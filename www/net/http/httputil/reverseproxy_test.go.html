<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="8270403">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8270458">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8270512">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8270563">//&nbsp;Reverse&nbsp;proxy&nbsp;tests.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8270588">package</span>&nbsp;<span class="ident" id="8270596">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8270606">import</span>&nbsp;<span class="op" id="8270613">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8270616">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8270629">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8270641">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8270662">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8270673">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8270684">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8270695">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8270702">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8270705">const</span>&nbsp;<span class="ident" id="8270711">fakeHopHeader</span>&nbsp;<span class="op" id="8270725">=</span>&nbsp;<span class="string" id="8270727">&#34;X-Fake-Hop-Header-For-Test&#34;</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="8270757">func</span>&nbsp;<span class="ident" id="8270762">init</span><span class="op" id="8270766">(</span><span class="op" id="8270767">)</span>&nbsp;<span class="op" id="8270769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8270772"><a href="/net/http/httputil/reverseproxy.go.html#5540157">hopHeaders</a></span>&nbsp;<span class="op" id="8270783">=</span>&nbsp;<span class="builtinfunc" id="8270785">append</span><span class="op" id="8270791">(</span><span class="ident" id="8270792"><a href="/net/http/httputil/reverseproxy.go.html#5540157">hopHeaders</a></span><span class="op" id="8270802">,</span>&nbsp;<span class="ident" id="8270804"><a href="/net/http/httputil/reverseproxy_test.go.html#8270711">fakeHopHeader</a></span><span class="op" id="8270817">)</span><br>
<span class="lineno"></span><span class="op" id="8270819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="8270822">func</span>&nbsp;<span class="ident" id="8270827">TestReverseProxy</span><span class="op" id="8270843">(</span><span class="ident" id="8270844">t</span>&nbsp;<span class="op" id="8270846">*</span><span class="ident" id="8270847"><a href="/net/http/httputil/reverseproxy_test.go.html#8270684">testing</a></span><span class="op" id="8270854">.</span><span class="ident" id="8270855">T</span><span class="op" id="8270856">)</span>&nbsp;<span class="op" id="8270858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8270861">const</span>&nbsp;<span class="ident" id="8270867">backendResponse</span>&nbsp;<span class="op" id="8270883">=</span>&nbsp;<span class="string" id="8270885">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8270905">const</span>&nbsp;<span class="ident" id="8270911">backendStatus</span>&nbsp;<span class="op" id="8270925">=</span>&nbsp;<span class="num" id="8270927">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8270932">backend</span>&nbsp;<span class="op" id="8270940">:=</span>&nbsp;<span class="ident" id="8270943"><a href="/net/http/httputil/reverseproxy_test.go.html#8270641">httptest</a></span><span class="op" id="8270951">.</span><span class="ident" id="8270952">NewServer</span><span class="op" id="8270961">(</span><span class="ident" id="8270962"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8270966">.</span><span class="ident" id="8270967">HandlerFunc</span><span class="op" id="8270978">(</span><span class="keyword" id="8270979">func</span><span class="op" id="8270983">(</span><span class="ident" id="8270984">w</span>&nbsp;<span class="ident" id="8270986"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8270990">.</span><span class="ident" id="8270991">ResponseWriter</span><span class="op" id="8271005">,</span>&nbsp;<span class="ident" id="8271007">r</span>&nbsp;<span class="op" id="8271009">*</span><span class="ident" id="8271010"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8271014">.</span><span class="ident" id="8271015">Request</span><span class="op" id="8271022">)</span>&nbsp;<span class="op" id="8271024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8271028">if</span>&nbsp;<span class="builtinfunc" id="8271031">len</span><span class="op" id="8271034">(</span><span class="ident" id="8271035"><a href="/net/http/httputil/reverseproxy_test.go.html#8271007">r</a></span><span class="op" id="8271036">.</span><span class="ident" id="8271037">TransferEncoding</span><span class="op" id="8271053">)</span>&nbsp;<span class="op" id="8271055">&gt;</span>&nbsp;<span class="num" id="8271057">0</span>&nbsp;<span class="op" id="8271059">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8271064"><a href="/net/http/httputil/reverseproxy_test.go.html#8270844">t</a></span><span class="op" id="8271065">.</span><span class="ident" id="8271066">Errorf</span><span class="op" id="8271072">(</span><span class="string" id="8271073">&#34;backend&nbsp;got&nbsp;unexpected&nbsp;TransferEncoding:&nbsp;%v&#34;</span><span class="op" id="8271118">,</span>&nbsp;<span class="ident" id="8271120"><a href="/net/http/httputil/reverseproxy_test.go.html#8271007">r</a></span><span class="op" id="8271121">.</span><span class="ident" id="8271122">TransferEncoding</span><span class="op" id="8271138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8271142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8271146">if</span>&nbsp;<span class="ident" id="8271149"><a href="/net/http/httputil/reverseproxy_test.go.html#8271007">r</a></span><span class="op" id="8271150">.</span><span class="ident" id="8271151">Header</span><span class="op" id="8271157">.</span><span class="ident" id="8271158">Get</span><span class="op" id="8271161">(</span><span class="string" id="8271162">&#34;X-Forwarded-For&#34;</span><span class="op" id="8271179">)</span>&nbsp;<span class="op" id="8271181">==</span>&nbsp;<span class="string" id="8271184">&#34;&#34;</span>&nbsp;<span class="op" id="8271187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8271192"><a href="/net/http/httputil/reverseproxy_test.go.html#8270844">t</a></span><span class="op" id="8271193">.</span><span class="ident" id="8271194">Errorf</span><span class="op" id="8271200">(</span><span class="string" id="8271201">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="8271236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8271240">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8271244">if</span>&nbsp;<span class="ident" id="8271247">c</span>&nbsp;<span class="op" id="8271249">:=</span>&nbsp;<span class="ident" id="8271252"><a href="/net/http/httputil/reverseproxy_test.go.html#8271007">r</a></span><span class="op" id="8271253">.</span><span class="ident" id="8271254">Header</span><span class="op" id="8271260">.</span><span class="ident" id="8271261">Get</span><span class="op" id="8271264">(</span><span class="string" id="8271265">&#34;Connection&#34;</span><span class="op" id="8271277">)</span><span class="op" id="8271278">;</span>&nbsp;<span class="ident" id="8271280"><a href="/net/http/httputil/reverseproxy_test.go.html#8271247">c</a></span>&nbsp;<span class="op" id="8271282">!=</span>&nbsp;<span class="string" id="8271285">&#34;&#34;</span>&nbsp;<span class="op" id="8271288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8271293"><a href="/net/http/httputil/reverseproxy_test.go.html#8270844">t</a></span><span class="op" id="8271294">.</span><span class="ident" id="8271295">Errorf</span><span class="op" id="8271301">(</span><span class="string" id="8271302">&#34;handler&nbsp;got&nbsp;Connection&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="8271342">,</span>&nbsp;<span class="ident" id="8271344"><a href="/net/http/httputil/reverseproxy_test.go.html#8271247">c</a></span><span class="op" id="8271345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8271349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8271353">if</span>&nbsp;<span class="ident" id="8271356">c</span>&nbsp;<span class="op" id="8271358">:=</span>&nbsp;<span class="ident" id="8271361"><a href="/net/http/httputil/reverseproxy_test.go.html#8271007">r</a></span><span class="op" id="8271362">.</span><span class="ident" id="8271363">Header</span><span class="op" id="8271369">.</span><span class="ident" id="8271370">Get</span><span class="op" id="8271373">(</span><span class="string" id="8271374">&#34;Upgrade&#34;</span><span class="op" id="8271383">)</span><span class="op" id="8271384">;</span>&nbsp;<span class="ident" id="8271386"><a href="/net/http/httputil/reverseproxy_test.go.html#8271356">c</a></span>&nbsp;<span class="op" id="8271388">!=</span>&nbsp;<span class="string" id="8271391">&#34;&#34;</span>&nbsp;<span class="op" id="8271394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8271399"><a href="/net/http/httputil/reverseproxy_test.go.html#8270844">t</a></span><span class="op" id="8271400">.</span><span class="ident" id="8271401">Errorf</span><span class="op" id="8271407">(</span><span class="string" id="8271408">&#34;handler&nbsp;got&nbsp;Upgrade&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="8271445">,</span>&nbsp;<span class="ident" id="8271447"><a href="/net/http/httputil/reverseproxy_test.go.html#8271356">c</a></span><span class="op" id="8271448">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8271452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8271456">if</span>&nbsp;<span class="ident" id="8271459">g</span><span class="op" id="8271460">,</span>&nbsp;<span class="ident" id="8271462">e</span>&nbsp;<span class="op" id="8271464">:=</span>&nbsp;<span class="ident" id="8271467"><a href="/net/http/httputil/reverseproxy_test.go.html#8271007">r</a></span><span class="op" id="8271468">.</span><span class="ident" id="8271469">Host</span><span class="op" id="8271473">,</span>&nbsp;<span class="string" id="8271475">&#34;some-name&#34;</span><span class="op" id="8271486">;</span>&nbsp;<span class="ident" id="8271488"><a href="/net/http/httputil/reverseproxy_test.go.html#8271459">g</a></span>&nbsp;<span class="op" id="8271490">!=</span>&nbsp;<span class="ident" id="8271493"><a href="/net/http/httputil/reverseproxy_test.go.html#8271462">e</a></span>&nbsp;<span class="op" id="8271495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8271500"><a href="/net/http/httputil/reverseproxy_test.go.html#8270844">t</a></span><span class="op" id="8271501">.</span><span class="ident" id="8271502">Errorf</span><span class="op" id="8271508">(</span><span class="string" id="8271509">&#34;backend&nbsp;got&nbsp;Host&nbsp;header&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8271546">,</span>&nbsp;<span class="ident" id="8271548"><a href="/net/http/httputil/reverseproxy_test.go.html#8271459">g</a></span><span class="op" id="8271549">,</span>&nbsp;<span class="ident" id="8271551"><a href="/net/http/httputil/reverseproxy_test.go.html#8271462">e</a></span><span class="op" id="8271552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8271556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8271560"><a href="/net/http/httputil/reverseproxy_test.go.html#8270984">w</a></span><span class="op" id="8271561">.</span><span class="ident" id="8271562">Header</span><span class="op" id="8271568">(</span><span class="op" id="8271569">)</span><span class="op" id="8271570">.</span><span class="ident" id="8271571">Set</span><span class="op" id="8271574">(</span><span class="string" id="8271575">&#34;X-Foo&#34;</span><span class="op" id="8271582">,</span>&nbsp;<span class="string" id="8271584">&#34;bar&#34;</span><span class="op" id="8271589">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8271593"><a href="/net/http/httputil/reverseproxy_test.go.html#8270984">w</a></span><span class="op" id="8271594">.</span><span class="ident" id="8271595">Header</span><span class="op" id="8271601">(</span><span class="op" id="8271602">)</span><span class="op" id="8271603">.</span><span class="ident" id="8271604">Set</span><span class="op" id="8271607">(</span><span class="string" id="8271608">&#34;Upgrade&#34;</span><span class="op" id="8271617">,</span>&nbsp;<span class="string" id="8271619">&#34;foo&#34;</span><span class="op" id="8271624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8271628"><a href="/net/http/httputil/reverseproxy_test.go.html#8270984">w</a></span><span class="op" id="8271629">.</span><span class="ident" id="8271630">Header</span><span class="op" id="8271636">(</span><span class="op" id="8271637">)</span><span class="op" id="8271638">.</span><span class="ident" id="8271639">Set</span><span class="op" id="8271642">(</span><span class="ident" id="8271643"><a href="/net/http/httputil/reverseproxy_test.go.html#8270711">fakeHopHeader</a></span><span class="op" id="8271656">,</span>&nbsp;<span class="string" id="8271658">&#34;foo&#34;</span><span class="op" id="8271663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8271667"><a href="/net/http/httputil/reverseproxy_test.go.html#8270984">w</a></span><span class="op" id="8271668">.</span><span class="ident" id="8271669">Header</span><span class="op" id="8271675">(</span><span class="op" id="8271676">)</span><span class="op" id="8271677">.</span><span class="ident" id="8271678">Add</span><span class="op" id="8271681">(</span><span class="string" id="8271682">&#34;X-Multi-Value&#34;</span><span class="op" id="8271697">,</span>&nbsp;<span class="string" id="8271699">&#34;foo&#34;</span><span class="op" id="8271704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8271708"><a href="/net/http/httputil/reverseproxy_test.go.html#8270984">w</a></span><span class="op" id="8271709">.</span><span class="ident" id="8271710">Header</span><span class="op" id="8271716">(</span><span class="op" id="8271717">)</span><span class="op" id="8271718">.</span><span class="ident" id="8271719">Add</span><span class="op" id="8271722">(</span><span class="string" id="8271723">&#34;X-Multi-Value&#34;</span><span class="op" id="8271738">,</span>&nbsp;<span class="string" id="8271740">&#34;bar&#34;</span><span class="op" id="8271745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8271749"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8271753">.</span><span class="ident" id="8271754">SetCookie</span><span class="op" id="8271763">(</span><span class="ident" id="8271764"><a href="/net/http/httputil/reverseproxy_test.go.html#8270984">w</a></span><span class="op" id="8271765">,</span>&nbsp;<span class="op" id="8271767">&amp;</span><span class="ident" id="8271768"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8271772">.</span><span class="ident" id="8271773">Cookie</span><span class="op" id="8271779">{</span><span class="ident" id="8271780">Name</span><span class="op" id="8271784">:</span>&nbsp;<span class="string" id="8271786">&#34;flavor&#34;</span><span class="op" id="8271794">,</span>&nbsp;<span class="ident" id="8271796">Value</span><span class="op" id="8271801">:</span>&nbsp;<span class="string" id="8271803">&#34;chocolateChip&#34;</span><span class="op" id="8271818">}</span><span class="op" id="8271819">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8271823"><a href="/net/http/httputil/reverseproxy_test.go.html#8270984">w</a></span><span class="op" id="8271824">.</span><span class="ident" id="8271825">WriteHeader</span><span class="op" id="8271836">(</span><span class="ident" id="8271837"><a href="/net/http/httputil/reverseproxy_test.go.html#8270911">backendStatus</a></span><span class="op" id="8271850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8271854"><a href="/net/http/httputil/reverseproxy_test.go.html#8270984">w</a></span><span class="op" id="8271855">.</span><span class="ident" id="8271856">Write</span><span class="op" id="8271861">(</span><span class="op" id="8271862">[</span><span class="op" id="8271863">]</span><span class="builtintype" id="8271864">byte</span><span class="op" id="8271868">(</span><span class="ident" id="8271869"><a href="/net/http/httputil/reverseproxy_test.go.html#8270867">backendResponse</a></span><span class="op" id="8271884">)</span><span class="op" id="8271885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8271888">}</span><span class="op" id="8271889">)</span><span class="op" id="8271890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8271893">defer</span>&nbsp;<span class="ident" id="8271899"><a href="/net/http/httputil/reverseproxy_test.go.html#8270932">backend</a></span><span class="op" id="8271906">.</span><span class="ident" id="8271907">Close</span><span class="op" id="8271912">(</span><span class="op" id="8271913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8271916">backendURL</span><span class="op" id="8271926">,</span>&nbsp;<span class="ident" id="8271928">err</span>&nbsp;<span class="op" id="8271932">:=</span>&nbsp;<span class="ident" id="8271935"><a href="/net/http/httputil/reverseproxy_test.go.html#8270662">url</a></span><span class="op" id="8271938">.</span><span class="ident" id="8271939">Parse</span><span class="op" id="8271944">(</span><span class="ident" id="8271945"><a href="/net/http/httputil/reverseproxy_test.go.html#8270932">backend</a></span><span class="op" id="8271952">.</span><span class="ident" id="8271953">URL</span><span class="op" id="8271956">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8271959">if</span>&nbsp;<span class="ident" id="8271962"><a href="/net/http/httputil/reverseproxy_test.go.html#8271928">err</a></span>&nbsp;<span class="op" id="8271966">!=</span>&nbsp;<span class="ident" id="8271969">nil</span>&nbsp;<span class="op" id="8271973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8271977"><a href="/net/http/httputil/reverseproxy_test.go.html#8270844">t</a></span><span class="op" id="8271978">.</span><span class="ident" id="8271979">Fatal</span><span class="op" id="8271984">(</span><span class="ident" id="8271985"><a href="/net/http/httputil/reverseproxy_test.go.html#8271928">err</a></span><span class="op" id="8271988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8271991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8271994">proxyHandler</span>&nbsp;<span class="op" id="8272007">:=</span>&nbsp;<span class="ident" id="8272010"><a href="/net/http/httputil/reverseproxy.go.html#5539429">NewSingleHostReverseProxy</a></span><span class="op" id="8272035">(</span><span class="ident" id="8272036"><a href="/net/http/httputil/reverseproxy_test.go.html#8271916">backendURL</a></span><span class="op" id="8272046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8272049">frontend</span>&nbsp;<span class="op" id="8272058">:=</span>&nbsp;<span class="ident" id="8272061"><a href="/net/http/httputil/reverseproxy_test.go.html#8270641">httptest</a></span><span class="op" id="8272069">.</span><span class="ident" id="8272070">NewServer</span><span class="op" id="8272079">(</span><span class="ident" id="8272080"><a href="/net/http/httputil/reverseproxy_test.go.html#8271994">proxyHandler</a></span><span class="op" id="8272092">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8272095">defer</span>&nbsp;<span class="ident" id="8272101"><a href="/net/http/httputil/reverseproxy_test.go.html#8272049">frontend</a></span><span class="op" id="8272109">.</span><span class="ident" id="8272110">Close</span><span class="op" id="8272115">(</span><span class="op" id="8272116">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8272120">getReq</span><span class="op" id="8272126">,</span>&nbsp;<span class="ident" id="8272128">_</span>&nbsp;<span class="op" id="8272130">:=</span>&nbsp;<span class="ident" id="8272133"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8272137">.</span><span class="ident" id="8272138">NewRequest</span><span class="op" id="8272148">(</span><span class="string" id="8272149">&#34;GET&#34;</span><span class="op" id="8272154">,</span>&nbsp;<span class="ident" id="8272156"><a href="/net/http/httputil/reverseproxy_test.go.html#8272049">frontend</a></span><span class="op" id="8272164">.</span><span class="ident" id="8272165">URL</span><span class="op" id="8272168">,</span>&nbsp;<span class="ident" id="8272170">nil</span><span class="op" id="8272173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8272176"><a href="/net/http/httputil/reverseproxy_test.go.html#8272120">getReq</a></span><span class="op" id="8272182">.</span><span class="ident" id="8272183">Host</span>&nbsp;<span class="op" id="8272188">=</span>&nbsp;<span class="string" id="8272190">&#34;some-name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8272203"><a href="/net/http/httputil/reverseproxy_test.go.html#8272120">getReq</a></span><span class="op" id="8272209">.</span><span class="ident" id="8272210">Header</span><span class="op" id="8272216">.</span><span class="ident" id="8272217">Set</span><span class="op" id="8272220">(</span><span class="string" id="8272221">&#34;Connection&#34;</span><span class="op" id="8272233">,</span>&nbsp;<span class="string" id="8272235">&#34;close&#34;</span><span class="op" id="8272242">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8272245"><a href="/net/http/httputil/reverseproxy_test.go.html#8272120">getReq</a></span><span class="op" id="8272251">.</span><span class="ident" id="8272252">Header</span><span class="op" id="8272258">.</span><span class="ident" id="8272259">Set</span><span class="op" id="8272262">(</span><span class="string" id="8272263">&#34;Upgrade&#34;</span><span class="op" id="8272272">,</span>&nbsp;<span class="string" id="8272274">&#34;foo&#34;</span><span class="op" id="8272279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8272282"><a href="/net/http/httputil/reverseproxy_test.go.html#8272120">getReq</a></span><span class="op" id="8272288">.</span><span class="ident" id="8272289">Close</span>&nbsp;<span class="op" id="8272295">=</span>&nbsp;<span class="builtintype" id="8272297">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8272303">res</span><span class="op" id="8272306">,</span>&nbsp;<span class="ident" id="8272308"><a href="/net/http/httputil/reverseproxy_test.go.html#8271928">err</a></span>&nbsp;<span class="op" id="8272312">:=</span>&nbsp;<span class="ident" id="8272315"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8272319">.</span><span class="ident" id="8272320">DefaultClient</span><span class="op" id="8272333">.</span><span class="ident" id="8272334">Do</span><span class="op" id="8272336">(</span><span class="ident" id="8272337"><a href="/net/http/httputil/reverseproxy_test.go.html#8272120">getReq</a></span><span class="op" id="8272343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8272346">if</span>&nbsp;<span class="ident" id="8272349"><a href="/net/http/httputil/reverseproxy_test.go.html#8271928">err</a></span>&nbsp;<span class="op" id="8272353">!=</span>&nbsp;<span class="ident" id="8272356">nil</span>&nbsp;<span class="op" id="8272360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8272364"><a href="/net/http/httputil/reverseproxy_test.go.html#8270844">t</a></span><span class="op" id="8272365">.</span><span class="ident" id="8272366">Fatalf</span><span class="op" id="8272372">(</span><span class="string" id="8272373">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="8272382">,</span>&nbsp;<span class="ident" id="8272384"><a href="/net/http/httputil/reverseproxy_test.go.html#8271928">err</a></span><span class="op" id="8272387">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8272390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8272393">if</span>&nbsp;<span class="ident" id="8272396">g</span><span class="op" id="8272397">,</span>&nbsp;<span class="ident" id="8272399">e</span>&nbsp;<span class="op" id="8272401">:=</span>&nbsp;<span class="ident" id="8272404"><a href="/net/http/httputil/reverseproxy_test.go.html#8272303">res</a></span><span class="op" id="8272407">.</span><span class="ident" id="8272408">StatusCode</span><span class="op" id="8272418">,</span>&nbsp;<span class="ident" id="8272420"><a href="/net/http/httputil/reverseproxy_test.go.html#8270911">backendStatus</a></span><span class="op" id="8272433">;</span>&nbsp;<span class="ident" id="8272435"><a href="/net/http/httputil/reverseproxy_test.go.html#8272396">g</a></span>&nbsp;<span class="op" id="8272437">!=</span>&nbsp;<span class="ident" id="8272440"><a href="/net/http/httputil/reverseproxy_test.go.html#8272399">e</a></span>&nbsp;<span class="op" id="8272442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8272446"><a href="/net/http/httputil/reverseproxy_test.go.html#8270844">t</a></span><span class="op" id="8272447">.</span><span class="ident" id="8272448">Errorf</span><span class="op" id="8272454">(</span><span class="string" id="8272455">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="8272491">,</span>&nbsp;<span class="ident" id="8272493"><a href="/net/http/httputil/reverseproxy_test.go.html#8272396">g</a></span><span class="op" id="8272494">,</span>&nbsp;<span class="ident" id="8272496"><a href="/net/http/httputil/reverseproxy_test.go.html#8272399">e</a></span><span class="op" id="8272497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8272500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8272503">if</span>&nbsp;<span class="ident" id="8272506">g</span><span class="op" id="8272507">,</span>&nbsp;<span class="ident" id="8272509">e</span>&nbsp;<span class="op" id="8272511">:=</span>&nbsp;<span class="ident" id="8272514"><a href="/net/http/httputil/reverseproxy_test.go.html#8272303">res</a></span><span class="op" id="8272517">.</span><span class="ident" id="8272518">Header</span><span class="op" id="8272524">.</span><span class="ident" id="8272525">Get</span><span class="op" id="8272528">(</span><span class="string" id="8272529">&#34;X-Foo&#34;</span><span class="op" id="8272536">)</span><span class="op" id="8272537">,</span>&nbsp;<span class="string" id="8272539">&#34;bar&#34;</span><span class="op" id="8272544">;</span>&nbsp;<span class="ident" id="8272546"><a href="/net/http/httputil/reverseproxy_test.go.html#8272506">g</a></span>&nbsp;<span class="op" id="8272548">!=</span>&nbsp;<span class="ident" id="8272551"><a href="/net/http/httputil/reverseproxy_test.go.html#8272509">e</a></span>&nbsp;<span class="op" id="8272553">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8272557"><a href="/net/http/httputil/reverseproxy_test.go.html#8270844">t</a></span><span class="op" id="8272558">.</span><span class="ident" id="8272559">Errorf</span><span class="op" id="8272565">(</span><span class="string" id="8272566">&#34;got&nbsp;X-Foo&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8272593">,</span>&nbsp;<span class="ident" id="8272595"><a href="/net/http/httputil/reverseproxy_test.go.html#8272506">g</a></span><span class="op" id="8272596">,</span>&nbsp;<span class="ident" id="8272598"><a href="/net/http/httputil/reverseproxy_test.go.html#8272509">e</a></span><span class="op" id="8272599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8272602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8272605">if</span>&nbsp;<span class="ident" id="8272608">c</span>&nbsp;<span class="op" id="8272610">:=</span>&nbsp;<span class="ident" id="8272613"><a href="/net/http/httputil/reverseproxy_test.go.html#8272303">res</a></span><span class="op" id="8272616">.</span><span class="ident" id="8272617">Header</span><span class="op" id="8272623">.</span><span class="ident" id="8272624">Get</span><span class="op" id="8272627">(</span><span class="ident" id="8272628"><a href="/net/http/httputil/reverseproxy_test.go.html#8270711">fakeHopHeader</a></span><span class="op" id="8272641">)</span><span class="op" id="8272642">;</span>&nbsp;<span class="ident" id="8272644"><a href="/net/http/httputil/reverseproxy_test.go.html#8272608">c</a></span>&nbsp;<span class="op" id="8272646">!=</span>&nbsp;<span class="string" id="8272649">&#34;&#34;</span>&nbsp;<span class="op" id="8272652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8272656"><a href="/net/http/httputil/reverseproxy_test.go.html#8270844">t</a></span><span class="op" id="8272657">.</span><span class="ident" id="8272658">Errorf</span><span class="op" id="8272664">(</span><span class="string" id="8272665">&#34;got&nbsp;%s&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="8272689">,</span>&nbsp;<span class="ident" id="8272691"><a href="/net/http/httputil/reverseproxy_test.go.html#8270711">fakeHopHeader</a></span><span class="op" id="8272704">,</span>&nbsp;<span class="ident" id="8272706"><a href="/net/http/httputil/reverseproxy_test.go.html#8272608">c</a></span><span class="op" id="8272707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8272710">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8272713">if</span>&nbsp;<span class="ident" id="8272716">g</span><span class="op" id="8272717">,</span>&nbsp;<span class="ident" id="8272719">e</span>&nbsp;<span class="op" id="8272721">:=</span>&nbsp;<span class="builtinfunc" id="8272724">len</span><span class="op" id="8272727">(</span><span class="ident" id="8272728"><a href="/net/http/httputil/reverseproxy_test.go.html#8272303">res</a></span><span class="op" id="8272731">.</span><span class="ident" id="8272732">Header</span><span class="op" id="8272738">[</span><span class="string" id="8272739">&#34;X-Multi-Value&#34;</span><span class="op" id="8272754">]</span><span class="op" id="8272755">)</span><span class="op" id="8272756">,</span>&nbsp;<span class="num" id="8272758">2</span><span class="op" id="8272759">;</span>&nbsp;<span class="ident" id="8272761"><a href="/net/http/httputil/reverseproxy_test.go.html#8272716">g</a></span>&nbsp;<span class="op" id="8272763">!=</span>&nbsp;<span class="ident" id="8272766"><a href="/net/http/httputil/reverseproxy_test.go.html#8272719">e</a></span>&nbsp;<span class="op" id="8272768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8272772"><a href="/net/http/httputil/reverseproxy_test.go.html#8270844">t</a></span><span class="op" id="8272773">.</span><span class="ident" id="8272774">Errorf</span><span class="op" id="8272780">(</span><span class="string" id="8272781">&#34;got&nbsp;%d&nbsp;X-Multi-Value&nbsp;header&nbsp;values;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="8272830">,</span>&nbsp;<span class="ident" id="8272832"><a href="/net/http/httputil/reverseproxy_test.go.html#8272716">g</a></span><span class="op" id="8272833">,</span>&nbsp;<span class="ident" id="8272835"><a href="/net/http/httputil/reverseproxy_test.go.html#8272719">e</a></span><span class="op" id="8272836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8272839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8272842">if</span>&nbsp;<span class="ident" id="8272845">g</span><span class="op" id="8272846">,</span>&nbsp;<span class="ident" id="8272848">e</span>&nbsp;<span class="op" id="8272850">:=</span>&nbsp;<span class="builtinfunc" id="8272853">len</span><span class="op" id="8272856">(</span><span class="ident" id="8272857"><a href="/net/http/httputil/reverseproxy_test.go.html#8272303">res</a></span><span class="op" id="8272860">.</span><span class="ident" id="8272861">Header</span><span class="op" id="8272867">[</span><span class="string" id="8272868">&#34;Set-Cookie&#34;</span><span class="op" id="8272880">]</span><span class="op" id="8272881">)</span><span class="op" id="8272882">,</span>&nbsp;<span class="num" id="8272884">1</span><span class="op" id="8272885">;</span>&nbsp;<span class="ident" id="8272887"><a href="/net/http/httputil/reverseproxy_test.go.html#8272845">g</a></span>&nbsp;<span class="op" id="8272889">!=</span>&nbsp;<span class="ident" id="8272892"><a href="/net/http/httputil/reverseproxy_test.go.html#8272848">e</a></span>&nbsp;<span class="op" id="8272894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8272898"><a href="/net/http/httputil/reverseproxy_test.go.html#8270844">t</a></span><span class="op" id="8272899">.</span><span class="ident" id="8272900">Fatalf</span><span class="op" id="8272906">(</span><span class="string" id="8272907">&#34;got&nbsp;%d&nbsp;SetCookies,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8272935">,</span>&nbsp;<span class="ident" id="8272937"><a href="/net/http/httputil/reverseproxy_test.go.html#8272845">g</a></span><span class="op" id="8272938">,</span>&nbsp;<span class="ident" id="8272940"><a href="/net/http/httputil/reverseproxy_test.go.html#8272848">e</a></span><span class="op" id="8272941">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8272944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8272947">if</span>&nbsp;<span class="ident" id="8272950">cookie</span>&nbsp;<span class="op" id="8272957">:=</span>&nbsp;<span class="ident" id="8272960"><a href="/net/http/httputil/reverseproxy_test.go.html#8272303">res</a></span><span class="op" id="8272963">.</span><span class="ident" id="8272964">Cookies</span><span class="op" id="8272971">(</span><span class="op" id="8272972">)</span><span class="op" id="8272973">[</span><span class="num" id="8272974">0</span><span class="op" id="8272975">]</span><span class="op" id="8272976">;</span>&nbsp;<span class="ident" id="8272978"><a href="/net/http/httputil/reverseproxy_test.go.html#8272950">cookie</a></span><span class="op" id="8272984">.</span><span class="ident" id="8272985">Name</span>&nbsp;<span class="op" id="8272990">!=</span>&nbsp;<span class="string" id="8272993">&#34;flavor&#34;</span>&nbsp;<span class="op" id="8273002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8273006"><a href="/net/http/httputil/reverseproxy_test.go.html#8270844">t</a></span><span class="op" id="8273007">.</span><span class="ident" id="8273008">Errorf</span><span class="op" id="8273014">(</span><span class="string" id="8273015">&#34;unexpected&nbsp;cookie&nbsp;%q&#34;</span><span class="op" id="8273037">,</span>&nbsp;<span class="ident" id="8273039"><a href="/net/http/httputil/reverseproxy_test.go.html#8272950">cookie</a></span><span class="op" id="8273045">.</span><span class="ident" id="8273046">Name</span><span class="op" id="8273050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8273053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8273056">bodyBytes</span><span class="op" id="8273065">,</span>&nbsp;<span class="ident" id="8273067">_</span>&nbsp;<span class="op" id="8273069">:=</span>&nbsp;<span class="ident" id="8273072"><a href="/net/http/httputil/reverseproxy_test.go.html#8270616">ioutil</a></span><span class="op" id="8273078">.</span><span class="ident" id="8273079">ReadAll</span><span class="op" id="8273086">(</span><span class="ident" id="8273087"><a href="/net/http/httputil/reverseproxy_test.go.html#8272303">res</a></span><span class="op" id="8273090">.</span><span class="ident" id="8273091">Body</span><span class="op" id="8273095">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8273098">if</span>&nbsp;<span class="ident" id="8273101">g</span><span class="op" id="8273102">,</span>&nbsp;<span class="ident" id="8273104">e</span>&nbsp;<span class="op" id="8273106">:=</span>&nbsp;<span class="builtintype" id="8273109">string</span><span class="op" id="8273115">(</span><span class="ident" id="8273116"><a href="/net/http/httputil/reverseproxy_test.go.html#8273056">bodyBytes</a></span><span class="op" id="8273125">)</span><span class="op" id="8273126">,</span>&nbsp;<span class="ident" id="8273128"><a href="/net/http/httputil/reverseproxy_test.go.html#8270867">backendResponse</a></span><span class="op" id="8273143">;</span>&nbsp;<span class="ident" id="8273145"><a href="/net/http/httputil/reverseproxy_test.go.html#8273101">g</a></span>&nbsp;<span class="op" id="8273147">!=</span>&nbsp;<span class="ident" id="8273150"><a href="/net/http/httputil/reverseproxy_test.go.html#8273104">e</a></span>&nbsp;<span class="op" id="8273152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8273156"><a href="/net/http/httputil/reverseproxy_test.go.html#8270844">t</a></span><span class="op" id="8273157">.</span><span class="ident" id="8273158">Errorf</span><span class="op" id="8273164">(</span><span class="string" id="8273165">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8273191">,</span>&nbsp;<span class="ident" id="8273193"><a href="/net/http/httputil/reverseproxy_test.go.html#8273101">g</a></span><span class="op" id="8273194">,</span>&nbsp;<span class="ident" id="8273196"><a href="/net/http/httputil/reverseproxy_test.go.html#8273104">e</a></span><span class="op" id="8273197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8273200">}</span><br>
<span class="lineno"></span><span class="op" id="8273202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="8273205">func</span>&nbsp;<span class="ident" id="8273210">TestXForwardedFor</span><span class="op" id="8273227">(</span><span class="ident" id="8273228">t</span>&nbsp;<span class="op" id="8273230">*</span><span class="ident" id="8273231"><a href="/net/http/httputil/reverseproxy_test.go.html#8270684">testing</a></span><span class="op" id="8273238">.</span><span class="ident" id="8273239">T</span><span class="op" id="8273240">)</span>&nbsp;<span class="op" id="8273242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8273245">const</span>&nbsp;<span class="ident" id="8273251">prevForwardedFor</span>&nbsp;<span class="op" id="8273268">=</span>&nbsp;<span class="string" id="8273270">&#34;client&nbsp;ip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8273283">const</span>&nbsp;<span class="ident" id="8273289">backendResponse</span>&nbsp;<span class="op" id="8273305">=</span>&nbsp;<span class="string" id="8273307">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8273327">const</span>&nbsp;<span class="ident" id="8273333">backendStatus</span>&nbsp;<span class="op" id="8273347">=</span>&nbsp;<span class="num" id="8273349">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8273354">backend</span>&nbsp;<span class="op" id="8273362">:=</span>&nbsp;<span class="ident" id="8273365"><a href="/net/http/httputil/reverseproxy_test.go.html#8270641">httptest</a></span><span class="op" id="8273373">.</span><span class="ident" id="8273374">NewServer</span><span class="op" id="8273383">(</span><span class="ident" id="8273384"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8273388">.</span><span class="ident" id="8273389">HandlerFunc</span><span class="op" id="8273400">(</span><span class="keyword" id="8273401">func</span><span class="op" id="8273405">(</span><span class="ident" id="8273406">w</span>&nbsp;<span class="ident" id="8273408"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8273412">.</span><span class="ident" id="8273413">ResponseWriter</span><span class="op" id="8273427">,</span>&nbsp;<span class="ident" id="8273429">r</span>&nbsp;<span class="op" id="8273431">*</span><span class="ident" id="8273432"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8273436">.</span><span class="ident" id="8273437">Request</span><span class="op" id="8273444">)</span>&nbsp;<span class="op" id="8273446">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8273450">if</span>&nbsp;<span class="ident" id="8273453"><a href="/net/http/httputil/reverseproxy_test.go.html#8273429">r</a></span><span class="op" id="8273454">.</span><span class="ident" id="8273455">Header</span><span class="op" id="8273461">.</span><span class="ident" id="8273462">Get</span><span class="op" id="8273465">(</span><span class="string" id="8273466">&#34;X-Forwarded-For&#34;</span><span class="op" id="8273483">)</span>&nbsp;<span class="op" id="8273485">==</span>&nbsp;<span class="string" id="8273488">&#34;&#34;</span>&nbsp;<span class="op" id="8273491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8273496"><a href="/net/http/httputil/reverseproxy_test.go.html#8273228">t</a></span><span class="op" id="8273497">.</span><span class="ident" id="8273498">Errorf</span><span class="op" id="8273504">(</span><span class="string" id="8273505">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="8273540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8273544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8273548">if</span>&nbsp;<span class="op" id="8273551">!</span><span class="ident" id="8273552"><a href="/net/http/httputil/reverseproxy_test.go.html#8270673">strings</a></span><span class="op" id="8273559">.</span><span class="ident" id="8273560">Contains</span><span class="op" id="8273568">(</span><span class="ident" id="8273569"><a href="/net/http/httputil/reverseproxy_test.go.html#8273429">r</a></span><span class="op" id="8273570">.</span><span class="ident" id="8273571">Header</span><span class="op" id="8273577">.</span><span class="ident" id="8273578">Get</span><span class="op" id="8273581">(</span><span class="string" id="8273582">&#34;X-Forwarded-For&#34;</span><span class="op" id="8273599">)</span><span class="op" id="8273600">,</span>&nbsp;<span class="ident" id="8273602"><a href="/net/http/httputil/reverseproxy_test.go.html#8273251">prevForwardedFor</a></span><span class="op" id="8273618">)</span>&nbsp;<span class="op" id="8273620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8273625"><a href="/net/http/httputil/reverseproxy_test.go.html#8273228">t</a></span><span class="op" id="8273626">.</span><span class="ident" id="8273627">Errorf</span><span class="op" id="8273633">(</span><span class="string" id="8273634">&#34;X-Forwarded-For&nbsp;didn&#39;t&nbsp;contain&nbsp;prior&nbsp;data&#34;</span><span class="op" id="8273677">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8273681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8273685"><a href="/net/http/httputil/reverseproxy_test.go.html#8273406">w</a></span><span class="op" id="8273686">.</span><span class="ident" id="8273687">WriteHeader</span><span class="op" id="8273698">(</span><span class="ident" id="8273699"><a href="/net/http/httputil/reverseproxy_test.go.html#8273333">backendStatus</a></span><span class="op" id="8273712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8273716"><a href="/net/http/httputil/reverseproxy_test.go.html#8273406">w</a></span><span class="op" id="8273717">.</span><span class="ident" id="8273718">Write</span><span class="op" id="8273723">(</span><span class="op" id="8273724">[</span><span class="op" id="8273725">]</span><span class="builtintype" id="8273726">byte</span><span class="op" id="8273730">(</span><span class="ident" id="8273731"><a href="/net/http/httputil/reverseproxy_test.go.html#8273289">backendResponse</a></span><span class="op" id="8273746">)</span><span class="op" id="8273747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8273750">}</span><span class="op" id="8273751">)</span><span class="op" id="8273752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8273755">defer</span>&nbsp;<span class="ident" id="8273761"><a href="/net/http/httputil/reverseproxy_test.go.html#8273354">backend</a></span><span class="op" id="8273768">.</span><span class="ident" id="8273769">Close</span><span class="op" id="8273774">(</span><span class="op" id="8273775">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8273778">backendURL</span><span class="op" id="8273788">,</span>&nbsp;<span class="ident" id="8273790">err</span>&nbsp;<span class="op" id="8273794">:=</span>&nbsp;<span class="ident" id="8273797"><a href="/net/http/httputil/reverseproxy_test.go.html#8270662">url</a></span><span class="op" id="8273800">.</span><span class="ident" id="8273801">Parse</span><span class="op" id="8273806">(</span><span class="ident" id="8273807"><a href="/net/http/httputil/reverseproxy_test.go.html#8273354">backend</a></span><span class="op" id="8273814">.</span><span class="ident" id="8273815">URL</span><span class="op" id="8273818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8273821">if</span>&nbsp;<span class="ident" id="8273824"><a href="/net/http/httputil/reverseproxy_test.go.html#8273790">err</a></span>&nbsp;<span class="op" id="8273828">!=</span>&nbsp;<span class="ident" id="8273831">nil</span>&nbsp;<span class="op" id="8273835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8273839"><a href="/net/http/httputil/reverseproxy_test.go.html#8273228">t</a></span><span class="op" id="8273840">.</span><span class="ident" id="8273841">Fatal</span><span class="op" id="8273846">(</span><span class="ident" id="8273847"><a href="/net/http/httputil/reverseproxy_test.go.html#8273790">err</a></span><span class="op" id="8273850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8273853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8273856">proxyHandler</span>&nbsp;<span class="op" id="8273869">:=</span>&nbsp;<span class="ident" id="8273872"><a href="/net/http/httputil/reverseproxy.go.html#5539429">NewSingleHostReverseProxy</a></span><span class="op" id="8273897">(</span><span class="ident" id="8273898"><a href="/net/http/httputil/reverseproxy_test.go.html#8273778">backendURL</a></span><span class="op" id="8273908">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8273911">frontend</span>&nbsp;<span class="op" id="8273920">:=</span>&nbsp;<span class="ident" id="8273923"><a href="/net/http/httputil/reverseproxy_test.go.html#8270641">httptest</a></span><span class="op" id="8273931">.</span><span class="ident" id="8273932">NewServer</span><span class="op" id="8273941">(</span><span class="ident" id="8273942"><a href="/net/http/httputil/reverseproxy_test.go.html#8273856">proxyHandler</a></span><span class="op" id="8273954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8273957">defer</span>&nbsp;<span class="ident" id="8273963"><a href="/net/http/httputil/reverseproxy_test.go.html#8273911">frontend</a></span><span class="op" id="8273971">.</span><span class="ident" id="8273972">Close</span><span class="op" id="8273977">(</span><span class="op" id="8273978">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8273982">getReq</span><span class="op" id="8273988">,</span>&nbsp;<span class="ident" id="8273990">_</span>&nbsp;<span class="op" id="8273992">:=</span>&nbsp;<span class="ident" id="8273995"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8273999">.</span><span class="ident" id="8274000">NewRequest</span><span class="op" id="8274010">(</span><span class="string" id="8274011">&#34;GET&#34;</span><span class="op" id="8274016">,</span>&nbsp;<span class="ident" id="8274018"><a href="/net/http/httputil/reverseproxy_test.go.html#8273911">frontend</a></span><span class="op" id="8274026">.</span><span class="ident" id="8274027">URL</span><span class="op" id="8274030">,</span>&nbsp;<span class="ident" id="8274032">nil</span><span class="op" id="8274035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8274038"><a href="/net/http/httputil/reverseproxy_test.go.html#8273982">getReq</a></span><span class="op" id="8274044">.</span><span class="ident" id="8274045">Host</span>&nbsp;<span class="op" id="8274050">=</span>&nbsp;<span class="string" id="8274052">&#34;some-name&#34;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8274065"><a href="/net/http/httputil/reverseproxy_test.go.html#8273982">getReq</a></span><span class="op" id="8274071">.</span><span class="ident" id="8274072">Header</span><span class="op" id="8274078">.</span><span class="ident" id="8274079">Set</span><span class="op" id="8274082">(</span><span class="string" id="8274083">&#34;Connection&#34;</span><span class="op" id="8274095">,</span>&nbsp;<span class="string" id="8274097">&#34;close&#34;</span><span class="op" id="8274104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8274107"><a href="/net/http/httputil/reverseproxy_test.go.html#8273982">getReq</a></span><span class="op" id="8274113">.</span><span class="ident" id="8274114">Header</span><span class="op" id="8274120">.</span><span class="ident" id="8274121">Set</span><span class="op" id="8274124">(</span><span class="string" id="8274125">&#34;X-Forwarded-For&#34;</span><span class="op" id="8274142">,</span>&nbsp;<span class="ident" id="8274144"><a href="/net/http/httputil/reverseproxy_test.go.html#8273251">prevForwardedFor</a></span><span class="op" id="8274160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8274163"><a href="/net/http/httputil/reverseproxy_test.go.html#8273982">getReq</a></span><span class="op" id="8274169">.</span><span class="ident" id="8274170">Close</span>&nbsp;<span class="op" id="8274176">=</span>&nbsp;<span class="builtintype" id="8274178">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8274184">res</span><span class="op" id="8274187">,</span>&nbsp;<span class="ident" id="8274189"><a href="/net/http/httputil/reverseproxy_test.go.html#8273790">err</a></span>&nbsp;<span class="op" id="8274193">:=</span>&nbsp;<span class="ident" id="8274196"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8274200">.</span><span class="ident" id="8274201">DefaultClient</span><span class="op" id="8274214">.</span><span class="ident" id="8274215">Do</span><span class="op" id="8274217">(</span><span class="ident" id="8274218"><a href="/net/http/httputil/reverseproxy_test.go.html#8273982">getReq</a></span><span class="op" id="8274224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8274227">if</span>&nbsp;<span class="ident" id="8274230"><a href="/net/http/httputil/reverseproxy_test.go.html#8273790">err</a></span>&nbsp;<span class="op" id="8274234">!=</span>&nbsp;<span class="ident" id="8274237">nil</span>&nbsp;<span class="op" id="8274241">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8274245"><a href="/net/http/httputil/reverseproxy_test.go.html#8273228">t</a></span><span class="op" id="8274246">.</span><span class="ident" id="8274247">Fatalf</span><span class="op" id="8274253">(</span><span class="string" id="8274254">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="8274263">,</span>&nbsp;<span class="ident" id="8274265"><a href="/net/http/httputil/reverseproxy_test.go.html#8273790">err</a></span><span class="op" id="8274268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8274271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8274274">if</span>&nbsp;<span class="ident" id="8274277">g</span><span class="op" id="8274278">,</span>&nbsp;<span class="ident" id="8274280">e</span>&nbsp;<span class="op" id="8274282">:=</span>&nbsp;<span class="ident" id="8274285"><a href="/net/http/httputil/reverseproxy_test.go.html#8274184">res</a></span><span class="op" id="8274288">.</span><span class="ident" id="8274289">StatusCode</span><span class="op" id="8274299">,</span>&nbsp;<span class="ident" id="8274301"><a href="/net/http/httputil/reverseproxy_test.go.html#8273333">backendStatus</a></span><span class="op" id="8274314">;</span>&nbsp;<span class="ident" id="8274316"><a href="/net/http/httputil/reverseproxy_test.go.html#8274277">g</a></span>&nbsp;<span class="op" id="8274318">!=</span>&nbsp;<span class="ident" id="8274321"><a href="/net/http/httputil/reverseproxy_test.go.html#8274280">e</a></span>&nbsp;<span class="op" id="8274323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8274327"><a href="/net/http/httputil/reverseproxy_test.go.html#8273228">t</a></span><span class="op" id="8274328">.</span><span class="ident" id="8274329">Errorf</span><span class="op" id="8274335">(</span><span class="string" id="8274336">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="8274372">,</span>&nbsp;<span class="ident" id="8274374"><a href="/net/http/httputil/reverseproxy_test.go.html#8274277">g</a></span><span class="op" id="8274375">,</span>&nbsp;<span class="ident" id="8274377"><a href="/net/http/httputil/reverseproxy_test.go.html#8274280">e</a></span><span class="op" id="8274378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8274381">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8274384">bodyBytes</span><span class="op" id="8274393">,</span>&nbsp;<span class="ident" id="8274395">_</span>&nbsp;<span class="op" id="8274397">:=</span>&nbsp;<span class="ident" id="8274400"><a href="/net/http/httputil/reverseproxy_test.go.html#8270616">ioutil</a></span><span class="op" id="8274406">.</span><span class="ident" id="8274407">ReadAll</span><span class="op" id="8274414">(</span><span class="ident" id="8274415"><a href="/net/http/httputil/reverseproxy_test.go.html#8274184">res</a></span><span class="op" id="8274418">.</span><span class="ident" id="8274419">Body</span><span class="op" id="8274423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8274426">if</span>&nbsp;<span class="ident" id="8274429">g</span><span class="op" id="8274430">,</span>&nbsp;<span class="ident" id="8274432">e</span>&nbsp;<span class="op" id="8274434">:=</span>&nbsp;<span class="builtintype" id="8274437">string</span><span class="op" id="8274443">(</span><span class="ident" id="8274444"><a href="/net/http/httputil/reverseproxy_test.go.html#8274384">bodyBytes</a></span><span class="op" id="8274453">)</span><span class="op" id="8274454">,</span>&nbsp;<span class="ident" id="8274456"><a href="/net/http/httputil/reverseproxy_test.go.html#8273289">backendResponse</a></span><span class="op" id="8274471">;</span>&nbsp;<span class="ident" id="8274473"><a href="/net/http/httputil/reverseproxy_test.go.html#8274429">g</a></span>&nbsp;<span class="op" id="8274475">!=</span>&nbsp;<span class="ident" id="8274478"><a href="/net/http/httputil/reverseproxy_test.go.html#8274432">e</a></span>&nbsp;<span class="op" id="8274480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8274484"><a href="/net/http/httputil/reverseproxy_test.go.html#8273228">t</a></span><span class="op" id="8274485">.</span><span class="ident" id="8274486">Errorf</span><span class="op" id="8274492">(</span><span class="string" id="8274493">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8274519">,</span>&nbsp;<span class="ident" id="8274521"><a href="/net/http/httputil/reverseproxy_test.go.html#8274429">g</a></span><span class="op" id="8274522">,</span>&nbsp;<span class="ident" id="8274524"><a href="/net/http/httputil/reverseproxy_test.go.html#8274432">e</a></span><span class="op" id="8274525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8274528">}</span><br>
<span class="lineno"></span><span class="op" id="8274530">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="8274533">var</span>&nbsp;<span class="ident" id="8274537">proxyQueryTests</span>&nbsp;<span class="op" id="8274553">=</span>&nbsp;<span class="op" id="8274555">[</span><span class="op" id="8274556">]</span><span class="keyword" id="8274557">struct</span>&nbsp;<span class="op" id="8274564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8274567">baseSuffix</span>&nbsp;<span class="builtintype" id="8274578">string</span>&nbsp;<span class="comment" id="8274585">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;backend&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8274618">reqSuffix</span>&nbsp;&nbsp;<span class="builtintype" id="8274629">string</span>&nbsp;<span class="comment" id="8274636">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;frontend&#39;s&nbsp;request&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8274680">want</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8274691">string</span>&nbsp;<span class="comment" id="8274698">//&nbsp;what&nbsp;backend&nbsp;should&nbsp;see&nbsp;for&nbsp;final&nbsp;request&nbsp;URL&nbsp;(without&nbsp;?)</span><br>
<span class="lineno">140</span><span class="op" id="8274759">}</span><span class="op" id="8274760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8274763">{</span><span class="string" id="8274764">&#34;&#34;</span><span class="op" id="8274766">,</span>&nbsp;<span class="string" id="8274768">&#34;&#34;</span><span class="op" id="8274770">,</span>&nbsp;<span class="string" id="8274772">&#34;&#34;</span><span class="op" id="8274774">}</span><span class="op" id="8274775">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8274778">{</span><span class="string" id="8274779">&#34;?sta=tic&#34;</span><span class="op" id="8274789">,</span>&nbsp;<span class="string" id="8274791">&#34;?us=er&#34;</span><span class="op" id="8274799">,</span>&nbsp;<span class="string" id="8274801">&#34;sta=tic&amp;us=er&#34;</span><span class="op" id="8274816">}</span><span class="op" id="8274817">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8274820">{</span><span class="string" id="8274821">&#34;&#34;</span><span class="op" id="8274823">,</span>&nbsp;<span class="string" id="8274825">&#34;?us=er&#34;</span><span class="op" id="8274833">,</span>&nbsp;<span class="string" id="8274835">&#34;us=er&#34;</span><span class="op" id="8274842">}</span><span class="op" id="8274843">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8274846">{</span><span class="string" id="8274847">&#34;?sta=tic&#34;</span><span class="op" id="8274857">,</span>&nbsp;<span class="string" id="8274859">&#34;&#34;</span><span class="op" id="8274861">,</span>&nbsp;<span class="string" id="8274863">&#34;sta=tic&#34;</span><span class="op" id="8274872">}</span><span class="op" id="8274873">,</span><br>
<span class="lineno">145</span><span class="op" id="8274875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8274878">func</span>&nbsp;<span class="ident" id="8274883">TestReverseProxyQuery</span><span class="op" id="8274904">(</span><span class="ident" id="8274905">t</span>&nbsp;<span class="op" id="8274907">*</span><span class="ident" id="8274908"><a href="/net/http/httputil/reverseproxy_test.go.html#8270684">testing</a></span><span class="op" id="8274915">.</span><span class="ident" id="8274916">T</span><span class="op" id="8274917">)</span>&nbsp;<span class="op" id="8274919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8274922">backend</span>&nbsp;<span class="op" id="8274930">:=</span>&nbsp;<span class="ident" id="8274933"><a href="/net/http/httputil/reverseproxy_test.go.html#8270641">httptest</a></span><span class="op" id="8274941">.</span><span class="ident" id="8274942">NewServer</span><span class="op" id="8274951">(</span><span class="ident" id="8274952"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8274956">.</span><span class="ident" id="8274957">HandlerFunc</span><span class="op" id="8274968">(</span><span class="keyword" id="8274969">func</span><span class="op" id="8274973">(</span><span class="ident" id="8274974">w</span>&nbsp;<span class="ident" id="8274976"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8274980">.</span><span class="ident" id="8274981">ResponseWriter</span><span class="op" id="8274995">,</span>&nbsp;<span class="ident" id="8274997">r</span>&nbsp;<span class="op" id="8274999">*</span><span class="ident" id="8275000"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8275004">.</span><span class="ident" id="8275005">Request</span><span class="op" id="8275012">)</span>&nbsp;<span class="op" id="8275014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275018"><a href="/net/http/httputil/reverseproxy_test.go.html#8274974">w</a></span><span class="op" id="8275019">.</span><span class="ident" id="8275020">Header</span><span class="op" id="8275026">(</span><span class="op" id="8275027">)</span><span class="op" id="8275028">.</span><span class="ident" id="8275029">Set</span><span class="op" id="8275032">(</span><span class="string" id="8275033">&#34;X-Got-Query&#34;</span><span class="op" id="8275046">,</span>&nbsp;<span class="ident" id="8275048"><a href="/net/http/httputil/reverseproxy_test.go.html#8274997">r</a></span><span class="op" id="8275049">.</span><span class="ident" id="8275050">URL</span><span class="op" id="8275053">.</span><span class="ident" id="8275054">RawQuery</span><span class="op" id="8275062">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275066"><a href="/net/http/httputil/reverseproxy_test.go.html#8274974">w</a></span><span class="op" id="8275067">.</span><span class="ident" id="8275068">Write</span><span class="op" id="8275073">(</span><span class="op" id="8275074">[</span><span class="op" id="8275075">]</span><span class="builtintype" id="8275076">byte</span><span class="op" id="8275080">(</span><span class="string" id="8275081">&#34;hi&#34;</span><span class="op" id="8275085">)</span><span class="op" id="8275086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8275089">}</span><span class="op" id="8275090">)</span><span class="op" id="8275091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8275094">defer</span>&nbsp;<span class="ident" id="8275100"><a href="/net/http/httputil/reverseproxy_test.go.html#8274922">backend</a></span><span class="op" id="8275107">.</span><span class="ident" id="8275108">Close</span><span class="op" id="8275113">(</span><span class="op" id="8275114">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8275118">for</span>&nbsp;<span class="ident" id="8275122">i</span><span class="op" id="8275123">,</span>&nbsp;<span class="ident" id="8275125">tt</span>&nbsp;<span class="op" id="8275128">:=</span>&nbsp;<span class="keyword" id="8275131">range</span>&nbsp;<span class="ident" id="8275137"><a href="/net/http/httputil/reverseproxy_test.go.html#8274537">proxyQueryTests</a></span>&nbsp;<span class="op" id="8275153">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275157">backendURL</span><span class="op" id="8275167">,</span>&nbsp;<span class="ident" id="8275169">err</span>&nbsp;<span class="op" id="8275173">:=</span>&nbsp;<span class="ident" id="8275176"><a href="/net/http/httputil/reverseproxy_test.go.html#8270662">url</a></span><span class="op" id="8275179">.</span><span class="ident" id="8275180">Parse</span><span class="op" id="8275185">(</span><span class="ident" id="8275186"><a href="/net/http/httputil/reverseproxy_test.go.html#8274922">backend</a></span><span class="op" id="8275193">.</span><span class="ident" id="8275194">URL</span>&nbsp;<span class="op" id="8275198">+</span>&nbsp;<span class="ident" id="8275200"><a href="/net/http/httputil/reverseproxy_test.go.html#8275125">tt</a></span><span class="op" id="8275202">.</span><span class="ident" id="8275203">baseSuffix</span><span class="op" id="8275213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8275217">if</span>&nbsp;<span class="ident" id="8275220"><a href="/net/http/httputil/reverseproxy_test.go.html#8275169">err</a></span>&nbsp;<span class="op" id="8275224">!=</span>&nbsp;<span class="ident" id="8275227">nil</span>&nbsp;<span class="op" id="8275231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275236"><a href="/net/http/httputil/reverseproxy_test.go.html#8274905">t</a></span><span class="op" id="8275237">.</span><span class="ident" id="8275238">Fatal</span><span class="op" id="8275243">(</span><span class="ident" id="8275244"><a href="/net/http/httputil/reverseproxy_test.go.html#8275169">err</a></span><span class="op" id="8275247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8275251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275255">frontend</span>&nbsp;<span class="op" id="8275264">:=</span>&nbsp;<span class="ident" id="8275267"><a href="/net/http/httputil/reverseproxy_test.go.html#8270641">httptest</a></span><span class="op" id="8275275">.</span><span class="ident" id="8275276">NewServer</span><span class="op" id="8275285">(</span><span class="ident" id="8275286"><a href="/net/http/httputil/reverseproxy.go.html#5539429">NewSingleHostReverseProxy</a></span><span class="op" id="8275311">(</span><span class="ident" id="8275312"><a href="/net/http/httputil/reverseproxy_test.go.html#8275157">backendURL</a></span><span class="op" id="8275322">)</span><span class="op" id="8275323">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275327">req</span><span class="op" id="8275330">,</span>&nbsp;<span class="ident" id="8275332">_</span>&nbsp;<span class="op" id="8275334">:=</span>&nbsp;<span class="ident" id="8275337"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8275341">.</span><span class="ident" id="8275342">NewRequest</span><span class="op" id="8275352">(</span><span class="string" id="8275353">&#34;GET&#34;</span><span class="op" id="8275358">,</span>&nbsp;<span class="ident" id="8275360"><a href="/net/http/httputil/reverseproxy_test.go.html#8275255">frontend</a></span><span class="op" id="8275368">.</span><span class="ident" id="8275369">URL</span><span class="op" id="8275372">+</span><span class="ident" id="8275373"><a href="/net/http/httputil/reverseproxy_test.go.html#8275125">tt</a></span><span class="op" id="8275375">.</span><span class="ident" id="8275376">reqSuffix</span><span class="op" id="8275385">,</span>&nbsp;<span class="ident" id="8275387">nil</span><span class="op" id="8275390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275394"><a href="/net/http/httputil/reverseproxy_test.go.html#8275327">req</a></span><span class="op" id="8275397">.</span><span class="ident" id="8275398">Close</span>&nbsp;<span class="op" id="8275404">=</span>&nbsp;<span class="builtintype" id="8275406">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275413">res</span><span class="op" id="8275416">,</span>&nbsp;<span class="ident" id="8275418"><a href="/net/http/httputil/reverseproxy_test.go.html#8275169">err</a></span>&nbsp;<span class="op" id="8275422">:=</span>&nbsp;<span class="ident" id="8275425"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8275429">.</span><span class="ident" id="8275430">DefaultClient</span><span class="op" id="8275443">.</span><span class="ident" id="8275444">Do</span><span class="op" id="8275446">(</span><span class="ident" id="8275447"><a href="/net/http/httputil/reverseproxy_test.go.html#8275327">req</a></span><span class="op" id="8275450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8275454">if</span>&nbsp;<span class="ident" id="8275457"><a href="/net/http/httputil/reverseproxy_test.go.html#8275169">err</a></span>&nbsp;<span class="op" id="8275461">!=</span>&nbsp;<span class="ident" id="8275464">nil</span>&nbsp;<span class="op" id="8275468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275473"><a href="/net/http/httputil/reverseproxy_test.go.html#8274905">t</a></span><span class="op" id="8275474">.</span><span class="ident" id="8275475">Fatalf</span><span class="op" id="8275481">(</span><span class="string" id="8275482">&#34;%d.&nbsp;Get:&nbsp;%v&#34;</span><span class="op" id="8275495">,</span>&nbsp;<span class="ident" id="8275497"><a href="/net/http/httputil/reverseproxy_test.go.html#8275122">i</a></span><span class="op" id="8275498">,</span>&nbsp;<span class="ident" id="8275500"><a href="/net/http/httputil/reverseproxy_test.go.html#8275169">err</a></span><span class="op" id="8275503">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8275507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8275511">if</span>&nbsp;<span class="ident" id="8275514">g</span><span class="op" id="8275515">,</span>&nbsp;<span class="ident" id="8275517">e</span>&nbsp;<span class="op" id="8275519">:=</span>&nbsp;<span class="ident" id="8275522"><a href="/net/http/httputil/reverseproxy_test.go.html#8275413">res</a></span><span class="op" id="8275525">.</span><span class="ident" id="8275526">Header</span><span class="op" id="8275532">.</span><span class="ident" id="8275533">Get</span><span class="op" id="8275536">(</span><span class="string" id="8275537">&#34;X-Got-Query&#34;</span><span class="op" id="8275550">)</span><span class="op" id="8275551">,</span>&nbsp;<span class="ident" id="8275553"><a href="/net/http/httputil/reverseproxy_test.go.html#8275125">tt</a></span><span class="op" id="8275555">.</span><span class="ident" id="8275556">want</span><span class="op" id="8275560">;</span>&nbsp;<span class="ident" id="8275562"><a href="/net/http/httputil/reverseproxy_test.go.html#8275514">g</a></span>&nbsp;<span class="op" id="8275564">!=</span>&nbsp;<span class="ident" id="8275567"><a href="/net/http/httputil/reverseproxy_test.go.html#8275517">e</a></span>&nbsp;<span class="op" id="8275569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275574"><a href="/net/http/httputil/reverseproxy_test.go.html#8274905">t</a></span><span class="op" id="8275575">.</span><span class="ident" id="8275576">Errorf</span><span class="op" id="8275582">(</span><span class="string" id="8275583">&#34;%d.&nbsp;got&nbsp;query&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8275614">,</span>&nbsp;<span class="ident" id="8275616"><a href="/net/http/httputil/reverseproxy_test.go.html#8275122">i</a></span><span class="op" id="8275617">,</span>&nbsp;<span class="ident" id="8275619"><a href="/net/http/httputil/reverseproxy_test.go.html#8275514">g</a></span><span class="op" id="8275620">,</span>&nbsp;<span class="ident" id="8275622"><a href="/net/http/httputil/reverseproxy_test.go.html#8275517">e</a></span><span class="op" id="8275623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8275627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275631"><a href="/net/http/httputil/reverseproxy_test.go.html#8275413">res</a></span><span class="op" id="8275634">.</span><span class="ident" id="8275635">Body</span><span class="op" id="8275639">.</span><span class="ident" id="8275640">Close</span><span class="op" id="8275645">(</span><span class="op" id="8275646">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275650"><a href="/net/http/httputil/reverseproxy_test.go.html#8275255">frontend</a></span><span class="op" id="8275658">.</span><span class="ident" id="8275659">Close</span><span class="op" id="8275664">(</span><span class="op" id="8275665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8275668">}</span><br>
<span class="lineno"></span><span class="op" id="8275670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8275673">func</span>&nbsp;<span class="ident" id="8275678">TestReverseProxyFlushInterval</span><span class="op" id="8275707">(</span><span class="ident" id="8275708">t</span>&nbsp;<span class="op" id="8275710">*</span><span class="ident" id="8275711"><a href="/net/http/httputil/reverseproxy_test.go.html#8270684">testing</a></span><span class="op" id="8275718">.</span><span class="ident" id="8275719">T</span><span class="op" id="8275720">)</span>&nbsp;<span class="op" id="8275722">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8275725">const</span>&nbsp;<span class="ident" id="8275731">expected</span>&nbsp;<span class="op" id="8275740">=</span>&nbsp;<span class="string" id="8275742">&#34;hi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275748">backend</span>&nbsp;<span class="op" id="8275756">:=</span>&nbsp;<span class="ident" id="8275759"><a href="/net/http/httputil/reverseproxy_test.go.html#8270641">httptest</a></span><span class="op" id="8275767">.</span><span class="ident" id="8275768">NewServer</span><span class="op" id="8275777">(</span><span class="ident" id="8275778"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8275782">.</span><span class="ident" id="8275783">HandlerFunc</span><span class="op" id="8275794">(</span><span class="keyword" id="8275795">func</span><span class="op" id="8275799">(</span><span class="ident" id="8275800">w</span>&nbsp;<span class="ident" id="8275802"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8275806">.</span><span class="ident" id="8275807">ResponseWriter</span><span class="op" id="8275821">,</span>&nbsp;<span class="ident" id="8275823">r</span>&nbsp;<span class="op" id="8275825">*</span><span class="ident" id="8275826"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8275830">.</span><span class="ident" id="8275831">Request</span><span class="op" id="8275838">)</span>&nbsp;<span class="op" id="8275840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275844"><a href="/net/http/httputil/reverseproxy_test.go.html#8275800">w</a></span><span class="op" id="8275845">.</span><span class="ident" id="8275846">Write</span><span class="op" id="8275851">(</span><span class="op" id="8275852">[</span><span class="op" id="8275853">]</span><span class="builtintype" id="8275854">byte</span><span class="op" id="8275858">(</span><span class="ident" id="8275859"><a href="/net/http/httputil/reverseproxy_test.go.html#8275731">expected</a></span><span class="op" id="8275867">)</span><span class="op" id="8275868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8275871">}</span><span class="op" id="8275872">)</span><span class="op" id="8275873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8275876">defer</span>&nbsp;<span class="ident" id="8275882"><a href="/net/http/httputil/reverseproxy_test.go.html#8275748">backend</a></span><span class="op" id="8275889">.</span><span class="ident" id="8275890">Close</span><span class="op" id="8275895">(</span><span class="op" id="8275896">)</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275900">backendURL</span><span class="op" id="8275910">,</span>&nbsp;<span class="ident" id="8275912">err</span>&nbsp;<span class="op" id="8275916">:=</span>&nbsp;<span class="ident" id="8275919"><a href="/net/http/httputil/reverseproxy_test.go.html#8270662">url</a></span><span class="op" id="8275922">.</span><span class="ident" id="8275923">Parse</span><span class="op" id="8275928">(</span><span class="ident" id="8275929"><a href="/net/http/httputil/reverseproxy_test.go.html#8275748">backend</a></span><span class="op" id="8275936">.</span><span class="ident" id="8275937">URL</span><span class="op" id="8275940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8275943">if</span>&nbsp;<span class="ident" id="8275946"><a href="/net/http/httputil/reverseproxy_test.go.html#8275912">err</a></span>&nbsp;<span class="op" id="8275950">!=</span>&nbsp;<span class="ident" id="8275953">nil</span>&nbsp;<span class="op" id="8275957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275961"><a href="/net/http/httputil/reverseproxy_test.go.html#8275708">t</a></span><span class="op" id="8275962">.</span><span class="ident" id="8275963">Fatal</span><span class="op" id="8275968">(</span><span class="ident" id="8275969"><a href="/net/http/httputil/reverseproxy_test.go.html#8275912">err</a></span><span class="op" id="8275972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8275975">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8275979">proxyHandler</span>&nbsp;<span class="op" id="8275992">:=</span>&nbsp;<span class="ident" id="8275995"><a href="/net/http/httputil/reverseproxy.go.html#5539429">NewSingleHostReverseProxy</a></span><span class="op" id="8276020">(</span><span class="ident" id="8276021"><a href="/net/http/httputil/reverseproxy_test.go.html#8275900">backendURL</a></span><span class="op" id="8276031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8276034"><a href="/net/http/httputil/reverseproxy_test.go.html#8275979">proxyHandler</a></span><span class="op" id="8276046">.</span><span class="ident" id="8276047">FlushInterval</span>&nbsp;<span class="op" id="8276061">=</span>&nbsp;<span class="ident" id="8276063"><a href="/net/http/httputil/reverseproxy_test.go.html#8270695">time</a></span><span class="op" id="8276067">.</span><span class="ident" id="8276068">Microsecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8276082">done</span>&nbsp;<span class="op" id="8276087">:=</span>&nbsp;<span class="builtinfunc" id="8276090">make</span><span class="op" id="8276094">(</span><span class="keyword" id="8276095">chan</span>&nbsp;<span class="builtintype" id="8276100">bool</span><span class="op" id="8276104">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8276107"><a href="/net/http/httputil/reverseproxy.go.html#5537997">onExitFlushLoop</a></span>&nbsp;<span class="op" id="8276123">=</span>&nbsp;<span class="keyword" id="8276125">func</span><span class="op" id="8276129">(</span><span class="op" id="8276130">)</span>&nbsp;<span class="op" id="8276132">{</span>&nbsp;<span class="ident" id="8276134"><a href="/net/http/httputil/reverseproxy_test.go.html#8276082">done</a></span>&nbsp;<span class="op" id="8276139">&lt;-</span>&nbsp;<span class="builtintype" id="8276142">true</span>&nbsp;<span class="op" id="8276147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8276150">defer</span>&nbsp;<span class="keyword" id="8276156">func</span><span class="op" id="8276160">(</span><span class="op" id="8276161">)</span>&nbsp;<span class="op" id="8276163">{</span>&nbsp;<span class="ident" id="8276165"><a href="/net/http/httputil/reverseproxy.go.html#5537997">onExitFlushLoop</a></span>&nbsp;<span class="op" id="8276181">=</span>&nbsp;<span class="ident" id="8276183">nil</span>&nbsp;<span class="op" id="8276187">}</span><span class="op" id="8276188">(</span><span class="op" id="8276189">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8276193">frontend</span>&nbsp;<span class="op" id="8276202">:=</span>&nbsp;<span class="ident" id="8276205"><a href="/net/http/httputil/reverseproxy_test.go.html#8270641">httptest</a></span><span class="op" id="8276213">.</span><span class="ident" id="8276214">NewServer</span><span class="op" id="8276223">(</span><span class="ident" id="8276224"><a href="/net/http/httputil/reverseproxy_test.go.html#8275979">proxyHandler</a></span><span class="op" id="8276236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8276239">defer</span>&nbsp;<span class="ident" id="8276245"><a href="/net/http/httputil/reverseproxy_test.go.html#8276193">frontend</a></span><span class="op" id="8276253">.</span><span class="ident" id="8276254">Close</span><span class="op" id="8276259">(</span><span class="op" id="8276260">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8276264">req</span><span class="op" id="8276267">,</span>&nbsp;<span class="ident" id="8276269">_</span>&nbsp;<span class="op" id="8276271">:=</span>&nbsp;<span class="ident" id="8276274"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8276278">.</span><span class="ident" id="8276279">NewRequest</span><span class="op" id="8276289">(</span><span class="string" id="8276290">&#34;GET&#34;</span><span class="op" id="8276295">,</span>&nbsp;<span class="ident" id="8276297"><a href="/net/http/httputil/reverseproxy_test.go.html#8276193">frontend</a></span><span class="op" id="8276305">.</span><span class="ident" id="8276306">URL</span><span class="op" id="8276309">,</span>&nbsp;<span class="ident" id="8276311">nil</span><span class="op" id="8276314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8276317"><a href="/net/http/httputil/reverseproxy_test.go.html#8276264">req</a></span><span class="op" id="8276320">.</span><span class="ident" id="8276321">Close</span>&nbsp;<span class="op" id="8276327">=</span>&nbsp;<span class="builtintype" id="8276329">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8276335">res</span><span class="op" id="8276338">,</span>&nbsp;<span class="ident" id="8276340"><a href="/net/http/httputil/reverseproxy_test.go.html#8275912">err</a></span>&nbsp;<span class="op" id="8276344">:=</span>&nbsp;<span class="ident" id="8276347"><a href="/net/http/httputil/reverseproxy_test.go.html#8270629">http</a></span><span class="op" id="8276351">.</span><span class="ident" id="8276352">DefaultClient</span><span class="op" id="8276365">.</span><span class="ident" id="8276366">Do</span><span class="op" id="8276368">(</span><span class="ident" id="8276369"><a href="/net/http/httputil/reverseproxy_test.go.html#8276264">req</a></span><span class="op" id="8276372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8276375">if</span>&nbsp;<span class="ident" id="8276378"><a href="/net/http/httputil/reverseproxy_test.go.html#8275912">err</a></span>&nbsp;<span class="op" id="8276382">!=</span>&nbsp;<span class="ident" id="8276385">nil</span>&nbsp;<span class="op" id="8276389">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8276393"><a href="/net/http/httputil/reverseproxy_test.go.html#8275708">t</a></span><span class="op" id="8276394">.</span><span class="ident" id="8276395">Fatalf</span><span class="op" id="8276401">(</span><span class="string" id="8276402">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="8276411">,</span>&nbsp;<span class="ident" id="8276413"><a href="/net/http/httputil/reverseproxy_test.go.html#8275912">err</a></span><span class="op" id="8276416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8276419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8276422">defer</span>&nbsp;<span class="ident" id="8276428"><a href="/net/http/httputil/reverseproxy_test.go.html#8276335">res</a></span><span class="op" id="8276431">.</span><span class="ident" id="8276432">Body</span><span class="op" id="8276436">.</span><span class="ident" id="8276437">Close</span><span class="op" id="8276442">(</span><span class="op" id="8276443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8276446">if</span>&nbsp;<span class="ident" id="8276449">bodyBytes</span><span class="op" id="8276458">,</span>&nbsp;<span class="ident" id="8276460">_</span>&nbsp;<span class="op" id="8276462">:=</span>&nbsp;<span class="ident" id="8276465"><a href="/net/http/httputil/reverseproxy_test.go.html#8270616">ioutil</a></span><span class="op" id="8276471">.</span><span class="ident" id="8276472">ReadAll</span><span class="op" id="8276479">(</span><span class="ident" id="8276480"><a href="/net/http/httputil/reverseproxy_test.go.html#8276335">res</a></span><span class="op" id="8276483">.</span><span class="ident" id="8276484">Body</span><span class="op" id="8276488">)</span><span class="op" id="8276489">;</span>&nbsp;<span class="builtintype" id="8276491">string</span><span class="op" id="8276497">(</span><span class="ident" id="8276498"><a href="/net/http/httputil/reverseproxy_test.go.html#8276449">bodyBytes</a></span><span class="op" id="8276507">)</span>&nbsp;<span class="op" id="8276509">!=</span>&nbsp;<span class="ident" id="8276512"><a href="/net/http/httputil/reverseproxy_test.go.html#8275731">expected</a></span>&nbsp;<span class="op" id="8276521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8276525"><a href="/net/http/httputil/reverseproxy_test.go.html#8275708">t</a></span><span class="op" id="8276526">.</span><span class="ident" id="8276527">Errorf</span><span class="op" id="8276533">(</span><span class="string" id="8276534">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8276560">,</span>&nbsp;<span class="ident" id="8276562"><a href="/net/http/httputil/reverseproxy_test.go.html#8276449">bodyBytes</a></span><span class="op" id="8276571">,</span>&nbsp;<span class="ident" id="8276573"><a href="/net/http/httputil/reverseproxy_test.go.html#8275731">expected</a></span><span class="op" id="8276581">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8276584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8276588">select</span>&nbsp;<span class="op" id="8276595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8276598">case</span>&nbsp;<span class="op" id="8276603">&lt;-</span><span class="ident" id="8276605"><a href="/net/http/httputil/reverseproxy_test.go.html#8276082">done</a></span><span class="op" id="8276609">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8276613">//&nbsp;OK</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8276620">case</span>&nbsp;<span class="op" id="8276625">&lt;-</span><span class="ident" id="8276627"><a href="/net/http/httputil/reverseproxy_test.go.html#8270695">time</a></span><span class="op" id="8276631">.</span><span class="ident" id="8276632">After</span><span class="op" id="8276637">(</span><span class="num" id="8276638">5</span>&nbsp;<span class="op" id="8276640">*</span>&nbsp;<span class="ident" id="8276642"><a href="/net/http/httputil/reverseproxy_test.go.html#8270695">time</a></span><span class="op" id="8276646">.</span><span class="ident" id="8276647">Second</span><span class="op" id="8276653">)</span><span class="op" id="8276654">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8276658"><a href="/net/http/httputil/reverseproxy_test.go.html#8275708">t</a></span><span class="op" id="8276659">.</span><span class="ident" id="8276660">Error</span><span class="op" id="8276665">(</span><span class="string" id="8276666">&#34;maxLatencyWriter&nbsp;flushLoop()&nbsp;never&nbsp;exited&#34;</span><span class="op" id="8276709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8276712">}</span><br>
<span class="lineno"></span><span class="op" id="8276714">}</span>
</div>
</body>
</html>
