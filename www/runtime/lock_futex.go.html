<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1571301">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1571356">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1571410">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1571461">//&nbsp;+build&nbsp;dragonfly&nbsp;freebsd&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1571496">package</span>&nbsp;<span class="ident" id="1571504">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1571513">import</span>&nbsp;<span class="string" id="1571520">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1571530">//&nbsp;This&nbsp;implementation&nbsp;depends&nbsp;on&nbsp;OS-specific&nbsp;implementations&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1571595">//</span><br>
<span class="lineno"></span><span class="comment" id="1571598">//&nbsp;&nbsp;&nbsp;&nbspruntime·futexsleep(uint32&nbsp;*addr,&nbsp;uint32&nbsp;val,&nbsp;int64&nbsp;ns)</span><br>
<span class="lineno"></span><span class="comment" id="1571657">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspAtomically,</span><br>
<span class="lineno">15</span><span class="comment" id="1571673">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif(*addr&nbsp;==&nbsp;val)&nbsp;sleep</span><br>
<span class="lineno"></span><span class="comment" id="1571701">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspMight&nbsp;be&nbsp;woken&nbsp;up&nbsp;spuriously;&nbsp;that&#39;s&nbsp;allowed.</span><br>
<span class="lineno"></span><span class="comment" id="1571751">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspDon&#39;t&nbsp;sleep&nbsp;longer&nbsp;than&nbsp;ns;&nbsp;ns&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;forever.</span><br>
<span class="lineno"></span><span class="comment" id="1571805">//</span><br>
<span class="lineno"></span><span class="comment" id="1571808">//&nbsp;&nbsp;&nbsp;&nbspruntime·futexwakeup(uint32&nbsp;*addr,&nbsp;uint32&nbsp;cnt)</span><br>
<span class="lineno">20</span><span class="comment" id="1571858">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;any&nbsp;procs&nbsp;are&nbsp;sleeping&nbsp;on&nbsp;addr,&nbsp;wake&nbsp;up&nbsp;at&nbsp;most&nbsp;cnt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1571919">const</span>&nbsp;<span class="op" id="1571925">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1571928">mutex_unlocked</span>&nbsp;<span class="op" id="1571943">=</span>&nbsp;<span class="num" id="1571945">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1571948">mutex_locked</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1571963">=</span>&nbsp;<span class="num" id="1571965">1</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1571968">mutex_sleeping</span>&nbsp;<span class="op" id="1571983">=</span>&nbsp;<span class="num" id="1571985">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1571989">active_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1572005">=</span>&nbsp;<span class="num" id="1572007">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1572010">active_spin_cnt</span>&nbsp;<span class="op" id="1572026">=</span>&nbsp;<span class="num" id="1572028">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1572032">passive_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1572048">=</span>&nbsp;<span class="num" id="1572050">1</span><br>
<span class="lineno">30</span><span class="op" id="1572052">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1572055">//&nbsp;Possible&nbsp;lock&nbsp;states&nbsp;are&nbsp;mutex_unlocked,&nbsp;mutex_locked&nbsp;and&nbsp;mutex_sleeping.</span><br>
<span class="lineno"></span><span class="comment" id="1572132">//&nbsp;mutex_sleeping&nbsp;means&nbsp;that&nbsp;there&nbsp;is&nbsp;presumably&nbsp;at&nbsp;least&nbsp;one&nbsp;sleeping&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1572211">//&nbsp;Note&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;spinning&nbsp;threads&nbsp;during&nbsp;all&nbsp;states&nbsp;-&nbsp;they&nbsp;do&nbsp;not</span><br>
<span class="lineno">35</span><span class="comment" id="1572286">//&nbsp;affect&nbsp;mutex&#39;s&nbsp;state.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1572312">func</span>&nbsp;<span class="ident" id="1572317">futexsleep</span><span class="op" id="1572327">(</span><span class="ident" id="1572328">addr</span>&nbsp;<span class="op" id="1572333">*</span><span class="builtintype" id="1572334">uint32</span><span class="op" id="1572340">,</span>&nbsp;<span class="ident" id="1572342">val</span>&nbsp;<span class="builtintype" id="1572346">uint32</span><span class="op" id="1572352">,</span>&nbsp;<span class="ident" id="1572354">ns</span>&nbsp;<span class="ident" id="1572357">int64</span><span class="op" id="1572362">)</span><br>
<span class="lineno"></span><span class="keyword" id="1572364">func</span>&nbsp;<span class="ident" id="1572369">futexwakeup</span><span class="op" id="1572380">(</span><span class="ident" id="1572381">addr</span>&nbsp;<span class="op" id="1572386">*</span><span class="builtintype" id="1572387">uint32</span><span class="op" id="1572393">,</span>&nbsp;<span class="ident" id="1572395">cnt</span>&nbsp;<span class="builtintype" id="1572399">uint32</span><span class="op" id="1572405">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1572408">//&nbsp;We&nbsp;use&nbsp;the&nbsp;uintptr&nbsp;mutex.key&nbsp;and&nbsp;note.key&nbsp;as&nbsp;a&nbsp;uint32.</span><br>
<span class="lineno"></span><span class="keyword" id="1572466">func</span>&nbsp;<span class="ident" id="1572471">key32</span><span class="op" id="1572476">(</span><span class="ident" id="1572477">p</span>&nbsp;<span class="op" id="1572479">*</span><span class="builtintype" id="1572480">uintptr</span><span class="op" id="1572487">)</span>&nbsp;<span class="op" id="1572489">*</span><span class="builtintype" id="1572490">uint32</span>&nbsp;<span class="op" id="1572497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1572500">return</span>&nbsp;<span class="op" id="1572507">(</span><span class="op" id="1572508">*</span><span class="builtintype" id="1572509">uint32</span><span class="op" id="1572515">)</span><span class="op" id="1572516">(</span><span class="ident" id="1572517">unsafe</span><span class="op" id="1572523">.</span><span class="ident" id="1572524">Pointer</span><span class="op" id="1572531">(</span><span class="ident" id="1572532">p</span><span class="op" id="1572533">)</span><span class="op" id="1572534">)</span><br>
<span class="lineno"></span><span class="op" id="1572536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1572539">func</span>&nbsp;<span class="ident" id="1572544">lock</span><span class="op" id="1572548">(</span><span class="ident" id="1572549">l</span>&nbsp;<span class="op" id="1572551">*</span><span class="ident" id="1572552">mutex</span><span class="op" id="1572557">)</span>&nbsp;<span class="op" id="1572559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1572562">gp</span>&nbsp;<span class="op" id="1572565">:=</span>&nbsp;<span class="ident" id="1572568">getg</span><span class="op" id="1572572">(</span><span class="op" id="1572573">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1572577">if</span>&nbsp;<span class="ident" id="1572580">gp</span><span class="op" id="1572582">.</span><span class="ident" id="1572583">m</span><span class="op" id="1572584">.</span><span class="ident" id="1572585">locks</span>&nbsp;<span class="op" id="1572591">&lt;</span>&nbsp;<span class="num" id="1572593">0</span>&nbsp;<span class="op" id="1572595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1572599">gothrow</span><span class="op" id="1572606">(</span><span class="string" id="1572607">&#34;runtime·lock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1572634">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1572637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1572640">gp</span><span class="op" id="1572642">.</span><span class="ident" id="1572643">m</span><span class="op" id="1572644">.</span><span class="ident" id="1572645">locks</span><span class="op" id="1572650">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1572655">//&nbsp;Speculative&nbsp;grab&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1572686">v</span>&nbsp;<span class="op" id="1572688">:=</span>&nbsp;<span class="ident" id="1572691">xchg</span><span class="op" id="1572695">(</span><span class="ident" id="1572696">key32</span><span class="op" id="1572701">(</span><span class="op" id="1572702">&amp;</span><span class="ident" id="1572703">l</span><span class="op" id="1572704">.</span><span class="ident" id="1572705">key</span><span class="op" id="1572708">)</span><span class="op" id="1572709">,</span>&nbsp;<span class="ident" id="1572711">mutex_locked</span><span class="op" id="1572723">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1572726">if</span>&nbsp;<span class="ident" id="1572729">v</span>&nbsp;<span class="op" id="1572731">==</span>&nbsp;<span class="ident" id="1572734">mutex_unlocked</span>&nbsp;<span class="op" id="1572749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1572753">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1572761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1572765">//&nbsp;wait&nbsp;is&nbsp;either&nbsp;MUTEX_LOCKED&nbsp;or&nbsp;MUTEX_SLEEPING</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1572815">//&nbsp;depending&nbsp;on&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;thread&nbsp;sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1572867">//&nbsp;on&nbsp;this&nbsp;mutex.&nbsp;&nbsp;If&nbsp;we&nbsp;ever&nbsp;change&nbsp;l-&gt;key&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1572917">//&nbsp;MUTEX_SLEEPING&nbsp;to&nbsp;some&nbsp;other&nbsp;value,&nbsp;we&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1572968">//&nbsp;careful&nbsp;to&nbsp;change&nbsp;it&nbsp;back&nbsp;to&nbsp;MUTEX_SLEEPING&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1573023">//&nbsp;returning,&nbsp;to&nbsp;ensure&nbsp;that&nbsp;the&nbsp;sleeping&nbsp;thread&nbsp;gets</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1573078">//&nbsp;its&nbsp;wakeup&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1573099">wait</span>&nbsp;<span class="op" id="1573104">:=</span>&nbsp;<span class="ident" id="1573107">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1573111">//&nbsp;On&nbsp;uniprocessors,&nbsp;no&nbsp;point&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1573152">//&nbsp;On&nbsp;multiprocessors,&nbsp;spin&nbsp;for&nbsp;ACTIVE_SPIN&nbsp;attempts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1573207">spin</span>&nbsp;<span class="op" id="1573212">:=</span>&nbsp;<span class="num" id="1573215">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1573218">if</span>&nbsp;<span class="ident" id="1573221">ncpu</span>&nbsp;<span class="op" id="1573226">&gt;</span>&nbsp;<span class="num" id="1573228">1</span>&nbsp;<span class="op" id="1573230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1573234">spin</span>&nbsp;<span class="op" id="1573239">=</span>&nbsp;<span class="ident" id="1573241">active_spin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1573254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1573257">for</span>&nbsp;<span class="op" id="1573261">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1573265">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1573294">for</span>&nbsp;<span class="ident" id="1573298">i</span>&nbsp;<span class="op" id="1573300">:=</span>&nbsp;<span class="num" id="1573303">0</span><span class="op" id="1573304">;</span>&nbsp;<span class="ident" id="1573306">i</span>&nbsp;<span class="op" id="1573308">&lt;</span>&nbsp;<span class="ident" id="1573310">spin</span><span class="op" id="1573314">;</span>&nbsp;<span class="ident" id="1573316">i</span><span class="op" id="1573317">++</span>&nbsp;<span class="op" id="1573320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1573325">for</span>&nbsp;<span class="ident" id="1573329">l</span><span class="op" id="1573330">.</span><span class="ident" id="1573331">key</span>&nbsp;<span class="op" id="1573335">==</span>&nbsp;<span class="ident" id="1573338">mutex_unlocked</span>&nbsp;<span class="op" id="1573353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1573359">if</span>&nbsp;<span class="ident" id="1573362">cas</span><span class="op" id="1573365">(</span><span class="ident" id="1573366">key32</span><span class="op" id="1573371">(</span><span class="op" id="1573372">&amp;</span><span class="ident" id="1573373">l</span><span class="op" id="1573374">.</span><span class="ident" id="1573375">key</span><span class="op" id="1573378">)</span><span class="op" id="1573379">,</span>&nbsp;<span class="ident" id="1573381">mutex_unlocked</span><span class="op" id="1573395">,</span>&nbsp;<span class="ident" id="1573397">wait</span><span class="op" id="1573401">)</span>&nbsp;<span class="op" id="1573403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1573410">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1573421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1573426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1573431">procyield</span><span class="op" id="1573440">(</span><span class="ident" id="1573441">active_spin_cnt</span><span class="op" id="1573456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1573460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1573465">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;rescheduling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1573498">for</span>&nbsp;<span class="ident" id="1573502">i</span>&nbsp;<span class="op" id="1573504">:=</span>&nbsp;<span class="num" id="1573507">0</span><span class="op" id="1573508">;</span>&nbsp;<span class="ident" id="1573510">i</span>&nbsp;<span class="op" id="1573512">&lt;</span>&nbsp;<span class="ident" id="1573514">passive_spin</span><span class="op" id="1573526">;</span>&nbsp;<span class="ident" id="1573528">i</span><span class="op" id="1573529">++</span>&nbsp;<span class="op" id="1573532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1573537">for</span>&nbsp;<span class="ident" id="1573541">l</span><span class="op" id="1573542">.</span><span class="ident" id="1573543">key</span>&nbsp;<span class="op" id="1573547">==</span>&nbsp;<span class="ident" id="1573550">mutex_unlocked</span>&nbsp;<span class="op" id="1573565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1573571">if</span>&nbsp;<span class="ident" id="1573574">cas</span><span class="op" id="1573577">(</span><span class="ident" id="1573578">key32</span><span class="op" id="1573583">(</span><span class="op" id="1573584">&amp;</span><span class="ident" id="1573585">l</span><span class="op" id="1573586">.</span><span class="ident" id="1573587">key</span><span class="op" id="1573590">)</span><span class="op" id="1573591">,</span>&nbsp;<span class="ident" id="1573593">mutex_unlocked</span><span class="op" id="1573607">,</span>&nbsp;<span class="ident" id="1573609">wait</span><span class="op" id="1573613">)</span>&nbsp;<span class="op" id="1573615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1573622">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1573633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1573638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1573643">osyield</span><span class="op" id="1573650">(</span><span class="op" id="1573651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1573655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1573660">//&nbsp;Sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1573672">v</span>&nbsp;<span class="op" id="1573674">=</span>&nbsp;<span class="ident" id="1573676">xchg</span><span class="op" id="1573680">(</span><span class="ident" id="1573681">key32</span><span class="op" id="1573686">(</span><span class="op" id="1573687">&amp;</span><span class="ident" id="1573688">l</span><span class="op" id="1573689">.</span><span class="ident" id="1573690">key</span><span class="op" id="1573693">)</span><span class="op" id="1573694">,</span>&nbsp;<span class="ident" id="1573696">mutex_sleeping</span><span class="op" id="1573710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1573714">if</span>&nbsp;<span class="ident" id="1573717">v</span>&nbsp;<span class="op" id="1573719">==</span>&nbsp;<span class="ident" id="1573722">mutex_unlocked</span>&nbsp;<span class="op" id="1573737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1573742">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1573751">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1573755">wait</span>&nbsp;<span class="op" id="1573760">=</span>&nbsp;<span class="ident" id="1573762">mutex_sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1573779">futexsleep</span><span class="op" id="1573789">(</span><span class="ident" id="1573790">key32</span><span class="op" id="1573795">(</span><span class="op" id="1573796">&amp;</span><span class="ident" id="1573797">l</span><span class="op" id="1573798">.</span><span class="ident" id="1573799">key</span><span class="op" id="1573802">)</span><span class="op" id="1573803">,</span>&nbsp;<span class="ident" id="1573805">mutex_sleeping</span><span class="op" id="1573819">,</span>&nbsp;<span class="op" id="1573821">-</span><span class="num" id="1573822">1</span><span class="op" id="1573823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1573826">}</span><br>
<span class="lineno"></span><span class="op" id="1573828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="1573831">func</span>&nbsp;<span class="ident" id="1573836">unlock</span><span class="op" id="1573842">(</span><span class="ident" id="1573843">l</span>&nbsp;<span class="op" id="1573845">*</span><span class="ident" id="1573846">mutex</span><span class="op" id="1573851">)</span>&nbsp;<span class="op" id="1573853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1573856">v</span>&nbsp;<span class="op" id="1573858">:=</span>&nbsp;<span class="ident" id="1573861">xchg</span><span class="op" id="1573865">(</span><span class="ident" id="1573866">key32</span><span class="op" id="1573871">(</span><span class="op" id="1573872">&amp;</span><span class="ident" id="1573873">l</span><span class="op" id="1573874">.</span><span class="ident" id="1573875">key</span><span class="op" id="1573878">)</span><span class="op" id="1573879">,</span>&nbsp;<span class="ident" id="1573881">mutex_unlocked</span><span class="op" id="1573895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1573898">if</span>&nbsp;<span class="ident" id="1573901">v</span>&nbsp;<span class="op" id="1573903">==</span>&nbsp;<span class="ident" id="1573906">mutex_unlocked</span>&nbsp;<span class="op" id="1573921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1573925">gothrow</span><span class="op" id="1573932">(</span><span class="string" id="1573933">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;lock&#34;</span><span class="op" id="1573958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1573961">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1573964">if</span>&nbsp;<span class="ident" id="1573967">v</span>&nbsp;<span class="op" id="1573969">==</span>&nbsp;<span class="ident" id="1573972">mutex_sleeping</span>&nbsp;<span class="op" id="1573987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1573991">futexwakeup</span><span class="op" id="1574002">(</span><span class="ident" id="1574003">key32</span><span class="op" id="1574008">(</span><span class="op" id="1574009">&amp;</span><span class="ident" id="1574010">l</span><span class="op" id="1574011">.</span><span class="ident" id="1574012">key</span><span class="op" id="1574015">)</span><span class="op" id="1574016">,</span>&nbsp;<span class="num" id="1574018">1</span><span class="op" id="1574019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1574022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574026">gp</span>&nbsp;<span class="op" id="1574029">:=</span>&nbsp;<span class="ident" id="1574032">getg</span><span class="op" id="1574036">(</span><span class="op" id="1574037">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574040">gp</span><span class="op" id="1574042">.</span><span class="ident" id="1574043">m</span><span class="op" id="1574044">.</span><span class="ident" id="1574045">locks</span><span class="op" id="1574050">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1574054">if</span>&nbsp;<span class="ident" id="1574057">gp</span><span class="op" id="1574059">.</span><span class="ident" id="1574060">m</span><span class="op" id="1574061">.</span><span class="ident" id="1574062">locks</span>&nbsp;<span class="op" id="1574068">&lt;</span>&nbsp;<span class="num" id="1574070">0</span>&nbsp;<span class="op" id="1574072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574076">gothrow</span><span class="op" id="1574083">(</span><span class="string" id="1574084">&#34;runtime·unlock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1574113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1574116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1574119">if</span>&nbsp;<span class="ident" id="1574122">gp</span><span class="op" id="1574124">.</span><span class="ident" id="1574125">m</span><span class="op" id="1574126">.</span><span class="ident" id="1574127">locks</span>&nbsp;<span class="op" id="1574133">==</span>&nbsp;<span class="num" id="1574136">0</span>&nbsp;<span class="op" id="1574138">&amp;&amp;</span>&nbsp;<span class="ident" id="1574141">gp</span><span class="op" id="1574143">.</span><span class="ident" id="1574144">preempt</span>&nbsp;<span class="op" id="1574152">{</span>&nbsp;<span class="comment" id="1574154">//&nbsp;restore&nbsp;the&nbsp;preemption&nbsp;request&nbsp;in&nbsp;case&nbsp;we&#39;ve&nbsp;cleared&nbsp;it&nbsp;in&nbsp;newstack</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574227">gp</span><span class="op" id="1574229">.</span><span class="ident" id="1574230">stackguard0</span>&nbsp;<span class="op" id="1574242">=</span>&nbsp;<span class="ident" id="1574244">stackPreempt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1574258">}</span><br>
<span class="lineno"></span><span class="op" id="1574260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1574263">//&nbsp;One-time&nbsp;notifications.</span><br>
<span class="lineno">125</span><span class="keyword" id="1574290">func</span>&nbsp;<span class="ident" id="1574295">noteclear</span><span class="op" id="1574304">(</span><span class="ident" id="1574305">n</span>&nbsp;<span class="op" id="1574307">*</span><span class="ident" id="1574308">note</span><span class="op" id="1574312">)</span>&nbsp;<span class="op" id="1574314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574317">n</span><span class="op" id="1574318">.</span><span class="ident" id="1574319">key</span>&nbsp;<span class="op" id="1574323">=</span>&nbsp;<span class="num" id="1574325">0</span><br>
<span class="lineno"></span><span class="op" id="1574327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1574330">func</span>&nbsp;<span class="ident" id="1574335">notewakeup</span><span class="op" id="1574345">(</span><span class="ident" id="1574346">n</span>&nbsp;<span class="op" id="1574348">*</span><span class="ident" id="1574349">note</span><span class="op" id="1574353">)</span>&nbsp;<span class="op" id="1574355">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574358">old</span>&nbsp;<span class="op" id="1574362">:=</span>&nbsp;<span class="ident" id="1574365">xchg</span><span class="op" id="1574369">(</span><span class="ident" id="1574370">key32</span><span class="op" id="1574375">(</span><span class="op" id="1574376">&amp;</span><span class="ident" id="1574377">n</span><span class="op" id="1574378">.</span><span class="ident" id="1574379">key</span><span class="op" id="1574382">)</span><span class="op" id="1574383">,</span>&nbsp;<span class="num" id="1574385">1</span><span class="op" id="1574386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1574389">if</span>&nbsp;<span class="ident" id="1574392">old</span>&nbsp;<span class="op" id="1574396">!=</span>&nbsp;<span class="num" id="1574399">0</span>&nbsp;<span class="op" id="1574401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1574405">print</span><span class="op" id="1574410">(</span><span class="string" id="1574411">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&nbsp;(&#34;</span><span class="op" id="1574441">,</span>&nbsp;<span class="ident" id="1574443">old</span><span class="op" id="1574446">,</span>&nbsp;<span class="string" id="1574448">&#34;)\n&#34;</span><span class="op" id="1574453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574457">gothrow</span><span class="op" id="1574464">(</span><span class="string" id="1574465">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&#34;</span><span class="op" id="1574493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1574496">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574499">futexwakeup</span><span class="op" id="1574510">(</span><span class="ident" id="1574511">key32</span><span class="op" id="1574516">(</span><span class="op" id="1574517">&amp;</span><span class="ident" id="1574518">n</span><span class="op" id="1574519">.</span><span class="ident" id="1574520">key</span><span class="op" id="1574523">)</span><span class="op" id="1574524">,</span>&nbsp;<span class="num" id="1574526">1</span><span class="op" id="1574527">)</span><br>
<span class="lineno"></span><span class="op" id="1574529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1574532">func</span>&nbsp;<span class="ident" id="1574537">notesleep</span><span class="op" id="1574546">(</span><span class="ident" id="1574547">n</span>&nbsp;<span class="op" id="1574549">*</span><span class="ident" id="1574550">note</span><span class="op" id="1574554">)</span>&nbsp;<span class="op" id="1574556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574559">gp</span>&nbsp;<span class="op" id="1574562">:=</span>&nbsp;<span class="ident" id="1574565">getg</span><span class="op" id="1574569">(</span><span class="op" id="1574570">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1574573">if</span>&nbsp;<span class="ident" id="1574576">gp</span>&nbsp;<span class="op" id="1574579">!=</span>&nbsp;<span class="ident" id="1574582">gp</span><span class="op" id="1574584">.</span><span class="ident" id="1574585">m</span><span class="op" id="1574586">.</span><span class="ident" id="1574587">g0</span>&nbsp;<span class="op" id="1574590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574594">gothrow</span><span class="op" id="1574601">(</span><span class="string" id="1574602">&#34;notesleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1574623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1574626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1574629">for</span>&nbsp;<span class="ident" id="1574633">atomicload</span><span class="op" id="1574643">(</span><span class="ident" id="1574644">key32</span><span class="op" id="1574649">(</span><span class="op" id="1574650">&amp;</span><span class="ident" id="1574651">n</span><span class="op" id="1574652">.</span><span class="ident" id="1574653">key</span><span class="op" id="1574656">)</span><span class="op" id="1574657">)</span>&nbsp;<span class="op" id="1574659">==</span>&nbsp;<span class="num" id="1574662">0</span>&nbsp;<span class="op" id="1574664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574668">gp</span><span class="op" id="1574670">.</span><span class="ident" id="1574671">m</span><span class="op" id="1574672">.</span><span class="ident" id="1574673">blocked</span>&nbsp;<span class="op" id="1574681">=</span>&nbsp;<span class="ident" id="1574683">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574690">futexsleep</span><span class="op" id="1574700">(</span><span class="ident" id="1574701">key32</span><span class="op" id="1574706">(</span><span class="op" id="1574707">&amp;</span><span class="ident" id="1574708">n</span><span class="op" id="1574709">.</span><span class="ident" id="1574710">key</span><span class="op" id="1574713">)</span><span class="op" id="1574714">,</span>&nbsp;<span class="num" id="1574716">0</span><span class="op" id="1574717">,</span>&nbsp;<span class="op" id="1574719">-</span><span class="num" id="1574720">1</span><span class="op" id="1574721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574725">gp</span><span class="op" id="1574727">.</span><span class="ident" id="1574728">m</span><span class="op" id="1574729">.</span><span class="ident" id="1574730">blocked</span>&nbsp;<span class="op" id="1574738">=</span>&nbsp;<span class="ident" id="1574740">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1574747">}</span><br>
<span class="lineno"></span><span class="op" id="1574749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1574752">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1574765">func</span>&nbsp;<span class="ident" id="1574770">notetsleep_internal</span><span class="op" id="1574789">(</span><span class="ident" id="1574790">n</span>&nbsp;<span class="op" id="1574792">*</span><span class="ident" id="1574793">note</span><span class="op" id="1574797">,</span>&nbsp;<span class="ident" id="1574799">ns</span>&nbsp;<span class="ident" id="1574802">int64</span><span class="op" id="1574807">)</span>&nbsp;<span class="builtintype" id="1574809">bool</span>&nbsp;<span class="op" id="1574814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574817">gp</span>&nbsp;<span class="op" id="1574820">:=</span>&nbsp;<span class="ident" id="1574823">getg</span><span class="op" id="1574827">(</span><span class="op" id="1574828">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1574832">if</span>&nbsp;<span class="ident" id="1574835">ns</span>&nbsp;<span class="op" id="1574838">&lt;</span>&nbsp;<span class="num" id="1574840">0</span>&nbsp;<span class="op" id="1574842">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1574846">for</span>&nbsp;<span class="ident" id="1574850">atomicload</span><span class="op" id="1574860">(</span><span class="ident" id="1574861">key32</span><span class="op" id="1574866">(</span><span class="op" id="1574867">&amp;</span><span class="ident" id="1574868">n</span><span class="op" id="1574869">.</span><span class="ident" id="1574870">key</span><span class="op" id="1574873">)</span><span class="op" id="1574874">)</span>&nbsp;<span class="op" id="1574876">==</span>&nbsp;<span class="num" id="1574879">0</span>&nbsp;<span class="op" id="1574881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574886">gp</span><span class="op" id="1574888">.</span><span class="ident" id="1574889">m</span><span class="op" id="1574890">.</span><span class="ident" id="1574891">blocked</span>&nbsp;<span class="op" id="1574899">=</span>&nbsp;<span class="ident" id="1574901">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574909">futexsleep</span><span class="op" id="1574919">(</span><span class="ident" id="1574920">key32</span><span class="op" id="1574925">(</span><span class="op" id="1574926">&amp;</span><span class="ident" id="1574927">n</span><span class="op" id="1574928">.</span><span class="ident" id="1574929">key</span><span class="op" id="1574932">)</span><span class="op" id="1574933">,</span>&nbsp;<span class="num" id="1574935">0</span><span class="op" id="1574936">,</span>&nbsp;<span class="op" id="1574938">-</span><span class="num" id="1574939">1</span><span class="op" id="1574940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574945">gp</span><span class="op" id="1574947">.</span><span class="ident" id="1574948">m</span><span class="op" id="1574949">.</span><span class="ident" id="1574950">blocked</span>&nbsp;<span class="op" id="1574958">=</span>&nbsp;<span class="ident" id="1574960">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1574968">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1574972">return</span>&nbsp;<span class="ident" id="1574979">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1574985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1574989">if</span>&nbsp;<span class="ident" id="1574992">atomicload</span><span class="op" id="1575002">(</span><span class="ident" id="1575003">key32</span><span class="op" id="1575008">(</span><span class="op" id="1575009">&amp;</span><span class="ident" id="1575010">n</span><span class="op" id="1575011">.</span><span class="ident" id="1575012">key</span><span class="op" id="1575015">)</span><span class="op" id="1575016">)</span>&nbsp;<span class="op" id="1575018">!=</span>&nbsp;<span class="num" id="1575021">0</span>&nbsp;<span class="op" id="1575023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575027">return</span>&nbsp;<span class="ident" id="1575034">true</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1575040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575044">deadline</span>&nbsp;<span class="op" id="1575053">:=</span>&nbsp;<span class="ident" id="1575056">nanotime</span><span class="op" id="1575064">(</span><span class="op" id="1575065">)</span>&nbsp;<span class="op" id="1575067">+</span>&nbsp;<span class="ident" id="1575069">ns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575073">for</span>&nbsp;<span class="op" id="1575077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575081">gp</span><span class="op" id="1575083">.</span><span class="ident" id="1575084">m</span><span class="op" id="1575085">.</span><span class="ident" id="1575086">blocked</span>&nbsp;<span class="op" id="1575094">=</span>&nbsp;<span class="ident" id="1575096">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575103">futexsleep</span><span class="op" id="1575113">(</span><span class="ident" id="1575114">key32</span><span class="op" id="1575119">(</span><span class="op" id="1575120">&amp;</span><span class="ident" id="1575121">n</span><span class="op" id="1575122">.</span><span class="ident" id="1575123">key</span><span class="op" id="1575126">)</span><span class="op" id="1575127">,</span>&nbsp;<span class="num" id="1575129">0</span><span class="op" id="1575130">,</span>&nbsp;<span class="ident" id="1575132">ns</span><span class="op" id="1575134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575138">gp</span><span class="op" id="1575140">.</span><span class="ident" id="1575141">m</span><span class="op" id="1575142">.</span><span class="ident" id="1575143">blocked</span>&nbsp;<span class="op" id="1575151">=</span>&nbsp;<span class="ident" id="1575153">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575161">if</span>&nbsp;<span class="ident" id="1575164">atomicload</span><span class="op" id="1575174">(</span><span class="ident" id="1575175">key32</span><span class="op" id="1575180">(</span><span class="op" id="1575181">&amp;</span><span class="ident" id="1575182">n</span><span class="op" id="1575183">.</span><span class="ident" id="1575184">key</span><span class="op" id="1575187">)</span><span class="op" id="1575188">)</span>&nbsp;<span class="op" id="1575190">!=</span>&nbsp;<span class="num" id="1575193">0</span>&nbsp;<span class="op" id="1575195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575200">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1575208">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575212">now</span>&nbsp;<span class="op" id="1575216">:=</span>&nbsp;<span class="ident" id="1575219">nanotime</span><span class="op" id="1575227">(</span><span class="op" id="1575228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575232">if</span>&nbsp;<span class="ident" id="1575235">now</span>&nbsp;<span class="op" id="1575239">&gt;=</span>&nbsp;<span class="ident" id="1575242">deadline</span>&nbsp;<span class="op" id="1575251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575256">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1575264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575268">ns</span>&nbsp;<span class="op" id="1575271">=</span>&nbsp;<span class="ident" id="1575273">deadline</span>&nbsp;<span class="op" id="1575282">-</span>&nbsp;<span class="ident" id="1575284">now</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1575289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575292">return</span>&nbsp;<span class="ident" id="1575299">atomicload</span><span class="op" id="1575309">(</span><span class="ident" id="1575310">key32</span><span class="op" id="1575315">(</span><span class="op" id="1575316">&amp;</span><span class="ident" id="1575317">n</span><span class="op" id="1575318">.</span><span class="ident" id="1575319">key</span><span class="op" id="1575322">)</span><span class="op" id="1575323">)</span>&nbsp;<span class="op" id="1575325">!=</span>&nbsp;<span class="num" id="1575328">0</span><br>
<span class="lineno"></span><span class="op" id="1575330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1575333">func</span>&nbsp;<span class="ident" id="1575338">notetsleep</span><span class="op" id="1575348">(</span><span class="ident" id="1575349">n</span>&nbsp;<span class="op" id="1575351">*</span><span class="ident" id="1575352">note</span><span class="op" id="1575356">,</span>&nbsp;<span class="ident" id="1575358">ns</span>&nbsp;<span class="ident" id="1575361">int64</span><span class="op" id="1575366">)</span>&nbsp;<span class="builtintype" id="1575368">bool</span>&nbsp;<span class="op" id="1575373">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575376">gp</span>&nbsp;<span class="op" id="1575379">:=</span>&nbsp;<span class="ident" id="1575382">getg</span><span class="op" id="1575386">(</span><span class="op" id="1575387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575390">if</span>&nbsp;<span class="ident" id="1575393">gp</span>&nbsp;<span class="op" id="1575396">!=</span>&nbsp;<span class="ident" id="1575399">gp</span><span class="op" id="1575401">.</span><span class="ident" id="1575402">m</span><span class="op" id="1575403">.</span><span class="ident" id="1575404">g0</span>&nbsp;<span class="op" id="1575407">&amp;&amp;</span>&nbsp;<span class="ident" id="1575410">gp</span><span class="op" id="1575412">.</span><span class="ident" id="1575413">m</span><span class="op" id="1575414">.</span><span class="ident" id="1575415">gcing</span>&nbsp;<span class="op" id="1575421">==</span>&nbsp;<span class="num" id="1575424">0</span>&nbsp;<span class="op" id="1575426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575430">gothrow</span><span class="op" id="1575437">(</span><span class="string" id="1575438">&#34;notetsleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1575460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1575463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575467">return</span>&nbsp;<span class="ident" id="1575474">notetsleep_internal</span><span class="op" id="1575493">(</span><span class="ident" id="1575494">n</span><span class="op" id="1575495">,</span>&nbsp;<span class="ident" id="1575497">ns</span><span class="op" id="1575499">)</span><br>
<span class="lineno"></span><span class="op" id="1575501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1575504">//&nbsp;same&nbsp;as&nbsp;runtime·notetsleep,&nbsp;but&nbsp;called&nbsp;on&nbsp;user&nbsp;g&nbsp;(not&nbsp;g0)</span><br>
<span class="lineno"></span><span class="comment" id="1575566">//&nbsp;calls&nbsp;only&nbsp;nosplit&nbsp;functions&nbsp;between&nbsp;entersyscallblock/exitsyscall</span><br>
<span class="lineno">195</span><span class="keyword" id="1575636">func</span>&nbsp;<span class="ident" id="1575641">notetsleepg</span><span class="op" id="1575652">(</span><span class="ident" id="1575653">n</span>&nbsp;<span class="op" id="1575655">*</span><span class="ident" id="1575656">note</span><span class="op" id="1575660">,</span>&nbsp;<span class="ident" id="1575662">ns</span>&nbsp;<span class="ident" id="1575665">int64</span><span class="op" id="1575670">)</span>&nbsp;<span class="builtintype" id="1575672">bool</span>&nbsp;<span class="op" id="1575677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575680">gp</span>&nbsp;<span class="op" id="1575683">:=</span>&nbsp;<span class="ident" id="1575686">getg</span><span class="op" id="1575690">(</span><span class="op" id="1575691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575694">if</span>&nbsp;<span class="ident" id="1575697">gp</span>&nbsp;<span class="op" id="1575700">==</span>&nbsp;<span class="ident" id="1575703">gp</span><span class="op" id="1575705">.</span><span class="ident" id="1575706">m</span><span class="op" id="1575707">.</span><span class="ident" id="1575708">g0</span>&nbsp;<span class="op" id="1575711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575715">gothrow</span><span class="op" id="1575722">(</span><span class="string" id="1575723">&#34;notetsleepg&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1575742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1575745">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575749">entersyscallblock</span><span class="op" id="1575766">(</span><span class="op" id="1575767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575770">ok</span>&nbsp;<span class="op" id="1575773">:=</span>&nbsp;<span class="ident" id="1575776">notetsleep_internal</span><span class="op" id="1575795">(</span><span class="ident" id="1575796">n</span><span class="op" id="1575797">,</span>&nbsp;<span class="ident" id="1575799">ns</span><span class="op" id="1575801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575804">exitsyscall</span><span class="op" id="1575815">(</span><span class="op" id="1575816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575819">return</span>&nbsp;<span class="ident" id="1575826">ok</span><br>
<span class="lineno">205</span><span class="op" id="1575829">}</span>
</div>
</body>
</html>
