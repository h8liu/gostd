<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3504513">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3504568">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3504622">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3504673">//&nbsp;HTTP&nbsp;server.&nbsp;&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3504705">package</span>&nbsp;<span class="ident" id="3504713">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3504719">import</span>&nbsp;<span class="op" id="3504726">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504729">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504738">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504752">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504762">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504769">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504775">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504788">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504795">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504802">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504813">&#34;os&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504819">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504827">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504838">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504849">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504860">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504868">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3504883">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3504890">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3504893">//&nbsp;Errors&nbsp;introduced&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">30</span><span class="keyword" id="3504934">var</span>&nbsp;<span class="op" id="3504938">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3504941">ErrWriteAfterFlush</span>&nbsp;<span class="op" id="3504960">=</span>&nbsp;<span class="ident" id="3504962">errors</span><span class="op" id="3504968">.</span><span class="ident" id="3504969">New</span><span class="op" id="3504972">(</span><span class="string" id="3504973">&#34;Conn.Write&nbsp;called&nbsp;after&nbsp;Flush&#34;</span><span class="op" id="3505004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3505007">ErrBodyNotAllowed</span>&nbsp;&nbsp;<span class="op" id="3505026">=</span>&nbsp;<span class="ident" id="3505028">errors</span><span class="op" id="3505034">.</span><span class="ident" id="3505035">New</span><span class="op" id="3505038">(</span><span class="string" id="3505039">&#34;http:&nbsp;request&nbsp;method&nbsp;or&nbsp;response&nbsp;status&nbsp;code&nbsp;does&nbsp;not&nbsp;allow&nbsp;body&#34;</span><span class="op" id="3505105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3505108">ErrHijacked</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3505127">=</span>&nbsp;<span class="ident" id="3505129">errors</span><span class="op" id="3505135">.</span><span class="ident" id="3505136">New</span><span class="op" id="3505139">(</span><span class="string" id="3505140">&#34;Conn&nbsp;has&nbsp;been&nbsp;hijacked&#34;</span><span class="op" id="3505164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3505167">ErrContentLength</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3505186">=</span>&nbsp;<span class="ident" id="3505188">errors</span><span class="op" id="3505194">.</span><span class="ident" id="3505195">New</span><span class="op" id="3505198">(</span><span class="string" id="3505199">&#34;Conn.Write&nbsp;wrote&nbsp;more&nbsp;than&nbsp;the&nbsp;declared&nbsp;Content-Length&#34;</span><span class="op" id="3505255">)</span><br>
<span class="lineno">35</span><span class="op" id="3505257">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3505260">//&nbsp;Objects&nbsp;implementing&nbsp;the&nbsp;Handler&nbsp;interface&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3505313">//&nbsp;registered&nbsp;to&nbsp;serve&nbsp;a&nbsp;particular&nbsp;path&nbsp;or&nbsp;subtree</span><br>
<span class="lineno"></span><span class="comment" id="3505365">//&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">40</span><span class="comment" id="3505388">//</span><br>
<span class="lineno"></span><span class="comment" id="3505391">//&nbsp;ServeHTTP&nbsp;should&nbsp;write&nbsp;reply&nbsp;headers&nbsp;and&nbsp;data&nbsp;to&nbsp;the&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3505462">//&nbsp;and&nbsp;then&nbsp;return.&nbsp;&nbsp;Returning&nbsp;signals&nbsp;that&nbsp;the&nbsp;request&nbsp;is&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3505530">//&nbsp;and&nbsp;that&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;can&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3505593">//&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">45</span><span class="comment" id="3505612">//</span><br>
<span class="lineno"></span><span class="comment" id="3505615">//&nbsp;If&nbsp;ServeHTTP&nbsp;panics,&nbsp;the&nbsp;server&nbsp;(the&nbsp;caller&nbsp;of&nbsp;ServeHTTP)&nbsp;assumes</span><br>
<span class="lineno"></span><span class="comment" id="3505684">//&nbsp;that&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;panic&nbsp;was&nbsp;isolated&nbsp;to&nbsp;the&nbsp;active&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3505752">//&nbsp;It&nbsp;recovers&nbsp;the&nbsp;panic,&nbsp;logs&nbsp;a&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;server&nbsp;error&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="3505822">//&nbsp;and&nbsp;hangs&nbsp;up&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">50</span><span class="comment" id="3505854">//</span><br>
<span class="lineno"></span><span class="keyword" id="3505857">type</span>&nbsp;<span class="ident" id="3505862">Handler</span>&nbsp;<span class="keyword" id="3505870">interface</span>&nbsp;<span class="op" id="3505880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3505883">ServeHTTP</span><span class="op" id="3505892">(</span><span class="ident" id="3505893">ResponseWriter</span><span class="op" id="3505907">,</span>&nbsp;<span class="op" id="3505909">*</span><span class="ident" id="3505910">Request</span><span class="op" id="3505917">)</span><br>
<span class="lineno"></span><span class="op" id="3505919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3505922">//&nbsp;A&nbsp;ResponseWriter&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3505982">//&nbsp;construct&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3506013">type</span>&nbsp;<span class="ident" id="3506018">ResponseWriter</span>&nbsp;<span class="keyword" id="3506033">interface</span>&nbsp;<span class="op" id="3506043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3506046">//&nbsp;Header&nbsp;returns&nbsp;the&nbsp;header&nbsp;map&nbsp;that&nbsp;will&nbsp;be&nbsp;sent&nbsp;by&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3506114">//&nbsp;Changing&nbsp;the&nbsp;header&nbsp;after&nbsp;a&nbsp;call&nbsp;to&nbsp;WriteHeader&nbsp;(or&nbsp;Write)&nbsp;has</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3506181">//&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3506196">Header</span><span class="op" id="3506202">(</span><span class="op" id="3506203">)</span>&nbsp;<span class="ident" id="3506205">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3506214">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;data&nbsp;to&nbsp;the&nbsp;connection&nbsp;as&nbsp;part&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3506284">//&nbsp;If&nbsp;WriteHeader&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;called,&nbsp;Write&nbsp;calls&nbsp;WriteHeader(http.StatusOK)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3506367">//&nbsp;before&nbsp;writing&nbsp;the&nbsp;data.&nbsp;&nbsp;If&nbsp;the&nbsp;Header&nbsp;does&nbsp;not&nbsp;contain&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3506430">//&nbsp;Content-Type&nbsp;line,&nbsp;Write&nbsp;adds&nbsp;a&nbsp;Content-Type&nbsp;set&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;passing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3506508">//&nbsp;the&nbsp;initial&nbsp;512&nbsp;bytes&nbsp;of&nbsp;written&nbsp;data&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3506572">Write</span><span class="op" id="3506577">(</span><span class="op" id="3506578">[</span><span class="op" id="3506579">]</span><span class="builtintype" id="3506580">byte</span><span class="op" id="3506584">)</span>&nbsp;<span class="op" id="3506586">(</span><span class="builtintype" id="3506587">int</span><span class="op" id="3506590">,</span>&nbsp;<span class="builtintype" id="3506592">error</span><span class="op" id="3506597">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3506601">//&nbsp;WriteHeader&nbsp;sends&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;header&nbsp;with&nbsp;status&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3506665">//&nbsp;If&nbsp;WriteHeader&nbsp;is&nbsp;not&nbsp;called&nbsp;explicitly,&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3506734">//&nbsp;will&nbsp;trigger&nbsp;an&nbsp;implicit&nbsp;WriteHeader(http.StatusOK).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3506791">//&nbsp;Thus&nbsp;explicit&nbsp;calls&nbsp;to&nbsp;WriteHeader&nbsp;are&nbsp;mainly&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3506849">//&nbsp;send&nbsp;error&nbsp;codes.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3506871">WriteHeader</span><span class="op" id="3506882">(</span><span class="builtintype" id="3506883">int</span><span class="op" id="3506886">)</span><br>
<span class="lineno"></span><span class="op" id="3506888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3506891">//&nbsp;The&nbsp;Flusher&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3506961">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;flush&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno">80</span><span class="comment" id="3507018">//</span><br>
<span class="lineno"></span><span class="comment" id="3507021">//&nbsp;Note&nbsp;that&nbsp;even&nbsp;for&nbsp;ResponseWriters&nbsp;that&nbsp;support&nbsp;Flush,</span><br>
<span class="lineno"></span><span class="comment" id="3507079">//&nbsp;if&nbsp;the&nbsp;client&nbsp;is&nbsp;connected&nbsp;through&nbsp;an&nbsp;HTTP&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="3507132">//&nbsp;the&nbsp;buffered&nbsp;data&nbsp;may&nbsp;not&nbsp;reach&nbsp;the&nbsp;client&nbsp;until&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="3507197">//&nbsp;completes.</span><br>
<span class="lineno">85</span><span class="keyword" id="3507211">type</span>&nbsp;<span class="ident" id="3507216">Flusher</span>&nbsp;<span class="keyword" id="3507224">interface</span>&nbsp;<span class="op" id="3507234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3507237">//&nbsp;Flush&nbsp;sends&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3507286">Flush</span><span class="op" id="3507291">(</span><span class="op" id="3507292">)</span><br>
<span class="lineno"></span><span class="op" id="3507294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="3507297">//&nbsp;The&nbsp;Hijacker&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3507368">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3507416">type</span>&nbsp;<span class="ident" id="3507421">Hijacker</span>&nbsp;<span class="keyword" id="3507430">interface</span>&nbsp;<span class="op" id="3507440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3507443">//&nbsp;Hijack&nbsp;lets&nbsp;the&nbsp;caller&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3507496">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Hijack(),&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;library</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3507550">//&nbsp;will&nbsp;not&nbsp;do&nbsp;anything&nbsp;else&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3507601">//&nbsp;It&nbsp;becomes&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;manage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3507654">//&nbsp;and&nbsp;close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3507684">Hijack</span><span class="op" id="3507690">(</span><span class="op" id="3507691">)</span>&nbsp;<span class="op" id="3507693">(</span><span class="ident" id="3507694">net</span><span class="op" id="3507697">.</span><span class="ident" id="3507698">Conn</span><span class="op" id="3507702">,</span>&nbsp;<span class="op" id="3507704">*</span><span class="ident" id="3507705">bufio</span><span class="op" id="3507710">.</span><span class="ident" id="3507711">ReadWriter</span><span class="op" id="3507721">,</span>&nbsp;<span class="builtintype" id="3507723">error</span><span class="op" id="3507728">)</span><br>
<span class="lineno"></span><span class="op" id="3507730">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="3507733">//&nbsp;The&nbsp;CloseNotifier&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="3507804">//&nbsp;allow&nbsp;detecting&nbsp;when&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span><span class="comment" id="3507869">//</span><br>
<span class="lineno"></span><span class="comment" id="3507872">//&nbsp;This&nbsp;mechanism&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;cancel&nbsp;long&nbsp;operations&nbsp;on&nbsp;the&nbsp;server</span><br>
<span class="lineno">105</span><span class="comment" id="3507942">//&nbsp;if&nbsp;the&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;before&nbsp;the&nbsp;response&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3508006">type</span>&nbsp;<span class="ident" id="3508011">CloseNotifier</span>&nbsp;<span class="keyword" id="3508025">interface</span>&nbsp;<span class="op" id="3508035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3508038">//&nbsp;CloseNotify&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;receives&nbsp;a&nbsp;single&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3508101">//&nbsp;when&nbsp;the&nbsp;client&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3508147">CloseNotify</span><span class="op" id="3508158">(</span><span class="op" id="3508159">)</span>&nbsp;<span class="op" id="3508161">&lt;-</span><span class="keyword" id="3508163">chan</span>&nbsp;<span class="builtintype" id="3508168">bool</span><br>
<span class="lineno">110</span><span class="op" id="3508173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3508176">//&nbsp;A&nbsp;conn&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3508236">type</span>&nbsp;<span class="ident" id="3508241">conn</span>&nbsp;<span class="keyword" id="3508246">struct</span>&nbsp;<span class="op" id="3508253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3508256">remoteAddr</span>&nbsp;<span class="builtintype" id="3508267">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3508288">//&nbsp;network&nbsp;address&nbsp;of&nbsp;remote&nbsp;side</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3508323">server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3508334">*</span><span class="ident" id="3508335">Server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3508355">//&nbsp;the&nbsp;Server&nbsp;on&nbsp;which&nbsp;the&nbsp;connection&nbsp;arrived</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3508402">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3508413">net</span><span class="op" id="3508416">.</span><span class="ident" id="3508417">Conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3508434">//&nbsp;i/o&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3508453">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3508464">io</span><span class="op" id="3508466">.</span><span class="ident" id="3508467">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3508485">//&nbsp;checkConnErrorWriter&#39;s&nbsp;copy&nbsp;of&nbsp;wrc,&nbsp;not&nbsp;zeroed&nbsp;on&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3508546">werr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3508557">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3508578">//&nbsp;any&nbsp;errors&nbsp;writing&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3508606">sr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3508617">liveSwitchReader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3508638">//&nbsp;where&nbsp;the&nbsp;LimitReader&nbsp;reads&nbsp;from;&nbsp;usually&nbsp;the&nbsp;rwc</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3508692">lr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3508703">*</span><span class="ident" id="3508704">io</span><span class="op" id="3508706">.</span><span class="ident" id="3508707">LimitedReader</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3508724">//&nbsp;io.LimitReader(sr)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3508747">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3508758">*</span><span class="ident" id="3508759">bufio</span><span class="op" id="3508764">.</span><span class="ident" id="3508765">ReadWriter</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3508779">//&nbsp;buffered(lr,rwc),&nbsp;reading&nbsp;from&nbsp;bufio-&gt;limitReader-&gt;sr-&gt;rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3508842">tlsState</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3508853">*</span><span class="ident" id="3508854">tls</span><span class="op" id="3508857">.</span><span class="ident" id="3508858">ConnectionState</span>&nbsp;<span class="comment" id="3508874">//&nbsp;or&nbsp;nil&nbsp;when&nbsp;not&nbsp;using&nbsp;TLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3508905">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3508918">sync</span><span class="op" id="3508922">.</span><span class="ident" id="3508923">Mutex</span>&nbsp;<span class="comment" id="3508929">//&nbsp;guards&nbsp;the&nbsp;following</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3508954">clientGone</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3508967">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3508978">//&nbsp;if&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;mid-request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509021">closeNotifyc</span>&nbsp;<span class="keyword" id="3509034">chan</span>&nbsp;<span class="builtintype" id="3509039">bool</span>&nbsp;&nbsp;<span class="comment" id="3509045">//&nbsp;made&nbsp;lazily</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509061">hijackedv</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3509074">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3509085">//&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked&nbsp;by&nbsp;handler</span><br>
<span class="lineno"></span><span class="op" id="3509128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3509131">func</span>&nbsp;<span class="op" id="3509136">(</span><span class="ident" id="3509137">c</span>&nbsp;<span class="op" id="3509139">*</span><span class="ident" id="3509140">conn</span><span class="op" id="3509144">)</span>&nbsp;<span class="ident" id="3509146">hijacked</span><span class="op" id="3509154">(</span><span class="op" id="3509155">)</span>&nbsp;<span class="builtintype" id="3509157">bool</span>&nbsp;<span class="op" id="3509162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509165">c</span><span class="op" id="3509166">.</span><span class="ident" id="3509167">mu</span><span class="op" id="3509169">.</span><span class="ident" id="3509170">Lock</span><span class="op" id="3509174">(</span><span class="op" id="3509175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3509178">defer</span>&nbsp;<span class="ident" id="3509184">c</span><span class="op" id="3509185">.</span><span class="ident" id="3509186">mu</span><span class="op" id="3509188">.</span><span class="ident" id="3509189">Unlock</span><span class="op" id="3509195">(</span><span class="op" id="3509196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3509199">return</span>&nbsp;<span class="ident" id="3509206">c</span><span class="op" id="3509207">.</span><span class="ident" id="3509208">hijackedv</span><br>
<span class="lineno"></span><span class="op" id="3509218">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="3509221">func</span>&nbsp;<span class="op" id="3509226">(</span><span class="ident" id="3509227">c</span>&nbsp;<span class="op" id="3509229">*</span><span class="ident" id="3509230">conn</span><span class="op" id="3509234">)</span>&nbsp;<span class="ident" id="3509236">hijack</span><span class="op" id="3509242">(</span><span class="op" id="3509243">)</span>&nbsp;<span class="op" id="3509245">(</span><span class="ident" id="3509246">rwc</span>&nbsp;<span class="ident" id="3509250">net</span><span class="op" id="3509253">.</span><span class="ident" id="3509254">Conn</span><span class="op" id="3509258">,</span>&nbsp;<span class="ident" id="3509260">buf</span>&nbsp;<span class="op" id="3509264">*</span><span class="ident" id="3509265">bufio</span><span class="op" id="3509270">.</span><span class="ident" id="3509271">ReadWriter</span><span class="op" id="3509281">,</span>&nbsp;<span class="ident" id="3509283">err</span>&nbsp;<span class="builtintype" id="3509287">error</span><span class="op" id="3509292">)</span>&nbsp;<span class="op" id="3509294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509297">c</span><span class="op" id="3509298">.</span><span class="ident" id="3509299">mu</span><span class="op" id="3509301">.</span><span class="ident" id="3509302">Lock</span><span class="op" id="3509306">(</span><span class="op" id="3509307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3509310">defer</span>&nbsp;<span class="ident" id="3509316">c</span><span class="op" id="3509317">.</span><span class="ident" id="3509318">mu</span><span class="op" id="3509320">.</span><span class="ident" id="3509321">Unlock</span><span class="op" id="3509327">(</span><span class="op" id="3509328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3509331">if</span>&nbsp;<span class="ident" id="3509334">c</span><span class="op" id="3509335">.</span><span class="ident" id="3509336">hijackedv</span>&nbsp;<span class="op" id="3509346">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3509350">return</span>&nbsp;<span class="ident" id="3509357">nil</span><span class="op" id="3509360">,</span>&nbsp;<span class="ident" id="3509362">nil</span><span class="op" id="3509365">,</span>&nbsp;<span class="ident" id="3509367">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3509380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3509383">if</span>&nbsp;<span class="ident" id="3509386">c</span><span class="op" id="3509387">.</span><span class="ident" id="3509388">closeNotifyc</span>&nbsp;<span class="op" id="3509401">!=</span>&nbsp;<span class="ident" id="3509404">nil</span>&nbsp;<span class="op" id="3509408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3509412">return</span>&nbsp;<span class="ident" id="3509419">nil</span><span class="op" id="3509422">,</span>&nbsp;<span class="ident" id="3509424">nil</span><span class="op" id="3509427">,</span>&nbsp;<span class="ident" id="3509429">errors</span><span class="op" id="3509435">.</span><span class="ident" id="3509436">New</span><span class="op" id="3509439">(</span><span class="string" id="3509440">&#34;http:&nbsp;Hijack&nbsp;is&nbsp;incompatible&nbsp;with&nbsp;use&nbsp;of&nbsp;CloseNotifier&#34;</span><span class="op" id="3509496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3509499">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509502">c</span><span class="op" id="3509503">.</span><span class="ident" id="3509504">hijackedv</span>&nbsp;<span class="op" id="3509514">=</span>&nbsp;<span class="builtintype" id="3509516">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509522">rwc</span>&nbsp;<span class="op" id="3509526">=</span>&nbsp;<span class="ident" id="3509528">c</span><span class="op" id="3509529">.</span><span class="ident" id="3509530">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509535">buf</span>&nbsp;<span class="op" id="3509539">=</span>&nbsp;<span class="ident" id="3509541">c</span><span class="op" id="3509542">.</span><span class="ident" id="3509543">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509548">c</span><span class="op" id="3509549">.</span><span class="ident" id="3509550">rwc</span>&nbsp;<span class="op" id="3509554">=</span>&nbsp;<span class="ident" id="3509556">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509561">c</span><span class="op" id="3509562">.</span><span class="ident" id="3509563">buf</span>&nbsp;<span class="op" id="3509567">=</span>&nbsp;<span class="ident" id="3509569">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509574">c</span><span class="op" id="3509575">.</span><span class="ident" id="3509576">setState</span><span class="op" id="3509584">(</span><span class="ident" id="3509585">rwc</span><span class="op" id="3509588">,</span>&nbsp;<span class="ident" id="3509590">StateHijacked</span><span class="op" id="3509603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3509606">return</span><br>
<span class="lineno"></span><span class="op" id="3509613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3509616">func</span>&nbsp;<span class="op" id="3509621">(</span><span class="ident" id="3509622">c</span>&nbsp;<span class="op" id="3509624">*</span><span class="ident" id="3509625">conn</span><span class="op" id="3509629">)</span>&nbsp;<span class="ident" id="3509631">closeNotify</span><span class="op" id="3509642">(</span><span class="op" id="3509643">)</span>&nbsp;<span class="op" id="3509645">&lt;-</span><span class="keyword" id="3509647">chan</span>&nbsp;<span class="builtintype" id="3509652">bool</span>&nbsp;<span class="op" id="3509657">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509660">c</span><span class="op" id="3509661">.</span><span class="ident" id="3509662">mu</span><span class="op" id="3509664">.</span><span class="ident" id="3509665">Lock</span><span class="op" id="3509669">(</span><span class="op" id="3509670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3509673">defer</span>&nbsp;<span class="ident" id="3509679">c</span><span class="op" id="3509680">.</span><span class="ident" id="3509681">mu</span><span class="op" id="3509683">.</span><span class="ident" id="3509684">Unlock</span><span class="op" id="3509690">(</span><span class="op" id="3509691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3509694">if</span>&nbsp;<span class="ident" id="3509697">c</span><span class="op" id="3509698">.</span><span class="ident" id="3509699">closeNotifyc</span>&nbsp;<span class="op" id="3509712">==</span>&nbsp;<span class="ident" id="3509715">nil</span>&nbsp;<span class="op" id="3509719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509723">c</span><span class="op" id="3509724">.</span><span class="ident" id="3509725">closeNotifyc</span>&nbsp;<span class="op" id="3509738">=</span>&nbsp;<span class="builtinfunc" id="3509740">make</span><span class="op" id="3509744">(</span><span class="keyword" id="3509745">chan</span>&nbsp;<span class="builtintype" id="3509750">bool</span><span class="op" id="3509754">,</span>&nbsp;<span class="num" id="3509756">1</span><span class="op" id="3509757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3509761">if</span>&nbsp;<span class="ident" id="3509764">c</span><span class="op" id="3509765">.</span><span class="ident" id="3509766">hijackedv</span>&nbsp;<span class="op" id="3509776">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3509781">//&nbsp;to&nbsp;obey&nbsp;the&nbsp;function&nbsp;signature,&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3509831">//&nbsp;it&#39;ll&nbsp;never&nbsp;receive&nbsp;a&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3509866">return</span>&nbsp;<span class="ident" id="3509873">c</span><span class="op" id="3509874">.</span><span class="ident" id="3509875">closeNotifyc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3509890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509894">pr</span><span class="op" id="3509896">,</span>&nbsp;<span class="ident" id="3509898">pw</span>&nbsp;<span class="op" id="3509901">:=</span>&nbsp;<span class="ident" id="3509904">io</span><span class="op" id="3509906">.</span><span class="ident" id="3509907">Pipe</span><span class="op" id="3509911">(</span><span class="op" id="3509912">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509917">readSource</span>&nbsp;<span class="op" id="3509928">:=</span>&nbsp;<span class="ident" id="3509931">c</span><span class="op" id="3509932">.</span><span class="ident" id="3509933">sr</span><span class="op" id="3509935">.</span><span class="ident" id="3509936">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509940">c</span><span class="op" id="3509941">.</span><span class="ident" id="3509942">sr</span><span class="op" id="3509944">.</span><span class="ident" id="3509945">Lock</span><span class="op" id="3509949">(</span><span class="op" id="3509950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509954">c</span><span class="op" id="3509955">.</span><span class="ident" id="3509956">sr</span><span class="op" id="3509958">.</span><span class="ident" id="3509959">r</span>&nbsp;<span class="op" id="3509961">=</span>&nbsp;<span class="ident" id="3509963">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509968">c</span><span class="op" id="3509969">.</span><span class="ident" id="3509970">sr</span><span class="op" id="3509972">.</span><span class="ident" id="3509973">Unlock</span><span class="op" id="3509979">(</span><span class="op" id="3509980">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3509984">go</span>&nbsp;<span class="keyword" id="3509987">func</span><span class="op" id="3509991">(</span><span class="op" id="3509992">)</span>&nbsp;<span class="op" id="3509994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3509999">_</span><span class="op" id="3510000">,</span>&nbsp;<span class="ident" id="3510002">err</span>&nbsp;<span class="op" id="3510006">:=</span>&nbsp;<span class="ident" id="3510009">io</span><span class="op" id="3510011">.</span><span class="ident" id="3510012">Copy</span><span class="op" id="3510016">(</span><span class="ident" id="3510017">pw</span><span class="op" id="3510019">,</span>&nbsp;<span class="ident" id="3510021">readSource</span><span class="op" id="3510031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3510036">if</span>&nbsp;<span class="ident" id="3510039">err</span>&nbsp;<span class="op" id="3510043">==</span>&nbsp;<span class="ident" id="3510046">nil</span>&nbsp;<span class="op" id="3510050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3510056">err</span>&nbsp;<span class="op" id="3510060">=</span>&nbsp;<span class="ident" id="3510062">io</span><span class="op" id="3510064">.</span><span class="ident" id="3510065">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3510072">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3510077">pw</span><span class="op" id="3510079">.</span><span class="ident" id="3510080">CloseWithError</span><span class="op" id="3510094">(</span><span class="ident" id="3510095">err</span><span class="op" id="3510098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3510103">c</span><span class="op" id="3510104">.</span><span class="ident" id="3510105">noteClientGone</span><span class="op" id="3510119">(</span><span class="op" id="3510120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3510124">}</span><span class="op" id="3510125">(</span><span class="op" id="3510126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3510129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3510132">return</span>&nbsp;<span class="ident" id="3510139">c</span><span class="op" id="3510140">.</span><span class="ident" id="3510141">closeNotifyc</span><br>
<span class="lineno">180</span><span class="op" id="3510154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3510157">func</span>&nbsp;<span class="op" id="3510162">(</span><span class="ident" id="3510163">c</span>&nbsp;<span class="op" id="3510165">*</span><span class="ident" id="3510166">conn</span><span class="op" id="3510170">)</span>&nbsp;<span class="ident" id="3510172">noteClientGone</span><span class="op" id="3510186">(</span><span class="op" id="3510187">)</span>&nbsp;<span class="op" id="3510189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3510192">c</span><span class="op" id="3510193">.</span><span class="ident" id="3510194">mu</span><span class="op" id="3510196">.</span><span class="ident" id="3510197">Lock</span><span class="op" id="3510201">(</span><span class="op" id="3510202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3510205">defer</span>&nbsp;<span class="ident" id="3510211">c</span><span class="op" id="3510212">.</span><span class="ident" id="3510213">mu</span><span class="op" id="3510215">.</span><span class="ident" id="3510216">Unlock</span><span class="op" id="3510222">(</span><span class="op" id="3510223">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3510226">if</span>&nbsp;<span class="ident" id="3510229">c</span><span class="op" id="3510230">.</span><span class="ident" id="3510231">closeNotifyc</span>&nbsp;<span class="op" id="3510244">!=</span>&nbsp;<span class="ident" id="3510247">nil</span>&nbsp;<span class="op" id="3510251">&amp;&amp;</span>&nbsp;<span class="op" id="3510254">!</span><span class="ident" id="3510255">c</span><span class="op" id="3510256">.</span><span class="ident" id="3510257">clientGone</span>&nbsp;<span class="op" id="3510268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3510272">c</span><span class="op" id="3510273">.</span><span class="ident" id="3510274">closeNotifyc</span>&nbsp;<span class="op" id="3510287">&lt;-</span>&nbsp;<span class="builtintype" id="3510290">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3510296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3510299">c</span><span class="op" id="3510300">.</span><span class="ident" id="3510301">clientGone</span>&nbsp;<span class="op" id="3510312">=</span>&nbsp;<span class="builtintype" id="3510314">true</span><br>
<span class="lineno"></span><span class="op" id="3510319">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3510322">//&nbsp;A&nbsp;switchReader&nbsp;can&nbsp;have&nbsp;its&nbsp;Reader&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3510380">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Reads&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3510432">type</span>&nbsp;<span class="ident" id="3510437">switchReader</span>&nbsp;<span class="keyword" id="3510450">struct</span>&nbsp;<span class="op" id="3510457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3510460">io</span><span class="op" id="3510462">.</span><span class="ident" id="3510463">Reader</span><br>
<span class="lineno">195</span><span class="op" id="3510470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3510473">//&nbsp;A&nbsp;switchWriter&nbsp;can&nbsp;have&nbsp;its&nbsp;Writer&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3510531">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Writes&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3510584">type</span>&nbsp;<span class="ident" id="3510589">switchWriter</span>&nbsp;<span class="keyword" id="3510602">struct</span>&nbsp;<span class="op" id="3510609">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3510612">io</span><span class="op" id="3510614">.</span><span class="ident" id="3510615">Writer</span><br>
<span class="lineno"></span><span class="op" id="3510622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3510625">//&nbsp;A&nbsp;liveSwitchReader&nbsp;is&nbsp;a&nbsp;switchReader&nbsp;that&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent</span><br>
<span class="lineno"></span><span class="comment" id="3510692">//&nbsp;reads&nbsp;and&nbsp;switches,&nbsp;if&nbsp;its&nbsp;mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno">205</span><span class="keyword" id="3510737">type</span>&nbsp;<span class="ident" id="3510742">liveSwitchReader</span>&nbsp;<span class="keyword" id="3510759">struct</span>&nbsp;<span class="op" id="3510766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3510769">sync</span><span class="op" id="3510773">.</span><span class="ident" id="3510774">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3510781">r</span>&nbsp;<span class="ident" id="3510783">io</span><span class="op" id="3510785">.</span><span class="ident" id="3510786">Reader</span><br>
<span class="lineno"></span><span class="op" id="3510793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="keyword" id="3510796">func</span>&nbsp;<span class="op" id="3510801">(</span><span class="ident" id="3510802">sr</span>&nbsp;<span class="op" id="3510805">*</span><span class="ident" id="3510806">liveSwitchReader</span><span class="op" id="3510822">)</span>&nbsp;<span class="ident" id="3510824">Read</span><span class="op" id="3510828">(</span><span class="ident" id="3510829">p</span>&nbsp;<span class="op" id="3510831">[</span><span class="op" id="3510832">]</span><span class="builtintype" id="3510833">byte</span><span class="op" id="3510837">)</span>&nbsp;<span class="op" id="3510839">(</span><span class="ident" id="3510840">n</span>&nbsp;<span class="builtintype" id="3510842">int</span><span class="op" id="3510845">,</span>&nbsp;<span class="ident" id="3510847">err</span>&nbsp;<span class="builtintype" id="3510851">error</span><span class="op" id="3510856">)</span>&nbsp;<span class="op" id="3510858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3510861">sr</span><span class="op" id="3510863">.</span><span class="ident" id="3510864">Lock</span><span class="op" id="3510868">(</span><span class="op" id="3510869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3510872">r</span>&nbsp;<span class="op" id="3510874">:=</span>&nbsp;<span class="ident" id="3510877">sr</span><span class="op" id="3510879">.</span><span class="ident" id="3510880">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3510883">sr</span><span class="op" id="3510885">.</span><span class="ident" id="3510886">Unlock</span><span class="op" id="3510892">(</span><span class="op" id="3510893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3510896">return</span>&nbsp;<span class="ident" id="3510903">r</span><span class="op" id="3510904">.</span><span class="ident" id="3510905">Read</span><span class="op" id="3510909">(</span><span class="ident" id="3510910">p</span><span class="op" id="3510911">)</span><br>
<span class="lineno">215</span><span class="op" id="3510913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3510916">//&nbsp;This&nbsp;should&nbsp;be&nbsp;&gt;=&nbsp;512&nbsp;bytes&nbsp;for&nbsp;DetectContentType,</span><br>
<span class="lineno"></span><span class="comment" id="3510970">//&nbsp;but&nbsp;otherwise&nbsp;it&#39;s&nbsp;somewhat&nbsp;arbitrary.</span><br>
<span class="lineno"></span><span class="keyword" id="3511012">const</span>&nbsp;<span class="ident" id="3511018">bufferBeforeChunkingSize</span>&nbsp;<span class="op" id="3511043">=</span>&nbsp;<span class="num" id="3511045">2048</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="3511051">//&nbsp;chunkWriter&nbsp;writes&nbsp;to&nbsp;a&nbsp;response&#39;s&nbsp;conn&nbsp;buffer,&nbsp;and&nbsp;is&nbsp;the&nbsp;writer</span><br>
<span class="lineno"></span><span class="comment" id="3511120">//&nbsp;wrapped&nbsp;by&nbsp;the&nbsp;response.bufw&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="3511169">//</span><br>
<span class="lineno"></span><span class="comment" id="3511172">//&nbsp;chunkWriter&nbsp;also&nbsp;is&nbsp;responsible&nbsp;for&nbsp;finalizing&nbsp;the&nbsp;Header,&nbsp;including</span><br>
<span class="lineno">225</span><span class="comment" id="3511244">//&nbsp;conditionally&nbsp;setting&nbsp;the&nbsp;Content-Type&nbsp;and&nbsp;setting&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span><span class="comment" id="3511315">//&nbsp;in&nbsp;cases&nbsp;where&nbsp;the&nbsp;handler&#39;s&nbsp;final&nbsp;output&nbsp;is&nbsp;smaller&nbsp;than&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3511387">//&nbsp;size.&nbsp;It&nbsp;also&nbsp;conditionally&nbsp;adds&nbsp;chunk&nbsp;headers,&nbsp;when&nbsp;in&nbsp;chunking&nbsp;mode.</span><br>
<span class="lineno"></span><span class="comment" id="3511461">//</span><br>
<span class="lineno"></span><span class="comment" id="3511464">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;above&nbsp;(*response).Write&nbsp;for&nbsp;the&nbsp;entire&nbsp;write&nbsp;flow.</span><br>
<span class="lineno">230</span><span class="keyword" id="3511534">type</span>&nbsp;<span class="ident" id="3511539">chunkWriter</span>&nbsp;<span class="keyword" id="3511551">struct</span>&nbsp;<span class="op" id="3511558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3511561">res</span>&nbsp;<span class="op" id="3511565">*</span><span class="ident" id="3511566">response</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3511577">//&nbsp;header&nbsp;is&nbsp;either&nbsp;nil&nbsp;or&nbsp;a&nbsp;deep&nbsp;clone&nbsp;of&nbsp;res.handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3511639">//&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;res.WriteHeader,&nbsp;if&nbsp;res.WriteHeader&nbsp;is</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3511697">//&nbsp;called&nbsp;and&nbsp;extra&nbsp;buffering&nbsp;is&nbsp;being&nbsp;done&nbsp;to&nbsp;calculate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3511755">//&nbsp;Content-Type&nbsp;and/or&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3511795">header</span>&nbsp;<span class="ident" id="3511802">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3511811">//&nbsp;wroteHeader&nbsp;tells&nbsp;whether&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;written&nbsp;to&nbsp;&#34;the</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3511875">//&nbsp;wire&#34;&nbsp;(or&nbsp;rather:&nbsp;w.conn.buf).&nbsp;this&nbsp;is&nbsp;unlike</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3511925">//&nbsp;(*response).wroteHeader,&nbsp;which&nbsp;tells&nbsp;only&nbsp;whether&nbsp;it&nbsp;was</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3511986">//&nbsp;logically&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3512009">wroteHeader</span>&nbsp;<span class="builtintype" id="3512021">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3512028">//&nbsp;set&nbsp;by&nbsp;the&nbsp;writeHeader&nbsp;method:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3512063">chunking</span>&nbsp;<span class="builtintype" id="3512072">bool</span>&nbsp;<span class="comment" id="3512077">//&nbsp;using&nbsp;chunked&nbsp;transfer&nbsp;encoding&nbsp;for&nbsp;reply&nbsp;body</span><br>
<span class="lineno"></span><span class="op" id="3512127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3512130">var</span>&nbsp;<span class="op" id="3512134">(</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3512137">crlf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3512148">=</span>&nbsp;<span class="op" id="3512150">[</span><span class="op" id="3512151">]</span><span class="builtintype" id="3512152">byte</span><span class="op" id="3512156">(</span><span class="string" id="3512157">&#34;\r\n&#34;</span><span class="op" id="3512163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3512166">colonSpace</span>&nbsp;<span class="op" id="3512177">=</span>&nbsp;<span class="op" id="3512179">[</span><span class="op" id="3512180">]</span><span class="builtintype" id="3512181">byte</span><span class="op" id="3512185">(</span><span class="string" id="3512186">&#34;:&nbsp;&#34;</span><span class="op" id="3512190">)</span><br>
<span class="lineno"></span><span class="op" id="3512192">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3512195">func</span>&nbsp;<span class="op" id="3512200">(</span><span class="ident" id="3512201">cw</span>&nbsp;<span class="op" id="3512204">*</span><span class="ident" id="3512205">chunkWriter</span><span class="op" id="3512216">)</span>&nbsp;<span class="ident" id="3512218">Write</span><span class="op" id="3512223">(</span><span class="ident" id="3512224">p</span>&nbsp;<span class="op" id="3512226">[</span><span class="op" id="3512227">]</span><span class="builtintype" id="3512228">byte</span><span class="op" id="3512232">)</span>&nbsp;<span class="op" id="3512234">(</span><span class="ident" id="3512235">n</span>&nbsp;<span class="builtintype" id="3512237">int</span><span class="op" id="3512240">,</span>&nbsp;<span class="ident" id="3512242">err</span>&nbsp;<span class="builtintype" id="3512246">error</span><span class="op" id="3512251">)</span>&nbsp;<span class="op" id="3512253">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3512256">if</span>&nbsp;<span class="op" id="3512259">!</span><span class="ident" id="3512260">cw</span><span class="op" id="3512262">.</span><span class="ident" id="3512263">wroteHeader</span>&nbsp;<span class="op" id="3512275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3512279">cw</span><span class="op" id="3512281">.</span><span class="ident" id="3512282">writeHeader</span><span class="op" id="3512293">(</span><span class="ident" id="3512294">p</span><span class="op" id="3512295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3512298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3512301">if</span>&nbsp;<span class="ident" id="3512304">cw</span><span class="op" id="3512306">.</span><span class="ident" id="3512307">res</span><span class="op" id="3512310">.</span><span class="ident" id="3512311">req</span><span class="op" id="3512314">.</span><span class="ident" id="3512315">Method</span>&nbsp;<span class="op" id="3512322">==</span>&nbsp;<span class="string" id="3512325">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3512332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3512336">//&nbsp;Eat&nbsp;writes.</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3512353">return</span>&nbsp;<span class="builtinfunc" id="3512360">len</span><span class="op" id="3512363">(</span><span class="ident" id="3512364">p</span><span class="op" id="3512365">)</span><span class="op" id="3512366">,</span>&nbsp;<span class="ident" id="3512368">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3512373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3512376">if</span>&nbsp;<span class="ident" id="3512379">cw</span><span class="op" id="3512381">.</span><span class="ident" id="3512382">chunking</span>&nbsp;<span class="op" id="3512391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3512395">_</span><span class="op" id="3512396">,</span>&nbsp;<span class="ident" id="3512398">err</span>&nbsp;<span class="op" id="3512402">=</span>&nbsp;<span class="ident" id="3512404">fmt</span><span class="op" id="3512407">.</span><span class="ident" id="3512408">Fprintf</span><span class="op" id="3512415">(</span><span class="ident" id="3512416">cw</span><span class="op" id="3512418">.</span><span class="ident" id="3512419">res</span><span class="op" id="3512422">.</span><span class="ident" id="3512423">conn</span><span class="op" id="3512427">.</span><span class="ident" id="3512428">buf</span><span class="op" id="3512431">,</span>&nbsp;<span class="string" id="3512433">&#34;%x\r\n&#34;</span><span class="op" id="3512441">,</span>&nbsp;<span class="builtinfunc" id="3512443">len</span><span class="op" id="3512446">(</span><span class="ident" id="3512447">p</span><span class="op" id="3512448">)</span><span class="op" id="3512449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3512453">if</span>&nbsp;<span class="ident" id="3512456">err</span>&nbsp;<span class="op" id="3512460">!=</span>&nbsp;<span class="ident" id="3512463">nil</span>&nbsp;<span class="op" id="3512467">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3512472">cw</span><span class="op" id="3512474">.</span><span class="ident" id="3512475">res</span><span class="op" id="3512478">.</span><span class="ident" id="3512479">conn</span><span class="op" id="3512483">.</span><span class="ident" id="3512484">rwc</span><span class="op" id="3512487">.</span><span class="ident" id="3512488">Close</span><span class="op" id="3512493">(</span><span class="op" id="3512494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3512499">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3512508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3512511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3512514">n</span><span class="op" id="3512515">,</span>&nbsp;<span class="ident" id="3512517">err</span>&nbsp;<span class="op" id="3512521">=</span>&nbsp;<span class="ident" id="3512523">cw</span><span class="op" id="3512525">.</span><span class="ident" id="3512526">res</span><span class="op" id="3512529">.</span><span class="ident" id="3512530">conn</span><span class="op" id="3512534">.</span><span class="ident" id="3512535">buf</span><span class="op" id="3512538">.</span><span class="ident" id="3512539">Write</span><span class="op" id="3512544">(</span><span class="ident" id="3512545">p</span><span class="op" id="3512546">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3512549">if</span>&nbsp;<span class="ident" id="3512552">cw</span><span class="op" id="3512554">.</span><span class="ident" id="3512555">chunking</span>&nbsp;<span class="op" id="3512564">&amp;&amp;</span>&nbsp;<span class="ident" id="3512567">err</span>&nbsp;<span class="op" id="3512571">==</span>&nbsp;<span class="ident" id="3512574">nil</span>&nbsp;<span class="op" id="3512578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3512582">_</span><span class="op" id="3512583">,</span>&nbsp;<span class="ident" id="3512585">err</span>&nbsp;<span class="op" id="3512589">=</span>&nbsp;<span class="ident" id="3512591">cw</span><span class="op" id="3512593">.</span><span class="ident" id="3512594">res</span><span class="op" id="3512597">.</span><span class="ident" id="3512598">conn</span><span class="op" id="3512602">.</span><span class="ident" id="3512603">buf</span><span class="op" id="3512606">.</span><span class="ident" id="3512607">Write</span><span class="op" id="3512612">(</span><span class="ident" id="3512613">crlf</span><span class="op" id="3512617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3512620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3512623">if</span>&nbsp;<span class="ident" id="3512626">err</span>&nbsp;<span class="op" id="3512630">!=</span>&nbsp;<span class="ident" id="3512633">nil</span>&nbsp;<span class="op" id="3512637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3512641">cw</span><span class="op" id="3512643">.</span><span class="ident" id="3512644">res</span><span class="op" id="3512647">.</span><span class="ident" id="3512648">conn</span><span class="op" id="3512652">.</span><span class="ident" id="3512653">rwc</span><span class="op" id="3512656">.</span><span class="ident" id="3512657">Close</span><span class="op" id="3512662">(</span><span class="op" id="3512663">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3512666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3512669">return</span><br>
<span class="lineno"></span><span class="op" id="3512676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3512679">func</span>&nbsp;<span class="op" id="3512684">(</span><span class="ident" id="3512685">cw</span>&nbsp;<span class="op" id="3512688">*</span><span class="ident" id="3512689">chunkWriter</span><span class="op" id="3512700">)</span>&nbsp;<span class="ident" id="3512702">flush</span><span class="op" id="3512707">(</span><span class="op" id="3512708">)</span>&nbsp;<span class="op" id="3512710">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3512713">if</span>&nbsp;<span class="op" id="3512716">!</span><span class="ident" id="3512717">cw</span><span class="op" id="3512719">.</span><span class="ident" id="3512720">wroteHeader</span>&nbsp;<span class="op" id="3512732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3512736">cw</span><span class="op" id="3512738">.</span><span class="ident" id="3512739">writeHeader</span><span class="op" id="3512750">(</span><span class="ident" id="3512751">nil</span><span class="op" id="3512754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3512757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3512760">cw</span><span class="op" id="3512762">.</span><span class="ident" id="3512763">res</span><span class="op" id="3512766">.</span><span class="ident" id="3512767">conn</span><span class="op" id="3512771">.</span><span class="ident" id="3512772">buf</span><span class="op" id="3512775">.</span><span class="ident" id="3512776">Flush</span><span class="op" id="3512781">(</span><span class="op" id="3512782">)</span><br>
<span class="lineno"></span><span class="op" id="3512784">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="3512787">func</span>&nbsp;<span class="op" id="3512792">(</span><span class="ident" id="3512793">cw</span>&nbsp;<span class="op" id="3512796">*</span><span class="ident" id="3512797">chunkWriter</span><span class="op" id="3512808">)</span>&nbsp;<span class="builtinfunc" id="3512810">close</span><span class="op" id="3512815">(</span><span class="op" id="3512816">)</span>&nbsp;<span class="op" id="3512818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3512821">if</span>&nbsp;<span class="op" id="3512824">!</span><span class="ident" id="3512825">cw</span><span class="op" id="3512827">.</span><span class="ident" id="3512828">wroteHeader</span>&nbsp;<span class="op" id="3512840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3512844">cw</span><span class="op" id="3512846">.</span><span class="ident" id="3512847">writeHeader</span><span class="op" id="3512858">(</span><span class="ident" id="3512859">nil</span><span class="op" id="3512862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3512865">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3512868">if</span>&nbsp;<span class="ident" id="3512871">cw</span><span class="op" id="3512873">.</span><span class="ident" id="3512874">chunking</span>&nbsp;<span class="op" id="3512883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3512887">//&nbsp;zero&nbsp;EOF&nbsp;chunk,&nbsp;trailer&nbsp;key/value&nbsp;pairs&nbsp;(currently</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3512943">//&nbsp;unsupported&nbsp;in&nbsp;Go&#39;s&nbsp;server),&nbsp;followed&nbsp;by&nbsp;a&nbsp;blank</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3512997">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3513008">cw</span><span class="op" id="3513010">.</span><span class="ident" id="3513011">res</span><span class="op" id="3513014">.</span><span class="ident" id="3513015">conn</span><span class="op" id="3513019">.</span><span class="ident" id="3513020">buf</span><span class="op" id="3513023">.</span><span class="ident" id="3513024">WriteString</span><span class="op" id="3513035">(</span><span class="string" id="3513036">&#34;0\r\n\r\n&#34;</span><span class="op" id="3513047">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3513050">}</span><br>
<span class="lineno"></span><span class="op" id="3513052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3513055">//&nbsp;A&nbsp;response&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3513117">type</span>&nbsp;<span class="ident" id="3513122">response</span>&nbsp;<span class="keyword" id="3513131">struct</span>&nbsp;<span class="op" id="3513138">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3513141">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3513155">*</span><span class="ident" id="3513156">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3513162">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3513176">*</span><span class="ident" id="3513177">Request</span>&nbsp;<span class="comment" id="3513185">//&nbsp;request&nbsp;for&nbsp;this&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3513215">wroteHeader</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3513229">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3513238">//&nbsp;reply&nbsp;header&nbsp;has&nbsp;been&nbsp;(logically)&nbsp;written</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3513284">wroteContinue</span>&nbsp;<span class="builtintype" id="3513298">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3513307">//&nbsp;100&nbsp;Continue&nbsp;response&nbsp;was&nbsp;written</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3513346">w</span>&nbsp;&nbsp;<span class="op" id="3513349">*</span><span class="ident" id="3513350">bufio</span><span class="op" id="3513355">.</span><span class="ident" id="3513356">Writer</span>&nbsp;<span class="comment" id="3513363">//&nbsp;buffers&nbsp;output&nbsp;in&nbsp;chunks&nbsp;to&nbsp;chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3513407">cw</span>&nbsp;<span class="ident" id="3513410">chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3513423">sw</span>&nbsp;<span class="op" id="3513426">*</span><span class="ident" id="3513427">switchWriter</span>&nbsp;<span class="comment" id="3513440">//&nbsp;of&nbsp;the&nbsp;bufio.Writer,&nbsp;for&nbsp;return&nbsp;to&nbsp;putBufioWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3513495">//&nbsp;handlerHeader&nbsp;is&nbsp;the&nbsp;Header&nbsp;that&nbsp;Handlers&nbsp;get&nbsp;access&nbsp;to,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3513556">//&nbsp;which&nbsp;may&nbsp;be&nbsp;retained&nbsp;and&nbsp;mutated&nbsp;even&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3513618">//&nbsp;handlerHeader&nbsp;is&nbsp;copied&nbsp;into&nbsp;cw.header&nbsp;at&nbsp;WriteHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3513676">//&nbsp;time,&nbsp;and&nbsp;privately&nbsp;mutated&nbsp;thereafter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3513720">handlerHeader</span>&nbsp;<span class="ident" id="3513734">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3513742">calledHeader</span>&nbsp;&nbsp;<span class="builtintype" id="3513756">bool</span>&nbsp;<span class="comment" id="3513761">//&nbsp;handler&nbsp;accessed&nbsp;handlerHeader&nbsp;via&nbsp;Header</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3513808">written</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3513822">int64</span>&nbsp;<span class="comment" id="3513828">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;in&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3513864">contentLength</span>&nbsp;<span class="ident" id="3513878">int64</span>&nbsp;<span class="comment" id="3513884">//&nbsp;explicitly-declared&nbsp;Content-Length;&nbsp;or&nbsp;-1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3513930">status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3513944">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3513950">//&nbsp;status&nbsp;code&nbsp;passed&nbsp;to&nbsp;WriteHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3513989">//&nbsp;close&nbsp;connection&nbsp;after&nbsp;this&nbsp;reply.&nbsp;&nbsp;set&nbsp;on&nbsp;request&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3514048">//&nbsp;updated&nbsp;after&nbsp;response&nbsp;from&nbsp;handler&nbsp;if&nbsp;there&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3514101">//&nbsp;&#34;Connection:&nbsp;keep-alive&#34;&nbsp;response&nbsp;header&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3514152">//&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3514172">closeAfterReply</span>&nbsp;<span class="builtintype" id="3514188">bool</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3514195">//&nbsp;requestBodyLimitHit&nbsp;is&nbsp;set&nbsp;by&nbsp;requestTooLarge&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3514250">//&nbsp;maxBytesReader&nbsp;hits&nbsp;its&nbsp;max&nbsp;size.&nbsp;It&nbsp;is&nbsp;checked&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3514305">//&nbsp;WriteHeader,&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;don&#39;t&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3514356">//&nbsp;remaining&nbsp;request&nbsp;body&nbsp;to&nbsp;try&nbsp;to&nbsp;advance&nbsp;to&nbsp;the&nbsp;next&nbsp;HTTP</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3514418">//&nbsp;request.&nbsp;Instead,&nbsp;when&nbsp;this&nbsp;is&nbsp;set,&nbsp;we&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3514474">//&nbsp;subsequent&nbsp;requests&nbsp;on&nbsp;this&nbsp;connection&nbsp;and&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3514534">//&nbsp;input&nbsp;from&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3514553">requestBodyLimitHit</span>&nbsp;<span class="builtintype" id="3514573">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3514580">handlerDone</span>&nbsp;<span class="builtintype" id="3514592">bool</span>&nbsp;<span class="comment" id="3514597">//&nbsp;set&nbsp;true&nbsp;when&nbsp;the&nbsp;handler&nbsp;exits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3514634">//&nbsp;Buffers&nbsp;for&nbsp;Date&nbsp;and&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3514674">dateBuf</span>&nbsp;<span class="op" id="3514682">[</span><span class="builtinfunc" id="3514683">len</span><span class="op" id="3514686">(</span><span class="ident" id="3514687">TimeFormat</span><span class="op" id="3514697">)</span><span class="op" id="3514698">]</span><span class="builtintype" id="3514699">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3514705">clenBuf</span>&nbsp;<span class="op" id="3514713">[</span><span class="num" id="3514714">10</span><span class="op" id="3514716">]</span><span class="builtintype" id="3514717">byte</span><br>
<span class="lineno">340</span><span class="op" id="3514722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3514725">//&nbsp;requestTooLarge&nbsp;is&nbsp;called&nbsp;by&nbsp;maxBytesReader&nbsp;when&nbsp;too&nbsp;much&nbsp;input&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="3514796">//&nbsp;been&nbsp;read&nbsp;from&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="3514826">func</span>&nbsp;<span class="op" id="3514831">(</span><span class="ident" id="3514832">w</span>&nbsp;<span class="op" id="3514834">*</span><span class="ident" id="3514835">response</span><span class="op" id="3514843">)</span>&nbsp;<span class="ident" id="3514845">requestTooLarge</span><span class="op" id="3514860">(</span><span class="op" id="3514861">)</span>&nbsp;<span class="op" id="3514863">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3514866">w</span><span class="op" id="3514867">.</span><span class="ident" id="3514868">closeAfterReply</span>&nbsp;<span class="op" id="3514884">=</span>&nbsp;<span class="builtintype" id="3514886">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3514892">w</span><span class="op" id="3514893">.</span><span class="ident" id="3514894">requestBodyLimitHit</span>&nbsp;<span class="op" id="3514914">=</span>&nbsp;<span class="builtintype" id="3514916">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3514922">if</span>&nbsp;<span class="op" id="3514925">!</span><span class="ident" id="3514926">w</span><span class="op" id="3514927">.</span><span class="ident" id="3514928">wroteHeader</span>&nbsp;<span class="op" id="3514940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3514944">w</span><span class="op" id="3514945">.</span><span class="ident" id="3514946">Header</span><span class="op" id="3514952">(</span><span class="op" id="3514953">)</span><span class="op" id="3514954">.</span><span class="ident" id="3514955">Set</span><span class="op" id="3514958">(</span><span class="string" id="3514959">&#34;Connection&#34;</span><span class="op" id="3514971">,</span>&nbsp;<span class="string" id="3514973">&#34;close&#34;</span><span class="op" id="3514980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3514983">}</span><br>
<span class="lineno">350</span><span class="op" id="3514985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3514988">//&nbsp;needsSniff&nbsp;reports&nbsp;whether&nbsp;a&nbsp;Content-Type&nbsp;still&nbsp;needs&nbsp;to&nbsp;be&nbsp;sniffed.</span><br>
<span class="lineno"></span><span class="keyword" id="3515060">func</span>&nbsp;<span class="op" id="3515065">(</span><span class="ident" id="3515066">w</span>&nbsp;<span class="op" id="3515068">*</span><span class="ident" id="3515069">response</span><span class="op" id="3515077">)</span>&nbsp;<span class="ident" id="3515079">needsSniff</span><span class="op" id="3515089">(</span><span class="op" id="3515090">)</span>&nbsp;<span class="builtintype" id="3515092">bool</span>&nbsp;<span class="op" id="3515097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3515100">_</span><span class="op" id="3515101">,</span>&nbsp;<span class="ident" id="3515103">haveType</span>&nbsp;<span class="op" id="3515112">:=</span>&nbsp;<span class="ident" id="3515115">w</span><span class="op" id="3515116">.</span><span class="ident" id="3515117">handlerHeader</span><span class="op" id="3515130">[</span><span class="string" id="3515131">&#34;Content-Type&#34;</span><span class="op" id="3515145">]</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3515148">return</span>&nbsp;<span class="op" id="3515155">!</span><span class="ident" id="3515156">w</span><span class="op" id="3515157">.</span><span class="ident" id="3515158">cw</span><span class="op" id="3515160">.</span><span class="ident" id="3515161">wroteHeader</span>&nbsp;<span class="op" id="3515173">&amp;&amp;</span>&nbsp;<span class="op" id="3515176">!</span><span class="ident" id="3515177">haveType</span>&nbsp;<span class="op" id="3515186">&amp;&amp;</span>&nbsp;<span class="ident" id="3515189">w</span><span class="op" id="3515190">.</span><span class="ident" id="3515191">written</span>&nbsp;<span class="op" id="3515199">&lt;</span>&nbsp;<span class="ident" id="3515201">sniffLen</span><br>
<span class="lineno"></span><span class="op" id="3515210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3515213">//&nbsp;writerOnly&nbsp;hides&nbsp;an&nbsp;io.Writer&nbsp;value&#39;s&nbsp;optional&nbsp;ReadFrom&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="3515279">//&nbsp;from&nbsp;io.Copy.</span><br>
<span class="lineno">360</span><span class="keyword" id="3515296">type</span>&nbsp;<span class="ident" id="3515301">writerOnly</span>&nbsp;<span class="keyword" id="3515312">struct</span>&nbsp;<span class="op" id="3515319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3515322">io</span><span class="op" id="3515324">.</span><span class="ident" id="3515325">Writer</span><br>
<span class="lineno"></span><span class="op" id="3515332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3515335">func</span>&nbsp;<span class="ident" id="3515340">srcIsRegularFile</span><span class="op" id="3515356">(</span><span class="ident" id="3515357">src</span>&nbsp;<span class="ident" id="3515361">io</span><span class="op" id="3515363">.</span><span class="ident" id="3515364">Reader</span><span class="op" id="3515370">)</span>&nbsp;<span class="op" id="3515372">(</span><span class="ident" id="3515373">isRegular</span>&nbsp;<span class="builtintype" id="3515383">bool</span><span class="op" id="3515387">,</span>&nbsp;<span class="ident" id="3515389">err</span>&nbsp;<span class="builtintype" id="3515393">error</span><span class="op" id="3515398">)</span>&nbsp;<span class="op" id="3515400">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3515403">switch</span>&nbsp;<span class="ident" id="3515410">v</span>&nbsp;<span class="op" id="3515412">:=</span>&nbsp;<span class="ident" id="3515415">src</span><span class="op" id="3515418">.</span><span class="op" id="3515419">(</span><span class="keyword" id="3515420">type</span><span class="op" id="3515424">)</span>&nbsp;<span class="op" id="3515426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3515429">case</span>&nbsp;<span class="op" id="3515434">*</span><span class="ident" id="3515435">os</span><span class="op" id="3515437">.</span><span class="ident" id="3515438">File</span><span class="op" id="3515442">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3515446">fi</span><span class="op" id="3515448">,</span>&nbsp;<span class="ident" id="3515450">err</span>&nbsp;<span class="op" id="3515454">:=</span>&nbsp;<span class="ident" id="3515457">v</span><span class="op" id="3515458">.</span><span class="ident" id="3515459">Stat</span><span class="op" id="3515463">(</span><span class="op" id="3515464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3515468">if</span>&nbsp;<span class="ident" id="3515471">err</span>&nbsp;<span class="op" id="3515475">!=</span>&nbsp;<span class="ident" id="3515478">nil</span>&nbsp;<span class="op" id="3515482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3515487">return</span>&nbsp;<span class="builtintype" id="3515494">false</span><span class="op" id="3515499">,</span>&nbsp;<span class="ident" id="3515501">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3515507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3515511">return</span>&nbsp;<span class="ident" id="3515518">fi</span><span class="op" id="3515520">.</span><span class="ident" id="3515521">Mode</span><span class="op" id="3515525">(</span><span class="op" id="3515526">)</span><span class="op" id="3515527">.</span><span class="ident" id="3515528">IsRegular</span><span class="op" id="3515537">(</span><span class="op" id="3515538">)</span><span class="op" id="3515539">,</span>&nbsp;<span class="ident" id="3515541">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3515546">case</span>&nbsp;<span class="op" id="3515551">*</span><span class="ident" id="3515552">io</span><span class="op" id="3515554">.</span><span class="ident" id="3515555">LimitedReader</span><span class="op" id="3515568">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3515572">return</span>&nbsp;<span class="ident" id="3515579">srcIsRegularFile</span><span class="op" id="3515595">(</span><span class="ident" id="3515596">v</span><span class="op" id="3515597">.</span><span class="ident" id="3515598">R</span><span class="op" id="3515599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3515602">default</span><span class="op" id="3515609">:</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3515613">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3515621">}</span><br>
<span class="lineno"></span><span class="op" id="3515623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3515626">//&nbsp;ReadFrom&nbsp;is&nbsp;here&nbsp;to&nbsp;optimize&nbsp;copying&nbsp;from&nbsp;an&nbsp;*os.File&nbsp;regular&nbsp;file</span><br>
<span class="lineno">380</span><span class="comment" id="3515696">//&nbsp;to&nbsp;a&nbsp;*net.TCPConn&nbsp;with&nbsp;sendfile.</span><br>
<span class="lineno"></span><span class="keyword" id="3515732">func</span>&nbsp;<span class="op" id="3515737">(</span><span class="ident" id="3515738">w</span>&nbsp;<span class="op" id="3515740">*</span><span class="ident" id="3515741">response</span><span class="op" id="3515749">)</span>&nbsp;<span class="ident" id="3515751">ReadFrom</span><span class="op" id="3515759">(</span><span class="ident" id="3515760">src</span>&nbsp;<span class="ident" id="3515764">io</span><span class="op" id="3515766">.</span><span class="ident" id="3515767">Reader</span><span class="op" id="3515773">)</span>&nbsp;<span class="op" id="3515775">(</span><span class="ident" id="3515776">n</span>&nbsp;<span class="ident" id="3515778">int64</span><span class="op" id="3515783">,</span>&nbsp;<span class="ident" id="3515785">err</span>&nbsp;<span class="builtintype" id="3515789">error</span><span class="op" id="3515794">)</span>&nbsp;<span class="op" id="3515796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3515799">//&nbsp;Our&nbsp;underlying&nbsp;w.conn.rwc&nbsp;is&nbsp;usually&nbsp;a&nbsp;*TCPConn&nbsp;(with&nbsp;its</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3515861">//&nbsp;own&nbsp;ReadFrom&nbsp;method).&nbsp;If&nbsp;not,&nbsp;or&nbsp;if&nbsp;our&nbsp;src&nbsp;isn&#39;t&nbsp;a&nbsp;regular</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3515925">//&nbsp;file,&nbsp;just&nbsp;fall&nbsp;back&nbsp;to&nbsp;the&nbsp;normal&nbsp;copy&nbsp;method.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3515977">rf</span><span class="op" id="3515979">,</span>&nbsp;<span class="ident" id="3515981">ok</span>&nbsp;<span class="op" id="3515984">:=</span>&nbsp;<span class="ident" id="3515987">w</span><span class="op" id="3515988">.</span><span class="ident" id="3515989">conn</span><span class="op" id="3515993">.</span><span class="ident" id="3515994">rwc</span><span class="op" id="3515997">.</span><span class="op" id="3515998">(</span><span class="ident" id="3515999">io</span><span class="op" id="3516001">.</span><span class="ident" id="3516002">ReaderFrom</span><span class="op" id="3516012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3516015">regFile</span><span class="op" id="3516022">,</span>&nbsp;<span class="ident" id="3516024">err</span>&nbsp;<span class="op" id="3516028">:=</span>&nbsp;<span class="ident" id="3516031">srcIsRegularFile</span><span class="op" id="3516047">(</span><span class="ident" id="3516048">src</span><span class="op" id="3516051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3516054">if</span>&nbsp;<span class="ident" id="3516057">err</span>&nbsp;<span class="op" id="3516061">!=</span>&nbsp;<span class="ident" id="3516064">nil</span>&nbsp;<span class="op" id="3516068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3516072">return</span>&nbsp;<span class="num" id="3516079">0</span><span class="op" id="3516080">,</span>&nbsp;<span class="ident" id="3516082">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3516087">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3516090">if</span>&nbsp;<span class="op" id="3516093">!</span><span class="ident" id="3516094">ok</span>&nbsp;<span class="op" id="3516097">||</span>&nbsp;<span class="op" id="3516100">!</span><span class="ident" id="3516101">regFile</span>&nbsp;<span class="op" id="3516109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3516113">return</span>&nbsp;<span class="ident" id="3516120">io</span><span class="op" id="3516122">.</span><span class="ident" id="3516123">Copy</span><span class="op" id="3516127">(</span><span class="ident" id="3516128">writerOnly</span><span class="op" id="3516138">{</span><span class="ident" id="3516139">w</span><span class="op" id="3516140">}</span><span class="op" id="3516141">,</span>&nbsp;<span class="ident" id="3516143">src</span><span class="op" id="3516146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3516149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3516153">//&nbsp;sendfile&nbsp;path:</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3516173">if</span>&nbsp;<span class="op" id="3516176">!</span><span class="ident" id="3516177">w</span><span class="op" id="3516178">.</span><span class="ident" id="3516179">wroteHeader</span>&nbsp;<span class="op" id="3516191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3516195">w</span><span class="op" id="3516196">.</span><span class="ident" id="3516197">WriteHeader</span><span class="op" id="3516208">(</span><span class="ident" id="3516209">StatusOK</span><span class="op" id="3516217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3516220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3516224">if</span>&nbsp;<span class="ident" id="3516227">w</span><span class="op" id="3516228">.</span><span class="ident" id="3516229">needsSniff</span><span class="op" id="3516239">(</span><span class="op" id="3516240">)</span>&nbsp;<span class="op" id="3516242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3516246">n0</span><span class="op" id="3516248">,</span>&nbsp;<span class="ident" id="3516250">err</span>&nbsp;<span class="op" id="3516254">:=</span>&nbsp;<span class="ident" id="3516257">io</span><span class="op" id="3516259">.</span><span class="ident" id="3516260">Copy</span><span class="op" id="3516264">(</span><span class="ident" id="3516265">writerOnly</span><span class="op" id="3516275">{</span><span class="ident" id="3516276">w</span><span class="op" id="3516277">}</span><span class="op" id="3516278">,</span>&nbsp;<span class="ident" id="3516280">io</span><span class="op" id="3516282">.</span><span class="ident" id="3516283">LimitReader</span><span class="op" id="3516294">(</span><span class="ident" id="3516295">src</span><span class="op" id="3516298">,</span>&nbsp;<span class="ident" id="3516300">sniffLen</span><span class="op" id="3516308">)</span><span class="op" id="3516309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3516313">n</span>&nbsp;<span class="op" id="3516315">+=</span>&nbsp;<span class="ident" id="3516318">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3516323">if</span>&nbsp;<span class="ident" id="3516326">err</span>&nbsp;<span class="op" id="3516330">!=</span>&nbsp;<span class="ident" id="3516333">nil</span>&nbsp;<span class="op" id="3516337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3516342">return</span>&nbsp;<span class="ident" id="3516349">n</span><span class="op" id="3516350">,</span>&nbsp;<span class="ident" id="3516352">err</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3516358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3516361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3516365">w</span><span class="op" id="3516366">.</span><span class="ident" id="3516367">w</span><span class="op" id="3516368">.</span><span class="ident" id="3516369">Flush</span><span class="op" id="3516374">(</span><span class="op" id="3516375">)</span>&nbsp;&nbsp;<span class="comment" id="3516378">//&nbsp;get&nbsp;rid&nbsp;of&nbsp;any&nbsp;previous&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3516413">w</span><span class="op" id="3516414">.</span><span class="ident" id="3516415">cw</span><span class="op" id="3516417">.</span><span class="ident" id="3516418">flush</span><span class="op" id="3516423">(</span><span class="op" id="3516424">)</span>&nbsp;<span class="comment" id="3516426">//&nbsp;make&nbsp;sure&nbsp;Header&nbsp;is&nbsp;written;&nbsp;flush&nbsp;data&nbsp;to&nbsp;rwc</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3516478">//&nbsp;Now&nbsp;that&nbsp;cw&nbsp;has&nbsp;been&nbsp;flushed,&nbsp;its&nbsp;chunking&nbsp;field&nbsp;is&nbsp;guaranteed&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3516558">if</span>&nbsp;<span class="op" id="3516561">!</span><span class="ident" id="3516562">w</span><span class="op" id="3516563">.</span><span class="ident" id="3516564">cw</span><span class="op" id="3516566">.</span><span class="ident" id="3516567">chunking</span>&nbsp;<span class="op" id="3516576">&amp;&amp;</span>&nbsp;<span class="ident" id="3516579">w</span><span class="op" id="3516580">.</span><span class="ident" id="3516581">bodyAllowed</span><span class="op" id="3516592">(</span><span class="op" id="3516593">)</span>&nbsp;<span class="op" id="3516595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3516599">n0</span><span class="op" id="3516601">,</span>&nbsp;<span class="ident" id="3516603">err</span>&nbsp;<span class="op" id="3516607">:=</span>&nbsp;<span class="ident" id="3516610">rf</span><span class="op" id="3516612">.</span><span class="ident" id="3516613">ReadFrom</span><span class="op" id="3516621">(</span><span class="ident" id="3516622">src</span><span class="op" id="3516625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3516629">n</span>&nbsp;<span class="op" id="3516631">+=</span>&nbsp;<span class="ident" id="3516634">n0</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3516639">w</span><span class="op" id="3516640">.</span><span class="ident" id="3516641">written</span>&nbsp;<span class="op" id="3516649">+=</span>&nbsp;<span class="ident" id="3516652">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3516657">return</span>&nbsp;<span class="ident" id="3516664">n</span><span class="op" id="3516665">,</span>&nbsp;<span class="ident" id="3516667">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3516672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3516676">n0</span><span class="op" id="3516678">,</span>&nbsp;<span class="ident" id="3516680">err</span>&nbsp;<span class="op" id="3516684">:=</span>&nbsp;<span class="ident" id="3516687">io</span><span class="op" id="3516689">.</span><span class="ident" id="3516690">Copy</span><span class="op" id="3516694">(</span><span class="ident" id="3516695">writerOnly</span><span class="op" id="3516705">{</span><span class="ident" id="3516706">w</span><span class="op" id="3516707">}</span><span class="op" id="3516708">,</span>&nbsp;<span class="ident" id="3516710">src</span><span class="op" id="3516713">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3516716">n</span>&nbsp;<span class="op" id="3516718">+=</span>&nbsp;<span class="ident" id="3516721">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3516725">return</span>&nbsp;<span class="ident" id="3516732">n</span><span class="op" id="3516733">,</span>&nbsp;<span class="ident" id="3516735">err</span><br>
<span class="lineno"></span><span class="op" id="3516739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3516742">//&nbsp;noLimit&nbsp;is&nbsp;an&nbsp;effective&nbsp;infinite&nbsp;upper&nbsp;bound&nbsp;for&nbsp;io.LimitedReader</span><br>
<span class="lineno">425</span><span class="keyword" id="3516811">const</span>&nbsp;<span class="ident" id="3516817">noLimit</span>&nbsp;<span class="ident" id="3516825">int64</span>&nbsp;<span class="op" id="3516831">=</span>&nbsp;<span class="op" id="3516833">(</span><span class="num" id="3516834">1</span>&nbsp;<span class="op" id="3516836">&lt;&lt;</span>&nbsp;<span class="num" id="3516839">63</span><span class="op" id="3516841">)</span>&nbsp;<span class="op" id="3516843">-</span>&nbsp;<span class="num" id="3516845">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3516848">//&nbsp;debugServerConnections&nbsp;controls&nbsp;whether&nbsp;all&nbsp;server&nbsp;connections&nbsp;are&nbsp;wrapped</span><br>
<span class="lineno"></span><span class="comment" id="3516926">//&nbsp;with&nbsp;a&nbsp;verbose&nbsp;logging&nbsp;wrapper.</span><br>
<span class="lineno"></span><span class="keyword" id="3516961">const</span>&nbsp;<span class="ident" id="3516967">debugServerConnections</span>&nbsp;<span class="op" id="3516990">=</span>&nbsp;<span class="builtintype" id="3516992">false</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="comment" id="3516999">//&nbsp;Create&nbsp;new&nbsp;connection&nbsp;from&nbsp;rwc.</span><br>
<span class="lineno"></span><span class="keyword" id="3517034">func</span>&nbsp;<span class="op" id="3517039">(</span><span class="ident" id="3517040">srv</span>&nbsp;<span class="op" id="3517044">*</span><span class="ident" id="3517045">Server</span><span class="op" id="3517051">)</span>&nbsp;<span class="ident" id="3517053">newConn</span><span class="op" id="3517060">(</span><span class="ident" id="3517061">rwc</span>&nbsp;<span class="ident" id="3517065">net</span><span class="op" id="3517068">.</span><span class="ident" id="3517069">Conn</span><span class="op" id="3517073">)</span>&nbsp;<span class="op" id="3517075">(</span><span class="ident" id="3517076">c</span>&nbsp;<span class="op" id="3517078">*</span><span class="ident" id="3517079">conn</span><span class="op" id="3517083">,</span>&nbsp;<span class="ident" id="3517085">err</span>&nbsp;<span class="builtintype" id="3517089">error</span><span class="op" id="3517094">)</span>&nbsp;<span class="op" id="3517096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517099">c</span>&nbsp;<span class="op" id="3517101">=</span>&nbsp;<span class="builtinfunc" id="3517103">new</span><span class="op" id="3517106">(</span><span class="ident" id="3517107">conn</span><span class="op" id="3517111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517114">c</span><span class="op" id="3517115">.</span><span class="ident" id="3517116">remoteAddr</span>&nbsp;<span class="op" id="3517127">=</span>&nbsp;<span class="ident" id="3517129">rwc</span><span class="op" id="3517132">.</span><span class="ident" id="3517133">RemoteAddr</span><span class="op" id="3517143">(</span><span class="op" id="3517144">)</span><span class="op" id="3517145">.</span><span class="ident" id="3517146">String</span><span class="op" id="3517152">(</span><span class="op" id="3517153">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517156">c</span><span class="op" id="3517157">.</span><span class="ident" id="3517158">server</span>&nbsp;<span class="op" id="3517165">=</span>&nbsp;<span class="ident" id="3517167">srv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517172">c</span><span class="op" id="3517173">.</span><span class="ident" id="3517174">rwc</span>&nbsp;<span class="op" id="3517178">=</span>&nbsp;<span class="ident" id="3517180">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517185">c</span><span class="op" id="3517186">.</span><span class="ident" id="3517187">w</span>&nbsp;<span class="op" id="3517189">=</span>&nbsp;<span class="ident" id="3517191">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3517196">if</span>&nbsp;<span class="ident" id="3517199">debugServerConnections</span>&nbsp;<span class="op" id="3517222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517226">c</span><span class="op" id="3517227">.</span><span class="ident" id="3517228">rwc</span>&nbsp;<span class="op" id="3517232">=</span>&nbsp;<span class="ident" id="3517234">newLoggingConn</span><span class="op" id="3517248">(</span><span class="string" id="3517249">&#34;server&#34;</span><span class="op" id="3517257">,</span>&nbsp;<span class="ident" id="3517259">c</span><span class="op" id="3517260">.</span><span class="ident" id="3517261">rwc</span><span class="op" id="3517264">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3517267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517270">c</span><span class="op" id="3517271">.</span><span class="ident" id="3517272">sr</span>&nbsp;<span class="op" id="3517275">=</span>&nbsp;<span class="ident" id="3517277">liveSwitchReader</span><span class="op" id="3517293">{</span><span class="ident" id="3517294">r</span><span class="op" id="3517295">:</span>&nbsp;<span class="ident" id="3517297">c</span><span class="op" id="3517298">.</span><span class="ident" id="3517299">rwc</span><span class="op" id="3517302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517305">c</span><span class="op" id="3517306">.</span><span class="ident" id="3517307">lr</span>&nbsp;<span class="op" id="3517310">=</span>&nbsp;<span class="ident" id="3517312">io</span><span class="op" id="3517314">.</span><span class="ident" id="3517315">LimitReader</span><span class="op" id="3517326">(</span><span class="op" id="3517327">&amp;</span><span class="ident" id="3517328">c</span><span class="op" id="3517329">.</span><span class="ident" id="3517330">sr</span><span class="op" id="3517332">,</span>&nbsp;<span class="ident" id="3517334">noLimit</span><span class="op" id="3517341">)</span><span class="op" id="3517342">.</span><span class="op" id="3517343">(</span><span class="op" id="3517344">*</span><span class="ident" id="3517345">io</span><span class="op" id="3517347">.</span><span class="ident" id="3517348">LimitedReader</span><span class="op" id="3517361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517364">br</span>&nbsp;<span class="op" id="3517367">:=</span>&nbsp;<span class="ident" id="3517370">newBufioReader</span><span class="op" id="3517384">(</span><span class="ident" id="3517385">c</span><span class="op" id="3517386">.</span><span class="ident" id="3517387">lr</span><span class="op" id="3517389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517392">bw</span>&nbsp;<span class="op" id="3517395">:=</span>&nbsp;<span class="ident" id="3517398">newBufioWriterSize</span><span class="op" id="3517416">(</span><span class="ident" id="3517417">checkConnErrorWriter</span><span class="op" id="3517437">{</span><span class="ident" id="3517438">c</span><span class="op" id="3517439">}</span><span class="op" id="3517440">,</span>&nbsp;<span class="num" id="3517442">4</span><span class="op" id="3517443">&lt;&lt;</span><span class="num" id="3517445">10</span><span class="op" id="3517447">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517450">c</span><span class="op" id="3517451">.</span><span class="ident" id="3517452">buf</span>&nbsp;<span class="op" id="3517456">=</span>&nbsp;<span class="ident" id="3517458">bufio</span><span class="op" id="3517463">.</span><span class="ident" id="3517464">NewReadWriter</span><span class="op" id="3517477">(</span><span class="ident" id="3517478">br</span><span class="op" id="3517480">,</span>&nbsp;<span class="ident" id="3517482">bw</span><span class="op" id="3517484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3517487">return</span>&nbsp;<span class="ident" id="3517494">c</span><span class="op" id="3517495">,</span>&nbsp;<span class="ident" id="3517497">nil</span><br>
<span class="lineno"></span><span class="op" id="3517501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3517504">var</span>&nbsp;<span class="op" id="3517508">(</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517511">bufioReaderPool</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3517529">sync</span><span class="op" id="3517533">.</span><span class="ident" id="3517534">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517540">bufioWriter2kPool</span>&nbsp;<span class="ident" id="3517558">sync</span><span class="op" id="3517562">.</span><span class="ident" id="3517563">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517569">bufioWriter4kPool</span>&nbsp;<span class="ident" id="3517587">sync</span><span class="op" id="3517591">.</span><span class="ident" id="3517592">Pool</span><br>
<span class="lineno"></span><span class="op" id="3517597">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="keyword" id="3517600">func</span>&nbsp;<span class="ident" id="3517605">bufioWriterPool</span><span class="op" id="3517620">(</span><span class="ident" id="3517621">size</span>&nbsp;<span class="builtintype" id="3517626">int</span><span class="op" id="3517629">)</span>&nbsp;<span class="op" id="3517631">*</span><span class="ident" id="3517632">sync</span><span class="op" id="3517636">.</span><span class="ident" id="3517637">Pool</span>&nbsp;<span class="op" id="3517642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3517645">switch</span>&nbsp;<span class="ident" id="3517652">size</span>&nbsp;<span class="op" id="3517657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3517660">case</span>&nbsp;<span class="num" id="3517665">2</span>&nbsp;<span class="op" id="3517667">&lt;&lt;</span>&nbsp;<span class="num" id="3517670">10</span><span class="op" id="3517672">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3517676">return</span>&nbsp;<span class="op" id="3517683">&amp;</span><span class="ident" id="3517684">bufioWriter2kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3517703">case</span>&nbsp;<span class="num" id="3517708">4</span>&nbsp;<span class="op" id="3517710">&lt;&lt;</span>&nbsp;<span class="num" id="3517713">10</span><span class="op" id="3517715">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3517719">return</span>&nbsp;<span class="op" id="3517726">&amp;</span><span class="ident" id="3517727">bufioWriter4kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3517746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3517749">return</span>&nbsp;<span class="ident" id="3517756">nil</span><br>
<span class="lineno"></span><span class="op" id="3517760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="keyword" id="3517763">func</span>&nbsp;<span class="ident" id="3517768">newBufioReader</span><span class="op" id="3517782">(</span><span class="ident" id="3517783">r</span>&nbsp;<span class="ident" id="3517785">io</span><span class="op" id="3517787">.</span><span class="ident" id="3517788">Reader</span><span class="op" id="3517794">)</span>&nbsp;<span class="op" id="3517796">*</span><span class="ident" id="3517797">bufio</span><span class="op" id="3517802">.</span><span class="ident" id="3517803">Reader</span>&nbsp;<span class="op" id="3517810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3517813">if</span>&nbsp;<span class="ident" id="3517816">v</span>&nbsp;<span class="op" id="3517818">:=</span>&nbsp;<span class="ident" id="3517821">bufioReaderPool</span><span class="op" id="3517836">.</span><span class="ident" id="3517837">Get</span><span class="op" id="3517840">(</span><span class="op" id="3517841">)</span><span class="op" id="3517842">;</span>&nbsp;<span class="ident" id="3517844">v</span>&nbsp;<span class="op" id="3517846">!=</span>&nbsp;<span class="ident" id="3517849">nil</span>&nbsp;<span class="op" id="3517853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517857">br</span>&nbsp;<span class="op" id="3517860">:=</span>&nbsp;<span class="ident" id="3517863">v</span><span class="op" id="3517864">.</span><span class="op" id="3517865">(</span><span class="op" id="3517866">*</span><span class="ident" id="3517867">bufio</span><span class="op" id="3517872">.</span><span class="ident" id="3517873">Reader</span><span class="op" id="3517879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517883">br</span><span class="op" id="3517885">.</span><span class="ident" id="3517886">Reset</span><span class="op" id="3517891">(</span><span class="ident" id="3517892">r</span><span class="op" id="3517893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3517897">return</span>&nbsp;<span class="ident" id="3517904">br</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3517908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3517911">return</span>&nbsp;<span class="ident" id="3517918">bufio</span><span class="op" id="3517923">.</span><span class="ident" id="3517924">NewReader</span><span class="op" id="3517933">(</span><span class="ident" id="3517934">r</span><span class="op" id="3517935">)</span><br>
<span class="lineno"></span><span class="op" id="3517937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3517940">func</span>&nbsp;<span class="ident" id="3517945">putBufioReader</span><span class="op" id="3517959">(</span><span class="ident" id="3517960">br</span>&nbsp;<span class="op" id="3517963">*</span><span class="ident" id="3517964">bufio</span><span class="op" id="3517969">.</span><span class="ident" id="3517970">Reader</span><span class="op" id="3517976">)</span>&nbsp;<span class="op" id="3517978">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517981">br</span><span class="op" id="3517983">.</span><span class="ident" id="3517984">Reset</span><span class="op" id="3517989">(</span><span class="ident" id="3517990">nil</span><span class="op" id="3517993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3517996">bufioReaderPool</span><span class="op" id="3518011">.</span><span class="ident" id="3518012">Put</span><span class="op" id="3518015">(</span><span class="ident" id="3518016">br</span><span class="op" id="3518018">)</span><br>
<span class="lineno"></span><span class="op" id="3518020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3518023">func</span>&nbsp;<span class="ident" id="3518028">newBufioWriterSize</span><span class="op" id="3518046">(</span><span class="ident" id="3518047">w</span>&nbsp;<span class="ident" id="3518049">io</span><span class="op" id="3518051">.</span><span class="ident" id="3518052">Writer</span><span class="op" id="3518058">,</span>&nbsp;<span class="ident" id="3518060">size</span>&nbsp;<span class="builtintype" id="3518065">int</span><span class="op" id="3518068">)</span>&nbsp;<span class="op" id="3518070">*</span><span class="ident" id="3518071">bufio</span><span class="op" id="3518076">.</span><span class="ident" id="3518077">Writer</span>&nbsp;<span class="op" id="3518084">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3518087">pool</span>&nbsp;<span class="op" id="3518092">:=</span>&nbsp;<span class="ident" id="3518095">bufioWriterPool</span><span class="op" id="3518110">(</span><span class="ident" id="3518111">size</span><span class="op" id="3518115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3518118">if</span>&nbsp;<span class="ident" id="3518121">pool</span>&nbsp;<span class="op" id="3518126">!=</span>&nbsp;<span class="ident" id="3518129">nil</span>&nbsp;<span class="op" id="3518133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3518137">if</span>&nbsp;<span class="ident" id="3518140">v</span>&nbsp;<span class="op" id="3518142">:=</span>&nbsp;<span class="ident" id="3518145">pool</span><span class="op" id="3518149">.</span><span class="ident" id="3518150">Get</span><span class="op" id="3518153">(</span><span class="op" id="3518154">)</span><span class="op" id="3518155">;</span>&nbsp;<span class="ident" id="3518157">v</span>&nbsp;<span class="op" id="3518159">!=</span>&nbsp;<span class="ident" id="3518162">nil</span>&nbsp;<span class="op" id="3518166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3518171">bw</span>&nbsp;<span class="op" id="3518174">:=</span>&nbsp;<span class="ident" id="3518177">v</span><span class="op" id="3518178">.</span><span class="op" id="3518179">(</span><span class="op" id="3518180">*</span><span class="ident" id="3518181">bufio</span><span class="op" id="3518186">.</span><span class="ident" id="3518187">Writer</span><span class="op" id="3518193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3518198">bw</span><span class="op" id="3518200">.</span><span class="ident" id="3518201">Reset</span><span class="op" id="3518206">(</span><span class="ident" id="3518207">w</span><span class="op" id="3518208">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3518213">return</span>&nbsp;<span class="ident" id="3518220">bw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3518225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3518228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3518231">return</span>&nbsp;<span class="ident" id="3518238">bufio</span><span class="op" id="3518243">.</span><span class="ident" id="3518244">NewWriterSize</span><span class="op" id="3518257">(</span><span class="ident" id="3518258">w</span><span class="op" id="3518259">,</span>&nbsp;<span class="ident" id="3518261">size</span><span class="op" id="3518265">)</span><br>
<span class="lineno"></span><span class="op" id="3518267">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="keyword" id="3518270">func</span>&nbsp;<span class="ident" id="3518275">putBufioWriter</span><span class="op" id="3518289">(</span><span class="ident" id="3518290">bw</span>&nbsp;<span class="op" id="3518293">*</span><span class="ident" id="3518294">bufio</span><span class="op" id="3518299">.</span><span class="ident" id="3518300">Writer</span><span class="op" id="3518306">)</span>&nbsp;<span class="op" id="3518308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3518311">bw</span><span class="op" id="3518313">.</span><span class="ident" id="3518314">Reset</span><span class="op" id="3518319">(</span><span class="ident" id="3518320">nil</span><span class="op" id="3518323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3518326">if</span>&nbsp;<span class="ident" id="3518329">pool</span>&nbsp;<span class="op" id="3518334">:=</span>&nbsp;<span class="ident" id="3518337">bufioWriterPool</span><span class="op" id="3518352">(</span><span class="ident" id="3518353">bw</span><span class="op" id="3518355">.</span><span class="ident" id="3518356">Available</span><span class="op" id="3518365">(</span><span class="op" id="3518366">)</span><span class="op" id="3518367">)</span><span class="op" id="3518368">;</span>&nbsp;<span class="ident" id="3518370">pool</span>&nbsp;<span class="op" id="3518375">!=</span>&nbsp;<span class="ident" id="3518378">nil</span>&nbsp;<span class="op" id="3518382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3518386">pool</span><span class="op" id="3518390">.</span><span class="ident" id="3518391">Put</span><span class="op" id="3518394">(</span><span class="ident" id="3518395">bw</span><span class="op" id="3518397">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3518400">}</span><br>
<span class="lineno"></span><span class="op" id="3518402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3518405">//&nbsp;DefaultMaxHeaderBytes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;permitted&nbsp;size&nbsp;of&nbsp;the&nbsp;headers</span><br>
<span class="lineno"></span><span class="comment" id="3518475">//&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno">500</span><span class="comment" id="3518498">//&nbsp;This&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;setting&nbsp;Server.MaxHeaderBytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3518558">const</span>&nbsp;<span class="ident" id="3518564">DefaultMaxHeaderBytes</span>&nbsp;<span class="op" id="3518586">=</span>&nbsp;<span class="num" id="3518588">1</span>&nbsp;<span class="op" id="3518590">&lt;&lt;</span>&nbsp;<span class="num" id="3518593">20</span>&nbsp;<span class="comment" id="3518596">//&nbsp;1&nbsp;MB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3518605">func</span>&nbsp;<span class="op" id="3518610">(</span><span class="ident" id="3518611">srv</span>&nbsp;<span class="op" id="3518615">*</span><span class="ident" id="3518616">Server</span><span class="op" id="3518622">)</span>&nbsp;<span class="ident" id="3518624">maxHeaderBytes</span><span class="op" id="3518638">(</span><span class="op" id="3518639">)</span>&nbsp;<span class="builtintype" id="3518641">int</span>&nbsp;<span class="op" id="3518645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3518648">if</span>&nbsp;<span class="ident" id="3518651">srv</span><span class="op" id="3518654">.</span><span class="ident" id="3518655">MaxHeaderBytes</span>&nbsp;<span class="op" id="3518670">&gt;</span>&nbsp;<span class="num" id="3518672">0</span>&nbsp;<span class="op" id="3518674">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3518678">return</span>&nbsp;<span class="ident" id="3518685">srv</span><span class="op" id="3518688">.</span><span class="ident" id="3518689">MaxHeaderBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3518705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3518708">return</span>&nbsp;<span class="ident" id="3518715">DefaultMaxHeaderBytes</span><br>
<span class="lineno"></span><span class="op" id="3518737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="3518740">func</span>&nbsp;<span class="op" id="3518745">(</span><span class="ident" id="3518746">srv</span>&nbsp;<span class="op" id="3518750">*</span><span class="ident" id="3518751">Server</span><span class="op" id="3518757">)</span>&nbsp;<span class="ident" id="3518759">initialLimitedReaderSize</span><span class="op" id="3518783">(</span><span class="op" id="3518784">)</span>&nbsp;<span class="ident" id="3518786">int64</span>&nbsp;<span class="op" id="3518792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3518795">return</span>&nbsp;<span class="ident" id="3518802">int64</span><span class="op" id="3518807">(</span><span class="ident" id="3518808">srv</span><span class="op" id="3518811">.</span><span class="ident" id="3518812">maxHeaderBytes</span><span class="op" id="3518826">(</span><span class="op" id="3518827">)</span><span class="op" id="3518828">)</span>&nbsp;<span class="op" id="3518830">+</span>&nbsp;<span class="num" id="3518832">4096</span>&nbsp;<span class="comment" id="3518837">//&nbsp;bufio&nbsp;slop</span><br>
<span class="lineno"></span><span class="op" id="3518851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3518854">//&nbsp;wrapper&nbsp;around&nbsp;io.ReaderCloser&nbsp;which&nbsp;on&nbsp;first&nbsp;read,&nbsp;sends&nbsp;an</span><br>
<span class="lineno">515</span><span class="comment" id="3518918">//&nbsp;HTTP/1.1&nbsp;100&nbsp;Continue&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3518950">type</span>&nbsp;<span class="ident" id="3518955">expectContinueReader</span>&nbsp;<span class="keyword" id="3518976">struct</span>&nbsp;<span class="op" id="3518983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3518986">resp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3518997">*</span><span class="ident" id="3518998">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3519008">readCloser</span>&nbsp;<span class="ident" id="3519019">io</span><span class="op" id="3519021">.</span><span class="ident" id="3519022">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3519034">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3519045">bool</span><br>
<span class="lineno">520</span><span class="op" id="3519050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3519053">func</span>&nbsp;<span class="op" id="3519058">(</span><span class="ident" id="3519059">ecr</span>&nbsp;<span class="op" id="3519063">*</span><span class="ident" id="3519064">expectContinueReader</span><span class="op" id="3519084">)</span>&nbsp;<span class="ident" id="3519086">Read</span><span class="op" id="3519090">(</span><span class="ident" id="3519091">p</span>&nbsp;<span class="op" id="3519093">[</span><span class="op" id="3519094">]</span><span class="builtintype" id="3519095">byte</span><span class="op" id="3519099">)</span>&nbsp;<span class="op" id="3519101">(</span><span class="ident" id="3519102">n</span>&nbsp;<span class="builtintype" id="3519104">int</span><span class="op" id="3519107">,</span>&nbsp;<span class="ident" id="3519109">err</span>&nbsp;<span class="builtintype" id="3519113">error</span><span class="op" id="3519118">)</span>&nbsp;<span class="op" id="3519120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3519123">if</span>&nbsp;<span class="ident" id="3519126">ecr</span><span class="op" id="3519129">.</span><span class="ident" id="3519130">closed</span>&nbsp;<span class="op" id="3519137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3519141">return</span>&nbsp;<span class="num" id="3519148">0</span><span class="op" id="3519149">,</span>&nbsp;<span class="ident" id="3519151">ErrBodyReadAfterClose</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3519174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3519177">if</span>&nbsp;<span class="op" id="3519180">!</span><span class="ident" id="3519181">ecr</span><span class="op" id="3519184">.</span><span class="ident" id="3519185">resp</span><span class="op" id="3519189">.</span><span class="ident" id="3519190">wroteContinue</span>&nbsp;<span class="op" id="3519204">&amp;&amp;</span>&nbsp;<span class="op" id="3519207">!</span><span class="ident" id="3519208">ecr</span><span class="op" id="3519211">.</span><span class="ident" id="3519212">resp</span><span class="op" id="3519216">.</span><span class="ident" id="3519217">conn</span><span class="op" id="3519221">.</span><span class="ident" id="3519222">hijacked</span><span class="op" id="3519230">(</span><span class="op" id="3519231">)</span>&nbsp;<span class="op" id="3519233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3519237">ecr</span><span class="op" id="3519240">.</span><span class="ident" id="3519241">resp</span><span class="op" id="3519245">.</span><span class="ident" id="3519246">wroteContinue</span>&nbsp;<span class="op" id="3519260">=</span>&nbsp;<span class="builtintype" id="3519262">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3519269">ecr</span><span class="op" id="3519272">.</span><span class="ident" id="3519273">resp</span><span class="op" id="3519277">.</span><span class="ident" id="3519278">conn</span><span class="op" id="3519282">.</span><span class="ident" id="3519283">buf</span><span class="op" id="3519286">.</span><span class="ident" id="3519287">WriteString</span><span class="op" id="3519298">(</span><span class="string" id="3519299">&#34;HTTP/1.1&nbsp;100&nbsp;Continue\r\n\r\n&#34;</span><span class="op" id="3519330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3519334">ecr</span><span class="op" id="3519337">.</span><span class="ident" id="3519338">resp</span><span class="op" id="3519342">.</span><span class="ident" id="3519343">conn</span><span class="op" id="3519347">.</span><span class="ident" id="3519348">buf</span><span class="op" id="3519351">.</span><span class="ident" id="3519352">Flush</span><span class="op" id="3519357">(</span><span class="op" id="3519358">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3519361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3519364">return</span>&nbsp;<span class="ident" id="3519371">ecr</span><span class="op" id="3519374">.</span><span class="ident" id="3519375">readCloser</span><span class="op" id="3519385">.</span><span class="ident" id="3519386">Read</span><span class="op" id="3519390">(</span><span class="ident" id="3519391">p</span><span class="op" id="3519392">)</span><br>
<span class="lineno"></span><span class="op" id="3519394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3519397">func</span>&nbsp;<span class="op" id="3519402">(</span><span class="ident" id="3519403">ecr</span>&nbsp;<span class="op" id="3519407">*</span><span class="ident" id="3519408">expectContinueReader</span><span class="op" id="3519428">)</span>&nbsp;<span class="ident" id="3519430">Close</span><span class="op" id="3519435">(</span><span class="op" id="3519436">)</span>&nbsp;<span class="builtintype" id="3519438">error</span>&nbsp;<span class="op" id="3519444">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3519447">ecr</span><span class="op" id="3519450">.</span><span class="ident" id="3519451">closed</span>&nbsp;<span class="op" id="3519458">=</span>&nbsp;<span class="builtintype" id="3519460">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3519466">return</span>&nbsp;<span class="ident" id="3519473">ecr</span><span class="op" id="3519476">.</span><span class="ident" id="3519477">readCloser</span><span class="op" id="3519487">.</span><span class="ident" id="3519488">Close</span><span class="op" id="3519493">(</span><span class="op" id="3519494">)</span><br>
<span class="lineno"></span><span class="op" id="3519496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3519499">//&nbsp;TimeFormat&nbsp;is&nbsp;the&nbsp;time&nbsp;format&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno">540</span><span class="comment" id="3519544">//&nbsp;time.Parse&nbsp;and&nbsp;time.Time.Format&nbsp;when&nbsp;parsing</span><br>
<span class="lineno"></span><span class="comment" id="3519592">//&nbsp;or&nbsp;generating&nbsp;times&nbsp;in&nbsp;HTTP&nbsp;headers.</span><br>
<span class="lineno"></span><span class="comment" id="3519632">//&nbsp;It&nbsp;is&nbsp;like&nbsp;time.RFC1123&nbsp;but&nbsp;hard&nbsp;codes&nbsp;GMT&nbsp;as&nbsp;the&nbsp;time&nbsp;zone.</span><br>
<span class="lineno"></span><span class="keyword" id="3519696">const</span>&nbsp;<span class="ident" id="3519702">TimeFormat</span>&nbsp;<span class="op" id="3519713">=</span>&nbsp;<span class="string" id="3519715">&#34;Mon,&nbsp;02&nbsp;Jan&nbsp;2006&nbsp;15:04:05&nbsp;GMT&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span><span class="comment" id="3519748">//&nbsp;appendTime&nbsp;is&nbsp;a&nbsp;non-allocating&nbsp;version&nbsp;of&nbsp;[]byte(t.UTC().Format(TimeFormat))</span><br>
<span class="lineno"></span><span class="keyword" id="3519828">func</span>&nbsp;<span class="ident" id="3519833">appendTime</span><span class="op" id="3519843">(</span><span class="ident" id="3519844">b</span>&nbsp;<span class="op" id="3519846">[</span><span class="op" id="3519847">]</span><span class="builtintype" id="3519848">byte</span><span class="op" id="3519852">,</span>&nbsp;<span class="ident" id="3519854">t</span>&nbsp;<span class="ident" id="3519856">time</span><span class="op" id="3519860">.</span><span class="ident" id="3519861">Time</span><span class="op" id="3519865">)</span>&nbsp;<span class="op" id="3519867">[</span><span class="op" id="3519868">]</span><span class="builtintype" id="3519869">byte</span>&nbsp;<span class="op" id="3519874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3519877">const</span>&nbsp;<span class="ident" id="3519883">days</span>&nbsp;<span class="op" id="3519888">=</span>&nbsp;<span class="string" id="3519890">&#34;SunMonTueWedThuFriSat&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3519915">const</span>&nbsp;<span class="ident" id="3519921">months</span>&nbsp;<span class="op" id="3519928">=</span>&nbsp;<span class="string" id="3519930">&#34;JanFebMarAprMayJunJulAugSepOctNovDec&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3519971">t</span>&nbsp;<span class="op" id="3519973">=</span>&nbsp;<span class="ident" id="3519975">t</span><span class="op" id="3519976">.</span><span class="ident" id="3519977">UTC</span><span class="op" id="3519980">(</span><span class="op" id="3519981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3519984">yy</span><span class="op" id="3519986">,</span>&nbsp;<span class="ident" id="3519988">mm</span><span class="op" id="3519990">,</span>&nbsp;<span class="ident" id="3519992">dd</span>&nbsp;<span class="op" id="3519995">:=</span>&nbsp;<span class="ident" id="3519998">t</span><span class="op" id="3519999">.</span><span class="ident" id="3520000">Date</span><span class="op" id="3520004">(</span><span class="op" id="3520005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3520008">hh</span><span class="op" id="3520010">,</span>&nbsp;<span class="ident" id="3520012">mn</span><span class="op" id="3520014">,</span>&nbsp;<span class="ident" id="3520016">ss</span>&nbsp;<span class="op" id="3520019">:=</span>&nbsp;<span class="ident" id="3520022">t</span><span class="op" id="3520023">.</span><span class="ident" id="3520024">Clock</span><span class="op" id="3520029">(</span><span class="op" id="3520030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3520033">day</span>&nbsp;<span class="op" id="3520037">:=</span>&nbsp;<span class="ident" id="3520040">days</span><span class="op" id="3520044">[</span><span class="num" id="3520045">3</span><span class="op" id="3520046">*</span><span class="ident" id="3520047">t</span><span class="op" id="3520048">.</span><span class="ident" id="3520049">Weekday</span><span class="op" id="3520056">(</span><span class="op" id="3520057">)</span><span class="op" id="3520058">:</span><span class="op" id="3520059">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3520062">mon</span>&nbsp;<span class="op" id="3520066">:=</span>&nbsp;<span class="ident" id="3520069">months</span><span class="op" id="3520075">[</span><span class="num" id="3520076">3</span><span class="op" id="3520077">*</span><span class="op" id="3520078">(</span><span class="ident" id="3520079">mm</span><span class="op" id="3520081">-</span><span class="num" id="3520082">1</span><span class="op" id="3520083">)</span><span class="op" id="3520084">:</span><span class="op" id="3520085">]</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3520089">return</span>&nbsp;<span class="builtinfunc" id="3520096">append</span><span class="op" id="3520102">(</span><span class="ident" id="3520103">b</span><span class="op" id="3520104">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3520108">day</span><span class="op" id="3520111">[</span><span class="num" id="3520112">0</span><span class="op" id="3520113">]</span><span class="op" id="3520114">,</span>&nbsp;<span class="ident" id="3520116">day</span><span class="op" id="3520119">[</span><span class="num" id="3520120">1</span><span class="op" id="3520121">]</span><span class="op" id="3520122">,</span>&nbsp;<span class="ident" id="3520124">day</span><span class="op" id="3520127">[</span><span class="num" id="3520128">2</span><span class="op" id="3520129">]</span><span class="op" id="3520130">,</span>&nbsp;<span class="string" id="3520132">&#39;,&#39;</span><span class="op" id="3520135">,</span>&nbsp;<span class="string" id="3520137">&#39;&nbsp;&#39;</span><span class="op" id="3520140">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3520144">byte</span><span class="op" id="3520148">(</span><span class="string" id="3520149">&#39;0&#39;</span><span class="op" id="3520152">+</span><span class="ident" id="3520153">dd</span><span class="op" id="3520155">/</span><span class="num" id="3520156">10</span><span class="op" id="3520158">)</span><span class="op" id="3520159">,</span>&nbsp;<span class="builtintype" id="3520161">byte</span><span class="op" id="3520165">(</span><span class="string" id="3520166">&#39;0&#39;</span><span class="op" id="3520169">+</span><span class="ident" id="3520170">dd</span><span class="op" id="3520172">%</span><span class="num" id="3520173">10</span><span class="op" id="3520175">)</span><span class="op" id="3520176">,</span>&nbsp;<span class="string" id="3520178">&#39;&nbsp;&#39;</span><span class="op" id="3520181">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3520185">mon</span><span class="op" id="3520188">[</span><span class="num" id="3520189">0</span><span class="op" id="3520190">]</span><span class="op" id="3520191">,</span>&nbsp;<span class="ident" id="3520193">mon</span><span class="op" id="3520196">[</span><span class="num" id="3520197">1</span><span class="op" id="3520198">]</span><span class="op" id="3520199">,</span>&nbsp;<span class="ident" id="3520201">mon</span><span class="op" id="3520204">[</span><span class="num" id="3520205">2</span><span class="op" id="3520206">]</span><span class="op" id="3520207">,</span>&nbsp;<span class="string" id="3520209">&#39;&nbsp;&#39;</span><span class="op" id="3520212">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3520216">byte</span><span class="op" id="3520220">(</span><span class="string" id="3520221">&#39;0&#39;</span><span class="op" id="3520224">+</span><span class="ident" id="3520225">yy</span><span class="op" id="3520227">/</span><span class="num" id="3520228">1000</span><span class="op" id="3520232">)</span><span class="op" id="3520233">,</span>&nbsp;<span class="builtintype" id="3520235">byte</span><span class="op" id="3520239">(</span><span class="string" id="3520240">&#39;0&#39;</span><span class="op" id="3520243">+</span><span class="op" id="3520244">(</span><span class="ident" id="3520245">yy</span><span class="op" id="3520247">/</span><span class="num" id="3520248">100</span><span class="op" id="3520251">)</span><span class="op" id="3520252">%</span><span class="num" id="3520253">10</span><span class="op" id="3520255">)</span><span class="op" id="3520256">,</span>&nbsp;<span class="builtintype" id="3520258">byte</span><span class="op" id="3520262">(</span><span class="string" id="3520263">&#39;0&#39;</span><span class="op" id="3520266">+</span><span class="op" id="3520267">(</span><span class="ident" id="3520268">yy</span><span class="op" id="3520270">/</span><span class="num" id="3520271">10</span><span class="op" id="3520273">)</span><span class="op" id="3520274">%</span><span class="num" id="3520275">10</span><span class="op" id="3520277">)</span><span class="op" id="3520278">,</span>&nbsp;<span class="builtintype" id="3520280">byte</span><span class="op" id="3520284">(</span><span class="string" id="3520285">&#39;0&#39;</span><span class="op" id="3520288">+</span><span class="ident" id="3520289">yy</span><span class="op" id="3520291">%</span><span class="num" id="3520292">10</span><span class="op" id="3520294">)</span><span class="op" id="3520295">,</span>&nbsp;<span class="string" id="3520297">&#39;&nbsp;&#39;</span><span class="op" id="3520300">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3520304">byte</span><span class="op" id="3520308">(</span><span class="string" id="3520309">&#39;0&#39;</span><span class="op" id="3520312">+</span><span class="ident" id="3520313">hh</span><span class="op" id="3520315">/</span><span class="num" id="3520316">10</span><span class="op" id="3520318">)</span><span class="op" id="3520319">,</span>&nbsp;<span class="builtintype" id="3520321">byte</span><span class="op" id="3520325">(</span><span class="string" id="3520326">&#39;0&#39;</span><span class="op" id="3520329">+</span><span class="ident" id="3520330">hh</span><span class="op" id="3520332">%</span><span class="num" id="3520333">10</span><span class="op" id="3520335">)</span><span class="op" id="3520336">,</span>&nbsp;<span class="string" id="3520338">&#39;:&#39;</span><span class="op" id="3520341">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3520345">byte</span><span class="op" id="3520349">(</span><span class="string" id="3520350">&#39;0&#39;</span><span class="op" id="3520353">+</span><span class="ident" id="3520354">mn</span><span class="op" id="3520356">/</span><span class="num" id="3520357">10</span><span class="op" id="3520359">)</span><span class="op" id="3520360">,</span>&nbsp;<span class="builtintype" id="3520362">byte</span><span class="op" id="3520366">(</span><span class="string" id="3520367">&#39;0&#39;</span><span class="op" id="3520370">+</span><span class="ident" id="3520371">mn</span><span class="op" id="3520373">%</span><span class="num" id="3520374">10</span><span class="op" id="3520376">)</span><span class="op" id="3520377">,</span>&nbsp;<span class="string" id="3520379">&#39;:&#39;</span><span class="op" id="3520382">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3520386">byte</span><span class="op" id="3520390">(</span><span class="string" id="3520391">&#39;0&#39;</span><span class="op" id="3520394">+</span><span class="ident" id="3520395">ss</span><span class="op" id="3520397">/</span><span class="num" id="3520398">10</span><span class="op" id="3520400">)</span><span class="op" id="3520401">,</span>&nbsp;<span class="builtintype" id="3520403">byte</span><span class="op" id="3520407">(</span><span class="string" id="3520408">&#39;0&#39;</span><span class="op" id="3520411">+</span><span class="ident" id="3520412">ss</span><span class="op" id="3520414">%</span><span class="num" id="3520415">10</span><span class="op" id="3520417">)</span><span class="op" id="3520418">,</span>&nbsp;<span class="string" id="3520420">&#39;&nbsp;&#39;</span><span class="op" id="3520423">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3520427">&#39;G&#39;</span><span class="op" id="3520430">,</span>&nbsp;<span class="string" id="3520432">&#39;M&#39;</span><span class="op" id="3520435">,</span>&nbsp;<span class="string" id="3520437">&#39;T&#39;</span><span class="op" id="3520440">)</span><br>
<span class="lineno">565</span><span class="op" id="3520442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3520445">var</span>&nbsp;<span class="ident" id="3520449">errTooLarge</span>&nbsp;<span class="op" id="3520461">=</span>&nbsp;<span class="ident" id="3520463">errors</span><span class="op" id="3520469">.</span><span class="ident" id="3520470">New</span><span class="op" id="3520473">(</span><span class="string" id="3520474">&#34;http:&nbsp;request&nbsp;too&nbsp;large&#34;</span><span class="op" id="3520499">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3520502">//&nbsp;Read&nbsp;next&nbsp;request&nbsp;from&nbsp;connection.</span><br>
<span class="lineno">570</span><span class="keyword" id="3520540">func</span>&nbsp;<span class="op" id="3520545">(</span><span class="ident" id="3520546">c</span>&nbsp;<span class="op" id="3520548">*</span><span class="ident" id="3520549">conn</span><span class="op" id="3520553">)</span>&nbsp;<span class="ident" id="3520555">readRequest</span><span class="op" id="3520566">(</span><span class="op" id="3520567">)</span>&nbsp;<span class="op" id="3520569">(</span><span class="ident" id="3520570">w</span>&nbsp;<span class="op" id="3520572">*</span><span class="ident" id="3520573">response</span><span class="op" id="3520581">,</span>&nbsp;<span class="ident" id="3520583">err</span>&nbsp;<span class="builtintype" id="3520587">error</span><span class="op" id="3520592">)</span>&nbsp;<span class="op" id="3520594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3520597">if</span>&nbsp;<span class="ident" id="3520600">c</span><span class="op" id="3520601">.</span><span class="ident" id="3520602">hijacked</span><span class="op" id="3520610">(</span><span class="op" id="3520611">)</span>&nbsp;<span class="op" id="3520613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3520617">return</span>&nbsp;<span class="ident" id="3520624">nil</span><span class="op" id="3520627">,</span>&nbsp;<span class="ident" id="3520629">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3520642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3520646">if</span>&nbsp;<span class="ident" id="3520649">d</span>&nbsp;<span class="op" id="3520651">:=</span>&nbsp;<span class="ident" id="3520654">c</span><span class="op" id="3520655">.</span><span class="ident" id="3520656">server</span><span class="op" id="3520662">.</span><span class="ident" id="3520663">ReadTimeout</span><span class="op" id="3520674">;</span>&nbsp;<span class="ident" id="3520676">d</span>&nbsp;<span class="op" id="3520678">!=</span>&nbsp;<span class="num" id="3520681">0</span>&nbsp;<span class="op" id="3520683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3520687">c</span><span class="op" id="3520688">.</span><span class="ident" id="3520689">rwc</span><span class="op" id="3520692">.</span><span class="ident" id="3520693">SetReadDeadline</span><span class="op" id="3520708">(</span><span class="ident" id="3520709">time</span><span class="op" id="3520713">.</span><span class="ident" id="3520714">Now</span><span class="op" id="3520717">(</span><span class="op" id="3520718">)</span><span class="op" id="3520719">.</span><span class="ident" id="3520720">Add</span><span class="op" id="3520723">(</span><span class="ident" id="3520724">d</span><span class="op" id="3520725">)</span><span class="op" id="3520726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3520729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3520732">if</span>&nbsp;<span class="ident" id="3520735">d</span>&nbsp;<span class="op" id="3520737">:=</span>&nbsp;<span class="ident" id="3520740">c</span><span class="op" id="3520741">.</span><span class="ident" id="3520742">server</span><span class="op" id="3520748">.</span><span class="ident" id="3520749">WriteTimeout</span><span class="op" id="3520761">;</span>&nbsp;<span class="ident" id="3520763">d</span>&nbsp;<span class="op" id="3520765">!=</span>&nbsp;<span class="num" id="3520768">0</span>&nbsp;<span class="op" id="3520770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3520774">defer</span>&nbsp;<span class="keyword" id="3520780">func</span><span class="op" id="3520784">(</span><span class="op" id="3520785">)</span>&nbsp;<span class="op" id="3520787">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3520792">c</span><span class="op" id="3520793">.</span><span class="ident" id="3520794">rwc</span><span class="op" id="3520797">.</span><span class="ident" id="3520798">SetWriteDeadline</span><span class="op" id="3520814">(</span><span class="ident" id="3520815">time</span><span class="op" id="3520819">.</span><span class="ident" id="3520820">Now</span><span class="op" id="3520823">(</span><span class="op" id="3520824">)</span><span class="op" id="3520825">.</span><span class="ident" id="3520826">Add</span><span class="op" id="3520829">(</span><span class="ident" id="3520830">d</span><span class="op" id="3520831">)</span><span class="op" id="3520832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3520836">}</span><span class="op" id="3520837">(</span><span class="op" id="3520838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3520841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3520845">c</span><span class="op" id="3520846">.</span><span class="ident" id="3520847">lr</span><span class="op" id="3520849">.</span><span class="ident" id="3520850">N</span>&nbsp;<span class="op" id="3520852">=</span>&nbsp;<span class="ident" id="3520854">c</span><span class="op" id="3520855">.</span><span class="ident" id="3520856">server</span><span class="op" id="3520862">.</span><span class="ident" id="3520863">initialLimitedReaderSize</span><span class="op" id="3520887">(</span><span class="op" id="3520888">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3520891">var</span>&nbsp;<span class="ident" id="3520895">req</span>&nbsp;<span class="op" id="3520899">*</span><span class="ident" id="3520900">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3520909">if</span>&nbsp;<span class="ident" id="3520912">req</span><span class="op" id="3520915">,</span>&nbsp;<span class="ident" id="3520917">err</span>&nbsp;<span class="op" id="3520921">=</span>&nbsp;<span class="ident" id="3520923">ReadRequest</span><span class="op" id="3520934">(</span><span class="ident" id="3520935">c</span><span class="op" id="3520936">.</span><span class="ident" id="3520937">buf</span><span class="op" id="3520940">.</span><span class="ident" id="3520941">Reader</span><span class="op" id="3520947">)</span><span class="op" id="3520948">;</span>&nbsp;<span class="ident" id="3520950">err</span>&nbsp;<span class="op" id="3520954">!=</span>&nbsp;<span class="ident" id="3520957">nil</span>&nbsp;<span class="op" id="3520961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3520965">if</span>&nbsp;<span class="ident" id="3520968">c</span><span class="op" id="3520969">.</span><span class="ident" id="3520970">lr</span><span class="op" id="3520972">.</span><span class="ident" id="3520973">N</span>&nbsp;<span class="op" id="3520975">==</span>&nbsp;<span class="num" id="3520978">0</span>&nbsp;<span class="op" id="3520980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3520985">return</span>&nbsp;<span class="ident" id="3520992">nil</span><span class="op" id="3520995">,</span>&nbsp;<span class="ident" id="3520997">errTooLarge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3521011">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3521015">return</span>&nbsp;<span class="ident" id="3521022">nil</span><span class="op" id="3521025">,</span>&nbsp;<span class="ident" id="3521027">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3521032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521035">c</span><span class="op" id="3521036">.</span><span class="ident" id="3521037">lr</span><span class="op" id="3521039">.</span><span class="ident" id="3521040">N</span>&nbsp;<span class="op" id="3521042">=</span>&nbsp;<span class="ident" id="3521044">noLimit</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521054">req</span><span class="op" id="3521057">.</span><span class="ident" id="3521058">RemoteAddr</span>&nbsp;<span class="op" id="3521069">=</span>&nbsp;<span class="ident" id="3521071">c</span><span class="op" id="3521072">.</span><span class="ident" id="3521073">remoteAddr</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521085">req</span><span class="op" id="3521088">.</span><span class="ident" id="3521089">TLS</span>&nbsp;<span class="op" id="3521093">=</span>&nbsp;<span class="ident" id="3521095">c</span><span class="op" id="3521096">.</span><span class="ident" id="3521097">tlsState</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521108">w</span>&nbsp;<span class="op" id="3521110">=</span>&nbsp;<span class="op" id="3521112">&amp;</span><span class="ident" id="3521113">response</span><span class="op" id="3521121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521125">conn</span><span class="op" id="3521129">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521140">c</span><span class="op" id="3521141">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521145">req</span><span class="op" id="3521148">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521160">req</span><span class="op" id="3521163">,</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521167">handlerHeader</span><span class="op" id="3521180">:</span>&nbsp;<span class="builtinfunc" id="3521182">make</span><span class="op" id="3521186">(</span><span class="ident" id="3521187">Header</span><span class="op" id="3521193">)</span><span class="op" id="3521194">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521198">contentLength</span><span class="op" id="3521211">:</span>&nbsp;<span class="op" id="3521213">-</span><span class="num" id="3521214">1</span><span class="op" id="3521215">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3521218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521221">w</span><span class="op" id="3521222">.</span><span class="ident" id="3521223">cw</span><span class="op" id="3521225">.</span><span class="ident" id="3521226">res</span>&nbsp;<span class="op" id="3521230">=</span>&nbsp;<span class="ident" id="3521232">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521235">w</span><span class="op" id="3521236">.</span><span class="ident" id="3521237">w</span>&nbsp;<span class="op" id="3521239">=</span>&nbsp;<span class="ident" id="3521241">newBufioWriterSize</span><span class="op" id="3521259">(</span><span class="op" id="3521260">&amp;</span><span class="ident" id="3521261">w</span><span class="op" id="3521262">.</span><span class="ident" id="3521263">cw</span><span class="op" id="3521265">,</span>&nbsp;<span class="ident" id="3521267">bufferBeforeChunkingSize</span><span class="op" id="3521291">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3521294">return</span>&nbsp;<span class="ident" id="3521301">w</span><span class="op" id="3521302">,</span>&nbsp;<span class="ident" id="3521304">nil</span><br>
<span class="lineno"></span><span class="op" id="3521308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3521311">func</span>&nbsp;<span class="op" id="3521316">(</span><span class="ident" id="3521317">w</span>&nbsp;<span class="op" id="3521319">*</span><span class="ident" id="3521320">response</span><span class="op" id="3521328">)</span>&nbsp;<span class="ident" id="3521330">Header</span><span class="op" id="3521336">(</span><span class="op" id="3521337">)</span>&nbsp;<span class="ident" id="3521339">Header</span>&nbsp;<span class="op" id="3521346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3521349">if</span>&nbsp;<span class="ident" id="3521352">w</span><span class="op" id="3521353">.</span><span class="ident" id="3521354">cw</span><span class="op" id="3521356">.</span><span class="ident" id="3521357">header</span>&nbsp;<span class="op" id="3521364">==</span>&nbsp;<span class="ident" id="3521367">nil</span>&nbsp;<span class="op" id="3521371">&amp;&amp;</span>&nbsp;<span class="ident" id="3521374">w</span><span class="op" id="3521375">.</span><span class="ident" id="3521376">wroteHeader</span>&nbsp;<span class="op" id="3521388">&amp;&amp;</span>&nbsp;<span class="op" id="3521391">!</span><span class="ident" id="3521392">w</span><span class="op" id="3521393">.</span><span class="ident" id="3521394">cw</span><span class="op" id="3521396">.</span><span class="ident" id="3521397">wroteHeader</span>&nbsp;<span class="op" id="3521409">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3521413">//&nbsp;Accessing&nbsp;the&nbsp;header&nbsp;between&nbsp;logically&nbsp;writing&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3521468">//&nbsp;and&nbsp;physically&nbsp;writing&nbsp;it&nbsp;means&nbsp;we&nbsp;need&nbsp;to&nbsp;allocate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3521525">//&nbsp;a&nbsp;clone&nbsp;to&nbsp;snapshot&nbsp;the&nbsp;logically&nbsp;written&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521579">w</span><span class="op" id="3521580">.</span><span class="ident" id="3521581">cw</span><span class="op" id="3521583">.</span><span class="ident" id="3521584">header</span>&nbsp;<span class="op" id="3521591">=</span>&nbsp;<span class="ident" id="3521593">w</span><span class="op" id="3521594">.</span><span class="ident" id="3521595">handlerHeader</span><span class="op" id="3521608">.</span><span class="ident" id="3521609">clone</span><span class="op" id="3521614">(</span><span class="op" id="3521615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3521618">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521621">w</span><span class="op" id="3521622">.</span><span class="ident" id="3521623">calledHeader</span>&nbsp;<span class="op" id="3521636">=</span>&nbsp;<span class="builtintype" id="3521638">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3521644">return</span>&nbsp;<span class="ident" id="3521651">w</span><span class="op" id="3521652">.</span><span class="ident" id="3521653">handlerHeader</span><br>
<span class="lineno"></span><span class="op" id="3521667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3521670">//&nbsp;maxPostHandlerReadBytes&nbsp;is&nbsp;the&nbsp;max&nbsp;number&nbsp;of&nbsp;Request.Body&nbsp;bytes&nbsp;not</span><br>
<span class="lineno">620</span><span class="comment" id="3521741">//&nbsp;consumed&nbsp;by&nbsp;a&nbsp;handler&nbsp;that&nbsp;the&nbsp;server&nbsp;will&nbsp;read&nbsp;from&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="3521808">//&nbsp;in&nbsp;order&nbsp;to&nbsp;keep&nbsp;a&nbsp;connection&nbsp;alive.&nbsp;&nbsp;If&nbsp;there&nbsp;are&nbsp;more&nbsp;bytes&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="3521878">//&nbsp;this&nbsp;then&nbsp;the&nbsp;server&nbsp;to&nbsp;be&nbsp;paranoid&nbsp;instead&nbsp;sends&nbsp;a&nbsp;&#34;Connection:</span><br>
<span class="lineno"></span><span class="comment" id="3521946">//&nbsp;close&#34;&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3521966">//</span><br>
<span class="lineno">625</span><span class="comment" id="3521969">//&nbsp;This&nbsp;number&nbsp;is&nbsp;approximately&nbsp;what&nbsp;a&nbsp;typical&nbsp;machine&#39;s&nbsp;TCP&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3522037">//&nbsp;size&nbsp;is&nbsp;anyway.&nbsp;&nbsp;(if&nbsp;we&nbsp;have&nbsp;the&nbsp;bytes&nbsp;on&nbsp;the&nbsp;machine,&nbsp;we&nbsp;might&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3522107">//&nbsp;well&nbsp;read&nbsp;them)</span><br>
<span class="lineno"></span><span class="keyword" id="3522126">const</span>&nbsp;<span class="ident" id="3522132">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="3522156">=</span>&nbsp;<span class="num" id="3522158">256</span>&nbsp;<span class="op" id="3522162">&lt;&lt;</span>&nbsp;<span class="num" id="3522165">10</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="3522169">func</span>&nbsp;<span class="op" id="3522174">(</span><span class="ident" id="3522175">w</span>&nbsp;<span class="op" id="3522177">*</span><span class="ident" id="3522178">response</span><span class="op" id="3522186">)</span>&nbsp;<span class="ident" id="3522188">WriteHeader</span><span class="op" id="3522199">(</span><span class="ident" id="3522200">code</span>&nbsp;<span class="builtintype" id="3522205">int</span><span class="op" id="3522208">)</span>&nbsp;<span class="op" id="3522210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3522213">if</span>&nbsp;<span class="ident" id="3522216">w</span><span class="op" id="3522217">.</span><span class="ident" id="3522218">conn</span><span class="op" id="3522222">.</span><span class="ident" id="3522223">hijacked</span><span class="op" id="3522231">(</span><span class="op" id="3522232">)</span>&nbsp;<span class="op" id="3522234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3522238">w</span><span class="op" id="3522239">.</span><span class="ident" id="3522240">conn</span><span class="op" id="3522244">.</span><span class="ident" id="3522245">server</span><span class="op" id="3522251">.</span><span class="ident" id="3522252">logf</span><span class="op" id="3522256">(</span><span class="string" id="3522257">&#34;http:&nbsp;response.WriteHeader&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3522308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3522312">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3522320">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3522323">if</span>&nbsp;<span class="ident" id="3522326">w</span><span class="op" id="3522327">.</span><span class="ident" id="3522328">wroteHeader</span>&nbsp;<span class="op" id="3522340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3522344">w</span><span class="op" id="3522345">.</span><span class="ident" id="3522346">conn</span><span class="op" id="3522350">.</span><span class="ident" id="3522351">server</span><span class="op" id="3522357">.</span><span class="ident" id="3522358">logf</span><span class="op" id="3522362">(</span><span class="string" id="3522363">&#34;http:&nbsp;multiple&nbsp;response.WriteHeader&nbsp;calls&#34;</span><span class="op" id="3522406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3522410">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3522418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3522421">w</span><span class="op" id="3522422">.</span><span class="ident" id="3522423">wroteHeader</span>&nbsp;<span class="op" id="3522435">=</span>&nbsp;<span class="builtintype" id="3522437">true</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3522443">w</span><span class="op" id="3522444">.</span><span class="ident" id="3522445">status</span>&nbsp;<span class="op" id="3522452">=</span>&nbsp;<span class="ident" id="3522454">code</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3522461">if</span>&nbsp;<span class="ident" id="3522464">w</span><span class="op" id="3522465">.</span><span class="ident" id="3522466">calledHeader</span>&nbsp;<span class="op" id="3522479">&amp;&amp;</span>&nbsp;<span class="ident" id="3522482">w</span><span class="op" id="3522483">.</span><span class="ident" id="3522484">cw</span><span class="op" id="3522486">.</span><span class="ident" id="3522487">header</span>&nbsp;<span class="op" id="3522494">==</span>&nbsp;<span class="ident" id="3522497">nil</span>&nbsp;<span class="op" id="3522501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3522505">w</span><span class="op" id="3522506">.</span><span class="ident" id="3522507">cw</span><span class="op" id="3522509">.</span><span class="ident" id="3522510">header</span>&nbsp;<span class="op" id="3522517">=</span>&nbsp;<span class="ident" id="3522519">w</span><span class="op" id="3522520">.</span><span class="ident" id="3522521">handlerHeader</span><span class="op" id="3522534">.</span><span class="ident" id="3522535">clone</span><span class="op" id="3522540">(</span><span class="op" id="3522541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3522544">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3522548">if</span>&nbsp;<span class="ident" id="3522551">cl</span>&nbsp;<span class="op" id="3522554">:=</span>&nbsp;<span class="ident" id="3522557">w</span><span class="op" id="3522558">.</span><span class="ident" id="3522559">handlerHeader</span><span class="op" id="3522572">.</span><span class="ident" id="3522573">get</span><span class="op" id="3522576">(</span><span class="string" id="3522577">&#34;Content-Length&#34;</span><span class="op" id="3522593">)</span><span class="op" id="3522594">;</span>&nbsp;<span class="ident" id="3522596">cl</span>&nbsp;<span class="op" id="3522599">!=</span>&nbsp;<span class="string" id="3522602">&#34;&#34;</span>&nbsp;<span class="op" id="3522605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3522609">v</span><span class="op" id="3522610">,</span>&nbsp;<span class="ident" id="3522612">err</span>&nbsp;<span class="op" id="3522616">:=</span>&nbsp;<span class="ident" id="3522619">strconv</span><span class="op" id="3522626">.</span><span class="ident" id="3522627">ParseInt</span><span class="op" id="3522635">(</span><span class="ident" id="3522636">cl</span><span class="op" id="3522638">,</span>&nbsp;<span class="num" id="3522640">10</span><span class="op" id="3522642">,</span>&nbsp;<span class="num" id="3522644">64</span><span class="op" id="3522646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3522650">if</span>&nbsp;<span class="ident" id="3522653">err</span>&nbsp;<span class="op" id="3522657">==</span>&nbsp;<span class="ident" id="3522660">nil</span>&nbsp;<span class="op" id="3522664">&amp;&amp;</span>&nbsp;<span class="ident" id="3522667">v</span>&nbsp;<span class="op" id="3522669">&gt;=</span>&nbsp;<span class="num" id="3522672">0</span>&nbsp;<span class="op" id="3522674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3522679">w</span><span class="op" id="3522680">.</span><span class="ident" id="3522681">contentLength</span>&nbsp;<span class="op" id="3522695">=</span>&nbsp;<span class="ident" id="3522697">v</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3522701">}</span>&nbsp;<span class="keyword" id="3522703">else</span>&nbsp;<span class="op" id="3522708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3522713">w</span><span class="op" id="3522714">.</span><span class="ident" id="3522715">conn</span><span class="op" id="3522719">.</span><span class="ident" id="3522720">server</span><span class="op" id="3522726">.</span><span class="ident" id="3522727">logf</span><span class="op" id="3522731">(</span><span class="string" id="3522732">&#34;http:&nbsp;invalid&nbsp;Content-Length&nbsp;of&nbsp;%q&#34;</span><span class="op" id="3522768">,</span>&nbsp;<span class="ident" id="3522770">cl</span><span class="op" id="3522772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3522777">w</span><span class="op" id="3522778">.</span><span class="ident" id="3522779">handlerHeader</span><span class="op" id="3522792">.</span><span class="ident" id="3522793">Del</span><span class="op" id="3522796">(</span><span class="string" id="3522797">&#34;Content-Length&#34;</span><span class="op" id="3522813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3522817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3522820">}</span><br>
<span class="lineno">655</span><span class="op" id="3522822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3522825">//&nbsp;extraHeader&nbsp;is&nbsp;the&nbsp;set&nbsp;of&nbsp;headers&nbsp;sometimes&nbsp;added&nbsp;by&nbsp;chunkWriter.writeHeader.</span><br>
<span class="lineno"></span><span class="comment" id="3522906">//&nbsp;This&nbsp;type&nbsp;is&nbsp;used&nbsp;to&nbsp;avoid&nbsp;extra&nbsp;allocations&nbsp;from&nbsp;cloning&nbsp;and/or&nbsp;populating</span><br>
<span class="lineno"></span><span class="comment" id="3522985">//&nbsp;the&nbsp;response&nbsp;Header&nbsp;map&nbsp;and&nbsp;all&nbsp;its&nbsp;1-element&nbsp;slices.</span><br>
<span class="lineno">660</span><span class="keyword" id="3523042">type</span>&nbsp;<span class="ident" id="3523047">extraHeader</span>&nbsp;<span class="keyword" id="3523059">struct</span>&nbsp;<span class="op" id="3523066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3523069">contentType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3523086">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3523094">connection</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3523111">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3523119">transferEncoding</span>&nbsp;<span class="builtintype" id="3523136">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3523144">date</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3523161">[</span><span class="op" id="3523162">]</span><span class="builtintype" id="3523163">byte</span>&nbsp;<span class="comment" id="3523168">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3523191">contentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3523208">[</span><span class="op" id="3523209">]</span><span class="builtintype" id="3523210">byte</span>&nbsp;<span class="comment" id="3523215">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="3523237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3523240">//&nbsp;Sorted&nbsp;the&nbsp;same&nbsp;as&nbsp;extraHeader.Write&#39;s&nbsp;loop.</span><br>
<span class="lineno"></span><span class="keyword" id="3523288">var</span>&nbsp;<span class="ident" id="3523292">extraHeaderKeys</span>&nbsp;<span class="op" id="3523308">=</span>&nbsp;<span class="op" id="3523310">[</span><span class="op" id="3523311">]</span><span class="op" id="3523312">[</span><span class="op" id="3523313">]</span><span class="builtintype" id="3523314">byte</span><span class="op" id="3523318">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3523321">[</span><span class="op" id="3523322">]</span><span class="builtintype" id="3523323">byte</span><span class="op" id="3523327">(</span><span class="string" id="3523328">&#34;Content-Type&#34;</span><span class="op" id="3523342">)</span><span class="op" id="3523343">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3523346">[</span><span class="op" id="3523347">]</span><span class="builtintype" id="3523348">byte</span><span class="op" id="3523352">(</span><span class="string" id="3523353">&#34;Connection&#34;</span><span class="op" id="3523365">)</span><span class="op" id="3523366">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3523369">[</span><span class="op" id="3523370">]</span><span class="builtintype" id="3523371">byte</span><span class="op" id="3523375">(</span><span class="string" id="3523376">&#34;Transfer-Encoding&#34;</span><span class="op" id="3523395">)</span><span class="op" id="3523396">,</span><br>
<span class="lineno"></span><span class="op" id="3523398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span><span class="keyword" id="3523401">var</span>&nbsp;<span class="op" id="3523405">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3523408">headerContentLength</span>&nbsp;<span class="op" id="3523428">=</span>&nbsp;<span class="op" id="3523430">[</span><span class="op" id="3523431">]</span><span class="builtintype" id="3523432">byte</span><span class="op" id="3523436">(</span><span class="string" id="3523437">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3523455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3523458">headerDate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3523478">=</span>&nbsp;<span class="op" id="3523480">[</span><span class="op" id="3523481">]</span><span class="builtintype" id="3523482">byte</span><span class="op" id="3523486">(</span><span class="string" id="3523487">&#34;Date:&nbsp;&#34;</span><span class="op" id="3523495">)</span><br>
<span class="lineno"></span><span class="op" id="3523497">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="comment" id="3523500">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;headers&nbsp;described&nbsp;in&nbsp;h&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="3523549">//</span><br>
<span class="lineno"></span><span class="comment" id="3523552">//&nbsp;This&nbsp;method&nbsp;has&nbsp;a&nbsp;value&nbsp;receiver,&nbsp;despite&nbsp;the&nbsp;somewhat&nbsp;large&nbsp;size</span><br>
<span class="lineno"></span><span class="comment" id="3523621">//&nbsp;of&nbsp;h,&nbsp;because&nbsp;it&nbsp;prevents&nbsp;an&nbsp;allocation.&nbsp;The&nbsp;escape&nbsp;analysis&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3523691">//&nbsp;smart&nbsp;enough&nbsp;to&nbsp;realize&nbsp;this&nbsp;function&nbsp;doesn&#39;t&nbsp;mutate&nbsp;h.</span><br>
<span class="lineno">685</span><span class="keyword" id="3523750">func</span>&nbsp;<span class="op" id="3523755">(</span><span class="ident" id="3523756">h</span>&nbsp;<span class="ident" id="3523758">extraHeader</span><span class="op" id="3523769">)</span>&nbsp;<span class="ident" id="3523771">Write</span><span class="op" id="3523776">(</span><span class="ident" id="3523777">w</span>&nbsp;<span class="op" id="3523779">*</span><span class="ident" id="3523780">bufio</span><span class="op" id="3523785">.</span><span class="ident" id="3523786">Writer</span><span class="op" id="3523792">)</span>&nbsp;<span class="op" id="3523794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3523797">if</span>&nbsp;<span class="ident" id="3523800">h</span><span class="op" id="3523801">.</span><span class="ident" id="3523802">date</span>&nbsp;<span class="op" id="3523807">!=</span>&nbsp;<span class="ident" id="3523810">nil</span>&nbsp;<span class="op" id="3523814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3523818">w</span><span class="op" id="3523819">.</span><span class="ident" id="3523820">Write</span><span class="op" id="3523825">(</span><span class="ident" id="3523826">headerDate</span><span class="op" id="3523836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3523840">w</span><span class="op" id="3523841">.</span><span class="ident" id="3523842">Write</span><span class="op" id="3523847">(</span><span class="ident" id="3523848">h</span><span class="op" id="3523849">.</span><span class="ident" id="3523850">date</span><span class="op" id="3523854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3523858">w</span><span class="op" id="3523859">.</span><span class="ident" id="3523860">Write</span><span class="op" id="3523865">(</span><span class="ident" id="3523866">crlf</span><span class="op" id="3523870">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3523873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3523876">if</span>&nbsp;<span class="ident" id="3523879">h</span><span class="op" id="3523880">.</span><span class="ident" id="3523881">contentLength</span>&nbsp;<span class="op" id="3523895">!=</span>&nbsp;<span class="ident" id="3523898">nil</span>&nbsp;<span class="op" id="3523902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3523906">w</span><span class="op" id="3523907">.</span><span class="ident" id="3523908">Write</span><span class="op" id="3523913">(</span><span class="ident" id="3523914">headerContentLength</span><span class="op" id="3523933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3523937">w</span><span class="op" id="3523938">.</span><span class="ident" id="3523939">Write</span><span class="op" id="3523944">(</span><span class="ident" id="3523945">h</span><span class="op" id="3523946">.</span><span class="ident" id="3523947">contentLength</span><span class="op" id="3523960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3523964">w</span><span class="op" id="3523965">.</span><span class="ident" id="3523966">Write</span><span class="op" id="3523971">(</span><span class="ident" id="3523972">crlf</span><span class="op" id="3523976">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3523979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3523982">for</span>&nbsp;<span class="ident" id="3523986">i</span><span class="op" id="3523987">,</span>&nbsp;<span class="ident" id="3523989">v</span>&nbsp;<span class="op" id="3523991">:=</span>&nbsp;<span class="keyword" id="3523994">range</span>&nbsp;<span class="op" id="3524000">[</span><span class="op" id="3524001">]</span><span class="builtintype" id="3524002">string</span><span class="op" id="3524008">{</span><span class="ident" id="3524009">h</span><span class="op" id="3524010">.</span><span class="ident" id="3524011">contentType</span><span class="op" id="3524022">,</span>&nbsp;<span class="ident" id="3524024">h</span><span class="op" id="3524025">.</span><span class="ident" id="3524026">connection</span><span class="op" id="3524036">,</span>&nbsp;<span class="ident" id="3524038">h</span><span class="op" id="3524039">.</span><span class="ident" id="3524040">transferEncoding</span><span class="op" id="3524056">}</span>&nbsp;<span class="op" id="3524058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3524062">if</span>&nbsp;<span class="ident" id="3524065">v</span>&nbsp;<span class="op" id="3524067">!=</span>&nbsp;<span class="string" id="3524070">&#34;&#34;</span>&nbsp;<span class="op" id="3524073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3524078">w</span><span class="op" id="3524079">.</span><span class="ident" id="3524080">Write</span><span class="op" id="3524085">(</span><span class="ident" id="3524086">extraHeaderKeys</span><span class="op" id="3524101">[</span><span class="ident" id="3524102">i</span><span class="op" id="3524103">]</span><span class="op" id="3524104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3524109">w</span><span class="op" id="3524110">.</span><span class="ident" id="3524111">Write</span><span class="op" id="3524116">(</span><span class="ident" id="3524117">colonSpace</span><span class="op" id="3524127">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3524132">w</span><span class="op" id="3524133">.</span><span class="ident" id="3524134">WriteString</span><span class="op" id="3524145">(</span><span class="ident" id="3524146">v</span><span class="op" id="3524147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3524152">w</span><span class="op" id="3524153">.</span><span class="ident" id="3524154">Write</span><span class="op" id="3524159">(</span><span class="ident" id="3524160">crlf</span><span class="op" id="3524164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3524168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3524171">}</span><br>
<span class="lineno"></span><span class="op" id="3524173">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span><span class="comment" id="3524176">//&nbsp;writeHeader&nbsp;finalizes&nbsp;the&nbsp;header&nbsp;sent&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;writes&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3524245">//&nbsp;to&nbsp;cw.res.conn.buf.</span><br>
<span class="lineno"></span><span class="comment" id="3524268">//</span><br>
<span class="lineno"></span><span class="comment" id="3524271">//&nbsp;p&nbsp;is&nbsp;not&nbsp;written&nbsp;by&nbsp;writeHeader,&nbsp;but&nbsp;is&nbsp;the&nbsp;first&nbsp;chunk&nbsp;of&nbsp;the&nbsp;body</span><br>
<span class="lineno">710</span><span class="comment" id="3524342">//&nbsp;that&nbsp;will&nbsp;be&nbsp;written.&nbsp;&nbsp;It&nbsp;is&nbsp;sniffed&nbsp;for&nbsp;a&nbsp;Content-Type&nbsp;if&nbsp;none&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3524412">//&nbsp;set&nbsp;explicitly.&nbsp;&nbsp;It&#39;s&nbsp;also&nbsp;used&nbsp;to&nbsp;set&nbsp;the&nbsp;Content-Length,&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3524481">//&nbsp;total&nbsp;body&nbsp;size&nbsp;was&nbsp;small&nbsp;and&nbsp;the&nbsp;handler&nbsp;has&nbsp;already&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3524547">//&nbsp;running.</span><br>
<span class="lineno"></span><span class="keyword" id="3524559">func</span>&nbsp;<span class="op" id="3524564">(</span><span class="ident" id="3524565">cw</span>&nbsp;<span class="op" id="3524568">*</span><span class="ident" id="3524569">chunkWriter</span><span class="op" id="3524580">)</span>&nbsp;<span class="ident" id="3524582">writeHeader</span><span class="op" id="3524593">(</span><span class="ident" id="3524594">p</span>&nbsp;<span class="op" id="3524596">[</span><span class="op" id="3524597">]</span><span class="builtintype" id="3524598">byte</span><span class="op" id="3524602">)</span>&nbsp;<span class="op" id="3524604">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3524607">if</span>&nbsp;<span class="ident" id="3524610">cw</span><span class="op" id="3524612">.</span><span class="ident" id="3524613">wroteHeader</span>&nbsp;<span class="op" id="3524625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3524629">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3524637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3524640">cw</span><span class="op" id="3524642">.</span><span class="ident" id="3524643">wroteHeader</span>&nbsp;<span class="op" id="3524655">=</span>&nbsp;<span class="builtintype" id="3524657">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3524664">w</span>&nbsp;<span class="op" id="3524666">:=</span>&nbsp;<span class="ident" id="3524669">cw</span><span class="op" id="3524671">.</span><span class="ident" id="3524672">res</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3524677">keepAlivesEnabled</span>&nbsp;<span class="op" id="3524695">:=</span>&nbsp;<span class="ident" id="3524698">w</span><span class="op" id="3524699">.</span><span class="ident" id="3524700">conn</span><span class="op" id="3524704">.</span><span class="ident" id="3524705">server</span><span class="op" id="3524711">.</span><span class="ident" id="3524712">doKeepAlives</span><span class="op" id="3524724">(</span><span class="op" id="3524725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3524728">isHEAD</span>&nbsp;<span class="op" id="3524735">:=</span>&nbsp;<span class="ident" id="3524738">w</span><span class="op" id="3524739">.</span><span class="ident" id="3524740">req</span><span class="op" id="3524743">.</span><span class="ident" id="3524744">Method</span>&nbsp;<span class="op" id="3524751">==</span>&nbsp;<span class="string" id="3524754">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3524763">//&nbsp;header&nbsp;is&nbsp;written&nbsp;out&nbsp;to&nbsp;w.conn.buf&nbsp;below.&nbsp;Depending&nbsp;on&nbsp;the</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3524827">//&nbsp;state&nbsp;of&nbsp;the&nbsp;handler,&nbsp;we&nbsp;either&nbsp;own&nbsp;the&nbsp;map&nbsp;or&nbsp;not.&nbsp;If&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3524889">//&nbsp;don&#39;t&nbsp;own&nbsp;it,&nbsp;the&nbsp;exclude&nbsp;map&nbsp;is&nbsp;created&nbsp;lazily&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3524945">//&nbsp;WriteSubset&nbsp;to&nbsp;remove&nbsp;headers.&nbsp;The&nbsp;setHeader&nbsp;struct&nbsp;holds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3525007">//&nbsp;headers&nbsp;we&nbsp;need&nbsp;to&nbsp;add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3525035">header</span>&nbsp;<span class="op" id="3525042">:=</span>&nbsp;<span class="ident" id="3525045">cw</span><span class="op" id="3525047">.</span><span class="ident" id="3525048">header</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3525056">owned</span>&nbsp;<span class="op" id="3525062">:=</span>&nbsp;<span class="ident" id="3525065">header</span>&nbsp;<span class="op" id="3525072">!=</span>&nbsp;<span class="ident" id="3525075">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3525080">if</span>&nbsp;<span class="op" id="3525083">!</span><span class="ident" id="3525084">owned</span>&nbsp;<span class="op" id="3525090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3525094">header</span>&nbsp;<span class="op" id="3525101">=</span>&nbsp;<span class="ident" id="3525103">w</span><span class="op" id="3525104">.</span><span class="ident" id="3525105">handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3525120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3525123">var</span>&nbsp;<span class="ident" id="3525127">excludeHeader</span>&nbsp;<span class="keyword" id="3525141">map</span><span class="op" id="3525144">[</span><span class="builtintype" id="3525145">string</span><span class="op" id="3525151">]</span><span class="builtintype" id="3525152">bool</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3525158">delHeader</span>&nbsp;<span class="op" id="3525168">:=</span>&nbsp;<span class="keyword" id="3525171">func</span><span class="op" id="3525175">(</span><span class="ident" id="3525176">key</span>&nbsp;<span class="builtintype" id="3525180">string</span><span class="op" id="3525186">)</span>&nbsp;<span class="op" id="3525188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3525192">if</span>&nbsp;<span class="ident" id="3525195">owned</span>&nbsp;<span class="op" id="3525201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3525206">header</span><span class="op" id="3525212">.</span><span class="ident" id="3525213">Del</span><span class="op" id="3525216">(</span><span class="ident" id="3525217">key</span><span class="op" id="3525220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3525225">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3525234">}</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3525238">if</span>&nbsp;<span class="ident" id="3525241">_</span><span class="op" id="3525242">,</span>&nbsp;<span class="ident" id="3525244">ok</span>&nbsp;<span class="op" id="3525247">:=</span>&nbsp;<span class="ident" id="3525250">header</span><span class="op" id="3525256">[</span><span class="ident" id="3525257">key</span><span class="op" id="3525260">]</span><span class="op" id="3525261">;</span>&nbsp;<span class="op" id="3525263">!</span><span class="ident" id="3525264">ok</span>&nbsp;<span class="op" id="3525267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3525272">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3525281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3525285">if</span>&nbsp;<span class="ident" id="3525288">excludeHeader</span>&nbsp;<span class="op" id="3525302">==</span>&nbsp;<span class="ident" id="3525305">nil</span>&nbsp;<span class="op" id="3525309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3525314">excludeHeader</span>&nbsp;<span class="op" id="3525328">=</span>&nbsp;<span class="builtinfunc" id="3525330">make</span><span class="op" id="3525334">(</span><span class="keyword" id="3525335">map</span><span class="op" id="3525338">[</span><span class="builtintype" id="3525339">string</span><span class="op" id="3525345">]</span><span class="builtintype" id="3525346">bool</span><span class="op" id="3525350">)</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3525354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3525358">excludeHeader</span><span class="op" id="3525371">[</span><span class="ident" id="3525372">key</span><span class="op" id="3525375">]</span>&nbsp;<span class="op" id="3525377">=</span>&nbsp;<span class="builtintype" id="3525379">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3525385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3525388">var</span>&nbsp;<span class="ident" id="3525392">setHeader</span>&nbsp;<span class="ident" id="3525402">extraHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3525416">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;is&nbsp;done&nbsp;but&nbsp;never&nbsp;sent&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3525475">//&nbsp;response&nbsp;header&nbsp;and&nbsp;this&nbsp;is&nbsp;our&nbsp;first&nbsp;(and&nbsp;last)&nbsp;write,&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3525539">//&nbsp;it,&nbsp;even&nbsp;to&nbsp;zero.&nbsp;This&nbsp;helps&nbsp;HTTP/1.0&nbsp;clients&nbsp;keep&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3525600">//&nbsp;&#34;keep-alive&#34;&nbsp;connections&nbsp;alive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3525636">//&nbsp;Exceptions:&nbsp;304/204/1xx&nbsp;responses&nbsp;never&nbsp;get&nbsp;Content-Length,&nbsp;and&nbsp;if</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3525707">//&nbsp;it&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;difference&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3525771">//&nbsp;0&nbsp;actual&nbsp;bytes&nbsp;and&nbsp;0&nbsp;bytes&nbsp;because&nbsp;the&nbsp;handler&nbsp;noticed&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3525833">//&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request&nbsp;and&nbsp;chose&nbsp;not&nbsp;to&nbsp;write&nbsp;anything.&nbsp;&nbsp;So&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3525897">//&nbsp;HEAD,&nbsp;the&nbsp;handler&nbsp;should&nbsp;either&nbsp;write&nbsp;the&nbsp;Content-Length&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3525961">//&nbsp;write&nbsp;non-zero&nbsp;bytes.&nbsp;&nbsp;If&nbsp;it&#39;s&nbsp;actually&nbsp;0&nbsp;bytes&nbsp;and&nbsp;the</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3526021">//&nbsp;handler&nbsp;never&nbsp;looked&nbsp;at&nbsp;the&nbsp;Request.Method,&nbsp;we&nbsp;just&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3526083">//&nbsp;send&nbsp;a&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3526117">if</span>&nbsp;<span class="ident" id="3526120">w</span><span class="op" id="3526121">.</span><span class="ident" id="3526122">handlerDone</span>&nbsp;<span class="op" id="3526134">&amp;&amp;</span>&nbsp;<span class="ident" id="3526137">bodyAllowedForStatus</span><span class="op" id="3526157">(</span><span class="ident" id="3526158">w</span><span class="op" id="3526159">.</span><span class="ident" id="3526160">status</span><span class="op" id="3526166">)</span>&nbsp;<span class="op" id="3526168">&amp;&amp;</span>&nbsp;<span class="ident" id="3526171">header</span><span class="op" id="3526177">.</span><span class="ident" id="3526178">get</span><span class="op" id="3526181">(</span><span class="string" id="3526182">&#34;Content-Length&#34;</span><span class="op" id="3526198">)</span>&nbsp;<span class="op" id="3526200">==</span>&nbsp;<span class="string" id="3526203">&#34;&#34;</span>&nbsp;<span class="op" id="3526206">&amp;&amp;</span>&nbsp;<span class="op" id="3526209">(</span><span class="op" id="3526210">!</span><span class="ident" id="3526211">isHEAD</span>&nbsp;<span class="op" id="3526218">||</span>&nbsp;<span class="builtinfunc" id="3526221">len</span><span class="op" id="3526224">(</span><span class="ident" id="3526225">p</span><span class="op" id="3526226">)</span>&nbsp;<span class="op" id="3526228">&gt;</span>&nbsp;<span class="num" id="3526230">0</span><span class="op" id="3526231">)</span>&nbsp;<span class="op" id="3526233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3526237">w</span><span class="op" id="3526238">.</span><span class="ident" id="3526239">contentLength</span>&nbsp;<span class="op" id="3526253">=</span>&nbsp;<span class="ident" id="3526255">int64</span><span class="op" id="3526260">(</span><span class="builtinfunc" id="3526261">len</span><span class="op" id="3526264">(</span><span class="ident" id="3526265">p</span><span class="op" id="3526266">)</span><span class="op" id="3526267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3526271">setHeader</span><span class="op" id="3526280">.</span><span class="ident" id="3526281">contentLength</span>&nbsp;<span class="op" id="3526295">=</span>&nbsp;<span class="ident" id="3526297">strconv</span><span class="op" id="3526304">.</span><span class="ident" id="3526305">AppendInt</span><span class="op" id="3526314">(</span><span class="ident" id="3526315">cw</span><span class="op" id="3526317">.</span><span class="ident" id="3526318">res</span><span class="op" id="3526321">.</span><span class="ident" id="3526322">clenBuf</span><span class="op" id="3526329">[</span><span class="op" id="3526330">:</span><span class="num" id="3526331">0</span><span class="op" id="3526332">]</span><span class="op" id="3526333">,</span>&nbsp;<span class="ident" id="3526335">int64</span><span class="op" id="3526340">(</span><span class="builtinfunc" id="3526341">len</span><span class="op" id="3526344">(</span><span class="ident" id="3526345">p</span><span class="op" id="3526346">)</span><span class="op" id="3526347">)</span><span class="op" id="3526348">,</span>&nbsp;<span class="num" id="3526350">10</span><span class="op" id="3526352">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3526355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3526359">//&nbsp;If&nbsp;this&nbsp;was&nbsp;an&nbsp;HTTP/1.0&nbsp;request&nbsp;with&nbsp;keep-alive&nbsp;and&nbsp;we&nbsp;sent&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3526425">//&nbsp;Content-Length&nbsp;back,&nbsp;we&nbsp;can&nbsp;make&nbsp;this&nbsp;a&nbsp;keep-alive&nbsp;response&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3526493">if</span>&nbsp;<span class="ident" id="3526496">w</span><span class="op" id="3526497">.</span><span class="ident" id="3526498">req</span><span class="op" id="3526501">.</span><span class="ident" id="3526502">wantsHttp10KeepAlive</span><span class="op" id="3526522">(</span><span class="op" id="3526523">)</span>&nbsp;<span class="op" id="3526525">&amp;&amp;</span>&nbsp;<span class="ident" id="3526528">keepAlivesEnabled</span>&nbsp;<span class="op" id="3526546">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3526550">sentLength</span>&nbsp;<span class="op" id="3526561">:=</span>&nbsp;<span class="ident" id="3526564">header</span><span class="op" id="3526570">.</span><span class="ident" id="3526571">get</span><span class="op" id="3526574">(</span><span class="string" id="3526575">&#34;Content-Length&#34;</span><span class="op" id="3526591">)</span>&nbsp;<span class="op" id="3526593">!=</span>&nbsp;<span class="string" id="3526596">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3526601">if</span>&nbsp;<span class="ident" id="3526604">sentLength</span>&nbsp;<span class="op" id="3526615">&amp;&amp;</span>&nbsp;<span class="ident" id="3526618">header</span><span class="op" id="3526624">.</span><span class="ident" id="3526625">get</span><span class="op" id="3526628">(</span><span class="string" id="3526629">&#34;Connection&#34;</span><span class="op" id="3526641">)</span>&nbsp;<span class="op" id="3526643">==</span>&nbsp;<span class="string" id="3526646">&#34;keep-alive&#34;</span>&nbsp;<span class="op" id="3526659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3526664">w</span><span class="op" id="3526665">.</span><span class="ident" id="3526666">closeAfterReply</span>&nbsp;<span class="op" id="3526682">=</span>&nbsp;<span class="builtintype" id="3526684">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3526692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3526695">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3526699">//&nbsp;Check&nbsp;for&nbsp;a&nbsp;explicit&nbsp;(and&nbsp;valid)&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3526759">hasCL</span>&nbsp;<span class="op" id="3526765">:=</span>&nbsp;<span class="ident" id="3526768">w</span><span class="op" id="3526769">.</span><span class="ident" id="3526770">contentLength</span>&nbsp;<span class="op" id="3526784">!=</span>&nbsp;<span class="op" id="3526787">-</span><span class="num" id="3526788">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3526792">if</span>&nbsp;<span class="ident" id="3526795">w</span><span class="op" id="3526796">.</span><span class="ident" id="3526797">req</span><span class="op" id="3526800">.</span><span class="ident" id="3526801">wantsHttp10KeepAlive</span><span class="op" id="3526821">(</span><span class="op" id="3526822">)</span>&nbsp;<span class="op" id="3526824">&amp;&amp;</span>&nbsp;<span class="op" id="3526827">(</span><span class="ident" id="3526828">isHEAD</span>&nbsp;<span class="op" id="3526835">||</span>&nbsp;<span class="ident" id="3526838">hasCL</span><span class="op" id="3526843">)</span>&nbsp;<span class="op" id="3526845">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3526849">_</span><span class="op" id="3526850">,</span>&nbsp;<span class="ident" id="3526852">connectionHeaderSet</span>&nbsp;<span class="op" id="3526872">:=</span>&nbsp;<span class="ident" id="3526875">header</span><span class="op" id="3526881">[</span><span class="string" id="3526882">&#34;Connection&#34;</span><span class="op" id="3526894">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3526898">if</span>&nbsp;<span class="op" id="3526901">!</span><span class="ident" id="3526902">connectionHeaderSet</span>&nbsp;<span class="op" id="3526922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3526927">setHeader</span><span class="op" id="3526936">.</span><span class="ident" id="3526937">connection</span>&nbsp;<span class="op" id="3526948">=</span>&nbsp;<span class="string" id="3526950">&#34;keep-alive&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3526965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3526968">}</span>&nbsp;<span class="keyword" id="3526970">else</span>&nbsp;<span class="keyword" id="3526975">if</span>&nbsp;<span class="op" id="3526978">!</span><span class="ident" id="3526979">w</span><span class="op" id="3526980">.</span><span class="ident" id="3526981">req</span><span class="op" id="3526984">.</span><span class="ident" id="3526985">ProtoAtLeast</span><span class="op" id="3526997">(</span><span class="num" id="3526998">1</span><span class="op" id="3526999">,</span>&nbsp;<span class="num" id="3527001">1</span><span class="op" id="3527002">)</span>&nbsp;<span class="op" id="3527004">||</span>&nbsp;<span class="ident" id="3527007">w</span><span class="op" id="3527008">.</span><span class="ident" id="3527009">req</span><span class="op" id="3527012">.</span><span class="ident" id="3527013">wantsClose</span><span class="op" id="3527023">(</span><span class="op" id="3527024">)</span>&nbsp;<span class="op" id="3527026">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527030">w</span><span class="op" id="3527031">.</span><span class="ident" id="3527032">closeAfterReply</span>&nbsp;<span class="op" id="3527048">=</span>&nbsp;<span class="builtintype" id="3527050">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3527056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3527060">if</span>&nbsp;<span class="ident" id="3527063">header</span><span class="op" id="3527069">.</span><span class="ident" id="3527070">get</span><span class="op" id="3527073">(</span><span class="string" id="3527074">&#34;Connection&#34;</span><span class="op" id="3527086">)</span>&nbsp;<span class="op" id="3527088">==</span>&nbsp;<span class="string" id="3527091">&#34;close&#34;</span>&nbsp;<span class="op" id="3527099">||</span>&nbsp;<span class="op" id="3527102">!</span><span class="ident" id="3527103">keepAlivesEnabled</span>&nbsp;<span class="op" id="3527121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527125">w</span><span class="op" id="3527126">.</span><span class="ident" id="3527127">closeAfterReply</span>&nbsp;<span class="op" id="3527143">=</span>&nbsp;<span class="builtintype" id="3527145">true</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3527151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3527155">//&nbsp;Per&nbsp;RFC&nbsp;2616,&nbsp;we&nbsp;should&nbsp;consume&nbsp;the&nbsp;request&nbsp;body&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3527215">//&nbsp;replying,&nbsp;if&nbsp;the&nbsp;handler&nbsp;hasn&#39;t&nbsp;already&nbsp;done&nbsp;so.&nbsp;&nbsp;But&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3527276">//&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;do&nbsp;an&nbsp;unbounded&nbsp;amount&nbsp;of&nbsp;reading&nbsp;here&nbsp;for</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3527337">//&nbsp;DoS&nbsp;reasons,&nbsp;so&nbsp;we&nbsp;only&nbsp;try&nbsp;up&nbsp;to&nbsp;a&nbsp;threshold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3527388">if</span>&nbsp;<span class="ident" id="3527391">w</span><span class="op" id="3527392">.</span><span class="ident" id="3527393">req</span><span class="op" id="3527396">.</span><span class="ident" id="3527397">ContentLength</span>&nbsp;<span class="op" id="3527411">!=</span>&nbsp;<span class="num" id="3527414">0</span>&nbsp;<span class="op" id="3527416">&amp;&amp;</span>&nbsp;<span class="op" id="3527419">!</span><span class="ident" id="3527420">w</span><span class="op" id="3527421">.</span><span class="ident" id="3527422">closeAfterReply</span>&nbsp;<span class="op" id="3527438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527442">ecr</span><span class="op" id="3527445">,</span>&nbsp;<span class="ident" id="3527447">isExpecter</span>&nbsp;<span class="op" id="3527458">:=</span>&nbsp;<span class="ident" id="3527461">w</span><span class="op" id="3527462">.</span><span class="ident" id="3527463">req</span><span class="op" id="3527466">.</span><span class="ident" id="3527467">Body</span><span class="op" id="3527471">.</span><span class="op" id="3527472">(</span><span class="op" id="3527473">*</span><span class="ident" id="3527474">expectContinueReader</span><span class="op" id="3527494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3527498">if</span>&nbsp;<span class="op" id="3527501">!</span><span class="ident" id="3527502">isExpecter</span>&nbsp;<span class="op" id="3527513">||</span>&nbsp;<span class="ident" id="3527516">ecr</span><span class="op" id="3527519">.</span><span class="ident" id="3527520">resp</span><span class="op" id="3527524">.</span><span class="ident" id="3527525">wroteContinue</span>&nbsp;<span class="op" id="3527539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527544">n</span><span class="op" id="3527545">,</span>&nbsp;<span class="ident" id="3527547">_</span>&nbsp;<span class="op" id="3527549">:=</span>&nbsp;<span class="ident" id="3527552">io</span><span class="op" id="3527554">.</span><span class="ident" id="3527555">CopyN</span><span class="op" id="3527560">(</span><span class="ident" id="3527561">ioutil</span><span class="op" id="3527567">.</span><span class="ident" id="3527568">Discard</span><span class="op" id="3527575">,</span>&nbsp;<span class="ident" id="3527577">w</span><span class="op" id="3527578">.</span><span class="ident" id="3527579">req</span><span class="op" id="3527582">.</span><span class="ident" id="3527583">Body</span><span class="op" id="3527587">,</span>&nbsp;<span class="ident" id="3527589">maxPostHandlerReadBytes</span><span class="op" id="3527612">+</span><span class="num" id="3527613">1</span><span class="op" id="3527614">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3527619">if</span>&nbsp;<span class="ident" id="3527622">n</span>&nbsp;<span class="op" id="3527624">&gt;=</span>&nbsp;<span class="ident" id="3527627">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="3527651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527657">w</span><span class="op" id="3527658">.</span><span class="ident" id="3527659">requestTooLarge</span><span class="op" id="3527674">(</span><span class="op" id="3527675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527681">delHeader</span><span class="op" id="3527690">(</span><span class="string" id="3527691">&#34;Connection&#34;</span><span class="op" id="3527703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527709">setHeader</span><span class="op" id="3527718">.</span><span class="ident" id="3527719">connection</span>&nbsp;<span class="op" id="3527730">=</span>&nbsp;<span class="string" id="3527732">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3527743">}</span>&nbsp;<span class="keyword" id="3527745">else</span>&nbsp;<span class="op" id="3527750">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527756">w</span><span class="op" id="3527757">.</span><span class="ident" id="3527758">req</span><span class="op" id="3527761">.</span><span class="ident" id="3527762">Body</span><span class="op" id="3527766">.</span><span class="ident" id="3527767">Close</span><span class="op" id="3527772">(</span><span class="op" id="3527773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3527778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3527782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3527785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527789">code</span>&nbsp;<span class="op" id="3527794">:=</span>&nbsp;<span class="ident" id="3527797">w</span><span class="op" id="3527798">.</span><span class="ident" id="3527799">status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3527807">if</span>&nbsp;<span class="ident" id="3527810">bodyAllowedForStatus</span><span class="op" id="3527830">(</span><span class="ident" id="3527831">code</span><span class="op" id="3527835">)</span>&nbsp;<span class="op" id="3527837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3527841">//&nbsp;If&nbsp;no&nbsp;content&nbsp;type,&nbsp;apply&nbsp;sniffing&nbsp;algorithm&nbsp;to&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527900">_</span><span class="op" id="3527901">,</span>&nbsp;<span class="ident" id="3527903">haveType</span>&nbsp;<span class="op" id="3527912">:=</span>&nbsp;<span class="ident" id="3527915">header</span><span class="op" id="3527921">[</span><span class="string" id="3527922">&#34;Content-Type&#34;</span><span class="op" id="3527936">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3527940">if</span>&nbsp;<span class="op" id="3527943">!</span><span class="ident" id="3527944">haveType</span>&nbsp;<span class="op" id="3527953">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3527958">setHeader</span><span class="op" id="3527967">.</span><span class="ident" id="3527968">contentType</span>&nbsp;<span class="op" id="3527980">=</span>&nbsp;<span class="ident" id="3527982">DetectContentType</span><span class="op" id="3527999">(</span><span class="ident" id="3528000">p</span><span class="op" id="3528001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3528005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3528008">}</span>&nbsp;<span class="keyword" id="3528010">else</span>&nbsp;<span class="op" id="3528015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3528019">for</span>&nbsp;<span class="ident" id="3528023">_</span><span class="op" id="3528024">,</span>&nbsp;<span class="ident" id="3528026">k</span>&nbsp;<span class="op" id="3528028">:=</span>&nbsp;<span class="keyword" id="3528031">range</span>&nbsp;<span class="ident" id="3528037">suppressedHeaders</span><span class="op" id="3528054">(</span><span class="ident" id="3528055">code</span><span class="op" id="3528059">)</span>&nbsp;<span class="op" id="3528061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3528066">delHeader</span><span class="op" id="3528075">(</span><span class="ident" id="3528076">k</span><span class="op" id="3528077">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3528081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3528084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3528088">if</span>&nbsp;<span class="ident" id="3528091">_</span><span class="op" id="3528092">,</span>&nbsp;<span class="ident" id="3528094">ok</span>&nbsp;<span class="op" id="3528097">:=</span>&nbsp;<span class="ident" id="3528100">header</span><span class="op" id="3528106">[</span><span class="string" id="3528107">&#34;Date&#34;</span><span class="op" id="3528113">]</span><span class="op" id="3528114">;</span>&nbsp;<span class="op" id="3528116">!</span><span class="ident" id="3528117">ok</span>&nbsp;<span class="op" id="3528120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3528124">setHeader</span><span class="op" id="3528133">.</span><span class="ident" id="3528134">date</span>&nbsp;<span class="op" id="3528139">=</span>&nbsp;<span class="ident" id="3528141">appendTime</span><span class="op" id="3528151">(</span><span class="ident" id="3528152">cw</span><span class="op" id="3528154">.</span><span class="ident" id="3528155">res</span><span class="op" id="3528158">.</span><span class="ident" id="3528159">dateBuf</span><span class="op" id="3528166">[</span><span class="op" id="3528167">:</span><span class="num" id="3528168">0</span><span class="op" id="3528169">]</span><span class="op" id="3528170">,</span>&nbsp;<span class="ident" id="3528172">time</span><span class="op" id="3528176">.</span><span class="ident" id="3528177">Now</span><span class="op" id="3528180">(</span><span class="op" id="3528181">)</span><span class="op" id="3528182">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3528185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3528189">te</span>&nbsp;<span class="op" id="3528192">:=</span>&nbsp;<span class="ident" id="3528195">header</span><span class="op" id="3528201">.</span><span class="ident" id="3528202">get</span><span class="op" id="3528205">(</span><span class="string" id="3528206">&#34;Transfer-Encoding&#34;</span><span class="op" id="3528225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3528228">hasTE</span>&nbsp;<span class="op" id="3528234">:=</span>&nbsp;<span class="ident" id="3528237">te</span>&nbsp;<span class="op" id="3528240">!=</span>&nbsp;<span class="string" id="3528243">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3528247">if</span>&nbsp;<span class="ident" id="3528250">hasCL</span>&nbsp;<span class="op" id="3528256">&amp;&amp;</span>&nbsp;<span class="ident" id="3528259">hasTE</span>&nbsp;<span class="op" id="3528265">&amp;&amp;</span>&nbsp;<span class="ident" id="3528268">te</span>&nbsp;<span class="op" id="3528271">!=</span>&nbsp;<span class="string" id="3528274">&#34;identity&#34;</span>&nbsp;<span class="op" id="3528285">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3528289">//&nbsp;TODO:&nbsp;return&nbsp;an&nbsp;error&nbsp;if&nbsp;WriteHeader&nbsp;gets&nbsp;a&nbsp;return&nbsp;parameter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3528355">//&nbsp;For&nbsp;now&nbsp;just&nbsp;ignore&nbsp;the&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3528400">w</span><span class="op" id="3528401">.</span><span class="ident" id="3528402">conn</span><span class="op" id="3528406">.</span><span class="ident" id="3528407">server</span><span class="op" id="3528413">.</span><span class="ident" id="3528414">logf</span><span class="op" id="3528418">(</span><span class="string" id="3528419">&#34;http:&nbsp;WriteHeader&nbsp;called&nbsp;with&nbsp;both&nbsp;Transfer-Encoding&nbsp;of&nbsp;%q&nbsp;and&nbsp;a&nbsp;Content-Length&nbsp;of&nbsp;%d&#34;</span><span class="op" id="3528506">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3528511">te</span><span class="op" id="3528513">,</span>&nbsp;<span class="ident" id="3528515">w</span><span class="op" id="3528516">.</span><span class="ident" id="3528517">contentLength</span><span class="op" id="3528530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3528534">delHeader</span><span class="op" id="3528543">(</span><span class="string" id="3528544">&#34;Content-Length&#34;</span><span class="op" id="3528560">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3528564">hasCL</span>&nbsp;<span class="op" id="3528570">=</span>&nbsp;<span class="builtintype" id="3528572">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3528579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3528583">if</span>&nbsp;<span class="ident" id="3528586">w</span><span class="op" id="3528587">.</span><span class="ident" id="3528588">req</span><span class="op" id="3528591">.</span><span class="ident" id="3528592">Method</span>&nbsp;<span class="op" id="3528599">==</span>&nbsp;<span class="string" id="3528602">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3528609">||</span>&nbsp;<span class="op" id="3528612">!</span><span class="ident" id="3528613">bodyAllowedForStatus</span><span class="op" id="3528633">(</span><span class="ident" id="3528634">code</span><span class="op" id="3528638">)</span>&nbsp;<span class="op" id="3528640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3528644">//&nbsp;do&nbsp;nothing</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3528659">}</span>&nbsp;<span class="keyword" id="3528661">else</span>&nbsp;<span class="keyword" id="3528666">if</span>&nbsp;<span class="ident" id="3528669">code</span>&nbsp;<span class="op" id="3528674">==</span>&nbsp;<span class="ident" id="3528677">StatusNoContent</span>&nbsp;<span class="op" id="3528693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3528697">delHeader</span><span class="op" id="3528706">(</span><span class="string" id="3528707">&#34;Transfer-Encoding&#34;</span><span class="op" id="3528726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3528729">}</span>&nbsp;<span class="keyword" id="3528731">else</span>&nbsp;<span class="keyword" id="3528736">if</span>&nbsp;<span class="ident" id="3528739">hasCL</span>&nbsp;<span class="op" id="3528745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3528749">delHeader</span><span class="op" id="3528758">(</span><span class="string" id="3528759">&#34;Transfer-Encoding&#34;</span><span class="op" id="3528778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3528781">}</span>&nbsp;<span class="keyword" id="3528783">else</span>&nbsp;<span class="keyword" id="3528788">if</span>&nbsp;<span class="ident" id="3528791">w</span><span class="op" id="3528792">.</span><span class="ident" id="3528793">req</span><span class="op" id="3528796">.</span><span class="ident" id="3528797">ProtoAtLeast</span><span class="op" id="3528809">(</span><span class="num" id="3528810">1</span><span class="op" id="3528811">,</span>&nbsp;<span class="num" id="3528813">1</span><span class="op" id="3528814">)</span>&nbsp;<span class="op" id="3528816">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3528820">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;Transfer-Encoding&nbsp;has&nbsp;been&nbsp;set&nbsp;to&nbsp;identity,&nbsp;&nbsp;and&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3528898">//&nbsp;content-length&nbsp;has&nbsp;been&nbsp;provided.&nbsp;The&nbsp;connection&nbsp;must&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3528977">//&nbsp;reply&nbsp;is&nbsp;written,&nbsp;and&nbsp;no&nbsp;chunking&nbsp;is&nbsp;to&nbsp;be&nbsp;done.&nbsp;This&nbsp;is&nbsp;the&nbsp;setup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3529049">//&nbsp;recommended&nbsp;in&nbsp;the&nbsp;Server-Sent&nbsp;Events&nbsp;candidate&nbsp;recommendation&nbsp;11,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3529121">//&nbsp;section&nbsp;8.</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3529137">if</span>&nbsp;<span class="ident" id="3529140">hasTE</span>&nbsp;<span class="op" id="3529146">&amp;&amp;</span>&nbsp;<span class="ident" id="3529149">te</span>&nbsp;<span class="op" id="3529152">==</span>&nbsp;<span class="string" id="3529155">&#34;identity&#34;</span>&nbsp;<span class="op" id="3529166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3529171">cw</span><span class="op" id="3529173">.</span><span class="ident" id="3529174">chunking</span>&nbsp;<span class="op" id="3529183">=</span>&nbsp;<span class="builtintype" id="3529185">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3529194">w</span><span class="op" id="3529195">.</span><span class="ident" id="3529196">closeAfterReply</span>&nbsp;<span class="op" id="3529212">=</span>&nbsp;<span class="builtintype" id="3529214">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3529221">}</span>&nbsp;<span class="keyword" id="3529223">else</span>&nbsp;<span class="op" id="3529228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3529233">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;use&nbsp;chunked&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3529290">//&nbsp;to&nbsp;avoid&nbsp;closing&nbsp;the&nbsp;connection&nbsp;at&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3529336">cw</span><span class="op" id="3529338">.</span><span class="ident" id="3529339">chunking</span>&nbsp;<span class="op" id="3529348">=</span>&nbsp;<span class="builtintype" id="3529350">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3529358">setHeader</span><span class="op" id="3529367">.</span><span class="ident" id="3529368">transferEncoding</span>&nbsp;<span class="op" id="3529385">=</span>&nbsp;<span class="string" id="3529387">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3529399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3529402">}</span>&nbsp;<span class="keyword" id="3529404">else</span>&nbsp;<span class="op" id="3529409">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3529413">//&nbsp;HTTP&nbsp;version&nbsp;&lt;&nbsp;1.1:&nbsp;cannot&nbsp;do&nbsp;chunked&nbsp;transfer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3529465">//&nbsp;encoding&nbsp;and&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;Content-Length&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3529519">//&nbsp;signal&nbsp;EOF&nbsp;by&nbsp;closing&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3529558">w</span><span class="op" id="3529559">.</span><span class="ident" id="3529560">closeAfterReply</span>&nbsp;<span class="op" id="3529576">=</span>&nbsp;<span class="builtintype" id="3529578">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3529585">delHeader</span><span class="op" id="3529594">(</span><span class="string" id="3529595">&#34;Transfer-Encoding&#34;</span><span class="op" id="3529614">)</span>&nbsp;<span class="comment" id="3529616">//&nbsp;in&nbsp;case&nbsp;already&nbsp;set</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3529640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3529644">//&nbsp;Cannot&nbsp;use&nbsp;Content-Length&nbsp;with&nbsp;non-identity&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3529711">if</span>&nbsp;<span class="ident" id="3529714">cw</span><span class="op" id="3529716">.</span><span class="ident" id="3529717">chunking</span>&nbsp;<span class="op" id="3529726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3529730">delHeader</span><span class="op" id="3529739">(</span><span class="string" id="3529740">&#34;Content-Length&#34;</span><span class="op" id="3529756">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3529759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3529762">if</span>&nbsp;<span class="op" id="3529765">!</span><span class="ident" id="3529766">w</span><span class="op" id="3529767">.</span><span class="ident" id="3529768">req</span><span class="op" id="3529771">.</span><span class="ident" id="3529772">ProtoAtLeast</span><span class="op" id="3529784">(</span><span class="num" id="3529785">1</span><span class="op" id="3529786">,</span>&nbsp;<span class="num" id="3529788">0</span><span class="op" id="3529789">)</span>&nbsp;<span class="op" id="3529791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3529795">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3529803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3529807">if</span>&nbsp;<span class="ident" id="3529810">w</span><span class="op" id="3529811">.</span><span class="ident" id="3529812">closeAfterReply</span>&nbsp;<span class="op" id="3529828">&amp;&amp;</span>&nbsp;<span class="op" id="3529831">(</span><span class="op" id="3529832">!</span><span class="ident" id="3529833">keepAlivesEnabled</span>&nbsp;<span class="op" id="3529851">||</span>&nbsp;<span class="op" id="3529854">!</span><span class="ident" id="3529855">hasToken</span><span class="op" id="3529863">(</span><span class="ident" id="3529864">cw</span><span class="op" id="3529866">.</span><span class="ident" id="3529867">header</span><span class="op" id="3529873">.</span><span class="ident" id="3529874">get</span><span class="op" id="3529877">(</span><span class="string" id="3529878">&#34;Connection&#34;</span><span class="op" id="3529890">)</span><span class="op" id="3529891">,</span>&nbsp;<span class="string" id="3529893">&#34;close&#34;</span><span class="op" id="3529900">)</span><span class="op" id="3529901">)</span>&nbsp;<span class="op" id="3529903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3529907">delHeader</span><span class="op" id="3529916">(</span><span class="string" id="3529917">&#34;Connection&#34;</span><span class="op" id="3529929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3529933">if</span>&nbsp;<span class="ident" id="3529936">w</span><span class="op" id="3529937">.</span><span class="ident" id="3529938">req</span><span class="op" id="3529941">.</span><span class="ident" id="3529942">ProtoAtLeast</span><span class="op" id="3529954">(</span><span class="num" id="3529955">1</span><span class="op" id="3529956">,</span>&nbsp;<span class="num" id="3529958">1</span><span class="op" id="3529959">)</span>&nbsp;<span class="op" id="3529961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3529966">setHeader</span><span class="op" id="3529975">.</span><span class="ident" id="3529976">connection</span>&nbsp;<span class="op" id="3529987">=</span>&nbsp;<span class="string" id="3529989">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3529999">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3530002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530006">w</span><span class="op" id="3530007">.</span><span class="ident" id="3530008">conn</span><span class="op" id="3530012">.</span><span class="ident" id="3530013">buf</span><span class="op" id="3530016">.</span><span class="ident" id="3530017">WriteString</span><span class="op" id="3530028">(</span><span class="ident" id="3530029">statusLine</span><span class="op" id="3530039">(</span><span class="ident" id="3530040">w</span><span class="op" id="3530041">.</span><span class="ident" id="3530042">req</span><span class="op" id="3530045">,</span>&nbsp;<span class="ident" id="3530047">code</span><span class="op" id="3530051">)</span><span class="op" id="3530052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530055">cw</span><span class="op" id="3530057">.</span><span class="ident" id="3530058">header</span><span class="op" id="3530064">.</span><span class="ident" id="3530065">WriteSubset</span><span class="op" id="3530076">(</span><span class="ident" id="3530077">w</span><span class="op" id="3530078">.</span><span class="ident" id="3530079">conn</span><span class="op" id="3530083">.</span><span class="ident" id="3530084">buf</span><span class="op" id="3530087">,</span>&nbsp;<span class="ident" id="3530089">excludeHeader</span><span class="op" id="3530102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530105">setHeader</span><span class="op" id="3530114">.</span><span class="ident" id="3530115">Write</span><span class="op" id="3530120">(</span><span class="ident" id="3530121">w</span><span class="op" id="3530122">.</span><span class="ident" id="3530123">conn</span><span class="op" id="3530127">.</span><span class="ident" id="3530128">buf</span><span class="op" id="3530131">.</span><span class="ident" id="3530132">Writer</span><span class="op" id="3530138">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530141">w</span><span class="op" id="3530142">.</span><span class="ident" id="3530143">conn</span><span class="op" id="3530147">.</span><span class="ident" id="3530148">buf</span><span class="op" id="3530151">.</span><span class="ident" id="3530152">Write</span><span class="op" id="3530157">(</span><span class="ident" id="3530158">crlf</span><span class="op" id="3530162">)</span><br>
<span class="lineno"></span><span class="op" id="3530164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3530167">//&nbsp;statusLines&nbsp;is&nbsp;a&nbsp;cache&nbsp;of&nbsp;Status-Line&nbsp;strings,&nbsp;keyed&nbsp;by&nbsp;code&nbsp;(for</span><br>
<span class="lineno"></span><span class="comment" id="3530236">//&nbsp;HTTP/1.1)&nbsp;or&nbsp;negative&nbsp;code&nbsp;(for&nbsp;HTTP/1.0).&nbsp;This&nbsp;is&nbsp;faster&nbsp;than&nbsp;a</span><br>
<span class="lineno">890</span><span class="comment" id="3530304">//&nbsp;map&nbsp;keyed&nbsp;by&nbsp;struct&nbsp;of&nbsp;two&nbsp;fields.&nbsp;This&nbsp;map&#39;s&nbsp;max&nbsp;size&nbsp;is&nbsp;bounded</span><br>
<span class="lineno"></span><span class="comment" id="3530373">//&nbsp;by&nbsp;2*len(statusText),&nbsp;two&nbsp;protocol&nbsp;types&nbsp;for&nbsp;each&nbsp;known&nbsp;official</span><br>
<span class="lineno"></span><span class="comment" id="3530441">//&nbsp;status&nbsp;code&nbsp;in&nbsp;the&nbsp;statusText&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="3530479">var</span>&nbsp;<span class="op" id="3530483">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530486">statusMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530498">sync</span><span class="op" id="3530502">.</span><span class="ident" id="3530503">RWMutex</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530512">statusLines</span>&nbsp;<span class="op" id="3530524">=</span>&nbsp;<span class="builtinfunc" id="3530526">make</span><span class="op" id="3530530">(</span><span class="keyword" id="3530531">map</span><span class="op" id="3530534">[</span><span class="builtintype" id="3530535">int</span><span class="op" id="3530538">]</span><span class="builtintype" id="3530539">string</span><span class="op" id="3530545">)</span><br>
<span class="lineno"></span><span class="op" id="3530547">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3530550">//&nbsp;statusLine&nbsp;returns&nbsp;a&nbsp;response&nbsp;Status-Line&nbsp;(RFC&nbsp;2616&nbsp;Section&nbsp;6.1)</span><br>
<span class="lineno"></span><span class="comment" id="3530618">//&nbsp;for&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response&nbsp;status&nbsp;code.</span><br>
<span class="lineno">900</span><span class="keyword" id="3530669">func</span>&nbsp;<span class="ident" id="3530674">statusLine</span><span class="op" id="3530684">(</span><span class="ident" id="3530685">req</span>&nbsp;<span class="op" id="3530689">*</span><span class="ident" id="3530690">Request</span><span class="op" id="3530697">,</span>&nbsp;<span class="ident" id="3530699">code</span>&nbsp;<span class="builtintype" id="3530704">int</span><span class="op" id="3530707">)</span>&nbsp;<span class="builtintype" id="3530709">string</span>&nbsp;<span class="op" id="3530716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3530719">//&nbsp;Fast&nbsp;path:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530734">key</span>&nbsp;<span class="op" id="3530738">:=</span>&nbsp;<span class="ident" id="3530741">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530747">proto11</span>&nbsp;<span class="op" id="3530755">:=</span>&nbsp;<span class="ident" id="3530758">req</span><span class="op" id="3530761">.</span><span class="ident" id="3530762">ProtoAtLeast</span><span class="op" id="3530774">(</span><span class="num" id="3530775">1</span><span class="op" id="3530776">,</span>&nbsp;<span class="num" id="3530778">1</span><span class="op" id="3530779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3530782">if</span>&nbsp;<span class="op" id="3530785">!</span><span class="ident" id="3530786">proto11</span>&nbsp;<span class="op" id="3530794">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530798">key</span>&nbsp;<span class="op" id="3530802">=</span>&nbsp;<span class="op" id="3530804">-</span><span class="ident" id="3530805">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3530810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530813">statusMu</span><span class="op" id="3530821">.</span><span class="ident" id="3530822">RLock</span><span class="op" id="3530827">(</span><span class="op" id="3530828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530831">line</span><span class="op" id="3530835">,</span>&nbsp;<span class="ident" id="3530837">ok</span>&nbsp;<span class="op" id="3530840">:=</span>&nbsp;<span class="ident" id="3530843">statusLines</span><span class="op" id="3530854">[</span><span class="ident" id="3530855">key</span><span class="op" id="3530858">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530861">statusMu</span><span class="op" id="3530869">.</span><span class="ident" id="3530870">RUnlock</span><span class="op" id="3530877">(</span><span class="op" id="3530878">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3530881">if</span>&nbsp;<span class="ident" id="3530884">ok</span>&nbsp;<span class="op" id="3530887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3530891">return</span>&nbsp;<span class="ident" id="3530898">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3530904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3530908">//&nbsp;Slow&nbsp;path:</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530923">proto</span>&nbsp;<span class="op" id="3530929">:=</span>&nbsp;<span class="string" id="3530932">&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3530944">if</span>&nbsp;<span class="ident" id="3530947">proto11</span>&nbsp;<span class="op" id="3530955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530959">proto</span>&nbsp;<span class="op" id="3530965">=</span>&nbsp;<span class="string" id="3530967">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3530979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530982">codestring</span>&nbsp;<span class="op" id="3530993">:=</span>&nbsp;<span class="ident" id="3530996">strconv</span><span class="op" id="3531003">.</span><span class="ident" id="3531004">Itoa</span><span class="op" id="3531008">(</span><span class="ident" id="3531009">code</span><span class="op" id="3531013">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3531016">text</span><span class="op" id="3531020">,</span>&nbsp;<span class="ident" id="3531022">ok</span>&nbsp;<span class="op" id="3531025">:=</span>&nbsp;<span class="ident" id="3531028">statusText</span><span class="op" id="3531038">[</span><span class="ident" id="3531039">code</span><span class="op" id="3531043">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3531046">if</span>&nbsp;<span class="op" id="3531049">!</span><span class="ident" id="3531050">ok</span>&nbsp;<span class="op" id="3531053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3531057">text</span>&nbsp;<span class="op" id="3531062">=</span>&nbsp;<span class="string" id="3531064">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="3531079">+</span>&nbsp;<span class="ident" id="3531081">codestring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3531093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3531096">line</span>&nbsp;<span class="op" id="3531101">=</span>&nbsp;<span class="ident" id="3531103">proto</span>&nbsp;<span class="op" id="3531109">+</span>&nbsp;<span class="string" id="3531111">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3531115">+</span>&nbsp;<span class="ident" id="3531117">codestring</span>&nbsp;<span class="op" id="3531128">+</span>&nbsp;<span class="string" id="3531130">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3531134">+</span>&nbsp;<span class="ident" id="3531136">text</span>&nbsp;<span class="op" id="3531141">+</span>&nbsp;<span class="string" id="3531143">&#34;\r\n&#34;</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3531151">if</span>&nbsp;<span class="ident" id="3531154">ok</span>&nbsp;<span class="op" id="3531157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3531161">statusMu</span><span class="op" id="3531169">.</span><span class="ident" id="3531170">Lock</span><span class="op" id="3531174">(</span><span class="op" id="3531175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3531179">defer</span>&nbsp;<span class="ident" id="3531185">statusMu</span><span class="op" id="3531193">.</span><span class="ident" id="3531194">Unlock</span><span class="op" id="3531200">(</span><span class="op" id="3531201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3531205">statusLines</span><span class="op" id="3531216">[</span><span class="ident" id="3531217">key</span><span class="op" id="3531220">]</span>&nbsp;<span class="op" id="3531222">=</span>&nbsp;<span class="ident" id="3531224">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3531230">}</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3531233">return</span>&nbsp;<span class="ident" id="3531240">line</span><br>
<span class="lineno"></span><span class="op" id="3531245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3531248">//&nbsp;bodyAllowed&nbsp;returns&nbsp;true&nbsp;if&nbsp;a&nbsp;Write&nbsp;is&nbsp;allowed&nbsp;for&nbsp;this&nbsp;response&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3531322">//&nbsp;It&#39;s&nbsp;illegal&nbsp;to&nbsp;call&nbsp;this&nbsp;before&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;flushed.</span><br>
<span class="lineno">935</span><span class="keyword" id="3531387">func</span>&nbsp;<span class="op" id="3531392">(</span><span class="ident" id="3531393">w</span>&nbsp;<span class="op" id="3531395">*</span><span class="ident" id="3531396">response</span><span class="op" id="3531404">)</span>&nbsp;<span class="ident" id="3531406">bodyAllowed</span><span class="op" id="3531417">(</span><span class="op" id="3531418">)</span>&nbsp;<span class="builtintype" id="3531420">bool</span>&nbsp;<span class="op" id="3531425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3531428">if</span>&nbsp;<span class="op" id="3531431">!</span><span class="ident" id="3531432">w</span><span class="op" id="3531433">.</span><span class="ident" id="3531434">wroteHeader</span>&nbsp;<span class="op" id="3531446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3531450">panic</span><span class="op" id="3531455">(</span><span class="string" id="3531456">&#34;&#34;</span><span class="op" id="3531458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3531461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3531464">return</span>&nbsp;<span class="ident" id="3531471">bodyAllowedForStatus</span><span class="op" id="3531491">(</span><span class="ident" id="3531492">w</span><span class="op" id="3531493">.</span><span class="ident" id="3531494">status</span><span class="op" id="3531500">)</span><br>
<span class="lineno">940</span><span class="op" id="3531502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3531505">//&nbsp;The&nbsp;Life&nbsp;Of&nbsp;A&nbsp;Write&nbsp;is&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span><span class="comment" id="3531542">//</span><br>
<span class="lineno"></span><span class="comment" id="3531545">//&nbsp;Handler&nbsp;starts.&nbsp;No&nbsp;header&nbsp;has&nbsp;been&nbsp;sent.&nbsp;The&nbsp;handler&nbsp;can&nbsp;either</span><br>
<span class="lineno">945</span><span class="comment" id="3531612">//&nbsp;write&nbsp;a&nbsp;header,&nbsp;or&nbsp;just&nbsp;start&nbsp;writing.&nbsp;&nbsp;Writing&nbsp;before&nbsp;sending&nbsp;a&nbsp;header</span><br>
<span class="lineno"></span><span class="comment" id="3531687">//&nbsp;sends&nbsp;an&nbsp;implicitly&nbsp;empty&nbsp;200&nbsp;OK&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="3531731">//</span><br>
<span class="lineno"></span><span class="comment" id="3531734">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;declare&nbsp;a&nbsp;Content-Length&nbsp;up&nbsp;front,&nbsp;we&nbsp;either</span><br>
<span class="lineno"></span><span class="comment" id="3531804">//&nbsp;go&nbsp;into&nbsp;chunking&nbsp;mode&nbsp;or,&nbsp;if&nbsp;the&nbsp;handler&nbsp;finishes&nbsp;running&nbsp;before</span><br>
<span class="lineno">950</span><span class="comment" id="3531872">//&nbsp;the&nbsp;chunking&nbsp;buffer&nbsp;size,&nbsp;we&nbsp;compute&nbsp;a&nbsp;Content-Length&nbsp;and&nbsp;send&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3531943">//&nbsp;in&nbsp;the&nbsp;header&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="3531969">//</span><br>
<span class="lineno"></span><span class="comment" id="3531972">//&nbsp;Likewise,&nbsp;if&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;set&nbsp;a&nbsp;Content-Type,&nbsp;we&nbsp;sniff&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3532041">//&nbsp;from&nbsp;the&nbsp;initial&nbsp;chunk&nbsp;of&nbsp;output.</span><br>
<span class="lineno">955</span><span class="comment" id="3532078">//</span><br>
<span class="lineno"></span><span class="comment" id="3532081">//&nbsp;The&nbsp;Writers&nbsp;are&nbsp;wired&nbsp;together&nbsp;like:</span><br>
<span class="lineno"></span><span class="comment" id="3532121">//</span><br>
<span class="lineno"></span><span class="comment" id="3532124">//&nbsp;1.&nbsp;*response&nbsp;(the&nbsp;ResponseWriter)&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3532164">//&nbsp;2.&nbsp;(*response).w,&nbsp;a&nbsp;*bufio.Writer&nbsp;of&nbsp;bufferBeforeChunkingSize&nbsp;bytes</span><br>
<span class="lineno">960</span><span class="comment" id="3532235">//&nbsp;3.&nbsp;chunkWriter.Writer&nbsp;(whose&nbsp;writeHeader&nbsp;finalizes&nbsp;Content-Length/Type)</span><br>
<span class="lineno"></span><span class="comment" id="3532310">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;which&nbsp;writes&nbsp;the&nbsp;chunk&nbsp;headers,&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="comment" id="3532363">//&nbsp;4.&nbsp;conn.buf,&nbsp;a&nbsp;bufio.Writer&nbsp;of&nbsp;default&nbsp;(4kB)&nbsp;bytes,&nbsp;writing&nbsp;to&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3532432">//&nbsp;5.&nbsp;checkConnErrorWriter{c},&nbsp;which&nbsp;notes&nbsp;any&nbsp;non-nil&nbsp;error&nbsp;on&nbsp;Write</span><br>
<span class="lineno"></span><span class="comment" id="3532502">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;populates&nbsp;c.werr&nbsp;with&nbsp;it&nbsp;if&nbsp;so.&nbsp;but&nbsp;otherwise&nbsp;writes&nbsp;to:</span><br>
<span class="lineno">965</span><span class="comment" id="3532569">//&nbsp;6.&nbsp;the&nbsp;rwc,&nbsp;the&nbsp;net.Conn.</span><br>
<span class="lineno"></span><span class="comment" id="3532598">//</span><br>
<span class="lineno"></span><span class="comment" id="3532601">//&nbsp;TODO(bradfitz):&nbsp;short-circuit&nbsp;some&nbsp;of&nbsp;the&nbsp;buffering&nbsp;when&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3532665">//&nbsp;initial&nbsp;header&nbsp;contains&nbsp;both&nbsp;a&nbsp;Content-Type&nbsp;and&nbsp;Content-Length.</span><br>
<span class="lineno"></span><span class="comment" id="3532732">//&nbsp;Also&nbsp;short-circuit&nbsp;in&nbsp;(1)&nbsp;when&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;sent&nbsp;and&nbsp;not&nbsp;in</span><br>
<span class="lineno">970</span><span class="comment" id="3532800">//&nbsp;chunking&nbsp;mode,&nbsp;writing&nbsp;directly&nbsp;to&nbsp;(4)&nbsp;instead,&nbsp;if&nbsp;(2)&nbsp;has&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="3532865">//&nbsp;buffered&nbsp;data.&nbsp;&nbsp;More&nbsp;generally,&nbsp;we&nbsp;could&nbsp;short-circuit&nbsp;from&nbsp;(1)&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3532935">//&nbsp;(3)&nbsp;even&nbsp;in&nbsp;chunking&nbsp;mode&nbsp;if&nbsp;the&nbsp;write&nbsp;size&nbsp;from&nbsp;(1)&nbsp;is&nbsp;over&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="3533004">//&nbsp;threshold&nbsp;and&nbsp;nothing&nbsp;is&nbsp;in&nbsp;(2).&nbsp;&nbsp;The&nbsp;answer&nbsp;might&nbsp;be&nbsp;mostly&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3533075">//&nbsp;bufferBeforeChunkingSize&nbsp;smaller&nbsp;and&nbsp;having&nbsp;bufio&#39;s&nbsp;fast-paths&nbsp;deal</span><br>
<span class="lineno">975</span><span class="comment" id="3533146">//&nbsp;with&nbsp;this&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="3533168">func</span>&nbsp;<span class="op" id="3533173">(</span><span class="ident" id="3533174">w</span>&nbsp;<span class="op" id="3533176">*</span><span class="ident" id="3533177">response</span><span class="op" id="3533185">)</span>&nbsp;<span class="ident" id="3533187">Write</span><span class="op" id="3533192">(</span><span class="ident" id="3533193">data</span>&nbsp;<span class="op" id="3533198">[</span><span class="op" id="3533199">]</span><span class="builtintype" id="3533200">byte</span><span class="op" id="3533204">)</span>&nbsp;<span class="op" id="3533206">(</span><span class="ident" id="3533207">n</span>&nbsp;<span class="builtintype" id="3533209">int</span><span class="op" id="3533212">,</span>&nbsp;<span class="ident" id="3533214">err</span>&nbsp;<span class="builtintype" id="3533218">error</span><span class="op" id="3533223">)</span>&nbsp;<span class="op" id="3533225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533228">return</span>&nbsp;<span class="ident" id="3533235">w</span><span class="op" id="3533236">.</span><span class="ident" id="3533237">write</span><span class="op" id="3533242">(</span><span class="builtinfunc" id="3533243">len</span><span class="op" id="3533246">(</span><span class="ident" id="3533247">data</span><span class="op" id="3533251">)</span><span class="op" id="3533252">,</span>&nbsp;<span class="ident" id="3533254">data</span><span class="op" id="3533258">,</span>&nbsp;<span class="string" id="3533260">&#34;&#34;</span><span class="op" id="3533262">)</span><br>
<span class="lineno"></span><span class="op" id="3533264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="3533267">func</span>&nbsp;<span class="op" id="3533272">(</span><span class="ident" id="3533273">w</span>&nbsp;<span class="op" id="3533275">*</span><span class="ident" id="3533276">response</span><span class="op" id="3533284">)</span>&nbsp;<span class="ident" id="3533286">WriteString</span><span class="op" id="3533297">(</span><span class="ident" id="3533298">data</span>&nbsp;<span class="builtintype" id="3533303">string</span><span class="op" id="3533309">)</span>&nbsp;<span class="op" id="3533311">(</span><span class="ident" id="3533312">n</span>&nbsp;<span class="builtintype" id="3533314">int</span><span class="op" id="3533317">,</span>&nbsp;<span class="ident" id="3533319">err</span>&nbsp;<span class="builtintype" id="3533323">error</span><span class="op" id="3533328">)</span>&nbsp;<span class="op" id="3533330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533333">return</span>&nbsp;<span class="ident" id="3533340">w</span><span class="op" id="3533341">.</span><span class="ident" id="3533342">write</span><span class="op" id="3533347">(</span><span class="builtinfunc" id="3533348">len</span><span class="op" id="3533351">(</span><span class="ident" id="3533352">data</span><span class="op" id="3533356">)</span><span class="op" id="3533357">,</span>&nbsp;<span class="ident" id="3533359">nil</span><span class="op" id="3533362">,</span>&nbsp;<span class="ident" id="3533364">data</span><span class="op" id="3533368">)</span><br>
<span class="lineno"></span><span class="op" id="3533370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3533373">//&nbsp;either&nbsp;dataB&nbsp;or&nbsp;dataS&nbsp;is&nbsp;non-zero.</span><br>
<span class="lineno">985</span><span class="keyword" id="3533411">func</span>&nbsp;<span class="op" id="3533416">(</span><span class="ident" id="3533417">w</span>&nbsp;<span class="op" id="3533419">*</span><span class="ident" id="3533420">response</span><span class="op" id="3533428">)</span>&nbsp;<span class="ident" id="3533430">write</span><span class="op" id="3533435">(</span><span class="ident" id="3533436">lenData</span>&nbsp;<span class="builtintype" id="3533444">int</span><span class="op" id="3533447">,</span>&nbsp;<span class="ident" id="3533449">dataB</span>&nbsp;<span class="op" id="3533455">[</span><span class="op" id="3533456">]</span><span class="builtintype" id="3533457">byte</span><span class="op" id="3533461">,</span>&nbsp;<span class="ident" id="3533463">dataS</span>&nbsp;<span class="builtintype" id="3533469">string</span><span class="op" id="3533475">)</span>&nbsp;<span class="op" id="3533477">(</span><span class="ident" id="3533478">n</span>&nbsp;<span class="builtintype" id="3533480">int</span><span class="op" id="3533483">,</span>&nbsp;<span class="ident" id="3533485">err</span>&nbsp;<span class="builtintype" id="3533489">error</span><span class="op" id="3533494">)</span>&nbsp;<span class="op" id="3533496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533499">if</span>&nbsp;<span class="ident" id="3533502">w</span><span class="op" id="3533503">.</span><span class="ident" id="3533504">conn</span><span class="op" id="3533508">.</span><span class="ident" id="3533509">hijacked</span><span class="op" id="3533517">(</span><span class="op" id="3533518">)</span>&nbsp;<span class="op" id="3533520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3533524">w</span><span class="op" id="3533525">.</span><span class="ident" id="3533526">conn</span><span class="op" id="3533530">.</span><span class="ident" id="3533531">server</span><span class="op" id="3533537">.</span><span class="ident" id="3533538">logf</span><span class="op" id="3533542">(</span><span class="string" id="3533543">&#34;http:&nbsp;response.Write&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3533588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533592">return</span>&nbsp;<span class="num" id="3533599">0</span><span class="op" id="3533600">,</span>&nbsp;<span class="ident" id="3533602">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3533615">}</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533618">if</span>&nbsp;<span class="op" id="3533621">!</span><span class="ident" id="3533622">w</span><span class="op" id="3533623">.</span><span class="ident" id="3533624">wroteHeader</span>&nbsp;<span class="op" id="3533636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3533640">w</span><span class="op" id="3533641">.</span><span class="ident" id="3533642">WriteHeader</span><span class="op" id="3533653">(</span><span class="ident" id="3533654">StatusOK</span><span class="op" id="3533662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3533665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533668">if</span>&nbsp;<span class="ident" id="3533671">lenData</span>&nbsp;<span class="op" id="3533679">==</span>&nbsp;<span class="num" id="3533682">0</span>&nbsp;<span class="op" id="3533684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533688">return</span>&nbsp;<span class="num" id="3533695">0</span><span class="op" id="3533696">,</span>&nbsp;<span class="ident" id="3533698">nil</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3533703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533706">if</span>&nbsp;<span class="op" id="3533709">!</span><span class="ident" id="3533710">w</span><span class="op" id="3533711">.</span><span class="ident" id="3533712">bodyAllowed</span><span class="op" id="3533723">(</span><span class="op" id="3533724">)</span>&nbsp;<span class="op" id="3533726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533730">return</span>&nbsp;<span class="num" id="3533737">0</span><span class="op" id="3533738">,</span>&nbsp;<span class="ident" id="3533740">ErrBodyNotAllowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3533759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3533763">w</span><span class="op" id="3533764">.</span><span class="ident" id="3533765">written</span>&nbsp;<span class="op" id="3533773">+=</span>&nbsp;<span class="ident" id="3533776">int64</span><span class="op" id="3533781">(</span><span class="ident" id="3533782">lenData</span><span class="op" id="3533789">)</span>&nbsp;<span class="comment" id="3533791">//&nbsp;ignoring&nbsp;errors,&nbsp;for&nbsp;errorKludge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533828">if</span>&nbsp;<span class="ident" id="3533831">w</span><span class="op" id="3533832">.</span><span class="ident" id="3533833">contentLength</span>&nbsp;<span class="op" id="3533847">!=</span>&nbsp;<span class="op" id="3533850">-</span><span class="num" id="3533851">1</span>&nbsp;<span class="op" id="3533853">&amp;&amp;</span>&nbsp;<span class="ident" id="3533856">w</span><span class="op" id="3533857">.</span><span class="ident" id="3533858">written</span>&nbsp;<span class="op" id="3533866">&gt;</span>&nbsp;<span class="ident" id="3533868">w</span><span class="op" id="3533869">.</span><span class="ident" id="3533870">contentLength</span>&nbsp;<span class="op" id="3533884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533888">return</span>&nbsp;<span class="num" id="3533895">0</span><span class="op" id="3533896">,</span>&nbsp;<span class="ident" id="3533898">ErrContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3533916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533919">if</span>&nbsp;<span class="ident" id="3533922">dataB</span>&nbsp;<span class="op" id="3533928">!=</span>&nbsp;<span class="ident" id="3533931">nil</span>&nbsp;<span class="op" id="3533935">{</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533939">return</span>&nbsp;<span class="ident" id="3533946">w</span><span class="op" id="3533947">.</span><span class="ident" id="3533948">w</span><span class="op" id="3533949">.</span><span class="ident" id="3533950">Write</span><span class="op" id="3533955">(</span><span class="ident" id="3533956">dataB</span><span class="op" id="3533961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3533964">}</span>&nbsp;<span class="keyword" id="3533966">else</span>&nbsp;<span class="op" id="3533971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533975">return</span>&nbsp;<span class="ident" id="3533982">w</span><span class="op" id="3533983">.</span><span class="ident" id="3533984">w</span><span class="op" id="3533985">.</span><span class="ident" id="3533986">WriteString</span><span class="op" id="3533997">(</span><span class="ident" id="3533998">dataS</span><span class="op" id="3534003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534006">}</span><br>
<span class="lineno"></span><span class="op" id="3534008">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span><span class="keyword" id="3534011">func</span>&nbsp;<span class="op" id="3534016">(</span><span class="ident" id="3534017">w</span>&nbsp;<span class="op" id="3534019">*</span><span class="ident" id="3534020">response</span><span class="op" id="3534028">)</span>&nbsp;<span class="ident" id="3534030">finishRequest</span><span class="op" id="3534043">(</span><span class="op" id="3534044">)</span>&nbsp;<span class="op" id="3534046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534049">w</span><span class="op" id="3534050">.</span><span class="ident" id="3534051">handlerDone</span>&nbsp;<span class="op" id="3534063">=</span>&nbsp;<span class="builtintype" id="3534065">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534072">if</span>&nbsp;<span class="op" id="3534075">!</span><span class="ident" id="3534076">w</span><span class="op" id="3534077">.</span><span class="ident" id="3534078">wroteHeader</span>&nbsp;<span class="op" id="3534090">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534094">w</span><span class="op" id="3534095">.</span><span class="ident" id="3534096">WriteHeader</span><span class="op" id="3534107">(</span><span class="ident" id="3534108">StatusOK</span><span class="op" id="3534116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534123">w</span><span class="op" id="3534124">.</span><span class="ident" id="3534125">w</span><span class="op" id="3534126">.</span><span class="ident" id="3534127">Flush</span><span class="op" id="3534132">(</span><span class="op" id="3534133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534136">putBufioWriter</span><span class="op" id="3534150">(</span><span class="ident" id="3534151">w</span><span class="op" id="3534152">.</span><span class="ident" id="3534153">w</span><span class="op" id="3534154">)</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534157">w</span><span class="op" id="3534158">.</span><span class="ident" id="3534159">cw</span><span class="op" id="3534161">.</span><span class="builtinfunc" id="3534162">close</span><span class="op" id="3534167">(</span><span class="op" id="3534168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534171">w</span><span class="op" id="3534172">.</span><span class="ident" id="3534173">conn</span><span class="op" id="3534177">.</span><span class="ident" id="3534178">buf</span><span class="op" id="3534181">.</span><span class="ident" id="3534182">Flush</span><span class="op" id="3534187">(</span><span class="op" id="3534188">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3534192">//&nbsp;Close&nbsp;the&nbsp;body&nbsp;(regardless&nbsp;of&nbsp;w.closeAfterReply)&nbsp;so&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3534255">//&nbsp;re-use&nbsp;its&nbsp;bufio.Reader&nbsp;later&nbsp;safely.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534297">w</span><span class="op" id="3534298">.</span><span class="ident" id="3534299">req</span><span class="op" id="3534302">.</span><span class="ident" id="3534303">Body</span><span class="op" id="3534307">.</span><span class="ident" id="3534308">Close</span><span class="op" id="3534313">(</span><span class="op" id="3534314">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534318">if</span>&nbsp;<span class="ident" id="3534321">w</span><span class="op" id="3534322">.</span><span class="ident" id="3534323">req</span><span class="op" id="3534326">.</span><span class="ident" id="3534327">MultipartForm</span>&nbsp;<span class="op" id="3534341">!=</span>&nbsp;<span class="ident" id="3534344">nil</span>&nbsp;<span class="op" id="3534348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534352">w</span><span class="op" id="3534353">.</span><span class="ident" id="3534354">req</span><span class="op" id="3534357">.</span><span class="ident" id="3534358">MultipartForm</span><span class="op" id="3534371">.</span><span class="ident" id="3534372">RemoveAll</span><span class="op" id="3534381">(</span><span class="op" id="3534382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534385">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534389">if</span>&nbsp;<span class="ident" id="3534392">w</span><span class="op" id="3534393">.</span><span class="ident" id="3534394">req</span><span class="op" id="3534397">.</span><span class="ident" id="3534398">Method</span>&nbsp;<span class="op" id="3534405">!=</span>&nbsp;<span class="string" id="3534408">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3534415">&amp;&amp;</span>&nbsp;<span class="ident" id="3534418">w</span><span class="op" id="3534419">.</span><span class="ident" id="3534420">contentLength</span>&nbsp;<span class="op" id="3534434">!=</span>&nbsp;<span class="op" id="3534437">-</span><span class="num" id="3534438">1</span>&nbsp;<span class="op" id="3534440">&amp;&amp;</span>&nbsp;<span class="ident" id="3534443">w</span><span class="op" id="3534444">.</span><span class="ident" id="3534445">bodyAllowed</span><span class="op" id="3534456">(</span><span class="op" id="3534457">)</span>&nbsp;<span class="op" id="3534459">&amp;&amp;</span>&nbsp;<span class="ident" id="3534462">w</span><span class="op" id="3534463">.</span><span class="ident" id="3534464">contentLength</span>&nbsp;<span class="op" id="3534478">!=</span>&nbsp;<span class="ident" id="3534481">w</span><span class="op" id="3534482">.</span><span class="ident" id="3534483">written</span>&nbsp;<span class="op" id="3534491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3534495">//&nbsp;Did&nbsp;not&nbsp;write&nbsp;enough.&nbsp;Avoid&nbsp;getting&nbsp;out&nbsp;of&nbsp;sync.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534549">w</span><span class="op" id="3534550">.</span><span class="ident" id="3534551">closeAfterReply</span>&nbsp;<span class="op" id="3534567">=</span>&nbsp;<span class="builtintype" id="3534569">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534575">}</span><br>
<span class="lineno">1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3534579">//&nbsp;There&nbsp;was&nbsp;some&nbsp;error&nbsp;writing&nbsp;to&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3534641">//&nbsp;during&nbsp;the&nbsp;request,&nbsp;so&nbsp;don&#39;t&nbsp;re-use&nbsp;this&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534692">if</span>&nbsp;<span class="ident" id="3534695">w</span><span class="op" id="3534696">.</span><span class="ident" id="3534697">conn</span><span class="op" id="3534701">.</span><span class="ident" id="3534702">werr</span>&nbsp;<span class="op" id="3534707">!=</span>&nbsp;<span class="ident" id="3534710">nil</span>&nbsp;<span class="op" id="3534714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534718">w</span><span class="op" id="3534719">.</span><span class="ident" id="3534720">closeAfterReply</span>&nbsp;<span class="op" id="3534736">=</span>&nbsp;<span class="builtintype" id="3534738">true</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534744">}</span><br>
<span class="lineno"></span><span class="op" id="3534746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3534749">func</span>&nbsp;<span class="op" id="3534754">(</span><span class="ident" id="3534755">w</span>&nbsp;<span class="op" id="3534757">*</span><span class="ident" id="3534758">response</span><span class="op" id="3534766">)</span>&nbsp;<span class="ident" id="3534768">Flush</span><span class="op" id="3534773">(</span><span class="op" id="3534774">)</span>&nbsp;<span class="op" id="3534776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534779">if</span>&nbsp;<span class="op" id="3534782">!</span><span class="ident" id="3534783">w</span><span class="op" id="3534784">.</span><span class="ident" id="3534785">wroteHeader</span>&nbsp;<span class="op" id="3534797">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534801">w</span><span class="op" id="3534802">.</span><span class="ident" id="3534803">WriteHeader</span><span class="op" id="3534814">(</span><span class="ident" id="3534815">StatusOK</span><span class="op" id="3534823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534829">w</span><span class="op" id="3534830">.</span><span class="ident" id="3534831">w</span><span class="op" id="3534832">.</span><span class="ident" id="3534833">Flush</span><span class="op" id="3534838">(</span><span class="op" id="3534839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534842">w</span><span class="op" id="3534843">.</span><span class="ident" id="3534844">cw</span><span class="op" id="3534846">.</span><span class="ident" id="3534847">flush</span><span class="op" id="3534852">(</span><span class="op" id="3534853">)</span><br>
<span class="lineno"></span><span class="op" id="3534855">}</span><br>
<span class="lineno">1050</span><br>
<span class="lineno"></span><span class="keyword" id="3534858">func</span>&nbsp;<span class="op" id="3534863">(</span><span class="ident" id="3534864">c</span>&nbsp;<span class="op" id="3534866">*</span><span class="ident" id="3534867">conn</span><span class="op" id="3534871">)</span>&nbsp;<span class="ident" id="3534873">finalFlush</span><span class="op" id="3534883">(</span><span class="op" id="3534884">)</span>&nbsp;<span class="op" id="3534886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534889">if</span>&nbsp;<span class="ident" id="3534892">c</span><span class="op" id="3534893">.</span><span class="ident" id="3534894">buf</span>&nbsp;<span class="op" id="3534898">!=</span>&nbsp;<span class="ident" id="3534901">nil</span>&nbsp;<span class="op" id="3534905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534909">c</span><span class="op" id="3534910">.</span><span class="ident" id="3534911">buf</span><span class="op" id="3534914">.</span><span class="ident" id="3534915">Flush</span><span class="op" id="3534920">(</span><span class="op" id="3534921">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3534926">//&nbsp;Steal&nbsp;the&nbsp;bufio.Reader&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3534996">//&nbsp;reader&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3535033">putBufioReader</span><span class="op" id="3535047">(</span><span class="ident" id="3535048">c</span><span class="op" id="3535049">.</span><span class="ident" id="3535050">buf</span><span class="op" id="3535053">.</span><span class="ident" id="3535054">Reader</span><span class="op" id="3535060">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3535065">//&nbsp;Steal&nbsp;the&nbsp;bufio.Writer&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3535135">//&nbsp;writer&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3535172">putBufioWriter</span><span class="op" id="3535186">(</span><span class="ident" id="3535187">c</span><span class="op" id="3535188">.</span><span class="ident" id="3535189">buf</span><span class="op" id="3535192">.</span><span class="ident" id="3535193">Writer</span><span class="op" id="3535199">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3535204">c</span><span class="op" id="3535205">.</span><span class="ident" id="3535206">buf</span>&nbsp;<span class="op" id="3535210">=</span>&nbsp;<span class="ident" id="3535212">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3535217">}</span><br>
<span class="lineno">1065</span><span class="op" id="3535219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3535222">//&nbsp;Close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3535247">func</span>&nbsp;<span class="op" id="3535252">(</span><span class="ident" id="3535253">c</span>&nbsp;<span class="op" id="3535255">*</span><span class="ident" id="3535256">conn</span><span class="op" id="3535260">)</span>&nbsp;<span class="builtinfunc" id="3535262">close</span><span class="op" id="3535267">(</span><span class="op" id="3535268">)</span>&nbsp;<span class="op" id="3535270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3535273">c</span><span class="op" id="3535274">.</span><span class="ident" id="3535275">finalFlush</span><span class="op" id="3535285">(</span><span class="op" id="3535286">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3535289">if</span>&nbsp;<span class="ident" id="3535292">c</span><span class="op" id="3535293">.</span><span class="ident" id="3535294">rwc</span>&nbsp;<span class="op" id="3535298">!=</span>&nbsp;<span class="ident" id="3535301">nil</span>&nbsp;<span class="op" id="3535305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3535309">c</span><span class="op" id="3535310">.</span><span class="ident" id="3535311">rwc</span><span class="op" id="3535314">.</span><span class="ident" id="3535315">Close</span><span class="op" id="3535320">(</span><span class="op" id="3535321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3535325">c</span><span class="op" id="3535326">.</span><span class="ident" id="3535327">rwc</span>&nbsp;<span class="op" id="3535331">=</span>&nbsp;<span class="ident" id="3535333">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3535338">}</span><br>
<span class="lineno"></span><span class="op" id="3535340">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span><span class="comment" id="3535343">//&nbsp;rstAvoidanceDelay&nbsp;is&nbsp;the&nbsp;amount&nbsp;of&nbsp;time&nbsp;we&nbsp;sleep&nbsp;after&nbsp;closing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3535413">//&nbsp;write&nbsp;side&nbsp;of&nbsp;a&nbsp;TCP&nbsp;connection&nbsp;before&nbsp;closing&nbsp;the&nbsp;entire&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="3535481">//&nbsp;By&nbsp;sleeping,&nbsp;we&nbsp;increase&nbsp;the&nbsp;chances&nbsp;that&nbsp;the&nbsp;client&nbsp;sees&nbsp;our&nbsp;FIN</span><br>
<span class="lineno"></span><span class="comment" id="3535550">//&nbsp;and&nbsp;processes&nbsp;its&nbsp;final&nbsp;data&nbsp;before&nbsp;they&nbsp;process&nbsp;the&nbsp;subsequent&nbsp;RST</span><br>
<span class="lineno">1080</span><span class="comment" id="3535621">//&nbsp;from&nbsp;closing&nbsp;a&nbsp;connection&nbsp;with&nbsp;known&nbsp;unread&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3535674">//&nbsp;This&nbsp;RST&nbsp;seems&nbsp;to&nbsp;occur&nbsp;mostly&nbsp;on&nbsp;BSD&nbsp;systems.&nbsp;(And&nbsp;Windows?)</span><br>
<span class="lineno"></span><span class="comment" id="3535739">//&nbsp;This&nbsp;timeout&nbsp;is&nbsp;somewhat&nbsp;arbitrary&nbsp;(~latency&nbsp;around&nbsp;the&nbsp;planet).</span><br>
<span class="lineno"></span><span class="keyword" id="3535807">const</span>&nbsp;<span class="ident" id="3535813">rstAvoidanceDelay</span>&nbsp;<span class="op" id="3535831">=</span>&nbsp;<span class="num" id="3535833">500</span>&nbsp;<span class="op" id="3535837">*</span>&nbsp;<span class="ident" id="3535839">time</span><span class="op" id="3535843">.</span><span class="ident" id="3535844">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno">1085</span><span class="keyword" id="3535857">type</span>&nbsp;<span class="ident" id="3535862">closeWriter</span>&nbsp;<span class="keyword" id="3535874">interface</span>&nbsp;<span class="op" id="3535884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3535887">CloseWrite</span><span class="op" id="3535897">(</span><span class="op" id="3535898">)</span>&nbsp;<span class="builtintype" id="3535900">error</span><br>
<span class="lineno"></span><span class="op" id="3535906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3535909">var</span>&nbsp;<span class="ident" id="3535913">_</span>&nbsp;<span class="ident" id="3535915">closeWriter</span>&nbsp;<span class="op" id="3535927">=</span>&nbsp;<span class="op" id="3535929">(</span><span class="op" id="3535930">*</span><span class="ident" id="3535931">net</span><span class="op" id="3535934">.</span><span class="ident" id="3535935">TCPConn</span><span class="op" id="3535942">)</span><span class="op" id="3535943">(</span><span class="ident" id="3535944">nil</span><span class="op" id="3535947">)</span><br>
<span class="lineno">1090</span><br>
<span class="lineno"></span><span class="comment" id="3535950">//&nbsp;closeWrite&nbsp;flushes&nbsp;any&nbsp;outstanding&nbsp;data&nbsp;and&nbsp;sends&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="3536020">//&nbsp;client&nbsp;is&nbsp;connected&nbsp;via&nbsp;TCP),&nbsp;signalling&nbsp;that&nbsp;we&#39;re&nbsp;done.&nbsp;&nbsp;We&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3536090">//&nbsp;pause&nbsp;for&nbsp;a&nbsp;bit,&nbsp;hoping&nbsp;the&nbsp;client&nbsp;processes&nbsp;it&nbsp;before&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3536152">//&nbsp;subsequent&nbsp;RST.</span><br>
<span class="lineno">1095</span><span class="comment" id="3536171">//</span><br>
<span class="lineno"></span><span class="comment" id="3536174">//&nbsp;See&nbsp;http://golang.org/issue/3595</span><br>
<span class="lineno"></span><span class="keyword" id="3536210">func</span>&nbsp;<span class="op" id="3536215">(</span><span class="ident" id="3536216">c</span>&nbsp;<span class="op" id="3536218">*</span><span class="ident" id="3536219">conn</span><span class="op" id="3536223">)</span>&nbsp;<span class="ident" id="3536225">closeWriteAndWait</span><span class="op" id="3536242">(</span><span class="op" id="3536243">)</span>&nbsp;<span class="op" id="3536245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3536248">c</span><span class="op" id="3536249">.</span><span class="ident" id="3536250">finalFlush</span><span class="op" id="3536260">(</span><span class="op" id="3536261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3536264">if</span>&nbsp;<span class="ident" id="3536267">tcp</span><span class="op" id="3536270">,</span>&nbsp;<span class="ident" id="3536272">ok</span>&nbsp;<span class="op" id="3536275">:=</span>&nbsp;<span class="ident" id="3536278">c</span><span class="op" id="3536279">.</span><span class="ident" id="3536280">rwc</span><span class="op" id="3536283">.</span><span class="op" id="3536284">(</span><span class="ident" id="3536285">closeWriter</span><span class="op" id="3536296">)</span><span class="op" id="3536297">;</span>&nbsp;<span class="ident" id="3536299">ok</span>&nbsp;<span class="op" id="3536302">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3536306">tcp</span><span class="op" id="3536309">.</span><span class="ident" id="3536310">CloseWrite</span><span class="op" id="3536320">(</span><span class="op" id="3536321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3536324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3536327">time</span><span class="op" id="3536331">.</span><span class="ident" id="3536332">Sleep</span><span class="op" id="3536337">(</span><span class="ident" id="3536338">rstAvoidanceDelay</span><span class="op" id="3536355">)</span><br>
<span class="lineno"></span><span class="op" id="3536357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1105</span><span class="comment" id="3536360">//&nbsp;validNPN&nbsp;reports&nbsp;whether&nbsp;the&nbsp;proto&nbsp;is&nbsp;not&nbsp;a&nbsp;blacklisted&nbsp;Next</span><br>
<span class="lineno"></span><span class="comment" id="3536424">//&nbsp;Protocol&nbsp;Negotiation&nbsp;protocol.&nbsp;&nbsp;Empty&nbsp;and&nbsp;built-in&nbsp;protocol&nbsp;types</span><br>
<span class="lineno"></span><span class="comment" id="3536493">//&nbsp;are&nbsp;blacklisted&nbsp;and&nbsp;can&#39;t&nbsp;be&nbsp;overridden&nbsp;with&nbsp;alternate</span><br>
<span class="lineno"></span><span class="comment" id="3536551">//&nbsp;implementations.</span><br>
<span class="lineno"></span><span class="keyword" id="3536571">func</span>&nbsp;<span class="ident" id="3536576">validNPN</span><span class="op" id="3536584">(</span><span class="ident" id="3536585">proto</span>&nbsp;<span class="builtintype" id="3536591">string</span><span class="op" id="3536597">)</span>&nbsp;<span class="builtintype" id="3536599">bool</span>&nbsp;<span class="op" id="3536604">{</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3536607">switch</span>&nbsp;<span class="ident" id="3536614">proto</span>&nbsp;<span class="op" id="3536620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3536623">case</span>&nbsp;<span class="string" id="3536628">&#34;&#34;</span><span class="op" id="3536630">,</span>&nbsp;<span class="string" id="3536632">&#34;http/1.1&#34;</span><span class="op" id="3536642">,</span>&nbsp;<span class="string" id="3536644">&#34;http/1.0&#34;</span><span class="op" id="3536654">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3536658">return</span>&nbsp;<span class="builtintype" id="3536665">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3536672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3536675">return</span>&nbsp;<span class="builtintype" id="3536682">true</span><br>
<span class="lineno">1115</span><span class="op" id="3536687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3536690">func</span>&nbsp;<span class="op" id="3536695">(</span><span class="ident" id="3536696">c</span>&nbsp;<span class="op" id="3536698">*</span><span class="ident" id="3536699">conn</span><span class="op" id="3536703">)</span>&nbsp;<span class="ident" id="3536705">setState</span><span class="op" id="3536713">(</span><span class="ident" id="3536714">nc</span>&nbsp;<span class="ident" id="3536717">net</span><span class="op" id="3536720">.</span><span class="ident" id="3536721">Conn</span><span class="op" id="3536725">,</span>&nbsp;<span class="ident" id="3536727">state</span>&nbsp;<span class="ident" id="3536733">ConnState</span><span class="op" id="3536742">)</span>&nbsp;<span class="op" id="3536744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3536747">if</span>&nbsp;<span class="ident" id="3536750">hook</span>&nbsp;<span class="op" id="3536755">:=</span>&nbsp;<span class="ident" id="3536758">c</span><span class="op" id="3536759">.</span><span class="ident" id="3536760">server</span><span class="op" id="3536766">.</span><span class="ident" id="3536767">ConnState</span><span class="op" id="3536776">;</span>&nbsp;<span class="ident" id="3536778">hook</span>&nbsp;<span class="op" id="3536783">!=</span>&nbsp;<span class="ident" id="3536786">nil</span>&nbsp;<span class="op" id="3536790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3536794">hook</span><span class="op" id="3536798">(</span><span class="ident" id="3536799">nc</span><span class="op" id="3536801">,</span>&nbsp;<span class="ident" id="3536803">state</span><span class="op" id="3536808">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3536811">}</span><br>
<span class="lineno"></span><span class="op" id="3536813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3536816">//&nbsp;Serve&nbsp;a&nbsp;new&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3536843">func</span>&nbsp;<span class="op" id="3536848">(</span><span class="ident" id="3536849">c</span>&nbsp;<span class="op" id="3536851">*</span><span class="ident" id="3536852">conn</span><span class="op" id="3536856">)</span>&nbsp;<span class="ident" id="3536858">serve</span><span class="op" id="3536863">(</span><span class="op" id="3536864">)</span>&nbsp;<span class="op" id="3536866">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3536869">origConn</span>&nbsp;<span class="op" id="3536878">:=</span>&nbsp;<span class="ident" id="3536881">c</span><span class="op" id="3536882">.</span><span class="ident" id="3536883">rwc</span>&nbsp;<span class="comment" id="3536887">//&nbsp;copy&nbsp;it&nbsp;before&nbsp;it&#39;s&nbsp;set&nbsp;nil&nbsp;on&nbsp;Close&nbsp;or&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3536938">defer</span>&nbsp;<span class="keyword" id="3536944">func</span><span class="op" id="3536948">(</span><span class="op" id="3536949">)</span>&nbsp;<span class="op" id="3536951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3536955">if</span>&nbsp;<span class="ident" id="3536958">err</span>&nbsp;<span class="op" id="3536962">:=</span>&nbsp;<span class="builtinfunc" id="3536965">recover</span><span class="op" id="3536972">(</span><span class="op" id="3536973">)</span><span class="op" id="3536974">;</span>&nbsp;<span class="ident" id="3536976">err</span>&nbsp;<span class="op" id="3536980">!=</span>&nbsp;<span class="ident" id="3536983">nil</span>&nbsp;<span class="op" id="3536987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3536992">const</span>&nbsp;<span class="ident" id="3536998">size</span>&nbsp;<span class="op" id="3537003">=</span>&nbsp;<span class="num" id="3537005">64</span>&nbsp;<span class="op" id="3537008">&lt;&lt;</span>&nbsp;<span class="num" id="3537011">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3537017">buf</span>&nbsp;<span class="op" id="3537021">:=</span>&nbsp;<span class="builtinfunc" id="3537024">make</span><span class="op" id="3537028">(</span><span class="op" id="3537029">[</span><span class="op" id="3537030">]</span><span class="builtintype" id="3537031">byte</span><span class="op" id="3537035">,</span>&nbsp;<span class="ident" id="3537037">size</span><span class="op" id="3537041">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3537046">buf</span>&nbsp;<span class="op" id="3537050">=</span>&nbsp;<span class="ident" id="3537052">buf</span><span class="op" id="3537055">[</span><span class="op" id="3537056">:</span><span class="ident" id="3537057">runtime</span><span class="op" id="3537064">.</span><span class="ident" id="3537065">Stack</span><span class="op" id="3537070">(</span><span class="ident" id="3537071">buf</span><span class="op" id="3537074">,</span>&nbsp;<span class="builtintype" id="3537076">false</span><span class="op" id="3537081">)</span><span class="op" id="3537082">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3537087">c</span><span class="op" id="3537088">.</span><span class="ident" id="3537089">server</span><span class="op" id="3537095">.</span><span class="ident" id="3537096">logf</span><span class="op" id="3537100">(</span><span class="string" id="3537101">&#34;http:&nbsp;panic&nbsp;serving&nbsp;%v:&nbsp;%v\n%s&#34;</span><span class="op" id="3537133">,</span>&nbsp;<span class="ident" id="3537135">c</span><span class="op" id="3537136">.</span><span class="ident" id="3537137">remoteAddr</span><span class="op" id="3537147">,</span>&nbsp;<span class="ident" id="3537149">err</span><span class="op" id="3537152">,</span>&nbsp;<span class="ident" id="3537154">buf</span><span class="op" id="3537157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3537161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3537165">if</span>&nbsp;<span class="op" id="3537168">!</span><span class="ident" id="3537169">c</span><span class="op" id="3537170">.</span><span class="ident" id="3537171">hijacked</span><span class="op" id="3537179">(</span><span class="op" id="3537180">)</span>&nbsp;<span class="op" id="3537182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3537187">c</span><span class="op" id="3537188">.</span><span class="builtinfunc" id="3537189">close</span><span class="op" id="3537194">(</span><span class="op" id="3537195">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3537200">c</span><span class="op" id="3537201">.</span><span class="ident" id="3537202">setState</span><span class="op" id="3537210">(</span><span class="ident" id="3537211">origConn</span><span class="op" id="3537219">,</span>&nbsp;<span class="ident" id="3537221">StateClosed</span><span class="op" id="3537232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3537236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3537239">}</span><span class="op" id="3537240">(</span><span class="op" id="3537241">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3537245">if</span>&nbsp;<span class="ident" id="3537248">tlsConn</span><span class="op" id="3537255">,</span>&nbsp;<span class="ident" id="3537257">ok</span>&nbsp;<span class="op" id="3537260">:=</span>&nbsp;<span class="ident" id="3537263">c</span><span class="op" id="3537264">.</span><span class="ident" id="3537265">rwc</span><span class="op" id="3537268">.</span><span class="op" id="3537269">(</span><span class="op" id="3537270">*</span><span class="ident" id="3537271">tls</span><span class="op" id="3537274">.</span><span class="ident" id="3537275">Conn</span><span class="op" id="3537279">)</span><span class="op" id="3537280">;</span>&nbsp;<span class="ident" id="3537282">ok</span>&nbsp;<span class="op" id="3537285">{</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3537289">if</span>&nbsp;<span class="ident" id="3537292">d</span>&nbsp;<span class="op" id="3537294">:=</span>&nbsp;<span class="ident" id="3537297">c</span><span class="op" id="3537298">.</span><span class="ident" id="3537299">server</span><span class="op" id="3537305">.</span><span class="ident" id="3537306">ReadTimeout</span><span class="op" id="3537317">;</span>&nbsp;<span class="ident" id="3537319">d</span>&nbsp;<span class="op" id="3537321">!=</span>&nbsp;<span class="num" id="3537324">0</span>&nbsp;<span class="op" id="3537326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3537331">c</span><span class="op" id="3537332">.</span><span class="ident" id="3537333">rwc</span><span class="op" id="3537336">.</span><span class="ident" id="3537337">SetReadDeadline</span><span class="op" id="3537352">(</span><span class="ident" id="3537353">time</span><span class="op" id="3537357">.</span><span class="ident" id="3537358">Now</span><span class="op" id="3537361">(</span><span class="op" id="3537362">)</span><span class="op" id="3537363">.</span><span class="ident" id="3537364">Add</span><span class="op" id="3537367">(</span><span class="ident" id="3537368">d</span><span class="op" id="3537369">)</span><span class="op" id="3537370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3537374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3537378">if</span>&nbsp;<span class="ident" id="3537381">d</span>&nbsp;<span class="op" id="3537383">:=</span>&nbsp;<span class="ident" id="3537386">c</span><span class="op" id="3537387">.</span><span class="ident" id="3537388">server</span><span class="op" id="3537394">.</span><span class="ident" id="3537395">WriteTimeout</span><span class="op" id="3537407">;</span>&nbsp;<span class="ident" id="3537409">d</span>&nbsp;<span class="op" id="3537411">!=</span>&nbsp;<span class="num" id="3537414">0</span>&nbsp;<span class="op" id="3537416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3537421">c</span><span class="op" id="3537422">.</span><span class="ident" id="3537423">rwc</span><span class="op" id="3537426">.</span><span class="ident" id="3537427">SetWriteDeadline</span><span class="op" id="3537443">(</span><span class="ident" id="3537444">time</span><span class="op" id="3537448">.</span><span class="ident" id="3537449">Now</span><span class="op" id="3537452">(</span><span class="op" id="3537453">)</span><span class="op" id="3537454">.</span><span class="ident" id="3537455">Add</span><span class="op" id="3537458">(</span><span class="ident" id="3537459">d</span><span class="op" id="3537460">)</span><span class="op" id="3537461">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3537465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3537469">if</span>&nbsp;<span class="ident" id="3537472">err</span>&nbsp;<span class="op" id="3537476">:=</span>&nbsp;<span class="ident" id="3537479">tlsConn</span><span class="op" id="3537486">.</span><span class="ident" id="3537487">Handshake</span><span class="op" id="3537496">(</span><span class="op" id="3537497">)</span><span class="op" id="3537498">;</span>&nbsp;<span class="ident" id="3537500">err</span>&nbsp;<span class="op" id="3537504">!=</span>&nbsp;<span class="ident" id="3537507">nil</span>&nbsp;<span class="op" id="3537511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3537516">c</span><span class="op" id="3537517">.</span><span class="ident" id="3537518">server</span><span class="op" id="3537524">.</span><span class="ident" id="3537525">logf</span><span class="op" id="3537529">(</span><span class="string" id="3537530">&#34;http:&nbsp;TLS&nbsp;handshake&nbsp;error&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="3537569">,</span>&nbsp;<span class="ident" id="3537571">c</span><span class="op" id="3537572">.</span><span class="ident" id="3537573">rwc</span><span class="op" id="3537576">.</span><span class="ident" id="3537577">RemoteAddr</span><span class="op" id="3537587">(</span><span class="op" id="3537588">)</span><span class="op" id="3537589">,</span>&nbsp;<span class="ident" id="3537591">err</span><span class="op" id="3537594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3537599">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3537608">}</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3537612">c</span><span class="op" id="3537613">.</span><span class="ident" id="3537614">tlsState</span>&nbsp;<span class="op" id="3537623">=</span>&nbsp;<span class="builtinfunc" id="3537625">new</span><span class="op" id="3537628">(</span><span class="ident" id="3537629">tls</span><span class="op" id="3537632">.</span><span class="ident" id="3537633">ConnectionState</span><span class="op" id="3537648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3537652">*</span><span class="ident" id="3537653">c</span><span class="op" id="3537654">.</span><span class="ident" id="3537655">tlsState</span>&nbsp;<span class="op" id="3537664">=</span>&nbsp;<span class="ident" id="3537666">tlsConn</span><span class="op" id="3537673">.</span><span class="ident" id="3537674">ConnectionState</span><span class="op" id="3537689">(</span><span class="op" id="3537690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3537694">if</span>&nbsp;<span class="ident" id="3537697">proto</span>&nbsp;<span class="op" id="3537703">:=</span>&nbsp;<span class="ident" id="3537706">c</span><span class="op" id="3537707">.</span><span class="ident" id="3537708">tlsState</span><span class="op" id="3537716">.</span><span class="ident" id="3537717">NegotiatedProtocol</span><span class="op" id="3537735">;</span>&nbsp;<span class="ident" id="3537737">validNPN</span><span class="op" id="3537745">(</span><span class="ident" id="3537746">proto</span><span class="op" id="3537751">)</span>&nbsp;<span class="op" id="3537753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3537758">if</span>&nbsp;<span class="ident" id="3537761">fn</span>&nbsp;<span class="op" id="3537764">:=</span>&nbsp;<span class="ident" id="3537767">c</span><span class="op" id="3537768">.</span><span class="ident" id="3537769">server</span><span class="op" id="3537775">.</span><span class="ident" id="3537776">TLSNextProto</span><span class="op" id="3537788">[</span><span class="ident" id="3537789">proto</span><span class="op" id="3537794">]</span><span class="op" id="3537795">;</span>&nbsp;<span class="ident" id="3537797">fn</span>&nbsp;<span class="op" id="3537800">!=</span>&nbsp;<span class="ident" id="3537803">nil</span>&nbsp;<span class="op" id="3537807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3537813">h</span>&nbsp;<span class="op" id="3537815">:=</span>&nbsp;<span class="ident" id="3537818">initNPNRequest</span><span class="op" id="3537832">{</span><span class="ident" id="3537833">tlsConn</span><span class="op" id="3537840">,</span>&nbsp;<span class="ident" id="3537842">serverHandler</span><span class="op" id="3537855">{</span><span class="ident" id="3537856">c</span><span class="op" id="3537857">.</span><span class="ident" id="3537858">server</span><span class="op" id="3537864">}</span><span class="op" id="3537865">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3537871">fn</span><span class="op" id="3537873">(</span><span class="ident" id="3537874">c</span><span class="op" id="3537875">.</span><span class="ident" id="3537876">server</span><span class="op" id="3537882">,</span>&nbsp;<span class="ident" id="3537884">tlsConn</span><span class="op" id="3537891">,</span>&nbsp;<span class="ident" id="3537893">h</span><span class="op" id="3537894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3537899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3537904">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3537913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3537916">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3537920">for</span>&nbsp;<span class="op" id="3537924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3537928">w</span><span class="op" id="3537929">,</span>&nbsp;<span class="ident" id="3537931">err</span>&nbsp;<span class="op" id="3537935">:=</span>&nbsp;<span class="ident" id="3537938">c</span><span class="op" id="3537939">.</span><span class="ident" id="3537940">readRequest</span><span class="op" id="3537951">(</span><span class="op" id="3537952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3537956">if</span>&nbsp;<span class="ident" id="3537959">c</span><span class="op" id="3537960">.</span><span class="ident" id="3537961">lr</span><span class="op" id="3537963">.</span><span class="ident" id="3537964">N</span>&nbsp;<span class="op" id="3537966">!=</span>&nbsp;<span class="ident" id="3537969">c</span><span class="op" id="3537970">.</span><span class="ident" id="3537971">server</span><span class="op" id="3537977">.</span><span class="ident" id="3537978">initialLimitedReaderSize</span><span class="op" id="3538002">(</span><span class="op" id="3538003">)</span>&nbsp;<span class="op" id="3538005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3538010">//&nbsp;If&nbsp;we&nbsp;read&nbsp;any&nbsp;bytes&nbsp;off&nbsp;the&nbsp;wire,&nbsp;we&#39;re&nbsp;active.</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3538065">c</span><span class="op" id="3538066">.</span><span class="ident" id="3538067">setState</span><span class="op" id="3538075">(</span><span class="ident" id="3538076">c</span><span class="op" id="3538077">.</span><span class="ident" id="3538078">rwc</span><span class="op" id="3538081">,</span>&nbsp;<span class="ident" id="3538083">StateActive</span><span class="op" id="3538094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3538098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3538102">if</span>&nbsp;<span class="ident" id="3538105">err</span>&nbsp;<span class="op" id="3538109">!=</span>&nbsp;<span class="ident" id="3538112">nil</span>&nbsp;<span class="op" id="3538116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3538121">if</span>&nbsp;<span class="ident" id="3538124">err</span>&nbsp;<span class="op" id="3538128">==</span>&nbsp;<span class="ident" id="3538131">errTooLarge</span>&nbsp;<span class="op" id="3538143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3538149">//&nbsp;Their&nbsp;HTTP&nbsp;client&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3538192">//&nbsp;able&nbsp;to&nbsp;read&nbsp;this&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3538226">//&nbsp;responding&nbsp;to&nbsp;them&nbsp;and&nbsp;hanging&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3538267">//&nbsp;while&nbsp;they&#39;re&nbsp;still&nbsp;writing&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3538308">//&nbsp;request.&nbsp;&nbsp;Undefined&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3538345">io</span><span class="op" id="3538347">.</span><span class="ident" id="3538348">WriteString</span><span class="op" id="3538359">(</span><span class="ident" id="3538360">c</span><span class="op" id="3538361">.</span><span class="ident" id="3538362">rwc</span><span class="op" id="3538365">,</span>&nbsp;<span class="string" id="3538367">&#34;HTTP/1.1&nbsp;413&nbsp;Request&nbsp;Entity&nbsp;Too&nbsp;Large\r\n\r\n&#34;</span><span class="op" id="3538414">)</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3538420">c</span><span class="op" id="3538421">.</span><span class="ident" id="3538422">closeWriteAndWait</span><span class="op" id="3538439">(</span><span class="op" id="3538440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3538446">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3538455">}</span>&nbsp;<span class="keyword" id="3538457">else</span>&nbsp;<span class="keyword" id="3538462">if</span>&nbsp;<span class="ident" id="3538465">err</span>&nbsp;<span class="op" id="3538469">==</span>&nbsp;<span class="ident" id="3538472">io</span><span class="op" id="3538474">.</span><span class="ident" id="3538475">EOF</span>&nbsp;<span class="op" id="3538479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3538485">break</span>&nbsp;<span class="comment" id="3538491">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3538509">}</span>&nbsp;<span class="keyword" id="3538511">else</span>&nbsp;<span class="keyword" id="3538516">if</span>&nbsp;<span class="ident" id="3538519">neterr</span><span class="op" id="3538525">,</span>&nbsp;<span class="ident" id="3538527">ok</span>&nbsp;<span class="op" id="3538530">:=</span>&nbsp;<span class="ident" id="3538533">err</span><span class="op" id="3538536">.</span><span class="op" id="3538537">(</span><span class="ident" id="3538538">net</span><span class="op" id="3538541">.</span><span class="ident" id="3538542">Error</span><span class="op" id="3538547">)</span><span class="op" id="3538548">;</span>&nbsp;<span class="ident" id="3538550">ok</span>&nbsp;<span class="op" id="3538553">&amp;&amp;</span>&nbsp;<span class="ident" id="3538556">neterr</span><span class="op" id="3538562">.</span><span class="ident" id="3538563">Timeout</span><span class="op" id="3538570">(</span><span class="op" id="3538571">)</span>&nbsp;<span class="op" id="3538573">{</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3538579">break</span>&nbsp;<span class="comment" id="3538585">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3538603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3538608">io</span><span class="op" id="3538610">.</span><span class="ident" id="3538611">WriteString</span><span class="op" id="3538622">(</span><span class="ident" id="3538623">c</span><span class="op" id="3538624">.</span><span class="ident" id="3538625">rwc</span><span class="op" id="3538628">,</span>&nbsp;<span class="string" id="3538630">&#34;HTTP/1.1&nbsp;400&nbsp;Bad&nbsp;Request\r\n\r\n&#34;</span><span class="op" id="3538664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3538669">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3538677">}</span><br>
<span class="lineno">1185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3538682">//&nbsp;Expect&nbsp;100&nbsp;Continue&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3538715">req</span>&nbsp;<span class="op" id="3538719">:=</span>&nbsp;<span class="ident" id="3538722">w</span><span class="op" id="3538723">.</span><span class="ident" id="3538724">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3538730">if</span>&nbsp;<span class="ident" id="3538733">req</span><span class="op" id="3538736">.</span><span class="ident" id="3538737">expectsContinue</span><span class="op" id="3538752">(</span><span class="op" id="3538753">)</span>&nbsp;<span class="op" id="3538755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3538760">if</span>&nbsp;<span class="ident" id="3538763">req</span><span class="op" id="3538766">.</span><span class="ident" id="3538767">ProtoAtLeast</span><span class="op" id="3538779">(</span><span class="num" id="3538780">1</span><span class="op" id="3538781">,</span>&nbsp;<span class="num" id="3538783">1</span><span class="op" id="3538784">)</span>&nbsp;<span class="op" id="3538786">&amp;&amp;</span>&nbsp;<span class="ident" id="3538789">req</span><span class="op" id="3538792">.</span><span class="ident" id="3538793">ContentLength</span>&nbsp;<span class="op" id="3538807">!=</span>&nbsp;<span class="num" id="3538810">0</span>&nbsp;<span class="op" id="3538812">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3538818">//&nbsp;Wrap&nbsp;the&nbsp;Body&nbsp;reader&nbsp;with&nbsp;one&nbsp;that&nbsp;replies&nbsp;on&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3538886">req</span><span class="op" id="3538889">.</span><span class="ident" id="3538890">Body</span>&nbsp;<span class="op" id="3538895">=</span>&nbsp;<span class="op" id="3538897">&amp;</span><span class="ident" id="3538898">expectContinueReader</span><span class="op" id="3538918">{</span><span class="ident" id="3538919">readCloser</span><span class="op" id="3538929">:</span>&nbsp;<span class="ident" id="3538931">req</span><span class="op" id="3538934">.</span><span class="ident" id="3538935">Body</span><span class="op" id="3538939">,</span>&nbsp;<span class="ident" id="3538941">resp</span><span class="op" id="3538945">:</span>&nbsp;<span class="ident" id="3538947">w</span><span class="op" id="3538948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3538953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3538958">req</span><span class="op" id="3538961">.</span><span class="ident" id="3538962">Header</span><span class="op" id="3538968">.</span><span class="ident" id="3538969">Del</span><span class="op" id="3538972">(</span><span class="string" id="3538973">&#34;Expect&#34;</span><span class="op" id="3538981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3538985">}</span>&nbsp;<span class="keyword" id="3538987">else</span>&nbsp;<span class="keyword" id="3538992">if</span>&nbsp;<span class="ident" id="3538995">req</span><span class="op" id="3538998">.</span><span class="ident" id="3538999">Header</span><span class="op" id="3539005">.</span><span class="ident" id="3539006">get</span><span class="op" id="3539009">(</span><span class="string" id="3539010">&#34;Expect&#34;</span><span class="op" id="3539018">)</span>&nbsp;<span class="op" id="3539020">!=</span>&nbsp;<span class="string" id="3539023">&#34;&#34;</span>&nbsp;<span class="op" id="3539026">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3539031">w</span><span class="op" id="3539032">.</span><span class="ident" id="3539033">sendExpectationFailed</span><span class="op" id="3539054">(</span><span class="op" id="3539055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3539060">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3539068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3539073">//&nbsp;HTTP&nbsp;cannot&nbsp;have&nbsp;multiple&nbsp;simultaneous&nbsp;active&nbsp;requests.[*]</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3539137">//&nbsp;Until&nbsp;the&nbsp;server&nbsp;replies&nbsp;to&nbsp;this&nbsp;request,&nbsp;it&nbsp;can&#39;t&nbsp;read&nbsp;another,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3539207">//&nbsp;so&nbsp;we&nbsp;might&nbsp;as&nbsp;well&nbsp;run&nbsp;the&nbsp;handler&nbsp;in&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3539267">//&nbsp;[*]&nbsp;Not&nbsp;strictly&nbsp;true:&nbsp;HTTP&nbsp;pipelining.&nbsp;&nbsp;We&nbsp;could&nbsp;let&nbsp;them&nbsp;all&nbsp;process</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3539343">//&nbsp;in&nbsp;parallel&nbsp;even&nbsp;if&nbsp;their&nbsp;responses&nbsp;need&nbsp;to&nbsp;be&nbsp;serialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3539407">serverHandler</span><span class="op" id="3539420">{</span><span class="ident" id="3539421">c</span><span class="op" id="3539422">.</span><span class="ident" id="3539423">server</span><span class="op" id="3539429">}</span><span class="op" id="3539430">.</span><span class="ident" id="3539431">ServeHTTP</span><span class="op" id="3539440">(</span><span class="ident" id="3539441">w</span><span class="op" id="3539442">,</span>&nbsp;<span class="ident" id="3539444">w</span><span class="op" id="3539445">.</span><span class="ident" id="3539446">req</span><span class="op" id="3539449">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3539453">if</span>&nbsp;<span class="ident" id="3539456">c</span><span class="op" id="3539457">.</span><span class="ident" id="3539458">hijacked</span><span class="op" id="3539466">(</span><span class="op" id="3539467">)</span>&nbsp;<span class="op" id="3539469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3539474">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3539483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3539487">w</span><span class="op" id="3539488">.</span><span class="ident" id="3539489">finishRequest</span><span class="op" id="3539502">(</span><span class="op" id="3539503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3539507">if</span>&nbsp;<span class="ident" id="3539510">w</span><span class="op" id="3539511">.</span><span class="ident" id="3539512">closeAfterReply</span>&nbsp;<span class="op" id="3539528">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3539533">if</span>&nbsp;<span class="ident" id="3539536">w</span><span class="op" id="3539537">.</span><span class="ident" id="3539538">requestBodyLimitHit</span>&nbsp;<span class="op" id="3539558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3539564">c</span><span class="op" id="3539565">.</span><span class="ident" id="3539566">closeWriteAndWait</span><span class="op" id="3539583">(</span><span class="op" id="3539584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3539589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3539594">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3539602">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3539606">c</span><span class="op" id="3539607">.</span><span class="ident" id="3539608">setState</span><span class="op" id="3539616">(</span><span class="ident" id="3539617">c</span><span class="op" id="3539618">.</span><span class="ident" id="3539619">rwc</span><span class="op" id="3539622">,</span>&nbsp;<span class="ident" id="3539624">StateIdle</span><span class="op" id="3539633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3539636">}</span><br>
<span class="lineno"></span><span class="op" id="3539638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3539641">func</span>&nbsp;<span class="op" id="3539646">(</span><span class="ident" id="3539647">w</span>&nbsp;<span class="op" id="3539649">*</span><span class="ident" id="3539650">response</span><span class="op" id="3539658">)</span>&nbsp;<span class="ident" id="3539660">sendExpectationFailed</span><span class="op" id="3539681">(</span><span class="op" id="3539682">)</span>&nbsp;<span class="op" id="3539684">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3539687">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;ServeHTTP&nbsp;handlers&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3539737">//&nbsp;requests&nbsp;with&nbsp;non-standard&nbsp;expectation[s]?&nbsp;Seems</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3539790">//&nbsp;theoretical&nbsp;at&nbsp;best,&nbsp;and&nbsp;doesn&#39;t&nbsp;fit&nbsp;into&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3539840">//&nbsp;current&nbsp;ServeHTTP&nbsp;model&nbsp;anyway.&nbsp;&nbsp;We&#39;d&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3539890">//&nbsp;make&nbsp;the&nbsp;ResponseWriter&nbsp;an&nbsp;optional</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3539930">//&nbsp;&#34;ExpectReplier&#34;&nbsp;interface&nbsp;or&nbsp;something.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3539974">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3539978">//&nbsp;For&nbsp;now&nbsp;we&#39;ll&nbsp;just&nbsp;obey&nbsp;RFC&nbsp;2616&nbsp;14.20&nbsp;which&nbsp;says</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3540032">//&nbsp;&#34;If&nbsp;a&nbsp;server&nbsp;receives&nbsp;a&nbsp;request&nbsp;containing&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3540082">//&nbsp;Expect&nbsp;field&nbsp;that&nbsp;includes&nbsp;an&nbsp;expectation-</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3540129">//&nbsp;extension&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;support,&nbsp;it&nbsp;MUST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3540177">//&nbsp;respond&nbsp;with&nbsp;a&nbsp;417&nbsp;(Expectation&nbsp;Failed)&nbsp;status.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3540230">w</span><span class="op" id="3540231">.</span><span class="ident" id="3540232">Header</span><span class="op" id="3540238">(</span><span class="op" id="3540239">)</span><span class="op" id="3540240">.</span><span class="ident" id="3540241">Set</span><span class="op" id="3540244">(</span><span class="string" id="3540245">&#34;Connection&#34;</span><span class="op" id="3540257">,</span>&nbsp;<span class="string" id="3540259">&#34;close&#34;</span><span class="op" id="3540266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3540269">w</span><span class="op" id="3540270">.</span><span class="ident" id="3540271">WriteHeader</span><span class="op" id="3540282">(</span><span class="ident" id="3540283">StatusExpectationFailed</span><span class="op" id="3540306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3540309">w</span><span class="op" id="3540310">.</span><span class="ident" id="3540311">finishRequest</span><span class="op" id="3540324">(</span><span class="op" id="3540325">)</span><br>
<span class="lineno">1235</span><span class="op" id="3540327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3540330">//&nbsp;Hijack&nbsp;implements&nbsp;the&nbsp;Hijacker.Hijack&nbsp;method.&nbsp;Our&nbsp;response&nbsp;is&nbsp;both&nbsp;a&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3540417">//&nbsp;and&nbsp;a&nbsp;Hijacker.</span><br>
<span class="lineno"></span><span class="keyword" id="3540436">func</span>&nbsp;<span class="op" id="3540441">(</span><span class="ident" id="3540442">w</span>&nbsp;<span class="op" id="3540444">*</span><span class="ident" id="3540445">response</span><span class="op" id="3540453">)</span>&nbsp;<span class="ident" id="3540455">Hijack</span><span class="op" id="3540461">(</span><span class="op" id="3540462">)</span>&nbsp;<span class="op" id="3540464">(</span><span class="ident" id="3540465">rwc</span>&nbsp;<span class="ident" id="3540469">net</span><span class="op" id="3540472">.</span><span class="ident" id="3540473">Conn</span><span class="op" id="3540477">,</span>&nbsp;<span class="ident" id="3540479">buf</span>&nbsp;<span class="op" id="3540483">*</span><span class="ident" id="3540484">bufio</span><span class="op" id="3540489">.</span><span class="ident" id="3540490">ReadWriter</span><span class="op" id="3540500">,</span>&nbsp;<span class="ident" id="3540502">err</span>&nbsp;<span class="builtintype" id="3540506">error</span><span class="op" id="3540511">)</span>&nbsp;<span class="op" id="3540513">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3540516">if</span>&nbsp;<span class="ident" id="3540519">w</span><span class="op" id="3540520">.</span><span class="ident" id="3540521">wroteHeader</span>&nbsp;<span class="op" id="3540533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3540537">w</span><span class="op" id="3540538">.</span><span class="ident" id="3540539">cw</span><span class="op" id="3540541">.</span><span class="ident" id="3540542">flush</span><span class="op" id="3540547">(</span><span class="op" id="3540548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3540551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3540554">//&nbsp;Release&nbsp;the&nbsp;bufioWriter&nbsp;that&nbsp;writes&nbsp;to&nbsp;the&nbsp;chunk&nbsp;writer,&nbsp;it&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3540625">//&nbsp;used&nbsp;after&nbsp;a&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3540672">rwc</span><span class="op" id="3540675">,</span>&nbsp;<span class="ident" id="3540677">buf</span><span class="op" id="3540680">,</span>&nbsp;<span class="ident" id="3540682">err</span>&nbsp;<span class="op" id="3540686">=</span>&nbsp;<span class="ident" id="3540688">w</span><span class="op" id="3540689">.</span><span class="ident" id="3540690">conn</span><span class="op" id="3540694">.</span><span class="ident" id="3540695">hijack</span><span class="op" id="3540701">(</span><span class="op" id="3540702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3540705">if</span>&nbsp;<span class="ident" id="3540708">err</span>&nbsp;<span class="op" id="3540712">==</span>&nbsp;<span class="ident" id="3540715">nil</span>&nbsp;<span class="op" id="3540719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3540723">putBufioWriter</span><span class="op" id="3540737">(</span><span class="ident" id="3540738">w</span><span class="op" id="3540739">.</span><span class="ident" id="3540740">w</span><span class="op" id="3540741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3540745">w</span><span class="op" id="3540746">.</span><span class="ident" id="3540747">w</span>&nbsp;<span class="op" id="3540749">=</span>&nbsp;<span class="ident" id="3540751">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3540756">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3540759">return</span>&nbsp;<span class="ident" id="3540766">rwc</span><span class="op" id="3540769">,</span>&nbsp;<span class="ident" id="3540771">buf</span><span class="op" id="3540774">,</span>&nbsp;<span class="ident" id="3540776">err</span><br>
<span class="lineno"></span><span class="op" id="3540780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3540783">func</span>&nbsp;<span class="op" id="3540788">(</span><span class="ident" id="3540789">w</span>&nbsp;<span class="op" id="3540791">*</span><span class="ident" id="3540792">response</span><span class="op" id="3540800">)</span>&nbsp;<span class="ident" id="3540802">CloseNotify</span><span class="op" id="3540813">(</span><span class="op" id="3540814">)</span>&nbsp;<span class="op" id="3540816">&lt;-</span><span class="keyword" id="3540818">chan</span>&nbsp;<span class="builtintype" id="3540823">bool</span>&nbsp;<span class="op" id="3540828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3540831">return</span>&nbsp;<span class="ident" id="3540838">w</span><span class="op" id="3540839">.</span><span class="ident" id="3540840">conn</span><span class="op" id="3540844">.</span><span class="ident" id="3540845">closeNotify</span><span class="op" id="3540856">(</span><span class="op" id="3540857">)</span><br>
<span class="lineno">1255</span><span class="op" id="3540859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3540862">//&nbsp;The&nbsp;HandlerFunc&nbsp;type&nbsp;is&nbsp;an&nbsp;adapter&nbsp;to&nbsp;allow&nbsp;the&nbsp;use&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3540920">//&nbsp;ordinary&nbsp;functions&nbsp;as&nbsp;HTTP&nbsp;handlers.&nbsp;&nbsp;If&nbsp;f&nbsp;is&nbsp;a&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="3540980">//&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;signature,&nbsp;HandlerFunc(f)&nbsp;is&nbsp;a</span><br>
<span class="lineno">1260</span><span class="comment" id="3541035">//&nbsp;Handler&nbsp;object&nbsp;that&nbsp;calls&nbsp;f.</span><br>
<span class="lineno"></span><span class="keyword" id="3541067">type</span>&nbsp;<span class="ident" id="3541072">HandlerFunc</span>&nbsp;<span class="keyword" id="3541084">func</span><span class="op" id="3541088">(</span><span class="ident" id="3541089">ResponseWriter</span><span class="op" id="3541103">,</span>&nbsp;<span class="op" id="3541105">*</span><span class="ident" id="3541106">Request</span><span class="op" id="3541113">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3541116">//&nbsp;ServeHTTP&nbsp;calls&nbsp;f(w,&nbsp;r).</span><br>
<span class="lineno"></span><span class="keyword" id="3541144">func</span>&nbsp;<span class="op" id="3541149">(</span><span class="ident" id="3541150">f</span>&nbsp;<span class="ident" id="3541152">HandlerFunc</span><span class="op" id="3541163">)</span>&nbsp;<span class="ident" id="3541165">ServeHTTP</span><span class="op" id="3541174">(</span><span class="ident" id="3541175">w</span>&nbsp;<span class="ident" id="3541177">ResponseWriter</span><span class="op" id="3541191">,</span>&nbsp;<span class="ident" id="3541193">r</span>&nbsp;<span class="op" id="3541195">*</span><span class="ident" id="3541196">Request</span><span class="op" id="3541203">)</span>&nbsp;<span class="op" id="3541205">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3541208">f</span><span class="op" id="3541209">(</span><span class="ident" id="3541210">w</span><span class="op" id="3541211">,</span>&nbsp;<span class="ident" id="3541213">r</span><span class="op" id="3541214">)</span><br>
<span class="lineno"></span><span class="op" id="3541216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3541219">//&nbsp;Helper&nbsp;handlers</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="3541239">//&nbsp;Error&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;specified&nbsp;error&nbsp;message&nbsp;and&nbsp;HTTP&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="3541319">//&nbsp;The&nbsp;error&nbsp;message&nbsp;should&nbsp;be&nbsp;plain&nbsp;text.</span><br>
<span class="lineno"></span><span class="keyword" id="3541362">func</span>&nbsp;<span class="ident" id="3541367">Error</span><span class="op" id="3541372">(</span><span class="ident" id="3541373">w</span>&nbsp;<span class="ident" id="3541375">ResponseWriter</span><span class="op" id="3541389">,</span>&nbsp;<span class="builtintype" id="3541391">error</span>&nbsp;<span class="builtintype" id="3541397">string</span><span class="op" id="3541403">,</span>&nbsp;<span class="ident" id="3541405">code</span>&nbsp;<span class="builtintype" id="3541410">int</span><span class="op" id="3541413">)</span>&nbsp;<span class="op" id="3541415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3541418">w</span><span class="op" id="3541419">.</span><span class="ident" id="3541420">Header</span><span class="op" id="3541426">(</span><span class="op" id="3541427">)</span><span class="op" id="3541428">.</span><span class="ident" id="3541429">Set</span><span class="op" id="3541432">(</span><span class="string" id="3541433">&#34;Content-Type&#34;</span><span class="op" id="3541447">,</span>&nbsp;<span class="string" id="3541449">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="3541476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3541479">w</span><span class="op" id="3541480">.</span><span class="ident" id="3541481">WriteHeader</span><span class="op" id="3541492">(</span><span class="ident" id="3541493">code</span><span class="op" id="3541497">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3541500">fmt</span><span class="op" id="3541503">.</span><span class="ident" id="3541504">Fprintln</span><span class="op" id="3541512">(</span><span class="ident" id="3541513">w</span><span class="op" id="3541514">,</span>&nbsp;<span class="builtintype" id="3541516">error</span><span class="op" id="3541521">)</span><br>
<span class="lineno"></span><span class="op" id="3541523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3541526">//&nbsp;NotFound&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3541595">func</span>&nbsp;<span class="ident" id="3541600">NotFound</span><span class="op" id="3541608">(</span><span class="ident" id="3541609">w</span>&nbsp;<span class="ident" id="3541611">ResponseWriter</span><span class="op" id="3541625">,</span>&nbsp;<span class="ident" id="3541627">r</span>&nbsp;<span class="op" id="3541629">*</span><span class="ident" id="3541630">Request</span><span class="op" id="3541637">)</span>&nbsp;<span class="op" id="3541639">{</span>&nbsp;<span class="ident" id="3541641">Error</span><span class="op" id="3541646">(</span><span class="ident" id="3541647">w</span><span class="op" id="3541648">,</span>&nbsp;<span class="string" id="3541650">&#34;404&nbsp;page&nbsp;not&nbsp;found&#34;</span><span class="op" id="3541670">,</span>&nbsp;<span class="ident" id="3541672">StatusNotFound</span><span class="op" id="3541686">)</span>&nbsp;<span class="op" id="3541688">}</span><br>
<span class="lineno">1280</span><br>
<span class="lineno"></span><span class="comment" id="3541691">//&nbsp;NotFoundHandler&nbsp;returns&nbsp;a&nbsp;simple&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="3541743">//&nbsp;that&nbsp;replies&nbsp;to&nbsp;each&nbsp;request&nbsp;with&nbsp;a&nbsp;``404&nbsp;page&nbsp;not&nbsp;found&#39;&#39;&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="3541812">func</span>&nbsp;<span class="ident" id="3541817">NotFoundHandler</span><span class="op" id="3541832">(</span><span class="op" id="3541833">)</span>&nbsp;<span class="ident" id="3541835">Handler</span>&nbsp;<span class="op" id="3541843">{</span>&nbsp;<span class="keyword" id="3541845">return</span>&nbsp;<span class="ident" id="3541852">HandlerFunc</span><span class="op" id="3541863">(</span><span class="ident" id="3541864">NotFound</span><span class="op" id="3541872">)</span>&nbsp;<span class="op" id="3541874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span><span class="comment" id="3541877">//&nbsp;StripPrefix&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3541936">//&nbsp;by&nbsp;removing&nbsp;the&nbsp;given&nbsp;prefix&nbsp;from&nbsp;the&nbsp;request&nbsp;URL&#39;s&nbsp;Path</span><br>
<span class="lineno"></span><span class="comment" id="3541996">//&nbsp;and&nbsp;invoking&nbsp;the&nbsp;handler&nbsp;h.&nbsp;StripPrefix&nbsp;handles&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3542049">//&nbsp;request&nbsp;for&nbsp;a&nbsp;path&nbsp;that&nbsp;doesn&#39;t&nbsp;begin&nbsp;with&nbsp;prefix&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3542105">//&nbsp;replying&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno">1290</span><span class="keyword" id="3542151">func</span>&nbsp;<span class="ident" id="3542156">StripPrefix</span><span class="op" id="3542167">(</span><span class="ident" id="3542168">prefix</span>&nbsp;<span class="builtintype" id="3542175">string</span><span class="op" id="3542181">,</span>&nbsp;<span class="ident" id="3542183">h</span>&nbsp;<span class="ident" id="3542185">Handler</span><span class="op" id="3542192">)</span>&nbsp;<span class="ident" id="3542194">Handler</span>&nbsp;<span class="op" id="3542202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3542205">if</span>&nbsp;<span class="ident" id="3542208">prefix</span>&nbsp;<span class="op" id="3542215">==</span>&nbsp;<span class="string" id="3542218">&#34;&#34;</span>&nbsp;<span class="op" id="3542221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3542225">return</span>&nbsp;<span class="ident" id="3542232">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3542235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3542238">return</span>&nbsp;<span class="ident" id="3542245">HandlerFunc</span><span class="op" id="3542256">(</span><span class="keyword" id="3542257">func</span><span class="op" id="3542261">(</span><span class="ident" id="3542262">w</span>&nbsp;<span class="ident" id="3542264">ResponseWriter</span><span class="op" id="3542278">,</span>&nbsp;<span class="ident" id="3542280">r</span>&nbsp;<span class="op" id="3542282">*</span><span class="ident" id="3542283">Request</span><span class="op" id="3542290">)</span>&nbsp;<span class="op" id="3542292">{</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3542296">if</span>&nbsp;<span class="ident" id="3542299">p</span>&nbsp;<span class="op" id="3542301">:=</span>&nbsp;<span class="ident" id="3542304">strings</span><span class="op" id="3542311">.</span><span class="ident" id="3542312">TrimPrefix</span><span class="op" id="3542322">(</span><span class="ident" id="3542323">r</span><span class="op" id="3542324">.</span><span class="ident" id="3542325">URL</span><span class="op" id="3542328">.</span><span class="ident" id="3542329">Path</span><span class="op" id="3542333">,</span>&nbsp;<span class="ident" id="3542335">prefix</span><span class="op" id="3542341">)</span><span class="op" id="3542342">;</span>&nbsp;<span class="builtinfunc" id="3542344">len</span><span class="op" id="3542347">(</span><span class="ident" id="3542348">p</span><span class="op" id="3542349">)</span>&nbsp;<span class="op" id="3542351">&lt;</span>&nbsp;<span class="builtinfunc" id="3542353">len</span><span class="op" id="3542356">(</span><span class="ident" id="3542357">r</span><span class="op" id="3542358">.</span><span class="ident" id="3542359">URL</span><span class="op" id="3542362">.</span><span class="ident" id="3542363">Path</span><span class="op" id="3542367">)</span>&nbsp;<span class="op" id="3542369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3542374">r</span><span class="op" id="3542375">.</span><span class="ident" id="3542376">URL</span><span class="op" id="3542379">.</span><span class="ident" id="3542380">Path</span>&nbsp;<span class="op" id="3542385">=</span>&nbsp;<span class="ident" id="3542387">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3542392">h</span><span class="op" id="3542393">.</span><span class="ident" id="3542394">ServeHTTP</span><span class="op" id="3542403">(</span><span class="ident" id="3542404">w</span><span class="op" id="3542405">,</span>&nbsp;<span class="ident" id="3542407">r</span><span class="op" id="3542408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3542412">}</span>&nbsp;<span class="keyword" id="3542414">else</span>&nbsp;<span class="op" id="3542419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3542424">NotFound</span><span class="op" id="3542432">(</span><span class="ident" id="3542433">w</span><span class="op" id="3542434">,</span>&nbsp;<span class="ident" id="3542436">r</span><span class="op" id="3542437">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3542441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3542444">}</span><span class="op" id="3542445">)</span><br>
<span class="lineno"></span><span class="op" id="3542447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3542450">//&nbsp;Redirect&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;a&nbsp;redirect&nbsp;to&nbsp;url,</span><br>
<span class="lineno">1305</span><span class="comment" id="3542509">//&nbsp;which&nbsp;may&nbsp;be&nbsp;a&nbsp;path&nbsp;relative&nbsp;to&nbsp;the&nbsp;request&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="3542562">func</span>&nbsp;<span class="ident" id="3542567">Redirect</span><span class="op" id="3542575">(</span><span class="ident" id="3542576">w</span>&nbsp;<span class="ident" id="3542578">ResponseWriter</span><span class="op" id="3542592">,</span>&nbsp;<span class="ident" id="3542594">r</span>&nbsp;<span class="op" id="3542596">*</span><span class="ident" id="3542597">Request</span><span class="op" id="3542604">,</span>&nbsp;<span class="ident" id="3542606">urlStr</span>&nbsp;<span class="builtintype" id="3542613">string</span><span class="op" id="3542619">,</span>&nbsp;<span class="ident" id="3542621">code</span>&nbsp;<span class="builtintype" id="3542626">int</span><span class="op" id="3542629">)</span>&nbsp;<span class="op" id="3542631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3542634">if</span>&nbsp;<span class="ident" id="3542637">u</span><span class="op" id="3542638">,</span>&nbsp;<span class="ident" id="3542640">err</span>&nbsp;<span class="op" id="3542644">:=</span>&nbsp;<span class="ident" id="3542647">url</span><span class="op" id="3542650">.</span><span class="ident" id="3542651">Parse</span><span class="op" id="3542656">(</span><span class="ident" id="3542657">urlStr</span><span class="op" id="3542663">)</span><span class="op" id="3542664">;</span>&nbsp;<span class="ident" id="3542666">err</span>&nbsp;<span class="op" id="3542670">==</span>&nbsp;<span class="ident" id="3542673">nil</span>&nbsp;<span class="op" id="3542677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3542681">//&nbsp;If&nbsp;url&nbsp;was&nbsp;relative,&nbsp;make&nbsp;absolute&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3542724">//&nbsp;combining&nbsp;with&nbsp;request&nbsp;path.</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3542758">//&nbsp;The&nbsp;browser&nbsp;would&nbsp;probably&nbsp;do&nbsp;this&nbsp;for&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3542806">//&nbsp;but&nbsp;doing&nbsp;it&nbsp;ourselves&nbsp;is&nbsp;more&nbsp;reliable.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3542853">//&nbsp;NOTE(rsc):&nbsp;RFC&nbsp;2616&nbsp;says&nbsp;that&nbsp;the&nbsp;Location</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3542901">//&nbsp;line&nbsp;must&nbsp;be&nbsp;an&nbsp;absolute&nbsp;URI,&nbsp;like</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3542941">//&nbsp;&#34;http://www.google.com/redirect/&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3542981">//&nbsp;not&nbsp;a&nbsp;path&nbsp;like&nbsp;&#34;/redirect/&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3543016">//&nbsp;Unfortunately,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3543058">//&nbsp;put&nbsp;in&nbsp;the&nbsp;host&nbsp;name&nbsp;section&nbsp;to&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3543103">//&nbsp;client&nbsp;to&nbsp;connect&nbsp;to&nbsp;us&nbsp;again,&nbsp;so&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3543151">//&nbsp;know&nbsp;the&nbsp;right&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;send&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3543198">//&nbsp;Because&nbsp;of&nbsp;this&nbsp;problem,&nbsp;no&nbsp;one&nbsp;pays&nbsp;attention</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3543250">//&nbsp;to&nbsp;the&nbsp;RFC;&nbsp;they&nbsp;all&nbsp;send&nbsp;back&nbsp;just&nbsp;a&nbsp;new&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3543303">//&nbsp;So&nbsp;do&nbsp;we.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3543318">oldpath</span>&nbsp;<span class="op" id="3543326">:=</span>&nbsp;<span class="ident" id="3543329">r</span><span class="op" id="3543330">.</span><span class="ident" id="3543331">URL</span><span class="op" id="3543334">.</span><span class="ident" id="3543335">Path</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3543342">if</span>&nbsp;<span class="ident" id="3543345">oldpath</span>&nbsp;<span class="op" id="3543353">==</span>&nbsp;<span class="string" id="3543356">&#34;&#34;</span>&nbsp;<span class="op" id="3543359">{</span>&nbsp;<span class="comment" id="3543361">//&nbsp;should&nbsp;not&nbsp;happen,&nbsp;but&nbsp;avoid&nbsp;a&nbsp;crash&nbsp;if&nbsp;it&nbsp;does</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3543415">oldpath</span>&nbsp;<span class="op" id="3543423">=</span>&nbsp;<span class="string" id="3543425">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3543431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3543435">if</span>&nbsp;<span class="ident" id="3543438">u</span><span class="op" id="3543439">.</span><span class="ident" id="3543440">Scheme</span>&nbsp;<span class="op" id="3543447">==</span>&nbsp;<span class="string" id="3543450">&#34;&#34;</span>&nbsp;<span class="op" id="3543453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3543458">//&nbsp;no&nbsp;leading&nbsp;http://server</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3543489">if</span>&nbsp;<span class="ident" id="3543492">urlStr</span>&nbsp;<span class="op" id="3543499">==</span>&nbsp;<span class="string" id="3543502">&#34;&#34;</span>&nbsp;<span class="op" id="3543505">||</span>&nbsp;<span class="ident" id="3543508">urlStr</span><span class="op" id="3543514">[</span><span class="num" id="3543515">0</span><span class="op" id="3543516">]</span>&nbsp;<span class="op" id="3543518">!=</span>&nbsp;<span class="string" id="3543521">&#39;/&#39;</span>&nbsp;<span class="op" id="3543525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3543531">//&nbsp;make&nbsp;relative&nbsp;path&nbsp;absolute</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3543566">olddir</span><span class="op" id="3543572">,</span>&nbsp;<span class="ident" id="3543574">_</span>&nbsp;<span class="op" id="3543576">:=</span>&nbsp;<span class="ident" id="3543579">path</span><span class="op" id="3543583">.</span><span class="ident" id="3543584">Split</span><span class="op" id="3543589">(</span><span class="ident" id="3543590">oldpath</span><span class="op" id="3543597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3543603">urlStr</span>&nbsp;<span class="op" id="3543610">=</span>&nbsp;<span class="ident" id="3543612">olddir</span>&nbsp;<span class="op" id="3543619">+</span>&nbsp;<span class="ident" id="3543621">urlStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3543631">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3543637">var</span>&nbsp;<span class="ident" id="3543641">query</span>&nbsp;<span class="builtintype" id="3543647">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3543657">if</span>&nbsp;<span class="ident" id="3543660">i</span>&nbsp;<span class="op" id="3543662">:=</span>&nbsp;<span class="ident" id="3543665">strings</span><span class="op" id="3543672">.</span><span class="ident" id="3543673">Index</span><span class="op" id="3543678">(</span><span class="ident" id="3543679">urlStr</span><span class="op" id="3543685">,</span>&nbsp;<span class="string" id="3543687">&#34;?&#34;</span><span class="op" id="3543690">)</span><span class="op" id="3543691">;</span>&nbsp;<span class="ident" id="3543693">i</span>&nbsp;<span class="op" id="3543695">!=</span>&nbsp;<span class="op" id="3543698">-</span><span class="num" id="3543699">1</span>&nbsp;<span class="op" id="3543701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3543707">urlStr</span><span class="op" id="3543713">,</span>&nbsp;<span class="ident" id="3543715">query</span>&nbsp;<span class="op" id="3543721">=</span>&nbsp;<span class="ident" id="3543723">urlStr</span><span class="op" id="3543729">[</span><span class="op" id="3543730">:</span><span class="ident" id="3543731">i</span><span class="op" id="3543732">]</span><span class="op" id="3543733">,</span>&nbsp;<span class="ident" id="3543735">urlStr</span><span class="op" id="3543741">[</span><span class="ident" id="3543742">i</span><span class="op" id="3543743">:</span><span class="op" id="3543744">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3543749">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3543755">//&nbsp;clean&nbsp;up&nbsp;but&nbsp;preserve&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3543798">trailing</span>&nbsp;<span class="op" id="3543807">:=</span>&nbsp;<span class="ident" id="3543810">strings</span><span class="op" id="3543817">.</span><span class="ident" id="3543818">HasSuffix</span><span class="op" id="3543827">(</span><span class="ident" id="3543828">urlStr</span><span class="op" id="3543834">,</span>&nbsp;<span class="string" id="3543836">&#34;/&#34;</span><span class="op" id="3543839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3543844">urlStr</span>&nbsp;<span class="op" id="3543851">=</span>&nbsp;<span class="ident" id="3543853">path</span><span class="op" id="3543857">.</span><span class="ident" id="3543858">Clean</span><span class="op" id="3543863">(</span><span class="ident" id="3543864">urlStr</span><span class="op" id="3543870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3543875">if</span>&nbsp;<span class="ident" id="3543878">trailing</span>&nbsp;<span class="op" id="3543887">&amp;&amp;</span>&nbsp;<span class="op" id="3543890">!</span><span class="ident" id="3543891">strings</span><span class="op" id="3543898">.</span><span class="ident" id="3543899">HasSuffix</span><span class="op" id="3543908">(</span><span class="ident" id="3543909">urlStr</span><span class="op" id="3543915">,</span>&nbsp;<span class="string" id="3543917">&#34;/&#34;</span><span class="op" id="3543920">)</span>&nbsp;<span class="op" id="3543922">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3543928">urlStr</span>&nbsp;<span class="op" id="3543935">+=</span>&nbsp;<span class="string" id="3543938">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3543945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3543950">urlStr</span>&nbsp;<span class="op" id="3543957">+=</span>&nbsp;<span class="ident" id="3543960">query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3543968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3543971">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3543975">w</span><span class="op" id="3543976">.</span><span class="ident" id="3543977">Header</span><span class="op" id="3543983">(</span><span class="op" id="3543984">)</span><span class="op" id="3543985">.</span><span class="ident" id="3543986">Set</span><span class="op" id="3543989">(</span><span class="string" id="3543990">&#34;Location&#34;</span><span class="op" id="3544000">,</span>&nbsp;<span class="ident" id="3544002">urlStr</span><span class="op" id="3544008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3544011">w</span><span class="op" id="3544012">.</span><span class="ident" id="3544013">WriteHeader</span><span class="op" id="3544024">(</span><span class="ident" id="3544025">code</span><span class="op" id="3544029">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3544033">//&nbsp;RFC2616&nbsp;recommends&nbsp;that&nbsp;a&nbsp;short&nbsp;note&nbsp;&#34;SHOULD&#34;&nbsp;be&nbsp;included&nbsp;in&nbsp;the</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3544102">//&nbsp;response&nbsp;because&nbsp;older&nbsp;user&nbsp;agents&nbsp;may&nbsp;not&nbsp;understand&nbsp;301/307.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3544169">//&nbsp;Shouldn&#39;t&nbsp;send&nbsp;the&nbsp;response&nbsp;for&nbsp;POST&nbsp;or&nbsp;HEAD;&nbsp;that&nbsp;leaves&nbsp;GET.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3544236">if</span>&nbsp;<span class="ident" id="3544239">r</span><span class="op" id="3544240">.</span><span class="ident" id="3544241">Method</span>&nbsp;<span class="op" id="3544248">==</span>&nbsp;<span class="string" id="3544251">&#34;GET&#34;</span>&nbsp;<span class="op" id="3544257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3544261">note</span>&nbsp;<span class="op" id="3544266">:=</span>&nbsp;<span class="string" id="3544269">&#34;&lt;a&nbsp;href=\&#34;&#34;</span>&nbsp;<span class="op" id="3544282">+</span>&nbsp;<span class="ident" id="3544284">htmlEscape</span><span class="op" id="3544294">(</span><span class="ident" id="3544295">urlStr</span><span class="op" id="3544301">)</span>&nbsp;<span class="op" id="3544303">+</span>&nbsp;<span class="string" id="3544305">&#34;\&#34;&gt;&#34;</span>&nbsp;<span class="op" id="3544311">+</span>&nbsp;<span class="ident" id="3544313">statusText</span><span class="op" id="3544323">[</span><span class="ident" id="3544324">code</span><span class="op" id="3544328">]</span>&nbsp;<span class="op" id="3544330">+</span>&nbsp;<span class="string" id="3544332">&#34;&lt;/a&gt;.\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3544344">fmt</span><span class="op" id="3544347">.</span><span class="ident" id="3544348">Fprintln</span><span class="op" id="3544356">(</span><span class="ident" id="3544357">w</span><span class="op" id="3544358">,</span>&nbsp;<span class="ident" id="3544360">note</span><span class="op" id="3544364">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3544367">}</span><br>
<span class="lineno"></span><span class="op" id="3544369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3544372">var</span>&nbsp;<span class="ident" id="3544376">htmlReplacer</span>&nbsp;<span class="op" id="3544389">=</span>&nbsp;<span class="ident" id="3544391">strings</span><span class="op" id="3544398">.</span><span class="ident" id="3544399">NewReplacer</span><span class="op" id="3544410">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3544413">&#34;&amp;&#34;</span><span class="op" id="3544416">,</span>&nbsp;<span class="string" id="3544418">&#34;&amp;amp;&#34;</span><span class="op" id="3544425">,</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3544428">&#34;&lt;&#34;</span><span class="op" id="3544431">,</span>&nbsp;<span class="string" id="3544433">&#34;&amp;lt;&#34;</span><span class="op" id="3544439">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3544442">&#34;&gt;&#34;</span><span class="op" id="3544445">,</span>&nbsp;<span class="string" id="3544447">&#34;&amp;gt;&#34;</span><span class="op" id="3544453">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3544456">//&nbsp;&#34;&amp;#34;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;quot;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3544494">`&#34;`</span><span class="op" id="3544497">,</span>&nbsp;<span class="string" id="3544499">&#34;&amp;#34;&#34;</span><span class="op" id="3544506">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3544509">//&nbsp;&#34;&amp;#39;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;apos;&#34;&nbsp;and&nbsp;apos&nbsp;was&nbsp;not&nbsp;in&nbsp;HTML&nbsp;until&nbsp;HTML5.</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3544584">&#34;&#39;&#34;</span><span class="op" id="3544587">,</span>&nbsp;<span class="string" id="3544589">&#34;&amp;#39;&#34;</span><span class="op" id="3544596">,</span><br>
<span class="lineno"></span><span class="op" id="3544598">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3544601">func</span>&nbsp;<span class="ident" id="3544606">htmlEscape</span><span class="op" id="3544616">(</span><span class="ident" id="3544617">s</span>&nbsp;<span class="builtintype" id="3544619">string</span><span class="op" id="3544625">)</span>&nbsp;<span class="builtintype" id="3544627">string</span>&nbsp;<span class="op" id="3544634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3544637">return</span>&nbsp;<span class="ident" id="3544644">htmlReplacer</span><span class="op" id="3544656">.</span><span class="ident" id="3544657">Replace</span><span class="op" id="3544664">(</span><span class="ident" id="3544665">s</span><span class="op" id="3544666">)</span><br>
<span class="lineno">1375</span><span class="op" id="3544668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3544671">//&nbsp;Redirect&nbsp;to&nbsp;a&nbsp;fixed&nbsp;URL</span><br>
<span class="lineno"></span><span class="keyword" id="3544698">type</span>&nbsp;<span class="ident" id="3544703">redirectHandler</span>&nbsp;<span class="keyword" id="3544719">struct</span>&nbsp;<span class="op" id="3544726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3544729">url</span>&nbsp;&nbsp;<span class="builtintype" id="3544734">string</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3544742">code</span>&nbsp;<span class="builtintype" id="3544747">int</span><br>
<span class="lineno"></span><span class="op" id="3544751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3544754">func</span>&nbsp;<span class="op" id="3544759">(</span><span class="ident" id="3544760">rh</span>&nbsp;<span class="op" id="3544763">*</span><span class="ident" id="3544764">redirectHandler</span><span class="op" id="3544779">)</span>&nbsp;<span class="ident" id="3544781">ServeHTTP</span><span class="op" id="3544790">(</span><span class="ident" id="3544791">w</span>&nbsp;<span class="ident" id="3544793">ResponseWriter</span><span class="op" id="3544807">,</span>&nbsp;<span class="ident" id="3544809">r</span>&nbsp;<span class="op" id="3544811">*</span><span class="ident" id="3544812">Request</span><span class="op" id="3544819">)</span>&nbsp;<span class="op" id="3544821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3544824">Redirect</span><span class="op" id="3544832">(</span><span class="ident" id="3544833">w</span><span class="op" id="3544834">,</span>&nbsp;<span class="ident" id="3544836">r</span><span class="op" id="3544837">,</span>&nbsp;<span class="ident" id="3544839">rh</span><span class="op" id="3544841">.</span><span class="ident" id="3544842">url</span><span class="op" id="3544845">,</span>&nbsp;<span class="ident" id="3544847">rh</span><span class="op" id="3544849">.</span><span class="ident" id="3544850">code</span><span class="op" id="3544854">)</span><br>
<span class="lineno">1385</span><span class="op" id="3544856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3544859">//&nbsp;RedirectHandler&nbsp;returns&nbsp;a&nbsp;request&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno"></span><span class="comment" id="3544919">//&nbsp;each&nbsp;request&nbsp;it&nbsp;receives&nbsp;to&nbsp;the&nbsp;given&nbsp;url&nbsp;using&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment" id="3544980">//&nbsp;status&nbsp;code.</span><br>
<span class="lineno">1390</span><span class="keyword" id="3544996">func</span>&nbsp;<span class="ident" id="3545001">RedirectHandler</span><span class="op" id="3545016">(</span><span class="ident" id="3545017">url</span>&nbsp;<span class="builtintype" id="3545021">string</span><span class="op" id="3545027">,</span>&nbsp;<span class="ident" id="3545029">code</span>&nbsp;<span class="builtintype" id="3545034">int</span><span class="op" id="3545037">)</span>&nbsp;<span class="ident" id="3545039">Handler</span>&nbsp;<span class="op" id="3545047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3545050">return</span>&nbsp;<span class="op" id="3545057">&amp;</span><span class="ident" id="3545058">redirectHandler</span><span class="op" id="3545073">{</span><span class="ident" id="3545074">url</span><span class="op" id="3545077">,</span>&nbsp;<span class="ident" id="3545079">code</span><span class="op" id="3545083">}</span><br>
<span class="lineno"></span><span class="op" id="3545085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3545088">//&nbsp;ServeMux&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;request&nbsp;multiplexer.</span><br>
<span class="lineno">1395</span><span class="comment" id="3545132">//&nbsp;It&nbsp;matches&nbsp;the&nbsp;URL&nbsp;of&nbsp;each&nbsp;incoming&nbsp;request&nbsp;against&nbsp;a&nbsp;list&nbsp;of&nbsp;registered</span><br>
<span class="lineno"></span><span class="comment" id="3545208">//&nbsp;patterns&nbsp;and&nbsp;calls&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;pattern&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3545263">//&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;URL.</span><br>
<span class="lineno"></span><span class="comment" id="3545296">//</span><br>
<span class="lineno"></span><span class="comment" id="3545299">//&nbsp;Patterns&nbsp;name&nbsp;fixed,&nbsp;rooted&nbsp;paths,&nbsp;like&nbsp;&#34;/favicon.ico&#34;,</span><br>
<span class="lineno">1400</span><span class="comment" id="3545358">//&nbsp;or&nbsp;rooted&nbsp;subtrees,&nbsp;like&nbsp;&#34;/images/&#34;&nbsp;(note&nbsp;the&nbsp;trailing&nbsp;slash).</span><br>
<span class="lineno"></span><span class="comment" id="3545424">//&nbsp;Longer&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over&nbsp;shorter&nbsp;ones,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3545486">//&nbsp;if&nbsp;there&nbsp;are&nbsp;handlers&nbsp;registered&nbsp;for&nbsp;both&nbsp;&#34;/images/&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3545542">//&nbsp;and&nbsp;&#34;/images/thumbnails/&#34;,&nbsp;the&nbsp;latter&nbsp;handler&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3545599">//&nbsp;called&nbsp;for&nbsp;paths&nbsp;beginning&nbsp;&#34;/images/thumbnails/&#34;&nbsp;and&nbsp;the</span><br>
<span class="lineno">1405</span><span class="comment" id="3545659">//&nbsp;former&nbsp;will&nbsp;receive&nbsp;requests&nbsp;for&nbsp;any&nbsp;other&nbsp;paths&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3545718">//&nbsp;&#34;/images/&#34;&nbsp;subtree.</span><br>
<span class="lineno"></span><span class="comment" id="3545741">//</span><br>
<span class="lineno"></span><span class="comment" id="3545744">//&nbsp;Note&nbsp;that&nbsp;since&nbsp;a&nbsp;pattern&nbsp;ending&nbsp;in&nbsp;a&nbsp;slash&nbsp;names&nbsp;a&nbsp;rooted&nbsp;subtree,</span><br>
<span class="lineno"></span><span class="comment" id="3545815">//&nbsp;the&nbsp;pattern&nbsp;&#34;/&#34;&nbsp;matches&nbsp;all&nbsp;paths&nbsp;not&nbsp;matched&nbsp;by&nbsp;other&nbsp;registered</span><br>
<span class="lineno">1410</span><span class="comment" id="3545884">//&nbsp;patterns,&nbsp;not&nbsp;just&nbsp;the&nbsp;URL&nbsp;with&nbsp;Path&nbsp;==&nbsp;&#34;/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3545932">//</span><br>
<span class="lineno"></span><span class="comment" id="3545935">//&nbsp;Patterns&nbsp;may&nbsp;optionally&nbsp;begin&nbsp;with&nbsp;a&nbsp;host&nbsp;name,&nbsp;restricting&nbsp;matches&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3546009">//&nbsp;URLs&nbsp;on&nbsp;that&nbsp;host&nbsp;only.&nbsp;&nbsp;Host-specific&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3546081">//&nbsp;general&nbsp;patterns,&nbsp;so&nbsp;that&nbsp;a&nbsp;handler&nbsp;might&nbsp;register&nbsp;for&nbsp;the&nbsp;two&nbsp;patterns</span><br>
<span class="lineno">1415</span><span class="comment" id="3546156">//&nbsp;&#34;/codesearch&#34;&nbsp;and&nbsp;&#34;codesearch.google.com/&#34;&nbsp;without&nbsp;also&nbsp;taking&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3546227">//&nbsp;requests&nbsp;for&nbsp;&#34;http://www.google.com/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3546269">//</span><br>
<span class="lineno"></span><span class="comment" id="3546272">//&nbsp;ServeMux&nbsp;also&nbsp;takes&nbsp;care&nbsp;of&nbsp;sanitizing&nbsp;the&nbsp;URL&nbsp;request&nbsp;path,</span><br>
<span class="lineno"></span><span class="comment" id="3546336">//&nbsp;redirecting&nbsp;any&nbsp;request&nbsp;containing&nbsp;.&nbsp;or&nbsp;..&nbsp;elements&nbsp;to&nbsp;an</span><br>
<span class="lineno">1420</span><span class="comment" id="3546397">//&nbsp;equivalent&nbsp;.-&nbsp;and&nbsp;..-free&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3546431">type</span>&nbsp;<span class="ident" id="3546436">ServeMux</span>&nbsp;<span class="keyword" id="3546445">struct</span>&nbsp;<span class="op" id="3546452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3546455">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3546461">sync</span><span class="op" id="3546465">.</span><span class="ident" id="3546466">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3546475">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3546481">map</span><span class="op" id="3546484">[</span><span class="builtintype" id="3546485">string</span><span class="op" id="3546491">]</span><span class="ident" id="3546492">muxEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3546502">hosts</span>&nbsp;<span class="builtintype" id="3546508">bool</span>&nbsp;<span class="comment" id="3546513">//&nbsp;whether&nbsp;any&nbsp;patterns&nbsp;contain&nbsp;hostnames</span><br>
<span class="lineno">1425</span><span class="op" id="3546555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3546558">type</span>&nbsp;<span class="ident" id="3546563">muxEntry</span>&nbsp;<span class="keyword" id="3546572">struct</span>&nbsp;<span class="op" id="3546579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3546582">explicit</span>&nbsp;<span class="builtintype" id="3546591">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3546597">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3546606">Handler</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3546615">pattern</span>&nbsp;&nbsp;<span class="builtintype" id="3546624">string</span><br>
<span class="lineno"></span><span class="op" id="3546631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3546634">//&nbsp;NewServeMux&nbsp;allocates&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="3546687">func</span>&nbsp;<span class="ident" id="3546692">NewServeMux</span><span class="op" id="3546703">(</span><span class="op" id="3546704">)</span>&nbsp;<span class="op" id="3546706">*</span><span class="ident" id="3546707">ServeMux</span>&nbsp;<span class="op" id="3546716">{</span>&nbsp;<span class="keyword" id="3546718">return</span>&nbsp;<span class="op" id="3546725">&amp;</span><span class="ident" id="3546726">ServeMux</span><span class="op" id="3546734">{</span><span class="ident" id="3546735">m</span><span class="op" id="3546736">:</span>&nbsp;<span class="builtinfunc" id="3546738">make</span><span class="op" id="3546742">(</span><span class="keyword" id="3546743">map</span><span class="op" id="3546746">[</span><span class="builtintype" id="3546747">string</span><span class="op" id="3546753">]</span><span class="ident" id="3546754">muxEntry</span><span class="op" id="3546762">)</span><span class="op" id="3546763">}</span>&nbsp;<span class="op" id="3546765">}</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span><span class="comment" id="3546768">//&nbsp;DefaultServeMux&nbsp;is&nbsp;the&nbsp;default&nbsp;ServeMux&nbsp;used&nbsp;by&nbsp;Serve.</span><br>
<span class="lineno"></span><span class="keyword" id="3546826">var</span>&nbsp;<span class="ident" id="3546830">DefaultServeMux</span>&nbsp;<span class="op" id="3546846">=</span>&nbsp;<span class="ident" id="3546848">NewServeMux</span><span class="op" id="3546859">(</span><span class="op" id="3546860">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3546863">//&nbsp;Does&nbsp;path&nbsp;match&nbsp;pattern?</span><br>
<span class="lineno">1440</span><span class="keyword" id="3546891">func</span>&nbsp;<span class="ident" id="3546896">pathMatch</span><span class="op" id="3546905">(</span><span class="ident" id="3546906">pattern</span><span class="op" id="3546913">,</span>&nbsp;<span class="ident" id="3546915">path</span>&nbsp;<span class="builtintype" id="3546920">string</span><span class="op" id="3546926">)</span>&nbsp;<span class="builtintype" id="3546928">bool</span>&nbsp;<span class="op" id="3546933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3546936">if</span>&nbsp;<span class="builtinfunc" id="3546939">len</span><span class="op" id="3546942">(</span><span class="ident" id="3546943">pattern</span><span class="op" id="3546950">)</span>&nbsp;<span class="op" id="3546952">==</span>&nbsp;<span class="num" id="3546955">0</span>&nbsp;<span class="op" id="3546957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3546961">//&nbsp;should&nbsp;not&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3546984">return</span>&nbsp;<span class="builtintype" id="3546991">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3546998">}</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3547001">n</span>&nbsp;<span class="op" id="3547003">:=</span>&nbsp;<span class="builtinfunc" id="3547006">len</span><span class="op" id="3547009">(</span><span class="ident" id="3547010">pattern</span><span class="op" id="3547017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3547020">if</span>&nbsp;<span class="ident" id="3547023">pattern</span><span class="op" id="3547030">[</span><span class="ident" id="3547031">n</span><span class="op" id="3547032">-</span><span class="num" id="3547033">1</span><span class="op" id="3547034">]</span>&nbsp;<span class="op" id="3547036">!=</span>&nbsp;<span class="string" id="3547039">&#39;/&#39;</span>&nbsp;<span class="op" id="3547043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3547047">return</span>&nbsp;<span class="ident" id="3547054">pattern</span>&nbsp;<span class="op" id="3547062">==</span>&nbsp;<span class="ident" id="3547065">path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3547071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3547074">return</span>&nbsp;<span class="builtinfunc" id="3547081">len</span><span class="op" id="3547084">(</span><span class="ident" id="3547085">path</span><span class="op" id="3547089">)</span>&nbsp;<span class="op" id="3547091">&gt;=</span>&nbsp;<span class="ident" id="3547094">n</span>&nbsp;<span class="op" id="3547096">&amp;&amp;</span>&nbsp;<span class="ident" id="3547099">path</span><span class="op" id="3547103">[</span><span class="num" id="3547104">0</span><span class="op" id="3547105">:</span><span class="ident" id="3547106">n</span><span class="op" id="3547107">]</span>&nbsp;<span class="op" id="3547109">==</span>&nbsp;<span class="ident" id="3547112">pattern</span><br>
<span class="lineno">1450</span><span class="op" id="3547120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3547123">//&nbsp;Return&nbsp;the&nbsp;canonical&nbsp;path&nbsp;for&nbsp;p,&nbsp;eliminating&nbsp;.&nbsp;and&nbsp;..&nbsp;elements.</span><br>
<span class="lineno"></span><span class="keyword" id="3547190">func</span>&nbsp;<span class="ident" id="3547195">cleanPath</span><span class="op" id="3547204">(</span><span class="ident" id="3547205">p</span>&nbsp;<span class="builtintype" id="3547207">string</span><span class="op" id="3547213">)</span>&nbsp;<span class="builtintype" id="3547215">string</span>&nbsp;<span class="op" id="3547222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3547225">if</span>&nbsp;<span class="ident" id="3547228">p</span>&nbsp;<span class="op" id="3547230">==</span>&nbsp;<span class="string" id="3547233">&#34;&#34;</span>&nbsp;<span class="op" id="3547236">{</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3547240">return</span>&nbsp;<span class="string" id="3547247">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3547252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3547255">if</span>&nbsp;<span class="ident" id="3547258">p</span><span class="op" id="3547259">[</span><span class="num" id="3547260">0</span><span class="op" id="3547261">]</span>&nbsp;<span class="op" id="3547263">!=</span>&nbsp;<span class="string" id="3547266">&#39;/&#39;</span>&nbsp;<span class="op" id="3547270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3547274">p</span>&nbsp;<span class="op" id="3547276">=</span>&nbsp;<span class="string" id="3547278">&#34;/&#34;</span>&nbsp;<span class="op" id="3547282">+</span>&nbsp;<span class="ident" id="3547284">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3547287">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3547290">np</span>&nbsp;<span class="op" id="3547293">:=</span>&nbsp;<span class="ident" id="3547296">path</span><span class="op" id="3547300">.</span><span class="ident" id="3547301">Clean</span><span class="op" id="3547306">(</span><span class="ident" id="3547307">p</span><span class="op" id="3547308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3547311">//&nbsp;path.Clean&nbsp;removes&nbsp;trailing&nbsp;slash&nbsp;except&nbsp;for&nbsp;root;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3547366">//&nbsp;put&nbsp;the&nbsp;trailing&nbsp;slash&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3547412">if</span>&nbsp;<span class="ident" id="3547415">p</span><span class="op" id="3547416">[</span><span class="builtinfunc" id="3547417">len</span><span class="op" id="3547420">(</span><span class="ident" id="3547421">p</span><span class="op" id="3547422">)</span><span class="op" id="3547423">-</span><span class="num" id="3547424">1</span><span class="op" id="3547425">]</span>&nbsp;<span class="op" id="3547427">==</span>&nbsp;<span class="string" id="3547430">&#39;/&#39;</span>&nbsp;<span class="op" id="3547434">&amp;&amp;</span>&nbsp;<span class="ident" id="3547437">np</span>&nbsp;<span class="op" id="3547440">!=</span>&nbsp;<span class="string" id="3547443">&#34;/&#34;</span>&nbsp;<span class="op" id="3547447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3547451">np</span>&nbsp;<span class="op" id="3547454">+=</span>&nbsp;<span class="string" id="3547457">&#34;/&#34;</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3547462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3547465">return</span>&nbsp;<span class="ident" id="3547472">np</span><br>
<span class="lineno"></span><span class="op" id="3547475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3547478">//&nbsp;Find&nbsp;a&nbsp;handler&nbsp;on&nbsp;a&nbsp;handler&nbsp;map&nbsp;given&nbsp;a&nbsp;path&nbsp;string</span><br>
<span class="lineno">1470</span><span class="comment" id="3547533">//&nbsp;Most-specific&nbsp;(longest)&nbsp;pattern&nbsp;wins</span><br>
<span class="lineno"></span><span class="keyword" id="3547573">func</span>&nbsp;<span class="op" id="3547578">(</span><span class="ident" id="3547579">mux</span>&nbsp;<span class="op" id="3547583">*</span><span class="ident" id="3547584">ServeMux</span><span class="op" id="3547592">)</span>&nbsp;<span class="ident" id="3547594">match</span><span class="op" id="3547599">(</span><span class="ident" id="3547600">path</span>&nbsp;<span class="builtintype" id="3547605">string</span><span class="op" id="3547611">)</span>&nbsp;<span class="op" id="3547613">(</span><span class="ident" id="3547614">h</span>&nbsp;<span class="ident" id="3547616">Handler</span><span class="op" id="3547623">,</span>&nbsp;<span class="ident" id="3547625">pattern</span>&nbsp;<span class="builtintype" id="3547633">string</span><span class="op" id="3547639">)</span>&nbsp;<span class="op" id="3547641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3547644">var</span>&nbsp;<span class="ident" id="3547648">n</span>&nbsp;<span class="op" id="3547650">=</span>&nbsp;<span class="num" id="3547652">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3547655">for</span>&nbsp;<span class="ident" id="3547659">k</span><span class="op" id="3547660">,</span>&nbsp;<span class="ident" id="3547662">v</span>&nbsp;<span class="op" id="3547664">:=</span>&nbsp;<span class="keyword" id="3547667">range</span>&nbsp;<span class="ident" id="3547673">mux</span><span class="op" id="3547676">.</span><span class="ident" id="3547677">m</span>&nbsp;<span class="op" id="3547679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3547683">if</span>&nbsp;<span class="op" id="3547686">!</span><span class="ident" id="3547687">pathMatch</span><span class="op" id="3547696">(</span><span class="ident" id="3547697">k</span><span class="op" id="3547698">,</span>&nbsp;<span class="ident" id="3547700">path</span><span class="op" id="3547704">)</span>&nbsp;<span class="op" id="3547706">{</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3547711">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3547722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3547726">if</span>&nbsp;<span class="ident" id="3547729">h</span>&nbsp;<span class="op" id="3547731">==</span>&nbsp;<span class="ident" id="3547734">nil</span>&nbsp;<span class="op" id="3547738">||</span>&nbsp;<span class="builtinfunc" id="3547741">len</span><span class="op" id="3547744">(</span><span class="ident" id="3547745">k</span><span class="op" id="3547746">)</span>&nbsp;<span class="op" id="3547748">&gt;</span>&nbsp;<span class="ident" id="3547750">n</span>&nbsp;<span class="op" id="3547752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3547757">n</span>&nbsp;<span class="op" id="3547759">=</span>&nbsp;<span class="builtinfunc" id="3547761">len</span><span class="op" id="3547764">(</span><span class="ident" id="3547765">k</span><span class="op" id="3547766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3547771">h</span>&nbsp;<span class="op" id="3547773">=</span>&nbsp;<span class="ident" id="3547775">v</span><span class="op" id="3547776">.</span><span class="ident" id="3547777">h</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3547782">pattern</span>&nbsp;<span class="op" id="3547790">=</span>&nbsp;<span class="ident" id="3547792">v</span><span class="op" id="3547793">.</span><span class="ident" id="3547794">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3547804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3547807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3547810">return</span><br>
<span class="lineno"></span><span class="op" id="3547817">}</span><br>
<span class="lineno">1485</span><br>
<span class="lineno"></span><span class="comment" id="3547820">//&nbsp;Handler&nbsp;returns&nbsp;the&nbsp;handler&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3547881">//&nbsp;consulting&nbsp;r.Method,&nbsp;r.Host,&nbsp;and&nbsp;r.URL.Path.&nbsp;It&nbsp;always&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="3547947">//&nbsp;a&nbsp;non-nil&nbsp;handler.&nbsp;If&nbsp;the&nbsp;path&nbsp;is&nbsp;not&nbsp;in&nbsp;its&nbsp;canonical&nbsp;form,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3548015">//&nbsp;handler&nbsp;will&nbsp;be&nbsp;an&nbsp;internally-generated&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno">1490</span><span class="comment" id="3548081">//&nbsp;to&nbsp;the&nbsp;canonical&nbsp;path.</span><br>
<span class="lineno"></span><span class="comment" id="3548107">//</span><br>
<span class="lineno"></span><span class="comment" id="3548110">//&nbsp;Handler&nbsp;also&nbsp;returns&nbsp;the&nbsp;registered&nbsp;pattern&nbsp;that&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3548174">//&nbsp;request&nbsp;or,&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;internally-generated&nbsp;redirects,</span><br>
<span class="lineno"></span><span class="comment" id="3548236">//&nbsp;the&nbsp;pattern&nbsp;that&nbsp;will&nbsp;match&nbsp;after&nbsp;following&nbsp;the&nbsp;redirect.</span><br>
<span class="lineno">1495</span><span class="comment" id="3548297">//</span><br>
<span class="lineno"></span><span class="comment" id="3548300">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;registered&nbsp;handler&nbsp;that&nbsp;applies&nbsp;to&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3548366">//&nbsp;Handler&nbsp;returns&nbsp;a&nbsp;``page&nbsp;not&nbsp;found&#39;&#39;&nbsp;handler&nbsp;and&nbsp;an&nbsp;empty&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3548436">func</span>&nbsp;<span class="op" id="3548441">(</span><span class="ident" id="3548442">mux</span>&nbsp;<span class="op" id="3548446">*</span><span class="ident" id="3548447">ServeMux</span><span class="op" id="3548455">)</span>&nbsp;<span class="ident" id="3548457">Handler</span><span class="op" id="3548464">(</span><span class="ident" id="3548465">r</span>&nbsp;<span class="op" id="3548467">*</span><span class="ident" id="3548468">Request</span><span class="op" id="3548475">)</span>&nbsp;<span class="op" id="3548477">(</span><span class="ident" id="3548478">h</span>&nbsp;<span class="ident" id="3548480">Handler</span><span class="op" id="3548487">,</span>&nbsp;<span class="ident" id="3548489">pattern</span>&nbsp;<span class="builtintype" id="3548497">string</span><span class="op" id="3548503">)</span>&nbsp;<span class="op" id="3548505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3548508">if</span>&nbsp;<span class="ident" id="3548511">r</span><span class="op" id="3548512">.</span><span class="ident" id="3548513">Method</span>&nbsp;<span class="op" id="3548520">!=</span>&nbsp;<span class="string" id="3548523">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="3548533">{</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3548537">if</span>&nbsp;<span class="ident" id="3548540">p</span>&nbsp;<span class="op" id="3548542">:=</span>&nbsp;<span class="ident" id="3548545">cleanPath</span><span class="op" id="3548554">(</span><span class="ident" id="3548555">r</span><span class="op" id="3548556">.</span><span class="ident" id="3548557">URL</span><span class="op" id="3548560">.</span><span class="ident" id="3548561">Path</span><span class="op" id="3548565">)</span><span class="op" id="3548566">;</span>&nbsp;<span class="ident" id="3548568">p</span>&nbsp;<span class="op" id="3548570">!=</span>&nbsp;<span class="ident" id="3548573">r</span><span class="op" id="3548574">.</span><span class="ident" id="3548575">URL</span><span class="op" id="3548578">.</span><span class="ident" id="3548579">Path</span>&nbsp;<span class="op" id="3548584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3548589">_</span><span class="op" id="3548590">,</span>&nbsp;<span class="ident" id="3548592">pattern</span>&nbsp;<span class="op" id="3548600">=</span>&nbsp;<span class="ident" id="3548602">mux</span><span class="op" id="3548605">.</span><span class="ident" id="3548606">handler</span><span class="op" id="3548613">(</span><span class="ident" id="3548614">r</span><span class="op" id="3548615">.</span><span class="ident" id="3548616">Host</span><span class="op" id="3548620">,</span>&nbsp;<span class="ident" id="3548622">p</span><span class="op" id="3548623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3548628">url</span>&nbsp;<span class="op" id="3548632">:=</span>&nbsp;<span class="op" id="3548635">*</span><span class="ident" id="3548636">r</span><span class="op" id="3548637">.</span><span class="ident" id="3548638">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3548645">url</span><span class="op" id="3548648">.</span><span class="ident" id="3548649">Path</span>&nbsp;<span class="op" id="3548654">=</span>&nbsp;<span class="ident" id="3548656">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3548661">return</span>&nbsp;<span class="ident" id="3548668">RedirectHandler</span><span class="op" id="3548683">(</span><span class="ident" id="3548684">url</span><span class="op" id="3548687">.</span><span class="ident" id="3548688">String</span><span class="op" id="3548694">(</span><span class="op" id="3548695">)</span><span class="op" id="3548696">,</span>&nbsp;<span class="ident" id="3548698">StatusMovedPermanently</span><span class="op" id="3548720">)</span><span class="op" id="3548721">,</span>&nbsp;<span class="ident" id="3548723">pattern</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3548733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3548736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3548740">return</span>&nbsp;<span class="ident" id="3548747">mux</span><span class="op" id="3548750">.</span><span class="ident" id="3548751">handler</span><span class="op" id="3548758">(</span><span class="ident" id="3548759">r</span><span class="op" id="3548760">.</span><span class="ident" id="3548761">Host</span><span class="op" id="3548765">,</span>&nbsp;<span class="ident" id="3548767">r</span><span class="op" id="3548768">.</span><span class="ident" id="3548769">URL</span><span class="op" id="3548772">.</span><span class="ident" id="3548773">Path</span><span class="op" id="3548777">)</span><br>
<span class="lineno"></span><span class="op" id="3548779">}</span><br>
<span class="lineno">1510</span><br>
<span class="lineno"></span><span class="comment" id="3548782">//&nbsp;handler&nbsp;is&nbsp;the&nbsp;main&nbsp;implementation&nbsp;of&nbsp;Handler.</span><br>
<span class="lineno"></span><span class="comment" id="3548832">//&nbsp;The&nbsp;path&nbsp;is&nbsp;known&nbsp;to&nbsp;be&nbsp;in&nbsp;canonical&nbsp;form,&nbsp;except&nbsp;for&nbsp;CONNECT&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="3548906">func</span>&nbsp;<span class="op" id="3548911">(</span><span class="ident" id="3548912">mux</span>&nbsp;<span class="op" id="3548916">*</span><span class="ident" id="3548917">ServeMux</span><span class="op" id="3548925">)</span>&nbsp;<span class="ident" id="3548927">handler</span><span class="op" id="3548934">(</span><span class="ident" id="3548935">host</span><span class="op" id="3548939">,</span>&nbsp;<span class="ident" id="3548941">path</span>&nbsp;<span class="builtintype" id="3548946">string</span><span class="op" id="3548952">)</span>&nbsp;<span class="op" id="3548954">(</span><span class="ident" id="3548955">h</span>&nbsp;<span class="ident" id="3548957">Handler</span><span class="op" id="3548964">,</span>&nbsp;<span class="ident" id="3548966">pattern</span>&nbsp;<span class="builtintype" id="3548974">string</span><span class="op" id="3548980">)</span>&nbsp;<span class="op" id="3548982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3548985">mux</span><span class="op" id="3548988">.</span><span class="ident" id="3548989">mu</span><span class="op" id="3548991">.</span><span class="ident" id="3548992">RLock</span><span class="op" id="3548997">(</span><span class="op" id="3548998">)</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3549001">defer</span>&nbsp;<span class="ident" id="3549007">mux</span><span class="op" id="3549010">.</span><span class="ident" id="3549011">mu</span><span class="op" id="3549013">.</span><span class="ident" id="3549014">RUnlock</span><span class="op" id="3549021">(</span><span class="op" id="3549022">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3549026">//&nbsp;Host-specific&nbsp;pattern&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;generic&nbsp;ones</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3549087">if</span>&nbsp;<span class="ident" id="3549090">mux</span><span class="op" id="3549093">.</span><span class="ident" id="3549094">hosts</span>&nbsp;<span class="op" id="3549100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3549104">h</span><span class="op" id="3549105">,</span>&nbsp;<span class="ident" id="3549107">pattern</span>&nbsp;<span class="op" id="3549115">=</span>&nbsp;<span class="ident" id="3549117">mux</span><span class="op" id="3549120">.</span><span class="ident" id="3549121">match</span><span class="op" id="3549126">(</span><span class="ident" id="3549127">host</span>&nbsp;<span class="op" id="3549132">+</span>&nbsp;<span class="ident" id="3549134">path</span><span class="op" id="3549138">)</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3549141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3549144">if</span>&nbsp;<span class="ident" id="3549147">h</span>&nbsp;<span class="op" id="3549149">==</span>&nbsp;<span class="ident" id="3549152">nil</span>&nbsp;<span class="op" id="3549156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3549160">h</span><span class="op" id="3549161">,</span>&nbsp;<span class="ident" id="3549163">pattern</span>&nbsp;<span class="op" id="3549171">=</span>&nbsp;<span class="ident" id="3549173">mux</span><span class="op" id="3549176">.</span><span class="ident" id="3549177">match</span><span class="op" id="3549182">(</span><span class="ident" id="3549183">path</span><span class="op" id="3549187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3549190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3549193">if</span>&nbsp;<span class="ident" id="3549196">h</span>&nbsp;<span class="op" id="3549198">==</span>&nbsp;<span class="ident" id="3549201">nil</span>&nbsp;<span class="op" id="3549205">{</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3549209">h</span><span class="op" id="3549210">,</span>&nbsp;<span class="ident" id="3549212">pattern</span>&nbsp;<span class="op" id="3549220">=</span>&nbsp;<span class="ident" id="3549222">NotFoundHandler</span><span class="op" id="3549237">(</span><span class="op" id="3549238">)</span><span class="op" id="3549239">,</span>&nbsp;<span class="string" id="3549241">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3549245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3549248">return</span><br>
<span class="lineno"></span><span class="op" id="3549255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1530</span><span class="comment" id="3549258">//&nbsp;ServeHTTP&nbsp;dispatches&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;handler&nbsp;whose</span><br>
<span class="lineno"></span><span class="comment" id="3549315">//&nbsp;pattern&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;request&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3549364">func</span>&nbsp;<span class="op" id="3549369">(</span><span class="ident" id="3549370">mux</span>&nbsp;<span class="op" id="3549374">*</span><span class="ident" id="3549375">ServeMux</span><span class="op" id="3549383">)</span>&nbsp;<span class="ident" id="3549385">ServeHTTP</span><span class="op" id="3549394">(</span><span class="ident" id="3549395">w</span>&nbsp;<span class="ident" id="3549397">ResponseWriter</span><span class="op" id="3549411">,</span>&nbsp;<span class="ident" id="3549413">r</span>&nbsp;<span class="op" id="3549415">*</span><span class="ident" id="3549416">Request</span><span class="op" id="3549423">)</span>&nbsp;<span class="op" id="3549425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3549428">if</span>&nbsp;<span class="ident" id="3549431">r</span><span class="op" id="3549432">.</span><span class="ident" id="3549433">RequestURI</span>&nbsp;<span class="op" id="3549444">==</span>&nbsp;<span class="string" id="3549447">&#34;*&#34;</span>&nbsp;<span class="op" id="3549451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3549455">if</span>&nbsp;<span class="ident" id="3549458">r</span><span class="op" id="3549459">.</span><span class="ident" id="3549460">ProtoAtLeast</span><span class="op" id="3549472">(</span><span class="num" id="3549473">1</span><span class="op" id="3549474">,</span>&nbsp;<span class="num" id="3549476">1</span><span class="op" id="3549477">)</span>&nbsp;<span class="op" id="3549479">{</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3549484">w</span><span class="op" id="3549485">.</span><span class="ident" id="3549486">Header</span><span class="op" id="3549492">(</span><span class="op" id="3549493">)</span><span class="op" id="3549494">.</span><span class="ident" id="3549495">Set</span><span class="op" id="3549498">(</span><span class="string" id="3549499">&#34;Connection&#34;</span><span class="op" id="3549511">,</span>&nbsp;<span class="string" id="3549513">&#34;close&#34;</span><span class="op" id="3549520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3549524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3549528">w</span><span class="op" id="3549529">.</span><span class="ident" id="3549530">WriteHeader</span><span class="op" id="3549541">(</span><span class="ident" id="3549542">StatusBadRequest</span><span class="op" id="3549558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3549562">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3549570">}</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3549573">h</span><span class="op" id="3549574">,</span>&nbsp;<span class="ident" id="3549576">_</span>&nbsp;<span class="op" id="3549578">:=</span>&nbsp;<span class="ident" id="3549581">mux</span><span class="op" id="3549584">.</span><span class="ident" id="3549585">Handler</span><span class="op" id="3549592">(</span><span class="ident" id="3549593">r</span><span class="op" id="3549594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3549597">h</span><span class="op" id="3549598">.</span><span class="ident" id="3549599">ServeHTTP</span><span class="op" id="3549608">(</span><span class="ident" id="3549609">w</span><span class="op" id="3549610">,</span>&nbsp;<span class="ident" id="3549612">r</span><span class="op" id="3549613">)</span><br>
<span class="lineno"></span><span class="op" id="3549615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3549618">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno">1545</span><span class="comment" id="3549673">//&nbsp;If&nbsp;a&nbsp;handler&nbsp;already&nbsp;exists&nbsp;for&nbsp;pattern,&nbsp;Handle&nbsp;panics.</span><br>
<span class="lineno"></span><span class="keyword" id="3549732">func</span>&nbsp;<span class="op" id="3549737">(</span><span class="ident" id="3549738">mux</span>&nbsp;<span class="op" id="3549742">*</span><span class="ident" id="3549743">ServeMux</span><span class="op" id="3549751">)</span>&nbsp;<span class="ident" id="3549753">Handle</span><span class="op" id="3549759">(</span><span class="ident" id="3549760">pattern</span>&nbsp;<span class="builtintype" id="3549768">string</span><span class="op" id="3549774">,</span>&nbsp;<span class="ident" id="3549776">handler</span>&nbsp;<span class="ident" id="3549784">Handler</span><span class="op" id="3549791">)</span>&nbsp;<span class="op" id="3549793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3549796">mux</span><span class="op" id="3549799">.</span><span class="ident" id="3549800">mu</span><span class="op" id="3549802">.</span><span class="ident" id="3549803">Lock</span><span class="op" id="3549807">(</span><span class="op" id="3549808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3549811">defer</span>&nbsp;<span class="ident" id="3549817">mux</span><span class="op" id="3549820">.</span><span class="ident" id="3549821">mu</span><span class="op" id="3549823">.</span><span class="ident" id="3549824">Unlock</span><span class="op" id="3549830">(</span><span class="op" id="3549831">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3549835">if</span>&nbsp;<span class="ident" id="3549838">pattern</span>&nbsp;<span class="op" id="3549846">==</span>&nbsp;<span class="string" id="3549849">&#34;&#34;</span>&nbsp;<span class="op" id="3549852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3549856">panic</span><span class="op" id="3549861">(</span><span class="string" id="3549862">&#34;http:&nbsp;invalid&nbsp;pattern&nbsp;&#34;</span>&nbsp;<span class="op" id="3549887">+</span>&nbsp;<span class="ident" id="3549889">pattern</span><span class="op" id="3549896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3549899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3549902">if</span>&nbsp;<span class="ident" id="3549905">handler</span>&nbsp;<span class="op" id="3549913">==</span>&nbsp;<span class="ident" id="3549916">nil</span>&nbsp;<span class="op" id="3549920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3549924">panic</span><span class="op" id="3549929">(</span><span class="string" id="3549930">&#34;http:&nbsp;nil&nbsp;handler&#34;</span><span class="op" id="3549949">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3549952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3549955">if</span>&nbsp;<span class="ident" id="3549958">mux</span><span class="op" id="3549961">.</span><span class="ident" id="3549962">m</span><span class="op" id="3549963">[</span><span class="ident" id="3549964">pattern</span><span class="op" id="3549971">]</span><span class="op" id="3549972">.</span><span class="ident" id="3549973">explicit</span>&nbsp;<span class="op" id="3549982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3549986">panic</span><span class="op" id="3549991">(</span><span class="string" id="3549992">&#34;http:&nbsp;multiple&nbsp;registrations&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="3550028">+</span>&nbsp;<span class="ident" id="3550030">pattern</span><span class="op" id="3550037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3550040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3550044">mux</span><span class="op" id="3550047">.</span><span class="ident" id="3550048">m</span><span class="op" id="3550049">[</span><span class="ident" id="3550050">pattern</span><span class="op" id="3550057">]</span>&nbsp;<span class="op" id="3550059">=</span>&nbsp;<span class="ident" id="3550061">muxEntry</span><span class="op" id="3550069">{</span><span class="ident" id="3550070">explicit</span><span class="op" id="3550078">:</span>&nbsp;<span class="builtintype" id="3550080">true</span><span class="op" id="3550084">,</span>&nbsp;<span class="ident" id="3550086">h</span><span class="op" id="3550087">:</span>&nbsp;<span class="ident" id="3550089">handler</span><span class="op" id="3550096">,</span>&nbsp;<span class="ident" id="3550098">pattern</span><span class="op" id="3550105">:</span>&nbsp;<span class="ident" id="3550107">pattern</span><span class="op" id="3550114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3550118">if</span>&nbsp;<span class="ident" id="3550121">pattern</span><span class="op" id="3550128">[</span><span class="num" id="3550129">0</span><span class="op" id="3550130">]</span>&nbsp;<span class="op" id="3550132">!=</span>&nbsp;<span class="string" id="3550135">&#39;/&#39;</span>&nbsp;<span class="op" id="3550139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3550143">mux</span><span class="op" id="3550146">.</span><span class="ident" id="3550147">hosts</span>&nbsp;<span class="op" id="3550153">=</span>&nbsp;<span class="builtintype" id="3550155">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3550161">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3550165">//&nbsp;Helpful&nbsp;behavior:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3550187">//&nbsp;If&nbsp;pattern&nbsp;is&nbsp;/tree/,&nbsp;insert&nbsp;an&nbsp;implicit&nbsp;permanent&nbsp;redirect&nbsp;for&nbsp;/tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3550262">//&nbsp;It&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;an&nbsp;explicit&nbsp;registration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3550316">n</span>&nbsp;<span class="op" id="3550318">:=</span>&nbsp;<span class="builtinfunc" id="3550321">len</span><span class="op" id="3550324">(</span><span class="ident" id="3550325">pattern</span><span class="op" id="3550332">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3550335">if</span>&nbsp;<span class="ident" id="3550338">n</span>&nbsp;<span class="op" id="3550340">&gt;</span>&nbsp;<span class="num" id="3550342">0</span>&nbsp;<span class="op" id="3550344">&amp;&amp;</span>&nbsp;<span class="ident" id="3550347">pattern</span><span class="op" id="3550354">[</span><span class="ident" id="3550355">n</span><span class="op" id="3550356">-</span><span class="num" id="3550357">1</span><span class="op" id="3550358">]</span>&nbsp;<span class="op" id="3550360">==</span>&nbsp;<span class="string" id="3550363">&#39;/&#39;</span>&nbsp;<span class="op" id="3550367">&amp;&amp;</span>&nbsp;<span class="op" id="3550370">!</span><span class="ident" id="3550371">mux</span><span class="op" id="3550374">.</span><span class="ident" id="3550375">m</span><span class="op" id="3550376">[</span><span class="ident" id="3550377">pattern</span><span class="op" id="3550384">[</span><span class="num" id="3550385">0</span><span class="op" id="3550386">:</span><span class="ident" id="3550387">n</span><span class="op" id="3550388">-</span><span class="num" id="3550389">1</span><span class="op" id="3550390">]</span><span class="op" id="3550391">]</span><span class="op" id="3550392">.</span><span class="ident" id="3550393">explicit</span>&nbsp;<span class="op" id="3550402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3550406">//&nbsp;If&nbsp;pattern&nbsp;contains&nbsp;a&nbsp;host&nbsp;name,&nbsp;strip&nbsp;it&nbsp;and&nbsp;use&nbsp;remaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3550471">//&nbsp;path&nbsp;for&nbsp;redirect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3550495">path</span>&nbsp;<span class="op" id="3550500">:=</span>&nbsp;<span class="ident" id="3550503">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3550513">if</span>&nbsp;<span class="ident" id="3550516">pattern</span><span class="op" id="3550523">[</span><span class="num" id="3550524">0</span><span class="op" id="3550525">]</span>&nbsp;<span class="op" id="3550527">!=</span>&nbsp;<span class="string" id="3550530">&#39;/&#39;</span>&nbsp;<span class="op" id="3550534">{</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3550539">//&nbsp;In&nbsp;pattern,&nbsp;at&nbsp;least&nbsp;the&nbsp;last&nbsp;character&nbsp;is&nbsp;a&nbsp;&#39;/&#39;,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3550598">//&nbsp;strings.Index&nbsp;can&#39;t&nbsp;be&nbsp;-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3550631">path</span>&nbsp;<span class="op" id="3550636">=</span>&nbsp;<span class="ident" id="3550638">pattern</span><span class="op" id="3550645">[</span><span class="ident" id="3550646">strings</span><span class="op" id="3550653">.</span><span class="ident" id="3550654">Index</span><span class="op" id="3550659">(</span><span class="ident" id="3550660">pattern</span><span class="op" id="3550667">,</span>&nbsp;<span class="string" id="3550669">&#34;/&#34;</span><span class="op" id="3550672">)</span><span class="op" id="3550673">:</span><span class="op" id="3550674">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3550678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3550682">mux</span><span class="op" id="3550685">.</span><span class="ident" id="3550686">m</span><span class="op" id="3550687">[</span><span class="ident" id="3550688">pattern</span><span class="op" id="3550695">[</span><span class="num" id="3550696">0</span><span class="op" id="3550697">:</span><span class="ident" id="3550698">n</span><span class="op" id="3550699">-</span><span class="num" id="3550700">1</span><span class="op" id="3550701">]</span><span class="op" id="3550702">]</span>&nbsp;<span class="op" id="3550704">=</span>&nbsp;<span class="ident" id="3550706">muxEntry</span><span class="op" id="3550714">{</span><span class="ident" id="3550715">h</span><span class="op" id="3550716">:</span>&nbsp;<span class="ident" id="3550718">RedirectHandler</span><span class="op" id="3550733">(</span><span class="ident" id="3550734">path</span><span class="op" id="3550738">,</span>&nbsp;<span class="ident" id="3550740">StatusMovedPermanently</span><span class="op" id="3550762">)</span><span class="op" id="3550763">,</span>&nbsp;<span class="ident" id="3550765">pattern</span><span class="op" id="3550772">:</span>&nbsp;<span class="ident" id="3550774">pattern</span><span class="op" id="3550781">}</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3550784">}</span><br>
<span class="lineno"></span><span class="op" id="3550786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3550789">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3550857">func</span>&nbsp;<span class="op" id="3550862">(</span><span class="ident" id="3550863">mux</span>&nbsp;<span class="op" id="3550867">*</span><span class="ident" id="3550868">ServeMux</span><span class="op" id="3550876">)</span>&nbsp;<span class="ident" id="3550878">HandleFunc</span><span class="op" id="3550888">(</span><span class="ident" id="3550889">pattern</span>&nbsp;<span class="builtintype" id="3550897">string</span><span class="op" id="3550903">,</span>&nbsp;<span class="ident" id="3550905">handler</span>&nbsp;<span class="keyword" id="3550913">func</span><span class="op" id="3550917">(</span><span class="ident" id="3550918">ResponseWriter</span><span class="op" id="3550932">,</span>&nbsp;<span class="op" id="3550934">*</span><span class="ident" id="3550935">Request</span><span class="op" id="3550942">)</span><span class="op" id="3550943">)</span>&nbsp;<span class="op" id="3550945">{</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3550948">mux</span><span class="op" id="3550951">.</span><span class="ident" id="3550952">Handle</span><span class="op" id="3550958">(</span><span class="ident" id="3550959">pattern</span><span class="op" id="3550966">,</span>&nbsp;<span class="ident" id="3550968">HandlerFunc</span><span class="op" id="3550979">(</span><span class="ident" id="3550980">handler</span><span class="op" id="3550987">)</span><span class="op" id="3550988">)</span><br>
<span class="lineno"></span><span class="op" id="3550990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3550993">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3551047">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1590</span><span class="comment" id="3551074">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3551143">func</span>&nbsp;<span class="ident" id="3551148">Handle</span><span class="op" id="3551154">(</span><span class="ident" id="3551155">pattern</span>&nbsp;<span class="builtintype" id="3551163">string</span><span class="op" id="3551169">,</span>&nbsp;<span class="ident" id="3551171">handler</span>&nbsp;<span class="ident" id="3551179">Handler</span><span class="op" id="3551186">)</span>&nbsp;<span class="op" id="3551188">{</span>&nbsp;<span class="ident" id="3551190">DefaultServeMux</span><span class="op" id="3551205">.</span><span class="ident" id="3551206">Handle</span><span class="op" id="3551212">(</span><span class="ident" id="3551213">pattern</span><span class="op" id="3551220">,</span>&nbsp;<span class="ident" id="3551222">handler</span><span class="op" id="3551229">)</span>&nbsp;<span class="op" id="3551231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3551234">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3551301">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1595</span><span class="comment" id="3551328">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3551397">func</span>&nbsp;<span class="ident" id="3551402">HandleFunc</span><span class="op" id="3551412">(</span><span class="ident" id="3551413">pattern</span>&nbsp;<span class="builtintype" id="3551421">string</span><span class="op" id="3551427">,</span>&nbsp;<span class="ident" id="3551429">handler</span>&nbsp;<span class="keyword" id="3551437">func</span><span class="op" id="3551441">(</span><span class="ident" id="3551442">ResponseWriter</span><span class="op" id="3551456">,</span>&nbsp;<span class="op" id="3551458">*</span><span class="ident" id="3551459">Request</span><span class="op" id="3551466">)</span><span class="op" id="3551467">)</span>&nbsp;<span class="op" id="3551469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3551472">DefaultServeMux</span><span class="op" id="3551487">.</span><span class="ident" id="3551488">HandleFunc</span><span class="op" id="3551498">(</span><span class="ident" id="3551499">pattern</span><span class="op" id="3551506">,</span>&nbsp;<span class="ident" id="3551508">handler</span><span class="op" id="3551515">)</span><br>
<span class="lineno"></span><span class="op" id="3551517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="3551520">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;HTTP&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,</span><br>
<span class="lineno"></span><span class="comment" id="3551582">//&nbsp;creating&nbsp;a&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="3551652">//&nbsp;read&nbsp;requests&nbsp;and&nbsp;then&nbsp;call&nbsp;handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="3551709">//&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3551781">func</span>&nbsp;<span class="ident" id="3551786">Serve</span><span class="op" id="3551791">(</span><span class="ident" id="3551792">l</span>&nbsp;<span class="ident" id="3551794">net</span><span class="op" id="3551797">.</span><span class="ident" id="3551798">Listener</span><span class="op" id="3551806">,</span>&nbsp;<span class="ident" id="3551808">handler</span>&nbsp;<span class="ident" id="3551816">Handler</span><span class="op" id="3551823">)</span>&nbsp;<span class="builtintype" id="3551825">error</span>&nbsp;<span class="op" id="3551831">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3551834">srv</span>&nbsp;<span class="op" id="3551838">:=</span>&nbsp;<span class="op" id="3551841">&amp;</span><span class="ident" id="3551842">Server</span><span class="op" id="3551848">{</span><span class="ident" id="3551849">Handler</span><span class="op" id="3551856">:</span>&nbsp;<span class="ident" id="3551858">handler</span><span class="op" id="3551865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3551868">return</span>&nbsp;<span class="ident" id="3551875">srv</span><span class="op" id="3551878">.</span><span class="ident" id="3551879">Serve</span><span class="op" id="3551884">(</span><span class="ident" id="3551885">l</span><span class="op" id="3551886">)</span><br>
<span class="lineno"></span><span class="op" id="3551888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3551891">//&nbsp;A&nbsp;Server&nbsp;defines&nbsp;parameters&nbsp;for&nbsp;running&nbsp;an&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">1610</span><span class="comment" id="3551950">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;Server&nbsp;is&nbsp;a&nbsp;valid&nbsp;configuration.</span><br>
<span class="lineno"></span><span class="keyword" id="3552005">type</span>&nbsp;<span class="ident" id="3552010">Server</span>&nbsp;<span class="keyword" id="3552017">struct</span>&nbsp;<span class="op" id="3552024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3552027">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3552042">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552056">//&nbsp;TCP&nbsp;address&nbsp;to&nbsp;listen&nbsp;on,&nbsp;&#34;:http&#34;&nbsp;if&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3552103">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3552118">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552132">//&nbsp;handler&nbsp;to&nbsp;invoke,&nbsp;http.DefaultServeMux&nbsp;if&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3552183">ReadTimeout</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3552198">time</span><span class="op" id="3552202">.</span><span class="ident" id="3552203">Duration</span>&nbsp;<span class="comment" id="3552212">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;read&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3552271">WriteTimeout</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3552286">time</span><span class="op" id="3552290">.</span><span class="ident" id="3552291">Duration</span>&nbsp;<span class="comment" id="3552300">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;write&nbsp;of&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3552361">MaxHeaderBytes</span>&nbsp;<span class="builtintype" id="3552376">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552390">//&nbsp;maximum&nbsp;size&nbsp;of&nbsp;request&nbsp;headers,&nbsp;DefaultMaxHeaderBytes&nbsp;if&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3552454">TLSConfig</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3552469">*</span><span class="ident" id="3552470">tls</span><span class="op" id="3552473">.</span><span class="ident" id="3552474">Config</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3552483">//&nbsp;optional&nbsp;TLS&nbsp;config,&nbsp;used&nbsp;by&nbsp;ListenAndServeTLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552535">//&nbsp;TLSNextProto&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;take&nbsp;over</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552597">//&nbsp;ownership&nbsp;of&nbsp;the&nbsp;provided&nbsp;TLS&nbsp;connection&nbsp;when&nbsp;an&nbsp;NPN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552654">//&nbsp;protocol&nbsp;upgrade&nbsp;has&nbsp;occurred.&nbsp;&nbsp;The&nbsp;map&nbsp;key&nbsp;is&nbsp;the&nbsp;protocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552718">//&nbsp;name&nbsp;negotiated.&nbsp;The&nbsp;Handler&nbsp;argument&nbsp;should&nbsp;be&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552778">//&nbsp;handle&nbsp;HTTP&nbsp;requests&nbsp;and&nbsp;will&nbsp;initialize&nbsp;the&nbsp;Request&#39;s&nbsp;TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552841">//&nbsp;and&nbsp;RemoteAddr&nbsp;if&nbsp;not&nbsp;already&nbsp;set.&nbsp;&nbsp;The&nbsp;connection&nbsp;is</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3552899">//&nbsp;automatically&nbsp;closed&nbsp;when&nbsp;the&nbsp;function&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3552951">TLSNextProto</span>&nbsp;<span class="keyword" id="3552964">map</span><span class="op" id="3552967">[</span><span class="builtintype" id="3552968">string</span><span class="op" id="3552974">]</span><span class="keyword" id="3552975">func</span><span class="op" id="3552979">(</span><span class="op" id="3552980">*</span><span class="ident" id="3552981">Server</span><span class="op" id="3552987">,</span>&nbsp;<span class="op" id="3552989">*</span><span class="ident" id="3552990">tls</span><span class="op" id="3552993">.</span><span class="ident" id="3552994">Conn</span><span class="op" id="3552998">,</span>&nbsp;<span class="ident" id="3553000">Handler</span><span class="op" id="3553007">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553011">//&nbsp;ConnState&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;callback&nbsp;function&nbsp;that&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553073">//&nbsp;called&nbsp;when&nbsp;a&nbsp;client&nbsp;connection&nbsp;changes&nbsp;state.&nbsp;See&nbsp;the</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553132">//&nbsp;ConnState&nbsp;type&nbsp;and&nbsp;associated&nbsp;constants&nbsp;for&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3553189">ConnState</span>&nbsp;<span class="keyword" id="3553199">func</span><span class="op" id="3553203">(</span><span class="ident" id="3553204">net</span><span class="op" id="3553207">.</span><span class="ident" id="3553208">Conn</span><span class="op" id="3553212">,</span>&nbsp;<span class="ident" id="3553214">ConnState</span><span class="op" id="3553223">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553227">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors&nbsp;accepting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553290">//&nbsp;connections&nbsp;and&nbsp;unexpected&nbsp;behavior&nbsp;from&nbsp;handlers.</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553345">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553405">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3553426">ErrorLog</span>&nbsp;<span class="op" id="3553435">*</span><span class="ident" id="3553436">log</span><span class="op" id="3553439">.</span><span class="ident" id="3553440">Logger</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3553449">disableKeepAlives</span>&nbsp;<span class="builtintype" id="3553467">int32</span>&nbsp;<span class="comment" id="3553473">//&nbsp;accessed&nbsp;atomically.</span><br>
<span class="lineno">1640</span><span class="op" id="3553497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3553500">//&nbsp;A&nbsp;ConnState&nbsp;represents&nbsp;the&nbsp;state&nbsp;of&nbsp;a&nbsp;client&nbsp;connection&nbsp;to&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="comment" id="3553572">//&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;the&nbsp;optional&nbsp;Server.ConnState&nbsp;hook.</span><br>
<span class="lineno"></span><span class="keyword" id="3553624">type</span>&nbsp;<span class="ident" id="3553629">ConnState</span>&nbsp;<span class="builtintype" id="3553639">int</span><br>
<span class="lineno">1645</span><br>
<span class="lineno"></span><span class="keyword" id="3553644">const</span>&nbsp;<span class="op" id="3553650">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553653">//&nbsp;StateNew&nbsp;represents&nbsp;a&nbsp;new&nbsp;connection&nbsp;that&nbsp;is&nbsp;expected&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553714">//&nbsp;send&nbsp;a&nbsp;request&nbsp;immediately.&nbsp;Connections&nbsp;begin&nbsp;at&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553772">//&nbsp;state&nbsp;and&nbsp;then&nbsp;transition&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553827">//&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3553844">StateNew</span>&nbsp;<span class="ident" id="3553853">ConnState</span>&nbsp;<span class="op" id="3553863">=</span>&nbsp;<span class="ident" id="3553865">iota</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553872">//&nbsp;StateActive&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;read&nbsp;1&nbsp;or&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553936">//&nbsp;bytes&nbsp;of&nbsp;a&nbsp;request.&nbsp;The&nbsp;Server.ConnState&nbsp;hook&nbsp;for</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3553990">//&nbsp;StateActive&nbsp;fires&nbsp;before&nbsp;the&nbsp;request&nbsp;has&nbsp;entered&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554053">//&nbsp;and&nbsp;doesn&#39;t&nbsp;fire&nbsp;again&nbsp;until&nbsp;the&nbsp;request&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554107">//&nbsp;handled.&nbsp;After&nbsp;the&nbsp;request&nbsp;is&nbsp;handled,&nbsp;the&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554160">//&nbsp;transitions&nbsp;to&nbsp;StateClosed,&nbsp;StateHijacked,&nbsp;or&nbsp;StateIdle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554221">StateActive</span><br>
<span class="lineno">1660</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554235">//&nbsp;StateIdle&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554291">//&nbsp;handling&nbsp;a&nbsp;request&nbsp;and&nbsp;is&nbsp;in&nbsp;the&nbsp;keep-alive&nbsp;state,&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554354">//&nbsp;for&nbsp;a&nbsp;new&nbsp;request.&nbsp;Connections&nbsp;transition&nbsp;from&nbsp;StateIdle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554415">//&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or&nbsp;StateClosed.</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554457">StateIdle</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554469">//&nbsp;StateHijacked&nbsp;represents&nbsp;a&nbsp;hijacked&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554521">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554590">StateHijacked</span><br>
<span class="lineno">1670</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554606">//&nbsp;StateClosed&nbsp;represents&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554654">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;Hijacked&nbsp;connections&nbsp;do&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554712">//&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554743">StateClosed</span><br>
<span class="lineno">1675</span><span class="op" id="3554755">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3554758">var</span>&nbsp;<span class="ident" id="3554762">stateName</span>&nbsp;<span class="op" id="3554772">=</span>&nbsp;<span class="keyword" id="3554774">map</span><span class="op" id="3554777">[</span><span class="ident" id="3554778">ConnState</span><span class="op" id="3554787">]</span><span class="builtintype" id="3554788">string</span><span class="op" id="3554794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554797">StateNew</span><span class="op" id="3554805">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3554812">&#34;new&#34;</span><span class="op" id="3554817">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554820">StateActive</span><span class="op" id="3554831">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3554835">&#34;active&#34;</span><span class="op" id="3554843">,</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554846">StateIdle</span><span class="op" id="3554855">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3554861">&#34;idle&#34;</span><span class="op" id="3554867">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554870">StateHijacked</span><span class="op" id="3554883">:</span>&nbsp;<span class="string" id="3554885">&#34;hijacked&#34;</span><span class="op" id="3554895">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3554898">StateClosed</span><span class="op" id="3554909">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3554913">&#34;closed&#34;</span><span class="op" id="3554921">,</span><br>
<span class="lineno"></span><span class="op" id="3554923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1685</span><span class="keyword" id="3554926">func</span>&nbsp;<span class="op" id="3554931">(</span><span class="ident" id="3554932">c</span>&nbsp;<span class="ident" id="3554934">ConnState</span><span class="op" id="3554943">)</span>&nbsp;<span class="ident" id="3554945">String</span><span class="op" id="3554951">(</span><span class="op" id="3554952">)</span>&nbsp;<span class="builtintype" id="3554954">string</span>&nbsp;<span class="op" id="3554961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3554964">return</span>&nbsp;<span class="ident" id="3554971">stateName</span><span class="op" id="3554980">[</span><span class="ident" id="3554981">c</span><span class="op" id="3554982">]</span><br>
<span class="lineno"></span><span class="op" id="3554984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3554987">//&nbsp;serverHandler&nbsp;delegates&nbsp;to&nbsp;either&nbsp;the&nbsp;server&#39;s&nbsp;Handler&nbsp;or</span><br>
<span class="lineno">1690</span><span class="comment" id="3555048">//&nbsp;DefaultServeMux&nbsp;and&nbsp;also&nbsp;handles&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3555106">type</span>&nbsp;<span class="ident" id="3555111">serverHandler</span>&nbsp;<span class="keyword" id="3555125">struct</span>&nbsp;<span class="op" id="3555132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555135">srv</span>&nbsp;<span class="op" id="3555139">*</span><span class="ident" id="3555140">Server</span><br>
<span class="lineno"></span><span class="op" id="3555147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1695</span><span class="keyword" id="3555150">func</span>&nbsp;<span class="op" id="3555155">(</span><span class="ident" id="3555156">sh</span>&nbsp;<span class="ident" id="3555159">serverHandler</span><span class="op" id="3555172">)</span>&nbsp;<span class="ident" id="3555174">ServeHTTP</span><span class="op" id="3555183">(</span><span class="ident" id="3555184">rw</span>&nbsp;<span class="ident" id="3555187">ResponseWriter</span><span class="op" id="3555201">,</span>&nbsp;<span class="ident" id="3555203">req</span>&nbsp;<span class="op" id="3555207">*</span><span class="ident" id="3555208">Request</span><span class="op" id="3555215">)</span>&nbsp;<span class="op" id="3555217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555220">handler</span>&nbsp;<span class="op" id="3555228">:=</span>&nbsp;<span class="ident" id="3555231">sh</span><span class="op" id="3555233">.</span><span class="ident" id="3555234">srv</span><span class="op" id="3555237">.</span><span class="ident" id="3555238">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555247">if</span>&nbsp;<span class="ident" id="3555250">handler</span>&nbsp;<span class="op" id="3555258">==</span>&nbsp;<span class="ident" id="3555261">nil</span>&nbsp;<span class="op" id="3555265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555269">handler</span>&nbsp;<span class="op" id="3555277">=</span>&nbsp;<span class="ident" id="3555279">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3555296">}</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555299">if</span>&nbsp;<span class="ident" id="3555302">req</span><span class="op" id="3555305">.</span><span class="ident" id="3555306">RequestURI</span>&nbsp;<span class="op" id="3555317">==</span>&nbsp;<span class="string" id="3555320">&#34;*&#34;</span>&nbsp;<span class="op" id="3555324">&amp;&amp;</span>&nbsp;<span class="ident" id="3555327">req</span><span class="op" id="3555330">.</span><span class="ident" id="3555331">Method</span>&nbsp;<span class="op" id="3555338">==</span>&nbsp;<span class="string" id="3555341">&#34;OPTIONS&#34;</span>&nbsp;<span class="op" id="3555351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555355">handler</span>&nbsp;<span class="op" id="3555363">=</span>&nbsp;<span class="ident" id="3555365">globalOptionsHandler</span><span class="op" id="3555385">{</span><span class="op" id="3555386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3555389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555392">handler</span><span class="op" id="3555399">.</span><span class="ident" id="3555400">ServeHTTP</span><span class="op" id="3555409">(</span><span class="ident" id="3555410">rw</span><span class="op" id="3555412">,</span>&nbsp;<span class="ident" id="3555414">req</span><span class="op" id="3555417">)</span><br>
<span class="lineno"></span><span class="op" id="3555419">}</span><br>
<span class="lineno">1705</span><br>
<span class="lineno"></span><span class="comment" id="3555422">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3555493">//&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="3555556">//&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:http&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3555595">func</span>&nbsp;<span class="op" id="3555600">(</span><span class="ident" id="3555601">srv</span>&nbsp;<span class="op" id="3555605">*</span><span class="ident" id="3555606">Server</span><span class="op" id="3555612">)</span>&nbsp;<span class="ident" id="3555614">ListenAndServe</span><span class="op" id="3555628">(</span><span class="op" id="3555629">)</span>&nbsp;<span class="builtintype" id="3555631">error</span>&nbsp;<span class="op" id="3555637">{</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555640">addr</span>&nbsp;<span class="op" id="3555645">:=</span>&nbsp;<span class="ident" id="3555648">srv</span><span class="op" id="3555651">.</span><span class="ident" id="3555652">Addr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555658">if</span>&nbsp;<span class="ident" id="3555661">addr</span>&nbsp;<span class="op" id="3555666">==</span>&nbsp;<span class="string" id="3555669">&#34;&#34;</span>&nbsp;<span class="op" id="3555672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555676">addr</span>&nbsp;<span class="op" id="3555681">=</span>&nbsp;<span class="string" id="3555683">&#34;:http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3555692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3555695">ln</span><span class="op" id="3555697">,</span>&nbsp;<span class="ident" id="3555699">err</span>&nbsp;<span class="op" id="3555703">:=</span>&nbsp;<span class="ident" id="3555706">net</span><span class="op" id="3555709">.</span><span class="ident" id="3555710">Listen</span><span class="op" id="3555716">(</span><span class="string" id="3555717">&#34;tcp&#34;</span><span class="op" id="3555722">,</span>&nbsp;<span class="ident" id="3555724">addr</span><span class="op" id="3555728">)</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555731">if</span>&nbsp;<span class="ident" id="3555734">err</span>&nbsp;<span class="op" id="3555738">!=</span>&nbsp;<span class="ident" id="3555741">nil</span>&nbsp;<span class="op" id="3555745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555749">return</span>&nbsp;<span class="ident" id="3555756">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3555761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3555764">return</span>&nbsp;<span class="ident" id="3555771">srv</span><span class="op" id="3555774">.</span><span class="ident" id="3555775">Serve</span><span class="op" id="3555780">(</span><span class="ident" id="3555781">tcpKeepAliveListener</span><span class="op" id="3555801">{</span><span class="ident" id="3555802">ln</span><span class="op" id="3555804">.</span><span class="op" id="3555805">(</span><span class="op" id="3555806">*</span><span class="ident" id="3555807">net</span><span class="op" id="3555810">.</span><span class="ident" id="3555811">TCPListener</span><span class="op" id="3555822">)</span><span class="op" id="3555823">}</span><span class="op" id="3555824">)</span><br>
<span class="lineno"></span><span class="op" id="3555826">}</span><br>
<span class="lineno">1720</span><br>
<span class="lineno"></span><span class="comment" id="3555829">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;connections&nbsp;on&nbsp;the&nbsp;Listener&nbsp;l,&nbsp;creating&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3555897">//&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines&nbsp;read&nbsp;requests&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3555974">//&nbsp;then&nbsp;call&nbsp;srv.Handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3556017">func</span>&nbsp;<span class="op" id="3556022">(</span><span class="ident" id="3556023">srv</span>&nbsp;<span class="op" id="3556027">*</span><span class="ident" id="3556028">Server</span><span class="op" id="3556034">)</span>&nbsp;<span class="ident" id="3556036">Serve</span><span class="op" id="3556041">(</span><span class="ident" id="3556042">l</span>&nbsp;<span class="ident" id="3556044">net</span><span class="op" id="3556047">.</span><span class="ident" id="3556048">Listener</span><span class="op" id="3556056">)</span>&nbsp;<span class="builtintype" id="3556058">error</span>&nbsp;<span class="op" id="3556064">{</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3556067">defer</span>&nbsp;<span class="ident" id="3556073">l</span><span class="op" id="3556074">.</span><span class="ident" id="3556075">Close</span><span class="op" id="3556080">(</span><span class="op" id="3556081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3556084">var</span>&nbsp;<span class="ident" id="3556088">tempDelay</span>&nbsp;<span class="ident" id="3556098">time</span><span class="op" id="3556102">.</span><span class="ident" id="3556103">Duration</span>&nbsp;<span class="comment" id="3556112">//&nbsp;how&nbsp;long&nbsp;to&nbsp;sleep&nbsp;on&nbsp;accept&nbsp;failure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3556152">for</span>&nbsp;<span class="op" id="3556156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556160">rw</span><span class="op" id="3556162">,</span>&nbsp;<span class="ident" id="3556164">e</span>&nbsp;<span class="op" id="3556166">:=</span>&nbsp;<span class="ident" id="3556169">l</span><span class="op" id="3556170">.</span><span class="ident" id="3556171">Accept</span><span class="op" id="3556177">(</span><span class="op" id="3556178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3556182">if</span>&nbsp;<span class="ident" id="3556185">e</span>&nbsp;<span class="op" id="3556187">!=</span>&nbsp;<span class="ident" id="3556190">nil</span>&nbsp;<span class="op" id="3556194">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3556199">if</span>&nbsp;<span class="ident" id="3556202">ne</span><span class="op" id="3556204">,</span>&nbsp;<span class="ident" id="3556206">ok</span>&nbsp;<span class="op" id="3556209">:=</span>&nbsp;<span class="ident" id="3556212">e</span><span class="op" id="3556213">.</span><span class="op" id="3556214">(</span><span class="ident" id="3556215">net</span><span class="op" id="3556218">.</span><span class="ident" id="3556219">Error</span><span class="op" id="3556224">)</span><span class="op" id="3556225">;</span>&nbsp;<span class="ident" id="3556227">ok</span>&nbsp;<span class="op" id="3556230">&amp;&amp;</span>&nbsp;<span class="ident" id="3556233">ne</span><span class="op" id="3556235">.</span><span class="ident" id="3556236">Temporary</span><span class="op" id="3556245">(</span><span class="op" id="3556246">)</span>&nbsp;<span class="op" id="3556248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3556254">if</span>&nbsp;<span class="ident" id="3556257">tempDelay</span>&nbsp;<span class="op" id="3556267">==</span>&nbsp;<span class="num" id="3556270">0</span>&nbsp;<span class="op" id="3556272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556279">tempDelay</span>&nbsp;<span class="op" id="3556289">=</span>&nbsp;<span class="num" id="3556291">5</span>&nbsp;<span class="op" id="3556293">*</span>&nbsp;<span class="ident" id="3556295">time</span><span class="op" id="3556299">.</span><span class="ident" id="3556300">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3556316">}</span>&nbsp;<span class="keyword" id="3556318">else</span>&nbsp;<span class="op" id="3556323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556330">tempDelay</span>&nbsp;<span class="op" id="3556340">*=</span>&nbsp;<span class="num" id="3556343">2</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3556349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3556355">if</span>&nbsp;<span class="ident" id="3556358">max</span>&nbsp;<span class="op" id="3556362">:=</span>&nbsp;<span class="num" id="3556365">1</span>&nbsp;<span class="op" id="3556367">*</span>&nbsp;<span class="ident" id="3556369">time</span><span class="op" id="3556373">.</span><span class="ident" id="3556374">Second</span><span class="op" id="3556380">;</span>&nbsp;<span class="ident" id="3556382">tempDelay</span>&nbsp;<span class="op" id="3556392">&gt;</span>&nbsp;<span class="ident" id="3556394">max</span>&nbsp;<span class="op" id="3556398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556405">tempDelay</span>&nbsp;<span class="op" id="3556415">=</span>&nbsp;<span class="ident" id="3556417">max</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3556425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556431">srv</span><span class="op" id="3556434">.</span><span class="ident" id="3556435">logf</span><span class="op" id="3556439">(</span><span class="string" id="3556440">&#34;http:&nbsp;Accept&nbsp;error:&nbsp;%v;&nbsp;retrying&nbsp;in&nbsp;%v&#34;</span><span class="op" id="3556480">,</span>&nbsp;<span class="ident" id="3556482">e</span><span class="op" id="3556483">,</span>&nbsp;<span class="ident" id="3556485">tempDelay</span><span class="op" id="3556494">)</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556500">time</span><span class="op" id="3556504">.</span><span class="ident" id="3556505">Sleep</span><span class="op" id="3556510">(</span><span class="ident" id="3556511">tempDelay</span><span class="op" id="3556520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3556526">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3556538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3556543">return</span>&nbsp;<span class="ident" id="3556550">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3556554">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556558">tempDelay</span>&nbsp;<span class="op" id="3556568">=</span>&nbsp;<span class="num" id="3556570">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556574">c</span><span class="op" id="3556575">,</span>&nbsp;<span class="ident" id="3556577">err</span>&nbsp;<span class="op" id="3556581">:=</span>&nbsp;<span class="ident" id="3556584">srv</span><span class="op" id="3556587">.</span><span class="ident" id="3556588">newConn</span><span class="op" id="3556595">(</span><span class="ident" id="3556596">rw</span><span class="op" id="3556598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3556602">if</span>&nbsp;<span class="ident" id="3556605">err</span>&nbsp;<span class="op" id="3556609">!=</span>&nbsp;<span class="ident" id="3556612">nil</span>&nbsp;<span class="op" id="3556616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3556621">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3556632">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556636">c</span><span class="op" id="3556637">.</span><span class="ident" id="3556638">setState</span><span class="op" id="3556646">(</span><span class="ident" id="3556647">c</span><span class="op" id="3556648">.</span><span class="ident" id="3556649">rwc</span><span class="op" id="3556652">,</span>&nbsp;<span class="ident" id="3556654">StateNew</span><span class="op" id="3556662">)</span>&nbsp;<span class="comment" id="3556664">//&nbsp;before&nbsp;Serve&nbsp;can&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3556693">go</span>&nbsp;<span class="ident" id="3556696">c</span><span class="op" id="3556697">.</span><span class="ident" id="3556698">serve</span><span class="op" id="3556703">(</span><span class="op" id="3556704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3556707">}</span><br>
<span class="lineno"></span><span class="op" id="3556709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1755</span><span class="keyword" id="3556712">func</span>&nbsp;<span class="op" id="3556717">(</span><span class="ident" id="3556718">s</span>&nbsp;<span class="op" id="3556720">*</span><span class="ident" id="3556721">Server</span><span class="op" id="3556727">)</span>&nbsp;<span class="ident" id="3556729">doKeepAlives</span><span class="op" id="3556741">(</span><span class="op" id="3556742">)</span>&nbsp;<span class="builtintype" id="3556744">bool</span>&nbsp;<span class="op" id="3556749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3556752">return</span>&nbsp;<span class="ident" id="3556759">atomic</span><span class="op" id="3556765">.</span><span class="ident" id="3556766">LoadInt32</span><span class="op" id="3556775">(</span><span class="op" id="3556776">&amp;</span><span class="ident" id="3556777">s</span><span class="op" id="3556778">.</span><span class="ident" id="3556779">disableKeepAlives</span><span class="op" id="3556796">)</span>&nbsp;<span class="op" id="3556798">==</span>&nbsp;<span class="num" id="3556801">0</span><br>
<span class="lineno"></span><span class="op" id="3556803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3556806">//&nbsp;SetKeepAlivesEnabled&nbsp;controls&nbsp;whether&nbsp;HTTP&nbsp;keep-alives&nbsp;are&nbsp;enabled.</span><br>
<span class="lineno">1760</span><span class="comment" id="3556877">//&nbsp;By&nbsp;default,&nbsp;keep-alives&nbsp;are&nbsp;always&nbsp;enabled.&nbsp;Only&nbsp;very</span><br>
<span class="lineno"></span><span class="comment" id="3556934">//&nbsp;resource-constrained&nbsp;environments&nbsp;or&nbsp;servers&nbsp;in&nbsp;the&nbsp;process&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3557000">//&nbsp;shutting&nbsp;down&nbsp;should&nbsp;disable&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3557038">func</span>&nbsp;<span class="op" id="3557043">(</span><span class="ident" id="3557044">s</span>&nbsp;<span class="op" id="3557046">*</span><span class="ident" id="3557047">Server</span><span class="op" id="3557053">)</span>&nbsp;<span class="ident" id="3557055">SetKeepAlivesEnabled</span><span class="op" id="3557075">(</span><span class="ident" id="3557076">v</span>&nbsp;<span class="builtintype" id="3557078">bool</span><span class="op" id="3557082">)</span>&nbsp;<span class="op" id="3557084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3557087">if</span>&nbsp;<span class="ident" id="3557090">v</span>&nbsp;<span class="op" id="3557092">{</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3557096">atomic</span><span class="op" id="3557102">.</span><span class="ident" id="3557103">StoreInt32</span><span class="op" id="3557113">(</span><span class="op" id="3557114">&amp;</span><span class="ident" id="3557115">s</span><span class="op" id="3557116">.</span><span class="ident" id="3557117">disableKeepAlives</span><span class="op" id="3557134">,</span>&nbsp;<span class="num" id="3557136">0</span><span class="op" id="3557137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3557140">}</span>&nbsp;<span class="keyword" id="3557142">else</span>&nbsp;<span class="op" id="3557147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3557151">atomic</span><span class="op" id="3557157">.</span><span class="ident" id="3557158">StoreInt32</span><span class="op" id="3557168">(</span><span class="op" id="3557169">&amp;</span><span class="ident" id="3557170">s</span><span class="op" id="3557171">.</span><span class="ident" id="3557172">disableKeepAlives</span><span class="op" id="3557189">,</span>&nbsp;<span class="num" id="3557191">1</span><span class="op" id="3557192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3557195">}</span><br>
<span class="lineno"></span><span class="op" id="3557197">}</span><br>
<span class="lineno">1770</span><br>
<span class="lineno"></span><span class="keyword" id="3557200">func</span>&nbsp;<span class="op" id="3557205">(</span><span class="ident" id="3557206">s</span>&nbsp;<span class="op" id="3557208">*</span><span class="ident" id="3557209">Server</span><span class="op" id="3557215">)</span>&nbsp;<span class="ident" id="3557217">logf</span><span class="op" id="3557221">(</span><span class="ident" id="3557222">format</span>&nbsp;<span class="builtintype" id="3557229">string</span><span class="op" id="3557235">,</span>&nbsp;<span class="ident" id="3557237">args</span>&nbsp;<span class="op" id="3557242">...</span><span class="keyword" id="3557245">interface</span><span class="op" id="3557254">{</span><span class="op" id="3557255">}</span><span class="op" id="3557256">)</span>&nbsp;<span class="op" id="3557258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3557261">if</span>&nbsp;<span class="ident" id="3557264">s</span><span class="op" id="3557265">.</span><span class="ident" id="3557266">ErrorLog</span>&nbsp;<span class="op" id="3557275">!=</span>&nbsp;<span class="ident" id="3557278">nil</span>&nbsp;<span class="op" id="3557282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3557286">s</span><span class="op" id="3557287">.</span><span class="ident" id="3557288">ErrorLog</span><span class="op" id="3557296">.</span><span class="ident" id="3557297">Printf</span><span class="op" id="3557303">(</span><span class="ident" id="3557304">format</span><span class="op" id="3557310">,</span>&nbsp;<span class="ident" id="3557312">args</span><span class="op" id="3557316">...</span><span class="op" id="3557319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3557322">}</span>&nbsp;<span class="keyword" id="3557324">else</span>&nbsp;<span class="op" id="3557329">{</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3557333">log</span><span class="op" id="3557336">.</span><span class="ident" id="3557337">Printf</span><span class="op" id="3557343">(</span><span class="ident" id="3557344">format</span><span class="op" id="3557350">,</span>&nbsp;<span class="ident" id="3557352">args</span><span class="op" id="3557356">...</span><span class="op" id="3557359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3557362">}</span><br>
<span class="lineno"></span><span class="op" id="3557364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3557367">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;addr</span><br>
<span class="lineno">1780</span><span class="comment" id="3557425">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;with&nbsp;handler&nbsp;to&nbsp;handle&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3557481">//&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="3557536">//&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3557582">//</span><br>
<span class="lineno"></span><span class="comment" id="3557585">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno">1785</span><span class="comment" id="3557617">//</span><br>
<span class="lineno"></span><span class="comment" id="3557620">//&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;main</span><br>
<span class="lineno"></span><span class="comment" id="3557636">//</span><br>
<span class="lineno"></span><span class="comment" id="3557639">//&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;(</span><br>
<span class="lineno"></span><span class="comment" id="3557651">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;io&#34;</span><br>
<span class="lineno">1790</span><span class="comment" id="3557660">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3557675">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3557685">//&nbsp;&nbsp;&nbsp;&nbsp;)</span><br>
<span class="lineno"></span><span class="comment" id="3557690">//</span><br>
<span class="lineno"></span><span class="comment" id="3557693">//&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;hello&nbsp;world,&nbsp;the&nbsp;web&nbsp;server</span><br>
<span class="lineno">1795</span><span class="comment" id="3557727">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;HelloServer(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3557791">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io.WriteString(w,&nbsp;&#34;hello,&nbsp;world!\n&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3557832">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3557837">//</span><br>
<span class="lineno"></span><span class="comment" id="3557840">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1800</span><span class="comment" id="3557857">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.HandleFunc(&#34;/hello&#34;,&nbsp;HelloServer)</span><br>
<span class="lineno"></span><span class="comment" id="3557900">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;:=&nbsp;http.ListenAndServe(&#34;:12345&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3557946">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3557966">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;ListenAndServe:&nbsp;&#34;,&nbsp;err)</span><br>
<span class="lineno"></span><span class="comment" id="3558006">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno">1805</span><span class="comment" id="3558012">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="keyword" id="3558017">func</span>&nbsp;<span class="ident" id="3558022">ListenAndServe</span><span class="op" id="3558036">(</span><span class="ident" id="3558037">addr</span>&nbsp;<span class="builtintype" id="3558042">string</span><span class="op" id="3558048">,</span>&nbsp;<span class="ident" id="3558050">handler</span>&nbsp;<span class="ident" id="3558058">Handler</span><span class="op" id="3558065">)</span>&nbsp;<span class="builtintype" id="3558067">error</span>&nbsp;<span class="op" id="3558073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3558076">server</span>&nbsp;<span class="op" id="3558083">:=</span>&nbsp;<span class="op" id="3558086">&amp;</span><span class="ident" id="3558087">Server</span><span class="op" id="3558093">{</span><span class="ident" id="3558094">Addr</span><span class="op" id="3558098">:</span>&nbsp;<span class="ident" id="3558100">addr</span><span class="op" id="3558104">,</span>&nbsp;<span class="ident" id="3558106">Handler</span><span class="op" id="3558113">:</span>&nbsp;<span class="ident" id="3558115">handler</span><span class="op" id="3558122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3558125">return</span>&nbsp;<span class="ident" id="3558132">server</span><span class="op" id="3558138">.</span><span class="ident" id="3558139">ListenAndServe</span><span class="op" id="3558153">(</span><span class="op" id="3558154">)</span><br>
<span class="lineno"></span><span class="op" id="3558156">}</span><br>
<span class="lineno">1810</span><br>
<span class="lineno"></span><span class="comment" id="3558159">//&nbsp;ListenAndServeTLS&nbsp;acts&nbsp;identically&nbsp;to&nbsp;ListenAndServe,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3558231">//&nbsp;expects&nbsp;HTTPS&nbsp;connections.&nbsp;Additionally,&nbsp;files&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3558310">//&nbsp;matching&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate</span><br>
<span class="lineno"></span><span class="comment" id="3558386">//&nbsp;is&nbsp;signed&nbsp;by&nbsp;a&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1815</span><span class="comment" id="3558468">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3558533">//</span><br>
<span class="lineno"></span><span class="comment" id="3558536">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno"></span><span class="comment" id="3558568">//</span><br>
<span class="lineno"></span><span class="comment" id="3558571">//&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;(</span><br>
<span class="lineno">1820</span><span class="comment" id="3558583">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3558593">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3558608">//&nbsp;&nbsp;&nbsp;&nbsp;)</span><br>
<span class="lineno"></span><span class="comment" id="3558613">//</span><br>
<span class="lineno"></span><span class="comment" id="3558616">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;handler(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno">1825</span><span class="comment" id="3558676">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.Header().Set(&#34;Content-Type&#34;,&nbsp;&#34;text/plain&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3558725">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.Write([]byte(&#34;This&nbsp;is&nbsp;an&nbsp;example&nbsp;server.\n&#34;))</span><br>
<span class="lineno"></span><span class="comment" id="3558777">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3558782">//</span><br>
<span class="lineno"></span><span class="comment" id="3558785">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1830</span><span class="comment" id="3558802">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.HandleFunc(&#34;/&#34;,&nbsp;handler)</span><br>
<span class="lineno"></span><span class="comment" id="3558836">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(&#34;About&nbsp;to&nbsp;listen&nbsp;on&nbsp;10443.&nbsp;Go&nbsp;to&nbsp;https://127.0.0.1:10443/&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3558911">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;:=&nbsp;http.ListenAndServeTLS(&#34;:10443&#34;,&nbsp;&#34;cert.pem&#34;,&nbsp;&#34;key.pem&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3558983">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3559003">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(err)</span><br>
<span class="lineno">1835</span><span class="comment" id="3559023">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3559029">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3559034">//</span><br>
<span class="lineno"></span><span class="comment" id="3559037">//&nbsp;One&nbsp;can&nbsp;use&nbsp;generate_cert.go&nbsp;in&nbsp;crypto/tls&nbsp;to&nbsp;generate&nbsp;cert.pem&nbsp;and&nbsp;key.pem.</span><br>
<span class="lineno"></span><span class="keyword" id="3559117">func</span>&nbsp;<span class="ident" id="3559122">ListenAndServeTLS</span><span class="op" id="3559139">(</span><span class="ident" id="3559140">addr</span>&nbsp;<span class="builtintype" id="3559145">string</span><span class="op" id="3559151">,</span>&nbsp;<span class="ident" id="3559153">certFile</span>&nbsp;<span class="builtintype" id="3559162">string</span><span class="op" id="3559168">,</span>&nbsp;<span class="ident" id="3559170">keyFile</span>&nbsp;<span class="builtintype" id="3559178">string</span><span class="op" id="3559184">,</span>&nbsp;<span class="ident" id="3559186">handler</span>&nbsp;<span class="ident" id="3559194">Handler</span><span class="op" id="3559201">)</span>&nbsp;<span class="builtintype" id="3559203">error</span>&nbsp;<span class="op" id="3559209">{</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3559212">server</span>&nbsp;<span class="op" id="3559219">:=</span>&nbsp;<span class="op" id="3559222">&amp;</span><span class="ident" id="3559223">Server</span><span class="op" id="3559229">{</span><span class="ident" id="3559230">Addr</span><span class="op" id="3559234">:</span>&nbsp;<span class="ident" id="3559236">addr</span><span class="op" id="3559240">,</span>&nbsp;<span class="ident" id="3559242">Handler</span><span class="op" id="3559249">:</span>&nbsp;<span class="ident" id="3559251">handler</span><span class="op" id="3559258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3559261">return</span>&nbsp;<span class="ident" id="3559268">server</span><span class="op" id="3559274">.</span><span class="ident" id="3559275">ListenAndServeTLS</span><span class="op" id="3559292">(</span><span class="ident" id="3559293">certFile</span><span class="op" id="3559301">,</span>&nbsp;<span class="ident" id="3559303">keyFile</span><span class="op" id="3559310">)</span><br>
<span class="lineno"></span><span class="op" id="3559312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3559315">//&nbsp;ListenAndServeTLS&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and</span><br>
<span class="lineno">1845</span><span class="comment" id="3559384">//&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="3559452">//</span><br>
<span class="lineno"></span><span class="comment" id="3559455">//&nbsp;Filenames&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and&nbsp;matching&nbsp;private&nbsp;key&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3559522">//&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3559588">//&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1850</span><span class="comment" id="3559655">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3559720">//</span><br>
<span class="lineno"></span><span class="comment" id="3559723">//&nbsp;If&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:https&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3559766">func</span>&nbsp;<span class="op" id="3559771">(</span><span class="ident" id="3559772">srv</span>&nbsp;<span class="op" id="3559776">*</span><span class="ident" id="3559777">Server</span><span class="op" id="3559783">)</span>&nbsp;<span class="ident" id="3559785">ListenAndServeTLS</span><span class="op" id="3559802">(</span><span class="ident" id="3559803">certFile</span><span class="op" id="3559811">,</span>&nbsp;<span class="ident" id="3559813">keyFile</span>&nbsp;<span class="builtintype" id="3559821">string</span><span class="op" id="3559827">)</span>&nbsp;<span class="builtintype" id="3559829">error</span>&nbsp;<span class="op" id="3559835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3559838">addr</span>&nbsp;<span class="op" id="3559843">:=</span>&nbsp;<span class="ident" id="3559846">srv</span><span class="op" id="3559849">.</span><span class="ident" id="3559850">Addr</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3559856">if</span>&nbsp;<span class="ident" id="3559859">addr</span>&nbsp;<span class="op" id="3559864">==</span>&nbsp;<span class="string" id="3559867">&#34;&#34;</span>&nbsp;<span class="op" id="3559870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3559874">addr</span>&nbsp;<span class="op" id="3559879">=</span>&nbsp;<span class="string" id="3559881">&#34;:https&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3559891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3559894">config</span>&nbsp;<span class="op" id="3559901">:=</span>&nbsp;<span class="op" id="3559904">&amp;</span><span class="ident" id="3559905">tls</span><span class="op" id="3559908">.</span><span class="ident" id="3559909">Config</span><span class="op" id="3559915">{</span><span class="op" id="3559916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3559919">if</span>&nbsp;<span class="ident" id="3559922">srv</span><span class="op" id="3559925">.</span><span class="ident" id="3559926">TLSConfig</span>&nbsp;<span class="op" id="3559936">!=</span>&nbsp;<span class="ident" id="3559939">nil</span>&nbsp;<span class="op" id="3559943">{</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3559947">*</span><span class="ident" id="3559948">config</span>&nbsp;<span class="op" id="3559955">=</span>&nbsp;<span class="op" id="3559957">*</span><span class="ident" id="3559958">srv</span><span class="op" id="3559961">.</span><span class="ident" id="3559962">TLSConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3559973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3559976">if</span>&nbsp;<span class="ident" id="3559979">config</span><span class="op" id="3559985">.</span><span class="ident" id="3559986">NextProtos</span>&nbsp;<span class="op" id="3559997">==</span>&nbsp;<span class="ident" id="3560000">nil</span>&nbsp;<span class="op" id="3560004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3560008">config</span><span class="op" id="3560014">.</span><span class="ident" id="3560015">NextProtos</span>&nbsp;<span class="op" id="3560026">=</span>&nbsp;<span class="op" id="3560028">[</span><span class="op" id="3560029">]</span><span class="builtintype" id="3560030">string</span><span class="op" id="3560036">{</span><span class="string" id="3560037">&#34;http/1.1&#34;</span><span class="op" id="3560047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3560050">}</span><br>
<span class="lineno">1865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3560054">var</span>&nbsp;<span class="ident" id="3560058">err</span>&nbsp;<span class="builtintype" id="3560062">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3560069">config</span><span class="op" id="3560075">.</span><span class="ident" id="3560076">Certificates</span>&nbsp;<span class="op" id="3560089">=</span>&nbsp;<span class="builtinfunc" id="3560091">make</span><span class="op" id="3560095">(</span><span class="op" id="3560096">[</span><span class="op" id="3560097">]</span><span class="ident" id="3560098">tls</span><span class="op" id="3560101">.</span><span class="ident" id="3560102">Certificate</span><span class="op" id="3560113">,</span>&nbsp;<span class="num" id="3560115">1</span><span class="op" id="3560116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3560119">config</span><span class="op" id="3560125">.</span><span class="ident" id="3560126">Certificates</span><span class="op" id="3560138">[</span><span class="num" id="3560139">0</span><span class="op" id="3560140">]</span><span class="op" id="3560141">,</span>&nbsp;<span class="ident" id="3560143">err</span>&nbsp;<span class="op" id="3560147">=</span>&nbsp;<span class="ident" id="3560149">tls</span><span class="op" id="3560152">.</span><span class="ident" id="3560153">LoadX509KeyPair</span><span class="op" id="3560168">(</span><span class="ident" id="3560169">certFile</span><span class="op" id="3560177">,</span>&nbsp;<span class="ident" id="3560179">keyFile</span><span class="op" id="3560186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3560189">if</span>&nbsp;<span class="ident" id="3560192">err</span>&nbsp;<span class="op" id="3560196">!=</span>&nbsp;<span class="ident" id="3560199">nil</span>&nbsp;<span class="op" id="3560203">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3560207">return</span>&nbsp;<span class="ident" id="3560214">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3560219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3560223">ln</span><span class="op" id="3560225">,</span>&nbsp;<span class="ident" id="3560227">err</span>&nbsp;<span class="op" id="3560231">:=</span>&nbsp;<span class="ident" id="3560234">net</span><span class="op" id="3560237">.</span><span class="ident" id="3560238">Listen</span><span class="op" id="3560244">(</span><span class="string" id="3560245">&#34;tcp&#34;</span><span class="op" id="3560250">,</span>&nbsp;<span class="ident" id="3560252">addr</span><span class="op" id="3560256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3560259">if</span>&nbsp;<span class="ident" id="3560262">err</span>&nbsp;<span class="op" id="3560266">!=</span>&nbsp;<span class="ident" id="3560269">nil</span>&nbsp;<span class="op" id="3560273">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3560277">return</span>&nbsp;<span class="ident" id="3560284">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3560289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3560293">tlsListener</span>&nbsp;<span class="op" id="3560305">:=</span>&nbsp;<span class="ident" id="3560308">tls</span><span class="op" id="3560311">.</span><span class="ident" id="3560312">NewListener</span><span class="op" id="3560323">(</span><span class="ident" id="3560324">tcpKeepAliveListener</span><span class="op" id="3560344">{</span><span class="ident" id="3560345">ln</span><span class="op" id="3560347">.</span><span class="op" id="3560348">(</span><span class="op" id="3560349">*</span><span class="ident" id="3560350">net</span><span class="op" id="3560353">.</span><span class="ident" id="3560354">TCPListener</span><span class="op" id="3560365">)</span><span class="op" id="3560366">}</span><span class="op" id="3560367">,</span>&nbsp;<span class="ident" id="3560369">config</span><span class="op" id="3560375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3560378">return</span>&nbsp;<span class="ident" id="3560385">srv</span><span class="op" id="3560388">.</span><span class="ident" id="3560389">Serve</span><span class="op" id="3560394">(</span><span class="ident" id="3560395">tlsListener</span><span class="op" id="3560406">)</span><br>
<span class="lineno">1880</span><span class="op" id="3560408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3560411">//&nbsp;TimeoutHandler&nbsp;returns&nbsp;a&nbsp;Handler&nbsp;that&nbsp;runs&nbsp;h&nbsp;with&nbsp;the&nbsp;given&nbsp;time&nbsp;limit.</span><br>
<span class="lineno"></span><span class="comment" id="3560486">//</span><br>
<span class="lineno"></span><span class="comment" id="3560489">//&nbsp;The&nbsp;new&nbsp;Handler&nbsp;calls&nbsp;h.ServeHTTP&nbsp;to&nbsp;handle&nbsp;each&nbsp;request,&nbsp;but&nbsp;if&nbsp;a</span><br>
<span class="lineno">1885</span><span class="comment" id="3560559">//&nbsp;call&nbsp;runs&nbsp;for&nbsp;longer&nbsp;than&nbsp;its&nbsp;time&nbsp;limit,&nbsp;the&nbsp;handler&nbsp;responds&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3560630">//&nbsp;a&nbsp;503&nbsp;Service&nbsp;Unavailable&nbsp;error&nbsp;and&nbsp;the&nbsp;given&nbsp;message&nbsp;in&nbsp;its&nbsp;body.</span><br>
<span class="lineno"></span><span class="comment" id="3560700">//&nbsp;(If&nbsp;msg&nbsp;is&nbsp;empty,&nbsp;a&nbsp;suitable&nbsp;default&nbsp;message&nbsp;will&nbsp;be&nbsp;sent.)</span><br>
<span class="lineno"></span><span class="comment" id="3560763">//&nbsp;After&nbsp;such&nbsp;a&nbsp;timeout,&nbsp;writes&nbsp;by&nbsp;h&nbsp;to&nbsp;its&nbsp;ResponseWriter&nbsp;will&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="3560834">//&nbsp;ErrHandlerTimeout.</span><br>
<span class="lineno">1890</span><span class="keyword" id="3560856">func</span>&nbsp;<span class="ident" id="3560861">TimeoutHandler</span><span class="op" id="3560875">(</span><span class="ident" id="3560876">h</span>&nbsp;<span class="ident" id="3560878">Handler</span><span class="op" id="3560885">,</span>&nbsp;<span class="ident" id="3560887">dt</span>&nbsp;<span class="ident" id="3560890">time</span><span class="op" id="3560894">.</span><span class="ident" id="3560895">Duration</span><span class="op" id="3560903">,</span>&nbsp;<span class="ident" id="3560905">msg</span>&nbsp;<span class="builtintype" id="3560909">string</span><span class="op" id="3560915">)</span>&nbsp;<span class="ident" id="3560917">Handler</span>&nbsp;<span class="op" id="3560925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3560928">f</span>&nbsp;<span class="op" id="3560930">:=</span>&nbsp;<span class="keyword" id="3560933">func</span><span class="op" id="3560937">(</span><span class="op" id="3560938">)</span>&nbsp;<span class="op" id="3560940">&lt;-</span><span class="keyword" id="3560942">chan</span>&nbsp;<span class="ident" id="3560947">time</span><span class="op" id="3560951">.</span><span class="ident" id="3560952">Time</span>&nbsp;<span class="op" id="3560957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3560961">return</span>&nbsp;<span class="ident" id="3560968">time</span><span class="op" id="3560972">.</span><span class="ident" id="3560973">After</span><span class="op" id="3560978">(</span><span class="ident" id="3560979">dt</span><span class="op" id="3560981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3560984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3560987">return</span>&nbsp;<span class="op" id="3560994">&amp;</span><span class="ident" id="3560995">timeoutHandler</span><span class="op" id="3561009">{</span><span class="ident" id="3561010">h</span><span class="op" id="3561011">,</span>&nbsp;<span class="ident" id="3561013">f</span><span class="op" id="3561014">,</span>&nbsp;<span class="ident" id="3561016">msg</span><span class="op" id="3561019">}</span><br>
<span class="lineno">1895</span><span class="op" id="3561021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3561024">//&nbsp;ErrHandlerTimeout&nbsp;is&nbsp;returned&nbsp;on&nbsp;ResponseWriter&nbsp;Write&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3561087">//&nbsp;in&nbsp;handlers&nbsp;which&nbsp;have&nbsp;timed&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3561124">var</span>&nbsp;<span class="ident" id="3561128">ErrHandlerTimeout</span>&nbsp;<span class="op" id="3561146">=</span>&nbsp;<span class="ident" id="3561148">errors</span><span class="op" id="3561154">.</span><span class="ident" id="3561155">New</span><span class="op" id="3561158">(</span><span class="string" id="3561159">&#34;http:&nbsp;Handler&nbsp;timeout&#34;</span><span class="op" id="3561182">)</span><br>
<span class="lineno">1900</span><br>
<span class="lineno"></span><span class="keyword" id="3561185">type</span>&nbsp;<span class="ident" id="3561190">timeoutHandler</span>&nbsp;<span class="keyword" id="3561205">struct</span>&nbsp;<span class="op" id="3561212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561215">handler</span>&nbsp;<span class="ident" id="3561223">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561232">timeout</span>&nbsp;<span class="keyword" id="3561240">func</span><span class="op" id="3561244">(</span><span class="op" id="3561245">)</span>&nbsp;<span class="op" id="3561247">&lt;-</span><span class="keyword" id="3561249">chan</span>&nbsp;<span class="ident" id="3561254">time</span><span class="op" id="3561258">.</span><span class="ident" id="3561259">Time</span>&nbsp;<span class="comment" id="3561264">//&nbsp;returns&nbsp;channel&nbsp;producing&nbsp;a&nbsp;timeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561304">body</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3561312">string</span><br>
<span class="lineno">1905</span><span class="op" id="3561319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3561322">func</span>&nbsp;<span class="op" id="3561327">(</span><span class="ident" id="3561328">h</span>&nbsp;<span class="op" id="3561330">*</span><span class="ident" id="3561331">timeoutHandler</span><span class="op" id="3561345">)</span>&nbsp;<span class="ident" id="3561347">errorBody</span><span class="op" id="3561356">(</span><span class="op" id="3561357">)</span>&nbsp;<span class="builtintype" id="3561359">string</span>&nbsp;<span class="op" id="3561366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561369">if</span>&nbsp;<span class="ident" id="3561372">h</span><span class="op" id="3561373">.</span><span class="ident" id="3561374">body</span>&nbsp;<span class="op" id="3561379">!=</span>&nbsp;<span class="string" id="3561382">&#34;&#34;</span>&nbsp;<span class="op" id="3561385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561389">return</span>&nbsp;<span class="ident" id="3561396">h</span><span class="op" id="3561397">.</span><span class="ident" id="3561398">body</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3561404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561407">return</span>&nbsp;<span class="string" id="3561414">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Timeout&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Timeout&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3561494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3561497">func</span>&nbsp;<span class="op" id="3561502">(</span><span class="ident" id="3561503">h</span>&nbsp;<span class="op" id="3561505">*</span><span class="ident" id="3561506">timeoutHandler</span><span class="op" id="3561520">)</span>&nbsp;<span class="ident" id="3561522">ServeHTTP</span><span class="op" id="3561531">(</span><span class="ident" id="3561532">w</span>&nbsp;<span class="ident" id="3561534">ResponseWriter</span><span class="op" id="3561548">,</span>&nbsp;<span class="ident" id="3561550">r</span>&nbsp;<span class="op" id="3561552">*</span><span class="ident" id="3561553">Request</span><span class="op" id="3561560">)</span>&nbsp;<span class="op" id="3561562">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561565">done</span>&nbsp;<span class="op" id="3561570">:=</span>&nbsp;<span class="builtinfunc" id="3561573">make</span><span class="op" id="3561577">(</span><span class="keyword" id="3561578">chan</span>&nbsp;<span class="builtintype" id="3561583">bool</span><span class="op" id="3561587">,</span>&nbsp;<span class="num" id="3561589">1</span><span class="op" id="3561590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561593">tw</span>&nbsp;<span class="op" id="3561596">:=</span>&nbsp;<span class="op" id="3561599">&amp;</span><span class="ident" id="3561600">timeoutWriter</span><span class="op" id="3561613">{</span><span class="ident" id="3561614">w</span><span class="op" id="3561615">:</span>&nbsp;<span class="ident" id="3561617">w</span><span class="op" id="3561618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561621">go</span>&nbsp;<span class="keyword" id="3561624">func</span><span class="op" id="3561628">(</span><span class="op" id="3561629">)</span>&nbsp;<span class="op" id="3561631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561635">h</span><span class="op" id="3561636">.</span><span class="ident" id="3561637">handler</span><span class="op" id="3561644">.</span><span class="ident" id="3561645">ServeHTTP</span><span class="op" id="3561654">(</span><span class="ident" id="3561655">tw</span><span class="op" id="3561657">,</span>&nbsp;<span class="ident" id="3561659">r</span><span class="op" id="3561660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561664">done</span>&nbsp;<span class="op" id="3561669">&lt;-</span>&nbsp;<span class="builtintype" id="3561672">true</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3561678">}</span><span class="op" id="3561679">(</span><span class="op" id="3561680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561683">select</span>&nbsp;<span class="op" id="3561690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561693">case</span>&nbsp;<span class="op" id="3561698">&lt;-</span><span class="ident" id="3561700">done</span><span class="op" id="3561704">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561708">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561716">case</span>&nbsp;<span class="op" id="3561721">&lt;-</span><span class="ident" id="3561723">h</span><span class="op" id="3561724">.</span><span class="ident" id="3561725">timeout</span><span class="op" id="3561732">(</span><span class="op" id="3561733">)</span><span class="op" id="3561734">:</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561738">tw</span><span class="op" id="3561740">.</span><span class="ident" id="3561741">mu</span><span class="op" id="3561743">.</span><span class="ident" id="3561744">Lock</span><span class="op" id="3561748">(</span><span class="op" id="3561749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561753">defer</span>&nbsp;<span class="ident" id="3561759">tw</span><span class="op" id="3561761">.</span><span class="ident" id="3561762">mu</span><span class="op" id="3561764">.</span><span class="ident" id="3561765">Unlock</span><span class="op" id="3561771">(</span><span class="op" id="3561772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3561776">if</span>&nbsp;<span class="op" id="3561779">!</span><span class="ident" id="3561780">tw</span><span class="op" id="3561782">.</span><span class="ident" id="3561783">wroteHeader</span>&nbsp;<span class="op" id="3561795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561800">tw</span><span class="op" id="3561802">.</span><span class="ident" id="3561803">w</span><span class="op" id="3561804">.</span><span class="ident" id="3561805">WriteHeader</span><span class="op" id="3561816">(</span><span class="ident" id="3561817">StatusServiceUnavailable</span><span class="op" id="3561841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561846">tw</span><span class="op" id="3561848">.</span><span class="ident" id="3561849">w</span><span class="op" id="3561850">.</span><span class="ident" id="3561851">Write</span><span class="op" id="3561856">(</span><span class="op" id="3561857">[</span><span class="op" id="3561858">]</span><span class="builtintype" id="3561859">byte</span><span class="op" id="3561863">(</span><span class="ident" id="3561864">h</span><span class="op" id="3561865">.</span><span class="ident" id="3561866">errorBody</span><span class="op" id="3561875">(</span><span class="op" id="3561876">)</span><span class="op" id="3561877">)</span><span class="op" id="3561878">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3561882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561886">tw</span><span class="op" id="3561888">.</span><span class="ident" id="3561889">timedOut</span>&nbsp;<span class="op" id="3561898">=</span>&nbsp;<span class="builtintype" id="3561900">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3561906">}</span><br>
<span class="lineno"></span><span class="op" id="3561908">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1935</span><span class="keyword" id="3561911">type</span>&nbsp;<span class="ident" id="3561916">timeoutWriter</span>&nbsp;<span class="keyword" id="3561930">struct</span>&nbsp;<span class="op" id="3561937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561940">w</span>&nbsp;<span class="ident" id="3561942">ResponseWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561959">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561971">sync</span><span class="op" id="3561975">.</span><span class="ident" id="3561976">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3561983">timedOut</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3561995">bool</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562001">wroteHeader</span>&nbsp;<span class="builtintype" id="3562013">bool</span><br>
<span class="lineno"></span><span class="op" id="3562018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3562021">func</span>&nbsp;<span class="op" id="3562026">(</span><span class="ident" id="3562027">tw</span>&nbsp;<span class="op" id="3562030">*</span><span class="ident" id="3562031">timeoutWriter</span><span class="op" id="3562044">)</span>&nbsp;<span class="ident" id="3562046">Header</span><span class="op" id="3562052">(</span><span class="op" id="3562053">)</span>&nbsp;<span class="ident" id="3562055">Header</span>&nbsp;<span class="op" id="3562062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3562065">return</span>&nbsp;<span class="ident" id="3562072">tw</span><span class="op" id="3562074">.</span><span class="ident" id="3562075">w</span><span class="op" id="3562076">.</span><span class="ident" id="3562077">Header</span><span class="op" id="3562083">(</span><span class="op" id="3562084">)</span><br>
<span class="lineno">1945</span><span class="op" id="3562086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3562089">func</span>&nbsp;<span class="op" id="3562094">(</span><span class="ident" id="3562095">tw</span>&nbsp;<span class="op" id="3562098">*</span><span class="ident" id="3562099">timeoutWriter</span><span class="op" id="3562112">)</span>&nbsp;<span class="ident" id="3562114">Write</span><span class="op" id="3562119">(</span><span class="ident" id="3562120">p</span>&nbsp;<span class="op" id="3562122">[</span><span class="op" id="3562123">]</span><span class="builtintype" id="3562124">byte</span><span class="op" id="3562128">)</span>&nbsp;<span class="op" id="3562130">(</span><span class="builtintype" id="3562131">int</span><span class="op" id="3562134">,</span>&nbsp;<span class="builtintype" id="3562136">error</span><span class="op" id="3562141">)</span>&nbsp;<span class="op" id="3562143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562146">tw</span><span class="op" id="3562148">.</span><span class="ident" id="3562149">mu</span><span class="op" id="3562151">.</span><span class="ident" id="3562152">Lock</span><span class="op" id="3562156">(</span><span class="op" id="3562157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3562160">defer</span>&nbsp;<span class="ident" id="3562166">tw</span><span class="op" id="3562168">.</span><span class="ident" id="3562169">mu</span><span class="op" id="3562171">.</span><span class="ident" id="3562172">Unlock</span><span class="op" id="3562178">(</span><span class="op" id="3562179">)</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562182">tw</span><span class="op" id="3562184">.</span><span class="ident" id="3562185">wroteHeader</span>&nbsp;<span class="op" id="3562197">=</span>&nbsp;<span class="builtintype" id="3562199">true</span>&nbsp;<span class="comment" id="3562204">//&nbsp;implicitly&nbsp;at&nbsp;least</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3562228">if</span>&nbsp;<span class="ident" id="3562231">tw</span><span class="op" id="3562233">.</span><span class="ident" id="3562234">timedOut</span>&nbsp;<span class="op" id="3562243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3562247">return</span>&nbsp;<span class="num" id="3562254">0</span><span class="op" id="3562255">,</span>&nbsp;<span class="ident" id="3562257">ErrHandlerTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3562276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3562279">return</span>&nbsp;<span class="ident" id="3562286">tw</span><span class="op" id="3562288">.</span><span class="ident" id="3562289">w</span><span class="op" id="3562290">.</span><span class="ident" id="3562291">Write</span><span class="op" id="3562296">(</span><span class="ident" id="3562297">p</span><span class="op" id="3562298">)</span><br>
<span class="lineno">1955</span><span class="op" id="3562300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3562303">func</span>&nbsp;<span class="op" id="3562308">(</span><span class="ident" id="3562309">tw</span>&nbsp;<span class="op" id="3562312">*</span><span class="ident" id="3562313">timeoutWriter</span><span class="op" id="3562326">)</span>&nbsp;<span class="ident" id="3562328">WriteHeader</span><span class="op" id="3562339">(</span><span class="ident" id="3562340">code</span>&nbsp;<span class="builtintype" id="3562345">int</span><span class="op" id="3562348">)</span>&nbsp;<span class="op" id="3562350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562353">tw</span><span class="op" id="3562355">.</span><span class="ident" id="3562356">mu</span><span class="op" id="3562358">.</span><span class="ident" id="3562359">Lock</span><span class="op" id="3562363">(</span><span class="op" id="3562364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3562367">defer</span>&nbsp;<span class="ident" id="3562373">tw</span><span class="op" id="3562375">.</span><span class="ident" id="3562376">mu</span><span class="op" id="3562378">.</span><span class="ident" id="3562379">Unlock</span><span class="op" id="3562385">(</span><span class="op" id="3562386">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3562389">if</span>&nbsp;<span class="ident" id="3562392">tw</span><span class="op" id="3562394">.</span><span class="ident" id="3562395">timedOut</span>&nbsp;<span class="op" id="3562404">||</span>&nbsp;<span class="ident" id="3562407">tw</span><span class="op" id="3562409">.</span><span class="ident" id="3562410">wroteHeader</span>&nbsp;<span class="op" id="3562422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3562426">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3562434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562437">tw</span><span class="op" id="3562439">.</span><span class="ident" id="3562440">wroteHeader</span>&nbsp;<span class="op" id="3562452">=</span>&nbsp;<span class="builtintype" id="3562454">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562460">tw</span><span class="op" id="3562462">.</span><span class="ident" id="3562463">w</span><span class="op" id="3562464">.</span><span class="ident" id="3562465">WriteHeader</span><span class="op" id="3562476">(</span><span class="ident" id="3562477">code</span><span class="op" id="3562481">)</span><br>
<span class="lineno">1965</span><span class="op" id="3562483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3562486">//&nbsp;tcpKeepAliveListener&nbsp;sets&nbsp;TCP&nbsp;keep-alive&nbsp;timeouts&nbsp;on&nbsp;accepted</span><br>
<span class="lineno"></span><span class="comment" id="3562551">//&nbsp;connections.&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;ListenAndServe&nbsp;and&nbsp;ListenAndServeTLS&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="3562620">//&nbsp;dead&nbsp;TCP&nbsp;connections&nbsp;(e.g.&nbsp;closing&nbsp;laptop&nbsp;mid-download)&nbsp;eventually</span><br>
<span class="lineno">1970</span><span class="comment" id="3562690">//&nbsp;go&nbsp;away.</span><br>
<span class="lineno"></span><span class="keyword" id="3562702">type</span>&nbsp;<span class="ident" id="3562707">tcpKeepAliveListener</span>&nbsp;<span class="keyword" id="3562728">struct</span>&nbsp;<span class="op" id="3562735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3562738">*</span><span class="ident" id="3562739">net</span><span class="op" id="3562742">.</span><span class="ident" id="3562743">TCPListener</span><br>
<span class="lineno"></span><span class="op" id="3562755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1975</span><span class="keyword" id="3562758">func</span>&nbsp;<span class="op" id="3562763">(</span><span class="ident" id="3562764">ln</span>&nbsp;<span class="ident" id="3562767">tcpKeepAliveListener</span><span class="op" id="3562787">)</span>&nbsp;<span class="ident" id="3562789">Accept</span><span class="op" id="3562795">(</span><span class="op" id="3562796">)</span>&nbsp;<span class="op" id="3562798">(</span><span class="ident" id="3562799">c</span>&nbsp;<span class="ident" id="3562801">net</span><span class="op" id="3562804">.</span><span class="ident" id="3562805">Conn</span><span class="op" id="3562809">,</span>&nbsp;<span class="ident" id="3562811">err</span>&nbsp;<span class="builtintype" id="3562815">error</span><span class="op" id="3562820">)</span>&nbsp;<span class="op" id="3562822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562825">tc</span><span class="op" id="3562827">,</span>&nbsp;<span class="ident" id="3562829">err</span>&nbsp;<span class="op" id="3562833">:=</span>&nbsp;<span class="ident" id="3562836">ln</span><span class="op" id="3562838">.</span><span class="ident" id="3562839">AcceptTCP</span><span class="op" id="3562848">(</span><span class="op" id="3562849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3562852">if</span>&nbsp;<span class="ident" id="3562855">err</span>&nbsp;<span class="op" id="3562859">!=</span>&nbsp;<span class="ident" id="3562862">nil</span>&nbsp;<span class="op" id="3562866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3562870">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3562878">}</span><br>
<span class="lineno">1980</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562881">tc</span><span class="op" id="3562883">.</span><span class="ident" id="3562884">SetKeepAlive</span><span class="op" id="3562896">(</span><span class="builtintype" id="3562897">true</span><span class="op" id="3562901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3562904">tc</span><span class="op" id="3562906">.</span><span class="ident" id="3562907">SetKeepAlivePeriod</span><span class="op" id="3562925">(</span><span class="num" id="3562926">3</span>&nbsp;<span class="op" id="3562928">*</span>&nbsp;<span class="ident" id="3562930">time</span><span class="op" id="3562934">.</span><span class="ident" id="3562935">Minute</span><span class="op" id="3562941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3562944">return</span>&nbsp;<span class="ident" id="3562951">tc</span><span class="op" id="3562953">,</span>&nbsp;<span class="ident" id="3562955">nil</span><br>
<span class="lineno"></span><span class="op" id="3562959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1985</span><span class="comment" id="3562962">//&nbsp;globalOptionsHandler&nbsp;responds&nbsp;to&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3563020">type</span>&nbsp;<span class="ident" id="3563025">globalOptionsHandler</span>&nbsp;<span class="keyword" id="3563046">struct</span><span class="op" id="3563052">{</span><span class="op" id="3563053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3563056">func</span>&nbsp;<span class="op" id="3563061">(</span><span class="ident" id="3563062">globalOptionsHandler</span><span class="op" id="3563082">)</span>&nbsp;<span class="ident" id="3563084">ServeHTTP</span><span class="op" id="3563093">(</span><span class="ident" id="3563094">w</span>&nbsp;<span class="ident" id="3563096">ResponseWriter</span><span class="op" id="3563110">,</span>&nbsp;<span class="ident" id="3563112">r</span>&nbsp;<span class="op" id="3563114">*</span><span class="ident" id="3563115">Request</span><span class="op" id="3563122">)</span>&nbsp;<span class="op" id="3563124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563127">w</span><span class="op" id="3563128">.</span><span class="ident" id="3563129">Header</span><span class="op" id="3563135">(</span><span class="op" id="3563136">)</span><span class="op" id="3563137">.</span><span class="ident" id="3563138">Set</span><span class="op" id="3563141">(</span><span class="string" id="3563142">&#34;Content-Length&#34;</span><span class="op" id="3563158">,</span>&nbsp;<span class="string" id="3563160">&#34;0&#34;</span><span class="op" id="3563163">)</span><br>
<span class="lineno">1990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3563166">if</span>&nbsp;<span class="ident" id="3563169">r</span><span class="op" id="3563170">.</span><span class="ident" id="3563171">ContentLength</span>&nbsp;<span class="op" id="3563185">!=</span>&nbsp;<span class="num" id="3563188">0</span>&nbsp;<span class="op" id="3563190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3563194">//&nbsp;Read&nbsp;up&nbsp;to&nbsp;4KB&nbsp;of&nbsp;OPTIONS&nbsp;body&nbsp;(as&nbsp;mentioned&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3563251">//&nbsp;spec&nbsp;as&nbsp;being&nbsp;reserved&nbsp;for&nbsp;future&nbsp;use),&nbsp;but&nbsp;anything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3563309">//&nbsp;over&nbsp;that&nbsp;is&nbsp;considered&nbsp;a&nbsp;waste&nbsp;of&nbsp;server&nbsp;resources</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3563366">//&nbsp;(or&nbsp;an&nbsp;attack)&nbsp;and&nbsp;we&nbsp;abort&nbsp;and&nbsp;close&nbsp;the&nbsp;connection,</span><br>
<span class="lineno">1995</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3563425">//&nbsp;courtesy&nbsp;of&nbsp;MaxBytesReader&#39;s&nbsp;EOF&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563473">mb</span>&nbsp;<span class="op" id="3563476">:=</span>&nbsp;<span class="ident" id="3563479">MaxBytesReader</span><span class="op" id="3563493">(</span><span class="ident" id="3563494">w</span><span class="op" id="3563495">,</span>&nbsp;<span class="ident" id="3563497">r</span><span class="op" id="3563498">.</span><span class="ident" id="3563499">Body</span><span class="op" id="3563503">,</span>&nbsp;<span class="num" id="3563505">4</span><span class="op" id="3563506">&lt;&lt;</span><span class="num" id="3563508">10</span><span class="op" id="3563510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563514">io</span><span class="op" id="3563516">.</span><span class="ident" id="3563517">Copy</span><span class="op" id="3563521">(</span><span class="ident" id="3563522">ioutil</span><span class="op" id="3563528">.</span><span class="ident" id="3563529">Discard</span><span class="op" id="3563536">,</span>&nbsp;<span class="ident" id="3563538">mb</span><span class="op" id="3563540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3563543">}</span><br>
<span class="lineno"></span><span class="op" id="3563545">}</span><br>
<span class="lineno">2000</span><br>
<span class="lineno"></span><span class="keyword" id="3563548">type</span>&nbsp;<span class="ident" id="3563553">eofReaderWithWriteTo</span>&nbsp;<span class="keyword" id="3563574">struct</span><span class="op" id="3563580">{</span><span class="op" id="3563581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3563584">func</span>&nbsp;<span class="op" id="3563589">(</span><span class="ident" id="3563590">eofReaderWithWriteTo</span><span class="op" id="3563610">)</span>&nbsp;<span class="ident" id="3563612">WriteTo</span><span class="op" id="3563619">(</span><span class="ident" id="3563620">io</span><span class="op" id="3563622">.</span><span class="ident" id="3563623">Writer</span><span class="op" id="3563629">)</span>&nbsp;<span class="op" id="3563631">(</span><span class="ident" id="3563632">int64</span><span class="op" id="3563637">,</span>&nbsp;<span class="builtintype" id="3563639">error</span><span class="op" id="3563644">)</span>&nbsp;<span class="op" id="3563646">{</span>&nbsp;<span class="keyword" id="3563648">return</span>&nbsp;<span class="num" id="3563655">0</span><span class="op" id="3563656">,</span>&nbsp;<span class="ident" id="3563658">nil</span>&nbsp;<span class="op" id="3563662">}</span><br>
<span class="lineno"></span><span class="keyword" id="3563664">func</span>&nbsp;<span class="op" id="3563669">(</span><span class="ident" id="3563670">eofReaderWithWriteTo</span><span class="op" id="3563690">)</span>&nbsp;<span class="ident" id="3563692">Read</span><span class="op" id="3563696">(</span><span class="op" id="3563697">[</span><span class="op" id="3563698">]</span><span class="builtintype" id="3563699">byte</span><span class="op" id="3563703">)</span>&nbsp;<span class="op" id="3563705">(</span><span class="builtintype" id="3563706">int</span><span class="op" id="3563709">,</span>&nbsp;<span class="builtintype" id="3563711">error</span><span class="op" id="3563716">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3563726">{</span>&nbsp;<span class="keyword" id="3563728">return</span>&nbsp;<span class="num" id="3563735">0</span><span class="op" id="3563736">,</span>&nbsp;<span class="ident" id="3563738">io</span><span class="op" id="3563740">.</span><span class="ident" id="3563741">EOF</span>&nbsp;<span class="op" id="3563745">}</span><br>
<span class="lineno">2005</span><br>
<span class="lineno"></span><span class="comment" id="3563748">//&nbsp;eofReader&nbsp;is&nbsp;a&nbsp;non-nil&nbsp;io.ReadCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="comment" id="3563813">//&nbsp;It&nbsp;has&nbsp;a&nbsp;WriteTo&nbsp;method&nbsp;so&nbsp;io.Copy&nbsp;won&#39;t&nbsp;need&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3563872">var</span>&nbsp;<span class="ident" id="3563876">eofReader</span>&nbsp;<span class="op" id="3563886">=</span>&nbsp;<span class="op" id="3563888">&amp;</span><span class="keyword" id="3563889">struct</span>&nbsp;<span class="op" id="3563896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563899">eofReaderWithWriteTo</span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563921">io</span><span class="op" id="3563923">.</span><span class="ident" id="3563924">Closer</span><br>
<span class="lineno"></span><span class="op" id="3563931">}</span><span class="op" id="3563932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563935">eofReaderWithWriteTo</span><span class="op" id="3563955">{</span><span class="op" id="3563956">}</span><span class="op" id="3563957">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3563960">ioutil</span><span class="op" id="3563966">.</span><span class="ident" id="3563967">NopCloser</span><span class="op" id="3563976">(</span><span class="ident" id="3563977">nil</span><span class="op" id="3563980">)</span><span class="op" id="3563981">,</span><br>
<span class="lineno"></span><span class="op" id="3563983">}</span><br>
<span class="lineno">2015</span><br>
<span class="lineno"></span><span class="comment" id="3563986">//&nbsp;Verify&nbsp;that&nbsp;an&nbsp;io.Copy&nbsp;from&nbsp;an&nbsp;eofReader&nbsp;won&#39;t&nbsp;require&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3564054">var</span>&nbsp;<span class="ident" id="3564058">_</span>&nbsp;<span class="ident" id="3564060">io</span><span class="op" id="3564062">.</span><span class="ident" id="3564063">WriterTo</span>&nbsp;<span class="op" id="3564072">=</span>&nbsp;<span class="ident" id="3564074">eofReader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3564085">//&nbsp;initNPNRequest&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;that&nbsp;initializes&nbsp;certain</span><br>
<span class="lineno">2020</span><span class="comment" id="3564147">//&nbsp;uninitialized&nbsp;fields&nbsp;in&nbsp;its&nbsp;*Request.&nbsp;Such&nbsp;partially-initialized</span><br>
<span class="lineno"></span><span class="comment" id="3564215">//&nbsp;Requests&nbsp;come&nbsp;from&nbsp;NPN&nbsp;protocol&nbsp;handlers.</span><br>
<span class="lineno"></span><span class="keyword" id="3564260">type</span>&nbsp;<span class="ident" id="3564265">initNPNRequest</span>&nbsp;<span class="keyword" id="3564280">struct</span>&nbsp;<span class="op" id="3564287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564290">c</span>&nbsp;<span class="op" id="3564292">*</span><span class="ident" id="3564293">tls</span><span class="op" id="3564296">.</span><span class="ident" id="3564297">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564303">h</span>&nbsp;<span class="ident" id="3564305">serverHandler</span><br>
<span class="lineno">2025</span><span class="op" id="3564319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3564322">func</span>&nbsp;<span class="op" id="3564327">(</span><span class="ident" id="3564328">h</span>&nbsp;<span class="ident" id="3564330">initNPNRequest</span><span class="op" id="3564344">)</span>&nbsp;<span class="ident" id="3564346">ServeHTTP</span><span class="op" id="3564355">(</span><span class="ident" id="3564356">rw</span>&nbsp;<span class="ident" id="3564359">ResponseWriter</span><span class="op" id="3564373">,</span>&nbsp;<span class="ident" id="3564375">req</span>&nbsp;<span class="op" id="3564379">*</span><span class="ident" id="3564380">Request</span><span class="op" id="3564387">)</span>&nbsp;<span class="op" id="3564389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3564392">if</span>&nbsp;<span class="ident" id="3564395">req</span><span class="op" id="3564398">.</span><span class="ident" id="3564399">TLS</span>&nbsp;<span class="op" id="3564403">==</span>&nbsp;<span class="ident" id="3564406">nil</span>&nbsp;<span class="op" id="3564410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564414">req</span><span class="op" id="3564417">.</span><span class="ident" id="3564418">TLS</span>&nbsp;<span class="op" id="3564422">=</span>&nbsp;<span class="op" id="3564424">&amp;</span><span class="ident" id="3564425">tls</span><span class="op" id="3564428">.</span><span class="ident" id="3564429">ConnectionState</span><span class="op" id="3564444">{</span><span class="op" id="3564445">}</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3564449">*</span><span class="ident" id="3564450">req</span><span class="op" id="3564453">.</span><span class="ident" id="3564454">TLS</span>&nbsp;<span class="op" id="3564458">=</span>&nbsp;<span class="ident" id="3564460">h</span><span class="op" id="3564461">.</span><span class="ident" id="3564462">c</span><span class="op" id="3564463">.</span><span class="ident" id="3564464">ConnectionState</span><span class="op" id="3564479">(</span><span class="op" id="3564480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3564483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3564486">if</span>&nbsp;<span class="ident" id="3564489">req</span><span class="op" id="3564492">.</span><span class="ident" id="3564493">Body</span>&nbsp;<span class="op" id="3564498">==</span>&nbsp;<span class="ident" id="3564501">nil</span>&nbsp;<span class="op" id="3564505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564509">req</span><span class="op" id="3564512">.</span><span class="ident" id="3564513">Body</span>&nbsp;<span class="op" id="3564518">=</span>&nbsp;<span class="ident" id="3564520">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3564531">}</span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3564534">if</span>&nbsp;<span class="ident" id="3564537">req</span><span class="op" id="3564540">.</span><span class="ident" id="3564541">RemoteAddr</span>&nbsp;<span class="op" id="3564552">==</span>&nbsp;<span class="string" id="3564555">&#34;&#34;</span>&nbsp;<span class="op" id="3564558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564562">req</span><span class="op" id="3564565">.</span><span class="ident" id="3564566">RemoteAddr</span>&nbsp;<span class="op" id="3564577">=</span>&nbsp;<span class="ident" id="3564579">h</span><span class="op" id="3564580">.</span><span class="ident" id="3564581">c</span><span class="op" id="3564582">.</span><span class="ident" id="3564583">RemoteAddr</span><span class="op" id="3564593">(</span><span class="op" id="3564594">)</span><span class="op" id="3564595">.</span><span class="ident" id="3564596">String</span><span class="op" id="3564602">(</span><span class="op" id="3564603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3564606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564609">h</span><span class="op" id="3564610">.</span><span class="ident" id="3564611">h</span><span class="op" id="3564612">.</span><span class="ident" id="3564613">ServeHTTP</span><span class="op" id="3564622">(</span><span class="ident" id="3564623">rw</span><span class="op" id="3564625">,</span>&nbsp;<span class="ident" id="3564627">req</span><span class="op" id="3564630">)</span><br>
<span class="lineno"></span><span class="op" id="3564632">}</span><br>
<span class="lineno">2040</span><br>
<span class="lineno"></span><span class="comment" id="3564635">//&nbsp;loggingConn&nbsp;is&nbsp;used&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="keyword" id="3564673">type</span>&nbsp;<span class="ident" id="3564678">loggingConn</span>&nbsp;<span class="keyword" id="3564690">struct</span>&nbsp;<span class="op" id="3564697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564700">name</span>&nbsp;<span class="builtintype" id="3564705">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564713">net</span><span class="op" id="3564716">.</span><span class="ident" id="3564717">Conn</span><br>
<span class="lineno">2045</span><span class="op" id="3564722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3564725">var</span>&nbsp;<span class="op" id="3564729">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564732">uniqNameMu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3564745">sync</span><span class="op" id="3564749">.</span><span class="ident" id="3564750">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564757">uniqNameNext</span>&nbsp;<span class="op" id="3564770">=</span>&nbsp;<span class="builtinfunc" id="3564772">make</span><span class="op" id="3564776">(</span><span class="keyword" id="3564777">map</span><span class="op" id="3564780">[</span><span class="builtintype" id="3564781">string</span><span class="op" id="3564787">]</span><span class="builtintype" id="3564788">int</span><span class="op" id="3564791">)</span><br>
<span class="lineno">2050</span><span class="op" id="3564793">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3564796">func</span>&nbsp;<span class="ident" id="3564801">newLoggingConn</span><span class="op" id="3564815">(</span><span class="ident" id="3564816">baseName</span>&nbsp;<span class="builtintype" id="3564825">string</span><span class="op" id="3564831">,</span>&nbsp;<span class="ident" id="3564833">c</span>&nbsp;<span class="ident" id="3564835">net</span><span class="op" id="3564838">.</span><span class="ident" id="3564839">Conn</span><span class="op" id="3564843">)</span>&nbsp;<span class="ident" id="3564845">net</span><span class="op" id="3564848">.</span><span class="ident" id="3564849">Conn</span>&nbsp;<span class="op" id="3564854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564857">uniqNameMu</span><span class="op" id="3564867">.</span><span class="ident" id="3564868">Lock</span><span class="op" id="3564872">(</span><span class="op" id="3564873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3564876">defer</span>&nbsp;<span class="ident" id="3564882">uniqNameMu</span><span class="op" id="3564892">.</span><span class="ident" id="3564893">Unlock</span><span class="op" id="3564899">(</span><span class="op" id="3564900">)</span><br>
<span class="lineno">2055</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564903">uniqNameNext</span><span class="op" id="3564915">[</span><span class="ident" id="3564916">baseName</span><span class="op" id="3564924">]</span><span class="op" id="3564925">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3564929">return</span>&nbsp;<span class="op" id="3564936">&amp;</span><span class="ident" id="3564937">loggingConn</span><span class="op" id="3564948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3564952">name</span><span class="op" id="3564956">:</span>&nbsp;<span class="ident" id="3564958">fmt</span><span class="op" id="3564961">.</span><span class="ident" id="3564962">Sprintf</span><span class="op" id="3564969">(</span><span class="string" id="3564970">&#34;%s-%d&#34;</span><span class="op" id="3564977">,</span>&nbsp;<span class="ident" id="3564979">baseName</span><span class="op" id="3564987">,</span>&nbsp;<span class="ident" id="3564989">uniqNameNext</span><span class="op" id="3565001">[</span><span class="ident" id="3565002">baseName</span><span class="op" id="3565010">]</span><span class="op" id="3565011">)</span><span class="op" id="3565012">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565016">Conn</span><span class="op" id="3565020">:</span>&nbsp;<span class="ident" id="3565022">c</span><span class="op" id="3565023">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3565026">}</span><br>
<span class="lineno">2060</span><span class="op" id="3565028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3565031">func</span>&nbsp;<span class="op" id="3565036">(</span><span class="ident" id="3565037">c</span>&nbsp;<span class="op" id="3565039">*</span><span class="ident" id="3565040">loggingConn</span><span class="op" id="3565051">)</span>&nbsp;<span class="ident" id="3565053">Write</span><span class="op" id="3565058">(</span><span class="ident" id="3565059">p</span>&nbsp;<span class="op" id="3565061">[</span><span class="op" id="3565062">]</span><span class="builtintype" id="3565063">byte</span><span class="op" id="3565067">)</span>&nbsp;<span class="op" id="3565069">(</span><span class="ident" id="3565070">n</span>&nbsp;<span class="builtintype" id="3565072">int</span><span class="op" id="3565075">,</span>&nbsp;<span class="ident" id="3565077">err</span>&nbsp;<span class="builtintype" id="3565081">error</span><span class="op" id="3565086">)</span>&nbsp;<span class="op" id="3565088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565091">log</span><span class="op" id="3565094">.</span><span class="ident" id="3565095">Printf</span><span class="op" id="3565101">(</span><span class="string" id="3565102">&#34;%s.Write(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3565123">,</span>&nbsp;<span class="ident" id="3565125">c</span><span class="op" id="3565126">.</span><span class="ident" id="3565127">name</span><span class="op" id="3565131">,</span>&nbsp;<span class="builtinfunc" id="3565133">len</span><span class="op" id="3565136">(</span><span class="ident" id="3565137">p</span><span class="op" id="3565138">)</span><span class="op" id="3565139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565142">n</span><span class="op" id="3565143">,</span>&nbsp;<span class="ident" id="3565145">err</span>&nbsp;<span class="op" id="3565149">=</span>&nbsp;<span class="ident" id="3565151">c</span><span class="op" id="3565152">.</span><span class="ident" id="3565153">Conn</span><span class="op" id="3565157">.</span><span class="ident" id="3565158">Write</span><span class="op" id="3565163">(</span><span class="ident" id="3565164">p</span><span class="op" id="3565165">)</span><br>
<span class="lineno">2065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565168">log</span><span class="op" id="3565171">.</span><span class="ident" id="3565172">Printf</span><span class="op" id="3565178">(</span><span class="string" id="3565179">&#34;%s.Write(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3565202">,</span>&nbsp;<span class="ident" id="3565204">c</span><span class="op" id="3565205">.</span><span class="ident" id="3565206">name</span><span class="op" id="3565210">,</span>&nbsp;<span class="builtinfunc" id="3565212">len</span><span class="op" id="3565215">(</span><span class="ident" id="3565216">p</span><span class="op" id="3565217">)</span><span class="op" id="3565218">,</span>&nbsp;<span class="ident" id="3565220">n</span><span class="op" id="3565221">,</span>&nbsp;<span class="ident" id="3565223">err</span><span class="op" id="3565226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3565229">return</span><br>
<span class="lineno"></span><span class="op" id="3565236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3565239">func</span>&nbsp;<span class="op" id="3565244">(</span><span class="ident" id="3565245">c</span>&nbsp;<span class="op" id="3565247">*</span><span class="ident" id="3565248">loggingConn</span><span class="op" id="3565259">)</span>&nbsp;<span class="ident" id="3565261">Read</span><span class="op" id="3565265">(</span><span class="ident" id="3565266">p</span>&nbsp;<span class="op" id="3565268">[</span><span class="op" id="3565269">]</span><span class="builtintype" id="3565270">byte</span><span class="op" id="3565274">)</span>&nbsp;<span class="op" id="3565276">(</span><span class="ident" id="3565277">n</span>&nbsp;<span class="builtintype" id="3565279">int</span><span class="op" id="3565282">,</span>&nbsp;<span class="ident" id="3565284">err</span>&nbsp;<span class="builtintype" id="3565288">error</span><span class="op" id="3565293">)</span>&nbsp;<span class="op" id="3565295">{</span><br>
<span class="lineno">2070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565298">log</span><span class="op" id="3565301">.</span><span class="ident" id="3565302">Printf</span><span class="op" id="3565308">(</span><span class="string" id="3565309">&#34;%s.Read(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3565329">,</span>&nbsp;<span class="ident" id="3565331">c</span><span class="op" id="3565332">.</span><span class="ident" id="3565333">name</span><span class="op" id="3565337">,</span>&nbsp;<span class="builtinfunc" id="3565339">len</span><span class="op" id="3565342">(</span><span class="ident" id="3565343">p</span><span class="op" id="3565344">)</span><span class="op" id="3565345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565348">n</span><span class="op" id="3565349">,</span>&nbsp;<span class="ident" id="3565351">err</span>&nbsp;<span class="op" id="3565355">=</span>&nbsp;<span class="ident" id="3565357">c</span><span class="op" id="3565358">.</span><span class="ident" id="3565359">Conn</span><span class="op" id="3565363">.</span><span class="ident" id="3565364">Read</span><span class="op" id="3565368">(</span><span class="ident" id="3565369">p</span><span class="op" id="3565370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565373">log</span><span class="op" id="3565376">.</span><span class="ident" id="3565377">Printf</span><span class="op" id="3565383">(</span><span class="string" id="3565384">&#34;%s.Read(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3565406">,</span>&nbsp;<span class="ident" id="3565408">c</span><span class="op" id="3565409">.</span><span class="ident" id="3565410">name</span><span class="op" id="3565414">,</span>&nbsp;<span class="builtinfunc" id="3565416">len</span><span class="op" id="3565419">(</span><span class="ident" id="3565420">p</span><span class="op" id="3565421">)</span><span class="op" id="3565422">,</span>&nbsp;<span class="ident" id="3565424">n</span><span class="op" id="3565425">,</span>&nbsp;<span class="ident" id="3565427">err</span><span class="op" id="3565430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3565433">return</span><br>
<span class="lineno"></span><span class="op" id="3565440">}</span><br>
<span class="lineno">2075</span><br>
<span class="lineno"></span><span class="keyword" id="3565443">func</span>&nbsp;<span class="op" id="3565448">(</span><span class="ident" id="3565449">c</span>&nbsp;<span class="op" id="3565451">*</span><span class="ident" id="3565452">loggingConn</span><span class="op" id="3565463">)</span>&nbsp;<span class="ident" id="3565465">Close</span><span class="op" id="3565470">(</span><span class="op" id="3565471">)</span>&nbsp;<span class="op" id="3565473">(</span><span class="ident" id="3565474">err</span>&nbsp;<span class="builtintype" id="3565478">error</span><span class="op" id="3565483">)</span>&nbsp;<span class="op" id="3565485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565488">log</span><span class="op" id="3565491">.</span><span class="ident" id="3565492">Printf</span><span class="op" id="3565498">(</span><span class="string" id="3565499">&#34;%s.Close()&nbsp;=&nbsp;...&#34;</span><span class="op" id="3565517">,</span>&nbsp;<span class="ident" id="3565519">c</span><span class="op" id="3565520">.</span><span class="ident" id="3565521">name</span><span class="op" id="3565525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565528">err</span>&nbsp;<span class="op" id="3565532">=</span>&nbsp;<span class="ident" id="3565534">c</span><span class="op" id="3565535">.</span><span class="ident" id="3565536">Conn</span><span class="op" id="3565540">.</span><span class="ident" id="3565541">Close</span><span class="op" id="3565546">(</span><span class="op" id="3565547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565550">log</span><span class="op" id="3565553">.</span><span class="ident" id="3565554">Printf</span><span class="op" id="3565560">(</span><span class="string" id="3565561">&#34;%s.Close()&nbsp;=&nbsp;%v&#34;</span><span class="op" id="3565578">,</span>&nbsp;<span class="ident" id="3565580">c</span><span class="op" id="3565581">.</span><span class="ident" id="3565582">name</span><span class="op" id="3565586">,</span>&nbsp;<span class="ident" id="3565588">err</span><span class="op" id="3565591">)</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3565594">return</span><br>
<span class="lineno"></span><span class="op" id="3565601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3565604">//&nbsp;checkConnErrorWriter&nbsp;writes&nbsp;to&nbsp;c.rwc&nbsp;and&nbsp;records&nbsp;any&nbsp;write&nbsp;errors&nbsp;to&nbsp;c.werr.</span><br>
<span class="lineno"></span><span class="comment" id="3565684">//&nbsp;It&nbsp;only&nbsp;contains&nbsp;one&nbsp;field&nbsp;(and&nbsp;a&nbsp;pointer&nbsp;field&nbsp;at&nbsp;that),&nbsp;so&nbsp;it</span><br>
<span class="lineno">2085</span><span class="comment" id="3565751">//&nbsp;fits&nbsp;in&nbsp;an&nbsp;interface&nbsp;value&nbsp;without&nbsp;an&nbsp;extra&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="3565810">type</span>&nbsp;<span class="ident" id="3565815">checkConnErrorWriter</span>&nbsp;<span class="keyword" id="3565836">struct</span>&nbsp;<span class="op" id="3565843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565846">c</span>&nbsp;<span class="op" id="3565848">*</span><span class="ident" id="3565849">conn</span><br>
<span class="lineno"></span><span class="op" id="3565854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2090</span><span class="keyword" id="3565857">func</span>&nbsp;<span class="op" id="3565862">(</span><span class="ident" id="3565863">w</span>&nbsp;<span class="ident" id="3565865">checkConnErrorWriter</span><span class="op" id="3565885">)</span>&nbsp;<span class="ident" id="3565887">Write</span><span class="op" id="3565892">(</span><span class="ident" id="3565893">p</span>&nbsp;<span class="op" id="3565895">[</span><span class="op" id="3565896">]</span><span class="builtintype" id="3565897">byte</span><span class="op" id="3565901">)</span>&nbsp;<span class="op" id="3565903">(</span><span class="ident" id="3565904">n</span>&nbsp;<span class="builtintype" id="3565906">int</span><span class="op" id="3565909">,</span>&nbsp;<span class="ident" id="3565911">err</span>&nbsp;<span class="builtintype" id="3565915">error</span><span class="op" id="3565920">)</span>&nbsp;<span class="op" id="3565922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3565925">n</span><span class="op" id="3565926">,</span>&nbsp;<span class="ident" id="3565928">err</span>&nbsp;<span class="op" id="3565932">=</span>&nbsp;<span class="ident" id="3565934">w</span><span class="op" id="3565935">.</span><span class="ident" id="3565936">c</span><span class="op" id="3565937">.</span><span class="ident" id="3565938">w</span><span class="op" id="3565939">.</span><span class="ident" id="3565940">Write</span><span class="op" id="3565945">(</span><span class="ident" id="3565946">p</span><span class="op" id="3565947">)</span>&nbsp;<span class="comment" id="3565949">//&nbsp;c.w&nbsp;==&nbsp;c.rwc,&nbsp;except&nbsp;after&nbsp;a&nbsp;hijack,&nbsp;when&nbsp;rwc&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3566007">if</span>&nbsp;<span class="ident" id="3566010">err</span>&nbsp;<span class="op" id="3566014">!=</span>&nbsp;<span class="ident" id="3566017">nil</span>&nbsp;<span class="op" id="3566021">&amp;&amp;</span>&nbsp;<span class="ident" id="3566024">w</span><span class="op" id="3566025">.</span><span class="ident" id="3566026">c</span><span class="op" id="3566027">.</span><span class="ident" id="3566028">werr</span>&nbsp;<span class="op" id="3566033">==</span>&nbsp;<span class="ident" id="3566036">nil</span>&nbsp;<span class="op" id="3566040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3566044">w</span><span class="op" id="3566045">.</span><span class="ident" id="3566046">c</span><span class="op" id="3566047">.</span><span class="ident" id="3566048">werr</span>&nbsp;<span class="op" id="3566053">=</span>&nbsp;<span class="ident" id="3566055">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3566060">}</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3566063">return</span><br>
<span class="lineno"></span><span class="op" id="3566070">}</span>
</div>
</body>
</html>
