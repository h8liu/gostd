<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>html/template</h2>
<ul>
<li><a href="/gostd/html/template/attr.go.html">attr.go</a></li>
<li><a href="/gostd/html/template/clone_test.go.html">clone_test.go</a></li>
<li><a href="/gostd/html/template/content.go.html">content.go</a></li>
<li><a href="/gostd/html/template/content_test.go.html">content_test.go</a></li>
<li><a href="/gostd/html/template/context.go.html">context.go</a></li>
<li><a href="/gostd/html/template/css.go.html">css.go</a></li>
<li><a href="/gostd/html/template/css_test.go.html">css_test.go</a></li>
<li><a href="/gostd/html/template/doc.go.html">doc.go</a></li>
<li><a href="/gostd/html/template/error.go.html">error.go</a></li>
<li><a href="/gostd/html/template/escape.go.html">escape.go</a></li>
<li><a href="/gostd/html/template/escape_test.go.html">escape_test.go</a></li>
<li><a href="/gostd/html/template/html.go.html">html.go</a></li>
<li><a href="/gostd/html/template/html_test.go.html">html_test.go</a></li>
<li><a href="/gostd/html/template/js.go.html">js.go</a></li>
<li><a href="/gostd/html/template/js_test.go.html">js_test.go</a></li>
<li><a href="/gostd/html/template/template.go.html">template.go</a></li>
<li><a href="/gostd/html/template/transition.go.html">transition.go</a></li>
<li><a href="/gostd/html/template/url.go.html">url.go</a></li>
<li><a href="/gostd/html/template/url_test.go.html">url_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4587249">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4587304">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4587358">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4587409">package</span>&nbsp;<span class="ident" id="4587417">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4587427">import</span>&nbsp;<span class="op" id="4587434">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4587437">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4587446">&#34;encoding/json&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4587463">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4587470">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4587481">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4587492">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="4587507">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="4587510">//&nbsp;nextJSCtx&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;determines&nbsp;whether&nbsp;a&nbsp;slash&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4587585">//&nbsp;given&nbsp;run&nbsp;of&nbsp;tokens&nbsp;starts&nbsp;a&nbsp;regular&nbsp;expression&nbsp;instead&nbsp;of&nbsp;a&nbsp;division</span><br>
<span class="lineno"></span><span class="comment" id="4587658">//&nbsp;operator:&nbsp;/&nbsp;or&nbsp;/=.</span><br>
<span class="lineno"></span><span class="comment" id="4587680">//</span><br>
<span class="lineno">20</span><span class="comment" id="4587683">//&nbsp;This&nbsp;assumes&nbsp;that&nbsp;the&nbsp;token&nbsp;run&nbsp;does&nbsp;not&nbsp;include&nbsp;any&nbsp;string&nbsp;tokens,&nbsp;comment</span><br>
<span class="lineno"></span><span class="comment" id="4587762">//&nbsp;tokens,&nbsp;regular&nbsp;expression&nbsp;literal&nbsp;tokens,&nbsp;or&nbsp;division&nbsp;operators.</span><br>
<span class="lineno"></span><span class="comment" id="4587831">//</span><br>
<span class="lineno"></span><span class="comment" id="4587834">//&nbsp;This&nbsp;fails&nbsp;on&nbsp;some&nbsp;valid&nbsp;but&nbsp;nonsensical&nbsp;JavaScript&nbsp;programs&nbsp;like</span><br>
<span class="lineno"></span><span class="comment" id="4587903">//&nbsp;&#34;x&nbsp;=&nbsp;++/foo/i&#34;&nbsp;which&nbsp;is&nbsp;quite&nbsp;different&nbsp;than&nbsp;&#34;x++/foo/i&#34;,&nbsp;but&nbsp;is&nbsp;not&nbsp;known&nbsp;to</span><br>
<span class="lineno">25</span><span class="comment" id="4587984">//&nbsp;fail&nbsp;on&nbsp;any&nbsp;known&nbsp;useful&nbsp;programs.&nbsp;It&nbsp;is&nbsp;based&nbsp;on&nbsp;the&nbsp;draft</span><br>
<span class="lineno"></span><span class="comment" id="4588047">//&nbsp;JavaScript&nbsp;2.0&nbsp;lexical&nbsp;grammar&nbsp;and&nbsp;requires&nbsp;one&nbsp;token&nbsp;of&nbsp;lookbehind:</span><br>
<span class="lineno"></span><span class="comment" id="4588119">//&nbsp;http://www.mozilla.org/js/language/js20-2000-07/rationale/syntax.html</span><br>
<span class="lineno"></span><span class="keyword" id="4588192">func</span>&nbsp;<span class="ident" id="4588197">nextJSCtx</span><span class="op" id="4588206">(</span><span class="ident" id="4588207">s</span>&nbsp;<span class="op" id="4588209">[</span><span class="op" id="4588210">]</span><span class="builtintype" id="4588211">byte</span><span class="op" id="4588215">,</span>&nbsp;<span class="ident" id="4588217">preceding</span>&nbsp;<span class="ident" id="4588227">jsCtx</span><span class="op" id="4588232">)</span>&nbsp;<span class="ident" id="4588234">jsCtx</span>&nbsp;<span class="op" id="4588240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4588243">s</span>&nbsp;<span class="op" id="4588245">=</span>&nbsp;<span class="ident" id="4588247">bytes</span><span class="op" id="4588252">.</span><span class="ident" id="4588253">TrimRight</span><span class="op" id="4588262">(</span><span class="ident" id="4588263">s</span><span class="op" id="4588264">,</span>&nbsp;<span class="string" id="4588266">&#34;\t\n\f\r&nbsp;\u2028\u2029&#34;</span><span class="op" id="4588289">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588292">if</span>&nbsp;<span class="builtinfunc" id="4588295">len</span><span class="op" id="4588298">(</span><span class="ident" id="4588299">s</span><span class="op" id="4588300">)</span>&nbsp;<span class="op" id="4588302">==</span>&nbsp;<span class="num" id="4588305">0</span>&nbsp;<span class="op" id="4588307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588311">return</span>&nbsp;<span class="ident" id="4588318">preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4588329">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4588333">//&nbsp;All&nbsp;cases&nbsp;below&nbsp;are&nbsp;in&nbsp;the&nbsp;single-byte&nbsp;UTF-8&nbsp;group.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588389">switch</span>&nbsp;<span class="ident" id="4588396">c</span><span class="op" id="4588397">,</span>&nbsp;<span class="ident" id="4588399">n</span>&nbsp;<span class="op" id="4588401">:=</span>&nbsp;<span class="ident" id="4588404">s</span><span class="op" id="4588405">[</span><span class="builtinfunc" id="4588406">len</span><span class="op" id="4588409">(</span><span class="ident" id="4588410">s</span><span class="op" id="4588411">)</span><span class="op" id="4588412">-</span><span class="num" id="4588413">1</span><span class="op" id="4588414">]</span><span class="op" id="4588415">,</span>&nbsp;<span class="builtinfunc" id="4588417">len</span><span class="op" id="4588420">(</span><span class="ident" id="4588421">s</span><span class="op" id="4588422">)</span><span class="op" id="4588423">;</span>&nbsp;<span class="ident" id="4588425">c</span>&nbsp;<span class="op" id="4588427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588430">case</span>&nbsp;<span class="string" id="4588435">&#39;+&#39;</span><span class="op" id="4588438">,</span>&nbsp;<span class="string" id="4588440">&#39;-&#39;</span><span class="op" id="4588443">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4588447">//&nbsp;++&nbsp;and&nbsp;--&nbsp;are&nbsp;not&nbsp;regexp&nbsp;preceders,&nbsp;but&nbsp;+&nbsp;and&nbsp;-&nbsp;are&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4588512">//&nbsp;they&nbsp;are&nbsp;used&nbsp;as&nbsp;infix&nbsp;or&nbsp;prefix&nbsp;operators.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4588561">start</span>&nbsp;<span class="op" id="4588567">:=</span>&nbsp;<span class="ident" id="4588570">n</span>&nbsp;<span class="op" id="4588572">-</span>&nbsp;<span class="num" id="4588574">1</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4588578">//&nbsp;Count&nbsp;the&nbsp;number&nbsp;of&nbsp;adjacent&nbsp;dashes&nbsp;or&nbsp;pluses.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588630">for</span>&nbsp;<span class="ident" id="4588634">start</span>&nbsp;<span class="op" id="4588640">&gt;</span>&nbsp;<span class="num" id="4588642">0</span>&nbsp;<span class="op" id="4588644">&amp;&amp;</span>&nbsp;<span class="ident" id="4588647">s</span><span class="op" id="4588648">[</span><span class="ident" id="4588649">start</span><span class="op" id="4588654">-</span><span class="num" id="4588655">1</span><span class="op" id="4588656">]</span>&nbsp;<span class="op" id="4588658">==</span>&nbsp;<span class="ident" id="4588661">c</span>&nbsp;<span class="op" id="4588663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4588668">start</span><span class="op" id="4588673">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4588678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588682">if</span>&nbsp;<span class="op" id="4588685">(</span><span class="ident" id="4588686">n</span><span class="op" id="4588687">-</span><span class="ident" id="4588688">start</span><span class="op" id="4588693">)</span><span class="op" id="4588694">&amp;</span><span class="num" id="4588695">1</span>&nbsp;<span class="op" id="4588697">==</span>&nbsp;<span class="num" id="4588700">1</span>&nbsp;<span class="op" id="4588702">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4588707">//&nbsp;Reached&nbsp;for&nbsp;trailing&nbsp;minus&nbsp;signs&nbsp;since&nbsp;&#34;---&#34;&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4588765">//&nbsp;same&nbsp;as&nbsp;&#34;--&nbsp;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588787">return</span>&nbsp;<span class="ident" id="4588794">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4588808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588812">return</span>&nbsp;<span class="ident" id="4588819">jsCtxDivOp</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588831">case</span>&nbsp;<span class="string" id="4588836">&#39;.&#39;</span><span class="op" id="4588839">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4588843">//&nbsp;Handle&nbsp;&#34;42.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588861">if</span>&nbsp;<span class="ident" id="4588864">n</span>&nbsp;<span class="op" id="4588866">!=</span>&nbsp;<span class="num" id="4588869">1</span>&nbsp;<span class="op" id="4588871">&amp;&amp;</span>&nbsp;<span class="string" id="4588874">&#39;0&#39;</span>&nbsp;<span class="op" id="4588878">&lt;=</span>&nbsp;<span class="ident" id="4588881">s</span><span class="op" id="4588882">[</span><span class="ident" id="4588883">n</span><span class="op" id="4588884">-</span><span class="num" id="4588885">2</span><span class="op" id="4588886">]</span>&nbsp;<span class="op" id="4588888">&amp;&amp;</span>&nbsp;<span class="ident" id="4588891">s</span><span class="op" id="4588892">[</span><span class="ident" id="4588893">n</span><span class="op" id="4588894">-</span><span class="num" id="4588895">2</span><span class="op" id="4588896">]</span>&nbsp;<span class="op" id="4588898">&lt;=</span>&nbsp;<span class="string" id="4588901">&#39;9&#39;</span>&nbsp;<span class="op" id="4588905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588910">return</span>&nbsp;<span class="ident" id="4588917">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4588930">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588934">return</span>&nbsp;<span class="ident" id="4588941">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4588954">//&nbsp;Suffixes&nbsp;for&nbsp;all&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589025">//&nbsp;that&nbsp;only&nbsp;end&nbsp;binary&nbsp;operators&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4589079">case</span>&nbsp;<span class="string" id="4589084">&#39;,&#39;</span><span class="op" id="4589087">,</span>&nbsp;<span class="string" id="4589089">&#39;&lt;&#39;</span><span class="op" id="4589092">,</span>&nbsp;<span class="string" id="4589094">&#39;&gt;&#39;</span><span class="op" id="4589097">,</span>&nbsp;<span class="string" id="4589099">&#39;=&#39;</span><span class="op" id="4589102">,</span>&nbsp;<span class="string" id="4589104">&#39;*&#39;</span><span class="op" id="4589107">,</span>&nbsp;<span class="string" id="4589109">&#39;%&#39;</span><span class="op" id="4589112">,</span>&nbsp;<span class="string" id="4589114">&#39;&amp;&#39;</span><span class="op" id="4589117">,</span>&nbsp;<span class="string" id="4589119">&#39;|&#39;</span><span class="op" id="4589122">,</span>&nbsp;<span class="string" id="4589124">&#39;^&#39;</span><span class="op" id="4589127">,</span>&nbsp;<span class="string" id="4589129">&#39;?&#39;</span><span class="op" id="4589132">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4589136">return</span>&nbsp;<span class="ident" id="4589143">jsCtxRegexp</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589156">//&nbsp;Suffixes&nbsp;for&nbsp;all&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589227">//&nbsp;that&nbsp;are&nbsp;prefix&nbsp;operators&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4589276">case</span>&nbsp;<span class="string" id="4589281">&#39;!&#39;</span><span class="op" id="4589284">,</span>&nbsp;<span class="string" id="4589286">&#39;~&#39;</span><span class="op" id="4589289">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4589293">return</span>&nbsp;<span class="ident" id="4589300">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589313">//&nbsp;Matches&nbsp;all&nbsp;the&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589383">//&nbsp;that&nbsp;are&nbsp;open&nbsp;brackets&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4589429">case</span>&nbsp;<span class="string" id="4589434">&#39;(&#39;</span><span class="op" id="4589437">,</span>&nbsp;<span class="string" id="4589439">&#39;[&#39;</span><span class="op" id="4589442">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4589446">return</span>&nbsp;<span class="ident" id="4589453">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589466">//&nbsp;Matches&nbsp;all&nbsp;the&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589536">//&nbsp;that&nbsp;precede&nbsp;expression&nbsp;starts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4589572">case</span>&nbsp;<span class="string" id="4589577">&#39;:&#39;</span><span class="op" id="4589580">,</span>&nbsp;<span class="string" id="4589582">&#39;;&#39;</span><span class="op" id="4589585">,</span>&nbsp;<span class="string" id="4589587">&#39;{&#39;</span><span class="op" id="4589590">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4589594">return</span>&nbsp;<span class="ident" id="4589601">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589614">//&nbsp;CAVEAT:&nbsp;the&nbsp;close&nbsp;punctuators&nbsp;(&#39;}&#39;,&nbsp;&#39;]&#39;,&nbsp;&#39;)&#39;)&nbsp;precede&nbsp;div&nbsp;ops&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589684">//&nbsp;are&nbsp;handled&nbsp;in&nbsp;the&nbsp;default&nbsp;except&nbsp;for&nbsp;&#39;}&#39;&nbsp;which&nbsp;can&nbsp;precede&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589750">//&nbsp;division&nbsp;op&nbsp;as&nbsp;in</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589772">//&nbsp;&nbsp;&nbsp;&nbsp;({&nbsp;valueOf:&nbsp;function&nbsp;()&nbsp;{&nbsp;return&nbsp;42&nbsp;}&nbsp;}&nbsp;/&nbsp;2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589823">//&nbsp;which&nbsp;is&nbsp;valid,&nbsp;but,&nbsp;in&nbsp;practice,&nbsp;developers&nbsp;don&#39;t&nbsp;divide&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589892">//&nbsp;literals,&nbsp;so&nbsp;our&nbsp;heuristic&nbsp;works&nbsp;well&nbsp;for&nbsp;code&nbsp;like</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589948">//&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;()&nbsp;{&nbsp;...&nbsp;}&nbsp;&nbsp;/foo/.test(x)&nbsp;&amp;&amp;&nbsp;sideEffect();</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4590007">//&nbsp;The&nbsp;&#39;)&#39;&nbsp;punctuator&nbsp;can&nbsp;precede&nbsp;a&nbsp;regular&nbsp;expression&nbsp;as&nbsp;in</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4590069">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(b)&nbsp;/foo/.test(x)&nbsp;&amp;&amp;&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4590105">//&nbsp;but&nbsp;this&nbsp;is&nbsp;much&nbsp;less&nbsp;likely&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4590143">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(a&nbsp;+&nbsp;b)&nbsp;/&nbsp;c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590163">case</span>&nbsp;<span class="string" id="4590168">&#39;}&#39;</span><span class="op" id="4590171">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590175">return</span>&nbsp;<span class="ident" id="4590182">jsCtxRegexp</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590195">default</span><span class="op" id="4590202">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4590206">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;IdentifierName&nbsp;and&nbsp;see&nbsp;if&nbsp;it&nbsp;is&nbsp;a&nbsp;keyword&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4590270">//&nbsp;can&nbsp;precede&nbsp;a&nbsp;regular&nbsp;expression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4590309">j</span>&nbsp;<span class="op" id="4590311">:=</span>&nbsp;<span class="ident" id="4590314">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590318">for</span>&nbsp;<span class="ident" id="4590322">j</span>&nbsp;<span class="op" id="4590324">&gt;</span>&nbsp;<span class="num" id="4590326">0</span>&nbsp;<span class="op" id="4590328">&amp;&amp;</span>&nbsp;<span class="ident" id="4590331">isJSIdentPart</span><span class="op" id="4590344">(</span><span class="builtintype" id="4590345">rune</span><span class="op" id="4590349">(</span><span class="ident" id="4590350">s</span><span class="op" id="4590351">[</span><span class="ident" id="4590352">j</span><span class="op" id="4590353">-</span><span class="num" id="4590354">1</span><span class="op" id="4590355">]</span><span class="op" id="4590356">)</span><span class="op" id="4590357">)</span>&nbsp;<span class="op" id="4590359">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4590364">j</span><span class="op" id="4590365">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4590370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590374">if</span>&nbsp;<span class="ident" id="4590377">regexpPrecederKeywords</span><span class="op" id="4590399">[</span><span class="builtintype" id="4590400">string</span><span class="op" id="4590406">(</span><span class="ident" id="4590407">s</span><span class="op" id="4590408">[</span><span class="ident" id="4590409">j</span><span class="op" id="4590410">:</span><span class="op" id="4590411">]</span><span class="op" id="4590412">)</span><span class="op" id="4590413">]</span>&nbsp;<span class="op" id="4590415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590420">return</span>&nbsp;<span class="ident" id="4590427">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4590441">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4590444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4590447">//&nbsp;Otherwise&nbsp;is&nbsp;a&nbsp;punctuator&nbsp;not&nbsp;listed&nbsp;above,&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4590498">//&nbsp;a&nbsp;string&nbsp;which&nbsp;precedes&nbsp;a&nbsp;div&nbsp;op,&nbsp;or&nbsp;an&nbsp;identifier</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4590553">//&nbsp;which&nbsp;precedes&nbsp;a&nbsp;div&nbsp;op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590582">return</span>&nbsp;<span class="ident" id="4590589">jsCtxDivOp</span><br>
<span class="lineno">100</span><span class="op" id="4590600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4590603">//&nbsp;regexpPrecederKeywords&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;reserved&nbsp;JS&nbsp;keywords&nbsp;that&nbsp;can&nbsp;precede&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4590681">//&nbsp;regular&nbsp;expression&nbsp;in&nbsp;JS&nbsp;source.</span><br>
<span class="lineno"></span><span class="keyword" id="4590717">var</span>&nbsp;<span class="ident" id="4590721">regexpPrecederKeywords</span>&nbsp;<span class="op" id="4590744">=</span>&nbsp;<span class="keyword" id="4590746">map</span><span class="op" id="4590749">[</span><span class="builtintype" id="4590750">string</span><span class="op" id="4590756">]</span><span class="builtintype" id="4590757">bool</span><span class="op" id="4590761">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4590764">&#34;break&#34;</span><span class="op" id="4590771">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4590778">true</span><span class="op" id="4590782">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4590785">&#34;case&#34;</span><span class="op" id="4590791">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4590799">true</span><span class="op" id="4590803">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4590806">&#34;continue&#34;</span><span class="op" id="4590816">:</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4590820">true</span><span class="op" id="4590824">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4590827">&#34;delete&#34;</span><span class="op" id="4590835">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4590841">true</span><span class="op" id="4590845">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4590848">&#34;do&#34;</span><span class="op" id="4590852">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4590862">true</span><span class="op" id="4590866">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4590869">&#34;else&#34;</span><span class="op" id="4590875">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4590883">true</span><span class="op" id="4590887">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4590890">&#34;finally&#34;</span><span class="op" id="4590899">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4590904">true</span><span class="op" id="4590908">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4590911">&#34;in&#34;</span><span class="op" id="4590915">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4590925">true</span><span class="op" id="4590929">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4590932">&#34;instanceof&#34;</span><span class="op" id="4590944">:</span>&nbsp;<span class="builtintype" id="4590946">true</span><span class="op" id="4590950">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4590953">&#34;return&#34;</span><span class="op" id="4590961">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4590967">true</span><span class="op" id="4590971">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4590974">&#34;throw&#34;</span><span class="op" id="4590981">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4590988">true</span><span class="op" id="4590992">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4590995">&#34;try&#34;</span><span class="op" id="4591000">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4591009">true</span><span class="op" id="4591013">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4591016">&#34;typeof&#34;</span><span class="op" id="4591024">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4591030">true</span><span class="op" id="4591034">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4591037">&#34;void&#34;</span><span class="op" id="4591043">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4591051">true</span><span class="op" id="4591055">,</span><br>
<span class="lineno"></span><span class="op" id="4591057">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="keyword" id="4591060">var</span>&nbsp;<span class="ident" id="4591064">jsonMarshalType</span>&nbsp;<span class="op" id="4591080">=</span>&nbsp;<span class="ident" id="4591082">reflect</span><span class="op" id="4591089">.</span><span class="ident" id="4591090">TypeOf</span><span class="op" id="4591096">(</span><span class="op" id="4591097">(</span><span class="op" id="4591098">*</span><span class="ident" id="4591099">json</span><span class="op" id="4591103">.</span><span class="ident" id="4591104">Marshaler</span><span class="op" id="4591113">)</span><span class="op" id="4591114">(</span><span class="ident" id="4591115">nil</span><span class="op" id="4591118">)</span><span class="op" id="4591119">)</span><span class="op" id="4591120">.</span><span class="ident" id="4591121">Elem</span><span class="op" id="4591125">(</span><span class="op" id="4591126">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4591129">//&nbsp;indirectToJSONMarshaler&nbsp;returns&nbsp;the&nbsp;value,&nbsp;after&nbsp;dereferencing&nbsp;as&nbsp;many&nbsp;times</span><br>
<span class="lineno"></span><span class="comment" id="4591209">//&nbsp;as&nbsp;necessary&nbsp;to&nbsp;reach&nbsp;the&nbsp;base&nbsp;type&nbsp;(or&nbsp;nil)&nbsp;or&nbsp;an&nbsp;implementation&nbsp;of&nbsp;json.Marshal.</span><br>
<span class="lineno">125</span><span class="keyword" id="4591295">func</span>&nbsp;<span class="ident" id="4591300">indirectToJSONMarshaler</span><span class="op" id="4591323">(</span><span class="ident" id="4591324">a</span>&nbsp;<span class="keyword" id="4591326">interface</span><span class="op" id="4591335">{</span><span class="op" id="4591336">}</span><span class="op" id="4591337">)</span>&nbsp;<span class="keyword" id="4591339">interface</span><span class="op" id="4591348">{</span><span class="op" id="4591349">}</span>&nbsp;<span class="op" id="4591351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4591354">v</span>&nbsp;<span class="op" id="4591356">:=</span>&nbsp;<span class="ident" id="4591359">reflect</span><span class="op" id="4591366">.</span><span class="ident" id="4591367">ValueOf</span><span class="op" id="4591374">(</span><span class="ident" id="4591375">a</span><span class="op" id="4591376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591379">for</span>&nbsp;<span class="op" id="4591383">!</span><span class="ident" id="4591384">v</span><span class="op" id="4591385">.</span><span class="ident" id="4591386">Type</span><span class="op" id="4591390">(</span><span class="op" id="4591391">)</span><span class="op" id="4591392">.</span><span class="ident" id="4591393">Implements</span><span class="op" id="4591403">(</span><span class="ident" id="4591404">jsonMarshalType</span><span class="op" id="4591419">)</span>&nbsp;<span class="op" id="4591421">&amp;&amp;</span>&nbsp;<span class="ident" id="4591424">v</span><span class="op" id="4591425">.</span><span class="ident" id="4591426">Kind</span><span class="op" id="4591430">(</span><span class="op" id="4591431">)</span>&nbsp;<span class="op" id="4591433">==</span>&nbsp;<span class="ident" id="4591436">reflect</span><span class="op" id="4591443">.</span><span class="ident" id="4591444">Ptr</span>&nbsp;<span class="op" id="4591448">&amp;&amp;</span>&nbsp;<span class="op" id="4591451">!</span><span class="ident" id="4591452">v</span><span class="op" id="4591453">.</span><span class="ident" id="4591454">IsNil</span><span class="op" id="4591459">(</span><span class="op" id="4591460">)</span>&nbsp;<span class="op" id="4591462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4591466">v</span>&nbsp;<span class="op" id="4591468">=</span>&nbsp;<span class="ident" id="4591470">v</span><span class="op" id="4591471">.</span><span class="ident" id="4591472">Elem</span><span class="op" id="4591476">(</span><span class="op" id="4591477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4591480">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591483">return</span>&nbsp;<span class="ident" id="4591490">v</span><span class="op" id="4591491">.</span><span class="ident" id="4591492">Interface</span><span class="op" id="4591501">(</span><span class="op" id="4591502">)</span><br>
<span class="lineno"></span><span class="op" id="4591504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4591507">//&nbsp;jsValEscaper&nbsp;escapes&nbsp;its&nbsp;inputs&nbsp;to&nbsp;a&nbsp;JS&nbsp;Expression&nbsp;(section&nbsp;11.14)&nbsp;that&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4591586">//&nbsp;neither&nbsp;side-effects&nbsp;nor&nbsp;free&nbsp;variables&nbsp;outside&nbsp;(NaN,&nbsp;Infinity).</span><br>
<span class="lineno">135</span><span class="keyword" id="4591654">func</span>&nbsp;<span class="ident" id="4591659">jsValEscaper</span><span class="op" id="4591671">(</span><span class="ident" id="4591672">args</span>&nbsp;<span class="op" id="4591677">...</span><span class="keyword" id="4591680">interface</span><span class="op" id="4591689">{</span><span class="op" id="4591690">}</span><span class="op" id="4591691">)</span>&nbsp;<span class="builtintype" id="4591693">string</span>&nbsp;<span class="op" id="4591700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591703">var</span>&nbsp;<span class="ident" id="4591707">a</span>&nbsp;<span class="keyword" id="4591709">interface</span><span class="op" id="4591718">{</span><span class="op" id="4591719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591722">if</span>&nbsp;<span class="builtinfunc" id="4591725">len</span><span class="op" id="4591728">(</span><span class="ident" id="4591729">args</span><span class="op" id="4591733">)</span>&nbsp;<span class="op" id="4591735">==</span>&nbsp;<span class="num" id="4591738">1</span>&nbsp;<span class="op" id="4591740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4591744">a</span>&nbsp;<span class="op" id="4591746">=</span>&nbsp;<span class="ident" id="4591748">indirectToJSONMarshaler</span><span class="op" id="4591771">(</span><span class="ident" id="4591772">args</span><span class="op" id="4591776">[</span><span class="num" id="4591777">0</span><span class="op" id="4591778">]</span><span class="op" id="4591779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591783">switch</span>&nbsp;<span class="ident" id="4591790">t</span>&nbsp;<span class="op" id="4591792">:=</span>&nbsp;<span class="ident" id="4591795">a</span><span class="op" id="4591796">.</span><span class="op" id="4591797">(</span><span class="keyword" id="4591798">type</span><span class="op" id="4591802">)</span>&nbsp;<span class="op" id="4591804">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591808">case</span>&nbsp;<span class="ident" id="4591813">JS</span><span class="op" id="4591815">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591820">return</span>&nbsp;<span class="builtintype" id="4591827">string</span><span class="op" id="4591833">(</span><span class="ident" id="4591834">t</span><span class="op" id="4591835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591839">case</span>&nbsp;<span class="ident" id="4591844">JSStr</span><span class="op" id="4591849">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4591854">//&nbsp;TODO:&nbsp;normalize&nbsp;quotes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591884">return</span>&nbsp;<span class="string" id="4591891">`&#34;`</span>&nbsp;<span class="op" id="4591895">+</span>&nbsp;<span class="builtintype" id="4591897">string</span><span class="op" id="4591903">(</span><span class="ident" id="4591904">t</span><span class="op" id="4591905">)</span>&nbsp;<span class="op" id="4591907">+</span>&nbsp;<span class="string" id="4591909">`&#34;`</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591915">case</span>&nbsp;<span class="ident" id="4591920">json</span><span class="op" id="4591924">.</span><span class="ident" id="4591925">Marshaler</span><span class="op" id="4591934">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4591939">//&nbsp;Do&nbsp;not&nbsp;treat&nbsp;as&nbsp;a&nbsp;Stringer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591972">case</span>&nbsp;<span class="ident" id="4591977">fmt</span><span class="op" id="4591980">.</span><span class="ident" id="4591981">Stringer</span><span class="op" id="4591989">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4591994">a</span>&nbsp;<span class="op" id="4591996">=</span>&nbsp;<span class="ident" id="4591998">t</span><span class="op" id="4591999">.</span><span class="ident" id="4592000">String</span><span class="op" id="4592006">(</span><span class="op" id="4592007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4592011">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4592014">}</span>&nbsp;<span class="keyword" id="4592016">else</span>&nbsp;<span class="op" id="4592021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4592025">for</span>&nbsp;<span class="ident" id="4592029">i</span><span class="op" id="4592030">,</span>&nbsp;<span class="ident" id="4592032">arg</span>&nbsp;<span class="op" id="4592036">:=</span>&nbsp;<span class="keyword" id="4592039">range</span>&nbsp;<span class="ident" id="4592045">args</span>&nbsp;<span class="op" id="4592050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4592055">args</span><span class="op" id="4592059">[</span><span class="ident" id="4592060">i</span><span class="op" id="4592061">]</span>&nbsp;<span class="op" id="4592063">=</span>&nbsp;<span class="ident" id="4592065">indirectToJSONMarshaler</span><span class="op" id="4592088">(</span><span class="ident" id="4592089">arg</span><span class="op" id="4592092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4592096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4592100">a</span>&nbsp;<span class="op" id="4592102">=</span>&nbsp;<span class="ident" id="4592104">fmt</span><span class="op" id="4592107">.</span><span class="ident" id="4592108">Sprint</span><span class="op" id="4592114">(</span><span class="ident" id="4592115">args</span><span class="op" id="4592119">...</span><span class="op" id="4592122">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4592125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592128">//&nbsp;TODO:&nbsp;detect&nbsp;cycles&nbsp;before&nbsp;calling&nbsp;Marshal&nbsp;which&nbsp;loops&nbsp;infinitely&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592201">//&nbsp;cyclic&nbsp;data.&nbsp;This&nbsp;may&nbsp;be&nbsp;an&nbsp;unacceptable&nbsp;DoS&nbsp;risk.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4592257">b</span><span class="op" id="4592258">,</span>&nbsp;<span class="ident" id="4592260">err</span>&nbsp;<span class="op" id="4592264">:=</span>&nbsp;<span class="ident" id="4592267">json</span><span class="op" id="4592271">.</span><span class="ident" id="4592272">Marshal</span><span class="op" id="4592279">(</span><span class="ident" id="4592280">a</span><span class="op" id="4592281">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4592284">if</span>&nbsp;<span class="ident" id="4592287">err</span>&nbsp;<span class="op" id="4592291">!=</span>&nbsp;<span class="ident" id="4592294">nil</span>&nbsp;<span class="op" id="4592298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592302">//&nbsp;Put&nbsp;a&nbsp;space&nbsp;before&nbsp;comment&nbsp;so&nbsp;that&nbsp;if&nbsp;it&nbsp;is&nbsp;flush&nbsp;against</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592365">//&nbsp;a&nbsp;division&nbsp;operator&nbsp;it&nbsp;is&nbsp;not&nbsp;turned&nbsp;into&nbsp;a&nbsp;line&nbsp;comment:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592428">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x/{{y}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592445">//&nbsp;turning&nbsp;into</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592463">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x//*&nbsp;error&nbsp;marshalling&nbsp;y:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592498">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;second&nbsp;line&nbsp;of&nbsp;error&nbsp;message&nbsp;*/null</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4592548">return</span>&nbsp;<span class="ident" id="4592555">fmt</span><span class="op" id="4592558">.</span><span class="ident" id="4592559">Sprintf</span><span class="op" id="4592566">(</span><span class="string" id="4592567">&#34;&nbsp;/*&nbsp;%s&nbsp;*/null&nbsp;&#34;</span><span class="op" id="4592583">,</span>&nbsp;<span class="ident" id="4592585">strings</span><span class="op" id="4592592">.</span><span class="ident" id="4592593">Replace</span><span class="op" id="4592600">(</span><span class="ident" id="4592601">err</span><span class="op" id="4592604">.</span><span class="ident" id="4592605">Error</span><span class="op" id="4592610">(</span><span class="op" id="4592611">)</span><span class="op" id="4592612">,</span>&nbsp;<span class="string" id="4592614">&#34;*/&#34;</span><span class="op" id="4592618">,</span>&nbsp;<span class="string" id="4592620">&#34;*&nbsp;/&#34;</span><span class="op" id="4592625">,</span>&nbsp;<span class="op" id="4592627">-</span><span class="num" id="4592628">1</span><span class="op" id="4592629">)</span><span class="op" id="4592630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4592633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592637">//&nbsp;TODO:&nbsp;maybe&nbsp;post-process&nbsp;output&nbsp;to&nbsp;prevent&nbsp;it&nbsp;from&nbsp;containing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592703">//&nbsp;&#34;&lt;!--&#34;,&nbsp;&#34;--&gt;&#34;,&nbsp;&#34;&lt;![CDATA[&#34;,&nbsp;&#34;]]&gt;&#34;,&nbsp;or&nbsp;&#34;&lt;/script&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592756">//&nbsp;in&nbsp;case&nbsp;custom&nbsp;marshallers&nbsp;produce&nbsp;output&nbsp;containing&nbsp;those.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592821">//&nbsp;TODO:&nbsp;Maybe&nbsp;abbreviate&nbsp;\u00ab&nbsp;to&nbsp;\xab&nbsp;to&nbsp;produce&nbsp;more&nbsp;compact&nbsp;output.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4592895">if</span>&nbsp;<span class="builtinfunc" id="4592898">len</span><span class="op" id="4592901">(</span><span class="ident" id="4592902">b</span><span class="op" id="4592903">)</span>&nbsp;<span class="op" id="4592905">==</span>&nbsp;<span class="num" id="4592908">0</span>&nbsp;<span class="op" id="4592910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592914">//&nbsp;In,&nbsp;`x=y/{{.}}*z`&nbsp;a&nbsp;json.Marshaler&nbsp;that&nbsp;produces&nbsp;&#34;&#34;&nbsp;should</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592978">//&nbsp;not&nbsp;cause&nbsp;the&nbsp;output&nbsp;`x=y/*z`.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4593014">return</span>&nbsp;<span class="string" id="4593021">&#34;&nbsp;null&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4593031">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593034">first</span><span class="op" id="4593039">,</span>&nbsp;<span class="ident" id="4593041">_</span>&nbsp;<span class="op" id="4593043">:=</span>&nbsp;<span class="ident" id="4593046">utf8</span><span class="op" id="4593050">.</span><span class="ident" id="4593051">DecodeRune</span><span class="op" id="4593061">(</span><span class="ident" id="4593062">b</span><span class="op" id="4593063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593066">last</span><span class="op" id="4593070">,</span>&nbsp;<span class="ident" id="4593072">_</span>&nbsp;<span class="op" id="4593074">:=</span>&nbsp;<span class="ident" id="4593077">utf8</span><span class="op" id="4593081">.</span><span class="ident" id="4593082">DecodeLastRune</span><span class="op" id="4593096">(</span><span class="ident" id="4593097">b</span><span class="op" id="4593098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4593101">var</span>&nbsp;<span class="ident" id="4593105">buf</span>&nbsp;<span class="ident" id="4593109">bytes</span><span class="op" id="4593114">.</span><span class="ident" id="4593115">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4593123">//&nbsp;Prevent&nbsp;IdentifierNames&nbsp;and&nbsp;NumericLiterals&nbsp;from&nbsp;running&nbsp;into</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4593189">//&nbsp;keywords:&nbsp;in,&nbsp;instanceof,&nbsp;typeof,&nbsp;void</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593232">pad</span>&nbsp;<span class="op" id="4593236">:=</span>&nbsp;<span class="ident" id="4593239">isJSIdentPart</span><span class="op" id="4593252">(</span><span class="ident" id="4593253">first</span><span class="op" id="4593258">)</span>&nbsp;<span class="op" id="4593260">||</span>&nbsp;<span class="ident" id="4593263">isJSIdentPart</span><span class="op" id="4593276">(</span><span class="ident" id="4593277">last</span><span class="op" id="4593281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4593284">if</span>&nbsp;<span class="ident" id="4593287">pad</span>&nbsp;<span class="op" id="4593291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593295">buf</span><span class="op" id="4593298">.</span><span class="ident" id="4593299">WriteByte</span><span class="op" id="4593308">(</span><span class="string" id="4593309">&#39;&nbsp;&#39;</span><span class="op" id="4593312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4593315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593318">written</span>&nbsp;<span class="op" id="4593326">:=</span>&nbsp;<span class="num" id="4593329">0</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4593332">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;json.Marshal&nbsp;escapes&nbsp;codepoints&nbsp;U+2028&nbsp;&amp;&nbsp;U+2029</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4593399">//&nbsp;so&nbsp;it&nbsp;falls&nbsp;within&nbsp;the&nbsp;subset&nbsp;of&nbsp;JSON&nbsp;which&nbsp;is&nbsp;valid&nbsp;JS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4593460">for</span>&nbsp;<span class="ident" id="4593464">i</span>&nbsp;<span class="op" id="4593466">:=</span>&nbsp;<span class="num" id="4593469">0</span><span class="op" id="4593470">;</span>&nbsp;<span class="ident" id="4593472">i</span>&nbsp;<span class="op" id="4593474">&lt;</span>&nbsp;<span class="builtinfunc" id="4593476">len</span><span class="op" id="4593479">(</span><span class="ident" id="4593480">b</span><span class="op" id="4593481">)</span><span class="op" id="4593482">;</span>&nbsp;<span class="op" id="4593484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4593488">rune</span><span class="op" id="4593492">,</span>&nbsp;<span class="ident" id="4593494">n</span>&nbsp;<span class="op" id="4593496">:=</span>&nbsp;<span class="ident" id="4593499">utf8</span><span class="op" id="4593503">.</span><span class="ident" id="4593504">DecodeRune</span><span class="op" id="4593514">(</span><span class="ident" id="4593515">b</span><span class="op" id="4593516">[</span><span class="ident" id="4593517">i</span><span class="op" id="4593518">:</span><span class="op" id="4593519">]</span><span class="op" id="4593520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593524">repl</span>&nbsp;<span class="op" id="4593529">:=</span>&nbsp;<span class="string" id="4593532">&#34;&#34;</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4593537">if</span>&nbsp;<span class="builtintype" id="4593540">rune</span>&nbsp;<span class="op" id="4593545">==</span>&nbsp;<span class="num" id="4593548">0x2028</span>&nbsp;<span class="op" id="4593555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593560">repl</span>&nbsp;<span class="op" id="4593565">=</span>&nbsp;<span class="string" id="4593567">`\u2028`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4593578">}</span>&nbsp;<span class="keyword" id="4593580">else</span>&nbsp;<span class="keyword" id="4593585">if</span>&nbsp;<span class="builtintype" id="4593588">rune</span>&nbsp;<span class="op" id="4593593">==</span>&nbsp;<span class="num" id="4593596">0x2029</span>&nbsp;<span class="op" id="4593603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593608">repl</span>&nbsp;<span class="op" id="4593613">=</span>&nbsp;<span class="string" id="4593615">`\u2029`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4593626">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4593630">if</span>&nbsp;<span class="ident" id="4593633">repl</span>&nbsp;<span class="op" id="4593638">!=</span>&nbsp;<span class="string" id="4593641">&#34;&#34;</span>&nbsp;<span class="op" id="4593644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593649">buf</span><span class="op" id="4593652">.</span><span class="ident" id="4593653">Write</span><span class="op" id="4593658">(</span><span class="ident" id="4593659">b</span><span class="op" id="4593660">[</span><span class="ident" id="4593661">written</span><span class="op" id="4593668">:</span><span class="ident" id="4593669">i</span><span class="op" id="4593670">]</span><span class="op" id="4593671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593676">buf</span><span class="op" id="4593679">.</span><span class="ident" id="4593680">WriteString</span><span class="op" id="4593691">(</span><span class="ident" id="4593692">repl</span><span class="op" id="4593696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593701">written</span>&nbsp;<span class="op" id="4593709">=</span>&nbsp;<span class="ident" id="4593711">i</span>&nbsp;<span class="op" id="4593713">+</span>&nbsp;<span class="ident" id="4593715">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4593719">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593723">i</span>&nbsp;<span class="op" id="4593725">+=</span>&nbsp;<span class="ident" id="4593728">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4593731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4593734">if</span>&nbsp;<span class="ident" id="4593737">buf</span><span class="op" id="4593740">.</span><span class="ident" id="4593741">Len</span><span class="op" id="4593744">(</span><span class="op" id="4593745">)</span>&nbsp;<span class="op" id="4593747">!=</span>&nbsp;<span class="num" id="4593750">0</span>&nbsp;<span class="op" id="4593752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593756">buf</span><span class="op" id="4593759">.</span><span class="ident" id="4593760">Write</span><span class="op" id="4593765">(</span><span class="ident" id="4593766">b</span><span class="op" id="4593767">[</span><span class="ident" id="4593768">written</span><span class="op" id="4593775">:</span><span class="op" id="4593776">]</span><span class="op" id="4593777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4593781">if</span>&nbsp;<span class="ident" id="4593784">pad</span>&nbsp;<span class="op" id="4593788">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593793">buf</span><span class="op" id="4593796">.</span><span class="ident" id="4593797">WriteByte</span><span class="op" id="4593806">(</span><span class="string" id="4593807">&#39;&nbsp;&#39;</span><span class="op" id="4593810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4593814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593818">b</span>&nbsp;<span class="op" id="4593820">=</span>&nbsp;<span class="ident" id="4593822">buf</span><span class="op" id="4593825">.</span><span class="ident" id="4593826">Bytes</span><span class="op" id="4593831">(</span><span class="op" id="4593832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4593835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4593838">return</span>&nbsp;<span class="builtintype" id="4593845">string</span><span class="op" id="4593851">(</span><span class="ident" id="4593852">b</span><span class="op" id="4593853">)</span><br>
<span class="lineno">215</span><span class="op" id="4593855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4593858">//&nbsp;jsStrEscaper&nbsp;produces&nbsp;a&nbsp;string&nbsp;that&nbsp;can&nbsp;be&nbsp;included&nbsp;between&nbsp;quotes&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4593931">//&nbsp;JavaScript&nbsp;source,&nbsp;in&nbsp;JavaScript&nbsp;embedded&nbsp;in&nbsp;an&nbsp;HTML5&nbsp;&lt;script&gt;&nbsp;element,</span><br>
<span class="lineno"></span><span class="comment" id="4594006">//&nbsp;or&nbsp;in&nbsp;an&nbsp;HTML5&nbsp;event&nbsp;handler&nbsp;attribute&nbsp;such&nbsp;as&nbsp;onclick.</span><br>
<span class="lineno">220</span><span class="keyword" id="4594065">func</span>&nbsp;<span class="ident" id="4594070">jsStrEscaper</span><span class="op" id="4594082">(</span><span class="ident" id="4594083">args</span>&nbsp;<span class="op" id="4594088">...</span><span class="keyword" id="4594091">interface</span><span class="op" id="4594100">{</span><span class="op" id="4594101">}</span><span class="op" id="4594102">)</span>&nbsp;<span class="builtintype" id="4594104">string</span>&nbsp;<span class="op" id="4594111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4594114">s</span><span class="op" id="4594115">,</span>&nbsp;<span class="ident" id="4594117">t</span>&nbsp;<span class="op" id="4594119">:=</span>&nbsp;<span class="ident" id="4594122">stringify</span><span class="op" id="4594131">(</span><span class="ident" id="4594132">args</span><span class="op" id="4594136">...</span><span class="op" id="4594139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4594142">if</span>&nbsp;<span class="ident" id="4594145">t</span>&nbsp;<span class="op" id="4594147">==</span>&nbsp;<span class="ident" id="4594150">contentTypeJSStr</span>&nbsp;<span class="op" id="4594167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4594171">return</span>&nbsp;<span class="ident" id="4594178">replace</span><span class="op" id="4594185">(</span><span class="ident" id="4594186">s</span><span class="op" id="4594187">,</span>&nbsp;<span class="ident" id="4594189">jsStrNormReplacementTable</span><span class="op" id="4594214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4594217">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4594220">return</span>&nbsp;<span class="ident" id="4594227">replace</span><span class="op" id="4594234">(</span><span class="ident" id="4594235">s</span><span class="op" id="4594236">,</span>&nbsp;<span class="ident" id="4594238">jsStrReplacementTable</span><span class="op" id="4594259">)</span><br>
<span class="lineno"></span><span class="op" id="4594261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4594264">//&nbsp;jsRegexpEscaper&nbsp;behaves&nbsp;like&nbsp;jsStrEscaper&nbsp;but&nbsp;escapes&nbsp;regular&nbsp;expression</span><br>
<span class="lineno"></span><span class="comment" id="4594340">//&nbsp;specials&nbsp;so&nbsp;the&nbsp;result&nbsp;is&nbsp;treated&nbsp;literally&nbsp;when&nbsp;included&nbsp;in&nbsp;a&nbsp;regular</span><br>
<span class="lineno">230</span><span class="comment" id="4594414">//&nbsp;expression&nbsp;literal.&nbsp;/foo{{.X}}bar/&nbsp;matches&nbsp;the&nbsp;string&nbsp;&#34;foo&#34;&nbsp;followed&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4594489">//&nbsp;the&nbsp;literal&nbsp;text&nbsp;of&nbsp;{{.X}}&nbsp;followed&nbsp;by&nbsp;the&nbsp;string&nbsp;&#34;bar&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="4594549">func</span>&nbsp;<span class="ident" id="4594554">jsRegexpEscaper</span><span class="op" id="4594569">(</span><span class="ident" id="4594570">args</span>&nbsp;<span class="op" id="4594575">...</span><span class="keyword" id="4594578">interface</span><span class="op" id="4594587">{</span><span class="op" id="4594588">}</span><span class="op" id="4594589">)</span>&nbsp;<span class="builtintype" id="4594591">string</span>&nbsp;<span class="op" id="4594598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4594601">s</span><span class="op" id="4594602">,</span>&nbsp;<span class="ident" id="4594604">_</span>&nbsp;<span class="op" id="4594606">:=</span>&nbsp;<span class="ident" id="4594609">stringify</span><span class="op" id="4594618">(</span><span class="ident" id="4594619">args</span><span class="op" id="4594623">...</span><span class="op" id="4594626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4594629">s</span>&nbsp;<span class="op" id="4594631">=</span>&nbsp;<span class="ident" id="4594633">replace</span><span class="op" id="4594640">(</span><span class="ident" id="4594641">s</span><span class="op" id="4594642">,</span>&nbsp;<span class="ident" id="4594644">jsRegexpReplacementTable</span><span class="op" id="4594668">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4594671">if</span>&nbsp;<span class="ident" id="4594674">s</span>&nbsp;<span class="op" id="4594676">==</span>&nbsp;<span class="string" id="4594679">&#34;&#34;</span>&nbsp;<span class="op" id="4594682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4594686">//&nbsp;/{{.X}}/&nbsp;should&nbsp;not&nbsp;produce&nbsp;a&nbsp;line&nbsp;comment&nbsp;when&nbsp;.X&nbsp;==&nbsp;&#34;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4594749">return</span>&nbsp;<span class="string" id="4594756">&#34;(?:)&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4594764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4594767">return</span>&nbsp;<span class="ident" id="4594774">s</span><br>
<span class="lineno">240</span><span class="op" id="4594776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4594779">//&nbsp;replace&nbsp;replaces&nbsp;each&nbsp;rune&nbsp;r&nbsp;of&nbsp;s&nbsp;with&nbsp;replacementTable[r],&nbsp;provided&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4594856">//&nbsp;r&nbsp;&lt;&nbsp;len(replacementTable).&nbsp;If&nbsp;replacementTable[r]&nbsp;is&nbsp;the&nbsp;empty&nbsp;string&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="4594934">//&nbsp;no&nbsp;replacement&nbsp;is&nbsp;made.</span><br>
<span class="lineno">245</span><span class="comment" id="4594961">//&nbsp;It&nbsp;also&nbsp;replaces&nbsp;runes&nbsp;U+2028&nbsp;and&nbsp;U+2029&nbsp;with&nbsp;the&nbsp;raw&nbsp;strings&nbsp;`\u2028`&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4595039">//&nbsp;`\u2029`.</span><br>
<span class="lineno"></span><span class="keyword" id="4595052">func</span>&nbsp;<span class="ident" id="4595057">replace</span><span class="op" id="4595064">(</span><span class="ident" id="4595065">s</span>&nbsp;<span class="builtintype" id="4595067">string</span><span class="op" id="4595073">,</span>&nbsp;<span class="ident" id="4595075">replacementTable</span>&nbsp;<span class="op" id="4595092">[</span><span class="op" id="4595093">]</span><span class="builtintype" id="4595094">string</span><span class="op" id="4595100">)</span>&nbsp;<span class="builtintype" id="4595102">string</span>&nbsp;<span class="op" id="4595109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4595112">var</span>&nbsp;<span class="ident" id="4595116">b</span>&nbsp;<span class="ident" id="4595118">bytes</span><span class="op" id="4595123">.</span><span class="ident" id="4595124">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4595132">written</span>&nbsp;<span class="op" id="4595140">:=</span>&nbsp;<span class="num" id="4595143">0</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4595146">for</span>&nbsp;<span class="ident" id="4595150">i</span><span class="op" id="4595151">,</span>&nbsp;<span class="ident" id="4595153">r</span>&nbsp;<span class="op" id="4595155">:=</span>&nbsp;<span class="keyword" id="4595158">range</span>&nbsp;<span class="ident" id="4595164">s</span>&nbsp;<span class="op" id="4595166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4595170">var</span>&nbsp;<span class="ident" id="4595174">repl</span>&nbsp;<span class="builtintype" id="4595179">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4595188">switch</span>&nbsp;<span class="op" id="4595195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4595199">case</span>&nbsp;<span class="builtintype" id="4595204">int</span><span class="op" id="4595207">(</span><span class="ident" id="4595208">r</span><span class="op" id="4595209">)</span>&nbsp;<span class="op" id="4595211">&lt;</span>&nbsp;<span class="builtinfunc" id="4595213">len</span><span class="op" id="4595216">(</span><span class="ident" id="4595217">replacementTable</span><span class="op" id="4595233">)</span>&nbsp;<span class="op" id="4595235">&amp;&amp;</span>&nbsp;<span class="ident" id="4595238">replacementTable</span><span class="op" id="4595254">[</span><span class="ident" id="4595255">r</span><span class="op" id="4595256">]</span>&nbsp;<span class="op" id="4595258">!=</span>&nbsp;<span class="string" id="4595261">&#34;&#34;</span><span class="op" id="4595263">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4595268">repl</span>&nbsp;<span class="op" id="4595273">=</span>&nbsp;<span class="ident" id="4595275">replacementTable</span><span class="op" id="4595291">[</span><span class="ident" id="4595292">r</span><span class="op" id="4595293">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4595297">case</span>&nbsp;<span class="ident" id="4595302">r</span>&nbsp;<span class="op" id="4595304">==</span>&nbsp;<span class="string" id="4595307">&#39;\u2028&#39;</span><span class="op" id="4595315">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4595320">repl</span>&nbsp;<span class="op" id="4595325">=</span>&nbsp;<span class="string" id="4595327">`\u2028`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4595338">case</span>&nbsp;<span class="ident" id="4595343">r</span>&nbsp;<span class="op" id="4595345">==</span>&nbsp;<span class="string" id="4595348">&#39;\u2029&#39;</span><span class="op" id="4595356">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4595361">repl</span>&nbsp;<span class="op" id="4595366">=</span>&nbsp;<span class="string" id="4595368">`\u2029`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4595379">default</span><span class="op" id="4595386">:</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4595391">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4595402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4595406">b</span><span class="op" id="4595407">.</span><span class="ident" id="4595408">WriteString</span><span class="op" id="4595419">(</span><span class="ident" id="4595420">s</span><span class="op" id="4595421">[</span><span class="ident" id="4595422">written</span><span class="op" id="4595429">:</span><span class="ident" id="4595430">i</span><span class="op" id="4595431">]</span><span class="op" id="4595432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4595436">b</span><span class="op" id="4595437">.</span><span class="ident" id="4595438">WriteString</span><span class="op" id="4595449">(</span><span class="ident" id="4595450">repl</span><span class="op" id="4595454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4595458">written</span>&nbsp;<span class="op" id="4595466">=</span>&nbsp;<span class="ident" id="4595468">i</span>&nbsp;<span class="op" id="4595470">+</span>&nbsp;<span class="ident" id="4595472">utf8</span><span class="op" id="4595476">.</span><span class="ident" id="4595477">RuneLen</span><span class="op" id="4595484">(</span><span class="ident" id="4595485">r</span><span class="op" id="4595486">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4595489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4595492">if</span>&nbsp;<span class="ident" id="4595495">written</span>&nbsp;<span class="op" id="4595503">==</span>&nbsp;<span class="num" id="4595506">0</span>&nbsp;<span class="op" id="4595508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4595512">return</span>&nbsp;<span class="ident" id="4595519">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4595522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4595525">b</span><span class="op" id="4595526">.</span><span class="ident" id="4595527">WriteString</span><span class="op" id="4595538">(</span><span class="ident" id="4595539">s</span><span class="op" id="4595540">[</span><span class="ident" id="4595541">written</span><span class="op" id="4595548">:</span><span class="op" id="4595549">]</span><span class="op" id="4595550">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4595553">return</span>&nbsp;<span class="ident" id="4595560">b</span><span class="op" id="4595561">.</span><span class="ident" id="4595562">String</span><span class="op" id="4595568">(</span><span class="op" id="4595569">)</span><br>
<span class="lineno"></span><span class="op" id="4595571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4595574">var</span>&nbsp;<span class="ident" id="4595578">jsStrReplacementTable</span>&nbsp;<span class="op" id="4595600">=</span>&nbsp;<span class="op" id="4595602">[</span><span class="op" id="4595603">]</span><span class="builtintype" id="4595604">string</span><span class="op" id="4595610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="4595613">0</span><span class="op" id="4595614">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4595619">`\0`</span><span class="op" id="4595623">,</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4595626">&#39;\t&#39;</span><span class="op" id="4595630">:</span>&nbsp;<span class="string" id="4595632">`\t`</span><span class="op" id="4595636">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4595639">&#39;\n&#39;</span><span class="op" id="4595643">:</span>&nbsp;<span class="string" id="4595645">`\n`</span><span class="op" id="4595649">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4595652">&#39;\v&#39;</span><span class="op" id="4595656">:</span>&nbsp;<span class="string" id="4595658">`\x0b`</span><span class="op" id="4595664">,</span>&nbsp;<span class="comment" id="4595666">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4595691">&#39;\f&#39;</span><span class="op" id="4595695">:</span>&nbsp;<span class="string" id="4595697">`\f`</span><span class="op" id="4595701">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4595704">&#39;\r&#39;</span><span class="op" id="4595708">:</span>&nbsp;<span class="string" id="4595710">`\r`</span><span class="op" id="4595714">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4595717">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4595779">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4595828">&#39;&#34;&#39;</span><span class="op" id="4595831">:</span>&nbsp;&nbsp;<span class="string" id="4595834">`\x22`</span><span class="op" id="4595840">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4595843">&#39;&amp;&#39;</span><span class="op" id="4595846">:</span>&nbsp;&nbsp;<span class="string" id="4595849">`\x26`</span><span class="op" id="4595855">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4595858">&#39;\&#39;&#39;</span><span class="op" id="4595862">:</span>&nbsp;<span class="string" id="4595864">`\x27`</span><span class="op" id="4595870">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4595873">&#39;+&#39;</span><span class="op" id="4595876">:</span>&nbsp;&nbsp;<span class="string" id="4595879">`\x2b`</span><span class="op" id="4595885">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4595888">&#39;/&#39;</span><span class="op" id="4595891">:</span>&nbsp;&nbsp;<span class="string" id="4595894">`\/`</span><span class="op" id="4595898">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4595901">&#39;&lt;&#39;</span><span class="op" id="4595904">:</span>&nbsp;&nbsp;<span class="string" id="4595907">`\x3c`</span><span class="op" id="4595913">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4595916">&#39;&gt;&#39;</span><span class="op" id="4595919">:</span>&nbsp;&nbsp;<span class="string" id="4595922">`\x3e`</span><span class="op" id="4595928">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4595931">&#39;\\&#39;</span><span class="op" id="4595935">:</span>&nbsp;<span class="string" id="4595937">`\\`</span><span class="op" id="4595941">,</span><br>
<span class="lineno">290</span><span class="op" id="4595943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4595946">//&nbsp;jsStrNormReplacementTable&nbsp;is&nbsp;like&nbsp;jsStrReplacementTable&nbsp;but&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="4596018">//&nbsp;overencode&nbsp;existing&nbsp;escapes&nbsp;since&nbsp;this&nbsp;table&nbsp;has&nbsp;no&nbsp;entry&nbsp;for&nbsp;`\`.</span><br>
<span class="lineno"></span><span class="keyword" id="4596088">var</span>&nbsp;<span class="ident" id="4596092">jsStrNormReplacementTable</span>&nbsp;<span class="op" id="4596118">=</span>&nbsp;<span class="op" id="4596120">[</span><span class="op" id="4596121">]</span><span class="builtintype" id="4596122">string</span><span class="op" id="4596128">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="4596131">0</span><span class="op" id="4596132">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4596137">`\0`</span><span class="op" id="4596141">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596144">&#39;\t&#39;</span><span class="op" id="4596148">:</span>&nbsp;<span class="string" id="4596150">`\t`</span><span class="op" id="4596154">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596157">&#39;\n&#39;</span><span class="op" id="4596161">:</span>&nbsp;<span class="string" id="4596163">`\n`</span><span class="op" id="4596167">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596170">&#39;\v&#39;</span><span class="op" id="4596174">:</span>&nbsp;<span class="string" id="4596176">`\x0b`</span><span class="op" id="4596182">,</span>&nbsp;<span class="comment" id="4596184">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596209">&#39;\f&#39;</span><span class="op" id="4596213">:</span>&nbsp;<span class="string" id="4596215">`\f`</span><span class="op" id="4596219">,</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596222">&#39;\r&#39;</span><span class="op" id="4596226">:</span>&nbsp;<span class="string" id="4596228">`\r`</span><span class="op" id="4596232">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4596235">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4596297">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596346">&#39;&#34;&#39;</span><span class="op" id="4596349">:</span>&nbsp;&nbsp;<span class="string" id="4596352">`\x22`</span><span class="op" id="4596358">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596361">&#39;&amp;&#39;</span><span class="op" id="4596364">:</span>&nbsp;&nbsp;<span class="string" id="4596367">`\x26`</span><span class="op" id="4596373">,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596376">&#39;\&#39;&#39;</span><span class="op" id="4596380">:</span>&nbsp;<span class="string" id="4596382">`\x27`</span><span class="op" id="4596388">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596391">&#39;+&#39;</span><span class="op" id="4596394">:</span>&nbsp;&nbsp;<span class="string" id="4596397">`\x2b`</span><span class="op" id="4596403">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596406">&#39;/&#39;</span><span class="op" id="4596409">:</span>&nbsp;&nbsp;<span class="string" id="4596412">`\/`</span><span class="op" id="4596416">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596419">&#39;&lt;&#39;</span><span class="op" id="4596422">:</span>&nbsp;&nbsp;<span class="string" id="4596425">`\x3c`</span><span class="op" id="4596431">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596434">&#39;&gt;&#39;</span><span class="op" id="4596437">:</span>&nbsp;&nbsp;<span class="string" id="4596440">`\x3e`</span><span class="op" id="4596446">,</span><br>
<span class="lineno">310</span><span class="op" id="4596448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4596451">var</span>&nbsp;<span class="ident" id="4596455">jsRegexpReplacementTable</span>&nbsp;<span class="op" id="4596480">=</span>&nbsp;<span class="op" id="4596482">[</span><span class="op" id="4596483">]</span><span class="builtintype" id="4596484">string</span><span class="op" id="4596490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="4596493">0</span><span class="op" id="4596494">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4596499">`\0`</span><span class="op" id="4596503">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596506">&#39;\t&#39;</span><span class="op" id="4596510">:</span>&nbsp;<span class="string" id="4596512">`\t`</span><span class="op" id="4596516">,</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596519">&#39;\n&#39;</span><span class="op" id="4596523">:</span>&nbsp;<span class="string" id="4596525">`\n`</span><span class="op" id="4596529">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596532">&#39;\v&#39;</span><span class="op" id="4596536">:</span>&nbsp;<span class="string" id="4596538">`\x0b`</span><span class="op" id="4596544">,</span>&nbsp;<span class="comment" id="4596546">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596571">&#39;\f&#39;</span><span class="op" id="4596575">:</span>&nbsp;<span class="string" id="4596577">`\f`</span><span class="op" id="4596581">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596584">&#39;\r&#39;</span><span class="op" id="4596588">:</span>&nbsp;<span class="string" id="4596590">`\r`</span><span class="op" id="4596594">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4596597">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4596659">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596708">&#39;&#34;&#39;</span><span class="op" id="4596711">:</span>&nbsp;&nbsp;<span class="string" id="4596714">`\x22`</span><span class="op" id="4596720">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596723">&#39;$&#39;</span><span class="op" id="4596726">:</span>&nbsp;&nbsp;<span class="string" id="4596729">`\$`</span><span class="op" id="4596733">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596736">&#39;&amp;&#39;</span><span class="op" id="4596739">:</span>&nbsp;&nbsp;<span class="string" id="4596742">`\x26`</span><span class="op" id="4596748">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596751">&#39;\&#39;&#39;</span><span class="op" id="4596755">:</span>&nbsp;<span class="string" id="4596757">`\x27`</span><span class="op" id="4596763">,</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596766">&#39;(&#39;</span><span class="op" id="4596769">:</span>&nbsp;&nbsp;<span class="string" id="4596772">`\(`</span><span class="op" id="4596776">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596779">&#39;)&#39;</span><span class="op" id="4596782">:</span>&nbsp;&nbsp;<span class="string" id="4596785">`\)`</span><span class="op" id="4596789">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596792">&#39;*&#39;</span><span class="op" id="4596795">:</span>&nbsp;&nbsp;<span class="string" id="4596798">`\*`</span><span class="op" id="4596802">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596805">&#39;+&#39;</span><span class="op" id="4596808">:</span>&nbsp;&nbsp;<span class="string" id="4596811">`\x2b`</span><span class="op" id="4596817">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596820">&#39;-&#39;</span><span class="op" id="4596823">:</span>&nbsp;&nbsp;<span class="string" id="4596826">`\-`</span><span class="op" id="4596830">,</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596833">&#39;.&#39;</span><span class="op" id="4596836">:</span>&nbsp;&nbsp;<span class="string" id="4596839">`\.`</span><span class="op" id="4596843">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596846">&#39;/&#39;</span><span class="op" id="4596849">:</span>&nbsp;&nbsp;<span class="string" id="4596852">`\/`</span><span class="op" id="4596856">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596859">&#39;&lt;&#39;</span><span class="op" id="4596862">:</span>&nbsp;&nbsp;<span class="string" id="4596865">`\x3c`</span><span class="op" id="4596871">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596874">&#39;&gt;&#39;</span><span class="op" id="4596877">:</span>&nbsp;&nbsp;<span class="string" id="4596880">`\x3e`</span><span class="op" id="4596886">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596889">&#39;?&#39;</span><span class="op" id="4596892">:</span>&nbsp;&nbsp;<span class="string" id="4596895">`\?`</span><span class="op" id="4596899">,</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596902">&#39;[&#39;</span><span class="op" id="4596905">:</span>&nbsp;&nbsp;<span class="string" id="4596908">`\[`</span><span class="op" id="4596912">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596915">&#39;\\&#39;</span><span class="op" id="4596919">:</span>&nbsp;<span class="string" id="4596921">`\\`</span><span class="op" id="4596925">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596928">&#39;]&#39;</span><span class="op" id="4596931">:</span>&nbsp;&nbsp;<span class="string" id="4596934">`\]`</span><span class="op" id="4596938">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596941">&#39;^&#39;</span><span class="op" id="4596944">:</span>&nbsp;&nbsp;<span class="string" id="4596947">`\^`</span><span class="op" id="4596951">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596954">&#39;{&#39;</span><span class="op" id="4596957">:</span>&nbsp;&nbsp;<span class="string" id="4596960">`\{`</span><span class="op" id="4596964">,</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596967">&#39;|&#39;</span><span class="op" id="4596970">:</span>&nbsp;&nbsp;<span class="string" id="4596973">`\|`</span><span class="op" id="4596977">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4596980">&#39;}&#39;</span><span class="op" id="4596983">:</span>&nbsp;&nbsp;<span class="string" id="4596986">`\}`</span><span class="op" id="4596990">,</span><br>
<span class="lineno"></span><span class="op" id="4596992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4596995">//&nbsp;isJSIdentPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;given&nbsp;rune&nbsp;is&nbsp;a&nbsp;JS&nbsp;identifier&nbsp;part.</span><br>
<span class="lineno">345</span><span class="comment" id="4597068">//&nbsp;It&nbsp;does&nbsp;not&nbsp;handle&nbsp;all&nbsp;the&nbsp;non-Latin&nbsp;letters,&nbsp;joiners,&nbsp;and&nbsp;combining&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="4597147">//&nbsp;but&nbsp;it&nbsp;does&nbsp;handle&nbsp;every&nbsp;codepoint&nbsp;that&nbsp;can&nbsp;occur&nbsp;in&nbsp;a&nbsp;numeric&nbsp;literal&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4597224">//&nbsp;a&nbsp;keyword.</span><br>
<span class="lineno"></span><span class="keyword" id="4597238">func</span>&nbsp;<span class="ident" id="4597243">isJSIdentPart</span><span class="op" id="4597256">(</span><span class="ident" id="4597257">r</span>&nbsp;<span class="builtintype" id="4597259">rune</span><span class="op" id="4597263">)</span>&nbsp;<span class="builtintype" id="4597265">bool</span>&nbsp;<span class="op" id="4597270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4597273">switch</span>&nbsp;<span class="op" id="4597280">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4597283">case</span>&nbsp;<span class="ident" id="4597288">r</span>&nbsp;<span class="op" id="4597290">==</span>&nbsp;<span class="string" id="4597293">&#39;$&#39;</span><span class="op" id="4597296">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4597300">return</span>&nbsp;<span class="builtintype" id="4597307">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4597313">case</span>&nbsp;<span class="string" id="4597318">&#39;0&#39;</span>&nbsp;<span class="op" id="4597322">&lt;=</span>&nbsp;<span class="ident" id="4597325">r</span>&nbsp;<span class="op" id="4597327">&amp;&amp;</span>&nbsp;<span class="ident" id="4597330">r</span>&nbsp;<span class="op" id="4597332">&lt;=</span>&nbsp;<span class="string" id="4597335">&#39;9&#39;</span><span class="op" id="4597338">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4597342">return</span>&nbsp;<span class="builtintype" id="4597349">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4597355">case</span>&nbsp;<span class="string" id="4597360">&#39;A&#39;</span>&nbsp;<span class="op" id="4597364">&lt;=</span>&nbsp;<span class="ident" id="4597367">r</span>&nbsp;<span class="op" id="4597369">&amp;&amp;</span>&nbsp;<span class="ident" id="4597372">r</span>&nbsp;<span class="op" id="4597374">&lt;=</span>&nbsp;<span class="string" id="4597377">&#39;Z&#39;</span><span class="op" id="4597380">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4597384">return</span>&nbsp;<span class="builtintype" id="4597391">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4597397">case</span>&nbsp;<span class="ident" id="4597402">r</span>&nbsp;<span class="op" id="4597404">==</span>&nbsp;<span class="string" id="4597407">&#39;_&#39;</span><span class="op" id="4597410">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4597414">return</span>&nbsp;<span class="builtintype" id="4597421">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4597427">case</span>&nbsp;<span class="string" id="4597432">&#39;a&#39;</span>&nbsp;<span class="op" id="4597436">&lt;=</span>&nbsp;<span class="ident" id="4597439">r</span>&nbsp;<span class="op" id="4597441">&amp;&amp;</span>&nbsp;<span class="ident" id="4597444">r</span>&nbsp;<span class="op" id="4597446">&lt;=</span>&nbsp;<span class="string" id="4597449">&#39;z&#39;</span><span class="op" id="4597452">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4597456">return</span>&nbsp;<span class="builtintype" id="4597463">true</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4597469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4597472">return</span>&nbsp;<span class="builtintype" id="4597479">false</span><br>
<span class="lineno"></span><span class="op" id="4597485">}</span>
</div>
</body>
</html>
