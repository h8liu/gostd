<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7706818">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7706873">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7706927">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7706978">//&nbsp;Reverse&nbsp;proxy&nbsp;tests.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7707003">package</span>&nbsp;<span class="ident" id="7707011">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7707021">import</span>&nbsp;<span class="op" id="7707028">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7707031">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7707044">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7707056">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7707077">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7707088">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7707099">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7707110">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7707117">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7707120">const</span>&nbsp;<span class="ident" id="7707126">fakeHopHeader</span>&nbsp;<span class="op" id="7707140">=</span>&nbsp;<span class="string" id="7707142">&#34;X-Fake-Hop-Header-For-Test&#34;</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7707172">func</span>&nbsp;<span class="ident" id="7707177">init</span><span class="op" id="7707181">(</span><span class="op" id="7707182">)</span>&nbsp;<span class="op" id="7707184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7707187">hopHeaders</span>&nbsp;<span class="op" id="7707198">=</span>&nbsp;<span class="builtinfunc" id="7707200">append</span><span class="op" id="7707206">(</span><span class="ident" id="7707207">hopHeaders</span><span class="op" id="7707217">,</span>&nbsp;<span class="ident" id="7707219">fakeHopHeader</span><span class="op" id="7707232">)</span><br>
<span class="lineno"></span><span class="op" id="7707234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="7707237">func</span>&nbsp;<span class="ident" id="7707242">TestReverseProxy</span><span class="op" id="7707258">(</span><span class="ident" id="7707259">t</span>&nbsp;<span class="op" id="7707261">*</span><span class="ident" id="7707262">testing</span><span class="op" id="7707269">.</span><span class="ident" id="7707270">T</span><span class="op" id="7707271">)</span>&nbsp;<span class="op" id="7707273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7707276">const</span>&nbsp;<span class="ident" id="7707282">backendResponse</span>&nbsp;<span class="op" id="7707298">=</span>&nbsp;<span class="string" id="7707300">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7707320">const</span>&nbsp;<span class="ident" id="7707326">backendStatus</span>&nbsp;<span class="op" id="7707340">=</span>&nbsp;<span class="num" id="7707342">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7707347">backend</span>&nbsp;<span class="op" id="7707355">:=</span>&nbsp;<span class="ident" id="7707358">httptest</span><span class="op" id="7707366">.</span><span class="ident" id="7707367">NewServer</span><span class="op" id="7707376">(</span><span class="ident" id="7707377">http</span><span class="op" id="7707381">.</span><span class="ident" id="7707382">HandlerFunc</span><span class="op" id="7707393">(</span><span class="keyword" id="7707394">func</span><span class="op" id="7707398">(</span><span class="ident" id="7707399">w</span>&nbsp;<span class="ident" id="7707401">http</span><span class="op" id="7707405">.</span><span class="ident" id="7707406">ResponseWriter</span><span class="op" id="7707420">,</span>&nbsp;<span class="ident" id="7707422">r</span>&nbsp;<span class="op" id="7707424">*</span><span class="ident" id="7707425">http</span><span class="op" id="7707429">.</span><span class="ident" id="7707430">Request</span><span class="op" id="7707437">)</span>&nbsp;<span class="op" id="7707439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7707443">if</span>&nbsp;<span class="builtinfunc" id="7707446">len</span><span class="op" id="7707449">(</span><span class="ident" id="7707450">r</span><span class="op" id="7707451">.</span><span class="ident" id="7707452">TransferEncoding</span><span class="op" id="7707468">)</span>&nbsp;<span class="op" id="7707470">&gt;</span>&nbsp;<span class="num" id="7707472">0</span>&nbsp;<span class="op" id="7707474">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7707479">t</span><span class="op" id="7707480">.</span><span class="ident" id="7707481">Errorf</span><span class="op" id="7707487">(</span><span class="string" id="7707488">&#34;backend&nbsp;got&nbsp;unexpected&nbsp;TransferEncoding:&nbsp;%v&#34;</span><span class="op" id="7707533">,</span>&nbsp;<span class="ident" id="7707535">r</span><span class="op" id="7707536">.</span><span class="ident" id="7707537">TransferEncoding</span><span class="op" id="7707553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7707557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7707561">if</span>&nbsp;<span class="ident" id="7707564">r</span><span class="op" id="7707565">.</span><span class="ident" id="7707566">Header</span><span class="op" id="7707572">.</span><span class="ident" id="7707573">Get</span><span class="op" id="7707576">(</span><span class="string" id="7707577">&#34;X-Forwarded-For&#34;</span><span class="op" id="7707594">)</span>&nbsp;<span class="op" id="7707596">==</span>&nbsp;<span class="string" id="7707599">&#34;&#34;</span>&nbsp;<span class="op" id="7707602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7707607">t</span><span class="op" id="7707608">.</span><span class="ident" id="7707609">Errorf</span><span class="op" id="7707615">(</span><span class="string" id="7707616">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7707651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7707655">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7707659">if</span>&nbsp;<span class="ident" id="7707662">c</span>&nbsp;<span class="op" id="7707664">:=</span>&nbsp;<span class="ident" id="7707667">r</span><span class="op" id="7707668">.</span><span class="ident" id="7707669">Header</span><span class="op" id="7707675">.</span><span class="ident" id="7707676">Get</span><span class="op" id="7707679">(</span><span class="string" id="7707680">&#34;Connection&#34;</span><span class="op" id="7707692">)</span><span class="op" id="7707693">;</span>&nbsp;<span class="ident" id="7707695">c</span>&nbsp;<span class="op" id="7707697">!=</span>&nbsp;<span class="string" id="7707700">&#34;&#34;</span>&nbsp;<span class="op" id="7707703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7707708">t</span><span class="op" id="7707709">.</span><span class="ident" id="7707710">Errorf</span><span class="op" id="7707716">(</span><span class="string" id="7707717">&#34;handler&nbsp;got&nbsp;Connection&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7707757">,</span>&nbsp;<span class="ident" id="7707759">c</span><span class="op" id="7707760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7707764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7707768">if</span>&nbsp;<span class="ident" id="7707771">c</span>&nbsp;<span class="op" id="7707773">:=</span>&nbsp;<span class="ident" id="7707776">r</span><span class="op" id="7707777">.</span><span class="ident" id="7707778">Header</span><span class="op" id="7707784">.</span><span class="ident" id="7707785">Get</span><span class="op" id="7707788">(</span><span class="string" id="7707789">&#34;Upgrade&#34;</span><span class="op" id="7707798">)</span><span class="op" id="7707799">;</span>&nbsp;<span class="ident" id="7707801">c</span>&nbsp;<span class="op" id="7707803">!=</span>&nbsp;<span class="string" id="7707806">&#34;&#34;</span>&nbsp;<span class="op" id="7707809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7707814">t</span><span class="op" id="7707815">.</span><span class="ident" id="7707816">Errorf</span><span class="op" id="7707822">(</span><span class="string" id="7707823">&#34;handler&nbsp;got&nbsp;Upgrade&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7707860">,</span>&nbsp;<span class="ident" id="7707862">c</span><span class="op" id="7707863">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7707867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7707871">if</span>&nbsp;<span class="ident" id="7707874">g</span><span class="op" id="7707875">,</span>&nbsp;<span class="ident" id="7707877">e</span>&nbsp;<span class="op" id="7707879">:=</span>&nbsp;<span class="ident" id="7707882">r</span><span class="op" id="7707883">.</span><span class="ident" id="7707884">Host</span><span class="op" id="7707888">,</span>&nbsp;<span class="string" id="7707890">&#34;some-name&#34;</span><span class="op" id="7707901">;</span>&nbsp;<span class="ident" id="7707903">g</span>&nbsp;<span class="op" id="7707905">!=</span>&nbsp;<span class="ident" id="7707908">e</span>&nbsp;<span class="op" id="7707910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7707915">t</span><span class="op" id="7707916">.</span><span class="ident" id="7707917">Errorf</span><span class="op" id="7707923">(</span><span class="string" id="7707924">&#34;backend&nbsp;got&nbsp;Host&nbsp;header&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7707961">,</span>&nbsp;<span class="ident" id="7707963">g</span><span class="op" id="7707964">,</span>&nbsp;<span class="ident" id="7707966">e</span><span class="op" id="7707967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7707971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7707975">w</span><span class="op" id="7707976">.</span><span class="ident" id="7707977">Header</span><span class="op" id="7707983">(</span><span class="op" id="7707984">)</span><span class="op" id="7707985">.</span><span class="ident" id="7707986">Set</span><span class="op" id="7707989">(</span><span class="string" id="7707990">&#34;X-Foo&#34;</span><span class="op" id="7707997">,</span>&nbsp;<span class="string" id="7707999">&#34;bar&#34;</span><span class="op" id="7708004">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708008">w</span><span class="op" id="7708009">.</span><span class="ident" id="7708010">Header</span><span class="op" id="7708016">(</span><span class="op" id="7708017">)</span><span class="op" id="7708018">.</span><span class="ident" id="7708019">Set</span><span class="op" id="7708022">(</span><span class="string" id="7708023">&#34;Upgrade&#34;</span><span class="op" id="7708032">,</span>&nbsp;<span class="string" id="7708034">&#34;foo&#34;</span><span class="op" id="7708039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708043">w</span><span class="op" id="7708044">.</span><span class="ident" id="7708045">Header</span><span class="op" id="7708051">(</span><span class="op" id="7708052">)</span><span class="op" id="7708053">.</span><span class="ident" id="7708054">Set</span><span class="op" id="7708057">(</span><span class="ident" id="7708058">fakeHopHeader</span><span class="op" id="7708071">,</span>&nbsp;<span class="string" id="7708073">&#34;foo&#34;</span><span class="op" id="7708078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708082">w</span><span class="op" id="7708083">.</span><span class="ident" id="7708084">Header</span><span class="op" id="7708090">(</span><span class="op" id="7708091">)</span><span class="op" id="7708092">.</span><span class="ident" id="7708093">Add</span><span class="op" id="7708096">(</span><span class="string" id="7708097">&#34;X-Multi-Value&#34;</span><span class="op" id="7708112">,</span>&nbsp;<span class="string" id="7708114">&#34;foo&#34;</span><span class="op" id="7708119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708123">w</span><span class="op" id="7708124">.</span><span class="ident" id="7708125">Header</span><span class="op" id="7708131">(</span><span class="op" id="7708132">)</span><span class="op" id="7708133">.</span><span class="ident" id="7708134">Add</span><span class="op" id="7708137">(</span><span class="string" id="7708138">&#34;X-Multi-Value&#34;</span><span class="op" id="7708153">,</span>&nbsp;<span class="string" id="7708155">&#34;bar&#34;</span><span class="op" id="7708160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708164">http</span><span class="op" id="7708168">.</span><span class="ident" id="7708169">SetCookie</span><span class="op" id="7708178">(</span><span class="ident" id="7708179">w</span><span class="op" id="7708180">,</span>&nbsp;<span class="op" id="7708182">&amp;</span><span class="ident" id="7708183">http</span><span class="op" id="7708187">.</span><span class="ident" id="7708188">Cookie</span><span class="op" id="7708194">{</span><span class="ident" id="7708195">Name</span><span class="op" id="7708199">:</span>&nbsp;<span class="string" id="7708201">&#34;flavor&#34;</span><span class="op" id="7708209">,</span>&nbsp;<span class="ident" id="7708211">Value</span><span class="op" id="7708216">:</span>&nbsp;<span class="string" id="7708218">&#34;chocolateChip&#34;</span><span class="op" id="7708233">}</span><span class="op" id="7708234">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708238">w</span><span class="op" id="7708239">.</span><span class="ident" id="7708240">WriteHeader</span><span class="op" id="7708251">(</span><span class="ident" id="7708252">backendStatus</span><span class="op" id="7708265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708269">w</span><span class="op" id="7708270">.</span><span class="ident" id="7708271">Write</span><span class="op" id="7708276">(</span><span class="op" id="7708277">[</span><span class="op" id="7708278">]</span><span class="builtintype" id="7708279">byte</span><span class="op" id="7708283">(</span><span class="ident" id="7708284">backendResponse</span><span class="op" id="7708299">)</span><span class="op" id="7708300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7708303">}</span><span class="op" id="7708304">)</span><span class="op" id="7708305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7708308">defer</span>&nbsp;<span class="ident" id="7708314">backend</span><span class="op" id="7708321">.</span><span class="ident" id="7708322">Close</span><span class="op" id="7708327">(</span><span class="op" id="7708328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708331">backendURL</span><span class="op" id="7708341">,</span>&nbsp;<span class="ident" id="7708343">err</span>&nbsp;<span class="op" id="7708347">:=</span>&nbsp;<span class="ident" id="7708350">url</span><span class="op" id="7708353">.</span><span class="ident" id="7708354">Parse</span><span class="op" id="7708359">(</span><span class="ident" id="7708360">backend</span><span class="op" id="7708367">.</span><span class="ident" id="7708368">URL</span><span class="op" id="7708371">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7708374">if</span>&nbsp;<span class="ident" id="7708377">err</span>&nbsp;<span class="op" id="7708381">!=</span>&nbsp;<span class="ident" id="7708384">nil</span>&nbsp;<span class="op" id="7708388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708392">t</span><span class="op" id="7708393">.</span><span class="ident" id="7708394">Fatal</span><span class="op" id="7708399">(</span><span class="ident" id="7708400">err</span><span class="op" id="7708403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7708406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708409">proxyHandler</span>&nbsp;<span class="op" id="7708422">:=</span>&nbsp;<span class="ident" id="7708425">NewSingleHostReverseProxy</span><span class="op" id="7708450">(</span><span class="ident" id="7708451">backendURL</span><span class="op" id="7708461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708464">frontend</span>&nbsp;<span class="op" id="7708473">:=</span>&nbsp;<span class="ident" id="7708476">httptest</span><span class="op" id="7708484">.</span><span class="ident" id="7708485">NewServer</span><span class="op" id="7708494">(</span><span class="ident" id="7708495">proxyHandler</span><span class="op" id="7708507">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7708510">defer</span>&nbsp;<span class="ident" id="7708516">frontend</span><span class="op" id="7708524">.</span><span class="ident" id="7708525">Close</span><span class="op" id="7708530">(</span><span class="op" id="7708531">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708535">getReq</span><span class="op" id="7708541">,</span>&nbsp;<span class="ident" id="7708543">_</span>&nbsp;<span class="op" id="7708545">:=</span>&nbsp;<span class="ident" id="7708548">http</span><span class="op" id="7708552">.</span><span class="ident" id="7708553">NewRequest</span><span class="op" id="7708563">(</span><span class="string" id="7708564">&#34;GET&#34;</span><span class="op" id="7708569">,</span>&nbsp;<span class="ident" id="7708571">frontend</span><span class="op" id="7708579">.</span><span class="ident" id="7708580">URL</span><span class="op" id="7708583">,</span>&nbsp;<span class="ident" id="7708585">nil</span><span class="op" id="7708588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708591">getReq</span><span class="op" id="7708597">.</span><span class="ident" id="7708598">Host</span>&nbsp;<span class="op" id="7708603">=</span>&nbsp;<span class="string" id="7708605">&#34;some-name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708618">getReq</span><span class="op" id="7708624">.</span><span class="ident" id="7708625">Header</span><span class="op" id="7708631">.</span><span class="ident" id="7708632">Set</span><span class="op" id="7708635">(</span><span class="string" id="7708636">&#34;Connection&#34;</span><span class="op" id="7708648">,</span>&nbsp;<span class="string" id="7708650">&#34;close&#34;</span><span class="op" id="7708657">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708660">getReq</span><span class="op" id="7708666">.</span><span class="ident" id="7708667">Header</span><span class="op" id="7708673">.</span><span class="ident" id="7708674">Set</span><span class="op" id="7708677">(</span><span class="string" id="7708678">&#34;Upgrade&#34;</span><span class="op" id="7708687">,</span>&nbsp;<span class="string" id="7708689">&#34;foo&#34;</span><span class="op" id="7708694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708697">getReq</span><span class="op" id="7708703">.</span><span class="ident" id="7708704">Close</span>&nbsp;<span class="op" id="7708710">=</span>&nbsp;<span class="builtintype" id="7708712">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708718">res</span><span class="op" id="7708721">,</span>&nbsp;<span class="ident" id="7708723">err</span>&nbsp;<span class="op" id="7708727">:=</span>&nbsp;<span class="ident" id="7708730">http</span><span class="op" id="7708734">.</span><span class="ident" id="7708735">DefaultClient</span><span class="op" id="7708748">.</span><span class="ident" id="7708749">Do</span><span class="op" id="7708751">(</span><span class="ident" id="7708752">getReq</span><span class="op" id="7708758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7708761">if</span>&nbsp;<span class="ident" id="7708764">err</span>&nbsp;<span class="op" id="7708768">!=</span>&nbsp;<span class="ident" id="7708771">nil</span>&nbsp;<span class="op" id="7708775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708779">t</span><span class="op" id="7708780">.</span><span class="ident" id="7708781">Fatalf</span><span class="op" id="7708787">(</span><span class="string" id="7708788">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7708797">,</span>&nbsp;<span class="ident" id="7708799">err</span><span class="op" id="7708802">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7708805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7708808">if</span>&nbsp;<span class="ident" id="7708811">g</span><span class="op" id="7708812">,</span>&nbsp;<span class="ident" id="7708814">e</span>&nbsp;<span class="op" id="7708816">:=</span>&nbsp;<span class="ident" id="7708819">res</span><span class="op" id="7708822">.</span><span class="ident" id="7708823">StatusCode</span><span class="op" id="7708833">,</span>&nbsp;<span class="ident" id="7708835">backendStatus</span><span class="op" id="7708848">;</span>&nbsp;<span class="ident" id="7708850">g</span>&nbsp;<span class="op" id="7708852">!=</span>&nbsp;<span class="ident" id="7708855">e</span>&nbsp;<span class="op" id="7708857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708861">t</span><span class="op" id="7708862">.</span><span class="ident" id="7708863">Errorf</span><span class="op" id="7708869">(</span><span class="string" id="7708870">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7708906">,</span>&nbsp;<span class="ident" id="7708908">g</span><span class="op" id="7708909">,</span>&nbsp;<span class="ident" id="7708911">e</span><span class="op" id="7708912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7708915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7708918">if</span>&nbsp;<span class="ident" id="7708921">g</span><span class="op" id="7708922">,</span>&nbsp;<span class="ident" id="7708924">e</span>&nbsp;<span class="op" id="7708926">:=</span>&nbsp;<span class="ident" id="7708929">res</span><span class="op" id="7708932">.</span><span class="ident" id="7708933">Header</span><span class="op" id="7708939">.</span><span class="ident" id="7708940">Get</span><span class="op" id="7708943">(</span><span class="string" id="7708944">&#34;X-Foo&#34;</span><span class="op" id="7708951">)</span><span class="op" id="7708952">,</span>&nbsp;<span class="string" id="7708954">&#34;bar&#34;</span><span class="op" id="7708959">;</span>&nbsp;<span class="ident" id="7708961">g</span>&nbsp;<span class="op" id="7708963">!=</span>&nbsp;<span class="ident" id="7708966">e</span>&nbsp;<span class="op" id="7708968">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7708972">t</span><span class="op" id="7708973">.</span><span class="ident" id="7708974">Errorf</span><span class="op" id="7708980">(</span><span class="string" id="7708981">&#34;got&nbsp;X-Foo&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7709008">,</span>&nbsp;<span class="ident" id="7709010">g</span><span class="op" id="7709011">,</span>&nbsp;<span class="ident" id="7709013">e</span><span class="op" id="7709014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7709017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7709020">if</span>&nbsp;<span class="ident" id="7709023">c</span>&nbsp;<span class="op" id="7709025">:=</span>&nbsp;<span class="ident" id="7709028">res</span><span class="op" id="7709031">.</span><span class="ident" id="7709032">Header</span><span class="op" id="7709038">.</span><span class="ident" id="7709039">Get</span><span class="op" id="7709042">(</span><span class="ident" id="7709043">fakeHopHeader</span><span class="op" id="7709056">)</span><span class="op" id="7709057">;</span>&nbsp;<span class="ident" id="7709059">c</span>&nbsp;<span class="op" id="7709061">!=</span>&nbsp;<span class="string" id="7709064">&#34;&#34;</span>&nbsp;<span class="op" id="7709067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7709071">t</span><span class="op" id="7709072">.</span><span class="ident" id="7709073">Errorf</span><span class="op" id="7709079">(</span><span class="string" id="7709080">&#34;got&nbsp;%s&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7709104">,</span>&nbsp;<span class="ident" id="7709106">fakeHopHeader</span><span class="op" id="7709119">,</span>&nbsp;<span class="ident" id="7709121">c</span><span class="op" id="7709122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7709125">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7709128">if</span>&nbsp;<span class="ident" id="7709131">g</span><span class="op" id="7709132">,</span>&nbsp;<span class="ident" id="7709134">e</span>&nbsp;<span class="op" id="7709136">:=</span>&nbsp;<span class="builtinfunc" id="7709139">len</span><span class="op" id="7709142">(</span><span class="ident" id="7709143">res</span><span class="op" id="7709146">.</span><span class="ident" id="7709147">Header</span><span class="op" id="7709153">[</span><span class="string" id="7709154">&#34;X-Multi-Value&#34;</span><span class="op" id="7709169">]</span><span class="op" id="7709170">)</span><span class="op" id="7709171">,</span>&nbsp;<span class="num" id="7709173">2</span><span class="op" id="7709174">;</span>&nbsp;<span class="ident" id="7709176">g</span>&nbsp;<span class="op" id="7709178">!=</span>&nbsp;<span class="ident" id="7709181">e</span>&nbsp;<span class="op" id="7709183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7709187">t</span><span class="op" id="7709188">.</span><span class="ident" id="7709189">Errorf</span><span class="op" id="7709195">(</span><span class="string" id="7709196">&#34;got&nbsp;%d&nbsp;X-Multi-Value&nbsp;header&nbsp;values;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7709245">,</span>&nbsp;<span class="ident" id="7709247">g</span><span class="op" id="7709248">,</span>&nbsp;<span class="ident" id="7709250">e</span><span class="op" id="7709251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7709254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7709257">if</span>&nbsp;<span class="ident" id="7709260">g</span><span class="op" id="7709261">,</span>&nbsp;<span class="ident" id="7709263">e</span>&nbsp;<span class="op" id="7709265">:=</span>&nbsp;<span class="builtinfunc" id="7709268">len</span><span class="op" id="7709271">(</span><span class="ident" id="7709272">res</span><span class="op" id="7709275">.</span><span class="ident" id="7709276">Header</span><span class="op" id="7709282">[</span><span class="string" id="7709283">&#34;Set-Cookie&#34;</span><span class="op" id="7709295">]</span><span class="op" id="7709296">)</span><span class="op" id="7709297">,</span>&nbsp;<span class="num" id="7709299">1</span><span class="op" id="7709300">;</span>&nbsp;<span class="ident" id="7709302">g</span>&nbsp;<span class="op" id="7709304">!=</span>&nbsp;<span class="ident" id="7709307">e</span>&nbsp;<span class="op" id="7709309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7709313">t</span><span class="op" id="7709314">.</span><span class="ident" id="7709315">Fatalf</span><span class="op" id="7709321">(</span><span class="string" id="7709322">&#34;got&nbsp;%d&nbsp;SetCookies,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7709350">,</span>&nbsp;<span class="ident" id="7709352">g</span><span class="op" id="7709353">,</span>&nbsp;<span class="ident" id="7709355">e</span><span class="op" id="7709356">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7709359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7709362">if</span>&nbsp;<span class="ident" id="7709365">cookie</span>&nbsp;<span class="op" id="7709372">:=</span>&nbsp;<span class="ident" id="7709375">res</span><span class="op" id="7709378">.</span><span class="ident" id="7709379">Cookies</span><span class="op" id="7709386">(</span><span class="op" id="7709387">)</span><span class="op" id="7709388">[</span><span class="num" id="7709389">0</span><span class="op" id="7709390">]</span><span class="op" id="7709391">;</span>&nbsp;<span class="ident" id="7709393">cookie</span><span class="op" id="7709399">.</span><span class="ident" id="7709400">Name</span>&nbsp;<span class="op" id="7709405">!=</span>&nbsp;<span class="string" id="7709408">&#34;flavor&#34;</span>&nbsp;<span class="op" id="7709417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7709421">t</span><span class="op" id="7709422">.</span><span class="ident" id="7709423">Errorf</span><span class="op" id="7709429">(</span><span class="string" id="7709430">&#34;unexpected&nbsp;cookie&nbsp;%q&#34;</span><span class="op" id="7709452">,</span>&nbsp;<span class="ident" id="7709454">cookie</span><span class="op" id="7709460">.</span><span class="ident" id="7709461">Name</span><span class="op" id="7709465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7709468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7709471">bodyBytes</span><span class="op" id="7709480">,</span>&nbsp;<span class="ident" id="7709482">_</span>&nbsp;<span class="op" id="7709484">:=</span>&nbsp;<span class="ident" id="7709487">ioutil</span><span class="op" id="7709493">.</span><span class="ident" id="7709494">ReadAll</span><span class="op" id="7709501">(</span><span class="ident" id="7709502">res</span><span class="op" id="7709505">.</span><span class="ident" id="7709506">Body</span><span class="op" id="7709510">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7709513">if</span>&nbsp;<span class="ident" id="7709516">g</span><span class="op" id="7709517">,</span>&nbsp;<span class="ident" id="7709519">e</span>&nbsp;<span class="op" id="7709521">:=</span>&nbsp;<span class="builtintype" id="7709524">string</span><span class="op" id="7709530">(</span><span class="ident" id="7709531">bodyBytes</span><span class="op" id="7709540">)</span><span class="op" id="7709541">,</span>&nbsp;<span class="ident" id="7709543">backendResponse</span><span class="op" id="7709558">;</span>&nbsp;<span class="ident" id="7709560">g</span>&nbsp;<span class="op" id="7709562">!=</span>&nbsp;<span class="ident" id="7709565">e</span>&nbsp;<span class="op" id="7709567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7709571">t</span><span class="op" id="7709572">.</span><span class="ident" id="7709573">Errorf</span><span class="op" id="7709579">(</span><span class="string" id="7709580">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7709606">,</span>&nbsp;<span class="ident" id="7709608">g</span><span class="op" id="7709609">,</span>&nbsp;<span class="ident" id="7709611">e</span><span class="op" id="7709612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7709615">}</span><br>
<span class="lineno"></span><span class="op" id="7709617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7709620">func</span>&nbsp;<span class="ident" id="7709625">TestXForwardedFor</span><span class="op" id="7709642">(</span><span class="ident" id="7709643">t</span>&nbsp;<span class="op" id="7709645">*</span><span class="ident" id="7709646">testing</span><span class="op" id="7709653">.</span><span class="ident" id="7709654">T</span><span class="op" id="7709655">)</span>&nbsp;<span class="op" id="7709657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7709660">const</span>&nbsp;<span class="ident" id="7709666">prevForwardedFor</span>&nbsp;<span class="op" id="7709683">=</span>&nbsp;<span class="string" id="7709685">&#34;client&nbsp;ip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7709698">const</span>&nbsp;<span class="ident" id="7709704">backendResponse</span>&nbsp;<span class="op" id="7709720">=</span>&nbsp;<span class="string" id="7709722">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7709742">const</span>&nbsp;<span class="ident" id="7709748">backendStatus</span>&nbsp;<span class="op" id="7709762">=</span>&nbsp;<span class="num" id="7709764">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7709769">backend</span>&nbsp;<span class="op" id="7709777">:=</span>&nbsp;<span class="ident" id="7709780">httptest</span><span class="op" id="7709788">.</span><span class="ident" id="7709789">NewServer</span><span class="op" id="7709798">(</span><span class="ident" id="7709799">http</span><span class="op" id="7709803">.</span><span class="ident" id="7709804">HandlerFunc</span><span class="op" id="7709815">(</span><span class="keyword" id="7709816">func</span><span class="op" id="7709820">(</span><span class="ident" id="7709821">w</span>&nbsp;<span class="ident" id="7709823">http</span><span class="op" id="7709827">.</span><span class="ident" id="7709828">ResponseWriter</span><span class="op" id="7709842">,</span>&nbsp;<span class="ident" id="7709844">r</span>&nbsp;<span class="op" id="7709846">*</span><span class="ident" id="7709847">http</span><span class="op" id="7709851">.</span><span class="ident" id="7709852">Request</span><span class="op" id="7709859">)</span>&nbsp;<span class="op" id="7709861">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7709865">if</span>&nbsp;<span class="ident" id="7709868">r</span><span class="op" id="7709869">.</span><span class="ident" id="7709870">Header</span><span class="op" id="7709876">.</span><span class="ident" id="7709877">Get</span><span class="op" id="7709880">(</span><span class="string" id="7709881">&#34;X-Forwarded-For&#34;</span><span class="op" id="7709898">)</span>&nbsp;<span class="op" id="7709900">==</span>&nbsp;<span class="string" id="7709903">&#34;&#34;</span>&nbsp;<span class="op" id="7709906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7709911">t</span><span class="op" id="7709912">.</span><span class="ident" id="7709913">Errorf</span><span class="op" id="7709919">(</span><span class="string" id="7709920">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7709955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7709959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7709963">if</span>&nbsp;<span class="op" id="7709966">!</span><span class="ident" id="7709967">strings</span><span class="op" id="7709974">.</span><span class="ident" id="7709975">Contains</span><span class="op" id="7709983">(</span><span class="ident" id="7709984">r</span><span class="op" id="7709985">.</span><span class="ident" id="7709986">Header</span><span class="op" id="7709992">.</span><span class="ident" id="7709993">Get</span><span class="op" id="7709996">(</span><span class="string" id="7709997">&#34;X-Forwarded-For&#34;</span><span class="op" id="7710014">)</span><span class="op" id="7710015">,</span>&nbsp;<span class="ident" id="7710017">prevForwardedFor</span><span class="op" id="7710033">)</span>&nbsp;<span class="op" id="7710035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710040">t</span><span class="op" id="7710041">.</span><span class="ident" id="7710042">Errorf</span><span class="op" id="7710048">(</span><span class="string" id="7710049">&#34;X-Forwarded-For&nbsp;didn&#39;t&nbsp;contain&nbsp;prior&nbsp;data&#34;</span><span class="op" id="7710092">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7710096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710100">w</span><span class="op" id="7710101">.</span><span class="ident" id="7710102">WriteHeader</span><span class="op" id="7710113">(</span><span class="ident" id="7710114">backendStatus</span><span class="op" id="7710127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710131">w</span><span class="op" id="7710132">.</span><span class="ident" id="7710133">Write</span><span class="op" id="7710138">(</span><span class="op" id="7710139">[</span><span class="op" id="7710140">]</span><span class="builtintype" id="7710141">byte</span><span class="op" id="7710145">(</span><span class="ident" id="7710146">backendResponse</span><span class="op" id="7710161">)</span><span class="op" id="7710162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7710165">}</span><span class="op" id="7710166">)</span><span class="op" id="7710167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7710170">defer</span>&nbsp;<span class="ident" id="7710176">backend</span><span class="op" id="7710183">.</span><span class="ident" id="7710184">Close</span><span class="op" id="7710189">(</span><span class="op" id="7710190">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710193">backendURL</span><span class="op" id="7710203">,</span>&nbsp;<span class="ident" id="7710205">err</span>&nbsp;<span class="op" id="7710209">:=</span>&nbsp;<span class="ident" id="7710212">url</span><span class="op" id="7710215">.</span><span class="ident" id="7710216">Parse</span><span class="op" id="7710221">(</span><span class="ident" id="7710222">backend</span><span class="op" id="7710229">.</span><span class="ident" id="7710230">URL</span><span class="op" id="7710233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7710236">if</span>&nbsp;<span class="ident" id="7710239">err</span>&nbsp;<span class="op" id="7710243">!=</span>&nbsp;<span class="ident" id="7710246">nil</span>&nbsp;<span class="op" id="7710250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710254">t</span><span class="op" id="7710255">.</span><span class="ident" id="7710256">Fatal</span><span class="op" id="7710261">(</span><span class="ident" id="7710262">err</span><span class="op" id="7710265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7710268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710271">proxyHandler</span>&nbsp;<span class="op" id="7710284">:=</span>&nbsp;<span class="ident" id="7710287">NewSingleHostReverseProxy</span><span class="op" id="7710312">(</span><span class="ident" id="7710313">backendURL</span><span class="op" id="7710323">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710326">frontend</span>&nbsp;<span class="op" id="7710335">:=</span>&nbsp;<span class="ident" id="7710338">httptest</span><span class="op" id="7710346">.</span><span class="ident" id="7710347">NewServer</span><span class="op" id="7710356">(</span><span class="ident" id="7710357">proxyHandler</span><span class="op" id="7710369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7710372">defer</span>&nbsp;<span class="ident" id="7710378">frontend</span><span class="op" id="7710386">.</span><span class="ident" id="7710387">Close</span><span class="op" id="7710392">(</span><span class="op" id="7710393">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710397">getReq</span><span class="op" id="7710403">,</span>&nbsp;<span class="ident" id="7710405">_</span>&nbsp;<span class="op" id="7710407">:=</span>&nbsp;<span class="ident" id="7710410">http</span><span class="op" id="7710414">.</span><span class="ident" id="7710415">NewRequest</span><span class="op" id="7710425">(</span><span class="string" id="7710426">&#34;GET&#34;</span><span class="op" id="7710431">,</span>&nbsp;<span class="ident" id="7710433">frontend</span><span class="op" id="7710441">.</span><span class="ident" id="7710442">URL</span><span class="op" id="7710445">,</span>&nbsp;<span class="ident" id="7710447">nil</span><span class="op" id="7710450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710453">getReq</span><span class="op" id="7710459">.</span><span class="ident" id="7710460">Host</span>&nbsp;<span class="op" id="7710465">=</span>&nbsp;<span class="string" id="7710467">&#34;some-name&#34;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710480">getReq</span><span class="op" id="7710486">.</span><span class="ident" id="7710487">Header</span><span class="op" id="7710493">.</span><span class="ident" id="7710494">Set</span><span class="op" id="7710497">(</span><span class="string" id="7710498">&#34;Connection&#34;</span><span class="op" id="7710510">,</span>&nbsp;<span class="string" id="7710512">&#34;close&#34;</span><span class="op" id="7710519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710522">getReq</span><span class="op" id="7710528">.</span><span class="ident" id="7710529">Header</span><span class="op" id="7710535">.</span><span class="ident" id="7710536">Set</span><span class="op" id="7710539">(</span><span class="string" id="7710540">&#34;X-Forwarded-For&#34;</span><span class="op" id="7710557">,</span>&nbsp;<span class="ident" id="7710559">prevForwardedFor</span><span class="op" id="7710575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710578">getReq</span><span class="op" id="7710584">.</span><span class="ident" id="7710585">Close</span>&nbsp;<span class="op" id="7710591">=</span>&nbsp;<span class="builtintype" id="7710593">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710599">res</span><span class="op" id="7710602">,</span>&nbsp;<span class="ident" id="7710604">err</span>&nbsp;<span class="op" id="7710608">:=</span>&nbsp;<span class="ident" id="7710611">http</span><span class="op" id="7710615">.</span><span class="ident" id="7710616">DefaultClient</span><span class="op" id="7710629">.</span><span class="ident" id="7710630">Do</span><span class="op" id="7710632">(</span><span class="ident" id="7710633">getReq</span><span class="op" id="7710639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7710642">if</span>&nbsp;<span class="ident" id="7710645">err</span>&nbsp;<span class="op" id="7710649">!=</span>&nbsp;<span class="ident" id="7710652">nil</span>&nbsp;<span class="op" id="7710656">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710660">t</span><span class="op" id="7710661">.</span><span class="ident" id="7710662">Fatalf</span><span class="op" id="7710668">(</span><span class="string" id="7710669">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7710678">,</span>&nbsp;<span class="ident" id="7710680">err</span><span class="op" id="7710683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7710686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7710689">if</span>&nbsp;<span class="ident" id="7710692">g</span><span class="op" id="7710693">,</span>&nbsp;<span class="ident" id="7710695">e</span>&nbsp;<span class="op" id="7710697">:=</span>&nbsp;<span class="ident" id="7710700">res</span><span class="op" id="7710703">.</span><span class="ident" id="7710704">StatusCode</span><span class="op" id="7710714">,</span>&nbsp;<span class="ident" id="7710716">backendStatus</span><span class="op" id="7710729">;</span>&nbsp;<span class="ident" id="7710731">g</span>&nbsp;<span class="op" id="7710733">!=</span>&nbsp;<span class="ident" id="7710736">e</span>&nbsp;<span class="op" id="7710738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710742">t</span><span class="op" id="7710743">.</span><span class="ident" id="7710744">Errorf</span><span class="op" id="7710750">(</span><span class="string" id="7710751">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7710787">,</span>&nbsp;<span class="ident" id="7710789">g</span><span class="op" id="7710790">,</span>&nbsp;<span class="ident" id="7710792">e</span><span class="op" id="7710793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7710796">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710799">bodyBytes</span><span class="op" id="7710808">,</span>&nbsp;<span class="ident" id="7710810">_</span>&nbsp;<span class="op" id="7710812">:=</span>&nbsp;<span class="ident" id="7710815">ioutil</span><span class="op" id="7710821">.</span><span class="ident" id="7710822">ReadAll</span><span class="op" id="7710829">(</span><span class="ident" id="7710830">res</span><span class="op" id="7710833">.</span><span class="ident" id="7710834">Body</span><span class="op" id="7710838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7710841">if</span>&nbsp;<span class="ident" id="7710844">g</span><span class="op" id="7710845">,</span>&nbsp;<span class="ident" id="7710847">e</span>&nbsp;<span class="op" id="7710849">:=</span>&nbsp;<span class="builtintype" id="7710852">string</span><span class="op" id="7710858">(</span><span class="ident" id="7710859">bodyBytes</span><span class="op" id="7710868">)</span><span class="op" id="7710869">,</span>&nbsp;<span class="ident" id="7710871">backendResponse</span><span class="op" id="7710886">;</span>&nbsp;<span class="ident" id="7710888">g</span>&nbsp;<span class="op" id="7710890">!=</span>&nbsp;<span class="ident" id="7710893">e</span>&nbsp;<span class="op" id="7710895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710899">t</span><span class="op" id="7710900">.</span><span class="ident" id="7710901">Errorf</span><span class="op" id="7710907">(</span><span class="string" id="7710908">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7710934">,</span>&nbsp;<span class="ident" id="7710936">g</span><span class="op" id="7710937">,</span>&nbsp;<span class="ident" id="7710939">e</span><span class="op" id="7710940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7710943">}</span><br>
<span class="lineno"></span><span class="op" id="7710945">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="7710948">var</span>&nbsp;<span class="ident" id="7710952">proxyQueryTests</span>&nbsp;<span class="op" id="7710968">=</span>&nbsp;<span class="op" id="7710970">[</span><span class="op" id="7710971">]</span><span class="keyword" id="7710972">struct</span>&nbsp;<span class="op" id="7710979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7710982">baseSuffix</span>&nbsp;<span class="builtintype" id="7710993">string</span>&nbsp;<span class="comment" id="7711000">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;backend&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7711033">reqSuffix</span>&nbsp;&nbsp;<span class="builtintype" id="7711044">string</span>&nbsp;<span class="comment" id="7711051">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;frontend&#39;s&nbsp;request&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7711095">want</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7711106">string</span>&nbsp;<span class="comment" id="7711113">//&nbsp;what&nbsp;backend&nbsp;should&nbsp;see&nbsp;for&nbsp;final&nbsp;request&nbsp;URL&nbsp;(without&nbsp;?)</span><br>
<span class="lineno">140</span><span class="op" id="7711174">}</span><span class="op" id="7711175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7711178">{</span><span class="string" id="7711179">&#34;&#34;</span><span class="op" id="7711181">,</span>&nbsp;<span class="string" id="7711183">&#34;&#34;</span><span class="op" id="7711185">,</span>&nbsp;<span class="string" id="7711187">&#34;&#34;</span><span class="op" id="7711189">}</span><span class="op" id="7711190">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7711193">{</span><span class="string" id="7711194">&#34;?sta=tic&#34;</span><span class="op" id="7711204">,</span>&nbsp;<span class="string" id="7711206">&#34;?us=er&#34;</span><span class="op" id="7711214">,</span>&nbsp;<span class="string" id="7711216">&#34;sta=tic&amp;us=er&#34;</span><span class="op" id="7711231">}</span><span class="op" id="7711232">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7711235">{</span><span class="string" id="7711236">&#34;&#34;</span><span class="op" id="7711238">,</span>&nbsp;<span class="string" id="7711240">&#34;?us=er&#34;</span><span class="op" id="7711248">,</span>&nbsp;<span class="string" id="7711250">&#34;us=er&#34;</span><span class="op" id="7711257">}</span><span class="op" id="7711258">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7711261">{</span><span class="string" id="7711262">&#34;?sta=tic&#34;</span><span class="op" id="7711272">,</span>&nbsp;<span class="string" id="7711274">&#34;&#34;</span><span class="op" id="7711276">,</span>&nbsp;<span class="string" id="7711278">&#34;sta=tic&#34;</span><span class="op" id="7711287">}</span><span class="op" id="7711288">,</span><br>
<span class="lineno">145</span><span class="op" id="7711290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7711293">func</span>&nbsp;<span class="ident" id="7711298">TestReverseProxyQuery</span><span class="op" id="7711319">(</span><span class="ident" id="7711320">t</span>&nbsp;<span class="op" id="7711322">*</span><span class="ident" id="7711323">testing</span><span class="op" id="7711330">.</span><span class="ident" id="7711331">T</span><span class="op" id="7711332">)</span>&nbsp;<span class="op" id="7711334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7711337">backend</span>&nbsp;<span class="op" id="7711345">:=</span>&nbsp;<span class="ident" id="7711348">httptest</span><span class="op" id="7711356">.</span><span class="ident" id="7711357">NewServer</span><span class="op" id="7711366">(</span><span class="ident" id="7711367">http</span><span class="op" id="7711371">.</span><span class="ident" id="7711372">HandlerFunc</span><span class="op" id="7711383">(</span><span class="keyword" id="7711384">func</span><span class="op" id="7711388">(</span><span class="ident" id="7711389">w</span>&nbsp;<span class="ident" id="7711391">http</span><span class="op" id="7711395">.</span><span class="ident" id="7711396">ResponseWriter</span><span class="op" id="7711410">,</span>&nbsp;<span class="ident" id="7711412">r</span>&nbsp;<span class="op" id="7711414">*</span><span class="ident" id="7711415">http</span><span class="op" id="7711419">.</span><span class="ident" id="7711420">Request</span><span class="op" id="7711427">)</span>&nbsp;<span class="op" id="7711429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7711433">w</span><span class="op" id="7711434">.</span><span class="ident" id="7711435">Header</span><span class="op" id="7711441">(</span><span class="op" id="7711442">)</span><span class="op" id="7711443">.</span><span class="ident" id="7711444">Set</span><span class="op" id="7711447">(</span><span class="string" id="7711448">&#34;X-Got-Query&#34;</span><span class="op" id="7711461">,</span>&nbsp;<span class="ident" id="7711463">r</span><span class="op" id="7711464">.</span><span class="ident" id="7711465">URL</span><span class="op" id="7711468">.</span><span class="ident" id="7711469">RawQuery</span><span class="op" id="7711477">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7711481">w</span><span class="op" id="7711482">.</span><span class="ident" id="7711483">Write</span><span class="op" id="7711488">(</span><span class="op" id="7711489">[</span><span class="op" id="7711490">]</span><span class="builtintype" id="7711491">byte</span><span class="op" id="7711495">(</span><span class="string" id="7711496">&#34;hi&#34;</span><span class="op" id="7711500">)</span><span class="op" id="7711501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7711504">}</span><span class="op" id="7711505">)</span><span class="op" id="7711506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7711509">defer</span>&nbsp;<span class="ident" id="7711515">backend</span><span class="op" id="7711522">.</span><span class="ident" id="7711523">Close</span><span class="op" id="7711528">(</span><span class="op" id="7711529">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7711533">for</span>&nbsp;<span class="ident" id="7711537">i</span><span class="op" id="7711538">,</span>&nbsp;<span class="ident" id="7711540">tt</span>&nbsp;<span class="op" id="7711543">:=</span>&nbsp;<span class="keyword" id="7711546">range</span>&nbsp;<span class="ident" id="7711552">proxyQueryTests</span>&nbsp;<span class="op" id="7711568">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7711572">backendURL</span><span class="op" id="7711582">,</span>&nbsp;<span class="ident" id="7711584">err</span>&nbsp;<span class="op" id="7711588">:=</span>&nbsp;<span class="ident" id="7711591">url</span><span class="op" id="7711594">.</span><span class="ident" id="7711595">Parse</span><span class="op" id="7711600">(</span><span class="ident" id="7711601">backend</span><span class="op" id="7711608">.</span><span class="ident" id="7711609">URL</span>&nbsp;<span class="op" id="7711613">+</span>&nbsp;<span class="ident" id="7711615">tt</span><span class="op" id="7711617">.</span><span class="ident" id="7711618">baseSuffix</span><span class="op" id="7711628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7711632">if</span>&nbsp;<span class="ident" id="7711635">err</span>&nbsp;<span class="op" id="7711639">!=</span>&nbsp;<span class="ident" id="7711642">nil</span>&nbsp;<span class="op" id="7711646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7711651">t</span><span class="op" id="7711652">.</span><span class="ident" id="7711653">Fatal</span><span class="op" id="7711658">(</span><span class="ident" id="7711659">err</span><span class="op" id="7711662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7711666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7711670">frontend</span>&nbsp;<span class="op" id="7711679">:=</span>&nbsp;<span class="ident" id="7711682">httptest</span><span class="op" id="7711690">.</span><span class="ident" id="7711691">NewServer</span><span class="op" id="7711700">(</span><span class="ident" id="7711701">NewSingleHostReverseProxy</span><span class="op" id="7711726">(</span><span class="ident" id="7711727">backendURL</span><span class="op" id="7711737">)</span><span class="op" id="7711738">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7711742">req</span><span class="op" id="7711745">,</span>&nbsp;<span class="ident" id="7711747">_</span>&nbsp;<span class="op" id="7711749">:=</span>&nbsp;<span class="ident" id="7711752">http</span><span class="op" id="7711756">.</span><span class="ident" id="7711757">NewRequest</span><span class="op" id="7711767">(</span><span class="string" id="7711768">&#34;GET&#34;</span><span class="op" id="7711773">,</span>&nbsp;<span class="ident" id="7711775">frontend</span><span class="op" id="7711783">.</span><span class="ident" id="7711784">URL</span><span class="op" id="7711787">+</span><span class="ident" id="7711788">tt</span><span class="op" id="7711790">.</span><span class="ident" id="7711791">reqSuffix</span><span class="op" id="7711800">,</span>&nbsp;<span class="ident" id="7711802">nil</span><span class="op" id="7711805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7711809">req</span><span class="op" id="7711812">.</span><span class="ident" id="7711813">Close</span>&nbsp;<span class="op" id="7711819">=</span>&nbsp;<span class="builtintype" id="7711821">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7711828">res</span><span class="op" id="7711831">,</span>&nbsp;<span class="ident" id="7711833">err</span>&nbsp;<span class="op" id="7711837">:=</span>&nbsp;<span class="ident" id="7711840">http</span><span class="op" id="7711844">.</span><span class="ident" id="7711845">DefaultClient</span><span class="op" id="7711858">.</span><span class="ident" id="7711859">Do</span><span class="op" id="7711861">(</span><span class="ident" id="7711862">req</span><span class="op" id="7711865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7711869">if</span>&nbsp;<span class="ident" id="7711872">err</span>&nbsp;<span class="op" id="7711876">!=</span>&nbsp;<span class="ident" id="7711879">nil</span>&nbsp;<span class="op" id="7711883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7711888">t</span><span class="op" id="7711889">.</span><span class="ident" id="7711890">Fatalf</span><span class="op" id="7711896">(</span><span class="string" id="7711897">&#34;%d.&nbsp;Get:&nbsp;%v&#34;</span><span class="op" id="7711910">,</span>&nbsp;<span class="ident" id="7711912">i</span><span class="op" id="7711913">,</span>&nbsp;<span class="ident" id="7711915">err</span><span class="op" id="7711918">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7711922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7711926">if</span>&nbsp;<span class="ident" id="7711929">g</span><span class="op" id="7711930">,</span>&nbsp;<span class="ident" id="7711932">e</span>&nbsp;<span class="op" id="7711934">:=</span>&nbsp;<span class="ident" id="7711937">res</span><span class="op" id="7711940">.</span><span class="ident" id="7711941">Header</span><span class="op" id="7711947">.</span><span class="ident" id="7711948">Get</span><span class="op" id="7711951">(</span><span class="string" id="7711952">&#34;X-Got-Query&#34;</span><span class="op" id="7711965">)</span><span class="op" id="7711966">,</span>&nbsp;<span class="ident" id="7711968">tt</span><span class="op" id="7711970">.</span><span class="ident" id="7711971">want</span><span class="op" id="7711975">;</span>&nbsp;<span class="ident" id="7711977">g</span>&nbsp;<span class="op" id="7711979">!=</span>&nbsp;<span class="ident" id="7711982">e</span>&nbsp;<span class="op" id="7711984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7711989">t</span><span class="op" id="7711990">.</span><span class="ident" id="7711991">Errorf</span><span class="op" id="7711997">(</span><span class="string" id="7711998">&#34;%d.&nbsp;got&nbsp;query&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7712029">,</span>&nbsp;<span class="ident" id="7712031">i</span><span class="op" id="7712032">,</span>&nbsp;<span class="ident" id="7712034">g</span><span class="op" id="7712035">,</span>&nbsp;<span class="ident" id="7712037">e</span><span class="op" id="7712038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7712042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7712046">res</span><span class="op" id="7712049">.</span><span class="ident" id="7712050">Body</span><span class="op" id="7712054">.</span><span class="ident" id="7712055">Close</span><span class="op" id="7712060">(</span><span class="op" id="7712061">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7712065">frontend</span><span class="op" id="7712073">.</span><span class="ident" id="7712074">Close</span><span class="op" id="7712079">(</span><span class="op" id="7712080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7712083">}</span><br>
<span class="lineno"></span><span class="op" id="7712085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7712088">func</span>&nbsp;<span class="ident" id="7712093">TestReverseProxyFlushInterval</span><span class="op" id="7712122">(</span><span class="ident" id="7712123">t</span>&nbsp;<span class="op" id="7712125">*</span><span class="ident" id="7712126">testing</span><span class="op" id="7712133">.</span><span class="ident" id="7712134">T</span><span class="op" id="7712135">)</span>&nbsp;<span class="op" id="7712137">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7712140">const</span>&nbsp;<span class="ident" id="7712146">expected</span>&nbsp;<span class="op" id="7712155">=</span>&nbsp;<span class="string" id="7712157">&#34;hi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7712163">backend</span>&nbsp;<span class="op" id="7712171">:=</span>&nbsp;<span class="ident" id="7712174">httptest</span><span class="op" id="7712182">.</span><span class="ident" id="7712183">NewServer</span><span class="op" id="7712192">(</span><span class="ident" id="7712193">http</span><span class="op" id="7712197">.</span><span class="ident" id="7712198">HandlerFunc</span><span class="op" id="7712209">(</span><span class="keyword" id="7712210">func</span><span class="op" id="7712214">(</span><span class="ident" id="7712215">w</span>&nbsp;<span class="ident" id="7712217">http</span><span class="op" id="7712221">.</span><span class="ident" id="7712222">ResponseWriter</span><span class="op" id="7712236">,</span>&nbsp;<span class="ident" id="7712238">r</span>&nbsp;<span class="op" id="7712240">*</span><span class="ident" id="7712241">http</span><span class="op" id="7712245">.</span><span class="ident" id="7712246">Request</span><span class="op" id="7712253">)</span>&nbsp;<span class="op" id="7712255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7712259">w</span><span class="op" id="7712260">.</span><span class="ident" id="7712261">Write</span><span class="op" id="7712266">(</span><span class="op" id="7712267">[</span><span class="op" id="7712268">]</span><span class="builtintype" id="7712269">byte</span><span class="op" id="7712273">(</span><span class="ident" id="7712274">expected</span><span class="op" id="7712282">)</span><span class="op" id="7712283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7712286">}</span><span class="op" id="7712287">)</span><span class="op" id="7712288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7712291">defer</span>&nbsp;<span class="ident" id="7712297">backend</span><span class="op" id="7712304">.</span><span class="ident" id="7712305">Close</span><span class="op" id="7712310">(</span><span class="op" id="7712311">)</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7712315">backendURL</span><span class="op" id="7712325">,</span>&nbsp;<span class="ident" id="7712327">err</span>&nbsp;<span class="op" id="7712331">:=</span>&nbsp;<span class="ident" id="7712334">url</span><span class="op" id="7712337">.</span><span class="ident" id="7712338">Parse</span><span class="op" id="7712343">(</span><span class="ident" id="7712344">backend</span><span class="op" id="7712351">.</span><span class="ident" id="7712352">URL</span><span class="op" id="7712355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7712358">if</span>&nbsp;<span class="ident" id="7712361">err</span>&nbsp;<span class="op" id="7712365">!=</span>&nbsp;<span class="ident" id="7712368">nil</span>&nbsp;<span class="op" id="7712372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7712376">t</span><span class="op" id="7712377">.</span><span class="ident" id="7712378">Fatal</span><span class="op" id="7712383">(</span><span class="ident" id="7712384">err</span><span class="op" id="7712387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7712390">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7712394">proxyHandler</span>&nbsp;<span class="op" id="7712407">:=</span>&nbsp;<span class="ident" id="7712410">NewSingleHostReverseProxy</span><span class="op" id="7712435">(</span><span class="ident" id="7712436">backendURL</span><span class="op" id="7712446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7712449">proxyHandler</span><span class="op" id="7712461">.</span><span class="ident" id="7712462">FlushInterval</span>&nbsp;<span class="op" id="7712476">=</span>&nbsp;<span class="ident" id="7712478">time</span><span class="op" id="7712482">.</span><span class="ident" id="7712483">Microsecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7712497">done</span>&nbsp;<span class="op" id="7712502">:=</span>&nbsp;<span class="builtinfunc" id="7712505">make</span><span class="op" id="7712509">(</span><span class="keyword" id="7712510">chan</span>&nbsp;<span class="builtintype" id="7712515">bool</span><span class="op" id="7712519">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7712522">onExitFlushLoop</span>&nbsp;<span class="op" id="7712538">=</span>&nbsp;<span class="keyword" id="7712540">func</span><span class="op" id="7712544">(</span><span class="op" id="7712545">)</span>&nbsp;<span class="op" id="7712547">{</span>&nbsp;<span class="ident" id="7712549">done</span>&nbsp;<span class="op" id="7712554">&lt;-</span>&nbsp;<span class="builtintype" id="7712557">true</span>&nbsp;<span class="op" id="7712562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7712565">defer</span>&nbsp;<span class="keyword" id="7712571">func</span><span class="op" id="7712575">(</span><span class="op" id="7712576">)</span>&nbsp;<span class="op" id="7712578">{</span>&nbsp;<span class="ident" id="7712580">onExitFlushLoop</span>&nbsp;<span class="op" id="7712596">=</span>&nbsp;<span class="ident" id="7712598">nil</span>&nbsp;<span class="op" id="7712602">}</span><span class="op" id="7712603">(</span><span class="op" id="7712604">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7712608">frontend</span>&nbsp;<span class="op" id="7712617">:=</span>&nbsp;<span class="ident" id="7712620">httptest</span><span class="op" id="7712628">.</span><span class="ident" id="7712629">NewServer</span><span class="op" id="7712638">(</span><span class="ident" id="7712639">proxyHandler</span><span class="op" id="7712651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7712654">defer</span>&nbsp;<span class="ident" id="7712660">frontend</span><span class="op" id="7712668">.</span><span class="ident" id="7712669">Close</span><span class="op" id="7712674">(</span><span class="op" id="7712675">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7712679">req</span><span class="op" id="7712682">,</span>&nbsp;<span class="ident" id="7712684">_</span>&nbsp;<span class="op" id="7712686">:=</span>&nbsp;<span class="ident" id="7712689">http</span><span class="op" id="7712693">.</span><span class="ident" id="7712694">NewRequest</span><span class="op" id="7712704">(</span><span class="string" id="7712705">&#34;GET&#34;</span><span class="op" id="7712710">,</span>&nbsp;<span class="ident" id="7712712">frontend</span><span class="op" id="7712720">.</span><span class="ident" id="7712721">URL</span><span class="op" id="7712724">,</span>&nbsp;<span class="ident" id="7712726">nil</span><span class="op" id="7712729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7712732">req</span><span class="op" id="7712735">.</span><span class="ident" id="7712736">Close</span>&nbsp;<span class="op" id="7712742">=</span>&nbsp;<span class="builtintype" id="7712744">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7712750">res</span><span class="op" id="7712753">,</span>&nbsp;<span class="ident" id="7712755">err</span>&nbsp;<span class="op" id="7712759">:=</span>&nbsp;<span class="ident" id="7712762">http</span><span class="op" id="7712766">.</span><span class="ident" id="7712767">DefaultClient</span><span class="op" id="7712780">.</span><span class="ident" id="7712781">Do</span><span class="op" id="7712783">(</span><span class="ident" id="7712784">req</span><span class="op" id="7712787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7712790">if</span>&nbsp;<span class="ident" id="7712793">err</span>&nbsp;<span class="op" id="7712797">!=</span>&nbsp;<span class="ident" id="7712800">nil</span>&nbsp;<span class="op" id="7712804">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7712808">t</span><span class="op" id="7712809">.</span><span class="ident" id="7712810">Fatalf</span><span class="op" id="7712816">(</span><span class="string" id="7712817">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7712826">,</span>&nbsp;<span class="ident" id="7712828">err</span><span class="op" id="7712831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7712834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7712837">defer</span>&nbsp;<span class="ident" id="7712843">res</span><span class="op" id="7712846">.</span><span class="ident" id="7712847">Body</span><span class="op" id="7712851">.</span><span class="ident" id="7712852">Close</span><span class="op" id="7712857">(</span><span class="op" id="7712858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7712861">if</span>&nbsp;<span class="ident" id="7712864">bodyBytes</span><span class="op" id="7712873">,</span>&nbsp;<span class="ident" id="7712875">_</span>&nbsp;<span class="op" id="7712877">:=</span>&nbsp;<span class="ident" id="7712880">ioutil</span><span class="op" id="7712886">.</span><span class="ident" id="7712887">ReadAll</span><span class="op" id="7712894">(</span><span class="ident" id="7712895">res</span><span class="op" id="7712898">.</span><span class="ident" id="7712899">Body</span><span class="op" id="7712903">)</span><span class="op" id="7712904">;</span>&nbsp;<span class="builtintype" id="7712906">string</span><span class="op" id="7712912">(</span><span class="ident" id="7712913">bodyBytes</span><span class="op" id="7712922">)</span>&nbsp;<span class="op" id="7712924">!=</span>&nbsp;<span class="ident" id="7712927">expected</span>&nbsp;<span class="op" id="7712936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7712940">t</span><span class="op" id="7712941">.</span><span class="ident" id="7712942">Errorf</span><span class="op" id="7712948">(</span><span class="string" id="7712949">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7712975">,</span>&nbsp;<span class="ident" id="7712977">bodyBytes</span><span class="op" id="7712986">,</span>&nbsp;<span class="ident" id="7712988">expected</span><span class="op" id="7712996">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7712999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7713003">select</span>&nbsp;<span class="op" id="7713010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7713013">case</span>&nbsp;<span class="op" id="7713018">&lt;-</span><span class="ident" id="7713020">done</span><span class="op" id="7713024">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7713028">//&nbsp;OK</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7713035">case</span>&nbsp;<span class="op" id="7713040">&lt;-</span><span class="ident" id="7713042">time</span><span class="op" id="7713046">.</span><span class="ident" id="7713047">After</span><span class="op" id="7713052">(</span><span class="num" id="7713053">5</span>&nbsp;<span class="op" id="7713055">*</span>&nbsp;<span class="ident" id="7713057">time</span><span class="op" id="7713061">.</span><span class="ident" id="7713062">Second</span><span class="op" id="7713068">)</span><span class="op" id="7713069">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7713073">t</span><span class="op" id="7713074">.</span><span class="ident" id="7713075">Error</span><span class="op" id="7713080">(</span><span class="string" id="7713081">&#34;maxLatencyWriter&nbsp;flushLoop()&nbsp;never&nbsp;exited&#34;</span><span class="op" id="7713124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7713127">}</span><br>
<span class="lineno"></span><span class="op" id="7713129">}</span>
</div>
</body>
</html>
