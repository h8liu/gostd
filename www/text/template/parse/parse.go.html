<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4517796">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4517851">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4517905">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4517956">//&nbsp;Package&nbsp;parse&nbsp;builds&nbsp;parse&nbsp;trees&nbsp;for&nbsp;templates&nbsp;as&nbsp;defined&nbsp;by&nbsp;text/template</span><br>
<span class="lineno"></span><span class="comment" id="4518034">//&nbsp;and&nbsp;html/template.&nbsp;Clients&nbsp;should&nbsp;use&nbsp;those&nbsp;packages&nbsp;to&nbsp;construct&nbsp;templates</span><br>
<span class="lineno"></span><span class="comment" id="4518113">//&nbsp;rather&nbsp;than&nbsp;this&nbsp;one,&nbsp;which&nbsp;provides&nbsp;shared&nbsp;internal&nbsp;data&nbsp;structures&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="4518189">//&nbsp;intended&nbsp;for&nbsp;general&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="4518218">package</span>&nbsp;<span class="ident" id="4518226">parse</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4518233">import</span>&nbsp;<span class="op" id="4518240">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4518243">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4518252">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4518259">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4518270">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4518281">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="4518291">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4518294">//&nbsp;Tree&nbsp;is&nbsp;the&nbsp;representation&nbsp;of&nbsp;a&nbsp;single&nbsp;parsed&nbsp;template.</span><br>
<span class="lineno">20</span><span class="keyword" id="4518353">type</span>&nbsp;<span class="ident" id="4518358">Tree</span>&nbsp;<span class="keyword" id="4518363">struct</span>&nbsp;<span class="op" id="4518370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4518373">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4518383">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4518393">//&nbsp;name&nbsp;of&nbsp;the&nbsp;template&nbsp;represented&nbsp;by&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4518443">ParseName</span>&nbsp;<span class="builtintype" id="4518453">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4518463">//&nbsp;name&nbsp;of&nbsp;the&nbsp;top-level&nbsp;template&nbsp;during&nbsp;parsing,&nbsp;for&nbsp;error&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4518534">Root</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4518544">*</span><span class="ident" id="4518545">ListNode</span>&nbsp;<span class="comment" id="4518554">//&nbsp;top-level&nbsp;root&nbsp;of&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4518586">text</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4518596">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4518606">//&nbsp;text&nbsp;parsed&nbsp;to&nbsp;create&nbsp;the&nbsp;template&nbsp;(or&nbsp;its&nbsp;parent)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4518661">//&nbsp;Parsing&nbsp;only;&nbsp;cleared&nbsp;after&nbsp;parse.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4518700">funcs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4518710">[</span><span class="op" id="4518711">]</span><span class="keyword" id="4518712">map</span><span class="op" id="4518715">[</span><span class="builtintype" id="4518716">string</span><span class="op" id="4518722">]</span><span class="keyword" id="4518723">interface</span><span class="op" id="4518732">{</span><span class="op" id="4518733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4518736">lex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4518746">*</span><span class="ident" id="4518747">lexer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4518754">token</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4518764">[</span><span class="num" id="4518765">3</span><span class="op" id="4518766">]</span><span class="ident" id="4518767">item</span>&nbsp;<span class="comment" id="4518772">//&nbsp;three-token&nbsp;lookahead&nbsp;for&nbsp;parser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4518810">peekCount</span>&nbsp;<span class="builtintype" id="4518820">int</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4518825">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4518835">[</span><span class="op" id="4518836">]</span><span class="builtintype" id="4518837">string</span>&nbsp;<span class="comment" id="4518844">//&nbsp;variables&nbsp;defined&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span><span class="op" id="4518880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4518883">//&nbsp;Copy&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;Tree.&nbsp;Any&nbsp;parsing&nbsp;state&nbsp;is&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="4518951">func</span>&nbsp;<span class="op" id="4518956">(</span><span class="ident" id="4518957">t</span>&nbsp;<span class="op" id="4518959">*</span><span class="ident" id="4518960">Tree</span><span class="op" id="4518964">)</span>&nbsp;<span class="ident" id="4518966">Copy</span><span class="op" id="4518970">(</span><span class="op" id="4518971">)</span>&nbsp;<span class="op" id="4518973">*</span><span class="ident" id="4518974">Tree</span>&nbsp;<span class="op" id="4518979">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518982">if</span>&nbsp;<span class="ident" id="4518985">t</span>&nbsp;<span class="op" id="4518987">==</span>&nbsp;<span class="ident" id="4518990">nil</span>&nbsp;<span class="op" id="4518994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518998">return</span>&nbsp;<span class="ident" id="4519005">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4519010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4519013">return</span>&nbsp;<span class="op" id="4519020">&amp;</span><span class="ident" id="4519021">Tree</span><span class="op" id="4519025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519029">Name</span><span class="op" id="4519033">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4519040">t</span><span class="op" id="4519041">.</span><span class="ident" id="4519042">Name</span><span class="op" id="4519046">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519050">ParseName</span><span class="op" id="4519059">:</span>&nbsp;<span class="ident" id="4519061">t</span><span class="op" id="4519062">.</span><span class="ident" id="4519063">ParseName</span><span class="op" id="4519072">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519076">Root</span><span class="op" id="4519080">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4519087">t</span><span class="op" id="4519088">.</span><span class="ident" id="4519089">Root</span><span class="op" id="4519093">.</span><span class="ident" id="4519094">CopyList</span><span class="op" id="4519102">(</span><span class="op" id="4519103">)</span><span class="op" id="4519104">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519108">text</span><span class="op" id="4519112">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4519119">t</span><span class="op" id="4519120">.</span><span class="ident" id="4519121">text</span><span class="op" id="4519125">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4519128">}</span><br>
<span class="lineno"></span><span class="op" id="4519130">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="4519133">//&nbsp;Parse&nbsp;returns&nbsp;a&nbsp;map&nbsp;from&nbsp;template&nbsp;name&nbsp;to&nbsp;parse.Tree,&nbsp;created&nbsp;by&nbsp;parsing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4519213">//&nbsp;templates&nbsp;described&nbsp;in&nbsp;the&nbsp;argument&nbsp;string.&nbsp;The&nbsp;top-level&nbsp;template&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4519291">//&nbsp;given&nbsp;the&nbsp;specified&nbsp;name.&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;encountered,&nbsp;parsing&nbsp;stops&nbsp;and&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4519369">//&nbsp;empty&nbsp;map&nbsp;is&nbsp;returned&nbsp;with&nbsp;the&nbsp;error.</span><br>
<span class="lineno">50</span><span class="keyword" id="4519410">func</span>&nbsp;<span class="ident" id="4519415">Parse</span><span class="op" id="4519420">(</span><span class="ident" id="4519421">name</span><span class="op" id="4519425">,</span>&nbsp;<span class="ident" id="4519427">text</span><span class="op" id="4519431">,</span>&nbsp;<span class="ident" id="4519433">leftDelim</span><span class="op" id="4519442">,</span>&nbsp;<span class="ident" id="4519444">rightDelim</span>&nbsp;<span class="builtintype" id="4519455">string</span><span class="op" id="4519461">,</span>&nbsp;<span class="ident" id="4519463">funcs</span>&nbsp;<span class="op" id="4519469">...</span><span class="keyword" id="4519472">map</span><span class="op" id="4519475">[</span><span class="builtintype" id="4519476">string</span><span class="op" id="4519482">]</span><span class="keyword" id="4519483">interface</span><span class="op" id="4519492">{</span><span class="op" id="4519493">}</span><span class="op" id="4519494">)</span>&nbsp;<span class="op" id="4519496">(</span><span class="ident" id="4519497">treeSet</span>&nbsp;<span class="keyword" id="4519505">map</span><span class="op" id="4519508">[</span><span class="builtintype" id="4519509">string</span><span class="op" id="4519515">]</span><span class="op" id="4519516">*</span><span class="ident" id="4519517">Tree</span><span class="op" id="4519521">,</span>&nbsp;<span class="ident" id="4519523">err</span>&nbsp;<span class="builtintype" id="4519527">error</span><span class="op" id="4519532">)</span>&nbsp;<span class="op" id="4519534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519537">treeSet</span>&nbsp;<span class="op" id="4519545">=</span>&nbsp;<span class="builtinfunc" id="4519547">make</span><span class="op" id="4519551">(</span><span class="keyword" id="4519552">map</span><span class="op" id="4519555">[</span><span class="builtintype" id="4519556">string</span><span class="op" id="4519562">]</span><span class="op" id="4519563">*</span><span class="ident" id="4519564">Tree</span><span class="op" id="4519568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519571">t</span>&nbsp;<span class="op" id="4519573">:=</span>&nbsp;<span class="ident" id="4519576">New</span><span class="op" id="4519579">(</span><span class="ident" id="4519580">name</span><span class="op" id="4519584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519587">t</span><span class="op" id="4519588">.</span><span class="ident" id="4519589">text</span>&nbsp;<span class="op" id="4519594">=</span>&nbsp;<span class="ident" id="4519596">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519602">_</span><span class="op" id="4519603">,</span>&nbsp;<span class="ident" id="4519605">err</span>&nbsp;<span class="op" id="4519609">=</span>&nbsp;<span class="ident" id="4519611">t</span><span class="op" id="4519612">.</span><span class="ident" id="4519613">Parse</span><span class="op" id="4519618">(</span><span class="ident" id="4519619">text</span><span class="op" id="4519623">,</span>&nbsp;<span class="ident" id="4519625">leftDelim</span><span class="op" id="4519634">,</span>&nbsp;<span class="ident" id="4519636">rightDelim</span><span class="op" id="4519646">,</span>&nbsp;<span class="ident" id="4519648">treeSet</span><span class="op" id="4519655">,</span>&nbsp;<span class="ident" id="4519657">funcs</span><span class="op" id="4519662">...</span><span class="op" id="4519665">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4519668">return</span><br>
<span class="lineno"></span><span class="op" id="4519675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4519678">//&nbsp;next&nbsp;returns&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="4519710">func</span>&nbsp;<span class="op" id="4519715">(</span><span class="ident" id="4519716">t</span>&nbsp;<span class="op" id="4519718">*</span><span class="ident" id="4519719">Tree</span><span class="op" id="4519723">)</span>&nbsp;<span class="ident" id="4519725">next</span><span class="op" id="4519729">(</span><span class="op" id="4519730">)</span>&nbsp;<span class="ident" id="4519732">item</span>&nbsp;<span class="op" id="4519737">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4519740">if</span>&nbsp;<span class="ident" id="4519743">t</span><span class="op" id="4519744">.</span><span class="ident" id="4519745">peekCount</span>&nbsp;<span class="op" id="4519755">&gt;</span>&nbsp;<span class="num" id="4519757">0</span>&nbsp;<span class="op" id="4519759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519763">t</span><span class="op" id="4519764">.</span><span class="ident" id="4519765">peekCount</span><span class="op" id="4519774">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4519778">}</span>&nbsp;<span class="keyword" id="4519780">else</span>&nbsp;<span class="op" id="4519785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519789">t</span><span class="op" id="4519790">.</span><span class="ident" id="4519791">token</span><span class="op" id="4519796">[</span><span class="num" id="4519797">0</span><span class="op" id="4519798">]</span>&nbsp;<span class="op" id="4519800">=</span>&nbsp;<span class="ident" id="4519802">t</span><span class="op" id="4519803">.</span><span class="ident" id="4519804">lex</span><span class="op" id="4519807">.</span><span class="ident" id="4519808">nextItem</span><span class="op" id="4519816">(</span><span class="op" id="4519817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4519820">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4519823">return</span>&nbsp;<span class="ident" id="4519830">t</span><span class="op" id="4519831">.</span><span class="ident" id="4519832">token</span><span class="op" id="4519837">[</span><span class="ident" id="4519838">t</span><span class="op" id="4519839">.</span><span class="ident" id="4519840">peekCount</span><span class="op" id="4519849">]</span><br>
<span class="lineno"></span><span class="op" id="4519851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4519854">//&nbsp;backup&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;one&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="4519901">func</span>&nbsp;<span class="op" id="4519906">(</span><span class="ident" id="4519907">t</span>&nbsp;<span class="op" id="4519909">*</span><span class="ident" id="4519910">Tree</span><span class="op" id="4519914">)</span>&nbsp;<span class="ident" id="4519916">backup</span><span class="op" id="4519922">(</span><span class="op" id="4519923">)</span>&nbsp;<span class="op" id="4519925">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519928">t</span><span class="op" id="4519929">.</span><span class="ident" id="4519930">peekCount</span><span class="op" id="4519939">++</span><br>
<span class="lineno"></span><span class="op" id="4519942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4519945">//&nbsp;backup2&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;two&nbsp;tokens.</span><br>
<span class="lineno"></span><span class="comment" id="4519994">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno">75</span><span class="keyword" id="4520032">func</span>&nbsp;<span class="op" id="4520037">(</span><span class="ident" id="4520038">t</span>&nbsp;<span class="op" id="4520040">*</span><span class="ident" id="4520041">Tree</span><span class="op" id="4520045">)</span>&nbsp;<span class="ident" id="4520047">backup2</span><span class="op" id="4520054">(</span><span class="ident" id="4520055">t1</span>&nbsp;<span class="ident" id="4520058">item</span><span class="op" id="4520062">)</span>&nbsp;<span class="op" id="4520064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520067">t</span><span class="op" id="4520068">.</span><span class="ident" id="4520069">token</span><span class="op" id="4520074">[</span><span class="num" id="4520075">1</span><span class="op" id="4520076">]</span>&nbsp;<span class="op" id="4520078">=</span>&nbsp;<span class="ident" id="4520080">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520084">t</span><span class="op" id="4520085">.</span><span class="ident" id="4520086">peekCount</span>&nbsp;<span class="op" id="4520096">=</span>&nbsp;<span class="num" id="4520098">2</span><br>
<span class="lineno"></span><span class="op" id="4520100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="4520103">//&nbsp;backup3&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;three&nbsp;tokens</span><br>
<span class="lineno"></span><span class="comment" id="4520153">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno"></span><span class="keyword" id="4520191">func</span>&nbsp;<span class="op" id="4520196">(</span><span class="ident" id="4520197">t</span>&nbsp;<span class="op" id="4520199">*</span><span class="ident" id="4520200">Tree</span><span class="op" id="4520204">)</span>&nbsp;<span class="ident" id="4520206">backup3</span><span class="op" id="4520213">(</span><span class="ident" id="4520214">t2</span><span class="op" id="4520216">,</span>&nbsp;<span class="ident" id="4520218">t1</span>&nbsp;<span class="ident" id="4520221">item</span><span class="op" id="4520225">)</span>&nbsp;<span class="op" id="4520227">{</span>&nbsp;<span class="comment" id="4520229">//&nbsp;Reverse&nbsp;order:&nbsp;we&#39;re&nbsp;pushing&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520268">t</span><span class="op" id="4520269">.</span><span class="ident" id="4520270">token</span><span class="op" id="4520275">[</span><span class="num" id="4520276">1</span><span class="op" id="4520277">]</span>&nbsp;<span class="op" id="4520279">=</span>&nbsp;<span class="ident" id="4520281">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520285">t</span><span class="op" id="4520286">.</span><span class="ident" id="4520287">token</span><span class="op" id="4520292">[</span><span class="num" id="4520293">2</span><span class="op" id="4520294">]</span>&nbsp;<span class="op" id="4520296">=</span>&nbsp;<span class="ident" id="4520298">t2</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520302">t</span><span class="op" id="4520303">.</span><span class="ident" id="4520304">peekCount</span>&nbsp;<span class="op" id="4520314">=</span>&nbsp;<span class="num" id="4520316">3</span><br>
<span class="lineno"></span><span class="op" id="4520318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4520321">//&nbsp;peek&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="4520374">func</span>&nbsp;<span class="op" id="4520379">(</span><span class="ident" id="4520380">t</span>&nbsp;<span class="op" id="4520382">*</span><span class="ident" id="4520383">Tree</span><span class="op" id="4520387">)</span>&nbsp;<span class="ident" id="4520389">peek</span><span class="op" id="4520393">(</span><span class="op" id="4520394">)</span>&nbsp;<span class="ident" id="4520396">item</span>&nbsp;<span class="op" id="4520401">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4520404">if</span>&nbsp;<span class="ident" id="4520407">t</span><span class="op" id="4520408">.</span><span class="ident" id="4520409">peekCount</span>&nbsp;<span class="op" id="4520419">&gt;</span>&nbsp;<span class="num" id="4520421">0</span>&nbsp;<span class="op" id="4520423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4520427">return</span>&nbsp;<span class="ident" id="4520434">t</span><span class="op" id="4520435">.</span><span class="ident" id="4520436">token</span><span class="op" id="4520441">[</span><span class="ident" id="4520442">t</span><span class="op" id="4520443">.</span><span class="ident" id="4520444">peekCount</span><span class="op" id="4520453">-</span><span class="num" id="4520454">1</span><span class="op" id="4520455">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4520458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520461">t</span><span class="op" id="4520462">.</span><span class="ident" id="4520463">peekCount</span>&nbsp;<span class="op" id="4520473">=</span>&nbsp;<span class="num" id="4520475">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520478">t</span><span class="op" id="4520479">.</span><span class="ident" id="4520480">token</span><span class="op" id="4520485">[</span><span class="num" id="4520486">0</span><span class="op" id="4520487">]</span>&nbsp;<span class="op" id="4520489">=</span>&nbsp;<span class="ident" id="4520491">t</span><span class="op" id="4520492">.</span><span class="ident" id="4520493">lex</span><span class="op" id="4520496">.</span><span class="ident" id="4520497">nextItem</span><span class="op" id="4520505">(</span><span class="op" id="4520506">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4520509">return</span>&nbsp;<span class="ident" id="4520516">t</span><span class="op" id="4520517">.</span><span class="ident" id="4520518">token</span><span class="op" id="4520523">[</span><span class="num" id="4520524">0</span><span class="op" id="4520525">]</span><br>
<span class="lineno"></span><span class="op" id="4520527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4520530">//&nbsp;nextNonSpace&nbsp;returns&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="4520580">func</span>&nbsp;<span class="op" id="4520585">(</span><span class="ident" id="4520586">t</span>&nbsp;<span class="op" id="4520588">*</span><span class="ident" id="4520589">Tree</span><span class="op" id="4520593">)</span>&nbsp;<span class="ident" id="4520595">nextNonSpace</span><span class="op" id="4520607">(</span><span class="op" id="4520608">)</span>&nbsp;<span class="op" id="4520610">(</span><span class="ident" id="4520611">token</span>&nbsp;<span class="ident" id="4520617">item</span><span class="op" id="4520621">)</span>&nbsp;<span class="op" id="4520623">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4520626">for</span>&nbsp;<span class="op" id="4520630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520634">token</span>&nbsp;<span class="op" id="4520640">=</span>&nbsp;<span class="ident" id="4520642">t</span><span class="op" id="4520643">.</span><span class="ident" id="4520644">next</span><span class="op" id="4520648">(</span><span class="op" id="4520649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4520653">if</span>&nbsp;<span class="ident" id="4520656">token</span><span class="op" id="4520661">.</span><span class="ident" id="4520662">typ</span>&nbsp;<span class="op" id="4520666">!=</span>&nbsp;<span class="ident" id="4520669">itemSpace</span>&nbsp;<span class="op" id="4520679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4520684">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4520692">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4520695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4520698">return</span>&nbsp;<span class="ident" id="4520705">token</span><br>
<span class="lineno"></span><span class="op" id="4520711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4520714">//&nbsp;peekNonSpace&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno">110</span><span class="keyword" id="4520785">func</span>&nbsp;<span class="op" id="4520790">(</span><span class="ident" id="4520791">t</span>&nbsp;<span class="op" id="4520793">*</span><span class="ident" id="4520794">Tree</span><span class="op" id="4520798">)</span>&nbsp;<span class="ident" id="4520800">peekNonSpace</span><span class="op" id="4520812">(</span><span class="op" id="4520813">)</span>&nbsp;<span class="op" id="4520815">(</span><span class="ident" id="4520816">token</span>&nbsp;<span class="ident" id="4520822">item</span><span class="op" id="4520826">)</span>&nbsp;<span class="op" id="4520828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4520831">for</span>&nbsp;<span class="op" id="4520835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520839">token</span>&nbsp;<span class="op" id="4520845">=</span>&nbsp;<span class="ident" id="4520847">t</span><span class="op" id="4520848">.</span><span class="ident" id="4520849">next</span><span class="op" id="4520853">(</span><span class="op" id="4520854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4520858">if</span>&nbsp;<span class="ident" id="4520861">token</span><span class="op" id="4520866">.</span><span class="ident" id="4520867">typ</span>&nbsp;<span class="op" id="4520871">!=</span>&nbsp;<span class="ident" id="4520874">itemSpace</span>&nbsp;<span class="op" id="4520884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4520889">break</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4520897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4520900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520903">t</span><span class="op" id="4520904">.</span><span class="ident" id="4520905">backup</span><span class="op" id="4520911">(</span><span class="op" id="4520912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4520915">return</span>&nbsp;<span class="ident" id="4520922">token</span><br>
<span class="lineno"></span><span class="op" id="4520928">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="4520931">//&nbsp;Parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4520944">//&nbsp;New&nbsp;allocates&nbsp;a&nbsp;new&nbsp;parse&nbsp;tree&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="4520999">func</span>&nbsp;<span class="ident" id="4521004">New</span><span class="op" id="4521007">(</span><span class="ident" id="4521008">name</span>&nbsp;<span class="builtintype" id="4521013">string</span><span class="op" id="4521019">,</span>&nbsp;<span class="ident" id="4521021">funcs</span>&nbsp;<span class="op" id="4521027">...</span><span class="keyword" id="4521030">map</span><span class="op" id="4521033">[</span><span class="builtintype" id="4521034">string</span><span class="op" id="4521040">]</span><span class="keyword" id="4521041">interface</span><span class="op" id="4521050">{</span><span class="op" id="4521051">}</span><span class="op" id="4521052">)</span>&nbsp;<span class="op" id="4521054">*</span><span class="ident" id="4521055">Tree</span>&nbsp;<span class="op" id="4521060">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4521063">return</span>&nbsp;<span class="op" id="4521070">&amp;</span><span class="ident" id="4521071">Tree</span><span class="op" id="4521075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521079">Name</span><span class="op" id="4521083">:</span>&nbsp;&nbsp;<span class="ident" id="4521086">name</span><span class="op" id="4521090">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521094">funcs</span><span class="op" id="4521099">:</span>&nbsp;<span class="ident" id="4521101">funcs</span><span class="op" id="4521106">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4521109">}</span><br>
<span class="lineno"></span><span class="op" id="4521111">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="4521114">//&nbsp;ErrorContext&nbsp;returns&nbsp;a&nbsp;textual&nbsp;representation&nbsp;of&nbsp;the&nbsp;location&nbsp;of&nbsp;the&nbsp;node&nbsp;in&nbsp;the&nbsp;input&nbsp;text.</span><br>
<span class="lineno"></span><span class="comment" id="4521210">//&nbsp;The&nbsp;receiver&nbsp;is&nbsp;only&nbsp;used&nbsp;when&nbsp;the&nbsp;node&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;tree&nbsp;inside,</span><br>
<span class="lineno"></span><span class="comment" id="4521297">//&nbsp;which&nbsp;can&nbsp;occur&nbsp;in&nbsp;old&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="4521329">func</span>&nbsp;<span class="op" id="4521334">(</span><span class="ident" id="4521335">t</span>&nbsp;<span class="op" id="4521337">*</span><span class="ident" id="4521338">Tree</span><span class="op" id="4521342">)</span>&nbsp;<span class="ident" id="4521344">ErrorContext</span><span class="op" id="4521356">(</span><span class="ident" id="4521357">n</span>&nbsp;<span class="ident" id="4521359">Node</span><span class="op" id="4521363">)</span>&nbsp;<span class="op" id="4521365">(</span><span class="ident" id="4521366">location</span><span class="op" id="4521374">,</span>&nbsp;<span class="ident" id="4521376">context</span>&nbsp;<span class="builtintype" id="4521384">string</span><span class="op" id="4521390">)</span>&nbsp;<span class="op" id="4521392">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521395">pos</span>&nbsp;<span class="op" id="4521399">:=</span>&nbsp;<span class="builtintype" id="4521402">int</span><span class="op" id="4521405">(</span><span class="ident" id="4521406">n</span><span class="op" id="4521407">.</span><span class="ident" id="4521408">Position</span><span class="op" id="4521416">(</span><span class="op" id="4521417">)</span><span class="op" id="4521418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521421">tree</span>&nbsp;<span class="op" id="4521426">:=</span>&nbsp;<span class="ident" id="4521429">n</span><span class="op" id="4521430">.</span><span class="ident" id="4521431">tree</span><span class="op" id="4521435">(</span><span class="op" id="4521436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4521439">if</span>&nbsp;<span class="ident" id="4521442">tree</span>&nbsp;<span class="op" id="4521447">==</span>&nbsp;<span class="ident" id="4521450">nil</span>&nbsp;<span class="op" id="4521454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521458">tree</span>&nbsp;<span class="op" id="4521463">=</span>&nbsp;<span class="ident" id="4521465">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4521468">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521471">text</span>&nbsp;<span class="op" id="4521476">:=</span>&nbsp;<span class="ident" id="4521479">tree</span><span class="op" id="4521483">.</span><span class="ident" id="4521484">text</span><span class="op" id="4521488">[</span><span class="op" id="4521489">:</span><span class="ident" id="4521490">pos</span><span class="op" id="4521493">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521496">byteNum</span>&nbsp;<span class="op" id="4521504">:=</span>&nbsp;<span class="ident" id="4521507">strings</span><span class="op" id="4521514">.</span><span class="ident" id="4521515">LastIndex</span><span class="op" id="4521524">(</span><span class="ident" id="4521525">text</span><span class="op" id="4521529">,</span>&nbsp;<span class="string" id="4521531">&#34;\n&#34;</span><span class="op" id="4521535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4521538">if</span>&nbsp;<span class="ident" id="4521541">byteNum</span>&nbsp;<span class="op" id="4521549">==</span>&nbsp;<span class="op" id="4521552">-</span><span class="num" id="4521553">1</span>&nbsp;<span class="op" id="4521555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521559">byteNum</span>&nbsp;<span class="op" id="4521567">=</span>&nbsp;<span class="ident" id="4521569">pos</span>&nbsp;<span class="comment" id="4521573">//&nbsp;On&nbsp;first&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4521592">}</span>&nbsp;<span class="keyword" id="4521594">else</span>&nbsp;<span class="op" id="4521599">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521603">byteNum</span><span class="op" id="4521610">++</span>&nbsp;<span class="comment" id="4521613">//&nbsp;After&nbsp;the&nbsp;newline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521637">byteNum</span>&nbsp;<span class="op" id="4521645">=</span>&nbsp;<span class="ident" id="4521647">pos</span>&nbsp;<span class="op" id="4521651">-</span>&nbsp;<span class="ident" id="4521653">byteNum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4521662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521665">lineNum</span>&nbsp;<span class="op" id="4521673">:=</span>&nbsp;<span class="num" id="4521676">1</span>&nbsp;<span class="op" id="4521678">+</span>&nbsp;<span class="ident" id="4521680">strings</span><span class="op" id="4521687">.</span><span class="ident" id="4521688">Count</span><span class="op" id="4521693">(</span><span class="ident" id="4521694">text</span><span class="op" id="4521698">,</span>&nbsp;<span class="string" id="4521700">&#34;\n&#34;</span><span class="op" id="4521704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521707">context</span>&nbsp;<span class="op" id="4521715">=</span>&nbsp;<span class="ident" id="4521717">n</span><span class="op" id="4521718">.</span><span class="ident" id="4521719">String</span><span class="op" id="4521725">(</span><span class="op" id="4521726">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4521729">if</span>&nbsp;<span class="builtinfunc" id="4521732">len</span><span class="op" id="4521735">(</span><span class="ident" id="4521736">context</span><span class="op" id="4521743">)</span>&nbsp;<span class="op" id="4521745">&gt;</span>&nbsp;<span class="num" id="4521747">20</span>&nbsp;<span class="op" id="4521750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521754">context</span>&nbsp;<span class="op" id="4521762">=</span>&nbsp;<span class="ident" id="4521764">fmt</span><span class="op" id="4521767">.</span><span class="ident" id="4521768">Sprintf</span><span class="op" id="4521775">(</span><span class="string" id="4521776">&#34;%.20s...&#34;</span><span class="op" id="4521786">,</span>&nbsp;<span class="ident" id="4521788">context</span><span class="op" id="4521795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4521798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4521801">return</span>&nbsp;<span class="ident" id="4521808">fmt</span><span class="op" id="4521811">.</span><span class="ident" id="4521812">Sprintf</span><span class="op" id="4521819">(</span><span class="string" id="4521820">&#34;%s:%d:%d&#34;</span><span class="op" id="4521830">,</span>&nbsp;<span class="ident" id="4521832">tree</span><span class="op" id="4521836">.</span><span class="ident" id="4521837">ParseName</span><span class="op" id="4521846">,</span>&nbsp;<span class="ident" id="4521848">lineNum</span><span class="op" id="4521855">,</span>&nbsp;<span class="ident" id="4521857">byteNum</span><span class="op" id="4521864">)</span><span class="op" id="4521865">,</span>&nbsp;<span class="ident" id="4521867">context</span><br>
<span class="lineno"></span><span class="op" id="4521875">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4521878">//&nbsp;errorf&nbsp;formats&nbsp;the&nbsp;error&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="4521933">func</span>&nbsp;<span class="op" id="4521938">(</span><span class="ident" id="4521939">t</span>&nbsp;<span class="op" id="4521941">*</span><span class="ident" id="4521942">Tree</span><span class="op" id="4521946">)</span>&nbsp;<span class="ident" id="4521948">errorf</span><span class="op" id="4521954">(</span><span class="ident" id="4521955">format</span>&nbsp;<span class="builtintype" id="4521962">string</span><span class="op" id="4521968">,</span>&nbsp;<span class="ident" id="4521970">args</span>&nbsp;<span class="op" id="4521975">...</span><span class="keyword" id="4521978">interface</span><span class="op" id="4521987">{</span><span class="op" id="4521988">}</span><span class="op" id="4521989">)</span>&nbsp;<span class="op" id="4521991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521994">t</span><span class="op" id="4521995">.</span><span class="ident" id="4521996">Root</span>&nbsp;<span class="op" id="4522001">=</span>&nbsp;<span class="ident" id="4522003">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522008">format</span>&nbsp;<span class="op" id="4522015">=</span>&nbsp;<span class="ident" id="4522017">fmt</span><span class="op" id="4522020">.</span><span class="ident" id="4522021">Sprintf</span><span class="op" id="4522028">(</span><span class="string" id="4522029">&#34;template:&nbsp;%s:%d:&nbsp;%s&#34;</span><span class="op" id="4522050">,</span>&nbsp;<span class="ident" id="4522052">t</span><span class="op" id="4522053">.</span><span class="ident" id="4522054">ParseName</span><span class="op" id="4522063">,</span>&nbsp;<span class="ident" id="4522065">t</span><span class="op" id="4522066">.</span><span class="ident" id="4522067">lex</span><span class="op" id="4522070">.</span><span class="ident" id="4522071">lineNumber</span><span class="op" id="4522081">(</span><span class="op" id="4522082">)</span><span class="op" id="4522083">,</span>&nbsp;<span class="ident" id="4522085">format</span><span class="op" id="4522091">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4522094">panic</span><span class="op" id="4522099">(</span><span class="ident" id="4522100">fmt</span><span class="op" id="4522103">.</span><span class="ident" id="4522104">Errorf</span><span class="op" id="4522110">(</span><span class="ident" id="4522111">format</span><span class="op" id="4522117">,</span>&nbsp;<span class="ident" id="4522119">args</span><span class="op" id="4522123">...</span><span class="op" id="4522126">)</span><span class="op" id="4522127">)</span><br>
<span class="lineno"></span><span class="op" id="4522129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4522132">//&nbsp;error&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="4522164">func</span>&nbsp;<span class="op" id="4522169">(</span><span class="ident" id="4522170">t</span>&nbsp;<span class="op" id="4522172">*</span><span class="ident" id="4522173">Tree</span><span class="op" id="4522177">)</span>&nbsp;<span class="builtintype" id="4522179">error</span><span class="op" id="4522184">(</span><span class="ident" id="4522185">err</span>&nbsp;<span class="builtintype" id="4522189">error</span><span class="op" id="4522194">)</span>&nbsp;<span class="op" id="4522196">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522199">t</span><span class="op" id="4522200">.</span><span class="ident" id="4522201">errorf</span><span class="op" id="4522207">(</span><span class="string" id="4522208">&#34;%s&#34;</span><span class="op" id="4522212">,</span>&nbsp;<span class="ident" id="4522214">err</span><span class="op" id="4522217">)</span><br>
<span class="lineno"></span><span class="op" id="4522219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4522222">//&nbsp;expect&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;the&nbsp;required&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4522297">func</span>&nbsp;<span class="op" id="4522302">(</span><span class="ident" id="4522303">t</span>&nbsp;<span class="op" id="4522305">*</span><span class="ident" id="4522306">Tree</span><span class="op" id="4522310">)</span>&nbsp;<span class="ident" id="4522312">expect</span><span class="op" id="4522318">(</span><span class="ident" id="4522319">expected</span>&nbsp;<span class="ident" id="4522328">itemType</span><span class="op" id="4522336">,</span>&nbsp;<span class="ident" id="4522338">context</span>&nbsp;<span class="builtintype" id="4522346">string</span><span class="op" id="4522352">)</span>&nbsp;<span class="ident" id="4522354">item</span>&nbsp;<span class="op" id="4522359">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522362">token</span>&nbsp;<span class="op" id="4522368">:=</span>&nbsp;<span class="ident" id="4522371">t</span><span class="op" id="4522372">.</span><span class="ident" id="4522373">nextNonSpace</span><span class="op" id="4522385">(</span><span class="op" id="4522386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522389">if</span>&nbsp;<span class="ident" id="4522392">token</span><span class="op" id="4522397">.</span><span class="ident" id="4522398">typ</span>&nbsp;<span class="op" id="4522402">!=</span>&nbsp;<span class="ident" id="4522405">expected</span>&nbsp;<span class="op" id="4522414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522418">t</span><span class="op" id="4522419">.</span><span class="ident" id="4522420">unexpected</span><span class="op" id="4522430">(</span><span class="ident" id="4522431">token</span><span class="op" id="4522436">,</span>&nbsp;<span class="ident" id="4522438">context</span><span class="op" id="4522445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4522448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522451">return</span>&nbsp;<span class="ident" id="4522458">token</span><br>
<span class="lineno">175</span><span class="op" id="4522464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4522467">//&nbsp;expectOneOf&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;one&nbsp;of&nbsp;the&nbsp;required&nbsp;types.</span><br>
<span class="lineno"></span><span class="keyword" id="4522555">func</span>&nbsp;<span class="op" id="4522560">(</span><span class="ident" id="4522561">t</span>&nbsp;<span class="op" id="4522563">*</span><span class="ident" id="4522564">Tree</span><span class="op" id="4522568">)</span>&nbsp;<span class="ident" id="4522570">expectOneOf</span><span class="op" id="4522581">(</span><span class="ident" id="4522582">expected1</span><span class="op" id="4522591">,</span>&nbsp;<span class="ident" id="4522593">expected2</span>&nbsp;<span class="ident" id="4522603">itemType</span><span class="op" id="4522611">,</span>&nbsp;<span class="ident" id="4522613">context</span>&nbsp;<span class="builtintype" id="4522621">string</span><span class="op" id="4522627">)</span>&nbsp;<span class="ident" id="4522629">item</span>&nbsp;<span class="op" id="4522634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522637">token</span>&nbsp;<span class="op" id="4522643">:=</span>&nbsp;<span class="ident" id="4522646">t</span><span class="op" id="4522647">.</span><span class="ident" id="4522648">nextNonSpace</span><span class="op" id="4522660">(</span><span class="op" id="4522661">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522664">if</span>&nbsp;<span class="ident" id="4522667">token</span><span class="op" id="4522672">.</span><span class="ident" id="4522673">typ</span>&nbsp;<span class="op" id="4522677">!=</span>&nbsp;<span class="ident" id="4522680">expected1</span>&nbsp;<span class="op" id="4522690">&amp;&amp;</span>&nbsp;<span class="ident" id="4522693">token</span><span class="op" id="4522698">.</span><span class="ident" id="4522699">typ</span>&nbsp;<span class="op" id="4522703">!=</span>&nbsp;<span class="ident" id="4522706">expected2</span>&nbsp;<span class="op" id="4522716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522720">t</span><span class="op" id="4522721">.</span><span class="ident" id="4522722">unexpected</span><span class="op" id="4522732">(</span><span class="ident" id="4522733">token</span><span class="op" id="4522738">,</span>&nbsp;<span class="ident" id="4522740">context</span><span class="op" id="4522747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4522750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522753">return</span>&nbsp;<span class="ident" id="4522760">token</span><br>
<span class="lineno"></span><span class="op" id="4522766">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="comment" id="4522769">//&nbsp;unexpected&nbsp;complains&nbsp;about&nbsp;the&nbsp;token&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="4522836">func</span>&nbsp;<span class="op" id="4522841">(</span><span class="ident" id="4522842">t</span>&nbsp;<span class="op" id="4522844">*</span><span class="ident" id="4522845">Tree</span><span class="op" id="4522849">)</span>&nbsp;<span class="ident" id="4522851">unexpected</span><span class="op" id="4522861">(</span><span class="ident" id="4522862">token</span>&nbsp;<span class="ident" id="4522868">item</span><span class="op" id="4522872">,</span>&nbsp;<span class="ident" id="4522874">context</span>&nbsp;<span class="builtintype" id="4522882">string</span><span class="op" id="4522888">)</span>&nbsp;<span class="op" id="4522890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522893">t</span><span class="op" id="4522894">.</span><span class="ident" id="4522895">errorf</span><span class="op" id="4522901">(</span><span class="string" id="4522902">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="4522923">,</span>&nbsp;<span class="ident" id="4522925">token</span><span class="op" id="4522930">,</span>&nbsp;<span class="ident" id="4522932">context</span><span class="op" id="4522939">)</span><br>
<span class="lineno"></span><span class="op" id="4522941">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="4522944">//&nbsp;recover&nbsp;is&nbsp;the&nbsp;handler&nbsp;that&nbsp;turns&nbsp;panics&nbsp;into&nbsp;returns&nbsp;from&nbsp;the&nbsp;top&nbsp;level&nbsp;of&nbsp;Parse.</span><br>
<span class="lineno"></span><span class="keyword" id="4523030">func</span>&nbsp;<span class="op" id="4523035">(</span><span class="ident" id="4523036">t</span>&nbsp;<span class="op" id="4523038">*</span><span class="ident" id="4523039">Tree</span><span class="op" id="4523043">)</span>&nbsp;<span class="builtinfunc" id="4523045">recover</span><span class="op" id="4523052">(</span><span class="ident" id="4523053">errp</span>&nbsp;<span class="op" id="4523058">*</span><span class="builtintype" id="4523059">error</span><span class="op" id="4523064">)</span>&nbsp;<span class="op" id="4523066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523069">e</span>&nbsp;<span class="op" id="4523071">:=</span>&nbsp;<span class="builtinfunc" id="4523074">recover</span><span class="op" id="4523081">(</span><span class="op" id="4523082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523085">if</span>&nbsp;<span class="ident" id="4523088">e</span>&nbsp;<span class="op" id="4523090">!=</span>&nbsp;<span class="ident" id="4523093">nil</span>&nbsp;<span class="op" id="4523097">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523101">if</span>&nbsp;<span class="ident" id="4523104">_</span><span class="op" id="4523105">,</span>&nbsp;<span class="ident" id="4523107">ok</span>&nbsp;<span class="op" id="4523110">:=</span>&nbsp;<span class="ident" id="4523113">e</span><span class="op" id="4523114">.</span><span class="op" id="4523115">(</span><span class="ident" id="4523116">runtime</span><span class="op" id="4523123">.</span><span class="ident" id="4523124">Error</span><span class="op" id="4523129">)</span><span class="op" id="4523130">;</span>&nbsp;<span class="ident" id="4523132">ok</span>&nbsp;<span class="op" id="4523135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4523140">panic</span><span class="op" id="4523145">(</span><span class="ident" id="4523146">e</span><span class="op" id="4523147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4523151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523155">if</span>&nbsp;<span class="ident" id="4523158">t</span>&nbsp;<span class="op" id="4523160">!=</span>&nbsp;<span class="ident" id="4523163">nil</span>&nbsp;<span class="op" id="4523167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523172">t</span><span class="op" id="4523173">.</span><span class="ident" id="4523174">stopParse</span><span class="op" id="4523183">(</span><span class="op" id="4523184">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4523188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4523192">*</span><span class="ident" id="4523193">errp</span>&nbsp;<span class="op" id="4523198">=</span>&nbsp;<span class="ident" id="4523200">e</span><span class="op" id="4523201">.</span><span class="op" id="4523202">(</span><span class="builtintype" id="4523203">error</span><span class="op" id="4523208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4523211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523214">return</span><br>
<span class="lineno"></span><span class="op" id="4523221">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment" id="4523224">//&nbsp;startParse&nbsp;initializes&nbsp;the&nbsp;parser,&nbsp;using&nbsp;the&nbsp;lexer.</span><br>
<span class="lineno"></span><span class="keyword" id="4523279">func</span>&nbsp;<span class="op" id="4523284">(</span><span class="ident" id="4523285">t</span>&nbsp;<span class="op" id="4523287">*</span><span class="ident" id="4523288">Tree</span><span class="op" id="4523292">)</span>&nbsp;<span class="ident" id="4523294">startParse</span><span class="op" id="4523304">(</span><span class="ident" id="4523305">funcs</span>&nbsp;<span class="op" id="4523311">[</span><span class="op" id="4523312">]</span><span class="keyword" id="4523313">map</span><span class="op" id="4523316">[</span><span class="builtintype" id="4523317">string</span><span class="op" id="4523323">]</span><span class="keyword" id="4523324">interface</span><span class="op" id="4523333">{</span><span class="op" id="4523334">}</span><span class="op" id="4523335">,</span>&nbsp;<span class="ident" id="4523337">lex</span>&nbsp;<span class="op" id="4523341">*</span><span class="ident" id="4523342">lexer</span><span class="op" id="4523347">)</span>&nbsp;<span class="op" id="4523349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523352">t</span><span class="op" id="4523353">.</span><span class="ident" id="4523354">Root</span>&nbsp;<span class="op" id="4523359">=</span>&nbsp;<span class="ident" id="4523361">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523366">t</span><span class="op" id="4523367">.</span><span class="ident" id="4523368">lex</span>&nbsp;<span class="op" id="4523372">=</span>&nbsp;<span class="ident" id="4523374">lex</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523379">t</span><span class="op" id="4523380">.</span><span class="ident" id="4523381">vars</span>&nbsp;<span class="op" id="4523386">=</span>&nbsp;<span class="op" id="4523388">[</span><span class="op" id="4523389">]</span><span class="builtintype" id="4523390">string</span><span class="op" id="4523396">{</span><span class="string" id="4523397">&#34;$&#34;</span><span class="op" id="4523400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523403">t</span><span class="op" id="4523404">.</span><span class="ident" id="4523405">funcs</span>&nbsp;<span class="op" id="4523411">=</span>&nbsp;<span class="ident" id="4523413">funcs</span><br>
<span class="lineno"></span><span class="op" id="4523419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4523422">//&nbsp;stopParse&nbsp;terminates&nbsp;parsing.</span><br>
<span class="lineno">215</span><span class="keyword" id="4523455">func</span>&nbsp;<span class="op" id="4523460">(</span><span class="ident" id="4523461">t</span>&nbsp;<span class="op" id="4523463">*</span><span class="ident" id="4523464">Tree</span><span class="op" id="4523468">)</span>&nbsp;<span class="ident" id="4523470">stopParse</span><span class="op" id="4523479">(</span><span class="op" id="4523480">)</span>&nbsp;<span class="op" id="4523482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523485">t</span><span class="op" id="4523486">.</span><span class="ident" id="4523487">lex</span>&nbsp;<span class="op" id="4523491">=</span>&nbsp;<span class="ident" id="4523493">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523498">t</span><span class="op" id="4523499">.</span><span class="ident" id="4523500">vars</span>&nbsp;<span class="op" id="4523505">=</span>&nbsp;<span class="ident" id="4523507">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523512">t</span><span class="op" id="4523513">.</span><span class="ident" id="4523514">funcs</span>&nbsp;<span class="op" id="4523520">=</span>&nbsp;<span class="ident" id="4523522">nil</span><br>
<span class="lineno"></span><span class="op" id="4523526">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="4523529">//&nbsp;Parse&nbsp;parses&nbsp;the&nbsp;template&nbsp;definition&nbsp;string&nbsp;to&nbsp;construct&nbsp;a&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4523609">//&nbsp;the&nbsp;template&nbsp;for&nbsp;execution.&nbsp;If&nbsp;either&nbsp;action&nbsp;delimiter&nbsp;string&nbsp;is&nbsp;empty,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4523688">//&nbsp;default&nbsp;(&#34;{{&#34;&nbsp;or&nbsp;&#34;}}&#34;)&nbsp;is&nbsp;used.&nbsp;Embedded&nbsp;template&nbsp;definitions&nbsp;are&nbsp;added&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4523766">//&nbsp;the&nbsp;treeSet&nbsp;map.</span><br>
<span class="lineno">225</span><span class="keyword" id="4523786">func</span>&nbsp;<span class="op" id="4523791">(</span><span class="ident" id="4523792">t</span>&nbsp;<span class="op" id="4523794">*</span><span class="ident" id="4523795">Tree</span><span class="op" id="4523799">)</span>&nbsp;<span class="ident" id="4523801">Parse</span><span class="op" id="4523806">(</span><span class="ident" id="4523807">text</span><span class="op" id="4523811">,</span>&nbsp;<span class="ident" id="4523813">leftDelim</span><span class="op" id="4523822">,</span>&nbsp;<span class="ident" id="4523824">rightDelim</span>&nbsp;<span class="builtintype" id="4523835">string</span><span class="op" id="4523841">,</span>&nbsp;<span class="ident" id="4523843">treeSet</span>&nbsp;<span class="keyword" id="4523851">map</span><span class="op" id="4523854">[</span><span class="builtintype" id="4523855">string</span><span class="op" id="4523861">]</span><span class="op" id="4523862">*</span><span class="ident" id="4523863">Tree</span><span class="op" id="4523867">,</span>&nbsp;<span class="ident" id="4523869">funcs</span>&nbsp;<span class="op" id="4523875">...</span><span class="keyword" id="4523878">map</span><span class="op" id="4523881">[</span><span class="builtintype" id="4523882">string</span><span class="op" id="4523888">]</span><span class="keyword" id="4523889">interface</span><span class="op" id="4523898">{</span><span class="op" id="4523899">}</span><span class="op" id="4523900">)</span>&nbsp;<span class="op" id="4523902">(</span><span class="ident" id="4523903">tree</span>&nbsp;<span class="op" id="4523908">*</span><span class="ident" id="4523909">Tree</span><span class="op" id="4523913">,</span>&nbsp;<span class="ident" id="4523915">err</span>&nbsp;<span class="builtintype" id="4523919">error</span><span class="op" id="4523924">)</span>&nbsp;<span class="op" id="4523926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523929">defer</span>&nbsp;<span class="ident" id="4523935">t</span><span class="op" id="4523936">.</span><span class="builtinfunc" id="4523937">recover</span><span class="op" id="4523944">(</span><span class="op" id="4523945">&amp;</span><span class="ident" id="4523946">err</span><span class="op" id="4523949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523952">t</span><span class="op" id="4523953">.</span><span class="ident" id="4523954">ParseName</span>&nbsp;<span class="op" id="4523964">=</span>&nbsp;<span class="ident" id="4523966">t</span><span class="op" id="4523967">.</span><span class="ident" id="4523968">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523974">t</span><span class="op" id="4523975">.</span><span class="ident" id="4523976">startParse</span><span class="op" id="4523986">(</span><span class="ident" id="4523987">funcs</span><span class="op" id="4523992">,</span>&nbsp;<span class="ident" id="4523994">lex</span><span class="op" id="4523997">(</span><span class="ident" id="4523998">t</span><span class="op" id="4523999">.</span><span class="ident" id="4524000">Name</span><span class="op" id="4524004">,</span>&nbsp;<span class="ident" id="4524006">text</span><span class="op" id="4524010">,</span>&nbsp;<span class="ident" id="4524012">leftDelim</span><span class="op" id="4524021">,</span>&nbsp;<span class="ident" id="4524023">rightDelim</span><span class="op" id="4524033">)</span><span class="op" id="4524034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524037">t</span><span class="op" id="4524038">.</span><span class="ident" id="4524039">text</span>&nbsp;<span class="op" id="4524044">=</span>&nbsp;<span class="ident" id="4524046">text</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524052">t</span><span class="op" id="4524053">.</span><span class="ident" id="4524054">parse</span><span class="op" id="4524059">(</span><span class="ident" id="4524060">treeSet</span><span class="op" id="4524067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524070">t</span><span class="op" id="4524071">.</span><span class="ident" id="4524072">add</span><span class="op" id="4524075">(</span><span class="ident" id="4524076">treeSet</span><span class="op" id="4524083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524086">t</span><span class="op" id="4524087">.</span><span class="ident" id="4524088">stopParse</span><span class="op" id="4524097">(</span><span class="op" id="4524098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524101">return</span>&nbsp;<span class="ident" id="4524108">t</span><span class="op" id="4524109">,</span>&nbsp;<span class="ident" id="4524111">nil</span><br>
<span class="lineno"></span><span class="op" id="4524115">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="4524118">//&nbsp;add&nbsp;adds&nbsp;tree&nbsp;to&nbsp;the&nbsp;treeSet.</span><br>
<span class="lineno"></span><span class="keyword" id="4524151">func</span>&nbsp;<span class="op" id="4524156">(</span><span class="ident" id="4524157">t</span>&nbsp;<span class="op" id="4524159">*</span><span class="ident" id="4524160">Tree</span><span class="op" id="4524164">)</span>&nbsp;<span class="ident" id="4524166">add</span><span class="op" id="4524169">(</span><span class="ident" id="4524170">treeSet</span>&nbsp;<span class="keyword" id="4524178">map</span><span class="op" id="4524181">[</span><span class="builtintype" id="4524182">string</span><span class="op" id="4524188">]</span><span class="op" id="4524189">*</span><span class="ident" id="4524190">Tree</span><span class="op" id="4524194">)</span>&nbsp;<span class="op" id="4524196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524199">tree</span>&nbsp;<span class="op" id="4524204">:=</span>&nbsp;<span class="ident" id="4524207">treeSet</span><span class="op" id="4524214">[</span><span class="ident" id="4524215">t</span><span class="op" id="4524216">.</span><span class="ident" id="4524217">Name</span><span class="op" id="4524221">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524224">if</span>&nbsp;<span class="ident" id="4524227">tree</span>&nbsp;<span class="op" id="4524232">==</span>&nbsp;<span class="ident" id="4524235">nil</span>&nbsp;<span class="op" id="4524239">||</span>&nbsp;<span class="ident" id="4524242">IsEmptyTree</span><span class="op" id="4524253">(</span><span class="ident" id="4524254">tree</span><span class="op" id="4524258">.</span><span class="ident" id="4524259">Root</span><span class="op" id="4524263">)</span>&nbsp;<span class="op" id="4524265">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524269">treeSet</span><span class="op" id="4524276">[</span><span class="ident" id="4524277">t</span><span class="op" id="4524278">.</span><span class="ident" id="4524279">Name</span><span class="op" id="4524283">]</span>&nbsp;<span class="op" id="4524285">=</span>&nbsp;<span class="ident" id="4524287">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524291">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4524299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524302">if</span>&nbsp;<span class="op" id="4524305">!</span><span class="ident" id="4524306">IsEmptyTree</span><span class="op" id="4524317">(</span><span class="ident" id="4524318">t</span><span class="op" id="4524319">.</span><span class="ident" id="4524320">Root</span><span class="op" id="4524324">)</span>&nbsp;<span class="op" id="4524326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524330">t</span><span class="op" id="4524331">.</span><span class="ident" id="4524332">errorf</span><span class="op" id="4524338">(</span><span class="string" id="4524339">&#34;template:&nbsp;multiple&nbsp;definition&nbsp;of&nbsp;template&nbsp;%q&#34;</span><span class="op" id="4524385">,</span>&nbsp;<span class="ident" id="4524387">t</span><span class="op" id="4524388">.</span><span class="ident" id="4524389">Name</span><span class="op" id="4524393">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4524396">}</span><br>
<span class="lineno"></span><span class="op" id="4524398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4524401">//&nbsp;IsEmptyTree&nbsp;reports&nbsp;whether&nbsp;this&nbsp;tree&nbsp;(node)&nbsp;is&nbsp;empty&nbsp;of&nbsp;everything&nbsp;but&nbsp;space.</span><br>
<span class="lineno"></span><span class="keyword" id="4524483">func</span>&nbsp;<span class="ident" id="4524488">IsEmptyTree</span><span class="op" id="4524499">(</span><span class="ident" id="4524500">n</span>&nbsp;<span class="ident" id="4524502">Node</span><span class="op" id="4524506">)</span>&nbsp;<span class="builtintype" id="4524508">bool</span>&nbsp;<span class="op" id="4524513">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524516">switch</span>&nbsp;<span class="ident" id="4524523">n</span>&nbsp;<span class="op" id="4524525">:=</span>&nbsp;<span class="ident" id="4524528">n</span><span class="op" id="4524529">.</span><span class="op" id="4524530">(</span><span class="keyword" id="4524531">type</span><span class="op" id="4524535">)</span>&nbsp;<span class="op" id="4524537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524540">case</span>&nbsp;<span class="ident" id="4524545">nil</span><span class="op" id="4524548">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524552">return</span>&nbsp;<span class="ident" id="4524559">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524565">case</span>&nbsp;<span class="op" id="4524570">*</span><span class="ident" id="4524571">ActionNode</span><span class="op" id="4524581">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524584">case</span>&nbsp;<span class="op" id="4524589">*</span><span class="ident" id="4524590">IfNode</span><span class="op" id="4524596">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524599">case</span>&nbsp;<span class="op" id="4524604">*</span><span class="ident" id="4524605">ListNode</span><span class="op" id="4524613">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524617">for</span>&nbsp;<span class="ident" id="4524621">_</span><span class="op" id="4524622">,</span>&nbsp;<span class="ident" id="4524624">node</span>&nbsp;<span class="op" id="4524629">:=</span>&nbsp;<span class="keyword" id="4524632">range</span>&nbsp;<span class="ident" id="4524638">n</span><span class="op" id="4524639">.</span><span class="ident" id="4524640">Nodes</span>&nbsp;<span class="op" id="4524646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524651">if</span>&nbsp;<span class="op" id="4524654">!</span><span class="ident" id="4524655">IsEmptyTree</span><span class="op" id="4524666">(</span><span class="ident" id="4524667">node</span><span class="op" id="4524671">)</span>&nbsp;<span class="op" id="4524673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524679">return</span>&nbsp;<span class="ident" id="4524686">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4524695">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4524699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524703">return</span>&nbsp;<span class="ident" id="4524710">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524716">case</span>&nbsp;<span class="op" id="4524721">*</span><span class="ident" id="4524722">RangeNode</span><span class="op" id="4524731">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524734">case</span>&nbsp;<span class="op" id="4524739">*</span><span class="ident" id="4524740">TemplateNode</span><span class="op" id="4524752">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524755">case</span>&nbsp;<span class="op" id="4524760">*</span><span class="ident" id="4524761">TextNode</span><span class="op" id="4524769">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524773">return</span>&nbsp;<span class="builtinfunc" id="4524780">len</span><span class="op" id="4524783">(</span><span class="ident" id="4524784">bytes</span><span class="op" id="4524789">.</span><span class="ident" id="4524790">TrimSpace</span><span class="op" id="4524799">(</span><span class="ident" id="4524800">n</span><span class="op" id="4524801">.</span><span class="ident" id="4524802">Text</span><span class="op" id="4524806">)</span><span class="op" id="4524807">)</span>&nbsp;<span class="op" id="4524809">==</span>&nbsp;<span class="num" id="4524812">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524815">case</span>&nbsp;<span class="op" id="4524820">*</span><span class="ident" id="4524821">WithNode</span><span class="op" id="4524829">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524832">default</span><span class="op" id="4524839">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4524843">panic</span><span class="op" id="4524848">(</span><span class="string" id="4524849">&#34;unknown&nbsp;node:&nbsp;&#34;</span>&nbsp;<span class="op" id="4524866">+</span>&nbsp;<span class="ident" id="4524868">n</span><span class="op" id="4524869">.</span><span class="ident" id="4524870">String</span><span class="op" id="4524876">(</span><span class="op" id="4524877">)</span><span class="op" id="4524878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4524881">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524884">return</span>&nbsp;<span class="ident" id="4524891">false</span><br>
<span class="lineno"></span><span class="op" id="4524897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4524900">//&nbsp;parse&nbsp;is&nbsp;the&nbsp;top-level&nbsp;parser&nbsp;for&nbsp;a&nbsp;template,&nbsp;essentially&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="4524970">//&nbsp;as&nbsp;itemList&nbsp;except&nbsp;it&nbsp;also&nbsp;parses&nbsp;{{define}}&nbsp;actions.</span><br>
<span class="lineno">275</span><span class="comment" id="4525027">//&nbsp;It&nbsp;runs&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="4525046">func</span>&nbsp;<span class="op" id="4525051">(</span><span class="ident" id="4525052">t</span>&nbsp;<span class="op" id="4525054">*</span><span class="ident" id="4525055">Tree</span><span class="op" id="4525059">)</span>&nbsp;<span class="ident" id="4525061">parse</span><span class="op" id="4525066">(</span><span class="ident" id="4525067">treeSet</span>&nbsp;<span class="keyword" id="4525075">map</span><span class="op" id="4525078">[</span><span class="builtintype" id="4525079">string</span><span class="op" id="4525085">]</span><span class="op" id="4525086">*</span><span class="ident" id="4525087">Tree</span><span class="op" id="4525091">)</span>&nbsp;<span class="op" id="4525093">(</span><span class="ident" id="4525094">next</span>&nbsp;<span class="ident" id="4525099">Node</span><span class="op" id="4525103">)</span>&nbsp;<span class="op" id="4525105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525108">t</span><span class="op" id="4525109">.</span><span class="ident" id="4525110">Root</span>&nbsp;<span class="op" id="4525115">=</span>&nbsp;<span class="ident" id="4525117">t</span><span class="op" id="4525118">.</span><span class="ident" id="4525119">newList</span><span class="op" id="4525126">(</span><span class="ident" id="4525127">t</span><span class="op" id="4525128">.</span><span class="ident" id="4525129">peek</span><span class="op" id="4525133">(</span><span class="op" id="4525134">)</span><span class="op" id="4525135">.</span><span class="ident" id="4525136">pos</span><span class="op" id="4525139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525142">for</span>&nbsp;<span class="ident" id="4525146">t</span><span class="op" id="4525147">.</span><span class="ident" id="4525148">peek</span><span class="op" id="4525152">(</span><span class="op" id="4525153">)</span><span class="op" id="4525154">.</span><span class="ident" id="4525155">typ</span>&nbsp;<span class="op" id="4525159">!=</span>&nbsp;<span class="ident" id="4525162">itemEOF</span>&nbsp;<span class="op" id="4525170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525174">if</span>&nbsp;<span class="ident" id="4525177">t</span><span class="op" id="4525178">.</span><span class="ident" id="4525179">peek</span><span class="op" id="4525183">(</span><span class="op" id="4525184">)</span><span class="op" id="4525185">.</span><span class="ident" id="4525186">typ</span>&nbsp;<span class="op" id="4525190">==</span>&nbsp;<span class="ident" id="4525193">itemLeftDelim</span>&nbsp;<span class="op" id="4525207">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525212">delim</span>&nbsp;<span class="op" id="4525218">:=</span>&nbsp;<span class="ident" id="4525221">t</span><span class="op" id="4525222">.</span><span class="ident" id="4525223">next</span><span class="op" id="4525227">(</span><span class="op" id="4525228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525233">if</span>&nbsp;<span class="ident" id="4525236">t</span><span class="op" id="4525237">.</span><span class="ident" id="4525238">nextNonSpace</span><span class="op" id="4525250">(</span><span class="op" id="4525251">)</span><span class="op" id="4525252">.</span><span class="ident" id="4525253">typ</span>&nbsp;<span class="op" id="4525257">==</span>&nbsp;<span class="ident" id="4525260">itemDefine</span>&nbsp;<span class="op" id="4525271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525277">newT</span>&nbsp;<span class="op" id="4525282">:=</span>&nbsp;<span class="ident" id="4525285">New</span><span class="op" id="4525288">(</span><span class="string" id="4525289">&#34;definition&#34;</span><span class="op" id="4525301">)</span>&nbsp;<span class="comment" id="4525303">//&nbsp;name&nbsp;will&nbsp;be&nbsp;updated&nbsp;once&nbsp;we&nbsp;know&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525348">newT</span><span class="op" id="4525352">.</span><span class="ident" id="4525353">text</span>&nbsp;<span class="op" id="4525358">=</span>&nbsp;<span class="ident" id="4525360">t</span><span class="op" id="4525361">.</span><span class="ident" id="4525362">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525371">newT</span><span class="op" id="4525375">.</span><span class="ident" id="4525376">ParseName</span>&nbsp;<span class="op" id="4525386">=</span>&nbsp;<span class="ident" id="4525388">t</span><span class="op" id="4525389">.</span><span class="ident" id="4525390">ParseName</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525404">newT</span><span class="op" id="4525408">.</span><span class="ident" id="4525409">startParse</span><span class="op" id="4525419">(</span><span class="ident" id="4525420">t</span><span class="op" id="4525421">.</span><span class="ident" id="4525422">funcs</span><span class="op" id="4525427">,</span>&nbsp;<span class="ident" id="4525429">t</span><span class="op" id="4525430">.</span><span class="ident" id="4525431">lex</span><span class="op" id="4525434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525440">newT</span><span class="op" id="4525444">.</span><span class="ident" id="4525445">parseDefinition</span><span class="op" id="4525460">(</span><span class="ident" id="4525461">treeSet</span><span class="op" id="4525468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525474">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4525486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525491">t</span><span class="op" id="4525492">.</span><span class="ident" id="4525493">backup2</span><span class="op" id="4525500">(</span><span class="ident" id="4525501">delim</span><span class="op" id="4525506">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4525510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525514">n</span>&nbsp;<span class="op" id="4525516">:=</span>&nbsp;<span class="ident" id="4525519">t</span><span class="op" id="4525520">.</span><span class="ident" id="4525521">textOrAction</span><span class="op" id="4525533">(</span><span class="op" id="4525534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525538">if</span>&nbsp;<span class="ident" id="4525541">n</span><span class="op" id="4525542">.</span><span class="ident" id="4525543">Type</span><span class="op" id="4525547">(</span><span class="op" id="4525548">)</span>&nbsp;<span class="op" id="4525550">==</span>&nbsp;<span class="ident" id="4525553">nodeEnd</span>&nbsp;<span class="op" id="4525561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525566">t</span><span class="op" id="4525567">.</span><span class="ident" id="4525568">errorf</span><span class="op" id="4525574">(</span><span class="string" id="4525575">&#34;unexpected&nbsp;%s&#34;</span><span class="op" id="4525590">,</span>&nbsp;<span class="ident" id="4525592">n</span><span class="op" id="4525593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4525597">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525601">t</span><span class="op" id="4525602">.</span><span class="ident" id="4525603">Root</span><span class="op" id="4525607">.</span><span class="builtinfunc" id="4525608">append</span><span class="op" id="4525614">(</span><span class="ident" id="4525615">n</span><span class="op" id="4525616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4525619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525622">return</span>&nbsp;<span class="ident" id="4525629">nil</span><br>
<span class="lineno"></span><span class="op" id="4525633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="4525636">//&nbsp;parseDefinition&nbsp;parses&nbsp;a&nbsp;{{define}}&nbsp;...&nbsp;&nbsp;{{end}}&nbsp;template&nbsp;definition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4525712">//&nbsp;installs&nbsp;the&nbsp;definition&nbsp;in&nbsp;the&nbsp;treeSet&nbsp;map.&nbsp;&nbsp;The&nbsp;&#34;define&#34;&nbsp;keyword&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="4525793">//&nbsp;been&nbsp;scanned.</span><br>
<span class="lineno"></span><span class="keyword" id="4525810">func</span>&nbsp;<span class="op" id="4525815">(</span><span class="ident" id="4525816">t</span>&nbsp;<span class="op" id="4525818">*</span><span class="ident" id="4525819">Tree</span><span class="op" id="4525823">)</span>&nbsp;<span class="ident" id="4525825">parseDefinition</span><span class="op" id="4525840">(</span><span class="ident" id="4525841">treeSet</span>&nbsp;<span class="keyword" id="4525849">map</span><span class="op" id="4525852">[</span><span class="builtintype" id="4525853">string</span><span class="op" id="4525859">]</span><span class="op" id="4525860">*</span><span class="ident" id="4525861">Tree</span><span class="op" id="4525865">)</span>&nbsp;<span class="op" id="4525867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525870">const</span>&nbsp;<span class="ident" id="4525876">context</span>&nbsp;<span class="op" id="4525884">=</span>&nbsp;<span class="string" id="4525886">&#34;define&nbsp;clause&#34;</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525903">name</span>&nbsp;<span class="op" id="4525908">:=</span>&nbsp;<span class="ident" id="4525911">t</span><span class="op" id="4525912">.</span><span class="ident" id="4525913">expectOneOf</span><span class="op" id="4525924">(</span><span class="ident" id="4525925">itemString</span><span class="op" id="4525935">,</span>&nbsp;<span class="ident" id="4525937">itemRawString</span><span class="op" id="4525950">,</span>&nbsp;<span class="ident" id="4525952">context</span><span class="op" id="4525959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525962">var</span>&nbsp;<span class="ident" id="4525966">err</span>&nbsp;<span class="builtintype" id="4525970">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525977">t</span><span class="op" id="4525978">.</span><span class="ident" id="4525979">Name</span><span class="op" id="4525983">,</span>&nbsp;<span class="ident" id="4525985">err</span>&nbsp;<span class="op" id="4525989">=</span>&nbsp;<span class="ident" id="4525991">strconv</span><span class="op" id="4525998">.</span><span class="ident" id="4525999">Unquote</span><span class="op" id="4526006">(</span><span class="ident" id="4526007">name</span><span class="op" id="4526011">.</span><span class="ident" id="4526012">val</span><span class="op" id="4526015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526018">if</span>&nbsp;<span class="ident" id="4526021">err</span>&nbsp;<span class="op" id="4526025">!=</span>&nbsp;<span class="ident" id="4526028">nil</span>&nbsp;<span class="op" id="4526032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526036">t</span><span class="op" id="4526037">.</span><span class="builtintype" id="4526038">error</span><span class="op" id="4526043">(</span><span class="ident" id="4526044">err</span><span class="op" id="4526047">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4526050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526053">t</span><span class="op" id="4526054">.</span><span class="ident" id="4526055">expect</span><span class="op" id="4526061">(</span><span class="ident" id="4526062">itemRightDelim</span><span class="op" id="4526076">,</span>&nbsp;<span class="ident" id="4526078">context</span><span class="op" id="4526085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526088">var</span>&nbsp;<span class="ident" id="4526092">end</span>&nbsp;<span class="ident" id="4526096">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526102">t</span><span class="op" id="4526103">.</span><span class="ident" id="4526104">Root</span><span class="op" id="4526108">,</span>&nbsp;<span class="ident" id="4526110">end</span>&nbsp;<span class="op" id="4526114">=</span>&nbsp;<span class="ident" id="4526116">t</span><span class="op" id="4526117">.</span><span class="ident" id="4526118">itemList</span><span class="op" id="4526126">(</span><span class="op" id="4526127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526130">if</span>&nbsp;<span class="ident" id="4526133">end</span><span class="op" id="4526136">.</span><span class="ident" id="4526137">Type</span><span class="op" id="4526141">(</span><span class="op" id="4526142">)</span>&nbsp;<span class="op" id="4526144">!=</span>&nbsp;<span class="ident" id="4526147">nodeEnd</span>&nbsp;<span class="op" id="4526155">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526159">t</span><span class="op" id="4526160">.</span><span class="ident" id="4526161">errorf</span><span class="op" id="4526167">(</span><span class="string" id="4526168">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="4526189">,</span>&nbsp;<span class="ident" id="4526191">end</span><span class="op" id="4526194">,</span>&nbsp;<span class="ident" id="4526196">context</span><span class="op" id="4526203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4526206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526209">t</span><span class="op" id="4526210">.</span><span class="ident" id="4526211">add</span><span class="op" id="4526214">(</span><span class="ident" id="4526215">treeSet</span><span class="op" id="4526222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526225">t</span><span class="op" id="4526226">.</span><span class="ident" id="4526227">stopParse</span><span class="op" id="4526236">(</span><span class="op" id="4526237">)</span><br>
<span class="lineno"></span><span class="op" id="4526239">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span><span class="comment" id="4526242">//&nbsp;itemList:</span><br>
<span class="lineno"></span><span class="comment" id="4526255">//&nbsp;&nbsp;&nbsp;&nbsptextOrAction*</span><br>
<span class="lineno"></span><span class="comment" id="4526272">//&nbsp;Terminates&nbsp;at&nbsp;{{end}}&nbsp;or&nbsp;{{else}},&nbsp;returned&nbsp;separately.</span><br>
<span class="lineno"></span><span class="keyword" id="4526331">func</span>&nbsp;<span class="op" id="4526336">(</span><span class="ident" id="4526337">t</span>&nbsp;<span class="op" id="4526339">*</span><span class="ident" id="4526340">Tree</span><span class="op" id="4526344">)</span>&nbsp;<span class="ident" id="4526346">itemList</span><span class="op" id="4526354">(</span><span class="op" id="4526355">)</span>&nbsp;<span class="op" id="4526357">(</span><span class="ident" id="4526358">list</span>&nbsp;<span class="op" id="4526363">*</span><span class="ident" id="4526364">ListNode</span><span class="op" id="4526372">,</span>&nbsp;<span class="ident" id="4526374">next</span>&nbsp;<span class="ident" id="4526379">Node</span><span class="op" id="4526383">)</span>&nbsp;<span class="op" id="4526385">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526388">list</span>&nbsp;<span class="op" id="4526393">=</span>&nbsp;<span class="ident" id="4526395">t</span><span class="op" id="4526396">.</span><span class="ident" id="4526397">newList</span><span class="op" id="4526404">(</span><span class="ident" id="4526405">t</span><span class="op" id="4526406">.</span><span class="ident" id="4526407">peekNonSpace</span><span class="op" id="4526419">(</span><span class="op" id="4526420">)</span><span class="op" id="4526421">.</span><span class="ident" id="4526422">pos</span><span class="op" id="4526425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526428">for</span>&nbsp;<span class="ident" id="4526432">t</span><span class="op" id="4526433">.</span><span class="ident" id="4526434">peekNonSpace</span><span class="op" id="4526446">(</span><span class="op" id="4526447">)</span><span class="op" id="4526448">.</span><span class="ident" id="4526449">typ</span>&nbsp;<span class="op" id="4526453">!=</span>&nbsp;<span class="ident" id="4526456">itemEOF</span>&nbsp;<span class="op" id="4526464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526468">n</span>&nbsp;<span class="op" id="4526470">:=</span>&nbsp;<span class="ident" id="4526473">t</span><span class="op" id="4526474">.</span><span class="ident" id="4526475">textOrAction</span><span class="op" id="4526487">(</span><span class="op" id="4526488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526492">switch</span>&nbsp;<span class="ident" id="4526499">n</span><span class="op" id="4526500">.</span><span class="ident" id="4526501">Type</span><span class="op" id="4526505">(</span><span class="op" id="4526506">)</span>&nbsp;<span class="op" id="4526508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526512">case</span>&nbsp;<span class="ident" id="4526517">nodeEnd</span><span class="op" id="4526524">,</span>&nbsp;<span class="ident" id="4526526">nodeElse</span><span class="op" id="4526534">:</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526539">return</span>&nbsp;<span class="ident" id="4526546">list</span><span class="op" id="4526550">,</span>&nbsp;<span class="ident" id="4526552">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4526556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526560">list</span><span class="op" id="4526564">.</span><span class="builtinfunc" id="4526565">append</span><span class="op" id="4526571">(</span><span class="ident" id="4526572">n</span><span class="op" id="4526573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4526576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526579">t</span><span class="op" id="4526580">.</span><span class="ident" id="4526581">errorf</span><span class="op" id="4526587">(</span><span class="string" id="4526588">&#34;unexpected&nbsp;EOF&#34;</span><span class="op" id="4526604">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526607">return</span><br>
<span class="lineno"></span><span class="op" id="4526614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4526617">//&nbsp;textOrAction:</span><br>
<span class="lineno"></span><span class="comment" id="4526634">//&nbsp;&nbsp;&nbsp;&nbsptext&nbsp;|&nbsp;action</span><br>
<span class="lineno">340</span><span class="keyword" id="4526651">func</span>&nbsp;<span class="op" id="4526656">(</span><span class="ident" id="4526657">t</span>&nbsp;<span class="op" id="4526659">*</span><span class="ident" id="4526660">Tree</span><span class="op" id="4526664">)</span>&nbsp;<span class="ident" id="4526666">textOrAction</span><span class="op" id="4526678">(</span><span class="op" id="4526679">)</span>&nbsp;<span class="ident" id="4526681">Node</span>&nbsp;<span class="op" id="4526686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526689">switch</span>&nbsp;<span class="ident" id="4526696">token</span>&nbsp;<span class="op" id="4526702">:=</span>&nbsp;<span class="ident" id="4526705">t</span><span class="op" id="4526706">.</span><span class="ident" id="4526707">nextNonSpace</span><span class="op" id="4526719">(</span><span class="op" id="4526720">)</span><span class="op" id="4526721">;</span>&nbsp;<span class="ident" id="4526723">token</span><span class="op" id="4526728">.</span><span class="ident" id="4526729">typ</span>&nbsp;<span class="op" id="4526733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526736">case</span>&nbsp;<span class="ident" id="4526741">itemText</span><span class="op" id="4526749">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526753">return</span>&nbsp;<span class="ident" id="4526760">t</span><span class="op" id="4526761">.</span><span class="ident" id="4526762">newText</span><span class="op" id="4526769">(</span><span class="ident" id="4526770">token</span><span class="op" id="4526775">.</span><span class="ident" id="4526776">pos</span><span class="op" id="4526779">,</span>&nbsp;<span class="ident" id="4526781">token</span><span class="op" id="4526786">.</span><span class="ident" id="4526787">val</span><span class="op" id="4526790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526793">case</span>&nbsp;<span class="ident" id="4526798">itemLeftDelim</span><span class="op" id="4526811">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526815">return</span>&nbsp;<span class="ident" id="4526822">t</span><span class="op" id="4526823">.</span><span class="ident" id="4526824">action</span><span class="op" id="4526830">(</span><span class="op" id="4526831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526834">default</span><span class="op" id="4526841">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526845">t</span><span class="op" id="4526846">.</span><span class="ident" id="4526847">unexpected</span><span class="op" id="4526857">(</span><span class="ident" id="4526858">token</span><span class="op" id="4526863">,</span>&nbsp;<span class="string" id="4526865">&#34;input&#34;</span><span class="op" id="4526872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4526875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526878">return</span>&nbsp;<span class="ident" id="4526885">nil</span><br>
<span class="lineno">350</span><span class="op" id="4526889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4526892">//&nbsp;Action:</span><br>
<span class="lineno"></span><span class="comment" id="4526903">//&nbsp;&nbsp;&nbsp;&nbspcontrol</span><br>
<span class="lineno"></span><span class="comment" id="4526914">//&nbsp;&nbsp;&nbsp;&nbspcommand&nbsp;(&#34;|&#34;&nbsp;command)*</span><br>
<span class="lineno">355</span><span class="comment" id="4526940">//&nbsp;Left&nbsp;delim&nbsp;is&nbsp;past.&nbsp;Now&nbsp;get&nbsp;actions.</span><br>
<span class="lineno"></span><span class="comment" id="4526980">//&nbsp;First&nbsp;word&nbsp;could&nbsp;be&nbsp;a&nbsp;keyword&nbsp;such&nbsp;as&nbsp;range.</span><br>
<span class="lineno"></span><span class="keyword" id="4527028">func</span>&nbsp;<span class="op" id="4527033">(</span><span class="ident" id="4527034">t</span>&nbsp;<span class="op" id="4527036">*</span><span class="ident" id="4527037">Tree</span><span class="op" id="4527041">)</span>&nbsp;<span class="ident" id="4527043">action</span><span class="op" id="4527049">(</span><span class="op" id="4527050">)</span>&nbsp;<span class="op" id="4527052">(</span><span class="ident" id="4527053">n</span>&nbsp;<span class="ident" id="4527055">Node</span><span class="op" id="4527059">)</span>&nbsp;<span class="op" id="4527061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527064">switch</span>&nbsp;<span class="ident" id="4527071">token</span>&nbsp;<span class="op" id="4527077">:=</span>&nbsp;<span class="ident" id="4527080">t</span><span class="op" id="4527081">.</span><span class="ident" id="4527082">nextNonSpace</span><span class="op" id="4527094">(</span><span class="op" id="4527095">)</span><span class="op" id="4527096">;</span>&nbsp;<span class="ident" id="4527098">token</span><span class="op" id="4527103">.</span><span class="ident" id="4527104">typ</span>&nbsp;<span class="op" id="4527108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527111">case</span>&nbsp;<span class="ident" id="4527116">itemElse</span><span class="op" id="4527124">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527128">return</span>&nbsp;<span class="ident" id="4527135">t</span><span class="op" id="4527136">.</span><span class="ident" id="4527137">elseControl</span><span class="op" id="4527148">(</span><span class="op" id="4527149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527152">case</span>&nbsp;<span class="ident" id="4527157">itemEnd</span><span class="op" id="4527164">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527168">return</span>&nbsp;<span class="ident" id="4527175">t</span><span class="op" id="4527176">.</span><span class="ident" id="4527177">endControl</span><span class="op" id="4527187">(</span><span class="op" id="4527188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527191">case</span>&nbsp;<span class="ident" id="4527196">itemIf</span><span class="op" id="4527202">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527206">return</span>&nbsp;<span class="ident" id="4527213">t</span><span class="op" id="4527214">.</span><span class="ident" id="4527215">ifControl</span><span class="op" id="4527224">(</span><span class="op" id="4527225">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527228">case</span>&nbsp;<span class="ident" id="4527233">itemRange</span><span class="op" id="4527242">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527246">return</span>&nbsp;<span class="ident" id="4527253">t</span><span class="op" id="4527254">.</span><span class="ident" id="4527255">rangeControl</span><span class="op" id="4527267">(</span><span class="op" id="4527268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527271">case</span>&nbsp;<span class="ident" id="4527276">itemTemplate</span><span class="op" id="4527288">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527292">return</span>&nbsp;<span class="ident" id="4527299">t</span><span class="op" id="4527300">.</span><span class="ident" id="4527301">templateControl</span><span class="op" id="4527316">(</span><span class="op" id="4527317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527320">case</span>&nbsp;<span class="ident" id="4527325">itemWith</span><span class="op" id="4527333">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527337">return</span>&nbsp;<span class="ident" id="4527344">t</span><span class="op" id="4527345">.</span><span class="ident" id="4527346">withControl</span><span class="op" id="4527357">(</span><span class="op" id="4527358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4527361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527364">t</span><span class="op" id="4527365">.</span><span class="ident" id="4527366">backup</span><span class="op" id="4527372">(</span><span class="op" id="4527373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4527376">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527428">return</span>&nbsp;<span class="ident" id="4527435">t</span><span class="op" id="4527436">.</span><span class="ident" id="4527437">newAction</span><span class="op" id="4527446">(</span><span class="ident" id="4527447">t</span><span class="op" id="4527448">.</span><span class="ident" id="4527449">peek</span><span class="op" id="4527453">(</span><span class="op" id="4527454">)</span><span class="op" id="4527455">.</span><span class="ident" id="4527456">pos</span><span class="op" id="4527459">,</span>&nbsp;<span class="ident" id="4527461">t</span><span class="op" id="4527462">.</span><span class="ident" id="4527463">lex</span><span class="op" id="4527466">.</span><span class="ident" id="4527467">lineNumber</span><span class="op" id="4527477">(</span><span class="op" id="4527478">)</span><span class="op" id="4527479">,</span>&nbsp;<span class="ident" id="4527481">t</span><span class="op" id="4527482">.</span><span class="ident" id="4527483">pipeline</span><span class="op" id="4527491">(</span><span class="string" id="4527492">&#34;command&#34;</span><span class="op" id="4527501">)</span><span class="op" id="4527502">)</span><br>
<span class="lineno">375</span><span class="op" id="4527504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4527507">//&nbsp;Pipeline:</span><br>
<span class="lineno"></span><span class="comment" id="4527520">//&nbsp;&nbsp;&nbsp;&nbspdeclarations?&nbsp;command&nbsp;(&#39;|&#39;&nbsp;command)*</span><br>
<span class="lineno"></span><span class="keyword" id="4527560">func</span>&nbsp;<span class="op" id="4527565">(</span><span class="ident" id="4527566">t</span>&nbsp;<span class="op" id="4527568">*</span><span class="ident" id="4527569">Tree</span><span class="op" id="4527573">)</span>&nbsp;<span class="ident" id="4527575">pipeline</span><span class="op" id="4527583">(</span><span class="ident" id="4527584">context</span>&nbsp;<span class="builtintype" id="4527592">string</span><span class="op" id="4527598">)</span>&nbsp;<span class="op" id="4527600">(</span><span class="ident" id="4527601">pipe</span>&nbsp;<span class="op" id="4527606">*</span><span class="ident" id="4527607">PipeNode</span><span class="op" id="4527615">)</span>&nbsp;<span class="op" id="4527617">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527620">var</span>&nbsp;<span class="ident" id="4527624">decl</span>&nbsp;<span class="op" id="4527629">[</span><span class="op" id="4527630">]</span><span class="op" id="4527631">*</span><span class="ident" id="4527632">VariableNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527646">pos</span>&nbsp;<span class="op" id="4527650">:=</span>&nbsp;<span class="ident" id="4527653">t</span><span class="op" id="4527654">.</span><span class="ident" id="4527655">peekNonSpace</span><span class="op" id="4527667">(</span><span class="op" id="4527668">)</span><span class="op" id="4527669">.</span><span class="ident" id="4527670">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4527675">//&nbsp;Are&nbsp;there&nbsp;declarations?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527703">for</span>&nbsp;<span class="op" id="4527707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527711">if</span>&nbsp;<span class="ident" id="4527714">v</span>&nbsp;<span class="op" id="4527716">:=</span>&nbsp;<span class="ident" id="4527719">t</span><span class="op" id="4527720">.</span><span class="ident" id="4527721">peekNonSpace</span><span class="op" id="4527733">(</span><span class="op" id="4527734">)</span><span class="op" id="4527735">;</span>&nbsp;<span class="ident" id="4527737">v</span><span class="op" id="4527738">.</span><span class="ident" id="4527739">typ</span>&nbsp;<span class="op" id="4527743">==</span>&nbsp;<span class="ident" id="4527746">itemVariable</span>&nbsp;<span class="op" id="4527759">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527764">t</span><span class="op" id="4527765">.</span><span class="ident" id="4527766">next</span><span class="op" id="4527770">(</span><span class="op" id="4527771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4527776">//&nbsp;Since&nbsp;space&nbsp;is&nbsp;a&nbsp;token,&nbsp;we&nbsp;need&nbsp;3-token&nbsp;look-ahead&nbsp;here&nbsp;in&nbsp;the&nbsp;worst&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4527857">//&nbsp;in&nbsp;&#34;$x&nbsp;foo&#34;&nbsp;we&nbsp;need&nbsp;to&nbsp;read&nbsp;&#34;foo&#34;&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;&#34;:=&#34;)&nbsp;to&nbsp;know&nbsp;that&nbsp;$x&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4527940">//&nbsp;argument&nbsp;variable&nbsp;rather&nbsp;than&nbsp;a&nbsp;declaration.&nbsp;So&nbsp;remember&nbsp;the&nbsp;token</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4528013">//&nbsp;adjacent&nbsp;to&nbsp;the&nbsp;variable&nbsp;so&nbsp;we&nbsp;can&nbsp;push&nbsp;it&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528081">tokenAfterVariable</span>&nbsp;<span class="op" id="4528100">:=</span>&nbsp;<span class="ident" id="4528103">t</span><span class="op" id="4528104">.</span><span class="ident" id="4528105">peek</span><span class="op" id="4528109">(</span><span class="op" id="4528110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528115">if</span>&nbsp;<span class="ident" id="4528118">next</span>&nbsp;<span class="op" id="4528123">:=</span>&nbsp;<span class="ident" id="4528126">t</span><span class="op" id="4528127">.</span><span class="ident" id="4528128">peekNonSpace</span><span class="op" id="4528140">(</span><span class="op" id="4528141">)</span><span class="op" id="4528142">;</span>&nbsp;<span class="ident" id="4528144">next</span><span class="op" id="4528148">.</span><span class="ident" id="4528149">typ</span>&nbsp;<span class="op" id="4528153">==</span>&nbsp;<span class="ident" id="4528156">itemColonEquals</span>&nbsp;<span class="op" id="4528172">||</span>&nbsp;<span class="op" id="4528175">(</span><span class="ident" id="4528176">next</span><span class="op" id="4528180">.</span><span class="ident" id="4528181">typ</span>&nbsp;<span class="op" id="4528185">==</span>&nbsp;<span class="ident" id="4528188">itemChar</span>&nbsp;<span class="op" id="4528197">&amp;&amp;</span>&nbsp;<span class="ident" id="4528200">next</span><span class="op" id="4528204">.</span><span class="ident" id="4528205">val</span>&nbsp;<span class="op" id="4528209">==</span>&nbsp;<span class="string" id="4528212">&#34;,&#34;</span><span class="op" id="4528215">)</span>&nbsp;<span class="op" id="4528217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528223">t</span><span class="op" id="4528224">.</span><span class="ident" id="4528225">nextNonSpace</span><span class="op" id="4528237">(</span><span class="op" id="4528238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528244">variable</span>&nbsp;<span class="op" id="4528253">:=</span>&nbsp;<span class="ident" id="4528256">t</span><span class="op" id="4528257">.</span><span class="ident" id="4528258">newVariable</span><span class="op" id="4528269">(</span><span class="ident" id="4528270">v</span><span class="op" id="4528271">.</span><span class="ident" id="4528272">pos</span><span class="op" id="4528275">,</span>&nbsp;<span class="ident" id="4528277">v</span><span class="op" id="4528278">.</span><span class="ident" id="4528279">val</span><span class="op" id="4528282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528288">decl</span>&nbsp;<span class="op" id="4528293">=</span>&nbsp;<span class="builtinfunc" id="4528295">append</span><span class="op" id="4528301">(</span><span class="ident" id="4528302">decl</span><span class="op" id="4528306">,</span>&nbsp;<span class="ident" id="4528308">variable</span><span class="op" id="4528316">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528322">t</span><span class="op" id="4528323">.</span><span class="ident" id="4528324">vars</span>&nbsp;<span class="op" id="4528329">=</span>&nbsp;<span class="builtinfunc" id="4528331">append</span><span class="op" id="4528337">(</span><span class="ident" id="4528338">t</span><span class="op" id="4528339">.</span><span class="ident" id="4528340">vars</span><span class="op" id="4528344">,</span>&nbsp;<span class="ident" id="4528346">v</span><span class="op" id="4528347">.</span><span class="ident" id="4528348">val</span><span class="op" id="4528351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528357">if</span>&nbsp;<span class="ident" id="4528360">next</span><span class="op" id="4528364">.</span><span class="ident" id="4528365">typ</span>&nbsp;<span class="op" id="4528369">==</span>&nbsp;<span class="ident" id="4528372">itemChar</span>&nbsp;<span class="op" id="4528381">&amp;&amp;</span>&nbsp;<span class="ident" id="4528384">next</span><span class="op" id="4528388">.</span><span class="ident" id="4528389">val</span>&nbsp;<span class="op" id="4528393">==</span>&nbsp;<span class="string" id="4528396">&#34;,&#34;</span>&nbsp;<span class="op" id="4528400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528407">if</span>&nbsp;<span class="ident" id="4528410">context</span>&nbsp;<span class="op" id="4528418">==</span>&nbsp;<span class="string" id="4528421">&#34;range&#34;</span>&nbsp;<span class="op" id="4528429">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4528432">len</span><span class="op" id="4528435">(</span><span class="ident" id="4528436">decl</span><span class="op" id="4528440">)</span>&nbsp;<span class="op" id="4528442">&lt;</span>&nbsp;<span class="num" id="4528444">2</span>&nbsp;<span class="op" id="4528446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528454">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4528468">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528475">t</span><span class="op" id="4528476">.</span><span class="ident" id="4528477">errorf</span><span class="op" id="4528483">(</span><span class="string" id="4528484">&#34;too&nbsp;many&nbsp;declarations&nbsp;in&nbsp;%s&#34;</span><span class="op" id="4528513">,</span>&nbsp;<span class="ident" id="4528515">context</span><span class="op" id="4528522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4528528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4528533">}</span>&nbsp;<span class="keyword" id="4528535">else</span>&nbsp;<span class="keyword" id="4528540">if</span>&nbsp;<span class="ident" id="4528543">tokenAfterVariable</span><span class="op" id="4528561">.</span><span class="ident" id="4528562">typ</span>&nbsp;<span class="op" id="4528566">==</span>&nbsp;<span class="ident" id="4528569">itemSpace</span>&nbsp;<span class="op" id="4528579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528585">t</span><span class="op" id="4528586">.</span><span class="ident" id="4528587">backup3</span><span class="op" id="4528594">(</span><span class="ident" id="4528595">v</span><span class="op" id="4528596">,</span>&nbsp;<span class="ident" id="4528598">tokenAfterVariable</span><span class="op" id="4528616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4528621">}</span>&nbsp;<span class="keyword" id="4528623">else</span>&nbsp;<span class="op" id="4528628">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528634">t</span><span class="op" id="4528635">.</span><span class="ident" id="4528636">backup2</span><span class="op" id="4528643">(</span><span class="ident" id="4528644">v</span><span class="op" id="4528645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4528650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4528654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528658">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4528665">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528668">pipe</span>&nbsp;<span class="op" id="4528673">=</span>&nbsp;<span class="ident" id="4528675">t</span><span class="op" id="4528676">.</span><span class="ident" id="4528677">newPipeline</span><span class="op" id="4528688">(</span><span class="ident" id="4528689">pos</span><span class="op" id="4528692">,</span>&nbsp;<span class="ident" id="4528694">t</span><span class="op" id="4528695">.</span><span class="ident" id="4528696">lex</span><span class="op" id="4528699">.</span><span class="ident" id="4528700">lineNumber</span><span class="op" id="4528710">(</span><span class="op" id="4528711">)</span><span class="op" id="4528712">,</span>&nbsp;<span class="ident" id="4528714">decl</span><span class="op" id="4528718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528721">for</span>&nbsp;<span class="op" id="4528725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528729">switch</span>&nbsp;<span class="ident" id="4528736">token</span>&nbsp;<span class="op" id="4528742">:=</span>&nbsp;<span class="ident" id="4528745">t</span><span class="op" id="4528746">.</span><span class="ident" id="4528747">nextNonSpace</span><span class="op" id="4528759">(</span><span class="op" id="4528760">)</span><span class="op" id="4528761">;</span>&nbsp;<span class="ident" id="4528763">token</span><span class="op" id="4528768">.</span><span class="ident" id="4528769">typ</span>&nbsp;<span class="op" id="4528773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528777">case</span>&nbsp;<span class="ident" id="4528782">itemRightDelim</span><span class="op" id="4528796">,</span>&nbsp;<span class="ident" id="4528798">itemRightParen</span><span class="op" id="4528812">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528817">if</span>&nbsp;<span class="builtinfunc" id="4528820">len</span><span class="op" id="4528823">(</span><span class="ident" id="4528824">pipe</span><span class="op" id="4528828">.</span><span class="ident" id="4528829">Cmds</span><span class="op" id="4528833">)</span>&nbsp;<span class="op" id="4528835">==</span>&nbsp;<span class="num" id="4528838">0</span>&nbsp;<span class="op" id="4528840">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528846">t</span><span class="op" id="4528847">.</span><span class="ident" id="4528848">errorf</span><span class="op" id="4528854">(</span><span class="string" id="4528855">&#34;missing&nbsp;value&nbsp;for&nbsp;%s&#34;</span><span class="op" id="4528877">,</span>&nbsp;<span class="ident" id="4528879">context</span><span class="op" id="4528886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4528891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528896">if</span>&nbsp;<span class="ident" id="4528899">token</span><span class="op" id="4528904">.</span><span class="ident" id="4528905">typ</span>&nbsp;<span class="op" id="4528909">==</span>&nbsp;<span class="ident" id="4528912">itemRightParen</span>&nbsp;<span class="op" id="4528927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528933">t</span><span class="op" id="4528934">.</span><span class="ident" id="4528935">backup</span><span class="op" id="4528941">(</span><span class="op" id="4528942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4528947">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528952">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528961">case</span>&nbsp;<span class="ident" id="4528966">itemBool</span><span class="op" id="4528974">,</span>&nbsp;<span class="ident" id="4528976">itemCharConstant</span><span class="op" id="4528992">,</span>&nbsp;<span class="ident" id="4528994">itemComplex</span><span class="op" id="4529005">,</span>&nbsp;<span class="ident" id="4529007">itemDot</span><span class="op" id="4529014">,</span>&nbsp;<span class="ident" id="4529016">itemField</span><span class="op" id="4529025">,</span>&nbsp;<span class="ident" id="4529027">itemIdentifier</span><span class="op" id="4529041">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529046">itemNumber</span><span class="op" id="4529056">,</span>&nbsp;<span class="ident" id="4529058">itemNil</span><span class="op" id="4529065">,</span>&nbsp;<span class="ident" id="4529067">itemRawString</span><span class="op" id="4529080">,</span>&nbsp;<span class="ident" id="4529082">itemString</span><span class="op" id="4529092">,</span>&nbsp;<span class="ident" id="4529094">itemVariable</span><span class="op" id="4529106">,</span>&nbsp;<span class="ident" id="4529108">itemLeftParen</span><span class="op" id="4529121">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529126">t</span><span class="op" id="4529127">.</span><span class="ident" id="4529128">backup</span><span class="op" id="4529134">(</span><span class="op" id="4529135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529140">pipe</span><span class="op" id="4529144">.</span><span class="builtinfunc" id="4529145">append</span><span class="op" id="4529151">(</span><span class="ident" id="4529152">t</span><span class="op" id="4529153">.</span><span class="ident" id="4529154">command</span><span class="op" id="4529161">(</span><span class="op" id="4529162">)</span><span class="op" id="4529163">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529167">default</span><span class="op" id="4529174">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529179">t</span><span class="op" id="4529180">.</span><span class="ident" id="4529181">unexpected</span><span class="op" id="4529191">(</span><span class="ident" id="4529192">token</span><span class="op" id="4529197">,</span>&nbsp;<span class="ident" id="4529199">context</span><span class="op" id="4529206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529213">}</span><br>
<span class="lineno"></span><span class="op" id="4529215">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="4529218">func</span>&nbsp;<span class="op" id="4529223">(</span><span class="ident" id="4529224">t</span>&nbsp;<span class="op" id="4529226">*</span><span class="ident" id="4529227">Tree</span><span class="op" id="4529231">)</span>&nbsp;<span class="ident" id="4529233">parseControl</span><span class="op" id="4529245">(</span><span class="ident" id="4529246">allowElseIf</span>&nbsp;<span class="builtintype" id="4529258">bool</span><span class="op" id="4529262">,</span>&nbsp;<span class="ident" id="4529264">context</span>&nbsp;<span class="builtintype" id="4529272">string</span><span class="op" id="4529278">)</span>&nbsp;<span class="op" id="4529280">(</span><span class="ident" id="4529281">pos</span>&nbsp;<span class="ident" id="4529285">Pos</span><span class="op" id="4529288">,</span>&nbsp;<span class="ident" id="4529290">line</span>&nbsp;<span class="builtintype" id="4529295">int</span><span class="op" id="4529298">,</span>&nbsp;<span class="ident" id="4529300">pipe</span>&nbsp;<span class="op" id="4529305">*</span><span class="ident" id="4529306">PipeNode</span><span class="op" id="4529314">,</span>&nbsp;<span class="ident" id="4529316">list</span><span class="op" id="4529320">,</span>&nbsp;<span class="ident" id="4529322">elseList</span>&nbsp;<span class="op" id="4529331">*</span><span class="ident" id="4529332">ListNode</span><span class="op" id="4529340">)</span>&nbsp;<span class="op" id="4529342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529345">defer</span>&nbsp;<span class="ident" id="4529351">t</span><span class="op" id="4529352">.</span><span class="ident" id="4529353">popVars</span><span class="op" id="4529360">(</span><span class="builtinfunc" id="4529361">len</span><span class="op" id="4529364">(</span><span class="ident" id="4529365">t</span><span class="op" id="4529366">.</span><span class="ident" id="4529367">vars</span><span class="op" id="4529371">)</span><span class="op" id="4529372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529375">line</span>&nbsp;<span class="op" id="4529380">=</span>&nbsp;<span class="ident" id="4529382">t</span><span class="op" id="4529383">.</span><span class="ident" id="4529384">lex</span><span class="op" id="4529387">.</span><span class="ident" id="4529388">lineNumber</span><span class="op" id="4529398">(</span><span class="op" id="4529399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529402">pipe</span>&nbsp;<span class="op" id="4529407">=</span>&nbsp;<span class="ident" id="4529409">t</span><span class="op" id="4529410">.</span><span class="ident" id="4529411">pipeline</span><span class="op" id="4529419">(</span><span class="ident" id="4529420">context</span><span class="op" id="4529427">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529430">var</span>&nbsp;<span class="ident" id="4529434">next</span>&nbsp;<span class="ident" id="4529439">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529445">list</span><span class="op" id="4529449">,</span>&nbsp;<span class="ident" id="4529451">next</span>&nbsp;<span class="op" id="4529456">=</span>&nbsp;<span class="ident" id="4529458">t</span><span class="op" id="4529459">.</span><span class="ident" id="4529460">itemList</span><span class="op" id="4529468">(</span><span class="op" id="4529469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529472">switch</span>&nbsp;<span class="ident" id="4529479">next</span><span class="op" id="4529483">.</span><span class="ident" id="4529484">Type</span><span class="op" id="4529488">(</span><span class="op" id="4529489">)</span>&nbsp;<span class="op" id="4529491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529494">case</span>&nbsp;<span class="ident" id="4529499">nodeEnd</span><span class="op" id="4529506">:</span>&nbsp;<span class="comment" id="4529508">//done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529516">case</span>&nbsp;<span class="ident" id="4529521">nodeElse</span><span class="op" id="4529529">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529533">if</span>&nbsp;<span class="ident" id="4529536">allowElseIf</span>&nbsp;<span class="op" id="4529548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4529553">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.&nbsp;If&nbsp;the&nbsp;&#34;else&#34;&nbsp;is&nbsp;followed&nbsp;immediately&nbsp;by&nbsp;an&nbsp;&#34;if&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4529637">//&nbsp;the&nbsp;elseControl&nbsp;will&nbsp;have&nbsp;left&nbsp;the&nbsp;&#34;if&#34;&nbsp;token&nbsp;pending.&nbsp;Treat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4529704">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;a}}_{{else&nbsp;if&nbsp;b}}_{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4529741">//&nbsp;as</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4529750">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;a}}_{{else}}{{if&nbsp;b}}_{{end}}{{end}}.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4529798">//&nbsp;To&nbsp;do&nbsp;this,&nbsp;parse&nbsp;the&nbsp;if&nbsp;as&nbsp;usual&nbsp;and&nbsp;stop&nbsp;at&nbsp;it&nbsp;{{end}};&nbsp;the&nbsp;subsequent{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4529884">//&nbsp;is&nbsp;assumed.&nbsp;This&nbsp;technique&nbsp;works&nbsp;even&nbsp;for&nbsp;long&nbsp;if-else-if&nbsp;chains.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4529956">//&nbsp;TODO:&nbsp;Should&nbsp;we&nbsp;allow&nbsp;else-if&nbsp;in&nbsp;with&nbsp;and&nbsp;range?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530011">if</span>&nbsp;<span class="ident" id="4530014">t</span><span class="op" id="4530015">.</span><span class="ident" id="4530016">peek</span><span class="op" id="4530020">(</span><span class="op" id="4530021">)</span><span class="op" id="4530022">.</span><span class="ident" id="4530023">typ</span>&nbsp;<span class="op" id="4530027">==</span>&nbsp;<span class="ident" id="4530030">itemIf</span>&nbsp;<span class="op" id="4530037">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530043">t</span><span class="op" id="4530044">.</span><span class="ident" id="4530045">next</span><span class="op" id="4530049">(</span><span class="op" id="4530050">)</span>&nbsp;<span class="comment" id="4530052">//&nbsp;Consume&nbsp;the&nbsp;&#34;if&#34;&nbsp;token.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530083">elseList</span>&nbsp;<span class="op" id="4530092">=</span>&nbsp;<span class="ident" id="4530094">t</span><span class="op" id="4530095">.</span><span class="ident" id="4530096">newList</span><span class="op" id="4530103">(</span><span class="ident" id="4530104">next</span><span class="op" id="4530108">.</span><span class="ident" id="4530109">Position</span><span class="op" id="4530117">(</span><span class="op" id="4530118">)</span><span class="op" id="4530119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530125">elseList</span><span class="op" id="4530133">.</span><span class="builtinfunc" id="4530134">append</span><span class="op" id="4530140">(</span><span class="ident" id="4530141">t</span><span class="op" id="4530142">.</span><span class="ident" id="4530143">ifControl</span><span class="op" id="4530152">(</span><span class="op" id="4530153">)</span><span class="op" id="4530154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530160">//&nbsp;Do&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;item&nbsp;-&nbsp;only&nbsp;one&nbsp;{{end}}&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530225">break</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530242">elseList</span><span class="op" id="4530250">,</span>&nbsp;<span class="ident" id="4530252">next</span>&nbsp;<span class="op" id="4530257">=</span>&nbsp;<span class="ident" id="4530259">t</span><span class="op" id="4530260">.</span><span class="ident" id="4530261">itemList</span><span class="op" id="4530269">(</span><span class="op" id="4530270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530274">if</span>&nbsp;<span class="ident" id="4530277">next</span><span class="op" id="4530281">.</span><span class="ident" id="4530282">Type</span><span class="op" id="4530286">(</span><span class="op" id="4530287">)</span>&nbsp;<span class="op" id="4530289">!=</span>&nbsp;<span class="ident" id="4530292">nodeEnd</span>&nbsp;<span class="op" id="4530300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530305">t</span><span class="op" id="4530306">.</span><span class="ident" id="4530307">errorf</span><span class="op" id="4530313">(</span><span class="string" id="4530314">&#34;expected&nbsp;end;&nbsp;found&nbsp;%s&#34;</span><span class="op" id="4530338">,</span>&nbsp;<span class="ident" id="4530340">next</span><span class="op" id="4530344">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530354">return</span>&nbsp;<span class="ident" id="4530361">pipe</span><span class="op" id="4530365">.</span><span class="ident" id="4530366">Position</span><span class="op" id="4530374">(</span><span class="op" id="4530375">)</span><span class="op" id="4530376">,</span>&nbsp;<span class="ident" id="4530378">line</span><span class="op" id="4530382">,</span>&nbsp;<span class="ident" id="4530384">pipe</span><span class="op" id="4530388">,</span>&nbsp;<span class="ident" id="4530390">list</span><span class="op" id="4530394">,</span>&nbsp;<span class="ident" id="4530396">elseList</span><br>
<span class="lineno"></span><span class="op" id="4530405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="comment" id="4530408">//&nbsp;If:</span><br>
<span class="lineno"></span><span class="comment" id="4530415">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4530451">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4530505">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="4530528">func</span>&nbsp;<span class="op" id="4530533">(</span><span class="ident" id="4530534">t</span>&nbsp;<span class="op" id="4530536">*</span><span class="ident" id="4530537">Tree</span><span class="op" id="4530541">)</span>&nbsp;<span class="ident" id="4530543">ifControl</span><span class="op" id="4530552">(</span><span class="op" id="4530553">)</span>&nbsp;<span class="ident" id="4530555">Node</span>&nbsp;<span class="op" id="4530560">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530563">return</span>&nbsp;<span class="ident" id="4530570">t</span><span class="op" id="4530571">.</span><span class="ident" id="4530572">newIf</span><span class="op" id="4530577">(</span><span class="ident" id="4530578">t</span><span class="op" id="4530579">.</span><span class="ident" id="4530580">parseControl</span><span class="op" id="4530592">(</span><span class="ident" id="4530593">true</span><span class="op" id="4530597">,</span>&nbsp;<span class="string" id="4530599">&#34;if&#34;</span><span class="op" id="4530603">)</span><span class="op" id="4530604">)</span><br>
<span class="lineno"></span><span class="op" id="4530606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4530609">//&nbsp;Range:</span><br>
<span class="lineno"></span><span class="comment" id="4530619">//&nbsp;&nbsp;&nbsp;&nbsp{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno">475</span><span class="comment" id="4530658">//&nbsp;&nbsp;&nbsp;&nbsp{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4530715">//&nbsp;Range&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="4530741">func</span>&nbsp;<span class="op" id="4530746">(</span><span class="ident" id="4530747">t</span>&nbsp;<span class="op" id="4530749">*</span><span class="ident" id="4530750">Tree</span><span class="op" id="4530754">)</span>&nbsp;<span class="ident" id="4530756">rangeControl</span><span class="op" id="4530768">(</span><span class="op" id="4530769">)</span>&nbsp;<span class="ident" id="4530771">Node</span>&nbsp;<span class="op" id="4530776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530779">return</span>&nbsp;<span class="ident" id="4530786">t</span><span class="op" id="4530787">.</span><span class="ident" id="4530788">newRange</span><span class="op" id="4530796">(</span><span class="ident" id="4530797">t</span><span class="op" id="4530798">.</span><span class="ident" id="4530799">parseControl</span><span class="op" id="4530811">(</span><span class="ident" id="4530812">false</span><span class="op" id="4530817">,</span>&nbsp;<span class="string" id="4530819">&#34;range&#34;</span><span class="op" id="4530826">)</span><span class="op" id="4530827">)</span><br>
<span class="lineno"></span><span class="op" id="4530829">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="4530832">//&nbsp;With:</span><br>
<span class="lineno"></span><span class="comment" id="4530841">//&nbsp;&nbsp;&nbsp;&nbsp{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4530879">//&nbsp;&nbsp;&nbsp;&nbsp{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4530935">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno">485</span><span class="keyword" id="4530958">func</span>&nbsp;<span class="op" id="4530963">(</span><span class="ident" id="4530964">t</span>&nbsp;<span class="op" id="4530966">*</span><span class="ident" id="4530967">Tree</span><span class="op" id="4530971">)</span>&nbsp;<span class="ident" id="4530973">withControl</span><span class="op" id="4530984">(</span><span class="op" id="4530985">)</span>&nbsp;<span class="ident" id="4530987">Node</span>&nbsp;<span class="op" id="4530992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530995">return</span>&nbsp;<span class="ident" id="4531002">t</span><span class="op" id="4531003">.</span><span class="ident" id="4531004">newWith</span><span class="op" id="4531011">(</span><span class="ident" id="4531012">t</span><span class="op" id="4531013">.</span><span class="ident" id="4531014">parseControl</span><span class="op" id="4531026">(</span><span class="ident" id="4531027">false</span><span class="op" id="4531032">,</span>&nbsp;<span class="string" id="4531034">&#34;with&#34;</span><span class="op" id="4531040">)</span><span class="op" id="4531041">)</span><br>
<span class="lineno"></span><span class="op" id="4531043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4531046">//&nbsp;End:</span><br>
<span class="lineno">490</span><span class="comment" id="4531054">//&nbsp;&nbsp;&nbsp;&nbsp{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4531065">//&nbsp;End&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="4531089">func</span>&nbsp;<span class="op" id="4531094">(</span><span class="ident" id="4531095">t</span>&nbsp;<span class="op" id="4531097">*</span><span class="ident" id="4531098">Tree</span><span class="op" id="4531102">)</span>&nbsp;<span class="ident" id="4531104">endControl</span><span class="op" id="4531114">(</span><span class="op" id="4531115">)</span>&nbsp;<span class="ident" id="4531117">Node</span>&nbsp;<span class="op" id="4531122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531125">return</span>&nbsp;<span class="ident" id="4531132">t</span><span class="op" id="4531133">.</span><span class="ident" id="4531134">newEnd</span><span class="op" id="4531140">(</span><span class="ident" id="4531141">t</span><span class="op" id="4531142">.</span><span class="ident" id="4531143">expect</span><span class="op" id="4531149">(</span><span class="ident" id="4531150">itemRightDelim</span><span class="op" id="4531164">,</span>&nbsp;<span class="string" id="4531166">&#34;end&#34;</span><span class="op" id="4531171">)</span><span class="op" id="4531172">.</span><span class="ident" id="4531173">pos</span><span class="op" id="4531176">)</span><br>
<span class="lineno"></span><span class="op" id="4531178">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="comment" id="4531181">//&nbsp;Else:</span><br>
<span class="lineno"></span><span class="comment" id="4531190">//&nbsp;&nbsp;&nbsp;&nbsp{{else}}</span><br>
<span class="lineno"></span><span class="comment" id="4531202">//&nbsp;Else&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="4531227">func</span>&nbsp;<span class="op" id="4531232">(</span><span class="ident" id="4531233">t</span>&nbsp;<span class="op" id="4531235">*</span><span class="ident" id="4531236">Tree</span><span class="op" id="4531240">)</span>&nbsp;<span class="ident" id="4531242">elseControl</span><span class="op" id="4531253">(</span><span class="op" id="4531254">)</span>&nbsp;<span class="ident" id="4531256">Node</span>&nbsp;<span class="op" id="4531261">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4531264">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531296">peek</span>&nbsp;<span class="op" id="4531301">:=</span>&nbsp;<span class="ident" id="4531304">t</span><span class="op" id="4531305">.</span><span class="ident" id="4531306">peekNonSpace</span><span class="op" id="4531318">(</span><span class="op" id="4531319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531322">if</span>&nbsp;<span class="ident" id="4531325">peek</span><span class="op" id="4531329">.</span><span class="ident" id="4531330">typ</span>&nbsp;<span class="op" id="4531334">==</span>&nbsp;<span class="ident" id="4531337">itemIf</span>&nbsp;<span class="op" id="4531344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4531348">//&nbsp;We&nbsp;see&nbsp;&#34;{{else&nbsp;if&nbsp;...&nbsp;&#34;&nbsp;but&nbsp;in&nbsp;effect&nbsp;rewrite&nbsp;it&nbsp;to&nbsp;{{else}}{{if&nbsp;...&nbsp;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531425">return</span>&nbsp;<span class="ident" id="4531432">t</span><span class="op" id="4531433">.</span><span class="ident" id="4531434">newElse</span><span class="op" id="4531441">(</span><span class="ident" id="4531442">peek</span><span class="op" id="4531446">.</span><span class="ident" id="4531447">pos</span><span class="op" id="4531450">,</span>&nbsp;<span class="ident" id="4531452">t</span><span class="op" id="4531453">.</span><span class="ident" id="4531454">lex</span><span class="op" id="4531457">.</span><span class="ident" id="4531458">lineNumber</span><span class="op" id="4531468">(</span><span class="op" id="4531469">)</span><span class="op" id="4531470">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4531473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531476">return</span>&nbsp;<span class="ident" id="4531483">t</span><span class="op" id="4531484">.</span><span class="ident" id="4531485">newElse</span><span class="op" id="4531492">(</span><span class="ident" id="4531493">t</span><span class="op" id="4531494">.</span><span class="ident" id="4531495">expect</span><span class="op" id="4531501">(</span><span class="ident" id="4531502">itemRightDelim</span><span class="op" id="4531516">,</span>&nbsp;<span class="string" id="4531518">&#34;else&#34;</span><span class="op" id="4531524">)</span><span class="op" id="4531525">.</span><span class="ident" id="4531526">pos</span><span class="op" id="4531529">,</span>&nbsp;<span class="ident" id="4531531">t</span><span class="op" id="4531532">.</span><span class="ident" id="4531533">lex</span><span class="op" id="4531536">.</span><span class="ident" id="4531537">lineNumber</span><span class="op" id="4531547">(</span><span class="op" id="4531548">)</span><span class="op" id="4531549">)</span><br>
<span class="lineno"></span><span class="op" id="4531551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4531554">//&nbsp;Template:</span><br>
<span class="lineno">510</span><span class="comment" id="4531567">//&nbsp;&nbsp;&nbsp;&nbsp{{template&nbsp;stringValue&nbsp;pipeline}}</span><br>
<span class="lineno"></span><span class="comment" id="4531604">//&nbsp;Template&nbsp;keyword&nbsp;is&nbsp;past.&nbsp;&nbsp;The&nbsp;name&nbsp;must&nbsp;be&nbsp;something&nbsp;that&nbsp;can&nbsp;evaluate</span><br>
<span class="lineno"></span><span class="comment" id="4531679">//&nbsp;to&nbsp;a&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="4531695">func</span>&nbsp;<span class="op" id="4531700">(</span><span class="ident" id="4531701">t</span>&nbsp;<span class="op" id="4531703">*</span><span class="ident" id="4531704">Tree</span><span class="op" id="4531708">)</span>&nbsp;<span class="ident" id="4531710">templateControl</span><span class="op" id="4531725">(</span><span class="op" id="4531726">)</span>&nbsp;<span class="ident" id="4531728">Node</span>&nbsp;<span class="op" id="4531733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531736">var</span>&nbsp;<span class="ident" id="4531740">name</span>&nbsp;<span class="builtintype" id="4531745">string</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531753">token</span>&nbsp;<span class="op" id="4531759">:=</span>&nbsp;<span class="ident" id="4531762">t</span><span class="op" id="4531763">.</span><span class="ident" id="4531764">nextNonSpace</span><span class="op" id="4531776">(</span><span class="op" id="4531777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531780">switch</span>&nbsp;<span class="ident" id="4531787">token</span><span class="op" id="4531792">.</span><span class="ident" id="4531793">typ</span>&nbsp;<span class="op" id="4531797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531800">case</span>&nbsp;<span class="ident" id="4531805">itemString</span><span class="op" id="4531815">,</span>&nbsp;<span class="ident" id="4531817">itemRawString</span><span class="op" id="4531830">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531834">s</span><span class="op" id="4531835">,</span>&nbsp;<span class="ident" id="4531837">err</span>&nbsp;<span class="op" id="4531841">:=</span>&nbsp;<span class="ident" id="4531844">strconv</span><span class="op" id="4531851">.</span><span class="ident" id="4531852">Unquote</span><span class="op" id="4531859">(</span><span class="ident" id="4531860">token</span><span class="op" id="4531865">.</span><span class="ident" id="4531866">val</span><span class="op" id="4531869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531873">if</span>&nbsp;<span class="ident" id="4531876">err</span>&nbsp;<span class="op" id="4531880">!=</span>&nbsp;<span class="ident" id="4531883">nil</span>&nbsp;<span class="op" id="4531887">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531892">t</span><span class="op" id="4531893">.</span><span class="builtintype" id="4531894">error</span><span class="op" id="4531899">(</span><span class="ident" id="4531900">err</span><span class="op" id="4531903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4531907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531911">name</span>&nbsp;<span class="op" id="4531916">=</span>&nbsp;<span class="ident" id="4531918">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531921">default</span><span class="op" id="4531928">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531932">t</span><span class="op" id="4531933">.</span><span class="ident" id="4531934">unexpected</span><span class="op" id="4531944">(</span><span class="ident" id="4531945">token</span><span class="op" id="4531950">,</span>&nbsp;<span class="string" id="4531952">&#34;template&nbsp;invocation&#34;</span><span class="op" id="4531973">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4531976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531979">var</span>&nbsp;<span class="ident" id="4531983">pipe</span>&nbsp;<span class="op" id="4531988">*</span><span class="ident" id="4531989">PipeNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531999">if</span>&nbsp;<span class="ident" id="4532002">t</span><span class="op" id="4532003">.</span><span class="ident" id="4532004">nextNonSpace</span><span class="op" id="4532016">(</span><span class="op" id="4532017">)</span><span class="op" id="4532018">.</span><span class="ident" id="4532019">typ</span>&nbsp;<span class="op" id="4532023">!=</span>&nbsp;<span class="ident" id="4532026">itemRightDelim</span>&nbsp;<span class="op" id="4532041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532045">t</span><span class="op" id="4532046">.</span><span class="ident" id="4532047">backup</span><span class="op" id="4532053">(</span><span class="op" id="4532054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4532058">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532111">pipe</span>&nbsp;<span class="op" id="4532116">=</span>&nbsp;<span class="ident" id="4532118">t</span><span class="op" id="4532119">.</span><span class="ident" id="4532120">pipeline</span><span class="op" id="4532128">(</span><span class="string" id="4532129">&#34;template&#34;</span><span class="op" id="4532139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4532142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532145">return</span>&nbsp;<span class="ident" id="4532152">t</span><span class="op" id="4532153">.</span><span class="ident" id="4532154">newTemplate</span><span class="op" id="4532165">(</span><span class="ident" id="4532166">token</span><span class="op" id="4532171">.</span><span class="ident" id="4532172">pos</span><span class="op" id="4532175">,</span>&nbsp;<span class="ident" id="4532177">t</span><span class="op" id="4532178">.</span><span class="ident" id="4532179">lex</span><span class="op" id="4532182">.</span><span class="ident" id="4532183">lineNumber</span><span class="op" id="4532193">(</span><span class="op" id="4532194">)</span><span class="op" id="4532195">,</span>&nbsp;<span class="ident" id="4532197">name</span><span class="op" id="4532201">,</span>&nbsp;<span class="ident" id="4532203">pipe</span><span class="op" id="4532207">)</span><br>
<span class="lineno"></span><span class="op" id="4532209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="comment" id="4532212">//&nbsp;command:</span><br>
<span class="lineno"></span><span class="comment" id="4532224">//&nbsp;&nbsp;&nbsp;&nbspoperand&nbsp;(space&nbsp;operand)*</span><br>
<span class="lineno"></span><span class="comment" id="4532252">//&nbsp;space-separated&nbsp;arguments&nbsp;up&nbsp;to&nbsp;a&nbsp;pipeline&nbsp;character&nbsp;or&nbsp;right&nbsp;delimiter.</span><br>
<span class="lineno"></span><span class="comment" id="4532328">//&nbsp;we&nbsp;consume&nbsp;the&nbsp;pipe&nbsp;character&nbsp;but&nbsp;leave&nbsp;the&nbsp;right&nbsp;delim&nbsp;to&nbsp;terminate&nbsp;the&nbsp;action.</span><br>
<span class="lineno"></span><span class="keyword" id="4532412">func</span>&nbsp;<span class="op" id="4532417">(</span><span class="ident" id="4532418">t</span>&nbsp;<span class="op" id="4532420">*</span><span class="ident" id="4532421">Tree</span><span class="op" id="4532425">)</span>&nbsp;<span class="ident" id="4532427">command</span><span class="op" id="4532434">(</span><span class="op" id="4532435">)</span>&nbsp;<span class="op" id="4532437">*</span><span class="ident" id="4532438">CommandNode</span>&nbsp;<span class="op" id="4532450">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532453">cmd</span>&nbsp;<span class="op" id="4532457">:=</span>&nbsp;<span class="ident" id="4532460">t</span><span class="op" id="4532461">.</span><span class="ident" id="4532462">newCommand</span><span class="op" id="4532472">(</span><span class="ident" id="4532473">t</span><span class="op" id="4532474">.</span><span class="ident" id="4532475">peekNonSpace</span><span class="op" id="4532487">(</span><span class="op" id="4532488">)</span><span class="op" id="4532489">.</span><span class="ident" id="4532490">pos</span><span class="op" id="4532493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532496">for</span>&nbsp;<span class="op" id="4532500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532504">t</span><span class="op" id="4532505">.</span><span class="ident" id="4532506">peekNonSpace</span><span class="op" id="4532518">(</span><span class="op" id="4532519">)</span>&nbsp;<span class="comment" id="4532521">//&nbsp;skip&nbsp;leading&nbsp;spaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532547">operand</span>&nbsp;<span class="op" id="4532555">:=</span>&nbsp;<span class="ident" id="4532558">t</span><span class="op" id="4532559">.</span><span class="ident" id="4532560">operand</span><span class="op" id="4532567">(</span><span class="op" id="4532568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532572">if</span>&nbsp;<span class="ident" id="4532575">operand</span>&nbsp;<span class="op" id="4532583">!=</span>&nbsp;<span class="ident" id="4532586">nil</span>&nbsp;<span class="op" id="4532590">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532595">cmd</span><span class="op" id="4532598">.</span><span class="builtinfunc" id="4532599">append</span><span class="op" id="4532605">(</span><span class="ident" id="4532606">operand</span><span class="op" id="4532613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4532617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532621">switch</span>&nbsp;<span class="ident" id="4532628">token</span>&nbsp;<span class="op" id="4532634">:=</span>&nbsp;<span class="ident" id="4532637">t</span><span class="op" id="4532638">.</span><span class="ident" id="4532639">next</span><span class="op" id="4532643">(</span><span class="op" id="4532644">)</span><span class="op" id="4532645">;</span>&nbsp;<span class="ident" id="4532647">token</span><span class="op" id="4532652">.</span><span class="ident" id="4532653">typ</span>&nbsp;<span class="op" id="4532657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532661">case</span>&nbsp;<span class="ident" id="4532666">itemSpace</span><span class="op" id="4532675">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532680">continue</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532691">case</span>&nbsp;<span class="ident" id="4532696">itemError</span><span class="op" id="4532705">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532710">t</span><span class="op" id="4532711">.</span><span class="ident" id="4532712">errorf</span><span class="op" id="4532718">(</span><span class="string" id="4532719">&#34;%s&#34;</span><span class="op" id="4532723">,</span>&nbsp;<span class="ident" id="4532725">token</span><span class="op" id="4532730">.</span><span class="ident" id="4532731">val</span><span class="op" id="4532734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532738">case</span>&nbsp;<span class="ident" id="4532743">itemRightDelim</span><span class="op" id="4532757">,</span>&nbsp;<span class="ident" id="4532759">itemRightParen</span><span class="op" id="4532773">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532778">t</span><span class="op" id="4532779">.</span><span class="ident" id="4532780">backup</span><span class="op" id="4532786">(</span><span class="op" id="4532787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532791">case</span>&nbsp;<span class="ident" id="4532796">itemPipe</span><span class="op" id="4532804">:</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532808">default</span><span class="op" id="4532815">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532820">t</span><span class="op" id="4532821">.</span><span class="ident" id="4532822">errorf</span><span class="op" id="4532828">(</span><span class="string" id="4532829">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;operand;&nbsp;missing&nbsp;space?&#34;</span><span class="op" id="4532871">,</span>&nbsp;<span class="ident" id="4532873">token</span><span class="op" id="4532878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4532882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532886">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4532893">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532896">if</span>&nbsp;<span class="builtinfunc" id="4532899">len</span><span class="op" id="4532902">(</span><span class="ident" id="4532903">cmd</span><span class="op" id="4532906">.</span><span class="ident" id="4532907">Args</span><span class="op" id="4532911">)</span>&nbsp;<span class="op" id="4532913">==</span>&nbsp;<span class="num" id="4532916">0</span>&nbsp;<span class="op" id="4532918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532922">t</span><span class="op" id="4532923">.</span><span class="ident" id="4532924">errorf</span><span class="op" id="4532930">(</span><span class="string" id="4532931">&#34;empty&nbsp;command&#34;</span><span class="op" id="4532946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4532949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532952">return</span>&nbsp;<span class="ident" id="4532959">cmd</span><br>
<span class="lineno"></span><span class="op" id="4532963">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="comment" id="4532966">//&nbsp;operand:</span><br>
<span class="lineno"></span><span class="comment" id="4532978">//&nbsp;&nbsp;&nbsp;&nbspterm&nbsp;.Field*</span><br>
<span class="lineno"></span><span class="comment" id="4532994">//&nbsp;An&nbsp;operand&nbsp;is&nbsp;a&nbsp;space-separated&nbsp;component&nbsp;of&nbsp;a&nbsp;command,</span><br>
<span class="lineno"></span><span class="comment" id="4533053">//&nbsp;a&nbsp;term&nbsp;possibly&nbsp;followed&nbsp;by&nbsp;field&nbsp;accesses.</span><br>
<span class="lineno">570</span><span class="comment" id="4533100">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;an&nbsp;operand.</span><br>
<span class="lineno"></span><span class="keyword" id="4533155">func</span>&nbsp;<span class="op" id="4533160">(</span><span class="ident" id="4533161">t</span>&nbsp;<span class="op" id="4533163">*</span><span class="ident" id="4533164">Tree</span><span class="op" id="4533168">)</span>&nbsp;<span class="ident" id="4533170">operand</span><span class="op" id="4533177">(</span><span class="op" id="4533178">)</span>&nbsp;<span class="ident" id="4533180">Node</span>&nbsp;<span class="op" id="4533185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533188">node</span>&nbsp;<span class="op" id="4533193">:=</span>&nbsp;<span class="ident" id="4533196">t</span><span class="op" id="4533197">.</span><span class="ident" id="4533198">term</span><span class="op" id="4533202">(</span><span class="op" id="4533203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533206">if</span>&nbsp;<span class="ident" id="4533209">node</span>&nbsp;<span class="op" id="4533214">==</span>&nbsp;<span class="ident" id="4533217">nil</span>&nbsp;<span class="op" id="4533221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533225">return</span>&nbsp;<span class="ident" id="4533232">nil</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4533237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533240">if</span>&nbsp;<span class="ident" id="4533243">t</span><span class="op" id="4533244">.</span><span class="ident" id="4533245">peek</span><span class="op" id="4533249">(</span><span class="op" id="4533250">)</span><span class="op" id="4533251">.</span><span class="ident" id="4533252">typ</span>&nbsp;<span class="op" id="4533256">==</span>&nbsp;<span class="ident" id="4533259">itemField</span>&nbsp;<span class="op" id="4533269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533273">chain</span>&nbsp;<span class="op" id="4533279">:=</span>&nbsp;<span class="ident" id="4533282">t</span><span class="op" id="4533283">.</span><span class="ident" id="4533284">newChain</span><span class="op" id="4533292">(</span><span class="ident" id="4533293">t</span><span class="op" id="4533294">.</span><span class="ident" id="4533295">peek</span><span class="op" id="4533299">(</span><span class="op" id="4533300">)</span><span class="op" id="4533301">.</span><span class="ident" id="4533302">pos</span><span class="op" id="4533305">,</span>&nbsp;<span class="ident" id="4533307">node</span><span class="op" id="4533311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533315">for</span>&nbsp;<span class="ident" id="4533319">t</span><span class="op" id="4533320">.</span><span class="ident" id="4533321">peek</span><span class="op" id="4533325">(</span><span class="op" id="4533326">)</span><span class="op" id="4533327">.</span><span class="ident" id="4533328">typ</span>&nbsp;<span class="op" id="4533332">==</span>&nbsp;<span class="ident" id="4533335">itemField</span>&nbsp;<span class="op" id="4533345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533350">chain</span><span class="op" id="4533355">.</span><span class="ident" id="4533356">Add</span><span class="op" id="4533359">(</span><span class="ident" id="4533360">t</span><span class="op" id="4533361">.</span><span class="ident" id="4533362">next</span><span class="op" id="4533366">(</span><span class="op" id="4533367">)</span><span class="op" id="4533368">.</span><span class="ident" id="4533369">val</span><span class="op" id="4533372">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4533376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4533380">//&nbsp;Compatibility&nbsp;with&nbsp;original&nbsp;API:&nbsp;If&nbsp;the&nbsp;term&nbsp;is&nbsp;of&nbsp;type&nbsp;NodeField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4533451">//&nbsp;or&nbsp;NodeVariable,&nbsp;just&nbsp;put&nbsp;more&nbsp;fields&nbsp;on&nbsp;the&nbsp;original.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4533511">//&nbsp;Otherwise,&nbsp;keep&nbsp;the&nbsp;Chain&nbsp;node.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4533548">//&nbsp;TODO:&nbsp;Switch&nbsp;to&nbsp;Chains&nbsp;always&nbsp;when&nbsp;we&nbsp;can.</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533596">switch</span>&nbsp;<span class="ident" id="4533603">node</span><span class="op" id="4533607">.</span><span class="ident" id="4533608">Type</span><span class="op" id="4533612">(</span><span class="op" id="4533613">)</span>&nbsp;<span class="op" id="4533615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533619">case</span>&nbsp;<span class="ident" id="4533624">NodeField</span><span class="op" id="4533633">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533638">node</span>&nbsp;<span class="op" id="4533643">=</span>&nbsp;<span class="ident" id="4533645">t</span><span class="op" id="4533646">.</span><span class="ident" id="4533647">newField</span><span class="op" id="4533655">(</span><span class="ident" id="4533656">chain</span><span class="op" id="4533661">.</span><span class="ident" id="4533662">Position</span><span class="op" id="4533670">(</span><span class="op" id="4533671">)</span><span class="op" id="4533672">,</span>&nbsp;<span class="ident" id="4533674">chain</span><span class="op" id="4533679">.</span><span class="ident" id="4533680">String</span><span class="op" id="4533686">(</span><span class="op" id="4533687">)</span><span class="op" id="4533688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533692">case</span>&nbsp;<span class="ident" id="4533697">NodeVariable</span><span class="op" id="4533709">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533714">node</span>&nbsp;<span class="op" id="4533719">=</span>&nbsp;<span class="ident" id="4533721">t</span><span class="op" id="4533722">.</span><span class="ident" id="4533723">newVariable</span><span class="op" id="4533734">(</span><span class="ident" id="4533735">chain</span><span class="op" id="4533740">.</span><span class="ident" id="4533741">Position</span><span class="op" id="4533749">(</span><span class="op" id="4533750">)</span><span class="op" id="4533751">,</span>&nbsp;<span class="ident" id="4533753">chain</span><span class="op" id="4533758">.</span><span class="ident" id="4533759">String</span><span class="op" id="4533765">(</span><span class="op" id="4533766">)</span><span class="op" id="4533767">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533771">default</span><span class="op" id="4533778">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533783">node</span>&nbsp;<span class="op" id="4533788">=</span>&nbsp;<span class="ident" id="4533790">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4533798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4533801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533804">return</span>&nbsp;<span class="ident" id="4533811">node</span><br>
<span class="lineno">595</span><span class="op" id="4533816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4533819">//&nbsp;term:</span><br>
<span class="lineno"></span><span class="comment" id="4533828">//&nbsp;&nbsp;&nbsp;&nbspliteral&nbsp;(number,&nbsp;string,&nbsp;nil,&nbsp;boolean)</span><br>
<span class="lineno"></span><span class="comment" id="4533870">//&nbsp;&nbsp;&nbsp;&nbspfunction&nbsp;(identifier)</span><br>
<span class="lineno">600</span><span class="comment" id="4533895">//&nbsp;&nbsp;&nbsp;&nbsp.</span><br>
<span class="lineno"></span><span class="comment" id="4533900">//&nbsp;&nbsp;&nbsp;&nbsp.Field</span><br>
<span class="lineno"></span><span class="comment" id="4533910">//&nbsp;&nbsp;&nbsp;&nbsp$</span><br>
<span class="lineno"></span><span class="comment" id="4533915">//&nbsp;&nbsp;&nbsp;&nbsp&#39;(&#39;&nbsp;pipeline&nbsp;&#39;)&#39;</span><br>
<span class="lineno"></span><span class="comment" id="4533935">//&nbsp;A&nbsp;term&nbsp;is&nbsp;a&nbsp;simple&nbsp;&#34;expression&#34;.</span><br>
<span class="lineno">605</span><span class="comment" id="4533971">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;a&nbsp;term.</span><br>
<span class="lineno"></span><span class="keyword" id="4534022">func</span>&nbsp;<span class="op" id="4534027">(</span><span class="ident" id="4534028">t</span>&nbsp;<span class="op" id="4534030">*</span><span class="ident" id="4534031">Tree</span><span class="op" id="4534035">)</span>&nbsp;<span class="ident" id="4534037">term</span><span class="op" id="4534041">(</span><span class="op" id="4534042">)</span>&nbsp;<span class="ident" id="4534044">Node</span>&nbsp;<span class="op" id="4534049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534052">switch</span>&nbsp;<span class="ident" id="4534059">token</span>&nbsp;<span class="op" id="4534065">:=</span>&nbsp;<span class="ident" id="4534068">t</span><span class="op" id="4534069">.</span><span class="ident" id="4534070">nextNonSpace</span><span class="op" id="4534082">(</span><span class="op" id="4534083">)</span><span class="op" id="4534084">;</span>&nbsp;<span class="ident" id="4534086">token</span><span class="op" id="4534091">.</span><span class="ident" id="4534092">typ</span>&nbsp;<span class="op" id="4534096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534099">case</span>&nbsp;<span class="ident" id="4534104">itemError</span><span class="op" id="4534113">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534117">t</span><span class="op" id="4534118">.</span><span class="ident" id="4534119">errorf</span><span class="op" id="4534125">(</span><span class="string" id="4534126">&#34;%s&#34;</span><span class="op" id="4534130">,</span>&nbsp;<span class="ident" id="4534132">token</span><span class="op" id="4534137">.</span><span class="ident" id="4534138">val</span><span class="op" id="4534141">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534144">case</span>&nbsp;<span class="ident" id="4534149">itemIdentifier</span><span class="op" id="4534163">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534167">if</span>&nbsp;<span class="op" id="4534170">!</span><span class="ident" id="4534171">t</span><span class="op" id="4534172">.</span><span class="ident" id="4534173">hasFunction</span><span class="op" id="4534184">(</span><span class="ident" id="4534185">token</span><span class="op" id="4534190">.</span><span class="ident" id="4534191">val</span><span class="op" id="4534194">)</span>&nbsp;<span class="op" id="4534196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534201">t</span><span class="op" id="4534202">.</span><span class="ident" id="4534203">errorf</span><span class="op" id="4534209">(</span><span class="string" id="4534210">&#34;function&nbsp;%q&nbsp;not&nbsp;defined&#34;</span><span class="op" id="4534235">,</span>&nbsp;<span class="ident" id="4534237">token</span><span class="op" id="4534242">.</span><span class="ident" id="4534243">val</span><span class="op" id="4534246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4534250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534254">return</span>&nbsp;<span class="ident" id="4534261">NewIdentifier</span><span class="op" id="4534274">(</span><span class="ident" id="4534275">token</span><span class="op" id="4534280">.</span><span class="ident" id="4534281">val</span><span class="op" id="4534284">)</span><span class="op" id="4534285">.</span><span class="ident" id="4534286">SetTree</span><span class="op" id="4534293">(</span><span class="ident" id="4534294">t</span><span class="op" id="4534295">)</span><span class="op" id="4534296">.</span><span class="ident" id="4534297">SetPos</span><span class="op" id="4534303">(</span><span class="ident" id="4534304">token</span><span class="op" id="4534309">.</span><span class="ident" id="4534310">pos</span><span class="op" id="4534313">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534316">case</span>&nbsp;<span class="ident" id="4534321">itemDot</span><span class="op" id="4534328">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534332">return</span>&nbsp;<span class="ident" id="4534339">t</span><span class="op" id="4534340">.</span><span class="ident" id="4534341">newDot</span><span class="op" id="4534347">(</span><span class="ident" id="4534348">token</span><span class="op" id="4534353">.</span><span class="ident" id="4534354">pos</span><span class="op" id="4534357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534360">case</span>&nbsp;<span class="ident" id="4534365">itemNil</span><span class="op" id="4534372">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534376">return</span>&nbsp;<span class="ident" id="4534383">t</span><span class="op" id="4534384">.</span><span class="ident" id="4534385">newNil</span><span class="op" id="4534391">(</span><span class="ident" id="4534392">token</span><span class="op" id="4534397">.</span><span class="ident" id="4534398">pos</span><span class="op" id="4534401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534404">case</span>&nbsp;<span class="ident" id="4534409">itemVariable</span><span class="op" id="4534421">:</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534425">return</span>&nbsp;<span class="ident" id="4534432">t</span><span class="op" id="4534433">.</span><span class="ident" id="4534434">useVar</span><span class="op" id="4534440">(</span><span class="ident" id="4534441">token</span><span class="op" id="4534446">.</span><span class="ident" id="4534447">pos</span><span class="op" id="4534450">,</span>&nbsp;<span class="ident" id="4534452">token</span><span class="op" id="4534457">.</span><span class="ident" id="4534458">val</span><span class="op" id="4534461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534464">case</span>&nbsp;<span class="ident" id="4534469">itemField</span><span class="op" id="4534478">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534482">return</span>&nbsp;<span class="ident" id="4534489">t</span><span class="op" id="4534490">.</span><span class="ident" id="4534491">newField</span><span class="op" id="4534499">(</span><span class="ident" id="4534500">token</span><span class="op" id="4534505">.</span><span class="ident" id="4534506">pos</span><span class="op" id="4534509">,</span>&nbsp;<span class="ident" id="4534511">token</span><span class="op" id="4534516">.</span><span class="ident" id="4534517">val</span><span class="op" id="4534520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534523">case</span>&nbsp;<span class="ident" id="4534528">itemBool</span><span class="op" id="4534536">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534540">return</span>&nbsp;<span class="ident" id="4534547">t</span><span class="op" id="4534548">.</span><span class="ident" id="4534549">newBool</span><span class="op" id="4534556">(</span><span class="ident" id="4534557">token</span><span class="op" id="4534562">.</span><span class="ident" id="4534563">pos</span><span class="op" id="4534566">,</span>&nbsp;<span class="ident" id="4534568">token</span><span class="op" id="4534573">.</span><span class="ident" id="4534574">val</span>&nbsp;<span class="op" id="4534578">==</span>&nbsp;<span class="string" id="4534581">&#34;true&#34;</span><span class="op" id="4534587">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534590">case</span>&nbsp;<span class="ident" id="4534595">itemCharConstant</span><span class="op" id="4534611">,</span>&nbsp;<span class="ident" id="4534613">itemComplex</span><span class="op" id="4534624">,</span>&nbsp;<span class="ident" id="4534626">itemNumber</span><span class="op" id="4534636">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534640">number</span><span class="op" id="4534646">,</span>&nbsp;<span class="ident" id="4534648">err</span>&nbsp;<span class="op" id="4534652">:=</span>&nbsp;<span class="ident" id="4534655">t</span><span class="op" id="4534656">.</span><span class="ident" id="4534657">newNumber</span><span class="op" id="4534666">(</span><span class="ident" id="4534667">token</span><span class="op" id="4534672">.</span><span class="ident" id="4534673">pos</span><span class="op" id="4534676">,</span>&nbsp;<span class="ident" id="4534678">token</span><span class="op" id="4534683">.</span><span class="ident" id="4534684">val</span><span class="op" id="4534687">,</span>&nbsp;<span class="ident" id="4534689">token</span><span class="op" id="4534694">.</span><span class="ident" id="4534695">typ</span><span class="op" id="4534698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534702">if</span>&nbsp;<span class="ident" id="4534705">err</span>&nbsp;<span class="op" id="4534709">!=</span>&nbsp;<span class="ident" id="4534712">nil</span>&nbsp;<span class="op" id="4534716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534721">t</span><span class="op" id="4534722">.</span><span class="builtintype" id="4534723">error</span><span class="op" id="4534728">(</span><span class="ident" id="4534729">err</span><span class="op" id="4534732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4534736">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534740">return</span>&nbsp;<span class="ident" id="4534747">number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534755">case</span>&nbsp;<span class="ident" id="4534760">itemLeftParen</span><span class="op" id="4534773">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534777">pipe</span>&nbsp;<span class="op" id="4534782">:=</span>&nbsp;<span class="ident" id="4534785">t</span><span class="op" id="4534786">.</span><span class="ident" id="4534787">pipeline</span><span class="op" id="4534795">(</span><span class="string" id="4534796">&#34;parenthesized&nbsp;pipeline&#34;</span><span class="op" id="4534820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534824">if</span>&nbsp;<span class="ident" id="4534827">token</span>&nbsp;<span class="op" id="4534833">:=</span>&nbsp;<span class="ident" id="4534836">t</span><span class="op" id="4534837">.</span><span class="ident" id="4534838">next</span><span class="op" id="4534842">(</span><span class="op" id="4534843">)</span><span class="op" id="4534844">;</span>&nbsp;<span class="ident" id="4534846">token</span><span class="op" id="4534851">.</span><span class="ident" id="4534852">typ</span>&nbsp;<span class="op" id="4534856">!=</span>&nbsp;<span class="ident" id="4534859">itemRightParen</span>&nbsp;<span class="op" id="4534874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534879">t</span><span class="op" id="4534880">.</span><span class="ident" id="4534881">errorf</span><span class="op" id="4534887">(</span><span class="string" id="4534888">&#34;unclosed&nbsp;right&nbsp;paren:&nbsp;unexpected&nbsp;%s&#34;</span><span class="op" id="4534925">,</span>&nbsp;<span class="ident" id="4534927">token</span><span class="op" id="4534932">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4534936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534940">return</span>&nbsp;<span class="ident" id="4534947">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534953">case</span>&nbsp;<span class="ident" id="4534958">itemString</span><span class="op" id="4534968">,</span>&nbsp;<span class="ident" id="4534970">itemRawString</span><span class="op" id="4534983">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534987">s</span><span class="op" id="4534988">,</span>&nbsp;<span class="ident" id="4534990">err</span>&nbsp;<span class="op" id="4534994">:=</span>&nbsp;<span class="ident" id="4534997">strconv</span><span class="op" id="4535004">.</span><span class="ident" id="4535005">Unquote</span><span class="op" id="4535012">(</span><span class="ident" id="4535013">token</span><span class="op" id="4535018">.</span><span class="ident" id="4535019">val</span><span class="op" id="4535022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535026">if</span>&nbsp;<span class="ident" id="4535029">err</span>&nbsp;<span class="op" id="4535033">!=</span>&nbsp;<span class="ident" id="4535036">nil</span>&nbsp;<span class="op" id="4535040">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4535045">t</span><span class="op" id="4535046">.</span><span class="builtintype" id="4535047">error</span><span class="op" id="4535052">(</span><span class="ident" id="4535053">err</span><span class="op" id="4535056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4535060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535064">return</span>&nbsp;<span class="ident" id="4535071">t</span><span class="op" id="4535072">.</span><span class="ident" id="4535073">newString</span><span class="op" id="4535082">(</span><span class="ident" id="4535083">token</span><span class="op" id="4535088">.</span><span class="ident" id="4535089">pos</span><span class="op" id="4535092">,</span>&nbsp;<span class="ident" id="4535094">token</span><span class="op" id="4535099">.</span><span class="ident" id="4535100">val</span><span class="op" id="4535103">,</span>&nbsp;<span class="ident" id="4535105">s</span><span class="op" id="4535106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4535109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4535112">t</span><span class="op" id="4535113">.</span><span class="ident" id="4535114">backup</span><span class="op" id="4535120">(</span><span class="op" id="4535121">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535124">return</span>&nbsp;<span class="ident" id="4535131">nil</span><br>
<span class="lineno"></span><span class="op" id="4535135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4535138">//&nbsp;hasFunction&nbsp;reports&nbsp;if&nbsp;a&nbsp;function&nbsp;name&nbsp;exists&nbsp;in&nbsp;the&nbsp;Tree&#39;s&nbsp;maps.</span><br>
<span class="lineno"></span><span class="keyword" id="4535207">func</span>&nbsp;<span class="op" id="4535212">(</span><span class="ident" id="4535213">t</span>&nbsp;<span class="op" id="4535215">*</span><span class="ident" id="4535216">Tree</span><span class="op" id="4535220">)</span>&nbsp;<span class="ident" id="4535222">hasFunction</span><span class="op" id="4535233">(</span><span class="ident" id="4535234">name</span>&nbsp;<span class="builtintype" id="4535239">string</span><span class="op" id="4535245">)</span>&nbsp;<span class="builtintype" id="4535247">bool</span>&nbsp;<span class="op" id="4535252">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535255">for</span>&nbsp;<span class="ident" id="4535259">_</span><span class="op" id="4535260">,</span>&nbsp;<span class="ident" id="4535262">funcMap</span>&nbsp;<span class="op" id="4535270">:=</span>&nbsp;<span class="keyword" id="4535273">range</span>&nbsp;<span class="ident" id="4535279">t</span><span class="op" id="4535280">.</span><span class="ident" id="4535281">funcs</span>&nbsp;<span class="op" id="4535287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535291">if</span>&nbsp;<span class="ident" id="4535294">funcMap</span>&nbsp;<span class="op" id="4535302">==</span>&nbsp;<span class="ident" id="4535305">nil</span>&nbsp;<span class="op" id="4535309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535314">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4535325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535329">if</span>&nbsp;<span class="ident" id="4535332">funcMap</span><span class="op" id="4535339">[</span><span class="ident" id="4535340">name</span><span class="op" id="4535344">]</span>&nbsp;<span class="op" id="4535346">!=</span>&nbsp;<span class="ident" id="4535349">nil</span>&nbsp;<span class="op" id="4535353">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535358">return</span>&nbsp;<span class="ident" id="4535365">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4535372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4535375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535378">return</span>&nbsp;<span class="ident" id="4535385">false</span><br>
<span class="lineno"></span><span class="op" id="4535391">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="comment" id="4535394">//&nbsp;popVars&nbsp;trims&nbsp;the&nbsp;variable&nbsp;list&nbsp;to&nbsp;the&nbsp;specified&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="4535453">func</span>&nbsp;<span class="op" id="4535458">(</span><span class="ident" id="4535459">t</span>&nbsp;<span class="op" id="4535461">*</span><span class="ident" id="4535462">Tree</span><span class="op" id="4535466">)</span>&nbsp;<span class="ident" id="4535468">popVars</span><span class="op" id="4535475">(</span><span class="ident" id="4535476">n</span>&nbsp;<span class="builtintype" id="4535478">int</span><span class="op" id="4535481">)</span>&nbsp;<span class="op" id="4535483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4535486">t</span><span class="op" id="4535487">.</span><span class="ident" id="4535488">vars</span>&nbsp;<span class="op" id="4535493">=</span>&nbsp;<span class="ident" id="4535495">t</span><span class="op" id="4535496">.</span><span class="ident" id="4535497">vars</span><span class="op" id="4535501">[</span><span class="op" id="4535502">:</span><span class="ident" id="4535503">n</span><span class="op" id="4535504">]</span><br>
<span class="lineno"></span><span class="op" id="4535506">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="4535509">//&nbsp;useVar&nbsp;returns&nbsp;a&nbsp;node&nbsp;for&nbsp;a&nbsp;variable&nbsp;reference.&nbsp;It&nbsp;errors&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4535577">//&nbsp;variable&nbsp;is&nbsp;not&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="4535605">func</span>&nbsp;<span class="op" id="4535610">(</span><span class="ident" id="4535611">t</span>&nbsp;<span class="op" id="4535613">*</span><span class="ident" id="4535614">Tree</span><span class="op" id="4535618">)</span>&nbsp;<span class="ident" id="4535620">useVar</span><span class="op" id="4535626">(</span><span class="ident" id="4535627">pos</span>&nbsp;<span class="ident" id="4535631">Pos</span><span class="op" id="4535634">,</span>&nbsp;<span class="ident" id="4535636">name</span>&nbsp;<span class="builtintype" id="4535641">string</span><span class="op" id="4535647">)</span>&nbsp;<span class="ident" id="4535649">Node</span>&nbsp;<span class="op" id="4535654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4535657">v</span>&nbsp;<span class="op" id="4535659">:=</span>&nbsp;<span class="ident" id="4535662">t</span><span class="op" id="4535663">.</span><span class="ident" id="4535664">newVariable</span><span class="op" id="4535675">(</span><span class="ident" id="4535676">pos</span><span class="op" id="4535679">,</span>&nbsp;<span class="ident" id="4535681">name</span><span class="op" id="4535685">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535688">for</span>&nbsp;<span class="ident" id="4535692">_</span><span class="op" id="4535693">,</span>&nbsp;<span class="ident" id="4535695">varName</span>&nbsp;<span class="op" id="4535703">:=</span>&nbsp;<span class="keyword" id="4535706">range</span>&nbsp;<span class="ident" id="4535712">t</span><span class="op" id="4535713">.</span><span class="ident" id="4535714">vars</span>&nbsp;<span class="op" id="4535719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535723">if</span>&nbsp;<span class="ident" id="4535726">varName</span>&nbsp;<span class="op" id="4535734">==</span>&nbsp;<span class="ident" id="4535737">v</span><span class="op" id="4535738">.</span><span class="ident" id="4535739">Ident</span><span class="op" id="4535744">[</span><span class="num" id="4535745">0</span><span class="op" id="4535746">]</span>&nbsp;<span class="op" id="4535748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535753">return</span>&nbsp;<span class="ident" id="4535760">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4535764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4535767">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4535770">t</span><span class="op" id="4535771">.</span><span class="ident" id="4535772">errorf</span><span class="op" id="4535778">(</span><span class="string" id="4535779">&#34;undefined&nbsp;variable&nbsp;%q&#34;</span><span class="op" id="4535802">,</span>&nbsp;<span class="ident" id="4535804">v</span><span class="op" id="4535805">.</span><span class="ident" id="4535806">Ident</span><span class="op" id="4535811">[</span><span class="num" id="4535812">0</span><span class="op" id="4535813">]</span><span class="op" id="4535814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535817">return</span>&nbsp;<span class="ident" id="4535824">nil</span><br>
<span class="lineno"></span><span class="op" id="4535828">}</span>
</div>
</body>
</html>
