<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html" class="current">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6264954">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6265009">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6265063">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6265114">//&nbsp;Package&nbsp;fcgi&nbsp;implements&nbsp;the&nbsp;FastCGI&nbsp;protocol.</span><br>
<span class="lineno"></span><span class="comment" id="6265163">//&nbsp;Currently&nbsp;only&nbsp;the&nbsp;responder&nbsp;role&nbsp;is&nbsp;supported.</span><br>
<span class="lineno"></span><span class="comment" id="6265214">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;defined&nbsp;at&nbsp;http://www.fastcgi.com/drupal/node/6?q=node/22</span><br>
<span class="lineno"></span><span class="keyword" id="6265291">package</span>&nbsp;<span class="ident" id="6265299">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="6265305">//&nbsp;This&nbsp;file&nbsp;defines&nbsp;the&nbsp;raw&nbsp;protocol&nbsp;and&nbsp;some&nbsp;utilities&nbsp;used&nbsp;by&nbsp;the&nbsp;child&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6265384">//&nbsp;the&nbsp;host.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6265398">import</span>&nbsp;<span class="op" id="6265405">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6265408">&#34;bufio&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6265417">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6265426">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6265445">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6265455">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6265461">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="6265468">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6265471">//&nbsp;recType&nbsp;is&nbsp;a&nbsp;record&nbsp;type,&nbsp;as&nbsp;defined&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="6265514">//&nbsp;http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S8</span><br>
<span class="lineno"></span><span class="keyword" id="6265569">type</span>&nbsp;<span class="ident" id="6265574">recType</span>&nbsp;<span class="builtintype" id="6265582">uint8</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6265589">const</span>&nbsp;<span class="op" id="6265595">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265598">typeBeginRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265618">recType</span>&nbsp;<span class="op" id="6265626">=</span>&nbsp;<span class="num" id="6265628">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265631">typeAbortRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265651">recType</span>&nbsp;<span class="op" id="6265659">=</span>&nbsp;<span class="num" id="6265661">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265664">typeEndRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265684">recType</span>&nbsp;<span class="op" id="6265692">=</span>&nbsp;<span class="num" id="6265694">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265697">typeParams</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265717">recType</span>&nbsp;<span class="op" id="6265725">=</span>&nbsp;<span class="num" id="6265727">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265730">typeStdin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265750">recType</span>&nbsp;<span class="op" id="6265758">=</span>&nbsp;<span class="num" id="6265760">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265763">typeStdout</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265783">recType</span>&nbsp;<span class="op" id="6265791">=</span>&nbsp;<span class="num" id="6265793">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265796">typeStderr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265816">recType</span>&nbsp;<span class="op" id="6265824">=</span>&nbsp;<span class="num" id="6265826">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265829">typeData</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265849">recType</span>&nbsp;<span class="op" id="6265857">=</span>&nbsp;<span class="num" id="6265859">8</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265862">typeGetValues</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265882">recType</span>&nbsp;<span class="op" id="6265890">=</span>&nbsp;<span class="num" id="6265892">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265895">typeGetValuesResult</span>&nbsp;<span class="ident" id="6265915">recType</span>&nbsp;<span class="op" id="6265923">=</span>&nbsp;<span class="num" id="6265925">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265929">typeUnknownType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6265949">recType</span>&nbsp;<span class="op" id="6265957">=</span>&nbsp;<span class="num" id="6265959">11</span><br>
<span class="lineno"></span><span class="op" id="6265962">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="6265965">//&nbsp;keep&nbsp;the&nbsp;connection&nbsp;between&nbsp;web-server&nbsp;and&nbsp;responder&nbsp;open&nbsp;after&nbsp;request</span><br>
<span class="lineno"></span><span class="keyword" id="6266040">const</span>&nbsp;<span class="ident" id="6266046">flagKeepConn</span>&nbsp;<span class="op" id="6266059">=</span>&nbsp;<span class="num" id="6266061">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6266064">const</span>&nbsp;<span class="op" id="6266070">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266073">maxWrite</span>&nbsp;<span class="op" id="6266082">=</span>&nbsp;<span class="num" id="6266084">65535</span>&nbsp;<span class="comment" id="6266090">//&nbsp;maximum&nbsp;record&nbsp;body</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266114">maxPad</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6266123">=</span>&nbsp;<span class="num" id="6266125">255</span><br>
<span class="lineno"></span><span class="op" id="6266129">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6266132">const</span>&nbsp;<span class="op" id="6266138">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266141">roleResponder</span>&nbsp;<span class="op" id="6266155">=</span>&nbsp;<span class="ident" id="6266157">iota</span>&nbsp;<span class="op" id="6266162">+</span>&nbsp;<span class="num" id="6266164">1</span>&nbsp;<span class="comment" id="6266166">//&nbsp;only&nbsp;Responders&nbsp;are&nbsp;implemented.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266203">roleAuthorizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266219">roleFilter</span><br>
<span class="lineno"></span><span class="op" id="6266230">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6266233">const</span>&nbsp;<span class="op" id="6266239">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266242">statusRequestComplete</span>&nbsp;<span class="op" id="6266264">=</span>&nbsp;<span class="ident" id="6266266">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266272">statusCantMultiplex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266293">statusOverloaded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266311">statusUnknownRole</span><br>
<span class="lineno"></span><span class="op" id="6266329">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6266332">const</span>&nbsp;<span class="ident" id="6266338">headerLen</span>&nbsp;<span class="op" id="6266348">=</span>&nbsp;<span class="num" id="6266350">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6266353">type</span>&nbsp;<span class="ident" id="6266358">header</span>&nbsp;<span class="keyword" id="6266365">struct</span>&nbsp;<span class="op" id="6266372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266375">Version</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6266389">uint8</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266396">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266410">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266419">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6266433">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266441">ContentLength</span>&nbsp;<span class="builtintype" id="6266455">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266463">PaddingLength</span>&nbsp;<span class="builtintype" id="6266477">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266484">Reserved</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6266498">uint8</span><br>
<span class="lineno">70</span><span class="op" id="6266504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6266507">type</span>&nbsp;<span class="ident" id="6266512">beginRequest</span>&nbsp;<span class="keyword" id="6266525">struct</span>&nbsp;<span class="op" id="6266532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266535">role</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6266544">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266552">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6266561">uint8</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266568">reserved</span>&nbsp;<span class="op" id="6266577">[</span><span class="num" id="6266578">5</span><span class="op" id="6266579">]</span><span class="builtintype" id="6266580">uint8</span><br>
<span class="lineno"></span><span class="op" id="6266586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6266589">func</span>&nbsp;<span class="op" id="6266594">(</span><span class="ident" id="6266595">br</span>&nbsp;<span class="op" id="6266598">*</span><span class="ident" id="6266599">beginRequest</span><span class="op" id="6266611">)</span>&nbsp;<span class="ident" id="6266613">read</span><span class="op" id="6266617">(</span><span class="ident" id="6266618">content</span>&nbsp;<span class="op" id="6266626">[</span><span class="op" id="6266627">]</span><span class="builtintype" id="6266628">byte</span><span class="op" id="6266632">)</span>&nbsp;<span class="builtintype" id="6266634">error</span>&nbsp;<span class="op" id="6266640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6266643">if</span>&nbsp;<span class="builtinfunc" id="6266646">len</span><span class="op" id="6266649">(</span><span class="ident" id="6266650">content</span><span class="op" id="6266657">)</span>&nbsp;<span class="op" id="6266659">!=</span>&nbsp;<span class="num" id="6266662">8</span>&nbsp;<span class="op" id="6266664">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6266668">return</span>&nbsp;<span class="ident" id="6266675">errors</span><span class="op" id="6266681">.</span><span class="ident" id="6266682">New</span><span class="op" id="6266685">(</span><span class="string" id="6266686">&#34;fcgi:&nbsp;invalid&nbsp;begin&nbsp;request&nbsp;record&#34;</span><span class="op" id="6266722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6266725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266728">br</span><span class="op" id="6266730">.</span><span class="ident" id="6266731">role</span>&nbsp;<span class="op" id="6266736">=</span>&nbsp;<span class="ident" id="6266738">binary</span><span class="op" id="6266744">.</span><span class="ident" id="6266745">BigEndian</span><span class="op" id="6266754">.</span><span class="ident" id="6266755">Uint16</span><span class="op" id="6266761">(</span><span class="ident" id="6266762">content</span><span class="op" id="6266769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6266772">br</span><span class="op" id="6266774">.</span><span class="ident" id="6266775">flags</span>&nbsp;<span class="op" id="6266781">=</span>&nbsp;<span class="ident" id="6266783">content</span><span class="op" id="6266790">[</span><span class="num" id="6266791">2</span><span class="op" id="6266792">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6266795">return</span>&nbsp;<span class="builtintype" id="6266802">nil</span><br>
<span class="lineno">85</span><span class="op" id="6266806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6266809">//&nbsp;for&nbsp;padding&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to&nbsp;allocate&nbsp;all&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="6266866">//&nbsp;not&nbsp;synchronized&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;care&nbsp;what&nbsp;the&nbsp;contents&nbsp;are</span><br>
<span class="lineno"></span><span class="keyword" id="6266930">var</span>&nbsp;<span class="ident" id="6266934">pad</span>&nbsp;<span class="op" id="6266938">[</span><span class="ident" id="6266939">maxPad</span><span class="op" id="6266945">]</span><span class="builtintype" id="6266946">byte</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="6266952">func</span>&nbsp;<span class="op" id="6266957">(</span><span class="ident" id="6266958">h</span>&nbsp;<span class="op" id="6266960">*</span><span class="ident" id="6266961">header</span><span class="op" id="6266967">)</span>&nbsp;<span class="ident" id="6266969">init</span><span class="op" id="6266973">(</span><span class="ident" id="6266974">recType</span>&nbsp;<span class="ident" id="6266982">recType</span><span class="op" id="6266989">,</span>&nbsp;<span class="ident" id="6266991">reqId</span>&nbsp;<span class="builtintype" id="6266997">uint16</span><span class="op" id="6267003">,</span>&nbsp;<span class="ident" id="6267005">contentLength</span>&nbsp;<span class="builtintype" id="6267019">int</span><span class="op" id="6267022">)</span>&nbsp;<span class="op" id="6267024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6267027">h</span><span class="op" id="6267028">.</span><span class="ident" id="6267029">Version</span>&nbsp;<span class="op" id="6267037">=</span>&nbsp;<span class="num" id="6267039">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6267042">h</span><span class="op" id="6267043">.</span><span class="ident" id="6267044">Type</span>&nbsp;<span class="op" id="6267049">=</span>&nbsp;<span class="ident" id="6267051">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6267060">h</span><span class="op" id="6267061">.</span><span class="ident" id="6267062">Id</span>&nbsp;<span class="op" id="6267065">=</span>&nbsp;<span class="ident" id="6267067">reqId</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6267074">h</span><span class="op" id="6267075">.</span><span class="ident" id="6267076">ContentLength</span>&nbsp;<span class="op" id="6267090">=</span>&nbsp;<span class="builtintype" id="6267092">uint16</span><span class="op" id="6267098">(</span><span class="ident" id="6267099">contentLength</span><span class="op" id="6267112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6267115">h</span><span class="op" id="6267116">.</span><span class="ident" id="6267117">PaddingLength</span>&nbsp;<span class="op" id="6267131">=</span>&nbsp;<span class="builtintype" id="6267133">uint8</span><span class="op" id="6267138">(</span><span class="op" id="6267139">-</span><span class="ident" id="6267140">contentLength</span>&nbsp;<span class="op" id="6267154">&amp;</span>&nbsp;<span class="num" id="6267156">7</span><span class="op" id="6267157">)</span><br>
<span class="lineno"></span><span class="op" id="6267159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6267162">//&nbsp;conn&nbsp;sends&nbsp;records&nbsp;over&nbsp;rwc</span><br>
<span class="lineno">100</span><span class="keyword" id="6267193">type</span>&nbsp;<span class="ident" id="6267198">conn</span>&nbsp;<span class="keyword" id="6267203">struct</span>&nbsp;<span class="op" id="6267210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6267213">mutex</span>&nbsp;<span class="ident" id="6267219">sync</span><span class="op" id="6267223">.</span><span class="ident" id="6267224">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6267231">rwc</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6267237">io</span><span class="op" id="6267239">.</span><span class="ident" id="6267240">ReadWriteCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6267258">//&nbsp;to&nbsp;avoid&nbsp;allocations</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6267283">buf</span>&nbsp;<span class="ident" id="6267287">bytes</span><span class="op" id="6267292">.</span><span class="ident" id="6267293">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6267301">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6267305">header</span><br>
<span class="lineno"></span><span class="op" id="6267312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6267315">func</span>&nbsp;<span class="ident" id="6267320">newConn</span><span class="op" id="6267327">(</span><span class="ident" id="6267328">rwc</span>&nbsp;<span class="ident" id="6267332">io</span><span class="op" id="6267334">.</span><span class="ident" id="6267335">ReadWriteCloser</span><span class="op" id="6267350">)</span>&nbsp;<span class="op" id="6267352">*</span><span class="ident" id="6267353">conn</span>&nbsp;<span class="op" id="6267358">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6267361">return</span>&nbsp;<span class="op" id="6267368">&amp;</span><span class="ident" id="6267369">conn</span><span class="op" id="6267373">{</span><span class="ident" id="6267374">rwc</span><span class="op" id="6267377">:</span>&nbsp;<span class="ident" id="6267379">rwc</span><span class="op" id="6267382">}</span><br>
<span class="lineno"></span><span class="op" id="6267384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6267387">func</span>&nbsp;<span class="op" id="6267392">(</span><span class="ident" id="6267393">c</span>&nbsp;<span class="op" id="6267395">*</span><span class="ident" id="6267396">conn</span><span class="op" id="6267400">)</span>&nbsp;<span class="ident" id="6267402">Close</span><span class="op" id="6267407">(</span><span class="op" id="6267408">)</span>&nbsp;<span class="builtintype" id="6267410">error</span>&nbsp;<span class="op" id="6267416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6267419">c</span><span class="op" id="6267420">.</span><span class="ident" id="6267421">mutex</span><span class="op" id="6267426">.</span><span class="ident" id="6267427">Lock</span><span class="op" id="6267431">(</span><span class="op" id="6267432">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6267435">defer</span>&nbsp;<span class="ident" id="6267441">c</span><span class="op" id="6267442">.</span><span class="ident" id="6267443">mutex</span><span class="op" id="6267448">.</span><span class="ident" id="6267449">Unlock</span><span class="op" id="6267455">(</span><span class="op" id="6267456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6267459">return</span>&nbsp;<span class="ident" id="6267466">c</span><span class="op" id="6267467">.</span><span class="ident" id="6267468">rwc</span><span class="op" id="6267471">.</span><span class="ident" id="6267472">Close</span><span class="op" id="6267477">(</span><span class="op" id="6267478">)</span><br>
<span class="lineno"></span><span class="op" id="6267480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6267483">type</span>&nbsp;<span class="ident" id="6267488">record</span>&nbsp;<span class="keyword" id="6267495">struct</span>&nbsp;<span class="op" id="6267502">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6267505">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6267509">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6267517">buf</span>&nbsp;<span class="op" id="6267521">[</span><span class="ident" id="6267522">maxWrite</span>&nbsp;<span class="op" id="6267531">+</span>&nbsp;<span class="ident" id="6267533">maxPad</span><span class="op" id="6267539">]</span><span class="builtintype" id="6267540">byte</span><br>
<span class="lineno"></span><span class="op" id="6267545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6267548">func</span>&nbsp;<span class="op" id="6267553">(</span><span class="ident" id="6267554">rec</span>&nbsp;<span class="op" id="6267558">*</span><span class="ident" id="6267559">record</span><span class="op" id="6267565">)</span>&nbsp;<span class="ident" id="6267567">read</span><span class="op" id="6267571">(</span><span class="ident" id="6267572">r</span>&nbsp;<span class="ident" id="6267574">io</span><span class="op" id="6267576">.</span><span class="ident" id="6267577">Reader</span><span class="op" id="6267583">)</span>&nbsp;<span class="op" id="6267585">(</span><span class="ident" id="6267586">err</span>&nbsp;<span class="builtintype" id="6267590">error</span><span class="op" id="6267595">)</span>&nbsp;<span class="op" id="6267597">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6267600">if</span>&nbsp;<span class="ident" id="6267603">err</span>&nbsp;<span class="op" id="6267607">=</span>&nbsp;<span class="ident" id="6267609">binary</span><span class="op" id="6267615">.</span><span class="ident" id="6267616">Read</span><span class="op" id="6267620">(</span><span class="ident" id="6267621">r</span><span class="op" id="6267622">,</span>&nbsp;<span class="ident" id="6267624">binary</span><span class="op" id="6267630">.</span><span class="ident" id="6267631">BigEndian</span><span class="op" id="6267640">,</span>&nbsp;<span class="op" id="6267642">&amp;</span><span class="ident" id="6267643">rec</span><span class="op" id="6267646">.</span><span class="ident" id="6267647">h</span><span class="op" id="6267648">)</span><span class="op" id="6267649">;</span>&nbsp;<span class="ident" id="6267651">err</span>&nbsp;<span class="op" id="6267655">!=</span>&nbsp;<span class="builtintype" id="6267658">nil</span>&nbsp;<span class="op" id="6267662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6267666">return</span>&nbsp;<span class="ident" id="6267673">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6267678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6267681">if</span>&nbsp;<span class="ident" id="6267684">rec</span><span class="op" id="6267687">.</span><span class="ident" id="6267688">h</span><span class="op" id="6267689">.</span><span class="ident" id="6267690">Version</span>&nbsp;<span class="op" id="6267698">!=</span>&nbsp;<span class="num" id="6267701">1</span>&nbsp;<span class="op" id="6267703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6267707">return</span>&nbsp;<span class="ident" id="6267714">errors</span><span class="op" id="6267720">.</span><span class="ident" id="6267721">New</span><span class="op" id="6267724">(</span><span class="string" id="6267725">&#34;fcgi:&nbsp;invalid&nbsp;header&nbsp;version&#34;</span><span class="op" id="6267755">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6267758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6267761">n</span>&nbsp;<span class="op" id="6267763">:=</span>&nbsp;<span class="builtintype" id="6267766">int</span><span class="op" id="6267769">(</span><span class="ident" id="6267770">rec</span><span class="op" id="6267773">.</span><span class="ident" id="6267774">h</span><span class="op" id="6267775">.</span><span class="ident" id="6267776">ContentLength</span><span class="op" id="6267789">)</span>&nbsp;<span class="op" id="6267791">+</span>&nbsp;<span class="builtintype" id="6267793">int</span><span class="op" id="6267796">(</span><span class="ident" id="6267797">rec</span><span class="op" id="6267800">.</span><span class="ident" id="6267801">h</span><span class="op" id="6267802">.</span><span class="ident" id="6267803">PaddingLength</span><span class="op" id="6267816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6267819">if</span>&nbsp;<span class="ident" id="6267822">_</span><span class="op" id="6267823">,</span>&nbsp;<span class="ident" id="6267825">err</span>&nbsp;<span class="op" id="6267829">=</span>&nbsp;<span class="ident" id="6267831">io</span><span class="op" id="6267833">.</span><span class="ident" id="6267834">ReadFull</span><span class="op" id="6267842">(</span><span class="ident" id="6267843">r</span><span class="op" id="6267844">,</span>&nbsp;<span class="ident" id="6267846">rec</span><span class="op" id="6267849">.</span><span class="ident" id="6267850">buf</span><span class="op" id="6267853">[</span><span class="op" id="6267854">:</span><span class="ident" id="6267855">n</span><span class="op" id="6267856">]</span><span class="op" id="6267857">)</span><span class="op" id="6267858">;</span>&nbsp;<span class="ident" id="6267860">err</span>&nbsp;<span class="op" id="6267864">!=</span>&nbsp;<span class="builtintype" id="6267867">nil</span>&nbsp;<span class="op" id="6267871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6267875">return</span>&nbsp;<span class="ident" id="6267882">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6267887">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6267890">return</span>&nbsp;<span class="builtintype" id="6267897">nil</span><br>
<span class="lineno"></span><span class="op" id="6267901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6267904">func</span>&nbsp;<span class="op" id="6267909">(</span><span class="ident" id="6267910">r</span>&nbsp;<span class="op" id="6267912">*</span><span class="ident" id="6267913">record</span><span class="op" id="6267919">)</span>&nbsp;<span class="ident" id="6267921">content</span><span class="op" id="6267928">(</span><span class="op" id="6267929">)</span>&nbsp;<span class="op" id="6267931">[</span><span class="op" id="6267932">]</span><span class="builtintype" id="6267933">byte</span>&nbsp;<span class="op" id="6267938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6267941">return</span>&nbsp;<span class="ident" id="6267948">r</span><span class="op" id="6267949">.</span><span class="ident" id="6267950">buf</span><span class="op" id="6267953">[</span><span class="op" id="6267954">:</span><span class="ident" id="6267955">r</span><span class="op" id="6267956">.</span><span class="ident" id="6267957">h</span><span class="op" id="6267958">.</span><span class="ident" id="6267959">ContentLength</span><span class="op" id="6267972">]</span><br>
<span class="lineno">140</span><span class="op" id="6267974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6267977">//&nbsp;writeRecord&nbsp;writes&nbsp;and&nbsp;sends&nbsp;a&nbsp;single&nbsp;record.</span><br>
<span class="lineno"></span><span class="keyword" id="6268026">func</span>&nbsp;<span class="op" id="6268031">(</span><span class="ident" id="6268032">c</span>&nbsp;<span class="op" id="6268034">*</span><span class="ident" id="6268035">conn</span><span class="op" id="6268039">)</span>&nbsp;<span class="ident" id="6268041">writeRecord</span><span class="op" id="6268052">(</span><span class="ident" id="6268053">recType</span>&nbsp;<span class="ident" id="6268061">recType</span><span class="op" id="6268068">,</span>&nbsp;<span class="ident" id="6268070">reqId</span>&nbsp;<span class="builtintype" id="6268076">uint16</span><span class="op" id="6268082">,</span>&nbsp;<span class="ident" id="6268084">b</span>&nbsp;<span class="op" id="6268086">[</span><span class="op" id="6268087">]</span><span class="builtintype" id="6268088">byte</span><span class="op" id="6268092">)</span>&nbsp;<span class="builtintype" id="6268094">error</span>&nbsp;<span class="op" id="6268100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6268103">c</span><span class="op" id="6268104">.</span><span class="ident" id="6268105">mutex</span><span class="op" id="6268110">.</span><span class="ident" id="6268111">Lock</span><span class="op" id="6268115">(</span><span class="op" id="6268116">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6268119">defer</span>&nbsp;<span class="ident" id="6268125">c</span><span class="op" id="6268126">.</span><span class="ident" id="6268127">mutex</span><span class="op" id="6268132">.</span><span class="ident" id="6268133">Unlock</span><span class="op" id="6268139">(</span><span class="op" id="6268140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6268143">c</span><span class="op" id="6268144">.</span><span class="ident" id="6268145">buf</span><span class="op" id="6268148">.</span><span class="ident" id="6268149">Reset</span><span class="op" id="6268154">(</span><span class="op" id="6268155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6268158">c</span><span class="op" id="6268159">.</span><span class="ident" id="6268160">h</span><span class="op" id="6268161">.</span><span class="ident" id="6268162">init</span><span class="op" id="6268166">(</span><span class="ident" id="6268167">recType</span><span class="op" id="6268174">,</span>&nbsp;<span class="ident" id="6268176">reqId</span><span class="op" id="6268181">,</span>&nbsp;<span class="builtinfunc" id="6268183">len</span><span class="op" id="6268186">(</span><span class="ident" id="6268187">b</span><span class="op" id="6268188">)</span><span class="op" id="6268189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6268192">if</span>&nbsp;<span class="ident" id="6268195">err</span>&nbsp;<span class="op" id="6268199">:=</span>&nbsp;<span class="ident" id="6268202">binary</span><span class="op" id="6268208">.</span><span class="ident" id="6268209">Write</span><span class="op" id="6268214">(</span><span class="op" id="6268215">&amp;</span><span class="ident" id="6268216">c</span><span class="op" id="6268217">.</span><span class="ident" id="6268218">buf</span><span class="op" id="6268221">,</span>&nbsp;<span class="ident" id="6268223">binary</span><span class="op" id="6268229">.</span><span class="ident" id="6268230">BigEndian</span><span class="op" id="6268239">,</span>&nbsp;<span class="ident" id="6268241">c</span><span class="op" id="6268242">.</span><span class="ident" id="6268243">h</span><span class="op" id="6268244">)</span><span class="op" id="6268245">;</span>&nbsp;<span class="ident" id="6268247">err</span>&nbsp;<span class="op" id="6268251">!=</span>&nbsp;<span class="builtintype" id="6268254">nil</span>&nbsp;<span class="op" id="6268258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6268262">return</span>&nbsp;<span class="ident" id="6268269">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6268274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6268277">if</span>&nbsp;<span class="ident" id="6268280">_</span><span class="op" id="6268281">,</span>&nbsp;<span class="ident" id="6268283">err</span>&nbsp;<span class="op" id="6268287">:=</span>&nbsp;<span class="ident" id="6268290">c</span><span class="op" id="6268291">.</span><span class="ident" id="6268292">buf</span><span class="op" id="6268295">.</span><span class="ident" id="6268296">Write</span><span class="op" id="6268301">(</span><span class="ident" id="6268302">b</span><span class="op" id="6268303">)</span><span class="op" id="6268304">;</span>&nbsp;<span class="ident" id="6268306">err</span>&nbsp;<span class="op" id="6268310">!=</span>&nbsp;<span class="builtintype" id="6268313">nil</span>&nbsp;<span class="op" id="6268317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6268321">return</span>&nbsp;<span class="ident" id="6268328">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6268333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6268336">if</span>&nbsp;<span class="ident" id="6268339">_</span><span class="op" id="6268340">,</span>&nbsp;<span class="ident" id="6268342">err</span>&nbsp;<span class="op" id="6268346">:=</span>&nbsp;<span class="ident" id="6268349">c</span><span class="op" id="6268350">.</span><span class="ident" id="6268351">buf</span><span class="op" id="6268354">.</span><span class="ident" id="6268355">Write</span><span class="op" id="6268360">(</span><span class="ident" id="6268361">pad</span><span class="op" id="6268364">[</span><span class="op" id="6268365">:</span><span class="ident" id="6268366">c</span><span class="op" id="6268367">.</span><span class="ident" id="6268368">h</span><span class="op" id="6268369">.</span><span class="ident" id="6268370">PaddingLength</span><span class="op" id="6268383">]</span><span class="op" id="6268384">)</span><span class="op" id="6268385">;</span>&nbsp;<span class="ident" id="6268387">err</span>&nbsp;<span class="op" id="6268391">!=</span>&nbsp;<span class="builtintype" id="6268394">nil</span>&nbsp;<span class="op" id="6268398">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6268402">return</span>&nbsp;<span class="ident" id="6268409">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6268414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6268417">_</span><span class="op" id="6268418">,</span>&nbsp;<span class="ident" id="6268420">err</span>&nbsp;<span class="op" id="6268424">:=</span>&nbsp;<span class="ident" id="6268427">c</span><span class="op" id="6268428">.</span><span class="ident" id="6268429">rwc</span><span class="op" id="6268432">.</span><span class="ident" id="6268433">Write</span><span class="op" id="6268438">(</span><span class="ident" id="6268439">c</span><span class="op" id="6268440">.</span><span class="ident" id="6268441">buf</span><span class="op" id="6268444">.</span><span class="ident" id="6268445">Bytes</span><span class="op" id="6268450">(</span><span class="op" id="6268451">)</span><span class="op" id="6268452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6268455">return</span>&nbsp;<span class="ident" id="6268462">err</span><br>
<span class="lineno"></span><span class="op" id="6268466">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="keyword" id="6268469">func</span>&nbsp;<span class="op" id="6268474">(</span><span class="ident" id="6268475">c</span>&nbsp;<span class="op" id="6268477">*</span><span class="ident" id="6268478">conn</span><span class="op" id="6268482">)</span>&nbsp;<span class="ident" id="6268484">writeBeginRequest</span><span class="op" id="6268501">(</span><span class="ident" id="6268502">reqId</span>&nbsp;<span class="builtintype" id="6268508">uint16</span><span class="op" id="6268514">,</span>&nbsp;<span class="ident" id="6268516">role</span>&nbsp;<span class="builtintype" id="6268521">uint16</span><span class="op" id="6268527">,</span>&nbsp;<span class="ident" id="6268529">flags</span>&nbsp;<span class="builtintype" id="6268535">uint8</span><span class="op" id="6268540">)</span>&nbsp;<span class="builtintype" id="6268542">error</span>&nbsp;<span class="op" id="6268548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6268551">b</span>&nbsp;<span class="op" id="6268553">:=</span>&nbsp;<span class="op" id="6268556">[</span><span class="num" id="6268557">8</span><span class="op" id="6268558">]</span><span class="builtintype" id="6268559">byte</span><span class="op" id="6268563">{</span><span class="builtintype" id="6268564">byte</span><span class="op" id="6268568">(</span><span class="ident" id="6268569">role</span>&nbsp;<span class="op" id="6268574">&gt;&gt;</span>&nbsp;<span class="num" id="6268577">8</span><span class="op" id="6268578">)</span><span class="op" id="6268579">,</span>&nbsp;<span class="builtintype" id="6268581">byte</span><span class="op" id="6268585">(</span><span class="ident" id="6268586">role</span><span class="op" id="6268590">)</span><span class="op" id="6268591">,</span>&nbsp;<span class="ident" id="6268593">flags</span><span class="op" id="6268598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6268601">return</span>&nbsp;<span class="ident" id="6268608">c</span><span class="op" id="6268609">.</span><span class="ident" id="6268610">writeRecord</span><span class="op" id="6268621">(</span><span class="ident" id="6268622">typeBeginRequest</span><span class="op" id="6268638">,</span>&nbsp;<span class="ident" id="6268640">reqId</span><span class="op" id="6268645">,</span>&nbsp;<span class="ident" id="6268647">b</span><span class="op" id="6268648">[</span><span class="op" id="6268649">:</span><span class="op" id="6268650">]</span><span class="op" id="6268651">)</span><br>
<span class="lineno"></span><span class="op" id="6268653">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="6268656">func</span>&nbsp;<span class="op" id="6268661">(</span><span class="ident" id="6268662">c</span>&nbsp;<span class="op" id="6268664">*</span><span class="ident" id="6268665">conn</span><span class="op" id="6268669">)</span>&nbsp;<span class="ident" id="6268671">writeEndRequest</span><span class="op" id="6268686">(</span><span class="ident" id="6268687">reqId</span>&nbsp;<span class="builtintype" id="6268693">uint16</span><span class="op" id="6268699">,</span>&nbsp;<span class="ident" id="6268701">appStatus</span>&nbsp;<span class="builtintype" id="6268711">int</span><span class="op" id="6268714">,</span>&nbsp;<span class="ident" id="6268716">protocolStatus</span>&nbsp;<span class="builtintype" id="6268731">uint8</span><span class="op" id="6268736">)</span>&nbsp;<span class="builtintype" id="6268738">error</span>&nbsp;<span class="op" id="6268744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6268747">b</span>&nbsp;<span class="op" id="6268749">:=</span>&nbsp;<span class="builtinfunc" id="6268752">make</span><span class="op" id="6268756">(</span><span class="op" id="6268757">[</span><span class="op" id="6268758">]</span><span class="builtintype" id="6268759">byte</span><span class="op" id="6268763">,</span>&nbsp;<span class="num" id="6268765">8</span><span class="op" id="6268766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6268769">binary</span><span class="op" id="6268775">.</span><span class="ident" id="6268776">BigEndian</span><span class="op" id="6268785">.</span><span class="ident" id="6268786">PutUint32</span><span class="op" id="6268795">(</span><span class="ident" id="6268796">b</span><span class="op" id="6268797">,</span>&nbsp;<span class="builtintype" id="6268799">uint32</span><span class="op" id="6268805">(</span><span class="ident" id="6268806">appStatus</span><span class="op" id="6268815">)</span><span class="op" id="6268816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6268819">b</span><span class="op" id="6268820">[</span><span class="num" id="6268821">4</span><span class="op" id="6268822">]</span>&nbsp;<span class="op" id="6268824">=</span>&nbsp;<span class="ident" id="6268826">protocolStatus</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6268842">return</span>&nbsp;<span class="ident" id="6268849">c</span><span class="op" id="6268850">.</span><span class="ident" id="6268851">writeRecord</span><span class="op" id="6268862">(</span><span class="ident" id="6268863">typeEndRequest</span><span class="op" id="6268877">,</span>&nbsp;<span class="ident" id="6268879">reqId</span><span class="op" id="6268884">,</span>&nbsp;<span class="ident" id="6268886">b</span><span class="op" id="6268887">)</span><br>
<span class="lineno"></span><span class="op" id="6268889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6268892">func</span>&nbsp;<span class="op" id="6268897">(</span><span class="ident" id="6268898">c</span>&nbsp;<span class="op" id="6268900">*</span><span class="ident" id="6268901">conn</span><span class="op" id="6268905">)</span>&nbsp;<span class="ident" id="6268907">writePairs</span><span class="op" id="6268917">(</span><span class="ident" id="6268918">recType</span>&nbsp;<span class="ident" id="6268926">recType</span><span class="op" id="6268933">,</span>&nbsp;<span class="ident" id="6268935">reqId</span>&nbsp;<span class="builtintype" id="6268941">uint16</span><span class="op" id="6268947">,</span>&nbsp;<span class="ident" id="6268949">pairs</span>&nbsp;<span class="keyword" id="6268955">map</span><span class="op" id="6268958">[</span><span class="builtintype" id="6268959">string</span><span class="op" id="6268965">]</span><span class="builtintype" id="6268966">string</span><span class="op" id="6268972">)</span>&nbsp;<span class="builtintype" id="6268974">error</span>&nbsp;<span class="op" id="6268980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6268983">w</span>&nbsp;<span class="op" id="6268985">:=</span>&nbsp;<span class="ident" id="6268988">newWriter</span><span class="op" id="6268997">(</span><span class="ident" id="6268998">c</span><span class="op" id="6268999">,</span>&nbsp;<span class="ident" id="6269001">recType</span><span class="op" id="6269008">,</span>&nbsp;<span class="ident" id="6269010">reqId</span><span class="op" id="6269015">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6269018">b</span>&nbsp;<span class="op" id="6269020">:=</span>&nbsp;<span class="builtinfunc" id="6269023">make</span><span class="op" id="6269027">(</span><span class="op" id="6269028">[</span><span class="op" id="6269029">]</span><span class="builtintype" id="6269030">byte</span><span class="op" id="6269034">,</span>&nbsp;<span class="num" id="6269036">8</span><span class="op" id="6269037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269040">for</span>&nbsp;<span class="ident" id="6269044">k</span><span class="op" id="6269045">,</span>&nbsp;<span class="ident" id="6269047">v</span>&nbsp;<span class="op" id="6269049">:=</span>&nbsp;<span class="keyword" id="6269052">range</span>&nbsp;<span class="ident" id="6269058">pairs</span>&nbsp;<span class="op" id="6269064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6269068">n</span>&nbsp;<span class="op" id="6269070">:=</span>&nbsp;<span class="ident" id="6269073">encodeSize</span><span class="op" id="6269083">(</span><span class="ident" id="6269084">b</span><span class="op" id="6269085">,</span>&nbsp;<span class="builtintype" id="6269087">uint32</span><span class="op" id="6269093">(</span><span class="builtinfunc" id="6269094">len</span><span class="op" id="6269097">(</span><span class="ident" id="6269098">k</span><span class="op" id="6269099">)</span><span class="op" id="6269100">)</span><span class="op" id="6269101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6269105">n</span>&nbsp;<span class="op" id="6269107">+=</span>&nbsp;<span class="ident" id="6269110">encodeSize</span><span class="op" id="6269120">(</span><span class="ident" id="6269121">b</span><span class="op" id="6269122">[</span><span class="ident" id="6269123">n</span><span class="op" id="6269124">:</span><span class="op" id="6269125">]</span><span class="op" id="6269126">,</span>&nbsp;<span class="builtintype" id="6269128">uint32</span><span class="op" id="6269134">(</span><span class="builtinfunc" id="6269135">len</span><span class="op" id="6269138">(</span><span class="ident" id="6269139">v</span><span class="op" id="6269140">)</span><span class="op" id="6269141">)</span><span class="op" id="6269142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269146">if</span>&nbsp;<span class="ident" id="6269149">_</span><span class="op" id="6269150">,</span>&nbsp;<span class="ident" id="6269152">err</span>&nbsp;<span class="op" id="6269156">:=</span>&nbsp;<span class="ident" id="6269159">w</span><span class="op" id="6269160">.</span><span class="ident" id="6269161">Write</span><span class="op" id="6269166">(</span><span class="ident" id="6269167">b</span><span class="op" id="6269168">[</span><span class="op" id="6269169">:</span><span class="ident" id="6269170">n</span><span class="op" id="6269171">]</span><span class="op" id="6269172">)</span><span class="op" id="6269173">;</span>&nbsp;<span class="ident" id="6269175">err</span>&nbsp;<span class="op" id="6269179">!=</span>&nbsp;<span class="builtintype" id="6269182">nil</span>&nbsp;<span class="op" id="6269186">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269191">return</span>&nbsp;<span class="ident" id="6269198">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6269204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269208">if</span>&nbsp;<span class="ident" id="6269211">_</span><span class="op" id="6269212">,</span>&nbsp;<span class="ident" id="6269214">err</span>&nbsp;<span class="op" id="6269218">:=</span>&nbsp;<span class="ident" id="6269221">w</span><span class="op" id="6269222">.</span><span class="ident" id="6269223">WriteString</span><span class="op" id="6269234">(</span><span class="ident" id="6269235">k</span><span class="op" id="6269236">)</span><span class="op" id="6269237">;</span>&nbsp;<span class="ident" id="6269239">err</span>&nbsp;<span class="op" id="6269243">!=</span>&nbsp;<span class="builtintype" id="6269246">nil</span>&nbsp;<span class="op" id="6269250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269255">return</span>&nbsp;<span class="ident" id="6269262">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6269268">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269272">if</span>&nbsp;<span class="ident" id="6269275">_</span><span class="op" id="6269276">,</span>&nbsp;<span class="ident" id="6269278">err</span>&nbsp;<span class="op" id="6269282">:=</span>&nbsp;<span class="ident" id="6269285">w</span><span class="op" id="6269286">.</span><span class="ident" id="6269287">WriteString</span><span class="op" id="6269298">(</span><span class="ident" id="6269299">v</span><span class="op" id="6269300">)</span><span class="op" id="6269301">;</span>&nbsp;<span class="ident" id="6269303">err</span>&nbsp;<span class="op" id="6269307">!=</span>&nbsp;<span class="builtintype" id="6269310">nil</span>&nbsp;<span class="op" id="6269314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269319">return</span>&nbsp;<span class="ident" id="6269326">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6269332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6269335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6269338">w</span><span class="op" id="6269339">.</span><span class="ident" id="6269340">Close</span><span class="op" id="6269345">(</span><span class="op" id="6269346">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269349">return</span>&nbsp;<span class="builtintype" id="6269356">nil</span><br>
<span class="lineno"></span><span class="op" id="6269360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6269363">func</span>&nbsp;<span class="ident" id="6269368">readSize</span><span class="op" id="6269376">(</span><span class="ident" id="6269377">s</span>&nbsp;<span class="op" id="6269379">[</span><span class="op" id="6269380">]</span><span class="builtintype" id="6269381">byte</span><span class="op" id="6269385">)</span>&nbsp;<span class="op" id="6269387">(</span><span class="builtintype" id="6269388">uint32</span><span class="op" id="6269394">,</span>&nbsp;<span class="builtintype" id="6269396">int</span><span class="op" id="6269399">)</span>&nbsp;<span class="op" id="6269401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269404">if</span>&nbsp;<span class="builtinfunc" id="6269407">len</span><span class="op" id="6269410">(</span><span class="ident" id="6269411">s</span><span class="op" id="6269412">)</span>&nbsp;<span class="op" id="6269414">==</span>&nbsp;<span class="num" id="6269417">0</span>&nbsp;<span class="op" id="6269419">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269423">return</span>&nbsp;<span class="num" id="6269430">0</span><span class="op" id="6269431">,</span>&nbsp;<span class="num" id="6269433">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6269436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6269439">size</span><span class="op" id="6269443">,</span>&nbsp;<span class="ident" id="6269445">n</span>&nbsp;<span class="op" id="6269447">:=</span>&nbsp;<span class="builtintype" id="6269450">uint32</span><span class="op" id="6269456">(</span><span class="ident" id="6269457">s</span><span class="op" id="6269458">[</span><span class="num" id="6269459">0</span><span class="op" id="6269460">]</span><span class="op" id="6269461">)</span><span class="op" id="6269462">,</span>&nbsp;<span class="num" id="6269464">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269467">if</span>&nbsp;<span class="ident" id="6269470">size</span><span class="op" id="6269474">&amp;</span><span class="op" id="6269475">(</span><span class="num" id="6269476">1</span><span class="op" id="6269477">&lt;&lt;</span><span class="num" id="6269479">7</span><span class="op" id="6269480">)</span>&nbsp;<span class="op" id="6269482">!=</span>&nbsp;<span class="num" id="6269485">0</span>&nbsp;<span class="op" id="6269487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269491">if</span>&nbsp;<span class="builtinfunc" id="6269494">len</span><span class="op" id="6269497">(</span><span class="ident" id="6269498">s</span><span class="op" id="6269499">)</span>&nbsp;<span class="op" id="6269501">&lt;</span>&nbsp;<span class="num" id="6269503">4</span>&nbsp;<span class="op" id="6269505">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269510">return</span>&nbsp;<span class="num" id="6269517">0</span><span class="op" id="6269518">,</span>&nbsp;<span class="num" id="6269520">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6269524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6269528">n</span>&nbsp;<span class="op" id="6269530">=</span>&nbsp;<span class="num" id="6269532">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6269536">size</span>&nbsp;<span class="op" id="6269541">=</span>&nbsp;<span class="ident" id="6269543">binary</span><span class="op" id="6269549">.</span><span class="ident" id="6269550">BigEndian</span><span class="op" id="6269559">.</span><span class="ident" id="6269560">Uint32</span><span class="op" id="6269566">(</span><span class="ident" id="6269567">s</span><span class="op" id="6269568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6269572">size</span>&nbsp;<span class="op" id="6269577">&amp;^=</span>&nbsp;<span class="num" id="6269581">1</span>&nbsp;<span class="op" id="6269583">&lt;&lt;</span>&nbsp;<span class="num" id="6269586">31</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6269590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269593">return</span>&nbsp;<span class="ident" id="6269600">size</span><span class="op" id="6269604">,</span>&nbsp;<span class="ident" id="6269606">n</span><br>
<span class="lineno"></span><span class="op" id="6269608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6269611">func</span>&nbsp;<span class="ident" id="6269616">readString</span><span class="op" id="6269626">(</span><span class="ident" id="6269627">s</span>&nbsp;<span class="op" id="6269629">[</span><span class="op" id="6269630">]</span><span class="builtintype" id="6269631">byte</span><span class="op" id="6269635">,</span>&nbsp;<span class="ident" id="6269637">size</span>&nbsp;<span class="builtintype" id="6269642">uint32</span><span class="op" id="6269648">)</span>&nbsp;<span class="builtintype" id="6269650">string</span>&nbsp;<span class="op" id="6269657">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269660">if</span>&nbsp;<span class="ident" id="6269663">size</span>&nbsp;<span class="op" id="6269668">&gt;</span>&nbsp;<span class="builtintype" id="6269670">uint32</span><span class="op" id="6269676">(</span><span class="builtinfunc" id="6269677">len</span><span class="op" id="6269680">(</span><span class="ident" id="6269681">s</span><span class="op" id="6269682">)</span><span class="op" id="6269683">)</span>&nbsp;<span class="op" id="6269685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269689">return</span>&nbsp;<span class="string" id="6269696">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6269700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269703">return</span>&nbsp;<span class="builtintype" id="6269710">string</span><span class="op" id="6269716">(</span><span class="ident" id="6269717">s</span><span class="op" id="6269718">[</span><span class="op" id="6269719">:</span><span class="ident" id="6269720">size</span><span class="op" id="6269724">]</span><span class="op" id="6269725">)</span><br>
<span class="lineno"></span><span class="op" id="6269727">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6269730">func</span>&nbsp;<span class="ident" id="6269735">encodeSize</span><span class="op" id="6269745">(</span><span class="ident" id="6269746">b</span>&nbsp;<span class="op" id="6269748">[</span><span class="op" id="6269749">]</span><span class="builtintype" id="6269750">byte</span><span class="op" id="6269754">,</span>&nbsp;<span class="ident" id="6269756">size</span>&nbsp;<span class="builtintype" id="6269761">uint32</span><span class="op" id="6269767">)</span>&nbsp;<span class="builtintype" id="6269769">int</span>&nbsp;<span class="op" id="6269773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269776">if</span>&nbsp;<span class="ident" id="6269779">size</span>&nbsp;<span class="op" id="6269784">&gt;</span>&nbsp;<span class="num" id="6269786">127</span>&nbsp;<span class="op" id="6269790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6269794">size</span>&nbsp;<span class="op" id="6269799">|=</span>&nbsp;<span class="num" id="6269802">1</span>&nbsp;<span class="op" id="6269804">&lt;&lt;</span>&nbsp;<span class="num" id="6269807">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6269812">binary</span><span class="op" id="6269818">.</span><span class="ident" id="6269819">BigEndian</span><span class="op" id="6269828">.</span><span class="ident" id="6269829">PutUint32</span><span class="op" id="6269838">(</span><span class="ident" id="6269839">b</span><span class="op" id="6269840">,</span>&nbsp;<span class="ident" id="6269842">size</span><span class="op" id="6269846">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269850">return</span>&nbsp;<span class="num" id="6269857">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6269860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6269863">b</span><span class="op" id="6269864">[</span><span class="num" id="6269865">0</span><span class="op" id="6269866">]</span>&nbsp;<span class="op" id="6269868">=</span>&nbsp;<span class="builtintype" id="6269870">byte</span><span class="op" id="6269874">(</span><span class="ident" id="6269875">size</span><span class="op" id="6269879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6269882">return</span>&nbsp;<span class="num" id="6269889">1</span><br>
<span class="lineno"></span><span class="op" id="6269891">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="6269894">//&nbsp;bufWriter&nbsp;encapsulates&nbsp;bufio.Writer&nbsp;but&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;stream&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="6269976">//&nbsp;Closed.</span><br>
<span class="lineno"></span><span class="keyword" id="6269987">type</span>&nbsp;<span class="ident" id="6269992">bufWriter</span>&nbsp;<span class="keyword" id="6270002">struct</span>&nbsp;<span class="op" id="6270009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6270012">closer</span>&nbsp;<span class="ident" id="6270019">io</span><span class="op" id="6270021">.</span><span class="ident" id="6270022">Closer</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6270030">*</span><span class="ident" id="6270031">bufio</span><span class="op" id="6270036">.</span><span class="ident" id="6270037">Writer</span><br>
<span class="lineno"></span><span class="op" id="6270044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6270047">func</span>&nbsp;<span class="op" id="6270052">(</span><span class="ident" id="6270053">w</span>&nbsp;<span class="op" id="6270055">*</span><span class="ident" id="6270056">bufWriter</span><span class="op" id="6270065">)</span>&nbsp;<span class="ident" id="6270067">Close</span><span class="op" id="6270072">(</span><span class="op" id="6270073">)</span>&nbsp;<span class="builtintype" id="6270075">error</span>&nbsp;<span class="op" id="6270081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6270084">if</span>&nbsp;<span class="ident" id="6270087">err</span>&nbsp;<span class="op" id="6270091">:=</span>&nbsp;<span class="ident" id="6270094">w</span><span class="op" id="6270095">.</span><span class="ident" id="6270096">Writer</span><span class="op" id="6270102">.</span><span class="ident" id="6270103">Flush</span><span class="op" id="6270108">(</span><span class="op" id="6270109">)</span><span class="op" id="6270110">;</span>&nbsp;<span class="ident" id="6270112">err</span>&nbsp;<span class="op" id="6270116">!=</span>&nbsp;<span class="builtintype" id="6270119">nil</span>&nbsp;<span class="op" id="6270123">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6270127">w</span><span class="op" id="6270128">.</span><span class="ident" id="6270129">closer</span><span class="op" id="6270135">.</span><span class="ident" id="6270136">Close</span><span class="op" id="6270141">(</span><span class="op" id="6270142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6270146">return</span>&nbsp;<span class="ident" id="6270153">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6270158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6270161">return</span>&nbsp;<span class="ident" id="6270168">w</span><span class="op" id="6270169">.</span><span class="ident" id="6270170">closer</span><span class="op" id="6270176">.</span><span class="ident" id="6270177">Close</span><span class="op" id="6270182">(</span><span class="op" id="6270183">)</span><br>
<span class="lineno"></span><span class="op" id="6270185">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword" id="6270188">func</span>&nbsp;<span class="ident" id="6270193">newWriter</span><span class="op" id="6270202">(</span><span class="ident" id="6270203">c</span>&nbsp;<span class="op" id="6270205">*</span><span class="ident" id="6270206">conn</span><span class="op" id="6270210">,</span>&nbsp;<span class="ident" id="6270212">recType</span>&nbsp;<span class="ident" id="6270220">recType</span><span class="op" id="6270227">,</span>&nbsp;<span class="ident" id="6270229">reqId</span>&nbsp;<span class="builtintype" id="6270235">uint16</span><span class="op" id="6270241">)</span>&nbsp;<span class="op" id="6270243">*</span><span class="ident" id="6270244">bufWriter</span>&nbsp;<span class="op" id="6270254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6270257">s</span>&nbsp;<span class="op" id="6270259">:=</span>&nbsp;<span class="op" id="6270262">&amp;</span><span class="ident" id="6270263">streamWriter</span><span class="op" id="6270275">{</span><span class="ident" id="6270276">c</span><span class="op" id="6270277">:</span>&nbsp;<span class="ident" id="6270279">c</span><span class="op" id="6270280">,</span>&nbsp;<span class="ident" id="6270282">recType</span><span class="op" id="6270289">:</span>&nbsp;<span class="ident" id="6270291">recType</span><span class="op" id="6270298">,</span>&nbsp;<span class="ident" id="6270300">reqId</span><span class="op" id="6270305">:</span>&nbsp;<span class="ident" id="6270307">reqId</span><span class="op" id="6270312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6270315">w</span>&nbsp;<span class="op" id="6270317">:=</span>&nbsp;<span class="ident" id="6270320">bufio</span><span class="op" id="6270325">.</span><span class="ident" id="6270326">NewWriterSize</span><span class="op" id="6270339">(</span><span class="ident" id="6270340">s</span><span class="op" id="6270341">,</span>&nbsp;<span class="ident" id="6270343">maxWrite</span><span class="op" id="6270351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6270354">return</span>&nbsp;<span class="op" id="6270361">&amp;</span><span class="ident" id="6270362">bufWriter</span><span class="op" id="6270371">{</span><span class="ident" id="6270372">s</span><span class="op" id="6270373">,</span>&nbsp;<span class="ident" id="6270375">w</span><span class="op" id="6270376">}</span><br>
<span class="lineno">245</span><span class="op" id="6270378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6270381">//&nbsp;streamWriter&nbsp;abstracts&nbsp;out&nbsp;the&nbsp;separation&nbsp;of&nbsp;a&nbsp;stream&nbsp;into&nbsp;discrete&nbsp;records.</span><br>
<span class="lineno"></span><span class="comment" id="6270461">//&nbsp;It&nbsp;only&nbsp;writes&nbsp;maxWrite&nbsp;bytes&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="6270505">type</span>&nbsp;<span class="ident" id="6270510">streamWriter</span>&nbsp;<span class="keyword" id="6270523">struct</span>&nbsp;<span class="op" id="6270530">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6270533">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6270541">*</span><span class="ident" id="6270542">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6270548">recType</span>&nbsp;<span class="ident" id="6270556">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6270565">reqId</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6270573">uint16</span><br>
<span class="lineno"></span><span class="op" id="6270580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="6270583">func</span>&nbsp;<span class="op" id="6270588">(</span><span class="ident" id="6270589">w</span>&nbsp;<span class="op" id="6270591">*</span><span class="ident" id="6270592">streamWriter</span><span class="op" id="6270604">)</span>&nbsp;<span class="ident" id="6270606">Write</span><span class="op" id="6270611">(</span><span class="ident" id="6270612">p</span>&nbsp;<span class="op" id="6270614">[</span><span class="op" id="6270615">]</span><span class="builtintype" id="6270616">byte</span><span class="op" id="6270620">)</span>&nbsp;<span class="op" id="6270622">(</span><span class="builtintype" id="6270623">int</span><span class="op" id="6270626">,</span>&nbsp;<span class="builtintype" id="6270628">error</span><span class="op" id="6270633">)</span>&nbsp;<span class="op" id="6270635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6270638">nn</span>&nbsp;<span class="op" id="6270641">:=</span>&nbsp;<span class="num" id="6270644">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6270647">for</span>&nbsp;<span class="builtinfunc" id="6270651">len</span><span class="op" id="6270654">(</span><span class="ident" id="6270655">p</span><span class="op" id="6270656">)</span>&nbsp;<span class="op" id="6270658">&gt;</span>&nbsp;<span class="num" id="6270660">0</span>&nbsp;<span class="op" id="6270662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6270666">n</span>&nbsp;<span class="op" id="6270668">:=</span>&nbsp;<span class="builtinfunc" id="6270671">len</span><span class="op" id="6270674">(</span><span class="ident" id="6270675">p</span><span class="op" id="6270676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6270680">if</span>&nbsp;<span class="ident" id="6270683">n</span>&nbsp;<span class="op" id="6270685">&gt;</span>&nbsp;<span class="ident" id="6270687">maxWrite</span>&nbsp;<span class="op" id="6270696">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6270701">n</span>&nbsp;<span class="op" id="6270703">=</span>&nbsp;<span class="ident" id="6270705">maxWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6270716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6270720">if</span>&nbsp;<span class="ident" id="6270723">err</span>&nbsp;<span class="op" id="6270727">:=</span>&nbsp;<span class="ident" id="6270730">w</span><span class="op" id="6270731">.</span><span class="ident" id="6270732">c</span><span class="op" id="6270733">.</span><span class="ident" id="6270734">writeRecord</span><span class="op" id="6270745">(</span><span class="ident" id="6270746">w</span><span class="op" id="6270747">.</span><span class="ident" id="6270748">recType</span><span class="op" id="6270755">,</span>&nbsp;<span class="ident" id="6270757">w</span><span class="op" id="6270758">.</span><span class="ident" id="6270759">reqId</span><span class="op" id="6270764">,</span>&nbsp;<span class="ident" id="6270766">p</span><span class="op" id="6270767">[</span><span class="op" id="6270768">:</span><span class="ident" id="6270769">n</span><span class="op" id="6270770">]</span><span class="op" id="6270771">)</span><span class="op" id="6270772">;</span>&nbsp;<span class="ident" id="6270774">err</span>&nbsp;<span class="op" id="6270778">!=</span>&nbsp;<span class="builtintype" id="6270781">nil</span>&nbsp;<span class="op" id="6270785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6270790">return</span>&nbsp;<span class="ident" id="6270797">nn</span><span class="op" id="6270799">,</span>&nbsp;<span class="ident" id="6270801">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6270807">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6270811">nn</span>&nbsp;<span class="op" id="6270814">+=</span>&nbsp;<span class="ident" id="6270817">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6270821">p</span>&nbsp;<span class="op" id="6270823">=</span>&nbsp;<span class="ident" id="6270825">p</span><span class="op" id="6270826">[</span><span class="ident" id="6270827">n</span><span class="op" id="6270828">:</span><span class="op" id="6270829">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6270832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6270835">return</span>&nbsp;<span class="ident" id="6270842">nn</span><span class="op" id="6270844">,</span>&nbsp;<span class="builtintype" id="6270846">nil</span><br>
<span class="lineno"></span><span class="op" id="6270850">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="6270853">func</span>&nbsp;<span class="op" id="6270858">(</span><span class="ident" id="6270859">w</span>&nbsp;<span class="op" id="6270861">*</span><span class="ident" id="6270862">streamWriter</span><span class="op" id="6270874">)</span>&nbsp;<span class="ident" id="6270876">Close</span><span class="op" id="6270881">(</span><span class="op" id="6270882">)</span>&nbsp;<span class="builtintype" id="6270884">error</span>&nbsp;<span class="op" id="6270890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6270893">//&nbsp;send&nbsp;empty&nbsp;record&nbsp;to&nbsp;close&nbsp;the&nbsp;stream</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6270935">return</span>&nbsp;<span class="ident" id="6270942">w</span><span class="op" id="6270943">.</span><span class="ident" id="6270944">c</span><span class="op" id="6270945">.</span><span class="ident" id="6270946">writeRecord</span><span class="op" id="6270957">(</span><span class="ident" id="6270958">w</span><span class="op" id="6270959">.</span><span class="ident" id="6270960">recType</span><span class="op" id="6270967">,</span>&nbsp;<span class="ident" id="6270969">w</span><span class="op" id="6270970">.</span><span class="ident" id="6270971">reqId</span><span class="op" id="6270976">,</span>&nbsp;<span class="builtintype" id="6270978">nil</span><span class="op" id="6270981">)</span><br>
<span class="lineno"></span><span class="op" id="6270983">}</span>
</div>
</body>
</html>
