<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>text/template/parse</h2>
<ul>
<li><a href="/gostd/text/template/parse/lex.go.html">lex.go</a></li>
<li><a href="/gostd/text/template/parse/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/text/template/parse/node.go.html">node.go</a></li>
<li><a href="/gostd/text/template/parse/parse.go.html">parse.go</a></li>
<li><a href="/gostd/text/template/parse/parse_test.go.html">parse_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5548045">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5548100">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5548154">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5548205">//&nbsp;Package&nbsp;parse&nbsp;builds&nbsp;parse&nbsp;trees&nbsp;for&nbsp;templates&nbsp;as&nbsp;defined&nbsp;by&nbsp;text/template</span><br>
<span class="lineno"></span><span class="comment" id="5548283">//&nbsp;and&nbsp;html/template.&nbsp;Clients&nbsp;should&nbsp;use&nbsp;those&nbsp;packages&nbsp;to&nbsp;construct&nbsp;templates</span><br>
<span class="lineno"></span><span class="comment" id="5548362">//&nbsp;rather&nbsp;than&nbsp;this&nbsp;one,&nbsp;which&nbsp;provides&nbsp;shared&nbsp;internal&nbsp;data&nbsp;structures&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="5548438">//&nbsp;intended&nbsp;for&nbsp;general&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="5548467">package</span>&nbsp;<span class="ident" id="5548475">parse</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5548482">import</span>&nbsp;<span class="op" id="5548489">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5548492">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5548501">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5548508">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5548519">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5548530">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5548540">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5548543">//&nbsp;Tree&nbsp;is&nbsp;the&nbsp;representation&nbsp;of&nbsp;a&nbsp;single&nbsp;parsed&nbsp;template.</span><br>
<span class="lineno">20</span><span class="keyword" id="5548602">type</span>&nbsp;<span class="ident" id="5548607">Tree</span>&nbsp;<span class="keyword" id="5548612">struct</span>&nbsp;<span class="op" id="5548619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5548622">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5548632">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5548642">//&nbsp;name&nbsp;of&nbsp;the&nbsp;template&nbsp;represented&nbsp;by&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5548692">ParseName</span>&nbsp;<span class="builtintype" id="5548702">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5548712">//&nbsp;name&nbsp;of&nbsp;the&nbsp;top-level&nbsp;template&nbsp;during&nbsp;parsing,&nbsp;for&nbsp;error&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5548783">Root</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5548793">*</span><span class="ident" id="5548794">ListNode</span>&nbsp;<span class="comment" id="5548803">//&nbsp;top-level&nbsp;root&nbsp;of&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5548835">text</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5548845">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5548855">//&nbsp;text&nbsp;parsed&nbsp;to&nbsp;create&nbsp;the&nbsp;template&nbsp;(or&nbsp;its&nbsp;parent)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5548910">//&nbsp;Parsing&nbsp;only;&nbsp;cleared&nbsp;after&nbsp;parse.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5548949">funcs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5548959">[</span><span class="op" id="5548960">]</span><span class="keyword" id="5548961">map</span><span class="op" id="5548964">[</span><span class="builtintype" id="5548965">string</span><span class="op" id="5548971">]</span><span class="keyword" id="5548972">interface</span><span class="op" id="5548981">{</span><span class="op" id="5548982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5548985">lex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5548995">*</span><span class="ident" id="5548996">lexer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549003">token</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5549013">[</span><span class="num" id="5549014">3</span><span class="op" id="5549015">]</span><span class="ident" id="5549016">item</span>&nbsp;<span class="comment" id="5549021">//&nbsp;three-token&nbsp;lookahead&nbsp;for&nbsp;parser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549059">peekCount</span>&nbsp;<span class="builtintype" id="5549069">int</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549074">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5549084">[</span><span class="op" id="5549085">]</span><span class="builtintype" id="5549086">string</span>&nbsp;<span class="comment" id="5549093">//&nbsp;variables&nbsp;defined&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span><span class="op" id="5549129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5549132">//&nbsp;Copy&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;Tree.&nbsp;Any&nbsp;parsing&nbsp;state&nbsp;is&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="5549200">func</span>&nbsp;<span class="op" id="5549205">(</span><span class="ident" id="5549206">t</span>&nbsp;<span class="op" id="5549208">*</span><span class="ident" id="5549209">Tree</span><span class="op" id="5549213">)</span>&nbsp;<span class="ident" id="5549215">Copy</span><span class="op" id="5549219">(</span><span class="op" id="5549220">)</span>&nbsp;<span class="op" id="5549222">*</span><span class="ident" id="5549223">Tree</span>&nbsp;<span class="op" id="5549228">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549231">if</span>&nbsp;<span class="ident" id="5549234">t</span>&nbsp;<span class="op" id="5549236">==</span>&nbsp;<span class="ident" id="5549239">nil</span>&nbsp;<span class="op" id="5549243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549247">return</span>&nbsp;<span class="ident" id="5549254">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5549259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549262">return</span>&nbsp;<span class="op" id="5549269">&amp;</span><span class="ident" id="5549270">Tree</span><span class="op" id="5549274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549278">Name</span><span class="op" id="5549282">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5549289">t</span><span class="op" id="5549290">.</span><span class="ident" id="5549291">Name</span><span class="op" id="5549295">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549299">ParseName</span><span class="op" id="5549308">:</span>&nbsp;<span class="ident" id="5549310">t</span><span class="op" id="5549311">.</span><span class="ident" id="5549312">ParseName</span><span class="op" id="5549321">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549325">Root</span><span class="op" id="5549329">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5549336">t</span><span class="op" id="5549337">.</span><span class="ident" id="5549338">Root</span><span class="op" id="5549342">.</span><span class="ident" id="5549343">CopyList</span><span class="op" id="5549351">(</span><span class="op" id="5549352">)</span><span class="op" id="5549353">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549357">text</span><span class="op" id="5549361">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5549368">t</span><span class="op" id="5549369">.</span><span class="ident" id="5549370">text</span><span class="op" id="5549374">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5549377">}</span><br>
<span class="lineno"></span><span class="op" id="5549379">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="5549382">//&nbsp;Parse&nbsp;returns&nbsp;a&nbsp;map&nbsp;from&nbsp;template&nbsp;name&nbsp;to&nbsp;parse.Tree,&nbsp;created&nbsp;by&nbsp;parsing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5549462">//&nbsp;templates&nbsp;described&nbsp;in&nbsp;the&nbsp;argument&nbsp;string.&nbsp;The&nbsp;top-level&nbsp;template&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5549540">//&nbsp;given&nbsp;the&nbsp;specified&nbsp;name.&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;encountered,&nbsp;parsing&nbsp;stops&nbsp;and&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5549618">//&nbsp;empty&nbsp;map&nbsp;is&nbsp;returned&nbsp;with&nbsp;the&nbsp;error.</span><br>
<span class="lineno">50</span><span class="keyword" id="5549659">func</span>&nbsp;<span class="ident" id="5549664">Parse</span><span class="op" id="5549669">(</span><span class="ident" id="5549670">name</span><span class="op" id="5549674">,</span>&nbsp;<span class="ident" id="5549676">text</span><span class="op" id="5549680">,</span>&nbsp;<span class="ident" id="5549682">leftDelim</span><span class="op" id="5549691">,</span>&nbsp;<span class="ident" id="5549693">rightDelim</span>&nbsp;<span class="builtintype" id="5549704">string</span><span class="op" id="5549710">,</span>&nbsp;<span class="ident" id="5549712">funcs</span>&nbsp;<span class="op" id="5549718">...</span><span class="keyword" id="5549721">map</span><span class="op" id="5549724">[</span><span class="builtintype" id="5549725">string</span><span class="op" id="5549731">]</span><span class="keyword" id="5549732">interface</span><span class="op" id="5549741">{</span><span class="op" id="5549742">}</span><span class="op" id="5549743">)</span>&nbsp;<span class="op" id="5549745">(</span><span class="ident" id="5549746">treeSet</span>&nbsp;<span class="keyword" id="5549754">map</span><span class="op" id="5549757">[</span><span class="builtintype" id="5549758">string</span><span class="op" id="5549764">]</span><span class="op" id="5549765">*</span><span class="ident" id="5549766">Tree</span><span class="op" id="5549770">,</span>&nbsp;<span class="ident" id="5549772">err</span>&nbsp;<span class="builtintype" id="5549776">error</span><span class="op" id="5549781">)</span>&nbsp;<span class="op" id="5549783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549786">treeSet</span>&nbsp;<span class="op" id="5549794">=</span>&nbsp;<span class="builtinfunc" id="5549796">make</span><span class="op" id="5549800">(</span><span class="keyword" id="5549801">map</span><span class="op" id="5549804">[</span><span class="builtintype" id="5549805">string</span><span class="op" id="5549811">]</span><span class="op" id="5549812">*</span><span class="ident" id="5549813">Tree</span><span class="op" id="5549817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549820">t</span>&nbsp;<span class="op" id="5549822">:=</span>&nbsp;<span class="ident" id="5549825">New</span><span class="op" id="5549828">(</span><span class="ident" id="5549829">name</span><span class="op" id="5549833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549836">t</span><span class="op" id="5549837">.</span><span class="ident" id="5549838">text</span>&nbsp;<span class="op" id="5549843">=</span>&nbsp;<span class="ident" id="5549845">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5549851">_</span><span class="op" id="5549852">,</span>&nbsp;<span class="ident" id="5549854">err</span>&nbsp;<span class="op" id="5549858">=</span>&nbsp;<span class="ident" id="5549860">t</span><span class="op" id="5549861">.</span><span class="ident" id="5549862">Parse</span><span class="op" id="5549867">(</span><span class="ident" id="5549868">text</span><span class="op" id="5549872">,</span>&nbsp;<span class="ident" id="5549874">leftDelim</span><span class="op" id="5549883">,</span>&nbsp;<span class="ident" id="5549885">rightDelim</span><span class="op" id="5549895">,</span>&nbsp;<span class="ident" id="5549897">treeSet</span><span class="op" id="5549904">,</span>&nbsp;<span class="ident" id="5549906">funcs</span><span class="op" id="5549911">...</span><span class="op" id="5549914">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549917">return</span><br>
<span class="lineno"></span><span class="op" id="5549924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5549927">//&nbsp;next&nbsp;returns&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="5549959">func</span>&nbsp;<span class="op" id="5549964">(</span><span class="ident" id="5549965">t</span>&nbsp;<span class="op" id="5549967">*</span><span class="ident" id="5549968">Tree</span><span class="op" id="5549972">)</span>&nbsp;<span class="ident" id="5549974">next</span><span class="op" id="5549978">(</span><span class="op" id="5549979">)</span>&nbsp;<span class="ident" id="5549981">item</span>&nbsp;<span class="op" id="5549986">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5549989">if</span>&nbsp;<span class="ident" id="5549992">t</span><span class="op" id="5549993">.</span><span class="ident" id="5549994">peekCount</span>&nbsp;<span class="op" id="5550004">&gt;</span>&nbsp;<span class="num" id="5550006">0</span>&nbsp;<span class="op" id="5550008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5550012">t</span><span class="op" id="5550013">.</span><span class="ident" id="5550014">peekCount</span><span class="op" id="5550023">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5550027">}</span>&nbsp;<span class="keyword" id="5550029">else</span>&nbsp;<span class="op" id="5550034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5550038">t</span><span class="op" id="5550039">.</span><span class="ident" id="5550040">token</span><span class="op" id="5550045">[</span><span class="num" id="5550046">0</span><span class="op" id="5550047">]</span>&nbsp;<span class="op" id="5550049">=</span>&nbsp;<span class="ident" id="5550051">t</span><span class="op" id="5550052">.</span><span class="ident" id="5550053">lex</span><span class="op" id="5550056">.</span><span class="ident" id="5550057">nextItem</span><span class="op" id="5550065">(</span><span class="op" id="5550066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5550069">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5550072">return</span>&nbsp;<span class="ident" id="5550079">t</span><span class="op" id="5550080">.</span><span class="ident" id="5550081">token</span><span class="op" id="5550086">[</span><span class="ident" id="5550087">t</span><span class="op" id="5550088">.</span><span class="ident" id="5550089">peekCount</span><span class="op" id="5550098">]</span><br>
<span class="lineno"></span><span class="op" id="5550100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5550103">//&nbsp;backup&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;one&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="5550150">func</span>&nbsp;<span class="op" id="5550155">(</span><span class="ident" id="5550156">t</span>&nbsp;<span class="op" id="5550158">*</span><span class="ident" id="5550159">Tree</span><span class="op" id="5550163">)</span>&nbsp;<span class="ident" id="5550165">backup</span><span class="op" id="5550171">(</span><span class="op" id="5550172">)</span>&nbsp;<span class="op" id="5550174">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5550177">t</span><span class="op" id="5550178">.</span><span class="ident" id="5550179">peekCount</span><span class="op" id="5550188">++</span><br>
<span class="lineno"></span><span class="op" id="5550191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5550194">//&nbsp;backup2&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;two&nbsp;tokens.</span><br>
<span class="lineno"></span><span class="comment" id="5550243">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno">75</span><span class="keyword" id="5550281">func</span>&nbsp;<span class="op" id="5550286">(</span><span class="ident" id="5550287">t</span>&nbsp;<span class="op" id="5550289">*</span><span class="ident" id="5550290">Tree</span><span class="op" id="5550294">)</span>&nbsp;<span class="ident" id="5550296">backup2</span><span class="op" id="5550303">(</span><span class="ident" id="5550304">t1</span>&nbsp;<span class="ident" id="5550307">item</span><span class="op" id="5550311">)</span>&nbsp;<span class="op" id="5550313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5550316">t</span><span class="op" id="5550317">.</span><span class="ident" id="5550318">token</span><span class="op" id="5550323">[</span><span class="num" id="5550324">1</span><span class="op" id="5550325">]</span>&nbsp;<span class="op" id="5550327">=</span>&nbsp;<span class="ident" id="5550329">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5550333">t</span><span class="op" id="5550334">.</span><span class="ident" id="5550335">peekCount</span>&nbsp;<span class="op" id="5550345">=</span>&nbsp;<span class="num" id="5550347">2</span><br>
<span class="lineno"></span><span class="op" id="5550349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="5550352">//&nbsp;backup3&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;three&nbsp;tokens</span><br>
<span class="lineno"></span><span class="comment" id="5550402">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno"></span><span class="keyword" id="5550440">func</span>&nbsp;<span class="op" id="5550445">(</span><span class="ident" id="5550446">t</span>&nbsp;<span class="op" id="5550448">*</span><span class="ident" id="5550449">Tree</span><span class="op" id="5550453">)</span>&nbsp;<span class="ident" id="5550455">backup3</span><span class="op" id="5550462">(</span><span class="ident" id="5550463">t2</span><span class="op" id="5550465">,</span>&nbsp;<span class="ident" id="5550467">t1</span>&nbsp;<span class="ident" id="5550470">item</span><span class="op" id="5550474">)</span>&nbsp;<span class="op" id="5550476">{</span>&nbsp;<span class="comment" id="5550478">//&nbsp;Reverse&nbsp;order:&nbsp;we&#39;re&nbsp;pushing&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5550517">t</span><span class="op" id="5550518">.</span><span class="ident" id="5550519">token</span><span class="op" id="5550524">[</span><span class="num" id="5550525">1</span><span class="op" id="5550526">]</span>&nbsp;<span class="op" id="5550528">=</span>&nbsp;<span class="ident" id="5550530">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5550534">t</span><span class="op" id="5550535">.</span><span class="ident" id="5550536">token</span><span class="op" id="5550541">[</span><span class="num" id="5550542">2</span><span class="op" id="5550543">]</span>&nbsp;<span class="op" id="5550545">=</span>&nbsp;<span class="ident" id="5550547">t2</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5550551">t</span><span class="op" id="5550552">.</span><span class="ident" id="5550553">peekCount</span>&nbsp;<span class="op" id="5550563">=</span>&nbsp;<span class="num" id="5550565">3</span><br>
<span class="lineno"></span><span class="op" id="5550567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5550570">//&nbsp;peek&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="5550623">func</span>&nbsp;<span class="op" id="5550628">(</span><span class="ident" id="5550629">t</span>&nbsp;<span class="op" id="5550631">*</span><span class="ident" id="5550632">Tree</span><span class="op" id="5550636">)</span>&nbsp;<span class="ident" id="5550638">peek</span><span class="op" id="5550642">(</span><span class="op" id="5550643">)</span>&nbsp;<span class="ident" id="5550645">item</span>&nbsp;<span class="op" id="5550650">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5550653">if</span>&nbsp;<span class="ident" id="5550656">t</span><span class="op" id="5550657">.</span><span class="ident" id="5550658">peekCount</span>&nbsp;<span class="op" id="5550668">&gt;</span>&nbsp;<span class="num" id="5550670">0</span>&nbsp;<span class="op" id="5550672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5550676">return</span>&nbsp;<span class="ident" id="5550683">t</span><span class="op" id="5550684">.</span><span class="ident" id="5550685">token</span><span class="op" id="5550690">[</span><span class="ident" id="5550691">t</span><span class="op" id="5550692">.</span><span class="ident" id="5550693">peekCount</span><span class="op" id="5550702">-</span><span class="num" id="5550703">1</span><span class="op" id="5550704">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5550707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5550710">t</span><span class="op" id="5550711">.</span><span class="ident" id="5550712">peekCount</span>&nbsp;<span class="op" id="5550722">=</span>&nbsp;<span class="num" id="5550724">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5550727">t</span><span class="op" id="5550728">.</span><span class="ident" id="5550729">token</span><span class="op" id="5550734">[</span><span class="num" id="5550735">0</span><span class="op" id="5550736">]</span>&nbsp;<span class="op" id="5550738">=</span>&nbsp;<span class="ident" id="5550740">t</span><span class="op" id="5550741">.</span><span class="ident" id="5550742">lex</span><span class="op" id="5550745">.</span><span class="ident" id="5550746">nextItem</span><span class="op" id="5550754">(</span><span class="op" id="5550755">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5550758">return</span>&nbsp;<span class="ident" id="5550765">t</span><span class="op" id="5550766">.</span><span class="ident" id="5550767">token</span><span class="op" id="5550772">[</span><span class="num" id="5550773">0</span><span class="op" id="5550774">]</span><br>
<span class="lineno"></span><span class="op" id="5550776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5550779">//&nbsp;nextNonSpace&nbsp;returns&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="5550829">func</span>&nbsp;<span class="op" id="5550834">(</span><span class="ident" id="5550835">t</span>&nbsp;<span class="op" id="5550837">*</span><span class="ident" id="5550838">Tree</span><span class="op" id="5550842">)</span>&nbsp;<span class="ident" id="5550844">nextNonSpace</span><span class="op" id="5550856">(</span><span class="op" id="5550857">)</span>&nbsp;<span class="op" id="5550859">(</span><span class="ident" id="5550860">token</span>&nbsp;<span class="ident" id="5550866">item</span><span class="op" id="5550870">)</span>&nbsp;<span class="op" id="5550872">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5550875">for</span>&nbsp;<span class="op" id="5550879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5550883">token</span>&nbsp;<span class="op" id="5550889">=</span>&nbsp;<span class="ident" id="5550891">t</span><span class="op" id="5550892">.</span><span class="ident" id="5550893">next</span><span class="op" id="5550897">(</span><span class="op" id="5550898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5550902">if</span>&nbsp;<span class="ident" id="5550905">token</span><span class="op" id="5550910">.</span><span class="ident" id="5550911">typ</span>&nbsp;<span class="op" id="5550915">!=</span>&nbsp;<span class="ident" id="5550918">itemSpace</span>&nbsp;<span class="op" id="5550928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5550933">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5550941">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5550944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5550947">return</span>&nbsp;<span class="ident" id="5550954">token</span><br>
<span class="lineno"></span><span class="op" id="5550960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5550963">//&nbsp;peekNonSpace&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno">110</span><span class="keyword" id="5551034">func</span>&nbsp;<span class="op" id="5551039">(</span><span class="ident" id="5551040">t</span>&nbsp;<span class="op" id="5551042">*</span><span class="ident" id="5551043">Tree</span><span class="op" id="5551047">)</span>&nbsp;<span class="ident" id="5551049">peekNonSpace</span><span class="op" id="5551061">(</span><span class="op" id="5551062">)</span>&nbsp;<span class="op" id="5551064">(</span><span class="ident" id="5551065">token</span>&nbsp;<span class="ident" id="5551071">item</span><span class="op" id="5551075">)</span>&nbsp;<span class="op" id="5551077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5551080">for</span>&nbsp;<span class="op" id="5551084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551088">token</span>&nbsp;<span class="op" id="5551094">=</span>&nbsp;<span class="ident" id="5551096">t</span><span class="op" id="5551097">.</span><span class="ident" id="5551098">next</span><span class="op" id="5551102">(</span><span class="op" id="5551103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5551107">if</span>&nbsp;<span class="ident" id="5551110">token</span><span class="op" id="5551115">.</span><span class="ident" id="5551116">typ</span>&nbsp;<span class="op" id="5551120">!=</span>&nbsp;<span class="ident" id="5551123">itemSpace</span>&nbsp;<span class="op" id="5551133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5551138">break</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5551146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5551149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551152">t</span><span class="op" id="5551153">.</span><span class="ident" id="5551154">backup</span><span class="op" id="5551160">(</span><span class="op" id="5551161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5551164">return</span>&nbsp;<span class="ident" id="5551171">token</span><br>
<span class="lineno"></span><span class="op" id="5551177">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="5551180">//&nbsp;Parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5551193">//&nbsp;New&nbsp;allocates&nbsp;a&nbsp;new&nbsp;parse&nbsp;tree&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="5551248">func</span>&nbsp;<span class="ident" id="5551253">New</span><span class="op" id="5551256">(</span><span class="ident" id="5551257">name</span>&nbsp;<span class="builtintype" id="5551262">string</span><span class="op" id="5551268">,</span>&nbsp;<span class="ident" id="5551270">funcs</span>&nbsp;<span class="op" id="5551276">...</span><span class="keyword" id="5551279">map</span><span class="op" id="5551282">[</span><span class="builtintype" id="5551283">string</span><span class="op" id="5551289">]</span><span class="keyword" id="5551290">interface</span><span class="op" id="5551299">{</span><span class="op" id="5551300">}</span><span class="op" id="5551301">)</span>&nbsp;<span class="op" id="5551303">*</span><span class="ident" id="5551304">Tree</span>&nbsp;<span class="op" id="5551309">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5551312">return</span>&nbsp;<span class="op" id="5551319">&amp;</span><span class="ident" id="5551320">Tree</span><span class="op" id="5551324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551328">Name</span><span class="op" id="5551332">:</span>&nbsp;&nbsp;<span class="ident" id="5551335">name</span><span class="op" id="5551339">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551343">funcs</span><span class="op" id="5551348">:</span>&nbsp;<span class="ident" id="5551350">funcs</span><span class="op" id="5551355">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5551358">}</span><br>
<span class="lineno"></span><span class="op" id="5551360">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="5551363">//&nbsp;ErrorContext&nbsp;returns&nbsp;a&nbsp;textual&nbsp;representation&nbsp;of&nbsp;the&nbsp;location&nbsp;of&nbsp;the&nbsp;node&nbsp;in&nbsp;the&nbsp;input&nbsp;text.</span><br>
<span class="lineno"></span><span class="comment" id="5551459">//&nbsp;The&nbsp;receiver&nbsp;is&nbsp;only&nbsp;used&nbsp;when&nbsp;the&nbsp;node&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;tree&nbsp;inside,</span><br>
<span class="lineno"></span><span class="comment" id="5551546">//&nbsp;which&nbsp;can&nbsp;occur&nbsp;in&nbsp;old&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="5551578">func</span>&nbsp;<span class="op" id="5551583">(</span><span class="ident" id="5551584">t</span>&nbsp;<span class="op" id="5551586">*</span><span class="ident" id="5551587">Tree</span><span class="op" id="5551591">)</span>&nbsp;<span class="ident" id="5551593">ErrorContext</span><span class="op" id="5551605">(</span><span class="ident" id="5551606">n</span>&nbsp;<span class="ident" id="5551608">Node</span><span class="op" id="5551612">)</span>&nbsp;<span class="op" id="5551614">(</span><span class="ident" id="5551615">location</span><span class="op" id="5551623">,</span>&nbsp;<span class="ident" id="5551625">context</span>&nbsp;<span class="builtintype" id="5551633">string</span><span class="op" id="5551639">)</span>&nbsp;<span class="op" id="5551641">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551644">pos</span>&nbsp;<span class="op" id="5551648">:=</span>&nbsp;<span class="builtintype" id="5551651">int</span><span class="op" id="5551654">(</span><span class="ident" id="5551655">n</span><span class="op" id="5551656">.</span><span class="ident" id="5551657">Position</span><span class="op" id="5551665">(</span><span class="op" id="5551666">)</span><span class="op" id="5551667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551670">tree</span>&nbsp;<span class="op" id="5551675">:=</span>&nbsp;<span class="ident" id="5551678">n</span><span class="op" id="5551679">.</span><span class="ident" id="5551680">tree</span><span class="op" id="5551684">(</span><span class="op" id="5551685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5551688">if</span>&nbsp;<span class="ident" id="5551691">tree</span>&nbsp;<span class="op" id="5551696">==</span>&nbsp;<span class="ident" id="5551699">nil</span>&nbsp;<span class="op" id="5551703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551707">tree</span>&nbsp;<span class="op" id="5551712">=</span>&nbsp;<span class="ident" id="5551714">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5551717">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551720">text</span>&nbsp;<span class="op" id="5551725">:=</span>&nbsp;<span class="ident" id="5551728">tree</span><span class="op" id="5551732">.</span><span class="ident" id="5551733">text</span><span class="op" id="5551737">[</span><span class="op" id="5551738">:</span><span class="ident" id="5551739">pos</span><span class="op" id="5551742">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551745">byteNum</span>&nbsp;<span class="op" id="5551753">:=</span>&nbsp;<span class="ident" id="5551756">strings</span><span class="op" id="5551763">.</span><span class="ident" id="5551764">LastIndex</span><span class="op" id="5551773">(</span><span class="ident" id="5551774">text</span><span class="op" id="5551778">,</span>&nbsp;<span class="string" id="5551780">&#34;\n&#34;</span><span class="op" id="5551784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5551787">if</span>&nbsp;<span class="ident" id="5551790">byteNum</span>&nbsp;<span class="op" id="5551798">==</span>&nbsp;<span class="op" id="5551801">-</span><span class="num" id="5551802">1</span>&nbsp;<span class="op" id="5551804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551808">byteNum</span>&nbsp;<span class="op" id="5551816">=</span>&nbsp;<span class="ident" id="5551818">pos</span>&nbsp;<span class="comment" id="5551822">//&nbsp;On&nbsp;first&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5551841">}</span>&nbsp;<span class="keyword" id="5551843">else</span>&nbsp;<span class="op" id="5551848">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551852">byteNum</span><span class="op" id="5551859">++</span>&nbsp;<span class="comment" id="5551862">//&nbsp;After&nbsp;the&nbsp;newline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551886">byteNum</span>&nbsp;<span class="op" id="5551894">=</span>&nbsp;<span class="ident" id="5551896">pos</span>&nbsp;<span class="op" id="5551900">-</span>&nbsp;<span class="ident" id="5551902">byteNum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5551911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551914">lineNum</span>&nbsp;<span class="op" id="5551922">:=</span>&nbsp;<span class="num" id="5551925">1</span>&nbsp;<span class="op" id="5551927">+</span>&nbsp;<span class="ident" id="5551929">strings</span><span class="op" id="5551936">.</span><span class="ident" id="5551937">Count</span><span class="op" id="5551942">(</span><span class="ident" id="5551943">text</span><span class="op" id="5551947">,</span>&nbsp;<span class="string" id="5551949">&#34;\n&#34;</span><span class="op" id="5551953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5551956">context</span>&nbsp;<span class="op" id="5551964">=</span>&nbsp;<span class="ident" id="5551966">n</span><span class="op" id="5551967">.</span><span class="ident" id="5551968">String</span><span class="op" id="5551974">(</span><span class="op" id="5551975">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5551978">if</span>&nbsp;<span class="builtinfunc" id="5551981">len</span><span class="op" id="5551984">(</span><span class="ident" id="5551985">context</span><span class="op" id="5551992">)</span>&nbsp;<span class="op" id="5551994">&gt;</span>&nbsp;<span class="num" id="5551996">20</span>&nbsp;<span class="op" id="5551999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552003">context</span>&nbsp;<span class="op" id="5552011">=</span>&nbsp;<span class="ident" id="5552013">fmt</span><span class="op" id="5552016">.</span><span class="ident" id="5552017">Sprintf</span><span class="op" id="5552024">(</span><span class="string" id="5552025">&#34;%.20s...&#34;</span><span class="op" id="5552035">,</span>&nbsp;<span class="ident" id="5552037">context</span><span class="op" id="5552044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5552047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552050">return</span>&nbsp;<span class="ident" id="5552057">fmt</span><span class="op" id="5552060">.</span><span class="ident" id="5552061">Sprintf</span><span class="op" id="5552068">(</span><span class="string" id="5552069">&#34;%s:%d:%d&#34;</span><span class="op" id="5552079">,</span>&nbsp;<span class="ident" id="5552081">tree</span><span class="op" id="5552085">.</span><span class="ident" id="5552086">ParseName</span><span class="op" id="5552095">,</span>&nbsp;<span class="ident" id="5552097">lineNum</span><span class="op" id="5552104">,</span>&nbsp;<span class="ident" id="5552106">byteNum</span><span class="op" id="5552113">)</span><span class="op" id="5552114">,</span>&nbsp;<span class="ident" id="5552116">context</span><br>
<span class="lineno"></span><span class="op" id="5552124">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5552127">//&nbsp;errorf&nbsp;formats&nbsp;the&nbsp;error&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="5552182">func</span>&nbsp;<span class="op" id="5552187">(</span><span class="ident" id="5552188">t</span>&nbsp;<span class="op" id="5552190">*</span><span class="ident" id="5552191">Tree</span><span class="op" id="5552195">)</span>&nbsp;<span class="ident" id="5552197">errorf</span><span class="op" id="5552203">(</span><span class="ident" id="5552204">format</span>&nbsp;<span class="builtintype" id="5552211">string</span><span class="op" id="5552217">,</span>&nbsp;<span class="ident" id="5552219">args</span>&nbsp;<span class="op" id="5552224">...</span><span class="keyword" id="5552227">interface</span><span class="op" id="5552236">{</span><span class="op" id="5552237">}</span><span class="op" id="5552238">)</span>&nbsp;<span class="op" id="5552240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552243">t</span><span class="op" id="5552244">.</span><span class="ident" id="5552245">Root</span>&nbsp;<span class="op" id="5552250">=</span>&nbsp;<span class="ident" id="5552252">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552257">format</span>&nbsp;<span class="op" id="5552264">=</span>&nbsp;<span class="ident" id="5552266">fmt</span><span class="op" id="5552269">.</span><span class="ident" id="5552270">Sprintf</span><span class="op" id="5552277">(</span><span class="string" id="5552278">&#34;template:&nbsp;%s:%d:&nbsp;%s&#34;</span><span class="op" id="5552299">,</span>&nbsp;<span class="ident" id="5552301">t</span><span class="op" id="5552302">.</span><span class="ident" id="5552303">ParseName</span><span class="op" id="5552312">,</span>&nbsp;<span class="ident" id="5552314">t</span><span class="op" id="5552315">.</span><span class="ident" id="5552316">lex</span><span class="op" id="5552319">.</span><span class="ident" id="5552320">lineNumber</span><span class="op" id="5552330">(</span><span class="op" id="5552331">)</span><span class="op" id="5552332">,</span>&nbsp;<span class="ident" id="5552334">format</span><span class="op" id="5552340">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5552343">panic</span><span class="op" id="5552348">(</span><span class="ident" id="5552349">fmt</span><span class="op" id="5552352">.</span><span class="ident" id="5552353">Errorf</span><span class="op" id="5552359">(</span><span class="ident" id="5552360">format</span><span class="op" id="5552366">,</span>&nbsp;<span class="ident" id="5552368">args</span><span class="op" id="5552372">...</span><span class="op" id="5552375">)</span><span class="op" id="5552376">)</span><br>
<span class="lineno"></span><span class="op" id="5552378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5552381">//&nbsp;error&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="5552413">func</span>&nbsp;<span class="op" id="5552418">(</span><span class="ident" id="5552419">t</span>&nbsp;<span class="op" id="5552421">*</span><span class="ident" id="5552422">Tree</span><span class="op" id="5552426">)</span>&nbsp;<span class="builtintype" id="5552428">error</span><span class="op" id="5552433">(</span><span class="ident" id="5552434">err</span>&nbsp;<span class="builtintype" id="5552438">error</span><span class="op" id="5552443">)</span>&nbsp;<span class="op" id="5552445">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552448">t</span><span class="op" id="5552449">.</span><span class="ident" id="5552450">errorf</span><span class="op" id="5552456">(</span><span class="string" id="5552457">&#34;%s&#34;</span><span class="op" id="5552461">,</span>&nbsp;<span class="ident" id="5552463">err</span><span class="op" id="5552466">)</span><br>
<span class="lineno"></span><span class="op" id="5552468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5552471">//&nbsp;expect&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;the&nbsp;required&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5552546">func</span>&nbsp;<span class="op" id="5552551">(</span><span class="ident" id="5552552">t</span>&nbsp;<span class="op" id="5552554">*</span><span class="ident" id="5552555">Tree</span><span class="op" id="5552559">)</span>&nbsp;<span class="ident" id="5552561">expect</span><span class="op" id="5552567">(</span><span class="ident" id="5552568">expected</span>&nbsp;<span class="ident" id="5552577">itemType</span><span class="op" id="5552585">,</span>&nbsp;<span class="ident" id="5552587">context</span>&nbsp;<span class="builtintype" id="5552595">string</span><span class="op" id="5552601">)</span>&nbsp;<span class="ident" id="5552603">item</span>&nbsp;<span class="op" id="5552608">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552611">token</span>&nbsp;<span class="op" id="5552617">:=</span>&nbsp;<span class="ident" id="5552620">t</span><span class="op" id="5552621">.</span><span class="ident" id="5552622">nextNonSpace</span><span class="op" id="5552634">(</span><span class="op" id="5552635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552638">if</span>&nbsp;<span class="ident" id="5552641">token</span><span class="op" id="5552646">.</span><span class="ident" id="5552647">typ</span>&nbsp;<span class="op" id="5552651">!=</span>&nbsp;<span class="ident" id="5552654">expected</span>&nbsp;<span class="op" id="5552663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552667">t</span><span class="op" id="5552668">.</span><span class="ident" id="5552669">unexpected</span><span class="op" id="5552679">(</span><span class="ident" id="5552680">token</span><span class="op" id="5552685">,</span>&nbsp;<span class="ident" id="5552687">context</span><span class="op" id="5552694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5552697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552700">return</span>&nbsp;<span class="ident" id="5552707">token</span><br>
<span class="lineno">175</span><span class="op" id="5552713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5552716">//&nbsp;expectOneOf&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;one&nbsp;of&nbsp;the&nbsp;required&nbsp;types.</span><br>
<span class="lineno"></span><span class="keyword" id="5552804">func</span>&nbsp;<span class="op" id="5552809">(</span><span class="ident" id="5552810">t</span>&nbsp;<span class="op" id="5552812">*</span><span class="ident" id="5552813">Tree</span><span class="op" id="5552817">)</span>&nbsp;<span class="ident" id="5552819">expectOneOf</span><span class="op" id="5552830">(</span><span class="ident" id="5552831">expected1</span><span class="op" id="5552840">,</span>&nbsp;<span class="ident" id="5552842">expected2</span>&nbsp;<span class="ident" id="5552852">itemType</span><span class="op" id="5552860">,</span>&nbsp;<span class="ident" id="5552862">context</span>&nbsp;<span class="builtintype" id="5552870">string</span><span class="op" id="5552876">)</span>&nbsp;<span class="ident" id="5552878">item</span>&nbsp;<span class="op" id="5552883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552886">token</span>&nbsp;<span class="op" id="5552892">:=</span>&nbsp;<span class="ident" id="5552895">t</span><span class="op" id="5552896">.</span><span class="ident" id="5552897">nextNonSpace</span><span class="op" id="5552909">(</span><span class="op" id="5552910">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5552913">if</span>&nbsp;<span class="ident" id="5552916">token</span><span class="op" id="5552921">.</span><span class="ident" id="5552922">typ</span>&nbsp;<span class="op" id="5552926">!=</span>&nbsp;<span class="ident" id="5552929">expected1</span>&nbsp;<span class="op" id="5552939">&amp;&amp;</span>&nbsp;<span class="ident" id="5552942">token</span><span class="op" id="5552947">.</span><span class="ident" id="5552948">typ</span>&nbsp;<span class="op" id="5552952">!=</span>&nbsp;<span class="ident" id="5552955">expected2</span>&nbsp;<span class="op" id="5552965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5552969">t</span><span class="op" id="5552970">.</span><span class="ident" id="5552971">unexpected</span><span class="op" id="5552981">(</span><span class="ident" id="5552982">token</span><span class="op" id="5552987">,</span>&nbsp;<span class="ident" id="5552989">context</span><span class="op" id="5552996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5552999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5553002">return</span>&nbsp;<span class="ident" id="5553009">token</span><br>
<span class="lineno"></span><span class="op" id="5553015">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="comment" id="5553018">//&nbsp;unexpected&nbsp;complains&nbsp;about&nbsp;the&nbsp;token&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="5553085">func</span>&nbsp;<span class="op" id="5553090">(</span><span class="ident" id="5553091">t</span>&nbsp;<span class="op" id="5553093">*</span><span class="ident" id="5553094">Tree</span><span class="op" id="5553098">)</span>&nbsp;<span class="ident" id="5553100">unexpected</span><span class="op" id="5553110">(</span><span class="ident" id="5553111">token</span>&nbsp;<span class="ident" id="5553117">item</span><span class="op" id="5553121">,</span>&nbsp;<span class="ident" id="5553123">context</span>&nbsp;<span class="builtintype" id="5553131">string</span><span class="op" id="5553137">)</span>&nbsp;<span class="op" id="5553139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5553142">t</span><span class="op" id="5553143">.</span><span class="ident" id="5553144">errorf</span><span class="op" id="5553150">(</span><span class="string" id="5553151">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="5553172">,</span>&nbsp;<span class="ident" id="5553174">token</span><span class="op" id="5553179">,</span>&nbsp;<span class="ident" id="5553181">context</span><span class="op" id="5553188">)</span><br>
<span class="lineno"></span><span class="op" id="5553190">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5553193">//&nbsp;recover&nbsp;is&nbsp;the&nbsp;handler&nbsp;that&nbsp;turns&nbsp;panics&nbsp;into&nbsp;returns&nbsp;from&nbsp;the&nbsp;top&nbsp;level&nbsp;of&nbsp;Parse.</span><br>
<span class="lineno"></span><span class="keyword" id="5553279">func</span>&nbsp;<span class="op" id="5553284">(</span><span class="ident" id="5553285">t</span>&nbsp;<span class="op" id="5553287">*</span><span class="ident" id="5553288">Tree</span><span class="op" id="5553292">)</span>&nbsp;<span class="builtinfunc" id="5553294">recover</span><span class="op" id="5553301">(</span><span class="ident" id="5553302">errp</span>&nbsp;<span class="op" id="5553307">*</span><span class="builtintype" id="5553308">error</span><span class="op" id="5553313">)</span>&nbsp;<span class="op" id="5553315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5553318">e</span>&nbsp;<span class="op" id="5553320">:=</span>&nbsp;<span class="builtinfunc" id="5553323">recover</span><span class="op" id="5553330">(</span><span class="op" id="5553331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5553334">if</span>&nbsp;<span class="ident" id="5553337">e</span>&nbsp;<span class="op" id="5553339">!=</span>&nbsp;<span class="ident" id="5553342">nil</span>&nbsp;<span class="op" id="5553346">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5553350">if</span>&nbsp;<span class="ident" id="5553353">_</span><span class="op" id="5553354">,</span>&nbsp;<span class="ident" id="5553356">ok</span>&nbsp;<span class="op" id="5553359">:=</span>&nbsp;<span class="ident" id="5553362">e</span><span class="op" id="5553363">.</span><span class="op" id="5553364">(</span><span class="ident" id="5553365">runtime</span><span class="op" id="5553372">.</span><span class="ident" id="5553373">Error</span><span class="op" id="5553378">)</span><span class="op" id="5553379">;</span>&nbsp;<span class="ident" id="5553381">ok</span>&nbsp;<span class="op" id="5553384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5553389">panic</span><span class="op" id="5553394">(</span><span class="ident" id="5553395">e</span><span class="op" id="5553396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5553400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5553404">if</span>&nbsp;<span class="ident" id="5553407">t</span>&nbsp;<span class="op" id="5553409">!=</span>&nbsp;<span class="ident" id="5553412">nil</span>&nbsp;<span class="op" id="5553416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5553421">t</span><span class="op" id="5553422">.</span><span class="ident" id="5553423">stopParse</span><span class="op" id="5553432">(</span><span class="op" id="5553433">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5553437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5553441">*</span><span class="ident" id="5553442">errp</span>&nbsp;<span class="op" id="5553447">=</span>&nbsp;<span class="ident" id="5553449">e</span><span class="op" id="5553450">.</span><span class="op" id="5553451">(</span><span class="builtintype" id="5553452">error</span><span class="op" id="5553457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5553460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5553463">return</span><br>
<span class="lineno"></span><span class="op" id="5553470">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment" id="5553473">//&nbsp;startParse&nbsp;initializes&nbsp;the&nbsp;parser,&nbsp;using&nbsp;the&nbsp;lexer.</span><br>
<span class="lineno"></span><span class="keyword" id="5553528">func</span>&nbsp;<span class="op" id="5553533">(</span><span class="ident" id="5553534">t</span>&nbsp;<span class="op" id="5553536">*</span><span class="ident" id="5553537">Tree</span><span class="op" id="5553541">)</span>&nbsp;<span class="ident" id="5553543">startParse</span><span class="op" id="5553553">(</span><span class="ident" id="5553554">funcs</span>&nbsp;<span class="op" id="5553560">[</span><span class="op" id="5553561">]</span><span class="keyword" id="5553562">map</span><span class="op" id="5553565">[</span><span class="builtintype" id="5553566">string</span><span class="op" id="5553572">]</span><span class="keyword" id="5553573">interface</span><span class="op" id="5553582">{</span><span class="op" id="5553583">}</span><span class="op" id="5553584">,</span>&nbsp;<span class="ident" id="5553586">lex</span>&nbsp;<span class="op" id="5553590">*</span><span class="ident" id="5553591">lexer</span><span class="op" id="5553596">)</span>&nbsp;<span class="op" id="5553598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5553601">t</span><span class="op" id="5553602">.</span><span class="ident" id="5553603">Root</span>&nbsp;<span class="op" id="5553608">=</span>&nbsp;<span class="ident" id="5553610">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5553615">t</span><span class="op" id="5553616">.</span><span class="ident" id="5553617">lex</span>&nbsp;<span class="op" id="5553621">=</span>&nbsp;<span class="ident" id="5553623">lex</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5553628">t</span><span class="op" id="5553629">.</span><span class="ident" id="5553630">vars</span>&nbsp;<span class="op" id="5553635">=</span>&nbsp;<span class="op" id="5553637">[</span><span class="op" id="5553638">]</span><span class="builtintype" id="5553639">string</span><span class="op" id="5553645">{</span><span class="string" id="5553646">&#34;$&#34;</span><span class="op" id="5553649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5553652">t</span><span class="op" id="5553653">.</span><span class="ident" id="5553654">funcs</span>&nbsp;<span class="op" id="5553660">=</span>&nbsp;<span class="ident" id="5553662">funcs</span><br>
<span class="lineno"></span><span class="op" id="5553668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5553671">//&nbsp;stopParse&nbsp;terminates&nbsp;parsing.</span><br>
<span class="lineno">215</span><span class="keyword" id="5553704">func</span>&nbsp;<span class="op" id="5553709">(</span><span class="ident" id="5553710">t</span>&nbsp;<span class="op" id="5553712">*</span><span class="ident" id="5553713">Tree</span><span class="op" id="5553717">)</span>&nbsp;<span class="ident" id="5553719">stopParse</span><span class="op" id="5553728">(</span><span class="op" id="5553729">)</span>&nbsp;<span class="op" id="5553731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5553734">t</span><span class="op" id="5553735">.</span><span class="ident" id="5553736">lex</span>&nbsp;<span class="op" id="5553740">=</span>&nbsp;<span class="ident" id="5553742">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5553747">t</span><span class="op" id="5553748">.</span><span class="ident" id="5553749">vars</span>&nbsp;<span class="op" id="5553754">=</span>&nbsp;<span class="ident" id="5553756">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5553761">t</span><span class="op" id="5553762">.</span><span class="ident" id="5553763">funcs</span>&nbsp;<span class="op" id="5553769">=</span>&nbsp;<span class="ident" id="5553771">nil</span><br>
<span class="lineno"></span><span class="op" id="5553775">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="5553778">//&nbsp;Parse&nbsp;parses&nbsp;the&nbsp;template&nbsp;definition&nbsp;string&nbsp;to&nbsp;construct&nbsp;a&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5553858">//&nbsp;the&nbsp;template&nbsp;for&nbsp;execution.&nbsp;If&nbsp;either&nbsp;action&nbsp;delimiter&nbsp;string&nbsp;is&nbsp;empty,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5553937">//&nbsp;default&nbsp;(&#34;{{&#34;&nbsp;or&nbsp;&#34;}}&#34;)&nbsp;is&nbsp;used.&nbsp;Embedded&nbsp;template&nbsp;definitions&nbsp;are&nbsp;added&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5554015">//&nbsp;the&nbsp;treeSet&nbsp;map.</span><br>
<span class="lineno">225</span><span class="keyword" id="5554035">func</span>&nbsp;<span class="op" id="5554040">(</span><span class="ident" id="5554041">t</span>&nbsp;<span class="op" id="5554043">*</span><span class="ident" id="5554044">Tree</span><span class="op" id="5554048">)</span>&nbsp;<span class="ident" id="5554050">Parse</span><span class="op" id="5554055">(</span><span class="ident" id="5554056">text</span><span class="op" id="5554060">,</span>&nbsp;<span class="ident" id="5554062">leftDelim</span><span class="op" id="5554071">,</span>&nbsp;<span class="ident" id="5554073">rightDelim</span>&nbsp;<span class="builtintype" id="5554084">string</span><span class="op" id="5554090">,</span>&nbsp;<span class="ident" id="5554092">treeSet</span>&nbsp;<span class="keyword" id="5554100">map</span><span class="op" id="5554103">[</span><span class="builtintype" id="5554104">string</span><span class="op" id="5554110">]</span><span class="op" id="5554111">*</span><span class="ident" id="5554112">Tree</span><span class="op" id="5554116">,</span>&nbsp;<span class="ident" id="5554118">funcs</span>&nbsp;<span class="op" id="5554124">...</span><span class="keyword" id="5554127">map</span><span class="op" id="5554130">[</span><span class="builtintype" id="5554131">string</span><span class="op" id="5554137">]</span><span class="keyword" id="5554138">interface</span><span class="op" id="5554147">{</span><span class="op" id="5554148">}</span><span class="op" id="5554149">)</span>&nbsp;<span class="op" id="5554151">(</span><span class="ident" id="5554152">tree</span>&nbsp;<span class="op" id="5554157">*</span><span class="ident" id="5554158">Tree</span><span class="op" id="5554162">,</span>&nbsp;<span class="ident" id="5554164">err</span>&nbsp;<span class="builtintype" id="5554168">error</span><span class="op" id="5554173">)</span>&nbsp;<span class="op" id="5554175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554178">defer</span>&nbsp;<span class="ident" id="5554184">t</span><span class="op" id="5554185">.</span><span class="builtinfunc" id="5554186">recover</span><span class="op" id="5554193">(</span><span class="op" id="5554194">&amp;</span><span class="ident" id="5554195">err</span><span class="op" id="5554198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554201">t</span><span class="op" id="5554202">.</span><span class="ident" id="5554203">ParseName</span>&nbsp;<span class="op" id="5554213">=</span>&nbsp;<span class="ident" id="5554215">t</span><span class="op" id="5554216">.</span><span class="ident" id="5554217">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554223">t</span><span class="op" id="5554224">.</span><span class="ident" id="5554225">startParse</span><span class="op" id="5554235">(</span><span class="ident" id="5554236">funcs</span><span class="op" id="5554241">,</span>&nbsp;<span class="ident" id="5554243">lex</span><span class="op" id="5554246">(</span><span class="ident" id="5554247">t</span><span class="op" id="5554248">.</span><span class="ident" id="5554249">Name</span><span class="op" id="5554253">,</span>&nbsp;<span class="ident" id="5554255">text</span><span class="op" id="5554259">,</span>&nbsp;<span class="ident" id="5554261">leftDelim</span><span class="op" id="5554270">,</span>&nbsp;<span class="ident" id="5554272">rightDelim</span><span class="op" id="5554282">)</span><span class="op" id="5554283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554286">t</span><span class="op" id="5554287">.</span><span class="ident" id="5554288">text</span>&nbsp;<span class="op" id="5554293">=</span>&nbsp;<span class="ident" id="5554295">text</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554301">t</span><span class="op" id="5554302">.</span><span class="ident" id="5554303">parse</span><span class="op" id="5554308">(</span><span class="ident" id="5554309">treeSet</span><span class="op" id="5554316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554319">t</span><span class="op" id="5554320">.</span><span class="ident" id="5554321">add</span><span class="op" id="5554324">(</span><span class="ident" id="5554325">treeSet</span><span class="op" id="5554332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554335">t</span><span class="op" id="5554336">.</span><span class="ident" id="5554337">stopParse</span><span class="op" id="5554346">(</span><span class="op" id="5554347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554350">return</span>&nbsp;<span class="ident" id="5554357">t</span><span class="op" id="5554358">,</span>&nbsp;<span class="ident" id="5554360">nil</span><br>
<span class="lineno"></span><span class="op" id="5554364">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="5554367">//&nbsp;add&nbsp;adds&nbsp;tree&nbsp;to&nbsp;the&nbsp;treeSet.</span><br>
<span class="lineno"></span><span class="keyword" id="5554400">func</span>&nbsp;<span class="op" id="5554405">(</span><span class="ident" id="5554406">t</span>&nbsp;<span class="op" id="5554408">*</span><span class="ident" id="5554409">Tree</span><span class="op" id="5554413">)</span>&nbsp;<span class="ident" id="5554415">add</span><span class="op" id="5554418">(</span><span class="ident" id="5554419">treeSet</span>&nbsp;<span class="keyword" id="5554427">map</span><span class="op" id="5554430">[</span><span class="builtintype" id="5554431">string</span><span class="op" id="5554437">]</span><span class="op" id="5554438">*</span><span class="ident" id="5554439">Tree</span><span class="op" id="5554443">)</span>&nbsp;<span class="op" id="5554445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554448">tree</span>&nbsp;<span class="op" id="5554453">:=</span>&nbsp;<span class="ident" id="5554456">treeSet</span><span class="op" id="5554463">[</span><span class="ident" id="5554464">t</span><span class="op" id="5554465">.</span><span class="ident" id="5554466">Name</span><span class="op" id="5554470">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554473">if</span>&nbsp;<span class="ident" id="5554476">tree</span>&nbsp;<span class="op" id="5554481">==</span>&nbsp;<span class="ident" id="5554484">nil</span>&nbsp;<span class="op" id="5554488">||</span>&nbsp;<span class="ident" id="5554491">IsEmptyTree</span><span class="op" id="5554502">(</span><span class="ident" id="5554503">tree</span><span class="op" id="5554507">.</span><span class="ident" id="5554508">Root</span><span class="op" id="5554512">)</span>&nbsp;<span class="op" id="5554514">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554518">treeSet</span><span class="op" id="5554525">[</span><span class="ident" id="5554526">t</span><span class="op" id="5554527">.</span><span class="ident" id="5554528">Name</span><span class="op" id="5554532">]</span>&nbsp;<span class="op" id="5554534">=</span>&nbsp;<span class="ident" id="5554536">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554540">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5554548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554551">if</span>&nbsp;<span class="op" id="5554554">!</span><span class="ident" id="5554555">IsEmptyTree</span><span class="op" id="5554566">(</span><span class="ident" id="5554567">t</span><span class="op" id="5554568">.</span><span class="ident" id="5554569">Root</span><span class="op" id="5554573">)</span>&nbsp;<span class="op" id="5554575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5554579">t</span><span class="op" id="5554580">.</span><span class="ident" id="5554581">errorf</span><span class="op" id="5554587">(</span><span class="string" id="5554588">&#34;template:&nbsp;multiple&nbsp;definition&nbsp;of&nbsp;template&nbsp;%q&#34;</span><span class="op" id="5554634">,</span>&nbsp;<span class="ident" id="5554636">t</span><span class="op" id="5554637">.</span><span class="ident" id="5554638">Name</span><span class="op" id="5554642">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5554645">}</span><br>
<span class="lineno"></span><span class="op" id="5554647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5554650">//&nbsp;IsEmptyTree&nbsp;reports&nbsp;whether&nbsp;this&nbsp;tree&nbsp;(node)&nbsp;is&nbsp;empty&nbsp;of&nbsp;everything&nbsp;but&nbsp;space.</span><br>
<span class="lineno"></span><span class="keyword" id="5554732">func</span>&nbsp;<span class="ident" id="5554737">IsEmptyTree</span><span class="op" id="5554748">(</span><span class="ident" id="5554749">n</span>&nbsp;<span class="ident" id="5554751">Node</span><span class="op" id="5554755">)</span>&nbsp;<span class="builtintype" id="5554757">bool</span>&nbsp;<span class="op" id="5554762">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554765">switch</span>&nbsp;<span class="ident" id="5554772">n</span>&nbsp;<span class="op" id="5554774">:=</span>&nbsp;<span class="ident" id="5554777">n</span><span class="op" id="5554778">.</span><span class="op" id="5554779">(</span><span class="keyword" id="5554780">type</span><span class="op" id="5554784">)</span>&nbsp;<span class="op" id="5554786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554789">case</span>&nbsp;<span class="ident" id="5554794">nil</span><span class="op" id="5554797">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554801">return</span>&nbsp;<span class="builtintype" id="5554808">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554814">case</span>&nbsp;<span class="op" id="5554819">*</span><span class="ident" id="5554820">ActionNode</span><span class="op" id="5554830">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554833">case</span>&nbsp;<span class="op" id="5554838">*</span><span class="ident" id="5554839">IfNode</span><span class="op" id="5554845">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554848">case</span>&nbsp;<span class="op" id="5554853">*</span><span class="ident" id="5554854">ListNode</span><span class="op" id="5554862">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554866">for</span>&nbsp;<span class="ident" id="5554870">_</span><span class="op" id="5554871">,</span>&nbsp;<span class="ident" id="5554873">node</span>&nbsp;<span class="op" id="5554878">:=</span>&nbsp;<span class="keyword" id="5554881">range</span>&nbsp;<span class="ident" id="5554887">n</span><span class="op" id="5554888">.</span><span class="ident" id="5554889">Nodes</span>&nbsp;<span class="op" id="5554895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554900">if</span>&nbsp;<span class="op" id="5554903">!</span><span class="ident" id="5554904">IsEmptyTree</span><span class="op" id="5554915">(</span><span class="ident" id="5554916">node</span><span class="op" id="5554920">)</span>&nbsp;<span class="op" id="5554922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554928">return</span>&nbsp;<span class="builtintype" id="5554935">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5554944">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5554948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554952">return</span>&nbsp;<span class="builtintype" id="5554959">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554965">case</span>&nbsp;<span class="op" id="5554970">*</span><span class="ident" id="5554971">RangeNode</span><span class="op" id="5554980">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5554983">case</span>&nbsp;<span class="op" id="5554988">*</span><span class="ident" id="5554989">TemplateNode</span><span class="op" id="5555001">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555004">case</span>&nbsp;<span class="op" id="5555009">*</span><span class="ident" id="5555010">TextNode</span><span class="op" id="5555018">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555022">return</span>&nbsp;<span class="builtinfunc" id="5555029">len</span><span class="op" id="5555032">(</span><span class="ident" id="5555033">bytes</span><span class="op" id="5555038">.</span><span class="ident" id="5555039">TrimSpace</span><span class="op" id="5555048">(</span><span class="ident" id="5555049">n</span><span class="op" id="5555050">.</span><span class="ident" id="5555051">Text</span><span class="op" id="5555055">)</span><span class="op" id="5555056">)</span>&nbsp;<span class="op" id="5555058">==</span>&nbsp;<span class="num" id="5555061">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555064">case</span>&nbsp;<span class="op" id="5555069">*</span><span class="ident" id="5555070">WithNode</span><span class="op" id="5555078">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555081">default</span><span class="op" id="5555088">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5555092">panic</span><span class="op" id="5555097">(</span><span class="string" id="5555098">&#34;unknown&nbsp;node:&nbsp;&#34;</span>&nbsp;<span class="op" id="5555115">+</span>&nbsp;<span class="ident" id="5555117">n</span><span class="op" id="5555118">.</span><span class="ident" id="5555119">String</span><span class="op" id="5555125">(</span><span class="op" id="5555126">)</span><span class="op" id="5555127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5555130">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555133">return</span>&nbsp;<span class="builtintype" id="5555140">false</span><br>
<span class="lineno"></span><span class="op" id="5555146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5555149">//&nbsp;parse&nbsp;is&nbsp;the&nbsp;top-level&nbsp;parser&nbsp;for&nbsp;a&nbsp;template,&nbsp;essentially&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="5555219">//&nbsp;as&nbsp;itemList&nbsp;except&nbsp;it&nbsp;also&nbsp;parses&nbsp;{{define}}&nbsp;actions.</span><br>
<span class="lineno">275</span><span class="comment" id="5555276">//&nbsp;It&nbsp;runs&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="5555295">func</span>&nbsp;<span class="op" id="5555300">(</span><span class="ident" id="5555301">t</span>&nbsp;<span class="op" id="5555303">*</span><span class="ident" id="5555304">Tree</span><span class="op" id="5555308">)</span>&nbsp;<span class="ident" id="5555310">parse</span><span class="op" id="5555315">(</span><span class="ident" id="5555316">treeSet</span>&nbsp;<span class="keyword" id="5555324">map</span><span class="op" id="5555327">[</span><span class="builtintype" id="5555328">string</span><span class="op" id="5555334">]</span><span class="op" id="5555335">*</span><span class="ident" id="5555336">Tree</span><span class="op" id="5555340">)</span>&nbsp;<span class="op" id="5555342">(</span><span class="ident" id="5555343">next</span>&nbsp;<span class="ident" id="5555348">Node</span><span class="op" id="5555352">)</span>&nbsp;<span class="op" id="5555354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555357">t</span><span class="op" id="5555358">.</span><span class="ident" id="5555359">Root</span>&nbsp;<span class="op" id="5555364">=</span>&nbsp;<span class="ident" id="5555366">t</span><span class="op" id="5555367">.</span><span class="ident" id="5555368">newList</span><span class="op" id="5555375">(</span><span class="ident" id="5555376">t</span><span class="op" id="5555377">.</span><span class="ident" id="5555378">peek</span><span class="op" id="5555382">(</span><span class="op" id="5555383">)</span><span class="op" id="5555384">.</span><span class="ident" id="5555385">pos</span><span class="op" id="5555388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555391">for</span>&nbsp;<span class="ident" id="5555395">t</span><span class="op" id="5555396">.</span><span class="ident" id="5555397">peek</span><span class="op" id="5555401">(</span><span class="op" id="5555402">)</span><span class="op" id="5555403">.</span><span class="ident" id="5555404">typ</span>&nbsp;<span class="op" id="5555408">!=</span>&nbsp;<span class="ident" id="5555411">itemEOF</span>&nbsp;<span class="op" id="5555419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555423">if</span>&nbsp;<span class="ident" id="5555426">t</span><span class="op" id="5555427">.</span><span class="ident" id="5555428">peek</span><span class="op" id="5555432">(</span><span class="op" id="5555433">)</span><span class="op" id="5555434">.</span><span class="ident" id="5555435">typ</span>&nbsp;<span class="op" id="5555439">==</span>&nbsp;<span class="ident" id="5555442">itemLeftDelim</span>&nbsp;<span class="op" id="5555456">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555461">delim</span>&nbsp;<span class="op" id="5555467">:=</span>&nbsp;<span class="ident" id="5555470">t</span><span class="op" id="5555471">.</span><span class="ident" id="5555472">next</span><span class="op" id="5555476">(</span><span class="op" id="5555477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555482">if</span>&nbsp;<span class="ident" id="5555485">t</span><span class="op" id="5555486">.</span><span class="ident" id="5555487">nextNonSpace</span><span class="op" id="5555499">(</span><span class="op" id="5555500">)</span><span class="op" id="5555501">.</span><span class="ident" id="5555502">typ</span>&nbsp;<span class="op" id="5555506">==</span>&nbsp;<span class="ident" id="5555509">itemDefine</span>&nbsp;<span class="op" id="5555520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555526">newT</span>&nbsp;<span class="op" id="5555531">:=</span>&nbsp;<span class="ident" id="5555534">New</span><span class="op" id="5555537">(</span><span class="string" id="5555538">&#34;definition&#34;</span><span class="op" id="5555550">)</span>&nbsp;<span class="comment" id="5555552">//&nbsp;name&nbsp;will&nbsp;be&nbsp;updated&nbsp;once&nbsp;we&nbsp;know&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555597">newT</span><span class="op" id="5555601">.</span><span class="ident" id="5555602">text</span>&nbsp;<span class="op" id="5555607">=</span>&nbsp;<span class="ident" id="5555609">t</span><span class="op" id="5555610">.</span><span class="ident" id="5555611">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555620">newT</span><span class="op" id="5555624">.</span><span class="ident" id="5555625">ParseName</span>&nbsp;<span class="op" id="5555635">=</span>&nbsp;<span class="ident" id="5555637">t</span><span class="op" id="5555638">.</span><span class="ident" id="5555639">ParseName</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555653">newT</span><span class="op" id="5555657">.</span><span class="ident" id="5555658">startParse</span><span class="op" id="5555668">(</span><span class="ident" id="5555669">t</span><span class="op" id="5555670">.</span><span class="ident" id="5555671">funcs</span><span class="op" id="5555676">,</span>&nbsp;<span class="ident" id="5555678">t</span><span class="op" id="5555679">.</span><span class="ident" id="5555680">lex</span><span class="op" id="5555683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555689">newT</span><span class="op" id="5555693">.</span><span class="ident" id="5555694">parseDefinition</span><span class="op" id="5555709">(</span><span class="ident" id="5555710">treeSet</span><span class="op" id="5555717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555723">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5555735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555740">t</span><span class="op" id="5555741">.</span><span class="ident" id="5555742">backup2</span><span class="op" id="5555749">(</span><span class="ident" id="5555750">delim</span><span class="op" id="5555755">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5555759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555763">n</span>&nbsp;<span class="op" id="5555765">:=</span>&nbsp;<span class="ident" id="5555768">t</span><span class="op" id="5555769">.</span><span class="ident" id="5555770">textOrAction</span><span class="op" id="5555782">(</span><span class="op" id="5555783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555787">if</span>&nbsp;<span class="ident" id="5555790">n</span><span class="op" id="5555791">.</span><span class="ident" id="5555792">Type</span><span class="op" id="5555796">(</span><span class="op" id="5555797">)</span>&nbsp;<span class="op" id="5555799">==</span>&nbsp;<span class="ident" id="5555802">nodeEnd</span>&nbsp;<span class="op" id="5555810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555815">t</span><span class="op" id="5555816">.</span><span class="ident" id="5555817">errorf</span><span class="op" id="5555823">(</span><span class="string" id="5555824">&#34;unexpected&nbsp;%s&#34;</span><span class="op" id="5555839">,</span>&nbsp;<span class="ident" id="5555841">n</span><span class="op" id="5555842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5555846">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5555850">t</span><span class="op" id="5555851">.</span><span class="ident" id="5555852">Root</span><span class="op" id="5555856">.</span><span class="builtinfunc" id="5555857">append</span><span class="op" id="5555863">(</span><span class="ident" id="5555864">n</span><span class="op" id="5555865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5555868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5555871">return</span>&nbsp;<span class="ident" id="5555878">nil</span><br>
<span class="lineno"></span><span class="op" id="5555882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="5555885">//&nbsp;parseDefinition&nbsp;parses&nbsp;a&nbsp;{{define}}&nbsp;...&nbsp;&nbsp;{{end}}&nbsp;template&nbsp;definition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5555961">//&nbsp;installs&nbsp;the&nbsp;definition&nbsp;in&nbsp;the&nbsp;treeSet&nbsp;map.&nbsp;&nbsp;The&nbsp;&#34;define&#34;&nbsp;keyword&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="5556042">//&nbsp;been&nbsp;scanned.</span><br>
<span class="lineno"></span><span class="keyword" id="5556059">func</span>&nbsp;<span class="op" id="5556064">(</span><span class="ident" id="5556065">t</span>&nbsp;<span class="op" id="5556067">*</span><span class="ident" id="5556068">Tree</span><span class="op" id="5556072">)</span>&nbsp;<span class="ident" id="5556074">parseDefinition</span><span class="op" id="5556089">(</span><span class="ident" id="5556090">treeSet</span>&nbsp;<span class="keyword" id="5556098">map</span><span class="op" id="5556101">[</span><span class="builtintype" id="5556102">string</span><span class="op" id="5556108">]</span><span class="op" id="5556109">*</span><span class="ident" id="5556110">Tree</span><span class="op" id="5556114">)</span>&nbsp;<span class="op" id="5556116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556119">const</span>&nbsp;<span class="ident" id="5556125">context</span>&nbsp;<span class="op" id="5556133">=</span>&nbsp;<span class="string" id="5556135">&#34;define&nbsp;clause&#34;</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556152">name</span>&nbsp;<span class="op" id="5556157">:=</span>&nbsp;<span class="ident" id="5556160">t</span><span class="op" id="5556161">.</span><span class="ident" id="5556162">expectOneOf</span><span class="op" id="5556173">(</span><span class="ident" id="5556174">itemString</span><span class="op" id="5556184">,</span>&nbsp;<span class="ident" id="5556186">itemRawString</span><span class="op" id="5556199">,</span>&nbsp;<span class="ident" id="5556201">context</span><span class="op" id="5556208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556211">var</span>&nbsp;<span class="ident" id="5556215">err</span>&nbsp;<span class="builtintype" id="5556219">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556226">t</span><span class="op" id="5556227">.</span><span class="ident" id="5556228">Name</span><span class="op" id="5556232">,</span>&nbsp;<span class="ident" id="5556234">err</span>&nbsp;<span class="op" id="5556238">=</span>&nbsp;<span class="ident" id="5556240">strconv</span><span class="op" id="5556247">.</span><span class="ident" id="5556248">Unquote</span><span class="op" id="5556255">(</span><span class="ident" id="5556256">name</span><span class="op" id="5556260">.</span><span class="ident" id="5556261">val</span><span class="op" id="5556264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556267">if</span>&nbsp;<span class="ident" id="5556270">err</span>&nbsp;<span class="op" id="5556274">!=</span>&nbsp;<span class="ident" id="5556277">nil</span>&nbsp;<span class="op" id="5556281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556285">t</span><span class="op" id="5556286">.</span><span class="builtintype" id="5556287">error</span><span class="op" id="5556292">(</span><span class="ident" id="5556293">err</span><span class="op" id="5556296">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5556299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556302">t</span><span class="op" id="5556303">.</span><span class="ident" id="5556304">expect</span><span class="op" id="5556310">(</span><span class="ident" id="5556311">itemRightDelim</span><span class="op" id="5556325">,</span>&nbsp;<span class="ident" id="5556327">context</span><span class="op" id="5556334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556337">var</span>&nbsp;<span class="ident" id="5556341">end</span>&nbsp;<span class="ident" id="5556345">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556351">t</span><span class="op" id="5556352">.</span><span class="ident" id="5556353">Root</span><span class="op" id="5556357">,</span>&nbsp;<span class="ident" id="5556359">end</span>&nbsp;<span class="op" id="5556363">=</span>&nbsp;<span class="ident" id="5556365">t</span><span class="op" id="5556366">.</span><span class="ident" id="5556367">itemList</span><span class="op" id="5556375">(</span><span class="op" id="5556376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556379">if</span>&nbsp;<span class="ident" id="5556382">end</span><span class="op" id="5556385">.</span><span class="ident" id="5556386">Type</span><span class="op" id="5556390">(</span><span class="op" id="5556391">)</span>&nbsp;<span class="op" id="5556393">!=</span>&nbsp;<span class="ident" id="5556396">nodeEnd</span>&nbsp;<span class="op" id="5556404">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556408">t</span><span class="op" id="5556409">.</span><span class="ident" id="5556410">errorf</span><span class="op" id="5556416">(</span><span class="string" id="5556417">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="5556438">,</span>&nbsp;<span class="ident" id="5556440">end</span><span class="op" id="5556443">,</span>&nbsp;<span class="ident" id="5556445">context</span><span class="op" id="5556452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5556455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556458">t</span><span class="op" id="5556459">.</span><span class="ident" id="5556460">add</span><span class="op" id="5556463">(</span><span class="ident" id="5556464">treeSet</span><span class="op" id="5556471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556474">t</span><span class="op" id="5556475">.</span><span class="ident" id="5556476">stopParse</span><span class="op" id="5556485">(</span><span class="op" id="5556486">)</span><br>
<span class="lineno"></span><span class="op" id="5556488">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span><span class="comment" id="5556491">//&nbsp;itemList:</span><br>
<span class="lineno"></span><span class="comment" id="5556504">//&nbsp;&nbsp;&nbsp;&nbsptextOrAction*</span><br>
<span class="lineno"></span><span class="comment" id="5556521">//&nbsp;Terminates&nbsp;at&nbsp;{{end}}&nbsp;or&nbsp;{{else}},&nbsp;returned&nbsp;separately.</span><br>
<span class="lineno"></span><span class="keyword" id="5556580">func</span>&nbsp;<span class="op" id="5556585">(</span><span class="ident" id="5556586">t</span>&nbsp;<span class="op" id="5556588">*</span><span class="ident" id="5556589">Tree</span><span class="op" id="5556593">)</span>&nbsp;<span class="ident" id="5556595">itemList</span><span class="op" id="5556603">(</span><span class="op" id="5556604">)</span>&nbsp;<span class="op" id="5556606">(</span><span class="ident" id="5556607">list</span>&nbsp;<span class="op" id="5556612">*</span><span class="ident" id="5556613">ListNode</span><span class="op" id="5556621">,</span>&nbsp;<span class="ident" id="5556623">next</span>&nbsp;<span class="ident" id="5556628">Node</span><span class="op" id="5556632">)</span>&nbsp;<span class="op" id="5556634">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556637">list</span>&nbsp;<span class="op" id="5556642">=</span>&nbsp;<span class="ident" id="5556644">t</span><span class="op" id="5556645">.</span><span class="ident" id="5556646">newList</span><span class="op" id="5556653">(</span><span class="ident" id="5556654">t</span><span class="op" id="5556655">.</span><span class="ident" id="5556656">peekNonSpace</span><span class="op" id="5556668">(</span><span class="op" id="5556669">)</span><span class="op" id="5556670">.</span><span class="ident" id="5556671">pos</span><span class="op" id="5556674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556677">for</span>&nbsp;<span class="ident" id="5556681">t</span><span class="op" id="5556682">.</span><span class="ident" id="5556683">peekNonSpace</span><span class="op" id="5556695">(</span><span class="op" id="5556696">)</span><span class="op" id="5556697">.</span><span class="ident" id="5556698">typ</span>&nbsp;<span class="op" id="5556702">!=</span>&nbsp;<span class="ident" id="5556705">itemEOF</span>&nbsp;<span class="op" id="5556713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556717">n</span>&nbsp;<span class="op" id="5556719">:=</span>&nbsp;<span class="ident" id="5556722">t</span><span class="op" id="5556723">.</span><span class="ident" id="5556724">textOrAction</span><span class="op" id="5556736">(</span><span class="op" id="5556737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556741">switch</span>&nbsp;<span class="ident" id="5556748">n</span><span class="op" id="5556749">.</span><span class="ident" id="5556750">Type</span><span class="op" id="5556754">(</span><span class="op" id="5556755">)</span>&nbsp;<span class="op" id="5556757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556761">case</span>&nbsp;<span class="ident" id="5556766">nodeEnd</span><span class="op" id="5556773">,</span>&nbsp;<span class="ident" id="5556775">nodeElse</span><span class="op" id="5556783">:</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556788">return</span>&nbsp;<span class="ident" id="5556795">list</span><span class="op" id="5556799">,</span>&nbsp;<span class="ident" id="5556801">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5556805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556809">list</span><span class="op" id="5556813">.</span><span class="builtinfunc" id="5556814">append</span><span class="op" id="5556820">(</span><span class="ident" id="5556821">n</span><span class="op" id="5556822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5556825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5556828">t</span><span class="op" id="5556829">.</span><span class="ident" id="5556830">errorf</span><span class="op" id="5556836">(</span><span class="string" id="5556837">&#34;unexpected&nbsp;EOF&#34;</span><span class="op" id="5556853">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556856">return</span><br>
<span class="lineno"></span><span class="op" id="5556863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5556866">//&nbsp;textOrAction:</span><br>
<span class="lineno"></span><span class="comment" id="5556883">//&nbsp;&nbsp;&nbsp;&nbsptext&nbsp;|&nbsp;action</span><br>
<span class="lineno">340</span><span class="keyword" id="5556900">func</span>&nbsp;<span class="op" id="5556905">(</span><span class="ident" id="5556906">t</span>&nbsp;<span class="op" id="5556908">*</span><span class="ident" id="5556909">Tree</span><span class="op" id="5556913">)</span>&nbsp;<span class="ident" id="5556915">textOrAction</span><span class="op" id="5556927">(</span><span class="op" id="5556928">)</span>&nbsp;<span class="ident" id="5556930">Node</span>&nbsp;<span class="op" id="5556935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556938">switch</span>&nbsp;<span class="ident" id="5556945">token</span>&nbsp;<span class="op" id="5556951">:=</span>&nbsp;<span class="ident" id="5556954">t</span><span class="op" id="5556955">.</span><span class="ident" id="5556956">nextNonSpace</span><span class="op" id="5556968">(</span><span class="op" id="5556969">)</span><span class="op" id="5556970">;</span>&nbsp;<span class="ident" id="5556972">token</span><span class="op" id="5556977">.</span><span class="ident" id="5556978">typ</span>&nbsp;<span class="op" id="5556982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5556985">case</span>&nbsp;<span class="ident" id="5556990">itemText</span><span class="op" id="5556998">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557002">return</span>&nbsp;<span class="ident" id="5557009">t</span><span class="op" id="5557010">.</span><span class="ident" id="5557011">newText</span><span class="op" id="5557018">(</span><span class="ident" id="5557019">token</span><span class="op" id="5557024">.</span><span class="ident" id="5557025">pos</span><span class="op" id="5557028">,</span>&nbsp;<span class="ident" id="5557030">token</span><span class="op" id="5557035">.</span><span class="ident" id="5557036">val</span><span class="op" id="5557039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557042">case</span>&nbsp;<span class="ident" id="5557047">itemLeftDelim</span><span class="op" id="5557060">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557064">return</span>&nbsp;<span class="ident" id="5557071">t</span><span class="op" id="5557072">.</span><span class="ident" id="5557073">action</span><span class="op" id="5557079">(</span><span class="op" id="5557080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557083">default</span><span class="op" id="5557090">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5557094">t</span><span class="op" id="5557095">.</span><span class="ident" id="5557096">unexpected</span><span class="op" id="5557106">(</span><span class="ident" id="5557107">token</span><span class="op" id="5557112">,</span>&nbsp;<span class="string" id="5557114">&#34;input&#34;</span><span class="op" id="5557121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5557124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557127">return</span>&nbsp;<span class="ident" id="5557134">nil</span><br>
<span class="lineno">350</span><span class="op" id="5557138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5557141">//&nbsp;Action:</span><br>
<span class="lineno"></span><span class="comment" id="5557152">//&nbsp;&nbsp;&nbsp;&nbspcontrol</span><br>
<span class="lineno"></span><span class="comment" id="5557163">//&nbsp;&nbsp;&nbsp;&nbspcommand&nbsp;(&#34;|&#34;&nbsp;command)*</span><br>
<span class="lineno">355</span><span class="comment" id="5557189">//&nbsp;Left&nbsp;delim&nbsp;is&nbsp;past.&nbsp;Now&nbsp;get&nbsp;actions.</span><br>
<span class="lineno"></span><span class="comment" id="5557229">//&nbsp;First&nbsp;word&nbsp;could&nbsp;be&nbsp;a&nbsp;keyword&nbsp;such&nbsp;as&nbsp;range.</span><br>
<span class="lineno"></span><span class="keyword" id="5557277">func</span>&nbsp;<span class="op" id="5557282">(</span><span class="ident" id="5557283">t</span>&nbsp;<span class="op" id="5557285">*</span><span class="ident" id="5557286">Tree</span><span class="op" id="5557290">)</span>&nbsp;<span class="ident" id="5557292">action</span><span class="op" id="5557298">(</span><span class="op" id="5557299">)</span>&nbsp;<span class="op" id="5557301">(</span><span class="ident" id="5557302">n</span>&nbsp;<span class="ident" id="5557304">Node</span><span class="op" id="5557308">)</span>&nbsp;<span class="op" id="5557310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557313">switch</span>&nbsp;<span class="ident" id="5557320">token</span>&nbsp;<span class="op" id="5557326">:=</span>&nbsp;<span class="ident" id="5557329">t</span><span class="op" id="5557330">.</span><span class="ident" id="5557331">nextNonSpace</span><span class="op" id="5557343">(</span><span class="op" id="5557344">)</span><span class="op" id="5557345">;</span>&nbsp;<span class="ident" id="5557347">token</span><span class="op" id="5557352">.</span><span class="ident" id="5557353">typ</span>&nbsp;<span class="op" id="5557357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557360">case</span>&nbsp;<span class="ident" id="5557365">itemElse</span><span class="op" id="5557373">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557377">return</span>&nbsp;<span class="ident" id="5557384">t</span><span class="op" id="5557385">.</span><span class="ident" id="5557386">elseControl</span><span class="op" id="5557397">(</span><span class="op" id="5557398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557401">case</span>&nbsp;<span class="ident" id="5557406">itemEnd</span><span class="op" id="5557413">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557417">return</span>&nbsp;<span class="ident" id="5557424">t</span><span class="op" id="5557425">.</span><span class="ident" id="5557426">endControl</span><span class="op" id="5557436">(</span><span class="op" id="5557437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557440">case</span>&nbsp;<span class="ident" id="5557445">itemIf</span><span class="op" id="5557451">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557455">return</span>&nbsp;<span class="ident" id="5557462">t</span><span class="op" id="5557463">.</span><span class="ident" id="5557464">ifControl</span><span class="op" id="5557473">(</span><span class="op" id="5557474">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557477">case</span>&nbsp;<span class="ident" id="5557482">itemRange</span><span class="op" id="5557491">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557495">return</span>&nbsp;<span class="ident" id="5557502">t</span><span class="op" id="5557503">.</span><span class="ident" id="5557504">rangeControl</span><span class="op" id="5557516">(</span><span class="op" id="5557517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557520">case</span>&nbsp;<span class="ident" id="5557525">itemTemplate</span><span class="op" id="5557537">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557541">return</span>&nbsp;<span class="ident" id="5557548">t</span><span class="op" id="5557549">.</span><span class="ident" id="5557550">templateControl</span><span class="op" id="5557565">(</span><span class="op" id="5557566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557569">case</span>&nbsp;<span class="ident" id="5557574">itemWith</span><span class="op" id="5557582">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557586">return</span>&nbsp;<span class="ident" id="5557593">t</span><span class="op" id="5557594">.</span><span class="ident" id="5557595">withControl</span><span class="op" id="5557606">(</span><span class="op" id="5557607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5557610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5557613">t</span><span class="op" id="5557614">.</span><span class="ident" id="5557615">backup</span><span class="op" id="5557621">(</span><span class="op" id="5557622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5557625">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557677">return</span>&nbsp;<span class="ident" id="5557684">t</span><span class="op" id="5557685">.</span><span class="ident" id="5557686">newAction</span><span class="op" id="5557695">(</span><span class="ident" id="5557696">t</span><span class="op" id="5557697">.</span><span class="ident" id="5557698">peek</span><span class="op" id="5557702">(</span><span class="op" id="5557703">)</span><span class="op" id="5557704">.</span><span class="ident" id="5557705">pos</span><span class="op" id="5557708">,</span>&nbsp;<span class="ident" id="5557710">t</span><span class="op" id="5557711">.</span><span class="ident" id="5557712">lex</span><span class="op" id="5557715">.</span><span class="ident" id="5557716">lineNumber</span><span class="op" id="5557726">(</span><span class="op" id="5557727">)</span><span class="op" id="5557728">,</span>&nbsp;<span class="ident" id="5557730">t</span><span class="op" id="5557731">.</span><span class="ident" id="5557732">pipeline</span><span class="op" id="5557740">(</span><span class="string" id="5557741">&#34;command&#34;</span><span class="op" id="5557750">)</span><span class="op" id="5557751">)</span><br>
<span class="lineno">375</span><span class="op" id="5557753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5557756">//&nbsp;Pipeline:</span><br>
<span class="lineno"></span><span class="comment" id="5557769">//&nbsp;&nbsp;&nbsp;&nbspdeclarations?&nbsp;command&nbsp;(&#39;|&#39;&nbsp;command)*</span><br>
<span class="lineno"></span><span class="keyword" id="5557809">func</span>&nbsp;<span class="op" id="5557814">(</span><span class="ident" id="5557815">t</span>&nbsp;<span class="op" id="5557817">*</span><span class="ident" id="5557818">Tree</span><span class="op" id="5557822">)</span>&nbsp;<span class="ident" id="5557824">pipeline</span><span class="op" id="5557832">(</span><span class="ident" id="5557833">context</span>&nbsp;<span class="builtintype" id="5557841">string</span><span class="op" id="5557847">)</span>&nbsp;<span class="op" id="5557849">(</span><span class="ident" id="5557850">pipe</span>&nbsp;<span class="op" id="5557855">*</span><span class="ident" id="5557856">PipeNode</span><span class="op" id="5557864">)</span>&nbsp;<span class="op" id="5557866">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557869">var</span>&nbsp;<span class="ident" id="5557873">decl</span>&nbsp;<span class="op" id="5557878">[</span><span class="op" id="5557879">]</span><span class="op" id="5557880">*</span><span class="ident" id="5557881">VariableNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5557895">pos</span>&nbsp;<span class="op" id="5557899">:=</span>&nbsp;<span class="ident" id="5557902">t</span><span class="op" id="5557903">.</span><span class="ident" id="5557904">peekNonSpace</span><span class="op" id="5557916">(</span><span class="op" id="5557917">)</span><span class="op" id="5557918">.</span><span class="ident" id="5557919">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5557924">//&nbsp;Are&nbsp;there&nbsp;declarations?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557952">for</span>&nbsp;<span class="op" id="5557956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5557960">if</span>&nbsp;<span class="ident" id="5557963">v</span>&nbsp;<span class="op" id="5557965">:=</span>&nbsp;<span class="ident" id="5557968">t</span><span class="op" id="5557969">.</span><span class="ident" id="5557970">peekNonSpace</span><span class="op" id="5557982">(</span><span class="op" id="5557983">)</span><span class="op" id="5557984">;</span>&nbsp;<span class="ident" id="5557986">v</span><span class="op" id="5557987">.</span><span class="ident" id="5557988">typ</span>&nbsp;<span class="op" id="5557992">==</span>&nbsp;<span class="ident" id="5557995">itemVariable</span>&nbsp;<span class="op" id="5558008">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558013">t</span><span class="op" id="5558014">.</span><span class="ident" id="5558015">next</span><span class="op" id="5558019">(</span><span class="op" id="5558020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5558025">//&nbsp;Since&nbsp;space&nbsp;is&nbsp;a&nbsp;token,&nbsp;we&nbsp;need&nbsp;3-token&nbsp;look-ahead&nbsp;here&nbsp;in&nbsp;the&nbsp;worst&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5558106">//&nbsp;in&nbsp;&#34;$x&nbsp;foo&#34;&nbsp;we&nbsp;need&nbsp;to&nbsp;read&nbsp;&#34;foo&#34;&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;&#34;:=&#34;)&nbsp;to&nbsp;know&nbsp;that&nbsp;$x&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5558189">//&nbsp;argument&nbsp;variable&nbsp;rather&nbsp;than&nbsp;a&nbsp;declaration.&nbsp;So&nbsp;remember&nbsp;the&nbsp;token</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5558262">//&nbsp;adjacent&nbsp;to&nbsp;the&nbsp;variable&nbsp;so&nbsp;we&nbsp;can&nbsp;push&nbsp;it&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558330">tokenAfterVariable</span>&nbsp;<span class="op" id="5558349">:=</span>&nbsp;<span class="ident" id="5558352">t</span><span class="op" id="5558353">.</span><span class="ident" id="5558354">peek</span><span class="op" id="5558358">(</span><span class="op" id="5558359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558364">if</span>&nbsp;<span class="ident" id="5558367">next</span>&nbsp;<span class="op" id="5558372">:=</span>&nbsp;<span class="ident" id="5558375">t</span><span class="op" id="5558376">.</span><span class="ident" id="5558377">peekNonSpace</span><span class="op" id="5558389">(</span><span class="op" id="5558390">)</span><span class="op" id="5558391">;</span>&nbsp;<span class="ident" id="5558393">next</span><span class="op" id="5558397">.</span><span class="ident" id="5558398">typ</span>&nbsp;<span class="op" id="5558402">==</span>&nbsp;<span class="ident" id="5558405">itemColonEquals</span>&nbsp;<span class="op" id="5558421">||</span>&nbsp;<span class="op" id="5558424">(</span><span class="ident" id="5558425">next</span><span class="op" id="5558429">.</span><span class="ident" id="5558430">typ</span>&nbsp;<span class="op" id="5558434">==</span>&nbsp;<span class="ident" id="5558437">itemChar</span>&nbsp;<span class="op" id="5558446">&amp;&amp;</span>&nbsp;<span class="ident" id="5558449">next</span><span class="op" id="5558453">.</span><span class="ident" id="5558454">val</span>&nbsp;<span class="op" id="5558458">==</span>&nbsp;<span class="string" id="5558461">&#34;,&#34;</span><span class="op" id="5558464">)</span>&nbsp;<span class="op" id="5558466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558472">t</span><span class="op" id="5558473">.</span><span class="ident" id="5558474">nextNonSpace</span><span class="op" id="5558486">(</span><span class="op" id="5558487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558493">variable</span>&nbsp;<span class="op" id="5558502">:=</span>&nbsp;<span class="ident" id="5558505">t</span><span class="op" id="5558506">.</span><span class="ident" id="5558507">newVariable</span><span class="op" id="5558518">(</span><span class="ident" id="5558519">v</span><span class="op" id="5558520">.</span><span class="ident" id="5558521">pos</span><span class="op" id="5558524">,</span>&nbsp;<span class="ident" id="5558526">v</span><span class="op" id="5558527">.</span><span class="ident" id="5558528">val</span><span class="op" id="5558531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558537">decl</span>&nbsp;<span class="op" id="5558542">=</span>&nbsp;<span class="builtinfunc" id="5558544">append</span><span class="op" id="5558550">(</span><span class="ident" id="5558551">decl</span><span class="op" id="5558555">,</span>&nbsp;<span class="ident" id="5558557">variable</span><span class="op" id="5558565">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558571">t</span><span class="op" id="5558572">.</span><span class="ident" id="5558573">vars</span>&nbsp;<span class="op" id="5558578">=</span>&nbsp;<span class="builtinfunc" id="5558580">append</span><span class="op" id="5558586">(</span><span class="ident" id="5558587">t</span><span class="op" id="5558588">.</span><span class="ident" id="5558589">vars</span><span class="op" id="5558593">,</span>&nbsp;<span class="ident" id="5558595">v</span><span class="op" id="5558596">.</span><span class="ident" id="5558597">val</span><span class="op" id="5558600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558606">if</span>&nbsp;<span class="ident" id="5558609">next</span><span class="op" id="5558613">.</span><span class="ident" id="5558614">typ</span>&nbsp;<span class="op" id="5558618">==</span>&nbsp;<span class="ident" id="5558621">itemChar</span>&nbsp;<span class="op" id="5558630">&amp;&amp;</span>&nbsp;<span class="ident" id="5558633">next</span><span class="op" id="5558637">.</span><span class="ident" id="5558638">val</span>&nbsp;<span class="op" id="5558642">==</span>&nbsp;<span class="string" id="5558645">&#34;,&#34;</span>&nbsp;<span class="op" id="5558649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558656">if</span>&nbsp;<span class="ident" id="5558659">context</span>&nbsp;<span class="op" id="5558667">==</span>&nbsp;<span class="string" id="5558670">&#34;range&#34;</span>&nbsp;<span class="op" id="5558678">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5558681">len</span><span class="op" id="5558684">(</span><span class="ident" id="5558685">decl</span><span class="op" id="5558689">)</span>&nbsp;<span class="op" id="5558691">&lt;</span>&nbsp;<span class="num" id="5558693">2</span>&nbsp;<span class="op" id="5558695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558703">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5558717">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558724">t</span><span class="op" id="5558725">.</span><span class="ident" id="5558726">errorf</span><span class="op" id="5558732">(</span><span class="string" id="5558733">&#34;too&nbsp;many&nbsp;declarations&nbsp;in&nbsp;%s&#34;</span><span class="op" id="5558762">,</span>&nbsp;<span class="ident" id="5558764">context</span><span class="op" id="5558771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5558777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5558782">}</span>&nbsp;<span class="keyword" id="5558784">else</span>&nbsp;<span class="keyword" id="5558789">if</span>&nbsp;<span class="ident" id="5558792">tokenAfterVariable</span><span class="op" id="5558810">.</span><span class="ident" id="5558811">typ</span>&nbsp;<span class="op" id="5558815">==</span>&nbsp;<span class="ident" id="5558818">itemSpace</span>&nbsp;<span class="op" id="5558828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558834">t</span><span class="op" id="5558835">.</span><span class="ident" id="5558836">backup3</span><span class="op" id="5558843">(</span><span class="ident" id="5558844">v</span><span class="op" id="5558845">,</span>&nbsp;<span class="ident" id="5558847">tokenAfterVariable</span><span class="op" id="5558865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5558870">}</span>&nbsp;<span class="keyword" id="5558872">else</span>&nbsp;<span class="op" id="5558877">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558883">t</span><span class="op" id="5558884">.</span><span class="ident" id="5558885">backup2</span><span class="op" id="5558892">(</span><span class="ident" id="5558893">v</span><span class="op" id="5558894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5558899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5558903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558907">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5558914">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5558917">pipe</span>&nbsp;<span class="op" id="5558922">=</span>&nbsp;<span class="ident" id="5558924">t</span><span class="op" id="5558925">.</span><span class="ident" id="5558926">newPipeline</span><span class="op" id="5558937">(</span><span class="ident" id="5558938">pos</span><span class="op" id="5558941">,</span>&nbsp;<span class="ident" id="5558943">t</span><span class="op" id="5558944">.</span><span class="ident" id="5558945">lex</span><span class="op" id="5558948">.</span><span class="ident" id="5558949">lineNumber</span><span class="op" id="5558959">(</span><span class="op" id="5558960">)</span><span class="op" id="5558961">,</span>&nbsp;<span class="ident" id="5558963">decl</span><span class="op" id="5558967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558970">for</span>&nbsp;<span class="op" id="5558974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5558978">switch</span>&nbsp;<span class="ident" id="5558985">token</span>&nbsp;<span class="op" id="5558991">:=</span>&nbsp;<span class="ident" id="5558994">t</span><span class="op" id="5558995">.</span><span class="ident" id="5558996">nextNonSpace</span><span class="op" id="5559008">(</span><span class="op" id="5559009">)</span><span class="op" id="5559010">;</span>&nbsp;<span class="ident" id="5559012">token</span><span class="op" id="5559017">.</span><span class="ident" id="5559018">typ</span>&nbsp;<span class="op" id="5559022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559026">case</span>&nbsp;<span class="ident" id="5559031">itemRightDelim</span><span class="op" id="5559045">,</span>&nbsp;<span class="ident" id="5559047">itemRightParen</span><span class="op" id="5559061">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559066">if</span>&nbsp;<span class="builtinfunc" id="5559069">len</span><span class="op" id="5559072">(</span><span class="ident" id="5559073">pipe</span><span class="op" id="5559077">.</span><span class="ident" id="5559078">Cmds</span><span class="op" id="5559082">)</span>&nbsp;<span class="op" id="5559084">==</span>&nbsp;<span class="num" id="5559087">0</span>&nbsp;<span class="op" id="5559089">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5559095">t</span><span class="op" id="5559096">.</span><span class="ident" id="5559097">errorf</span><span class="op" id="5559103">(</span><span class="string" id="5559104">&#34;missing&nbsp;value&nbsp;for&nbsp;%s&#34;</span><span class="op" id="5559126">,</span>&nbsp;<span class="ident" id="5559128">context</span><span class="op" id="5559135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5559140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559145">if</span>&nbsp;<span class="ident" id="5559148">token</span><span class="op" id="5559153">.</span><span class="ident" id="5559154">typ</span>&nbsp;<span class="op" id="5559158">==</span>&nbsp;<span class="ident" id="5559161">itemRightParen</span>&nbsp;<span class="op" id="5559176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5559182">t</span><span class="op" id="5559183">.</span><span class="ident" id="5559184">backup</span><span class="op" id="5559190">(</span><span class="op" id="5559191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5559196">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559201">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559210">case</span>&nbsp;<span class="ident" id="5559215">itemBool</span><span class="op" id="5559223">,</span>&nbsp;<span class="ident" id="5559225">itemCharConstant</span><span class="op" id="5559241">,</span>&nbsp;<span class="ident" id="5559243">itemComplex</span><span class="op" id="5559254">,</span>&nbsp;<span class="ident" id="5559256">itemDot</span><span class="op" id="5559263">,</span>&nbsp;<span class="ident" id="5559265">itemField</span><span class="op" id="5559274">,</span>&nbsp;<span class="ident" id="5559276">itemIdentifier</span><span class="op" id="5559290">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5559295">itemNumber</span><span class="op" id="5559305">,</span>&nbsp;<span class="ident" id="5559307">itemNil</span><span class="op" id="5559314">,</span>&nbsp;<span class="ident" id="5559316">itemRawString</span><span class="op" id="5559329">,</span>&nbsp;<span class="ident" id="5559331">itemString</span><span class="op" id="5559341">,</span>&nbsp;<span class="ident" id="5559343">itemVariable</span><span class="op" id="5559355">,</span>&nbsp;<span class="ident" id="5559357">itemLeftParen</span><span class="op" id="5559370">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5559375">t</span><span class="op" id="5559376">.</span><span class="ident" id="5559377">backup</span><span class="op" id="5559383">(</span><span class="op" id="5559384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5559389">pipe</span><span class="op" id="5559393">.</span><span class="builtinfunc" id="5559394">append</span><span class="op" id="5559400">(</span><span class="ident" id="5559401">t</span><span class="op" id="5559402">.</span><span class="ident" id="5559403">command</span><span class="op" id="5559410">(</span><span class="op" id="5559411">)</span><span class="op" id="5559412">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559416">default</span><span class="op" id="5559423">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5559428">t</span><span class="op" id="5559429">.</span><span class="ident" id="5559430">unexpected</span><span class="op" id="5559440">(</span><span class="ident" id="5559441">token</span><span class="op" id="5559446">,</span>&nbsp;<span class="ident" id="5559448">context</span><span class="op" id="5559455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5559459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5559462">}</span><br>
<span class="lineno"></span><span class="op" id="5559464">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="5559467">func</span>&nbsp;<span class="op" id="5559472">(</span><span class="ident" id="5559473">t</span>&nbsp;<span class="op" id="5559475">*</span><span class="ident" id="5559476">Tree</span><span class="op" id="5559480">)</span>&nbsp;<span class="ident" id="5559482">parseControl</span><span class="op" id="5559494">(</span><span class="ident" id="5559495">allowElseIf</span>&nbsp;<span class="builtintype" id="5559507">bool</span><span class="op" id="5559511">,</span>&nbsp;<span class="ident" id="5559513">context</span>&nbsp;<span class="builtintype" id="5559521">string</span><span class="op" id="5559527">)</span>&nbsp;<span class="op" id="5559529">(</span><span class="ident" id="5559530">pos</span>&nbsp;<span class="ident" id="5559534">Pos</span><span class="op" id="5559537">,</span>&nbsp;<span class="ident" id="5559539">line</span>&nbsp;<span class="builtintype" id="5559544">int</span><span class="op" id="5559547">,</span>&nbsp;<span class="ident" id="5559549">pipe</span>&nbsp;<span class="op" id="5559554">*</span><span class="ident" id="5559555">PipeNode</span><span class="op" id="5559563">,</span>&nbsp;<span class="ident" id="5559565">list</span><span class="op" id="5559569">,</span>&nbsp;<span class="ident" id="5559571">elseList</span>&nbsp;<span class="op" id="5559580">*</span><span class="ident" id="5559581">ListNode</span><span class="op" id="5559589">)</span>&nbsp;<span class="op" id="5559591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559594">defer</span>&nbsp;<span class="ident" id="5559600">t</span><span class="op" id="5559601">.</span><span class="ident" id="5559602">popVars</span><span class="op" id="5559609">(</span><span class="builtinfunc" id="5559610">len</span><span class="op" id="5559613">(</span><span class="ident" id="5559614">t</span><span class="op" id="5559615">.</span><span class="ident" id="5559616">vars</span><span class="op" id="5559620">)</span><span class="op" id="5559621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5559624">line</span>&nbsp;<span class="op" id="5559629">=</span>&nbsp;<span class="ident" id="5559631">t</span><span class="op" id="5559632">.</span><span class="ident" id="5559633">lex</span><span class="op" id="5559636">.</span><span class="ident" id="5559637">lineNumber</span><span class="op" id="5559647">(</span><span class="op" id="5559648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5559651">pipe</span>&nbsp;<span class="op" id="5559656">=</span>&nbsp;<span class="ident" id="5559658">t</span><span class="op" id="5559659">.</span><span class="ident" id="5559660">pipeline</span><span class="op" id="5559668">(</span><span class="ident" id="5559669">context</span><span class="op" id="5559676">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559679">var</span>&nbsp;<span class="ident" id="5559683">next</span>&nbsp;<span class="ident" id="5559688">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5559694">list</span><span class="op" id="5559698">,</span>&nbsp;<span class="ident" id="5559700">next</span>&nbsp;<span class="op" id="5559705">=</span>&nbsp;<span class="ident" id="5559707">t</span><span class="op" id="5559708">.</span><span class="ident" id="5559709">itemList</span><span class="op" id="5559717">(</span><span class="op" id="5559718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559721">switch</span>&nbsp;<span class="ident" id="5559728">next</span><span class="op" id="5559732">.</span><span class="ident" id="5559733">Type</span><span class="op" id="5559737">(</span><span class="op" id="5559738">)</span>&nbsp;<span class="op" id="5559740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559743">case</span>&nbsp;<span class="ident" id="5559748">nodeEnd</span><span class="op" id="5559755">:</span>&nbsp;<span class="comment" id="5559757">//done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559765">case</span>&nbsp;<span class="ident" id="5559770">nodeElse</span><span class="op" id="5559778">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5559782">if</span>&nbsp;<span class="ident" id="5559785">allowElseIf</span>&nbsp;<span class="op" id="5559797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5559802">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.&nbsp;If&nbsp;the&nbsp;&#34;else&#34;&nbsp;is&nbsp;followed&nbsp;immediately&nbsp;by&nbsp;an&nbsp;&#34;if&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5559886">//&nbsp;the&nbsp;elseControl&nbsp;will&nbsp;have&nbsp;left&nbsp;the&nbsp;&#34;if&#34;&nbsp;token&nbsp;pending.&nbsp;Treat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5559953">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;a}}_{{else&nbsp;if&nbsp;b}}_{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5559990">//&nbsp;as</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5559999">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;a}}_{{else}}{{if&nbsp;b}}_{{end}}{{end}}.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5560047">//&nbsp;To&nbsp;do&nbsp;this,&nbsp;parse&nbsp;the&nbsp;if&nbsp;as&nbsp;usual&nbsp;and&nbsp;stop&nbsp;at&nbsp;it&nbsp;{{end}};&nbsp;the&nbsp;subsequent{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5560133">//&nbsp;is&nbsp;assumed.&nbsp;This&nbsp;technique&nbsp;works&nbsp;even&nbsp;for&nbsp;long&nbsp;if-else-if&nbsp;chains.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5560205">//&nbsp;TODO:&nbsp;Should&nbsp;we&nbsp;allow&nbsp;else-if&nbsp;in&nbsp;with&nbsp;and&nbsp;range?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560260">if</span>&nbsp;<span class="ident" id="5560263">t</span><span class="op" id="5560264">.</span><span class="ident" id="5560265">peek</span><span class="op" id="5560269">(</span><span class="op" id="5560270">)</span><span class="op" id="5560271">.</span><span class="ident" id="5560272">typ</span>&nbsp;<span class="op" id="5560276">==</span>&nbsp;<span class="ident" id="5560279">itemIf</span>&nbsp;<span class="op" id="5560286">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5560292">t</span><span class="op" id="5560293">.</span><span class="ident" id="5560294">next</span><span class="op" id="5560298">(</span><span class="op" id="5560299">)</span>&nbsp;<span class="comment" id="5560301">//&nbsp;Consume&nbsp;the&nbsp;&#34;if&#34;&nbsp;token.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5560332">elseList</span>&nbsp;<span class="op" id="5560341">=</span>&nbsp;<span class="ident" id="5560343">t</span><span class="op" id="5560344">.</span><span class="ident" id="5560345">newList</span><span class="op" id="5560352">(</span><span class="ident" id="5560353">next</span><span class="op" id="5560357">.</span><span class="ident" id="5560358">Position</span><span class="op" id="5560366">(</span><span class="op" id="5560367">)</span><span class="op" id="5560368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5560374">elseList</span><span class="op" id="5560382">.</span><span class="builtinfunc" id="5560383">append</span><span class="op" id="5560389">(</span><span class="ident" id="5560390">t</span><span class="op" id="5560391">.</span><span class="ident" id="5560392">ifControl</span><span class="op" id="5560401">(</span><span class="op" id="5560402">)</span><span class="op" id="5560403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5560409">//&nbsp;Do&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;item&nbsp;-&nbsp;only&nbsp;one&nbsp;{{end}}&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560474">break</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5560483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5560487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5560491">elseList</span><span class="op" id="5560499">,</span>&nbsp;<span class="ident" id="5560501">next</span>&nbsp;<span class="op" id="5560506">=</span>&nbsp;<span class="ident" id="5560508">t</span><span class="op" id="5560509">.</span><span class="ident" id="5560510">itemList</span><span class="op" id="5560518">(</span><span class="op" id="5560519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560523">if</span>&nbsp;<span class="ident" id="5560526">next</span><span class="op" id="5560530">.</span><span class="ident" id="5560531">Type</span><span class="op" id="5560535">(</span><span class="op" id="5560536">)</span>&nbsp;<span class="op" id="5560538">!=</span>&nbsp;<span class="ident" id="5560541">nodeEnd</span>&nbsp;<span class="op" id="5560549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5560554">t</span><span class="op" id="5560555">.</span><span class="ident" id="5560556">errorf</span><span class="op" id="5560562">(</span><span class="string" id="5560563">&#34;expected&nbsp;end;&nbsp;found&nbsp;%s&#34;</span><span class="op" id="5560587">,</span>&nbsp;<span class="ident" id="5560589">next</span><span class="op" id="5560593">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5560597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5560600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560603">return</span>&nbsp;<span class="ident" id="5560610">pipe</span><span class="op" id="5560614">.</span><span class="ident" id="5560615">Position</span><span class="op" id="5560623">(</span><span class="op" id="5560624">)</span><span class="op" id="5560625">,</span>&nbsp;<span class="ident" id="5560627">line</span><span class="op" id="5560631">,</span>&nbsp;<span class="ident" id="5560633">pipe</span><span class="op" id="5560637">,</span>&nbsp;<span class="ident" id="5560639">list</span><span class="op" id="5560643">,</span>&nbsp;<span class="ident" id="5560645">elseList</span><br>
<span class="lineno"></span><span class="op" id="5560654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="comment" id="5560657">//&nbsp;If:</span><br>
<span class="lineno"></span><span class="comment" id="5560664">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="5560700">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="5560754">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="5560777">func</span>&nbsp;<span class="op" id="5560782">(</span><span class="ident" id="5560783">t</span>&nbsp;<span class="op" id="5560785">*</span><span class="ident" id="5560786">Tree</span><span class="op" id="5560790">)</span>&nbsp;<span class="ident" id="5560792">ifControl</span><span class="op" id="5560801">(</span><span class="op" id="5560802">)</span>&nbsp;<span class="ident" id="5560804">Node</span>&nbsp;<span class="op" id="5560809">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5560812">return</span>&nbsp;<span class="ident" id="5560819">t</span><span class="op" id="5560820">.</span><span class="ident" id="5560821">newIf</span><span class="op" id="5560826">(</span><span class="ident" id="5560827">t</span><span class="op" id="5560828">.</span><span class="ident" id="5560829">parseControl</span><span class="op" id="5560841">(</span><span class="builtintype" id="5560842">true</span><span class="op" id="5560846">,</span>&nbsp;<span class="string" id="5560848">&#34;if&#34;</span><span class="op" id="5560852">)</span><span class="op" id="5560853">)</span><br>
<span class="lineno"></span><span class="op" id="5560855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5560858">//&nbsp;Range:</span><br>
<span class="lineno"></span><span class="comment" id="5560868">//&nbsp;&nbsp;&nbsp;&nbsp{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno">475</span><span class="comment" id="5560907">//&nbsp;&nbsp;&nbsp;&nbsp{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="5560964">//&nbsp;Range&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="5560990">func</span>&nbsp;<span class="op" id="5560995">(</span><span class="ident" id="5560996">t</span>&nbsp;<span class="op" id="5560998">*</span><span class="ident" id="5560999">Tree</span><span class="op" id="5561003">)</span>&nbsp;<span class="ident" id="5561005">rangeControl</span><span class="op" id="5561017">(</span><span class="op" id="5561018">)</span>&nbsp;<span class="ident" id="5561020">Node</span>&nbsp;<span class="op" id="5561025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5561028">return</span>&nbsp;<span class="ident" id="5561035">t</span><span class="op" id="5561036">.</span><span class="ident" id="5561037">newRange</span><span class="op" id="5561045">(</span><span class="ident" id="5561046">t</span><span class="op" id="5561047">.</span><span class="ident" id="5561048">parseControl</span><span class="op" id="5561060">(</span><span class="builtintype" id="5561061">false</span><span class="op" id="5561066">,</span>&nbsp;<span class="string" id="5561068">&#34;range&#34;</span><span class="op" id="5561075">)</span><span class="op" id="5561076">)</span><br>
<span class="lineno"></span><span class="op" id="5561078">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5561081">//&nbsp;With:</span><br>
<span class="lineno"></span><span class="comment" id="5561090">//&nbsp;&nbsp;&nbsp;&nbsp{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="5561128">//&nbsp;&nbsp;&nbsp;&nbsp{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="5561184">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno">485</span><span class="keyword" id="5561207">func</span>&nbsp;<span class="op" id="5561212">(</span><span class="ident" id="5561213">t</span>&nbsp;<span class="op" id="5561215">*</span><span class="ident" id="5561216">Tree</span><span class="op" id="5561220">)</span>&nbsp;<span class="ident" id="5561222">withControl</span><span class="op" id="5561233">(</span><span class="op" id="5561234">)</span>&nbsp;<span class="ident" id="5561236">Node</span>&nbsp;<span class="op" id="5561241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5561244">return</span>&nbsp;<span class="ident" id="5561251">t</span><span class="op" id="5561252">.</span><span class="ident" id="5561253">newWith</span><span class="op" id="5561260">(</span><span class="ident" id="5561261">t</span><span class="op" id="5561262">.</span><span class="ident" id="5561263">parseControl</span><span class="op" id="5561275">(</span><span class="builtintype" id="5561276">false</span><span class="op" id="5561281">,</span>&nbsp;<span class="string" id="5561283">&#34;with&#34;</span><span class="op" id="5561289">)</span><span class="op" id="5561290">)</span><br>
<span class="lineno"></span><span class="op" id="5561292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5561295">//&nbsp;End:</span><br>
<span class="lineno">490</span><span class="comment" id="5561303">//&nbsp;&nbsp;&nbsp;&nbsp{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="5561314">//&nbsp;End&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="5561338">func</span>&nbsp;<span class="op" id="5561343">(</span><span class="ident" id="5561344">t</span>&nbsp;<span class="op" id="5561346">*</span><span class="ident" id="5561347">Tree</span><span class="op" id="5561351">)</span>&nbsp;<span class="ident" id="5561353">endControl</span><span class="op" id="5561363">(</span><span class="op" id="5561364">)</span>&nbsp;<span class="ident" id="5561366">Node</span>&nbsp;<span class="op" id="5561371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5561374">return</span>&nbsp;<span class="ident" id="5561381">t</span><span class="op" id="5561382">.</span><span class="ident" id="5561383">newEnd</span><span class="op" id="5561389">(</span><span class="ident" id="5561390">t</span><span class="op" id="5561391">.</span><span class="ident" id="5561392">expect</span><span class="op" id="5561398">(</span><span class="ident" id="5561399">itemRightDelim</span><span class="op" id="5561413">,</span>&nbsp;<span class="string" id="5561415">&#34;end&#34;</span><span class="op" id="5561420">)</span><span class="op" id="5561421">.</span><span class="ident" id="5561422">pos</span><span class="op" id="5561425">)</span><br>
<span class="lineno"></span><span class="op" id="5561427">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="comment" id="5561430">//&nbsp;Else:</span><br>
<span class="lineno"></span><span class="comment" id="5561439">//&nbsp;&nbsp;&nbsp;&nbsp{{else}}</span><br>
<span class="lineno"></span><span class="comment" id="5561451">//&nbsp;Else&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="5561476">func</span>&nbsp;<span class="op" id="5561481">(</span><span class="ident" id="5561482">t</span>&nbsp;<span class="op" id="5561484">*</span><span class="ident" id="5561485">Tree</span><span class="op" id="5561489">)</span>&nbsp;<span class="ident" id="5561491">elseControl</span><span class="op" id="5561502">(</span><span class="op" id="5561503">)</span>&nbsp;<span class="ident" id="5561505">Node</span>&nbsp;<span class="op" id="5561510">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5561513">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5561545">peek</span>&nbsp;<span class="op" id="5561550">:=</span>&nbsp;<span class="ident" id="5561553">t</span><span class="op" id="5561554">.</span><span class="ident" id="5561555">peekNonSpace</span><span class="op" id="5561567">(</span><span class="op" id="5561568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5561571">if</span>&nbsp;<span class="ident" id="5561574">peek</span><span class="op" id="5561578">.</span><span class="ident" id="5561579">typ</span>&nbsp;<span class="op" id="5561583">==</span>&nbsp;<span class="ident" id="5561586">itemIf</span>&nbsp;<span class="op" id="5561593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5561597">//&nbsp;We&nbsp;see&nbsp;&#34;{{else&nbsp;if&nbsp;...&nbsp;&#34;&nbsp;but&nbsp;in&nbsp;effect&nbsp;rewrite&nbsp;it&nbsp;to&nbsp;{{else}}{{if&nbsp;...&nbsp;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5561674">return</span>&nbsp;<span class="ident" id="5561681">t</span><span class="op" id="5561682">.</span><span class="ident" id="5561683">newElse</span><span class="op" id="5561690">(</span><span class="ident" id="5561691">peek</span><span class="op" id="5561695">.</span><span class="ident" id="5561696">pos</span><span class="op" id="5561699">,</span>&nbsp;<span class="ident" id="5561701">t</span><span class="op" id="5561702">.</span><span class="ident" id="5561703">lex</span><span class="op" id="5561706">.</span><span class="ident" id="5561707">lineNumber</span><span class="op" id="5561717">(</span><span class="op" id="5561718">)</span><span class="op" id="5561719">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5561722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5561725">return</span>&nbsp;<span class="ident" id="5561732">t</span><span class="op" id="5561733">.</span><span class="ident" id="5561734">newElse</span><span class="op" id="5561741">(</span><span class="ident" id="5561742">t</span><span class="op" id="5561743">.</span><span class="ident" id="5561744">expect</span><span class="op" id="5561750">(</span><span class="ident" id="5561751">itemRightDelim</span><span class="op" id="5561765">,</span>&nbsp;<span class="string" id="5561767">&#34;else&#34;</span><span class="op" id="5561773">)</span><span class="op" id="5561774">.</span><span class="ident" id="5561775">pos</span><span class="op" id="5561778">,</span>&nbsp;<span class="ident" id="5561780">t</span><span class="op" id="5561781">.</span><span class="ident" id="5561782">lex</span><span class="op" id="5561785">.</span><span class="ident" id="5561786">lineNumber</span><span class="op" id="5561796">(</span><span class="op" id="5561797">)</span><span class="op" id="5561798">)</span><br>
<span class="lineno"></span><span class="op" id="5561800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5561803">//&nbsp;Template:</span><br>
<span class="lineno">510</span><span class="comment" id="5561816">//&nbsp;&nbsp;&nbsp;&nbsp{{template&nbsp;stringValue&nbsp;pipeline}}</span><br>
<span class="lineno"></span><span class="comment" id="5561853">//&nbsp;Template&nbsp;keyword&nbsp;is&nbsp;past.&nbsp;&nbsp;The&nbsp;name&nbsp;must&nbsp;be&nbsp;something&nbsp;that&nbsp;can&nbsp;evaluate</span><br>
<span class="lineno"></span><span class="comment" id="5561928">//&nbsp;to&nbsp;a&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="5561944">func</span>&nbsp;<span class="op" id="5561949">(</span><span class="ident" id="5561950">t</span>&nbsp;<span class="op" id="5561952">*</span><span class="ident" id="5561953">Tree</span><span class="op" id="5561957">)</span>&nbsp;<span class="ident" id="5561959">templateControl</span><span class="op" id="5561974">(</span><span class="op" id="5561975">)</span>&nbsp;<span class="ident" id="5561977">Node</span>&nbsp;<span class="op" id="5561982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5561985">var</span>&nbsp;<span class="ident" id="5561989">name</span>&nbsp;<span class="builtintype" id="5561994">string</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5562002">token</span>&nbsp;<span class="op" id="5562008">:=</span>&nbsp;<span class="ident" id="5562011">t</span><span class="op" id="5562012">.</span><span class="ident" id="5562013">nextNonSpace</span><span class="op" id="5562025">(</span><span class="op" id="5562026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562029">switch</span>&nbsp;<span class="ident" id="5562036">token</span><span class="op" id="5562041">.</span><span class="ident" id="5562042">typ</span>&nbsp;<span class="op" id="5562046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562049">case</span>&nbsp;<span class="ident" id="5562054">itemString</span><span class="op" id="5562064">,</span>&nbsp;<span class="ident" id="5562066">itemRawString</span><span class="op" id="5562079">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5562083">s</span><span class="op" id="5562084">,</span>&nbsp;<span class="ident" id="5562086">err</span>&nbsp;<span class="op" id="5562090">:=</span>&nbsp;<span class="ident" id="5562093">strconv</span><span class="op" id="5562100">.</span><span class="ident" id="5562101">Unquote</span><span class="op" id="5562108">(</span><span class="ident" id="5562109">token</span><span class="op" id="5562114">.</span><span class="ident" id="5562115">val</span><span class="op" id="5562118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562122">if</span>&nbsp;<span class="ident" id="5562125">err</span>&nbsp;<span class="op" id="5562129">!=</span>&nbsp;<span class="ident" id="5562132">nil</span>&nbsp;<span class="op" id="5562136">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5562141">t</span><span class="op" id="5562142">.</span><span class="builtintype" id="5562143">error</span><span class="op" id="5562148">(</span><span class="ident" id="5562149">err</span><span class="op" id="5562152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5562156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5562160">name</span>&nbsp;<span class="op" id="5562165">=</span>&nbsp;<span class="ident" id="5562167">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562170">default</span><span class="op" id="5562177">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5562181">t</span><span class="op" id="5562182">.</span><span class="ident" id="5562183">unexpected</span><span class="op" id="5562193">(</span><span class="ident" id="5562194">token</span><span class="op" id="5562199">,</span>&nbsp;<span class="string" id="5562201">&#34;template&nbsp;invocation&#34;</span><span class="op" id="5562222">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5562225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562228">var</span>&nbsp;<span class="ident" id="5562232">pipe</span>&nbsp;<span class="op" id="5562237">*</span><span class="ident" id="5562238">PipeNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562248">if</span>&nbsp;<span class="ident" id="5562251">t</span><span class="op" id="5562252">.</span><span class="ident" id="5562253">nextNonSpace</span><span class="op" id="5562265">(</span><span class="op" id="5562266">)</span><span class="op" id="5562267">.</span><span class="ident" id="5562268">typ</span>&nbsp;<span class="op" id="5562272">!=</span>&nbsp;<span class="ident" id="5562275">itemRightDelim</span>&nbsp;<span class="op" id="5562290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5562294">t</span><span class="op" id="5562295">.</span><span class="ident" id="5562296">backup</span><span class="op" id="5562302">(</span><span class="op" id="5562303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5562307">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5562360">pipe</span>&nbsp;<span class="op" id="5562365">=</span>&nbsp;<span class="ident" id="5562367">t</span><span class="op" id="5562368">.</span><span class="ident" id="5562369">pipeline</span><span class="op" id="5562377">(</span><span class="string" id="5562378">&#34;template&#34;</span><span class="op" id="5562388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5562391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562394">return</span>&nbsp;<span class="ident" id="5562401">t</span><span class="op" id="5562402">.</span><span class="ident" id="5562403">newTemplate</span><span class="op" id="5562414">(</span><span class="ident" id="5562415">token</span><span class="op" id="5562420">.</span><span class="ident" id="5562421">pos</span><span class="op" id="5562424">,</span>&nbsp;<span class="ident" id="5562426">t</span><span class="op" id="5562427">.</span><span class="ident" id="5562428">lex</span><span class="op" id="5562431">.</span><span class="ident" id="5562432">lineNumber</span><span class="op" id="5562442">(</span><span class="op" id="5562443">)</span><span class="op" id="5562444">,</span>&nbsp;<span class="ident" id="5562446">name</span><span class="op" id="5562450">,</span>&nbsp;<span class="ident" id="5562452">pipe</span><span class="op" id="5562456">)</span><br>
<span class="lineno"></span><span class="op" id="5562458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="comment" id="5562461">//&nbsp;command:</span><br>
<span class="lineno"></span><span class="comment" id="5562473">//&nbsp;&nbsp;&nbsp;&nbspoperand&nbsp;(space&nbsp;operand)*</span><br>
<span class="lineno"></span><span class="comment" id="5562501">//&nbsp;space-separated&nbsp;arguments&nbsp;up&nbsp;to&nbsp;a&nbsp;pipeline&nbsp;character&nbsp;or&nbsp;right&nbsp;delimiter.</span><br>
<span class="lineno"></span><span class="comment" id="5562577">//&nbsp;we&nbsp;consume&nbsp;the&nbsp;pipe&nbsp;character&nbsp;but&nbsp;leave&nbsp;the&nbsp;right&nbsp;delim&nbsp;to&nbsp;terminate&nbsp;the&nbsp;action.</span><br>
<span class="lineno"></span><span class="keyword" id="5562661">func</span>&nbsp;<span class="op" id="5562666">(</span><span class="ident" id="5562667">t</span>&nbsp;<span class="op" id="5562669">*</span><span class="ident" id="5562670">Tree</span><span class="op" id="5562674">)</span>&nbsp;<span class="ident" id="5562676">command</span><span class="op" id="5562683">(</span><span class="op" id="5562684">)</span>&nbsp;<span class="op" id="5562686">*</span><span class="ident" id="5562687">CommandNode</span>&nbsp;<span class="op" id="5562699">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5562702">cmd</span>&nbsp;<span class="op" id="5562706">:=</span>&nbsp;<span class="ident" id="5562709">t</span><span class="op" id="5562710">.</span><span class="ident" id="5562711">newCommand</span><span class="op" id="5562721">(</span><span class="ident" id="5562722">t</span><span class="op" id="5562723">.</span><span class="ident" id="5562724">peekNonSpace</span><span class="op" id="5562736">(</span><span class="op" id="5562737">)</span><span class="op" id="5562738">.</span><span class="ident" id="5562739">pos</span><span class="op" id="5562742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562745">for</span>&nbsp;<span class="op" id="5562749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5562753">t</span><span class="op" id="5562754">.</span><span class="ident" id="5562755">peekNonSpace</span><span class="op" id="5562767">(</span><span class="op" id="5562768">)</span>&nbsp;<span class="comment" id="5562770">//&nbsp;skip&nbsp;leading&nbsp;spaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5562796">operand</span>&nbsp;<span class="op" id="5562804">:=</span>&nbsp;<span class="ident" id="5562807">t</span><span class="op" id="5562808">.</span><span class="ident" id="5562809">operand</span><span class="op" id="5562816">(</span><span class="op" id="5562817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562821">if</span>&nbsp;<span class="ident" id="5562824">operand</span>&nbsp;<span class="op" id="5562832">!=</span>&nbsp;<span class="ident" id="5562835">nil</span>&nbsp;<span class="op" id="5562839">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5562844">cmd</span><span class="op" id="5562847">.</span><span class="builtinfunc" id="5562848">append</span><span class="op" id="5562854">(</span><span class="ident" id="5562855">operand</span><span class="op" id="5562862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5562866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562870">switch</span>&nbsp;<span class="ident" id="5562877">token</span>&nbsp;<span class="op" id="5562883">:=</span>&nbsp;<span class="ident" id="5562886">t</span><span class="op" id="5562887">.</span><span class="ident" id="5562888">next</span><span class="op" id="5562892">(</span><span class="op" id="5562893">)</span><span class="op" id="5562894">;</span>&nbsp;<span class="ident" id="5562896">token</span><span class="op" id="5562901">.</span><span class="ident" id="5562902">typ</span>&nbsp;<span class="op" id="5562906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562910">case</span>&nbsp;<span class="ident" id="5562915">itemSpace</span><span class="op" id="5562924">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562929">continue</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562940">case</span>&nbsp;<span class="ident" id="5562945">itemError</span><span class="op" id="5562954">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5562959">t</span><span class="op" id="5562960">.</span><span class="ident" id="5562961">errorf</span><span class="op" id="5562967">(</span><span class="string" id="5562968">&#34;%s&#34;</span><span class="op" id="5562972">,</span>&nbsp;<span class="ident" id="5562974">token</span><span class="op" id="5562979">.</span><span class="ident" id="5562980">val</span><span class="op" id="5562983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5562987">case</span>&nbsp;<span class="ident" id="5562992">itemRightDelim</span><span class="op" id="5563006">,</span>&nbsp;<span class="ident" id="5563008">itemRightParen</span><span class="op" id="5563022">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5563027">t</span><span class="op" id="5563028">.</span><span class="ident" id="5563029">backup</span><span class="op" id="5563035">(</span><span class="op" id="5563036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563040">case</span>&nbsp;<span class="ident" id="5563045">itemPipe</span><span class="op" id="5563053">:</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563057">default</span><span class="op" id="5563064">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5563069">t</span><span class="op" id="5563070">.</span><span class="ident" id="5563071">errorf</span><span class="op" id="5563077">(</span><span class="string" id="5563078">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;operand;&nbsp;missing&nbsp;space?&#34;</span><span class="op" id="5563120">,</span>&nbsp;<span class="ident" id="5563122">token</span><span class="op" id="5563127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5563131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563135">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5563142">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563145">if</span>&nbsp;<span class="builtinfunc" id="5563148">len</span><span class="op" id="5563151">(</span><span class="ident" id="5563152">cmd</span><span class="op" id="5563155">.</span><span class="ident" id="5563156">Args</span><span class="op" id="5563160">)</span>&nbsp;<span class="op" id="5563162">==</span>&nbsp;<span class="num" id="5563165">0</span>&nbsp;<span class="op" id="5563167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5563171">t</span><span class="op" id="5563172">.</span><span class="ident" id="5563173">errorf</span><span class="op" id="5563179">(</span><span class="string" id="5563180">&#34;empty&nbsp;command&#34;</span><span class="op" id="5563195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5563198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563201">return</span>&nbsp;<span class="ident" id="5563208">cmd</span><br>
<span class="lineno"></span><span class="op" id="5563212">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="comment" id="5563215">//&nbsp;operand:</span><br>
<span class="lineno"></span><span class="comment" id="5563227">//&nbsp;&nbsp;&nbsp;&nbspterm&nbsp;.Field*</span><br>
<span class="lineno"></span><span class="comment" id="5563243">//&nbsp;An&nbsp;operand&nbsp;is&nbsp;a&nbsp;space-separated&nbsp;component&nbsp;of&nbsp;a&nbsp;command,</span><br>
<span class="lineno"></span><span class="comment" id="5563302">//&nbsp;a&nbsp;term&nbsp;possibly&nbsp;followed&nbsp;by&nbsp;field&nbsp;accesses.</span><br>
<span class="lineno">570</span><span class="comment" id="5563349">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;an&nbsp;operand.</span><br>
<span class="lineno"></span><span class="keyword" id="5563404">func</span>&nbsp;<span class="op" id="5563409">(</span><span class="ident" id="5563410">t</span>&nbsp;<span class="op" id="5563412">*</span><span class="ident" id="5563413">Tree</span><span class="op" id="5563417">)</span>&nbsp;<span class="ident" id="5563419">operand</span><span class="op" id="5563426">(</span><span class="op" id="5563427">)</span>&nbsp;<span class="ident" id="5563429">Node</span>&nbsp;<span class="op" id="5563434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5563437">node</span>&nbsp;<span class="op" id="5563442">:=</span>&nbsp;<span class="ident" id="5563445">t</span><span class="op" id="5563446">.</span><span class="ident" id="5563447">term</span><span class="op" id="5563451">(</span><span class="op" id="5563452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563455">if</span>&nbsp;<span class="ident" id="5563458">node</span>&nbsp;<span class="op" id="5563463">==</span>&nbsp;<span class="ident" id="5563466">nil</span>&nbsp;<span class="op" id="5563470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563474">return</span>&nbsp;<span class="ident" id="5563481">nil</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5563486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563489">if</span>&nbsp;<span class="ident" id="5563492">t</span><span class="op" id="5563493">.</span><span class="ident" id="5563494">peek</span><span class="op" id="5563498">(</span><span class="op" id="5563499">)</span><span class="op" id="5563500">.</span><span class="ident" id="5563501">typ</span>&nbsp;<span class="op" id="5563505">==</span>&nbsp;<span class="ident" id="5563508">itemField</span>&nbsp;<span class="op" id="5563518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5563522">chain</span>&nbsp;<span class="op" id="5563528">:=</span>&nbsp;<span class="ident" id="5563531">t</span><span class="op" id="5563532">.</span><span class="ident" id="5563533">newChain</span><span class="op" id="5563541">(</span><span class="ident" id="5563542">t</span><span class="op" id="5563543">.</span><span class="ident" id="5563544">peek</span><span class="op" id="5563548">(</span><span class="op" id="5563549">)</span><span class="op" id="5563550">.</span><span class="ident" id="5563551">pos</span><span class="op" id="5563554">,</span>&nbsp;<span class="ident" id="5563556">node</span><span class="op" id="5563560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563564">for</span>&nbsp;<span class="ident" id="5563568">t</span><span class="op" id="5563569">.</span><span class="ident" id="5563570">peek</span><span class="op" id="5563574">(</span><span class="op" id="5563575">)</span><span class="op" id="5563576">.</span><span class="ident" id="5563577">typ</span>&nbsp;<span class="op" id="5563581">==</span>&nbsp;<span class="ident" id="5563584">itemField</span>&nbsp;<span class="op" id="5563594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5563599">chain</span><span class="op" id="5563604">.</span><span class="ident" id="5563605">Add</span><span class="op" id="5563608">(</span><span class="ident" id="5563609">t</span><span class="op" id="5563610">.</span><span class="ident" id="5563611">next</span><span class="op" id="5563615">(</span><span class="op" id="5563616">)</span><span class="op" id="5563617">.</span><span class="ident" id="5563618">val</span><span class="op" id="5563621">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5563625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5563629">//&nbsp;Compatibility&nbsp;with&nbsp;original&nbsp;API:&nbsp;If&nbsp;the&nbsp;term&nbsp;is&nbsp;of&nbsp;type&nbsp;NodeField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5563700">//&nbsp;or&nbsp;NodeVariable,&nbsp;just&nbsp;put&nbsp;more&nbsp;fields&nbsp;on&nbsp;the&nbsp;original.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5563760">//&nbsp;Otherwise,&nbsp;keep&nbsp;the&nbsp;Chain&nbsp;node.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5563797">//&nbsp;TODO:&nbsp;Switch&nbsp;to&nbsp;Chains&nbsp;always&nbsp;when&nbsp;we&nbsp;can.</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563845">switch</span>&nbsp;<span class="ident" id="5563852">node</span><span class="op" id="5563856">.</span><span class="ident" id="5563857">Type</span><span class="op" id="5563861">(</span><span class="op" id="5563862">)</span>&nbsp;<span class="op" id="5563864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563868">case</span>&nbsp;<span class="ident" id="5563873">NodeField</span><span class="op" id="5563882">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5563887">node</span>&nbsp;<span class="op" id="5563892">=</span>&nbsp;<span class="ident" id="5563894">t</span><span class="op" id="5563895">.</span><span class="ident" id="5563896">newField</span><span class="op" id="5563904">(</span><span class="ident" id="5563905">chain</span><span class="op" id="5563910">.</span><span class="ident" id="5563911">Position</span><span class="op" id="5563919">(</span><span class="op" id="5563920">)</span><span class="op" id="5563921">,</span>&nbsp;<span class="ident" id="5563923">chain</span><span class="op" id="5563928">.</span><span class="ident" id="5563929">String</span><span class="op" id="5563935">(</span><span class="op" id="5563936">)</span><span class="op" id="5563937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5563941">case</span>&nbsp;<span class="ident" id="5563946">NodeVariable</span><span class="op" id="5563958">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5563963">node</span>&nbsp;<span class="op" id="5563968">=</span>&nbsp;<span class="ident" id="5563970">t</span><span class="op" id="5563971">.</span><span class="ident" id="5563972">newVariable</span><span class="op" id="5563983">(</span><span class="ident" id="5563984">chain</span><span class="op" id="5563989">.</span><span class="ident" id="5563990">Position</span><span class="op" id="5563998">(</span><span class="op" id="5563999">)</span><span class="op" id="5564000">,</span>&nbsp;<span class="ident" id="5564002">chain</span><span class="op" id="5564007">.</span><span class="ident" id="5564008">String</span><span class="op" id="5564014">(</span><span class="op" id="5564015">)</span><span class="op" id="5564016">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564020">default</span><span class="op" id="5564027">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5564032">node</span>&nbsp;<span class="op" id="5564037">=</span>&nbsp;<span class="ident" id="5564039">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5564047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5564050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564053">return</span>&nbsp;<span class="ident" id="5564060">node</span><br>
<span class="lineno">595</span><span class="op" id="5564065">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5564068">//&nbsp;term:</span><br>
<span class="lineno"></span><span class="comment" id="5564077">//&nbsp;&nbsp;&nbsp;&nbspliteral&nbsp;(number,&nbsp;string,&nbsp;nil,&nbsp;boolean)</span><br>
<span class="lineno"></span><span class="comment" id="5564119">//&nbsp;&nbsp;&nbsp;&nbspfunction&nbsp;(identifier)</span><br>
<span class="lineno">600</span><span class="comment" id="5564144">//&nbsp;&nbsp;&nbsp;&nbsp.</span><br>
<span class="lineno"></span><span class="comment" id="5564149">//&nbsp;&nbsp;&nbsp;&nbsp.Field</span><br>
<span class="lineno"></span><span class="comment" id="5564159">//&nbsp;&nbsp;&nbsp;&nbsp$</span><br>
<span class="lineno"></span><span class="comment" id="5564164">//&nbsp;&nbsp;&nbsp;&nbsp&#39;(&#39;&nbsp;pipeline&nbsp;&#39;)&#39;</span><br>
<span class="lineno"></span><span class="comment" id="5564184">//&nbsp;A&nbsp;term&nbsp;is&nbsp;a&nbsp;simple&nbsp;&#34;expression&#34;.</span><br>
<span class="lineno">605</span><span class="comment" id="5564220">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;a&nbsp;term.</span><br>
<span class="lineno"></span><span class="keyword" id="5564271">func</span>&nbsp;<span class="op" id="5564276">(</span><span class="ident" id="5564277">t</span>&nbsp;<span class="op" id="5564279">*</span><span class="ident" id="5564280">Tree</span><span class="op" id="5564284">)</span>&nbsp;<span class="ident" id="5564286">term</span><span class="op" id="5564290">(</span><span class="op" id="5564291">)</span>&nbsp;<span class="ident" id="5564293">Node</span>&nbsp;<span class="op" id="5564298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564301">switch</span>&nbsp;<span class="ident" id="5564308">token</span>&nbsp;<span class="op" id="5564314">:=</span>&nbsp;<span class="ident" id="5564317">t</span><span class="op" id="5564318">.</span><span class="ident" id="5564319">nextNonSpace</span><span class="op" id="5564331">(</span><span class="op" id="5564332">)</span><span class="op" id="5564333">;</span>&nbsp;<span class="ident" id="5564335">token</span><span class="op" id="5564340">.</span><span class="ident" id="5564341">typ</span>&nbsp;<span class="op" id="5564345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564348">case</span>&nbsp;<span class="ident" id="5564353">itemError</span><span class="op" id="5564362">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5564366">t</span><span class="op" id="5564367">.</span><span class="ident" id="5564368">errorf</span><span class="op" id="5564374">(</span><span class="string" id="5564375">&#34;%s&#34;</span><span class="op" id="5564379">,</span>&nbsp;<span class="ident" id="5564381">token</span><span class="op" id="5564386">.</span><span class="ident" id="5564387">val</span><span class="op" id="5564390">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564393">case</span>&nbsp;<span class="ident" id="5564398">itemIdentifier</span><span class="op" id="5564412">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564416">if</span>&nbsp;<span class="op" id="5564419">!</span><span class="ident" id="5564420">t</span><span class="op" id="5564421">.</span><span class="ident" id="5564422">hasFunction</span><span class="op" id="5564433">(</span><span class="ident" id="5564434">token</span><span class="op" id="5564439">.</span><span class="ident" id="5564440">val</span><span class="op" id="5564443">)</span>&nbsp;<span class="op" id="5564445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5564450">t</span><span class="op" id="5564451">.</span><span class="ident" id="5564452">errorf</span><span class="op" id="5564458">(</span><span class="string" id="5564459">&#34;function&nbsp;%q&nbsp;not&nbsp;defined&#34;</span><span class="op" id="5564484">,</span>&nbsp;<span class="ident" id="5564486">token</span><span class="op" id="5564491">.</span><span class="ident" id="5564492">val</span><span class="op" id="5564495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5564499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564503">return</span>&nbsp;<span class="ident" id="5564510">NewIdentifier</span><span class="op" id="5564523">(</span><span class="ident" id="5564524">token</span><span class="op" id="5564529">.</span><span class="ident" id="5564530">val</span><span class="op" id="5564533">)</span><span class="op" id="5564534">.</span><span class="ident" id="5564535">SetTree</span><span class="op" id="5564542">(</span><span class="ident" id="5564543">t</span><span class="op" id="5564544">)</span><span class="op" id="5564545">.</span><span class="ident" id="5564546">SetPos</span><span class="op" id="5564552">(</span><span class="ident" id="5564553">token</span><span class="op" id="5564558">.</span><span class="ident" id="5564559">pos</span><span class="op" id="5564562">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564565">case</span>&nbsp;<span class="ident" id="5564570">itemDot</span><span class="op" id="5564577">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564581">return</span>&nbsp;<span class="ident" id="5564588">t</span><span class="op" id="5564589">.</span><span class="ident" id="5564590">newDot</span><span class="op" id="5564596">(</span><span class="ident" id="5564597">token</span><span class="op" id="5564602">.</span><span class="ident" id="5564603">pos</span><span class="op" id="5564606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564609">case</span>&nbsp;<span class="ident" id="5564614">itemNil</span><span class="op" id="5564621">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564625">return</span>&nbsp;<span class="ident" id="5564632">t</span><span class="op" id="5564633">.</span><span class="ident" id="5564634">newNil</span><span class="op" id="5564640">(</span><span class="ident" id="5564641">token</span><span class="op" id="5564646">.</span><span class="ident" id="5564647">pos</span><span class="op" id="5564650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564653">case</span>&nbsp;<span class="ident" id="5564658">itemVariable</span><span class="op" id="5564670">:</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564674">return</span>&nbsp;<span class="ident" id="5564681">t</span><span class="op" id="5564682">.</span><span class="ident" id="5564683">useVar</span><span class="op" id="5564689">(</span><span class="ident" id="5564690">token</span><span class="op" id="5564695">.</span><span class="ident" id="5564696">pos</span><span class="op" id="5564699">,</span>&nbsp;<span class="ident" id="5564701">token</span><span class="op" id="5564706">.</span><span class="ident" id="5564707">val</span><span class="op" id="5564710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564713">case</span>&nbsp;<span class="ident" id="5564718">itemField</span><span class="op" id="5564727">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564731">return</span>&nbsp;<span class="ident" id="5564738">t</span><span class="op" id="5564739">.</span><span class="ident" id="5564740">newField</span><span class="op" id="5564748">(</span><span class="ident" id="5564749">token</span><span class="op" id="5564754">.</span><span class="ident" id="5564755">pos</span><span class="op" id="5564758">,</span>&nbsp;<span class="ident" id="5564760">token</span><span class="op" id="5564765">.</span><span class="ident" id="5564766">val</span><span class="op" id="5564769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564772">case</span>&nbsp;<span class="ident" id="5564777">itemBool</span><span class="op" id="5564785">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564789">return</span>&nbsp;<span class="ident" id="5564796">t</span><span class="op" id="5564797">.</span><span class="ident" id="5564798">newBool</span><span class="op" id="5564805">(</span><span class="ident" id="5564806">token</span><span class="op" id="5564811">.</span><span class="ident" id="5564812">pos</span><span class="op" id="5564815">,</span>&nbsp;<span class="ident" id="5564817">token</span><span class="op" id="5564822">.</span><span class="ident" id="5564823">val</span>&nbsp;<span class="op" id="5564827">==</span>&nbsp;<span class="string" id="5564830">&#34;true&#34;</span><span class="op" id="5564836">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564839">case</span>&nbsp;<span class="ident" id="5564844">itemCharConstant</span><span class="op" id="5564860">,</span>&nbsp;<span class="ident" id="5564862">itemComplex</span><span class="op" id="5564873">,</span>&nbsp;<span class="ident" id="5564875">itemNumber</span><span class="op" id="5564885">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5564889">number</span><span class="op" id="5564895">,</span>&nbsp;<span class="ident" id="5564897">err</span>&nbsp;<span class="op" id="5564901">:=</span>&nbsp;<span class="ident" id="5564904">t</span><span class="op" id="5564905">.</span><span class="ident" id="5564906">newNumber</span><span class="op" id="5564915">(</span><span class="ident" id="5564916">token</span><span class="op" id="5564921">.</span><span class="ident" id="5564922">pos</span><span class="op" id="5564925">,</span>&nbsp;<span class="ident" id="5564927">token</span><span class="op" id="5564932">.</span><span class="ident" id="5564933">val</span><span class="op" id="5564936">,</span>&nbsp;<span class="ident" id="5564938">token</span><span class="op" id="5564943">.</span><span class="ident" id="5564944">typ</span><span class="op" id="5564947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564951">if</span>&nbsp;<span class="ident" id="5564954">err</span>&nbsp;<span class="op" id="5564958">!=</span>&nbsp;<span class="ident" id="5564961">nil</span>&nbsp;<span class="op" id="5564965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5564970">t</span><span class="op" id="5564971">.</span><span class="builtintype" id="5564972">error</span><span class="op" id="5564977">(</span><span class="ident" id="5564978">err</span><span class="op" id="5564981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5564985">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5564989">return</span>&nbsp;<span class="ident" id="5564996">number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565004">case</span>&nbsp;<span class="ident" id="5565009">itemLeftParen</span><span class="op" id="5565022">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5565026">pipe</span>&nbsp;<span class="op" id="5565031">:=</span>&nbsp;<span class="ident" id="5565034">t</span><span class="op" id="5565035">.</span><span class="ident" id="5565036">pipeline</span><span class="op" id="5565044">(</span><span class="string" id="5565045">&#34;parenthesized&nbsp;pipeline&#34;</span><span class="op" id="5565069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565073">if</span>&nbsp;<span class="ident" id="5565076">token</span>&nbsp;<span class="op" id="5565082">:=</span>&nbsp;<span class="ident" id="5565085">t</span><span class="op" id="5565086">.</span><span class="ident" id="5565087">next</span><span class="op" id="5565091">(</span><span class="op" id="5565092">)</span><span class="op" id="5565093">;</span>&nbsp;<span class="ident" id="5565095">token</span><span class="op" id="5565100">.</span><span class="ident" id="5565101">typ</span>&nbsp;<span class="op" id="5565105">!=</span>&nbsp;<span class="ident" id="5565108">itemRightParen</span>&nbsp;<span class="op" id="5565123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5565128">t</span><span class="op" id="5565129">.</span><span class="ident" id="5565130">errorf</span><span class="op" id="5565136">(</span><span class="string" id="5565137">&#34;unclosed&nbsp;right&nbsp;paren:&nbsp;unexpected&nbsp;%s&#34;</span><span class="op" id="5565174">,</span>&nbsp;<span class="ident" id="5565176">token</span><span class="op" id="5565181">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5565185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565189">return</span>&nbsp;<span class="ident" id="5565196">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565202">case</span>&nbsp;<span class="ident" id="5565207">itemString</span><span class="op" id="5565217">,</span>&nbsp;<span class="ident" id="5565219">itemRawString</span><span class="op" id="5565232">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5565236">s</span><span class="op" id="5565237">,</span>&nbsp;<span class="ident" id="5565239">err</span>&nbsp;<span class="op" id="5565243">:=</span>&nbsp;<span class="ident" id="5565246">strconv</span><span class="op" id="5565253">.</span><span class="ident" id="5565254">Unquote</span><span class="op" id="5565261">(</span><span class="ident" id="5565262">token</span><span class="op" id="5565267">.</span><span class="ident" id="5565268">val</span><span class="op" id="5565271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565275">if</span>&nbsp;<span class="ident" id="5565278">err</span>&nbsp;<span class="op" id="5565282">!=</span>&nbsp;<span class="ident" id="5565285">nil</span>&nbsp;<span class="op" id="5565289">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5565294">t</span><span class="op" id="5565295">.</span><span class="builtintype" id="5565296">error</span><span class="op" id="5565301">(</span><span class="ident" id="5565302">err</span><span class="op" id="5565305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5565309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565313">return</span>&nbsp;<span class="ident" id="5565320">t</span><span class="op" id="5565321">.</span><span class="ident" id="5565322">newString</span><span class="op" id="5565331">(</span><span class="ident" id="5565332">token</span><span class="op" id="5565337">.</span><span class="ident" id="5565338">pos</span><span class="op" id="5565341">,</span>&nbsp;<span class="ident" id="5565343">token</span><span class="op" id="5565348">.</span><span class="ident" id="5565349">val</span><span class="op" id="5565352">,</span>&nbsp;<span class="ident" id="5565354">s</span><span class="op" id="5565355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5565358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5565361">t</span><span class="op" id="5565362">.</span><span class="ident" id="5565363">backup</span><span class="op" id="5565369">(</span><span class="op" id="5565370">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565373">return</span>&nbsp;<span class="ident" id="5565380">nil</span><br>
<span class="lineno"></span><span class="op" id="5565384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5565387">//&nbsp;hasFunction&nbsp;reports&nbsp;if&nbsp;a&nbsp;function&nbsp;name&nbsp;exists&nbsp;in&nbsp;the&nbsp;Tree&#39;s&nbsp;maps.</span><br>
<span class="lineno"></span><span class="keyword" id="5565456">func</span>&nbsp;<span class="op" id="5565461">(</span><span class="ident" id="5565462">t</span>&nbsp;<span class="op" id="5565464">*</span><span class="ident" id="5565465">Tree</span><span class="op" id="5565469">)</span>&nbsp;<span class="ident" id="5565471">hasFunction</span><span class="op" id="5565482">(</span><span class="ident" id="5565483">name</span>&nbsp;<span class="builtintype" id="5565488">string</span><span class="op" id="5565494">)</span>&nbsp;<span class="builtintype" id="5565496">bool</span>&nbsp;<span class="op" id="5565501">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565504">for</span>&nbsp;<span class="ident" id="5565508">_</span><span class="op" id="5565509">,</span>&nbsp;<span class="ident" id="5565511">funcMap</span>&nbsp;<span class="op" id="5565519">:=</span>&nbsp;<span class="keyword" id="5565522">range</span>&nbsp;<span class="ident" id="5565528">t</span><span class="op" id="5565529">.</span><span class="ident" id="5565530">funcs</span>&nbsp;<span class="op" id="5565536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565540">if</span>&nbsp;<span class="ident" id="5565543">funcMap</span>&nbsp;<span class="op" id="5565551">==</span>&nbsp;<span class="ident" id="5565554">nil</span>&nbsp;<span class="op" id="5565558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565563">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5565574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565578">if</span>&nbsp;<span class="ident" id="5565581">funcMap</span><span class="op" id="5565588">[</span><span class="ident" id="5565589">name</span><span class="op" id="5565593">]</span>&nbsp;<span class="op" id="5565595">!=</span>&nbsp;<span class="ident" id="5565598">nil</span>&nbsp;<span class="op" id="5565602">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565607">return</span>&nbsp;<span class="builtintype" id="5565614">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5565621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5565624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565627">return</span>&nbsp;<span class="builtintype" id="5565634">false</span><br>
<span class="lineno"></span><span class="op" id="5565640">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="comment" id="5565643">//&nbsp;popVars&nbsp;trims&nbsp;the&nbsp;variable&nbsp;list&nbsp;to&nbsp;the&nbsp;specified&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="5565702">func</span>&nbsp;<span class="op" id="5565707">(</span><span class="ident" id="5565708">t</span>&nbsp;<span class="op" id="5565710">*</span><span class="ident" id="5565711">Tree</span><span class="op" id="5565715">)</span>&nbsp;<span class="ident" id="5565717">popVars</span><span class="op" id="5565724">(</span><span class="ident" id="5565725">n</span>&nbsp;<span class="builtintype" id="5565727">int</span><span class="op" id="5565730">)</span>&nbsp;<span class="op" id="5565732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5565735">t</span><span class="op" id="5565736">.</span><span class="ident" id="5565737">vars</span>&nbsp;<span class="op" id="5565742">=</span>&nbsp;<span class="ident" id="5565744">t</span><span class="op" id="5565745">.</span><span class="ident" id="5565746">vars</span><span class="op" id="5565750">[</span><span class="op" id="5565751">:</span><span class="ident" id="5565752">n</span><span class="op" id="5565753">]</span><br>
<span class="lineno"></span><span class="op" id="5565755">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="5565758">//&nbsp;useVar&nbsp;returns&nbsp;a&nbsp;node&nbsp;for&nbsp;a&nbsp;variable&nbsp;reference.&nbsp;It&nbsp;errors&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5565826">//&nbsp;variable&nbsp;is&nbsp;not&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="5565854">func</span>&nbsp;<span class="op" id="5565859">(</span><span class="ident" id="5565860">t</span>&nbsp;<span class="op" id="5565862">*</span><span class="ident" id="5565863">Tree</span><span class="op" id="5565867">)</span>&nbsp;<span class="ident" id="5565869">useVar</span><span class="op" id="5565875">(</span><span class="ident" id="5565876">pos</span>&nbsp;<span class="ident" id="5565880">Pos</span><span class="op" id="5565883">,</span>&nbsp;<span class="ident" id="5565885">name</span>&nbsp;<span class="builtintype" id="5565890">string</span><span class="op" id="5565896">)</span>&nbsp;<span class="ident" id="5565898">Node</span>&nbsp;<span class="op" id="5565903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5565906">v</span>&nbsp;<span class="op" id="5565908">:=</span>&nbsp;<span class="ident" id="5565911">t</span><span class="op" id="5565912">.</span><span class="ident" id="5565913">newVariable</span><span class="op" id="5565924">(</span><span class="ident" id="5565925">pos</span><span class="op" id="5565928">,</span>&nbsp;<span class="ident" id="5565930">name</span><span class="op" id="5565934">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565937">for</span>&nbsp;<span class="ident" id="5565941">_</span><span class="op" id="5565942">,</span>&nbsp;<span class="ident" id="5565944">varName</span>&nbsp;<span class="op" id="5565952">:=</span>&nbsp;<span class="keyword" id="5565955">range</span>&nbsp;<span class="ident" id="5565961">t</span><span class="op" id="5565962">.</span><span class="ident" id="5565963">vars</span>&nbsp;<span class="op" id="5565968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5565972">if</span>&nbsp;<span class="ident" id="5565975">varName</span>&nbsp;<span class="op" id="5565983">==</span>&nbsp;<span class="ident" id="5565986">v</span><span class="op" id="5565987">.</span><span class="ident" id="5565988">Ident</span><span class="op" id="5565993">[</span><span class="num" id="5565994">0</span><span class="op" id="5565995">]</span>&nbsp;<span class="op" id="5565997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5566002">return</span>&nbsp;<span class="ident" id="5566009">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5566013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5566016">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5566019">t</span><span class="op" id="5566020">.</span><span class="ident" id="5566021">errorf</span><span class="op" id="5566027">(</span><span class="string" id="5566028">&#34;undefined&nbsp;variable&nbsp;%q&#34;</span><span class="op" id="5566051">,</span>&nbsp;<span class="ident" id="5566053">v</span><span class="op" id="5566054">.</span><span class="ident" id="5566055">Ident</span><span class="op" id="5566060">[</span><span class="num" id="5566061">0</span><span class="op" id="5566062">]</span><span class="op" id="5566063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5566066">return</span>&nbsp;<span class="ident" id="5566073">nil</span><br>
<span class="lineno"></span><span class="op" id="5566077">}</span>
</div>
</body>
</html>
