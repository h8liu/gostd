<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rand</h2>
<ul>
<li><a href="/gostd/crypto/rand/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand.go.html">rand.go</a></li>
<li><a href="/gostd/crypto/rand/rand_linux.go.html">rand_linux.go</a></li>
<li><a href="/gostd/crypto/rand/rand_test.go.html">rand_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand_unix.go.html">rand_unix.go</a></li>
<li><a href="/gostd/crypto/rand/util.go.html">util.go</a></li>
<li><a href="/gostd/crypto/rand/util_test.go.html">util_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3875358">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3875414">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3875468">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3875519">package</span>&nbsp;<span class="ident" id="3875527">rand</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3875533">import</span>&nbsp;<span class="op" id="3875540">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3875543">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3875553">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3875559">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="3875570">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3875573">//&nbsp;smallPrimes&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;small,&nbsp;prime&nbsp;numbers&nbsp;that&nbsp;allows&nbsp;us&nbsp;to&nbsp;rapidly</span><br>
<span class="lineno"></span><span class="comment" id="3875648">//&nbsp;exclude&nbsp;some&nbsp;fraction&nbsp;of&nbsp;composite&nbsp;candidates&nbsp;when&nbsp;searching&nbsp;for&nbsp;a&nbsp;random</span><br>
<span class="lineno">15</span><span class="comment" id="3875725">//&nbsp;prime.&nbsp;This&nbsp;list&nbsp;is&nbsp;truncated&nbsp;at&nbsp;the&nbsp;point&nbsp;where&nbsp;smallPrimesProduct&nbsp;exceeds</span><br>
<span class="lineno"></span><span class="comment" id="3875804">//&nbsp;a&nbsp;uint64.&nbsp;It&nbsp;does&nbsp;not&nbsp;include&nbsp;two&nbsp;because&nbsp;we&nbsp;ensure&nbsp;that&nbsp;the&nbsp;candidates&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="3875883">//&nbsp;odd&nbsp;by&nbsp;construction.</span><br>
<span class="lineno"></span><span class="keyword" id="3875907">var</span>&nbsp;<span class="ident" id="3875911">smallPrimes</span>&nbsp;<span class="op" id="3875923">=</span>&nbsp;<span class="op" id="3875925">[</span><span class="op" id="3875926">]</span><span class="builtintype" id="3875927">uint8</span><span class="op" id="3875932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3875935">3</span><span class="op" id="3875936">,</span>&nbsp;<span class="num" id="3875938">5</span><span class="op" id="3875939">,</span>&nbsp;<span class="num" id="3875941">7</span><span class="op" id="3875942">,</span>&nbsp;<span class="num" id="3875944">11</span><span class="op" id="3875946">,</span>&nbsp;<span class="num" id="3875948">13</span><span class="op" id="3875950">,</span>&nbsp;<span class="num" id="3875952">17</span><span class="op" id="3875954">,</span>&nbsp;<span class="num" id="3875956">19</span><span class="op" id="3875958">,</span>&nbsp;<span class="num" id="3875960">23</span><span class="op" id="3875962">,</span>&nbsp;<span class="num" id="3875964">29</span><span class="op" id="3875966">,</span>&nbsp;<span class="num" id="3875968">31</span><span class="op" id="3875970">,</span>&nbsp;<span class="num" id="3875972">37</span><span class="op" id="3875974">,</span>&nbsp;<span class="num" id="3875976">41</span><span class="op" id="3875978">,</span>&nbsp;<span class="num" id="3875980">43</span><span class="op" id="3875982">,</span>&nbsp;<span class="num" id="3875984">47</span><span class="op" id="3875986">,</span>&nbsp;<span class="num" id="3875988">53</span><span class="op" id="3875990">,</span><br>
<span class="lineno">20</span><span class="op" id="3875992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3875995">//&nbsp;smallPrimesProduct&nbsp;is&nbsp;the&nbsp;product&nbsp;of&nbsp;the&nbsp;values&nbsp;in&nbsp;smallPrimes&nbsp;and&nbsp;allows&nbsp;us</span><br>
<span class="lineno"></span><span class="comment" id="3876075">//&nbsp;to&nbsp;reduce&nbsp;a&nbsp;candidate&nbsp;prime&nbsp;by&nbsp;this&nbsp;number&nbsp;and&nbsp;then&nbsp;determine&nbsp;whether&nbsp;it&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3876153">//&nbsp;coprime&nbsp;to&nbsp;all&nbsp;the&nbsp;elements&nbsp;of&nbsp;smallPrimes&nbsp;without&nbsp;further&nbsp;big.Int</span><br>
<span class="lineno">25</span><span class="comment" id="3876223">//&nbsp;operations.</span><br>
<span class="lineno"></span><span class="keyword" id="3876238">var</span>&nbsp;<span class="ident" id="3876242">smallPrimesProduct</span>&nbsp;<span class="op" id="3876261">=</span>&nbsp;<span class="builtinfunc" id="3876263">new</span><span class="op" id="3876266">(</span><span class="ident" id="3876267">big</span><span class="op" id="3876270">.</span><span class="ident" id="3876271">Int</span><span class="op" id="3876274">)</span><span class="op" id="3876275">.</span><span class="ident" id="3876276">SetUint64</span><span class="op" id="3876285">(</span><span class="num" id="3876286">16294579238595022365</span><span class="op" id="3876306">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3876309">//&nbsp;Prime&nbsp;returns&nbsp;a&nbsp;number,&nbsp;p,&nbsp;of&nbsp;the&nbsp;given&nbsp;size,&nbsp;such&nbsp;that&nbsp;p&nbsp;is&nbsp;prime</span><br>
<span class="lineno"></span><span class="comment" id="3876379">//&nbsp;with&nbsp;high&nbsp;probability.</span><br>
<span class="lineno">30</span><span class="comment" id="3876405">//&nbsp;Prime&nbsp;will&nbsp;return&nbsp;error&nbsp;for&nbsp;any&nbsp;error&nbsp;returned&nbsp;by&nbsp;rand.Read&nbsp;or&nbsp;if&nbsp;bits&nbsp;&lt;&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="3876484">func</span>&nbsp;<span class="ident" id="3876489">Prime</span><span class="op" id="3876494">(</span><span class="ident" id="3876495">rand</span>&nbsp;<span class="ident" id="3876500">io</span><span class="op" id="3876502">.</span><span class="ident" id="3876503">Reader</span><span class="op" id="3876509">,</span>&nbsp;<span class="ident" id="3876511">bits</span>&nbsp;<span class="builtintype" id="3876516">int</span><span class="op" id="3876519">)</span>&nbsp;<span class="op" id="3876521">(</span><span class="ident" id="3876522">p</span>&nbsp;<span class="op" id="3876524">*</span><span class="ident" id="3876525">big</span><span class="op" id="3876528">.</span><span class="ident" id="3876529">Int</span><span class="op" id="3876532">,</span>&nbsp;<span class="ident" id="3876534">err</span>&nbsp;<span class="builtintype" id="3876538">error</span><span class="op" id="3876543">)</span>&nbsp;<span class="op" id="3876545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876548">if</span>&nbsp;<span class="ident" id="3876551">bits</span>&nbsp;<span class="op" id="3876556">&lt;</span>&nbsp;<span class="num" id="3876558">2</span>&nbsp;<span class="op" id="3876560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876564">err</span>&nbsp;<span class="op" id="3876568">=</span>&nbsp;<span class="ident" id="3876570">errors</span><span class="op" id="3876576">.</span><span class="ident" id="3876577">New</span><span class="op" id="3876580">(</span><span class="string" id="3876581">&#34;crypto/rand:&nbsp;prime&nbsp;size&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;2-bit&#34;</span><span class="op" id="3876629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876633">return</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876645">b</span>&nbsp;<span class="op" id="3876647">:=</span>&nbsp;<span class="builtintype" id="3876650">uint</span><span class="op" id="3876654">(</span><span class="ident" id="3876655">bits</span>&nbsp;<span class="op" id="3876660">%</span>&nbsp;<span class="num" id="3876662">8</span><span class="op" id="3876663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876666">if</span>&nbsp;<span class="ident" id="3876669">b</span>&nbsp;<span class="op" id="3876671">==</span>&nbsp;<span class="num" id="3876674">0</span>&nbsp;<span class="op" id="3876676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876680">b</span>&nbsp;<span class="op" id="3876682">=</span>&nbsp;<span class="num" id="3876684">8</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876691">bytes</span>&nbsp;<span class="op" id="3876697">:=</span>&nbsp;<span class="builtinfunc" id="3876700">make</span><span class="op" id="3876704">(</span><span class="op" id="3876705">[</span><span class="op" id="3876706">]</span><span class="builtintype" id="3876707">byte</span><span class="op" id="3876711">,</span>&nbsp;<span class="op" id="3876713">(</span><span class="ident" id="3876714">bits</span><span class="op" id="3876718">+</span><span class="num" id="3876719">7</span><span class="op" id="3876720">)</span><span class="op" id="3876721">/</span><span class="num" id="3876722">8</span><span class="op" id="3876723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876726">p</span>&nbsp;<span class="op" id="3876728">=</span>&nbsp;<span class="builtinfunc" id="3876730">new</span><span class="op" id="3876733">(</span><span class="ident" id="3876734">big</span><span class="op" id="3876737">.</span><span class="ident" id="3876738">Int</span><span class="op" id="3876741">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876745">bigMod</span>&nbsp;<span class="op" id="3876752">:=</span>&nbsp;<span class="builtinfunc" id="3876755">new</span><span class="op" id="3876758">(</span><span class="ident" id="3876759">big</span><span class="op" id="3876762">.</span><span class="ident" id="3876763">Int</span><span class="op" id="3876766">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876770">for</span>&nbsp;<span class="op" id="3876774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876778">_</span><span class="op" id="3876779">,</span>&nbsp;<span class="ident" id="3876781">err</span>&nbsp;<span class="op" id="3876785">=</span>&nbsp;<span class="ident" id="3876787">io</span><span class="op" id="3876789">.</span><span class="ident" id="3876790">ReadFull</span><span class="op" id="3876798">(</span><span class="ident" id="3876799">rand</span><span class="op" id="3876803">,</span>&nbsp;<span class="ident" id="3876805">bytes</span><span class="op" id="3876810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876814">if</span>&nbsp;<span class="ident" id="3876817">err</span>&nbsp;<span class="op" id="3876821">!=</span>&nbsp;<span class="ident" id="3876824">nil</span>&nbsp;<span class="op" id="3876828">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876833">return</span>&nbsp;<span class="ident" id="3876840">nil</span><span class="op" id="3876843">,</span>&nbsp;<span class="ident" id="3876845">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3876856">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;candidate&nbsp;has&nbsp;a&nbsp;size&nbsp;&lt;=&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876937">bytes</span><span class="op" id="3876942">[</span><span class="num" id="3876943">0</span><span class="op" id="3876944">]</span>&nbsp;<span class="op" id="3876946">&amp;=</span>&nbsp;<span class="builtintype" id="3876949">uint8</span><span class="op" id="3876954">(</span><span class="builtintype" id="3876955">int</span><span class="op" id="3876958">(</span><span class="num" id="3876959">1</span><span class="op" id="3876960">&lt;&lt;</span><span class="ident" id="3876962">b</span><span class="op" id="3876963">)</span>&nbsp;<span class="op" id="3876965">-</span>&nbsp;<span class="num" id="3876967">1</span><span class="op" id="3876968">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3876972">//&nbsp;Don&#39;t&nbsp;let&nbsp;the&nbsp;value&nbsp;be&nbsp;too&nbsp;small,&nbsp;i.e,&nbsp;set&nbsp;the&nbsp;most&nbsp;significant&nbsp;two&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877051">//&nbsp;Setting&nbsp;the&nbsp;top&nbsp;two&nbsp;bits,&nbsp;rather&nbsp;than&nbsp;just&nbsp;the&nbsp;top&nbsp;bit,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877112">//&nbsp;means&nbsp;that&nbsp;when&nbsp;two&nbsp;of&nbsp;these&nbsp;values&nbsp;are&nbsp;multiplied&nbsp;together,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877178">//&nbsp;the&nbsp;result&nbsp;isn&#39;t&nbsp;ever&nbsp;one&nbsp;bit&nbsp;short.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877220">if</span>&nbsp;<span class="ident" id="3877223">b</span>&nbsp;<span class="op" id="3877225">&gt;=</span>&nbsp;<span class="num" id="3877228">2</span>&nbsp;<span class="op" id="3877230">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877235">bytes</span><span class="op" id="3877240">[</span><span class="num" id="3877241">0</span><span class="op" id="3877242">]</span>&nbsp;<span class="op" id="3877244">|=</span>&nbsp;<span class="num" id="3877247">3</span>&nbsp;<span class="op" id="3877249">&lt;&lt;</span>&nbsp;<span class="op" id="3877252">(</span><span class="ident" id="3877253">b</span>&nbsp;<span class="op" id="3877255">-</span>&nbsp;<span class="num" id="3877257">2</span><span class="op" id="3877258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877262">}</span>&nbsp;<span class="keyword" id="3877264">else</span>&nbsp;<span class="op" id="3877269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877274">//&nbsp;Here&nbsp;b==1,&nbsp;because&nbsp;b&nbsp;cannot&nbsp;be&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877317">bytes</span><span class="op" id="3877322">[</span><span class="num" id="3877323">0</span><span class="op" id="3877324">]</span>&nbsp;<span class="op" id="3877326">|=</span>&nbsp;<span class="num" id="3877329">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877334">if</span>&nbsp;<span class="builtinfunc" id="3877337">len</span><span class="op" id="3877340">(</span><span class="ident" id="3877341">bytes</span><span class="op" id="3877346">)</span>&nbsp;<span class="op" id="3877348">&gt;</span>&nbsp;<span class="num" id="3877350">1</span>&nbsp;<span class="op" id="3877352">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877358">bytes</span><span class="op" id="3877363">[</span><span class="num" id="3877364">1</span><span class="op" id="3877365">]</span>&nbsp;<span class="op" id="3877367">|=</span>&nbsp;<span class="num" id="3877370">0x80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877386">//&nbsp;Make&nbsp;the&nbsp;value&nbsp;odd&nbsp;since&nbsp;an&nbsp;even&nbsp;number&nbsp;this&nbsp;large&nbsp;certainly&nbsp;isn&#39;t&nbsp;prime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877465">bytes</span><span class="op" id="3877470">[</span><span class="builtinfunc" id="3877471">len</span><span class="op" id="3877474">(</span><span class="ident" id="3877475">bytes</span><span class="op" id="3877480">)</span><span class="op" id="3877481">-</span><span class="num" id="3877482">1</span><span class="op" id="3877483">]</span>&nbsp;<span class="op" id="3877485">|=</span>&nbsp;<span class="num" id="3877488">1</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877493">p</span><span class="op" id="3877494">.</span><span class="ident" id="3877495">SetBytes</span><span class="op" id="3877503">(</span><span class="ident" id="3877504">bytes</span><span class="op" id="3877509">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877514">//&nbsp;Calculate&nbsp;the&nbsp;value&nbsp;mod&nbsp;the&nbsp;product&nbsp;of&nbsp;smallPrimes.&nbsp;&nbsp;If&nbsp;it&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877580">//&nbsp;a&nbsp;multiple&nbsp;of&nbsp;any&nbsp;of&nbsp;these&nbsp;primes&nbsp;we&nbsp;add&nbsp;two&nbsp;until&nbsp;it&nbsp;isn&#39;t.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877646">//&nbsp;The&nbsp;probability&nbsp;of&nbsp;overflowing&nbsp;is&nbsp;minimal&nbsp;and&nbsp;can&nbsp;be&nbsp;ignored</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3877712">//&nbsp;because&nbsp;we&nbsp;still&nbsp;perform&nbsp;Miller-Rabin&nbsp;tests&nbsp;on&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877776">bigMod</span><span class="op" id="3877782">.</span><span class="ident" id="3877783">Mod</span><span class="op" id="3877786">(</span><span class="ident" id="3877787">p</span><span class="op" id="3877788">,</span>&nbsp;<span class="ident" id="3877790">smallPrimesProduct</span><span class="op" id="3877808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877812">mod</span>&nbsp;<span class="op" id="3877816">:=</span>&nbsp;<span class="ident" id="3877819">bigMod</span><span class="op" id="3877825">.</span><span class="ident" id="3877826">Uint64</span><span class="op" id="3877832">(</span><span class="op" id="3877833">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877837">NextDelta</span><span class="op" id="3877846">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877850">for</span>&nbsp;<span class="ident" id="3877854">delta</span>&nbsp;<span class="op" id="3877860">:=</span>&nbsp;<span class="ident" id="3877863">uint64</span><span class="op" id="3877869">(</span><span class="num" id="3877870">0</span><span class="op" id="3877871">)</span><span class="op" id="3877872">;</span>&nbsp;<span class="ident" id="3877874">delta</span>&nbsp;<span class="op" id="3877880">&lt;</span>&nbsp;<span class="num" id="3877882">1</span><span class="op" id="3877883">&lt;&lt;</span><span class="num" id="3877885">20</span><span class="op" id="3877887">;</span>&nbsp;<span class="ident" id="3877889">delta</span>&nbsp;<span class="op" id="3877895">+=</span>&nbsp;<span class="num" id="3877898">2</span>&nbsp;<span class="op" id="3877900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877905">m</span>&nbsp;<span class="op" id="3877907">:=</span>&nbsp;<span class="ident" id="3877910">mod</span>&nbsp;<span class="op" id="3877914">+</span>&nbsp;<span class="ident" id="3877916">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877925">for</span>&nbsp;<span class="ident" id="3877929">_</span><span class="op" id="3877930">,</span>&nbsp;<span class="ident" id="3877932">prime</span>&nbsp;<span class="op" id="3877938">:=</span>&nbsp;<span class="keyword" id="3877941">range</span>&nbsp;<span class="ident" id="3877947">smallPrimes</span>&nbsp;<span class="op" id="3877959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877965">if</span>&nbsp;<span class="ident" id="3877968">m</span><span class="op" id="3877969">%</span><span class="ident" id="3877970">uint64</span><span class="op" id="3877976">(</span><span class="ident" id="3877977">prime</span><span class="op" id="3877982">)</span>&nbsp;<span class="op" id="3877984">==</span>&nbsp;<span class="num" id="3877987">0</span>&nbsp;<span class="op" id="3877989">&amp;&amp;</span>&nbsp;<span class="op" id="3877992">(</span><span class="ident" id="3877993">bits</span>&nbsp;<span class="op" id="3877998">&gt;</span>&nbsp;<span class="num" id="3878000">6</span>&nbsp;<span class="op" id="3878002">||</span>&nbsp;<span class="ident" id="3878005">m</span>&nbsp;<span class="op" id="3878007">!=</span>&nbsp;<span class="ident" id="3878010">uint64</span><span class="op" id="3878016">(</span><span class="ident" id="3878017">prime</span><span class="op" id="3878022">)</span><span class="op" id="3878023">)</span>&nbsp;<span class="op" id="3878025">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878032">continue</span>&nbsp;<span class="ident" id="3878041">NextDelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878066">if</span>&nbsp;<span class="ident" id="3878069">delta</span>&nbsp;<span class="op" id="3878075">&gt;</span>&nbsp;<span class="num" id="3878077">0</span>&nbsp;<span class="op" id="3878079">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878085">bigMod</span><span class="op" id="3878091">.</span><span class="ident" id="3878092">SetUint64</span><span class="op" id="3878101">(</span><span class="ident" id="3878102">delta</span><span class="op" id="3878107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878113">p</span><span class="op" id="3878114">.</span><span class="ident" id="3878115">Add</span><span class="op" id="3878118">(</span><span class="ident" id="3878119">p</span><span class="op" id="3878120">,</span>&nbsp;<span class="ident" id="3878122">bigMod</span><span class="op" id="3878128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878138">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878146">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878151">//&nbsp;There&nbsp;is&nbsp;a&nbsp;tiny&nbsp;possibility&nbsp;that,&nbsp;by&nbsp;adding&nbsp;delta,&nbsp;we&nbsp;caused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878217">//&nbsp;the&nbsp;number&nbsp;to&nbsp;be&nbsp;one&nbsp;bit&nbsp;too&nbsp;long.&nbsp;Thus&nbsp;we&nbsp;check&nbsp;BitLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878278">//&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878289">if</span>&nbsp;<span class="ident" id="3878292">p</span><span class="op" id="3878293">.</span><span class="ident" id="3878294">ProbablyPrime</span><span class="op" id="3878307">(</span><span class="num" id="3878308">20</span><span class="op" id="3878310">)</span>&nbsp;<span class="op" id="3878312">&amp;&amp;</span>&nbsp;<span class="ident" id="3878315">p</span><span class="op" id="3878316">.</span><span class="ident" id="3878317">BitLen</span><span class="op" id="3878323">(</span><span class="op" id="3878324">)</span>&nbsp;<span class="op" id="3878326">==</span>&nbsp;<span class="ident" id="3878329">bits</span>&nbsp;<span class="op" id="3878334">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878339">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878351">}</span><br>
<span class="lineno"></span><span class="op" id="3878353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="3878356">//&nbsp;Int&nbsp;returns&nbsp;a&nbsp;uniform&nbsp;random&nbsp;value&nbsp;in&nbsp;[0,&nbsp;max).&nbsp;It&nbsp;panics&nbsp;if&nbsp;max&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3878430">func</span>&nbsp;<span class="ident" id="3878435">Int</span><span class="op" id="3878438">(</span><span class="ident" id="3878439">rand</span>&nbsp;<span class="ident" id="3878444">io</span><span class="op" id="3878446">.</span><span class="ident" id="3878447">Reader</span><span class="op" id="3878453">,</span>&nbsp;<span class="ident" id="3878455">max</span>&nbsp;<span class="op" id="3878459">*</span><span class="ident" id="3878460">big</span><span class="op" id="3878463">.</span><span class="ident" id="3878464">Int</span><span class="op" id="3878467">)</span>&nbsp;<span class="op" id="3878469">(</span><span class="ident" id="3878470">n</span>&nbsp;<span class="op" id="3878472">*</span><span class="ident" id="3878473">big</span><span class="op" id="3878476">.</span><span class="ident" id="3878477">Int</span><span class="op" id="3878480">,</span>&nbsp;<span class="ident" id="3878482">err</span>&nbsp;<span class="builtintype" id="3878486">error</span><span class="op" id="3878491">)</span>&nbsp;<span class="op" id="3878493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878496">if</span>&nbsp;<span class="ident" id="3878499">max</span><span class="op" id="3878502">.</span><span class="ident" id="3878503">Sign</span><span class="op" id="3878507">(</span><span class="op" id="3878508">)</span>&nbsp;<span class="op" id="3878510">&lt;=</span>&nbsp;<span class="num" id="3878513">0</span>&nbsp;<span class="op" id="3878515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3878519">panic</span><span class="op" id="3878524">(</span><span class="string" id="3878525">&#34;crypto/rand:&nbsp;argument&nbsp;to&nbsp;Int&nbsp;is&nbsp;&lt;=&nbsp;0&#34;</span><span class="op" id="3878563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878566">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878569">k</span>&nbsp;<span class="op" id="3878571">:=</span>&nbsp;<span class="op" id="3878574">(</span><span class="ident" id="3878575">max</span><span class="op" id="3878578">.</span><span class="ident" id="3878579">BitLen</span><span class="op" id="3878585">(</span><span class="op" id="3878586">)</span>&nbsp;<span class="op" id="3878588">+</span>&nbsp;<span class="num" id="3878590">7</span><span class="op" id="3878591">)</span>&nbsp;<span class="op" id="3878593">/</span>&nbsp;<span class="num" id="3878595">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878599">//&nbsp;b&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;the&nbsp;most&nbsp;significant&nbsp;byte&nbsp;of&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878664">b</span>&nbsp;<span class="op" id="3878666">:=</span>&nbsp;<span class="builtintype" id="3878669">uint</span><span class="op" id="3878673">(</span><span class="ident" id="3878674">max</span><span class="op" id="3878677">.</span><span class="ident" id="3878678">BitLen</span><span class="op" id="3878684">(</span><span class="op" id="3878685">)</span>&nbsp;<span class="op" id="3878687">%</span>&nbsp;<span class="num" id="3878689">8</span><span class="op" id="3878690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878693">if</span>&nbsp;<span class="ident" id="3878696">b</span>&nbsp;<span class="op" id="3878698">==</span>&nbsp;<span class="num" id="3878701">0</span>&nbsp;<span class="op" id="3878703">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878707">b</span>&nbsp;<span class="op" id="3878709">=</span>&nbsp;<span class="num" id="3878711">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878718">bytes</span>&nbsp;<span class="op" id="3878724">:=</span>&nbsp;<span class="builtinfunc" id="3878727">make</span><span class="op" id="3878731">(</span><span class="op" id="3878732">[</span><span class="op" id="3878733">]</span><span class="builtintype" id="3878734">byte</span><span class="op" id="3878738">,</span>&nbsp;<span class="ident" id="3878740">k</span><span class="op" id="3878741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878744">n</span>&nbsp;<span class="op" id="3878746">=</span>&nbsp;<span class="builtinfunc" id="3878748">new</span><span class="op" id="3878751">(</span><span class="ident" id="3878752">big</span><span class="op" id="3878755">.</span><span class="ident" id="3878756">Int</span><span class="op" id="3878759">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878763">for</span>&nbsp;<span class="op" id="3878767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878771">_</span><span class="op" id="3878772">,</span>&nbsp;<span class="ident" id="3878774">err</span>&nbsp;<span class="op" id="3878778">=</span>&nbsp;<span class="ident" id="3878780">io</span><span class="op" id="3878782">.</span><span class="ident" id="3878783">ReadFull</span><span class="op" id="3878791">(</span><span class="ident" id="3878792">rand</span><span class="op" id="3878796">,</span>&nbsp;<span class="ident" id="3878798">bytes</span><span class="op" id="3878803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878807">if</span>&nbsp;<span class="ident" id="3878810">err</span>&nbsp;<span class="op" id="3878814">!=</span>&nbsp;<span class="ident" id="3878817">nil</span>&nbsp;<span class="op" id="3878821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878826">return</span>&nbsp;<span class="ident" id="3878833">nil</span><span class="op" id="3878836">,</span>&nbsp;<span class="ident" id="3878838">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878849">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;increase&nbsp;the&nbsp;probability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878911">//&nbsp;that&nbsp;the&nbsp;candidate&nbsp;is&nbsp;&lt;&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878945">bytes</span><span class="op" id="3878950">[</span><span class="num" id="3878951">0</span><span class="op" id="3878952">]</span>&nbsp;<span class="op" id="3878954">&amp;=</span>&nbsp;<span class="builtintype" id="3878957">uint8</span><span class="op" id="3878962">(</span><span class="builtintype" id="3878963">int</span><span class="op" id="3878966">(</span><span class="num" id="3878967">1</span><span class="op" id="3878968">&lt;&lt;</span><span class="ident" id="3878970">b</span><span class="op" id="3878971">)</span>&nbsp;<span class="op" id="3878973">-</span>&nbsp;<span class="num" id="3878975">1</span><span class="op" id="3878976">)</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878981">n</span><span class="op" id="3878982">.</span><span class="ident" id="3878983">SetBytes</span><span class="op" id="3878991">(</span><span class="ident" id="3878992">bytes</span><span class="op" id="3878997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879001">if</span>&nbsp;<span class="ident" id="3879004">n</span><span class="op" id="3879005">.</span><span class="ident" id="3879006">Cmp</span><span class="op" id="3879009">(</span><span class="ident" id="3879010">max</span><span class="op" id="3879013">)</span>&nbsp;<span class="op" id="3879015">&lt;</span>&nbsp;<span class="num" id="3879017">0</span>&nbsp;<span class="op" id="3879019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879024">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879033">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879036">}</span><br>
<span class="lineno"></span><span class="op" id="3879038">}</span>
</div>
</body>
</html>
