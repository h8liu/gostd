<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html" class="current">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5656860">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5656915">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5656969">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5657020">package</span>&nbsp;<span class="ident" id="5657028">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5657033">import</span>&nbsp;<span class="op" id="5657040">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5657043">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5657049">&#34;reflect&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5657060">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5657067">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5657070">//&nbsp;An&nbsp;Encoder&nbsp;manages&nbsp;the&nbsp;transmission&nbsp;of&nbsp;type&nbsp;and&nbsp;data&nbsp;information&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5657145">//&nbsp;other&nbsp;side&nbsp;of&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">15</span><span class="keyword" id="5657176">type</span>&nbsp;<span class="ident" id="5657181">Encoder</span>&nbsp;<span class="keyword" id="5657189">struct</span>&nbsp;<span class="op" id="5657196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5657199">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5657210">sync</span><span class="op" id="5657214">.</span><span class="ident" id="5657215">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5657234">//&nbsp;each&nbsp;item&nbsp;must&nbsp;be&nbsp;sent&nbsp;atomically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5657272">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5657283">[</span><span class="op" id="5657284">]</span><span class="ident" id="5657285">io</span><span class="op" id="5657287">.</span><span class="ident" id="5657288">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5657307">//&nbsp;where&nbsp;to&nbsp;send&nbsp;the&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5657334">sent</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5657345">map</span><span class="op" id="5657348">[</span><span class="ident" id="5657349">reflect</span><span class="op" id="5657356">.</span><span class="ident" id="5657357">Type</span><span class="op" id="5657361">]</span><span class="ident" id="5657362">typeId</span>&nbsp;<span class="comment" id="5657369">//&nbsp;which&nbsp;types&nbsp;we&#39;ve&nbsp;already&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5657404">countState</span>&nbsp;<span class="op" id="5657415">*</span><span class="ident" id="5657416">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5657439">//&nbsp;stage&nbsp;for&nbsp;writing&nbsp;counts</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5657468">freeList</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5657479">*</span><span class="ident" id="5657480">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5657503">//&nbsp;list&nbsp;of&nbsp;free&nbsp;encoderStates;&nbsp;avoids&nbsp;reallocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5657555">byteBuf</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5657566">encBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5657590">//&nbsp;buffer&nbsp;for&nbsp;top-level&nbsp;encoderState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5657628">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5657639">error</span><br>
<span class="lineno"></span><span class="op" id="5657645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5657648">//&nbsp;Before&nbsp;we&nbsp;encode&nbsp;a&nbsp;message,&nbsp;we&nbsp;reserve&nbsp;space&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5657715">//&nbsp;buffer&nbsp;in&nbsp;which&nbsp;to&nbsp;encode&nbsp;its&nbsp;length.&nbsp;This&nbsp;means&nbsp;we&nbsp;can&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5657782">//&nbsp;buffer&nbsp;to&nbsp;assemble&nbsp;the&nbsp;message&nbsp;without&nbsp;another&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="5657844">const</span>&nbsp;<span class="ident" id="5657850">maxLength</span>&nbsp;<span class="op" id="5657860">=</span>&nbsp;<span class="num" id="5657862">9</span>&nbsp;<span class="comment" id="5657864">//&nbsp;Maximum&nbsp;size&nbsp;of&nbsp;an&nbsp;encoded&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="5657902">var</span>&nbsp;<span class="ident" id="5657906">spaceForLength</span>&nbsp;<span class="op" id="5657921">=</span>&nbsp;<span class="builtinfunc" id="5657923">make</span><span class="op" id="5657927">(</span><span class="op" id="5657928">[</span><span class="op" id="5657929">]</span><span class="builtintype" id="5657930">byte</span><span class="op" id="5657934">,</span>&nbsp;<span class="ident" id="5657936">maxLength</span><span class="op" id="5657945">)</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="5657948">//&nbsp;NewEncoder&nbsp;returns&nbsp;a&nbsp;new&nbsp;encoder&nbsp;that&nbsp;will&nbsp;transmit&nbsp;on&nbsp;the&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5658021">func</span>&nbsp;<span class="ident" id="5658026">NewEncoder</span><span class="op" id="5658036">(</span><span class="ident" id="5658037">w</span>&nbsp;<span class="ident" id="5658039">io</span><span class="op" id="5658041">.</span><span class="ident" id="5658042">Writer</span><span class="op" id="5658048">)</span>&nbsp;<span class="op" id="5658050">*</span><span class="ident" id="5658051">Encoder</span>&nbsp;<span class="op" id="5658059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5658062">enc</span>&nbsp;<span class="op" id="5658066">:=</span>&nbsp;<span class="builtinfunc" id="5658069">new</span><span class="op" id="5658072">(</span><span class="ident" id="5658073">Encoder</span><span class="op" id="5658080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5658083">enc</span><span class="op" id="5658086">.</span><span class="ident" id="5658087">w</span>&nbsp;<span class="op" id="5658089">=</span>&nbsp;<span class="op" id="5658091">[</span><span class="op" id="5658092">]</span><span class="ident" id="5658093">io</span><span class="op" id="5658095">.</span><span class="ident" id="5658096">Writer</span><span class="op" id="5658102">{</span><span class="ident" id="5658103">w</span><span class="op" id="5658104">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5658107">enc</span><span class="op" id="5658110">.</span><span class="ident" id="5658111">sent</span>&nbsp;<span class="op" id="5658116">=</span>&nbsp;<span class="builtinfunc" id="5658118">make</span><span class="op" id="5658122">(</span><span class="keyword" id="5658123">map</span><span class="op" id="5658126">[</span><span class="ident" id="5658127">reflect</span><span class="op" id="5658134">.</span><span class="ident" id="5658135">Type</span><span class="op" id="5658139">]</span><span class="ident" id="5658140">typeId</span><span class="op" id="5658146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5658149">enc</span><span class="op" id="5658152">.</span><span class="ident" id="5658153">countState</span>&nbsp;<span class="op" id="5658164">=</span>&nbsp;<span class="ident" id="5658166">enc</span><span class="op" id="5658169">.</span><span class="ident" id="5658170">newEncoderState</span><span class="op" id="5658185">(</span><span class="builtinfunc" id="5658186">new</span><span class="op" id="5658189">(</span><span class="ident" id="5658190">encBuffer</span><span class="op" id="5658199">)</span><span class="op" id="5658200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5658203">return</span>&nbsp;<span class="ident" id="5658210">enc</span><br>
<span class="lineno"></span><span class="op" id="5658214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="5658217">//&nbsp;writer()&nbsp;returns&nbsp;the&nbsp;innermost&nbsp;writer&nbsp;the&nbsp;encoder&nbsp;is&nbsp;using</span><br>
<span class="lineno"></span><span class="keyword" id="5658279">func</span>&nbsp;<span class="op" id="5658284">(</span><span class="ident" id="5658285">enc</span>&nbsp;<span class="op" id="5658289">*</span><span class="ident" id="5658290">Encoder</span><span class="op" id="5658297">)</span>&nbsp;<span class="ident" id="5658299">writer</span><span class="op" id="5658305">(</span><span class="op" id="5658306">)</span>&nbsp;<span class="ident" id="5658308">io</span><span class="op" id="5658310">.</span><span class="ident" id="5658311">Writer</span>&nbsp;<span class="op" id="5658318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5658321">return</span>&nbsp;<span class="ident" id="5658328">enc</span><span class="op" id="5658331">.</span><span class="ident" id="5658332">w</span><span class="op" id="5658333">[</span><span class="builtinfunc" id="5658334">len</span><span class="op" id="5658337">(</span><span class="ident" id="5658338">enc</span><span class="op" id="5658341">.</span><span class="ident" id="5658342">w</span><span class="op" id="5658343">)</span><span class="op" id="5658344">-</span><span class="num" id="5658345">1</span><span class="op" id="5658346">]</span><br>
<span class="lineno"></span><span class="op" id="5658348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5658351">//&nbsp;pushWriter&nbsp;adds&nbsp;a&nbsp;writer&nbsp;to&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="keyword" id="5658395">func</span>&nbsp;<span class="op" id="5658400">(</span><span class="ident" id="5658401">enc</span>&nbsp;<span class="op" id="5658405">*</span><span class="ident" id="5658406">Encoder</span><span class="op" id="5658413">)</span>&nbsp;<span class="ident" id="5658415">pushWriter</span><span class="op" id="5658425">(</span><span class="ident" id="5658426">w</span>&nbsp;<span class="ident" id="5658428">io</span><span class="op" id="5658430">.</span><span class="ident" id="5658431">Writer</span><span class="op" id="5658437">)</span>&nbsp;<span class="op" id="5658439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5658442">enc</span><span class="op" id="5658445">.</span><span class="ident" id="5658446">w</span>&nbsp;<span class="op" id="5658448">=</span>&nbsp;<span class="builtinfunc" id="5658450">append</span><span class="op" id="5658456">(</span><span class="ident" id="5658457">enc</span><span class="op" id="5658460">.</span><span class="ident" id="5658461">w</span><span class="op" id="5658462">,</span>&nbsp;<span class="ident" id="5658464">w</span><span class="op" id="5658465">)</span><br>
<span class="lineno"></span><span class="op" id="5658467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5658470">//&nbsp;popWriter&nbsp;pops&nbsp;the&nbsp;innermost&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5658510">func</span>&nbsp;<span class="op" id="5658515">(</span><span class="ident" id="5658516">enc</span>&nbsp;<span class="op" id="5658520">*</span><span class="ident" id="5658521">Encoder</span><span class="op" id="5658528">)</span>&nbsp;<span class="ident" id="5658530">popWriter</span><span class="op" id="5658539">(</span><span class="op" id="5658540">)</span>&nbsp;<span class="op" id="5658542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5658545">enc</span><span class="op" id="5658548">.</span><span class="ident" id="5658549">w</span>&nbsp;<span class="op" id="5658551">=</span>&nbsp;<span class="ident" id="5658553">enc</span><span class="op" id="5658556">.</span><span class="ident" id="5658557">w</span><span class="op" id="5658558">[</span><span class="num" id="5658559">0</span>&nbsp;<span class="op" id="5658561">:</span>&nbsp;<span class="builtinfunc" id="5658563">len</span><span class="op" id="5658566">(</span><span class="ident" id="5658567">enc</span><span class="op" id="5658570">.</span><span class="ident" id="5658571">w</span><span class="op" id="5658572">)</span><span class="op" id="5658573">-</span><span class="num" id="5658574">1</span><span class="op" id="5658575">]</span><br>
<span class="lineno"></span><span class="op" id="5658577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="5658580">func</span>&nbsp;<span class="op" id="5658585">(</span><span class="ident" id="5658586">enc</span>&nbsp;<span class="op" id="5658590">*</span><span class="ident" id="5658591">Encoder</span><span class="op" id="5658598">)</span>&nbsp;<span class="ident" id="5658600">setError</span><span class="op" id="5658608">(</span><span class="ident" id="5658609">err</span>&nbsp;<span class="builtintype" id="5658613">error</span><span class="op" id="5658618">)</span>&nbsp;<span class="op" id="5658620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5658623">if</span>&nbsp;<span class="ident" id="5658626">enc</span><span class="op" id="5658629">.</span><span class="ident" id="5658630">err</span>&nbsp;<span class="op" id="5658634">==</span>&nbsp;<span class="builtintype" id="5658637">nil</span>&nbsp;<span class="op" id="5658641">{</span>&nbsp;<span class="comment" id="5658643">//&nbsp;remember&nbsp;the&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5658668">enc</span><span class="op" id="5658671">.</span><span class="ident" id="5658672">err</span>&nbsp;<span class="op" id="5658676">=</span>&nbsp;<span class="ident" id="5658678">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5658683">}</span><br>
<span class="lineno"></span><span class="op" id="5658685">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="5658688">//&nbsp;writeMessage&nbsp;sends&nbsp;the&nbsp;data&nbsp;item&nbsp;preceded&nbsp;by&nbsp;a&nbsp;unsigned&nbsp;count&nbsp;of&nbsp;its&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="5658768">func</span>&nbsp;<span class="op" id="5658773">(</span><span class="ident" id="5658774">enc</span>&nbsp;<span class="op" id="5658778">*</span><span class="ident" id="5658779">Encoder</span><span class="op" id="5658786">)</span>&nbsp;<span class="ident" id="5658788">writeMessage</span><span class="op" id="5658800">(</span><span class="ident" id="5658801">w</span>&nbsp;<span class="ident" id="5658803">io</span><span class="op" id="5658805">.</span><span class="ident" id="5658806">Writer</span><span class="op" id="5658812">,</span>&nbsp;<span class="ident" id="5658814">b</span>&nbsp;<span class="op" id="5658816">*</span><span class="ident" id="5658817">encBuffer</span><span class="op" id="5658826">)</span>&nbsp;<span class="op" id="5658828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5658831">//&nbsp;Space&nbsp;has&nbsp;been&nbsp;reserved&nbsp;for&nbsp;the&nbsp;length&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5658902">//&nbsp;This&nbsp;is&nbsp;a&nbsp;little&nbsp;dirty:&nbsp;we&nbsp;grab&nbsp;the&nbsp;slice&nbsp;from&nbsp;the&nbsp;bytes.Buffer&nbsp;and&nbsp;massage</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5658982">//&nbsp;it&nbsp;by&nbsp;hand.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5658998">message</span>&nbsp;<span class="op" id="5659006">:=</span>&nbsp;<span class="ident" id="5659009">b</span><span class="op" id="5659010">.</span><span class="ident" id="5659011">Bytes</span><span class="op" id="5659016">(</span><span class="op" id="5659017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5659020">messageLen</span>&nbsp;<span class="op" id="5659031">:=</span>&nbsp;<span class="builtinfunc" id="5659034">len</span><span class="op" id="5659037">(</span><span class="ident" id="5659038">message</span><span class="op" id="5659045">)</span>&nbsp;<span class="op" id="5659047">-</span>&nbsp;<span class="ident" id="5659049">maxLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5659060">//&nbsp;Encode&nbsp;the&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5659083">enc</span><span class="op" id="5659086">.</span><span class="ident" id="5659087">countState</span><span class="op" id="5659097">.</span><span class="ident" id="5659098">b</span><span class="op" id="5659099">.</span><span class="ident" id="5659100">Reset</span><span class="op" id="5659105">(</span><span class="op" id="5659106">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5659109">enc</span><span class="op" id="5659112">.</span><span class="ident" id="5659113">countState</span><span class="op" id="5659123">.</span><span class="ident" id="5659124">encodeUint</span><span class="op" id="5659134">(</span><span class="builtintype" id="5659135">uint64</span><span class="op" id="5659141">(</span><span class="ident" id="5659142">messageLen</span><span class="op" id="5659152">)</span><span class="op" id="5659153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5659156">//&nbsp;Copy&nbsp;the&nbsp;length&nbsp;to&nbsp;be&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5659207">offset</span>&nbsp;<span class="op" id="5659214">:=</span>&nbsp;<span class="ident" id="5659217">maxLength</span>&nbsp;<span class="op" id="5659227">-</span>&nbsp;<span class="ident" id="5659229">enc</span><span class="op" id="5659232">.</span><span class="ident" id="5659233">countState</span><span class="op" id="5659243">.</span><span class="ident" id="5659244">b</span><span class="op" id="5659245">.</span><span class="ident" id="5659246">Len</span><span class="op" id="5659249">(</span><span class="op" id="5659250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5659253">copy</span><span class="op" id="5659257">(</span><span class="ident" id="5659258">message</span><span class="op" id="5659265">[</span><span class="ident" id="5659266">offset</span><span class="op" id="5659272">:</span><span class="op" id="5659273">]</span><span class="op" id="5659274">,</span>&nbsp;<span class="ident" id="5659276">enc</span><span class="op" id="5659279">.</span><span class="ident" id="5659280">countState</span><span class="op" id="5659290">.</span><span class="ident" id="5659291">b</span><span class="op" id="5659292">.</span><span class="ident" id="5659293">Bytes</span><span class="op" id="5659298">(</span><span class="op" id="5659299">)</span><span class="op" id="5659300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5659303">//&nbsp;Write&nbsp;the&nbsp;data.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5659323">_</span><span class="op" id="5659324">,</span>&nbsp;<span class="ident" id="5659326">err</span>&nbsp;<span class="op" id="5659330">:=</span>&nbsp;<span class="ident" id="5659333">w</span><span class="op" id="5659334">.</span><span class="ident" id="5659335">Write</span><span class="op" id="5659340">(</span><span class="ident" id="5659341">message</span><span class="op" id="5659348">[</span><span class="ident" id="5659349">offset</span><span class="op" id="5659355">:</span><span class="op" id="5659356">]</span><span class="op" id="5659357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5659360">//&nbsp;Drain&nbsp;the&nbsp;buffer&nbsp;and&nbsp;restore&nbsp;the&nbsp;space&nbsp;at&nbsp;the&nbsp;front&nbsp;for&nbsp;the&nbsp;count&nbsp;of&nbsp;the&nbsp;next&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5659451">b</span><span class="op" id="5659452">.</span><span class="ident" id="5659453">Reset</span><span class="op" id="5659458">(</span><span class="op" id="5659459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5659462">b</span><span class="op" id="5659463">.</span><span class="ident" id="5659464">Write</span><span class="op" id="5659469">(</span><span class="ident" id="5659470">spaceForLength</span><span class="op" id="5659484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5659487">if</span>&nbsp;<span class="ident" id="5659490">err</span>&nbsp;<span class="op" id="5659494">!=</span>&nbsp;<span class="builtintype" id="5659497">nil</span>&nbsp;<span class="op" id="5659501">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5659505">enc</span><span class="op" id="5659508">.</span><span class="ident" id="5659509">setError</span><span class="op" id="5659517">(</span><span class="ident" id="5659518">err</span><span class="op" id="5659521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5659524">}</span><br>
<span class="lineno"></span><span class="op" id="5659526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5659529">//&nbsp;sendActualType&nbsp;sends&nbsp;the&nbsp;requested&nbsp;type,&nbsp;without&nbsp;further&nbsp;investigation,&nbsp;unless</span><br>
<span class="lineno">85</span><span class="comment" id="5659611">//&nbsp;it&#39;s&nbsp;been&nbsp;sent&nbsp;before.</span><br>
<span class="lineno"></span><span class="keyword" id="5659637">func</span>&nbsp;<span class="op" id="5659642">(</span><span class="ident" id="5659643">enc</span>&nbsp;<span class="op" id="5659647">*</span><span class="ident" id="5659648">Encoder</span><span class="op" id="5659655">)</span>&nbsp;<span class="ident" id="5659657">sendActualType</span><span class="op" id="5659671">(</span><span class="ident" id="5659672">w</span>&nbsp;<span class="ident" id="5659674">io</span><span class="op" id="5659676">.</span><span class="ident" id="5659677">Writer</span><span class="op" id="5659683">,</span>&nbsp;<span class="ident" id="5659685">state</span>&nbsp;<span class="op" id="5659691">*</span><span class="ident" id="5659692">encoderState</span><span class="op" id="5659704">,</span>&nbsp;<span class="ident" id="5659706">ut</span>&nbsp;<span class="op" id="5659709">*</span><span class="ident" id="5659710">userTypeInfo</span><span class="op" id="5659722">,</span>&nbsp;<span class="ident" id="5659724">actual</span>&nbsp;<span class="ident" id="5659731">reflect</span><span class="op" id="5659738">.</span><span class="ident" id="5659739">Type</span><span class="op" id="5659743">)</span>&nbsp;<span class="op" id="5659745">(</span><span class="ident" id="5659746">sent</span>&nbsp;<span class="builtintype" id="5659751">bool</span><span class="op" id="5659755">)</span>&nbsp;<span class="op" id="5659757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5659760">if</span>&nbsp;<span class="ident" id="5659763">_</span><span class="op" id="5659764">,</span>&nbsp;<span class="ident" id="5659766">alreadySent</span>&nbsp;<span class="op" id="5659778">:=</span>&nbsp;<span class="ident" id="5659781">enc</span><span class="op" id="5659784">.</span><span class="ident" id="5659785">sent</span><span class="op" id="5659789">[</span><span class="ident" id="5659790">actual</span><span class="op" id="5659796">]</span><span class="op" id="5659797">;</span>&nbsp;<span class="ident" id="5659799">alreadySent</span>&nbsp;<span class="op" id="5659811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5659815">return</span>&nbsp;<span class="builtintype" id="5659822">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5659829">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5659832">info</span><span class="op" id="5659836">,</span>&nbsp;<span class="ident" id="5659838">err</span>&nbsp;<span class="op" id="5659842">:=</span>&nbsp;<span class="ident" id="5659845">getTypeInfo</span><span class="op" id="5659856">(</span><span class="ident" id="5659857">ut</span><span class="op" id="5659859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5659862">if</span>&nbsp;<span class="ident" id="5659865">err</span>&nbsp;<span class="op" id="5659869">!=</span>&nbsp;<span class="builtintype" id="5659872">nil</span>&nbsp;<span class="op" id="5659876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5659880">enc</span><span class="op" id="5659883">.</span><span class="ident" id="5659884">setError</span><span class="op" id="5659892">(</span><span class="ident" id="5659893">err</span><span class="op" id="5659896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5659900">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5659908">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5659911">//&nbsp;Send&nbsp;the&nbsp;pair&nbsp;(-id,&nbsp;type)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5659941">//&nbsp;Id:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5659949">state</span><span class="op" id="5659954">.</span><span class="ident" id="5659955">encodeInt</span><span class="op" id="5659964">(</span><span class="op" id="5659965">-</span><span class="builtintype" id="5659966">int64</span><span class="op" id="5659971">(</span><span class="ident" id="5659972">info</span><span class="op" id="5659976">.</span><span class="ident" id="5659977">id</span><span class="op" id="5659979">)</span><span class="op" id="5659980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5659983">//&nbsp;Type:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5659993">enc</span><span class="op" id="5659996">.</span><span class="ident" id="5659997">encode</span><span class="op" id="5660003">(</span><span class="ident" id="5660004">state</span><span class="op" id="5660009">.</span><span class="ident" id="5660010">b</span><span class="op" id="5660011">,</span>&nbsp;<span class="ident" id="5660013">reflect</span><span class="op" id="5660020">.</span><span class="ident" id="5660021">ValueOf</span><span class="op" id="5660028">(</span><span class="ident" id="5660029">info</span><span class="op" id="5660033">.</span><span class="ident" id="5660034">wire</span><span class="op" id="5660038">)</span><span class="op" id="5660039">,</span>&nbsp;<span class="ident" id="5660041">wireTypeUserInfo</span><span class="op" id="5660057">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5660060">enc</span><span class="op" id="5660063">.</span><span class="ident" id="5660064">writeMessage</span><span class="op" id="5660076">(</span><span class="ident" id="5660077">w</span><span class="op" id="5660078">,</span>&nbsp;<span class="ident" id="5660080">state</span><span class="op" id="5660085">.</span><span class="ident" id="5660086">b</span><span class="op" id="5660087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5660090">if</span>&nbsp;<span class="ident" id="5660093">enc</span><span class="op" id="5660096">.</span><span class="ident" id="5660097">err</span>&nbsp;<span class="op" id="5660101">!=</span>&nbsp;<span class="builtintype" id="5660104">nil</span>&nbsp;<span class="op" id="5660108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5660112">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5660120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5660124">//&nbsp;Remember&nbsp;we&#39;ve&nbsp;sent&nbsp;this&nbsp;type,&nbsp;both&nbsp;what&nbsp;the&nbsp;user&nbsp;gave&nbsp;us&nbsp;and&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5660205">enc</span><span class="op" id="5660208">.</span><span class="ident" id="5660209">sent</span><span class="op" id="5660213">[</span><span class="ident" id="5660214">ut</span><span class="op" id="5660216">.</span><span class="ident" id="5660217">base</span><span class="op" id="5660221">]</span>&nbsp;<span class="op" id="5660223">=</span>&nbsp;<span class="ident" id="5660225">info</span><span class="op" id="5660229">.</span><span class="ident" id="5660230">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5660234">if</span>&nbsp;<span class="ident" id="5660237">ut</span><span class="op" id="5660239">.</span><span class="ident" id="5660240">user</span>&nbsp;<span class="op" id="5660245">!=</span>&nbsp;<span class="ident" id="5660248">ut</span><span class="op" id="5660250">.</span><span class="ident" id="5660251">base</span>&nbsp;<span class="op" id="5660256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5660260">enc</span><span class="op" id="5660263">.</span><span class="ident" id="5660264">sent</span><span class="op" id="5660268">[</span><span class="ident" id="5660269">ut</span><span class="op" id="5660271">.</span><span class="ident" id="5660272">user</span><span class="op" id="5660276">]</span>&nbsp;<span class="op" id="5660278">=</span>&nbsp;<span class="ident" id="5660280">info</span><span class="op" id="5660284">.</span><span class="ident" id="5660285">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5660289">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5660292">//&nbsp;Now&nbsp;send&nbsp;the&nbsp;inner&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5660321">switch</span>&nbsp;<span class="ident" id="5660328">st</span>&nbsp;<span class="op" id="5660331">:=</span>&nbsp;<span class="ident" id="5660334">actual</span><span class="op" id="5660340">;</span>&nbsp;<span class="ident" id="5660342">st</span><span class="op" id="5660344">.</span><span class="ident" id="5660345">Kind</span><span class="op" id="5660349">(</span><span class="op" id="5660350">)</span>&nbsp;<span class="op" id="5660352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5660355">case</span>&nbsp;<span class="ident" id="5660360">reflect</span><span class="op" id="5660367">.</span><span class="ident" id="5660368">Struct</span><span class="op" id="5660374">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5660378">for</span>&nbsp;<span class="ident" id="5660382">i</span>&nbsp;<span class="op" id="5660384">:=</span>&nbsp;<span class="num" id="5660387">0</span><span class="op" id="5660388">;</span>&nbsp;<span class="ident" id="5660390">i</span>&nbsp;<span class="op" id="5660392">&lt;</span>&nbsp;<span class="ident" id="5660394">st</span><span class="op" id="5660396">.</span><span class="ident" id="5660397">NumField</span><span class="op" id="5660405">(</span><span class="op" id="5660406">)</span><span class="op" id="5660407">;</span>&nbsp;<span class="ident" id="5660409">i</span><span class="op" id="5660410">++</span>&nbsp;<span class="op" id="5660413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5660418">if</span>&nbsp;<span class="ident" id="5660421">isExported</span><span class="op" id="5660431">(</span><span class="ident" id="5660432">st</span><span class="op" id="5660434">.</span><span class="ident" id="5660435">Field</span><span class="op" id="5660440">(</span><span class="ident" id="5660441">i</span><span class="op" id="5660442">)</span><span class="op" id="5660443">.</span><span class="ident" id="5660444">Name</span><span class="op" id="5660448">)</span>&nbsp;<span class="op" id="5660450">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5660456">enc</span><span class="op" id="5660459">.</span><span class="ident" id="5660460">sendType</span><span class="op" id="5660468">(</span><span class="ident" id="5660469">w</span><span class="op" id="5660470">,</span>&nbsp;<span class="ident" id="5660472">state</span><span class="op" id="5660477">,</span>&nbsp;<span class="ident" id="5660479">st</span><span class="op" id="5660481">.</span><span class="ident" id="5660482">Field</span><span class="op" id="5660487">(</span><span class="ident" id="5660488">i</span><span class="op" id="5660489">)</span><span class="op" id="5660490">.</span><span class="ident" id="5660491">Type</span><span class="op" id="5660495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5660500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5660504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5660507">case</span>&nbsp;<span class="ident" id="5660512">reflect</span><span class="op" id="5660519">.</span><span class="ident" id="5660520">Array</span><span class="op" id="5660525">,</span>&nbsp;<span class="ident" id="5660527">reflect</span><span class="op" id="5660534">.</span><span class="ident" id="5660535">Slice</span><span class="op" id="5660540">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5660544">enc</span><span class="op" id="5660547">.</span><span class="ident" id="5660548">sendType</span><span class="op" id="5660556">(</span><span class="ident" id="5660557">w</span><span class="op" id="5660558">,</span>&nbsp;<span class="ident" id="5660560">state</span><span class="op" id="5660565">,</span>&nbsp;<span class="ident" id="5660567">st</span><span class="op" id="5660569">.</span><span class="ident" id="5660570">Elem</span><span class="op" id="5660574">(</span><span class="op" id="5660575">)</span><span class="op" id="5660576">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5660579">case</span>&nbsp;<span class="ident" id="5660584">reflect</span><span class="op" id="5660591">.</span><span class="ident" id="5660592">Map</span><span class="op" id="5660595">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5660599">enc</span><span class="op" id="5660602">.</span><span class="ident" id="5660603">sendType</span><span class="op" id="5660611">(</span><span class="ident" id="5660612">w</span><span class="op" id="5660613">,</span>&nbsp;<span class="ident" id="5660615">state</span><span class="op" id="5660620">,</span>&nbsp;<span class="ident" id="5660622">st</span><span class="op" id="5660624">.</span><span class="ident" id="5660625">Key</span><span class="op" id="5660628">(</span><span class="op" id="5660629">)</span><span class="op" id="5660630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5660634">enc</span><span class="op" id="5660637">.</span><span class="ident" id="5660638">sendType</span><span class="op" id="5660646">(</span><span class="ident" id="5660647">w</span><span class="op" id="5660648">,</span>&nbsp;<span class="ident" id="5660650">state</span><span class="op" id="5660655">,</span>&nbsp;<span class="ident" id="5660657">st</span><span class="op" id="5660659">.</span><span class="ident" id="5660660">Elem</span><span class="op" id="5660664">(</span><span class="op" id="5660665">)</span><span class="op" id="5660666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5660669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5660672">return</span>&nbsp;<span class="builtintype" id="5660679">true</span><br>
<span class="lineno">125</span><span class="op" id="5660684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5660687">//&nbsp;sendType&nbsp;sends&nbsp;the&nbsp;type&nbsp;info&nbsp;to&nbsp;the&nbsp;other&nbsp;side,&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="5660752">func</span>&nbsp;<span class="op" id="5660757">(</span><span class="ident" id="5660758">enc</span>&nbsp;<span class="op" id="5660762">*</span><span class="ident" id="5660763">Encoder</span><span class="op" id="5660770">)</span>&nbsp;<span class="ident" id="5660772">sendType</span><span class="op" id="5660780">(</span><span class="ident" id="5660781">w</span>&nbsp;<span class="ident" id="5660783">io</span><span class="op" id="5660785">.</span><span class="ident" id="5660786">Writer</span><span class="op" id="5660792">,</span>&nbsp;<span class="ident" id="5660794">state</span>&nbsp;<span class="op" id="5660800">*</span><span class="ident" id="5660801">encoderState</span><span class="op" id="5660813">,</span>&nbsp;<span class="ident" id="5660815">origt</span>&nbsp;<span class="ident" id="5660821">reflect</span><span class="op" id="5660828">.</span><span class="ident" id="5660829">Type</span><span class="op" id="5660833">)</span>&nbsp;<span class="op" id="5660835">(</span><span class="ident" id="5660836">sent</span>&nbsp;<span class="builtintype" id="5660841">bool</span><span class="op" id="5660845">)</span>&nbsp;<span class="op" id="5660847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5660850">ut</span>&nbsp;<span class="op" id="5660853">:=</span>&nbsp;<span class="ident" id="5660856">userType</span><span class="op" id="5660864">(</span><span class="ident" id="5660865">origt</span><span class="op" id="5660870">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5660873">if</span>&nbsp;<span class="ident" id="5660876">ut</span><span class="op" id="5660878">.</span><span class="ident" id="5660879">externalEnc</span>&nbsp;<span class="op" id="5660891">!=</span>&nbsp;<span class="num" id="5660894">0</span>&nbsp;<span class="op" id="5660896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5660900">//&nbsp;The&nbsp;rules&nbsp;are&nbsp;different:&nbsp;regardless&nbsp;of&nbsp;the&nbsp;underlying&nbsp;type&#39;s&nbsp;representation,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5660982">//&nbsp;we&nbsp;need&nbsp;to&nbsp;tell&nbsp;the&nbsp;other&nbsp;side&nbsp;that&nbsp;the&nbsp;base&nbsp;type&nbsp;is&nbsp;a&nbsp;GobEncoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661054">return</span>&nbsp;<span class="ident" id="5661061">enc</span><span class="op" id="5661064">.</span><span class="ident" id="5661065">sendActualType</span><span class="op" id="5661079">(</span><span class="ident" id="5661080">w</span><span class="op" id="5661081">,</span>&nbsp;<span class="ident" id="5661083">state</span><span class="op" id="5661088">,</span>&nbsp;<span class="ident" id="5661090">ut</span><span class="op" id="5661092">,</span>&nbsp;<span class="ident" id="5661094">ut</span><span class="op" id="5661096">.</span><span class="ident" id="5661097">base</span><span class="op" id="5661101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5661104">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5661108">//&nbsp;It&#39;s&nbsp;a&nbsp;concrete&nbsp;value,&nbsp;so&nbsp;drill&nbsp;down&nbsp;to&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661167">switch</span>&nbsp;<span class="ident" id="5661174">rt</span>&nbsp;<span class="op" id="5661177">:=</span>&nbsp;<span class="ident" id="5661180">ut</span><span class="op" id="5661182">.</span><span class="ident" id="5661183">base</span><span class="op" id="5661187">;</span>&nbsp;<span class="ident" id="5661189">rt</span><span class="op" id="5661191">.</span><span class="ident" id="5661192">Kind</span><span class="op" id="5661196">(</span><span class="op" id="5661197">)</span>&nbsp;<span class="op" id="5661199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661202">default</span><span class="op" id="5661209">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5661213">//&nbsp;Basic&nbsp;types&nbsp;and&nbsp;interfaces&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;be&nbsp;described.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661274">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661282">case</span>&nbsp;<span class="ident" id="5661287">reflect</span><span class="op" id="5661294">.</span><span class="ident" id="5661295">Slice</span><span class="op" id="5661300">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5661304">//&nbsp;If&nbsp;it&#39;s&nbsp;[]uint8,&nbsp;don&#39;t&nbsp;send;&nbsp;it&#39;s&nbsp;considered&nbsp;basic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661361">if</span>&nbsp;<span class="ident" id="5661364">rt</span><span class="op" id="5661366">.</span><span class="ident" id="5661367">Elem</span><span class="op" id="5661371">(</span><span class="op" id="5661372">)</span><span class="op" id="5661373">.</span><span class="ident" id="5661374">Kind</span><span class="op" id="5661378">(</span><span class="op" id="5661379">)</span>&nbsp;<span class="op" id="5661381">==</span>&nbsp;<span class="ident" id="5661384">reflect</span><span class="op" id="5661391">.</span><span class="ident" id="5661392">Uint8</span>&nbsp;<span class="op" id="5661398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661403">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5661412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5661416">//&nbsp;Otherwise&nbsp;we&nbsp;do&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661443">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661450">case</span>&nbsp;<span class="ident" id="5661455">reflect</span><span class="op" id="5661462">.</span><span class="ident" id="5661463">Array</span><span class="op" id="5661468">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5661472">//&nbsp;arrays&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;element&nbsp;types.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661541">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661548">case</span>&nbsp;<span class="ident" id="5661553">reflect</span><span class="op" id="5661560">.</span><span class="ident" id="5661561">Map</span><span class="op" id="5661564">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5661568">//&nbsp;maps&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;key/value&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661637">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661644">case</span>&nbsp;<span class="ident" id="5661649">reflect</span><span class="op" id="5661656">.</span><span class="ident" id="5661657">Struct</span><span class="op" id="5661663">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5661667">//&nbsp;structs&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661718">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661725">case</span>&nbsp;<span class="ident" id="5661730">reflect</span><span class="op" id="5661737">.</span><span class="ident" id="5661738">Chan</span><span class="op" id="5661742">,</span>&nbsp;<span class="ident" id="5661744">reflect</span><span class="op" id="5661751">.</span><span class="ident" id="5661752">Func</span><span class="op" id="5661756">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5661760">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here,&nbsp;it&#39;s&nbsp;a&nbsp;field&nbsp;of&nbsp;a&nbsp;struct;&nbsp;ignore&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661818">return</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5661826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5661830">return</span>&nbsp;<span class="ident" id="5661837">enc</span><span class="op" id="5661840">.</span><span class="ident" id="5661841">sendActualType</span><span class="op" id="5661855">(</span><span class="ident" id="5661856">w</span><span class="op" id="5661857">,</span>&nbsp;<span class="ident" id="5661859">state</span><span class="op" id="5661864">,</span>&nbsp;<span class="ident" id="5661866">ut</span><span class="op" id="5661868">,</span>&nbsp;<span class="ident" id="5661870">ut</span><span class="op" id="5661872">.</span><span class="ident" id="5661873">base</span><span class="op" id="5661877">)</span><br>
<span class="lineno"></span><span class="op" id="5661879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="5661882">//&nbsp;Encode&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;empty&nbsp;interface&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="5661958">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="5662038">func</span>&nbsp;<span class="op" id="5662043">(</span><span class="ident" id="5662044">enc</span>&nbsp;<span class="op" id="5662048">*</span><span class="ident" id="5662049">Encoder</span><span class="op" id="5662056">)</span>&nbsp;<span class="ident" id="5662058">Encode</span><span class="op" id="5662064">(</span><span class="ident" id="5662065">e</span>&nbsp;<span class="keyword" id="5662067">interface</span><span class="op" id="5662076">{</span><span class="op" id="5662077">}</span><span class="op" id="5662078">)</span>&nbsp;<span class="builtintype" id="5662080">error</span>&nbsp;<span class="op" id="5662086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5662089">return</span>&nbsp;<span class="ident" id="5662096">enc</span><span class="op" id="5662099">.</span><span class="ident" id="5662100">EncodeValue</span><span class="op" id="5662111">(</span><span class="ident" id="5662112">reflect</span><span class="op" id="5662119">.</span><span class="ident" id="5662120">ValueOf</span><span class="op" id="5662127">(</span><span class="ident" id="5662128">e</span><span class="op" id="5662129">)</span><span class="op" id="5662130">)</span><br>
<span class="lineno"></span><span class="op" id="5662132">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="5662135">//&nbsp;sendTypeDescriptor&nbsp;makes&nbsp;sure&nbsp;the&nbsp;remote&nbsp;side&nbsp;knows&nbsp;about&nbsp;this&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="5662207">//&nbsp;It&nbsp;will&nbsp;send&nbsp;a&nbsp;descriptor&nbsp;if&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;time&nbsp;the&nbsp;type&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span><span class="comment" id="5662280">//&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="5662289">func</span>&nbsp;<span class="op" id="5662294">(</span><span class="ident" id="5662295">enc</span>&nbsp;<span class="op" id="5662299">*</span><span class="ident" id="5662300">Encoder</span><span class="op" id="5662307">)</span>&nbsp;<span class="ident" id="5662309">sendTypeDescriptor</span><span class="op" id="5662327">(</span><span class="ident" id="5662328">w</span>&nbsp;<span class="ident" id="5662330">io</span><span class="op" id="5662332">.</span><span class="ident" id="5662333">Writer</span><span class="op" id="5662339">,</span>&nbsp;<span class="ident" id="5662341">state</span>&nbsp;<span class="op" id="5662347">*</span><span class="ident" id="5662348">encoderState</span><span class="op" id="5662360">,</span>&nbsp;<span class="ident" id="5662362">ut</span>&nbsp;<span class="op" id="5662365">*</span><span class="ident" id="5662366">userTypeInfo</span><span class="op" id="5662378">)</span>&nbsp;<span class="op" id="5662380">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5662383">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;type&nbsp;is&nbsp;known&nbsp;to&nbsp;the&nbsp;other&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5662434">//&nbsp;First,&nbsp;have&nbsp;we&nbsp;already&nbsp;sent&nbsp;this&nbsp;type?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5662477">rt</span>&nbsp;<span class="op" id="5662480">:=</span>&nbsp;<span class="ident" id="5662483">ut</span><span class="op" id="5662485">.</span><span class="ident" id="5662486">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5662492">if</span>&nbsp;<span class="ident" id="5662495">ut</span><span class="op" id="5662497">.</span><span class="ident" id="5662498">externalEnc</span>&nbsp;<span class="op" id="5662510">!=</span>&nbsp;<span class="num" id="5662513">0</span>&nbsp;<span class="op" id="5662515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5662519">rt</span>&nbsp;<span class="op" id="5662522">=</span>&nbsp;<span class="ident" id="5662524">ut</span><span class="op" id="5662526">.</span><span class="ident" id="5662527">user</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5662533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5662536">if</span>&nbsp;<span class="ident" id="5662539">_</span><span class="op" id="5662540">,</span>&nbsp;<span class="ident" id="5662542">alreadySent</span>&nbsp;<span class="op" id="5662554">:=</span>&nbsp;<span class="ident" id="5662557">enc</span><span class="op" id="5662560">.</span><span class="ident" id="5662561">sent</span><span class="op" id="5662565">[</span><span class="ident" id="5662566">rt</span><span class="op" id="5662568">]</span><span class="op" id="5662569">;</span>&nbsp;<span class="op" id="5662571">!</span><span class="ident" id="5662572">alreadySent</span>&nbsp;<span class="op" id="5662584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5662588">//&nbsp;No,&nbsp;so&nbsp;send&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5662609">sent</span>&nbsp;<span class="op" id="5662614">:=</span>&nbsp;<span class="ident" id="5662617">enc</span><span class="op" id="5662620">.</span><span class="ident" id="5662621">sendType</span><span class="op" id="5662629">(</span><span class="ident" id="5662630">w</span><span class="op" id="5662631">,</span>&nbsp;<span class="ident" id="5662633">state</span><span class="op" id="5662638">,</span>&nbsp;<span class="ident" id="5662640">rt</span><span class="op" id="5662642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5662646">if</span>&nbsp;<span class="ident" id="5662649">enc</span><span class="op" id="5662652">.</span><span class="ident" id="5662653">err</span>&nbsp;<span class="op" id="5662657">!=</span>&nbsp;<span class="builtintype" id="5662660">nil</span>&nbsp;<span class="op" id="5662664">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5662669">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5662678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5662682">//&nbsp;If&nbsp;the&nbsp;type&nbsp;info&nbsp;has&nbsp;still&nbsp;not&nbsp;been&nbsp;transmitted,&nbsp;it&nbsp;means&nbsp;we&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5662753">//&nbsp;a&nbsp;singleton&nbsp;basic&nbsp;type&nbsp;(int,&nbsp;[]byte&nbsp;etc.)&nbsp;at&nbsp;top&nbsp;level.&nbsp;&nbsp;We&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5662824">//&nbsp;need&nbsp;to&nbsp;send&nbsp;the&nbsp;type&nbsp;info&nbsp;but&nbsp;we&nbsp;do&nbsp;need&nbsp;to&nbsp;update&nbsp;enc.sent.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5662891">if</span>&nbsp;<span class="op" id="5662894">!</span><span class="ident" id="5662895">sent</span>&nbsp;<span class="op" id="5662900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5662905">info</span><span class="op" id="5662909">,</span>&nbsp;<span class="ident" id="5662911">err</span>&nbsp;<span class="op" id="5662915">:=</span>&nbsp;<span class="ident" id="5662918">getTypeInfo</span><span class="op" id="5662929">(</span><span class="ident" id="5662930">ut</span><span class="op" id="5662932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5662937">if</span>&nbsp;<span class="ident" id="5662940">err</span>&nbsp;<span class="op" id="5662944">!=</span>&nbsp;<span class="builtintype" id="5662947">nil</span>&nbsp;<span class="op" id="5662951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5662957">enc</span><span class="op" id="5662960">.</span><span class="ident" id="5662961">setError</span><span class="op" id="5662969">(</span><span class="ident" id="5662970">err</span><span class="op" id="5662973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5662979">return</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5662989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5662994">enc</span><span class="op" id="5662997">.</span><span class="ident" id="5662998">sent</span><span class="op" id="5663002">[</span><span class="ident" id="5663003">rt</span><span class="op" id="5663005">]</span>&nbsp;<span class="op" id="5663007">=</span>&nbsp;<span class="ident" id="5663009">info</span><span class="op" id="5663013">.</span><span class="ident" id="5663014">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5663019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5663022">}</span><br>
<span class="lineno"></span><span class="op" id="5663024">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="5663027">//&nbsp;sendTypeId&nbsp;sends&nbsp;the&nbsp;id,&nbsp;which&nbsp;must&nbsp;have&nbsp;already&nbsp;been&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="5663093">func</span>&nbsp;<span class="op" id="5663098">(</span><span class="ident" id="5663099">enc</span>&nbsp;<span class="op" id="5663103">*</span><span class="ident" id="5663104">Encoder</span><span class="op" id="5663111">)</span>&nbsp;<span class="ident" id="5663113">sendTypeId</span><span class="op" id="5663123">(</span><span class="ident" id="5663124">state</span>&nbsp;<span class="op" id="5663130">*</span><span class="ident" id="5663131">encoderState</span><span class="op" id="5663143">,</span>&nbsp;<span class="ident" id="5663145">ut</span>&nbsp;<span class="op" id="5663148">*</span><span class="ident" id="5663149">userTypeInfo</span><span class="op" id="5663161">)</span>&nbsp;<span class="op" id="5663163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5663166">//&nbsp;Identify&nbsp;the&nbsp;type&nbsp;of&nbsp;this&nbsp;top-level&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5663213">state</span><span class="op" id="5663218">.</span><span class="ident" id="5663219">encodeInt</span><span class="op" id="5663228">(</span><span class="builtintype" id="5663229">int64</span><span class="op" id="5663234">(</span><span class="ident" id="5663235">enc</span><span class="op" id="5663238">.</span><span class="ident" id="5663239">sent</span><span class="op" id="5663243">[</span><span class="ident" id="5663244">ut</span><span class="op" id="5663246">.</span><span class="ident" id="5663247">base</span><span class="op" id="5663251">]</span><span class="op" id="5663252">)</span><span class="op" id="5663253">)</span><br>
<span class="lineno">205</span><span class="op" id="5663255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5663258">//&nbsp;EncodeValue&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;reflection&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="5663334">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="5663414">func</span>&nbsp;<span class="op" id="5663419">(</span><span class="ident" id="5663420">enc</span>&nbsp;<span class="op" id="5663424">*</span><span class="ident" id="5663425">Encoder</span><span class="op" id="5663432">)</span>&nbsp;<span class="ident" id="5663434">EncodeValue</span><span class="op" id="5663445">(</span><span class="ident" id="5663446">value</span>&nbsp;<span class="ident" id="5663452">reflect</span><span class="op" id="5663459">.</span><span class="ident" id="5663460">Value</span><span class="op" id="5663465">)</span>&nbsp;<span class="builtintype" id="5663467">error</span>&nbsp;<span class="op" id="5663473">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5663476">//&nbsp;Gobs&nbsp;contain&nbsp;values.&nbsp;They&nbsp;cannot&nbsp;represent&nbsp;nil&nbsp;pointers,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5663543">//&nbsp;have&nbsp;no&nbsp;value&nbsp;to&nbsp;encode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5663572">if</span>&nbsp;<span class="ident" id="5663575">value</span><span class="op" id="5663580">.</span><span class="ident" id="5663581">Kind</span><span class="op" id="5663585">(</span><span class="op" id="5663586">)</span>&nbsp;<span class="op" id="5663588">==</span>&nbsp;<span class="ident" id="5663591">reflect</span><span class="op" id="5663598">.</span><span class="ident" id="5663599">Ptr</span>&nbsp;<span class="op" id="5663603">&amp;&amp;</span>&nbsp;<span class="ident" id="5663606">value</span><span class="op" id="5663611">.</span><span class="ident" id="5663612">IsNil</span><span class="op" id="5663617">(</span><span class="op" id="5663618">)</span>&nbsp;<span class="op" id="5663620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5663624">panic</span><span class="op" id="5663629">(</span><span class="string" id="5663630">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5663672">+</span>&nbsp;<span class="ident" id="5663674">value</span><span class="op" id="5663679">.</span><span class="ident" id="5663680">Type</span><span class="op" id="5663684">(</span><span class="op" id="5663685">)</span><span class="op" id="5663686">.</span><span class="ident" id="5663687">String</span><span class="op" id="5663693">(</span><span class="op" id="5663694">)</span><span class="op" id="5663695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5663698">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5663702">//&nbsp;Make&nbsp;sure&nbsp;we&#39;re&nbsp;single-threaded&nbsp;through&nbsp;here,&nbsp;so&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5663764">//&nbsp;goroutines&nbsp;can&nbsp;share&nbsp;an&nbsp;encoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5663801">enc</span><span class="op" id="5663804">.</span><span class="ident" id="5663805">mutex</span><span class="op" id="5663810">.</span><span class="ident" id="5663811">Lock</span><span class="op" id="5663815">(</span><span class="op" id="5663816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5663819">defer</span>&nbsp;<span class="ident" id="5663825">enc</span><span class="op" id="5663828">.</span><span class="ident" id="5663829">mutex</span><span class="op" id="5663834">.</span><span class="ident" id="5663835">Unlock</span><span class="op" id="5663841">(</span><span class="op" id="5663842">)</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5663846">//&nbsp;Remove&nbsp;any&nbsp;nested&nbsp;writers&nbsp;remaining&nbsp;due&nbsp;to&nbsp;previous&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5663910">enc</span><span class="op" id="5663913">.</span><span class="ident" id="5663914">w</span>&nbsp;<span class="op" id="5663916">=</span>&nbsp;<span class="ident" id="5663918">enc</span><span class="op" id="5663921">.</span><span class="ident" id="5663922">w</span><span class="op" id="5663923">[</span><span class="num" id="5663924">0</span><span class="op" id="5663925">:</span><span class="num" id="5663926">1</span><span class="op" id="5663927">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5663931">ut</span><span class="op" id="5663933">,</span>&nbsp;<span class="ident" id="5663935">err</span>&nbsp;<span class="op" id="5663939">:=</span>&nbsp;<span class="ident" id="5663942">validUserType</span><span class="op" id="5663955">(</span><span class="ident" id="5663956">value</span><span class="op" id="5663961">.</span><span class="ident" id="5663962">Type</span><span class="op" id="5663966">(</span><span class="op" id="5663967">)</span><span class="op" id="5663968">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5663971">if</span>&nbsp;<span class="ident" id="5663974">err</span>&nbsp;<span class="op" id="5663978">!=</span>&nbsp;<span class="builtintype" id="5663981">nil</span>&nbsp;<span class="op" id="5663985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5663989">return</span>&nbsp;<span class="ident" id="5663996">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5664001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5664005">enc</span><span class="op" id="5664008">.</span><span class="ident" id="5664009">err</span>&nbsp;<span class="op" id="5664013">=</span>&nbsp;<span class="builtintype" id="5664015">nil</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5664020">enc</span><span class="op" id="5664023">.</span><span class="ident" id="5664024">byteBuf</span><span class="op" id="5664031">.</span><span class="ident" id="5664032">Reset</span><span class="op" id="5664037">(</span><span class="op" id="5664038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5664041">enc</span><span class="op" id="5664044">.</span><span class="ident" id="5664045">byteBuf</span><span class="op" id="5664052">.</span><span class="ident" id="5664053">Write</span><span class="op" id="5664058">(</span><span class="ident" id="5664059">spaceForLength</span><span class="op" id="5664073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5664076">state</span>&nbsp;<span class="op" id="5664082">:=</span>&nbsp;<span class="ident" id="5664085">enc</span><span class="op" id="5664088">.</span><span class="ident" id="5664089">newEncoderState</span><span class="op" id="5664104">(</span><span class="op" id="5664105">&amp;</span><span class="ident" id="5664106">enc</span><span class="op" id="5664109">.</span><span class="ident" id="5664110">byteBuf</span><span class="op" id="5664117">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5664121">enc</span><span class="op" id="5664124">.</span><span class="ident" id="5664125">sendTypeDescriptor</span><span class="op" id="5664143">(</span><span class="ident" id="5664144">enc</span><span class="op" id="5664147">.</span><span class="ident" id="5664148">writer</span><span class="op" id="5664154">(</span><span class="op" id="5664155">)</span><span class="op" id="5664156">,</span>&nbsp;<span class="ident" id="5664158">state</span><span class="op" id="5664163">,</span>&nbsp;<span class="ident" id="5664165">ut</span><span class="op" id="5664167">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5664170">enc</span><span class="op" id="5664173">.</span><span class="ident" id="5664174">sendTypeId</span><span class="op" id="5664184">(</span><span class="ident" id="5664185">state</span><span class="op" id="5664190">,</span>&nbsp;<span class="ident" id="5664192">ut</span><span class="op" id="5664194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5664197">if</span>&nbsp;<span class="ident" id="5664200">enc</span><span class="op" id="5664203">.</span><span class="ident" id="5664204">err</span>&nbsp;<span class="op" id="5664208">!=</span>&nbsp;<span class="builtintype" id="5664211">nil</span>&nbsp;<span class="op" id="5664215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5664219">return</span>&nbsp;<span class="ident" id="5664226">enc</span><span class="op" id="5664229">.</span><span class="ident" id="5664230">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5664235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5664239">//&nbsp;Encode&nbsp;the&nbsp;object.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5664262">enc</span><span class="op" id="5664265">.</span><span class="ident" id="5664266">encode</span><span class="op" id="5664272">(</span><span class="ident" id="5664273">state</span><span class="op" id="5664278">.</span><span class="ident" id="5664279">b</span><span class="op" id="5664280">,</span>&nbsp;<span class="ident" id="5664282">value</span><span class="op" id="5664287">,</span>&nbsp;<span class="ident" id="5664289">ut</span><span class="op" id="5664291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5664294">if</span>&nbsp;<span class="ident" id="5664297">enc</span><span class="op" id="5664300">.</span><span class="ident" id="5664301">err</span>&nbsp;<span class="op" id="5664305">==</span>&nbsp;<span class="builtintype" id="5664308">nil</span>&nbsp;<span class="op" id="5664312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5664316">enc</span><span class="op" id="5664319">.</span><span class="ident" id="5664320">writeMessage</span><span class="op" id="5664332">(</span><span class="ident" id="5664333">enc</span><span class="op" id="5664336">.</span><span class="ident" id="5664337">writer</span><span class="op" id="5664343">(</span><span class="op" id="5664344">)</span><span class="op" id="5664345">,</span>&nbsp;<span class="ident" id="5664347">state</span><span class="op" id="5664352">.</span><span class="ident" id="5664353">b</span><span class="op" id="5664354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5664357">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5664361">enc</span><span class="op" id="5664364">.</span><span class="ident" id="5664365">freeEncoderState</span><span class="op" id="5664381">(</span><span class="ident" id="5664382">state</span><span class="op" id="5664387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5664390">return</span>&nbsp;<span class="ident" id="5664397">enc</span><span class="op" id="5664400">.</span><span class="ident" id="5664401">err</span><br>
<span class="lineno"></span><span class="op" id="5664405">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
