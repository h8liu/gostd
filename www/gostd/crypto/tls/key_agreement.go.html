<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html" class="current">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3977880">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3977935">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3977989">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3978040">package</span>&nbsp;<span class="ident" id="3978048">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3978053">import</span>&nbsp;<span class="op" id="3978060">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3978063">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3978073">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3978089">&#34;crypto/elliptic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3978108">&#34;crypto/md5&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3978122">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3978136">&#34;crypto/sha1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3978151">&#34;crypto/sha256&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3978168">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3978183">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3978200">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3978210">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3978216">&#34;math/big&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3978227">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3978230">var</span>&nbsp;<span class="ident" id="3978234">errClientKeyExchange</span>&nbsp;<span class="op" id="3978255">=</span>&nbsp;<span class="ident" id="3978257">errors</span><span class="op" id="3978263">.</span><span class="ident" id="3978264">New</span><span class="op" id="3978267">(</span><span class="string" id="3978268">&#34;tls:&nbsp;invalid&nbsp;ClientKeyExchange&nbsp;message&#34;</span><span class="op" id="3978308">)</span><br>
<span class="lineno"></span><span class="keyword" id="3978310">var</span>&nbsp;<span class="ident" id="3978314">errServerKeyExchange</span>&nbsp;<span class="op" id="3978335">=</span>&nbsp;<span class="ident" id="3978337">errors</span><span class="op" id="3978343">.</span><span class="ident" id="3978344">New</span><span class="op" id="3978347">(</span><span class="string" id="3978348">&#34;tls:&nbsp;invalid&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="3978388">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3978391">//&nbsp;rsaKeyAgreement&nbsp;implements&nbsp;the&nbsp;standard&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="3978469">//&nbsp;encrypts&nbsp;the&nbsp;pre-master&nbsp;secret&nbsp;to&nbsp;the&nbsp;server&#39;s&nbsp;public&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="3978531">type</span>&nbsp;<span class="ident" id="3978536">rsaKeyAgreement</span>&nbsp;<span class="keyword" id="3978552">struct</span><span class="op" id="3978558">{</span><span class="op" id="3978559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3978562">func</span>&nbsp;<span class="op" id="3978567">(</span><span class="ident" id="3978568">ka</span>&nbsp;<span class="ident" id="3978571">rsaKeyAgreement</span><span class="op" id="3978586">)</span>&nbsp;<span class="ident" id="3978588">generateServerKeyExchange</span><span class="op" id="3978613">(</span><span class="ident" id="3978614">config</span>&nbsp;<span class="op" id="3978621">*</span><span class="ident" id="3978622">Config</span><span class="op" id="3978628">,</span>&nbsp;<span class="ident" id="3978630">cert</span>&nbsp;<span class="op" id="3978635">*</span><span class="ident" id="3978636">Certificate</span><span class="op" id="3978647">,</span>&nbsp;<span class="ident" id="3978649">clientHello</span>&nbsp;<span class="op" id="3978661">*</span><span class="ident" id="3978662">clientHelloMsg</span><span class="op" id="3978676">,</span>&nbsp;<span class="ident" id="3978678">hello</span>&nbsp;<span class="op" id="3978684">*</span><span class="ident" id="3978685">serverHelloMsg</span><span class="op" id="3978699">)</span>&nbsp;<span class="op" id="3978701">(</span><span class="op" id="3978702">*</span><span class="ident" id="3978703">serverKeyExchangeMsg</span><span class="op" id="3978723">,</span>&nbsp;<span class="builtintype" id="3978725">error</span><span class="op" id="3978730">)</span>&nbsp;<span class="op" id="3978732">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3978735">return</span>&nbsp;<span class="ident" id="3978742">nil</span><span class="op" id="3978745">,</span>&nbsp;<span class="ident" id="3978747">nil</span><br>
<span class="lineno"></span><span class="op" id="3978751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3978754">func</span>&nbsp;<span class="op" id="3978759">(</span><span class="ident" id="3978760">ka</span>&nbsp;<span class="ident" id="3978763">rsaKeyAgreement</span><span class="op" id="3978778">)</span>&nbsp;<span class="ident" id="3978780">processClientKeyExchange</span><span class="op" id="3978804">(</span><span class="ident" id="3978805">config</span>&nbsp;<span class="op" id="3978812">*</span><span class="ident" id="3978813">Config</span><span class="op" id="3978819">,</span>&nbsp;<span class="ident" id="3978821">cert</span>&nbsp;<span class="op" id="3978826">*</span><span class="ident" id="3978827">Certificate</span><span class="op" id="3978838">,</span>&nbsp;<span class="ident" id="3978840">ckx</span>&nbsp;<span class="op" id="3978844">*</span><span class="ident" id="3978845">clientKeyExchangeMsg</span><span class="op" id="3978865">,</span>&nbsp;<span class="ident" id="3978867">version</span>&nbsp;<span class="builtintype" id="3978875">uint16</span><span class="op" id="3978881">)</span>&nbsp;<span class="op" id="3978883">(</span><span class="op" id="3978884">[</span><span class="op" id="3978885">]</span><span class="builtintype" id="3978886">byte</span><span class="op" id="3978890">,</span>&nbsp;<span class="builtintype" id="3978892">error</span><span class="op" id="3978897">)</span>&nbsp;<span class="op" id="3978899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3978902">preMasterSecret</span>&nbsp;<span class="op" id="3978918">:=</span>&nbsp;<span class="builtinfunc" id="3978921">make</span><span class="op" id="3978925">(</span><span class="op" id="3978926">[</span><span class="op" id="3978927">]</span><span class="builtintype" id="3978928">byte</span><span class="op" id="3978932">,</span>&nbsp;<span class="num" id="3978934">48</span><span class="op" id="3978936">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3978939">_</span><span class="op" id="3978940">,</span>&nbsp;<span class="ident" id="3978942">err</span>&nbsp;<span class="op" id="3978946">:=</span>&nbsp;<span class="ident" id="3978949">io</span><span class="op" id="3978951">.</span><span class="ident" id="3978952">ReadFull</span><span class="op" id="3978960">(</span><span class="ident" id="3978961">config</span><span class="op" id="3978967">.</span><span class="ident" id="3978968">rand</span><span class="op" id="3978972">(</span><span class="op" id="3978973">)</span><span class="op" id="3978974">,</span>&nbsp;<span class="ident" id="3978976">preMasterSecret</span><span class="op" id="3978991">[</span><span class="num" id="3978992">2</span><span class="op" id="3978993">:</span><span class="op" id="3978994">]</span><span class="op" id="3978995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3978998">if</span>&nbsp;<span class="ident" id="3979001">err</span>&nbsp;<span class="op" id="3979005">!=</span>&nbsp;<span class="ident" id="3979008">nil</span>&nbsp;<span class="op" id="3979012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3979016">return</span>&nbsp;<span class="ident" id="3979023">nil</span><span class="op" id="3979026">,</span>&nbsp;<span class="ident" id="3979028">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3979033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3979037">if</span>&nbsp;<span class="builtinfunc" id="3979040">len</span><span class="op" id="3979043">(</span><span class="ident" id="3979044">ckx</span><span class="op" id="3979047">.</span><span class="ident" id="3979048">ciphertext</span><span class="op" id="3979058">)</span>&nbsp;<span class="op" id="3979060">&lt;</span>&nbsp;<span class="num" id="3979062">2</span>&nbsp;<span class="op" id="3979064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3979068">return</span>&nbsp;<span class="ident" id="3979075">nil</span><span class="op" id="3979078">,</span>&nbsp;<span class="ident" id="3979080">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3979102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3979106">ciphertext</span>&nbsp;<span class="op" id="3979117">:=</span>&nbsp;<span class="ident" id="3979120">ckx</span><span class="op" id="3979123">.</span><span class="ident" id="3979124">ciphertext</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3979136">if</span>&nbsp;<span class="ident" id="3979139">version</span>&nbsp;<span class="op" id="3979147">!=</span>&nbsp;<span class="ident" id="3979150">VersionSSL30</span>&nbsp;<span class="op" id="3979163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3979167">ciphertextLen</span>&nbsp;<span class="op" id="3979181">:=</span>&nbsp;<span class="builtintype" id="3979184">int</span><span class="op" id="3979187">(</span><span class="ident" id="3979188">ckx</span><span class="op" id="3979191">.</span><span class="ident" id="3979192">ciphertext</span><span class="op" id="3979202">[</span><span class="num" id="3979203">0</span><span class="op" id="3979204">]</span><span class="op" id="3979205">)</span><span class="op" id="3979206">&lt;&lt;</span><span class="num" id="3979208">8</span>&nbsp;<span class="op" id="3979210">|</span>&nbsp;<span class="builtintype" id="3979212">int</span><span class="op" id="3979215">(</span><span class="ident" id="3979216">ckx</span><span class="op" id="3979219">.</span><span class="ident" id="3979220">ciphertext</span><span class="op" id="3979230">[</span><span class="num" id="3979231">1</span><span class="op" id="3979232">]</span><span class="op" id="3979233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3979237">if</span>&nbsp;<span class="ident" id="3979240">ciphertextLen</span>&nbsp;<span class="op" id="3979254">!=</span>&nbsp;<span class="builtinfunc" id="3979257">len</span><span class="op" id="3979260">(</span><span class="ident" id="3979261">ckx</span><span class="op" id="3979264">.</span><span class="ident" id="3979265">ciphertext</span><span class="op" id="3979275">)</span><span class="op" id="3979276">-</span><span class="num" id="3979277">2</span>&nbsp;<span class="op" id="3979279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3979284">return</span>&nbsp;<span class="ident" id="3979291">nil</span><span class="op" id="3979294">,</span>&nbsp;<span class="ident" id="3979296">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3979319">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3979323">ciphertext</span>&nbsp;<span class="op" id="3979334">=</span>&nbsp;<span class="ident" id="3979336">ckx</span><span class="op" id="3979339">.</span><span class="ident" id="3979340">ciphertext</span><span class="op" id="3979350">[</span><span class="num" id="3979351">2</span><span class="op" id="3979352">:</span><span class="op" id="3979353">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3979356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3979360">err</span>&nbsp;<span class="op" id="3979364">=</span>&nbsp;<span class="ident" id="3979366">rsa</span><span class="op" id="3979369">.</span><span class="ident" id="3979370">DecryptPKCS1v15SessionKey</span><span class="op" id="3979395">(</span><span class="ident" id="3979396">config</span><span class="op" id="3979402">.</span><span class="ident" id="3979403">rand</span><span class="op" id="3979407">(</span><span class="op" id="3979408">)</span><span class="op" id="3979409">,</span>&nbsp;<span class="ident" id="3979411">cert</span><span class="op" id="3979415">.</span><span class="ident" id="3979416">PrivateKey</span><span class="op" id="3979426">.</span><span class="op" id="3979427">(</span><span class="op" id="3979428">*</span><span class="ident" id="3979429">rsa</span><span class="op" id="3979432">.</span><span class="ident" id="3979433">PrivateKey</span><span class="op" id="3979443">)</span><span class="op" id="3979444">,</span>&nbsp;<span class="ident" id="3979446">ciphertext</span><span class="op" id="3979456">,</span>&nbsp;<span class="ident" id="3979458">preMasterSecret</span><span class="op" id="3979473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3979476">if</span>&nbsp;<span class="ident" id="3979479">err</span>&nbsp;<span class="op" id="3979483">!=</span>&nbsp;<span class="ident" id="3979486">nil</span>&nbsp;<span class="op" id="3979490">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3979494">return</span>&nbsp;<span class="ident" id="3979501">nil</span><span class="op" id="3979504">,</span>&nbsp;<span class="ident" id="3979506">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3979511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3979514">//&nbsp;We&nbsp;don&#39;t&nbsp;check&nbsp;the&nbsp;version&nbsp;number&nbsp;in&nbsp;the&nbsp;premaster&nbsp;secret.&nbsp;&nbsp;For&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3979587">//&nbsp;by&nbsp;checking&nbsp;it,&nbsp;we&nbsp;would&nbsp;leak&nbsp;information&nbsp;about&nbsp;the&nbsp;validity&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3979659">//&nbsp;encrypted&nbsp;pre-master&nbsp;secret.&nbsp;Secondly,&nbsp;it&nbsp;provides&nbsp;only&nbsp;a&nbsp;small</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3979727">//&nbsp;benefit&nbsp;against&nbsp;a&nbsp;downgrade&nbsp;attack&nbsp;and&nbsp;some&nbsp;implementations&nbsp;send&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3979800">//&nbsp;wrong&nbsp;version&nbsp;anyway.&nbsp;See&nbsp;the&nbsp;discussion&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;section</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3979867">//&nbsp;7.4.7.1&nbsp;of&nbsp;RFC&nbsp;4346.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3979892">return</span>&nbsp;<span class="ident" id="3979899">preMasterSecret</span><span class="op" id="3979914">,</span>&nbsp;<span class="ident" id="3979916">nil</span><br>
<span class="lineno"></span><span class="op" id="3979920">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="3979923">func</span>&nbsp;<span class="op" id="3979928">(</span><span class="ident" id="3979929">ka</span>&nbsp;<span class="ident" id="3979932">rsaKeyAgreement</span><span class="op" id="3979947">)</span>&nbsp;<span class="ident" id="3979949">processServerKeyExchange</span><span class="op" id="3979973">(</span><span class="ident" id="3979974">config</span>&nbsp;<span class="op" id="3979981">*</span><span class="ident" id="3979982">Config</span><span class="op" id="3979988">,</span>&nbsp;<span class="ident" id="3979990">clientHello</span>&nbsp;<span class="op" id="3980002">*</span><span class="ident" id="3980003">clientHelloMsg</span><span class="op" id="3980017">,</span>&nbsp;<span class="ident" id="3980019">serverHello</span>&nbsp;<span class="op" id="3980031">*</span><span class="ident" id="3980032">serverHelloMsg</span><span class="op" id="3980046">,</span>&nbsp;<span class="ident" id="3980048">cert</span>&nbsp;<span class="op" id="3980053">*</span><span class="ident" id="3980054">x509</span><span class="op" id="3980058">.</span><span class="ident" id="3980059">Certificate</span><span class="op" id="3980070">,</span>&nbsp;<span class="ident" id="3980072">skx</span>&nbsp;<span class="op" id="3980076">*</span><span class="ident" id="3980077">serverKeyExchangeMsg</span><span class="op" id="3980097">)</span>&nbsp;<span class="builtintype" id="3980099">error</span>&nbsp;<span class="op" id="3980105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3980108">return</span>&nbsp;<span class="ident" id="3980115">errors</span><span class="op" id="3980121">.</span><span class="ident" id="3980122">New</span><span class="op" id="3980125">(</span><span class="string" id="3980126">&#34;tls:&nbsp;unexpected&nbsp;ServerKeyExchange&#34;</span><span class="op" id="3980161">)</span><br>
<span class="lineno"></span><span class="op" id="3980163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="3980166">func</span>&nbsp;<span class="op" id="3980171">(</span><span class="ident" id="3980172">ka</span>&nbsp;<span class="ident" id="3980175">rsaKeyAgreement</span><span class="op" id="3980190">)</span>&nbsp;<span class="ident" id="3980192">generateClientKeyExchange</span><span class="op" id="3980217">(</span><span class="ident" id="3980218">config</span>&nbsp;<span class="op" id="3980225">*</span><span class="ident" id="3980226">Config</span><span class="op" id="3980232">,</span>&nbsp;<span class="ident" id="3980234">clientHello</span>&nbsp;<span class="op" id="3980246">*</span><span class="ident" id="3980247">clientHelloMsg</span><span class="op" id="3980261">,</span>&nbsp;<span class="ident" id="3980263">cert</span>&nbsp;<span class="op" id="3980268">*</span><span class="ident" id="3980269">x509</span><span class="op" id="3980273">.</span><span class="ident" id="3980274">Certificate</span><span class="op" id="3980285">)</span>&nbsp;<span class="op" id="3980287">(</span><span class="op" id="3980288">[</span><span class="op" id="3980289">]</span><span class="builtintype" id="3980290">byte</span><span class="op" id="3980294">,</span>&nbsp;<span class="op" id="3980296">*</span><span class="ident" id="3980297">clientKeyExchangeMsg</span><span class="op" id="3980317">,</span>&nbsp;<span class="builtintype" id="3980319">error</span><span class="op" id="3980324">)</span>&nbsp;<span class="op" id="3980326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980329">preMasterSecret</span>&nbsp;<span class="op" id="3980345">:=</span>&nbsp;<span class="builtinfunc" id="3980348">make</span><span class="op" id="3980352">(</span><span class="op" id="3980353">[</span><span class="op" id="3980354">]</span><span class="builtintype" id="3980355">byte</span><span class="op" id="3980359">,</span>&nbsp;<span class="num" id="3980361">48</span><span class="op" id="3980363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980366">preMasterSecret</span><span class="op" id="3980381">[</span><span class="num" id="3980382">0</span><span class="op" id="3980383">]</span>&nbsp;<span class="op" id="3980385">=</span>&nbsp;<span class="builtintype" id="3980387">byte</span><span class="op" id="3980391">(</span><span class="ident" id="3980392">clientHello</span><span class="op" id="3980403">.</span><span class="ident" id="3980404">vers</span>&nbsp;<span class="op" id="3980409">&gt;&gt;</span>&nbsp;<span class="num" id="3980412">8</span><span class="op" id="3980413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980416">preMasterSecret</span><span class="op" id="3980431">[</span><span class="num" id="3980432">1</span><span class="op" id="3980433">]</span>&nbsp;<span class="op" id="3980435">=</span>&nbsp;<span class="builtintype" id="3980437">byte</span><span class="op" id="3980441">(</span><span class="ident" id="3980442">clientHello</span><span class="op" id="3980453">.</span><span class="ident" id="3980454">vers</span><span class="op" id="3980458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980461">_</span><span class="op" id="3980462">,</span>&nbsp;<span class="ident" id="3980464">err</span>&nbsp;<span class="op" id="3980468">:=</span>&nbsp;<span class="ident" id="3980471">io</span><span class="op" id="3980473">.</span><span class="ident" id="3980474">ReadFull</span><span class="op" id="3980482">(</span><span class="ident" id="3980483">config</span><span class="op" id="3980489">.</span><span class="ident" id="3980490">rand</span><span class="op" id="3980494">(</span><span class="op" id="3980495">)</span><span class="op" id="3980496">,</span>&nbsp;<span class="ident" id="3980498">preMasterSecret</span><span class="op" id="3980513">[</span><span class="num" id="3980514">2</span><span class="op" id="3980515">:</span><span class="op" id="3980516">]</span><span class="op" id="3980517">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3980520">if</span>&nbsp;<span class="ident" id="3980523">err</span>&nbsp;<span class="op" id="3980527">!=</span>&nbsp;<span class="ident" id="3980530">nil</span>&nbsp;<span class="op" id="3980534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3980538">return</span>&nbsp;<span class="ident" id="3980545">nil</span><span class="op" id="3980548">,</span>&nbsp;<span class="ident" id="3980550">nil</span><span class="op" id="3980553">,</span>&nbsp;<span class="ident" id="3980555">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3980560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980564">encrypted</span><span class="op" id="3980573">,</span>&nbsp;<span class="ident" id="3980575">err</span>&nbsp;<span class="op" id="3980579">:=</span>&nbsp;<span class="ident" id="3980582">rsa</span><span class="op" id="3980585">.</span><span class="ident" id="3980586">EncryptPKCS1v15</span><span class="op" id="3980601">(</span><span class="ident" id="3980602">config</span><span class="op" id="3980608">.</span><span class="ident" id="3980609">rand</span><span class="op" id="3980613">(</span><span class="op" id="3980614">)</span><span class="op" id="3980615">,</span>&nbsp;<span class="ident" id="3980617">cert</span><span class="op" id="3980621">.</span><span class="ident" id="3980622">PublicKey</span><span class="op" id="3980631">.</span><span class="op" id="3980632">(</span><span class="op" id="3980633">*</span><span class="ident" id="3980634">rsa</span><span class="op" id="3980637">.</span><span class="ident" id="3980638">PublicKey</span><span class="op" id="3980647">)</span><span class="op" id="3980648">,</span>&nbsp;<span class="ident" id="3980650">preMasterSecret</span><span class="op" id="3980665">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3980668">if</span>&nbsp;<span class="ident" id="3980671">err</span>&nbsp;<span class="op" id="3980675">!=</span>&nbsp;<span class="ident" id="3980678">nil</span>&nbsp;<span class="op" id="3980682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3980686">return</span>&nbsp;<span class="ident" id="3980693">nil</span><span class="op" id="3980696">,</span>&nbsp;<span class="ident" id="3980698">nil</span><span class="op" id="3980701">,</span>&nbsp;<span class="ident" id="3980703">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3980708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980711">ckx</span>&nbsp;<span class="op" id="3980715">:=</span>&nbsp;<span class="builtinfunc" id="3980718">new</span><span class="op" id="3980721">(</span><span class="ident" id="3980722">clientKeyExchangeMsg</span><span class="op" id="3980742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980745">ckx</span><span class="op" id="3980748">.</span><span class="ident" id="3980749">ciphertext</span>&nbsp;<span class="op" id="3980760">=</span>&nbsp;<span class="builtinfunc" id="3980762">make</span><span class="op" id="3980766">(</span><span class="op" id="3980767">[</span><span class="op" id="3980768">]</span><span class="builtintype" id="3980769">byte</span><span class="op" id="3980773">,</span>&nbsp;<span class="builtinfunc" id="3980775">len</span><span class="op" id="3980778">(</span><span class="ident" id="3980779">encrypted</span><span class="op" id="3980788">)</span><span class="op" id="3980789">+</span><span class="num" id="3980790">2</span><span class="op" id="3980791">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980794">ckx</span><span class="op" id="3980797">.</span><span class="ident" id="3980798">ciphertext</span><span class="op" id="3980808">[</span><span class="num" id="3980809">0</span><span class="op" id="3980810">]</span>&nbsp;<span class="op" id="3980812">=</span>&nbsp;<span class="builtintype" id="3980814">byte</span><span class="op" id="3980818">(</span><span class="builtinfunc" id="3980819">len</span><span class="op" id="3980822">(</span><span class="ident" id="3980823">encrypted</span><span class="op" id="3980832">)</span>&nbsp;<span class="op" id="3980834">&gt;&gt;</span>&nbsp;<span class="num" id="3980837">8</span><span class="op" id="3980838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3980841">ckx</span><span class="op" id="3980844">.</span><span class="ident" id="3980845">ciphertext</span><span class="op" id="3980855">[</span><span class="num" id="3980856">1</span><span class="op" id="3980857">]</span>&nbsp;<span class="op" id="3980859">=</span>&nbsp;<span class="builtintype" id="3980861">byte</span><span class="op" id="3980865">(</span><span class="builtinfunc" id="3980866">len</span><span class="op" id="3980869">(</span><span class="ident" id="3980870">encrypted</span><span class="op" id="3980879">)</span><span class="op" id="3980880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3980883">copy</span><span class="op" id="3980887">(</span><span class="ident" id="3980888">ckx</span><span class="op" id="3980891">.</span><span class="ident" id="3980892">ciphertext</span><span class="op" id="3980902">[</span><span class="num" id="3980903">2</span><span class="op" id="3980904">:</span><span class="op" id="3980905">]</span><span class="op" id="3980906">,</span>&nbsp;<span class="ident" id="3980908">encrypted</span><span class="op" id="3980917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3980920">return</span>&nbsp;<span class="ident" id="3980927">preMasterSecret</span><span class="op" id="3980942">,</span>&nbsp;<span class="ident" id="3980944">ckx</span><span class="op" id="3980947">,</span>&nbsp;<span class="ident" id="3980949">nil</span><br>
<span class="lineno"></span><span class="op" id="3980953">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="3980956">//&nbsp;sha1Hash&nbsp;calculates&nbsp;a&nbsp;SHA1&nbsp;hash&nbsp;over&nbsp;the&nbsp;given&nbsp;byte&nbsp;slices.</span><br>
<span class="lineno"></span><span class="keyword" id="3981019">func</span>&nbsp;<span class="ident" id="3981024">sha1Hash</span><span class="op" id="3981032">(</span><span class="ident" id="3981033">slices</span>&nbsp;<span class="op" id="3981040">[</span><span class="op" id="3981041">]</span><span class="op" id="3981042">[</span><span class="op" id="3981043">]</span><span class="builtintype" id="3981044">byte</span><span class="op" id="3981048">)</span>&nbsp;<span class="op" id="3981050">[</span><span class="op" id="3981051">]</span><span class="builtintype" id="3981052">byte</span>&nbsp;<span class="op" id="3981057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3981060">hsha1</span>&nbsp;<span class="op" id="3981066">:=</span>&nbsp;<span class="ident" id="3981069">sha1</span><span class="op" id="3981073">.</span><span class="ident" id="3981074">New</span><span class="op" id="3981077">(</span><span class="op" id="3981078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3981081">for</span>&nbsp;<span class="ident" id="3981085">_</span><span class="op" id="3981086">,</span>&nbsp;<span class="ident" id="3981088">slice</span>&nbsp;<span class="op" id="3981094">:=</span>&nbsp;<span class="keyword" id="3981097">range</span>&nbsp;<span class="ident" id="3981103">slices</span>&nbsp;<span class="op" id="3981110">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3981114">hsha1</span><span class="op" id="3981119">.</span><span class="ident" id="3981120">Write</span><span class="op" id="3981125">(</span><span class="ident" id="3981126">slice</span><span class="op" id="3981131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3981134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3981137">return</span>&nbsp;<span class="ident" id="3981144">hsha1</span><span class="op" id="3981149">.</span><span class="ident" id="3981150">Sum</span><span class="op" id="3981153">(</span><span class="ident" id="3981154">nil</span><span class="op" id="3981157">)</span><br>
<span class="lineno"></span><span class="op" id="3981159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="3981162">//&nbsp;md5SHA1Hash&nbsp;implements&nbsp;TLS&nbsp;1.0&#39;s&nbsp;hybrid&nbsp;hash&nbsp;function&nbsp;which&nbsp;consists&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3981241">//&nbsp;concatenation&nbsp;of&nbsp;an&nbsp;MD5&nbsp;and&nbsp;SHA1&nbsp;hash.</span><br>
<span class="lineno"></span><span class="keyword" id="3981283">func</span>&nbsp;<span class="ident" id="3981288">md5SHA1Hash</span><span class="op" id="3981299">(</span><span class="ident" id="3981300">slices</span>&nbsp;<span class="op" id="3981307">[</span><span class="op" id="3981308">]</span><span class="op" id="3981309">[</span><span class="op" id="3981310">]</span><span class="builtintype" id="3981311">byte</span><span class="op" id="3981315">)</span>&nbsp;<span class="op" id="3981317">[</span><span class="op" id="3981318">]</span><span class="builtintype" id="3981319">byte</span>&nbsp;<span class="op" id="3981324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3981327">md5sha1</span>&nbsp;<span class="op" id="3981335">:=</span>&nbsp;<span class="builtinfunc" id="3981338">make</span><span class="op" id="3981342">(</span><span class="op" id="3981343">[</span><span class="op" id="3981344">]</span><span class="builtintype" id="3981345">byte</span><span class="op" id="3981349">,</span>&nbsp;<span class="ident" id="3981351">md5</span><span class="op" id="3981354">.</span><span class="ident" id="3981355">Size</span><span class="op" id="3981359">+</span><span class="ident" id="3981360">sha1</span><span class="op" id="3981364">.</span><span class="ident" id="3981365">Size</span><span class="op" id="3981369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3981372">hmd5</span>&nbsp;<span class="op" id="3981377">:=</span>&nbsp;<span class="ident" id="3981380">md5</span><span class="op" id="3981383">.</span><span class="ident" id="3981384">New</span><span class="op" id="3981387">(</span><span class="op" id="3981388">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3981391">for</span>&nbsp;<span class="ident" id="3981395">_</span><span class="op" id="3981396">,</span>&nbsp;<span class="ident" id="3981398">slice</span>&nbsp;<span class="op" id="3981404">:=</span>&nbsp;<span class="keyword" id="3981407">range</span>&nbsp;<span class="ident" id="3981413">slices</span>&nbsp;<span class="op" id="3981420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3981424">hmd5</span><span class="op" id="3981428">.</span><span class="ident" id="3981429">Write</span><span class="op" id="3981434">(</span><span class="ident" id="3981435">slice</span><span class="op" id="3981440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3981443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3981446">copy</span><span class="op" id="3981450">(</span><span class="ident" id="3981451">md5sha1</span><span class="op" id="3981458">,</span>&nbsp;<span class="ident" id="3981460">hmd5</span><span class="op" id="3981464">.</span><span class="ident" id="3981465">Sum</span><span class="op" id="3981468">(</span><span class="ident" id="3981469">nil</span><span class="op" id="3981472">)</span><span class="op" id="3981473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3981476">copy</span><span class="op" id="3981480">(</span><span class="ident" id="3981481">md5sha1</span><span class="op" id="3981488">[</span><span class="ident" id="3981489">md5</span><span class="op" id="3981492">.</span><span class="ident" id="3981493">Size</span><span class="op" id="3981497">:</span><span class="op" id="3981498">]</span><span class="op" id="3981499">,</span>&nbsp;<span class="ident" id="3981501">sha1Hash</span><span class="op" id="3981509">(</span><span class="ident" id="3981510">slices</span><span class="op" id="3981516">)</span><span class="op" id="3981517">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3981520">return</span>&nbsp;<span class="ident" id="3981527">md5sha1</span><br>
<span class="lineno"></span><span class="op" id="3981535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3981538">//&nbsp;sha256Hash&nbsp;implements&nbsp;TLS&nbsp;1.2&#39;s&nbsp;hash&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="3981588">func</span>&nbsp;<span class="ident" id="3981593">sha256Hash</span><span class="op" id="3981603">(</span><span class="ident" id="3981604">slices</span>&nbsp;<span class="op" id="3981611">[</span><span class="op" id="3981612">]</span><span class="op" id="3981613">[</span><span class="op" id="3981614">]</span><span class="builtintype" id="3981615">byte</span><span class="op" id="3981619">)</span>&nbsp;<span class="op" id="3981621">[</span><span class="op" id="3981622">]</span><span class="builtintype" id="3981623">byte</span>&nbsp;<span class="op" id="3981628">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3981631">h</span>&nbsp;<span class="op" id="3981633">:=</span>&nbsp;<span class="ident" id="3981636">sha256</span><span class="op" id="3981642">.</span><span class="ident" id="3981643">New</span><span class="op" id="3981646">(</span><span class="op" id="3981647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3981650">for</span>&nbsp;<span class="ident" id="3981654">_</span><span class="op" id="3981655">,</span>&nbsp;<span class="ident" id="3981657">slice</span>&nbsp;<span class="op" id="3981663">:=</span>&nbsp;<span class="keyword" id="3981666">range</span>&nbsp;<span class="ident" id="3981672">slices</span>&nbsp;<span class="op" id="3981679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3981683">h</span><span class="op" id="3981684">.</span><span class="ident" id="3981685">Write</span><span class="op" id="3981690">(</span><span class="ident" id="3981691">slice</span><span class="op" id="3981696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3981699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3981702">return</span>&nbsp;<span class="ident" id="3981709">h</span><span class="op" id="3981710">.</span><span class="ident" id="3981711">Sum</span><span class="op" id="3981714">(</span><span class="ident" id="3981715">nil</span><span class="op" id="3981718">)</span><br>
<span class="lineno">120</span><span class="op" id="3981720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3981723">//&nbsp;hashForServerKeyExchange&nbsp;hashes&nbsp;the&nbsp;given&nbsp;slices&nbsp;and&nbsp;returns&nbsp;their&nbsp;digest</span><br>
<span class="lineno"></span><span class="comment" id="3981800">//&nbsp;and&nbsp;the&nbsp;identifier&nbsp;of&nbsp;the&nbsp;hash&nbsp;function&nbsp;used.&nbsp;The&nbsp;hashFunc&nbsp;argument&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="3981879">//&nbsp;used&nbsp;for&nbsp;&gt;=&nbsp;TLS&nbsp;1.2&nbsp;and&nbsp;precisely&nbsp;identifies&nbsp;the&nbsp;hash&nbsp;function&nbsp;to&nbsp;use.</span><br>
<span class="lineno">125</span><span class="keyword" id="3981953">func</span>&nbsp;<span class="ident" id="3981958">hashForServerKeyExchange</span><span class="op" id="3981982">(</span><span class="ident" id="3981983">sigType</span><span class="op" id="3981990">,</span>&nbsp;<span class="ident" id="3981992">hashFunc</span>&nbsp;<span class="builtintype" id="3982001">uint8</span><span class="op" id="3982006">,</span>&nbsp;<span class="ident" id="3982008">version</span>&nbsp;<span class="builtintype" id="3982016">uint16</span><span class="op" id="3982022">,</span>&nbsp;<span class="ident" id="3982024">slices</span>&nbsp;<span class="op" id="3982031">...</span><span class="op" id="3982034">[</span><span class="op" id="3982035">]</span><span class="builtintype" id="3982036">byte</span><span class="op" id="3982040">)</span>&nbsp;<span class="op" id="3982042">(</span><span class="op" id="3982043">[</span><span class="op" id="3982044">]</span><span class="builtintype" id="3982045">byte</span><span class="op" id="3982049">,</span>&nbsp;<span class="ident" id="3982051">crypto</span><span class="op" id="3982057">.</span><span class="ident" id="3982058">Hash</span><span class="op" id="3982062">,</span>&nbsp;<span class="builtintype" id="3982064">error</span><span class="op" id="3982069">)</span>&nbsp;<span class="op" id="3982071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982074">if</span>&nbsp;<span class="ident" id="3982077">version</span>&nbsp;<span class="op" id="3982085">&gt;=</span>&nbsp;<span class="ident" id="3982088">VersionTLS12</span>&nbsp;<span class="op" id="3982101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982105">switch</span>&nbsp;<span class="ident" id="3982112">hashFunc</span>&nbsp;<span class="op" id="3982121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982125">case</span>&nbsp;<span class="ident" id="3982130">hashSHA256</span><span class="op" id="3982140">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982145">return</span>&nbsp;<span class="ident" id="3982152">sha256Hash</span><span class="op" id="3982162">(</span><span class="ident" id="3982163">slices</span><span class="op" id="3982169">)</span><span class="op" id="3982170">,</span>&nbsp;<span class="ident" id="3982172">crypto</span><span class="op" id="3982178">.</span><span class="ident" id="3982179">SHA256</span><span class="op" id="3982185">,</span>&nbsp;<span class="ident" id="3982187">nil</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982193">case</span>&nbsp;<span class="ident" id="3982198">hashSHA1</span><span class="op" id="3982206">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982211">return</span>&nbsp;<span class="ident" id="3982218">sha1Hash</span><span class="op" id="3982226">(</span><span class="ident" id="3982227">slices</span><span class="op" id="3982233">)</span><span class="op" id="3982234">,</span>&nbsp;<span class="ident" id="3982236">crypto</span><span class="op" id="3982242">.</span><span class="ident" id="3982243">SHA1</span><span class="op" id="3982247">,</span>&nbsp;<span class="ident" id="3982249">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982255">default</span><span class="op" id="3982262">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982267">return</span>&nbsp;<span class="ident" id="3982274">nil</span><span class="op" id="3982277">,</span>&nbsp;<span class="ident" id="3982279">crypto</span><span class="op" id="3982285">.</span><span class="ident" id="3982286">Hash</span><span class="op" id="3982290">(</span><span class="num" id="3982291">0</span><span class="op" id="3982292">)</span><span class="op" id="3982293">,</span>&nbsp;<span class="ident" id="3982295">errors</span><span class="op" id="3982301">.</span><span class="ident" id="3982302">New</span><span class="op" id="3982305">(</span><span class="string" id="3982306">&#34;tls:&nbsp;unknown&nbsp;hash&nbsp;function&nbsp;used&nbsp;by&nbsp;peer&#34;</span><span class="op" id="3982347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3982351">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3982354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982357">if</span>&nbsp;<span class="ident" id="3982360">sigType</span>&nbsp;<span class="op" id="3982368">==</span>&nbsp;<span class="ident" id="3982371">signatureECDSA</span>&nbsp;<span class="op" id="3982386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982390">return</span>&nbsp;<span class="ident" id="3982397">sha1Hash</span><span class="op" id="3982405">(</span><span class="ident" id="3982406">slices</span><span class="op" id="3982412">)</span><span class="op" id="3982413">,</span>&nbsp;<span class="ident" id="3982415">crypto</span><span class="op" id="3982421">.</span><span class="ident" id="3982422">SHA1</span><span class="op" id="3982426">,</span>&nbsp;<span class="ident" id="3982428">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3982433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982436">return</span>&nbsp;<span class="ident" id="3982443">md5SHA1Hash</span><span class="op" id="3982454">(</span><span class="ident" id="3982455">slices</span><span class="op" id="3982461">)</span><span class="op" id="3982462">,</span>&nbsp;<span class="ident" id="3982464">crypto</span><span class="op" id="3982470">.</span><span class="ident" id="3982471">MD5SHA1</span><span class="op" id="3982478">,</span>&nbsp;<span class="ident" id="3982480">nil</span><br>
<span class="lineno">140</span><span class="op" id="3982484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3982487">//&nbsp;pickTLS12HashForSignature&nbsp;returns&nbsp;a&nbsp;TLS&nbsp;1.2&nbsp;hash&nbsp;identifier&nbsp;for&nbsp;signing&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3982564">//&nbsp;ServerKeyExchange&nbsp;given&nbsp;the&nbsp;signature&nbsp;type&nbsp;being&nbsp;used&nbsp;and&nbsp;the&nbsp;client&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3982638">//&nbsp;advertised&nbsp;list&nbsp;of&nbsp;supported&nbsp;signature&nbsp;and&nbsp;hash&nbsp;combinations.</span><br>
<span class="lineno">145</span><span class="keyword" id="3982703">func</span>&nbsp;<span class="ident" id="3982708">pickTLS12HashForSignature</span><span class="op" id="3982733">(</span><span class="ident" id="3982734">sigType</span>&nbsp;<span class="builtintype" id="3982742">uint8</span><span class="op" id="3982747">,</span>&nbsp;<span class="ident" id="3982749">clientSignatureAndHashes</span>&nbsp;<span class="op" id="3982774">[</span><span class="op" id="3982775">]</span><span class="ident" id="3982776">signatureAndHash</span><span class="op" id="3982792">)</span>&nbsp;<span class="op" id="3982794">(</span><span class="builtintype" id="3982795">uint8</span><span class="op" id="3982800">,</span>&nbsp;<span class="builtintype" id="3982802">error</span><span class="op" id="3982807">)</span>&nbsp;<span class="op" id="3982809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982812">if</span>&nbsp;<span class="builtinfunc" id="3982815">len</span><span class="op" id="3982818">(</span><span class="ident" id="3982819">clientSignatureAndHashes</span><span class="op" id="3982843">)</span>&nbsp;<span class="op" id="3982845">==</span>&nbsp;<span class="num" id="3982848">0</span>&nbsp;<span class="op" id="3982850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3982854">//&nbsp;If&nbsp;the&nbsp;client&nbsp;didn&#39;t&nbsp;specify&nbsp;any&nbsp;signature_algorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3982913">//&nbsp;extension&nbsp;then&nbsp;we&nbsp;can&nbsp;assume&nbsp;that&nbsp;it&nbsp;supports&nbsp;SHA1.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3982974">//&nbsp;http://tools.ietf.org/html/rfc5246#section-7.4.1.4.1</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983032">return</span>&nbsp;<span class="ident" id="3983039">hashSHA1</span><span class="op" id="3983047">,</span>&nbsp;<span class="ident" id="3983049">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3983054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983058">for</span>&nbsp;<span class="ident" id="3983062">_</span><span class="op" id="3983063">,</span>&nbsp;<span class="ident" id="3983065">sigAndHash</span>&nbsp;<span class="op" id="3983076">:=</span>&nbsp;<span class="keyword" id="3983079">range</span>&nbsp;<span class="ident" id="3983085">clientSignatureAndHashes</span>&nbsp;<span class="op" id="3983110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983114">if</span>&nbsp;<span class="ident" id="3983117">sigAndHash</span><span class="op" id="3983127">.</span><span class="ident" id="3983128">signature</span>&nbsp;<span class="op" id="3983138">!=</span>&nbsp;<span class="ident" id="3983141">sigType</span>&nbsp;<span class="op" id="3983149">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983154">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3983165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983169">switch</span>&nbsp;<span class="ident" id="3983176">sigAndHash</span><span class="op" id="3983186">.</span><span class="ident" id="3983187">hash</span>&nbsp;<span class="op" id="3983192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983196">case</span>&nbsp;<span class="ident" id="3983201">hashSHA1</span><span class="op" id="3983209">,</span>&nbsp;<span class="ident" id="3983211">hashSHA256</span><span class="op" id="3983221">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983226">return</span>&nbsp;<span class="ident" id="3983233">sigAndHash</span><span class="op" id="3983243">.</span><span class="ident" id="3983244">hash</span><span class="op" id="3983248">,</span>&nbsp;<span class="ident" id="3983250">nil</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3983256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3983259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983263">return</span>&nbsp;<span class="num" id="3983270">0</span><span class="op" id="3983271">,</span>&nbsp;<span class="ident" id="3983273">errors</span><span class="op" id="3983279">.</span><span class="ident" id="3983280">New</span><span class="op" id="3983283">(</span><span class="string" id="3983284">&#34;tls:&nbsp;client&nbsp;doesn&#39;t&nbsp;support&nbsp;any&nbsp;common&nbsp;hash&nbsp;functions&#34;</span><span class="op" id="3983339">)</span><br>
<span class="lineno"></span><span class="op" id="3983341">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="3983344">func</span>&nbsp;<span class="ident" id="3983349">curveForCurveID</span><span class="op" id="3983364">(</span><span class="ident" id="3983365">id</span>&nbsp;<span class="ident" id="3983368">CurveID</span><span class="op" id="3983375">)</span>&nbsp;<span class="op" id="3983377">(</span><span class="ident" id="3983378">elliptic</span><span class="op" id="3983386">.</span><span class="ident" id="3983387">Curve</span><span class="op" id="3983392">,</span>&nbsp;<span class="builtintype" id="3983394">bool</span><span class="op" id="3983398">)</span>&nbsp;<span class="op" id="3983400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983403">switch</span>&nbsp;<span class="ident" id="3983410">id</span>&nbsp;<span class="op" id="3983413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983416">case</span>&nbsp;<span class="ident" id="3983421">CurveP256</span><span class="op" id="3983430">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983434">return</span>&nbsp;<span class="ident" id="3983441">elliptic</span><span class="op" id="3983449">.</span><span class="ident" id="3983450">P256</span><span class="op" id="3983454">(</span><span class="op" id="3983455">)</span><span class="op" id="3983456">,</span>&nbsp;<span class="builtintype" id="3983458">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983464">case</span>&nbsp;<span class="ident" id="3983469">CurveP384</span><span class="op" id="3983478">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983482">return</span>&nbsp;<span class="ident" id="3983489">elliptic</span><span class="op" id="3983497">.</span><span class="ident" id="3983498">P384</span><span class="op" id="3983502">(</span><span class="op" id="3983503">)</span><span class="op" id="3983504">,</span>&nbsp;<span class="builtintype" id="3983506">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983512">case</span>&nbsp;<span class="ident" id="3983517">CurveP521</span><span class="op" id="3983526">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983530">return</span>&nbsp;<span class="ident" id="3983537">elliptic</span><span class="op" id="3983545">.</span><span class="ident" id="3983546">P521</span><span class="op" id="3983550">(</span><span class="op" id="3983551">)</span><span class="op" id="3983552">,</span>&nbsp;<span class="builtintype" id="3983554">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983560">default</span><span class="op" id="3983567">:</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983571">return</span>&nbsp;<span class="ident" id="3983578">nil</span><span class="op" id="3983581">,</span>&nbsp;<span class="builtintype" id="3983583">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3983590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="3983593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="comment" id="3983596">//&nbsp;ecdheRSAKeyAgreement&nbsp;implements&nbsp;a&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="3983668">//&nbsp;generates&nbsp;a&nbsp;ephemeral&nbsp;EC&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;and&nbsp;signs&nbsp;it.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="3983738">//&nbsp;pre-master&nbsp;secret&nbsp;is&nbsp;then&nbsp;calculated&nbsp;using&nbsp;ECDH.&nbsp;The&nbsp;signature&nbsp;may</span><br>
<span class="lineno"></span><span class="comment" id="3983808">//&nbsp;either&nbsp;be&nbsp;ECDSA&nbsp;or&nbsp;RSA.</span><br>
<span class="lineno"></span><span class="keyword" id="3983835">type</span>&nbsp;<span class="ident" id="3983840">ecdheKeyAgreement</span>&nbsp;<span class="keyword" id="3983858">struct</span>&nbsp;<span class="op" id="3983865">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3983868">version</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3983879">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3983887">sigType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3983898">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3983905">privateKey</span>&nbsp;<span class="op" id="3983916">[</span><span class="op" id="3983917">]</span><span class="builtintype" id="3983918">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3983924">curve</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3983935">elliptic</span><span class="op" id="3983943">.</span><span class="ident" id="3983944">Curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3983951">x</span><span class="op" id="3983952">,</span>&nbsp;<span class="ident" id="3983954">y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3983962">*</span><span class="ident" id="3983963">big</span><span class="op" id="3983966">.</span><span class="ident" id="3983967">Int</span><br>
<span class="lineno">190</span><span class="op" id="3983971">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3983974">func</span>&nbsp;<span class="op" id="3983979">(</span><span class="ident" id="3983980">ka</span>&nbsp;<span class="op" id="3983983">*</span><span class="ident" id="3983984">ecdheKeyAgreement</span><span class="op" id="3984001">)</span>&nbsp;<span class="ident" id="3984003">generateServerKeyExchange</span><span class="op" id="3984028">(</span><span class="ident" id="3984029">config</span>&nbsp;<span class="op" id="3984036">*</span><span class="ident" id="3984037">Config</span><span class="op" id="3984043">,</span>&nbsp;<span class="ident" id="3984045">cert</span>&nbsp;<span class="op" id="3984050">*</span><span class="ident" id="3984051">Certificate</span><span class="op" id="3984062">,</span>&nbsp;<span class="ident" id="3984064">clientHello</span>&nbsp;<span class="op" id="3984076">*</span><span class="ident" id="3984077">clientHelloMsg</span><span class="op" id="3984091">,</span>&nbsp;<span class="ident" id="3984093">hello</span>&nbsp;<span class="op" id="3984099">*</span><span class="ident" id="3984100">serverHelloMsg</span><span class="op" id="3984114">)</span>&nbsp;<span class="op" id="3984116">(</span><span class="op" id="3984117">*</span><span class="ident" id="3984118">serverKeyExchangeMsg</span><span class="op" id="3984138">,</span>&nbsp;<span class="builtintype" id="3984140">error</span><span class="op" id="3984145">)</span>&nbsp;<span class="op" id="3984147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3984150">var</span>&nbsp;<span class="ident" id="3984154">curveid</span>&nbsp;<span class="ident" id="3984162">CurveID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3984171">preferredCurves</span>&nbsp;<span class="op" id="3984187">:=</span>&nbsp;<span class="ident" id="3984190">config</span><span class="op" id="3984196">.</span><span class="ident" id="3984197">curvePreferences</span><span class="op" id="3984213">(</span><span class="op" id="3984214">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="ident" id="3984217">NextCandidate</span><span class="op" id="3984230">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3984233">for</span>&nbsp;<span class="ident" id="3984237">_</span><span class="op" id="3984238">,</span>&nbsp;<span class="ident" id="3984240">candidate</span>&nbsp;<span class="op" id="3984250">:=</span>&nbsp;<span class="keyword" id="3984253">range</span>&nbsp;<span class="ident" id="3984259">preferredCurves</span>&nbsp;<span class="op" id="3984275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3984279">for</span>&nbsp;<span class="ident" id="3984283">_</span><span class="op" id="3984284">,</span>&nbsp;<span class="ident" id="3984286">c</span>&nbsp;<span class="op" id="3984288">:=</span>&nbsp;<span class="keyword" id="3984291">range</span>&nbsp;<span class="ident" id="3984297">clientHello</span><span class="op" id="3984308">.</span><span class="ident" id="3984309">supportedCurves</span>&nbsp;<span class="op" id="3984325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3984330">if</span>&nbsp;<span class="ident" id="3984333">candidate</span>&nbsp;<span class="op" id="3984343">==</span>&nbsp;<span class="ident" id="3984346">c</span>&nbsp;<span class="op" id="3984348">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3984354">curveid</span>&nbsp;<span class="op" id="3984362">=</span>&nbsp;<span class="ident" id="3984364">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3984370">break</span>&nbsp;<span class="ident" id="3984376">NextCandidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3984393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3984397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3984400">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3984404">if</span>&nbsp;<span class="ident" id="3984407">curveid</span>&nbsp;<span class="op" id="3984415">==</span>&nbsp;<span class="num" id="3984418">0</span>&nbsp;<span class="op" id="3984420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3984424">return</span>&nbsp;<span class="ident" id="3984431">nil</span><span class="op" id="3984434">,</span>&nbsp;<span class="ident" id="3984436">errors</span><span class="op" id="3984442">.</span><span class="ident" id="3984443">New</span><span class="op" id="3984446">(</span><span class="string" id="3984447">&#34;tls:&nbsp;no&nbsp;supported&nbsp;elliptic&nbsp;curves&nbsp;offered&#34;</span><span class="op" id="3984490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3984493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3984497">var</span>&nbsp;<span class="ident" id="3984501">ok</span>&nbsp;<span class="builtintype" id="3984504">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3984510">if</span>&nbsp;<span class="ident" id="3984513">ka</span><span class="op" id="3984515">.</span><span class="ident" id="3984516">curve</span><span class="op" id="3984521">,</span>&nbsp;<span class="ident" id="3984523">ok</span>&nbsp;<span class="op" id="3984526">=</span>&nbsp;<span class="ident" id="3984528">curveForCurveID</span><span class="op" id="3984543">(</span><span class="ident" id="3984544">curveid</span><span class="op" id="3984551">)</span><span class="op" id="3984552">;</span>&nbsp;<span class="op" id="3984554">!</span><span class="ident" id="3984555">ok</span>&nbsp;<span class="op" id="3984558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3984562">return</span>&nbsp;<span class="ident" id="3984569">nil</span><span class="op" id="3984572">,</span>&nbsp;<span class="ident" id="3984574">errors</span><span class="op" id="3984580">.</span><span class="ident" id="3984581">New</span><span class="op" id="3984584">(</span><span class="string" id="3984585">&#34;tls:&nbsp;preferredCurves&nbsp;includes&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3984634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3984637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3984641">var</span>&nbsp;<span class="ident" id="3984645">x</span><span class="op" id="3984646">,</span>&nbsp;<span class="ident" id="3984648">y</span>&nbsp;<span class="op" id="3984650">*</span><span class="ident" id="3984651">big</span><span class="op" id="3984654">.</span><span class="ident" id="3984655">Int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3984660">var</span>&nbsp;<span class="ident" id="3984664">err</span>&nbsp;<span class="builtintype" id="3984668">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3984675">ka</span><span class="op" id="3984677">.</span><span class="ident" id="3984678">privateKey</span><span class="op" id="3984688">,</span>&nbsp;<span class="ident" id="3984690">x</span><span class="op" id="3984691">,</span>&nbsp;<span class="ident" id="3984693">y</span><span class="op" id="3984694">,</span>&nbsp;<span class="ident" id="3984696">err</span>&nbsp;<span class="op" id="3984700">=</span>&nbsp;<span class="ident" id="3984702">elliptic</span><span class="op" id="3984710">.</span><span class="ident" id="3984711">GenerateKey</span><span class="op" id="3984722">(</span><span class="ident" id="3984723">ka</span><span class="op" id="3984725">.</span><span class="ident" id="3984726">curve</span><span class="op" id="3984731">,</span>&nbsp;<span class="ident" id="3984733">config</span><span class="op" id="3984739">.</span><span class="ident" id="3984740">rand</span><span class="op" id="3984744">(</span><span class="op" id="3984745">)</span><span class="op" id="3984746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3984749">if</span>&nbsp;<span class="ident" id="3984752">err</span>&nbsp;<span class="op" id="3984756">!=</span>&nbsp;<span class="ident" id="3984759">nil</span>&nbsp;<span class="op" id="3984763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3984767">return</span>&nbsp;<span class="ident" id="3984774">nil</span><span class="op" id="3984777">,</span>&nbsp;<span class="ident" id="3984779">err</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3984784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3984787">ecdhePublic</span>&nbsp;<span class="op" id="3984799">:=</span>&nbsp;<span class="ident" id="3984802">elliptic</span><span class="op" id="3984810">.</span><span class="ident" id="3984811">Marshal</span><span class="op" id="3984818">(</span><span class="ident" id="3984819">ka</span><span class="op" id="3984821">.</span><span class="ident" id="3984822">curve</span><span class="op" id="3984827">,</span>&nbsp;<span class="ident" id="3984829">x</span><span class="op" id="3984830">,</span>&nbsp;<span class="ident" id="3984832">y</span><span class="op" id="3984833">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3984837">//&nbsp;http://tools.ietf.org/html/rfc4492#section-5.4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3984888">serverECDHParams</span>&nbsp;<span class="op" id="3984905">:=</span>&nbsp;<span class="builtinfunc" id="3984908">make</span><span class="op" id="3984912">(</span><span class="op" id="3984913">[</span><span class="op" id="3984914">]</span><span class="builtintype" id="3984915">byte</span><span class="op" id="3984919">,</span>&nbsp;<span class="num" id="3984921">1</span><span class="op" id="3984922">+</span><span class="num" id="3984923">2</span><span class="op" id="3984924">+</span><span class="num" id="3984925">1</span><span class="op" id="3984926">+</span><span class="builtinfunc" id="3984927">len</span><span class="op" id="3984930">(</span><span class="ident" id="3984931">ecdhePublic</span><span class="op" id="3984942">)</span><span class="op" id="3984943">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3984946">serverECDHParams</span><span class="op" id="3984962">[</span><span class="num" id="3984963">0</span><span class="op" id="3984964">]</span>&nbsp;<span class="op" id="3984966">=</span>&nbsp;<span class="num" id="3984968">3</span>&nbsp;<span class="comment" id="3984970">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3984986">serverECDHParams</span><span class="op" id="3985002">[</span><span class="num" id="3985003">1</span><span class="op" id="3985004">]</span>&nbsp;<span class="op" id="3985006">=</span>&nbsp;<span class="builtintype" id="3985008">byte</span><span class="op" id="3985012">(</span><span class="ident" id="3985013">curveid</span>&nbsp;<span class="op" id="3985021">&gt;&gt;</span>&nbsp;<span class="num" id="3985024">8</span><span class="op" id="3985025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3985028">serverECDHParams</span><span class="op" id="3985044">[</span><span class="num" id="3985045">2</span><span class="op" id="3985046">]</span>&nbsp;<span class="op" id="3985048">=</span>&nbsp;<span class="builtintype" id="3985050">byte</span><span class="op" id="3985054">(</span><span class="ident" id="3985055">curveid</span><span class="op" id="3985062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3985065">serverECDHParams</span><span class="op" id="3985081">[</span><span class="num" id="3985082">3</span><span class="op" id="3985083">]</span>&nbsp;<span class="op" id="3985085">=</span>&nbsp;<span class="builtintype" id="3985087">byte</span><span class="op" id="3985091">(</span><span class="builtinfunc" id="3985092">len</span><span class="op" id="3985095">(</span><span class="ident" id="3985096">ecdhePublic</span><span class="op" id="3985107">)</span><span class="op" id="3985108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3985111">copy</span><span class="op" id="3985115">(</span><span class="ident" id="3985116">serverECDHParams</span><span class="op" id="3985132">[</span><span class="num" id="3985133">4</span><span class="op" id="3985134">:</span><span class="op" id="3985135">]</span><span class="op" id="3985136">,</span>&nbsp;<span class="ident" id="3985138">ecdhePublic</span><span class="op" id="3985149">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3985153">var</span>&nbsp;<span class="ident" id="3985157">tls12HashId</span>&nbsp;<span class="builtintype" id="3985169">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3985176">if</span>&nbsp;<span class="ident" id="3985179">ka</span><span class="op" id="3985181">.</span><span class="ident" id="3985182">version</span>&nbsp;<span class="op" id="3985190">&gt;=</span>&nbsp;<span class="ident" id="3985193">VersionTLS12</span>&nbsp;<span class="op" id="3985206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3985210">if</span>&nbsp;<span class="ident" id="3985213">tls12HashId</span><span class="op" id="3985224">,</span>&nbsp;<span class="ident" id="3985226">err</span>&nbsp;<span class="op" id="3985230">=</span>&nbsp;<span class="ident" id="3985232">pickTLS12HashForSignature</span><span class="op" id="3985257">(</span><span class="ident" id="3985258">ka</span><span class="op" id="3985260">.</span><span class="ident" id="3985261">sigType</span><span class="op" id="3985268">,</span>&nbsp;<span class="ident" id="3985270">clientHello</span><span class="op" id="3985281">.</span><span class="ident" id="3985282">signatureAndHashes</span><span class="op" id="3985300">)</span><span class="op" id="3985301">;</span>&nbsp;<span class="ident" id="3985303">err</span>&nbsp;<span class="op" id="3985307">!=</span>&nbsp;<span class="ident" id="3985310">nil</span>&nbsp;<span class="op" id="3985314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3985319">return</span>&nbsp;<span class="ident" id="3985326">nil</span><span class="op" id="3985329">,</span>&nbsp;<span class="ident" id="3985331">err</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3985337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3985340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3985344">digest</span><span class="op" id="3985350">,</span>&nbsp;<span class="ident" id="3985352">hashFunc</span><span class="op" id="3985360">,</span>&nbsp;<span class="ident" id="3985362">err</span>&nbsp;<span class="op" id="3985366">:=</span>&nbsp;<span class="ident" id="3985369">hashForServerKeyExchange</span><span class="op" id="3985393">(</span><span class="ident" id="3985394">ka</span><span class="op" id="3985396">.</span><span class="ident" id="3985397">sigType</span><span class="op" id="3985404">,</span>&nbsp;<span class="ident" id="3985406">tls12HashId</span><span class="op" id="3985417">,</span>&nbsp;<span class="ident" id="3985419">ka</span><span class="op" id="3985421">.</span><span class="ident" id="3985422">version</span><span class="op" id="3985429">,</span>&nbsp;<span class="ident" id="3985431">clientHello</span><span class="op" id="3985442">.</span><span class="ident" id="3985443">random</span><span class="op" id="3985449">,</span>&nbsp;<span class="ident" id="3985451">hello</span><span class="op" id="3985456">.</span><span class="ident" id="3985457">random</span><span class="op" id="3985463">,</span>&nbsp;<span class="ident" id="3985465">serverECDHParams</span><span class="op" id="3985481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3985484">if</span>&nbsp;<span class="ident" id="3985487">err</span>&nbsp;<span class="op" id="3985491">!=</span>&nbsp;<span class="ident" id="3985494">nil</span>&nbsp;<span class="op" id="3985498">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3985502">return</span>&nbsp;<span class="ident" id="3985509">nil</span><span class="op" id="3985512">,</span>&nbsp;<span class="ident" id="3985514">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3985519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3985522">var</span>&nbsp;<span class="ident" id="3985526">sig</span>&nbsp;<span class="op" id="3985530">[</span><span class="op" id="3985531">]</span><span class="builtintype" id="3985532">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3985538">switch</span>&nbsp;<span class="ident" id="3985545">ka</span><span class="op" id="3985547">.</span><span class="ident" id="3985548">sigType</span>&nbsp;<span class="op" id="3985556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3985559">case</span>&nbsp;<span class="ident" id="3985564">signatureECDSA</span><span class="op" id="3985578">:</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3985582">privKey</span><span class="op" id="3985589">,</span>&nbsp;<span class="ident" id="3985591">ok</span>&nbsp;<span class="op" id="3985594">:=</span>&nbsp;<span class="ident" id="3985597">cert</span><span class="op" id="3985601">.</span><span class="ident" id="3985602">PrivateKey</span><span class="op" id="3985612">.</span><span class="op" id="3985613">(</span><span class="op" id="3985614">*</span><span class="ident" id="3985615">ecdsa</span><span class="op" id="3985620">.</span><span class="ident" id="3985621">PrivateKey</span><span class="op" id="3985631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3985635">if</span>&nbsp;<span class="op" id="3985638">!</span><span class="ident" id="3985639">ok</span>&nbsp;<span class="op" id="3985642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3985647">return</span>&nbsp;<span class="ident" id="3985654">nil</span><span class="op" id="3985657">,</span>&nbsp;<span class="ident" id="3985659">errors</span><span class="op" id="3985665">.</span><span class="ident" id="3985666">New</span><span class="op" id="3985669">(</span><span class="string" id="3985670">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;an&nbsp;ECDSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="3985720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3985724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3985728">r</span><span class="op" id="3985729">,</span>&nbsp;<span class="ident" id="3985731">s</span><span class="op" id="3985732">,</span>&nbsp;<span class="ident" id="3985734">err</span>&nbsp;<span class="op" id="3985738">:=</span>&nbsp;<span class="ident" id="3985741">ecdsa</span><span class="op" id="3985746">.</span><span class="ident" id="3985747">Sign</span><span class="op" id="3985751">(</span><span class="ident" id="3985752">config</span><span class="op" id="3985758">.</span><span class="ident" id="3985759">rand</span><span class="op" id="3985763">(</span><span class="op" id="3985764">)</span><span class="op" id="3985765">,</span>&nbsp;<span class="ident" id="3985767">privKey</span><span class="op" id="3985774">,</span>&nbsp;<span class="ident" id="3985776">digest</span><span class="op" id="3985782">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3985786">if</span>&nbsp;<span class="ident" id="3985789">err</span>&nbsp;<span class="op" id="3985793">!=</span>&nbsp;<span class="ident" id="3985796">nil</span>&nbsp;<span class="op" id="3985800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3985805">return</span>&nbsp;<span class="ident" id="3985812">nil</span><span class="op" id="3985815">,</span>&nbsp;<span class="ident" id="3985817">errors</span><span class="op" id="3985823">.</span><span class="ident" id="3985824">New</span><span class="op" id="3985827">(</span><span class="string" id="3985828">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="3985864">+</span>&nbsp;<span class="ident" id="3985866">err</span><span class="op" id="3985869">.</span><span class="ident" id="3985870">Error</span><span class="op" id="3985875">(</span><span class="op" id="3985876">)</span><span class="op" id="3985877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3985881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3985885">sig</span><span class="op" id="3985888">,</span>&nbsp;<span class="ident" id="3985890">err</span>&nbsp;<span class="op" id="3985894">=</span>&nbsp;<span class="ident" id="3985896">asn1</span><span class="op" id="3985900">.</span><span class="ident" id="3985901">Marshal</span><span class="op" id="3985908">(</span><span class="ident" id="3985909">ecdsaSignature</span><span class="op" id="3985923">{</span><span class="ident" id="3985924">r</span><span class="op" id="3985925">,</span>&nbsp;<span class="ident" id="3985927">s</span><span class="op" id="3985928">}</span><span class="op" id="3985929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3985932">case</span>&nbsp;<span class="ident" id="3985937">signatureRSA</span><span class="op" id="3985949">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3985953">privKey</span><span class="op" id="3985960">,</span>&nbsp;<span class="ident" id="3985962">ok</span>&nbsp;<span class="op" id="3985965">:=</span>&nbsp;<span class="ident" id="3985968">cert</span><span class="op" id="3985972">.</span><span class="ident" id="3985973">PrivateKey</span><span class="op" id="3985983">.</span><span class="op" id="3985984">(</span><span class="op" id="3985985">*</span><span class="ident" id="3985986">rsa</span><span class="op" id="3985989">.</span><span class="ident" id="3985990">PrivateKey</span><span class="op" id="3986000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3986004">if</span>&nbsp;<span class="op" id="3986007">!</span><span class="ident" id="3986008">ok</span>&nbsp;<span class="op" id="3986011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3986016">return</span>&nbsp;<span class="ident" id="3986023">nil</span><span class="op" id="3986026">,</span>&nbsp;<span class="ident" id="3986028">errors</span><span class="op" id="3986034">.</span><span class="ident" id="3986035">New</span><span class="op" id="3986038">(</span><span class="string" id="3986039">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="3986084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3986088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3986092">sig</span><span class="op" id="3986095">,</span>&nbsp;<span class="ident" id="3986097">err</span>&nbsp;<span class="op" id="3986101">=</span>&nbsp;<span class="ident" id="3986103">rsa</span><span class="op" id="3986106">.</span><span class="ident" id="3986107">SignPKCS1v15</span><span class="op" id="3986119">(</span><span class="ident" id="3986120">config</span><span class="op" id="3986126">.</span><span class="ident" id="3986127">rand</span><span class="op" id="3986131">(</span><span class="op" id="3986132">)</span><span class="op" id="3986133">,</span>&nbsp;<span class="ident" id="3986135">privKey</span><span class="op" id="3986142">,</span>&nbsp;<span class="ident" id="3986144">hashFunc</span><span class="op" id="3986152">,</span>&nbsp;<span class="ident" id="3986154">digest</span><span class="op" id="3986160">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3986164">if</span>&nbsp;<span class="ident" id="3986167">err</span>&nbsp;<span class="op" id="3986171">!=</span>&nbsp;<span class="ident" id="3986174">nil</span>&nbsp;<span class="op" id="3986178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3986183">return</span>&nbsp;<span class="ident" id="3986190">nil</span><span class="op" id="3986193">,</span>&nbsp;<span class="ident" id="3986195">errors</span><span class="op" id="3986201">.</span><span class="ident" id="3986202">New</span><span class="op" id="3986205">(</span><span class="string" id="3986206">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="3986242">+</span>&nbsp;<span class="ident" id="3986244">err</span><span class="op" id="3986247">.</span><span class="ident" id="3986248">Error</span><span class="op" id="3986253">(</span><span class="op" id="3986254">)</span><span class="op" id="3986255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3986259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3986262">default</span><span class="op" id="3986269">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3986273">return</span>&nbsp;<span class="ident" id="3986280">nil</span><span class="op" id="3986283">,</span>&nbsp;<span class="ident" id="3986285">errors</span><span class="op" id="3986291">.</span><span class="ident" id="3986292">New</span><span class="op" id="3986295">(</span><span class="string" id="3986296">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="3986331">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3986334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3986338">skx</span>&nbsp;<span class="op" id="3986342">:=</span>&nbsp;<span class="builtinfunc" id="3986345">new</span><span class="op" id="3986348">(</span><span class="ident" id="3986349">serverKeyExchangeMsg</span><span class="op" id="3986369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3986372">sigAndHashLen</span>&nbsp;<span class="op" id="3986386">:=</span>&nbsp;<span class="num" id="3986389">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3986392">if</span>&nbsp;<span class="ident" id="3986395">ka</span><span class="op" id="3986397">.</span><span class="ident" id="3986398">version</span>&nbsp;<span class="op" id="3986406">&gt;=</span>&nbsp;<span class="ident" id="3986409">VersionTLS12</span>&nbsp;<span class="op" id="3986422">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3986426">sigAndHashLen</span>&nbsp;<span class="op" id="3986440">=</span>&nbsp;<span class="num" id="3986442">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3986445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3986448">skx</span><span class="op" id="3986451">.</span><span class="ident" id="3986452">key</span>&nbsp;<span class="op" id="3986456">=</span>&nbsp;<span class="builtinfunc" id="3986458">make</span><span class="op" id="3986462">(</span><span class="op" id="3986463">[</span><span class="op" id="3986464">]</span><span class="builtintype" id="3986465">byte</span><span class="op" id="3986469">,</span>&nbsp;<span class="builtinfunc" id="3986471">len</span><span class="op" id="3986474">(</span><span class="ident" id="3986475">serverECDHParams</span><span class="op" id="3986491">)</span><span class="op" id="3986492">+</span><span class="ident" id="3986493">sigAndHashLen</span><span class="op" id="3986506">+</span><span class="num" id="3986507">2</span><span class="op" id="3986508">+</span><span class="builtinfunc" id="3986509">len</span><span class="op" id="3986512">(</span><span class="ident" id="3986513">sig</span><span class="op" id="3986516">)</span><span class="op" id="3986517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3986520">copy</span><span class="op" id="3986524">(</span><span class="ident" id="3986525">skx</span><span class="op" id="3986528">.</span><span class="ident" id="3986529">key</span><span class="op" id="3986532">,</span>&nbsp;<span class="ident" id="3986534">serverECDHParams</span><span class="op" id="3986550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3986553">k</span>&nbsp;<span class="op" id="3986555">:=</span>&nbsp;<span class="ident" id="3986558">skx</span><span class="op" id="3986561">.</span><span class="ident" id="3986562">key</span><span class="op" id="3986565">[</span><span class="builtinfunc" id="3986566">len</span><span class="op" id="3986569">(</span><span class="ident" id="3986570">serverECDHParams</span><span class="op" id="3986586">)</span><span class="op" id="3986587">:</span><span class="op" id="3986588">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3986591">if</span>&nbsp;<span class="ident" id="3986594">ka</span><span class="op" id="3986596">.</span><span class="ident" id="3986597">version</span>&nbsp;<span class="op" id="3986605">&gt;=</span>&nbsp;<span class="ident" id="3986608">VersionTLS12</span>&nbsp;<span class="op" id="3986621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3986625">k</span><span class="op" id="3986626">[</span><span class="num" id="3986627">0</span><span class="op" id="3986628">]</span>&nbsp;<span class="op" id="3986630">=</span>&nbsp;<span class="ident" id="3986632">tls12HashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3986646">k</span><span class="op" id="3986647">[</span><span class="num" id="3986648">1</span><span class="op" id="3986649">]</span>&nbsp;<span class="op" id="3986651">=</span>&nbsp;<span class="ident" id="3986653">ka</span><span class="op" id="3986655">.</span><span class="ident" id="3986656">sigType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3986666">k</span>&nbsp;<span class="op" id="3986668">=</span>&nbsp;<span class="ident" id="3986670">k</span><span class="op" id="3986671">[</span><span class="num" id="3986672">2</span><span class="op" id="3986673">:</span><span class="op" id="3986674">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3986677">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3986680">k</span><span class="op" id="3986681">[</span><span class="num" id="3986682">0</span><span class="op" id="3986683">]</span>&nbsp;<span class="op" id="3986685">=</span>&nbsp;<span class="builtintype" id="3986687">byte</span><span class="op" id="3986691">(</span><span class="builtinfunc" id="3986692">len</span><span class="op" id="3986695">(</span><span class="ident" id="3986696">sig</span><span class="op" id="3986699">)</span>&nbsp;<span class="op" id="3986701">&gt;&gt;</span>&nbsp;<span class="num" id="3986704">8</span><span class="op" id="3986705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3986708">k</span><span class="op" id="3986709">[</span><span class="num" id="3986710">1</span><span class="op" id="3986711">]</span>&nbsp;<span class="op" id="3986713">=</span>&nbsp;<span class="builtintype" id="3986715">byte</span><span class="op" id="3986719">(</span><span class="builtinfunc" id="3986720">len</span><span class="op" id="3986723">(</span><span class="ident" id="3986724">sig</span><span class="op" id="3986727">)</span><span class="op" id="3986728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3986731">copy</span><span class="op" id="3986735">(</span><span class="ident" id="3986736">k</span><span class="op" id="3986737">[</span><span class="num" id="3986738">2</span><span class="op" id="3986739">:</span><span class="op" id="3986740">]</span><span class="op" id="3986741">,</span>&nbsp;<span class="ident" id="3986743">sig</span><span class="op" id="3986746">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3986750">return</span>&nbsp;<span class="ident" id="3986757">skx</span><span class="op" id="3986760">,</span>&nbsp;<span class="ident" id="3986762">nil</span><br>
<span class="lineno">285</span><span class="op" id="3986766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3986769">func</span>&nbsp;<span class="op" id="3986774">(</span><span class="ident" id="3986775">ka</span>&nbsp;<span class="op" id="3986778">*</span><span class="ident" id="3986779">ecdheKeyAgreement</span><span class="op" id="3986796">)</span>&nbsp;<span class="ident" id="3986798">processClientKeyExchange</span><span class="op" id="3986822">(</span><span class="ident" id="3986823">config</span>&nbsp;<span class="op" id="3986830">*</span><span class="ident" id="3986831">Config</span><span class="op" id="3986837">,</span>&nbsp;<span class="ident" id="3986839">cert</span>&nbsp;<span class="op" id="3986844">*</span><span class="ident" id="3986845">Certificate</span><span class="op" id="3986856">,</span>&nbsp;<span class="ident" id="3986858">ckx</span>&nbsp;<span class="op" id="3986862">*</span><span class="ident" id="3986863">clientKeyExchangeMsg</span><span class="op" id="3986883">,</span>&nbsp;<span class="ident" id="3986885">version</span>&nbsp;<span class="builtintype" id="3986893">uint16</span><span class="op" id="3986899">)</span>&nbsp;<span class="op" id="3986901">(</span><span class="op" id="3986902">[</span><span class="op" id="3986903">]</span><span class="builtintype" id="3986904">byte</span><span class="op" id="3986908">,</span>&nbsp;<span class="builtintype" id="3986910">error</span><span class="op" id="3986915">)</span>&nbsp;<span class="op" id="3986917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3986920">if</span>&nbsp;<span class="builtinfunc" id="3986923">len</span><span class="op" id="3986926">(</span><span class="ident" id="3986927">ckx</span><span class="op" id="3986930">.</span><span class="ident" id="3986931">ciphertext</span><span class="op" id="3986941">)</span>&nbsp;<span class="op" id="3986943">==</span>&nbsp;<span class="num" id="3986946">0</span>&nbsp;<span class="op" id="3986948">||</span>&nbsp;<span class="builtintype" id="3986951">int</span><span class="op" id="3986954">(</span><span class="ident" id="3986955">ckx</span><span class="op" id="3986958">.</span><span class="ident" id="3986959">ciphertext</span><span class="op" id="3986969">[</span><span class="num" id="3986970">0</span><span class="op" id="3986971">]</span><span class="op" id="3986972">)</span>&nbsp;<span class="op" id="3986974">!=</span>&nbsp;<span class="builtinfunc" id="3986977">len</span><span class="op" id="3986980">(</span><span class="ident" id="3986981">ckx</span><span class="op" id="3986984">.</span><span class="ident" id="3986985">ciphertext</span><span class="op" id="3986995">)</span><span class="op" id="3986996">-</span><span class="num" id="3986997">1</span>&nbsp;<span class="op" id="3986999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3987003">return</span>&nbsp;<span class="ident" id="3987010">nil</span><span class="op" id="3987013">,</span>&nbsp;<span class="ident" id="3987015">errClientKeyExchange</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3987037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3987040">x</span><span class="op" id="3987041">,</span>&nbsp;<span class="ident" id="3987043">y</span>&nbsp;<span class="op" id="3987045">:=</span>&nbsp;<span class="ident" id="3987048">elliptic</span><span class="op" id="3987056">.</span><span class="ident" id="3987057">Unmarshal</span><span class="op" id="3987066">(</span><span class="ident" id="3987067">ka</span><span class="op" id="3987069">.</span><span class="ident" id="3987070">curve</span><span class="op" id="3987075">,</span>&nbsp;<span class="ident" id="3987077">ckx</span><span class="op" id="3987080">.</span><span class="ident" id="3987081">ciphertext</span><span class="op" id="3987091">[</span><span class="num" id="3987092">1</span><span class="op" id="3987093">:</span><span class="op" id="3987094">]</span><span class="op" id="3987095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3987098">if</span>&nbsp;<span class="ident" id="3987101">x</span>&nbsp;<span class="op" id="3987103">==</span>&nbsp;<span class="ident" id="3987106">nil</span>&nbsp;<span class="op" id="3987110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3987114">return</span>&nbsp;<span class="ident" id="3987121">nil</span><span class="op" id="3987124">,</span>&nbsp;<span class="ident" id="3987126">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3987148">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3987151">if</span>&nbsp;<span class="op" id="3987154">!</span><span class="ident" id="3987155">ka</span><span class="op" id="3987157">.</span><span class="ident" id="3987158">curve</span><span class="op" id="3987163">.</span><span class="ident" id="3987164">IsOnCurve</span><span class="op" id="3987173">(</span><span class="ident" id="3987174">x</span><span class="op" id="3987175">,</span>&nbsp;<span class="ident" id="3987177">y</span><span class="op" id="3987178">)</span>&nbsp;<span class="op" id="3987180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3987184">return</span>&nbsp;<span class="ident" id="3987191">nil</span><span class="op" id="3987194">,</span>&nbsp;<span class="ident" id="3987196">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3987218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3987221">x</span><span class="op" id="3987222">,</span>&nbsp;<span class="ident" id="3987224">_</span>&nbsp;<span class="op" id="3987226">=</span>&nbsp;<span class="ident" id="3987228">ka</span><span class="op" id="3987230">.</span><span class="ident" id="3987231">curve</span><span class="op" id="3987236">.</span><span class="ident" id="3987237">ScalarMult</span><span class="op" id="3987247">(</span><span class="ident" id="3987248">x</span><span class="op" id="3987249">,</span>&nbsp;<span class="ident" id="3987251">y</span><span class="op" id="3987252">,</span>&nbsp;<span class="ident" id="3987254">ka</span><span class="op" id="3987256">.</span><span class="ident" id="3987257">privateKey</span><span class="op" id="3987267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3987270">preMasterSecret</span>&nbsp;<span class="op" id="3987286">:=</span>&nbsp;<span class="builtinfunc" id="3987289">make</span><span class="op" id="3987293">(</span><span class="op" id="3987294">[</span><span class="op" id="3987295">]</span><span class="builtintype" id="3987296">byte</span><span class="op" id="3987300">,</span>&nbsp;<span class="op" id="3987302">(</span><span class="ident" id="3987303">ka</span><span class="op" id="3987305">.</span><span class="ident" id="3987306">curve</span><span class="op" id="3987311">.</span><span class="ident" id="3987312">Params</span><span class="op" id="3987318">(</span><span class="op" id="3987319">)</span><span class="op" id="3987320">.</span><span class="ident" id="3987321">BitSize</span><span class="op" id="3987328">+</span><span class="num" id="3987329">7</span><span class="op" id="3987330">)</span><span class="op" id="3987331">&gt;&gt;</span><span class="num" id="3987333">3</span><span class="op" id="3987334">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3987337">xBytes</span>&nbsp;<span class="op" id="3987344">:=</span>&nbsp;<span class="ident" id="3987347">x</span><span class="op" id="3987348">.</span><span class="ident" id="3987349">Bytes</span><span class="op" id="3987354">(</span><span class="op" id="3987355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3987358">copy</span><span class="op" id="3987362">(</span><span class="ident" id="3987363">preMasterSecret</span><span class="op" id="3987378">[</span><span class="builtinfunc" id="3987379">len</span><span class="op" id="3987382">(</span><span class="ident" id="3987383">preMasterSecret</span><span class="op" id="3987398">)</span><span class="op" id="3987399">-</span><span class="builtinfunc" id="3987400">len</span><span class="op" id="3987403">(</span><span class="ident" id="3987404">xBytes</span><span class="op" id="3987410">)</span><span class="op" id="3987411">:</span><span class="op" id="3987412">]</span><span class="op" id="3987413">,</span>&nbsp;<span class="ident" id="3987415">xBytes</span><span class="op" id="3987421">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3987425">return</span>&nbsp;<span class="ident" id="3987432">preMasterSecret</span><span class="op" id="3987447">,</span>&nbsp;<span class="ident" id="3987449">nil</span><br>
<span class="lineno"></span><span class="op" id="3987453">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="3987456">func</span>&nbsp;<span class="op" id="3987461">(</span><span class="ident" id="3987462">ka</span>&nbsp;<span class="op" id="3987465">*</span><span class="ident" id="3987466">ecdheKeyAgreement</span><span class="op" id="3987483">)</span>&nbsp;<span class="ident" id="3987485">processServerKeyExchange</span><span class="op" id="3987509">(</span><span class="ident" id="3987510">config</span>&nbsp;<span class="op" id="3987517">*</span><span class="ident" id="3987518">Config</span><span class="op" id="3987524">,</span>&nbsp;<span class="ident" id="3987526">clientHello</span>&nbsp;<span class="op" id="3987538">*</span><span class="ident" id="3987539">clientHelloMsg</span><span class="op" id="3987553">,</span>&nbsp;<span class="ident" id="3987555">serverHello</span>&nbsp;<span class="op" id="3987567">*</span><span class="ident" id="3987568">serverHelloMsg</span><span class="op" id="3987582">,</span>&nbsp;<span class="ident" id="3987584">cert</span>&nbsp;<span class="op" id="3987589">*</span><span class="ident" id="3987590">x509</span><span class="op" id="3987594">.</span><span class="ident" id="3987595">Certificate</span><span class="op" id="3987606">,</span>&nbsp;<span class="ident" id="3987608">skx</span>&nbsp;<span class="op" id="3987612">*</span><span class="ident" id="3987613">serverKeyExchangeMsg</span><span class="op" id="3987633">)</span>&nbsp;<span class="builtintype" id="3987635">error</span>&nbsp;<span class="op" id="3987641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3987644">if</span>&nbsp;<span class="builtinfunc" id="3987647">len</span><span class="op" id="3987650">(</span><span class="ident" id="3987651">skx</span><span class="op" id="3987654">.</span><span class="ident" id="3987655">key</span><span class="op" id="3987658">)</span>&nbsp;<span class="op" id="3987660">&lt;</span>&nbsp;<span class="num" id="3987662">4</span>&nbsp;<span class="op" id="3987664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3987668">return</span>&nbsp;<span class="ident" id="3987675">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3987697">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3987700">if</span>&nbsp;<span class="ident" id="3987703">skx</span><span class="op" id="3987706">.</span><span class="ident" id="3987707">key</span><span class="op" id="3987710">[</span><span class="num" id="3987711">0</span><span class="op" id="3987712">]</span>&nbsp;<span class="op" id="3987714">!=</span>&nbsp;<span class="num" id="3987717">3</span>&nbsp;<span class="op" id="3987719">{</span>&nbsp;<span class="comment" id="3987721">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3987738">return</span>&nbsp;<span class="ident" id="3987745">errors</span><span class="op" id="3987751">.</span><span class="ident" id="3987752">New</span><span class="op" id="3987755">(</span><span class="string" id="3987756">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3987796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3987799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3987802">curveid</span>&nbsp;<span class="op" id="3987810">:=</span>&nbsp;<span class="ident" id="3987813">CurveID</span><span class="op" id="3987820">(</span><span class="ident" id="3987821">skx</span><span class="op" id="3987824">.</span><span class="ident" id="3987825">key</span><span class="op" id="3987828">[</span><span class="num" id="3987829">1</span><span class="op" id="3987830">]</span><span class="op" id="3987831">)</span><span class="op" id="3987832">&lt;&lt;</span><span class="num" id="3987834">8</span>&nbsp;<span class="op" id="3987836">|</span>&nbsp;<span class="ident" id="3987838">CurveID</span><span class="op" id="3987845">(</span><span class="ident" id="3987846">skx</span><span class="op" id="3987849">.</span><span class="ident" id="3987850">key</span><span class="op" id="3987853">[</span><span class="num" id="3987854">2</span><span class="op" id="3987855">]</span><span class="op" id="3987856">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3987860">var</span>&nbsp;<span class="ident" id="3987864">ok</span>&nbsp;<span class="builtintype" id="3987867">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3987873">if</span>&nbsp;<span class="ident" id="3987876">ka</span><span class="op" id="3987878">.</span><span class="ident" id="3987879">curve</span><span class="op" id="3987884">,</span>&nbsp;<span class="ident" id="3987886">ok</span>&nbsp;<span class="op" id="3987889">=</span>&nbsp;<span class="ident" id="3987891">curveForCurveID</span><span class="op" id="3987906">(</span><span class="ident" id="3987907">curveid</span><span class="op" id="3987914">)</span><span class="op" id="3987915">;</span>&nbsp;<span class="op" id="3987917">!</span><span class="ident" id="3987918">ok</span>&nbsp;<span class="op" id="3987921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3987925">return</span>&nbsp;<span class="ident" id="3987932">errors</span><span class="op" id="3987938">.</span><span class="ident" id="3987939">New</span><span class="op" id="3987942">(</span><span class="string" id="3987943">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3987983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3987986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3987990">publicLen</span>&nbsp;<span class="op" id="3988000">:=</span>&nbsp;<span class="builtintype" id="3988003">int</span><span class="op" id="3988006">(</span><span class="ident" id="3988007">skx</span><span class="op" id="3988010">.</span><span class="ident" id="3988011">key</span><span class="op" id="3988014">[</span><span class="num" id="3988015">3</span><span class="op" id="3988016">]</span><span class="op" id="3988017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988020">if</span>&nbsp;<span class="ident" id="3988023">publicLen</span><span class="op" id="3988032">+</span><span class="num" id="3988033">4</span>&nbsp;<span class="op" id="3988035">&gt;</span>&nbsp;<span class="builtinfunc" id="3988037">len</span><span class="op" id="3988040">(</span><span class="ident" id="3988041">skx</span><span class="op" id="3988044">.</span><span class="ident" id="3988045">key</span><span class="op" id="3988048">)</span>&nbsp;<span class="op" id="3988050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988054">return</span>&nbsp;<span class="ident" id="3988061">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3988083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3988086">ka</span><span class="op" id="3988088">.</span><span class="ident" id="3988089">x</span><span class="op" id="3988090">,</span>&nbsp;<span class="ident" id="3988092">ka</span><span class="op" id="3988094">.</span><span class="ident" id="3988095">y</span>&nbsp;<span class="op" id="3988097">=</span>&nbsp;<span class="ident" id="3988099">elliptic</span><span class="op" id="3988107">.</span><span class="ident" id="3988108">Unmarshal</span><span class="op" id="3988117">(</span><span class="ident" id="3988118">ka</span><span class="op" id="3988120">.</span><span class="ident" id="3988121">curve</span><span class="op" id="3988126">,</span>&nbsp;<span class="ident" id="3988128">skx</span><span class="op" id="3988131">.</span><span class="ident" id="3988132">key</span><span class="op" id="3988135">[</span><span class="num" id="3988136">4</span><span class="op" id="3988137">:</span><span class="num" id="3988138">4</span><span class="op" id="3988139">+</span><span class="ident" id="3988140">publicLen</span><span class="op" id="3988149">]</span><span class="op" id="3988150">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988153">if</span>&nbsp;<span class="ident" id="3988156">ka</span><span class="op" id="3988158">.</span><span class="ident" id="3988159">x</span>&nbsp;<span class="op" id="3988161">==</span>&nbsp;<span class="ident" id="3988164">nil</span>&nbsp;<span class="op" id="3988168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988172">return</span>&nbsp;<span class="ident" id="3988179">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3988201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988204">if</span>&nbsp;<span class="op" id="3988207">!</span><span class="ident" id="3988208">ka</span><span class="op" id="3988210">.</span><span class="ident" id="3988211">curve</span><span class="op" id="3988216">.</span><span class="ident" id="3988217">IsOnCurve</span><span class="op" id="3988226">(</span><span class="ident" id="3988227">ka</span><span class="op" id="3988229">.</span><span class="ident" id="3988230">x</span><span class="op" id="3988231">,</span>&nbsp;<span class="ident" id="3988233">ka</span><span class="op" id="3988235">.</span><span class="ident" id="3988236">y</span><span class="op" id="3988237">)</span>&nbsp;<span class="op" id="3988239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988243">return</span>&nbsp;<span class="ident" id="3988250">errServerKeyExchange</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3988272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3988275">serverECDHParams</span>&nbsp;<span class="op" id="3988292">:=</span>&nbsp;<span class="ident" id="3988295">skx</span><span class="op" id="3988298">.</span><span class="ident" id="3988299">key</span><span class="op" id="3988302">[</span><span class="op" id="3988303">:</span><span class="num" id="3988304">4</span><span class="op" id="3988305">+</span><span class="ident" id="3988306">publicLen</span><span class="op" id="3988315">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3988319">sig</span>&nbsp;<span class="op" id="3988323">:=</span>&nbsp;<span class="ident" id="3988326">skx</span><span class="op" id="3988329">.</span><span class="ident" id="3988330">key</span><span class="op" id="3988333">[</span><span class="num" id="3988334">4</span><span class="op" id="3988335">+</span><span class="ident" id="3988336">publicLen</span><span class="op" id="3988345">:</span><span class="op" id="3988346">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988349">if</span>&nbsp;<span class="builtinfunc" id="3988352">len</span><span class="op" id="3988355">(</span><span class="ident" id="3988356">sig</span><span class="op" id="3988359">)</span>&nbsp;<span class="op" id="3988361">&lt;</span>&nbsp;<span class="num" id="3988363">2</span>&nbsp;<span class="op" id="3988365">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988369">return</span>&nbsp;<span class="ident" id="3988376">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3988398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988402">var</span>&nbsp;<span class="ident" id="3988406">tls12HashId</span>&nbsp;<span class="builtintype" id="3988418">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988425">if</span>&nbsp;<span class="ident" id="3988428">ka</span><span class="op" id="3988430">.</span><span class="ident" id="3988431">version</span>&nbsp;<span class="op" id="3988439">&gt;=</span>&nbsp;<span class="ident" id="3988442">VersionTLS12</span>&nbsp;<span class="op" id="3988455">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3988459">//&nbsp;handle&nbsp;SignatureAndHashAlgorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988497">var</span>&nbsp;<span class="ident" id="3988501">sigAndHash</span>&nbsp;<span class="op" id="3988512">[</span><span class="op" id="3988513">]</span><span class="builtintype" id="3988514">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3988522">sigAndHash</span><span class="op" id="3988532">,</span>&nbsp;<span class="ident" id="3988534">sig</span>&nbsp;<span class="op" id="3988538">=</span>&nbsp;<span class="ident" id="3988540">sig</span><span class="op" id="3988543">[</span><span class="op" id="3988544">:</span><span class="num" id="3988545">2</span><span class="op" id="3988546">]</span><span class="op" id="3988547">,</span>&nbsp;<span class="ident" id="3988549">sig</span><span class="op" id="3988552">[</span><span class="num" id="3988553">2</span><span class="op" id="3988554">:</span><span class="op" id="3988555">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988559">if</span>&nbsp;<span class="ident" id="3988562">sigAndHash</span><span class="op" id="3988572">[</span><span class="num" id="3988573">1</span><span class="op" id="3988574">]</span>&nbsp;<span class="op" id="3988576">!=</span>&nbsp;<span class="ident" id="3988579">ka</span><span class="op" id="3988581">.</span><span class="ident" id="3988582">sigType</span>&nbsp;<span class="op" id="3988590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988595">return</span>&nbsp;<span class="ident" id="3988602">errServerKeyExchange</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3988625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3988629">tls12HashId</span>&nbsp;<span class="op" id="3988641">=</span>&nbsp;<span class="ident" id="3988643">sigAndHash</span><span class="op" id="3988653">[</span><span class="num" id="3988654">0</span><span class="op" id="3988655">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988659">if</span>&nbsp;<span class="builtinfunc" id="3988662">len</span><span class="op" id="3988665">(</span><span class="ident" id="3988666">sig</span><span class="op" id="3988669">)</span>&nbsp;<span class="op" id="3988671">&lt;</span>&nbsp;<span class="num" id="3988673">2</span>&nbsp;<span class="op" id="3988675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988680">return</span>&nbsp;<span class="ident" id="3988687">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3988710">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3988713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3988716">sigLen</span>&nbsp;<span class="op" id="3988723">:=</span>&nbsp;<span class="builtintype" id="3988726">int</span><span class="op" id="3988729">(</span><span class="ident" id="3988730">sig</span><span class="op" id="3988733">[</span><span class="num" id="3988734">0</span><span class="op" id="3988735">]</span><span class="op" id="3988736">)</span><span class="op" id="3988737">&lt;&lt;</span><span class="num" id="3988739">8</span>&nbsp;<span class="op" id="3988741">|</span>&nbsp;<span class="builtintype" id="3988743">int</span><span class="op" id="3988746">(</span><span class="ident" id="3988747">sig</span><span class="op" id="3988750">[</span><span class="num" id="3988751">1</span><span class="op" id="3988752">]</span><span class="op" id="3988753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988756">if</span>&nbsp;<span class="ident" id="3988759">sigLen</span><span class="op" id="3988765">+</span><span class="num" id="3988766">2</span>&nbsp;<span class="op" id="3988768">!=</span>&nbsp;<span class="builtinfunc" id="3988771">len</span><span class="op" id="3988774">(</span><span class="ident" id="3988775">sig</span><span class="op" id="3988778">)</span>&nbsp;<span class="op" id="3988780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988784">return</span>&nbsp;<span class="ident" id="3988791">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3988813">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3988816">sig</span>&nbsp;<span class="op" id="3988820">=</span>&nbsp;<span class="ident" id="3988822">sig</span><span class="op" id="3988825">[</span><span class="num" id="3988826">2</span><span class="op" id="3988827">:</span><span class="op" id="3988828">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3988832">digest</span><span class="op" id="3988838">,</span>&nbsp;<span class="ident" id="3988840">hashFunc</span><span class="op" id="3988848">,</span>&nbsp;<span class="ident" id="3988850">err</span>&nbsp;<span class="op" id="3988854">:=</span>&nbsp;<span class="ident" id="3988857">hashForServerKeyExchange</span><span class="op" id="3988881">(</span><span class="ident" id="3988882">ka</span><span class="op" id="3988884">.</span><span class="ident" id="3988885">sigType</span><span class="op" id="3988892">,</span>&nbsp;<span class="ident" id="3988894">tls12HashId</span><span class="op" id="3988905">,</span>&nbsp;<span class="ident" id="3988907">ka</span><span class="op" id="3988909">.</span><span class="ident" id="3988910">version</span><span class="op" id="3988917">,</span>&nbsp;<span class="ident" id="3988919">clientHello</span><span class="op" id="3988930">.</span><span class="ident" id="3988931">random</span><span class="op" id="3988937">,</span>&nbsp;<span class="ident" id="3988939">serverHello</span><span class="op" id="3988950">.</span><span class="ident" id="3988951">random</span><span class="op" id="3988957">,</span>&nbsp;<span class="ident" id="3988959">serverECDHParams</span><span class="op" id="3988975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988978">if</span>&nbsp;<span class="ident" id="3988981">err</span>&nbsp;<span class="op" id="3988985">!=</span>&nbsp;<span class="ident" id="3988988">nil</span>&nbsp;<span class="op" id="3988992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988996">return</span>&nbsp;<span class="ident" id="3989003">err</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3989008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989011">switch</span>&nbsp;<span class="ident" id="3989018">ka</span><span class="op" id="3989020">.</span><span class="ident" id="3989021">sigType</span>&nbsp;<span class="op" id="3989029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989032">case</span>&nbsp;<span class="ident" id="3989037">signatureECDSA</span><span class="op" id="3989051">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3989055">pubKey</span><span class="op" id="3989061">,</span>&nbsp;<span class="ident" id="3989063">ok</span>&nbsp;<span class="op" id="3989066">:=</span>&nbsp;<span class="ident" id="3989069">cert</span><span class="op" id="3989073">.</span><span class="ident" id="3989074">PublicKey</span><span class="op" id="3989083">.</span><span class="op" id="3989084">(</span><span class="op" id="3989085">*</span><span class="ident" id="3989086">ecdsa</span><span class="op" id="3989091">.</span><span class="ident" id="3989092">PublicKey</span><span class="op" id="3989101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989105">if</span>&nbsp;<span class="op" id="3989108">!</span><span class="ident" id="3989109">ok</span>&nbsp;<span class="op" id="3989112">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989117">return</span>&nbsp;<span class="ident" id="3989124">errors</span><span class="op" id="3989130">.</span><span class="ident" id="3989131">New</span><span class="op" id="3989134">(</span><span class="string" id="3989135">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;a&nbsp;ECDSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="3989183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3989187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3989191">ecdsaSig</span>&nbsp;<span class="op" id="3989200">:=</span>&nbsp;<span class="builtinfunc" id="3989203">new</span><span class="op" id="3989206">(</span><span class="ident" id="3989207">ecdsaSignature</span><span class="op" id="3989221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989225">if</span>&nbsp;<span class="ident" id="3989228">_</span><span class="op" id="3989229">,</span>&nbsp;<span class="ident" id="3989231">err</span>&nbsp;<span class="op" id="3989235">:=</span>&nbsp;<span class="ident" id="3989238">asn1</span><span class="op" id="3989242">.</span><span class="ident" id="3989243">Unmarshal</span><span class="op" id="3989252">(</span><span class="ident" id="3989253">sig</span><span class="op" id="3989256">,</span>&nbsp;<span class="ident" id="3989258">ecdsaSig</span><span class="op" id="3989266">)</span><span class="op" id="3989267">;</span>&nbsp;<span class="ident" id="3989269">err</span>&nbsp;<span class="op" id="3989273">!=</span>&nbsp;<span class="ident" id="3989276">nil</span>&nbsp;<span class="op" id="3989280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989285">return</span>&nbsp;<span class="ident" id="3989292">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3989298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989302">if</span>&nbsp;<span class="ident" id="3989305">ecdsaSig</span><span class="op" id="3989313">.</span><span class="ident" id="3989314">R</span><span class="op" id="3989315">.</span><span class="ident" id="3989316">Sign</span><span class="op" id="3989320">(</span><span class="op" id="3989321">)</span>&nbsp;<span class="op" id="3989323">&lt;=</span>&nbsp;<span class="num" id="3989326">0</span>&nbsp;<span class="op" id="3989328">||</span>&nbsp;<span class="ident" id="3989331">ecdsaSig</span><span class="op" id="3989339">.</span><span class="ident" id="3989340">S</span><span class="op" id="3989341">.</span><span class="ident" id="3989342">Sign</span><span class="op" id="3989346">(</span><span class="op" id="3989347">)</span>&nbsp;<span class="op" id="3989349">&lt;=</span>&nbsp;<span class="num" id="3989352">0</span>&nbsp;<span class="op" id="3989354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989359">return</span>&nbsp;<span class="ident" id="3989366">errors</span><span class="op" id="3989372">.</span><span class="ident" id="3989373">New</span><span class="op" id="3989376">(</span><span class="string" id="3989377">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="3989428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3989432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989436">if</span>&nbsp;<span class="op" id="3989439">!</span><span class="ident" id="3989440">ecdsa</span><span class="op" id="3989445">.</span><span class="ident" id="3989446">Verify</span><span class="op" id="3989452">(</span><span class="ident" id="3989453">pubKey</span><span class="op" id="3989459">,</span>&nbsp;<span class="ident" id="3989461">digest</span><span class="op" id="3989467">,</span>&nbsp;<span class="ident" id="3989469">ecdsaSig</span><span class="op" id="3989477">.</span><span class="ident" id="3989478">R</span><span class="op" id="3989479">,</span>&nbsp;<span class="ident" id="3989481">ecdsaSig</span><span class="op" id="3989489">.</span><span class="ident" id="3989490">S</span><span class="op" id="3989491">)</span>&nbsp;<span class="op" id="3989493">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989498">return</span>&nbsp;<span class="ident" id="3989505">errors</span><span class="op" id="3989511">.</span><span class="ident" id="3989512">New</span><span class="op" id="3989515">(</span><span class="string" id="3989516">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="3989544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3989548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989551">case</span>&nbsp;<span class="ident" id="3989556">signatureRSA</span><span class="op" id="3989568">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3989572">pubKey</span><span class="op" id="3989578">,</span>&nbsp;<span class="ident" id="3989580">ok</span>&nbsp;<span class="op" id="3989583">:=</span>&nbsp;<span class="ident" id="3989586">cert</span><span class="op" id="3989590">.</span><span class="ident" id="3989591">PublicKey</span><span class="op" id="3989600">.</span><span class="op" id="3989601">(</span><span class="op" id="3989602">*</span><span class="ident" id="3989603">rsa</span><span class="op" id="3989606">.</span><span class="ident" id="3989607">PublicKey</span><span class="op" id="3989616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989620">if</span>&nbsp;<span class="op" id="3989623">!</span><span class="ident" id="3989624">ok</span>&nbsp;<span class="op" id="3989627">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989632">return</span>&nbsp;<span class="ident" id="3989639">errors</span><span class="op" id="3989645">.</span><span class="ident" id="3989646">New</span><span class="op" id="3989649">(</span><span class="string" id="3989650">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="3989694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3989698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989702">if</span>&nbsp;<span class="ident" id="3989705">err</span>&nbsp;<span class="op" id="3989709">:=</span>&nbsp;<span class="ident" id="3989712">rsa</span><span class="op" id="3989715">.</span><span class="ident" id="3989716">VerifyPKCS1v15</span><span class="op" id="3989730">(</span><span class="ident" id="3989731">pubKey</span><span class="op" id="3989737">,</span>&nbsp;<span class="ident" id="3989739">hashFunc</span><span class="op" id="3989747">,</span>&nbsp;<span class="ident" id="3989749">digest</span><span class="op" id="3989755">,</span>&nbsp;<span class="ident" id="3989757">sig</span><span class="op" id="3989760">)</span><span class="op" id="3989761">;</span>&nbsp;<span class="ident" id="3989763">err</span>&nbsp;<span class="op" id="3989767">!=</span>&nbsp;<span class="ident" id="3989770">nil</span>&nbsp;<span class="op" id="3989774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989779">return</span>&nbsp;<span class="ident" id="3989786">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3989792">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989795">default</span><span class="op" id="3989802">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989806">return</span>&nbsp;<span class="ident" id="3989813">errors</span><span class="op" id="3989819">.</span><span class="ident" id="3989820">New</span><span class="op" id="3989823">(</span><span class="string" id="3989824">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="3989859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3989862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3989866">return</span>&nbsp;<span class="ident" id="3989873">nil</span><br>
<span class="lineno">390</span><span class="op" id="3989877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3989880">func</span>&nbsp;<span class="op" id="3989885">(</span><span class="ident" id="3989886">ka</span>&nbsp;<span class="op" id="3989889">*</span><span class="ident" id="3989890">ecdheKeyAgreement</span><span class="op" id="3989907">)</span>&nbsp;<span class="ident" id="3989909">generateClientKeyExchange</span><span class="op" id="3989934">(</span><span class="ident" id="3989935">config</span>&nbsp;<span class="op" id="3989942">*</span><span class="ident" id="3989943">Config</span><span class="op" id="3989949">,</span>&nbsp;<span class="ident" id="3989951">clientHello</span>&nbsp;<span class="op" id="3989963">*</span><span class="ident" id="3989964">clientHelloMsg</span><span class="op" id="3989978">,</span>&nbsp;<span class="ident" id="3989980">cert</span>&nbsp;<span class="op" id="3989985">*</span><span class="ident" id="3989986">x509</span><span class="op" id="3989990">.</span><span class="ident" id="3989991">Certificate</span><span class="op" id="3990002">)</span>&nbsp;<span class="op" id="3990004">(</span><span class="op" id="3990005">[</span><span class="op" id="3990006">]</span><span class="builtintype" id="3990007">byte</span><span class="op" id="3990011">,</span>&nbsp;<span class="op" id="3990013">*</span><span class="ident" id="3990014">clientKeyExchangeMsg</span><span class="op" id="3990034">,</span>&nbsp;<span class="builtintype" id="3990036">error</span><span class="op" id="3990041">)</span>&nbsp;<span class="op" id="3990043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3990046">if</span>&nbsp;<span class="ident" id="3990049">ka</span><span class="op" id="3990051">.</span><span class="ident" id="3990052">curve</span>&nbsp;<span class="op" id="3990058">==</span>&nbsp;<span class="ident" id="3990061">nil</span>&nbsp;<span class="op" id="3990065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3990069">return</span>&nbsp;<span class="ident" id="3990076">nil</span><span class="op" id="3990079">,</span>&nbsp;<span class="ident" id="3990081">nil</span><span class="op" id="3990084">,</span>&nbsp;<span class="ident" id="3990086">errors</span><span class="op" id="3990092">.</span><span class="ident" id="3990093">New</span><span class="op" id="3990096">(</span><span class="string" id="3990097">&#34;missing&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="3990132">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3990135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3990138">priv</span><span class="op" id="3990142">,</span>&nbsp;<span class="ident" id="3990144">mx</span><span class="op" id="3990146">,</span>&nbsp;<span class="ident" id="3990148">my</span><span class="op" id="3990150">,</span>&nbsp;<span class="ident" id="3990152">err</span>&nbsp;<span class="op" id="3990156">:=</span>&nbsp;<span class="ident" id="3990159">elliptic</span><span class="op" id="3990167">.</span><span class="ident" id="3990168">GenerateKey</span><span class="op" id="3990179">(</span><span class="ident" id="3990180">ka</span><span class="op" id="3990182">.</span><span class="ident" id="3990183">curve</span><span class="op" id="3990188">,</span>&nbsp;<span class="ident" id="3990190">config</span><span class="op" id="3990196">.</span><span class="ident" id="3990197">rand</span><span class="op" id="3990201">(</span><span class="op" id="3990202">)</span><span class="op" id="3990203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3990206">if</span>&nbsp;<span class="ident" id="3990209">err</span>&nbsp;<span class="op" id="3990213">!=</span>&nbsp;<span class="ident" id="3990216">nil</span>&nbsp;<span class="op" id="3990220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3990224">return</span>&nbsp;<span class="ident" id="3990231">nil</span><span class="op" id="3990234">,</span>&nbsp;<span class="ident" id="3990236">nil</span><span class="op" id="3990239">,</span>&nbsp;<span class="ident" id="3990241">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3990246">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3990249">x</span><span class="op" id="3990250">,</span>&nbsp;<span class="ident" id="3990252">_</span>&nbsp;<span class="op" id="3990254">:=</span>&nbsp;<span class="ident" id="3990257">ka</span><span class="op" id="3990259">.</span><span class="ident" id="3990260">curve</span><span class="op" id="3990265">.</span><span class="ident" id="3990266">ScalarMult</span><span class="op" id="3990276">(</span><span class="ident" id="3990277">ka</span><span class="op" id="3990279">.</span><span class="ident" id="3990280">x</span><span class="op" id="3990281">,</span>&nbsp;<span class="ident" id="3990283">ka</span><span class="op" id="3990285">.</span><span class="ident" id="3990286">y</span><span class="op" id="3990287">,</span>&nbsp;<span class="ident" id="3990289">priv</span><span class="op" id="3990293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3990296">preMasterSecret</span>&nbsp;<span class="op" id="3990312">:=</span>&nbsp;<span class="builtinfunc" id="3990315">make</span><span class="op" id="3990319">(</span><span class="op" id="3990320">[</span><span class="op" id="3990321">]</span><span class="builtintype" id="3990322">byte</span><span class="op" id="3990326">,</span>&nbsp;<span class="op" id="3990328">(</span><span class="ident" id="3990329">ka</span><span class="op" id="3990331">.</span><span class="ident" id="3990332">curve</span><span class="op" id="3990337">.</span><span class="ident" id="3990338">Params</span><span class="op" id="3990344">(</span><span class="op" id="3990345">)</span><span class="op" id="3990346">.</span><span class="ident" id="3990347">BitSize</span><span class="op" id="3990354">+</span><span class="num" id="3990355">7</span><span class="op" id="3990356">)</span><span class="op" id="3990357">&gt;&gt;</span><span class="num" id="3990359">3</span><span class="op" id="3990360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3990363">xBytes</span>&nbsp;<span class="op" id="3990370">:=</span>&nbsp;<span class="ident" id="3990373">x</span><span class="op" id="3990374">.</span><span class="ident" id="3990375">Bytes</span><span class="op" id="3990380">(</span><span class="op" id="3990381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3990384">copy</span><span class="op" id="3990388">(</span><span class="ident" id="3990389">preMasterSecret</span><span class="op" id="3990404">[</span><span class="builtinfunc" id="3990405">len</span><span class="op" id="3990408">(</span><span class="ident" id="3990409">preMasterSecret</span><span class="op" id="3990424">)</span><span class="op" id="3990425">-</span><span class="builtinfunc" id="3990426">len</span><span class="op" id="3990429">(</span><span class="ident" id="3990430">xBytes</span><span class="op" id="3990436">)</span><span class="op" id="3990437">:</span><span class="op" id="3990438">]</span><span class="op" id="3990439">,</span>&nbsp;<span class="ident" id="3990441">xBytes</span><span class="op" id="3990447">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3990451">serialized</span>&nbsp;<span class="op" id="3990462">:=</span>&nbsp;<span class="ident" id="3990465">elliptic</span><span class="op" id="3990473">.</span><span class="ident" id="3990474">Marshal</span><span class="op" id="3990481">(</span><span class="ident" id="3990482">ka</span><span class="op" id="3990484">.</span><span class="ident" id="3990485">curve</span><span class="op" id="3990490">,</span>&nbsp;<span class="ident" id="3990492">mx</span><span class="op" id="3990494">,</span>&nbsp;<span class="ident" id="3990496">my</span><span class="op" id="3990498">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3990502">ckx</span>&nbsp;<span class="op" id="3990506">:=</span>&nbsp;<span class="builtinfunc" id="3990509">new</span><span class="op" id="3990512">(</span><span class="ident" id="3990513">clientKeyExchangeMsg</span><span class="op" id="3990533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3990536">ckx</span><span class="op" id="3990539">.</span><span class="ident" id="3990540">ciphertext</span>&nbsp;<span class="op" id="3990551">=</span>&nbsp;<span class="builtinfunc" id="3990553">make</span><span class="op" id="3990557">(</span><span class="op" id="3990558">[</span><span class="op" id="3990559">]</span><span class="builtintype" id="3990560">byte</span><span class="op" id="3990564">,</span>&nbsp;<span class="num" id="3990566">1</span><span class="op" id="3990567">+</span><span class="builtinfunc" id="3990568">len</span><span class="op" id="3990571">(</span><span class="ident" id="3990572">serialized</span><span class="op" id="3990582">)</span><span class="op" id="3990583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3990586">ckx</span><span class="op" id="3990589">.</span><span class="ident" id="3990590">ciphertext</span><span class="op" id="3990600">[</span><span class="num" id="3990601">0</span><span class="op" id="3990602">]</span>&nbsp;<span class="op" id="3990604">=</span>&nbsp;<span class="builtintype" id="3990606">byte</span><span class="op" id="3990610">(</span><span class="builtinfunc" id="3990611">len</span><span class="op" id="3990614">(</span><span class="ident" id="3990615">serialized</span><span class="op" id="3990625">)</span><span class="op" id="3990626">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3990629">copy</span><span class="op" id="3990633">(</span><span class="ident" id="3990634">ckx</span><span class="op" id="3990637">.</span><span class="ident" id="3990638">ciphertext</span><span class="op" id="3990648">[</span><span class="num" id="3990649">1</span><span class="op" id="3990650">:</span><span class="op" id="3990651">]</span><span class="op" id="3990652">,</span>&nbsp;<span class="ident" id="3990654">serialized</span><span class="op" id="3990664">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3990668">return</span>&nbsp;<span class="ident" id="3990675">preMasterSecret</span><span class="op" id="3990690">,</span>&nbsp;<span class="ident" id="3990692">ckx</span><span class="op" id="3990695">,</span>&nbsp;<span class="ident" id="3990697">nil</span><br>
<span class="lineno"></span><span class="op" id="3990701">}</span>
</div>
</body>
</html>
