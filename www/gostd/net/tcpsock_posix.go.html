<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3734779">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3734835">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3734889">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3734940">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3735018">package</span>&nbsp;<span class="ident" id="3735026">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3735031">import</span>&nbsp;<span class="op" id="3735038">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3735041">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3735047">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3735053">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3735064">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3735071">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="3735074">//&nbsp;BUG(rsc):&nbsp;On&nbsp;OpenBSD,&nbsp;listening&nbsp;on&nbsp;the&nbsp;&#34;tcp&#34;&nbsp;network&nbsp;does&nbsp;not&nbsp;listen&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3735150">//&nbsp;both&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;connections.&nbsp;This&nbsp;is&nbsp;due&nbsp;to&nbsp;the&nbsp;fact&nbsp;that&nbsp;IPv4&nbsp;traffic</span><br>
<span class="lineno"></span><span class="comment" id="3735227">//&nbsp;will&nbsp;not&nbsp;be&nbsp;routed&nbsp;to&nbsp;an&nbsp;IPv6&nbsp;socket&nbsp;-&nbsp;two&nbsp;separate&nbsp;sockets&nbsp;are&nbsp;required</span><br>
<span class="lineno"></span><span class="comment" id="3735303">//&nbsp;if&nbsp;both&nbsp;AFs&nbsp;are&nbsp;to&nbsp;be&nbsp;supported.&nbsp;See&nbsp;inet6(4)&nbsp;on&nbsp;OpenBSD&nbsp;for&nbsp;details.</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3735377">func</span>&nbsp;<span class="ident" id="3735382">sockaddrToTCP</span><span class="op" id="3735395">(</span><span class="ident" id="3735396">sa</span>&nbsp;<span class="ident" id="3735399">syscall</span><span class="op" id="3735406">.</span><span class="ident" id="3735407">Sockaddr</span><span class="op" id="3735415">)</span>&nbsp;<span class="ident" id="3735417">Addr</span>&nbsp;<span class="op" id="3735422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735425">switch</span>&nbsp;<span class="ident" id="3735432">sa</span>&nbsp;<span class="op" id="3735435">:=</span>&nbsp;<span class="ident" id="3735438">sa</span><span class="op" id="3735440">.</span><span class="op" id="3735441">(</span><span class="keyword" id="3735442">type</span><span class="op" id="3735446">)</span>&nbsp;<span class="op" id="3735448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735451">case</span>&nbsp;<span class="op" id="3735456">*</span><span class="ident" id="3735457">syscall</span><span class="op" id="3735464">.</span><span class="ident" id="3735465">SockaddrInet4</span><span class="op" id="3735478">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735482">return</span>&nbsp;<span class="op" id="3735489">&amp;</span><span class="ident" id="3735490">TCPAddr</span><span class="op" id="3735497">{</span><span class="ident" id="3735498">IP</span><span class="op" id="3735500">:</span>&nbsp;<span class="ident" id="3735502">sa</span><span class="op" id="3735504">.</span><span class="ident" id="3735505">Addr</span><span class="op" id="3735509">[</span><span class="num" id="3735510">0</span><span class="op" id="3735511">:</span><span class="op" id="3735512">]</span><span class="op" id="3735513">,</span>&nbsp;<span class="ident" id="3735515">Port</span><span class="op" id="3735519">:</span>&nbsp;<span class="ident" id="3735521">sa</span><span class="op" id="3735523">.</span><span class="ident" id="3735524">Port</span><span class="op" id="3735528">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735531">case</span>&nbsp;<span class="op" id="3735536">*</span><span class="ident" id="3735537">syscall</span><span class="op" id="3735544">.</span><span class="ident" id="3735545">SockaddrInet6</span><span class="op" id="3735558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735562">return</span>&nbsp;<span class="op" id="3735569">&amp;</span><span class="ident" id="3735570">TCPAddr</span><span class="op" id="3735577">{</span><span class="ident" id="3735578">IP</span><span class="op" id="3735580">:</span>&nbsp;<span class="ident" id="3735582">sa</span><span class="op" id="3735584">.</span><span class="ident" id="3735585">Addr</span><span class="op" id="3735589">[</span><span class="num" id="3735590">0</span><span class="op" id="3735591">:</span><span class="op" id="3735592">]</span><span class="op" id="3735593">,</span>&nbsp;<span class="ident" id="3735595">Port</span><span class="op" id="3735599">:</span>&nbsp;<span class="ident" id="3735601">sa</span><span class="op" id="3735603">.</span><span class="ident" id="3735604">Port</span><span class="op" id="3735608">,</span>&nbsp;<span class="ident" id="3735610">Zone</span><span class="op" id="3735614">:</span>&nbsp;<span class="ident" id="3735616">zoneToString</span><span class="op" id="3735628">(</span><span class="builtintype" id="3735629">int</span><span class="op" id="3735632">(</span><span class="ident" id="3735633">sa</span><span class="op" id="3735635">.</span><span class="ident" id="3735636">ZoneId</span><span class="op" id="3735642">)</span><span class="op" id="3735643">)</span><span class="op" id="3735644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735650">return</span>&nbsp;<span class="ident" id="3735657">nil</span><br>
<span class="lineno"></span><span class="op" id="3735661">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="3735664">func</span>&nbsp;<span class="op" id="3735669">(</span><span class="ident" id="3735670">a</span>&nbsp;<span class="op" id="3735672">*</span><span class="ident" id="3735673">TCPAddr</span><span class="op" id="3735680">)</span>&nbsp;<span class="ident" id="3735682">family</span><span class="op" id="3735688">(</span><span class="op" id="3735689">)</span>&nbsp;<span class="builtintype" id="3735691">int</span>&nbsp;<span class="op" id="3735695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735698">if</span>&nbsp;<span class="ident" id="3735701">a</span>&nbsp;<span class="op" id="3735703">==</span>&nbsp;<span class="ident" id="3735706">nil</span>&nbsp;<span class="op" id="3735710">||</span>&nbsp;<span class="builtinfunc" id="3735713">len</span><span class="op" id="3735716">(</span><span class="ident" id="3735717">a</span><span class="op" id="3735718">.</span><span class="ident" id="3735719">IP</span><span class="op" id="3735721">)</span>&nbsp;<span class="op" id="3735723">&lt;=</span>&nbsp;<span class="ident" id="3735726">IPv4len</span>&nbsp;<span class="op" id="3735734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735738">return</span>&nbsp;<span class="ident" id="3735745">syscall</span><span class="op" id="3735752">.</span><span class="ident" id="3735753">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735762">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735765">if</span>&nbsp;<span class="ident" id="3735768">a</span><span class="op" id="3735769">.</span><span class="ident" id="3735770">IP</span><span class="op" id="3735772">.</span><span class="ident" id="3735773">To4</span><span class="op" id="3735776">(</span><span class="op" id="3735777">)</span>&nbsp;<span class="op" id="3735779">!=</span>&nbsp;<span class="ident" id="3735782">nil</span>&nbsp;<span class="op" id="3735786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735790">return</span>&nbsp;<span class="ident" id="3735797">syscall</span><span class="op" id="3735804">.</span><span class="ident" id="3735805">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735817">return</span>&nbsp;<span class="ident" id="3735824">syscall</span><span class="op" id="3735831">.</span><span class="ident" id="3735832">AF_INET6</span><br>
<span class="lineno"></span><span class="op" id="3735841">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3735844">func</span>&nbsp;<span class="op" id="3735849">(</span><span class="ident" id="3735850">a</span>&nbsp;<span class="op" id="3735852">*</span><span class="ident" id="3735853">TCPAddr</span><span class="op" id="3735860">)</span>&nbsp;<span class="ident" id="3735862">isWildcard</span><span class="op" id="3735872">(</span><span class="op" id="3735873">)</span>&nbsp;<span class="builtintype" id="3735875">bool</span>&nbsp;<span class="op" id="3735880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735883">if</span>&nbsp;<span class="ident" id="3735886">a</span>&nbsp;<span class="op" id="3735888">==</span>&nbsp;<span class="ident" id="3735891">nil</span>&nbsp;<span class="op" id="3735895">||</span>&nbsp;<span class="ident" id="3735898">a</span><span class="op" id="3735899">.</span><span class="ident" id="3735900">IP</span>&nbsp;<span class="op" id="3735903">==</span>&nbsp;<span class="ident" id="3735906">nil</span>&nbsp;<span class="op" id="3735910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735914">return</span>&nbsp;<span class="builtintype" id="3735921">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735927">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735930">return</span>&nbsp;<span class="ident" id="3735937">a</span><span class="op" id="3735938">.</span><span class="ident" id="3735939">IP</span><span class="op" id="3735941">.</span><span class="ident" id="3735942">IsUnspecified</span><span class="op" id="3735955">(</span><span class="op" id="3735956">)</span><br>
<span class="lineno"></span><span class="op" id="3735958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3735961">func</span>&nbsp;<span class="op" id="3735966">(</span><span class="ident" id="3735967">a</span>&nbsp;<span class="op" id="3735969">*</span><span class="ident" id="3735970">TCPAddr</span><span class="op" id="3735977">)</span>&nbsp;<span class="ident" id="3735979">sockaddr</span><span class="op" id="3735987">(</span><span class="ident" id="3735988">family</span>&nbsp;<span class="builtintype" id="3735995">int</span><span class="op" id="3735998">)</span>&nbsp;<span class="op" id="3736000">(</span><span class="ident" id="3736001">syscall</span><span class="op" id="3736008">.</span><span class="ident" id="3736009">Sockaddr</span><span class="op" id="3736017">,</span>&nbsp;<span class="builtintype" id="3736019">error</span><span class="op" id="3736024">)</span>&nbsp;<span class="op" id="3736026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736029">if</span>&nbsp;<span class="ident" id="3736032">a</span>&nbsp;<span class="op" id="3736034">==</span>&nbsp;<span class="ident" id="3736037">nil</span>&nbsp;<span class="op" id="3736041">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736045">return</span>&nbsp;<span class="ident" id="3736052">nil</span><span class="op" id="3736055">,</span>&nbsp;<span class="ident" id="3736057">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3736062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736065">return</span>&nbsp;<span class="ident" id="3736072">ipToSockaddr</span><span class="op" id="3736084">(</span><span class="ident" id="3736085">family</span><span class="op" id="3736091">,</span>&nbsp;<span class="ident" id="3736093">a</span><span class="op" id="3736094">.</span><span class="ident" id="3736095">IP</span><span class="op" id="3736097">,</span>&nbsp;<span class="ident" id="3736099">a</span><span class="op" id="3736100">.</span><span class="ident" id="3736101">Port</span><span class="op" id="3736105">,</span>&nbsp;<span class="ident" id="3736107">a</span><span class="op" id="3736108">.</span><span class="ident" id="3736109">Zone</span><span class="op" id="3736113">)</span><br>
<span class="lineno"></span><span class="op" id="3736115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3736118">//&nbsp;TCPConn&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Conn&nbsp;interface&nbsp;for&nbsp;TCP&nbsp;network</span><br>
<span class="lineno"></span><span class="comment" id="3736188">//&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3736204">type</span>&nbsp;<span class="ident" id="3736209">TCPConn</span>&nbsp;<span class="keyword" id="3736217">struct</span>&nbsp;<span class="op" id="3736224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736227">conn</span><br>
<span class="lineno"></span><span class="op" id="3736232">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="3736235">func</span>&nbsp;<span class="ident" id="3736240">newTCPConn</span><span class="op" id="3736250">(</span><span class="ident" id="3736251">fd</span>&nbsp;<span class="op" id="3736254">*</span><span class="ident" id="3736255">netFD</span><span class="op" id="3736260">)</span>&nbsp;<span class="op" id="3736262">*</span><span class="ident" id="3736263">TCPConn</span>&nbsp;<span class="op" id="3736271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736274">c</span>&nbsp;<span class="op" id="3736276">:=</span>&nbsp;<span class="op" id="3736279">&amp;</span><span class="ident" id="3736280">TCPConn</span><span class="op" id="3736287">{</span><span class="ident" id="3736288">conn</span><span class="op" id="3736292">{</span><span class="ident" id="3736293">fd</span><span class="op" id="3736295">}</span><span class="op" id="3736296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736299">c</span><span class="op" id="3736300">.</span><span class="ident" id="3736301">SetNoDelay</span><span class="op" id="3736311">(</span><span class="builtintype" id="3736312">true</span><span class="op" id="3736316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736319">return</span>&nbsp;<span class="ident" id="3736326">c</span><br>
<span class="lineno">65</span><span class="op" id="3736328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3736331">//&nbsp;ReadFrom&nbsp;implements&nbsp;the&nbsp;io.ReaderFrom&nbsp;ReadFrom&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="3736389">func</span>&nbsp;<span class="op" id="3736394">(</span><span class="ident" id="3736395">c</span>&nbsp;<span class="op" id="3736397">*</span><span class="ident" id="3736398">TCPConn</span><span class="op" id="3736405">)</span>&nbsp;<span class="ident" id="3736407">ReadFrom</span><span class="op" id="3736415">(</span><span class="ident" id="3736416">r</span>&nbsp;<span class="ident" id="3736418">io</span><span class="op" id="3736420">.</span><span class="ident" id="3736421">Reader</span><span class="op" id="3736427">)</span>&nbsp;<span class="op" id="3736429">(</span><span class="ident" id="3736430">int64</span><span class="op" id="3736435">,</span>&nbsp;<span class="builtintype" id="3736437">error</span><span class="op" id="3736442">)</span>&nbsp;<span class="op" id="3736444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736447">if</span>&nbsp;<span class="ident" id="3736450">n</span><span class="op" id="3736451">,</span>&nbsp;<span class="ident" id="3736453">err</span><span class="op" id="3736456">,</span>&nbsp;<span class="ident" id="3736458">handled</span>&nbsp;<span class="op" id="3736466">:=</span>&nbsp;<span class="ident" id="3736469">sendFile</span><span class="op" id="3736477">(</span><span class="ident" id="3736478">c</span><span class="op" id="3736479">.</span><span class="ident" id="3736480">fd</span><span class="op" id="3736482">,</span>&nbsp;<span class="ident" id="3736484">r</span><span class="op" id="3736485">)</span><span class="op" id="3736486">;</span>&nbsp;<span class="ident" id="3736488">handled</span>&nbsp;<span class="op" id="3736496">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736500">return</span>&nbsp;<span class="ident" id="3736507">n</span><span class="op" id="3736508">,</span>&nbsp;<span class="ident" id="3736510">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3736515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736518">return</span>&nbsp;<span class="ident" id="3736525">genericReadFrom</span><span class="op" id="3736540">(</span><span class="ident" id="3736541">c</span><span class="op" id="3736542">,</span>&nbsp;<span class="ident" id="3736544">r</span><span class="op" id="3736545">)</span><br>
<span class="lineno"></span><span class="op" id="3736547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3736550">//&nbsp;CloseRead&nbsp;shuts&nbsp;down&nbsp;the&nbsp;reading&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3736614">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3736653">func</span>&nbsp;<span class="op" id="3736658">(</span><span class="ident" id="3736659">c</span>&nbsp;<span class="op" id="3736661">*</span><span class="ident" id="3736662">TCPConn</span><span class="op" id="3736669">)</span>&nbsp;<span class="ident" id="3736671">CloseRead</span><span class="op" id="3736680">(</span><span class="op" id="3736681">)</span>&nbsp;<span class="builtintype" id="3736683">error</span>&nbsp;<span class="op" id="3736689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736692">if</span>&nbsp;<span class="op" id="3736695">!</span><span class="ident" id="3736696">c</span><span class="op" id="3736697">.</span><span class="ident" id="3736698">ok</span><span class="op" id="3736700">(</span><span class="op" id="3736701">)</span>&nbsp;<span class="op" id="3736703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736707">return</span>&nbsp;<span class="ident" id="3736714">syscall</span><span class="op" id="3736721">.</span><span class="ident" id="3736722">EINVAL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3736730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736733">return</span>&nbsp;<span class="ident" id="3736740">c</span><span class="op" id="3736741">.</span><span class="ident" id="3736742">fd</span><span class="op" id="3736744">.</span><span class="ident" id="3736745">closeRead</span><span class="op" id="3736754">(</span><span class="op" id="3736755">)</span><br>
<span class="lineno"></span><span class="op" id="3736757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3736760">//&nbsp;CloseWrite&nbsp;shuts&nbsp;down&nbsp;the&nbsp;writing&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno">85</span><span class="comment" id="3736825">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3736864">func</span>&nbsp;<span class="op" id="3736869">(</span><span class="ident" id="3736870">c</span>&nbsp;<span class="op" id="3736872">*</span><span class="ident" id="3736873">TCPConn</span><span class="op" id="3736880">)</span>&nbsp;<span class="ident" id="3736882">CloseWrite</span><span class="op" id="3736892">(</span><span class="op" id="3736893">)</span>&nbsp;<span class="builtintype" id="3736895">error</span>&nbsp;<span class="op" id="3736901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736904">if</span>&nbsp;<span class="op" id="3736907">!</span><span class="ident" id="3736908">c</span><span class="op" id="3736909">.</span><span class="ident" id="3736910">ok</span><span class="op" id="3736912">(</span><span class="op" id="3736913">)</span>&nbsp;<span class="op" id="3736915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736919">return</span>&nbsp;<span class="ident" id="3736926">syscall</span><span class="op" id="3736933">.</span><span class="ident" id="3736934">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3736942">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736945">return</span>&nbsp;<span class="ident" id="3736952">c</span><span class="op" id="3736953">.</span><span class="ident" id="3736954">fd</span><span class="op" id="3736956">.</span><span class="ident" id="3736957">closeWrite</span><span class="op" id="3736967">(</span><span class="op" id="3736968">)</span><br>
<span class="lineno"></span><span class="op" id="3736970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3736973">//&nbsp;SetLinger&nbsp;sets&nbsp;the&nbsp;behavior&nbsp;of&nbsp;Close&nbsp;on&nbsp;a&nbsp;connection&nbsp;which&nbsp;still</span><br>
<span class="lineno"></span><span class="comment" id="3737041">//&nbsp;has&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;sent&nbsp;or&nbsp;to&nbsp;be&nbsp;acknowledged.</span><br>
<span class="lineno">95</span><span class="comment" id="3737095">//</span><br>
<span class="lineno"></span><span class="comment" id="3737098">//&nbsp;If&nbsp;sec&nbsp;&lt;&nbsp;0&nbsp;(the&nbsp;default),&nbsp;the&nbsp;operating&nbsp;system&nbsp;finishes&nbsp;sending&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3737169">//&nbsp;data&nbsp;in&nbsp;the&nbsp;background.</span><br>
<span class="lineno"></span><span class="comment" id="3737196">//</span><br>
<span class="lineno"></span><span class="comment" id="3737199">//&nbsp;If&nbsp;sec&nbsp;==&nbsp;0,&nbsp;the&nbsp;operating&nbsp;system&nbsp;discards&nbsp;any&nbsp;unsent&nbsp;or</span><br>
<span class="lineno">100</span><span class="comment" id="3737259">//&nbsp;unacknowledged&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3737283">//</span><br>
<span class="lineno"></span><span class="comment" id="3737286">//&nbsp;If&nbsp;sec&nbsp;&gt;&nbsp;0,&nbsp;the&nbsp;data&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;background&nbsp;as&nbsp;with&nbsp;sec&nbsp;&lt;&nbsp;0.&nbsp;On</span><br>
<span class="lineno"></span><span class="comment" id="3737356">//&nbsp;some&nbsp;operating&nbsp;systems&nbsp;after&nbsp;sec&nbsp;seconds&nbsp;have&nbsp;elapsed&nbsp;any&nbsp;remaining</span><br>
<span class="lineno"></span><span class="comment" id="3737427">//&nbsp;unsent&nbsp;data&nbsp;may&nbsp;be&nbsp;discarded.</span><br>
<span class="lineno">105</span><span class="keyword" id="3737460">func</span>&nbsp;<span class="op" id="3737465">(</span><span class="ident" id="3737466">c</span>&nbsp;<span class="op" id="3737468">*</span><span class="ident" id="3737469">TCPConn</span><span class="op" id="3737476">)</span>&nbsp;<span class="ident" id="3737478">SetLinger</span><span class="op" id="3737487">(</span><span class="ident" id="3737488">sec</span>&nbsp;<span class="builtintype" id="3737492">int</span><span class="op" id="3737495">)</span>&nbsp;<span class="builtintype" id="3737497">error</span>&nbsp;<span class="op" id="3737503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737506">if</span>&nbsp;<span class="op" id="3737509">!</span><span class="ident" id="3737510">c</span><span class="op" id="3737511">.</span><span class="ident" id="3737512">ok</span><span class="op" id="3737514">(</span><span class="op" id="3737515">)</span>&nbsp;<span class="op" id="3737517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737521">return</span>&nbsp;<span class="ident" id="3737528">syscall</span><span class="op" id="3737535">.</span><span class="ident" id="3737536">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3737544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737547">return</span>&nbsp;<span class="ident" id="3737554">setLinger</span><span class="op" id="3737563">(</span><span class="ident" id="3737564">c</span><span class="op" id="3737565">.</span><span class="ident" id="3737566">fd</span><span class="op" id="3737568">,</span>&nbsp;<span class="ident" id="3737570">sec</span><span class="op" id="3737573">)</span><br>
<span class="lineno">110</span><span class="op" id="3737575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3737578">//&nbsp;SetKeepAlive&nbsp;sets&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;send</span><br>
<span class="lineno"></span><span class="comment" id="3737640">//&nbsp;keepalive&nbsp;messages&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3737681">func</span>&nbsp;<span class="op" id="3737686">(</span><span class="ident" id="3737687">c</span>&nbsp;<span class="op" id="3737689">*</span><span class="ident" id="3737690">TCPConn</span><span class="op" id="3737697">)</span>&nbsp;<span class="ident" id="3737699">SetKeepAlive</span><span class="op" id="3737711">(</span><span class="ident" id="3737712">keepalive</span>&nbsp;<span class="builtintype" id="3737722">bool</span><span class="op" id="3737726">)</span>&nbsp;<span class="builtintype" id="3737728">error</span>&nbsp;<span class="op" id="3737734">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737737">if</span>&nbsp;<span class="op" id="3737740">!</span><span class="ident" id="3737741">c</span><span class="op" id="3737742">.</span><span class="ident" id="3737743">ok</span><span class="op" id="3737745">(</span><span class="op" id="3737746">)</span>&nbsp;<span class="op" id="3737748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737752">return</span>&nbsp;<span class="ident" id="3737759">syscall</span><span class="op" id="3737766">.</span><span class="ident" id="3737767">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3737775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737778">return</span>&nbsp;<span class="ident" id="3737785">setKeepAlive</span><span class="op" id="3737797">(</span><span class="ident" id="3737798">c</span><span class="op" id="3737799">.</span><span class="ident" id="3737800">fd</span><span class="op" id="3737802">,</span>&nbsp;<span class="ident" id="3737804">keepalive</span><span class="op" id="3737813">)</span><br>
<span class="lineno"></span><span class="op" id="3737815">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="3737818">//&nbsp;SetKeepAlivePeriod&nbsp;sets&nbsp;period&nbsp;between&nbsp;keep&nbsp;alives.</span><br>
<span class="lineno"></span><span class="keyword" id="3737873">func</span>&nbsp;<span class="op" id="3737878">(</span><span class="ident" id="3737879">c</span>&nbsp;<span class="op" id="3737881">*</span><span class="ident" id="3737882">TCPConn</span><span class="op" id="3737889">)</span>&nbsp;<span class="ident" id="3737891">SetKeepAlivePeriod</span><span class="op" id="3737909">(</span><span class="ident" id="3737910">d</span>&nbsp;<span class="ident" id="3737912">time</span><span class="op" id="3737916">.</span><span class="ident" id="3737917">Duration</span><span class="op" id="3737925">)</span>&nbsp;<span class="builtintype" id="3737927">error</span>&nbsp;<span class="op" id="3737933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737936">if</span>&nbsp;<span class="op" id="3737939">!</span><span class="ident" id="3737940">c</span><span class="op" id="3737941">.</span><span class="ident" id="3737942">ok</span><span class="op" id="3737944">(</span><span class="op" id="3737945">)</span>&nbsp;<span class="op" id="3737947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737951">return</span>&nbsp;<span class="ident" id="3737958">syscall</span><span class="op" id="3737965">.</span><span class="ident" id="3737966">EINVAL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3737974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737977">return</span>&nbsp;<span class="ident" id="3737984">setKeepAlivePeriod</span><span class="op" id="3738002">(</span><span class="ident" id="3738003">c</span><span class="op" id="3738004">.</span><span class="ident" id="3738005">fd</span><span class="op" id="3738007">,</span>&nbsp;<span class="ident" id="3738009">d</span><span class="op" id="3738010">)</span><br>
<span class="lineno"></span><span class="op" id="3738012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3738015">//&nbsp;SetNoDelay&nbsp;controls&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;delay</span><br>
<span class="lineno">130</span><span class="comment" id="3738080">//&nbsp;packet&nbsp;transmission&nbsp;in&nbsp;hopes&nbsp;of&nbsp;sending&nbsp;fewer&nbsp;packets&nbsp;(Nagle&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3738146">//&nbsp;algorithm).&nbsp;&nbsp;The&nbsp;default&nbsp;is&nbsp;true&nbsp;(no&nbsp;delay),&nbsp;meaning&nbsp;that&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3738215">//&nbsp;sent&nbsp;as&nbsp;soon&nbsp;as&nbsp;possible&nbsp;after&nbsp;a&nbsp;Write.</span><br>
<span class="lineno"></span><span class="keyword" id="3738258">func</span>&nbsp;<span class="op" id="3738263">(</span><span class="ident" id="3738264">c</span>&nbsp;<span class="op" id="3738266">*</span><span class="ident" id="3738267">TCPConn</span><span class="op" id="3738274">)</span>&nbsp;<span class="ident" id="3738276">SetNoDelay</span><span class="op" id="3738286">(</span><span class="ident" id="3738287">noDelay</span>&nbsp;<span class="builtintype" id="3738295">bool</span><span class="op" id="3738299">)</span>&nbsp;<span class="builtintype" id="3738301">error</span>&nbsp;<span class="op" id="3738307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738310">if</span>&nbsp;<span class="op" id="3738313">!</span><span class="ident" id="3738314">c</span><span class="op" id="3738315">.</span><span class="ident" id="3738316">ok</span><span class="op" id="3738318">(</span><span class="op" id="3738319">)</span>&nbsp;<span class="op" id="3738321">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738325">return</span>&nbsp;<span class="ident" id="3738332">syscall</span><span class="op" id="3738339">.</span><span class="ident" id="3738340">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3738348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738351">return</span>&nbsp;<span class="ident" id="3738358">setNoDelay</span><span class="op" id="3738368">(</span><span class="ident" id="3738369">c</span><span class="op" id="3738370">.</span><span class="ident" id="3738371">fd</span><span class="op" id="3738373">,</span>&nbsp;<span class="ident" id="3738375">noDelay</span><span class="op" id="3738382">)</span><br>
<span class="lineno"></span><span class="op" id="3738384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3738387">//&nbsp;DialTCP&nbsp;connects&nbsp;to&nbsp;the&nbsp;remote&nbsp;address&nbsp;raddr&nbsp;on&nbsp;the&nbsp;network&nbsp;net,</span><br>
<span class="lineno"></span><span class="comment" id="3738455">//&nbsp;which&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;is&nbsp;not&nbsp;nil,&nbsp;it&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3738526">//&nbsp;used&nbsp;as&nbsp;the&nbsp;local&nbsp;address&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3738575">func</span>&nbsp;<span class="ident" id="3738580">DialTCP</span><span class="op" id="3738587">(</span><span class="ident" id="3738588">net</span>&nbsp;<span class="builtintype" id="3738592">string</span><span class="op" id="3738598">,</span>&nbsp;<span class="ident" id="3738600">laddr</span><span class="op" id="3738605">,</span>&nbsp;<span class="ident" id="3738607">raddr</span>&nbsp;<span class="op" id="3738613">*</span><span class="ident" id="3738614">TCPAddr</span><span class="op" id="3738621">)</span>&nbsp;<span class="op" id="3738623">(</span><span class="op" id="3738624">*</span><span class="ident" id="3738625">TCPConn</span><span class="op" id="3738632">,</span>&nbsp;<span class="builtintype" id="3738634">error</span><span class="op" id="3738639">)</span>&nbsp;<span class="op" id="3738641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738644">switch</span>&nbsp;<span class="ident" id="3738651">net</span>&nbsp;<span class="op" id="3738655">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738658">case</span>&nbsp;<span class="string" id="3738663">&#34;tcp&#34;</span><span class="op" id="3738668">,</span>&nbsp;<span class="string" id="3738670">&#34;tcp4&#34;</span><span class="op" id="3738676">,</span>&nbsp;<span class="string" id="3738678">&#34;tcp6&#34;</span><span class="op" id="3738684">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738687">default</span><span class="op" id="3738694">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738698">return</span>&nbsp;<span class="ident" id="3738705">nil</span><span class="op" id="3738708">,</span>&nbsp;<span class="op" id="3738710">&amp;</span><span class="ident" id="3738711">OpError</span><span class="op" id="3738718">{</span><span class="ident" id="3738719">Op</span><span class="op" id="3738721">:</span>&nbsp;<span class="string" id="3738723">&#34;dial&#34;</span><span class="op" id="3738729">,</span>&nbsp;<span class="ident" id="3738731">Net</span><span class="op" id="3738734">:</span>&nbsp;<span class="ident" id="3738736">net</span><span class="op" id="3738739">,</span>&nbsp;<span class="ident" id="3738741">Addr</span><span class="op" id="3738745">:</span>&nbsp;<span class="ident" id="3738747">raddr</span><span class="op" id="3738752">,</span>&nbsp;<span class="ident" id="3738754">Err</span><span class="op" id="3738757">:</span>&nbsp;<span class="ident" id="3738759">UnknownNetworkError</span><span class="op" id="3738778">(</span><span class="ident" id="3738779">net</span><span class="op" id="3738782">)</span><span class="op" id="3738783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3738786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738789">if</span>&nbsp;<span class="ident" id="3738792">raddr</span>&nbsp;<span class="op" id="3738798">==</span>&nbsp;<span class="ident" id="3738801">nil</span>&nbsp;<span class="op" id="3738805">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738809">return</span>&nbsp;<span class="ident" id="3738816">nil</span><span class="op" id="3738819">,</span>&nbsp;<span class="op" id="3738821">&amp;</span><span class="ident" id="3738822">OpError</span><span class="op" id="3738829">{</span><span class="ident" id="3738830">Op</span><span class="op" id="3738832">:</span>&nbsp;<span class="string" id="3738834">&#34;dial&#34;</span><span class="op" id="3738840">,</span>&nbsp;<span class="ident" id="3738842">Net</span><span class="op" id="3738845">:</span>&nbsp;<span class="ident" id="3738847">net</span><span class="op" id="3738850">,</span>&nbsp;<span class="ident" id="3738852">Addr</span><span class="op" id="3738856">:</span>&nbsp;<span class="ident" id="3738858">nil</span><span class="op" id="3738861">,</span>&nbsp;<span class="ident" id="3738863">Err</span><span class="op" id="3738866">:</span>&nbsp;<span class="ident" id="3738868">errMissingAddress</span><span class="op" id="3738885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3738888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738891">return</span>&nbsp;<span class="ident" id="3738898">dialTCP</span><span class="op" id="3738905">(</span><span class="ident" id="3738906">net</span><span class="op" id="3738909">,</span>&nbsp;<span class="ident" id="3738911">laddr</span><span class="op" id="3738916">,</span>&nbsp;<span class="ident" id="3738918">raddr</span><span class="op" id="3738923">,</span>&nbsp;<span class="ident" id="3738925">noDeadline</span><span class="op" id="3738935">)</span><br>
<span class="lineno"></span><span class="op" id="3738937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="keyword" id="3738940">func</span>&nbsp;<span class="ident" id="3738945">dialTCP</span><span class="op" id="3738952">(</span><span class="ident" id="3738953">net</span>&nbsp;<span class="builtintype" id="3738957">string</span><span class="op" id="3738963">,</span>&nbsp;<span class="ident" id="3738965">laddr</span><span class="op" id="3738970">,</span>&nbsp;<span class="ident" id="3738972">raddr</span>&nbsp;<span class="op" id="3738978">*</span><span class="ident" id="3738979">TCPAddr</span><span class="op" id="3738986">,</span>&nbsp;<span class="ident" id="3738988">deadline</span>&nbsp;<span class="ident" id="3738997">time</span><span class="op" id="3739001">.</span><span class="ident" id="3739002">Time</span><span class="op" id="3739006">)</span>&nbsp;<span class="op" id="3739008">(</span><span class="op" id="3739009">*</span><span class="ident" id="3739010">TCPConn</span><span class="op" id="3739017">,</span>&nbsp;<span class="builtintype" id="3739019">error</span><span class="op" id="3739024">)</span>&nbsp;<span class="op" id="3739026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739029">fd</span><span class="op" id="3739031">,</span>&nbsp;<span class="ident" id="3739033">err</span>&nbsp;<span class="op" id="3739037">:=</span>&nbsp;<span class="ident" id="3739040">internetSocket</span><span class="op" id="3739054">(</span><span class="ident" id="3739055">net</span><span class="op" id="3739058">,</span>&nbsp;<span class="ident" id="3739060">laddr</span><span class="op" id="3739065">,</span>&nbsp;<span class="ident" id="3739067">raddr</span><span class="op" id="3739072">,</span>&nbsp;<span class="ident" id="3739074">deadline</span><span class="op" id="3739082">,</span>&nbsp;<span class="ident" id="3739084">syscall</span><span class="op" id="3739091">.</span><span class="ident" id="3739092">SOCK_STREAM</span><span class="op" id="3739103">,</span>&nbsp;<span class="num" id="3739105">0</span><span class="op" id="3739106">,</span>&nbsp;<span class="string" id="3739108">&#34;dial&#34;</span><span class="op" id="3739114">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739118">//&nbsp;TCP&nbsp;has&nbsp;a&nbsp;rarely&nbsp;used&nbsp;mechanism&nbsp;called&nbsp;a&nbsp;&#39;simultaneous&nbsp;connection&#39;&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739192">//&nbsp;which&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr1,&nbsp;addr2)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine&nbsp;at&nbsp;addr1&nbsp;can</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739260">//&nbsp;connect&nbsp;to&nbsp;a&nbsp;simultaneous&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr2,&nbsp;addr1)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739335">//&nbsp;at&nbsp;addr2,&nbsp;without&nbsp;either&nbsp;machine&nbsp;executing&nbsp;Listen.&nbsp;&nbsp;If&nbsp;laddr&nbsp;==&nbsp;nil,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739408">//&nbsp;it&nbsp;means&nbsp;we&nbsp;want&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate&nbsp;originating&nbsp;local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739481">//&nbsp;address.&nbsp;&nbsp;Some&nbsp;Linux&nbsp;kernels&nbsp;cycle&nbsp;blindly&nbsp;through&nbsp;a&nbsp;fixed&nbsp;range&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739553">//&nbsp;local&nbsp;ports,&nbsp;regardless&nbsp;of&nbsp;destination&nbsp;port.&nbsp;&nbsp;If&nbsp;a&nbsp;kernel&nbsp;happens&nbsp;to</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739626">//&nbsp;pick&nbsp;local&nbsp;port&nbsp;50001&nbsp;as&nbsp;the&nbsp;source&nbsp;for&nbsp;a&nbsp;Dial(&#34;tcp&#34;,&nbsp;&#34;&#34;,&nbsp;&#34;localhost:50001&#34;),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739708">//&nbsp;then&nbsp;the&nbsp;Dial&nbsp;will&nbsp;succeed,&nbsp;having&nbsp;simultaneously&nbsp;connected&nbsp;to&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739783">//&nbsp;This&nbsp;can&nbsp;only&nbsp;happen&nbsp;when&nbsp;we&nbsp;are&nbsp;letting&nbsp;the&nbsp;kernel&nbsp;pick&nbsp;a&nbsp;port&nbsp;(laddr&nbsp;==&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739866">//&nbsp;and&nbsp;when&nbsp;there&nbsp;is&nbsp;no&nbsp;listener&nbsp;for&nbsp;the&nbsp;destination&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739929">//&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;argue&nbsp;this&nbsp;is&nbsp;anything&nbsp;other&nbsp;than&nbsp;a&nbsp;kernel&nbsp;bug.&nbsp;&nbsp;If&nbsp;we</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3740001">//&nbsp;see&nbsp;this&nbsp;happen,&nbsp;rather&nbsp;than&nbsp;expose&nbsp;the&nbsp;buggy&nbsp;effect&nbsp;to&nbsp;users,&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3740071">//&nbsp;close&nbsp;the&nbsp;fd&nbsp;and&nbsp;try&nbsp;again.&nbsp;&nbsp;If&nbsp;it&nbsp;happens&nbsp;twice&nbsp;more,&nbsp;we&nbsp;relent&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3740144">//&nbsp;use&nbsp;the&nbsp;result.&nbsp;&nbsp;See&nbsp;also:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3740175">//&nbsp;&nbsp;&nbsp;&nbsphttp://golang.org/issue/2690</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3740208">//&nbsp;&nbsp;&nbsp;&nbsphttp://stackoverflow.com/questions/4949858/</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3740256">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3740260">//&nbsp;The&nbsp;opposite&nbsp;can&nbsp;also&nbsp;happen:&nbsp;if&nbsp;we&nbsp;ask&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3740338">//&nbsp;originating&nbsp;local&nbsp;address,&nbsp;sometimes&nbsp;it&nbsp;picks&nbsp;one&nbsp;that&nbsp;is&nbsp;already&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3740416">//&nbsp;So&nbsp;if&nbsp;the&nbsp;error&nbsp;is&nbsp;EADDRNOTAVAIL,&nbsp;we&nbsp;have&nbsp;to&nbsp;try&nbsp;again&nbsp;too,&nbsp;just&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3740489">//&nbsp;a&nbsp;different&nbsp;reason.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3740513">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3740517">//&nbsp;The&nbsp;kernel&nbsp;socket&nbsp;code&nbsp;is&nbsp;no&nbsp;doubt&nbsp;enjoying&nbsp;watching&nbsp;us&nbsp;squirm.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740585">for</span>&nbsp;<span class="ident" id="3740589">i</span>&nbsp;<span class="op" id="3740591">:=</span>&nbsp;<span class="num" id="3740594">0</span><span class="op" id="3740595">;</span>&nbsp;<span class="ident" id="3740597">i</span>&nbsp;<span class="op" id="3740599">&lt;</span>&nbsp;<span class="num" id="3740601">2</span>&nbsp;<span class="op" id="3740603">&amp;&amp;</span>&nbsp;<span class="op" id="3740606">(</span><span class="ident" id="3740607">laddr</span>&nbsp;<span class="op" id="3740613">==</span>&nbsp;<span class="ident" id="3740616">nil</span>&nbsp;<span class="op" id="3740620">||</span>&nbsp;<span class="ident" id="3740623">laddr</span><span class="op" id="3740628">.</span><span class="ident" id="3740629">Port</span>&nbsp;<span class="op" id="3740634">==</span>&nbsp;<span class="num" id="3740637">0</span><span class="op" id="3740638">)</span>&nbsp;<span class="op" id="3740640">&amp;&amp;</span>&nbsp;<span class="op" id="3740643">(</span><span class="ident" id="3740644">selfConnect</span><span class="op" id="3740655">(</span><span class="ident" id="3740656">fd</span><span class="op" id="3740658">,</span>&nbsp;<span class="ident" id="3740660">err</span><span class="op" id="3740663">)</span>&nbsp;<span class="op" id="3740665">||</span>&nbsp;<span class="ident" id="3740668">spuriousENOTAVAIL</span><span class="op" id="3740685">(</span><span class="ident" id="3740686">err</span><span class="op" id="3740689">)</span><span class="op" id="3740690">)</span><span class="op" id="3740691">;</span>&nbsp;<span class="ident" id="3740693">i</span><span class="op" id="3740694">++</span>&nbsp;<span class="op" id="3740697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740701">if</span>&nbsp;<span class="ident" id="3740704">err</span>&nbsp;<span class="op" id="3740708">==</span>&nbsp;<span class="ident" id="3740711">nil</span>&nbsp;<span class="op" id="3740715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740720">fd</span><span class="op" id="3740722">.</span><span class="ident" id="3740723">Close</span><span class="op" id="3740728">(</span><span class="op" id="3740729">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3740733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740737">fd</span><span class="op" id="3740739">,</span>&nbsp;<span class="ident" id="3740741">err</span>&nbsp;<span class="op" id="3740745">=</span>&nbsp;<span class="ident" id="3740747">internetSocket</span><span class="op" id="3740761">(</span><span class="ident" id="3740762">net</span><span class="op" id="3740765">,</span>&nbsp;<span class="ident" id="3740767">laddr</span><span class="op" id="3740772">,</span>&nbsp;<span class="ident" id="3740774">raddr</span><span class="op" id="3740779">,</span>&nbsp;<span class="ident" id="3740781">deadline</span><span class="op" id="3740789">,</span>&nbsp;<span class="ident" id="3740791">syscall</span><span class="op" id="3740798">.</span><span class="ident" id="3740799">SOCK_STREAM</span><span class="op" id="3740810">,</span>&nbsp;<span class="num" id="3740812">0</span><span class="op" id="3740813">,</span>&nbsp;<span class="string" id="3740815">&#34;dial&#34;</span><span class="op" id="3740821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3740824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740828">if</span>&nbsp;<span class="ident" id="3740831">err</span>&nbsp;<span class="op" id="3740835">!=</span>&nbsp;<span class="ident" id="3740838">nil</span>&nbsp;<span class="op" id="3740842">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740846">return</span>&nbsp;<span class="ident" id="3740853">nil</span><span class="op" id="3740856">,</span>&nbsp;<span class="op" id="3740858">&amp;</span><span class="ident" id="3740859">OpError</span><span class="op" id="3740866">{</span><span class="ident" id="3740867">Op</span><span class="op" id="3740869">:</span>&nbsp;<span class="string" id="3740871">&#34;dial&#34;</span><span class="op" id="3740877">,</span>&nbsp;<span class="ident" id="3740879">Net</span><span class="op" id="3740882">:</span>&nbsp;<span class="ident" id="3740884">net</span><span class="op" id="3740887">,</span>&nbsp;<span class="ident" id="3740889">Addr</span><span class="op" id="3740893">:</span>&nbsp;<span class="ident" id="3740895">raddr</span><span class="op" id="3740900">,</span>&nbsp;<span class="ident" id="3740902">Err</span><span class="op" id="3740905">:</span>&nbsp;<span class="ident" id="3740907">err</span><span class="op" id="3740910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3740913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740916">return</span>&nbsp;<span class="ident" id="3740923">newTCPConn</span><span class="op" id="3740933">(</span><span class="ident" id="3740934">fd</span><span class="op" id="3740936">)</span><span class="op" id="3740937">,</span>&nbsp;<span class="ident" id="3740939">nil</span><br>
<span class="lineno"></span><span class="op" id="3740943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="3740946">func</span>&nbsp;<span class="ident" id="3740951">selfConnect</span><span class="op" id="3740962">(</span><span class="ident" id="3740963">fd</span>&nbsp;<span class="op" id="3740966">*</span><span class="ident" id="3740967">netFD</span><span class="op" id="3740972">,</span>&nbsp;<span class="ident" id="3740974">err</span>&nbsp;<span class="builtintype" id="3740978">error</span><span class="op" id="3740983">)</span>&nbsp;<span class="builtintype" id="3740985">bool</span>&nbsp;<span class="op" id="3740990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3740993">//&nbsp;If&nbsp;the&nbsp;connect&nbsp;failed,&nbsp;we&nbsp;clearly&nbsp;didn&#39;t&nbsp;connect&nbsp;to&nbsp;ourselves.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741060">if</span>&nbsp;<span class="ident" id="3741063">err</span>&nbsp;<span class="op" id="3741067">!=</span>&nbsp;<span class="ident" id="3741070">nil</span>&nbsp;<span class="op" id="3741074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741078">return</span>&nbsp;<span class="builtintype" id="3741085">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3741092">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3741096">//&nbsp;The&nbsp;socket&nbsp;constructor&nbsp;can&nbsp;return&nbsp;an&nbsp;fd&nbsp;with&nbsp;raddr&nbsp;nil&nbsp;under&nbsp;certain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3741169">//&nbsp;unknown&nbsp;conditions.&nbsp;The&nbsp;errors&nbsp;in&nbsp;the&nbsp;calls&nbsp;there&nbsp;to&nbsp;Getpeername</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3741238">//&nbsp;are&nbsp;discarded,&nbsp;but&nbsp;we&nbsp;can&#39;t&nbsp;catch&nbsp;the&nbsp;problem&nbsp;there&nbsp;because&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3741308">//&nbsp;calls&nbsp;are&nbsp;sometimes&nbsp;legally&nbsp;erroneous&nbsp;with&nbsp;a&nbsp;&#34;socket&nbsp;not&nbsp;connected&#34;.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3741381">//&nbsp;Since&nbsp;this&nbsp;code&nbsp;(selfConnect)&nbsp;is&nbsp;already&nbsp;trying&nbsp;to&nbsp;work&nbsp;around</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3741448">//&nbsp;a&nbsp;problem,&nbsp;we&nbsp;make&nbsp;sure&nbsp;if&nbsp;this&nbsp;happens&nbsp;we&nbsp;recognize&nbsp;trouble&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3741517">//&nbsp;ask&nbsp;the&nbsp;DialTCP&nbsp;routine&nbsp;to&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3741559">//&nbsp;TODO:&nbsp;try&nbsp;to&nbsp;understand&nbsp;what&#39;s&nbsp;really&nbsp;going&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741611">if</span>&nbsp;<span class="ident" id="3741614">fd</span><span class="op" id="3741616">.</span><span class="ident" id="3741617">laddr</span>&nbsp;<span class="op" id="3741623">==</span>&nbsp;<span class="ident" id="3741626">nil</span>&nbsp;<span class="op" id="3741630">||</span>&nbsp;<span class="ident" id="3741633">fd</span><span class="op" id="3741635">.</span><span class="ident" id="3741636">raddr</span>&nbsp;<span class="op" id="3741642">==</span>&nbsp;<span class="ident" id="3741645">nil</span>&nbsp;<span class="op" id="3741649">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741653">return</span>&nbsp;<span class="builtintype" id="3741660">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3741666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3741669">l</span>&nbsp;<span class="op" id="3741671">:=</span>&nbsp;<span class="ident" id="3741674">fd</span><span class="op" id="3741676">.</span><span class="ident" id="3741677">laddr</span><span class="op" id="3741682">.</span><span class="op" id="3741683">(</span><span class="op" id="3741684">*</span><span class="ident" id="3741685">TCPAddr</span><span class="op" id="3741692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3741695">r</span>&nbsp;<span class="op" id="3741697">:=</span>&nbsp;<span class="ident" id="3741700">fd</span><span class="op" id="3741702">.</span><span class="ident" id="3741703">raddr</span><span class="op" id="3741708">.</span><span class="op" id="3741709">(</span><span class="op" id="3741710">*</span><span class="ident" id="3741711">TCPAddr</span><span class="op" id="3741718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741721">return</span>&nbsp;<span class="ident" id="3741728">l</span><span class="op" id="3741729">.</span><span class="ident" id="3741730">Port</span>&nbsp;<span class="op" id="3741735">==</span>&nbsp;<span class="ident" id="3741738">r</span><span class="op" id="3741739">.</span><span class="ident" id="3741740">Port</span>&nbsp;<span class="op" id="3741745">&amp;&amp;</span>&nbsp;<span class="ident" id="3741748">l</span><span class="op" id="3741749">.</span><span class="ident" id="3741750">IP</span><span class="op" id="3741752">.</span><span class="ident" id="3741753">Equal</span><span class="op" id="3741758">(</span><span class="ident" id="3741759">r</span><span class="op" id="3741760">.</span><span class="ident" id="3741761">IP</span><span class="op" id="3741763">)</span><br>
<span class="lineno">215</span><span class="op" id="3741765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3741768">func</span>&nbsp;<span class="ident" id="3741773">spuriousENOTAVAIL</span><span class="op" id="3741790">(</span><span class="ident" id="3741791">err</span>&nbsp;<span class="builtintype" id="3741795">error</span><span class="op" id="3741800">)</span>&nbsp;<span class="builtintype" id="3741802">bool</span>&nbsp;<span class="op" id="3741807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3741810">e</span><span class="op" id="3741811">,</span>&nbsp;<span class="ident" id="3741813">ok</span>&nbsp;<span class="op" id="3741816">:=</span>&nbsp;<span class="ident" id="3741819">err</span><span class="op" id="3741822">.</span><span class="op" id="3741823">(</span><span class="op" id="3741824">*</span><span class="ident" id="3741825">OpError</span><span class="op" id="3741832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741835">return</span>&nbsp;<span class="ident" id="3741842">ok</span>&nbsp;<span class="op" id="3741845">&amp;&amp;</span>&nbsp;<span class="ident" id="3741848">e</span><span class="op" id="3741849">.</span><span class="ident" id="3741850">Err</span>&nbsp;<span class="op" id="3741854">==</span>&nbsp;<span class="ident" id="3741857">syscall</span><span class="op" id="3741864">.</span><span class="ident" id="3741865">EADDRNOTAVAIL</span><br>
<span class="lineno">220</span><span class="op" id="3741879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3741882">//&nbsp;TCPListener&nbsp;is&nbsp;a&nbsp;TCP&nbsp;network&nbsp;listener.&nbsp;&nbsp;Clients&nbsp;should&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="3741950">//&nbsp;use&nbsp;variables&nbsp;of&nbsp;type&nbsp;Listener&nbsp;instead&nbsp;of&nbsp;assuming&nbsp;TCP.</span><br>
<span class="lineno"></span><span class="keyword" id="3742009">type</span>&nbsp;<span class="ident" id="3742014">TCPListener</span>&nbsp;<span class="keyword" id="3742026">struct</span>&nbsp;<span class="op" id="3742033">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742036">fd</span>&nbsp;<span class="op" id="3742039">*</span><span class="ident" id="3742040">netFD</span><br>
<span class="lineno"></span><span class="op" id="3742046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3742049">//&nbsp;AcceptTCP&nbsp;accepts&nbsp;the&nbsp;next&nbsp;incoming&nbsp;call&nbsp;and&nbsp;returns&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="3742113">//&nbsp;connection.</span><br>
<span class="lineno">230</span><span class="keyword" id="3742128">func</span>&nbsp;<span class="op" id="3742133">(</span><span class="ident" id="3742134">l</span>&nbsp;<span class="op" id="3742136">*</span><span class="ident" id="3742137">TCPListener</span><span class="op" id="3742148">)</span>&nbsp;<span class="ident" id="3742150">AcceptTCP</span><span class="op" id="3742159">(</span><span class="op" id="3742160">)</span>&nbsp;<span class="op" id="3742162">(</span><span class="op" id="3742163">*</span><span class="ident" id="3742164">TCPConn</span><span class="op" id="3742171">,</span>&nbsp;<span class="builtintype" id="3742173">error</span><span class="op" id="3742178">)</span>&nbsp;<span class="op" id="3742180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742183">if</span>&nbsp;<span class="ident" id="3742186">l</span>&nbsp;<span class="op" id="3742188">==</span>&nbsp;<span class="ident" id="3742191">nil</span>&nbsp;<span class="op" id="3742195">||</span>&nbsp;<span class="ident" id="3742198">l</span><span class="op" id="3742199">.</span><span class="ident" id="3742200">fd</span>&nbsp;<span class="op" id="3742203">==</span>&nbsp;<span class="ident" id="3742206">nil</span>&nbsp;<span class="op" id="3742210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742214">return</span>&nbsp;<span class="ident" id="3742221">nil</span><span class="op" id="3742224">,</span>&nbsp;<span class="ident" id="3742226">syscall</span><span class="op" id="3742233">.</span><span class="ident" id="3742234">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3742242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742245">fd</span><span class="op" id="3742247">,</span>&nbsp;<span class="ident" id="3742249">err</span>&nbsp;<span class="op" id="3742253">:=</span>&nbsp;<span class="ident" id="3742256">l</span><span class="op" id="3742257">.</span><span class="ident" id="3742258">fd</span><span class="op" id="3742260">.</span><span class="ident" id="3742261">accept</span><span class="op" id="3742267">(</span><span class="op" id="3742268">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742271">if</span>&nbsp;<span class="ident" id="3742274">err</span>&nbsp;<span class="op" id="3742278">!=</span>&nbsp;<span class="ident" id="3742281">nil</span>&nbsp;<span class="op" id="3742285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742289">return</span>&nbsp;<span class="ident" id="3742296">nil</span><span class="op" id="3742299">,</span>&nbsp;<span class="ident" id="3742301">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3742306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742309">return</span>&nbsp;<span class="ident" id="3742316">newTCPConn</span><span class="op" id="3742326">(</span><span class="ident" id="3742327">fd</span><span class="op" id="3742329">)</span><span class="op" id="3742330">,</span>&nbsp;<span class="ident" id="3742332">nil</span><br>
<span class="lineno"></span><span class="op" id="3742336">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="3742339">//&nbsp;Accept&nbsp;implements&nbsp;the&nbsp;Accept&nbsp;method&nbsp;in&nbsp;the&nbsp;Listener&nbsp;interface;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3742408">//&nbsp;waits&nbsp;for&nbsp;the&nbsp;next&nbsp;call&nbsp;and&nbsp;returns&nbsp;a&nbsp;generic&nbsp;Conn.</span><br>
<span class="lineno"></span><span class="keyword" id="3742463">func</span>&nbsp;<span class="op" id="3742468">(</span><span class="ident" id="3742469">l</span>&nbsp;<span class="op" id="3742471">*</span><span class="ident" id="3742472">TCPListener</span><span class="op" id="3742483">)</span>&nbsp;<span class="ident" id="3742485">Accept</span><span class="op" id="3742491">(</span><span class="op" id="3742492">)</span>&nbsp;<span class="op" id="3742494">(</span><span class="ident" id="3742495">Conn</span><span class="op" id="3742499">,</span>&nbsp;<span class="builtintype" id="3742501">error</span><span class="op" id="3742506">)</span>&nbsp;<span class="op" id="3742508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742511">c</span><span class="op" id="3742512">,</span>&nbsp;<span class="ident" id="3742514">err</span>&nbsp;<span class="op" id="3742518">:=</span>&nbsp;<span class="ident" id="3742521">l</span><span class="op" id="3742522">.</span><span class="ident" id="3742523">AcceptTCP</span><span class="op" id="3742532">(</span><span class="op" id="3742533">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742536">if</span>&nbsp;<span class="ident" id="3742539">err</span>&nbsp;<span class="op" id="3742543">!=</span>&nbsp;<span class="ident" id="3742546">nil</span>&nbsp;<span class="op" id="3742550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742554">return</span>&nbsp;<span class="ident" id="3742561">nil</span><span class="op" id="3742564">,</span>&nbsp;<span class="ident" id="3742566">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3742571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742574">return</span>&nbsp;<span class="ident" id="3742581">c</span><span class="op" id="3742582">,</span>&nbsp;<span class="ident" id="3742584">nil</span><br>
<span class="lineno"></span><span class="op" id="3742588">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="3742591">//&nbsp;Close&nbsp;stops&nbsp;listening&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="3742636">//&nbsp;Already&nbsp;Accepted&nbsp;connections&nbsp;are&nbsp;not&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="3742684">func</span>&nbsp;<span class="op" id="3742689">(</span><span class="ident" id="3742690">l</span>&nbsp;<span class="op" id="3742692">*</span><span class="ident" id="3742693">TCPListener</span><span class="op" id="3742704">)</span>&nbsp;<span class="ident" id="3742706">Close</span><span class="op" id="3742711">(</span><span class="op" id="3742712">)</span>&nbsp;<span class="builtintype" id="3742714">error</span>&nbsp;<span class="op" id="3742720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742723">if</span>&nbsp;<span class="ident" id="3742726">l</span>&nbsp;<span class="op" id="3742728">==</span>&nbsp;<span class="ident" id="3742731">nil</span>&nbsp;<span class="op" id="3742735">||</span>&nbsp;<span class="ident" id="3742738">l</span><span class="op" id="3742739">.</span><span class="ident" id="3742740">fd</span>&nbsp;<span class="op" id="3742743">==</span>&nbsp;<span class="ident" id="3742746">nil</span>&nbsp;<span class="op" id="3742750">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742754">return</span>&nbsp;<span class="ident" id="3742761">syscall</span><span class="op" id="3742768">.</span><span class="ident" id="3742769">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3742777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742780">return</span>&nbsp;<span class="ident" id="3742787">l</span><span class="op" id="3742788">.</span><span class="ident" id="3742789">fd</span><span class="op" id="3742791">.</span><span class="ident" id="3742792">Close</span><span class="op" id="3742797">(</span><span class="op" id="3742798">)</span><br>
<span class="lineno"></span><span class="op" id="3742800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="comment" id="3742803">//&nbsp;Addr&nbsp;returns&nbsp;the&nbsp;listener&#39;s&nbsp;network&nbsp;address,&nbsp;a&nbsp;*TCPAddr.</span><br>
<span class="lineno"></span><span class="keyword" id="3742863">func</span>&nbsp;<span class="op" id="3742868">(</span><span class="ident" id="3742869">l</span>&nbsp;<span class="op" id="3742871">*</span><span class="ident" id="3742872">TCPListener</span><span class="op" id="3742883">)</span>&nbsp;<span class="ident" id="3742885">Addr</span><span class="op" id="3742889">(</span><span class="op" id="3742890">)</span>&nbsp;<span class="ident" id="3742892">Addr</span>&nbsp;<span class="op" id="3742897">{</span>&nbsp;<span class="keyword" id="3742899">return</span>&nbsp;<span class="ident" id="3742906">l</span><span class="op" id="3742907">.</span><span class="ident" id="3742908">fd</span><span class="op" id="3742910">.</span><span class="ident" id="3742911">laddr</span>&nbsp;<span class="op" id="3742917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3742920">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;deadline&nbsp;associated&nbsp;with&nbsp;the&nbsp;listener.</span><br>
<span class="lineno"></span><span class="comment" id="3742983">//&nbsp;A&nbsp;zero&nbsp;time&nbsp;value&nbsp;disables&nbsp;the&nbsp;deadline.</span><br>
<span class="lineno">265</span><span class="keyword" id="3743027">func</span>&nbsp;<span class="op" id="3743032">(</span><span class="ident" id="3743033">l</span>&nbsp;<span class="op" id="3743035">*</span><span class="ident" id="3743036">TCPListener</span><span class="op" id="3743047">)</span>&nbsp;<span class="ident" id="3743049">SetDeadline</span><span class="op" id="3743060">(</span><span class="ident" id="3743061">t</span>&nbsp;<span class="ident" id="3743063">time</span><span class="op" id="3743067">.</span><span class="ident" id="3743068">Time</span><span class="op" id="3743072">)</span>&nbsp;<span class="builtintype" id="3743074">error</span>&nbsp;<span class="op" id="3743080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743083">if</span>&nbsp;<span class="ident" id="3743086">l</span>&nbsp;<span class="op" id="3743088">==</span>&nbsp;<span class="ident" id="3743091">nil</span>&nbsp;<span class="op" id="3743095">||</span>&nbsp;<span class="ident" id="3743098">l</span><span class="op" id="3743099">.</span><span class="ident" id="3743100">fd</span>&nbsp;<span class="op" id="3743103">==</span>&nbsp;<span class="ident" id="3743106">nil</span>&nbsp;<span class="op" id="3743110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743114">return</span>&nbsp;<span class="ident" id="3743121">syscall</span><span class="op" id="3743128">.</span><span class="ident" id="3743129">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3743137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743140">return</span>&nbsp;<span class="ident" id="3743147">l</span><span class="op" id="3743148">.</span><span class="ident" id="3743149">fd</span><span class="op" id="3743151">.</span><span class="ident" id="3743152">setDeadline</span><span class="op" id="3743163">(</span><span class="ident" id="3743164">t</span><span class="op" id="3743165">)</span><br>
<span class="lineno">270</span><span class="op" id="3743167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3743170">//&nbsp;File&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;underlying&nbsp;os.File,&nbsp;set&nbsp;to&nbsp;blocking</span><br>
<span class="lineno"></span><span class="comment" id="3743236">//&nbsp;mode.&nbsp;&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;close&nbsp;f&nbsp;when&nbsp;finished.</span><br>
<span class="lineno"></span><span class="comment" id="3743306">//&nbsp;Closing&nbsp;l&nbsp;does&nbsp;not&nbsp;affect&nbsp;f,&nbsp;and&nbsp;closing&nbsp;f&nbsp;does&nbsp;not&nbsp;affect&nbsp;l.</span><br>
<span class="lineno">275</span><span class="comment" id="3743371">//</span><br>
<span class="lineno"></span><span class="comment" id="3743374">//&nbsp;The&nbsp;returned&nbsp;os.File&#39;s&nbsp;file&nbsp;descriptor&nbsp;is&nbsp;different&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3743438">//&nbsp;connection&#39;s.&nbsp;&nbsp;Attempting&nbsp;to&nbsp;change&nbsp;properties&nbsp;of&nbsp;the&nbsp;original</span><br>
<span class="lineno"></span><span class="comment" id="3743504">//&nbsp;using&nbsp;this&nbsp;duplicate&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;have&nbsp;the&nbsp;desired&nbsp;effect.</span><br>
<span class="lineno"></span><span class="keyword" id="3743568">func</span>&nbsp;<span class="op" id="3743573">(</span><span class="ident" id="3743574">l</span>&nbsp;<span class="op" id="3743576">*</span><span class="ident" id="3743577">TCPListener</span><span class="op" id="3743588">)</span>&nbsp;<span class="ident" id="3743590">File</span><span class="op" id="3743594">(</span><span class="op" id="3743595">)</span>&nbsp;<span class="op" id="3743597">(</span><span class="ident" id="3743598">f</span>&nbsp;<span class="op" id="3743600">*</span><span class="ident" id="3743601">os</span><span class="op" id="3743603">.</span><span class="ident" id="3743604">File</span><span class="op" id="3743608">,</span>&nbsp;<span class="ident" id="3743610">err</span>&nbsp;<span class="builtintype" id="3743614">error</span><span class="op" id="3743619">)</span>&nbsp;<span class="op" id="3743621">{</span>&nbsp;<span class="keyword" id="3743623">return</span>&nbsp;<span class="ident" id="3743630">l</span><span class="op" id="3743631">.</span><span class="ident" id="3743632">fd</span><span class="op" id="3743634">.</span><span class="ident" id="3743635">dup</span><span class="op" id="3743638">(</span><span class="op" id="3743639">)</span>&nbsp;<span class="op" id="3743641">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3743644">//&nbsp;ListenTCP&nbsp;announces&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address&nbsp;laddr&nbsp;and&nbsp;returns&nbsp;a&nbsp;TCP</span><br>
<span class="lineno"></span><span class="comment" id="3743710">//&nbsp;listener.&nbsp;&nbsp;Net&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;has&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3743778">//&nbsp;port&nbsp;of&nbsp;0,&nbsp;ListenTCP&nbsp;will&nbsp;choose&nbsp;an&nbsp;available&nbsp;port.&nbsp;&nbsp;The&nbsp;caller&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="3743849">//&nbsp;use&nbsp;the&nbsp;Addr&nbsp;method&nbsp;of&nbsp;TCPListener&nbsp;to&nbsp;retrieve&nbsp;the&nbsp;chosen&nbsp;address.</span><br>
<span class="lineno">285</span><span class="keyword" id="3743919">func</span>&nbsp;<span class="ident" id="3743924">ListenTCP</span><span class="op" id="3743933">(</span><span class="ident" id="3743934">net</span>&nbsp;<span class="builtintype" id="3743938">string</span><span class="op" id="3743944">,</span>&nbsp;<span class="ident" id="3743946">laddr</span>&nbsp;<span class="op" id="3743952">*</span><span class="ident" id="3743953">TCPAddr</span><span class="op" id="3743960">)</span>&nbsp;<span class="op" id="3743962">(</span><span class="op" id="3743963">*</span><span class="ident" id="3743964">TCPListener</span><span class="op" id="3743975">,</span>&nbsp;<span class="builtintype" id="3743977">error</span><span class="op" id="3743982">)</span>&nbsp;<span class="op" id="3743984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743987">switch</span>&nbsp;<span class="ident" id="3743994">net</span>&nbsp;<span class="op" id="3743998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744001">case</span>&nbsp;<span class="string" id="3744006">&#34;tcp&#34;</span><span class="op" id="3744011">,</span>&nbsp;<span class="string" id="3744013">&#34;tcp4&#34;</span><span class="op" id="3744019">,</span>&nbsp;<span class="string" id="3744021">&#34;tcp6&#34;</span><span class="op" id="3744027">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744030">default</span><span class="op" id="3744037">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744041">return</span>&nbsp;<span class="ident" id="3744048">nil</span><span class="op" id="3744051">,</span>&nbsp;<span class="op" id="3744053">&amp;</span><span class="ident" id="3744054">OpError</span><span class="op" id="3744061">{</span><span class="ident" id="3744062">Op</span><span class="op" id="3744064">:</span>&nbsp;<span class="string" id="3744066">&#34;listen&#34;</span><span class="op" id="3744074">,</span>&nbsp;<span class="ident" id="3744076">Net</span><span class="op" id="3744079">:</span>&nbsp;<span class="ident" id="3744081">net</span><span class="op" id="3744084">,</span>&nbsp;<span class="ident" id="3744086">Addr</span><span class="op" id="3744090">:</span>&nbsp;<span class="ident" id="3744092">laddr</span><span class="op" id="3744097">,</span>&nbsp;<span class="ident" id="3744099">Err</span><span class="op" id="3744102">:</span>&nbsp;<span class="ident" id="3744104">UnknownNetworkError</span><span class="op" id="3744123">(</span><span class="ident" id="3744124">net</span><span class="op" id="3744127">)</span><span class="op" id="3744128">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744134">if</span>&nbsp;<span class="ident" id="3744137">laddr</span>&nbsp;<span class="op" id="3744143">==</span>&nbsp;<span class="ident" id="3744146">nil</span>&nbsp;<span class="op" id="3744150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744154">laddr</span>&nbsp;<span class="op" id="3744160">=</span>&nbsp;<span class="op" id="3744162">&amp;</span><span class="ident" id="3744163">TCPAddr</span><span class="op" id="3744170">{</span><span class="op" id="3744171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744177">fd</span><span class="op" id="3744179">,</span>&nbsp;<span class="ident" id="3744181">err</span>&nbsp;<span class="op" id="3744185">:=</span>&nbsp;<span class="ident" id="3744188">internetSocket</span><span class="op" id="3744202">(</span><span class="ident" id="3744203">net</span><span class="op" id="3744206">,</span>&nbsp;<span class="ident" id="3744208">laddr</span><span class="op" id="3744213">,</span>&nbsp;<span class="ident" id="3744215">nil</span><span class="op" id="3744218">,</span>&nbsp;<span class="ident" id="3744220">noDeadline</span><span class="op" id="3744230">,</span>&nbsp;<span class="ident" id="3744232">syscall</span><span class="op" id="3744239">.</span><span class="ident" id="3744240">SOCK_STREAM</span><span class="op" id="3744251">,</span>&nbsp;<span class="num" id="3744253">0</span><span class="op" id="3744254">,</span>&nbsp;<span class="string" id="3744256">&#34;listen&#34;</span><span class="op" id="3744264">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744267">if</span>&nbsp;<span class="ident" id="3744270">err</span>&nbsp;<span class="op" id="3744274">!=</span>&nbsp;<span class="ident" id="3744277">nil</span>&nbsp;<span class="op" id="3744281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744285">return</span>&nbsp;<span class="ident" id="3744292">nil</span><span class="op" id="3744295">,</span>&nbsp;<span class="op" id="3744297">&amp;</span><span class="ident" id="3744298">OpError</span><span class="op" id="3744305">{</span><span class="ident" id="3744306">Op</span><span class="op" id="3744308">:</span>&nbsp;<span class="string" id="3744310">&#34;listen&#34;</span><span class="op" id="3744318">,</span>&nbsp;<span class="ident" id="3744320">Net</span><span class="op" id="3744323">:</span>&nbsp;<span class="ident" id="3744325">net</span><span class="op" id="3744328">,</span>&nbsp;<span class="ident" id="3744330">Addr</span><span class="op" id="3744334">:</span>&nbsp;<span class="ident" id="3744336">laddr</span><span class="op" id="3744341">,</span>&nbsp;<span class="ident" id="3744343">Err</span><span class="op" id="3744346">:</span>&nbsp;<span class="ident" id="3744348">err</span><span class="op" id="3744351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744357">return</span>&nbsp;<span class="op" id="3744364">&amp;</span><span class="ident" id="3744365">TCPListener</span><span class="op" id="3744376">{</span><span class="ident" id="3744377">fd</span><span class="op" id="3744379">}</span><span class="op" id="3744380">,</span>&nbsp;<span class="ident" id="3744382">nil</span><br>
<span class="lineno"></span><span class="op" id="3744386">}</span>
</div>
</body>
</html>
