<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html" class="current">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5631114">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5631169">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5631223">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5631274">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;CGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="5631334">//&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5631347">package</span>&nbsp;<span class="ident" id="5631355">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5631360">import</span>&nbsp;<span class="op" id="5631367">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5631370">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5631379">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5631393">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5631403">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5631410">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5631416">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5631429">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5631436">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5631448">&#34;net/url&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5631459">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5631465">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5631476">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5631486">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5631489">//&nbsp;Request&nbsp;returns&nbsp;the&nbsp;HTTP&nbsp;request&nbsp;as&nbsp;represented&nbsp;in&nbsp;the&nbsp;current</span><br>
<span class="lineno"></span><span class="comment" id="5631555">//&nbsp;environment.&nbsp;This&nbsp;assumes&nbsp;the&nbsp;current&nbsp;program&nbsp;is&nbsp;being&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="5631617">//&nbsp;by&nbsp;a&nbsp;web&nbsp;server&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment.</span><br>
<span class="lineno"></span><span class="comment" id="5631658">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;populated,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="5631718">func</span>&nbsp;<span class="ident" id="5631723">Request</span><span class="op" id="5631730">(</span><span class="op" id="5631731">)</span>&nbsp;<span class="op" id="5631733">(</span><span class="op" id="5631734">*</span><span class="ident" id="5631735">http</span><span class="op" id="5631739">.</span><span class="ident" id="5631740">Request</span><span class="op" id="5631747">,</span>&nbsp;<span class="builtintype" id="5631749">error</span><span class="op" id="5631754">)</span>&nbsp;<span class="op" id="5631756">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5631759">r</span><span class="op" id="5631760">,</span>&nbsp;<span class="ident" id="5631762">err</span>&nbsp;<span class="op" id="5631766">:=</span>&nbsp;<span class="ident" id="5631769">RequestFromMap</span><span class="op" id="5631783">(</span><span class="ident" id="5631784">envMap</span><span class="op" id="5631790">(</span><span class="ident" id="5631791">os</span><span class="op" id="5631793">.</span><span class="ident" id="5631794">Environ</span><span class="op" id="5631801">(</span><span class="op" id="5631802">)</span><span class="op" id="5631803">)</span><span class="op" id="5631804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5631807">if</span>&nbsp;<span class="ident" id="5631810">err</span>&nbsp;<span class="op" id="5631814">!=</span>&nbsp;<span class="ident" id="5631817">nil</span>&nbsp;<span class="op" id="5631821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5631825">return</span>&nbsp;<span class="ident" id="5631832">nil</span><span class="op" id="5631835">,</span>&nbsp;<span class="ident" id="5631837">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5631842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5631845">if</span>&nbsp;<span class="ident" id="5631848">r</span><span class="op" id="5631849">.</span><span class="ident" id="5631850">ContentLength</span>&nbsp;<span class="op" id="5631864">&gt;</span>&nbsp;<span class="num" id="5631866">0</span>&nbsp;<span class="op" id="5631868">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5631872">r</span><span class="op" id="5631873">.</span><span class="ident" id="5631874">Body</span>&nbsp;<span class="op" id="5631879">=</span>&nbsp;<span class="ident" id="5631881">ioutil</span><span class="op" id="5631887">.</span><span class="ident" id="5631888">NopCloser</span><span class="op" id="5631897">(</span><span class="ident" id="5631898">io</span><span class="op" id="5631900">.</span><span class="ident" id="5631901">LimitReader</span><span class="op" id="5631912">(</span><span class="ident" id="5631913">os</span><span class="op" id="5631915">.</span><span class="ident" id="5631916">Stdin</span><span class="op" id="5631921">,</span>&nbsp;<span class="ident" id="5631923">r</span><span class="op" id="5631924">.</span><span class="ident" id="5631925">ContentLength</span><span class="op" id="5631938">)</span><span class="op" id="5631939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5631942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5631945">return</span>&nbsp;<span class="ident" id="5631952">r</span><span class="op" id="5631953">,</span>&nbsp;<span class="ident" id="5631955">nil</span><br>
<span class="lineno"></span><span class="op" id="5631959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="5631962">func</span>&nbsp;<span class="ident" id="5631967">envMap</span><span class="op" id="5631973">(</span><span class="ident" id="5631974">env</span>&nbsp;<span class="op" id="5631978">[</span><span class="op" id="5631979">]</span><span class="builtintype" id="5631980">string</span><span class="op" id="5631986">)</span>&nbsp;<span class="keyword" id="5631988">map</span><span class="op" id="5631991">[</span><span class="builtintype" id="5631992">string</span><span class="op" id="5631998">]</span><span class="builtintype" id="5631999">string</span>&nbsp;<span class="op" id="5632006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632009">m</span>&nbsp;<span class="op" id="5632011">:=</span>&nbsp;<span class="builtinfunc" id="5632014">make</span><span class="op" id="5632018">(</span><span class="keyword" id="5632019">map</span><span class="op" id="5632022">[</span><span class="builtintype" id="5632023">string</span><span class="op" id="5632029">]</span><span class="builtintype" id="5632030">string</span><span class="op" id="5632036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632039">for</span>&nbsp;<span class="ident" id="5632043">_</span><span class="op" id="5632044">,</span>&nbsp;<span class="ident" id="5632046">kv</span>&nbsp;<span class="op" id="5632049">:=</span>&nbsp;<span class="keyword" id="5632052">range</span>&nbsp;<span class="ident" id="5632058">env</span>&nbsp;<span class="op" id="5632062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632066">if</span>&nbsp;<span class="ident" id="5632069">idx</span>&nbsp;<span class="op" id="5632073">:=</span>&nbsp;<span class="ident" id="5632076">strings</span><span class="op" id="5632083">.</span><span class="ident" id="5632084">Index</span><span class="op" id="5632089">(</span><span class="ident" id="5632090">kv</span><span class="op" id="5632092">,</span>&nbsp;<span class="string" id="5632094">&#34;=&#34;</span><span class="op" id="5632097">)</span><span class="op" id="5632098">;</span>&nbsp;<span class="ident" id="5632100">idx</span>&nbsp;<span class="op" id="5632104">!=</span>&nbsp;<span class="op" id="5632107">-</span><span class="num" id="5632108">1</span>&nbsp;<span class="op" id="5632110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632115">m</span><span class="op" id="5632116">[</span><span class="ident" id="5632117">kv</span><span class="op" id="5632119">[</span><span class="op" id="5632120">:</span><span class="ident" id="5632121">idx</span><span class="op" id="5632124">]</span><span class="op" id="5632125">]</span>&nbsp;<span class="op" id="5632127">=</span>&nbsp;<span class="ident" id="5632129">kv</span><span class="op" id="5632131">[</span><span class="ident" id="5632132">idx</span><span class="op" id="5632135">+</span><span class="num" id="5632136">1</span><span class="op" id="5632137">:</span><span class="op" id="5632138">]</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5632142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5632145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632148">return</span>&nbsp;<span class="ident" id="5632155">m</span><br>
<span class="lineno"></span><span class="op" id="5632157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5632160">//&nbsp;RequestFromMap&nbsp;creates&nbsp;an&nbsp;http.Request&nbsp;from&nbsp;CGI&nbsp;variables.</span><br>
<span class="lineno"></span><span class="comment" id="5632222">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;field&nbsp;is&nbsp;not&nbsp;populated.</span><br>
<span class="lineno"></span><span class="keyword" id="5632277">func</span>&nbsp;<span class="ident" id="5632282">RequestFromMap</span><span class="op" id="5632296">(</span><span class="ident" id="5632297">params</span>&nbsp;<span class="keyword" id="5632304">map</span><span class="op" id="5632307">[</span><span class="builtintype" id="5632308">string</span><span class="op" id="5632314">]</span><span class="builtintype" id="5632315">string</span><span class="op" id="5632321">)</span>&nbsp;<span class="op" id="5632323">(</span><span class="op" id="5632324">*</span><span class="ident" id="5632325">http</span><span class="op" id="5632329">.</span><span class="ident" id="5632330">Request</span><span class="op" id="5632337">,</span>&nbsp;<span class="builtintype" id="5632339">error</span><span class="op" id="5632344">)</span>&nbsp;<span class="op" id="5632346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632349">r</span>&nbsp;<span class="op" id="5632351">:=</span>&nbsp;<span class="builtinfunc" id="5632354">new</span><span class="op" id="5632357">(</span><span class="ident" id="5632358">http</span><span class="op" id="5632362">.</span><span class="ident" id="5632363">Request</span><span class="op" id="5632370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632373">r</span><span class="op" id="5632374">.</span><span class="ident" id="5632375">Method</span>&nbsp;<span class="op" id="5632382">=</span>&nbsp;<span class="ident" id="5632384">params</span><span class="op" id="5632390">[</span><span class="string" id="5632391">&#34;REQUEST_METHOD&#34;</span><span class="op" id="5632407">]</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632410">if</span>&nbsp;<span class="ident" id="5632413">r</span><span class="op" id="5632414">.</span><span class="ident" id="5632415">Method</span>&nbsp;<span class="op" id="5632422">==</span>&nbsp;<span class="string" id="5632425">&#34;&#34;</span>&nbsp;<span class="op" id="5632428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632432">return</span>&nbsp;<span class="ident" id="5632439">nil</span><span class="op" id="5632442">,</span>&nbsp;<span class="ident" id="5632444">errors</span><span class="op" id="5632450">.</span><span class="ident" id="5632451">New</span><span class="op" id="5632454">(</span><span class="string" id="5632455">&#34;cgi:&nbsp;no&nbsp;REQUEST_METHOD&nbsp;in&nbsp;environment&#34;</span><span class="op" id="5632494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5632497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632501">r</span><span class="op" id="5632502">.</span><span class="ident" id="5632503">Proto</span>&nbsp;<span class="op" id="5632509">=</span>&nbsp;<span class="ident" id="5632511">params</span><span class="op" id="5632517">[</span><span class="string" id="5632518">&#34;SERVER_PROTOCOL&#34;</span><span class="op" id="5632535">]</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632538">var</span>&nbsp;<span class="ident" id="5632542">ok</span>&nbsp;<span class="builtintype" id="5632545">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632551">r</span><span class="op" id="5632552">.</span><span class="ident" id="5632553">ProtoMajor</span><span class="op" id="5632563">,</span>&nbsp;<span class="ident" id="5632565">r</span><span class="op" id="5632566">.</span><span class="ident" id="5632567">ProtoMinor</span><span class="op" id="5632577">,</span>&nbsp;<span class="ident" id="5632579">ok</span>&nbsp;<span class="op" id="5632582">=</span>&nbsp;<span class="ident" id="5632584">http</span><span class="op" id="5632588">.</span><span class="ident" id="5632589">ParseHTTPVersion</span><span class="op" id="5632605">(</span><span class="ident" id="5632606">r</span><span class="op" id="5632607">.</span><span class="ident" id="5632608">Proto</span><span class="op" id="5632613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632616">if</span>&nbsp;<span class="op" id="5632619">!</span><span class="ident" id="5632620">ok</span>&nbsp;<span class="op" id="5632623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632627">return</span>&nbsp;<span class="ident" id="5632634">nil</span><span class="op" id="5632637">,</span>&nbsp;<span class="ident" id="5632639">errors</span><span class="op" id="5632645">.</span><span class="ident" id="5632646">New</span><span class="op" id="5632649">(</span><span class="string" id="5632650">&#34;cgi:&nbsp;invalid&nbsp;SERVER_PROTOCOL&nbsp;version&#34;</span><span class="op" id="5632688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5632691">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632695">r</span><span class="op" id="5632696">.</span><span class="ident" id="5632697">Close</span>&nbsp;<span class="op" id="5632703">=</span>&nbsp;<span class="builtintype" id="5632705">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632711">r</span><span class="op" id="5632712">.</span><span class="ident" id="5632713">Trailer</span>&nbsp;<span class="op" id="5632721">=</span>&nbsp;<span class="ident" id="5632723">http</span><span class="op" id="5632727">.</span><span class="ident" id="5632728">Header</span><span class="op" id="5632734">{</span><span class="op" id="5632735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632738">r</span><span class="op" id="5632739">.</span><span class="ident" id="5632740">Header</span>&nbsp;<span class="op" id="5632747">=</span>&nbsp;<span class="ident" id="5632749">http</span><span class="op" id="5632753">.</span><span class="ident" id="5632754">Header</span><span class="op" id="5632760">{</span><span class="op" id="5632761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632765">r</span><span class="op" id="5632766">.</span><span class="ident" id="5632767">Host</span>&nbsp;<span class="op" id="5632772">=</span>&nbsp;<span class="ident" id="5632774">params</span><span class="op" id="5632780">[</span><span class="string" id="5632781">&#34;HTTP_HOST&#34;</span><span class="op" id="5632792">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632796">if</span>&nbsp;<span class="ident" id="5632799">lenstr</span>&nbsp;<span class="op" id="5632806">:=</span>&nbsp;<span class="ident" id="5632809">params</span><span class="op" id="5632815">[</span><span class="string" id="5632816">&#34;CONTENT_LENGTH&#34;</span><span class="op" id="5632832">]</span><span class="op" id="5632833">;</span>&nbsp;<span class="ident" id="5632835">lenstr</span>&nbsp;<span class="op" id="5632842">!=</span>&nbsp;<span class="string" id="5632845">&#34;&#34;</span>&nbsp;<span class="op" id="5632848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632852">clen</span><span class="op" id="5632856">,</span>&nbsp;<span class="ident" id="5632858">err</span>&nbsp;<span class="op" id="5632862">:=</span>&nbsp;<span class="ident" id="5632865">strconv</span><span class="op" id="5632872">.</span><span class="ident" id="5632873">ParseInt</span><span class="op" id="5632881">(</span><span class="ident" id="5632882">lenstr</span><span class="op" id="5632888">,</span>&nbsp;<span class="num" id="5632890">10</span><span class="op" id="5632892">,</span>&nbsp;<span class="num" id="5632894">64</span><span class="op" id="5632896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632900">if</span>&nbsp;<span class="ident" id="5632903">err</span>&nbsp;<span class="op" id="5632907">!=</span>&nbsp;<span class="ident" id="5632910">nil</span>&nbsp;<span class="op" id="5632914">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5632919">return</span>&nbsp;<span class="ident" id="5632926">nil</span><span class="op" id="5632929">,</span>&nbsp;<span class="ident" id="5632931">errors</span><span class="op" id="5632937">.</span><span class="ident" id="5632938">New</span><span class="op" id="5632941">(</span><span class="string" id="5632942">&#34;cgi:&nbsp;bad&nbsp;CONTENT_LENGTH&nbsp;in&nbsp;environment:&nbsp;&#34;</span>&nbsp;<span class="op" id="5632985">+</span>&nbsp;<span class="ident" id="5632987">lenstr</span><span class="op" id="5632993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5632997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633001">r</span><span class="op" id="5633002">.</span><span class="ident" id="5633003">ContentLength</span>&nbsp;<span class="op" id="5633017">=</span>&nbsp;<span class="ident" id="5633019">clen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5633025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5633029">if</span>&nbsp;<span class="ident" id="5633032">ct</span>&nbsp;<span class="op" id="5633035">:=</span>&nbsp;<span class="ident" id="5633038">params</span><span class="op" id="5633044">[</span><span class="string" id="5633045">&#34;CONTENT_TYPE&#34;</span><span class="op" id="5633059">]</span><span class="op" id="5633060">;</span>&nbsp;<span class="ident" id="5633062">ct</span>&nbsp;<span class="op" id="5633065">!=</span>&nbsp;<span class="string" id="5633068">&#34;&#34;</span>&nbsp;<span class="op" id="5633071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633075">r</span><span class="op" id="5633076">.</span><span class="ident" id="5633077">Header</span><span class="op" id="5633083">.</span><span class="ident" id="5633084">Set</span><span class="op" id="5633087">(</span><span class="string" id="5633088">&#34;Content-Type&#34;</span><span class="op" id="5633102">,</span>&nbsp;<span class="ident" id="5633104">ct</span><span class="op" id="5633106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5633109">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5633113">//&nbsp;Copy&nbsp;&#34;HTTP_FOO_BAR&#34;&nbsp;variables&nbsp;to&nbsp;&#34;Foo-Bar&#34;&nbsp;Headers</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5633168">for</span>&nbsp;<span class="ident" id="5633172">k</span><span class="op" id="5633173">,</span>&nbsp;<span class="ident" id="5633175">v</span>&nbsp;<span class="op" id="5633177">:=</span>&nbsp;<span class="keyword" id="5633180">range</span>&nbsp;<span class="ident" id="5633186">params</span>&nbsp;<span class="op" id="5633193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5633197">if</span>&nbsp;<span class="op" id="5633200">!</span><span class="ident" id="5633201">strings</span><span class="op" id="5633208">.</span><span class="ident" id="5633209">HasPrefix</span><span class="op" id="5633218">(</span><span class="ident" id="5633219">k</span><span class="op" id="5633220">,</span>&nbsp;<span class="string" id="5633222">&#34;HTTP_&#34;</span><span class="op" id="5633229">)</span>&nbsp;<span class="op" id="5633231">||</span>&nbsp;<span class="ident" id="5633234">k</span>&nbsp;<span class="op" id="5633236">==</span>&nbsp;<span class="string" id="5633239">&#34;HTTP_HOST&#34;</span>&nbsp;<span class="op" id="5633251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5633256">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5633267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633271">r</span><span class="op" id="5633272">.</span><span class="ident" id="5633273">Header</span><span class="op" id="5633279">.</span><span class="ident" id="5633280">Add</span><span class="op" id="5633283">(</span><span class="ident" id="5633284">strings</span><span class="op" id="5633291">.</span><span class="ident" id="5633292">Replace</span><span class="op" id="5633299">(</span><span class="ident" id="5633300">k</span><span class="op" id="5633301">[</span><span class="num" id="5633302">5</span><span class="op" id="5633303">:</span><span class="op" id="5633304">]</span><span class="op" id="5633305">,</span>&nbsp;<span class="string" id="5633307">&#34;_&#34;</span><span class="op" id="5633310">,</span>&nbsp;<span class="string" id="5633312">&#34;-&#34;</span><span class="op" id="5633315">,</span>&nbsp;<span class="op" id="5633317">-</span><span class="num" id="5633318">1</span><span class="op" id="5633319">)</span><span class="op" id="5633320">,</span>&nbsp;<span class="ident" id="5633322">v</span><span class="op" id="5633323">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5633326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5633330">//&nbsp;TODO:&nbsp;cookies.&nbsp;&nbsp;parsing&nbsp;them&nbsp;isn&#39;t&nbsp;exported,&nbsp;though.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633388">uriStr</span>&nbsp;<span class="op" id="5633395">:=</span>&nbsp;<span class="ident" id="5633398">params</span><span class="op" id="5633404">[</span><span class="string" id="5633405">&#34;REQUEST_URI&#34;</span><span class="op" id="5633418">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5633421">if</span>&nbsp;<span class="ident" id="5633424">uriStr</span>&nbsp;<span class="op" id="5633431">==</span>&nbsp;<span class="string" id="5633434">&#34;&#34;</span>&nbsp;<span class="op" id="5633437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5633441">//&nbsp;Fallback&nbsp;to&nbsp;SCRIPT_NAME,&nbsp;PATH_INFO&nbsp;and&nbsp;QUERY_STRING.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633499">uriStr</span>&nbsp;<span class="op" id="5633506">=</span>&nbsp;<span class="ident" id="5633508">params</span><span class="op" id="5633514">[</span><span class="string" id="5633515">&#34;SCRIPT_NAME&#34;</span><span class="op" id="5633528">]</span>&nbsp;<span class="op" id="5633530">+</span>&nbsp;<span class="ident" id="5633532">params</span><span class="op" id="5633538">[</span><span class="string" id="5633539">&#34;PATH_INFO&#34;</span><span class="op" id="5633550">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633554">s</span>&nbsp;<span class="op" id="5633556">:=</span>&nbsp;<span class="ident" id="5633559">params</span><span class="op" id="5633565">[</span><span class="string" id="5633566">&#34;QUERY_STRING&#34;</span><span class="op" id="5633580">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5633584">if</span>&nbsp;<span class="ident" id="5633587">s</span>&nbsp;<span class="op" id="5633589">!=</span>&nbsp;<span class="string" id="5633592">&#34;&#34;</span>&nbsp;<span class="op" id="5633595">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633600">uriStr</span>&nbsp;<span class="op" id="5633607">+=</span>&nbsp;<span class="string" id="5633610">&#34;?&#34;</span>&nbsp;<span class="op" id="5633614">+</span>&nbsp;<span class="ident" id="5633616">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5633620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5633623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5633627">//&nbsp;There&#39;s&nbsp;apparently&nbsp;a&nbsp;de-facto&nbsp;standard&nbsp;for&nbsp;this.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5633680">//&nbsp;http://docstore.mik.ua/orelly/linux/cgi/ch03_02.htm#ch03-35636</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5633747">if</span>&nbsp;<span class="ident" id="5633750">s</span>&nbsp;<span class="op" id="5633752">:=</span>&nbsp;<span class="ident" id="5633755">params</span><span class="op" id="5633761">[</span><span class="string" id="5633762">&#34;HTTPS&#34;</span><span class="op" id="5633769">]</span><span class="op" id="5633770">;</span>&nbsp;<span class="ident" id="5633772">s</span>&nbsp;<span class="op" id="5633774">==</span>&nbsp;<span class="string" id="5633777">&#34;on&#34;</span>&nbsp;<span class="op" id="5633782">||</span>&nbsp;<span class="ident" id="5633785">s</span>&nbsp;<span class="op" id="5633787">==</span>&nbsp;<span class="string" id="5633790">&#34;ON&#34;</span>&nbsp;<span class="op" id="5633795">||</span>&nbsp;<span class="ident" id="5633798">s</span>&nbsp;<span class="op" id="5633800">==</span>&nbsp;<span class="string" id="5633803">&#34;1&#34;</span>&nbsp;<span class="op" id="5633807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633811">r</span><span class="op" id="5633812">.</span><span class="ident" id="5633813">TLS</span>&nbsp;<span class="op" id="5633817">=</span>&nbsp;<span class="op" id="5633819">&amp;</span><span class="ident" id="5633820">tls</span><span class="op" id="5633823">.</span><span class="ident" id="5633824">ConnectionState</span><span class="op" id="5633839">{</span><span class="ident" id="5633840">HandshakeComplete</span><span class="op" id="5633857">:</span>&nbsp;<span class="builtintype" id="5633859">true</span><span class="op" id="5633863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5633866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5633870">if</span>&nbsp;<span class="ident" id="5633873">r</span><span class="op" id="5633874">.</span><span class="ident" id="5633875">Host</span>&nbsp;<span class="op" id="5633880">!=</span>&nbsp;<span class="string" id="5633883">&#34;&#34;</span>&nbsp;<span class="op" id="5633886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5633890">//&nbsp;Hostname&nbsp;is&nbsp;provided,&nbsp;so&nbsp;we&nbsp;can&nbsp;reasonably&nbsp;construct&nbsp;a&nbsp;URL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633955">rawurl</span>&nbsp;<span class="op" id="5633962">:=</span>&nbsp;<span class="ident" id="5633965">r</span><span class="op" id="5633966">.</span><span class="ident" id="5633967">Host</span>&nbsp;<span class="op" id="5633972">+</span>&nbsp;<span class="ident" id="5633974">uriStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5633983">if</span>&nbsp;<span class="ident" id="5633986">r</span><span class="op" id="5633987">.</span><span class="ident" id="5633988">TLS</span>&nbsp;<span class="op" id="5633992">==</span>&nbsp;<span class="ident" id="5633995">nil</span>&nbsp;<span class="op" id="5633999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5634004">rawurl</span>&nbsp;<span class="op" id="5634011">=</span>&nbsp;<span class="string" id="5634013">&#34;http://&#34;</span>&nbsp;<span class="op" id="5634023">+</span>&nbsp;<span class="ident" id="5634025">rawurl</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5634034">}</span>&nbsp;<span class="keyword" id="5634036">else</span>&nbsp;<span class="op" id="5634041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5634046">rawurl</span>&nbsp;<span class="op" id="5634053">=</span>&nbsp;<span class="string" id="5634055">&#34;https://&#34;</span>&nbsp;<span class="op" id="5634066">+</span>&nbsp;<span class="ident" id="5634068">rawurl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5634077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5634081">url</span><span class="op" id="5634084">,</span>&nbsp;<span class="ident" id="5634086">err</span>&nbsp;<span class="op" id="5634090">:=</span>&nbsp;<span class="ident" id="5634093">url</span><span class="op" id="5634096">.</span><span class="ident" id="5634097">Parse</span><span class="op" id="5634102">(</span><span class="ident" id="5634103">rawurl</span><span class="op" id="5634109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5634113">if</span>&nbsp;<span class="ident" id="5634116">err</span>&nbsp;<span class="op" id="5634120">!=</span>&nbsp;<span class="ident" id="5634123">nil</span>&nbsp;<span class="op" id="5634127">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5634132">return</span>&nbsp;<span class="ident" id="5634139">nil</span><span class="op" id="5634142">,</span>&nbsp;<span class="ident" id="5634144">errors</span><span class="op" id="5634150">.</span><span class="ident" id="5634151">New</span><span class="op" id="5634154">(</span><span class="string" id="5634155">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;host&nbsp;and&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="5634212">+</span>&nbsp;<span class="ident" id="5634214">rawurl</span><span class="op" id="5634220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5634224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5634228">r</span><span class="op" id="5634229">.</span><span class="ident" id="5634230">URL</span>&nbsp;<span class="op" id="5634234">=</span>&nbsp;<span class="ident" id="5634236">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5634241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5634244">//&nbsp;Fallback&nbsp;logic&nbsp;if&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a&nbsp;Host&nbsp;header&nbsp;or&nbsp;the&nbsp;URL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5634305">//&nbsp;failed&nbsp;to&nbsp;parse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5634325">if</span>&nbsp;<span class="ident" id="5634328">r</span><span class="op" id="5634329">.</span><span class="ident" id="5634330">URL</span>&nbsp;<span class="op" id="5634334">==</span>&nbsp;<span class="ident" id="5634337">nil</span>&nbsp;<span class="op" id="5634341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5634345">url</span><span class="op" id="5634348">,</span>&nbsp;<span class="ident" id="5634350">err</span>&nbsp;<span class="op" id="5634354">:=</span>&nbsp;<span class="ident" id="5634357">url</span><span class="op" id="5634360">.</span><span class="ident" id="5634361">Parse</span><span class="op" id="5634366">(</span><span class="ident" id="5634367">uriStr</span><span class="op" id="5634373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5634377">if</span>&nbsp;<span class="ident" id="5634380">err</span>&nbsp;<span class="op" id="5634384">!=</span>&nbsp;<span class="ident" id="5634387">nil</span>&nbsp;<span class="op" id="5634391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5634396">return</span>&nbsp;<span class="ident" id="5634403">nil</span><span class="op" id="5634406">,</span>&nbsp;<span class="ident" id="5634408">errors</span><span class="op" id="5634414">.</span><span class="ident" id="5634415">New</span><span class="op" id="5634418">(</span><span class="string" id="5634419">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="5634467">+</span>&nbsp;<span class="ident" id="5634469">uriStr</span><span class="op" id="5634475">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5634479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5634483">r</span><span class="op" id="5634484">.</span><span class="ident" id="5634485">URL</span>&nbsp;<span class="op" id="5634489">=</span>&nbsp;<span class="ident" id="5634491">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5634496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5634500">//&nbsp;Request.RemoteAddr&nbsp;has&nbsp;its&nbsp;port&nbsp;set&nbsp;by&nbsp;Go&#39;s&nbsp;standard&nbsp;http</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5634562">//&nbsp;server,&nbsp;so&nbsp;we&nbsp;do&nbsp;here&nbsp;too.&nbsp;We&nbsp;don&#39;t&nbsp;have&nbsp;one,&nbsp;though,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5634626">//&nbsp;use&nbsp;a&nbsp;dummy&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5634647">r</span><span class="op" id="5634648">.</span><span class="ident" id="5634649">RemoteAddr</span>&nbsp;<span class="op" id="5634660">=</span>&nbsp;<span class="ident" id="5634662">net</span><span class="op" id="5634665">.</span><span class="ident" id="5634666">JoinHostPort</span><span class="op" id="5634678">(</span><span class="ident" id="5634679">params</span><span class="op" id="5634685">[</span><span class="string" id="5634686">&#34;REMOTE_ADDR&#34;</span><span class="op" id="5634699">]</span><span class="op" id="5634700">,</span>&nbsp;<span class="string" id="5634702">&#34;0&#34;</span><span class="op" id="5634705">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5634709">return</span>&nbsp;<span class="ident" id="5634716">r</span><span class="op" id="5634717">,</span>&nbsp;<span class="ident" id="5634719">nil</span><br>
<span class="lineno">140</span><span class="op" id="5634723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5634726">//&nbsp;Serve&nbsp;executes&nbsp;the&nbsp;provided&nbsp;Handler&nbsp;on&nbsp;the&nbsp;currently&nbsp;active&nbsp;CGI</span><br>
<span class="lineno"></span><span class="comment" id="5634793">//&nbsp;request,&nbsp;if&nbsp;any.&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;current&nbsp;CGI&nbsp;environment</span><br>
<span class="lineno"></span><span class="comment" id="5634851">//&nbsp;an&nbsp;error&nbsp;is&nbsp;returned.&nbsp;The&nbsp;provided&nbsp;handler&nbsp;may&nbsp;be&nbsp;nil&nbsp;to&nbsp;use</span><br>
<span class="lineno">145</span><span class="comment" id="5634915">//&nbsp;http.DefaultServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="5634940">func</span>&nbsp;<span class="ident" id="5634945">Serve</span><span class="op" id="5634950">(</span><span class="ident" id="5634951">handler</span>&nbsp;<span class="ident" id="5634959">http</span><span class="op" id="5634963">.</span><span class="ident" id="5634964">Handler</span><span class="op" id="5634971">)</span>&nbsp;<span class="builtintype" id="5634973">error</span>&nbsp;<span class="op" id="5634979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5634982">req</span><span class="op" id="5634985">,</span>&nbsp;<span class="ident" id="5634987">err</span>&nbsp;<span class="op" id="5634991">:=</span>&nbsp;<span class="ident" id="5634994">Request</span><span class="op" id="5635001">(</span><span class="op" id="5635002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635005">if</span>&nbsp;<span class="ident" id="5635008">err</span>&nbsp;<span class="op" id="5635012">!=</span>&nbsp;<span class="ident" id="5635015">nil</span>&nbsp;<span class="op" id="5635019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635023">return</span>&nbsp;<span class="ident" id="5635030">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5635035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635038">if</span>&nbsp;<span class="ident" id="5635041">handler</span>&nbsp;<span class="op" id="5635049">==</span>&nbsp;<span class="ident" id="5635052">nil</span>&nbsp;<span class="op" id="5635056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635060">handler</span>&nbsp;<span class="op" id="5635068">=</span>&nbsp;<span class="ident" id="5635070">http</span><span class="op" id="5635074">.</span><span class="ident" id="5635075">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5635092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635095">rw</span>&nbsp;<span class="op" id="5635098">:=</span>&nbsp;<span class="op" id="5635101">&amp;</span><span class="ident" id="5635102">response</span><span class="op" id="5635110">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635114">req</span><span class="op" id="5635117">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635122">req</span><span class="op" id="5635125">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635129">header</span><span class="op" id="5635135">:</span>&nbsp;<span class="builtinfunc" id="5635137">make</span><span class="op" id="5635141">(</span><span class="ident" id="5635142">http</span><span class="op" id="5635146">.</span><span class="ident" id="5635147">Header</span><span class="op" id="5635153">)</span><span class="op" id="5635154">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635158">bufw</span><span class="op" id="5635162">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5635166">bufio</span><span class="op" id="5635171">.</span><span class="ident" id="5635172">NewWriter</span><span class="op" id="5635181">(</span><span class="ident" id="5635182">os</span><span class="op" id="5635184">.</span><span class="ident" id="5635185">Stdout</span><span class="op" id="5635191">)</span><span class="op" id="5635192">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5635195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635198">handler</span><span class="op" id="5635205">.</span><span class="ident" id="5635206">ServeHTTP</span><span class="op" id="5635215">(</span><span class="ident" id="5635216">rw</span><span class="op" id="5635218">,</span>&nbsp;<span class="ident" id="5635220">req</span><span class="op" id="5635223">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635226">rw</span><span class="op" id="5635228">.</span><span class="ident" id="5635229">Write</span><span class="op" id="5635234">(</span><span class="ident" id="5635235">nil</span><span class="op" id="5635238">)</span>&nbsp;<span class="comment" id="5635240">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;response&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635273">if</span>&nbsp;<span class="ident" id="5635276">err</span>&nbsp;<span class="op" id="5635280">=</span>&nbsp;<span class="ident" id="5635282">rw</span><span class="op" id="5635284">.</span><span class="ident" id="5635285">bufw</span><span class="op" id="5635289">.</span><span class="ident" id="5635290">Flush</span><span class="op" id="5635295">(</span><span class="op" id="5635296">)</span><span class="op" id="5635297">;</span>&nbsp;<span class="ident" id="5635299">err</span>&nbsp;<span class="op" id="5635303">!=</span>&nbsp;<span class="ident" id="5635306">nil</span>&nbsp;<span class="op" id="5635310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635314">return</span>&nbsp;<span class="ident" id="5635321">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5635326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635329">return</span>&nbsp;<span class="ident" id="5635336">nil</span><br>
<span class="lineno">165</span><span class="op" id="5635340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5635343">type</span>&nbsp;<span class="ident" id="5635348">response</span>&nbsp;<span class="keyword" id="5635357">struct</span>&nbsp;<span class="op" id="5635364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635367">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5635378">*</span><span class="ident" id="5635379">http</span><span class="op" id="5635383">.</span><span class="ident" id="5635384">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635393">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635404">http</span><span class="op" id="5635408">.</span><span class="ident" id="5635409">Header</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635417">bufw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5635428">*</span><span class="ident" id="5635429">bufio</span><span class="op" id="5635434">.</span><span class="ident" id="5635435">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635443">headerSent</span>&nbsp;<span class="builtintype" id="5635454">bool</span><br>
<span class="lineno"></span><span class="op" id="5635459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5635462">func</span>&nbsp;<span class="op" id="5635467">(</span><span class="ident" id="5635468">r</span>&nbsp;<span class="op" id="5635470">*</span><span class="ident" id="5635471">response</span><span class="op" id="5635479">)</span>&nbsp;<span class="ident" id="5635481">Flush</span><span class="op" id="5635486">(</span><span class="op" id="5635487">)</span>&nbsp;<span class="op" id="5635489">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635492">r</span><span class="op" id="5635493">.</span><span class="ident" id="5635494">bufw</span><span class="op" id="5635498">.</span><span class="ident" id="5635499">Flush</span><span class="op" id="5635504">(</span><span class="op" id="5635505">)</span><br>
<span class="lineno"></span><span class="op" id="5635507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5635510">func</span>&nbsp;<span class="op" id="5635515">(</span><span class="ident" id="5635516">r</span>&nbsp;<span class="op" id="5635518">*</span><span class="ident" id="5635519">response</span><span class="op" id="5635527">)</span>&nbsp;<span class="ident" id="5635529">Header</span><span class="op" id="5635535">(</span><span class="op" id="5635536">)</span>&nbsp;<span class="ident" id="5635538">http</span><span class="op" id="5635542">.</span><span class="ident" id="5635543">Header</span>&nbsp;<span class="op" id="5635550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635553">return</span>&nbsp;<span class="ident" id="5635560">r</span><span class="op" id="5635561">.</span><span class="ident" id="5635562">header</span><br>
<span class="lineno">180</span><span class="op" id="5635569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5635572">func</span>&nbsp;<span class="op" id="5635577">(</span><span class="ident" id="5635578">r</span>&nbsp;<span class="op" id="5635580">*</span><span class="ident" id="5635581">response</span><span class="op" id="5635589">)</span>&nbsp;<span class="ident" id="5635591">Write</span><span class="op" id="5635596">(</span><span class="ident" id="5635597">p</span>&nbsp;<span class="op" id="5635599">[</span><span class="op" id="5635600">]</span><span class="builtintype" id="5635601">byte</span><span class="op" id="5635605">)</span>&nbsp;<span class="op" id="5635607">(</span><span class="ident" id="5635608">n</span>&nbsp;<span class="builtintype" id="5635610">int</span><span class="op" id="5635613">,</span>&nbsp;<span class="ident" id="5635615">err</span>&nbsp;<span class="builtintype" id="5635619">error</span><span class="op" id="5635624">)</span>&nbsp;<span class="op" id="5635626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635629">if</span>&nbsp;<span class="op" id="5635632">!</span><span class="ident" id="5635633">r</span><span class="op" id="5635634">.</span><span class="ident" id="5635635">headerSent</span>&nbsp;<span class="op" id="5635646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635650">r</span><span class="op" id="5635651">.</span><span class="ident" id="5635652">WriteHeader</span><span class="op" id="5635663">(</span><span class="ident" id="5635664">http</span><span class="op" id="5635668">.</span><span class="ident" id="5635669">StatusOK</span><span class="op" id="5635677">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5635680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635683">return</span>&nbsp;<span class="ident" id="5635690">r</span><span class="op" id="5635691">.</span><span class="ident" id="5635692">bufw</span><span class="op" id="5635696">.</span><span class="ident" id="5635697">Write</span><span class="op" id="5635702">(</span><span class="ident" id="5635703">p</span><span class="op" id="5635704">)</span><br>
<span class="lineno"></span><span class="op" id="5635706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5635709">func</span>&nbsp;<span class="op" id="5635714">(</span><span class="ident" id="5635715">r</span>&nbsp;<span class="op" id="5635717">*</span><span class="ident" id="5635718">response</span><span class="op" id="5635726">)</span>&nbsp;<span class="ident" id="5635728">WriteHeader</span><span class="op" id="5635739">(</span><span class="ident" id="5635740">code</span>&nbsp;<span class="builtintype" id="5635745">int</span><span class="op" id="5635748">)</span>&nbsp;<span class="op" id="5635750">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635753">if</span>&nbsp;<span class="ident" id="5635756">r</span><span class="op" id="5635757">.</span><span class="ident" id="5635758">headerSent</span>&nbsp;<span class="op" id="5635769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5635773">//&nbsp;Note:&nbsp;explicitly&nbsp;using&nbsp;Stderr,&nbsp;as&nbsp;Stdout&nbsp;is&nbsp;our&nbsp;HTTP&nbsp;output.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635839">fmt</span><span class="op" id="5635842">.</span><span class="ident" id="5635843">Fprintf</span><span class="op" id="5635850">(</span><span class="ident" id="5635851">os</span><span class="op" id="5635853">.</span><span class="ident" id="5635854">Stderr</span><span class="op" id="5635860">,</span>&nbsp;<span class="string" id="5635862">&#34;CGI&nbsp;attempted&nbsp;to&nbsp;write&nbsp;header&nbsp;twice&nbsp;on&nbsp;request&nbsp;for&nbsp;%s&#34;</span><span class="op" id="5635917">,</span>&nbsp;<span class="ident" id="5635919">r</span><span class="op" id="5635920">.</span><span class="ident" id="5635921">req</span><span class="op" id="5635924">.</span><span class="ident" id="5635925">URL</span><span class="op" id="5635928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635932">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5635940">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635943">r</span><span class="op" id="5635944">.</span><span class="ident" id="5635945">headerSent</span>&nbsp;<span class="op" id="5635956">=</span>&nbsp;<span class="builtintype" id="5635958">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635964">fmt</span><span class="op" id="5635967">.</span><span class="ident" id="5635968">Fprintf</span><span class="op" id="5635975">(</span><span class="ident" id="5635976">r</span><span class="op" id="5635977">.</span><span class="ident" id="5635978">bufw</span><span class="op" id="5635982">,</span>&nbsp;<span class="string" id="5635984">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="5636003">,</span>&nbsp;<span class="ident" id="5636005">code</span><span class="op" id="5636009">,</span>&nbsp;<span class="ident" id="5636011">http</span><span class="op" id="5636015">.</span><span class="ident" id="5636016">StatusText</span><span class="op" id="5636026">(</span><span class="ident" id="5636027">code</span><span class="op" id="5636031">)</span><span class="op" id="5636032">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5636036">//&nbsp;Set&nbsp;a&nbsp;default&nbsp;Content-Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5636067">if</span>&nbsp;<span class="ident" id="5636070">_</span><span class="op" id="5636071">,</span>&nbsp;<span class="ident" id="5636073">hasType</span>&nbsp;<span class="op" id="5636081">:=</span>&nbsp;<span class="ident" id="5636084">r</span><span class="op" id="5636085">.</span><span class="ident" id="5636086">header</span><span class="op" id="5636092">[</span><span class="string" id="5636093">&#34;Content-Type&#34;</span><span class="op" id="5636107">]</span><span class="op" id="5636108">;</span>&nbsp;<span class="op" id="5636110">!</span><span class="ident" id="5636111">hasType</span>&nbsp;<span class="op" id="5636119">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5636123">r</span><span class="op" id="5636124">.</span><span class="ident" id="5636125">header</span><span class="op" id="5636131">.</span><span class="ident" id="5636132">Add</span><span class="op" id="5636135">(</span><span class="string" id="5636136">&#34;Content-Type&#34;</span><span class="op" id="5636150">,</span>&nbsp;<span class="string" id="5636152">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="5636178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5636181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5636185">r</span><span class="op" id="5636186">.</span><span class="ident" id="5636187">header</span><span class="op" id="5636193">.</span><span class="ident" id="5636194">Write</span><span class="op" id="5636199">(</span><span class="ident" id="5636200">r</span><span class="op" id="5636201">.</span><span class="ident" id="5636202">bufw</span><span class="op" id="5636206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5636209">r</span><span class="op" id="5636210">.</span><span class="ident" id="5636211">bufw</span><span class="op" id="5636215">.</span><span class="ident" id="5636216">WriteString</span><span class="op" id="5636227">(</span><span class="string" id="5636228">&#34;\r\n&#34;</span><span class="op" id="5636234">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5636237">r</span><span class="op" id="5636238">.</span><span class="ident" id="5636239">bufw</span><span class="op" id="5636243">.</span><span class="ident" id="5636244">Flush</span><span class="op" id="5636249">(</span><span class="op" id="5636250">)</span><br>
<span class="lineno"></span><span class="op" id="5636252">}</span>
</div>
</body>
</html>
