<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html" class="current">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5779424">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5779479">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5779533">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5779584">//&nbsp;Package&nbsp;sql&nbsp;provides&nbsp;a&nbsp;generic&nbsp;interface&nbsp;around&nbsp;SQL&nbsp;(or&nbsp;SQL-like)</span><br>
<span class="lineno"></span><span class="comment" id="5779653">//&nbsp;databases.</span><br>
<span class="lineno"></span><span class="comment" id="5779667">//</span><br>
<span class="lineno"></span><span class="comment" id="5779670">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;must&nbsp;be&nbsp;used&nbsp;in&nbsp;conjunction&nbsp;with&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="5779741">//&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for&nbsp;a&nbsp;list&nbsp;of&nbsp;drivers.</span><br>
<span class="lineno">10</span><span class="comment" id="5779802">//</span><br>
<span class="lineno"></span><span class="comment" id="5779805">//&nbsp;For&nbsp;more&nbsp;usage&nbsp;examples,&nbsp;see&nbsp;the&nbsp;wiki&nbsp;page&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5779854">//&nbsp;http://golang.org/s/sqlwiki.</span><br>
<span class="lineno"></span><span class="keyword" id="5779886">package</span>&nbsp;<span class="ident" id="5779894">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5779899">import</span>&nbsp;<span class="op" id="5779906">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5779909">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5779932">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5779942">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5779949">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5779955">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5779966">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5779974">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5779981">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5779984">var</span>&nbsp;<span class="ident" id="5779988">drivers</span>&nbsp;<span class="op" id="5779996">=</span>&nbsp;<span class="builtinfunc" id="5779998">make</span><span class="op" id="5780002">(</span><span class="keyword" id="5780003">map</span><span class="op" id="5780006">[</span><span class="builtintype" id="5780007">string</span><span class="op" id="5780013">]</span><span class="ident" id="5780014">driver</span><span class="op" id="5780020">.</span><span class="ident" id="5780021">Driver</span><span class="op" id="5780027">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5780030">//&nbsp;Register&nbsp;makes&nbsp;a&nbsp;database&nbsp;driver&nbsp;available&nbsp;by&nbsp;the&nbsp;provided&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="5780098">//&nbsp;If&nbsp;Register&nbsp;is&nbsp;called&nbsp;twice&nbsp;with&nbsp;the&nbsp;same&nbsp;name&nbsp;or&nbsp;if&nbsp;driver&nbsp;is&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="5780169">//&nbsp;it&nbsp;panics.</span><br>
<span class="lineno">30</span><span class="keyword" id="5780183">func</span>&nbsp;<span class="ident" id="5780188">Register</span><span class="op" id="5780196">(</span><span class="ident" id="5780197">name</span>&nbsp;<span class="builtintype" id="5780202">string</span><span class="op" id="5780208">,</span>&nbsp;<span class="ident" id="5780210">driver</span>&nbsp;<span class="ident" id="5780217">driver</span><span class="op" id="5780223">.</span><span class="ident" id="5780224">Driver</span><span class="op" id="5780230">)</span>&nbsp;<span class="op" id="5780232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780235">if</span>&nbsp;<span class="ident" id="5780238">driver</span>&nbsp;<span class="op" id="5780245">==</span>&nbsp;<span class="ident" id="5780248">nil</span>&nbsp;<span class="op" id="5780252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5780256">panic</span><span class="op" id="5780261">(</span><span class="string" id="5780262">&#34;sql:&nbsp;Register&nbsp;driver&nbsp;is&nbsp;nil&#34;</span><span class="op" id="5780291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5780294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780297">if</span>&nbsp;<span class="ident" id="5780300">_</span><span class="op" id="5780301">,</span>&nbsp;<span class="ident" id="5780303">dup</span>&nbsp;<span class="op" id="5780307">:=</span>&nbsp;<span class="ident" id="5780310">drivers</span><span class="op" id="5780317">[</span><span class="ident" id="5780318">name</span><span class="op" id="5780322">]</span><span class="op" id="5780323">;</span>&nbsp;<span class="ident" id="5780325">dup</span>&nbsp;<span class="op" id="5780329">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5780333">panic</span><span class="op" id="5780338">(</span><span class="string" id="5780339">&#34;sql:&nbsp;Register&nbsp;called&nbsp;twice&nbsp;for&nbsp;driver&nbsp;&#34;</span>&nbsp;<span class="op" id="5780380">+</span>&nbsp;<span class="ident" id="5780382">name</span><span class="op" id="5780386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5780389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5780392">drivers</span><span class="op" id="5780399">[</span><span class="ident" id="5780400">name</span><span class="op" id="5780404">]</span>&nbsp;<span class="op" id="5780406">=</span>&nbsp;<span class="ident" id="5780408">driver</span><br>
<span class="lineno"></span><span class="op" id="5780415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="5780418">func</span>&nbsp;<span class="ident" id="5780423">unregisterAllDrivers</span><span class="op" id="5780443">(</span><span class="op" id="5780444">)</span>&nbsp;<span class="op" id="5780446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5780449">//&nbsp;For&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5780464">drivers</span>&nbsp;<span class="op" id="5780472">=</span>&nbsp;<span class="builtinfunc" id="5780474">make</span><span class="op" id="5780478">(</span><span class="keyword" id="5780479">map</span><span class="op" id="5780482">[</span><span class="builtintype" id="5780483">string</span><span class="op" id="5780489">]</span><span class="ident" id="5780490">driver</span><span class="op" id="5780496">.</span><span class="ident" id="5780497">Driver</span><span class="op" id="5780503">)</span><br>
<span class="lineno"></span><span class="op" id="5780505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5780508">//&nbsp;Drivers&nbsp;returns&nbsp;a&nbsp;sorted&nbsp;list&nbsp;of&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;registered&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="keyword" id="5780581">func</span>&nbsp;<span class="ident" id="5780586">Drivers</span><span class="op" id="5780593">(</span><span class="op" id="5780594">)</span>&nbsp;<span class="op" id="5780596">[</span><span class="op" id="5780597">]</span><span class="builtintype" id="5780598">string</span>&nbsp;<span class="op" id="5780605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780608">var</span>&nbsp;<span class="ident" id="5780612">list</span>&nbsp;<span class="op" id="5780617">[</span><span class="op" id="5780618">]</span><span class="builtintype" id="5780619">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780627">for</span>&nbsp;<span class="ident" id="5780631">name</span>&nbsp;<span class="op" id="5780636">:=</span>&nbsp;<span class="keyword" id="5780639">range</span>&nbsp;<span class="ident" id="5780645">drivers</span>&nbsp;<span class="op" id="5780653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5780657">list</span>&nbsp;<span class="op" id="5780662">=</span>&nbsp;<span class="builtinfunc" id="5780664">append</span><span class="op" id="5780670">(</span><span class="ident" id="5780671">list</span><span class="op" id="5780675">,</span>&nbsp;<span class="ident" id="5780677">name</span><span class="op" id="5780681">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5780684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5780687">sort</span><span class="op" id="5780691">.</span><span class="ident" id="5780692">Strings</span><span class="op" id="5780699">(</span><span class="ident" id="5780700">list</span><span class="op" id="5780704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5780707">return</span>&nbsp;<span class="ident" id="5780714">list</span><br>
<span class="lineno"></span><span class="op" id="5780719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5780722">//&nbsp;RawBytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;slice&nbsp;that&nbsp;holds&nbsp;a&nbsp;reference&nbsp;to&nbsp;memory&nbsp;owned&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5780792">//&nbsp;the&nbsp;database&nbsp;itself.&nbsp;After&nbsp;a&nbsp;Scan&nbsp;into&nbsp;a&nbsp;RawBytes,&nbsp;the&nbsp;slice&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="5780864">//&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;Next,&nbsp;Scan,&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="5780918">type</span>&nbsp;<span class="ident" id="5780923">RawBytes</span>&nbsp;<span class="op" id="5780932">[</span><span class="op" id="5780933">]</span><span class="builtintype" id="5780934">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="5780940">//&nbsp;NullString&nbsp;represents&nbsp;a&nbsp;string&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5780992">//&nbsp;NullString&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5781042">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination:</span><br>
<span class="lineno"></span><span class="comment" id="5781083">//</span><br>
<span class="lineno"></span><span class="comment" id="5781086">//&nbsp;&nbsp;var&nbsp;s&nbsp;NullString</span><br>
<span class="lineno">65</span><span class="comment" id="5781107">//&nbsp;&nbsp;err&nbsp;:=&nbsp;db.QueryRow(&#34;SELECT&nbsp;name&nbsp;FROM&nbsp;foo&nbsp;WHERE&nbsp;id=?&#34;,&nbsp;id).Scan(&amp;s)</span><br>
<span class="lineno"></span><span class="comment" id="5781178">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5781186">//&nbsp;&nbsp;if&nbsp;s.Valid&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="5781203">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;use&nbsp;s.String</span><br>
<span class="lineno"></span><span class="comment" id="5781226">//&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno">70</span><span class="comment" id="5781239">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;NULL&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5781260">//&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="5781266">//</span><br>
<span class="lineno"></span><span class="keyword" id="5781269">type</span>&nbsp;<span class="ident" id="5781274">NullString</span>&nbsp;<span class="keyword" id="5781285">struct</span>&nbsp;<span class="op" id="5781292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5781295">String</span>&nbsp;<span class="builtintype" id="5781302">string</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5781310">Valid</span>&nbsp;&nbsp;<span class="builtintype" id="5781317">bool</span>&nbsp;<span class="comment" id="5781322">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;String&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5781361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5781364">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5781406">func</span>&nbsp;<span class="op" id="5781411">(</span><span class="ident" id="5781412">ns</span>&nbsp;<span class="op" id="5781415">*</span><span class="ident" id="5781416">NullString</span><span class="op" id="5781426">)</span>&nbsp;<span class="ident" id="5781428">Scan</span><span class="op" id="5781432">(</span><span class="ident" id="5781433">value</span>&nbsp;<span class="keyword" id="5781439">interface</span><span class="op" id="5781448">{</span><span class="op" id="5781449">}</span><span class="op" id="5781450">)</span>&nbsp;<span class="builtintype" id="5781452">error</span>&nbsp;<span class="op" id="5781458">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5781461">if</span>&nbsp;<span class="ident" id="5781464">value</span>&nbsp;<span class="op" id="5781470">==</span>&nbsp;<span class="ident" id="5781473">nil</span>&nbsp;<span class="op" id="5781477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5781481">ns</span><span class="op" id="5781483">.</span><span class="ident" id="5781484">String</span><span class="op" id="5781490">,</span>&nbsp;<span class="ident" id="5781492">ns</span><span class="op" id="5781494">.</span><span class="ident" id="5781495">Valid</span>&nbsp;<span class="op" id="5781501">=</span>&nbsp;<span class="string" id="5781503">&#34;&#34;</span><span class="op" id="5781505">,</span>&nbsp;<span class="builtintype" id="5781507">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5781515">return</span>&nbsp;<span class="ident" id="5781522">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5781527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5781530">ns</span><span class="op" id="5781532">.</span><span class="ident" id="5781533">Valid</span>&nbsp;<span class="op" id="5781539">=</span>&nbsp;<span class="builtintype" id="5781541">true</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5781547">return</span>&nbsp;<span class="ident" id="5781554">convertAssign</span><span class="op" id="5781567">(</span><span class="op" id="5781568">&amp;</span><span class="ident" id="5781569">ns</span><span class="op" id="5781571">.</span><span class="ident" id="5781572">String</span><span class="op" id="5781578">,</span>&nbsp;<span class="ident" id="5781580">value</span><span class="op" id="5781585">)</span><br>
<span class="lineno"></span><span class="op" id="5781587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5781590">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5781639">func</span>&nbsp;<span class="op" id="5781644">(</span><span class="ident" id="5781645">ns</span>&nbsp;<span class="ident" id="5781648">NullString</span><span class="op" id="5781658">)</span>&nbsp;<span class="ident" id="5781660">Value</span><span class="op" id="5781665">(</span><span class="op" id="5781666">)</span>&nbsp;<span class="op" id="5781668">(</span><span class="ident" id="5781669">driver</span><span class="op" id="5781675">.</span><span class="ident" id="5781676">Value</span><span class="op" id="5781681">,</span>&nbsp;<span class="builtintype" id="5781683">error</span><span class="op" id="5781688">)</span>&nbsp;<span class="op" id="5781690">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5781693">if</span>&nbsp;<span class="op" id="5781696">!</span><span class="ident" id="5781697">ns</span><span class="op" id="5781699">.</span><span class="ident" id="5781700">Valid</span>&nbsp;<span class="op" id="5781706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5781710">return</span>&nbsp;<span class="ident" id="5781717">nil</span><span class="op" id="5781720">,</span>&nbsp;<span class="ident" id="5781722">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5781727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5781730">return</span>&nbsp;<span class="ident" id="5781737">ns</span><span class="op" id="5781739">.</span><span class="ident" id="5781740">String</span><span class="op" id="5781746">,</span>&nbsp;<span class="ident" id="5781748">nil</span><br>
<span class="lineno"></span><span class="op" id="5781752">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="5781755">//&nbsp;NullInt64&nbsp;represents&nbsp;an&nbsp;int64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5781806">//&nbsp;NullInt64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5781855">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="5781919">type</span>&nbsp;<span class="ident" id="5781924">NullInt64</span>&nbsp;<span class="keyword" id="5781934">struct</span>&nbsp;<span class="op" id="5781941">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5781944">Int64</span>&nbsp;<span class="ident" id="5781950">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5781957">Valid</span>&nbsp;<span class="builtintype" id="5781963">bool</span>&nbsp;<span class="comment" id="5781968">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Int64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5782006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5782009">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno">105</span><span class="keyword" id="5782051">func</span>&nbsp;<span class="op" id="5782056">(</span><span class="ident" id="5782057">n</span>&nbsp;<span class="op" id="5782059">*</span><span class="ident" id="5782060">NullInt64</span><span class="op" id="5782069">)</span>&nbsp;<span class="ident" id="5782071">Scan</span><span class="op" id="5782075">(</span><span class="ident" id="5782076">value</span>&nbsp;<span class="keyword" id="5782082">interface</span><span class="op" id="5782091">{</span><span class="op" id="5782092">}</span><span class="op" id="5782093">)</span>&nbsp;<span class="builtintype" id="5782095">error</span>&nbsp;<span class="op" id="5782101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5782104">if</span>&nbsp;<span class="ident" id="5782107">value</span>&nbsp;<span class="op" id="5782113">==</span>&nbsp;<span class="ident" id="5782116">nil</span>&nbsp;<span class="op" id="5782120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782124">n</span><span class="op" id="5782125">.</span><span class="ident" id="5782126">Int64</span><span class="op" id="5782131">,</span>&nbsp;<span class="ident" id="5782133">n</span><span class="op" id="5782134">.</span><span class="ident" id="5782135">Valid</span>&nbsp;<span class="op" id="5782141">=</span>&nbsp;<span class="num" id="5782143">0</span><span class="op" id="5782144">,</span>&nbsp;<span class="builtintype" id="5782146">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5782154">return</span>&nbsp;<span class="ident" id="5782161">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5782166">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782169">n</span><span class="op" id="5782170">.</span><span class="ident" id="5782171">Valid</span>&nbsp;<span class="op" id="5782177">=</span>&nbsp;<span class="builtintype" id="5782179">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5782185">return</span>&nbsp;<span class="ident" id="5782192">convertAssign</span><span class="op" id="5782205">(</span><span class="op" id="5782206">&amp;</span><span class="ident" id="5782207">n</span><span class="op" id="5782208">.</span><span class="ident" id="5782209">Int64</span><span class="op" id="5782214">,</span>&nbsp;<span class="ident" id="5782216">value</span><span class="op" id="5782221">)</span><br>
<span class="lineno"></span><span class="op" id="5782223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5782226">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno">115</span><span class="keyword" id="5782275">func</span>&nbsp;<span class="op" id="5782280">(</span><span class="ident" id="5782281">n</span>&nbsp;<span class="ident" id="5782283">NullInt64</span><span class="op" id="5782292">)</span>&nbsp;<span class="ident" id="5782294">Value</span><span class="op" id="5782299">(</span><span class="op" id="5782300">)</span>&nbsp;<span class="op" id="5782302">(</span><span class="ident" id="5782303">driver</span><span class="op" id="5782309">.</span><span class="ident" id="5782310">Value</span><span class="op" id="5782315">,</span>&nbsp;<span class="builtintype" id="5782317">error</span><span class="op" id="5782322">)</span>&nbsp;<span class="op" id="5782324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5782327">if</span>&nbsp;<span class="op" id="5782330">!</span><span class="ident" id="5782331">n</span><span class="op" id="5782332">.</span><span class="ident" id="5782333">Valid</span>&nbsp;<span class="op" id="5782339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5782343">return</span>&nbsp;<span class="ident" id="5782350">nil</span><span class="op" id="5782353">,</span>&nbsp;<span class="ident" id="5782355">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5782360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5782363">return</span>&nbsp;<span class="ident" id="5782370">n</span><span class="op" id="5782371">.</span><span class="ident" id="5782372">Int64</span><span class="op" id="5782377">,</span>&nbsp;<span class="ident" id="5782379">nil</span><br>
<span class="lineno">120</span><span class="op" id="5782383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5782386">//&nbsp;NullFloat64&nbsp;represents&nbsp;a&nbsp;float64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5782440">//&nbsp;NullFloat64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5782491">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno">125</span><span class="keyword" id="5782555">type</span>&nbsp;<span class="ident" id="5782560">NullFloat64</span>&nbsp;<span class="keyword" id="5782572">struct</span>&nbsp;<span class="op" id="5782579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782582">Float64</span>&nbsp;<span class="builtintype" id="5782590">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782599">Valid</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5782607">bool</span>&nbsp;<span class="comment" id="5782612">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Float64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5782652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="5782655">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5782697">func</span>&nbsp;<span class="op" id="5782702">(</span><span class="ident" id="5782703">n</span>&nbsp;<span class="op" id="5782705">*</span><span class="ident" id="5782706">NullFloat64</span><span class="op" id="5782717">)</span>&nbsp;<span class="ident" id="5782719">Scan</span><span class="op" id="5782723">(</span><span class="ident" id="5782724">value</span>&nbsp;<span class="keyword" id="5782730">interface</span><span class="op" id="5782739">{</span><span class="op" id="5782740">}</span><span class="op" id="5782741">)</span>&nbsp;<span class="builtintype" id="5782743">error</span>&nbsp;<span class="op" id="5782749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5782752">if</span>&nbsp;<span class="ident" id="5782755">value</span>&nbsp;<span class="op" id="5782761">==</span>&nbsp;<span class="ident" id="5782764">nil</span>&nbsp;<span class="op" id="5782768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782772">n</span><span class="op" id="5782773">.</span><span class="ident" id="5782774">Float64</span><span class="op" id="5782781">,</span>&nbsp;<span class="ident" id="5782783">n</span><span class="op" id="5782784">.</span><span class="ident" id="5782785">Valid</span>&nbsp;<span class="op" id="5782791">=</span>&nbsp;<span class="num" id="5782793">0</span><span class="op" id="5782794">,</span>&nbsp;<span class="builtintype" id="5782796">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5782804">return</span>&nbsp;<span class="ident" id="5782811">nil</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5782816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5782819">n</span><span class="op" id="5782820">.</span><span class="ident" id="5782821">Valid</span>&nbsp;<span class="op" id="5782827">=</span>&nbsp;<span class="builtintype" id="5782829">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5782835">return</span>&nbsp;<span class="ident" id="5782842">convertAssign</span><span class="op" id="5782855">(</span><span class="op" id="5782856">&amp;</span><span class="ident" id="5782857">n</span><span class="op" id="5782858">.</span><span class="ident" id="5782859">Float64</span><span class="op" id="5782866">,</span>&nbsp;<span class="ident" id="5782868">value</span><span class="op" id="5782873">)</span><br>
<span class="lineno"></span><span class="op" id="5782875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="5782878">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5782927">func</span>&nbsp;<span class="op" id="5782932">(</span><span class="ident" id="5782933">n</span>&nbsp;<span class="ident" id="5782935">NullFloat64</span><span class="op" id="5782946">)</span>&nbsp;<span class="ident" id="5782948">Value</span><span class="op" id="5782953">(</span><span class="op" id="5782954">)</span>&nbsp;<span class="op" id="5782956">(</span><span class="ident" id="5782957">driver</span><span class="op" id="5782963">.</span><span class="ident" id="5782964">Value</span><span class="op" id="5782969">,</span>&nbsp;<span class="builtintype" id="5782971">error</span><span class="op" id="5782976">)</span>&nbsp;<span class="op" id="5782978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5782981">if</span>&nbsp;<span class="op" id="5782984">!</span><span class="ident" id="5782985">n</span><span class="op" id="5782986">.</span><span class="ident" id="5782987">Valid</span>&nbsp;<span class="op" id="5782993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5782997">return</span>&nbsp;<span class="ident" id="5783004">nil</span><span class="op" id="5783007">,</span>&nbsp;<span class="ident" id="5783009">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5783014">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5783017">return</span>&nbsp;<span class="ident" id="5783024">n</span><span class="op" id="5783025">.</span><span class="ident" id="5783026">Float64</span><span class="op" id="5783033">,</span>&nbsp;<span class="ident" id="5783035">nil</span><br>
<span class="lineno"></span><span class="op" id="5783039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5783042">//&nbsp;NullBool&nbsp;represents&nbsp;a&nbsp;bool&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5783090">//&nbsp;NullBool&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="5783138">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="5783202">type</span>&nbsp;<span class="ident" id="5783207">NullBool</span>&nbsp;<span class="keyword" id="5783216">struct</span>&nbsp;<span class="op" id="5783223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5783226">Bool</span>&nbsp;&nbsp;<span class="builtintype" id="5783232">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5783238">Valid</span>&nbsp;<span class="builtintype" id="5783244">bool</span>&nbsp;<span class="comment" id="5783249">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Bool&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5783286">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5783289">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5783331">func</span>&nbsp;<span class="op" id="5783336">(</span><span class="ident" id="5783337">n</span>&nbsp;<span class="op" id="5783339">*</span><span class="ident" id="5783340">NullBool</span><span class="op" id="5783348">)</span>&nbsp;<span class="ident" id="5783350">Scan</span><span class="op" id="5783354">(</span><span class="ident" id="5783355">value</span>&nbsp;<span class="keyword" id="5783361">interface</span><span class="op" id="5783370">{</span><span class="op" id="5783371">}</span><span class="op" id="5783372">)</span>&nbsp;<span class="builtintype" id="5783374">error</span>&nbsp;<span class="op" id="5783380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5783383">if</span>&nbsp;<span class="ident" id="5783386">value</span>&nbsp;<span class="op" id="5783392">==</span>&nbsp;<span class="ident" id="5783395">nil</span>&nbsp;<span class="op" id="5783399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5783403">n</span><span class="op" id="5783404">.</span><span class="ident" id="5783405">Bool</span><span class="op" id="5783409">,</span>&nbsp;<span class="ident" id="5783411">n</span><span class="op" id="5783412">.</span><span class="ident" id="5783413">Valid</span>&nbsp;<span class="op" id="5783419">=</span>&nbsp;<span class="builtintype" id="5783421">false</span><span class="op" id="5783426">,</span>&nbsp;<span class="builtintype" id="5783428">false</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5783436">return</span>&nbsp;<span class="ident" id="5783443">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5783448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5783451">n</span><span class="op" id="5783452">.</span><span class="ident" id="5783453">Valid</span>&nbsp;<span class="op" id="5783459">=</span>&nbsp;<span class="builtintype" id="5783461">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5783467">return</span>&nbsp;<span class="ident" id="5783474">convertAssign</span><span class="op" id="5783487">(</span><span class="op" id="5783488">&amp;</span><span class="ident" id="5783489">n</span><span class="op" id="5783490">.</span><span class="ident" id="5783491">Bool</span><span class="op" id="5783495">,</span>&nbsp;<span class="ident" id="5783497">value</span><span class="op" id="5783502">)</span><br>
<span class="lineno"></span><span class="op" id="5783504">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="5783507">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5783556">func</span>&nbsp;<span class="op" id="5783561">(</span><span class="ident" id="5783562">n</span>&nbsp;<span class="ident" id="5783564">NullBool</span><span class="op" id="5783572">)</span>&nbsp;<span class="ident" id="5783574">Value</span><span class="op" id="5783579">(</span><span class="op" id="5783580">)</span>&nbsp;<span class="op" id="5783582">(</span><span class="ident" id="5783583">driver</span><span class="op" id="5783589">.</span><span class="ident" id="5783590">Value</span><span class="op" id="5783595">,</span>&nbsp;<span class="builtintype" id="5783597">error</span><span class="op" id="5783602">)</span>&nbsp;<span class="op" id="5783604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5783607">if</span>&nbsp;<span class="op" id="5783610">!</span><span class="ident" id="5783611">n</span><span class="op" id="5783612">.</span><span class="ident" id="5783613">Valid</span>&nbsp;<span class="op" id="5783619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5783623">return</span>&nbsp;<span class="ident" id="5783630">nil</span><span class="op" id="5783633">,</span>&nbsp;<span class="ident" id="5783635">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5783640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5783643">return</span>&nbsp;<span class="ident" id="5783650">n</span><span class="op" id="5783651">.</span><span class="ident" id="5783652">Bool</span><span class="op" id="5783656">,</span>&nbsp;<span class="ident" id="5783658">nil</span><br>
<span class="lineno"></span><span class="op" id="5783662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5783665">//&nbsp;Scanner&nbsp;is&nbsp;an&nbsp;interface&nbsp;used&nbsp;by&nbsp;Scan.</span><br>
<span class="lineno">175</span><span class="keyword" id="5783706">type</span>&nbsp;<span class="ident" id="5783711">Scanner</span>&nbsp;<span class="keyword" id="5783719">interface</span>&nbsp;<span class="op" id="5783729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783732">//&nbsp;Scan&nbsp;assigns&nbsp;a&nbsp;value&nbsp;from&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783781">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783785">//&nbsp;The&nbsp;src&nbsp;value&nbsp;will&nbsp;be&nbsp;of&nbsp;one&nbsp;of&nbsp;the&nbsp;following&nbsp;restricted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783846">//&nbsp;set&nbsp;of&nbsp;types:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783864">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783868">//&nbsp;&nbsp;&nbsp;&nbsp;int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783881">//&nbsp;&nbsp;&nbsp;&nbsp;float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783896">//&nbsp;&nbsp;&nbsp;&nbsp;bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783908">//&nbsp;&nbsp;&nbsp;&nbsp;[]byte</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783922">//&nbsp;&nbsp;&nbsp;&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783936">//&nbsp;&nbsp;&nbsp;&nbsp;time.Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783953">//&nbsp;&nbsp;&nbsp;&nbsp;nil&nbsp;-&nbsp;for&nbsp;NULL&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783982">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5783986">//&nbsp;An&nbsp;error&nbsp;should&nbsp;be&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;can&nbsp;not&nbsp;be&nbsp;stored</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5784049">//&nbsp;without&nbsp;loss&nbsp;of&nbsp;information.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5784082">Scan</span><span class="op" id="5784086">(</span><span class="ident" id="5784087">src</span>&nbsp;<span class="keyword" id="5784091">interface</span><span class="op" id="5784100">{</span><span class="op" id="5784101">}</span><span class="op" id="5784102">)</span>&nbsp;<span class="builtintype" id="5784104">error</span><br>
<span class="lineno"></span><span class="op" id="5784110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5784113">//&nbsp;ErrNoRows&nbsp;is&nbsp;returned&nbsp;by&nbsp;Scan&nbsp;when&nbsp;QueryRow&nbsp;doesn&#39;t&nbsp;return&nbsp;a</span><br>
<span class="lineno">195</span><span class="comment" id="5784177">//&nbsp;row.&nbsp;In&nbsp;such&nbsp;a&nbsp;case,&nbsp;QueryRow&nbsp;returns&nbsp;a&nbsp;placeholder&nbsp;*Row&nbsp;value&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5784248">//&nbsp;defers&nbsp;this&nbsp;error&nbsp;until&nbsp;a&nbsp;Scan.</span><br>
<span class="lineno"></span><span class="keyword" id="5784283">var</span>&nbsp;<span class="ident" id="5784287">ErrNoRows</span>&nbsp;<span class="op" id="5784297">=</span>&nbsp;<span class="ident" id="5784299">errors</span><span class="op" id="5784305">.</span><span class="ident" id="5784306">New</span><span class="op" id="5784309">(</span><span class="string" id="5784310">&#34;sql:&nbsp;no&nbsp;rows&nbsp;in&nbsp;result&nbsp;set&#34;</span><span class="op" id="5784338">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5784341">//&nbsp;DB&nbsp;is&nbsp;a&nbsp;database&nbsp;handle&nbsp;representing&nbsp;a&nbsp;pool&nbsp;of&nbsp;zero&nbsp;or&nbsp;more</span><br>
<span class="lineno">200</span><span class="comment" id="5784404">//&nbsp;underlying&nbsp;connections.&nbsp;It&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple</span><br>
<span class="lineno"></span><span class="comment" id="5784472">//&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="5784487">//</span><br>
<span class="lineno"></span><span class="comment" id="5784490">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;creates&nbsp;and&nbsp;frees&nbsp;connections&nbsp;automatically;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5784557">//&nbsp;also&nbsp;maintains&nbsp;a&nbsp;free&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;If&nbsp;the&nbsp;database&nbsp;has</span><br>
<span class="lineno">205</span><span class="comment" id="5784628">//&nbsp;a&nbsp;concept&nbsp;of&nbsp;per-connection&nbsp;state,&nbsp;such&nbsp;state&nbsp;can&nbsp;only&nbsp;be&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="5784698">//&nbsp;observed&nbsp;within&nbsp;a&nbsp;transaction.&nbsp;Once&nbsp;DB.Begin&nbsp;is&nbsp;called,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5784761">//&nbsp;returned&nbsp;Tx&nbsp;is&nbsp;bound&nbsp;to&nbsp;a&nbsp;single&nbsp;connection.&nbsp;Once&nbsp;Commit&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5784824">//&nbsp;Rollback&nbsp;is&nbsp;called&nbsp;on&nbsp;the&nbsp;transaction,&nbsp;that&nbsp;transaction&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="5784885">//&nbsp;connection&nbsp;is&nbsp;returned&nbsp;to&nbsp;DB&#39;s&nbsp;idle&nbsp;connection&nbsp;pool.&nbsp;The&nbsp;pool&nbsp;size</span><br>
<span class="lineno">210</span><span class="comment" id="5784955">//&nbsp;can&nbsp;be&nbsp;controlled&nbsp;with&nbsp;SetMaxIdleConns.</span><br>
<span class="lineno"></span><span class="keyword" id="5784998">type</span>&nbsp;<span class="ident" id="5785003">DB</span>&nbsp;<span class="keyword" id="5785006">struct</span>&nbsp;<span class="op" id="5785013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785016">driver</span>&nbsp;<span class="ident" id="5785023">driver</span><span class="op" id="5785029">.</span><span class="ident" id="5785030">Driver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785038">dsn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5785045">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785054">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5785067">sync</span><span class="op" id="5785071">.</span><span class="ident" id="5785072">Mutex</span>&nbsp;<span class="comment" id="5785078">//&nbsp;protects&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785108">freeConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5785121">[</span><span class="op" id="5785122">]</span><span class="op" id="5785123">*</span><span class="ident" id="5785124">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785136">connRequests</span>&nbsp;<span class="op" id="5785149">[</span><span class="op" id="5785150">]</span><span class="keyword" id="5785151">chan</span>&nbsp;<span class="ident" id="5785156">connRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785169">numOpen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5785182">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785187">pendingOpens</span>&nbsp;<span class="builtintype" id="5785200">int</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5785205">//&nbsp;Used&nbsp;to&nbsp;signal&nbsp;the&nbsp;need&nbsp;for&nbsp;new&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5785253">//&nbsp;a&nbsp;goroutine&nbsp;running&nbsp;connectionOpener()&nbsp;reads&nbsp;on&nbsp;this&nbsp;chan&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5785319">//&nbsp;maybeOpenNewConnections&nbsp;sends&nbsp;on&nbsp;the&nbsp;chan&nbsp;(one&nbsp;send&nbsp;per&nbsp;needed&nbsp;connection)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5785398">//&nbsp;It&nbsp;is&nbsp;closed&nbsp;during&nbsp;db.Close().&nbsp;The&nbsp;close&nbsp;tells&nbsp;the&nbsp;connectionOpener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5785471">//&nbsp;goroutine&nbsp;to&nbsp;exit.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785494">openerCh</span>&nbsp;<span class="keyword" id="5785503">chan</span>&nbsp;<span class="keyword" id="5785508">struct</span><span class="op" id="5785514">{</span><span class="op" id="5785515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785518">closed</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5785527">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785533">dep</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5785542">map</span><span class="op" id="5785545">[</span><span class="ident" id="5785546">finalCloser</span><span class="op" id="5785557">]</span><span class="ident" id="5785558">depSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785566">lastPut</span>&nbsp;&nbsp;<span class="keyword" id="5785575">map</span><span class="op" id="5785578">[</span><span class="op" id="5785579">*</span><span class="ident" id="5785580">driverConn</span><span class="op" id="5785590">]</span><span class="builtintype" id="5785591">string</span>&nbsp;<span class="comment" id="5785598">//&nbsp;stacktrace&nbsp;of&nbsp;last&nbsp;conn&#39;s&nbsp;put;&nbsp;debug&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785644">maxIdle</span>&nbsp;&nbsp;<span class="builtintype" id="5785653">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5785676">//&nbsp;zero&nbsp;means&nbsp;defaultMaxIdleConns;&nbsp;negative&nbsp;means&nbsp;0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785729">maxOpen</span>&nbsp;&nbsp;<span class="builtintype" id="5785738">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5785761">//&nbsp;&lt;=&nbsp;0&nbsp;means&nbsp;unlimited</span><br>
<span class="lineno"></span><span class="op" id="5785785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5785788">//&nbsp;driverConn&nbsp;wraps&nbsp;a&nbsp;driver.Conn&nbsp;with&nbsp;a&nbsp;mutex,&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5785839">//&nbsp;be&nbsp;held&nbsp;during&nbsp;all&nbsp;calls&nbsp;into&nbsp;the&nbsp;Conn.&nbsp;(including&nbsp;any&nbsp;calls&nbsp;onto</span><br>
<span class="lineno">235</span><span class="comment" id="5785908">//&nbsp;interfaces&nbsp;returned&nbsp;via&nbsp;that&nbsp;Conn,&nbsp;such&nbsp;as&nbsp;calls&nbsp;on&nbsp;Tx,&nbsp;Stmt,</span><br>
<span class="lineno"></span><span class="comment" id="5785973">//&nbsp;Result,&nbsp;Rows)</span><br>
<span class="lineno"></span><span class="keyword" id="5785990">type</span>&nbsp;<span class="ident" id="5785995">driverConn</span>&nbsp;<span class="keyword" id="5786006">struct</span>&nbsp;<span class="op" id="5786013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786016">db</span>&nbsp;<span class="op" id="5786019">*</span><span class="ident" id="5786020">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786025">sync</span><span class="op" id="5786029">.</span><span class="ident" id="5786030">Mutex</span>&nbsp;&nbsp;<span class="comment" id="5786037">//&nbsp;guards&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786058">ci</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5786070">driver</span><span class="op" id="5786076">.</span><span class="ident" id="5786077">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786083">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5786095">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786101">finalClosed</span>&nbsp;<span class="builtintype" id="5786113">bool</span>&nbsp;<span class="comment" id="5786118">//&nbsp;ci.Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786147">openStmt</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5786159">map</span><span class="op" id="5786162">[</span><span class="ident" id="5786163">driver</span><span class="op" id="5786169">.</span><span class="ident" id="5786170">Stmt</span><span class="op" id="5786174">]</span><span class="builtintype" id="5786175">bool</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5786182">//&nbsp;guarded&nbsp;by&nbsp;db.mu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786203">inUse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5786214">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786220">onPut</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5786231">[</span><span class="op" id="5786232">]</span><span class="keyword" id="5786233">func</span><span class="op" id="5786237">(</span><span class="op" id="5786238">)</span>&nbsp;<span class="comment" id="5786240">//&nbsp;code&nbsp;(with&nbsp;db.mu&nbsp;held)&nbsp;run&nbsp;when&nbsp;conn&nbsp;is&nbsp;next&nbsp;returned</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786298">dbmuClosed</span>&nbsp;<span class="builtintype" id="5786309">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5786318">//&nbsp;same&nbsp;as&nbsp;closed,&nbsp;but&nbsp;guarded&nbsp;by&nbsp;db.mu,&nbsp;for&nbsp;connIfFree</span><br>
<span class="lineno">250</span><span class="op" id="5786374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5786377">func</span>&nbsp;<span class="op" id="5786382">(</span><span class="ident" id="5786383">dc</span>&nbsp;<span class="op" id="5786386">*</span><span class="ident" id="5786387">driverConn</span><span class="op" id="5786397">)</span>&nbsp;<span class="ident" id="5786399">releaseConn</span><span class="op" id="5786410">(</span><span class="ident" id="5786411">err</span>&nbsp;<span class="builtintype" id="5786415">error</span><span class="op" id="5786420">)</span>&nbsp;<span class="op" id="5786422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786425">dc</span><span class="op" id="5786427">.</span><span class="ident" id="5786428">db</span><span class="op" id="5786430">.</span><span class="ident" id="5786431">putConn</span><span class="op" id="5786438">(</span><span class="ident" id="5786439">dc</span><span class="op" id="5786441">,</span>&nbsp;<span class="ident" id="5786443">err</span><span class="op" id="5786446">)</span><br>
<span class="lineno"></span><span class="op" id="5786448">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="5786451">func</span>&nbsp;<span class="op" id="5786456">(</span><span class="ident" id="5786457">dc</span>&nbsp;<span class="op" id="5786460">*</span><span class="ident" id="5786461">driverConn</span><span class="op" id="5786471">)</span>&nbsp;<span class="ident" id="5786473">removeOpenStmt</span><span class="op" id="5786487">(</span><span class="ident" id="5786488">si</span>&nbsp;<span class="ident" id="5786491">driver</span><span class="op" id="5786497">.</span><span class="ident" id="5786498">Stmt</span><span class="op" id="5786502">)</span>&nbsp;<span class="op" id="5786504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786507">dc</span><span class="op" id="5786509">.</span><span class="ident" id="5786510">Lock</span><span class="op" id="5786514">(</span><span class="op" id="5786515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5786518">defer</span>&nbsp;<span class="ident" id="5786524">dc</span><span class="op" id="5786526">.</span><span class="ident" id="5786527">Unlock</span><span class="op" id="5786533">(</span><span class="op" id="5786534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5786537">delete</span><span class="op" id="5786543">(</span><span class="ident" id="5786544">dc</span><span class="op" id="5786546">.</span><span class="ident" id="5786547">openStmt</span><span class="op" id="5786555">,</span>&nbsp;<span class="ident" id="5786557">si</span><span class="op" id="5786559">)</span><br>
<span class="lineno">260</span><span class="op" id="5786561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5786564">func</span>&nbsp;<span class="op" id="5786569">(</span><span class="ident" id="5786570">dc</span>&nbsp;<span class="op" id="5786573">*</span><span class="ident" id="5786574">driverConn</span><span class="op" id="5786584">)</span>&nbsp;<span class="ident" id="5786586">prepareLocked</span><span class="op" id="5786599">(</span><span class="ident" id="5786600">query</span>&nbsp;<span class="builtintype" id="5786606">string</span><span class="op" id="5786612">)</span>&nbsp;<span class="op" id="5786614">(</span><span class="ident" id="5786615">driver</span><span class="op" id="5786621">.</span><span class="ident" id="5786622">Stmt</span><span class="op" id="5786626">,</span>&nbsp;<span class="builtintype" id="5786628">error</span><span class="op" id="5786633">)</span>&nbsp;<span class="op" id="5786635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786638">si</span><span class="op" id="5786640">,</span>&nbsp;<span class="ident" id="5786642">err</span>&nbsp;<span class="op" id="5786646">:=</span>&nbsp;<span class="ident" id="5786649">dc</span><span class="op" id="5786651">.</span><span class="ident" id="5786652">ci</span><span class="op" id="5786654">.</span><span class="ident" id="5786655">Prepare</span><span class="op" id="5786662">(</span><span class="ident" id="5786663">query</span><span class="op" id="5786668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5786671">if</span>&nbsp;<span class="ident" id="5786674">err</span>&nbsp;<span class="op" id="5786678">==</span>&nbsp;<span class="ident" id="5786681">nil</span>&nbsp;<span class="op" id="5786685">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5786689">//&nbsp;Track&nbsp;each&nbsp;driverConn&#39;s&nbsp;open&nbsp;statements,&nbsp;so&nbsp;we&nbsp;can&nbsp;close&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5786756">//&nbsp;before&nbsp;closing&nbsp;the&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5786786">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5786791">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;drivers&nbsp;opt&nbsp;out&nbsp;of&nbsp;caring&nbsp;about</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5786848">//&nbsp;stmt&nbsp;closes&nbsp;if&nbsp;the&nbsp;conn&nbsp;is&nbsp;about&nbsp;to&nbsp;close&nbsp;anyway?&nbsp;For&nbsp;now</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5786911">//&nbsp;do&nbsp;the&nbsp;safe&nbsp;thing,&nbsp;in&nbsp;case&nbsp;stmts&nbsp;need&nbsp;to&nbsp;be&nbsp;closed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5786968">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5786973">//&nbsp;TODO(bradfitz):&nbsp;after&nbsp;Go&nbsp;1.2,&nbsp;closing&nbsp;driver.Stmts</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5787029">//&nbsp;should&nbsp;be&nbsp;moved&nbsp;to&nbsp;driverStmt,&nbsp;using&nbsp;unique</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5787078">//&nbsp;*driverStmts&nbsp;everywhere&nbsp;(including&nbsp;from</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5787123">//&nbsp;*Stmt.connStmt,&nbsp;instead&nbsp;of&nbsp;returning&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5787167">//&nbsp;driver.Stmt),&nbsp;using&nbsp;driverStmt&nbsp;as&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5787216">//&nbsp;everywhere,&nbsp;and&nbsp;making&nbsp;it&nbsp;a&nbsp;finalCloser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787262">if</span>&nbsp;<span class="ident" id="5787265">dc</span><span class="op" id="5787267">.</span><span class="ident" id="5787268">openStmt</span>&nbsp;<span class="op" id="5787277">==</span>&nbsp;<span class="ident" id="5787280">nil</span>&nbsp;<span class="op" id="5787284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787289">dc</span><span class="op" id="5787291">.</span><span class="ident" id="5787292">openStmt</span>&nbsp;<span class="op" id="5787301">=</span>&nbsp;<span class="builtinfunc" id="5787303">make</span><span class="op" id="5787307">(</span><span class="keyword" id="5787308">map</span><span class="op" id="5787311">[</span><span class="ident" id="5787312">driver</span><span class="op" id="5787318">.</span><span class="ident" id="5787319">Stmt</span><span class="op" id="5787323">]</span><span class="builtintype" id="5787324">bool</span><span class="op" id="5787328">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787336">dc</span><span class="op" id="5787338">.</span><span class="ident" id="5787339">openStmt</span><span class="op" id="5787347">[</span><span class="ident" id="5787348">si</span><span class="op" id="5787350">]</span>&nbsp;<span class="op" id="5787352">=</span>&nbsp;<span class="builtintype" id="5787354">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787363">return</span>&nbsp;<span class="ident" id="5787370">si</span><span class="op" id="5787372">,</span>&nbsp;<span class="ident" id="5787374">err</span><br>
<span class="lineno"></span><span class="op" id="5787378">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="5787381">//&nbsp;the&nbsp;dc.db&#39;s&nbsp;Mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="5787411">func</span>&nbsp;<span class="op" id="5787416">(</span><span class="ident" id="5787417">dc</span>&nbsp;<span class="op" id="5787420">*</span><span class="ident" id="5787421">driverConn</span><span class="op" id="5787431">)</span>&nbsp;<span class="ident" id="5787433">closeDBLocked</span><span class="op" id="5787446">(</span><span class="op" id="5787447">)</span>&nbsp;<span class="keyword" id="5787449">func</span><span class="op" id="5787453">(</span><span class="op" id="5787454">)</span>&nbsp;<span class="builtintype" id="5787456">error</span>&nbsp;<span class="op" id="5787462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787465">dc</span><span class="op" id="5787467">.</span><span class="ident" id="5787468">Lock</span><span class="op" id="5787472">(</span><span class="op" id="5787473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787476">defer</span>&nbsp;<span class="ident" id="5787482">dc</span><span class="op" id="5787484">.</span><span class="ident" id="5787485">Unlock</span><span class="op" id="5787491">(</span><span class="op" id="5787492">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787495">if</span>&nbsp;<span class="ident" id="5787498">dc</span><span class="op" id="5787500">.</span><span class="ident" id="5787501">closed</span>&nbsp;<span class="op" id="5787508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787512">return</span>&nbsp;<span class="keyword" id="5787519">func</span><span class="op" id="5787523">(</span><span class="op" id="5787524">)</span>&nbsp;<span class="builtintype" id="5787526">error</span>&nbsp;<span class="op" id="5787532">{</span>&nbsp;<span class="keyword" id="5787534">return</span>&nbsp;<span class="ident" id="5787541">errors</span><span class="op" id="5787547">.</span><span class="ident" id="5787548">New</span><span class="op" id="5787551">(</span><span class="string" id="5787552">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="5787585">)</span>&nbsp;<span class="op" id="5787587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787593">dc</span><span class="op" id="5787595">.</span><span class="ident" id="5787596">closed</span>&nbsp;<span class="op" id="5787603">=</span>&nbsp;<span class="builtintype" id="5787605">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787611">return</span>&nbsp;<span class="ident" id="5787618">dc</span><span class="op" id="5787620">.</span><span class="ident" id="5787621">db</span><span class="op" id="5787623">.</span><span class="ident" id="5787624">removeDepLocked</span><span class="op" id="5787639">(</span><span class="ident" id="5787640">dc</span><span class="op" id="5787642">,</span>&nbsp;<span class="ident" id="5787644">dc</span><span class="op" id="5787646">)</span><br>
<span class="lineno">295</span><span class="op" id="5787648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5787651">func</span>&nbsp;<span class="op" id="5787656">(</span><span class="ident" id="5787657">dc</span>&nbsp;<span class="op" id="5787660">*</span><span class="ident" id="5787661">driverConn</span><span class="op" id="5787671">)</span>&nbsp;<span class="ident" id="5787673">Close</span><span class="op" id="5787678">(</span><span class="op" id="5787679">)</span>&nbsp;<span class="builtintype" id="5787681">error</span>&nbsp;<span class="op" id="5787687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787690">dc</span><span class="op" id="5787692">.</span><span class="ident" id="5787693">Lock</span><span class="op" id="5787697">(</span><span class="op" id="5787698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787701">if</span>&nbsp;<span class="ident" id="5787704">dc</span><span class="op" id="5787706">.</span><span class="ident" id="5787707">closed</span>&nbsp;<span class="op" id="5787714">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787718">dc</span><span class="op" id="5787720">.</span><span class="ident" id="5787721">Unlock</span><span class="op" id="5787727">(</span><span class="op" id="5787728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787732">return</span>&nbsp;<span class="ident" id="5787739">errors</span><span class="op" id="5787745">.</span><span class="ident" id="5787746">New</span><span class="op" id="5787749">(</span><span class="string" id="5787750">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="5787783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787789">dc</span><span class="op" id="5787791">.</span><span class="ident" id="5787792">closed</span>&nbsp;<span class="op" id="5787799">=</span>&nbsp;<span class="builtintype" id="5787801">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787807">dc</span><span class="op" id="5787809">.</span><span class="ident" id="5787810">Unlock</span><span class="op" id="5787816">(</span><span class="op" id="5787817">)</span>&nbsp;<span class="comment" id="5787819">//&nbsp;not&nbsp;defer;&nbsp;removeDep&nbsp;finalClose&nbsp;calls&nbsp;may&nbsp;need&nbsp;to&nbsp;lock</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5787879">//&nbsp;And&nbsp;now&nbsp;updates&nbsp;that&nbsp;require&nbsp;holding&nbsp;dc.mu.Lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787932">dc</span><span class="op" id="5787934">.</span><span class="ident" id="5787935">db</span><span class="op" id="5787937">.</span><span class="ident" id="5787938">mu</span><span class="op" id="5787940">.</span><span class="ident" id="5787941">Lock</span><span class="op" id="5787945">(</span><span class="op" id="5787946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787949">dc</span><span class="op" id="5787951">.</span><span class="ident" id="5787952">dbmuClosed</span>&nbsp;<span class="op" id="5787963">=</span>&nbsp;<span class="builtintype" id="5787965">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787971">fn</span>&nbsp;<span class="op" id="5787974">:=</span>&nbsp;<span class="ident" id="5787977">dc</span><span class="op" id="5787979">.</span><span class="ident" id="5787980">db</span><span class="op" id="5787982">.</span><span class="ident" id="5787983">removeDepLocked</span><span class="op" id="5787998">(</span><span class="ident" id="5787999">dc</span><span class="op" id="5788001">,</span>&nbsp;<span class="ident" id="5788003">dc</span><span class="op" id="5788005">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788008">dc</span><span class="op" id="5788010">.</span><span class="ident" id="5788011">db</span><span class="op" id="5788013">.</span><span class="ident" id="5788014">mu</span><span class="op" id="5788016">.</span><span class="ident" id="5788017">Unlock</span><span class="op" id="5788023">(</span><span class="op" id="5788024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788027">return</span>&nbsp;<span class="ident" id="5788034">fn</span><span class="op" id="5788036">(</span><span class="op" id="5788037">)</span><br>
<span class="lineno"></span><span class="op" id="5788039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5788042">func</span>&nbsp;<span class="op" id="5788047">(</span><span class="ident" id="5788048">dc</span>&nbsp;<span class="op" id="5788051">*</span><span class="ident" id="5788052">driverConn</span><span class="op" id="5788062">)</span>&nbsp;<span class="ident" id="5788064">finalClose</span><span class="op" id="5788074">(</span><span class="op" id="5788075">)</span>&nbsp;<span class="builtintype" id="5788077">error</span>&nbsp;<span class="op" id="5788083">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788086">dc</span><span class="op" id="5788088">.</span><span class="ident" id="5788089">Lock</span><span class="op" id="5788093">(</span><span class="op" id="5788094">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788098">for</span>&nbsp;<span class="ident" id="5788102">si</span>&nbsp;<span class="op" id="5788105">:=</span>&nbsp;<span class="keyword" id="5788108">range</span>&nbsp;<span class="ident" id="5788114">dc</span><span class="op" id="5788116">.</span><span class="ident" id="5788117">openStmt</span>&nbsp;<span class="op" id="5788126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788130">si</span><span class="op" id="5788132">.</span><span class="ident" id="5788133">Close</span><span class="op" id="5788138">(</span><span class="op" id="5788139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5788142">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788145">dc</span><span class="op" id="5788147">.</span><span class="ident" id="5788148">openStmt</span>&nbsp;<span class="op" id="5788157">=</span>&nbsp;<span class="ident" id="5788159">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788165">err</span>&nbsp;<span class="op" id="5788169">:=</span>&nbsp;<span class="ident" id="5788172">dc</span><span class="op" id="5788174">.</span><span class="ident" id="5788175">ci</span><span class="op" id="5788177">.</span><span class="ident" id="5788178">Close</span><span class="op" id="5788183">(</span><span class="op" id="5788184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788187">dc</span><span class="op" id="5788189">.</span><span class="ident" id="5788190">ci</span>&nbsp;<span class="op" id="5788193">=</span>&nbsp;<span class="ident" id="5788195">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788200">dc</span><span class="op" id="5788202">.</span><span class="ident" id="5788203">finalClosed</span>&nbsp;<span class="op" id="5788215">=</span>&nbsp;<span class="builtintype" id="5788217">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788223">dc</span><span class="op" id="5788225">.</span><span class="ident" id="5788226">Unlock</span><span class="op" id="5788232">(</span><span class="op" id="5788233">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788237">dc</span><span class="op" id="5788239">.</span><span class="ident" id="5788240">db</span><span class="op" id="5788242">.</span><span class="ident" id="5788243">mu</span><span class="op" id="5788245">.</span><span class="ident" id="5788246">Lock</span><span class="op" id="5788250">(</span><span class="op" id="5788251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788254">dc</span><span class="op" id="5788256">.</span><span class="ident" id="5788257">db</span><span class="op" id="5788259">.</span><span class="ident" id="5788260">numOpen</span><span class="op" id="5788267">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788271">dc</span><span class="op" id="5788273">.</span><span class="ident" id="5788274">db</span><span class="op" id="5788276">.</span><span class="ident" id="5788277">maybeOpenNewConnections</span><span class="op" id="5788300">(</span><span class="op" id="5788301">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788304">dc</span><span class="op" id="5788306">.</span><span class="ident" id="5788307">db</span><span class="op" id="5788309">.</span><span class="ident" id="5788310">mu</span><span class="op" id="5788312">.</span><span class="ident" id="5788313">Unlock</span><span class="op" id="5788319">(</span><span class="op" id="5788320">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788324">return</span>&nbsp;<span class="ident" id="5788331">err</span><br>
<span class="lineno"></span><span class="op" id="5788335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="5788338">//&nbsp;driverStmt&nbsp;associates&nbsp;a&nbsp;driver.Stmt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5788386">//&nbsp;*driverConn&nbsp;from&nbsp;which&nbsp;it&nbsp;came,&nbsp;so&nbsp;the&nbsp;driverConn&#39;s&nbsp;lock&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5788453">//&nbsp;held&nbsp;during&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="5788475">type</span>&nbsp;<span class="ident" id="5788480">driverStmt</span>&nbsp;<span class="keyword" id="5788491">struct</span>&nbsp;<span class="op" id="5788498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788501">sync</span><span class="op" id="5788505">.</span><span class="ident" id="5788506">Locker</span>&nbsp;<span class="comment" id="5788513">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788533">si</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5788545">driver</span><span class="op" id="5788551">.</span><span class="ident" id="5788552">Stmt</span><br>
<span class="lineno"></span><span class="op" id="5788557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5788560">func</span>&nbsp;<span class="op" id="5788565">(</span><span class="ident" id="5788566">ds</span>&nbsp;<span class="op" id="5788569">*</span><span class="ident" id="5788570">driverStmt</span><span class="op" id="5788580">)</span>&nbsp;<span class="ident" id="5788582">Close</span><span class="op" id="5788587">(</span><span class="op" id="5788588">)</span>&nbsp;<span class="builtintype" id="5788590">error</span>&nbsp;<span class="op" id="5788596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788599">ds</span><span class="op" id="5788601">.</span><span class="ident" id="5788602">Lock</span><span class="op" id="5788606">(</span><span class="op" id="5788607">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788610">defer</span>&nbsp;<span class="ident" id="5788616">ds</span><span class="op" id="5788618">.</span><span class="ident" id="5788619">Unlock</span><span class="op" id="5788625">(</span><span class="op" id="5788626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788629">return</span>&nbsp;<span class="ident" id="5788636">ds</span><span class="op" id="5788638">.</span><span class="ident" id="5788639">si</span><span class="op" id="5788641">.</span><span class="ident" id="5788642">Close</span><span class="op" id="5788647">(</span><span class="op" id="5788648">)</span><br>
<span class="lineno"></span><span class="op" id="5788650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5788653">//&nbsp;depSet&nbsp;is&nbsp;a&nbsp;finalCloser&#39;s&nbsp;outstanding&nbsp;dependencies</span><br>
<span class="lineno">350</span><span class="keyword" id="5788707">type</span>&nbsp;<span class="ident" id="5788712">depSet</span>&nbsp;<span class="keyword" id="5788719">map</span><span class="op" id="5788722">[</span><span class="keyword" id="5788723">interface</span><span class="op" id="5788732">{</span><span class="op" id="5788733">}</span><span class="op" id="5788734">]</span><span class="builtintype" id="5788735">bool</span>&nbsp;<span class="comment" id="5788740">//&nbsp;set&nbsp;of&nbsp;true&nbsp;bools</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5788762">//&nbsp;The&nbsp;finalCloser&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;(*DB).addDep&nbsp;and&nbsp;related</span><br>
<span class="lineno"></span><span class="comment" id="5788827">//&nbsp;dependency&nbsp;reference&nbsp;counting.</span><br>
<span class="lineno"></span><span class="keyword" id="5788861">type</span>&nbsp;<span class="ident" id="5788866">finalCloser</span>&nbsp;<span class="keyword" id="5788878">interface</span>&nbsp;<span class="op" id="5788888">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5788891">//&nbsp;finalClose&nbsp;is&nbsp;called&nbsp;when&nbsp;the&nbsp;reference&nbsp;count&nbsp;of&nbsp;an&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5788954">//&nbsp;goes&nbsp;to&nbsp;zero.&nbsp;(*DB).mu&nbsp;is&nbsp;not&nbsp;held&nbsp;while&nbsp;calling&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789011">finalClose</span><span class="op" id="5789021">(</span><span class="op" id="5789022">)</span>&nbsp;<span class="builtintype" id="5789024">error</span><br>
<span class="lineno"></span><span class="op" id="5789030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="comment" id="5789033">//&nbsp;addDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;now&nbsp;depends&nbsp;on&nbsp;dep,&nbsp;and&nbsp;x&#39;s&nbsp;finalClose&nbsp;won&#39;t&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5789104">//&nbsp;called&nbsp;until&nbsp;all&nbsp;of&nbsp;x&#39;s&nbsp;dependencies&nbsp;are&nbsp;removed&nbsp;with&nbsp;removeDep.</span><br>
<span class="lineno"></span><span class="keyword" id="5789172">func</span>&nbsp;<span class="op" id="5789177">(</span><span class="ident" id="5789178">db</span>&nbsp;<span class="op" id="5789181">*</span><span class="ident" id="5789182">DB</span><span class="op" id="5789184">)</span>&nbsp;<span class="ident" id="5789186">addDep</span><span class="op" id="5789192">(</span><span class="ident" id="5789193">x</span>&nbsp;<span class="ident" id="5789195">finalCloser</span><span class="op" id="5789206">,</span>&nbsp;<span class="ident" id="5789208">dep</span>&nbsp;<span class="keyword" id="5789212">interface</span><span class="op" id="5789221">{</span><span class="op" id="5789222">}</span><span class="op" id="5789223">)</span>&nbsp;<span class="op" id="5789225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5789228">//println(fmt.Sprintf(&#34;addDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789292">db</span><span class="op" id="5789294">.</span><span class="ident" id="5789295">mu</span><span class="op" id="5789297">.</span><span class="ident" id="5789298">Lock</span><span class="op" id="5789302">(</span><span class="op" id="5789303">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5789306">defer</span>&nbsp;<span class="ident" id="5789312">db</span><span class="op" id="5789314">.</span><span class="ident" id="5789315">mu</span><span class="op" id="5789317">.</span><span class="ident" id="5789318">Unlock</span><span class="op" id="5789324">(</span><span class="op" id="5789325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789328">db</span><span class="op" id="5789330">.</span><span class="ident" id="5789331">addDepLocked</span><span class="op" id="5789343">(</span><span class="ident" id="5789344">x</span><span class="op" id="5789345">,</span>&nbsp;<span class="ident" id="5789347">dep</span><span class="op" id="5789350">)</span><br>
<span class="lineno"></span><span class="op" id="5789352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5789355">func</span>&nbsp;<span class="op" id="5789360">(</span><span class="ident" id="5789361">db</span>&nbsp;<span class="op" id="5789364">*</span><span class="ident" id="5789365">DB</span><span class="op" id="5789367">)</span>&nbsp;<span class="ident" id="5789369">addDepLocked</span><span class="op" id="5789381">(</span><span class="ident" id="5789382">x</span>&nbsp;<span class="ident" id="5789384">finalCloser</span><span class="op" id="5789395">,</span>&nbsp;<span class="ident" id="5789397">dep</span>&nbsp;<span class="keyword" id="5789401">interface</span><span class="op" id="5789410">{</span><span class="op" id="5789411">}</span><span class="op" id="5789412">)</span>&nbsp;<span class="op" id="5789414">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5789417">if</span>&nbsp;<span class="ident" id="5789420">db</span><span class="op" id="5789422">.</span><span class="ident" id="5789423">dep</span>&nbsp;<span class="op" id="5789427">==</span>&nbsp;<span class="ident" id="5789430">nil</span>&nbsp;<span class="op" id="5789434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789438">db</span><span class="op" id="5789440">.</span><span class="ident" id="5789441">dep</span>&nbsp;<span class="op" id="5789445">=</span>&nbsp;<span class="builtinfunc" id="5789447">make</span><span class="op" id="5789451">(</span><span class="keyword" id="5789452">map</span><span class="op" id="5789455">[</span><span class="ident" id="5789456">finalCloser</span><span class="op" id="5789467">]</span><span class="ident" id="5789468">depSet</span><span class="op" id="5789474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5789477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789480">xdep</span>&nbsp;<span class="op" id="5789485">:=</span>&nbsp;<span class="ident" id="5789488">db</span><span class="op" id="5789490">.</span><span class="ident" id="5789491">dep</span><span class="op" id="5789494">[</span><span class="ident" id="5789495">x</span><span class="op" id="5789496">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5789499">if</span>&nbsp;<span class="ident" id="5789502">xdep</span>&nbsp;<span class="op" id="5789507">==</span>&nbsp;<span class="ident" id="5789510">nil</span>&nbsp;<span class="op" id="5789514">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789518">xdep</span>&nbsp;<span class="op" id="5789523">=</span>&nbsp;<span class="builtinfunc" id="5789525">make</span><span class="op" id="5789529">(</span><span class="ident" id="5789530">depSet</span><span class="op" id="5789536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789540">db</span><span class="op" id="5789542">.</span><span class="ident" id="5789543">dep</span><span class="op" id="5789546">[</span><span class="ident" id="5789547">x</span><span class="op" id="5789548">]</span>&nbsp;<span class="op" id="5789550">=</span>&nbsp;<span class="ident" id="5789552">xdep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5789558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789561">xdep</span><span class="op" id="5789565">[</span><span class="ident" id="5789566">dep</span><span class="op" id="5789569">]</span>&nbsp;<span class="op" id="5789571">=</span>&nbsp;<span class="builtintype" id="5789573">true</span><br>
<span class="lineno"></span><span class="op" id="5789578">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="5789581">//&nbsp;removeDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;no&nbsp;longer&nbsp;depends&nbsp;on&nbsp;dep.</span><br>
<span class="lineno"></span><span class="comment" id="5789633">//&nbsp;If&nbsp;x&nbsp;still&nbsp;has&nbsp;dependencies,&nbsp;nil&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="5789682">//&nbsp;If&nbsp;x&nbsp;no&nbsp;longer&nbsp;has&nbsp;any&nbsp;dependencies,&nbsp;its&nbsp;finalClose&nbsp;method&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5789752">//&nbsp;called&nbsp;and&nbsp;its&nbsp;error&nbsp;value&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno">385</span><span class="keyword" id="5789800">func</span>&nbsp;<span class="op" id="5789805">(</span><span class="ident" id="5789806">db</span>&nbsp;<span class="op" id="5789809">*</span><span class="ident" id="5789810">DB</span><span class="op" id="5789812">)</span>&nbsp;<span class="ident" id="5789814">removeDep</span><span class="op" id="5789823">(</span><span class="ident" id="5789824">x</span>&nbsp;<span class="ident" id="5789826">finalCloser</span><span class="op" id="5789837">,</span>&nbsp;<span class="ident" id="5789839">dep</span>&nbsp;<span class="keyword" id="5789843">interface</span><span class="op" id="5789852">{</span><span class="op" id="5789853">}</span><span class="op" id="5789854">)</span>&nbsp;<span class="builtintype" id="5789856">error</span>&nbsp;<span class="op" id="5789862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789865">db</span><span class="op" id="5789867">.</span><span class="ident" id="5789868">mu</span><span class="op" id="5789870">.</span><span class="ident" id="5789871">Lock</span><span class="op" id="5789875">(</span><span class="op" id="5789876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789879">fn</span>&nbsp;<span class="op" id="5789882">:=</span>&nbsp;<span class="ident" id="5789885">db</span><span class="op" id="5789887">.</span><span class="ident" id="5789888">removeDepLocked</span><span class="op" id="5789903">(</span><span class="ident" id="5789904">x</span><span class="op" id="5789905">,</span>&nbsp;<span class="ident" id="5789907">dep</span><span class="op" id="5789910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789913">db</span><span class="op" id="5789915">.</span><span class="ident" id="5789916">mu</span><span class="op" id="5789918">.</span><span class="ident" id="5789919">Unlock</span><span class="op" id="5789925">(</span><span class="op" id="5789926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5789929">return</span>&nbsp;<span class="ident" id="5789936">fn</span><span class="op" id="5789938">(</span><span class="op" id="5789939">)</span><br>
<span class="lineno">390</span><span class="op" id="5789941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5789944">func</span>&nbsp;<span class="op" id="5789949">(</span><span class="ident" id="5789950">db</span>&nbsp;<span class="op" id="5789953">*</span><span class="ident" id="5789954">DB</span><span class="op" id="5789956">)</span>&nbsp;<span class="ident" id="5789958">removeDepLocked</span><span class="op" id="5789973">(</span><span class="ident" id="5789974">x</span>&nbsp;<span class="ident" id="5789976">finalCloser</span><span class="op" id="5789987">,</span>&nbsp;<span class="ident" id="5789989">dep</span>&nbsp;<span class="keyword" id="5789993">interface</span><span class="op" id="5790002">{</span><span class="op" id="5790003">}</span><span class="op" id="5790004">)</span>&nbsp;<span class="keyword" id="5790006">func</span><span class="op" id="5790010">(</span><span class="op" id="5790011">)</span>&nbsp;<span class="builtintype" id="5790013">error</span>&nbsp;<span class="op" id="5790019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5790022">//println(fmt.Sprintf(&#34;removeDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5790090">xdep</span><span class="op" id="5790094">,</span>&nbsp;<span class="ident" id="5790096">ok</span>&nbsp;<span class="op" id="5790099">:=</span>&nbsp;<span class="ident" id="5790102">db</span><span class="op" id="5790104">.</span><span class="ident" id="5790105">dep</span><span class="op" id="5790108">[</span><span class="ident" id="5790109">x</span><span class="op" id="5790110">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790113">if</span>&nbsp;<span class="op" id="5790116">!</span><span class="ident" id="5790117">ok</span>&nbsp;<span class="op" id="5790120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5790124">panic</span><span class="op" id="5790129">(</span><span class="ident" id="5790130">fmt</span><span class="op" id="5790133">.</span><span class="ident" id="5790134">Sprintf</span><span class="op" id="5790141">(</span><span class="string" id="5790142">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;deps&nbsp;for&nbsp;%T&#34;</span><span class="op" id="5790178">,</span>&nbsp;<span class="ident" id="5790180">x</span><span class="op" id="5790181">)</span><span class="op" id="5790182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5790185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5790189">l0</span>&nbsp;<span class="op" id="5790192">:=</span>&nbsp;<span class="builtinfunc" id="5790195">len</span><span class="op" id="5790198">(</span><span class="ident" id="5790199">xdep</span><span class="op" id="5790203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5790206">delete</span><span class="op" id="5790212">(</span><span class="ident" id="5790213">xdep</span><span class="op" id="5790217">,</span>&nbsp;<span class="ident" id="5790219">dep</span><span class="op" id="5790222">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790226">switch</span>&nbsp;<span class="builtinfunc" id="5790233">len</span><span class="op" id="5790236">(</span><span class="ident" id="5790237">xdep</span><span class="op" id="5790241">)</span>&nbsp;<span class="op" id="5790243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790246">case</span>&nbsp;<span class="ident" id="5790251">l0</span><span class="op" id="5790253">:</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5790257">//&nbsp;Nothing&nbsp;removed.&nbsp;Shouldn&#39;t&nbsp;happen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5790297">panic</span><span class="op" id="5790302">(</span><span class="ident" id="5790303">fmt</span><span class="op" id="5790306">.</span><span class="ident" id="5790307">Sprintf</span><span class="op" id="5790314">(</span><span class="string" id="5790315">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;%T&nbsp;dep&nbsp;on&nbsp;%T&#34;</span><span class="op" id="5790352">,</span>&nbsp;<span class="ident" id="5790354">dep</span><span class="op" id="5790357">,</span>&nbsp;<span class="ident" id="5790359">x</span><span class="op" id="5790360">)</span><span class="op" id="5790361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790364">case</span>&nbsp;<span class="num" id="5790369">0</span><span class="op" id="5790370">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5790374">//&nbsp;No&nbsp;more&nbsp;dependencies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5790401">delete</span><span class="op" id="5790407">(</span><span class="ident" id="5790408">db</span><span class="op" id="5790410">.</span><span class="ident" id="5790411">dep</span><span class="op" id="5790414">,</span>&nbsp;<span class="ident" id="5790416">x</span><span class="op" id="5790417">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790421">return</span>&nbsp;<span class="ident" id="5790428">x</span><span class="op" id="5790429">.</span><span class="ident" id="5790430">finalClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790442">default</span><span class="op" id="5790449">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5790453">//&nbsp;Dependencies&nbsp;remain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790479">return</span>&nbsp;<span class="keyword" id="5790486">func</span><span class="op" id="5790490">(</span><span class="op" id="5790491">)</span>&nbsp;<span class="builtintype" id="5790493">error</span>&nbsp;<span class="op" id="5790499">{</span>&nbsp;<span class="keyword" id="5790501">return</span>&nbsp;<span class="ident" id="5790508">nil</span>&nbsp;<span class="op" id="5790512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5790515">}</span><br>
<span class="lineno">415</span><span class="op" id="5790517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5790520">//&nbsp;This&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;connectionOpener&nbsp;request&nbsp;chan&nbsp;(dn.openerCh).</span><br>
<span class="lineno"></span><span class="comment" id="5790592">//&nbsp;This&nbsp;value&nbsp;should&nbsp;be&nbsp;larger&nbsp;than&nbsp;the&nbsp;maximum&nbsp;typical&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5790654">//&nbsp;used&nbsp;for&nbsp;db.maxOpen.&nbsp;If&nbsp;maxOpen&nbsp;is&nbsp;significantly&nbsp;larger&nbsp;than</span><br>
<span class="lineno">420</span><span class="comment" id="5790718">//&nbsp;connectionRequestQueueSize&nbsp;then&nbsp;it&nbsp;is&nbsp;possible&nbsp;for&nbsp;ALL&nbsp;calls&nbsp;into&nbsp;the&nbsp;*DB</span><br>
<span class="lineno"></span><span class="comment" id="5790795">//&nbsp;to&nbsp;block&nbsp;until&nbsp;the&nbsp;connectionOpener&nbsp;can&nbsp;satisfy&nbsp;the&nbsp;backlog&nbsp;of&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="5790871">var</span>&nbsp;<span class="ident" id="5790875">connectionRequestQueueSize</span>&nbsp;<span class="op" id="5790902">=</span>&nbsp;<span class="num" id="5790904">1000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5790913">//&nbsp;Open&nbsp;opens&nbsp;a&nbsp;database&nbsp;specified&nbsp;by&nbsp;its&nbsp;database&nbsp;driver&nbsp;name&nbsp;and&nbsp;a</span><br>
<span class="lineno">425</span><span class="comment" id="5790982">//&nbsp;driver-specific&nbsp;data&nbsp;source&nbsp;name,&nbsp;usually&nbsp;consisting&nbsp;of&nbsp;at&nbsp;least&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5791052">//&nbsp;database&nbsp;name&nbsp;and&nbsp;connection&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="5791097">//</span><br>
<span class="lineno"></span><span class="comment" id="5791100">//&nbsp;Most&nbsp;users&nbsp;will&nbsp;open&nbsp;a&nbsp;database&nbsp;via&nbsp;a&nbsp;driver-specific&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5791168">//&nbsp;helper&nbsp;function&nbsp;that&nbsp;returns&nbsp;a&nbsp;*DB.&nbsp;No&nbsp;database&nbsp;drivers&nbsp;are&nbsp;included</span><br>
<span class="lineno">430</span><span class="comment" id="5791240">//&nbsp;in&nbsp;the&nbsp;Go&nbsp;standard&nbsp;library.&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5791310">//&nbsp;a&nbsp;list&nbsp;of&nbsp;third-party&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="comment" id="5791344">//</span><br>
<span class="lineno"></span><span class="comment" id="5791347">//&nbsp;Open&nbsp;may&nbsp;just&nbsp;validate&nbsp;its&nbsp;arguments&nbsp;without&nbsp;creating&nbsp;a&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5791417">//&nbsp;to&nbsp;the&nbsp;database.&nbsp;To&nbsp;verify&nbsp;that&nbsp;the&nbsp;data&nbsp;source&nbsp;name&nbsp;is&nbsp;valid,&nbsp;call</span><br>
<span class="lineno">435</span><span class="comment" id="5791488">//&nbsp;Ping.</span><br>
<span class="lineno"></span><span class="comment" id="5791497">//</span><br>
<span class="lineno"></span><span class="comment" id="5791500">//&nbsp;The&nbsp;returned&nbsp;DB&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="5791569">//&nbsp;and&nbsp;maintains&nbsp;its&nbsp;own&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;Thus,&nbsp;the&nbsp;Open</span><br>
<span class="lineno"></span><span class="comment" id="5791635">//&nbsp;function&nbsp;should&nbsp;be&nbsp;called&nbsp;just&nbsp;once.&nbsp;It&nbsp;is&nbsp;rarely&nbsp;necessary&nbsp;to</span><br>
<span class="lineno">440</span><span class="comment" id="5791701">//&nbsp;close&nbsp;a&nbsp;DB.</span><br>
<span class="lineno"></span><span class="keyword" id="5791716">func</span>&nbsp;<span class="ident" id="5791721">Open</span><span class="op" id="5791725">(</span><span class="ident" id="5791726">driverName</span><span class="op" id="5791736">,</span>&nbsp;<span class="ident" id="5791738">dataSourceName</span>&nbsp;<span class="builtintype" id="5791753">string</span><span class="op" id="5791759">)</span>&nbsp;<span class="op" id="5791761">(</span><span class="op" id="5791762">*</span><span class="ident" id="5791763">DB</span><span class="op" id="5791765">,</span>&nbsp;<span class="builtintype" id="5791767">error</span><span class="op" id="5791772">)</span>&nbsp;<span class="op" id="5791774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791777">driveri</span><span class="op" id="5791784">,</span>&nbsp;<span class="ident" id="5791786">ok</span>&nbsp;<span class="op" id="5791789">:=</span>&nbsp;<span class="ident" id="5791792">drivers</span><span class="op" id="5791799">[</span><span class="ident" id="5791800">driverName</span><span class="op" id="5791810">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5791813">if</span>&nbsp;<span class="op" id="5791816">!</span><span class="ident" id="5791817">ok</span>&nbsp;<span class="op" id="5791820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5791824">return</span>&nbsp;<span class="ident" id="5791831">nil</span><span class="op" id="5791834">,</span>&nbsp;<span class="ident" id="5791836">fmt</span><span class="op" id="5791839">.</span><span class="ident" id="5791840">Errorf</span><span class="op" id="5791846">(</span><span class="string" id="5791847">&#34;sql:&nbsp;unknown&nbsp;driver&nbsp;%q&nbsp;(forgotten&nbsp;import?)&#34;</span><span class="op" id="5791891">,</span>&nbsp;<span class="ident" id="5791893">driverName</span><span class="op" id="5791903">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5791906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791909">db</span>&nbsp;<span class="op" id="5791912">:=</span>&nbsp;<span class="op" id="5791915">&amp;</span><span class="ident" id="5791916">DB</span><span class="op" id="5791918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791922">driver</span><span class="op" id="5791928">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5791932">driveri</span><span class="op" id="5791939">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791943">dsn</span><span class="op" id="5791946">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5791953">dataSourceName</span><span class="op" id="5791967">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791971">openerCh</span><span class="op" id="5791979">:</span>&nbsp;<span class="builtinfunc" id="5791981">make</span><span class="op" id="5791985">(</span><span class="keyword" id="5791986">chan</span>&nbsp;<span class="keyword" id="5791991">struct</span><span class="op" id="5791997">{</span><span class="op" id="5791998">}</span><span class="op" id="5791999">,</span>&nbsp;<span class="ident" id="5792001">connectionRequestQueueSize</span><span class="op" id="5792027">)</span><span class="op" id="5792028">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5792032">lastPut</span><span class="op" id="5792039">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5792042">make</span><span class="op" id="5792046">(</span><span class="keyword" id="5792047">map</span><span class="op" id="5792050">[</span><span class="op" id="5792051">*</span><span class="ident" id="5792052">driverConn</span><span class="op" id="5792062">]</span><span class="builtintype" id="5792063">string</span><span class="op" id="5792069">)</span><span class="op" id="5792070">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5792073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5792076">go</span>&nbsp;<span class="ident" id="5792079">db</span><span class="op" id="5792081">.</span><span class="ident" id="5792082">connectionOpener</span><span class="op" id="5792098">(</span><span class="op" id="5792099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5792102">return</span>&nbsp;<span class="ident" id="5792109">db</span><span class="op" id="5792111">,</span>&nbsp;<span class="ident" id="5792113">nil</span><br>
<span class="lineno"></span><span class="op" id="5792117">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="5792120">//&nbsp;Ping&nbsp;verifies&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;database&nbsp;is&nbsp;still&nbsp;alive,</span><br>
<span class="lineno"></span><span class="comment" id="5792182">//&nbsp;establishing&nbsp;a&nbsp;connection&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="5792225">func</span>&nbsp;<span class="op" id="5792230">(</span><span class="ident" id="5792231">db</span>&nbsp;<span class="op" id="5792234">*</span><span class="ident" id="5792235">DB</span><span class="op" id="5792237">)</span>&nbsp;<span class="ident" id="5792239">Ping</span><span class="op" id="5792243">(</span><span class="op" id="5792244">)</span>&nbsp;<span class="builtintype" id="5792246">error</span>&nbsp;<span class="op" id="5792252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5792255">//&nbsp;TODO(bradfitz):&nbsp;give&nbsp;drivers&nbsp;an&nbsp;optional&nbsp;hook&nbsp;to&nbsp;implement</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5792318">//&nbsp;this&nbsp;in&nbsp;a&nbsp;more&nbsp;efficient&nbsp;or&nbsp;more&nbsp;reliable&nbsp;way,&nbsp;if&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5792377">//&nbsp;have&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5792391">dc</span><span class="op" id="5792393">,</span>&nbsp;<span class="ident" id="5792395">err</span>&nbsp;<span class="op" id="5792399">:=</span>&nbsp;<span class="ident" id="5792402">db</span><span class="op" id="5792404">.</span><span class="ident" id="5792405">conn</span><span class="op" id="5792409">(</span><span class="op" id="5792410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5792413">if</span>&nbsp;<span class="ident" id="5792416">err</span>&nbsp;<span class="op" id="5792420">!=</span>&nbsp;<span class="ident" id="5792423">nil</span>&nbsp;<span class="op" id="5792427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5792431">return</span>&nbsp;<span class="ident" id="5792438">err</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5792443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5792446">db</span><span class="op" id="5792448">.</span><span class="ident" id="5792449">putConn</span><span class="op" id="5792456">(</span><span class="ident" id="5792457">dc</span><span class="op" id="5792459">,</span>&nbsp;<span class="ident" id="5792461">nil</span><span class="op" id="5792464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5792467">return</span>&nbsp;<span class="ident" id="5792474">nil</span><br>
<span class="lineno"></span><span class="op" id="5792478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="comment" id="5792481">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;database,&nbsp;releasing&nbsp;any&nbsp;open&nbsp;resources.</span><br>
<span class="lineno"></span><span class="comment" id="5792541">//</span><br>
<span class="lineno"></span><span class="comment" id="5792544">//&nbsp;It&nbsp;is&nbsp;rare&nbsp;to&nbsp;Close&nbsp;a&nbsp;DB,&nbsp;as&nbsp;the&nbsp;DB&nbsp;handle&nbsp;is&nbsp;meant&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5792605">//&nbsp;long-lived&nbsp;and&nbsp;shared&nbsp;between&nbsp;many&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5792655">func</span>&nbsp;<span class="op" id="5792660">(</span><span class="ident" id="5792661">db</span>&nbsp;<span class="op" id="5792664">*</span><span class="ident" id="5792665">DB</span><span class="op" id="5792667">)</span>&nbsp;<span class="ident" id="5792669">Close</span><span class="op" id="5792674">(</span><span class="op" id="5792675">)</span>&nbsp;<span class="builtintype" id="5792677">error</span>&nbsp;<span class="op" id="5792683">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5792686">db</span><span class="op" id="5792688">.</span><span class="ident" id="5792689">mu</span><span class="op" id="5792691">.</span><span class="ident" id="5792692">Lock</span><span class="op" id="5792696">(</span><span class="op" id="5792697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5792700">if</span>&nbsp;<span class="ident" id="5792703">db</span><span class="op" id="5792705">.</span><span class="ident" id="5792706">closed</span>&nbsp;<span class="op" id="5792713">{</span>&nbsp;<span class="comment" id="5792715">//&nbsp;Make&nbsp;DB.Close&nbsp;idempotent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5792745">db</span><span class="op" id="5792747">.</span><span class="ident" id="5792748">mu</span><span class="op" id="5792750">.</span><span class="ident" id="5792751">Unlock</span><span class="op" id="5792757">(</span><span class="op" id="5792758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5792762">return</span>&nbsp;<span class="ident" id="5792769">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5792774">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5792777">close</span><span class="op" id="5792782">(</span><span class="ident" id="5792783">db</span><span class="op" id="5792785">.</span><span class="ident" id="5792786">openerCh</span><span class="op" id="5792794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5792797">var</span>&nbsp;<span class="ident" id="5792801">err</span>&nbsp;<span class="builtintype" id="5792805">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5792812">fns</span>&nbsp;<span class="op" id="5792816">:=</span>&nbsp;<span class="builtinfunc" id="5792819">make</span><span class="op" id="5792823">(</span><span class="op" id="5792824">[</span><span class="op" id="5792825">]</span><span class="keyword" id="5792826">func</span><span class="op" id="5792830">(</span><span class="op" id="5792831">)</span>&nbsp;<span class="builtintype" id="5792833">error</span><span class="op" id="5792838">,</span>&nbsp;<span class="num" id="5792840">0</span><span class="op" id="5792841">,</span>&nbsp;<span class="builtinfunc" id="5792843">len</span><span class="op" id="5792846">(</span><span class="ident" id="5792847">db</span><span class="op" id="5792849">.</span><span class="ident" id="5792850">freeConn</span><span class="op" id="5792858">)</span><span class="op" id="5792859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5792862">for</span>&nbsp;<span class="ident" id="5792866">_</span><span class="op" id="5792867">,</span>&nbsp;<span class="ident" id="5792869">dc</span>&nbsp;<span class="op" id="5792872">:=</span>&nbsp;<span class="keyword" id="5792875">range</span>&nbsp;<span class="ident" id="5792881">db</span><span class="op" id="5792883">.</span><span class="ident" id="5792884">freeConn</span>&nbsp;<span class="op" id="5792893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5792897">fns</span>&nbsp;<span class="op" id="5792901">=</span>&nbsp;<span class="builtinfunc" id="5792903">append</span><span class="op" id="5792909">(</span><span class="ident" id="5792910">fns</span><span class="op" id="5792913">,</span>&nbsp;<span class="ident" id="5792915">dc</span><span class="op" id="5792917">.</span><span class="ident" id="5792918">closeDBLocked</span><span class="op" id="5792931">(</span><span class="op" id="5792932">)</span><span class="op" id="5792933">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5792936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5792939">db</span><span class="op" id="5792941">.</span><span class="ident" id="5792942">freeConn</span>&nbsp;<span class="op" id="5792951">=</span>&nbsp;<span class="ident" id="5792953">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5792958">db</span><span class="op" id="5792960">.</span><span class="ident" id="5792961">closed</span>&nbsp;<span class="op" id="5792968">=</span>&nbsp;<span class="builtintype" id="5792970">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5792976">for</span>&nbsp;<span class="ident" id="5792980">_</span><span class="op" id="5792981">,</span>&nbsp;<span class="ident" id="5792983">req</span>&nbsp;<span class="op" id="5792987">:=</span>&nbsp;<span class="keyword" id="5792990">range</span>&nbsp;<span class="ident" id="5792996">db</span><span class="op" id="5792998">.</span><span class="ident" id="5792999">connRequests</span>&nbsp;<span class="op" id="5793012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5793016">close</span><span class="op" id="5793021">(</span><span class="ident" id="5793022">req</span><span class="op" id="5793025">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5793028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5793031">db</span><span class="op" id="5793033">.</span><span class="ident" id="5793034">mu</span><span class="op" id="5793036">.</span><span class="ident" id="5793037">Unlock</span><span class="op" id="5793043">(</span><span class="op" id="5793044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5793047">for</span>&nbsp;<span class="ident" id="5793051">_</span><span class="op" id="5793052">,</span>&nbsp;<span class="ident" id="5793054">fn</span>&nbsp;<span class="op" id="5793057">:=</span>&nbsp;<span class="keyword" id="5793060">range</span>&nbsp;<span class="ident" id="5793066">fns</span>&nbsp;<span class="op" id="5793070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5793074">err1</span>&nbsp;<span class="op" id="5793079">:=</span>&nbsp;<span class="ident" id="5793082">fn</span><span class="op" id="5793084">(</span><span class="op" id="5793085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5793089">if</span>&nbsp;<span class="ident" id="5793092">err1</span>&nbsp;<span class="op" id="5793097">!=</span>&nbsp;<span class="ident" id="5793100">nil</span>&nbsp;<span class="op" id="5793104">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5793109">err</span>&nbsp;<span class="op" id="5793113">=</span>&nbsp;<span class="ident" id="5793115">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5793122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5793125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5793128">return</span>&nbsp;<span class="ident" id="5793135">err</span><br>
<span class="lineno"></span><span class="op" id="5793139">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="5793142">const</span>&nbsp;<span class="ident" id="5793148">defaultMaxIdleConns</span>&nbsp;<span class="op" id="5793168">=</span>&nbsp;<span class="num" id="5793170">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5793173">func</span>&nbsp;<span class="op" id="5793178">(</span><span class="ident" id="5793179">db</span>&nbsp;<span class="op" id="5793182">*</span><span class="ident" id="5793183">DB</span><span class="op" id="5793185">)</span>&nbsp;<span class="ident" id="5793187">maxIdleConnsLocked</span><span class="op" id="5793205">(</span><span class="op" id="5793206">)</span>&nbsp;<span class="builtintype" id="5793208">int</span>&nbsp;<span class="op" id="5793212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5793215">n</span>&nbsp;<span class="op" id="5793217">:=</span>&nbsp;<span class="ident" id="5793220">db</span><span class="op" id="5793222">.</span><span class="ident" id="5793223">maxIdle</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5793232">switch</span>&nbsp;<span class="op" id="5793239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5793242">case</span>&nbsp;<span class="ident" id="5793247">n</span>&nbsp;<span class="op" id="5793249">==</span>&nbsp;<span class="num" id="5793252">0</span><span class="op" id="5793253">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5793257">//&nbsp;TODO(bradfitz):&nbsp;ask&nbsp;driver,&nbsp;if&nbsp;supported,&nbsp;for&nbsp;its&nbsp;default&nbsp;preference</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5793331">return</span>&nbsp;<span class="ident" id="5793338">defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5793359">case</span>&nbsp;<span class="ident" id="5793364">n</span>&nbsp;<span class="op" id="5793366">&lt;</span>&nbsp;<span class="num" id="5793368">0</span><span class="op" id="5793369">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5793373">return</span>&nbsp;<span class="num" id="5793380">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5793383">default</span><span class="op" id="5793390">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5793394">return</span>&nbsp;<span class="ident" id="5793401">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5793404">}</span><br>
<span class="lineno"></span><span class="op" id="5793406">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span><span class="comment" id="5793409">//&nbsp;SetMaxIdleConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;connections&nbsp;in&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="5793479">//&nbsp;connection&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="5793499">//</span><br>
<span class="lineno"></span><span class="comment" id="5793502">//&nbsp;If&nbsp;MaxOpenConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;but&nbsp;less&nbsp;than&nbsp;the&nbsp;new&nbsp;MaxIdleConns</span><br>
<span class="lineno">520</span><span class="comment" id="5793574">//&nbsp;then&nbsp;the&nbsp;new&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="5793651">//</span><br>
<span class="lineno"></span><span class="comment" id="5793654">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;no&nbsp;idle&nbsp;connections&nbsp;are&nbsp;retained.</span><br>
<span class="lineno"></span><span class="keyword" id="5793702">func</span>&nbsp;<span class="op" id="5793707">(</span><span class="ident" id="5793708">db</span>&nbsp;<span class="op" id="5793711">*</span><span class="ident" id="5793712">DB</span><span class="op" id="5793714">)</span>&nbsp;<span class="ident" id="5793716">SetMaxIdleConns</span><span class="op" id="5793731">(</span><span class="ident" id="5793732">n</span>&nbsp;<span class="builtintype" id="5793734">int</span><span class="op" id="5793737">)</span>&nbsp;<span class="op" id="5793739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5793742">db</span><span class="op" id="5793744">.</span><span class="ident" id="5793745">mu</span><span class="op" id="5793747">.</span><span class="ident" id="5793748">Lock</span><span class="op" id="5793752">(</span><span class="op" id="5793753">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5793756">if</span>&nbsp;<span class="ident" id="5793759">n</span>&nbsp;<span class="op" id="5793761">&gt;</span>&nbsp;<span class="num" id="5793763">0</span>&nbsp;<span class="op" id="5793765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5793769">db</span><span class="op" id="5793771">.</span><span class="ident" id="5793772">maxIdle</span>&nbsp;<span class="op" id="5793780">=</span>&nbsp;<span class="ident" id="5793782">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5793785">}</span>&nbsp;<span class="keyword" id="5793787">else</span>&nbsp;<span class="op" id="5793792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5793796">//&nbsp;No&nbsp;idle&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5793822">db</span><span class="op" id="5793824">.</span><span class="ident" id="5793825">maxIdle</span>&nbsp;<span class="op" id="5793833">=</span>&nbsp;<span class="op" id="5793835">-</span><span class="num" id="5793836">1</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5793839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5793842">//&nbsp;Make&nbsp;sure&nbsp;maxIdle&nbsp;doesn&#39;t&nbsp;exceed&nbsp;maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5793887">if</span>&nbsp;<span class="ident" id="5793890">db</span><span class="op" id="5793892">.</span><span class="ident" id="5793893">maxOpen</span>&nbsp;<span class="op" id="5793901">&gt;</span>&nbsp;<span class="num" id="5793903">0</span>&nbsp;<span class="op" id="5793905">&amp;&amp;</span>&nbsp;<span class="ident" id="5793908">db</span><span class="op" id="5793910">.</span><span class="ident" id="5793911">maxIdleConnsLocked</span><span class="op" id="5793929">(</span><span class="op" id="5793930">)</span>&nbsp;<span class="op" id="5793932">&gt;</span>&nbsp;<span class="ident" id="5793934">db</span><span class="op" id="5793936">.</span><span class="ident" id="5793937">maxOpen</span>&nbsp;<span class="op" id="5793945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5793949">db</span><span class="op" id="5793951">.</span><span class="ident" id="5793952">maxIdle</span>&nbsp;<span class="op" id="5793960">=</span>&nbsp;<span class="ident" id="5793962">db</span><span class="op" id="5793964">.</span><span class="ident" id="5793965">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5793974">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5793977">var</span>&nbsp;<span class="ident" id="5793981">closing</span>&nbsp;<span class="op" id="5793989">[</span><span class="op" id="5793990">]</span><span class="op" id="5793991">*</span><span class="ident" id="5793992">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5794004">idleCount</span>&nbsp;<span class="op" id="5794014">:=</span>&nbsp;<span class="builtinfunc" id="5794017">len</span><span class="op" id="5794020">(</span><span class="ident" id="5794021">db</span><span class="op" id="5794023">.</span><span class="ident" id="5794024">freeConn</span><span class="op" id="5794032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5794035">maxIdle</span>&nbsp;<span class="op" id="5794043">:=</span>&nbsp;<span class="ident" id="5794046">db</span><span class="op" id="5794048">.</span><span class="ident" id="5794049">maxIdleConnsLocked</span><span class="op" id="5794067">(</span><span class="op" id="5794068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5794071">if</span>&nbsp;<span class="ident" id="5794074">idleCount</span>&nbsp;<span class="op" id="5794084">&gt;</span>&nbsp;<span class="ident" id="5794086">maxIdle</span>&nbsp;<span class="op" id="5794094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5794098">closing</span>&nbsp;<span class="op" id="5794106">=</span>&nbsp;<span class="ident" id="5794108">db</span><span class="op" id="5794110">.</span><span class="ident" id="5794111">freeConn</span><span class="op" id="5794119">[</span><span class="ident" id="5794120">maxIdle</span><span class="op" id="5794127">:</span><span class="op" id="5794128">]</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5794132">db</span><span class="op" id="5794134">.</span><span class="ident" id="5794135">freeConn</span>&nbsp;<span class="op" id="5794144">=</span>&nbsp;<span class="ident" id="5794146">db</span><span class="op" id="5794148">.</span><span class="ident" id="5794149">freeConn</span><span class="op" id="5794157">[</span><span class="op" id="5794158">:</span><span class="ident" id="5794159">maxIdle</span><span class="op" id="5794166">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5794169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5794172">db</span><span class="op" id="5794174">.</span><span class="ident" id="5794175">mu</span><span class="op" id="5794177">.</span><span class="ident" id="5794178">Unlock</span><span class="op" id="5794184">(</span><span class="op" id="5794185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5794188">for</span>&nbsp;<span class="ident" id="5794192">_</span><span class="op" id="5794193">,</span>&nbsp;<span class="ident" id="5794195">c</span>&nbsp;<span class="op" id="5794197">:=</span>&nbsp;<span class="keyword" id="5794200">range</span>&nbsp;<span class="ident" id="5794206">closing</span>&nbsp;<span class="op" id="5794214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5794218">c</span><span class="op" id="5794219">.</span><span class="ident" id="5794220">Close</span><span class="op" id="5794225">(</span><span class="op" id="5794226">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5794229">}</span><br>
<span class="lineno"></span><span class="op" id="5794231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5794234">//&nbsp;SetMaxOpenConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;the&nbsp;database.</span><br>
<span class="lineno"></span><span class="comment" id="5794314">//</span><br>
<span class="lineno">550</span><span class="comment" id="5794317">//&nbsp;If&nbsp;MaxIdleConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;and&nbsp;the&nbsp;new&nbsp;MaxOpenConns&nbsp;is&nbsp;less&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="5794392">//&nbsp;MaxIdleConns,&nbsp;then&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="5794460">//&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="5794482">//</span><br>
<span class="lineno"></span><span class="comment" id="5794485">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;then&nbsp;there&nbsp;is&nbsp;no&nbsp;limit&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections.</span><br>
<span class="lineno">555</span><span class="comment" id="5794557">//&nbsp;The&nbsp;default&nbsp;is&nbsp;0&nbsp;(unlimited).</span><br>
<span class="lineno"></span><span class="keyword" id="5794590">func</span>&nbsp;<span class="op" id="5794595">(</span><span class="ident" id="5794596">db</span>&nbsp;<span class="op" id="5794599">*</span><span class="ident" id="5794600">DB</span><span class="op" id="5794602">)</span>&nbsp;<span class="ident" id="5794604">SetMaxOpenConns</span><span class="op" id="5794619">(</span><span class="ident" id="5794620">n</span>&nbsp;<span class="builtintype" id="5794622">int</span><span class="op" id="5794625">)</span>&nbsp;<span class="op" id="5794627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5794630">db</span><span class="op" id="5794632">.</span><span class="ident" id="5794633">mu</span><span class="op" id="5794635">.</span><span class="ident" id="5794636">Lock</span><span class="op" id="5794640">(</span><span class="op" id="5794641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5794644">db</span><span class="op" id="5794646">.</span><span class="ident" id="5794647">maxOpen</span>&nbsp;<span class="op" id="5794655">=</span>&nbsp;<span class="ident" id="5794657">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5794660">if</span>&nbsp;<span class="ident" id="5794663">n</span>&nbsp;<span class="op" id="5794665">&lt;</span>&nbsp;<span class="num" id="5794667">0</span>&nbsp;<span class="op" id="5794669">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5794673">db</span><span class="op" id="5794675">.</span><span class="ident" id="5794676">maxOpen</span>&nbsp;<span class="op" id="5794684">=</span>&nbsp;<span class="num" id="5794686">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5794689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5794692">syncMaxIdle</span>&nbsp;<span class="op" id="5794704">:=</span>&nbsp;<span class="ident" id="5794707">db</span><span class="op" id="5794709">.</span><span class="ident" id="5794710">maxOpen</span>&nbsp;<span class="op" id="5794718">&gt;</span>&nbsp;<span class="num" id="5794720">0</span>&nbsp;<span class="op" id="5794722">&amp;&amp;</span>&nbsp;<span class="ident" id="5794725">db</span><span class="op" id="5794727">.</span><span class="ident" id="5794728">maxIdleConnsLocked</span><span class="op" id="5794746">(</span><span class="op" id="5794747">)</span>&nbsp;<span class="op" id="5794749">&gt;</span>&nbsp;<span class="ident" id="5794751">db</span><span class="op" id="5794753">.</span><span class="ident" id="5794754">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5794763">db</span><span class="op" id="5794765">.</span><span class="ident" id="5794766">mu</span><span class="op" id="5794768">.</span><span class="ident" id="5794769">Unlock</span><span class="op" id="5794775">(</span><span class="op" id="5794776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5794779">if</span>&nbsp;<span class="ident" id="5794782">syncMaxIdle</span>&nbsp;<span class="op" id="5794794">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5794798">db</span><span class="op" id="5794800">.</span><span class="ident" id="5794801">SetMaxIdleConns</span><span class="op" id="5794816">(</span><span class="ident" id="5794817">n</span><span class="op" id="5794818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5794821">}</span><br>
<span class="lineno"></span><span class="op" id="5794823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5794826">//&nbsp;Assumes&nbsp;db.mu&nbsp;is&nbsp;locked.</span><br>
<span class="lineno">570</span><span class="comment" id="5794854">//&nbsp;If&nbsp;there&nbsp;are&nbsp;connRequests&nbsp;and&nbsp;the&nbsp;connection&nbsp;limit&nbsp;hasn&#39;t&nbsp;been&nbsp;reached,</span><br>
<span class="lineno"></span><span class="comment" id="5794929">//&nbsp;then&nbsp;tell&nbsp;the&nbsp;connectionOpener&nbsp;to&nbsp;open&nbsp;new&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="5794988">func</span>&nbsp;<span class="op" id="5794993">(</span><span class="ident" id="5794994">db</span>&nbsp;<span class="op" id="5794997">*</span><span class="ident" id="5794998">DB</span><span class="op" id="5795000">)</span>&nbsp;<span class="ident" id="5795002">maybeOpenNewConnections</span><span class="op" id="5795025">(</span><span class="op" id="5795026">)</span>&nbsp;<span class="op" id="5795028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795031">numRequests</span>&nbsp;<span class="op" id="5795043">:=</span>&nbsp;<span class="builtinfunc" id="5795046">len</span><span class="op" id="5795049">(</span><span class="ident" id="5795050">db</span><span class="op" id="5795052">.</span><span class="ident" id="5795053">connRequests</span><span class="op" id="5795065">)</span>&nbsp;<span class="op" id="5795067">-</span>&nbsp;<span class="ident" id="5795069">db</span><span class="op" id="5795071">.</span><span class="ident" id="5795072">pendingOpens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5795086">if</span>&nbsp;<span class="ident" id="5795089">db</span><span class="op" id="5795091">.</span><span class="ident" id="5795092">maxOpen</span>&nbsp;<span class="op" id="5795100">&gt;</span>&nbsp;<span class="num" id="5795102">0</span>&nbsp;<span class="op" id="5795104">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795108">numCanOpen</span>&nbsp;<span class="op" id="5795119">:=</span>&nbsp;<span class="ident" id="5795122">db</span><span class="op" id="5795124">.</span><span class="ident" id="5795125">maxOpen</span>&nbsp;<span class="op" id="5795133">-</span>&nbsp;<span class="op" id="5795135">(</span><span class="ident" id="5795136">db</span><span class="op" id="5795138">.</span><span class="ident" id="5795139">numOpen</span>&nbsp;<span class="op" id="5795147">+</span>&nbsp;<span class="ident" id="5795149">db</span><span class="op" id="5795151">.</span><span class="ident" id="5795152">pendingOpens</span><span class="op" id="5795164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5795168">if</span>&nbsp;<span class="ident" id="5795171">numRequests</span>&nbsp;<span class="op" id="5795183">&gt;</span>&nbsp;<span class="ident" id="5795185">numCanOpen</span>&nbsp;<span class="op" id="5795196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795201">numRequests</span>&nbsp;<span class="op" id="5795213">=</span>&nbsp;<span class="ident" id="5795215">numCanOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5795228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5795231">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5795234">for</span>&nbsp;<span class="ident" id="5795238">numRequests</span>&nbsp;<span class="op" id="5795250">&gt;</span>&nbsp;<span class="num" id="5795252">0</span>&nbsp;<span class="op" id="5795254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795258">db</span><span class="op" id="5795260">.</span><span class="ident" id="5795261">pendingOpens</span><span class="op" id="5795273">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795278">numRequests</span><span class="op" id="5795289">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795294">db</span><span class="op" id="5795296">.</span><span class="ident" id="5795297">openerCh</span>&nbsp;<span class="op" id="5795306">&lt;-</span>&nbsp;<span class="keyword" id="5795309">struct</span><span class="op" id="5795315">{</span><span class="op" id="5795316">}</span><span class="op" id="5795317">{</span><span class="op" id="5795318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5795321">}</span><br>
<span class="lineno">585</span><span class="op" id="5795323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5795326">//&nbsp;Runs&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine,&nbsp;opens&nbsp;new&nbsp;connections&nbsp;when&nbsp;requested.</span><br>
<span class="lineno"></span><span class="keyword" id="5795397">func</span>&nbsp;<span class="op" id="5795402">(</span><span class="ident" id="5795403">db</span>&nbsp;<span class="op" id="5795406">*</span><span class="ident" id="5795407">DB</span><span class="op" id="5795409">)</span>&nbsp;<span class="ident" id="5795411">connectionOpener</span><span class="op" id="5795427">(</span><span class="op" id="5795428">)</span>&nbsp;<span class="op" id="5795430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5795433">for</span>&nbsp;<span class="keyword" id="5795437">range</span>&nbsp;<span class="ident" id="5795443">db</span><span class="op" id="5795445">.</span><span class="ident" id="5795446">openerCh</span>&nbsp;<span class="op" id="5795455">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795459">db</span><span class="op" id="5795461">.</span><span class="ident" id="5795462">openNewConnection</span><span class="op" id="5795479">(</span><span class="op" id="5795480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5795483">}</span><br>
<span class="lineno"></span><span class="op" id="5795485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5795488">//&nbsp;Open&nbsp;one&nbsp;new&nbsp;connection</span><br>
<span class="lineno">595</span><span class="keyword" id="5795515">func</span>&nbsp;<span class="op" id="5795520">(</span><span class="ident" id="5795521">db</span>&nbsp;<span class="op" id="5795524">*</span><span class="ident" id="5795525">DB</span><span class="op" id="5795527">)</span>&nbsp;<span class="ident" id="5795529">openNewConnection</span><span class="op" id="5795546">(</span><span class="op" id="5795547">)</span>&nbsp;<span class="op" id="5795549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795552">ci</span><span class="op" id="5795554">,</span>&nbsp;<span class="ident" id="5795556">err</span>&nbsp;<span class="op" id="5795560">:=</span>&nbsp;<span class="ident" id="5795563">db</span><span class="op" id="5795565">.</span><span class="ident" id="5795566">driver</span><span class="op" id="5795572">.</span><span class="ident" id="5795573">Open</span><span class="op" id="5795577">(</span><span class="ident" id="5795578">db</span><span class="op" id="5795580">.</span><span class="ident" id="5795581">dsn</span><span class="op" id="5795584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795587">db</span><span class="op" id="5795589">.</span><span class="ident" id="5795590">mu</span><span class="op" id="5795592">.</span><span class="ident" id="5795593">Lock</span><span class="op" id="5795597">(</span><span class="op" id="5795598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5795601">defer</span>&nbsp;<span class="ident" id="5795607">db</span><span class="op" id="5795609">.</span><span class="ident" id="5795610">mu</span><span class="op" id="5795612">.</span><span class="ident" id="5795613">Unlock</span><span class="op" id="5795619">(</span><span class="op" id="5795620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5795623">if</span>&nbsp;<span class="ident" id="5795626">db</span><span class="op" id="5795628">.</span><span class="ident" id="5795629">closed</span>&nbsp;<span class="op" id="5795636">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5795640">if</span>&nbsp;<span class="ident" id="5795643">err</span>&nbsp;<span class="op" id="5795647">==</span>&nbsp;<span class="ident" id="5795650">nil</span>&nbsp;<span class="op" id="5795654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795659">ci</span><span class="op" id="5795661">.</span><span class="ident" id="5795662">Close</span><span class="op" id="5795667">(</span><span class="op" id="5795668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5795672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5795676">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5795684">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795687">db</span><span class="op" id="5795689">.</span><span class="ident" id="5795690">pendingOpens</span><span class="op" id="5795702">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5795706">if</span>&nbsp;<span class="ident" id="5795709">err</span>&nbsp;<span class="op" id="5795713">!=</span>&nbsp;<span class="ident" id="5795716">nil</span>&nbsp;<span class="op" id="5795720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795724">db</span><span class="op" id="5795726">.</span><span class="ident" id="5795727">putConnDBLocked</span><span class="op" id="5795742">(</span><span class="ident" id="5795743">nil</span><span class="op" id="5795746">,</span>&nbsp;<span class="ident" id="5795748">err</span><span class="op" id="5795751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5795755">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5795763">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795766">dc</span>&nbsp;<span class="op" id="5795769">:=</span>&nbsp;<span class="op" id="5795772">&amp;</span><span class="ident" id="5795773">driverConn</span><span class="op" id="5795783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795787">db</span><span class="op" id="5795789">:</span>&nbsp;<span class="ident" id="5795791">db</span><span class="op" id="5795793">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795797">ci</span><span class="op" id="5795799">:</span>&nbsp;<span class="ident" id="5795801">ci</span><span class="op" id="5795803">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5795806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5795809">if</span>&nbsp;<span class="ident" id="5795812">db</span><span class="op" id="5795814">.</span><span class="ident" id="5795815">putConnDBLocked</span><span class="op" id="5795830">(</span><span class="ident" id="5795831">dc</span><span class="op" id="5795833">,</span>&nbsp;<span class="ident" id="5795835">err</span><span class="op" id="5795838">)</span>&nbsp;<span class="op" id="5795840">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795844">db</span><span class="op" id="5795846">.</span><span class="ident" id="5795847">addDepLocked</span><span class="op" id="5795859">(</span><span class="ident" id="5795860">dc</span><span class="op" id="5795862">,</span>&nbsp;<span class="ident" id="5795864">dc</span><span class="op" id="5795866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795870">db</span><span class="op" id="5795872">.</span><span class="ident" id="5795873">numOpen</span><span class="op" id="5795880">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5795884">}</span>&nbsp;<span class="keyword" id="5795886">else</span>&nbsp;<span class="op" id="5795891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5795895">ci</span><span class="op" id="5795897">.</span><span class="ident" id="5795898">Close</span><span class="op" id="5795903">(</span><span class="op" id="5795904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5795907">}</span><br>
<span class="lineno">620</span><span class="op" id="5795909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5795912">//&nbsp;connRequest&nbsp;represents&nbsp;one&nbsp;request&nbsp;for&nbsp;a&nbsp;new&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5795971">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;idle&nbsp;connections&nbsp;available,&nbsp;DB.conn&nbsp;will&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="5796040">//&nbsp;a&nbsp;new&nbsp;connRequest&nbsp;and&nbsp;put&nbsp;it&nbsp;on&nbsp;the&nbsp;db.connRequests&nbsp;list.</span><br>
<span class="lineno">625</span><span class="keyword" id="5796101">type</span>&nbsp;<span class="ident" id="5796106">connRequest</span>&nbsp;<span class="keyword" id="5796118">struct</span>&nbsp;<span class="op" id="5796125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5796128">conn</span>&nbsp;<span class="op" id="5796133">*</span><span class="ident" id="5796134">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5796146">err</span>&nbsp;&nbsp;<span class="builtintype" id="5796151">error</span><br>
<span class="lineno"></span><span class="op" id="5796157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="5796160">var</span>&nbsp;<span class="ident" id="5796164">errDBClosed</span>&nbsp;<span class="op" id="5796176">=</span>&nbsp;<span class="ident" id="5796178">errors</span><span class="op" id="5796184">.</span><span class="ident" id="5796185">New</span><span class="op" id="5796188">(</span><span class="string" id="5796189">&#34;sql:&nbsp;database&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5796214">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5796217">//&nbsp;conn&nbsp;returns&nbsp;a&nbsp;newly-opened&nbsp;or&nbsp;cached&nbsp;*driverConn</span><br>
<span class="lineno"></span><span class="keyword" id="5796270">func</span>&nbsp;<span class="op" id="5796275">(</span><span class="ident" id="5796276">db</span>&nbsp;<span class="op" id="5796279">*</span><span class="ident" id="5796280">DB</span><span class="op" id="5796282">)</span>&nbsp;<span class="ident" id="5796284">conn</span><span class="op" id="5796288">(</span><span class="op" id="5796289">)</span>&nbsp;<span class="op" id="5796291">(</span><span class="op" id="5796292">*</span><span class="ident" id="5796293">driverConn</span><span class="op" id="5796303">,</span>&nbsp;<span class="builtintype" id="5796305">error</span><span class="op" id="5796310">)</span>&nbsp;<span class="op" id="5796312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5796315">db</span><span class="op" id="5796317">.</span><span class="ident" id="5796318">mu</span><span class="op" id="5796320">.</span><span class="ident" id="5796321">Lock</span><span class="op" id="5796325">(</span><span class="op" id="5796326">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5796329">if</span>&nbsp;<span class="ident" id="5796332">db</span><span class="op" id="5796334">.</span><span class="ident" id="5796335">closed</span>&nbsp;<span class="op" id="5796342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5796346">db</span><span class="op" id="5796348">.</span><span class="ident" id="5796349">mu</span><span class="op" id="5796351">.</span><span class="ident" id="5796352">Unlock</span><span class="op" id="5796358">(</span><span class="op" id="5796359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5796363">return</span>&nbsp;<span class="ident" id="5796370">nil</span><span class="op" id="5796373">,</span>&nbsp;<span class="ident" id="5796375">errDBClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5796388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5796392">//&nbsp;If&nbsp;db.maxOpen&nbsp;&gt;&nbsp;0&nbsp;and&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;is&nbsp;over&nbsp;the&nbsp;limit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5796467">//&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;free&nbsp;connection,&nbsp;make&nbsp;a&nbsp;request&nbsp;and&nbsp;wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5796530">if</span>&nbsp;<span class="ident" id="5796533">db</span><span class="op" id="5796535">.</span><span class="ident" id="5796536">maxOpen</span>&nbsp;<span class="op" id="5796544">&gt;</span>&nbsp;<span class="num" id="5796546">0</span>&nbsp;<span class="op" id="5796548">&amp;&amp;</span>&nbsp;<span class="ident" id="5796551">db</span><span class="op" id="5796553">.</span><span class="ident" id="5796554">numOpen</span>&nbsp;<span class="op" id="5796562">&gt;=</span>&nbsp;<span class="ident" id="5796565">db</span><span class="op" id="5796567">.</span><span class="ident" id="5796568">maxOpen</span>&nbsp;<span class="op" id="5796576">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5796579">len</span><span class="op" id="5796582">(</span><span class="ident" id="5796583">db</span><span class="op" id="5796585">.</span><span class="ident" id="5796586">freeConn</span><span class="op" id="5796594">)</span>&nbsp;<span class="op" id="5796596">==</span>&nbsp;<span class="num" id="5796599">0</span>&nbsp;<span class="op" id="5796601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5796605">//&nbsp;Make&nbsp;the&nbsp;connRequest&nbsp;channel.&nbsp;It&#39;s&nbsp;buffered&nbsp;so&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5796666">//&nbsp;connectionOpener&nbsp;doesn&#39;t&nbsp;block&nbsp;while&nbsp;waiting&nbsp;for&nbsp;the&nbsp;req&nbsp;to&nbsp;be&nbsp;read.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5796740">req</span>&nbsp;<span class="op" id="5796744">:=</span>&nbsp;<span class="builtinfunc" id="5796747">make</span><span class="op" id="5796751">(</span><span class="keyword" id="5796752">chan</span>&nbsp;<span class="ident" id="5796757">connRequest</span><span class="op" id="5796768">,</span>&nbsp;<span class="num" id="5796770">1</span><span class="op" id="5796771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5796775">db</span><span class="op" id="5796777">.</span><span class="ident" id="5796778">connRequests</span>&nbsp;<span class="op" id="5796791">=</span>&nbsp;<span class="builtinfunc" id="5796793">append</span><span class="op" id="5796799">(</span><span class="ident" id="5796800">db</span><span class="op" id="5796802">.</span><span class="ident" id="5796803">connRequests</span><span class="op" id="5796815">,</span>&nbsp;<span class="ident" id="5796817">req</span><span class="op" id="5796820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5796824">db</span><span class="op" id="5796826">.</span><span class="ident" id="5796827">maybeOpenNewConnections</span><span class="op" id="5796850">(</span><span class="op" id="5796851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5796855">db</span><span class="op" id="5796857">.</span><span class="ident" id="5796858">mu</span><span class="op" id="5796860">.</span><span class="ident" id="5796861">Unlock</span><span class="op" id="5796867">(</span><span class="op" id="5796868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5796872">ret</span>&nbsp;<span class="op" id="5796876">:=</span>&nbsp;<span class="op" id="5796879">&lt;-</span><span class="ident" id="5796881">req</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5796887">return</span>&nbsp;<span class="ident" id="5796894">ret</span><span class="op" id="5796897">.</span><span class="ident" id="5796898">conn</span><span class="op" id="5796902">,</span>&nbsp;<span class="ident" id="5796904">ret</span><span class="op" id="5796907">.</span><span class="ident" id="5796908">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5796913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5796917">if</span>&nbsp;<span class="ident" id="5796920">c</span>&nbsp;<span class="op" id="5796922">:=</span>&nbsp;<span class="builtinfunc" id="5796925">len</span><span class="op" id="5796928">(</span><span class="ident" id="5796929">db</span><span class="op" id="5796931">.</span><span class="ident" id="5796932">freeConn</span><span class="op" id="5796940">)</span><span class="op" id="5796941">;</span>&nbsp;<span class="ident" id="5796943">c</span>&nbsp;<span class="op" id="5796945">&gt;</span>&nbsp;<span class="num" id="5796947">0</span>&nbsp;<span class="op" id="5796949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5796953">conn</span>&nbsp;<span class="op" id="5796958">:=</span>&nbsp;<span class="ident" id="5796961">db</span><span class="op" id="5796963">.</span><span class="ident" id="5796964">freeConn</span><span class="op" id="5796972">[</span><span class="num" id="5796973">0</span><span class="op" id="5796974">]</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5796978">copy</span><span class="op" id="5796982">(</span><span class="ident" id="5796983">db</span><span class="op" id="5796985">.</span><span class="ident" id="5796986">freeConn</span><span class="op" id="5796994">,</span>&nbsp;<span class="ident" id="5796996">db</span><span class="op" id="5796998">.</span><span class="ident" id="5796999">freeConn</span><span class="op" id="5797007">[</span><span class="num" id="5797008">1</span><span class="op" id="5797009">:</span><span class="op" id="5797010">]</span><span class="op" id="5797011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797015">db</span><span class="op" id="5797017">.</span><span class="ident" id="5797018">freeConn</span>&nbsp;<span class="op" id="5797027">=</span>&nbsp;<span class="ident" id="5797029">db</span><span class="op" id="5797031">.</span><span class="ident" id="5797032">freeConn</span><span class="op" id="5797040">[</span><span class="op" id="5797041">:</span><span class="ident" id="5797042">c</span><span class="op" id="5797043">-</span><span class="num" id="5797044">1</span><span class="op" id="5797045">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797049">conn</span><span class="op" id="5797053">.</span><span class="ident" id="5797054">inUse</span>&nbsp;<span class="op" id="5797060">=</span>&nbsp;<span class="builtintype" id="5797062">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797069">db</span><span class="op" id="5797071">.</span><span class="ident" id="5797072">mu</span><span class="op" id="5797074">.</span><span class="ident" id="5797075">Unlock</span><span class="op" id="5797081">(</span><span class="op" id="5797082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5797086">return</span>&nbsp;<span class="ident" id="5797093">conn</span><span class="op" id="5797097">,</span>&nbsp;<span class="ident" id="5797099">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5797104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797108">db</span><span class="op" id="5797110">.</span><span class="ident" id="5797111">numOpen</span><span class="op" id="5797118">++</span>&nbsp;<span class="comment" id="5797121">//&nbsp;optimistically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797140">db</span><span class="op" id="5797142">.</span><span class="ident" id="5797143">mu</span><span class="op" id="5797145">.</span><span class="ident" id="5797146">Unlock</span><span class="op" id="5797152">(</span><span class="op" id="5797153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797156">ci</span><span class="op" id="5797158">,</span>&nbsp;<span class="ident" id="5797160">err</span>&nbsp;<span class="op" id="5797164">:=</span>&nbsp;<span class="ident" id="5797167">db</span><span class="op" id="5797169">.</span><span class="ident" id="5797170">driver</span><span class="op" id="5797176">.</span><span class="ident" id="5797177">Open</span><span class="op" id="5797181">(</span><span class="ident" id="5797182">db</span><span class="op" id="5797184">.</span><span class="ident" id="5797185">dsn</span><span class="op" id="5797188">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5797191">if</span>&nbsp;<span class="ident" id="5797194">err</span>&nbsp;<span class="op" id="5797198">!=</span>&nbsp;<span class="ident" id="5797201">nil</span>&nbsp;<span class="op" id="5797205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797209">db</span><span class="op" id="5797211">.</span><span class="ident" id="5797212">mu</span><span class="op" id="5797214">.</span><span class="ident" id="5797215">Lock</span><span class="op" id="5797219">(</span><span class="op" id="5797220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797224">db</span><span class="op" id="5797226">.</span><span class="ident" id="5797227">numOpen</span><span class="op" id="5797234">--</span>&nbsp;<span class="comment" id="5797237">//&nbsp;correct&nbsp;for&nbsp;earlier&nbsp;optimism</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797271">db</span><span class="op" id="5797273">.</span><span class="ident" id="5797274">mu</span><span class="op" id="5797276">.</span><span class="ident" id="5797277">Unlock</span><span class="op" id="5797283">(</span><span class="op" id="5797284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5797288">return</span>&nbsp;<span class="ident" id="5797295">nil</span><span class="op" id="5797298">,</span>&nbsp;<span class="ident" id="5797300">err</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5797305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797308">db</span><span class="op" id="5797310">.</span><span class="ident" id="5797311">mu</span><span class="op" id="5797313">.</span><span class="ident" id="5797314">Lock</span><span class="op" id="5797318">(</span><span class="op" id="5797319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797322">dc</span>&nbsp;<span class="op" id="5797325">:=</span>&nbsp;<span class="op" id="5797328">&amp;</span><span class="ident" id="5797329">driverConn</span><span class="op" id="5797339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797343">db</span><span class="op" id="5797345">:</span>&nbsp;<span class="ident" id="5797347">db</span><span class="op" id="5797349">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797353">ci</span><span class="op" id="5797355">:</span>&nbsp;<span class="ident" id="5797357">ci</span><span class="op" id="5797359">,</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5797362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797365">db</span><span class="op" id="5797367">.</span><span class="ident" id="5797368">addDepLocked</span><span class="op" id="5797380">(</span><span class="ident" id="5797381">dc</span><span class="op" id="5797383">,</span>&nbsp;<span class="ident" id="5797385">dc</span><span class="op" id="5797387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797390">dc</span><span class="op" id="5797392">.</span><span class="ident" id="5797393">inUse</span>&nbsp;<span class="op" id="5797399">=</span>&nbsp;<span class="builtintype" id="5797401">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797407">db</span><span class="op" id="5797409">.</span><span class="ident" id="5797410">mu</span><span class="op" id="5797412">.</span><span class="ident" id="5797413">Unlock</span><span class="op" id="5797419">(</span><span class="op" id="5797420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5797423">return</span>&nbsp;<span class="ident" id="5797430">dc</span><span class="op" id="5797432">,</span>&nbsp;<span class="ident" id="5797434">nil</span><br>
<span class="lineno">680</span><span class="op" id="5797438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5797441">var</span>&nbsp;<span class="op" id="5797445">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797448">errConnClosed</span>&nbsp;<span class="op" id="5797462">=</span>&nbsp;<span class="ident" id="5797464">errors</span><span class="op" id="5797470">.</span><span class="ident" id="5797471">New</span><span class="op" id="5797474">(</span><span class="string" id="5797475">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5797530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797533">errConnBusy</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5797547">=</span>&nbsp;<span class="ident" id="5797549">errors</span><span class="op" id="5797555">.</span><span class="ident" id="5797556">New</span><span class="op" id="5797559">(</span><span class="string" id="5797560">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;busy&#34;</span><span class="op" id="5797613">)</span><br>
<span class="lineno">685</span><span class="op" id="5797615">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5797618">//&nbsp;connIfFree&nbsp;returns&nbsp;(wanted,&nbsp;nil)&nbsp;if&nbsp;wanted&nbsp;is&nbsp;still&nbsp;a&nbsp;valid&nbsp;conn&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5797690">//&nbsp;isn&#39;t&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="comment" id="5797707">//</span><br>
<span class="lineno">690</span><span class="comment" id="5797710">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnClosed&nbsp;if&nbsp;the&nbsp;connection&nbsp;if&nbsp;the&nbsp;requested&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5797786">//&nbsp;is&nbsp;invalid&nbsp;because&nbsp;it&#39;s&nbsp;been&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="5797826">//</span><br>
<span class="lineno"></span><span class="comment" id="5797829">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnBusy&nbsp;if&nbsp;the&nbsp;connection&nbsp;is&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="5797886">func</span>&nbsp;<span class="op" id="5797891">(</span><span class="ident" id="5797892">db</span>&nbsp;<span class="op" id="5797895">*</span><span class="ident" id="5797896">DB</span><span class="op" id="5797898">)</span>&nbsp;<span class="ident" id="5797900">connIfFree</span><span class="op" id="5797910">(</span><span class="ident" id="5797911">wanted</span>&nbsp;<span class="op" id="5797918">*</span><span class="ident" id="5797919">driverConn</span><span class="op" id="5797929">)</span>&nbsp;<span class="op" id="5797931">(</span><span class="op" id="5797932">*</span><span class="ident" id="5797933">driverConn</span><span class="op" id="5797943">,</span>&nbsp;<span class="builtintype" id="5797945">error</span><span class="op" id="5797950">)</span>&nbsp;<span class="op" id="5797952">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797955">db</span><span class="op" id="5797957">.</span><span class="ident" id="5797958">mu</span><span class="op" id="5797960">.</span><span class="ident" id="5797961">Lock</span><span class="op" id="5797965">(</span><span class="op" id="5797966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5797969">defer</span>&nbsp;<span class="ident" id="5797975">db</span><span class="op" id="5797977">.</span><span class="ident" id="5797978">mu</span><span class="op" id="5797980">.</span><span class="ident" id="5797981">Unlock</span><span class="op" id="5797987">(</span><span class="op" id="5797988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5797991">if</span>&nbsp;<span class="ident" id="5797994">wanted</span><span class="op" id="5798000">.</span><span class="ident" id="5798001">dbmuClosed</span>&nbsp;<span class="op" id="5798012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798016">return</span>&nbsp;<span class="ident" id="5798023">nil</span><span class="op" id="5798026">,</span>&nbsp;<span class="ident" id="5798028">errConnClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5798043">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798046">if</span>&nbsp;<span class="ident" id="5798049">wanted</span><span class="op" id="5798055">.</span><span class="ident" id="5798056">inUse</span>&nbsp;<span class="op" id="5798062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798066">return</span>&nbsp;<span class="ident" id="5798073">nil</span><span class="op" id="5798076">,</span>&nbsp;<span class="ident" id="5798078">errConnBusy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5798091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798094">idx</span>&nbsp;<span class="op" id="5798098">:=</span>&nbsp;<span class="op" id="5798101">-</span><span class="num" id="5798102">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798105">for</span>&nbsp;<span class="ident" id="5798109">ii</span><span class="op" id="5798111">,</span>&nbsp;<span class="ident" id="5798113">v</span>&nbsp;<span class="op" id="5798115">:=</span>&nbsp;<span class="keyword" id="5798118">range</span>&nbsp;<span class="ident" id="5798124">db</span><span class="op" id="5798126">.</span><span class="ident" id="5798127">freeConn</span>&nbsp;<span class="op" id="5798136">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798140">if</span>&nbsp;<span class="ident" id="5798143">v</span>&nbsp;<span class="op" id="5798145">==</span>&nbsp;<span class="ident" id="5798148">wanted</span>&nbsp;<span class="op" id="5798155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798160">idx</span>&nbsp;<span class="op" id="5798164">=</span>&nbsp;<span class="ident" id="5798166">ii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798172">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5798180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5798183">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798186">if</span>&nbsp;<span class="ident" id="5798189">idx</span>&nbsp;<span class="op" id="5798193">&gt;=</span>&nbsp;<span class="num" id="5798196">0</span>&nbsp;<span class="op" id="5798198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798202">db</span><span class="op" id="5798204">.</span><span class="ident" id="5798205">freeConn</span>&nbsp;<span class="op" id="5798214">=</span>&nbsp;<span class="builtinfunc" id="5798216">append</span><span class="op" id="5798222">(</span><span class="ident" id="5798223">db</span><span class="op" id="5798225">.</span><span class="ident" id="5798226">freeConn</span><span class="op" id="5798234">[</span><span class="op" id="5798235">:</span><span class="ident" id="5798236">idx</span><span class="op" id="5798239">]</span><span class="op" id="5798240">,</span>&nbsp;<span class="ident" id="5798242">db</span><span class="op" id="5798244">.</span><span class="ident" id="5798245">freeConn</span><span class="op" id="5798253">[</span><span class="ident" id="5798254">idx</span><span class="op" id="5798257">+</span><span class="num" id="5798258">1</span><span class="op" id="5798259">:</span><span class="op" id="5798260">]</span><span class="op" id="5798261">...</span><span class="op" id="5798264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798268">wanted</span><span class="op" id="5798274">.</span><span class="ident" id="5798275">inUse</span>&nbsp;<span class="op" id="5798281">=</span>&nbsp;<span class="builtintype" id="5798283">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798290">return</span>&nbsp;<span class="ident" id="5798297">wanted</span><span class="op" id="5798303">,</span>&nbsp;<span class="ident" id="5798305">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5798310">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5798313">//&nbsp;TODO(bradfitz):&nbsp;shouldn&#39;t&nbsp;get&nbsp;here.&nbsp;After&nbsp;Go&nbsp;1.1,&nbsp;change&nbsp;this&nbsp;to:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5798383">//&nbsp;panic(&#34;connIfFree&nbsp;call&nbsp;requested&nbsp;a&nbsp;non-closed,&nbsp;non-busy,&nbsp;non-free&nbsp;conn&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5798460">//&nbsp;Which&nbsp;passes&nbsp;all&nbsp;the&nbsp;tests,&nbsp;but&nbsp;I&#39;m&nbsp;too&nbsp;paranoid&nbsp;to&nbsp;include&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5798529">//&nbsp;late&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5798549">//&nbsp;Instead,&nbsp;treat&nbsp;it&nbsp;like&nbsp;a&nbsp;busy&nbsp;connection:</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798595">return</span>&nbsp;<span class="ident" id="5798602">nil</span><span class="op" id="5798605">,</span>&nbsp;<span class="ident" id="5798607">errConnBusy</span><br>
<span class="lineno"></span><span class="op" id="5798619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5798622">//&nbsp;putConnHook&nbsp;is&nbsp;a&nbsp;hook&nbsp;for&nbsp;testing.</span><br>
<span class="lineno"></span><span class="keyword" id="5798660">var</span>&nbsp;<span class="ident" id="5798664">putConnHook</span>&nbsp;<span class="keyword" id="5798676">func</span><span class="op" id="5798680">(</span><span class="op" id="5798681">*</span><span class="ident" id="5798682">DB</span><span class="op" id="5798684">,</span>&nbsp;<span class="op" id="5798686">*</span><span class="ident" id="5798687">driverConn</span><span class="op" id="5798697">)</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="5798700">//&nbsp;noteUnusedDriverStatement&nbsp;notes&nbsp;that&nbsp;si&nbsp;is&nbsp;no&nbsp;longer&nbsp;used&nbsp;and&nbsp;should</span><br>
<span class="lineno"></span><span class="comment" id="5798772">//&nbsp;be&nbsp;closed&nbsp;whenever&nbsp;possible&nbsp;(when&nbsp;c&nbsp;is&nbsp;next&nbsp;not&nbsp;in&nbsp;use),&nbsp;unless&nbsp;c&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5798844">//&nbsp;already&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="5798863">func</span>&nbsp;<span class="op" id="5798868">(</span><span class="ident" id="5798869">db</span>&nbsp;<span class="op" id="5798872">*</span><span class="ident" id="5798873">DB</span><span class="op" id="5798875">)</span>&nbsp;<span class="ident" id="5798877">noteUnusedDriverStatement</span><span class="op" id="5798902">(</span><span class="ident" id="5798903">c</span>&nbsp;<span class="op" id="5798905">*</span><span class="ident" id="5798906">driverConn</span><span class="op" id="5798916">,</span>&nbsp;<span class="ident" id="5798918">si</span>&nbsp;<span class="ident" id="5798921">driver</span><span class="op" id="5798927">.</span><span class="ident" id="5798928">Stmt</span><span class="op" id="5798932">)</span>&nbsp;<span class="op" id="5798934">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798937">db</span><span class="op" id="5798939">.</span><span class="ident" id="5798940">mu</span><span class="op" id="5798942">.</span><span class="ident" id="5798943">Lock</span><span class="op" id="5798947">(</span><span class="op" id="5798948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798951">defer</span>&nbsp;<span class="ident" id="5798957">db</span><span class="op" id="5798959">.</span><span class="ident" id="5798960">mu</span><span class="op" id="5798962">.</span><span class="ident" id="5798963">Unlock</span><span class="op" id="5798969">(</span><span class="op" id="5798970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798973">if</span>&nbsp;<span class="ident" id="5798976">c</span><span class="op" id="5798977">.</span><span class="ident" id="5798978">inUse</span>&nbsp;<span class="op" id="5798984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798988">c</span><span class="op" id="5798989">.</span><span class="ident" id="5798990">onPut</span>&nbsp;<span class="op" id="5798996">=</span>&nbsp;<span class="builtinfunc" id="5798998">append</span><span class="op" id="5799004">(</span><span class="ident" id="5799005">c</span><span class="op" id="5799006">.</span><span class="ident" id="5799007">onPut</span><span class="op" id="5799012">,</span>&nbsp;<span class="keyword" id="5799014">func</span><span class="op" id="5799018">(</span><span class="op" id="5799019">)</span>&nbsp;<span class="op" id="5799021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799026">si</span><span class="op" id="5799028">.</span><span class="ident" id="5799029">Close</span><span class="op" id="5799034">(</span><span class="op" id="5799035">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5799039">}</span><span class="op" id="5799040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5799043">}</span>&nbsp;<span class="keyword" id="5799045">else</span>&nbsp;<span class="op" id="5799050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799054">c</span><span class="op" id="5799055">.</span><span class="ident" id="5799056">Lock</span><span class="op" id="5799060">(</span><span class="op" id="5799061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5799065">defer</span>&nbsp;<span class="ident" id="5799071">c</span><span class="op" id="5799072">.</span><span class="ident" id="5799073">Unlock</span><span class="op" id="5799079">(</span><span class="op" id="5799080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5799084">if</span>&nbsp;<span class="op" id="5799087">!</span><span class="ident" id="5799088">c</span><span class="op" id="5799089">.</span><span class="ident" id="5799090">finalClosed</span>&nbsp;<span class="op" id="5799102">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799107">si</span><span class="op" id="5799109">.</span><span class="ident" id="5799110">Close</span><span class="op" id="5799115">(</span><span class="op" id="5799116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5799120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5799123">}</span><br>
<span class="lineno"></span><span class="op" id="5799125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">745</span><span class="comment" id="5799128">//&nbsp;debugGetPut&nbsp;determines&nbsp;whether&nbsp;getConn&nbsp;&amp;&nbsp;putConn&nbsp;calls&#39;&nbsp;stack&nbsp;traces</span><br>
<span class="lineno"></span><span class="comment" id="5799200">//&nbsp;are&nbsp;returned&nbsp;for&nbsp;more&nbsp;verbose&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="5799242">const</span>&nbsp;<span class="ident" id="5799248">debugGetPut</span>&nbsp;<span class="op" id="5799260">=</span>&nbsp;<span class="builtintype" id="5799262">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5799269">//&nbsp;putConn&nbsp;adds&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;db&#39;s&nbsp;free&nbsp;pool.</span><br>
<span class="lineno">750</span><span class="comment" id="5799321">//&nbsp;err&nbsp;is&nbsp;optionally&nbsp;the&nbsp;last&nbsp;error&nbsp;that&nbsp;occurred&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5799391">func</span>&nbsp;<span class="op" id="5799396">(</span><span class="ident" id="5799397">db</span>&nbsp;<span class="op" id="5799400">*</span><span class="ident" id="5799401">DB</span><span class="op" id="5799403">)</span>&nbsp;<span class="ident" id="5799405">putConn</span><span class="op" id="5799412">(</span><span class="ident" id="5799413">dc</span>&nbsp;<span class="op" id="5799416">*</span><span class="ident" id="5799417">driverConn</span><span class="op" id="5799427">,</span>&nbsp;<span class="ident" id="5799429">err</span>&nbsp;<span class="builtintype" id="5799433">error</span><span class="op" id="5799438">)</span>&nbsp;<span class="op" id="5799440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799443">db</span><span class="op" id="5799445">.</span><span class="ident" id="5799446">mu</span><span class="op" id="5799448">.</span><span class="ident" id="5799449">Lock</span><span class="op" id="5799453">(</span><span class="op" id="5799454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5799457">if</span>&nbsp;<span class="op" id="5799460">!</span><span class="ident" id="5799461">dc</span><span class="op" id="5799463">.</span><span class="ident" id="5799464">inUse</span>&nbsp;<span class="op" id="5799470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5799474">if</span>&nbsp;<span class="ident" id="5799477">debugGetPut</span>&nbsp;<span class="op" id="5799489">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799494">fmt</span><span class="op" id="5799497">.</span><span class="ident" id="5799498">Printf</span><span class="op" id="5799504">(</span><span class="string" id="5799505">&#34;putConn(%v)&nbsp;DUPLICATE&nbsp;was:&nbsp;%s\n\nPREVIOUS&nbsp;was:&nbsp;%s&#34;</span><span class="op" id="5799556">,</span>&nbsp;<span class="ident" id="5799558">dc</span><span class="op" id="5799560">,</span>&nbsp;<span class="ident" id="5799562">stack</span><span class="op" id="5799567">(</span><span class="op" id="5799568">)</span><span class="op" id="5799569">,</span>&nbsp;<span class="ident" id="5799571">db</span><span class="op" id="5799573">.</span><span class="ident" id="5799574">lastPut</span><span class="op" id="5799581">[</span><span class="ident" id="5799582">dc</span><span class="op" id="5799584">]</span><span class="op" id="5799585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5799589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5799593">panic</span><span class="op" id="5799598">(</span><span class="string" id="5799599">&#34;sql:&nbsp;connection&nbsp;returned&nbsp;that&nbsp;was&nbsp;never&nbsp;out&#34;</span><span class="op" id="5799644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5799647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5799650">if</span>&nbsp;<span class="ident" id="5799653">debugGetPut</span>&nbsp;<span class="op" id="5799665">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799669">db</span><span class="op" id="5799671">.</span><span class="ident" id="5799672">lastPut</span><span class="op" id="5799679">[</span><span class="ident" id="5799680">dc</span><span class="op" id="5799682">]</span>&nbsp;<span class="op" id="5799684">=</span>&nbsp;<span class="ident" id="5799686">stack</span><span class="op" id="5799691">(</span><span class="op" id="5799692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5799695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799698">dc</span><span class="op" id="5799700">.</span><span class="ident" id="5799701">inUse</span>&nbsp;<span class="op" id="5799707">=</span>&nbsp;<span class="builtintype" id="5799709">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5799717">for</span>&nbsp;<span class="ident" id="5799721">_</span><span class="op" id="5799722">,</span>&nbsp;<span class="ident" id="5799724">fn</span>&nbsp;<span class="op" id="5799727">:=</span>&nbsp;<span class="keyword" id="5799730">range</span>&nbsp;<span class="ident" id="5799736">dc</span><span class="op" id="5799738">.</span><span class="ident" id="5799739">onPut</span>&nbsp;<span class="op" id="5799745">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799749">fn</span><span class="op" id="5799751">(</span><span class="op" id="5799752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5799755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799758">dc</span><span class="op" id="5799760">.</span><span class="ident" id="5799761">onPut</span>&nbsp;<span class="op" id="5799767">=</span>&nbsp;<span class="ident" id="5799769">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5799775">if</span>&nbsp;<span class="ident" id="5799778">err</span>&nbsp;<span class="op" id="5799782">==</span>&nbsp;<span class="ident" id="5799785">driver</span><span class="op" id="5799791">.</span><span class="ident" id="5799792">ErrBadConn</span>&nbsp;<span class="op" id="5799803">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5799807">//&nbsp;Don&#39;t&nbsp;reuse&nbsp;bad&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5799841">//&nbsp;Since&nbsp;the&nbsp;conn&nbsp;is&nbsp;considered&nbsp;bad&nbsp;and&nbsp;is&nbsp;being&nbsp;discarded,&nbsp;treat&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5799912">//&nbsp;as&nbsp;closed.&nbsp;Don&#39;t&nbsp;decrement&nbsp;the&nbsp;open&nbsp;count&nbsp;here,&nbsp;finalClose&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5799981">//&nbsp;take&nbsp;care&nbsp;of&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800005">db</span><span class="op" id="5800007">.</span><span class="ident" id="5800008">maybeOpenNewConnections</span><span class="op" id="5800031">(</span><span class="op" id="5800032">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800036">db</span><span class="op" id="5800038">.</span><span class="ident" id="5800039">mu</span><span class="op" id="5800041">.</span><span class="ident" id="5800042">Unlock</span><span class="op" id="5800048">(</span><span class="op" id="5800049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800053">dc</span><span class="op" id="5800055">.</span><span class="ident" id="5800056">Close</span><span class="op" id="5800061">(</span><span class="op" id="5800062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5800066">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5800074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5800077">if</span>&nbsp;<span class="ident" id="5800080">putConnHook</span>&nbsp;<span class="op" id="5800092">!=</span>&nbsp;<span class="ident" id="5800095">nil</span>&nbsp;<span class="op" id="5800099">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800103">putConnHook</span><span class="op" id="5800114">(</span><span class="ident" id="5800115">db</span><span class="op" id="5800117">,</span>&nbsp;<span class="ident" id="5800119">dc</span><span class="op" id="5800121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5800124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800127">added</span>&nbsp;<span class="op" id="5800133">:=</span>&nbsp;<span class="ident" id="5800136">db</span><span class="op" id="5800138">.</span><span class="ident" id="5800139">putConnDBLocked</span><span class="op" id="5800154">(</span><span class="ident" id="5800155">dc</span><span class="op" id="5800157">,</span>&nbsp;<span class="ident" id="5800159">nil</span><span class="op" id="5800162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800165">db</span><span class="op" id="5800167">.</span><span class="ident" id="5800168">mu</span><span class="op" id="5800170">.</span><span class="ident" id="5800171">Unlock</span><span class="op" id="5800177">(</span><span class="op" id="5800178">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5800182">if</span>&nbsp;<span class="op" id="5800185">!</span><span class="ident" id="5800186">added</span>&nbsp;<span class="op" id="5800192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800196">dc</span><span class="op" id="5800198">.</span><span class="ident" id="5800199">Close</span><span class="op" id="5800204">(</span><span class="op" id="5800205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5800208">}</span><br>
<span class="lineno"></span><span class="op" id="5800210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">790</span><span class="comment" id="5800213">//&nbsp;Satisfy&nbsp;a&nbsp;connRequest&nbsp;or&nbsp;put&nbsp;the&nbsp;driverConn&nbsp;in&nbsp;the&nbsp;idle&nbsp;pool&nbsp;and&nbsp;return&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="5800293">//&nbsp;or&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="5800313">//&nbsp;putConnDBLocked&nbsp;will&nbsp;satisfy&nbsp;a&nbsp;connRequest&nbsp;if&nbsp;there&nbsp;is&nbsp;one,&nbsp;or&nbsp;it&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="5800387">//&nbsp;return&nbsp;the&nbsp;*driverConn&nbsp;to&nbsp;the&nbsp;freeConn&nbsp;list&nbsp;if&nbsp;err&nbsp;==&nbsp;nil&nbsp;and&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="5800461">//&nbsp;connection&nbsp;limit&nbsp;will&nbsp;not&nbsp;be&nbsp;exceeded.</span><br>
<span class="lineno">795</span><span class="comment" id="5800503">//&nbsp;If&nbsp;err&nbsp;!=&nbsp;nil,&nbsp;the&nbsp;value&nbsp;of&nbsp;dc&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="5800549">//&nbsp;If&nbsp;err&nbsp;==&nbsp;nil,&nbsp;then&nbsp;dc&nbsp;must&nbsp;not&nbsp;equal&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="5800595">//&nbsp;If&nbsp;a&nbsp;connRequest&nbsp;was&nbsp;fulfilled&nbsp;or&nbsp;the&nbsp;*driverConn&nbsp;was&nbsp;placed&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5800666">//&nbsp;freeConn&nbsp;list,&nbsp;then&nbsp;true&nbsp;is&nbsp;returned,&nbsp;otherwise&nbsp;false&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5800736">func</span>&nbsp;<span class="op" id="5800741">(</span><span class="ident" id="5800742">db</span>&nbsp;<span class="op" id="5800745">*</span><span class="ident" id="5800746">DB</span><span class="op" id="5800748">)</span>&nbsp;<span class="ident" id="5800750">putConnDBLocked</span><span class="op" id="5800765">(</span><span class="ident" id="5800766">dc</span>&nbsp;<span class="op" id="5800769">*</span><span class="ident" id="5800770">driverConn</span><span class="op" id="5800780">,</span>&nbsp;<span class="ident" id="5800782">err</span>&nbsp;<span class="builtintype" id="5800786">error</span><span class="op" id="5800791">)</span>&nbsp;<span class="builtintype" id="5800793">bool</span>&nbsp;<span class="op" id="5800798">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5800801">if</span>&nbsp;<span class="ident" id="5800804">c</span>&nbsp;<span class="op" id="5800806">:=</span>&nbsp;<span class="builtinfunc" id="5800809">len</span><span class="op" id="5800812">(</span><span class="ident" id="5800813">db</span><span class="op" id="5800815">.</span><span class="ident" id="5800816">connRequests</span><span class="op" id="5800828">)</span><span class="op" id="5800829">;</span>&nbsp;<span class="ident" id="5800831">c</span>&nbsp;<span class="op" id="5800833">&gt;</span>&nbsp;<span class="num" id="5800835">0</span>&nbsp;<span class="op" id="5800837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800841">req</span>&nbsp;<span class="op" id="5800845">:=</span>&nbsp;<span class="ident" id="5800848">db</span><span class="op" id="5800850">.</span><span class="ident" id="5800851">connRequests</span><span class="op" id="5800863">[</span><span class="num" id="5800864">0</span><span class="op" id="5800865">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800869">//&nbsp;This&nbsp;copy&nbsp;is&nbsp;O(n)&nbsp;but&nbsp;in&nbsp;practice&nbsp;faster&nbsp;than&nbsp;a&nbsp;linked&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800935">//&nbsp;TODO:&nbsp;consider&nbsp;compacting&nbsp;it&nbsp;down&nbsp;less&nbsp;often&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800989">//&nbsp;moving&nbsp;the&nbsp;base&nbsp;instead?</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5801019">copy</span><span class="op" id="5801023">(</span><span class="ident" id="5801024">db</span><span class="op" id="5801026">.</span><span class="ident" id="5801027">connRequests</span><span class="op" id="5801039">,</span>&nbsp;<span class="ident" id="5801041">db</span><span class="op" id="5801043">.</span><span class="ident" id="5801044">connRequests</span><span class="op" id="5801056">[</span><span class="num" id="5801057">1</span><span class="op" id="5801058">:</span><span class="op" id="5801059">]</span><span class="op" id="5801060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5801064">db</span><span class="op" id="5801066">.</span><span class="ident" id="5801067">connRequests</span>&nbsp;<span class="op" id="5801080">=</span>&nbsp;<span class="ident" id="5801082">db</span><span class="op" id="5801084">.</span><span class="ident" id="5801085">connRequests</span><span class="op" id="5801097">[</span><span class="op" id="5801098">:</span><span class="ident" id="5801099">c</span><span class="op" id="5801100">-</span><span class="num" id="5801101">1</span><span class="op" id="5801102">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5801106">if</span>&nbsp;<span class="ident" id="5801109">err</span>&nbsp;<span class="op" id="5801113">==</span>&nbsp;<span class="ident" id="5801116">nil</span>&nbsp;<span class="op" id="5801120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5801125">dc</span><span class="op" id="5801127">.</span><span class="ident" id="5801128">inUse</span>&nbsp;<span class="op" id="5801134">=</span>&nbsp;<span class="builtintype" id="5801136">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5801143">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5801147">req</span>&nbsp;<span class="op" id="5801151">&lt;-</span>&nbsp;<span class="ident" id="5801154">connRequest</span><span class="op" id="5801165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5801170">conn</span><span class="op" id="5801174">:</span>&nbsp;<span class="ident" id="5801176">dc</span><span class="op" id="5801178">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5801183">err</span><span class="op" id="5801186">:</span>&nbsp;&nbsp;<span class="ident" id="5801189">err</span><span class="op" id="5801192">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5801196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5801200">return</span>&nbsp;<span class="builtintype" id="5801207">true</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5801213">}</span>&nbsp;<span class="keyword" id="5801215">else</span>&nbsp;<span class="keyword" id="5801220">if</span>&nbsp;<span class="ident" id="5801223">err</span>&nbsp;<span class="op" id="5801227">==</span>&nbsp;<span class="ident" id="5801230">nil</span>&nbsp;<span class="op" id="5801234">&amp;&amp;</span>&nbsp;<span class="op" id="5801237">!</span><span class="ident" id="5801238">db</span><span class="op" id="5801240">.</span><span class="ident" id="5801241">closed</span>&nbsp;<span class="op" id="5801248">&amp;&amp;</span>&nbsp;<span class="ident" id="5801251">db</span><span class="op" id="5801253">.</span><span class="ident" id="5801254">maxIdleConnsLocked</span><span class="op" id="5801272">(</span><span class="op" id="5801273">)</span>&nbsp;<span class="op" id="5801275">&gt;</span>&nbsp;<span class="builtinfunc" id="5801277">len</span><span class="op" id="5801280">(</span><span class="ident" id="5801281">db</span><span class="op" id="5801283">.</span><span class="ident" id="5801284">freeConn</span><span class="op" id="5801292">)</span>&nbsp;<span class="op" id="5801294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5801298">db</span><span class="op" id="5801300">.</span><span class="ident" id="5801301">freeConn</span>&nbsp;<span class="op" id="5801310">=</span>&nbsp;<span class="builtinfunc" id="5801312">append</span><span class="op" id="5801318">(</span><span class="ident" id="5801319">db</span><span class="op" id="5801321">.</span><span class="ident" id="5801322">freeConn</span><span class="op" id="5801330">,</span>&nbsp;<span class="ident" id="5801332">dc</span><span class="op" id="5801334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5801338">return</span>&nbsp;<span class="builtintype" id="5801345">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5801351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5801354">return</span>&nbsp;<span class="builtintype" id="5801361">false</span><br>
<span class="lineno">820</span><span class="op" id="5801367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5801370">//&nbsp;maxBadConnRetries&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;maximum&nbsp;retries&nbsp;if&nbsp;the&nbsp;driver&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5801446">//&nbsp;driver.ErrBadConn&nbsp;to&nbsp;signal&nbsp;a&nbsp;broken&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5801498">const</span>&nbsp;<span class="ident" id="5801504">maxBadConnRetries</span>&nbsp;<span class="op" id="5801522">=</span>&nbsp;<span class="num" id="5801524">10</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="comment" id="5801528">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;later&nbsp;queries&nbsp;or&nbsp;executions.</span><br>
<span class="lineno"></span><span class="comment" id="5801601">//&nbsp;Multiple&nbsp;queries&nbsp;or&nbsp;executions&nbsp;may&nbsp;be&nbsp;run&nbsp;concurrently&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5801668">//&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5801691">func</span>&nbsp;<span class="op" id="5801696">(</span><span class="ident" id="5801697">db</span>&nbsp;<span class="op" id="5801700">*</span><span class="ident" id="5801701">DB</span><span class="op" id="5801703">)</span>&nbsp;<span class="ident" id="5801705">Prepare</span><span class="op" id="5801712">(</span><span class="ident" id="5801713">query</span>&nbsp;<span class="builtintype" id="5801719">string</span><span class="op" id="5801725">)</span>&nbsp;<span class="op" id="5801727">(</span><span class="op" id="5801728">*</span><span class="ident" id="5801729">Stmt</span><span class="op" id="5801733">,</span>&nbsp;<span class="builtintype" id="5801735">error</span><span class="op" id="5801740">)</span>&nbsp;<span class="op" id="5801742">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5801745">var</span>&nbsp;<span class="ident" id="5801749">stmt</span>&nbsp;<span class="op" id="5801754">*</span><span class="ident" id="5801755">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5801761">var</span>&nbsp;<span class="ident" id="5801765">err</span>&nbsp;<span class="builtintype" id="5801769">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5801776">for</span>&nbsp;<span class="ident" id="5801780">i</span>&nbsp;<span class="op" id="5801782">:=</span>&nbsp;<span class="num" id="5801785">0</span><span class="op" id="5801786">;</span>&nbsp;<span class="ident" id="5801788">i</span>&nbsp;<span class="op" id="5801790">&lt;</span>&nbsp;<span class="ident" id="5801792">maxBadConnRetries</span><span class="op" id="5801809">;</span>&nbsp;<span class="ident" id="5801811">i</span><span class="op" id="5801812">++</span>&nbsp;<span class="op" id="5801815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5801819">stmt</span><span class="op" id="5801823">,</span>&nbsp;<span class="ident" id="5801825">err</span>&nbsp;<span class="op" id="5801829">=</span>&nbsp;<span class="ident" id="5801831">db</span><span class="op" id="5801833">.</span><span class="ident" id="5801834">prepare</span><span class="op" id="5801841">(</span><span class="ident" id="5801842">query</span><span class="op" id="5801847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5801851">if</span>&nbsp;<span class="ident" id="5801854">err</span>&nbsp;<span class="op" id="5801858">!=</span>&nbsp;<span class="ident" id="5801861">driver</span><span class="op" id="5801867">.</span><span class="ident" id="5801868">ErrBadConn</span>&nbsp;<span class="op" id="5801879">{</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5801884">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5801892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5801895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5801898">return</span>&nbsp;<span class="ident" id="5801905">stmt</span><span class="op" id="5801909">,</span>&nbsp;<span class="ident" id="5801911">err</span><br>
<span class="lineno"></span><span class="op" id="5801915">}</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span><span class="keyword" id="5801918">func</span>&nbsp;<span class="op" id="5801923">(</span><span class="ident" id="5801924">db</span>&nbsp;<span class="op" id="5801927">*</span><span class="ident" id="5801928">DB</span><span class="op" id="5801930">)</span>&nbsp;<span class="ident" id="5801932">prepare</span><span class="op" id="5801939">(</span><span class="ident" id="5801940">query</span>&nbsp;<span class="builtintype" id="5801946">string</span><span class="op" id="5801952">)</span>&nbsp;<span class="op" id="5801954">(</span><span class="op" id="5801955">*</span><span class="ident" id="5801956">Stmt</span><span class="op" id="5801960">,</span>&nbsp;<span class="builtintype" id="5801962">error</span><span class="op" id="5801967">)</span>&nbsp;<span class="op" id="5801969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5801972">//&nbsp;TODO:&nbsp;check&nbsp;if&nbsp;db.driver&nbsp;supports&nbsp;an&nbsp;optional</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5802022">//&nbsp;driver.Preparer&nbsp;interface&nbsp;and&nbsp;call&nbsp;that&nbsp;instead,&nbsp;if&nbsp;so,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5802082">//&nbsp;otherwise&nbsp;we&nbsp;make&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;that&#39;s&nbsp;bound</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5802138">//&nbsp;to&nbsp;a&nbsp;connection,&nbsp;and&nbsp;to&nbsp;execute&nbsp;this&nbsp;prepared&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5802198">//&nbsp;we&nbsp;either&nbsp;need&nbsp;to&nbsp;use&nbsp;this&nbsp;connection&nbsp;(if&nbsp;it&#39;s&nbsp;free),&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5802261">//&nbsp;get&nbsp;a&nbsp;new&nbsp;connection&nbsp;+&nbsp;re-prepare&nbsp;+&nbsp;execute&nbsp;on&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802322">dc</span><span class="op" id="5802324">,</span>&nbsp;<span class="ident" id="5802326">err</span>&nbsp;<span class="op" id="5802330">:=</span>&nbsp;<span class="ident" id="5802333">db</span><span class="op" id="5802335">.</span><span class="ident" id="5802336">conn</span><span class="op" id="5802340">(</span><span class="op" id="5802341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802344">if</span>&nbsp;<span class="ident" id="5802347">err</span>&nbsp;<span class="op" id="5802351">!=</span>&nbsp;<span class="ident" id="5802354">nil</span>&nbsp;<span class="op" id="5802358">{</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802362">return</span>&nbsp;<span class="ident" id="5802369">nil</span><span class="op" id="5802372">,</span>&nbsp;<span class="ident" id="5802374">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5802379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802382">dc</span><span class="op" id="5802384">.</span><span class="ident" id="5802385">Lock</span><span class="op" id="5802389">(</span><span class="op" id="5802390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802393">si</span><span class="op" id="5802395">,</span>&nbsp;<span class="ident" id="5802397">err</span>&nbsp;<span class="op" id="5802401">:=</span>&nbsp;<span class="ident" id="5802404">dc</span><span class="op" id="5802406">.</span><span class="ident" id="5802407">prepareLocked</span><span class="op" id="5802420">(</span><span class="ident" id="5802421">query</span><span class="op" id="5802426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802429">dc</span><span class="op" id="5802431">.</span><span class="ident" id="5802432">Unlock</span><span class="op" id="5802438">(</span><span class="op" id="5802439">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802442">if</span>&nbsp;<span class="ident" id="5802445">err</span>&nbsp;<span class="op" id="5802449">!=</span>&nbsp;<span class="ident" id="5802452">nil</span>&nbsp;<span class="op" id="5802456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802460">db</span><span class="op" id="5802462">.</span><span class="ident" id="5802463">putConn</span><span class="op" id="5802470">(</span><span class="ident" id="5802471">dc</span><span class="op" id="5802473">,</span>&nbsp;<span class="ident" id="5802475">err</span><span class="op" id="5802478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802482">return</span>&nbsp;<span class="ident" id="5802489">nil</span><span class="op" id="5802492">,</span>&nbsp;<span class="ident" id="5802494">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5802499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802502">stmt</span>&nbsp;<span class="op" id="5802507">:=</span>&nbsp;<span class="op" id="5802510">&amp;</span><span class="ident" id="5802511">Stmt</span><span class="op" id="5802515">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802519">db</span><span class="op" id="5802521">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802526">db</span><span class="op" id="5802528">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802532">query</span><span class="op" id="5802537">:</span>&nbsp;<span class="ident" id="5802539">query</span><span class="op" id="5802544">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802548">css</span><span class="op" id="5802551">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5802555">[</span><span class="op" id="5802556">]</span><span class="ident" id="5802557">connStmt</span><span class="op" id="5802565">{</span><span class="op" id="5802566">{</span><span class="ident" id="5802567">dc</span><span class="op" id="5802569">,</span>&nbsp;<span class="ident" id="5802571">si</span><span class="op" id="5802573">}</span><span class="op" id="5802574">}</span><span class="op" id="5802575">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5802578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802581">db</span><span class="op" id="5802583">.</span><span class="ident" id="5802584">addDep</span><span class="op" id="5802590">(</span><span class="ident" id="5802591">stmt</span><span class="op" id="5802595">,</span>&nbsp;<span class="ident" id="5802597">stmt</span><span class="op" id="5802601">)</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802604">db</span><span class="op" id="5802606">.</span><span class="ident" id="5802607">putConn</span><span class="op" id="5802614">(</span><span class="ident" id="5802615">dc</span><span class="op" id="5802617">,</span>&nbsp;<span class="ident" id="5802619">nil</span><span class="op" id="5802622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802625">return</span>&nbsp;<span class="ident" id="5802632">stmt</span><span class="op" id="5802636">,</span>&nbsp;<span class="ident" id="5802638">nil</span><br>
<span class="lineno"></span><span class="op" id="5802642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5802645">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;without&nbsp;returning&nbsp;any&nbsp;rows.</span><br>
<span class="lineno">870</span><span class="comment" id="5802698">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno"></span><span class="keyword" id="5802759">func</span>&nbsp;<span class="op" id="5802764">(</span><span class="ident" id="5802765">db</span>&nbsp;<span class="op" id="5802768">*</span><span class="ident" id="5802769">DB</span><span class="op" id="5802771">)</span>&nbsp;<span class="ident" id="5802773">Exec</span><span class="op" id="5802777">(</span><span class="ident" id="5802778">query</span>&nbsp;<span class="builtintype" id="5802784">string</span><span class="op" id="5802790">,</span>&nbsp;<span class="ident" id="5802792">args</span>&nbsp;<span class="op" id="5802797">...</span><span class="keyword" id="5802800">interface</span><span class="op" id="5802809">{</span><span class="op" id="5802810">}</span><span class="op" id="5802811">)</span>&nbsp;<span class="op" id="5802813">(</span><span class="ident" id="5802814">Result</span><span class="op" id="5802820">,</span>&nbsp;<span class="builtintype" id="5802822">error</span><span class="op" id="5802827">)</span>&nbsp;<span class="op" id="5802829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802832">var</span>&nbsp;<span class="ident" id="5802836">res</span>&nbsp;<span class="ident" id="5802840">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802848">var</span>&nbsp;<span class="ident" id="5802852">err</span>&nbsp;<span class="builtintype" id="5802856">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802863">for</span>&nbsp;<span class="ident" id="5802867">i</span>&nbsp;<span class="op" id="5802869">:=</span>&nbsp;<span class="num" id="5802872">0</span><span class="op" id="5802873">;</span>&nbsp;<span class="ident" id="5802875">i</span>&nbsp;<span class="op" id="5802877">&lt;</span>&nbsp;<span class="ident" id="5802879">maxBadConnRetries</span><span class="op" id="5802896">;</span>&nbsp;<span class="ident" id="5802898">i</span><span class="op" id="5802899">++</span>&nbsp;<span class="op" id="5802902">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802906">res</span><span class="op" id="5802909">,</span>&nbsp;<span class="ident" id="5802911">err</span>&nbsp;<span class="op" id="5802915">=</span>&nbsp;<span class="ident" id="5802917">db</span><span class="op" id="5802919">.</span><span class="ident" id="5802920">exec</span><span class="op" id="5802924">(</span><span class="ident" id="5802925">query</span><span class="op" id="5802930">,</span>&nbsp;<span class="ident" id="5802932">args</span><span class="op" id="5802936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802940">if</span>&nbsp;<span class="ident" id="5802943">err</span>&nbsp;<span class="op" id="5802947">!=</span>&nbsp;<span class="ident" id="5802950">driver</span><span class="op" id="5802956">.</span><span class="ident" id="5802957">ErrBadConn</span>&nbsp;<span class="op" id="5802968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802973">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5802981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5802984">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5802987">return</span>&nbsp;<span class="ident" id="5802994">res</span><span class="op" id="5802997">,</span>&nbsp;<span class="ident" id="5802999">err</span><br>
<span class="lineno"></span><span class="op" id="5803003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5803006">func</span>&nbsp;<span class="op" id="5803011">(</span><span class="ident" id="5803012">db</span>&nbsp;<span class="op" id="5803015">*</span><span class="ident" id="5803016">DB</span><span class="op" id="5803018">)</span>&nbsp;<span class="ident" id="5803020">exec</span><span class="op" id="5803024">(</span><span class="ident" id="5803025">query</span>&nbsp;<span class="builtintype" id="5803031">string</span><span class="op" id="5803037">,</span>&nbsp;<span class="ident" id="5803039">args</span>&nbsp;<span class="op" id="5803044">[</span><span class="op" id="5803045">]</span><span class="keyword" id="5803046">interface</span><span class="op" id="5803055">{</span><span class="op" id="5803056">}</span><span class="op" id="5803057">)</span>&nbsp;<span class="op" id="5803059">(</span><span class="ident" id="5803060">res</span>&nbsp;<span class="ident" id="5803064">Result</span><span class="op" id="5803070">,</span>&nbsp;<span class="ident" id="5803072">err</span>&nbsp;<span class="builtintype" id="5803076">error</span><span class="op" id="5803081">)</span>&nbsp;<span class="op" id="5803083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803086">dc</span><span class="op" id="5803088">,</span>&nbsp;<span class="ident" id="5803090">err</span>&nbsp;<span class="op" id="5803094">:=</span>&nbsp;<span class="ident" id="5803097">db</span><span class="op" id="5803099">.</span><span class="ident" id="5803100">conn</span><span class="op" id="5803104">(</span><span class="op" id="5803105">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803108">if</span>&nbsp;<span class="ident" id="5803111">err</span>&nbsp;<span class="op" id="5803115">!=</span>&nbsp;<span class="ident" id="5803118">nil</span>&nbsp;<span class="op" id="5803122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803126">return</span>&nbsp;<span class="ident" id="5803133">nil</span><span class="op" id="5803136">,</span>&nbsp;<span class="ident" id="5803138">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803146">defer</span>&nbsp;<span class="keyword" id="5803152">func</span><span class="op" id="5803156">(</span><span class="op" id="5803157">)</span>&nbsp;<span class="op" id="5803159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803163">db</span><span class="op" id="5803165">.</span><span class="ident" id="5803166">putConn</span><span class="op" id="5803173">(</span><span class="ident" id="5803174">dc</span><span class="op" id="5803176">,</span>&nbsp;<span class="ident" id="5803178">err</span><span class="op" id="5803181">)</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803184">}</span><span class="op" id="5803185">(</span><span class="op" id="5803186">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803190">if</span>&nbsp;<span class="ident" id="5803193">execer</span><span class="op" id="5803199">,</span>&nbsp;<span class="ident" id="5803201">ok</span>&nbsp;<span class="op" id="5803204">:=</span>&nbsp;<span class="ident" id="5803207">dc</span><span class="op" id="5803209">.</span><span class="ident" id="5803210">ci</span><span class="op" id="5803212">.</span><span class="op" id="5803213">(</span><span class="ident" id="5803214">driver</span><span class="op" id="5803220">.</span><span class="ident" id="5803221">Execer</span><span class="op" id="5803227">)</span><span class="op" id="5803228">;</span>&nbsp;<span class="ident" id="5803230">ok</span>&nbsp;<span class="op" id="5803233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803237">dargs</span><span class="op" id="5803242">,</span>&nbsp;<span class="ident" id="5803244">err</span>&nbsp;<span class="op" id="5803248">:=</span>&nbsp;<span class="ident" id="5803251">driverArgs</span><span class="op" id="5803261">(</span><span class="ident" id="5803262">nil</span><span class="op" id="5803265">,</span>&nbsp;<span class="ident" id="5803267">args</span><span class="op" id="5803271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803275">if</span>&nbsp;<span class="ident" id="5803278">err</span>&nbsp;<span class="op" id="5803282">!=</span>&nbsp;<span class="ident" id="5803285">nil</span>&nbsp;<span class="op" id="5803289">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803294">return</span>&nbsp;<span class="ident" id="5803301">nil</span><span class="op" id="5803304">,</span>&nbsp;<span class="ident" id="5803306">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803316">dc</span><span class="op" id="5803318">.</span><span class="ident" id="5803319">Lock</span><span class="op" id="5803323">(</span><span class="op" id="5803324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803328">resi</span><span class="op" id="5803332">,</span>&nbsp;<span class="ident" id="5803334">err</span>&nbsp;<span class="op" id="5803338">:=</span>&nbsp;<span class="ident" id="5803341">execer</span><span class="op" id="5803347">.</span><span class="ident" id="5803348">Exec</span><span class="op" id="5803352">(</span><span class="ident" id="5803353">query</span><span class="op" id="5803358">,</span>&nbsp;<span class="ident" id="5803360">dargs</span><span class="op" id="5803365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803369">dc</span><span class="op" id="5803371">.</span><span class="ident" id="5803372">Unlock</span><span class="op" id="5803378">(</span><span class="op" id="5803379">)</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803383">if</span>&nbsp;<span class="ident" id="5803386">err</span>&nbsp;<span class="op" id="5803390">!=</span>&nbsp;<span class="ident" id="5803393">driver</span><span class="op" id="5803399">.</span><span class="ident" id="5803400">ErrSkip</span>&nbsp;<span class="op" id="5803408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803413">if</span>&nbsp;<span class="ident" id="5803416">err</span>&nbsp;<span class="op" id="5803420">!=</span>&nbsp;<span class="ident" id="5803423">nil</span>&nbsp;<span class="op" id="5803427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803433">return</span>&nbsp;<span class="ident" id="5803440">nil</span><span class="op" id="5803443">,</span>&nbsp;<span class="ident" id="5803445">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803457">return</span>&nbsp;<span class="ident" id="5803464">driverResult</span><span class="op" id="5803476">{</span><span class="ident" id="5803477">dc</span><span class="op" id="5803479">,</span>&nbsp;<span class="ident" id="5803481">resi</span><span class="op" id="5803485">}</span><span class="op" id="5803486">,</span>&nbsp;<span class="ident" id="5803488">nil</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803501">dc</span><span class="op" id="5803503">.</span><span class="ident" id="5803504">Lock</span><span class="op" id="5803508">(</span><span class="op" id="5803509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803512">si</span><span class="op" id="5803514">,</span>&nbsp;<span class="ident" id="5803516">err</span>&nbsp;<span class="op" id="5803520">:=</span>&nbsp;<span class="ident" id="5803523">dc</span><span class="op" id="5803525">.</span><span class="ident" id="5803526">ci</span><span class="op" id="5803528">.</span><span class="ident" id="5803529">Prepare</span><span class="op" id="5803536">(</span><span class="ident" id="5803537">query</span><span class="op" id="5803542">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803545">dc</span><span class="op" id="5803547">.</span><span class="ident" id="5803548">Unlock</span><span class="op" id="5803554">(</span><span class="op" id="5803555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803558">if</span>&nbsp;<span class="ident" id="5803561">err</span>&nbsp;<span class="op" id="5803565">!=</span>&nbsp;<span class="ident" id="5803568">nil</span>&nbsp;<span class="op" id="5803572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803576">return</span>&nbsp;<span class="ident" id="5803583">nil</span><span class="op" id="5803586">,</span>&nbsp;<span class="ident" id="5803588">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5803593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803596">defer</span>&nbsp;<span class="ident" id="5803602">withLock</span><span class="op" id="5803610">(</span><span class="ident" id="5803611">dc</span><span class="op" id="5803613">,</span>&nbsp;<span class="keyword" id="5803615">func</span><span class="op" id="5803619">(</span><span class="op" id="5803620">)</span>&nbsp;<span class="op" id="5803622">{</span>&nbsp;<span class="ident" id="5803624">si</span><span class="op" id="5803626">.</span><span class="ident" id="5803627">Close</span><span class="op" id="5803632">(</span><span class="op" id="5803633">)</span>&nbsp;<span class="op" id="5803635">}</span><span class="op" id="5803636">)</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803639">return</span>&nbsp;<span class="ident" id="5803646">resultFromStatement</span><span class="op" id="5803665">(</span><span class="ident" id="5803666">driverStmt</span><span class="op" id="5803676">{</span><span class="ident" id="5803677">dc</span><span class="op" id="5803679">,</span>&nbsp;<span class="ident" id="5803681">si</span><span class="op" id="5803683">}</span><span class="op" id="5803684">,</span>&nbsp;<span class="ident" id="5803686">args</span><span class="op" id="5803690">...</span><span class="op" id="5803693">)</span><br>
<span class="lineno"></span><span class="op" id="5803695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5803698">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="comment" id="5803763">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno">920</span><span class="keyword" id="5803824">func</span>&nbsp;<span class="op" id="5803829">(</span><span class="ident" id="5803830">db</span>&nbsp;<span class="op" id="5803833">*</span><span class="ident" id="5803834">DB</span><span class="op" id="5803836">)</span>&nbsp;<span class="ident" id="5803838">Query</span><span class="op" id="5803843">(</span><span class="ident" id="5803844">query</span>&nbsp;<span class="builtintype" id="5803850">string</span><span class="op" id="5803856">,</span>&nbsp;<span class="ident" id="5803858">args</span>&nbsp;<span class="op" id="5803863">...</span><span class="keyword" id="5803866">interface</span><span class="op" id="5803875">{</span><span class="op" id="5803876">}</span><span class="op" id="5803877">)</span>&nbsp;<span class="op" id="5803879">(</span><span class="op" id="5803880">*</span><span class="ident" id="5803881">Rows</span><span class="op" id="5803885">,</span>&nbsp;<span class="builtintype" id="5803887">error</span><span class="op" id="5803892">)</span>&nbsp;<span class="op" id="5803894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803897">var</span>&nbsp;<span class="ident" id="5803901">rows</span>&nbsp;<span class="op" id="5803906">*</span><span class="ident" id="5803907">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803913">var</span>&nbsp;<span class="ident" id="5803917">err</span>&nbsp;<span class="builtintype" id="5803921">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803928">for</span>&nbsp;<span class="ident" id="5803932">i</span>&nbsp;<span class="op" id="5803934">:=</span>&nbsp;<span class="num" id="5803937">0</span><span class="op" id="5803938">;</span>&nbsp;<span class="ident" id="5803940">i</span>&nbsp;<span class="op" id="5803942">&lt;</span>&nbsp;<span class="ident" id="5803944">maxBadConnRetries</span><span class="op" id="5803961">;</span>&nbsp;<span class="ident" id="5803963">i</span><span class="op" id="5803964">++</span>&nbsp;<span class="op" id="5803967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803971">rows</span><span class="op" id="5803975">,</span>&nbsp;<span class="ident" id="5803977">err</span>&nbsp;<span class="op" id="5803981">=</span>&nbsp;<span class="ident" id="5803983">db</span><span class="op" id="5803985">.</span><span class="ident" id="5803986">query</span><span class="op" id="5803991">(</span><span class="ident" id="5803992">query</span><span class="op" id="5803997">,</span>&nbsp;<span class="ident" id="5803999">args</span><span class="op" id="5804003">)</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804007">if</span>&nbsp;<span class="ident" id="5804010">err</span>&nbsp;<span class="op" id="5804014">!=</span>&nbsp;<span class="ident" id="5804017">driver</span><span class="op" id="5804023">.</span><span class="ident" id="5804024">ErrBadConn</span>&nbsp;<span class="op" id="5804035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804040">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804054">return</span>&nbsp;<span class="ident" id="5804061">rows</span><span class="op" id="5804065">,</span>&nbsp;<span class="ident" id="5804067">err</span><br>
<span class="lineno">930</span><span class="op" id="5804071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5804074">func</span>&nbsp;<span class="op" id="5804079">(</span><span class="ident" id="5804080">db</span>&nbsp;<span class="op" id="5804083">*</span><span class="ident" id="5804084">DB</span><span class="op" id="5804086">)</span>&nbsp;<span class="ident" id="5804088">query</span><span class="op" id="5804093">(</span><span class="ident" id="5804094">query</span>&nbsp;<span class="builtintype" id="5804100">string</span><span class="op" id="5804106">,</span>&nbsp;<span class="ident" id="5804108">args</span>&nbsp;<span class="op" id="5804113">[</span><span class="op" id="5804114">]</span><span class="keyword" id="5804115">interface</span><span class="op" id="5804124">{</span><span class="op" id="5804125">}</span><span class="op" id="5804126">)</span>&nbsp;<span class="op" id="5804128">(</span><span class="op" id="5804129">*</span><span class="ident" id="5804130">Rows</span><span class="op" id="5804134">,</span>&nbsp;<span class="builtintype" id="5804136">error</span><span class="op" id="5804141">)</span>&nbsp;<span class="op" id="5804143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804146">ci</span><span class="op" id="5804148">,</span>&nbsp;<span class="ident" id="5804150">err</span>&nbsp;<span class="op" id="5804154">:=</span>&nbsp;<span class="ident" id="5804157">db</span><span class="op" id="5804159">.</span><span class="ident" id="5804160">conn</span><span class="op" id="5804164">(</span><span class="op" id="5804165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804168">if</span>&nbsp;<span class="ident" id="5804171">err</span>&nbsp;<span class="op" id="5804175">!=</span>&nbsp;<span class="ident" id="5804178">nil</span>&nbsp;<span class="op" id="5804182">{</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804186">return</span>&nbsp;<span class="ident" id="5804193">nil</span><span class="op" id="5804196">,</span>&nbsp;<span class="ident" id="5804198">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804207">return</span>&nbsp;<span class="ident" id="5804214">db</span><span class="op" id="5804216">.</span><span class="ident" id="5804217">queryConn</span><span class="op" id="5804226">(</span><span class="ident" id="5804227">ci</span><span class="op" id="5804229">,</span>&nbsp;<span class="ident" id="5804231">ci</span><span class="op" id="5804233">.</span><span class="ident" id="5804234">releaseConn</span><span class="op" id="5804245">,</span>&nbsp;<span class="ident" id="5804247">query</span><span class="op" id="5804252">,</span>&nbsp;<span class="ident" id="5804254">args</span><span class="op" id="5804258">)</span><br>
<span class="lineno"></span><span class="op" id="5804260">}</span><br>
<span class="lineno">940</span><br>
<span class="lineno"></span><span class="comment" id="5804263">//&nbsp;queryConn&nbsp;executes&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;given&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5804318">//&nbsp;The&nbsp;connection&nbsp;gets&nbsp;released&nbsp;by&nbsp;the&nbsp;releaseConn&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="5804379">func</span>&nbsp;<span class="op" id="5804384">(</span><span class="ident" id="5804385">db</span>&nbsp;<span class="op" id="5804388">*</span><span class="ident" id="5804389">DB</span><span class="op" id="5804391">)</span>&nbsp;<span class="ident" id="5804393">queryConn</span><span class="op" id="5804402">(</span><span class="ident" id="5804403">dc</span>&nbsp;<span class="op" id="5804406">*</span><span class="ident" id="5804407">driverConn</span><span class="op" id="5804417">,</span>&nbsp;<span class="ident" id="5804419">releaseConn</span>&nbsp;<span class="keyword" id="5804431">func</span><span class="op" id="5804435">(</span><span class="builtintype" id="5804436">error</span><span class="op" id="5804441">)</span><span class="op" id="5804442">,</span>&nbsp;<span class="ident" id="5804444">query</span>&nbsp;<span class="builtintype" id="5804450">string</span><span class="op" id="5804456">,</span>&nbsp;<span class="ident" id="5804458">args</span>&nbsp;<span class="op" id="5804463">[</span><span class="op" id="5804464">]</span><span class="keyword" id="5804465">interface</span><span class="op" id="5804474">{</span><span class="op" id="5804475">}</span><span class="op" id="5804476">)</span>&nbsp;<span class="op" id="5804478">(</span><span class="op" id="5804479">*</span><span class="ident" id="5804480">Rows</span><span class="op" id="5804484">,</span>&nbsp;<span class="builtintype" id="5804486">error</span><span class="op" id="5804491">)</span>&nbsp;<span class="op" id="5804493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804496">if</span>&nbsp;<span class="ident" id="5804499">queryer</span><span class="op" id="5804506">,</span>&nbsp;<span class="ident" id="5804508">ok</span>&nbsp;<span class="op" id="5804511">:=</span>&nbsp;<span class="ident" id="5804514">dc</span><span class="op" id="5804516">.</span><span class="ident" id="5804517">ci</span><span class="op" id="5804519">.</span><span class="op" id="5804520">(</span><span class="ident" id="5804521">driver</span><span class="op" id="5804527">.</span><span class="ident" id="5804528">Queryer</span><span class="op" id="5804535">)</span><span class="op" id="5804536">;</span>&nbsp;<span class="ident" id="5804538">ok</span>&nbsp;<span class="op" id="5804541">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804545">dargs</span><span class="op" id="5804550">,</span>&nbsp;<span class="ident" id="5804552">err</span>&nbsp;<span class="op" id="5804556">:=</span>&nbsp;<span class="ident" id="5804559">driverArgs</span><span class="op" id="5804569">(</span><span class="ident" id="5804570">nil</span><span class="op" id="5804573">,</span>&nbsp;<span class="ident" id="5804575">args</span><span class="op" id="5804579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804583">if</span>&nbsp;<span class="ident" id="5804586">err</span>&nbsp;<span class="op" id="5804590">!=</span>&nbsp;<span class="ident" id="5804593">nil</span>&nbsp;<span class="op" id="5804597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804602">releaseConn</span><span class="op" id="5804613">(</span><span class="ident" id="5804614">err</span><span class="op" id="5804617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804622">return</span>&nbsp;<span class="ident" id="5804629">nil</span><span class="op" id="5804632">,</span>&nbsp;<span class="ident" id="5804634">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804640">}</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804644">dc</span><span class="op" id="5804646">.</span><span class="ident" id="5804647">Lock</span><span class="op" id="5804651">(</span><span class="op" id="5804652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804656">rowsi</span><span class="op" id="5804661">,</span>&nbsp;<span class="ident" id="5804663">err</span>&nbsp;<span class="op" id="5804667">:=</span>&nbsp;<span class="ident" id="5804670">queryer</span><span class="op" id="5804677">.</span><span class="ident" id="5804678">Query</span><span class="op" id="5804683">(</span><span class="ident" id="5804684">query</span><span class="op" id="5804689">,</span>&nbsp;<span class="ident" id="5804691">dargs</span><span class="op" id="5804696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804700">dc</span><span class="op" id="5804702">.</span><span class="ident" id="5804703">Unlock</span><span class="op" id="5804709">(</span><span class="op" id="5804710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804714">if</span>&nbsp;<span class="ident" id="5804717">err</span>&nbsp;<span class="op" id="5804721">!=</span>&nbsp;<span class="ident" id="5804724">driver</span><span class="op" id="5804730">.</span><span class="ident" id="5804731">ErrSkip</span>&nbsp;<span class="op" id="5804739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804744">if</span>&nbsp;<span class="ident" id="5804747">err</span>&nbsp;<span class="op" id="5804751">!=</span>&nbsp;<span class="ident" id="5804754">nil</span>&nbsp;<span class="op" id="5804758">{</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804764">releaseConn</span><span class="op" id="5804775">(</span><span class="ident" id="5804776">err</span><span class="op" id="5804779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804785">return</span>&nbsp;<span class="ident" id="5804792">nil</span><span class="op" id="5804795">,</span>&nbsp;<span class="ident" id="5804797">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5804809">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;dc&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5804870">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804894">rows</span>&nbsp;<span class="op" id="5804899">:=</span>&nbsp;<span class="op" id="5804902">&amp;</span><span class="ident" id="5804903">Rows</span><span class="op" id="5804907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804913">dc</span><span class="op" id="5804915">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5804926">dc</span><span class="op" id="5804928">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804934">releaseConn</span><span class="op" id="5804945">:</span>&nbsp;<span class="ident" id="5804947">releaseConn</span><span class="op" id="5804958">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804964">rowsi</span><span class="op" id="5804969">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5804977">rowsi</span><span class="op" id="5804982">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804987">}</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804992">return</span>&nbsp;<span class="ident" id="5804999">rows</span><span class="op" id="5805003">,</span>&nbsp;<span class="ident" id="5805005">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5805011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5805014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805018">dc</span><span class="op" id="5805020">.</span><span class="ident" id="5805021">Lock</span><span class="op" id="5805025">(</span><span class="op" id="5805026">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805029">si</span><span class="op" id="5805031">,</span>&nbsp;<span class="ident" id="5805033">err</span>&nbsp;<span class="op" id="5805037">:=</span>&nbsp;<span class="ident" id="5805040">dc</span><span class="op" id="5805042">.</span><span class="ident" id="5805043">ci</span><span class="op" id="5805045">.</span><span class="ident" id="5805046">Prepare</span><span class="op" id="5805053">(</span><span class="ident" id="5805054">query</span><span class="op" id="5805059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805062">dc</span><span class="op" id="5805064">.</span><span class="ident" id="5805065">Unlock</span><span class="op" id="5805071">(</span><span class="op" id="5805072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805075">if</span>&nbsp;<span class="ident" id="5805078">err</span>&nbsp;<span class="op" id="5805082">!=</span>&nbsp;<span class="ident" id="5805085">nil</span>&nbsp;<span class="op" id="5805089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805093">releaseConn</span><span class="op" id="5805104">(</span><span class="ident" id="5805105">err</span><span class="op" id="5805108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805112">return</span>&nbsp;<span class="ident" id="5805119">nil</span><span class="op" id="5805122">,</span>&nbsp;<span class="ident" id="5805124">err</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5805129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805133">ds</span>&nbsp;<span class="op" id="5805136">:=</span>&nbsp;<span class="ident" id="5805139">driverStmt</span><span class="op" id="5805149">{</span><span class="ident" id="5805150">dc</span><span class="op" id="5805152">,</span>&nbsp;<span class="ident" id="5805154">si</span><span class="op" id="5805156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805159">rowsi</span><span class="op" id="5805164">,</span>&nbsp;<span class="ident" id="5805166">err</span>&nbsp;<span class="op" id="5805170">:=</span>&nbsp;<span class="ident" id="5805173">rowsiFromStatement</span><span class="op" id="5805191">(</span><span class="ident" id="5805192">ds</span><span class="op" id="5805194">,</span>&nbsp;<span class="ident" id="5805196">args</span><span class="op" id="5805200">...</span><span class="op" id="5805203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805206">if</span>&nbsp;<span class="ident" id="5805209">err</span>&nbsp;<span class="op" id="5805213">!=</span>&nbsp;<span class="ident" id="5805216">nil</span>&nbsp;<span class="op" id="5805220">{</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805224">dc</span><span class="op" id="5805226">.</span><span class="ident" id="5805227">Lock</span><span class="op" id="5805231">(</span><span class="op" id="5805232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805236">si</span><span class="op" id="5805238">.</span><span class="ident" id="5805239">Close</span><span class="op" id="5805244">(</span><span class="op" id="5805245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805249">dc</span><span class="op" id="5805251">.</span><span class="ident" id="5805252">Unlock</span><span class="op" id="5805258">(</span><span class="op" id="5805259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805263">releaseConn</span><span class="op" id="5805274">(</span><span class="ident" id="5805275">err</span><span class="op" id="5805278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805282">return</span>&nbsp;<span class="ident" id="5805289">nil</span><span class="op" id="5805292">,</span>&nbsp;<span class="ident" id="5805294">err</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5805299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5805303">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5805362">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805384">rows</span>&nbsp;<span class="op" id="5805389">:=</span>&nbsp;<span class="op" id="5805392">&amp;</span><span class="ident" id="5805393">Rows</span><span class="op" id="5805397">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805401">dc</span><span class="op" id="5805403">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5805414">dc</span><span class="op" id="5805416">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805420">releaseConn</span><span class="op" id="5805431">:</span>&nbsp;<span class="ident" id="5805433">releaseConn</span><span class="op" id="5805444">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805448">rowsi</span><span class="op" id="5805453">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5805461">rowsi</span><span class="op" id="5805466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805470">closeStmt</span><span class="op" id="5805479">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5805483">si</span><span class="op" id="5805485">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5805488">}</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805491">return</span>&nbsp;<span class="ident" id="5805498">rows</span><span class="op" id="5805502">,</span>&nbsp;<span class="ident" id="5805504">nil</span><br>
<span class="lineno"></span><span class="op" id="5805508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5805511">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="5805584">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno">1000</span><span class="comment" id="5805653">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="5805685">func</span>&nbsp;<span class="op" id="5805690">(</span><span class="ident" id="5805691">db</span>&nbsp;<span class="op" id="5805694">*</span><span class="ident" id="5805695">DB</span><span class="op" id="5805697">)</span>&nbsp;<span class="ident" id="5805699">QueryRow</span><span class="op" id="5805707">(</span><span class="ident" id="5805708">query</span>&nbsp;<span class="builtintype" id="5805714">string</span><span class="op" id="5805720">,</span>&nbsp;<span class="ident" id="5805722">args</span>&nbsp;<span class="op" id="5805727">...</span><span class="keyword" id="5805730">interface</span><span class="op" id="5805739">{</span><span class="op" id="5805740">}</span><span class="op" id="5805741">)</span>&nbsp;<span class="op" id="5805743">*</span><span class="ident" id="5805744">Row</span>&nbsp;<span class="op" id="5805748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805751">rows</span><span class="op" id="5805755">,</span>&nbsp;<span class="ident" id="5805757">err</span>&nbsp;<span class="op" id="5805761">:=</span>&nbsp;<span class="ident" id="5805764">db</span><span class="op" id="5805766">.</span><span class="ident" id="5805767">Query</span><span class="op" id="5805772">(</span><span class="ident" id="5805773">query</span><span class="op" id="5805778">,</span>&nbsp;<span class="ident" id="5805780">args</span><span class="op" id="5805784">...</span><span class="op" id="5805787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805790">return</span>&nbsp;<span class="op" id="5805797">&amp;</span><span class="ident" id="5805798">Row</span><span class="op" id="5805801">{</span><span class="ident" id="5805802">rows</span><span class="op" id="5805806">:</span>&nbsp;<span class="ident" id="5805808">rows</span><span class="op" id="5805812">,</span>&nbsp;<span class="ident" id="5805814">err</span><span class="op" id="5805817">:</span>&nbsp;<span class="ident" id="5805819">err</span><span class="op" id="5805822">}</span><br>
<span class="lineno"></span><span class="op" id="5805824">}</span><br>
<span class="lineno">1005</span><br>
<span class="lineno"></span><span class="comment" id="5805827">//&nbsp;Begin&nbsp;starts&nbsp;a&nbsp;transaction.&nbsp;The&nbsp;isolation&nbsp;level&nbsp;is&nbsp;dependent&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="5805894">//&nbsp;the&nbsp;driver.</span><br>
<span class="lineno"></span><span class="keyword" id="5805909">func</span>&nbsp;<span class="op" id="5805914">(</span><span class="ident" id="5805915">db</span>&nbsp;<span class="op" id="5805918">*</span><span class="ident" id="5805919">DB</span><span class="op" id="5805921">)</span>&nbsp;<span class="ident" id="5805923">Begin</span><span class="op" id="5805928">(</span><span class="op" id="5805929">)</span>&nbsp;<span class="op" id="5805931">(</span><span class="op" id="5805932">*</span><span class="ident" id="5805933">Tx</span><span class="op" id="5805935">,</span>&nbsp;<span class="builtintype" id="5805937">error</span><span class="op" id="5805942">)</span>&nbsp;<span class="op" id="5805944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805947">var</span>&nbsp;<span class="ident" id="5805951">tx</span>&nbsp;<span class="op" id="5805954">*</span><span class="ident" id="5805955">Tx</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805959">var</span>&nbsp;<span class="ident" id="5805963">err</span>&nbsp;<span class="builtintype" id="5805967">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805974">for</span>&nbsp;<span class="ident" id="5805978">i</span>&nbsp;<span class="op" id="5805980">:=</span>&nbsp;<span class="num" id="5805983">0</span><span class="op" id="5805984">;</span>&nbsp;<span class="ident" id="5805986">i</span>&nbsp;<span class="op" id="5805988">&lt;</span>&nbsp;<span class="ident" id="5805990">maxBadConnRetries</span><span class="op" id="5806007">;</span>&nbsp;<span class="ident" id="5806009">i</span><span class="op" id="5806010">++</span>&nbsp;<span class="op" id="5806013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806017">tx</span><span class="op" id="5806019">,</span>&nbsp;<span class="ident" id="5806021">err</span>&nbsp;<span class="op" id="5806025">=</span>&nbsp;<span class="ident" id="5806027">db</span><span class="op" id="5806029">.</span><span class="ident" id="5806030">begin</span><span class="op" id="5806035">(</span><span class="op" id="5806036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806040">if</span>&nbsp;<span class="ident" id="5806043">err</span>&nbsp;<span class="op" id="5806047">!=</span>&nbsp;<span class="ident" id="5806050">driver</span><span class="op" id="5806056">.</span><span class="ident" id="5806057">ErrBadConn</span>&nbsp;<span class="op" id="5806068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806073">break</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5806081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5806084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806087">return</span>&nbsp;<span class="ident" id="5806094">tx</span><span class="op" id="5806096">,</span>&nbsp;<span class="ident" id="5806098">err</span><br>
<span class="lineno"></span><span class="op" id="5806102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1020</span><span class="keyword" id="5806105">func</span>&nbsp;<span class="op" id="5806110">(</span><span class="ident" id="5806111">db</span>&nbsp;<span class="op" id="5806114">*</span><span class="ident" id="5806115">DB</span><span class="op" id="5806117">)</span>&nbsp;<span class="ident" id="5806119">begin</span><span class="op" id="5806124">(</span><span class="op" id="5806125">)</span>&nbsp;<span class="op" id="5806127">(</span><span class="ident" id="5806128">tx</span>&nbsp;<span class="op" id="5806131">*</span><span class="ident" id="5806132">Tx</span><span class="op" id="5806134">,</span>&nbsp;<span class="ident" id="5806136">err</span>&nbsp;<span class="builtintype" id="5806140">error</span><span class="op" id="5806145">)</span>&nbsp;<span class="op" id="5806147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806150">dc</span><span class="op" id="5806152">,</span>&nbsp;<span class="ident" id="5806154">err</span>&nbsp;<span class="op" id="5806158">:=</span>&nbsp;<span class="ident" id="5806161">db</span><span class="op" id="5806163">.</span><span class="ident" id="5806164">conn</span><span class="op" id="5806168">(</span><span class="op" id="5806169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806172">if</span>&nbsp;<span class="ident" id="5806175">err</span>&nbsp;<span class="op" id="5806179">!=</span>&nbsp;<span class="ident" id="5806182">nil</span>&nbsp;<span class="op" id="5806186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806190">return</span>&nbsp;<span class="ident" id="5806197">nil</span><span class="op" id="5806200">,</span>&nbsp;<span class="ident" id="5806202">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5806207">}</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806210">dc</span><span class="op" id="5806212">.</span><span class="ident" id="5806213">Lock</span><span class="op" id="5806217">(</span><span class="op" id="5806218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806221">txi</span><span class="op" id="5806224">,</span>&nbsp;<span class="ident" id="5806226">err</span>&nbsp;<span class="op" id="5806230">:=</span>&nbsp;<span class="ident" id="5806233">dc</span><span class="op" id="5806235">.</span><span class="ident" id="5806236">ci</span><span class="op" id="5806238">.</span><span class="ident" id="5806239">Begin</span><span class="op" id="5806244">(</span><span class="op" id="5806245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806248">dc</span><span class="op" id="5806250">.</span><span class="ident" id="5806251">Unlock</span><span class="op" id="5806257">(</span><span class="op" id="5806258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806261">if</span>&nbsp;<span class="ident" id="5806264">err</span>&nbsp;<span class="op" id="5806268">!=</span>&nbsp;<span class="ident" id="5806271">nil</span>&nbsp;<span class="op" id="5806275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806279">db</span><span class="op" id="5806281">.</span><span class="ident" id="5806282">putConn</span><span class="op" id="5806289">(</span><span class="ident" id="5806290">dc</span><span class="op" id="5806292">,</span>&nbsp;<span class="ident" id="5806294">err</span><span class="op" id="5806297">)</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806301">return</span>&nbsp;<span class="ident" id="5806308">nil</span><span class="op" id="5806311">,</span>&nbsp;<span class="ident" id="5806313">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5806318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806321">return</span>&nbsp;<span class="op" id="5806328">&amp;</span><span class="ident" id="5806329">Tx</span><span class="op" id="5806331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806335">db</span><span class="op" id="5806337">:</span>&nbsp;&nbsp;<span class="ident" id="5806340">db</span><span class="op" id="5806342">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806346">dc</span><span class="op" id="5806348">:</span>&nbsp;&nbsp;<span class="ident" id="5806351">dc</span><span class="op" id="5806353">,</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806357">txi</span><span class="op" id="5806360">:</span>&nbsp;<span class="ident" id="5806362">txi</span><span class="op" id="5806365">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5806368">}</span><span class="op" id="5806369">,</span>&nbsp;<span class="ident" id="5806371">nil</span><br>
<span class="lineno"></span><span class="op" id="5806375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5806378">//&nbsp;Driver&nbsp;returns&nbsp;the&nbsp;database&#39;s&nbsp;underlying&nbsp;driver.</span><br>
<span class="lineno">1040</span><span class="keyword" id="5806430">func</span>&nbsp;<span class="op" id="5806435">(</span><span class="ident" id="5806436">db</span>&nbsp;<span class="op" id="5806439">*</span><span class="ident" id="5806440">DB</span><span class="op" id="5806442">)</span>&nbsp;<span class="ident" id="5806444">Driver</span><span class="op" id="5806450">(</span><span class="op" id="5806451">)</span>&nbsp;<span class="ident" id="5806453">driver</span><span class="op" id="5806459">.</span><span class="ident" id="5806460">Driver</span>&nbsp;<span class="op" id="5806467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806470">return</span>&nbsp;<span class="ident" id="5806477">db</span><span class="op" id="5806479">.</span><span class="ident" id="5806480">driver</span><br>
<span class="lineno"></span><span class="op" id="5806487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5806490">//&nbsp;Tx&nbsp;is&nbsp;an&nbsp;in-progress&nbsp;database&nbsp;transaction.</span><br>
<span class="lineno">1045</span><span class="comment" id="5806536">//</span><br>
<span class="lineno"></span><span class="comment" id="5806539">//&nbsp;A&nbsp;transaction&nbsp;must&nbsp;end&nbsp;with&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback.</span><br>
<span class="lineno"></span><span class="comment" id="5806600">//</span><br>
<span class="lineno"></span><span class="comment" id="5806603">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;all&nbsp;operations&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5806664">//&nbsp;transaction&nbsp;fail&nbsp;with&nbsp;ErrTxDone.</span><br>
<span class="lineno">1050</span><span class="keyword" id="5806700">type</span>&nbsp;<span class="ident" id="5806705">Tx</span>&nbsp;<span class="keyword" id="5806708">struct</span>&nbsp;<span class="op" id="5806715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806718">db</span>&nbsp;<span class="op" id="5806721">*</span><span class="ident" id="5806722">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5806727">//&nbsp;dc&nbsp;is&nbsp;owned&nbsp;exclusively&nbsp;until&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;at&nbsp;which&nbsp;point</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5806796">//&nbsp;it&#39;s&nbsp;returned&nbsp;with&nbsp;putConn.</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806828">dc</span>&nbsp;&nbsp;<span class="op" id="5806832">*</span><span class="ident" id="5806833">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806845">txi</span>&nbsp;<span class="ident" id="5806849">driver</span><span class="op" id="5806855">.</span><span class="ident" id="5806856">Tx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5806861">//&nbsp;done&nbsp;transitions&nbsp;from&nbsp;false&nbsp;to&nbsp;true&nbsp;exactly&nbsp;once,&nbsp;on&nbsp;Commit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5806925">//&nbsp;or&nbsp;Rollback.&nbsp;once&nbsp;done,&nbsp;all&nbsp;operations&nbsp;fail&nbsp;with</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5806978">//&nbsp;ErrTxDone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806993">done</span>&nbsp;<span class="builtintype" id="5806998">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5807005">//&nbsp;All&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.&nbsp;&nbsp;These&nbsp;will&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5807082">//&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807133">stmts</span>&nbsp;<span class="keyword" id="5807139">struct</span>&nbsp;<span class="op" id="5807146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807150">sync</span><span class="op" id="5807154">.</span><span class="ident" id="5807155">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807163">v</span>&nbsp;<span class="op" id="5807165">[</span><span class="op" id="5807166">]</span><span class="op" id="5807167">*</span><span class="ident" id="5807168">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5807174">}</span><br>
<span class="lineno"></span><span class="op" id="5807176">}</span><br>
<span class="lineno">1070</span><br>
<span class="lineno"></span><span class="keyword" id="5807179">var</span>&nbsp;<span class="ident" id="5807183">ErrTxDone</span>&nbsp;<span class="op" id="5807193">=</span>&nbsp;<span class="ident" id="5807195">errors</span><span class="op" id="5807201">.</span><span class="ident" id="5807202">New</span><span class="op" id="5807205">(</span><span class="string" id="5807206">&#34;sql:&nbsp;Transaction&nbsp;has&nbsp;already&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back&#34;</span><span class="op" id="5807266">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5807269">func</span>&nbsp;<span class="op" id="5807274">(</span><span class="ident" id="5807275">tx</span>&nbsp;<span class="op" id="5807278">*</span><span class="ident" id="5807279">Tx</span><span class="op" id="5807281">)</span>&nbsp;<span class="builtinfunc" id="5807283">close</span><span class="op" id="5807288">(</span><span class="op" id="5807289">)</span>&nbsp;<span class="op" id="5807291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807294">if</span>&nbsp;<span class="ident" id="5807297">tx</span><span class="op" id="5807299">.</span><span class="ident" id="5807300">done</span>&nbsp;<span class="op" id="5807305">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5807309">panic</span><span class="op" id="5807314">(</span><span class="string" id="5807315">&#34;double&nbsp;close&#34;</span><span class="op" id="5807329">)</span>&nbsp;<span class="comment" id="5807331">//&nbsp;internal&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5807350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807353">tx</span><span class="op" id="5807355">.</span><span class="ident" id="5807356">done</span>&nbsp;<span class="op" id="5807361">=</span>&nbsp;<span class="builtintype" id="5807363">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807369">tx</span><span class="op" id="5807371">.</span><span class="ident" id="5807372">db</span><span class="op" id="5807374">.</span><span class="ident" id="5807375">putConn</span><span class="op" id="5807382">(</span><span class="ident" id="5807383">tx</span><span class="op" id="5807385">.</span><span class="ident" id="5807386">dc</span><span class="op" id="5807388">,</span>&nbsp;<span class="ident" id="5807390">nil</span><span class="op" id="5807393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807396">tx</span><span class="op" id="5807398">.</span><span class="ident" id="5807399">dc</span>&nbsp;<span class="op" id="5807402">=</span>&nbsp;<span class="ident" id="5807404">nil</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807409">tx</span><span class="op" id="5807411">.</span><span class="ident" id="5807412">txi</span>&nbsp;<span class="op" id="5807416">=</span>&nbsp;<span class="ident" id="5807418">nil</span><br>
<span class="lineno"></span><span class="op" id="5807422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5807425">func</span>&nbsp;<span class="op" id="5807430">(</span><span class="ident" id="5807431">tx</span>&nbsp;<span class="op" id="5807434">*</span><span class="ident" id="5807435">Tx</span><span class="op" id="5807437">)</span>&nbsp;<span class="ident" id="5807439">grabConn</span><span class="op" id="5807447">(</span><span class="op" id="5807448">)</span>&nbsp;<span class="op" id="5807450">(</span><span class="op" id="5807451">*</span><span class="ident" id="5807452">driverConn</span><span class="op" id="5807462">,</span>&nbsp;<span class="builtintype" id="5807464">error</span><span class="op" id="5807469">)</span>&nbsp;<span class="op" id="5807471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807474">if</span>&nbsp;<span class="ident" id="5807477">tx</span><span class="op" id="5807479">.</span><span class="ident" id="5807480">done</span>&nbsp;<span class="op" id="5807485">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807489">return</span>&nbsp;<span class="ident" id="5807496">nil</span><span class="op" id="5807499">,</span>&nbsp;<span class="ident" id="5807501">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5807512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807515">return</span>&nbsp;<span class="ident" id="5807522">tx</span><span class="op" id="5807524">.</span><span class="ident" id="5807525">dc</span><span class="op" id="5807527">,</span>&nbsp;<span class="ident" id="5807529">nil</span><br>
<span class="lineno"></span><span class="op" id="5807533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1090</span><span class="comment" id="5807536">//&nbsp;Closes&nbsp;all&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.</span><br>
<span class="lineno"></span><span class="keyword" id="5807587">func</span>&nbsp;<span class="op" id="5807592">(</span><span class="ident" id="5807593">tx</span>&nbsp;<span class="op" id="5807596">*</span><span class="ident" id="5807597">Tx</span><span class="op" id="5807599">)</span>&nbsp;<span class="ident" id="5807601">closePrepared</span><span class="op" id="5807614">(</span><span class="op" id="5807615">)</span>&nbsp;<span class="op" id="5807617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807620">tx</span><span class="op" id="5807622">.</span><span class="ident" id="5807623">stmts</span><span class="op" id="5807628">.</span><span class="ident" id="5807629">Lock</span><span class="op" id="5807633">(</span><span class="op" id="5807634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807637">for</span>&nbsp;<span class="ident" id="5807641">_</span><span class="op" id="5807642">,</span>&nbsp;<span class="ident" id="5807644">stmt</span>&nbsp;<span class="op" id="5807649">:=</span>&nbsp;<span class="keyword" id="5807652">range</span>&nbsp;<span class="ident" id="5807658">tx</span><span class="op" id="5807660">.</span><span class="ident" id="5807661">stmts</span><span class="op" id="5807666">.</span><span class="ident" id="5807667">v</span>&nbsp;<span class="op" id="5807669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807673">stmt</span><span class="op" id="5807677">.</span><span class="ident" id="5807678">Close</span><span class="op" id="5807683">(</span><span class="op" id="5807684">)</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5807687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807690">tx</span><span class="op" id="5807692">.</span><span class="ident" id="5807693">stmts</span><span class="op" id="5807698">.</span><span class="ident" id="5807699">Unlock</span><span class="op" id="5807705">(</span><span class="op" id="5807706">)</span><br>
<span class="lineno"></span><span class="op" id="5807708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5807711">//&nbsp;Commit&nbsp;commits&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1100</span><span class="keyword" id="5807746">func</span>&nbsp;<span class="op" id="5807751">(</span><span class="ident" id="5807752">tx</span>&nbsp;<span class="op" id="5807755">*</span><span class="ident" id="5807756">Tx</span><span class="op" id="5807758">)</span>&nbsp;<span class="ident" id="5807760">Commit</span><span class="op" id="5807766">(</span><span class="op" id="5807767">)</span>&nbsp;<span class="builtintype" id="5807769">error</span>&nbsp;<span class="op" id="5807775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807778">if</span>&nbsp;<span class="ident" id="5807781">tx</span><span class="op" id="5807783">.</span><span class="ident" id="5807784">done</span>&nbsp;<span class="op" id="5807789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807793">return</span>&nbsp;<span class="ident" id="5807800">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5807811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807814">defer</span>&nbsp;<span class="ident" id="5807820">tx</span><span class="op" id="5807822">.</span><span class="builtinfunc" id="5807823">close</span><span class="op" id="5807828">(</span><span class="op" id="5807829">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807832">tx</span><span class="op" id="5807834">.</span><span class="ident" id="5807835">dc</span><span class="op" id="5807837">.</span><span class="ident" id="5807838">Lock</span><span class="op" id="5807842">(</span><span class="op" id="5807843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807846">err</span>&nbsp;<span class="op" id="5807850">:=</span>&nbsp;<span class="ident" id="5807853">tx</span><span class="op" id="5807855">.</span><span class="ident" id="5807856">txi</span><span class="op" id="5807859">.</span><span class="ident" id="5807860">Commit</span><span class="op" id="5807866">(</span><span class="op" id="5807867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807870">tx</span><span class="op" id="5807872">.</span><span class="ident" id="5807873">dc</span><span class="op" id="5807875">.</span><span class="ident" id="5807876">Unlock</span><span class="op" id="5807882">(</span><span class="op" id="5807883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807886">if</span>&nbsp;<span class="ident" id="5807889">err</span>&nbsp;<span class="op" id="5807893">!=</span>&nbsp;<span class="ident" id="5807896">driver</span><span class="op" id="5807902">.</span><span class="ident" id="5807903">ErrBadConn</span>&nbsp;<span class="op" id="5807914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807918">tx</span><span class="op" id="5807920">.</span><span class="ident" id="5807921">closePrepared</span><span class="op" id="5807934">(</span><span class="op" id="5807935">)</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5807938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807941">return</span>&nbsp;<span class="ident" id="5807948">err</span><br>
<span class="lineno"></span><span class="op" id="5807952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5807955">//&nbsp;Rollback&nbsp;aborts&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1115</span><span class="keyword" id="5807991">func</span>&nbsp;<span class="op" id="5807996">(</span><span class="ident" id="5807997">tx</span>&nbsp;<span class="op" id="5808000">*</span><span class="ident" id="5808001">Tx</span><span class="op" id="5808003">)</span>&nbsp;<span class="ident" id="5808005">Rollback</span><span class="op" id="5808013">(</span><span class="op" id="5808014">)</span>&nbsp;<span class="builtintype" id="5808016">error</span>&nbsp;<span class="op" id="5808022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5808025">if</span>&nbsp;<span class="ident" id="5808028">tx</span><span class="op" id="5808030">.</span><span class="ident" id="5808031">done</span>&nbsp;<span class="op" id="5808036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5808040">return</span>&nbsp;<span class="ident" id="5808047">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5808058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5808061">defer</span>&nbsp;<span class="ident" id="5808067">tx</span><span class="op" id="5808069">.</span><span class="builtinfunc" id="5808070">close</span><span class="op" id="5808075">(</span><span class="op" id="5808076">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5808079">tx</span><span class="op" id="5808081">.</span><span class="ident" id="5808082">dc</span><span class="op" id="5808084">.</span><span class="ident" id="5808085">Lock</span><span class="op" id="5808089">(</span><span class="op" id="5808090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5808093">err</span>&nbsp;<span class="op" id="5808097">:=</span>&nbsp;<span class="ident" id="5808100">tx</span><span class="op" id="5808102">.</span><span class="ident" id="5808103">txi</span><span class="op" id="5808106">.</span><span class="ident" id="5808107">Rollback</span><span class="op" id="5808115">(</span><span class="op" id="5808116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5808119">tx</span><span class="op" id="5808121">.</span><span class="ident" id="5808122">dc</span><span class="op" id="5808124">.</span><span class="ident" id="5808125">Unlock</span><span class="op" id="5808131">(</span><span class="op" id="5808132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5808135">if</span>&nbsp;<span class="ident" id="5808138">err</span>&nbsp;<span class="op" id="5808142">!=</span>&nbsp;<span class="ident" id="5808145">driver</span><span class="op" id="5808151">.</span><span class="ident" id="5808152">ErrBadConn</span>&nbsp;<span class="op" id="5808163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5808167">tx</span><span class="op" id="5808169">.</span><span class="ident" id="5808170">closePrepared</span><span class="op" id="5808183">(</span><span class="op" id="5808184">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5808187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5808190">return</span>&nbsp;<span class="ident" id="5808197">err</span><br>
<span class="lineno"></span><span class="op" id="5808201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5808204">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;use&nbsp;within&nbsp;a&nbsp;transaction.</span><br>
<span class="lineno">1130</span><span class="comment" id="5808274">//</span><br>
<span class="lineno"></span><span class="comment" id="5808277">//&nbsp;The&nbsp;returned&nbsp;statement&nbsp;operates&nbsp;within&nbsp;the&nbsp;transaction&nbsp;and&nbsp;can&nbsp;no&nbsp;longer</span><br>
<span class="lineno"></span><span class="comment" id="5808353">//&nbsp;be&nbsp;used&nbsp;once&nbsp;the&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno"></span><span class="comment" id="5808420">//</span><br>
<span class="lineno"></span><span class="comment" id="5808423">//&nbsp;To&nbsp;use&nbsp;an&nbsp;existing&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;this&nbsp;transaction,&nbsp;see&nbsp;Tx.Stmt.</span><br>
<span class="lineno">1135</span><span class="keyword" id="5808498">func</span>&nbsp;<span class="op" id="5808503">(</span><span class="ident" id="5808504">tx</span>&nbsp;<span class="op" id="5808507">*</span><span class="ident" id="5808508">Tx</span><span class="op" id="5808510">)</span>&nbsp;<span class="ident" id="5808512">Prepare</span><span class="op" id="5808519">(</span><span class="ident" id="5808520">query</span>&nbsp;<span class="builtintype" id="5808526">string</span><span class="op" id="5808532">)</span>&nbsp;<span class="op" id="5808534">(</span><span class="op" id="5808535">*</span><span class="ident" id="5808536">Stmt</span><span class="op" id="5808540">,</span>&nbsp;<span class="builtintype" id="5808542">error</span><span class="op" id="5808547">)</span>&nbsp;<span class="op" id="5808549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808552">//&nbsp;TODO(bradfitz):&nbsp;We&nbsp;could&nbsp;be&nbsp;more&nbsp;efficient&nbsp;here&nbsp;and&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808615">//&nbsp;provide&nbsp;a&nbsp;method&nbsp;to&nbsp;take&nbsp;an&nbsp;existing&nbsp;Stmt&nbsp;(created&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808673">//&nbsp;perhaps&nbsp;a&nbsp;different&nbsp;Conn),&nbsp;and&nbsp;re-create&nbsp;it&nbsp;on&nbsp;this&nbsp;Conn&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808737">//&nbsp;necessary.&nbsp;Or,&nbsp;better:&nbsp;keep&nbsp;a&nbsp;map&nbsp;in&nbsp;DB&nbsp;of&nbsp;query&nbsp;string&nbsp;to</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808800">//&nbsp;Stmts,&nbsp;and&nbsp;have&nbsp;Stmt.Execute&nbsp;do&nbsp;the&nbsp;right&nbsp;thing&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808856">//&nbsp;re-prepare&nbsp;if&nbsp;the&nbsp;Conn&nbsp;in&nbsp;use&nbsp;doesn&#39;t&nbsp;have&nbsp;that&nbsp;prepared</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808917">//&nbsp;statement.&nbsp;&nbsp;But&nbsp;we&#39;ll&nbsp;want&nbsp;to&nbsp;avoid&nbsp;caching&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5808979">//&nbsp;in&nbsp;the&nbsp;case&nbsp;where&nbsp;we&nbsp;only&nbsp;call&nbsp;conn.Prepare&nbsp;implicitly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809038">//&nbsp;(such&nbsp;as&nbsp;in&nbsp;db.Exec&nbsp;or&nbsp;tx.Exec),&nbsp;but&nbsp;the&nbsp;caller&nbsp;package</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809098">//&nbsp;can&#39;t&nbsp;be&nbsp;holding&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809158">//&nbsp;Perhaps&nbsp;just&nbsp;looking&nbsp;at&nbsp;the&nbsp;reference&nbsp;count&nbsp;(by&nbsp;noting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809217">//&nbsp;Stmt.Close)&nbsp;would&nbsp;be&nbsp;enough.&nbsp;We&nbsp;might&nbsp;also&nbsp;want&nbsp;a&nbsp;finalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809281">//&nbsp;on&nbsp;Stmt&nbsp;to&nbsp;drop&nbsp;the&nbsp;reference&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809322">dc</span><span class="op" id="5809324">,</span>&nbsp;<span class="ident" id="5809326">err</span>&nbsp;<span class="op" id="5809330">:=</span>&nbsp;<span class="ident" id="5809333">tx</span><span class="op" id="5809335">.</span><span class="ident" id="5809336">grabConn</span><span class="op" id="5809344">(</span><span class="op" id="5809345">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809348">if</span>&nbsp;<span class="ident" id="5809351">err</span>&nbsp;<span class="op" id="5809355">!=</span>&nbsp;<span class="ident" id="5809358">nil</span>&nbsp;<span class="op" id="5809362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809366">return</span>&nbsp;<span class="ident" id="5809373">nil</span><span class="op" id="5809376">,</span>&nbsp;<span class="ident" id="5809378">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5809383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809387">dc</span><span class="op" id="5809389">.</span><span class="ident" id="5809390">Lock</span><span class="op" id="5809394">(</span><span class="op" id="5809395">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809398">si</span><span class="op" id="5809400">,</span>&nbsp;<span class="ident" id="5809402">err</span>&nbsp;<span class="op" id="5809406">:=</span>&nbsp;<span class="ident" id="5809409">dc</span><span class="op" id="5809411">.</span><span class="ident" id="5809412">ci</span><span class="op" id="5809414">.</span><span class="ident" id="5809415">Prepare</span><span class="op" id="5809422">(</span><span class="ident" id="5809423">query</span><span class="op" id="5809428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809431">dc</span><span class="op" id="5809433">.</span><span class="ident" id="5809434">Unlock</span><span class="op" id="5809440">(</span><span class="op" id="5809441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809444">if</span>&nbsp;<span class="ident" id="5809447">err</span>&nbsp;<span class="op" id="5809451">!=</span>&nbsp;<span class="ident" id="5809454">nil</span>&nbsp;<span class="op" id="5809458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809462">return</span>&nbsp;<span class="ident" id="5809469">nil</span><span class="op" id="5809472">,</span>&nbsp;<span class="ident" id="5809474">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5809479">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809483">stmt</span>&nbsp;<span class="op" id="5809488">:=</span>&nbsp;<span class="op" id="5809491">&amp;</span><span class="ident" id="5809492">Stmt</span><span class="op" id="5809496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809500">db</span><span class="op" id="5809502">:</span>&nbsp;<span class="ident" id="5809504">tx</span><span class="op" id="5809506">.</span><span class="ident" id="5809507">db</span><span class="op" id="5809509">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809513">tx</span><span class="op" id="5809515">:</span>&nbsp;<span class="ident" id="5809517">tx</span><span class="op" id="5809519">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809523">txsi</span><span class="op" id="5809527">:</span>&nbsp;<span class="op" id="5809529">&amp;</span><span class="ident" id="5809530">driverStmt</span><span class="op" id="5809540">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809545">Locker</span><span class="op" id="5809551">:</span>&nbsp;<span class="ident" id="5809553">dc</span><span class="op" id="5809555">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809560">si</span><span class="op" id="5809562">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809568">si</span><span class="op" id="5809570">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5809574">}</span><span class="op" id="5809575">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809579">query</span><span class="op" id="5809584">:</span>&nbsp;<span class="ident" id="5809586">query</span><span class="op" id="5809591">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5809594">}</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809597">tx</span><span class="op" id="5809599">.</span><span class="ident" id="5809600">stmts</span><span class="op" id="5809605">.</span><span class="ident" id="5809606">Lock</span><span class="op" id="5809610">(</span><span class="op" id="5809611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809614">tx</span><span class="op" id="5809616">.</span><span class="ident" id="5809617">stmts</span><span class="op" id="5809622">.</span><span class="ident" id="5809623">v</span>&nbsp;<span class="op" id="5809625">=</span>&nbsp;<span class="builtinfunc" id="5809627">append</span><span class="op" id="5809633">(</span><span class="ident" id="5809634">tx</span><span class="op" id="5809636">.</span><span class="ident" id="5809637">stmts</span><span class="op" id="5809642">.</span><span class="ident" id="5809643">v</span><span class="op" id="5809644">,</span>&nbsp;<span class="ident" id="5809646">stmt</span><span class="op" id="5809650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809653">tx</span><span class="op" id="5809655">.</span><span class="ident" id="5809656">stmts</span><span class="op" id="5809661">.</span><span class="ident" id="5809662">Unlock</span><span class="op" id="5809668">(</span><span class="op" id="5809669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809672">return</span>&nbsp;<span class="ident" id="5809679">stmt</span><span class="op" id="5809683">,</span>&nbsp;<span class="ident" id="5809685">nil</span><br>
<span class="lineno"></span><span class="op" id="5809689">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span><span class="comment" id="5809692">//&nbsp;Stmt&nbsp;returns&nbsp;a&nbsp;transaction-specific&nbsp;prepared&nbsp;statement&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="5809755">//&nbsp;an&nbsp;existing&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5809781">//</span><br>
<span class="lineno"></span><span class="comment" id="5809784">//&nbsp;Example:</span><br>
<span class="lineno">1180</span><span class="comment" id="5809796">//&nbsp;&nbsp;updateMoney,&nbsp;err&nbsp;:=&nbsp;db.Prepare(&#34;UPDATE&nbsp;balance&nbsp;SET&nbsp;money=money+?&nbsp;WHERE&nbsp;id=?&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="5809878">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5809886">//&nbsp;&nbsp;tx,&nbsp;err&nbsp;:=&nbsp;db.Begin()</span><br>
<span class="lineno"></span><span class="comment" id="5809912">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5809920">//&nbsp;&nbsp;res,&nbsp;err&nbsp;:=&nbsp;tx.Stmt(updateMoney).Exec(123.45,&nbsp;98293203)</span><br>
<span class="lineno">1185</span><span class="keyword" id="5809980">func</span>&nbsp;<span class="op" id="5809985">(</span><span class="ident" id="5809986">tx</span>&nbsp;<span class="op" id="5809989">*</span><span class="ident" id="5809990">Tx</span><span class="op" id="5809992">)</span>&nbsp;<span class="ident" id="5809994">Stmt</span><span class="op" id="5809998">(</span><span class="ident" id="5809999">stmt</span>&nbsp;<span class="op" id="5810004">*</span><span class="ident" id="5810005">Stmt</span><span class="op" id="5810009">)</span>&nbsp;<span class="op" id="5810011">*</span><span class="ident" id="5810012">Stmt</span>&nbsp;<span class="op" id="5810017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5810020">//&nbsp;TODO(bradfitz):&nbsp;optimize&nbsp;this.&nbsp;Currently&nbsp;this&nbsp;re-prepares</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5810082">//&nbsp;each&nbsp;time.&nbsp;&nbsp;This&nbsp;is&nbsp;fine&nbsp;for&nbsp;now&nbsp;to&nbsp;illustrate&nbsp;the&nbsp;API&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5810145">//&nbsp;we&nbsp;should&nbsp;really&nbsp;cache&nbsp;already-prepared&nbsp;statements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5810200">//&nbsp;per-Conn.&nbsp;See&nbsp;also&nbsp;the&nbsp;big&nbsp;comment&nbsp;in&nbsp;Tx.Prepare.</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810255">if</span>&nbsp;<span class="ident" id="5810258">tx</span><span class="op" id="5810260">.</span><span class="ident" id="5810261">db</span>&nbsp;<span class="op" id="5810264">!=</span>&nbsp;<span class="ident" id="5810267">stmt</span><span class="op" id="5810271">.</span><span class="ident" id="5810272">db</span>&nbsp;<span class="op" id="5810275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810279">return</span>&nbsp;<span class="op" id="5810286">&amp;</span><span class="ident" id="5810287">Stmt</span><span class="op" id="5810291">{</span><span class="ident" id="5810292">stickyErr</span><span class="op" id="5810301">:</span>&nbsp;<span class="ident" id="5810303">errors</span><span class="op" id="5810309">.</span><span class="ident" id="5810310">New</span><span class="op" id="5810313">(</span><span class="string" id="5810314">&#34;sql:&nbsp;Tx.Stmt:&nbsp;statement&nbsp;from&nbsp;different&nbsp;database&nbsp;used&#34;</span><span class="op" id="5810368">)</span><span class="op" id="5810369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5810372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810375">dc</span><span class="op" id="5810377">,</span>&nbsp;<span class="ident" id="5810379">err</span>&nbsp;<span class="op" id="5810383">:=</span>&nbsp;<span class="ident" id="5810386">tx</span><span class="op" id="5810388">.</span><span class="ident" id="5810389">grabConn</span><span class="op" id="5810397">(</span><span class="op" id="5810398">)</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810401">if</span>&nbsp;<span class="ident" id="5810404">err</span>&nbsp;<span class="op" id="5810408">!=</span>&nbsp;<span class="ident" id="5810411">nil</span>&nbsp;<span class="op" id="5810415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810419">return</span>&nbsp;<span class="op" id="5810426">&amp;</span><span class="ident" id="5810427">Stmt</span><span class="op" id="5810431">{</span><span class="ident" id="5810432">stickyErr</span><span class="op" id="5810441">:</span>&nbsp;<span class="ident" id="5810443">err</span><span class="op" id="5810446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5810449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810452">dc</span><span class="op" id="5810454">.</span><span class="ident" id="5810455">Lock</span><span class="op" id="5810459">(</span><span class="op" id="5810460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810463">si</span><span class="op" id="5810465">,</span>&nbsp;<span class="ident" id="5810467">err</span>&nbsp;<span class="op" id="5810471">:=</span>&nbsp;<span class="ident" id="5810474">dc</span><span class="op" id="5810476">.</span><span class="ident" id="5810477">ci</span><span class="op" id="5810479">.</span><span class="ident" id="5810480">Prepare</span><span class="op" id="5810487">(</span><span class="ident" id="5810488">stmt</span><span class="op" id="5810492">.</span><span class="ident" id="5810493">query</span><span class="op" id="5810498">)</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810501">dc</span><span class="op" id="5810503">.</span><span class="ident" id="5810504">Unlock</span><span class="op" id="5810510">(</span><span class="op" id="5810511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810514">txs</span>&nbsp;<span class="op" id="5810518">:=</span>&nbsp;<span class="op" id="5810521">&amp;</span><span class="ident" id="5810522">Stmt</span><span class="op" id="5810526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810530">db</span><span class="op" id="5810532">:</span>&nbsp;<span class="ident" id="5810534">tx</span><span class="op" id="5810536">.</span><span class="ident" id="5810537">db</span><span class="op" id="5810539">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810543">tx</span><span class="op" id="5810545">:</span>&nbsp;<span class="ident" id="5810547">tx</span><span class="op" id="5810549">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810553">txsi</span><span class="op" id="5810557">:</span>&nbsp;<span class="op" id="5810559">&amp;</span><span class="ident" id="5810560">driverStmt</span><span class="op" id="5810570">{</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810575">Locker</span><span class="op" id="5810581">:</span>&nbsp;<span class="ident" id="5810583">dc</span><span class="op" id="5810585">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810590">si</span><span class="op" id="5810592">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5810598">si</span><span class="op" id="5810600">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5810604">}</span><span class="op" id="5810605">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810609">query</span><span class="op" id="5810614">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5810620">stmt</span><span class="op" id="5810624">.</span><span class="ident" id="5810625">query</span><span class="op" id="5810630">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810634">stickyErr</span><span class="op" id="5810643">:</span>&nbsp;<span class="ident" id="5810645">err</span><span class="op" id="5810648">,</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5810651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810654">tx</span><span class="op" id="5810656">.</span><span class="ident" id="5810657">stmts</span><span class="op" id="5810662">.</span><span class="ident" id="5810663">Lock</span><span class="op" id="5810667">(</span><span class="op" id="5810668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810671">tx</span><span class="op" id="5810673">.</span><span class="ident" id="5810674">stmts</span><span class="op" id="5810679">.</span><span class="ident" id="5810680">v</span>&nbsp;<span class="op" id="5810682">=</span>&nbsp;<span class="builtinfunc" id="5810684">append</span><span class="op" id="5810690">(</span><span class="ident" id="5810691">tx</span><span class="op" id="5810693">.</span><span class="ident" id="5810694">stmts</span><span class="op" id="5810699">.</span><span class="ident" id="5810700">v</span><span class="op" id="5810701">,</span>&nbsp;<span class="ident" id="5810703">txs</span><span class="op" id="5810706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810709">tx</span><span class="op" id="5810711">.</span><span class="ident" id="5810712">stmts</span><span class="op" id="5810717">.</span><span class="ident" id="5810718">Unlock</span><span class="op" id="5810724">(</span><span class="op" id="5810725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810728">return</span>&nbsp;<span class="ident" id="5810735">txs</span><br>
<span class="lineno">1215</span><span class="op" id="5810739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5810742">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;doesn&#39;t&nbsp;return&nbsp;rows.</span><br>
<span class="lineno"></span><span class="comment" id="5810793">//&nbsp;For&nbsp;example:&nbsp;an&nbsp;INSERT&nbsp;and&nbsp;UPDATE.</span><br>
<span class="lineno"></span><span class="keyword" id="5810831">func</span>&nbsp;<span class="op" id="5810836">(</span><span class="ident" id="5810837">tx</span>&nbsp;<span class="op" id="5810840">*</span><span class="ident" id="5810841">Tx</span><span class="op" id="5810843">)</span>&nbsp;<span class="ident" id="5810845">Exec</span><span class="op" id="5810849">(</span><span class="ident" id="5810850">query</span>&nbsp;<span class="builtintype" id="5810856">string</span><span class="op" id="5810862">,</span>&nbsp;<span class="ident" id="5810864">args</span>&nbsp;<span class="op" id="5810869">...</span><span class="keyword" id="5810872">interface</span><span class="op" id="5810881">{</span><span class="op" id="5810882">}</span><span class="op" id="5810883">)</span>&nbsp;<span class="op" id="5810885">(</span><span class="ident" id="5810886">Result</span><span class="op" id="5810892">,</span>&nbsp;<span class="builtintype" id="5810894">error</span><span class="op" id="5810899">)</span>&nbsp;<span class="op" id="5810901">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810904">dc</span><span class="op" id="5810906">,</span>&nbsp;<span class="ident" id="5810908">err</span>&nbsp;<span class="op" id="5810912">:=</span>&nbsp;<span class="ident" id="5810915">tx</span><span class="op" id="5810917">.</span><span class="ident" id="5810918">grabConn</span><span class="op" id="5810926">(</span><span class="op" id="5810927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810930">if</span>&nbsp;<span class="ident" id="5810933">err</span>&nbsp;<span class="op" id="5810937">!=</span>&nbsp;<span class="ident" id="5810940">nil</span>&nbsp;<span class="op" id="5810944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810948">return</span>&nbsp;<span class="ident" id="5810955">nil</span><span class="op" id="5810958">,</span>&nbsp;<span class="ident" id="5810960">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5810965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810969">if</span>&nbsp;<span class="ident" id="5810972">execer</span><span class="op" id="5810978">,</span>&nbsp;<span class="ident" id="5810980">ok</span>&nbsp;<span class="op" id="5810983">:=</span>&nbsp;<span class="ident" id="5810986">dc</span><span class="op" id="5810988">.</span><span class="ident" id="5810989">ci</span><span class="op" id="5810991">.</span><span class="op" id="5810992">(</span><span class="ident" id="5810993">driver</span><span class="op" id="5810999">.</span><span class="ident" id="5811000">Execer</span><span class="op" id="5811006">)</span><span class="op" id="5811007">;</span>&nbsp;<span class="ident" id="5811009">ok</span>&nbsp;<span class="op" id="5811012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811016">dargs</span><span class="op" id="5811021">,</span>&nbsp;<span class="ident" id="5811023">err</span>&nbsp;<span class="op" id="5811027">:=</span>&nbsp;<span class="ident" id="5811030">driverArgs</span><span class="op" id="5811040">(</span><span class="ident" id="5811041">nil</span><span class="op" id="5811044">,</span>&nbsp;<span class="ident" id="5811046">args</span><span class="op" id="5811050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811054">if</span>&nbsp;<span class="ident" id="5811057">err</span>&nbsp;<span class="op" id="5811061">!=</span>&nbsp;<span class="ident" id="5811064">nil</span>&nbsp;<span class="op" id="5811068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811073">return</span>&nbsp;<span class="ident" id="5811080">nil</span><span class="op" id="5811083">,</span>&nbsp;<span class="ident" id="5811085">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811091">}</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811095">dc</span><span class="op" id="5811097">.</span><span class="ident" id="5811098">Lock</span><span class="op" id="5811102">(</span><span class="op" id="5811103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811107">resi</span><span class="op" id="5811111">,</span>&nbsp;<span class="ident" id="5811113">err</span>&nbsp;<span class="op" id="5811117">:=</span>&nbsp;<span class="ident" id="5811120">execer</span><span class="op" id="5811126">.</span><span class="ident" id="5811127">Exec</span><span class="op" id="5811131">(</span><span class="ident" id="5811132">query</span><span class="op" id="5811137">,</span>&nbsp;<span class="ident" id="5811139">dargs</span><span class="op" id="5811144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811148">dc</span><span class="op" id="5811150">.</span><span class="ident" id="5811151">Unlock</span><span class="op" id="5811157">(</span><span class="op" id="5811158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811162">if</span>&nbsp;<span class="ident" id="5811165">err</span>&nbsp;<span class="op" id="5811169">==</span>&nbsp;<span class="ident" id="5811172">nil</span>&nbsp;<span class="op" id="5811176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811181">return</span>&nbsp;<span class="ident" id="5811188">driverResult</span><span class="op" id="5811200">{</span><span class="ident" id="5811201">dc</span><span class="op" id="5811203">,</span>&nbsp;<span class="ident" id="5811205">resi</span><span class="op" id="5811209">}</span><span class="op" id="5811210">,</span>&nbsp;<span class="ident" id="5811212">nil</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811222">if</span>&nbsp;<span class="ident" id="5811225">err</span>&nbsp;<span class="op" id="5811229">!=</span>&nbsp;<span class="ident" id="5811232">driver</span><span class="op" id="5811238">.</span><span class="ident" id="5811239">ErrSkip</span>&nbsp;<span class="op" id="5811247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811252">return</span>&nbsp;<span class="ident" id="5811259">nil</span><span class="op" id="5811262">,</span>&nbsp;<span class="ident" id="5811264">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811273">}</span><br>
<span class="lineno">1240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811277">dc</span><span class="op" id="5811279">.</span><span class="ident" id="5811280">Lock</span><span class="op" id="5811284">(</span><span class="op" id="5811285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811288">si</span><span class="op" id="5811290">,</span>&nbsp;<span class="ident" id="5811292">err</span>&nbsp;<span class="op" id="5811296">:=</span>&nbsp;<span class="ident" id="5811299">dc</span><span class="op" id="5811301">.</span><span class="ident" id="5811302">ci</span><span class="op" id="5811304">.</span><span class="ident" id="5811305">Prepare</span><span class="op" id="5811312">(</span><span class="ident" id="5811313">query</span><span class="op" id="5811318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811321">dc</span><span class="op" id="5811323">.</span><span class="ident" id="5811324">Unlock</span><span class="op" id="5811330">(</span><span class="op" id="5811331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811334">if</span>&nbsp;<span class="ident" id="5811337">err</span>&nbsp;<span class="op" id="5811341">!=</span>&nbsp;<span class="ident" id="5811344">nil</span>&nbsp;<span class="op" id="5811348">{</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811352">return</span>&nbsp;<span class="ident" id="5811359">nil</span><span class="op" id="5811362">,</span>&nbsp;<span class="ident" id="5811364">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811372">defer</span>&nbsp;<span class="ident" id="5811378">withLock</span><span class="op" id="5811386">(</span><span class="ident" id="5811387">dc</span><span class="op" id="5811389">,</span>&nbsp;<span class="keyword" id="5811391">func</span><span class="op" id="5811395">(</span><span class="op" id="5811396">)</span>&nbsp;<span class="op" id="5811398">{</span>&nbsp;<span class="ident" id="5811400">si</span><span class="op" id="5811402">.</span><span class="ident" id="5811403">Close</span><span class="op" id="5811408">(</span><span class="op" id="5811409">)</span>&nbsp;<span class="op" id="5811411">}</span><span class="op" id="5811412">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811416">return</span>&nbsp;<span class="ident" id="5811423">resultFromStatement</span><span class="op" id="5811442">(</span><span class="ident" id="5811443">driverStmt</span><span class="op" id="5811453">{</span><span class="ident" id="5811454">dc</span><span class="op" id="5811456">,</span>&nbsp;<span class="ident" id="5811458">si</span><span class="op" id="5811460">}</span><span class="op" id="5811461">,</span>&nbsp;<span class="ident" id="5811463">args</span><span class="op" id="5811467">...</span><span class="op" id="5811470">)</span><br>
<span class="lineno">1250</span><span class="op" id="5811472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5811475">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="keyword" id="5811540">func</span>&nbsp;<span class="op" id="5811545">(</span><span class="ident" id="5811546">tx</span>&nbsp;<span class="op" id="5811549">*</span><span class="ident" id="5811550">Tx</span><span class="op" id="5811552">)</span>&nbsp;<span class="ident" id="5811554">Query</span><span class="op" id="5811559">(</span><span class="ident" id="5811560">query</span>&nbsp;<span class="builtintype" id="5811566">string</span><span class="op" id="5811572">,</span>&nbsp;<span class="ident" id="5811574">args</span>&nbsp;<span class="op" id="5811579">...</span><span class="keyword" id="5811582">interface</span><span class="op" id="5811591">{</span><span class="op" id="5811592">}</span><span class="op" id="5811593">)</span>&nbsp;<span class="op" id="5811595">(</span><span class="op" id="5811596">*</span><span class="ident" id="5811597">Rows</span><span class="op" id="5811601">,</span>&nbsp;<span class="builtintype" id="5811603">error</span><span class="op" id="5811608">)</span>&nbsp;<span class="op" id="5811610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811613">dc</span><span class="op" id="5811615">,</span>&nbsp;<span class="ident" id="5811617">err</span>&nbsp;<span class="op" id="5811621">:=</span>&nbsp;<span class="ident" id="5811624">tx</span><span class="op" id="5811626">.</span><span class="ident" id="5811627">grabConn</span><span class="op" id="5811635">(</span><span class="op" id="5811636">)</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811639">if</span>&nbsp;<span class="ident" id="5811642">err</span>&nbsp;<span class="op" id="5811646">!=</span>&nbsp;<span class="ident" id="5811649">nil</span>&nbsp;<span class="op" id="5811653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811657">return</span>&nbsp;<span class="ident" id="5811664">nil</span><span class="op" id="5811667">,</span>&nbsp;<span class="ident" id="5811669">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811677">releaseConn</span>&nbsp;<span class="op" id="5811689">:=</span>&nbsp;<span class="keyword" id="5811692">func</span><span class="op" id="5811696">(</span><span class="builtintype" id="5811697">error</span><span class="op" id="5811702">)</span>&nbsp;<span class="op" id="5811704">{</span><span class="op" id="5811705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811708">return</span>&nbsp;<span class="ident" id="5811715">tx</span><span class="op" id="5811717">.</span><span class="ident" id="5811718">db</span><span class="op" id="5811720">.</span><span class="ident" id="5811721">queryConn</span><span class="op" id="5811730">(</span><span class="ident" id="5811731">dc</span><span class="op" id="5811733">,</span>&nbsp;<span class="ident" id="5811735">releaseConn</span><span class="op" id="5811746">,</span>&nbsp;<span class="ident" id="5811748">query</span><span class="op" id="5811753">,</span>&nbsp;<span class="ident" id="5811755">args</span><span class="op" id="5811759">)</span><br>
<span class="lineno">1260</span><span class="op" id="5811761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5811764">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="5811837">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="5811906">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno">1265</span><span class="keyword" id="5811938">func</span>&nbsp;<span class="op" id="5811943">(</span><span class="ident" id="5811944">tx</span>&nbsp;<span class="op" id="5811947">*</span><span class="ident" id="5811948">Tx</span><span class="op" id="5811950">)</span>&nbsp;<span class="ident" id="5811952">QueryRow</span><span class="op" id="5811960">(</span><span class="ident" id="5811961">query</span>&nbsp;<span class="builtintype" id="5811967">string</span><span class="op" id="5811973">,</span>&nbsp;<span class="ident" id="5811975">args</span>&nbsp;<span class="op" id="5811980">...</span><span class="keyword" id="5811983">interface</span><span class="op" id="5811992">{</span><span class="op" id="5811993">}</span><span class="op" id="5811994">)</span>&nbsp;<span class="op" id="5811996">*</span><span class="ident" id="5811997">Row</span>&nbsp;<span class="op" id="5812001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812004">rows</span><span class="op" id="5812008">,</span>&nbsp;<span class="ident" id="5812010">err</span>&nbsp;<span class="op" id="5812014">:=</span>&nbsp;<span class="ident" id="5812017">tx</span><span class="op" id="5812019">.</span><span class="ident" id="5812020">Query</span><span class="op" id="5812025">(</span><span class="ident" id="5812026">query</span><span class="op" id="5812031">,</span>&nbsp;<span class="ident" id="5812033">args</span><span class="op" id="5812037">...</span><span class="op" id="5812040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5812043">return</span>&nbsp;<span class="op" id="5812050">&amp;</span><span class="ident" id="5812051">Row</span><span class="op" id="5812054">{</span><span class="ident" id="5812055">rows</span><span class="op" id="5812059">:</span>&nbsp;<span class="ident" id="5812061">rows</span><span class="op" id="5812065">,</span>&nbsp;<span class="ident" id="5812067">err</span><span class="op" id="5812070">:</span>&nbsp;<span class="ident" id="5812072">err</span><span class="op" id="5812075">}</span><br>
<span class="lineno"></span><span class="op" id="5812077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="5812080">//&nbsp;connStmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;a&nbsp;particular&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5812144">type</span>&nbsp;<span class="ident" id="5812149">connStmt</span>&nbsp;<span class="keyword" id="5812158">struct</span>&nbsp;<span class="op" id="5812165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812168">dc</span>&nbsp;<span class="op" id="5812171">*</span><span class="ident" id="5812172">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812184">si</span>&nbsp;<span class="ident" id="5812187">driver</span><span class="op" id="5812193">.</span><span class="ident" id="5812194">Stmt</span><br>
<span class="lineno"></span><span class="op" id="5812199">}</span><br>
<span class="lineno">1275</span><br>
<span class="lineno"></span><span class="comment" id="5812202">//&nbsp;Stmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement.&nbsp;Stmt&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5812291">type</span>&nbsp;<span class="ident" id="5812296">Stmt</span>&nbsp;<span class="keyword" id="5812301">struct</span>&nbsp;<span class="op" id="5812308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5812311">//&nbsp;Immutable:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812326">db</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5812336">*</span><span class="ident" id="5812337">DB</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5812343">//&nbsp;where&nbsp;we&nbsp;came&nbsp;from</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812366">query</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5812376">string</span>&nbsp;<span class="comment" id="5812383">//&nbsp;that&nbsp;created&nbsp;the&nbsp;Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812409">stickyErr</span>&nbsp;<span class="builtintype" id="5812419">error</span>&nbsp;&nbsp;<span class="comment" id="5812426">//&nbsp;if&nbsp;non-nil,&nbsp;this&nbsp;error&nbsp;is&nbsp;returned&nbsp;for&nbsp;all&nbsp;operations</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812485">closemu</span>&nbsp;<span class="ident" id="5812493">sync</span><span class="op" id="5812497">.</span><span class="ident" id="5812498">RWMutex</span>&nbsp;<span class="comment" id="5812506">//&nbsp;held&nbsp;exclusively&nbsp;during&nbsp;close,&nbsp;for&nbsp;read&nbsp;otherwise.</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5812562">//&nbsp;If&nbsp;in&nbsp;a&nbsp;transaction,&nbsp;else&nbsp;both&nbsp;nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812602">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5812607">*</span><span class="ident" id="5812608">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812612">txsi</span>&nbsp;<span class="op" id="5812617">*</span><span class="ident" id="5812618">driverStmt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812631">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5812638">sync</span><span class="op" id="5812642">.</span><span class="ident" id="5812643">Mutex</span>&nbsp;<span class="comment" id="5812649">//&nbsp;protects&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;fields</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812685">closed</span>&nbsp;<span class="builtintype" id="5812692">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5812699">//&nbsp;css&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;underlying&nbsp;driver&nbsp;statement&nbsp;interfaces</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5812759">//&nbsp;that&nbsp;are&nbsp;valid&nbsp;on&nbsp;particular&nbsp;connections.&nbsp;&nbsp;This&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5812819">//&nbsp;used&nbsp;if&nbsp;tx&nbsp;==&nbsp;nil&nbsp;and&nbsp;one&nbsp;is&nbsp;found&nbsp;that&nbsp;has&nbsp;idle</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5812872">//&nbsp;connections.&nbsp;&nbsp;If&nbsp;tx&nbsp;!=&nbsp;nil,&nbsp;txsi&nbsp;is&nbsp;always&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812925">css</span>&nbsp;<span class="op" id="5812929">[</span><span class="op" id="5812930">]</span><span class="ident" id="5812931">connStmt</span><br>
<span class="lineno"></span><span class="op" id="5812940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5812943">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments&nbsp;and</span><br>
<span class="lineno">1300</span><span class="comment" id="5813010">//&nbsp;returns&nbsp;a&nbsp;Result&nbsp;summarizing&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5813071">func</span>&nbsp;<span class="op" id="5813076">(</span><span class="ident" id="5813077">s</span>&nbsp;<span class="op" id="5813079">*</span><span class="ident" id="5813080">Stmt</span><span class="op" id="5813084">)</span>&nbsp;<span class="ident" id="5813086">Exec</span><span class="op" id="5813090">(</span><span class="ident" id="5813091">args</span>&nbsp;<span class="op" id="5813096">...</span><span class="keyword" id="5813099">interface</span><span class="op" id="5813108">{</span><span class="op" id="5813109">}</span><span class="op" id="5813110">)</span>&nbsp;<span class="op" id="5813112">(</span><span class="ident" id="5813113">Result</span><span class="op" id="5813119">,</span>&nbsp;<span class="builtintype" id="5813121">error</span><span class="op" id="5813126">)</span>&nbsp;<span class="op" id="5813128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813131">s</span><span class="op" id="5813132">.</span><span class="ident" id="5813133">closemu</span><span class="op" id="5813140">.</span><span class="ident" id="5813141">RLock</span><span class="op" id="5813146">(</span><span class="op" id="5813147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813150">defer</span>&nbsp;<span class="ident" id="5813156">s</span><span class="op" id="5813157">.</span><span class="ident" id="5813158">closemu</span><span class="op" id="5813165">.</span><span class="ident" id="5813166">RUnlock</span><span class="op" id="5813173">(</span><span class="op" id="5813174">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813178">var</span>&nbsp;<span class="ident" id="5813182">res</span>&nbsp;<span class="ident" id="5813186">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813194">for</span>&nbsp;<span class="ident" id="5813198">i</span>&nbsp;<span class="op" id="5813200">:=</span>&nbsp;<span class="num" id="5813203">0</span><span class="op" id="5813204">;</span>&nbsp;<span class="ident" id="5813206">i</span>&nbsp;<span class="op" id="5813208">&lt;</span>&nbsp;<span class="ident" id="5813210">maxBadConnRetries</span><span class="op" id="5813227">;</span>&nbsp;<span class="ident" id="5813229">i</span><span class="op" id="5813230">++</span>&nbsp;<span class="op" id="5813233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813237">dc</span><span class="op" id="5813239">,</span>&nbsp;<span class="ident" id="5813241">releaseConn</span><span class="op" id="5813252">,</span>&nbsp;<span class="ident" id="5813254">si</span><span class="op" id="5813256">,</span>&nbsp;<span class="ident" id="5813258">err</span>&nbsp;<span class="op" id="5813262">:=</span>&nbsp;<span class="ident" id="5813265">s</span><span class="op" id="5813266">.</span><span class="ident" id="5813267">connStmt</span><span class="op" id="5813275">(</span><span class="op" id="5813276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813280">if</span>&nbsp;<span class="ident" id="5813283">err</span>&nbsp;<span class="op" id="5813287">!=</span>&nbsp;<span class="ident" id="5813290">nil</span>&nbsp;<span class="op" id="5813294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813299">if</span>&nbsp;<span class="ident" id="5813302">err</span>&nbsp;<span class="op" id="5813306">==</span>&nbsp;<span class="ident" id="5813309">driver</span><span class="op" id="5813315">.</span><span class="ident" id="5813316">ErrBadConn</span>&nbsp;<span class="op" id="5813327">{</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813333">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5813345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813350">return</span>&nbsp;<span class="ident" id="5813357">nil</span><span class="op" id="5813360">,</span>&nbsp;<span class="ident" id="5813362">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5813368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813373">res</span><span class="op" id="5813376">,</span>&nbsp;<span class="ident" id="5813378">err</span>&nbsp;<span class="op" id="5813382">=</span>&nbsp;<span class="ident" id="5813384">resultFromStatement</span><span class="op" id="5813403">(</span><span class="ident" id="5813404">driverStmt</span><span class="op" id="5813414">{</span><span class="ident" id="5813415">dc</span><span class="op" id="5813417">,</span>&nbsp;<span class="ident" id="5813419">si</span><span class="op" id="5813421">}</span><span class="op" id="5813422">,</span>&nbsp;<span class="ident" id="5813424">args</span><span class="op" id="5813428">...</span><span class="op" id="5813431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813435">releaseConn</span><span class="op" id="5813446">(</span><span class="ident" id="5813447">err</span><span class="op" id="5813450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813454">if</span>&nbsp;<span class="ident" id="5813457">err</span>&nbsp;<span class="op" id="5813461">!=</span>&nbsp;<span class="ident" id="5813464">driver</span><span class="op" id="5813470">.</span><span class="ident" id="5813471">ErrBadConn</span>&nbsp;<span class="op" id="5813482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813487">return</span>&nbsp;<span class="ident" id="5813494">res</span><span class="op" id="5813497">,</span>&nbsp;<span class="ident" id="5813499">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5813505">}</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5813508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813511">return</span>&nbsp;<span class="ident" id="5813518">nil</span><span class="op" id="5813521">,</span>&nbsp;<span class="ident" id="5813523">driver</span><span class="op" id="5813529">.</span><span class="ident" id="5813530">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="5813541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5813544">func</span>&nbsp;<span class="ident" id="5813549">resultFromStatement</span><span class="op" id="5813568">(</span><span class="ident" id="5813569">ds</span>&nbsp;<span class="ident" id="5813572">driverStmt</span><span class="op" id="5813582">,</span>&nbsp;<span class="ident" id="5813584">args</span>&nbsp;<span class="op" id="5813589">...</span><span class="keyword" id="5813592">interface</span><span class="op" id="5813601">{</span><span class="op" id="5813602">}</span><span class="op" id="5813603">)</span>&nbsp;<span class="op" id="5813605">(</span><span class="ident" id="5813606">Result</span><span class="op" id="5813612">,</span>&nbsp;<span class="builtintype" id="5813614">error</span><span class="op" id="5813619">)</span>&nbsp;<span class="op" id="5813621">{</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813624">ds</span><span class="op" id="5813626">.</span><span class="ident" id="5813627">Lock</span><span class="op" id="5813631">(</span><span class="op" id="5813632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813635">want</span>&nbsp;<span class="op" id="5813640">:=</span>&nbsp;<span class="ident" id="5813643">ds</span><span class="op" id="5813645">.</span><span class="ident" id="5813646">si</span><span class="op" id="5813648">.</span><span class="ident" id="5813649">NumInput</span><span class="op" id="5813657">(</span><span class="op" id="5813658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813661">ds</span><span class="op" id="5813663">.</span><span class="ident" id="5813664">Unlock</span><span class="op" id="5813670">(</span><span class="op" id="5813671">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5813675">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5813739">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5813813">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813842">if</span>&nbsp;<span class="ident" id="5813845">want</span>&nbsp;<span class="op" id="5813850">!=</span>&nbsp;<span class="op" id="5813853">-</span><span class="num" id="5813854">1</span>&nbsp;<span class="op" id="5813856">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5813859">len</span><span class="op" id="5813862">(</span><span class="ident" id="5813863">args</span><span class="op" id="5813867">)</span>&nbsp;<span class="op" id="5813869">!=</span>&nbsp;<span class="ident" id="5813872">want</span>&nbsp;<span class="op" id="5813877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813881">return</span>&nbsp;<span class="ident" id="5813888">nil</span><span class="op" id="5813891">,</span>&nbsp;<span class="ident" id="5813893">fmt</span><span class="op" id="5813896">.</span><span class="ident" id="5813897">Errorf</span><span class="op" id="5813903">(</span><span class="string" id="5813904">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;arguments,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="5813940">,</span>&nbsp;<span class="ident" id="5813942">want</span><span class="op" id="5813946">,</span>&nbsp;<span class="builtinfunc" id="5813948">len</span><span class="op" id="5813951">(</span><span class="ident" id="5813952">args</span><span class="op" id="5813956">)</span><span class="op" id="5813957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5813960">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813964">dargs</span><span class="op" id="5813969">,</span>&nbsp;<span class="ident" id="5813971">err</span>&nbsp;<span class="op" id="5813975">:=</span>&nbsp;<span class="ident" id="5813978">driverArgs</span><span class="op" id="5813988">(</span><span class="op" id="5813989">&amp;</span><span class="ident" id="5813990">ds</span><span class="op" id="5813992">,</span>&nbsp;<span class="ident" id="5813994">args</span><span class="op" id="5813998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814001">if</span>&nbsp;<span class="ident" id="5814004">err</span>&nbsp;<span class="op" id="5814008">!=</span>&nbsp;<span class="ident" id="5814011">nil</span>&nbsp;<span class="op" id="5814015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814019">return</span>&nbsp;<span class="ident" id="5814026">nil</span><span class="op" id="5814029">,</span>&nbsp;<span class="ident" id="5814031">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5814036">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814040">ds</span><span class="op" id="5814042">.</span><span class="ident" id="5814043">Lock</span><span class="op" id="5814047">(</span><span class="op" id="5814048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814051">resi</span><span class="op" id="5814055">,</span>&nbsp;<span class="ident" id="5814057">err</span>&nbsp;<span class="op" id="5814061">:=</span>&nbsp;<span class="ident" id="5814064">ds</span><span class="op" id="5814066">.</span><span class="ident" id="5814067">si</span><span class="op" id="5814069">.</span><span class="ident" id="5814070">Exec</span><span class="op" id="5814074">(</span><span class="ident" id="5814075">dargs</span><span class="op" id="5814080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814083">ds</span><span class="op" id="5814085">.</span><span class="ident" id="5814086">Unlock</span><span class="op" id="5814092">(</span><span class="op" id="5814093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814096">if</span>&nbsp;<span class="ident" id="5814099">err</span>&nbsp;<span class="op" id="5814103">!=</span>&nbsp;<span class="ident" id="5814106">nil</span>&nbsp;<span class="op" id="5814110">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814114">return</span>&nbsp;<span class="ident" id="5814121">nil</span><span class="op" id="5814124">,</span>&nbsp;<span class="ident" id="5814126">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5814131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814134">return</span>&nbsp;<span class="ident" id="5814141">driverResult</span><span class="op" id="5814153">{</span><span class="ident" id="5814154">ds</span><span class="op" id="5814156">.</span><span class="ident" id="5814157">Locker</span><span class="op" id="5814163">,</span>&nbsp;<span class="ident" id="5814165">resi</span><span class="op" id="5814169">}</span><span class="op" id="5814170">,</span>&nbsp;<span class="ident" id="5814172">nil</span><br>
<span class="lineno"></span><span class="op" id="5814176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1350</span><span class="comment" id="5814179">//&nbsp;connStmt&nbsp;returns&nbsp;a&nbsp;free&nbsp;driver&nbsp;connection&nbsp;on&nbsp;which&nbsp;to&nbsp;execute&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5814248">//&nbsp;statement,&nbsp;a&nbsp;function&nbsp;to&nbsp;call&nbsp;to&nbsp;release&nbsp;the&nbsp;connection,&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5814314">//&nbsp;statement&nbsp;bound&nbsp;to&nbsp;that&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5814353">func</span>&nbsp;<span class="op" id="5814358">(</span><span class="ident" id="5814359">s</span>&nbsp;<span class="op" id="5814361">*</span><span class="ident" id="5814362">Stmt</span><span class="op" id="5814366">)</span>&nbsp;<span class="ident" id="5814368">connStmt</span><span class="op" id="5814376">(</span><span class="op" id="5814377">)</span>&nbsp;<span class="op" id="5814379">(</span><span class="ident" id="5814380">ci</span>&nbsp;<span class="op" id="5814383">*</span><span class="ident" id="5814384">driverConn</span><span class="op" id="5814394">,</span>&nbsp;<span class="ident" id="5814396">releaseConn</span>&nbsp;<span class="keyword" id="5814408">func</span><span class="op" id="5814412">(</span><span class="builtintype" id="5814413">error</span><span class="op" id="5814418">)</span><span class="op" id="5814419">,</span>&nbsp;<span class="ident" id="5814421">si</span>&nbsp;<span class="ident" id="5814424">driver</span><span class="op" id="5814430">.</span><span class="ident" id="5814431">Stmt</span><span class="op" id="5814435">,</span>&nbsp;<span class="ident" id="5814437">err</span>&nbsp;<span class="builtintype" id="5814441">error</span><span class="op" id="5814446">)</span>&nbsp;<span class="op" id="5814448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814451">if</span>&nbsp;<span class="ident" id="5814454">err</span>&nbsp;<span class="op" id="5814458">=</span>&nbsp;<span class="ident" id="5814460">s</span><span class="op" id="5814461">.</span><span class="ident" id="5814462">stickyErr</span><span class="op" id="5814471">;</span>&nbsp;<span class="ident" id="5814473">err</span>&nbsp;<span class="op" id="5814477">!=</span>&nbsp;<span class="ident" id="5814480">nil</span>&nbsp;<span class="op" id="5814484">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814488">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5814496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814499">s</span><span class="op" id="5814500">.</span><span class="ident" id="5814501">mu</span><span class="op" id="5814503">.</span><span class="ident" id="5814504">Lock</span><span class="op" id="5814508">(</span><span class="op" id="5814509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814512">if</span>&nbsp;<span class="ident" id="5814515">s</span><span class="op" id="5814516">.</span><span class="ident" id="5814517">closed</span>&nbsp;<span class="op" id="5814524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814528">s</span><span class="op" id="5814529">.</span><span class="ident" id="5814530">mu</span><span class="op" id="5814532">.</span><span class="ident" id="5814533">Unlock</span><span class="op" id="5814539">(</span><span class="op" id="5814540">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814544">err</span>&nbsp;<span class="op" id="5814548">=</span>&nbsp;<span class="ident" id="5814550">errors</span><span class="op" id="5814556">.</span><span class="ident" id="5814557">New</span><span class="op" id="5814560">(</span><span class="string" id="5814561">&#34;sql:&nbsp;statement&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5814587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814591">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5814599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5814603">//&nbsp;In&nbsp;a&nbsp;transaction,&nbsp;we&nbsp;always&nbsp;use&nbsp;the&nbsp;connection&nbsp;that&nbsp;the</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5814663">//&nbsp;transaction&nbsp;was&nbsp;created&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814695">if</span>&nbsp;<span class="ident" id="5814698">s</span><span class="op" id="5814699">.</span><span class="ident" id="5814700">tx</span>&nbsp;<span class="op" id="5814703">!=</span>&nbsp;<span class="ident" id="5814706">nil</span>&nbsp;<span class="op" id="5814710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814714">s</span><span class="op" id="5814715">.</span><span class="ident" id="5814716">mu</span><span class="op" id="5814718">.</span><span class="ident" id="5814719">Unlock</span><span class="op" id="5814725">(</span><span class="op" id="5814726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814730">ci</span><span class="op" id="5814732">,</span>&nbsp;<span class="ident" id="5814734">err</span>&nbsp;<span class="op" id="5814738">=</span>&nbsp;<span class="ident" id="5814740">s</span><span class="op" id="5814741">.</span><span class="ident" id="5814742">tx</span><span class="op" id="5814744">.</span><span class="ident" id="5814745">grabConn</span><span class="op" id="5814753">(</span><span class="op" id="5814754">)</span>&nbsp;<span class="comment" id="5814756">//&nbsp;blocks,&nbsp;waiting&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814797">if</span>&nbsp;<span class="ident" id="5814800">err</span>&nbsp;<span class="op" id="5814804">!=</span>&nbsp;<span class="ident" id="5814807">nil</span>&nbsp;<span class="op" id="5814811">{</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814816">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5814825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814829">releaseConn</span>&nbsp;<span class="op" id="5814841">=</span>&nbsp;<span class="keyword" id="5814843">func</span><span class="op" id="5814847">(</span><span class="builtintype" id="5814848">error</span><span class="op" id="5814853">)</span>&nbsp;<span class="op" id="5814855">{</span><span class="op" id="5814856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814860">return</span>&nbsp;<span class="ident" id="5814867">ci</span><span class="op" id="5814869">,</span>&nbsp;<span class="ident" id="5814871">releaseConn</span><span class="op" id="5814882">,</span>&nbsp;<span class="ident" id="5814884">s</span><span class="op" id="5814885">.</span><span class="ident" id="5814886">txsi</span><span class="op" id="5814890">.</span><span class="ident" id="5814891">si</span><span class="op" id="5814893">,</span>&nbsp;<span class="ident" id="5814895">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5814900">}</span><br>
<span class="lineno">1375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814904">for</span>&nbsp;<span class="ident" id="5814908">i</span>&nbsp;<span class="op" id="5814910">:=</span>&nbsp;<span class="num" id="5814913">0</span><span class="op" id="5814914">;</span>&nbsp;<span class="ident" id="5814916">i</span>&nbsp;<span class="op" id="5814918">&lt;</span>&nbsp;<span class="builtinfunc" id="5814920">len</span><span class="op" id="5814923">(</span><span class="ident" id="5814924">s</span><span class="op" id="5814925">.</span><span class="ident" id="5814926">css</span><span class="op" id="5814929">)</span><span class="op" id="5814930">;</span>&nbsp;<span class="ident" id="5814932">i</span><span class="op" id="5814933">++</span>&nbsp;<span class="op" id="5814936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814940">v</span>&nbsp;<span class="op" id="5814942">:=</span>&nbsp;<span class="ident" id="5814945">s</span><span class="op" id="5814946">.</span><span class="ident" id="5814947">css</span><span class="op" id="5814950">[</span><span class="ident" id="5814951">i</span><span class="op" id="5814952">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814956">_</span><span class="op" id="5814957">,</span>&nbsp;<span class="ident" id="5814959">err</span>&nbsp;<span class="op" id="5814963">:=</span>&nbsp;<span class="ident" id="5814966">s</span><span class="op" id="5814967">.</span><span class="ident" id="5814968">db</span><span class="op" id="5814970">.</span><span class="ident" id="5814971">connIfFree</span><span class="op" id="5814981">(</span><span class="ident" id="5814982">v</span><span class="op" id="5814983">.</span><span class="ident" id="5814984">dc</span><span class="op" id="5814986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814990">if</span>&nbsp;<span class="ident" id="5814993">err</span>&nbsp;<span class="op" id="5814997">==</span>&nbsp;<span class="ident" id="5815000">nil</span>&nbsp;<span class="op" id="5815004">{</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815009">s</span><span class="op" id="5815010">.</span><span class="ident" id="5815011">mu</span><span class="op" id="5815013">.</span><span class="ident" id="5815014">Unlock</span><span class="op" id="5815020">(</span><span class="op" id="5815021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815026">return</span>&nbsp;<span class="ident" id="5815033">v</span><span class="op" id="5815034">.</span><span class="ident" id="5815035">dc</span><span class="op" id="5815037">,</span>&nbsp;<span class="ident" id="5815039">v</span><span class="op" id="5815040">.</span><span class="ident" id="5815041">dc</span><span class="op" id="5815043">.</span><span class="ident" id="5815044">releaseConn</span><span class="op" id="5815055">,</span>&nbsp;<span class="ident" id="5815057">v</span><span class="op" id="5815058">.</span><span class="ident" id="5815059">si</span><span class="op" id="5815061">,</span>&nbsp;<span class="ident" id="5815063">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5815069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815073">if</span>&nbsp;<span class="ident" id="5815076">err</span>&nbsp;<span class="op" id="5815080">==</span>&nbsp;<span class="ident" id="5815083">errConnClosed</span>&nbsp;<span class="op" id="5815097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5815102">//&nbsp;Lazily&nbsp;remove&nbsp;dead&nbsp;conn&nbsp;from&nbsp;our&nbsp;freelist.</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815151">s</span><span class="op" id="5815152">.</span><span class="ident" id="5815153">css</span><span class="op" id="5815156">[</span><span class="ident" id="5815157">i</span><span class="op" id="5815158">]</span>&nbsp;<span class="op" id="5815160">=</span>&nbsp;<span class="ident" id="5815162">s</span><span class="op" id="5815163">.</span><span class="ident" id="5815164">css</span><span class="op" id="5815167">[</span><span class="builtinfunc" id="5815168">len</span><span class="op" id="5815171">(</span><span class="ident" id="5815172">s</span><span class="op" id="5815173">.</span><span class="ident" id="5815174">css</span><span class="op" id="5815177">)</span><span class="op" id="5815178">-</span><span class="num" id="5815179">1</span><span class="op" id="5815180">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815185">s</span><span class="op" id="5815186">.</span><span class="ident" id="5815187">css</span>&nbsp;<span class="op" id="5815191">=</span>&nbsp;<span class="ident" id="5815193">s</span><span class="op" id="5815194">.</span><span class="ident" id="5815195">css</span><span class="op" id="5815198">[</span><span class="op" id="5815199">:</span><span class="builtinfunc" id="5815200">len</span><span class="op" id="5815203">(</span><span class="ident" id="5815204">s</span><span class="op" id="5815205">.</span><span class="ident" id="5815206">css</span><span class="op" id="5815209">)</span><span class="op" id="5815210">-</span><span class="num" id="5815211">1</span><span class="op" id="5815212">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815217">i</span><span class="op" id="5815218">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5815223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5815227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815230">s</span><span class="op" id="5815231">.</span><span class="ident" id="5815232">mu</span><span class="op" id="5815234">.</span><span class="ident" id="5815235">Unlock</span><span class="op" id="5815241">(</span><span class="op" id="5815242">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5815246">//&nbsp;If&nbsp;all&nbsp;connections&nbsp;are&nbsp;busy,&nbsp;either&nbsp;wait&nbsp;for&nbsp;one&nbsp;to&nbsp;become&nbsp;available&nbsp;(if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5815323">//&nbsp;we&#39;ve&nbsp;already&nbsp;hit&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections)&nbsp;or&nbsp;create&nbsp;a</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5815397">//&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5815410">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5815414">//&nbsp;TODO(bradfitz):&nbsp;or&nbsp;always&nbsp;wait&nbsp;for&nbsp;one?&nbsp;make&nbsp;configurable&nbsp;later?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815483">dc</span><span class="op" id="5815485">,</span>&nbsp;<span class="ident" id="5815487">err</span>&nbsp;<span class="op" id="5815491">:=</span>&nbsp;<span class="ident" id="5815494">s</span><span class="op" id="5815495">.</span><span class="ident" id="5815496">db</span><span class="op" id="5815498">.</span><span class="ident" id="5815499">conn</span><span class="op" id="5815503">(</span><span class="op" id="5815504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815507">if</span>&nbsp;<span class="ident" id="5815510">err</span>&nbsp;<span class="op" id="5815514">!=</span>&nbsp;<span class="ident" id="5815517">nil</span>&nbsp;<span class="op" id="5815521">{</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815525">return</span>&nbsp;<span class="ident" id="5815532">nil</span><span class="op" id="5815535">,</span>&nbsp;<span class="ident" id="5815537">nil</span><span class="op" id="5815540">,</span>&nbsp;<span class="ident" id="5815542">nil</span><span class="op" id="5815545">,</span>&nbsp;<span class="ident" id="5815547">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5815552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5815556">//&nbsp;Do&nbsp;another&nbsp;pass&nbsp;over&nbsp;the&nbsp;list&nbsp;to&nbsp;see&nbsp;whether&nbsp;this&nbsp;statement&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5815624">//&nbsp;already&nbsp;been&nbsp;prepared&nbsp;on&nbsp;the&nbsp;connection&nbsp;assigned&nbsp;to&nbsp;us.</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815684">s</span><span class="op" id="5815685">.</span><span class="ident" id="5815686">mu</span><span class="op" id="5815688">.</span><span class="ident" id="5815689">Lock</span><span class="op" id="5815693">(</span><span class="op" id="5815694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815697">for</span>&nbsp;<span class="ident" id="5815701">_</span><span class="op" id="5815702">,</span>&nbsp;<span class="ident" id="5815704">v</span>&nbsp;<span class="op" id="5815706">:=</span>&nbsp;<span class="keyword" id="5815709">range</span>&nbsp;<span class="ident" id="5815715">s</span><span class="op" id="5815716">.</span><span class="ident" id="5815717">css</span>&nbsp;<span class="op" id="5815721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815725">if</span>&nbsp;<span class="ident" id="5815728">v</span><span class="op" id="5815729">.</span><span class="ident" id="5815730">dc</span>&nbsp;<span class="op" id="5815733">==</span>&nbsp;<span class="ident" id="5815736">dc</span>&nbsp;<span class="op" id="5815739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815744">s</span><span class="op" id="5815745">.</span><span class="ident" id="5815746">mu</span><span class="op" id="5815748">.</span><span class="ident" id="5815749">Unlock</span><span class="op" id="5815755">(</span><span class="op" id="5815756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815761">return</span>&nbsp;<span class="ident" id="5815768">dc</span><span class="op" id="5815770">,</span>&nbsp;<span class="ident" id="5815772">dc</span><span class="op" id="5815774">.</span><span class="ident" id="5815775">releaseConn</span><span class="op" id="5815786">,</span>&nbsp;<span class="ident" id="5815788">v</span><span class="op" id="5815789">.</span><span class="ident" id="5815790">si</span><span class="op" id="5815792">,</span>&nbsp;<span class="ident" id="5815794">nil</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5815800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5815803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815806">s</span><span class="op" id="5815807">.</span><span class="ident" id="5815808">mu</span><span class="op" id="5815810">.</span><span class="ident" id="5815811">Unlock</span><span class="op" id="5815817">(</span><span class="op" id="5815818">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5815822">//&nbsp;No&nbsp;luck;&nbsp;we&nbsp;need&nbsp;to&nbsp;prepare&nbsp;the&nbsp;statement&nbsp;on&nbsp;this&nbsp;connection</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815887">dc</span><span class="op" id="5815889">.</span><span class="ident" id="5815890">Lock</span><span class="op" id="5815894">(</span><span class="op" id="5815895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815898">si</span><span class="op" id="5815900">,</span>&nbsp;<span class="ident" id="5815902">err</span>&nbsp;<span class="op" id="5815906">=</span>&nbsp;<span class="ident" id="5815908">dc</span><span class="op" id="5815910">.</span><span class="ident" id="5815911">prepareLocked</span><span class="op" id="5815924">(</span><span class="ident" id="5815925">s</span><span class="op" id="5815926">.</span><span class="ident" id="5815927">query</span><span class="op" id="5815932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815935">dc</span><span class="op" id="5815937">.</span><span class="ident" id="5815938">Unlock</span><span class="op" id="5815944">(</span><span class="op" id="5815945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815948">if</span>&nbsp;<span class="ident" id="5815951">err</span>&nbsp;<span class="op" id="5815955">!=</span>&nbsp;<span class="ident" id="5815958">nil</span>&nbsp;<span class="op" id="5815962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815966">s</span><span class="op" id="5815967">.</span><span class="ident" id="5815968">db</span><span class="op" id="5815970">.</span><span class="ident" id="5815971">putConn</span><span class="op" id="5815978">(</span><span class="ident" id="5815979">dc</span><span class="op" id="5815981">,</span>&nbsp;<span class="ident" id="5815983">err</span><span class="op" id="5815986">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815990">return</span>&nbsp;<span class="ident" id="5815997">nil</span><span class="op" id="5816000">,</span>&nbsp;<span class="ident" id="5816002">nil</span><span class="op" id="5816005">,</span>&nbsp;<span class="ident" id="5816007">nil</span><span class="op" id="5816010">,</span>&nbsp;<span class="ident" id="5816012">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5816017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816020">s</span><span class="op" id="5816021">.</span><span class="ident" id="5816022">mu</span><span class="op" id="5816024">.</span><span class="ident" id="5816025">Lock</span><span class="op" id="5816029">(</span><span class="op" id="5816030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816033">cs</span>&nbsp;<span class="op" id="5816036">:=</span>&nbsp;<span class="ident" id="5816039">connStmt</span><span class="op" id="5816047">{</span><span class="ident" id="5816048">dc</span><span class="op" id="5816050">,</span>&nbsp;<span class="ident" id="5816052">si</span><span class="op" id="5816054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816057">s</span><span class="op" id="5816058">.</span><span class="ident" id="5816059">css</span>&nbsp;<span class="op" id="5816063">=</span>&nbsp;<span class="builtinfunc" id="5816065">append</span><span class="op" id="5816071">(</span><span class="ident" id="5816072">s</span><span class="op" id="5816073">.</span><span class="ident" id="5816074">css</span><span class="op" id="5816077">,</span>&nbsp;<span class="ident" id="5816079">cs</span><span class="op" id="5816081">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816084">s</span><span class="op" id="5816085">.</span><span class="ident" id="5816086">mu</span><span class="op" id="5816088">.</span><span class="ident" id="5816089">Unlock</span><span class="op" id="5816095">(</span><span class="op" id="5816096">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816100">return</span>&nbsp;<span class="ident" id="5816107">dc</span><span class="op" id="5816109">,</span>&nbsp;<span class="ident" id="5816111">dc</span><span class="op" id="5816113">.</span><span class="ident" id="5816114">releaseConn</span><span class="op" id="5816125">,</span>&nbsp;<span class="ident" id="5816127">si</span><span class="op" id="5816129">,</span>&nbsp;<span class="ident" id="5816131">nil</span><br>
<span class="lineno"></span><span class="op" id="5816135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1430</span><span class="comment" id="5816138">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments</span><br>
<span class="lineno"></span><span class="comment" id="5816208">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;query&nbsp;results&nbsp;as&nbsp;a&nbsp;*Rows.</span><br>
<span class="lineno"></span><span class="keyword" id="5816253">func</span>&nbsp;<span class="op" id="5816258">(</span><span class="ident" id="5816259">s</span>&nbsp;<span class="op" id="5816261">*</span><span class="ident" id="5816262">Stmt</span><span class="op" id="5816266">)</span>&nbsp;<span class="ident" id="5816268">Query</span><span class="op" id="5816273">(</span><span class="ident" id="5816274">args</span>&nbsp;<span class="op" id="5816279">...</span><span class="keyword" id="5816282">interface</span><span class="op" id="5816291">{</span><span class="op" id="5816292">}</span><span class="op" id="5816293">)</span>&nbsp;<span class="op" id="5816295">(</span><span class="op" id="5816296">*</span><span class="ident" id="5816297">Rows</span><span class="op" id="5816301">,</span>&nbsp;<span class="builtintype" id="5816303">error</span><span class="op" id="5816308">)</span>&nbsp;<span class="op" id="5816310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816313">s</span><span class="op" id="5816314">.</span><span class="ident" id="5816315">closemu</span><span class="op" id="5816322">.</span><span class="ident" id="5816323">RLock</span><span class="op" id="5816328">(</span><span class="op" id="5816329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816332">defer</span>&nbsp;<span class="ident" id="5816338">s</span><span class="op" id="5816339">.</span><span class="ident" id="5816340">closemu</span><span class="op" id="5816347">.</span><span class="ident" id="5816348">RUnlock</span><span class="op" id="5816355">(</span><span class="op" id="5816356">)</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816360">var</span>&nbsp;<span class="ident" id="5816364">rowsi</span>&nbsp;<span class="ident" id="5816370">driver</span><span class="op" id="5816376">.</span><span class="ident" id="5816377">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816383">for</span>&nbsp;<span class="ident" id="5816387">i</span>&nbsp;<span class="op" id="5816389">:=</span>&nbsp;<span class="num" id="5816392">0</span><span class="op" id="5816393">;</span>&nbsp;<span class="ident" id="5816395">i</span>&nbsp;<span class="op" id="5816397">&lt;</span>&nbsp;<span class="ident" id="5816399">maxBadConnRetries</span><span class="op" id="5816416">;</span>&nbsp;<span class="ident" id="5816418">i</span><span class="op" id="5816419">++</span>&nbsp;<span class="op" id="5816422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816426">dc</span><span class="op" id="5816428">,</span>&nbsp;<span class="ident" id="5816430">releaseConn</span><span class="op" id="5816441">,</span>&nbsp;<span class="ident" id="5816443">si</span><span class="op" id="5816445">,</span>&nbsp;<span class="ident" id="5816447">err</span>&nbsp;<span class="op" id="5816451">:=</span>&nbsp;<span class="ident" id="5816454">s</span><span class="op" id="5816455">.</span><span class="ident" id="5816456">connStmt</span><span class="op" id="5816464">(</span><span class="op" id="5816465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816469">if</span>&nbsp;<span class="ident" id="5816472">err</span>&nbsp;<span class="op" id="5816476">!=</span>&nbsp;<span class="ident" id="5816479">nil</span>&nbsp;<span class="op" id="5816483">{</span><br>
<span class="lineno">1440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816488">if</span>&nbsp;<span class="ident" id="5816491">err</span>&nbsp;<span class="op" id="5816495">==</span>&nbsp;<span class="ident" id="5816498">driver</span><span class="op" id="5816504">.</span><span class="ident" id="5816505">ErrBadConn</span>&nbsp;<span class="op" id="5816516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816522">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5816534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816539">return</span>&nbsp;<span class="ident" id="5816546">nil</span><span class="op" id="5816549">,</span>&nbsp;<span class="ident" id="5816551">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5816557">}</span><br>
<span class="lineno">1445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816562">rowsi</span><span class="op" id="5816567">,</span>&nbsp;<span class="ident" id="5816569">err</span>&nbsp;<span class="op" id="5816573">=</span>&nbsp;<span class="ident" id="5816575">rowsiFromStatement</span><span class="op" id="5816593">(</span><span class="ident" id="5816594">driverStmt</span><span class="op" id="5816604">{</span><span class="ident" id="5816605">dc</span><span class="op" id="5816607">,</span>&nbsp;<span class="ident" id="5816609">si</span><span class="op" id="5816611">}</span><span class="op" id="5816612">,</span>&nbsp;<span class="ident" id="5816614">args</span><span class="op" id="5816618">...</span><span class="op" id="5816621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816625">if</span>&nbsp;<span class="ident" id="5816628">err</span>&nbsp;<span class="op" id="5816632">==</span>&nbsp;<span class="ident" id="5816635">nil</span>&nbsp;<span class="op" id="5816639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5816644">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5816705">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816729">rows</span>&nbsp;<span class="op" id="5816734">:=</span>&nbsp;<span class="op" id="5816737">&amp;</span><span class="ident" id="5816738">Rows</span><span class="op" id="5816742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816748">dc</span><span class="op" id="5816750">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5816755">dc</span><span class="op" id="5816757">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816763">rowsi</span><span class="op" id="5816768">:</span>&nbsp;<span class="ident" id="5816770">rowsi</span><span class="op" id="5816775">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5816781">//&nbsp;releaseConn&nbsp;set&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5816809">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816814">s</span><span class="op" id="5816815">.</span><span class="ident" id="5816816">db</span><span class="op" id="5816818">.</span><span class="ident" id="5816819">addDep</span><span class="op" id="5816825">(</span><span class="ident" id="5816826">s</span><span class="op" id="5816827">,</span>&nbsp;<span class="ident" id="5816829">rows</span><span class="op" id="5816833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816838">rows</span><span class="op" id="5816842">.</span><span class="ident" id="5816843">releaseConn</span>&nbsp;<span class="op" id="5816855">=</span>&nbsp;<span class="keyword" id="5816857">func</span><span class="op" id="5816861">(</span><span class="ident" id="5816862">err</span>&nbsp;<span class="builtintype" id="5816866">error</span><span class="op" id="5816871">)</span>&nbsp;<span class="op" id="5816873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816879">releaseConn</span><span class="op" id="5816890">(</span><span class="ident" id="5816891">err</span><span class="op" id="5816894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816900">s</span><span class="op" id="5816901">.</span><span class="ident" id="5816902">db</span><span class="op" id="5816904">.</span><span class="ident" id="5816905">removeDep</span><span class="op" id="5816914">(</span><span class="ident" id="5816915">s</span><span class="op" id="5816916">,</span>&nbsp;<span class="ident" id="5816918">rows</span><span class="op" id="5816922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5816927">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816932">return</span>&nbsp;<span class="ident" id="5816939">rows</span><span class="op" id="5816943">,</span>&nbsp;<span class="ident" id="5816945">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5816951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816956">releaseConn</span><span class="op" id="5816967">(</span><span class="ident" id="5816968">err</span><span class="op" id="5816971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816975">if</span>&nbsp;<span class="ident" id="5816978">err</span>&nbsp;<span class="op" id="5816982">!=</span>&nbsp;<span class="ident" id="5816985">driver</span><span class="op" id="5816991">.</span><span class="ident" id="5816992">ErrBadConn</span>&nbsp;<span class="op" id="5817003">{</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5817008">return</span>&nbsp;<span class="ident" id="5817015">nil</span><span class="op" id="5817018">,</span>&nbsp;<span class="ident" id="5817020">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5817026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5817029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5817032">return</span>&nbsp;<span class="ident" id="5817039">nil</span><span class="op" id="5817042">,</span>&nbsp;<span class="ident" id="5817044">driver</span><span class="op" id="5817050">.</span><span class="ident" id="5817051">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="5817062">}</span><br>
<span class="lineno">1470</span><br>
<span class="lineno"></span><span class="keyword" id="5817065">func</span>&nbsp;<span class="ident" id="5817070">rowsiFromStatement</span><span class="op" id="5817088">(</span><span class="ident" id="5817089">ds</span>&nbsp;<span class="ident" id="5817092">driverStmt</span><span class="op" id="5817102">,</span>&nbsp;<span class="ident" id="5817104">args</span>&nbsp;<span class="op" id="5817109">...</span><span class="keyword" id="5817112">interface</span><span class="op" id="5817121">{</span><span class="op" id="5817122">}</span><span class="op" id="5817123">)</span>&nbsp;<span class="op" id="5817125">(</span><span class="ident" id="5817126">driver</span><span class="op" id="5817132">.</span><span class="ident" id="5817133">Rows</span><span class="op" id="5817137">,</span>&nbsp;<span class="builtintype" id="5817139">error</span><span class="op" id="5817144">)</span>&nbsp;<span class="op" id="5817146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5817149">ds</span><span class="op" id="5817151">.</span><span class="ident" id="5817152">Lock</span><span class="op" id="5817156">(</span><span class="op" id="5817157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5817160">want</span>&nbsp;<span class="op" id="5817165">:=</span>&nbsp;<span class="ident" id="5817168">ds</span><span class="op" id="5817170">.</span><span class="ident" id="5817171">si</span><span class="op" id="5817173">.</span><span class="ident" id="5817174">NumInput</span><span class="op" id="5817182">(</span><span class="op" id="5817183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5817186">ds</span><span class="op" id="5817188">.</span><span class="ident" id="5817189">Unlock</span><span class="op" id="5817195">(</span><span class="op" id="5817196">)</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5817200">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5817264">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5817338">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5817367">if</span>&nbsp;<span class="ident" id="5817370">want</span>&nbsp;<span class="op" id="5817375">!=</span>&nbsp;<span class="op" id="5817378">-</span><span class="num" id="5817379">1</span>&nbsp;<span class="op" id="5817381">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5817384">len</span><span class="op" id="5817387">(</span><span class="ident" id="5817388">args</span><span class="op" id="5817392">)</span>&nbsp;<span class="op" id="5817394">!=</span>&nbsp;<span class="ident" id="5817397">want</span>&nbsp;<span class="op" id="5817402">{</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5817406">return</span>&nbsp;<span class="ident" id="5817413">nil</span><span class="op" id="5817416">,</span>&nbsp;<span class="ident" id="5817418">fmt</span><span class="op" id="5817421">.</span><span class="ident" id="5817422">Errorf</span><span class="op" id="5817428">(</span><span class="string" id="5817429">&#34;sql:&nbsp;statement&nbsp;expects&nbsp;%d&nbsp;inputs;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="5817471">,</span>&nbsp;<span class="ident" id="5817473">want</span><span class="op" id="5817477">,</span>&nbsp;<span class="builtinfunc" id="5817479">len</span><span class="op" id="5817482">(</span><span class="ident" id="5817483">args</span><span class="op" id="5817487">)</span><span class="op" id="5817488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5817491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5817495">dargs</span><span class="op" id="5817500">,</span>&nbsp;<span class="ident" id="5817502">err</span>&nbsp;<span class="op" id="5817506">:=</span>&nbsp;<span class="ident" id="5817509">driverArgs</span><span class="op" id="5817519">(</span><span class="op" id="5817520">&amp;</span><span class="ident" id="5817521">ds</span><span class="op" id="5817523">,</span>&nbsp;<span class="ident" id="5817525">args</span><span class="op" id="5817529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5817532">if</span>&nbsp;<span class="ident" id="5817535">err</span>&nbsp;<span class="op" id="5817539">!=</span>&nbsp;<span class="ident" id="5817542">nil</span>&nbsp;<span class="op" id="5817546">{</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5817550">return</span>&nbsp;<span class="ident" id="5817557">nil</span><span class="op" id="5817560">,</span>&nbsp;<span class="ident" id="5817562">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5817567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5817571">ds</span><span class="op" id="5817573">.</span><span class="ident" id="5817574">Lock</span><span class="op" id="5817578">(</span><span class="op" id="5817579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5817582">rowsi</span><span class="op" id="5817587">,</span>&nbsp;<span class="ident" id="5817589">err</span>&nbsp;<span class="op" id="5817593">:=</span>&nbsp;<span class="ident" id="5817596">ds</span><span class="op" id="5817598">.</span><span class="ident" id="5817599">si</span><span class="op" id="5817601">.</span><span class="ident" id="5817602">Query</span><span class="op" id="5817607">(</span><span class="ident" id="5817608">dargs</span><span class="op" id="5817613">)</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5817616">ds</span><span class="op" id="5817618">.</span><span class="ident" id="5817619">Unlock</span><span class="op" id="5817625">(</span><span class="op" id="5817626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5817629">if</span>&nbsp;<span class="ident" id="5817632">err</span>&nbsp;<span class="op" id="5817636">!=</span>&nbsp;<span class="ident" id="5817639">nil</span>&nbsp;<span class="op" id="5817643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5817647">return</span>&nbsp;<span class="ident" id="5817654">nil</span><span class="op" id="5817657">,</span>&nbsp;<span class="ident" id="5817659">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5817664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5817667">return</span>&nbsp;<span class="ident" id="5817674">rowsi</span><span class="op" id="5817679">,</span>&nbsp;<span class="ident" id="5817681">nil</span><br>
<span class="lineno">1495</span><span class="op" id="5817685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5817688">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="5817762">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;during&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;statement,&nbsp;that&nbsp;error&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="5817839">//&nbsp;be&nbsp;returned&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Scan&nbsp;on&nbsp;the&nbsp;returned&nbsp;*Row,&nbsp;which&nbsp;is&nbsp;always&nbsp;non-nil.</span><br>
<span class="lineno">1500</span><span class="comment" id="5817919">//&nbsp;If&nbsp;the&nbsp;query&nbsp;selects&nbsp;no&nbsp;rows,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;will&nbsp;return&nbsp;ErrNoRows.</span><br>
<span class="lineno"></span><span class="comment" id="5817991">//&nbsp;Otherwise,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;scans&nbsp;the&nbsp;first&nbsp;selected&nbsp;row&nbsp;and&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="5818063">//&nbsp;the&nbsp;rest.</span><br>
<span class="lineno"></span><span class="comment" id="5818076">//</span><br>
<span class="lineno"></span><span class="comment" id="5818079">//&nbsp;Example&nbsp;usage:</span><br>
<span class="lineno">1505</span><span class="comment" id="5818097">//</span><br>
<span class="lineno"></span><span class="comment" id="5818100">//&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5818120">//&nbsp;&nbsp;err&nbsp;:=&nbsp;nameByUseridStmt.QueryRow(id).Scan(&amp;name)</span><br>
<span class="lineno"></span><span class="keyword" id="5818173">func</span>&nbsp;<span class="op" id="5818178">(</span><span class="ident" id="5818179">s</span>&nbsp;<span class="op" id="5818181">*</span><span class="ident" id="5818182">Stmt</span><span class="op" id="5818186">)</span>&nbsp;<span class="ident" id="5818188">QueryRow</span><span class="op" id="5818196">(</span><span class="ident" id="5818197">args</span>&nbsp;<span class="op" id="5818202">...</span><span class="keyword" id="5818205">interface</span><span class="op" id="5818214">{</span><span class="op" id="5818215">}</span><span class="op" id="5818216">)</span>&nbsp;<span class="op" id="5818218">*</span><span class="ident" id="5818219">Row</span>&nbsp;<span class="op" id="5818223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818226">rows</span><span class="op" id="5818230">,</span>&nbsp;<span class="ident" id="5818232">err</span>&nbsp;<span class="op" id="5818236">:=</span>&nbsp;<span class="ident" id="5818239">s</span><span class="op" id="5818240">.</span><span class="ident" id="5818241">Query</span><span class="op" id="5818246">(</span><span class="ident" id="5818247">args</span><span class="op" id="5818251">...</span><span class="op" id="5818254">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818257">if</span>&nbsp;<span class="ident" id="5818260">err</span>&nbsp;<span class="op" id="5818264">!=</span>&nbsp;<span class="ident" id="5818267">nil</span>&nbsp;<span class="op" id="5818271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818275">return</span>&nbsp;<span class="op" id="5818282">&amp;</span><span class="ident" id="5818283">Row</span><span class="op" id="5818286">{</span><span class="ident" id="5818287">err</span><span class="op" id="5818290">:</span>&nbsp;<span class="ident" id="5818292">err</span><span class="op" id="5818295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5818298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818301">return</span>&nbsp;<span class="op" id="5818308">&amp;</span><span class="ident" id="5818309">Row</span><span class="op" id="5818312">{</span><span class="ident" id="5818313">rows</span><span class="op" id="5818317">:</span>&nbsp;<span class="ident" id="5818319">rows</span><span class="op" id="5818323">}</span><br>
<span class="lineno"></span><span class="op" id="5818325">}</span><br>
<span class="lineno">1515</span><br>
<span class="lineno"></span><span class="comment" id="5818328">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5818359">func</span>&nbsp;<span class="op" id="5818364">(</span><span class="ident" id="5818365">s</span>&nbsp;<span class="op" id="5818367">*</span><span class="ident" id="5818368">Stmt</span><span class="op" id="5818372">)</span>&nbsp;<span class="ident" id="5818374">Close</span><span class="op" id="5818379">(</span><span class="op" id="5818380">)</span>&nbsp;<span class="builtintype" id="5818382">error</span>&nbsp;<span class="op" id="5818388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818391">s</span><span class="op" id="5818392">.</span><span class="ident" id="5818393">closemu</span><span class="op" id="5818400">.</span><span class="ident" id="5818401">Lock</span><span class="op" id="5818405">(</span><span class="op" id="5818406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818409">defer</span>&nbsp;<span class="ident" id="5818415">s</span><span class="op" id="5818416">.</span><span class="ident" id="5818417">closemu</span><span class="op" id="5818424">.</span><span class="ident" id="5818425">Unlock</span><span class="op" id="5818431">(</span><span class="op" id="5818432">)</span><br>
<span class="lineno">1520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818436">if</span>&nbsp;<span class="ident" id="5818439">s</span><span class="op" id="5818440">.</span><span class="ident" id="5818441">stickyErr</span>&nbsp;<span class="op" id="5818451">!=</span>&nbsp;<span class="ident" id="5818454">nil</span>&nbsp;<span class="op" id="5818458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818462">return</span>&nbsp;<span class="ident" id="5818469">s</span><span class="op" id="5818470">.</span><span class="ident" id="5818471">stickyErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5818482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818485">s</span><span class="op" id="5818486">.</span><span class="ident" id="5818487">mu</span><span class="op" id="5818489">.</span><span class="ident" id="5818490">Lock</span><span class="op" id="5818494">(</span><span class="op" id="5818495">)</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818498">if</span>&nbsp;<span class="ident" id="5818501">s</span><span class="op" id="5818502">.</span><span class="ident" id="5818503">closed</span>&nbsp;<span class="op" id="5818510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818514">s</span><span class="op" id="5818515">.</span><span class="ident" id="5818516">mu</span><span class="op" id="5818518">.</span><span class="ident" id="5818519">Unlock</span><span class="op" id="5818525">(</span><span class="op" id="5818526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818530">return</span>&nbsp;<span class="ident" id="5818537">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5818542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818545">s</span><span class="op" id="5818546">.</span><span class="ident" id="5818547">closed</span>&nbsp;<span class="op" id="5818554">=</span>&nbsp;<span class="builtintype" id="5818556">true</span><br>
<span class="lineno">1530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818563">if</span>&nbsp;<span class="ident" id="5818566">s</span><span class="op" id="5818567">.</span><span class="ident" id="5818568">tx</span>&nbsp;<span class="op" id="5818571">!=</span>&nbsp;<span class="ident" id="5818574">nil</span>&nbsp;<span class="op" id="5818578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818582">s</span><span class="op" id="5818583">.</span><span class="ident" id="5818584">txsi</span><span class="op" id="5818588">.</span><span class="ident" id="5818589">Close</span><span class="op" id="5818594">(</span><span class="op" id="5818595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818599">s</span><span class="op" id="5818600">.</span><span class="ident" id="5818601">mu</span><span class="op" id="5818603">.</span><span class="ident" id="5818604">Unlock</span><span class="op" id="5818610">(</span><span class="op" id="5818611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818615">return</span>&nbsp;<span class="ident" id="5818622">nil</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5818627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818630">s</span><span class="op" id="5818631">.</span><span class="ident" id="5818632">mu</span><span class="op" id="5818634">.</span><span class="ident" id="5818635">Unlock</span><span class="op" id="5818641">(</span><span class="op" id="5818642">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818646">return</span>&nbsp;<span class="ident" id="5818653">s</span><span class="op" id="5818654">.</span><span class="ident" id="5818655">db</span><span class="op" id="5818657">.</span><span class="ident" id="5818658">removeDep</span><span class="op" id="5818667">(</span><span class="ident" id="5818668">s</span><span class="op" id="5818669">,</span>&nbsp;<span class="ident" id="5818671">s</span><span class="op" id="5818672">)</span><br>
<span class="lineno"></span><span class="op" id="5818674">}</span><br>
<span class="lineno">1540</span><br>
<span class="lineno"></span><span class="keyword" id="5818677">func</span>&nbsp;<span class="op" id="5818682">(</span><span class="ident" id="5818683">s</span>&nbsp;<span class="op" id="5818685">*</span><span class="ident" id="5818686">Stmt</span><span class="op" id="5818690">)</span>&nbsp;<span class="ident" id="5818692">finalClose</span><span class="op" id="5818702">(</span><span class="op" id="5818703">)</span>&nbsp;<span class="builtintype" id="5818705">error</span>&nbsp;<span class="op" id="5818711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818714">s</span><span class="op" id="5818715">.</span><span class="ident" id="5818716">mu</span><span class="op" id="5818718">.</span><span class="ident" id="5818719">Lock</span><span class="op" id="5818723">(</span><span class="op" id="5818724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818727">defer</span>&nbsp;<span class="ident" id="5818733">s</span><span class="op" id="5818734">.</span><span class="ident" id="5818735">mu</span><span class="op" id="5818737">.</span><span class="ident" id="5818738">Unlock</span><span class="op" id="5818744">(</span><span class="op" id="5818745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818748">if</span>&nbsp;<span class="ident" id="5818751">s</span><span class="op" id="5818752">.</span><span class="ident" id="5818753">css</span>&nbsp;<span class="op" id="5818757">!=</span>&nbsp;<span class="ident" id="5818760">nil</span>&nbsp;<span class="op" id="5818764">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818768">for</span>&nbsp;<span class="ident" id="5818772">_</span><span class="op" id="5818773">,</span>&nbsp;<span class="ident" id="5818775">v</span>&nbsp;<span class="op" id="5818777">:=</span>&nbsp;<span class="keyword" id="5818780">range</span>&nbsp;<span class="ident" id="5818786">s</span><span class="op" id="5818787">.</span><span class="ident" id="5818788">css</span>&nbsp;<span class="op" id="5818792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818797">s</span><span class="op" id="5818798">.</span><span class="ident" id="5818799">db</span><span class="op" id="5818801">.</span><span class="ident" id="5818802">noteUnusedDriverStatement</span><span class="op" id="5818827">(</span><span class="ident" id="5818828">v</span><span class="op" id="5818829">.</span><span class="ident" id="5818830">dc</span><span class="op" id="5818832">,</span>&nbsp;<span class="ident" id="5818834">v</span><span class="op" id="5818835">.</span><span class="ident" id="5818836">si</span><span class="op" id="5818838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818843">v</span><span class="op" id="5818844">.</span><span class="ident" id="5818845">dc</span><span class="op" id="5818847">.</span><span class="ident" id="5818848">removeOpenStmt</span><span class="op" id="5818862">(</span><span class="ident" id="5818863">v</span><span class="op" id="5818864">.</span><span class="ident" id="5818865">si</span><span class="op" id="5818867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5818871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818875">s</span><span class="op" id="5818876">.</span><span class="ident" id="5818877">css</span>&nbsp;<span class="op" id="5818881">=</span>&nbsp;<span class="ident" id="5818883">nil</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5818888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818891">return</span>&nbsp;<span class="ident" id="5818898">nil</span><br>
<span class="lineno"></span><span class="op" id="5818902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5818905">//&nbsp;Rows&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;query.&nbsp;Its&nbsp;cursor&nbsp;starts&nbsp;before&nbsp;the&nbsp;first&nbsp;row</span><br>
<span class="lineno">1555</span><span class="comment" id="5818978">//&nbsp;of&nbsp;the&nbsp;result&nbsp;set.&nbsp;Use&nbsp;Next&nbsp;to&nbsp;advance&nbsp;through&nbsp;the&nbsp;rows:</span><br>
<span class="lineno"></span><span class="comment" id="5819038">//</span><br>
<span class="lineno"></span><span class="comment" id="5819041">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rows,&nbsp;err&nbsp;:=&nbsp;db.Query(&#34;SELECT&nbsp;...&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="5819084">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5819095">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defer&nbsp;rows.Close()</span><br>
<span class="lineno">1560</span><span class="comment" id="5819121">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;rows.Next()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="5819146">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;id&nbsp;int</span><br>
<span class="lineno"></span><span class="comment" id="5819168">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5819195">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Scan(&amp;id,&nbsp;&amp;name)</span><br>
<span class="lineno"></span><span class="comment" id="5819234">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno">1565</span><span class="comment" id="5819249">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="5819258">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Err()&nbsp;//&nbsp;get&nbsp;any&nbsp;error&nbsp;encountered&nbsp;during&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="5819328">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="keyword" id="5819339">type</span>&nbsp;<span class="ident" id="5819344">Rows</span>&nbsp;<span class="keyword" id="5819349">struct</span>&nbsp;<span class="op" id="5819356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819359">dc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5819371">*</span><span class="ident" id="5819372">driverConn</span>&nbsp;<span class="comment" id="5819383">//&nbsp;owned;&nbsp;must&nbsp;call&nbsp;releaseConn&nbsp;when&nbsp;closed&nbsp;to&nbsp;release</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819439">releaseConn</span>&nbsp;<span class="keyword" id="5819451">func</span><span class="op" id="5819455">(</span><span class="builtintype" id="5819456">error</span><span class="op" id="5819461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819464">rowsi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5819476">driver</span><span class="op" id="5819482">.</span><span class="ident" id="5819483">Rows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819490">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5819500">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819506">lastcols</span>&nbsp;&nbsp;<span class="op" id="5819516">[</span><span class="op" id="5819517">]</span><span class="ident" id="5819518">driver</span><span class="op" id="5819524">.</span><span class="ident" id="5819525">Value</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819532">lasterr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5819542">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5819554">//&nbsp;non-nil&nbsp;only&nbsp;if&nbsp;closed&nbsp;is&nbsp;true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819589">closeStmt</span>&nbsp;<span class="ident" id="5819599">driver</span><span class="op" id="5819605">.</span><span class="ident" id="5819606">Stmt</span>&nbsp;<span class="comment" id="5819611">//&nbsp;if&nbsp;non-nil,&nbsp;statement&nbsp;to&nbsp;Close&nbsp;on&nbsp;close</span><br>
<span class="lineno"></span><span class="op" id="5819654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5819657">//&nbsp;Next&nbsp;prepares&nbsp;the&nbsp;next&nbsp;result&nbsp;row&nbsp;for&nbsp;reading&nbsp;with&nbsp;the&nbsp;Scan&nbsp;method.&nbsp;&nbsp;It</span><br>
<span class="lineno">1580</span><span class="comment" id="5819732">//&nbsp;returns&nbsp;true&nbsp;on&nbsp;success,&nbsp;or&nbsp;false&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;next&nbsp;result&nbsp;row&nbsp;or&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5819812">//&nbsp;happened&nbsp;while&nbsp;preparing&nbsp;it.&nbsp;&nbsp;Err&nbsp;should&nbsp;be&nbsp;consulted&nbsp;to&nbsp;distinguish&nbsp;between</span><br>
<span class="lineno"></span><span class="comment" id="5819892">//&nbsp;the&nbsp;two&nbsp;cases.</span><br>
<span class="lineno"></span><span class="comment" id="5819910">//</span><br>
<span class="lineno"></span><span class="comment" id="5819913">//&nbsp;Every&nbsp;call&nbsp;to&nbsp;Scan,&nbsp;even&nbsp;the&nbsp;first&nbsp;one,&nbsp;must&nbsp;be&nbsp;preceded&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Next.</span><br>
<span class="lineno">1585</span><span class="keyword" id="5819992">func</span>&nbsp;<span class="op" id="5819997">(</span><span class="ident" id="5819998">rs</span>&nbsp;<span class="op" id="5820001">*</span><span class="ident" id="5820002">Rows</span><span class="op" id="5820006">)</span>&nbsp;<span class="ident" id="5820008">Next</span><span class="op" id="5820012">(</span><span class="op" id="5820013">)</span>&nbsp;<span class="builtintype" id="5820015">bool</span>&nbsp;<span class="op" id="5820020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820023">if</span>&nbsp;<span class="ident" id="5820026">rs</span><span class="op" id="5820028">.</span><span class="ident" id="5820029">closed</span>&nbsp;<span class="op" id="5820036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820040">return</span>&nbsp;<span class="builtintype" id="5820047">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5820054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820057">if</span>&nbsp;<span class="ident" id="5820060">rs</span><span class="op" id="5820062">.</span><span class="ident" id="5820063">lastcols</span>&nbsp;<span class="op" id="5820072">==</span>&nbsp;<span class="ident" id="5820075">nil</span>&nbsp;<span class="op" id="5820079">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5820083">rs</span><span class="op" id="5820085">.</span><span class="ident" id="5820086">lastcols</span>&nbsp;<span class="op" id="5820095">=</span>&nbsp;<span class="builtinfunc" id="5820097">make</span><span class="op" id="5820101">(</span><span class="op" id="5820102">[</span><span class="op" id="5820103">]</span><span class="ident" id="5820104">driver</span><span class="op" id="5820110">.</span><span class="ident" id="5820111">Value</span><span class="op" id="5820116">,</span>&nbsp;<span class="builtinfunc" id="5820118">len</span><span class="op" id="5820121">(</span><span class="ident" id="5820122">rs</span><span class="op" id="5820124">.</span><span class="ident" id="5820125">rowsi</span><span class="op" id="5820130">.</span><span class="ident" id="5820131">Columns</span><span class="op" id="5820138">(</span><span class="op" id="5820139">)</span><span class="op" id="5820140">)</span><span class="op" id="5820141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5820144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5820147">rs</span><span class="op" id="5820149">.</span><span class="ident" id="5820150">lasterr</span>&nbsp;<span class="op" id="5820158">=</span>&nbsp;<span class="ident" id="5820160">rs</span><span class="op" id="5820162">.</span><span class="ident" id="5820163">rowsi</span><span class="op" id="5820168">.</span><span class="ident" id="5820169">Next</span><span class="op" id="5820173">(</span><span class="ident" id="5820174">rs</span><span class="op" id="5820176">.</span><span class="ident" id="5820177">lastcols</span><span class="op" id="5820185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820188">if</span>&nbsp;<span class="ident" id="5820191">rs</span><span class="op" id="5820193">.</span><span class="ident" id="5820194">lasterr</span>&nbsp;<span class="op" id="5820202">!=</span>&nbsp;<span class="ident" id="5820205">nil</span>&nbsp;<span class="op" id="5820209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5820213">rs</span><span class="op" id="5820215">.</span><span class="ident" id="5820216">Close</span><span class="op" id="5820221">(</span><span class="op" id="5820222">)</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820226">return</span>&nbsp;<span class="builtintype" id="5820233">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5820240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820243">return</span>&nbsp;<span class="builtintype" id="5820250">true</span><br>
<span class="lineno"></span><span class="op" id="5820255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="5820258">//&nbsp;Err&nbsp;returns&nbsp;the&nbsp;error,&nbsp;if&nbsp;any,&nbsp;that&nbsp;was&nbsp;encountered&nbsp;during&nbsp;iteration.</span><br>
<span class="lineno"></span><span class="comment" id="5820331">//&nbsp;Err&nbsp;may&nbsp;be&nbsp;called&nbsp;after&nbsp;an&nbsp;explicit&nbsp;or&nbsp;implicit&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="5820389">func</span>&nbsp;<span class="op" id="5820394">(</span><span class="ident" id="5820395">rs</span>&nbsp;<span class="op" id="5820398">*</span><span class="ident" id="5820399">Rows</span><span class="op" id="5820403">)</span>&nbsp;<span class="ident" id="5820405">Err</span><span class="op" id="5820408">(</span><span class="op" id="5820409">)</span>&nbsp;<span class="builtintype" id="5820411">error</span>&nbsp;<span class="op" id="5820417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820420">if</span>&nbsp;<span class="ident" id="5820423">rs</span><span class="op" id="5820425">.</span><span class="ident" id="5820426">lasterr</span>&nbsp;<span class="op" id="5820434">==</span>&nbsp;<span class="ident" id="5820437">io</span><span class="op" id="5820439">.</span><span class="ident" id="5820440">EOF</span>&nbsp;<span class="op" id="5820444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820448">return</span>&nbsp;<span class="ident" id="5820455">nil</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5820460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820463">return</span>&nbsp;<span class="ident" id="5820470">rs</span><span class="op" id="5820472">.</span><span class="ident" id="5820473">lasterr</span><br>
<span class="lineno"></span><span class="op" id="5820481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5820484">//&nbsp;Columns&nbsp;returns&nbsp;the&nbsp;column&nbsp;names.</span><br>
<span class="lineno">1610</span><span class="comment" id="5820521">//&nbsp;Columns&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;rows&nbsp;are&nbsp;closed,&nbsp;or&nbsp;if&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span><span class="comment" id="5820588">//&nbsp;are&nbsp;from&nbsp;QueryRow&nbsp;and&nbsp;there&nbsp;was&nbsp;a&nbsp;deferred&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="5820641">func</span>&nbsp;<span class="op" id="5820646">(</span><span class="ident" id="5820647">rs</span>&nbsp;<span class="op" id="5820650">*</span><span class="ident" id="5820651">Rows</span><span class="op" id="5820655">)</span>&nbsp;<span class="ident" id="5820657">Columns</span><span class="op" id="5820664">(</span><span class="op" id="5820665">)</span>&nbsp;<span class="op" id="5820667">(</span><span class="op" id="5820668">[</span><span class="op" id="5820669">]</span><span class="builtintype" id="5820670">string</span><span class="op" id="5820676">,</span>&nbsp;<span class="builtintype" id="5820678">error</span><span class="op" id="5820683">)</span>&nbsp;<span class="op" id="5820685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820688">if</span>&nbsp;<span class="ident" id="5820691">rs</span><span class="op" id="5820693">.</span><span class="ident" id="5820694">closed</span>&nbsp;<span class="op" id="5820701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820705">return</span>&nbsp;<span class="ident" id="5820712">nil</span><span class="op" id="5820715">,</span>&nbsp;<span class="ident" id="5820717">errors</span><span class="op" id="5820723">.</span><span class="ident" id="5820724">New</span><span class="op" id="5820727">(</span><span class="string" id="5820728">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="5820750">)</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5820753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820756">if</span>&nbsp;<span class="ident" id="5820759">rs</span><span class="op" id="5820761">.</span><span class="ident" id="5820762">rowsi</span>&nbsp;<span class="op" id="5820768">==</span>&nbsp;<span class="ident" id="5820771">nil</span>&nbsp;<span class="op" id="5820775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820779">return</span>&nbsp;<span class="ident" id="5820786">nil</span><span class="op" id="5820789">,</span>&nbsp;<span class="ident" id="5820791">errors</span><span class="op" id="5820797">.</span><span class="ident" id="5820798">New</span><span class="op" id="5820801">(</span><span class="string" id="5820802">&#34;sql:&nbsp;no&nbsp;Rows&nbsp;available&#34;</span><span class="op" id="5820826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5820829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820832">return</span>&nbsp;<span class="ident" id="5820839">rs</span><span class="op" id="5820841">.</span><span class="ident" id="5820842">rowsi</span><span class="op" id="5820847">.</span><span class="ident" id="5820848">Columns</span><span class="op" id="5820855">(</span><span class="op" id="5820856">)</span><span class="op" id="5820857">,</span>&nbsp;<span class="ident" id="5820859">nil</span><br>
<span class="lineno">1620</span><span class="op" id="5820863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5820866">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;in&nbsp;the&nbsp;current&nbsp;row&nbsp;into&nbsp;the&nbsp;values&nbsp;pointed</span><br>
<span class="lineno"></span><span class="comment" id="5820936">//&nbsp;at&nbsp;by&nbsp;dest.</span><br>
<span class="lineno"></span><span class="comment" id="5820951">//</span><br>
<span class="lineno">1625</span><span class="comment" id="5820954">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*[]byte,&nbsp;Scan&nbsp;saves&nbsp;in&nbsp;that&nbsp;argument&nbsp;a&nbsp;copy</span><br>
<span class="lineno"></span><span class="comment" id="5821025">//&nbsp;of&nbsp;the&nbsp;corresponding&nbsp;data.&nbsp;The&nbsp;copy&nbsp;is&nbsp;owned&nbsp;by&nbsp;the&nbsp;caller&nbsp;and&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="5821095">//&nbsp;be&nbsp;modified&nbsp;and&nbsp;held&nbsp;indefinitely.&nbsp;The&nbsp;copy&nbsp;can&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using</span><br>
<span class="lineno"></span><span class="comment" id="5821166">//&nbsp;an&nbsp;argument&nbsp;of&nbsp;type&nbsp;*RawBytes&nbsp;instead;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5821234">//&nbsp;RawBytes&nbsp;for&nbsp;restrictions&nbsp;on&nbsp;its&nbsp;use.</span><br>
<span class="lineno">1630</span><span class="comment" id="5821275">//</span><br>
<span class="lineno"></span><span class="comment" id="5821278">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*interface{},&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5821341">//&nbsp;provided&nbsp;by&nbsp;the&nbsp;underlying&nbsp;driver&nbsp;without&nbsp;conversion.&nbsp;If&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5821411">//&nbsp;is&nbsp;of&nbsp;type&nbsp;[]byte,&nbsp;a&nbsp;copy&nbsp;is&nbsp;made&nbsp;and&nbsp;the&nbsp;caller&nbsp;owns&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span><span class="keyword" id="5821480">func</span>&nbsp;<span class="op" id="5821485">(</span><span class="ident" id="5821486">rs</span>&nbsp;<span class="op" id="5821489">*</span><span class="ident" id="5821490">Rows</span><span class="op" id="5821494">)</span>&nbsp;<span class="ident" id="5821496">Scan</span><span class="op" id="5821500">(</span><span class="ident" id="5821501">dest</span>&nbsp;<span class="op" id="5821506">...</span><span class="keyword" id="5821509">interface</span><span class="op" id="5821518">{</span><span class="op" id="5821519">}</span><span class="op" id="5821520">)</span>&nbsp;<span class="builtintype" id="5821522">error</span>&nbsp;<span class="op" id="5821528">{</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821531">if</span>&nbsp;<span class="ident" id="5821534">rs</span><span class="op" id="5821536">.</span><span class="ident" id="5821537">closed</span>&nbsp;<span class="op" id="5821544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821548">return</span>&nbsp;<span class="ident" id="5821555">errors</span><span class="op" id="5821561">.</span><span class="ident" id="5821562">New</span><span class="op" id="5821565">(</span><span class="string" id="5821566">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="5821588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5821591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821594">if</span>&nbsp;<span class="ident" id="5821597">rs</span><span class="op" id="5821599">.</span><span class="ident" id="5821600">lastcols</span>&nbsp;<span class="op" id="5821609">==</span>&nbsp;<span class="ident" id="5821612">nil</span>&nbsp;<span class="op" id="5821616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821620">return</span>&nbsp;<span class="ident" id="5821627">errors</span><span class="op" id="5821633">.</span><span class="ident" id="5821634">New</span><span class="op" id="5821637">(</span><span class="string" id="5821638">&#34;sql:&nbsp;Scan&nbsp;called&nbsp;without&nbsp;calling&nbsp;Next&#34;</span><span class="op" id="5821677">)</span><br>
<span class="lineno">1640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5821680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821683">if</span>&nbsp;<span class="builtinfunc" id="5821686">len</span><span class="op" id="5821689">(</span><span class="ident" id="5821690">dest</span><span class="op" id="5821694">)</span>&nbsp;<span class="op" id="5821696">!=</span>&nbsp;<span class="builtinfunc" id="5821699">len</span><span class="op" id="5821702">(</span><span class="ident" id="5821703">rs</span><span class="op" id="5821705">.</span><span class="ident" id="5821706">lastcols</span><span class="op" id="5821714">)</span>&nbsp;<span class="op" id="5821716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821720">return</span>&nbsp;<span class="ident" id="5821727">fmt</span><span class="op" id="5821730">.</span><span class="ident" id="5821731">Errorf</span><span class="op" id="5821737">(</span><span class="string" id="5821738">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;destination&nbsp;arguments&nbsp;in&nbsp;Scan,&nbsp;not&nbsp;%d&#34;</span><span class="op" id="5821794">,</span>&nbsp;<span class="builtinfunc" id="5821796">len</span><span class="op" id="5821799">(</span><span class="ident" id="5821800">rs</span><span class="op" id="5821802">.</span><span class="ident" id="5821803">lastcols</span><span class="op" id="5821811">)</span><span class="op" id="5821812">,</span>&nbsp;<span class="builtinfunc" id="5821814">len</span><span class="op" id="5821817">(</span><span class="ident" id="5821818">dest</span><span class="op" id="5821822">)</span><span class="op" id="5821823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5821826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821829">for</span>&nbsp;<span class="ident" id="5821833">i</span><span class="op" id="5821834">,</span>&nbsp;<span class="ident" id="5821836">sv</span>&nbsp;<span class="op" id="5821839">:=</span>&nbsp;<span class="keyword" id="5821842">range</span>&nbsp;<span class="ident" id="5821848">rs</span><span class="op" id="5821850">.</span><span class="ident" id="5821851">lastcols</span>&nbsp;<span class="op" id="5821860">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5821864">err</span>&nbsp;<span class="op" id="5821868">:=</span>&nbsp;<span class="ident" id="5821871">convertAssign</span><span class="op" id="5821884">(</span><span class="ident" id="5821885">dest</span><span class="op" id="5821889">[</span><span class="ident" id="5821890">i</span><span class="op" id="5821891">]</span><span class="op" id="5821892">,</span>&nbsp;<span class="ident" id="5821894">sv</span><span class="op" id="5821896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821900">if</span>&nbsp;<span class="ident" id="5821903">err</span>&nbsp;<span class="op" id="5821907">!=</span>&nbsp;<span class="ident" id="5821910">nil</span>&nbsp;<span class="op" id="5821914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821919">return</span>&nbsp;<span class="ident" id="5821926">fmt</span><span class="op" id="5821929">.</span><span class="ident" id="5821930">Errorf</span><span class="op" id="5821936">(</span><span class="string" id="5821937">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="5821977">,</span>&nbsp;<span class="ident" id="5821979">i</span><span class="op" id="5821980">,</span>&nbsp;<span class="ident" id="5821982">err</span><span class="op" id="5821985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5821989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5821992">}</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821995">return</span>&nbsp;<span class="ident" id="5822002">nil</span><br>
<span class="lineno"></span><span class="op" id="5822006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5822009">var</span>&nbsp;<span class="ident" id="5822013">rowsCloseHook</span>&nbsp;<span class="keyword" id="5822027">func</span><span class="op" id="5822031">(</span><span class="op" id="5822032">*</span><span class="ident" id="5822033">Rows</span><span class="op" id="5822037">,</span>&nbsp;<span class="op" id="5822039">*</span><span class="builtintype" id="5822040">error</span><span class="op" id="5822045">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1655</span><span class="comment" id="5822048">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;Rows,&nbsp;preventing&nbsp;further&nbsp;enumeration.&nbsp;If&nbsp;Next&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5822122">//&nbsp;false,&nbsp;the&nbsp;Rows&nbsp;are&nbsp;closed&nbsp;automatically&nbsp;and&nbsp;it&nbsp;will&nbsp;suffice&nbsp;to&nbsp;check&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5822199">//&nbsp;result&nbsp;of&nbsp;Err.&nbsp;Close&nbsp;is&nbsp;idempotent&nbsp;and&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;result&nbsp;of&nbsp;Err.</span><br>
<span class="lineno"></span><span class="keyword" id="5822276">func</span>&nbsp;<span class="op" id="5822281">(</span><span class="ident" id="5822282">rs</span>&nbsp;<span class="op" id="5822285">*</span><span class="ident" id="5822286">Rows</span><span class="op" id="5822290">)</span>&nbsp;<span class="ident" id="5822292">Close</span><span class="op" id="5822297">(</span><span class="op" id="5822298">)</span>&nbsp;<span class="builtintype" id="5822300">error</span>&nbsp;<span class="op" id="5822306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5822309">if</span>&nbsp;<span class="ident" id="5822312">rs</span><span class="op" id="5822314">.</span><span class="ident" id="5822315">closed</span>&nbsp;<span class="op" id="5822322">{</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5822326">return</span>&nbsp;<span class="ident" id="5822333">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5822338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822341">rs</span><span class="op" id="5822343">.</span><span class="ident" id="5822344">closed</span>&nbsp;<span class="op" id="5822351">=</span>&nbsp;<span class="builtintype" id="5822353">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822359">err</span>&nbsp;<span class="op" id="5822363">:=</span>&nbsp;<span class="ident" id="5822366">rs</span><span class="op" id="5822368">.</span><span class="ident" id="5822369">rowsi</span><span class="op" id="5822374">.</span><span class="ident" id="5822375">Close</span><span class="op" id="5822380">(</span><span class="op" id="5822381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5822384">if</span>&nbsp;<span class="ident" id="5822387">fn</span>&nbsp;<span class="op" id="5822390">:=</span>&nbsp;<span class="ident" id="5822393">rowsCloseHook</span><span class="op" id="5822406">;</span>&nbsp;<span class="ident" id="5822408">fn</span>&nbsp;<span class="op" id="5822411">!=</span>&nbsp;<span class="ident" id="5822414">nil</span>&nbsp;<span class="op" id="5822418">{</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822422">fn</span><span class="op" id="5822424">(</span><span class="ident" id="5822425">rs</span><span class="op" id="5822427">,</span>&nbsp;<span class="op" id="5822429">&amp;</span><span class="ident" id="5822430">err</span><span class="op" id="5822433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5822436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5822439">if</span>&nbsp;<span class="ident" id="5822442">rs</span><span class="op" id="5822444">.</span><span class="ident" id="5822445">closeStmt</span>&nbsp;<span class="op" id="5822455">!=</span>&nbsp;<span class="ident" id="5822458">nil</span>&nbsp;<span class="op" id="5822462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822466">rs</span><span class="op" id="5822468">.</span><span class="ident" id="5822469">closeStmt</span><span class="op" id="5822478">.</span><span class="ident" id="5822479">Close</span><span class="op" id="5822484">(</span><span class="op" id="5822485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5822488">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822491">rs</span><span class="op" id="5822493">.</span><span class="ident" id="5822494">releaseConn</span><span class="op" id="5822505">(</span><span class="ident" id="5822506">err</span><span class="op" id="5822509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5822512">return</span>&nbsp;<span class="ident" id="5822519">err</span><br>
<span class="lineno"></span><span class="op" id="5822523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5822526">//&nbsp;Row&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;QueryRow&nbsp;to&nbsp;select&nbsp;a&nbsp;single&nbsp;row.</span><br>
<span class="lineno">1675</span><span class="keyword" id="5822591">type</span>&nbsp;<span class="ident" id="5822596">Row</span>&nbsp;<span class="keyword" id="5822600">struct</span>&nbsp;<span class="op" id="5822607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5822610">//&nbsp;One&nbsp;of&nbsp;these&nbsp;two&nbsp;will&nbsp;be&nbsp;non-nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822648">err</span>&nbsp;&nbsp;<span class="builtintype" id="5822653">error</span>&nbsp;<span class="comment" id="5822659">//&nbsp;deferred&nbsp;error&nbsp;for&nbsp;easy&nbsp;chaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822696">rows</span>&nbsp;<span class="op" id="5822701">*</span><span class="ident" id="5822702">Rows</span><br>
<span class="lineno"></span><span class="op" id="5822707">}</span><br>
<span class="lineno">1680</span><br>
<span class="lineno"></span><span class="comment" id="5822710">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;from&nbsp;the&nbsp;matched&nbsp;row&nbsp;into&nbsp;the&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="5822774">//&nbsp;pointed&nbsp;at&nbsp;by&nbsp;dest.&nbsp;&nbsp;If&nbsp;more&nbsp;than&nbsp;one&nbsp;row&nbsp;matches&nbsp;the&nbsp;query,</span><br>
<span class="lineno"></span><span class="comment" id="5822838">//&nbsp;Scan&nbsp;uses&nbsp;the&nbsp;first&nbsp;row&nbsp;and&nbsp;discards&nbsp;the&nbsp;rest.&nbsp;&nbsp;If&nbsp;no&nbsp;row&nbsp;matches</span><br>
<span class="lineno"></span><span class="comment" id="5822907">//&nbsp;the&nbsp;query,&nbsp;Scan&nbsp;returns&nbsp;ErrNoRows.</span><br>
<span class="lineno">1685</span><span class="keyword" id="5822945">func</span>&nbsp;<span class="op" id="5822950">(</span><span class="ident" id="5822951">r</span>&nbsp;<span class="op" id="5822953">*</span><span class="ident" id="5822954">Row</span><span class="op" id="5822957">)</span>&nbsp;<span class="ident" id="5822959">Scan</span><span class="op" id="5822963">(</span><span class="ident" id="5822964">dest</span>&nbsp;<span class="op" id="5822969">...</span><span class="keyword" id="5822972">interface</span><span class="op" id="5822981">{</span><span class="op" id="5822982">}</span><span class="op" id="5822983">)</span>&nbsp;<span class="builtintype" id="5822985">error</span>&nbsp;<span class="op" id="5822991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5822994">if</span>&nbsp;<span class="ident" id="5822997">r</span><span class="op" id="5822998">.</span><span class="ident" id="5822999">err</span>&nbsp;<span class="op" id="5823003">!=</span>&nbsp;<span class="ident" id="5823006">nil</span>&nbsp;<span class="op" id="5823010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823014">return</span>&nbsp;<span class="ident" id="5823021">r</span><span class="op" id="5823022">.</span><span class="ident" id="5823023">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5823028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823032">//&nbsp;TODO(bradfitz):&nbsp;for&nbsp;now&nbsp;we&nbsp;need&nbsp;to&nbsp;defensively&nbsp;clone&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823093">//&nbsp;[]byte&nbsp;that&nbsp;the&nbsp;driver&nbsp;returned&nbsp;(not&nbsp;permitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823145">//&nbsp;*RawBytes&nbsp;in&nbsp;Rows.Scan),&nbsp;since&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823201">//&nbsp;the&nbsp;Rows&nbsp;in&nbsp;our&nbsp;defer,&nbsp;when&nbsp;we&nbsp;return&nbsp;from&nbsp;this&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823263">//&nbsp;the&nbsp;contract&nbsp;with&nbsp;the&nbsp;driver.Next(...)&nbsp;interface&nbsp;is&nbsp;that&nbsp;it</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823327">//&nbsp;can&nbsp;return&nbsp;slices&nbsp;into&nbsp;read-only&nbsp;temporary&nbsp;memory&nbsp;that&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823388">//&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;Scan/Close.&nbsp;&nbsp;But&nbsp;the&nbsp;TODO&nbsp;is&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823452">//&nbsp;for&nbsp;a&nbsp;lot&nbsp;of&nbsp;drivers,&nbsp;this&nbsp;copy&nbsp;will&nbsp;be&nbsp;unnecessary.&nbsp;&nbsp;We</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823513">//&nbsp;should&nbsp;provide&nbsp;an&nbsp;optional&nbsp;interface&nbsp;for&nbsp;drivers&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823569">//&nbsp;implement&nbsp;to&nbsp;say,&nbsp;&#34;don&#39;t&nbsp;worry,&nbsp;the&nbsp;[]bytes&nbsp;that&nbsp;I&nbsp;return</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823631">//&nbsp;from&nbsp;Next&nbsp;will&nbsp;not&nbsp;be&nbsp;modified&nbsp;again.&#34;&nbsp;(for&nbsp;instance,&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823692">//&nbsp;they&nbsp;were&nbsp;obtained&nbsp;from&nbsp;the&nbsp;network&nbsp;anyway)&nbsp;But&nbsp;for&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823755">//&nbsp;don&#39;t&nbsp;care.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823771">defer</span>&nbsp;<span class="ident" id="5823777">r</span><span class="op" id="5823778">.</span><span class="ident" id="5823779">rows</span><span class="op" id="5823783">.</span><span class="ident" id="5823784">Close</span><span class="op" id="5823789">(</span><span class="op" id="5823790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823793">for</span>&nbsp;<span class="ident" id="5823797">_</span><span class="op" id="5823798">,</span>&nbsp;<span class="ident" id="5823800">dp</span>&nbsp;<span class="op" id="5823803">:=</span>&nbsp;<span class="keyword" id="5823806">range</span>&nbsp;<span class="ident" id="5823812">dest</span>&nbsp;<span class="op" id="5823817">{</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823821">if</span>&nbsp;<span class="ident" id="5823824">_</span><span class="op" id="5823825">,</span>&nbsp;<span class="ident" id="5823827">ok</span>&nbsp;<span class="op" id="5823830">:=</span>&nbsp;<span class="ident" id="5823833">dp</span><span class="op" id="5823835">.</span><span class="op" id="5823836">(</span><span class="op" id="5823837">*</span><span class="ident" id="5823838">RawBytes</span><span class="op" id="5823846">)</span><span class="op" id="5823847">;</span>&nbsp;<span class="ident" id="5823849">ok</span>&nbsp;<span class="op" id="5823852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823857">return</span>&nbsp;<span class="ident" id="5823864">errors</span><span class="op" id="5823870">.</span><span class="ident" id="5823871">New</span><span class="op" id="5823874">(</span><span class="string" id="5823875">&#34;sql:&nbsp;RawBytes&nbsp;isn&#39;t&nbsp;allowed&nbsp;on&nbsp;Row.Scan&#34;</span><span class="op" id="5823916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5823920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5823923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823927">if</span>&nbsp;<span class="op" id="5823930">!</span><span class="ident" id="5823931">r</span><span class="op" id="5823932">.</span><span class="ident" id="5823933">rows</span><span class="op" id="5823937">.</span><span class="ident" id="5823938">Next</span><span class="op" id="5823942">(</span><span class="op" id="5823943">)</span>&nbsp;<span class="op" id="5823945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823949">if</span>&nbsp;<span class="ident" id="5823952">err</span>&nbsp;<span class="op" id="5823956">:=</span>&nbsp;<span class="ident" id="5823959">r</span><span class="op" id="5823960">.</span><span class="ident" id="5823961">rows</span><span class="op" id="5823965">.</span><span class="ident" id="5823966">Err</span><span class="op" id="5823969">(</span><span class="op" id="5823970">)</span><span class="op" id="5823971">;</span>&nbsp;<span class="ident" id="5823973">err</span>&nbsp;<span class="op" id="5823977">!=</span>&nbsp;<span class="ident" id="5823980">nil</span>&nbsp;<span class="op" id="5823984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823989">return</span>&nbsp;<span class="ident" id="5823996">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5824002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824006">return</span>&nbsp;<span class="ident" id="5824013">ErrNoRows</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5824024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824027">err</span>&nbsp;<span class="op" id="5824031">:=</span>&nbsp;<span class="ident" id="5824034">r</span><span class="op" id="5824035">.</span><span class="ident" id="5824036">rows</span><span class="op" id="5824040">.</span><span class="ident" id="5824041">Scan</span><span class="op" id="5824045">(</span><span class="ident" id="5824046">dest</span><span class="op" id="5824050">...</span><span class="op" id="5824053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824056">if</span>&nbsp;<span class="ident" id="5824059">err</span>&nbsp;<span class="op" id="5824063">!=</span>&nbsp;<span class="ident" id="5824066">nil</span>&nbsp;<span class="op" id="5824070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824074">return</span>&nbsp;<span class="ident" id="5824081">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5824086">}</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5824089">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;query&nbsp;can&nbsp;be&nbsp;processed&nbsp;to&nbsp;completion&nbsp;with&nbsp;no&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824160">if</span>&nbsp;<span class="ident" id="5824163">err</span>&nbsp;<span class="op" id="5824167">:=</span>&nbsp;<span class="ident" id="5824170">r</span><span class="op" id="5824171">.</span><span class="ident" id="5824172">rows</span><span class="op" id="5824176">.</span><span class="ident" id="5824177">Close</span><span class="op" id="5824182">(</span><span class="op" id="5824183">)</span><span class="op" id="5824184">;</span>&nbsp;<span class="ident" id="5824186">err</span>&nbsp;<span class="op" id="5824190">!=</span>&nbsp;<span class="ident" id="5824193">nil</span>&nbsp;<span class="op" id="5824197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824201">return</span>&nbsp;<span class="ident" id="5824208">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5824213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824217">return</span>&nbsp;<span class="ident" id="5824224">nil</span><br>
<span class="lineno"></span><span class="op" id="5824228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5824231">//&nbsp;A&nbsp;Result&nbsp;summarizes&nbsp;an&nbsp;executed&nbsp;SQL&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="5824279">type</span>&nbsp;<span class="ident" id="5824284">Result</span>&nbsp;<span class="keyword" id="5824291">interface</span>&nbsp;<span class="op" id="5824301">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5824304">//&nbsp;LastInsertId&nbsp;returns&nbsp;the&nbsp;integer&nbsp;generated&nbsp;by&nbsp;the&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5824367">//&nbsp;in&nbsp;response&nbsp;to&nbsp;a&nbsp;command.&nbsp;Typically&nbsp;this&nbsp;will&nbsp;be&nbsp;from&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5824428">//&nbsp;&#34;auto&nbsp;increment&#34;&nbsp;column&nbsp;when&nbsp;inserting&nbsp;a&nbsp;new&nbsp;row.&nbsp;Not&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5824490">//&nbsp;databases&nbsp;support&nbsp;this&nbsp;feature,&nbsp;and&nbsp;the&nbsp;syntax&nbsp;of&nbsp;such</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5824549">//&nbsp;statements&nbsp;varies.</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824572">LastInsertId</span><span class="op" id="5824584">(</span><span class="op" id="5824585">)</span>&nbsp;<span class="op" id="5824587">(</span><span class="ident" id="5824588">int64</span><span class="op" id="5824593">,</span>&nbsp;<span class="builtintype" id="5824595">error</span><span class="op" id="5824600">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5824604">//&nbsp;RowsAffected&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;rows&nbsp;affected&nbsp;by&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5824663">//&nbsp;update,&nbsp;insert,&nbsp;or&nbsp;delete.&nbsp;Not&nbsp;every&nbsp;database&nbsp;or&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5824725">//&nbsp;driver&nbsp;may&nbsp;support&nbsp;this.</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824754">RowsAffected</span><span class="op" id="5824766">(</span><span class="op" id="5824767">)</span>&nbsp;<span class="op" id="5824769">(</span><span class="ident" id="5824770">int64</span><span class="op" id="5824775">,</span>&nbsp;<span class="builtintype" id="5824777">error</span><span class="op" id="5824782">)</span><br>
<span class="lineno"></span><span class="op" id="5824784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5824787">type</span>&nbsp;<span class="ident" id="5824792">driverResult</span>&nbsp;<span class="keyword" id="5824805">struct</span>&nbsp;<span class="op" id="5824812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824815">sync</span><span class="op" id="5824819">.</span><span class="ident" id="5824820">Locker</span>&nbsp;<span class="comment" id="5824827">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824847">resi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5824859">driver</span><span class="op" id="5824865">.</span><span class="ident" id="5824866">Result</span><br>
<span class="lineno"></span><span class="op" id="5824873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5824876">func</span>&nbsp;<span class="op" id="5824881">(</span><span class="ident" id="5824882">dr</span>&nbsp;<span class="ident" id="5824885">driverResult</span><span class="op" id="5824897">)</span>&nbsp;<span class="ident" id="5824899">LastInsertId</span><span class="op" id="5824911">(</span><span class="op" id="5824912">)</span>&nbsp;<span class="op" id="5824914">(</span><span class="ident" id="5824915">int64</span><span class="op" id="5824920">,</span>&nbsp;<span class="builtintype" id="5824922">error</span><span class="op" id="5824927">)</span>&nbsp;<span class="op" id="5824929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824932">dr</span><span class="op" id="5824934">.</span><span class="ident" id="5824935">Lock</span><span class="op" id="5824939">(</span><span class="op" id="5824940">)</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824943">defer</span>&nbsp;<span class="ident" id="5824949">dr</span><span class="op" id="5824951">.</span><span class="ident" id="5824952">Unlock</span><span class="op" id="5824958">(</span><span class="op" id="5824959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824962">return</span>&nbsp;<span class="ident" id="5824969">dr</span><span class="op" id="5824971">.</span><span class="ident" id="5824972">resi</span><span class="op" id="5824976">.</span><span class="ident" id="5824977">LastInsertId</span><span class="op" id="5824989">(</span><span class="op" id="5824990">)</span><br>
<span class="lineno"></span><span class="op" id="5824992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5824995">func</span>&nbsp;<span class="op" id="5825000">(</span><span class="ident" id="5825001">dr</span>&nbsp;<span class="ident" id="5825004">driverResult</span><span class="op" id="5825016">)</span>&nbsp;<span class="ident" id="5825018">RowsAffected</span><span class="op" id="5825030">(</span><span class="op" id="5825031">)</span>&nbsp;<span class="op" id="5825033">(</span><span class="ident" id="5825034">int64</span><span class="op" id="5825039">,</span>&nbsp;<span class="builtintype" id="5825041">error</span><span class="op" id="5825046">)</span>&nbsp;<span class="op" id="5825048">{</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5825051">dr</span><span class="op" id="5825053">.</span><span class="ident" id="5825054">Lock</span><span class="op" id="5825058">(</span><span class="op" id="5825059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5825062">defer</span>&nbsp;<span class="ident" id="5825068">dr</span><span class="op" id="5825070">.</span><span class="ident" id="5825071">Unlock</span><span class="op" id="5825077">(</span><span class="op" id="5825078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5825081">return</span>&nbsp;<span class="ident" id="5825088">dr</span><span class="op" id="5825090">.</span><span class="ident" id="5825091">resi</span><span class="op" id="5825095">.</span><span class="ident" id="5825096">RowsAffected</span><span class="op" id="5825108">(</span><span class="op" id="5825109">)</span><br>
<span class="lineno"></span><span class="op" id="5825111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span><span class="keyword" id="5825114">func</span>&nbsp;<span class="ident" id="5825119">stack</span><span class="op" id="5825124">(</span><span class="op" id="5825125">)</span>&nbsp;<span class="builtintype" id="5825127">string</span>&nbsp;<span class="op" id="5825134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5825137">var</span>&nbsp;<span class="ident" id="5825141">buf</span>&nbsp;<span class="op" id="5825145">[</span><span class="num" id="5825146">2</span>&nbsp;<span class="op" id="5825148">&lt;&lt;</span>&nbsp;<span class="num" id="5825151">10</span><span class="op" id="5825153">]</span><span class="builtintype" id="5825154">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5825160">return</span>&nbsp;<span class="builtintype" id="5825167">string</span><span class="op" id="5825173">(</span><span class="ident" id="5825174">buf</span><span class="op" id="5825177">[</span><span class="op" id="5825178">:</span><span class="ident" id="5825179">runtime</span><span class="op" id="5825186">.</span><span class="ident" id="5825187">Stack</span><span class="op" id="5825192">(</span><span class="ident" id="5825193">buf</span><span class="op" id="5825196">[</span><span class="op" id="5825197">:</span><span class="op" id="5825198">]</span><span class="op" id="5825199">,</span>&nbsp;<span class="builtintype" id="5825201">false</span><span class="op" id="5825206">)</span><span class="op" id="5825207">]</span><span class="op" id="5825208">)</span><br>
<span class="lineno"></span><span class="op" id="5825210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1765</span><span class="comment" id="5825213">//&nbsp;withLock&nbsp;runs&nbsp;while&nbsp;holding&nbsp;lk.</span><br>
<span class="lineno"></span><span class="keyword" id="5825248">func</span>&nbsp;<span class="ident" id="5825253">withLock</span><span class="op" id="5825261">(</span><span class="ident" id="5825262">lk</span>&nbsp;<span class="ident" id="5825265">sync</span><span class="op" id="5825269">.</span><span class="ident" id="5825270">Locker</span><span class="op" id="5825276">,</span>&nbsp;<span class="ident" id="5825278">fn</span>&nbsp;<span class="keyword" id="5825281">func</span><span class="op" id="5825285">(</span><span class="op" id="5825286">)</span><span class="op" id="5825287">)</span>&nbsp;<span class="op" id="5825289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5825292">lk</span><span class="op" id="5825294">.</span><span class="ident" id="5825295">Lock</span><span class="op" id="5825299">(</span><span class="op" id="5825300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5825303">fn</span><span class="op" id="5825305">(</span><span class="op" id="5825306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5825309">lk</span><span class="op" id="5825311">.</span><span class="ident" id="5825312">Unlock</span><span class="op" id="5825318">(</span><span class="op" id="5825319">)</span><br>
<span class="lineno">1770</span><span class="op" id="5825321">}</span>
</div>
</body>
</html>
