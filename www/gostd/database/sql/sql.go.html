<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5796468">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5796523">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5796577">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5796628">//&nbsp;Package&nbsp;sql&nbsp;provides&nbsp;a&nbsp;generic&nbsp;interface&nbsp;around&nbsp;SQL&nbsp;(or&nbsp;SQL-like)</span><br>
<span class="lineno"></span><span class="comment" id="5796697">//&nbsp;databases.</span><br>
<span class="lineno"></span><span class="comment" id="5796711">//</span><br>
<span class="lineno"></span><span class="comment" id="5796714">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;must&nbsp;be&nbsp;used&nbsp;in&nbsp;conjunction&nbsp;with&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="5796785">//&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for&nbsp;a&nbsp;list&nbsp;of&nbsp;drivers.</span><br>
<span class="lineno">10</span><span class="comment" id="5796846">//</span><br>
<span class="lineno"></span><span class="comment" id="5796849">//&nbsp;For&nbsp;more&nbsp;usage&nbsp;examples,&nbsp;see&nbsp;the&nbsp;wiki&nbsp;page&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5796898">//&nbsp;http://golang.org/s/sqlwiki.</span><br>
<span class="lineno"></span><span class="keyword" id="5796930">package</span>&nbsp;<span class="ident" id="5796938">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5796943">import</span>&nbsp;<span class="op" id="5796950">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5796953">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5796976">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5796986">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5796993">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5796999">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5797010">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5797018">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5797025">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5797028">var</span>&nbsp;<span class="ident" id="5797032">drivers</span>&nbsp;<span class="op" id="5797040">=</span>&nbsp;<span class="builtinfunc" id="5797042">make</span><span class="op" id="5797046">(</span><span class="keyword" id="5797047">map</span><span class="op" id="5797050">[</span><span class="builtintype" id="5797051">string</span><span class="op" id="5797057">]</span><span class="ident" id="5797058">driver</span><span class="op" id="5797064">.</span><span class="ident" id="5797065">Driver</span><span class="op" id="5797071">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5797074">//&nbsp;Register&nbsp;makes&nbsp;a&nbsp;database&nbsp;driver&nbsp;available&nbsp;by&nbsp;the&nbsp;provided&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="5797142">//&nbsp;If&nbsp;Register&nbsp;is&nbsp;called&nbsp;twice&nbsp;with&nbsp;the&nbsp;same&nbsp;name&nbsp;or&nbsp;if&nbsp;driver&nbsp;is&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="5797213">//&nbsp;it&nbsp;panics.</span><br>
<span class="lineno">30</span><span class="keyword" id="5797227">func</span>&nbsp;<span class="ident" id="5797232">Register</span><span class="op" id="5797240">(</span><span class="ident" id="5797241">name</span>&nbsp;<span class="builtintype" id="5797246">string</span><span class="op" id="5797252">,</span>&nbsp;<span class="ident" id="5797254">driver</span>&nbsp;<span class="ident" id="5797261">driver</span><span class="op" id="5797267">.</span><span class="ident" id="5797268">Driver</span><span class="op" id="5797274">)</span>&nbsp;<span class="op" id="5797276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5797279">if</span>&nbsp;<span class="ident" id="5797282">driver</span>&nbsp;<span class="op" id="5797289">==</span>&nbsp;<span class="ident" id="5797292">nil</span>&nbsp;<span class="op" id="5797296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5797300">panic</span><span class="op" id="5797305">(</span><span class="string" id="5797306">&#34;sql:&nbsp;Register&nbsp;driver&nbsp;is&nbsp;nil&#34;</span><span class="op" id="5797335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5797338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5797341">if</span>&nbsp;<span class="ident" id="5797344">_</span><span class="op" id="5797345">,</span>&nbsp;<span class="ident" id="5797347">dup</span>&nbsp;<span class="op" id="5797351">:=</span>&nbsp;<span class="ident" id="5797354">drivers</span><span class="op" id="5797361">[</span><span class="ident" id="5797362">name</span><span class="op" id="5797366">]</span><span class="op" id="5797367">;</span>&nbsp;<span class="ident" id="5797369">dup</span>&nbsp;<span class="op" id="5797373">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5797377">panic</span><span class="op" id="5797382">(</span><span class="string" id="5797383">&#34;sql:&nbsp;Register&nbsp;called&nbsp;twice&nbsp;for&nbsp;driver&nbsp;&#34;</span>&nbsp;<span class="op" id="5797424">+</span>&nbsp;<span class="ident" id="5797426">name</span><span class="op" id="5797430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5797433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797436">drivers</span><span class="op" id="5797443">[</span><span class="ident" id="5797444">name</span><span class="op" id="5797448">]</span>&nbsp;<span class="op" id="5797450">=</span>&nbsp;<span class="ident" id="5797452">driver</span><br>
<span class="lineno"></span><span class="op" id="5797459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="5797462">func</span>&nbsp;<span class="ident" id="5797467">unregisterAllDrivers</span><span class="op" id="5797487">(</span><span class="op" id="5797488">)</span>&nbsp;<span class="op" id="5797490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5797493">//&nbsp;For&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797508">drivers</span>&nbsp;<span class="op" id="5797516">=</span>&nbsp;<span class="builtinfunc" id="5797518">make</span><span class="op" id="5797522">(</span><span class="keyword" id="5797523">map</span><span class="op" id="5797526">[</span><span class="builtintype" id="5797527">string</span><span class="op" id="5797533">]</span><span class="ident" id="5797534">driver</span><span class="op" id="5797540">.</span><span class="ident" id="5797541">Driver</span><span class="op" id="5797547">)</span><br>
<span class="lineno"></span><span class="op" id="5797549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5797552">//&nbsp;Drivers&nbsp;returns&nbsp;a&nbsp;sorted&nbsp;list&nbsp;of&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;registered&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="keyword" id="5797625">func</span>&nbsp;<span class="ident" id="5797630">Drivers</span><span class="op" id="5797637">(</span><span class="op" id="5797638">)</span>&nbsp;<span class="op" id="5797640">[</span><span class="op" id="5797641">]</span><span class="builtintype" id="5797642">string</span>&nbsp;<span class="op" id="5797649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5797652">var</span>&nbsp;<span class="ident" id="5797656">list</span>&nbsp;<span class="op" id="5797661">[</span><span class="op" id="5797662">]</span><span class="builtintype" id="5797663">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5797671">for</span>&nbsp;<span class="ident" id="5797675">name</span>&nbsp;<span class="op" id="5797680">:=</span>&nbsp;<span class="keyword" id="5797683">range</span>&nbsp;<span class="ident" id="5797689">drivers</span>&nbsp;<span class="op" id="5797697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797701">list</span>&nbsp;<span class="op" id="5797706">=</span>&nbsp;<span class="builtinfunc" id="5797708">append</span><span class="op" id="5797714">(</span><span class="ident" id="5797715">list</span><span class="op" id="5797719">,</span>&nbsp;<span class="ident" id="5797721">name</span><span class="op" id="5797725">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5797728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5797731">sort</span><span class="op" id="5797735">.</span><span class="ident" id="5797736">Strings</span><span class="op" id="5797743">(</span><span class="ident" id="5797744">list</span><span class="op" id="5797748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5797751">return</span>&nbsp;<span class="ident" id="5797758">list</span><br>
<span class="lineno"></span><span class="op" id="5797763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5797766">//&nbsp;RawBytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;slice&nbsp;that&nbsp;holds&nbsp;a&nbsp;reference&nbsp;to&nbsp;memory&nbsp;owned&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5797836">//&nbsp;the&nbsp;database&nbsp;itself.&nbsp;After&nbsp;a&nbsp;Scan&nbsp;into&nbsp;a&nbsp;RawBytes,&nbsp;the&nbsp;slice&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="5797908">//&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;Next,&nbsp;Scan,&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="5797962">type</span>&nbsp;<span class="ident" id="5797967">RawBytes</span>&nbsp;<span class="op" id="5797976">[</span><span class="op" id="5797977">]</span><span class="builtintype" id="5797978">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="5797984">//&nbsp;NullString&nbsp;represents&nbsp;a&nbsp;string&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5798036">//&nbsp;NullString&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5798086">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination:</span><br>
<span class="lineno"></span><span class="comment" id="5798127">//</span><br>
<span class="lineno"></span><span class="comment" id="5798130">//&nbsp;&nbsp;var&nbsp;s&nbsp;NullString</span><br>
<span class="lineno">65</span><span class="comment" id="5798151">//&nbsp;&nbsp;err&nbsp;:=&nbsp;db.QueryRow(&#34;SELECT&nbsp;name&nbsp;FROM&nbsp;foo&nbsp;WHERE&nbsp;id=?&#34;,&nbsp;id).Scan(&amp;s)</span><br>
<span class="lineno"></span><span class="comment" id="5798222">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5798230">//&nbsp;&nbsp;if&nbsp;s.Valid&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="5798247">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;use&nbsp;s.String</span><br>
<span class="lineno"></span><span class="comment" id="5798270">//&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno">70</span><span class="comment" id="5798283">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;NULL&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5798304">//&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="5798310">//</span><br>
<span class="lineno"></span><span class="keyword" id="5798313">type</span>&nbsp;<span class="ident" id="5798318">NullString</span>&nbsp;<span class="keyword" id="5798329">struct</span>&nbsp;<span class="op" id="5798336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798339">String</span>&nbsp;<span class="builtintype" id="5798346">string</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798354">Valid</span>&nbsp;&nbsp;<span class="builtintype" id="5798361">bool</span>&nbsp;<span class="comment" id="5798366">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;String&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5798405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5798408">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5798450">func</span>&nbsp;<span class="op" id="5798455">(</span><span class="ident" id="5798456">ns</span>&nbsp;<span class="op" id="5798459">*</span><span class="ident" id="5798460">NullString</span><span class="op" id="5798470">)</span>&nbsp;<span class="ident" id="5798472">Scan</span><span class="op" id="5798476">(</span><span class="ident" id="5798477">value</span>&nbsp;<span class="keyword" id="5798483">interface</span><span class="op" id="5798492">{</span><span class="op" id="5798493">}</span><span class="op" id="5798494">)</span>&nbsp;<span class="builtintype" id="5798496">error</span>&nbsp;<span class="op" id="5798502">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798505">if</span>&nbsp;<span class="ident" id="5798508">value</span>&nbsp;<span class="op" id="5798514">==</span>&nbsp;<span class="ident" id="5798517">nil</span>&nbsp;<span class="op" id="5798521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798525">ns</span><span class="op" id="5798527">.</span><span class="ident" id="5798528">String</span><span class="op" id="5798534">,</span>&nbsp;<span class="ident" id="5798536">ns</span><span class="op" id="5798538">.</span><span class="ident" id="5798539">Valid</span>&nbsp;<span class="op" id="5798545">=</span>&nbsp;<span class="string" id="5798547">&#34;&#34;</span><span class="op" id="5798549">,</span>&nbsp;<span class="builtintype" id="5798551">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798559">return</span>&nbsp;<span class="ident" id="5798566">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5798571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798574">ns</span><span class="op" id="5798576">.</span><span class="ident" id="5798577">Valid</span>&nbsp;<span class="op" id="5798583">=</span>&nbsp;<span class="builtintype" id="5798585">true</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798591">return</span>&nbsp;<span class="ident" id="5798598">convertAssign</span><span class="op" id="5798611">(</span><span class="op" id="5798612">&amp;</span><span class="ident" id="5798613">ns</span><span class="op" id="5798615">.</span><span class="ident" id="5798616">String</span><span class="op" id="5798622">,</span>&nbsp;<span class="ident" id="5798624">value</span><span class="op" id="5798629">)</span><br>
<span class="lineno"></span><span class="op" id="5798631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5798634">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5798683">func</span>&nbsp;<span class="op" id="5798688">(</span><span class="ident" id="5798689">ns</span>&nbsp;<span class="ident" id="5798692">NullString</span><span class="op" id="5798702">)</span>&nbsp;<span class="ident" id="5798704">Value</span><span class="op" id="5798709">(</span><span class="op" id="5798710">)</span>&nbsp;<span class="op" id="5798712">(</span><span class="ident" id="5798713">driver</span><span class="op" id="5798719">.</span><span class="ident" id="5798720">Value</span><span class="op" id="5798725">,</span>&nbsp;<span class="builtintype" id="5798727">error</span><span class="op" id="5798732">)</span>&nbsp;<span class="op" id="5798734">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798737">if</span>&nbsp;<span class="op" id="5798740">!</span><span class="ident" id="5798741">ns</span><span class="op" id="5798743">.</span><span class="ident" id="5798744">Valid</span>&nbsp;<span class="op" id="5798750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798754">return</span>&nbsp;<span class="ident" id="5798761">nil</span><span class="op" id="5798764">,</span>&nbsp;<span class="ident" id="5798766">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5798771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5798774">return</span>&nbsp;<span class="ident" id="5798781">ns</span><span class="op" id="5798783">.</span><span class="ident" id="5798784">String</span><span class="op" id="5798790">,</span>&nbsp;<span class="ident" id="5798792">nil</span><br>
<span class="lineno"></span><span class="op" id="5798796">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="5798799">//&nbsp;NullInt64&nbsp;represents&nbsp;an&nbsp;int64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5798850">//&nbsp;NullInt64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5798899">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="5798963">type</span>&nbsp;<span class="ident" id="5798968">NullInt64</span>&nbsp;<span class="keyword" id="5798978">struct</span>&nbsp;<span class="op" id="5798985">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5798988">Int64</span>&nbsp;<span class="ident" id="5798994">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799001">Valid</span>&nbsp;<span class="builtintype" id="5799007">bool</span>&nbsp;<span class="comment" id="5799012">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Int64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5799050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5799053">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno">105</span><span class="keyword" id="5799095">func</span>&nbsp;<span class="op" id="5799100">(</span><span class="ident" id="5799101">n</span>&nbsp;<span class="op" id="5799103">*</span><span class="ident" id="5799104">NullInt64</span><span class="op" id="5799113">)</span>&nbsp;<span class="ident" id="5799115">Scan</span><span class="op" id="5799119">(</span><span class="ident" id="5799120">value</span>&nbsp;<span class="keyword" id="5799126">interface</span><span class="op" id="5799135">{</span><span class="op" id="5799136">}</span><span class="op" id="5799137">)</span>&nbsp;<span class="builtintype" id="5799139">error</span>&nbsp;<span class="op" id="5799145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5799148">if</span>&nbsp;<span class="ident" id="5799151">value</span>&nbsp;<span class="op" id="5799157">==</span>&nbsp;<span class="ident" id="5799160">nil</span>&nbsp;<span class="op" id="5799164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799168">n</span><span class="op" id="5799169">.</span><span class="ident" id="5799170">Int64</span><span class="op" id="5799175">,</span>&nbsp;<span class="ident" id="5799177">n</span><span class="op" id="5799178">.</span><span class="ident" id="5799179">Valid</span>&nbsp;<span class="op" id="5799185">=</span>&nbsp;<span class="num" id="5799187">0</span><span class="op" id="5799188">,</span>&nbsp;<span class="builtintype" id="5799190">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5799198">return</span>&nbsp;<span class="ident" id="5799205">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5799210">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799213">n</span><span class="op" id="5799214">.</span><span class="ident" id="5799215">Valid</span>&nbsp;<span class="op" id="5799221">=</span>&nbsp;<span class="builtintype" id="5799223">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5799229">return</span>&nbsp;<span class="ident" id="5799236">convertAssign</span><span class="op" id="5799249">(</span><span class="op" id="5799250">&amp;</span><span class="ident" id="5799251">n</span><span class="op" id="5799252">.</span><span class="ident" id="5799253">Int64</span><span class="op" id="5799258">,</span>&nbsp;<span class="ident" id="5799260">value</span><span class="op" id="5799265">)</span><br>
<span class="lineno"></span><span class="op" id="5799267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5799270">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno">115</span><span class="keyword" id="5799319">func</span>&nbsp;<span class="op" id="5799324">(</span><span class="ident" id="5799325">n</span>&nbsp;<span class="ident" id="5799327">NullInt64</span><span class="op" id="5799336">)</span>&nbsp;<span class="ident" id="5799338">Value</span><span class="op" id="5799343">(</span><span class="op" id="5799344">)</span>&nbsp;<span class="op" id="5799346">(</span><span class="ident" id="5799347">driver</span><span class="op" id="5799353">.</span><span class="ident" id="5799354">Value</span><span class="op" id="5799359">,</span>&nbsp;<span class="builtintype" id="5799361">error</span><span class="op" id="5799366">)</span>&nbsp;<span class="op" id="5799368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5799371">if</span>&nbsp;<span class="op" id="5799374">!</span><span class="ident" id="5799375">n</span><span class="op" id="5799376">.</span><span class="ident" id="5799377">Valid</span>&nbsp;<span class="op" id="5799383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5799387">return</span>&nbsp;<span class="ident" id="5799394">nil</span><span class="op" id="5799397">,</span>&nbsp;<span class="ident" id="5799399">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5799404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5799407">return</span>&nbsp;<span class="ident" id="5799414">n</span><span class="op" id="5799415">.</span><span class="ident" id="5799416">Int64</span><span class="op" id="5799421">,</span>&nbsp;<span class="ident" id="5799423">nil</span><br>
<span class="lineno">120</span><span class="op" id="5799427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5799430">//&nbsp;NullFloat64&nbsp;represents&nbsp;a&nbsp;float64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5799484">//&nbsp;NullFloat64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5799535">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno">125</span><span class="keyword" id="5799599">type</span>&nbsp;<span class="ident" id="5799604">NullFloat64</span>&nbsp;<span class="keyword" id="5799616">struct</span>&nbsp;<span class="op" id="5799623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799626">Float64</span>&nbsp;<span class="builtintype" id="5799634">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799643">Valid</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5799651">bool</span>&nbsp;<span class="comment" id="5799656">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Float64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5799696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="5799699">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5799741">func</span>&nbsp;<span class="op" id="5799746">(</span><span class="ident" id="5799747">n</span>&nbsp;<span class="op" id="5799749">*</span><span class="ident" id="5799750">NullFloat64</span><span class="op" id="5799761">)</span>&nbsp;<span class="ident" id="5799763">Scan</span><span class="op" id="5799767">(</span><span class="ident" id="5799768">value</span>&nbsp;<span class="keyword" id="5799774">interface</span><span class="op" id="5799783">{</span><span class="op" id="5799784">}</span><span class="op" id="5799785">)</span>&nbsp;<span class="builtintype" id="5799787">error</span>&nbsp;<span class="op" id="5799793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5799796">if</span>&nbsp;<span class="ident" id="5799799">value</span>&nbsp;<span class="op" id="5799805">==</span>&nbsp;<span class="ident" id="5799808">nil</span>&nbsp;<span class="op" id="5799812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799816">n</span><span class="op" id="5799817">.</span><span class="ident" id="5799818">Float64</span><span class="op" id="5799825">,</span>&nbsp;<span class="ident" id="5799827">n</span><span class="op" id="5799828">.</span><span class="ident" id="5799829">Valid</span>&nbsp;<span class="op" id="5799835">=</span>&nbsp;<span class="num" id="5799837">0</span><span class="op" id="5799838">,</span>&nbsp;<span class="builtintype" id="5799840">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5799848">return</span>&nbsp;<span class="ident" id="5799855">nil</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5799860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5799863">n</span><span class="op" id="5799864">.</span><span class="ident" id="5799865">Valid</span>&nbsp;<span class="op" id="5799871">=</span>&nbsp;<span class="builtintype" id="5799873">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5799879">return</span>&nbsp;<span class="ident" id="5799886">convertAssign</span><span class="op" id="5799899">(</span><span class="op" id="5799900">&amp;</span><span class="ident" id="5799901">n</span><span class="op" id="5799902">.</span><span class="ident" id="5799903">Float64</span><span class="op" id="5799910">,</span>&nbsp;<span class="ident" id="5799912">value</span><span class="op" id="5799917">)</span><br>
<span class="lineno"></span><span class="op" id="5799919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="5799922">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5799971">func</span>&nbsp;<span class="op" id="5799976">(</span><span class="ident" id="5799977">n</span>&nbsp;<span class="ident" id="5799979">NullFloat64</span><span class="op" id="5799990">)</span>&nbsp;<span class="ident" id="5799992">Value</span><span class="op" id="5799997">(</span><span class="op" id="5799998">)</span>&nbsp;<span class="op" id="5800000">(</span><span class="ident" id="5800001">driver</span><span class="op" id="5800007">.</span><span class="ident" id="5800008">Value</span><span class="op" id="5800013">,</span>&nbsp;<span class="builtintype" id="5800015">error</span><span class="op" id="5800020">)</span>&nbsp;<span class="op" id="5800022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5800025">if</span>&nbsp;<span class="op" id="5800028">!</span><span class="ident" id="5800029">n</span><span class="op" id="5800030">.</span><span class="ident" id="5800031">Valid</span>&nbsp;<span class="op" id="5800037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5800041">return</span>&nbsp;<span class="ident" id="5800048">nil</span><span class="op" id="5800051">,</span>&nbsp;<span class="ident" id="5800053">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5800058">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5800061">return</span>&nbsp;<span class="ident" id="5800068">n</span><span class="op" id="5800069">.</span><span class="ident" id="5800070">Float64</span><span class="op" id="5800077">,</span>&nbsp;<span class="ident" id="5800079">nil</span><br>
<span class="lineno"></span><span class="op" id="5800083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5800086">//&nbsp;NullBool&nbsp;represents&nbsp;a&nbsp;bool&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5800134">//&nbsp;NullBool&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="5800182">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="5800246">type</span>&nbsp;<span class="ident" id="5800251">NullBool</span>&nbsp;<span class="keyword" id="5800260">struct</span>&nbsp;<span class="op" id="5800267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800270">Bool</span>&nbsp;&nbsp;<span class="builtintype" id="5800276">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800282">Valid</span>&nbsp;<span class="builtintype" id="5800288">bool</span>&nbsp;<span class="comment" id="5800293">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Bool&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5800330">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5800333">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5800375">func</span>&nbsp;<span class="op" id="5800380">(</span><span class="ident" id="5800381">n</span>&nbsp;<span class="op" id="5800383">*</span><span class="ident" id="5800384">NullBool</span><span class="op" id="5800392">)</span>&nbsp;<span class="ident" id="5800394">Scan</span><span class="op" id="5800398">(</span><span class="ident" id="5800399">value</span>&nbsp;<span class="keyword" id="5800405">interface</span><span class="op" id="5800414">{</span><span class="op" id="5800415">}</span><span class="op" id="5800416">)</span>&nbsp;<span class="builtintype" id="5800418">error</span>&nbsp;<span class="op" id="5800424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5800427">if</span>&nbsp;<span class="ident" id="5800430">value</span>&nbsp;<span class="op" id="5800436">==</span>&nbsp;<span class="ident" id="5800439">nil</span>&nbsp;<span class="op" id="5800443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800447">n</span><span class="op" id="5800448">.</span><span class="ident" id="5800449">Bool</span><span class="op" id="5800453">,</span>&nbsp;<span class="ident" id="5800455">n</span><span class="op" id="5800456">.</span><span class="ident" id="5800457">Valid</span>&nbsp;<span class="op" id="5800463">=</span>&nbsp;<span class="builtintype" id="5800465">false</span><span class="op" id="5800470">,</span>&nbsp;<span class="builtintype" id="5800472">false</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5800480">return</span>&nbsp;<span class="ident" id="5800487">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5800492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5800495">n</span><span class="op" id="5800496">.</span><span class="ident" id="5800497">Valid</span>&nbsp;<span class="op" id="5800503">=</span>&nbsp;<span class="builtintype" id="5800505">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5800511">return</span>&nbsp;<span class="ident" id="5800518">convertAssign</span><span class="op" id="5800531">(</span><span class="op" id="5800532">&amp;</span><span class="ident" id="5800533">n</span><span class="op" id="5800534">.</span><span class="ident" id="5800535">Bool</span><span class="op" id="5800539">,</span>&nbsp;<span class="ident" id="5800541">value</span><span class="op" id="5800546">)</span><br>
<span class="lineno"></span><span class="op" id="5800548">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="5800551">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5800600">func</span>&nbsp;<span class="op" id="5800605">(</span><span class="ident" id="5800606">n</span>&nbsp;<span class="ident" id="5800608">NullBool</span><span class="op" id="5800616">)</span>&nbsp;<span class="ident" id="5800618">Value</span><span class="op" id="5800623">(</span><span class="op" id="5800624">)</span>&nbsp;<span class="op" id="5800626">(</span><span class="ident" id="5800627">driver</span><span class="op" id="5800633">.</span><span class="ident" id="5800634">Value</span><span class="op" id="5800639">,</span>&nbsp;<span class="builtintype" id="5800641">error</span><span class="op" id="5800646">)</span>&nbsp;<span class="op" id="5800648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5800651">if</span>&nbsp;<span class="op" id="5800654">!</span><span class="ident" id="5800655">n</span><span class="op" id="5800656">.</span><span class="ident" id="5800657">Valid</span>&nbsp;<span class="op" id="5800663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5800667">return</span>&nbsp;<span class="ident" id="5800674">nil</span><span class="op" id="5800677">,</span>&nbsp;<span class="ident" id="5800679">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5800684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5800687">return</span>&nbsp;<span class="ident" id="5800694">n</span><span class="op" id="5800695">.</span><span class="ident" id="5800696">Bool</span><span class="op" id="5800700">,</span>&nbsp;<span class="ident" id="5800702">nil</span><br>
<span class="lineno"></span><span class="op" id="5800706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5800709">//&nbsp;Scanner&nbsp;is&nbsp;an&nbsp;interface&nbsp;used&nbsp;by&nbsp;Scan.</span><br>
<span class="lineno">175</span><span class="keyword" id="5800750">type</span>&nbsp;<span class="ident" id="5800755">Scanner</span>&nbsp;<span class="keyword" id="5800763">interface</span>&nbsp;<span class="op" id="5800773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800776">//&nbsp;Scan&nbsp;assigns&nbsp;a&nbsp;value&nbsp;from&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800825">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800829">//&nbsp;The&nbsp;src&nbsp;value&nbsp;will&nbsp;be&nbsp;of&nbsp;one&nbsp;of&nbsp;the&nbsp;following&nbsp;restricted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800890">//&nbsp;set&nbsp;of&nbsp;types:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800908">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800912">//&nbsp;&nbsp;&nbsp;&nbsp;int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800925">//&nbsp;&nbsp;&nbsp;&nbsp;float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800940">//&nbsp;&nbsp;&nbsp;&nbsp;bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800952">//&nbsp;&nbsp;&nbsp;&nbsp;[]byte</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800966">//&nbsp;&nbsp;&nbsp;&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800980">//&nbsp;&nbsp;&nbsp;&nbsp;time.Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5800997">//&nbsp;&nbsp;&nbsp;&nbsp;nil&nbsp;-&nbsp;for&nbsp;NULL&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5801026">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5801030">//&nbsp;An&nbsp;error&nbsp;should&nbsp;be&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;can&nbsp;not&nbsp;be&nbsp;stored</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5801093">//&nbsp;without&nbsp;loss&nbsp;of&nbsp;information.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5801126">Scan</span><span class="op" id="5801130">(</span><span class="ident" id="5801131">src</span>&nbsp;<span class="keyword" id="5801135">interface</span><span class="op" id="5801144">{</span><span class="op" id="5801145">}</span><span class="op" id="5801146">)</span>&nbsp;<span class="builtintype" id="5801148">error</span><br>
<span class="lineno"></span><span class="op" id="5801154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5801157">//&nbsp;ErrNoRows&nbsp;is&nbsp;returned&nbsp;by&nbsp;Scan&nbsp;when&nbsp;QueryRow&nbsp;doesn&#39;t&nbsp;return&nbsp;a</span><br>
<span class="lineno">195</span><span class="comment" id="5801221">//&nbsp;row.&nbsp;In&nbsp;such&nbsp;a&nbsp;case,&nbsp;QueryRow&nbsp;returns&nbsp;a&nbsp;placeholder&nbsp;*Row&nbsp;value&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5801292">//&nbsp;defers&nbsp;this&nbsp;error&nbsp;until&nbsp;a&nbsp;Scan.</span><br>
<span class="lineno"></span><span class="keyword" id="5801327">var</span>&nbsp;<span class="ident" id="5801331">ErrNoRows</span>&nbsp;<span class="op" id="5801341">=</span>&nbsp;<span class="ident" id="5801343">errors</span><span class="op" id="5801349">.</span><span class="ident" id="5801350">New</span><span class="op" id="5801353">(</span><span class="string" id="5801354">&#34;sql:&nbsp;no&nbsp;rows&nbsp;in&nbsp;result&nbsp;set&#34;</span><span class="op" id="5801382">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5801385">//&nbsp;DB&nbsp;is&nbsp;a&nbsp;database&nbsp;handle&nbsp;representing&nbsp;a&nbsp;pool&nbsp;of&nbsp;zero&nbsp;or&nbsp;more</span><br>
<span class="lineno">200</span><span class="comment" id="5801448">//&nbsp;underlying&nbsp;connections.&nbsp;It&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple</span><br>
<span class="lineno"></span><span class="comment" id="5801516">//&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="5801531">//</span><br>
<span class="lineno"></span><span class="comment" id="5801534">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;creates&nbsp;and&nbsp;frees&nbsp;connections&nbsp;automatically;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5801601">//&nbsp;also&nbsp;maintains&nbsp;a&nbsp;free&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;If&nbsp;the&nbsp;database&nbsp;has</span><br>
<span class="lineno">205</span><span class="comment" id="5801672">//&nbsp;a&nbsp;concept&nbsp;of&nbsp;per-connection&nbsp;state,&nbsp;such&nbsp;state&nbsp;can&nbsp;only&nbsp;be&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="5801742">//&nbsp;observed&nbsp;within&nbsp;a&nbsp;transaction.&nbsp;Once&nbsp;DB.Begin&nbsp;is&nbsp;called,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5801805">//&nbsp;returned&nbsp;Tx&nbsp;is&nbsp;bound&nbsp;to&nbsp;a&nbsp;single&nbsp;connection.&nbsp;Once&nbsp;Commit&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5801868">//&nbsp;Rollback&nbsp;is&nbsp;called&nbsp;on&nbsp;the&nbsp;transaction,&nbsp;that&nbsp;transaction&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="5801929">//&nbsp;connection&nbsp;is&nbsp;returned&nbsp;to&nbsp;DB&#39;s&nbsp;idle&nbsp;connection&nbsp;pool.&nbsp;The&nbsp;pool&nbsp;size</span><br>
<span class="lineno">210</span><span class="comment" id="5801999">//&nbsp;can&nbsp;be&nbsp;controlled&nbsp;with&nbsp;SetMaxIdleConns.</span><br>
<span class="lineno"></span><span class="keyword" id="5802042">type</span>&nbsp;<span class="ident" id="5802047">DB</span>&nbsp;<span class="keyword" id="5802050">struct</span>&nbsp;<span class="op" id="5802057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802060">driver</span>&nbsp;<span class="ident" id="5802067">driver</span><span class="op" id="5802073">.</span><span class="ident" id="5802074">Driver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802082">dsn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5802089">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802098">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802111">sync</span><span class="op" id="5802115">.</span><span class="ident" id="5802116">Mutex</span>&nbsp;<span class="comment" id="5802122">//&nbsp;protects&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802152">freeConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5802165">[</span><span class="op" id="5802166">]</span><span class="op" id="5802167">*</span><span class="ident" id="5802168">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802180">connRequests</span>&nbsp;<span class="op" id="5802193">[</span><span class="op" id="5802194">]</span><span class="keyword" id="5802195">chan</span>&nbsp;<span class="ident" id="5802200">connRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802213">numOpen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5802226">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802231">pendingOpens</span>&nbsp;<span class="builtintype" id="5802244">int</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5802249">//&nbsp;Used&nbsp;to&nbsp;signal&nbsp;the&nbsp;need&nbsp;for&nbsp;new&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5802297">//&nbsp;a&nbsp;goroutine&nbsp;running&nbsp;connectionOpener()&nbsp;reads&nbsp;on&nbsp;this&nbsp;chan&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5802363">//&nbsp;maybeOpenNewConnections&nbsp;sends&nbsp;on&nbsp;the&nbsp;chan&nbsp;(one&nbsp;send&nbsp;per&nbsp;needed&nbsp;connection)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5802442">//&nbsp;It&nbsp;is&nbsp;closed&nbsp;during&nbsp;db.Close().&nbsp;The&nbsp;close&nbsp;tells&nbsp;the&nbsp;connectionOpener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5802515">//&nbsp;goroutine&nbsp;to&nbsp;exit.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802538">openerCh</span>&nbsp;<span class="keyword" id="5802547">chan</span>&nbsp;<span class="keyword" id="5802552">struct</span><span class="op" id="5802558">{</span><span class="op" id="5802559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802562">closed</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5802571">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802577">dep</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5802586">map</span><span class="op" id="5802589">[</span><span class="ident" id="5802590">finalCloser</span><span class="op" id="5802601">]</span><span class="ident" id="5802602">depSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802610">lastPut</span>&nbsp;&nbsp;<span class="keyword" id="5802619">map</span><span class="op" id="5802622">[</span><span class="op" id="5802623">*</span><span class="ident" id="5802624">driverConn</span><span class="op" id="5802634">]</span><span class="builtintype" id="5802635">string</span>&nbsp;<span class="comment" id="5802642">//&nbsp;stacktrace&nbsp;of&nbsp;last&nbsp;conn&#39;s&nbsp;put;&nbsp;debug&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802688">maxIdle</span>&nbsp;&nbsp;<span class="builtintype" id="5802697">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5802720">//&nbsp;zero&nbsp;means&nbsp;defaultMaxIdleConns;&nbsp;negative&nbsp;means&nbsp;0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5802773">maxOpen</span>&nbsp;&nbsp;<span class="builtintype" id="5802782">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5802805">//&nbsp;&lt;=&nbsp;0&nbsp;means&nbsp;unlimited</span><br>
<span class="lineno"></span><span class="op" id="5802829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5802832">//&nbsp;driverConn&nbsp;wraps&nbsp;a&nbsp;driver.Conn&nbsp;with&nbsp;a&nbsp;mutex,&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5802883">//&nbsp;be&nbsp;held&nbsp;during&nbsp;all&nbsp;calls&nbsp;into&nbsp;the&nbsp;Conn.&nbsp;(including&nbsp;any&nbsp;calls&nbsp;onto</span><br>
<span class="lineno">235</span><span class="comment" id="5802952">//&nbsp;interfaces&nbsp;returned&nbsp;via&nbsp;that&nbsp;Conn,&nbsp;such&nbsp;as&nbsp;calls&nbsp;on&nbsp;Tx,&nbsp;Stmt,</span><br>
<span class="lineno"></span><span class="comment" id="5803017">//&nbsp;Result,&nbsp;Rows)</span><br>
<span class="lineno"></span><span class="keyword" id="5803034">type</span>&nbsp;<span class="ident" id="5803039">driverConn</span>&nbsp;<span class="keyword" id="5803050">struct</span>&nbsp;<span class="op" id="5803057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803060">db</span>&nbsp;<span class="op" id="5803063">*</span><span class="ident" id="5803064">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803069">sync</span><span class="op" id="5803073">.</span><span class="ident" id="5803074">Mutex</span>&nbsp;&nbsp;<span class="comment" id="5803081">//&nbsp;guards&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803102">ci</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5803114">driver</span><span class="op" id="5803120">.</span><span class="ident" id="5803121">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803127">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5803139">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803145">finalClosed</span>&nbsp;<span class="builtintype" id="5803157">bool</span>&nbsp;<span class="comment" id="5803162">//&nbsp;ci.Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803191">openStmt</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5803203">map</span><span class="op" id="5803206">[</span><span class="ident" id="5803207">driver</span><span class="op" id="5803213">.</span><span class="ident" id="5803214">Stmt</span><span class="op" id="5803218">]</span><span class="builtintype" id="5803219">bool</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5803226">//&nbsp;guarded&nbsp;by&nbsp;db.mu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803247">inUse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5803258">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803264">onPut</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5803275">[</span><span class="op" id="5803276">]</span><span class="keyword" id="5803277">func</span><span class="op" id="5803281">(</span><span class="op" id="5803282">)</span>&nbsp;<span class="comment" id="5803284">//&nbsp;code&nbsp;(with&nbsp;db.mu&nbsp;held)&nbsp;run&nbsp;when&nbsp;conn&nbsp;is&nbsp;next&nbsp;returned</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803342">dbmuClosed</span>&nbsp;<span class="builtintype" id="5803353">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5803362">//&nbsp;same&nbsp;as&nbsp;closed,&nbsp;but&nbsp;guarded&nbsp;by&nbsp;db.mu,&nbsp;for&nbsp;connIfFree</span><br>
<span class="lineno">250</span><span class="op" id="5803418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5803421">func</span>&nbsp;<span class="op" id="5803426">(</span><span class="ident" id="5803427">dc</span>&nbsp;<span class="op" id="5803430">*</span><span class="ident" id="5803431">driverConn</span><span class="op" id="5803441">)</span>&nbsp;<span class="ident" id="5803443">releaseConn</span><span class="op" id="5803454">(</span><span class="ident" id="5803455">err</span>&nbsp;<span class="builtintype" id="5803459">error</span><span class="op" id="5803464">)</span>&nbsp;<span class="op" id="5803466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803469">dc</span><span class="op" id="5803471">.</span><span class="ident" id="5803472">db</span><span class="op" id="5803474">.</span><span class="ident" id="5803475">putConn</span><span class="op" id="5803482">(</span><span class="ident" id="5803483">dc</span><span class="op" id="5803485">,</span>&nbsp;<span class="ident" id="5803487">err</span><span class="op" id="5803490">)</span><br>
<span class="lineno"></span><span class="op" id="5803492">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="5803495">func</span>&nbsp;<span class="op" id="5803500">(</span><span class="ident" id="5803501">dc</span>&nbsp;<span class="op" id="5803504">*</span><span class="ident" id="5803505">driverConn</span><span class="op" id="5803515">)</span>&nbsp;<span class="ident" id="5803517">removeOpenStmt</span><span class="op" id="5803531">(</span><span class="ident" id="5803532">si</span>&nbsp;<span class="ident" id="5803535">driver</span><span class="op" id="5803541">.</span><span class="ident" id="5803542">Stmt</span><span class="op" id="5803546">)</span>&nbsp;<span class="op" id="5803548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803551">dc</span><span class="op" id="5803553">.</span><span class="ident" id="5803554">Lock</span><span class="op" id="5803558">(</span><span class="op" id="5803559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803562">defer</span>&nbsp;<span class="ident" id="5803568">dc</span><span class="op" id="5803570">.</span><span class="ident" id="5803571">Unlock</span><span class="op" id="5803577">(</span><span class="op" id="5803578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5803581">delete</span><span class="op" id="5803587">(</span><span class="ident" id="5803588">dc</span><span class="op" id="5803590">.</span><span class="ident" id="5803591">openStmt</span><span class="op" id="5803599">,</span>&nbsp;<span class="ident" id="5803601">si</span><span class="op" id="5803603">)</span><br>
<span class="lineno">260</span><span class="op" id="5803605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5803608">func</span>&nbsp;<span class="op" id="5803613">(</span><span class="ident" id="5803614">dc</span>&nbsp;<span class="op" id="5803617">*</span><span class="ident" id="5803618">driverConn</span><span class="op" id="5803628">)</span>&nbsp;<span class="ident" id="5803630">prepareLocked</span><span class="op" id="5803643">(</span><span class="ident" id="5803644">query</span>&nbsp;<span class="builtintype" id="5803650">string</span><span class="op" id="5803656">)</span>&nbsp;<span class="op" id="5803658">(</span><span class="ident" id="5803659">driver</span><span class="op" id="5803665">.</span><span class="ident" id="5803666">Stmt</span><span class="op" id="5803670">,</span>&nbsp;<span class="builtintype" id="5803672">error</span><span class="op" id="5803677">)</span>&nbsp;<span class="op" id="5803679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5803682">si</span><span class="op" id="5803684">,</span>&nbsp;<span class="ident" id="5803686">err</span>&nbsp;<span class="op" id="5803690">:=</span>&nbsp;<span class="ident" id="5803693">dc</span><span class="op" id="5803695">.</span><span class="ident" id="5803696">ci</span><span class="op" id="5803698">.</span><span class="ident" id="5803699">Prepare</span><span class="op" id="5803706">(</span><span class="ident" id="5803707">query</span><span class="op" id="5803712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5803715">if</span>&nbsp;<span class="ident" id="5803718">err</span>&nbsp;<span class="op" id="5803722">==</span>&nbsp;<span class="ident" id="5803725">nil</span>&nbsp;<span class="op" id="5803729">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5803733">//&nbsp;Track&nbsp;each&nbsp;driverConn&#39;s&nbsp;open&nbsp;statements,&nbsp;so&nbsp;we&nbsp;can&nbsp;close&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5803800">//&nbsp;before&nbsp;closing&nbsp;the&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5803830">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5803835">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;drivers&nbsp;opt&nbsp;out&nbsp;of&nbsp;caring&nbsp;about</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5803892">//&nbsp;stmt&nbsp;closes&nbsp;if&nbsp;the&nbsp;conn&nbsp;is&nbsp;about&nbsp;to&nbsp;close&nbsp;anyway?&nbsp;For&nbsp;now</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5803955">//&nbsp;do&nbsp;the&nbsp;safe&nbsp;thing,&nbsp;in&nbsp;case&nbsp;stmts&nbsp;need&nbsp;to&nbsp;be&nbsp;closed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5804012">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5804017">//&nbsp;TODO(bradfitz):&nbsp;after&nbsp;Go&nbsp;1.2,&nbsp;closing&nbsp;driver.Stmts</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5804073">//&nbsp;should&nbsp;be&nbsp;moved&nbsp;to&nbsp;driverStmt,&nbsp;using&nbsp;unique</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5804122">//&nbsp;*driverStmts&nbsp;everywhere&nbsp;(including&nbsp;from</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5804167">//&nbsp;*Stmt.connStmt,&nbsp;instead&nbsp;of&nbsp;returning&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5804211">//&nbsp;driver.Stmt),&nbsp;using&nbsp;driverStmt&nbsp;as&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5804260">//&nbsp;everywhere,&nbsp;and&nbsp;making&nbsp;it&nbsp;a&nbsp;finalCloser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804306">if</span>&nbsp;<span class="ident" id="5804309">dc</span><span class="op" id="5804311">.</span><span class="ident" id="5804312">openStmt</span>&nbsp;<span class="op" id="5804321">==</span>&nbsp;<span class="ident" id="5804324">nil</span>&nbsp;<span class="op" id="5804328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804333">dc</span><span class="op" id="5804335">.</span><span class="ident" id="5804336">openStmt</span>&nbsp;<span class="op" id="5804345">=</span>&nbsp;<span class="builtinfunc" id="5804347">make</span><span class="op" id="5804351">(</span><span class="keyword" id="5804352">map</span><span class="op" id="5804355">[</span><span class="ident" id="5804356">driver</span><span class="op" id="5804362">.</span><span class="ident" id="5804363">Stmt</span><span class="op" id="5804367">]</span><span class="builtintype" id="5804368">bool</span><span class="op" id="5804372">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804380">dc</span><span class="op" id="5804382">.</span><span class="ident" id="5804383">openStmt</span><span class="op" id="5804391">[</span><span class="ident" id="5804392">si</span><span class="op" id="5804394">]</span>&nbsp;<span class="op" id="5804396">=</span>&nbsp;<span class="builtintype" id="5804398">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804407">return</span>&nbsp;<span class="ident" id="5804414">si</span><span class="op" id="5804416">,</span>&nbsp;<span class="ident" id="5804418">err</span><br>
<span class="lineno"></span><span class="op" id="5804422">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="5804425">//&nbsp;the&nbsp;dc.db&#39;s&nbsp;Mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="5804455">func</span>&nbsp;<span class="op" id="5804460">(</span><span class="ident" id="5804461">dc</span>&nbsp;<span class="op" id="5804464">*</span><span class="ident" id="5804465">driverConn</span><span class="op" id="5804475">)</span>&nbsp;<span class="ident" id="5804477">closeDBLocked</span><span class="op" id="5804490">(</span><span class="op" id="5804491">)</span>&nbsp;<span class="keyword" id="5804493">func</span><span class="op" id="5804497">(</span><span class="op" id="5804498">)</span>&nbsp;<span class="builtintype" id="5804500">error</span>&nbsp;<span class="op" id="5804506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804509">dc</span><span class="op" id="5804511">.</span><span class="ident" id="5804512">Lock</span><span class="op" id="5804516">(</span><span class="op" id="5804517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804520">defer</span>&nbsp;<span class="ident" id="5804526">dc</span><span class="op" id="5804528">.</span><span class="ident" id="5804529">Unlock</span><span class="op" id="5804535">(</span><span class="op" id="5804536">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804539">if</span>&nbsp;<span class="ident" id="5804542">dc</span><span class="op" id="5804544">.</span><span class="ident" id="5804545">closed</span>&nbsp;<span class="op" id="5804552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804556">return</span>&nbsp;<span class="keyword" id="5804563">func</span><span class="op" id="5804567">(</span><span class="op" id="5804568">)</span>&nbsp;<span class="builtintype" id="5804570">error</span>&nbsp;<span class="op" id="5804576">{</span>&nbsp;<span class="keyword" id="5804578">return</span>&nbsp;<span class="ident" id="5804585">errors</span><span class="op" id="5804591">.</span><span class="ident" id="5804592">New</span><span class="op" id="5804595">(</span><span class="string" id="5804596">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="5804629">)</span>&nbsp;<span class="op" id="5804631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804637">dc</span><span class="op" id="5804639">.</span><span class="ident" id="5804640">closed</span>&nbsp;<span class="op" id="5804647">=</span>&nbsp;<span class="builtintype" id="5804649">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804655">return</span>&nbsp;<span class="ident" id="5804662">dc</span><span class="op" id="5804664">.</span><span class="ident" id="5804665">db</span><span class="op" id="5804667">.</span><span class="ident" id="5804668">removeDepLocked</span><span class="op" id="5804683">(</span><span class="ident" id="5804684">dc</span><span class="op" id="5804686">,</span>&nbsp;<span class="ident" id="5804688">dc</span><span class="op" id="5804690">)</span><br>
<span class="lineno">295</span><span class="op" id="5804692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5804695">func</span>&nbsp;<span class="op" id="5804700">(</span><span class="ident" id="5804701">dc</span>&nbsp;<span class="op" id="5804704">*</span><span class="ident" id="5804705">driverConn</span><span class="op" id="5804715">)</span>&nbsp;<span class="ident" id="5804717">Close</span><span class="op" id="5804722">(</span><span class="op" id="5804723">)</span>&nbsp;<span class="builtintype" id="5804725">error</span>&nbsp;<span class="op" id="5804731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804734">dc</span><span class="op" id="5804736">.</span><span class="ident" id="5804737">Lock</span><span class="op" id="5804741">(</span><span class="op" id="5804742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804745">if</span>&nbsp;<span class="ident" id="5804748">dc</span><span class="op" id="5804750">.</span><span class="ident" id="5804751">closed</span>&nbsp;<span class="op" id="5804758">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804762">dc</span><span class="op" id="5804764">.</span><span class="ident" id="5804765">Unlock</span><span class="op" id="5804771">(</span><span class="op" id="5804772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5804776">return</span>&nbsp;<span class="ident" id="5804783">errors</span><span class="op" id="5804789">.</span><span class="ident" id="5804790">New</span><span class="op" id="5804793">(</span><span class="string" id="5804794">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="5804827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5804830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804833">dc</span><span class="op" id="5804835">.</span><span class="ident" id="5804836">closed</span>&nbsp;<span class="op" id="5804843">=</span>&nbsp;<span class="builtintype" id="5804845">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804851">dc</span><span class="op" id="5804853">.</span><span class="ident" id="5804854">Unlock</span><span class="op" id="5804860">(</span><span class="op" id="5804861">)</span>&nbsp;<span class="comment" id="5804863">//&nbsp;not&nbsp;defer;&nbsp;removeDep&nbsp;finalClose&nbsp;calls&nbsp;may&nbsp;need&nbsp;to&nbsp;lock</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5804923">//&nbsp;And&nbsp;now&nbsp;updates&nbsp;that&nbsp;require&nbsp;holding&nbsp;dc.mu.Lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804976">dc</span><span class="op" id="5804978">.</span><span class="ident" id="5804979">db</span><span class="op" id="5804981">.</span><span class="ident" id="5804982">mu</span><span class="op" id="5804984">.</span><span class="ident" id="5804985">Lock</span><span class="op" id="5804989">(</span><span class="op" id="5804990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5804993">dc</span><span class="op" id="5804995">.</span><span class="ident" id="5804996">dbmuClosed</span>&nbsp;<span class="op" id="5805007">=</span>&nbsp;<span class="builtintype" id="5805009">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805015">fn</span>&nbsp;<span class="op" id="5805018">:=</span>&nbsp;<span class="ident" id="5805021">dc</span><span class="op" id="5805023">.</span><span class="ident" id="5805024">db</span><span class="op" id="5805026">.</span><span class="ident" id="5805027">removeDepLocked</span><span class="op" id="5805042">(</span><span class="ident" id="5805043">dc</span><span class="op" id="5805045">,</span>&nbsp;<span class="ident" id="5805047">dc</span><span class="op" id="5805049">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805052">dc</span><span class="op" id="5805054">.</span><span class="ident" id="5805055">db</span><span class="op" id="5805057">.</span><span class="ident" id="5805058">mu</span><span class="op" id="5805060">.</span><span class="ident" id="5805061">Unlock</span><span class="op" id="5805067">(</span><span class="op" id="5805068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805071">return</span>&nbsp;<span class="ident" id="5805078">fn</span><span class="op" id="5805080">(</span><span class="op" id="5805081">)</span><br>
<span class="lineno"></span><span class="op" id="5805083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5805086">func</span>&nbsp;<span class="op" id="5805091">(</span><span class="ident" id="5805092">dc</span>&nbsp;<span class="op" id="5805095">*</span><span class="ident" id="5805096">driverConn</span><span class="op" id="5805106">)</span>&nbsp;<span class="ident" id="5805108">finalClose</span><span class="op" id="5805118">(</span><span class="op" id="5805119">)</span>&nbsp;<span class="builtintype" id="5805121">error</span>&nbsp;<span class="op" id="5805127">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805130">dc</span><span class="op" id="5805132">.</span><span class="ident" id="5805133">Lock</span><span class="op" id="5805137">(</span><span class="op" id="5805138">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805142">for</span>&nbsp;<span class="ident" id="5805146">si</span>&nbsp;<span class="op" id="5805149">:=</span>&nbsp;<span class="keyword" id="5805152">range</span>&nbsp;<span class="ident" id="5805158">dc</span><span class="op" id="5805160">.</span><span class="ident" id="5805161">openStmt</span>&nbsp;<span class="op" id="5805170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805174">si</span><span class="op" id="5805176">.</span><span class="ident" id="5805177">Close</span><span class="op" id="5805182">(</span><span class="op" id="5805183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5805186">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805189">dc</span><span class="op" id="5805191">.</span><span class="ident" id="5805192">openStmt</span>&nbsp;<span class="op" id="5805201">=</span>&nbsp;<span class="ident" id="5805203">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805209">err</span>&nbsp;<span class="op" id="5805213">:=</span>&nbsp;<span class="ident" id="5805216">dc</span><span class="op" id="5805218">.</span><span class="ident" id="5805219">ci</span><span class="op" id="5805221">.</span><span class="ident" id="5805222">Close</span><span class="op" id="5805227">(</span><span class="op" id="5805228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805231">dc</span><span class="op" id="5805233">.</span><span class="ident" id="5805234">ci</span>&nbsp;<span class="op" id="5805237">=</span>&nbsp;<span class="ident" id="5805239">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805244">dc</span><span class="op" id="5805246">.</span><span class="ident" id="5805247">finalClosed</span>&nbsp;<span class="op" id="5805259">=</span>&nbsp;<span class="builtintype" id="5805261">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805267">dc</span><span class="op" id="5805269">.</span><span class="ident" id="5805270">Unlock</span><span class="op" id="5805276">(</span><span class="op" id="5805277">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805281">dc</span><span class="op" id="5805283">.</span><span class="ident" id="5805284">db</span><span class="op" id="5805286">.</span><span class="ident" id="5805287">mu</span><span class="op" id="5805289">.</span><span class="ident" id="5805290">Lock</span><span class="op" id="5805294">(</span><span class="op" id="5805295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805298">dc</span><span class="op" id="5805300">.</span><span class="ident" id="5805301">db</span><span class="op" id="5805303">.</span><span class="ident" id="5805304">numOpen</span><span class="op" id="5805311">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805315">dc</span><span class="op" id="5805317">.</span><span class="ident" id="5805318">db</span><span class="op" id="5805320">.</span><span class="ident" id="5805321">maybeOpenNewConnections</span><span class="op" id="5805344">(</span><span class="op" id="5805345">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805348">dc</span><span class="op" id="5805350">.</span><span class="ident" id="5805351">db</span><span class="op" id="5805353">.</span><span class="ident" id="5805354">mu</span><span class="op" id="5805356">.</span><span class="ident" id="5805357">Unlock</span><span class="op" id="5805363">(</span><span class="op" id="5805364">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805368">return</span>&nbsp;<span class="ident" id="5805375">err</span><br>
<span class="lineno"></span><span class="op" id="5805379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="5805382">//&nbsp;driverStmt&nbsp;associates&nbsp;a&nbsp;driver.Stmt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5805430">//&nbsp;*driverConn&nbsp;from&nbsp;which&nbsp;it&nbsp;came,&nbsp;so&nbsp;the&nbsp;driverConn&#39;s&nbsp;lock&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5805497">//&nbsp;held&nbsp;during&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="5805519">type</span>&nbsp;<span class="ident" id="5805524">driverStmt</span>&nbsp;<span class="keyword" id="5805535">struct</span>&nbsp;<span class="op" id="5805542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805545">sync</span><span class="op" id="5805549">.</span><span class="ident" id="5805550">Locker</span>&nbsp;<span class="comment" id="5805557">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805577">si</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5805589">driver</span><span class="op" id="5805595">.</span><span class="ident" id="5805596">Stmt</span><br>
<span class="lineno"></span><span class="op" id="5805601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5805604">func</span>&nbsp;<span class="op" id="5805609">(</span><span class="ident" id="5805610">ds</span>&nbsp;<span class="op" id="5805613">*</span><span class="ident" id="5805614">driverStmt</span><span class="op" id="5805624">)</span>&nbsp;<span class="ident" id="5805626">Close</span><span class="op" id="5805631">(</span><span class="op" id="5805632">)</span>&nbsp;<span class="builtintype" id="5805634">error</span>&nbsp;<span class="op" id="5805640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5805643">ds</span><span class="op" id="5805645">.</span><span class="ident" id="5805646">Lock</span><span class="op" id="5805650">(</span><span class="op" id="5805651">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805654">defer</span>&nbsp;<span class="ident" id="5805660">ds</span><span class="op" id="5805662">.</span><span class="ident" id="5805663">Unlock</span><span class="op" id="5805669">(</span><span class="op" id="5805670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5805673">return</span>&nbsp;<span class="ident" id="5805680">ds</span><span class="op" id="5805682">.</span><span class="ident" id="5805683">si</span><span class="op" id="5805685">.</span><span class="ident" id="5805686">Close</span><span class="op" id="5805691">(</span><span class="op" id="5805692">)</span><br>
<span class="lineno"></span><span class="op" id="5805694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5805697">//&nbsp;depSet&nbsp;is&nbsp;a&nbsp;finalCloser&#39;s&nbsp;outstanding&nbsp;dependencies</span><br>
<span class="lineno">350</span><span class="keyword" id="5805751">type</span>&nbsp;<span class="ident" id="5805756">depSet</span>&nbsp;<span class="keyword" id="5805763">map</span><span class="op" id="5805766">[</span><span class="keyword" id="5805767">interface</span><span class="op" id="5805776">{</span><span class="op" id="5805777">}</span><span class="op" id="5805778">]</span><span class="builtintype" id="5805779">bool</span>&nbsp;<span class="comment" id="5805784">//&nbsp;set&nbsp;of&nbsp;true&nbsp;bools</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5805806">//&nbsp;The&nbsp;finalCloser&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;(*DB).addDep&nbsp;and&nbsp;related</span><br>
<span class="lineno"></span><span class="comment" id="5805871">//&nbsp;dependency&nbsp;reference&nbsp;counting.</span><br>
<span class="lineno"></span><span class="keyword" id="5805905">type</span>&nbsp;<span class="ident" id="5805910">finalCloser</span>&nbsp;<span class="keyword" id="5805922">interface</span>&nbsp;<span class="op" id="5805932">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5805935">//&nbsp;finalClose&nbsp;is&nbsp;called&nbsp;when&nbsp;the&nbsp;reference&nbsp;count&nbsp;of&nbsp;an&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5805998">//&nbsp;goes&nbsp;to&nbsp;zero.&nbsp;(*DB).mu&nbsp;is&nbsp;not&nbsp;held&nbsp;while&nbsp;calling&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806055">finalClose</span><span class="op" id="5806065">(</span><span class="op" id="5806066">)</span>&nbsp;<span class="builtintype" id="5806068">error</span><br>
<span class="lineno"></span><span class="op" id="5806074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="comment" id="5806077">//&nbsp;addDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;now&nbsp;depends&nbsp;on&nbsp;dep,&nbsp;and&nbsp;x&#39;s&nbsp;finalClose&nbsp;won&#39;t&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5806148">//&nbsp;called&nbsp;until&nbsp;all&nbsp;of&nbsp;x&#39;s&nbsp;dependencies&nbsp;are&nbsp;removed&nbsp;with&nbsp;removeDep.</span><br>
<span class="lineno"></span><span class="keyword" id="5806216">func</span>&nbsp;<span class="op" id="5806221">(</span><span class="ident" id="5806222">db</span>&nbsp;<span class="op" id="5806225">*</span><span class="ident" id="5806226">DB</span><span class="op" id="5806228">)</span>&nbsp;<span class="ident" id="5806230">addDep</span><span class="op" id="5806236">(</span><span class="ident" id="5806237">x</span>&nbsp;<span class="ident" id="5806239">finalCloser</span><span class="op" id="5806250">,</span>&nbsp;<span class="ident" id="5806252">dep</span>&nbsp;<span class="keyword" id="5806256">interface</span><span class="op" id="5806265">{</span><span class="op" id="5806266">}</span><span class="op" id="5806267">)</span>&nbsp;<span class="op" id="5806269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5806272">//println(fmt.Sprintf(&#34;addDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806336">db</span><span class="op" id="5806338">.</span><span class="ident" id="5806339">mu</span><span class="op" id="5806341">.</span><span class="ident" id="5806342">Lock</span><span class="op" id="5806346">(</span><span class="op" id="5806347">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806350">defer</span>&nbsp;<span class="ident" id="5806356">db</span><span class="op" id="5806358">.</span><span class="ident" id="5806359">mu</span><span class="op" id="5806361">.</span><span class="ident" id="5806362">Unlock</span><span class="op" id="5806368">(</span><span class="op" id="5806369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806372">db</span><span class="op" id="5806374">.</span><span class="ident" id="5806375">addDepLocked</span><span class="op" id="5806387">(</span><span class="ident" id="5806388">x</span><span class="op" id="5806389">,</span>&nbsp;<span class="ident" id="5806391">dep</span><span class="op" id="5806394">)</span><br>
<span class="lineno"></span><span class="op" id="5806396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5806399">func</span>&nbsp;<span class="op" id="5806404">(</span><span class="ident" id="5806405">db</span>&nbsp;<span class="op" id="5806408">*</span><span class="ident" id="5806409">DB</span><span class="op" id="5806411">)</span>&nbsp;<span class="ident" id="5806413">addDepLocked</span><span class="op" id="5806425">(</span><span class="ident" id="5806426">x</span>&nbsp;<span class="ident" id="5806428">finalCloser</span><span class="op" id="5806439">,</span>&nbsp;<span class="ident" id="5806441">dep</span>&nbsp;<span class="keyword" id="5806445">interface</span><span class="op" id="5806454">{</span><span class="op" id="5806455">}</span><span class="op" id="5806456">)</span>&nbsp;<span class="op" id="5806458">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806461">if</span>&nbsp;<span class="ident" id="5806464">db</span><span class="op" id="5806466">.</span><span class="ident" id="5806467">dep</span>&nbsp;<span class="op" id="5806471">==</span>&nbsp;<span class="ident" id="5806474">nil</span>&nbsp;<span class="op" id="5806478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806482">db</span><span class="op" id="5806484">.</span><span class="ident" id="5806485">dep</span>&nbsp;<span class="op" id="5806489">=</span>&nbsp;<span class="builtinfunc" id="5806491">make</span><span class="op" id="5806495">(</span><span class="keyword" id="5806496">map</span><span class="op" id="5806499">[</span><span class="ident" id="5806500">finalCloser</span><span class="op" id="5806511">]</span><span class="ident" id="5806512">depSet</span><span class="op" id="5806518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5806521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806524">xdep</span>&nbsp;<span class="op" id="5806529">:=</span>&nbsp;<span class="ident" id="5806532">db</span><span class="op" id="5806534">.</span><span class="ident" id="5806535">dep</span><span class="op" id="5806538">[</span><span class="ident" id="5806539">x</span><span class="op" id="5806540">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806543">if</span>&nbsp;<span class="ident" id="5806546">xdep</span>&nbsp;<span class="op" id="5806551">==</span>&nbsp;<span class="ident" id="5806554">nil</span>&nbsp;<span class="op" id="5806558">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806562">xdep</span>&nbsp;<span class="op" id="5806567">=</span>&nbsp;<span class="builtinfunc" id="5806569">make</span><span class="op" id="5806573">(</span><span class="ident" id="5806574">depSet</span><span class="op" id="5806580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806584">db</span><span class="op" id="5806586">.</span><span class="ident" id="5806587">dep</span><span class="op" id="5806590">[</span><span class="ident" id="5806591">x</span><span class="op" id="5806592">]</span>&nbsp;<span class="op" id="5806594">=</span>&nbsp;<span class="ident" id="5806596">xdep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5806602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806605">xdep</span><span class="op" id="5806609">[</span><span class="ident" id="5806610">dep</span><span class="op" id="5806613">]</span>&nbsp;<span class="op" id="5806615">=</span>&nbsp;<span class="builtintype" id="5806617">true</span><br>
<span class="lineno"></span><span class="op" id="5806622">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="5806625">//&nbsp;removeDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;no&nbsp;longer&nbsp;depends&nbsp;on&nbsp;dep.</span><br>
<span class="lineno"></span><span class="comment" id="5806677">//&nbsp;If&nbsp;x&nbsp;still&nbsp;has&nbsp;dependencies,&nbsp;nil&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="5806726">//&nbsp;If&nbsp;x&nbsp;no&nbsp;longer&nbsp;has&nbsp;any&nbsp;dependencies,&nbsp;its&nbsp;finalClose&nbsp;method&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5806796">//&nbsp;called&nbsp;and&nbsp;its&nbsp;error&nbsp;value&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno">385</span><span class="keyword" id="5806844">func</span>&nbsp;<span class="op" id="5806849">(</span><span class="ident" id="5806850">db</span>&nbsp;<span class="op" id="5806853">*</span><span class="ident" id="5806854">DB</span><span class="op" id="5806856">)</span>&nbsp;<span class="ident" id="5806858">removeDep</span><span class="op" id="5806867">(</span><span class="ident" id="5806868">x</span>&nbsp;<span class="ident" id="5806870">finalCloser</span><span class="op" id="5806881">,</span>&nbsp;<span class="ident" id="5806883">dep</span>&nbsp;<span class="keyword" id="5806887">interface</span><span class="op" id="5806896">{</span><span class="op" id="5806897">}</span><span class="op" id="5806898">)</span>&nbsp;<span class="builtintype" id="5806900">error</span>&nbsp;<span class="op" id="5806906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806909">db</span><span class="op" id="5806911">.</span><span class="ident" id="5806912">mu</span><span class="op" id="5806914">.</span><span class="ident" id="5806915">Lock</span><span class="op" id="5806919">(</span><span class="op" id="5806920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806923">fn</span>&nbsp;<span class="op" id="5806926">:=</span>&nbsp;<span class="ident" id="5806929">db</span><span class="op" id="5806931">.</span><span class="ident" id="5806932">removeDepLocked</span><span class="op" id="5806947">(</span><span class="ident" id="5806948">x</span><span class="op" id="5806949">,</span>&nbsp;<span class="ident" id="5806951">dep</span><span class="op" id="5806954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5806957">db</span><span class="op" id="5806959">.</span><span class="ident" id="5806960">mu</span><span class="op" id="5806962">.</span><span class="ident" id="5806963">Unlock</span><span class="op" id="5806969">(</span><span class="op" id="5806970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5806973">return</span>&nbsp;<span class="ident" id="5806980">fn</span><span class="op" id="5806982">(</span><span class="op" id="5806983">)</span><br>
<span class="lineno">390</span><span class="op" id="5806985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5806988">func</span>&nbsp;<span class="op" id="5806993">(</span><span class="ident" id="5806994">db</span>&nbsp;<span class="op" id="5806997">*</span><span class="ident" id="5806998">DB</span><span class="op" id="5807000">)</span>&nbsp;<span class="ident" id="5807002">removeDepLocked</span><span class="op" id="5807017">(</span><span class="ident" id="5807018">x</span>&nbsp;<span class="ident" id="5807020">finalCloser</span><span class="op" id="5807031">,</span>&nbsp;<span class="ident" id="5807033">dep</span>&nbsp;<span class="keyword" id="5807037">interface</span><span class="op" id="5807046">{</span><span class="op" id="5807047">}</span><span class="op" id="5807048">)</span>&nbsp;<span class="keyword" id="5807050">func</span><span class="op" id="5807054">(</span><span class="op" id="5807055">)</span>&nbsp;<span class="builtintype" id="5807057">error</span>&nbsp;<span class="op" id="5807063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5807066">//println(fmt.Sprintf(&#34;removeDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807134">xdep</span><span class="op" id="5807138">,</span>&nbsp;<span class="ident" id="5807140">ok</span>&nbsp;<span class="op" id="5807143">:=</span>&nbsp;<span class="ident" id="5807146">db</span><span class="op" id="5807148">.</span><span class="ident" id="5807149">dep</span><span class="op" id="5807152">[</span><span class="ident" id="5807153">x</span><span class="op" id="5807154">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807157">if</span>&nbsp;<span class="op" id="5807160">!</span><span class="ident" id="5807161">ok</span>&nbsp;<span class="op" id="5807164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5807168">panic</span><span class="op" id="5807173">(</span><span class="ident" id="5807174">fmt</span><span class="op" id="5807177">.</span><span class="ident" id="5807178">Sprintf</span><span class="op" id="5807185">(</span><span class="string" id="5807186">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;deps&nbsp;for&nbsp;%T&#34;</span><span class="op" id="5807222">,</span>&nbsp;<span class="ident" id="5807224">x</span><span class="op" id="5807225">)</span><span class="op" id="5807226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5807229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5807233">l0</span>&nbsp;<span class="op" id="5807236">:=</span>&nbsp;<span class="builtinfunc" id="5807239">len</span><span class="op" id="5807242">(</span><span class="ident" id="5807243">xdep</span><span class="op" id="5807247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5807250">delete</span><span class="op" id="5807256">(</span><span class="ident" id="5807257">xdep</span><span class="op" id="5807261">,</span>&nbsp;<span class="ident" id="5807263">dep</span><span class="op" id="5807266">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807270">switch</span>&nbsp;<span class="builtinfunc" id="5807277">len</span><span class="op" id="5807280">(</span><span class="ident" id="5807281">xdep</span><span class="op" id="5807285">)</span>&nbsp;<span class="op" id="5807287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807290">case</span>&nbsp;<span class="ident" id="5807295">l0</span><span class="op" id="5807297">:</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5807301">//&nbsp;Nothing&nbsp;removed.&nbsp;Shouldn&#39;t&nbsp;happen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5807341">panic</span><span class="op" id="5807346">(</span><span class="ident" id="5807347">fmt</span><span class="op" id="5807350">.</span><span class="ident" id="5807351">Sprintf</span><span class="op" id="5807358">(</span><span class="string" id="5807359">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;%T&nbsp;dep&nbsp;on&nbsp;%T&#34;</span><span class="op" id="5807396">,</span>&nbsp;<span class="ident" id="5807398">dep</span><span class="op" id="5807401">,</span>&nbsp;<span class="ident" id="5807403">x</span><span class="op" id="5807404">)</span><span class="op" id="5807405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807408">case</span>&nbsp;<span class="num" id="5807413">0</span><span class="op" id="5807414">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5807418">//&nbsp;No&nbsp;more&nbsp;dependencies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5807445">delete</span><span class="op" id="5807451">(</span><span class="ident" id="5807452">db</span><span class="op" id="5807454">.</span><span class="ident" id="5807455">dep</span><span class="op" id="5807458">,</span>&nbsp;<span class="ident" id="5807460">x</span><span class="op" id="5807461">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807465">return</span>&nbsp;<span class="ident" id="5807472">x</span><span class="op" id="5807473">.</span><span class="ident" id="5807474">finalClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807486">default</span><span class="op" id="5807493">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5807497">//&nbsp;Dependencies&nbsp;remain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5807523">return</span>&nbsp;<span class="keyword" id="5807530">func</span><span class="op" id="5807534">(</span><span class="op" id="5807535">)</span>&nbsp;<span class="builtintype" id="5807537">error</span>&nbsp;<span class="op" id="5807543">{</span>&nbsp;<span class="keyword" id="5807545">return</span>&nbsp;<span class="ident" id="5807552">nil</span>&nbsp;<span class="op" id="5807556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5807559">}</span><br>
<span class="lineno">415</span><span class="op" id="5807561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5807564">//&nbsp;This&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;connectionOpener&nbsp;request&nbsp;chan&nbsp;(dn.openerCh).</span><br>
<span class="lineno"></span><span class="comment" id="5807636">//&nbsp;This&nbsp;value&nbsp;should&nbsp;be&nbsp;larger&nbsp;than&nbsp;the&nbsp;maximum&nbsp;typical&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5807698">//&nbsp;used&nbsp;for&nbsp;db.maxOpen.&nbsp;If&nbsp;maxOpen&nbsp;is&nbsp;significantly&nbsp;larger&nbsp;than</span><br>
<span class="lineno">420</span><span class="comment" id="5807762">//&nbsp;connectionRequestQueueSize&nbsp;then&nbsp;it&nbsp;is&nbsp;possible&nbsp;for&nbsp;ALL&nbsp;calls&nbsp;into&nbsp;the&nbsp;*DB</span><br>
<span class="lineno"></span><span class="comment" id="5807839">//&nbsp;to&nbsp;block&nbsp;until&nbsp;the&nbsp;connectionOpener&nbsp;can&nbsp;satisfy&nbsp;the&nbsp;backlog&nbsp;of&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="5807915">var</span>&nbsp;<span class="ident" id="5807919">connectionRequestQueueSize</span>&nbsp;<span class="op" id="5807946">=</span>&nbsp;<span class="num" id="5807948">1000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5807957">//&nbsp;Open&nbsp;opens&nbsp;a&nbsp;database&nbsp;specified&nbsp;by&nbsp;its&nbsp;database&nbsp;driver&nbsp;name&nbsp;and&nbsp;a</span><br>
<span class="lineno">425</span><span class="comment" id="5808026">//&nbsp;driver-specific&nbsp;data&nbsp;source&nbsp;name,&nbsp;usually&nbsp;consisting&nbsp;of&nbsp;at&nbsp;least&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5808096">//&nbsp;database&nbsp;name&nbsp;and&nbsp;connection&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="5808141">//</span><br>
<span class="lineno"></span><span class="comment" id="5808144">//&nbsp;Most&nbsp;users&nbsp;will&nbsp;open&nbsp;a&nbsp;database&nbsp;via&nbsp;a&nbsp;driver-specific&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5808212">//&nbsp;helper&nbsp;function&nbsp;that&nbsp;returns&nbsp;a&nbsp;*DB.&nbsp;No&nbsp;database&nbsp;drivers&nbsp;are&nbsp;included</span><br>
<span class="lineno">430</span><span class="comment" id="5808284">//&nbsp;in&nbsp;the&nbsp;Go&nbsp;standard&nbsp;library.&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5808354">//&nbsp;a&nbsp;list&nbsp;of&nbsp;third-party&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="comment" id="5808388">//</span><br>
<span class="lineno"></span><span class="comment" id="5808391">//&nbsp;Open&nbsp;may&nbsp;just&nbsp;validate&nbsp;its&nbsp;arguments&nbsp;without&nbsp;creating&nbsp;a&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5808461">//&nbsp;to&nbsp;the&nbsp;database.&nbsp;To&nbsp;verify&nbsp;that&nbsp;the&nbsp;data&nbsp;source&nbsp;name&nbsp;is&nbsp;valid,&nbsp;call</span><br>
<span class="lineno">435</span><span class="comment" id="5808532">//&nbsp;Ping.</span><br>
<span class="lineno"></span><span class="comment" id="5808541">//</span><br>
<span class="lineno"></span><span class="comment" id="5808544">//&nbsp;The&nbsp;returned&nbsp;DB&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="5808613">//&nbsp;and&nbsp;maintains&nbsp;its&nbsp;own&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;Thus,&nbsp;the&nbsp;Open</span><br>
<span class="lineno"></span><span class="comment" id="5808679">//&nbsp;function&nbsp;should&nbsp;be&nbsp;called&nbsp;just&nbsp;once.&nbsp;It&nbsp;is&nbsp;rarely&nbsp;necessary&nbsp;to</span><br>
<span class="lineno">440</span><span class="comment" id="5808745">//&nbsp;close&nbsp;a&nbsp;DB.</span><br>
<span class="lineno"></span><span class="keyword" id="5808760">func</span>&nbsp;<span class="ident" id="5808765">Open</span><span class="op" id="5808769">(</span><span class="ident" id="5808770">driverName</span><span class="op" id="5808780">,</span>&nbsp;<span class="ident" id="5808782">dataSourceName</span>&nbsp;<span class="builtintype" id="5808797">string</span><span class="op" id="5808803">)</span>&nbsp;<span class="op" id="5808805">(</span><span class="op" id="5808806">*</span><span class="ident" id="5808807">DB</span><span class="op" id="5808809">,</span>&nbsp;<span class="builtintype" id="5808811">error</span><span class="op" id="5808816">)</span>&nbsp;<span class="op" id="5808818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5808821">driveri</span><span class="op" id="5808828">,</span>&nbsp;<span class="ident" id="5808830">ok</span>&nbsp;<span class="op" id="5808833">:=</span>&nbsp;<span class="ident" id="5808836">drivers</span><span class="op" id="5808843">[</span><span class="ident" id="5808844">driverName</span><span class="op" id="5808854">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5808857">if</span>&nbsp;<span class="op" id="5808860">!</span><span class="ident" id="5808861">ok</span>&nbsp;<span class="op" id="5808864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5808868">return</span>&nbsp;<span class="ident" id="5808875">nil</span><span class="op" id="5808878">,</span>&nbsp;<span class="ident" id="5808880">fmt</span><span class="op" id="5808883">.</span><span class="ident" id="5808884">Errorf</span><span class="op" id="5808890">(</span><span class="string" id="5808891">&#34;sql:&nbsp;unknown&nbsp;driver&nbsp;%q&nbsp;(forgotten&nbsp;import?)&#34;</span><span class="op" id="5808935">,</span>&nbsp;<span class="ident" id="5808937">driverName</span><span class="op" id="5808947">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5808950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5808953">db</span>&nbsp;<span class="op" id="5808956">:=</span>&nbsp;<span class="op" id="5808959">&amp;</span><span class="ident" id="5808960">DB</span><span class="op" id="5808962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5808966">driver</span><span class="op" id="5808972">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5808976">driveri</span><span class="op" id="5808983">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5808987">dsn</span><span class="op" id="5808990">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5808997">dataSourceName</span><span class="op" id="5809011">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809015">openerCh</span><span class="op" id="5809023">:</span>&nbsp;<span class="builtinfunc" id="5809025">make</span><span class="op" id="5809029">(</span><span class="keyword" id="5809030">chan</span>&nbsp;<span class="keyword" id="5809035">struct</span><span class="op" id="5809041">{</span><span class="op" id="5809042">}</span><span class="op" id="5809043">,</span>&nbsp;<span class="ident" id="5809045">connectionRequestQueueSize</span><span class="op" id="5809071">)</span><span class="op" id="5809072">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809076">lastPut</span><span class="op" id="5809083">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5809086">make</span><span class="op" id="5809090">(</span><span class="keyword" id="5809091">map</span><span class="op" id="5809094">[</span><span class="op" id="5809095">*</span><span class="ident" id="5809096">driverConn</span><span class="op" id="5809106">]</span><span class="builtintype" id="5809107">string</span><span class="op" id="5809113">)</span><span class="op" id="5809114">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5809117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809120">go</span>&nbsp;<span class="ident" id="5809123">db</span><span class="op" id="5809125">.</span><span class="ident" id="5809126">connectionOpener</span><span class="op" id="5809142">(</span><span class="op" id="5809143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809146">return</span>&nbsp;<span class="ident" id="5809153">db</span><span class="op" id="5809155">,</span>&nbsp;<span class="ident" id="5809157">nil</span><br>
<span class="lineno"></span><span class="op" id="5809161">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="5809164">//&nbsp;Ping&nbsp;verifies&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;database&nbsp;is&nbsp;still&nbsp;alive,</span><br>
<span class="lineno"></span><span class="comment" id="5809226">//&nbsp;establishing&nbsp;a&nbsp;connection&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="5809269">func</span>&nbsp;<span class="op" id="5809274">(</span><span class="ident" id="5809275">db</span>&nbsp;<span class="op" id="5809278">*</span><span class="ident" id="5809279">DB</span><span class="op" id="5809281">)</span>&nbsp;<span class="ident" id="5809283">Ping</span><span class="op" id="5809287">(</span><span class="op" id="5809288">)</span>&nbsp;<span class="builtintype" id="5809290">error</span>&nbsp;<span class="op" id="5809296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809299">//&nbsp;TODO(bradfitz):&nbsp;give&nbsp;drivers&nbsp;an&nbsp;optional&nbsp;hook&nbsp;to&nbsp;implement</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809362">//&nbsp;this&nbsp;in&nbsp;a&nbsp;more&nbsp;efficient&nbsp;or&nbsp;more&nbsp;reliable&nbsp;way,&nbsp;if&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5809421">//&nbsp;have&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809435">dc</span><span class="op" id="5809437">,</span>&nbsp;<span class="ident" id="5809439">err</span>&nbsp;<span class="op" id="5809443">:=</span>&nbsp;<span class="ident" id="5809446">db</span><span class="op" id="5809448">.</span><span class="ident" id="5809449">conn</span><span class="op" id="5809453">(</span><span class="op" id="5809454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809457">if</span>&nbsp;<span class="ident" id="5809460">err</span>&nbsp;<span class="op" id="5809464">!=</span>&nbsp;<span class="ident" id="5809467">nil</span>&nbsp;<span class="op" id="5809471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809475">return</span>&nbsp;<span class="ident" id="5809482">err</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5809487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809490">db</span><span class="op" id="5809492">.</span><span class="ident" id="5809493">putConn</span><span class="op" id="5809500">(</span><span class="ident" id="5809501">dc</span><span class="op" id="5809503">,</span>&nbsp;<span class="ident" id="5809505">nil</span><span class="op" id="5809508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809511">return</span>&nbsp;<span class="ident" id="5809518">nil</span><br>
<span class="lineno"></span><span class="op" id="5809522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="comment" id="5809525">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;database,&nbsp;releasing&nbsp;any&nbsp;open&nbsp;resources.</span><br>
<span class="lineno"></span><span class="comment" id="5809585">//</span><br>
<span class="lineno"></span><span class="comment" id="5809588">//&nbsp;It&nbsp;is&nbsp;rare&nbsp;to&nbsp;Close&nbsp;a&nbsp;DB,&nbsp;as&nbsp;the&nbsp;DB&nbsp;handle&nbsp;is&nbsp;meant&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5809649">//&nbsp;long-lived&nbsp;and&nbsp;shared&nbsp;between&nbsp;many&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5809699">func</span>&nbsp;<span class="op" id="5809704">(</span><span class="ident" id="5809705">db</span>&nbsp;<span class="op" id="5809708">*</span><span class="ident" id="5809709">DB</span><span class="op" id="5809711">)</span>&nbsp;<span class="ident" id="5809713">Close</span><span class="op" id="5809718">(</span><span class="op" id="5809719">)</span>&nbsp;<span class="builtintype" id="5809721">error</span>&nbsp;<span class="op" id="5809727">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809730">db</span><span class="op" id="5809732">.</span><span class="ident" id="5809733">mu</span><span class="op" id="5809735">.</span><span class="ident" id="5809736">Lock</span><span class="op" id="5809740">(</span><span class="op" id="5809741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809744">if</span>&nbsp;<span class="ident" id="5809747">db</span><span class="op" id="5809749">.</span><span class="ident" id="5809750">closed</span>&nbsp;<span class="op" id="5809757">{</span>&nbsp;<span class="comment" id="5809759">//&nbsp;Make&nbsp;DB.Close&nbsp;idempotent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809789">db</span><span class="op" id="5809791">.</span><span class="ident" id="5809792">mu</span><span class="op" id="5809794">.</span><span class="ident" id="5809795">Unlock</span><span class="op" id="5809801">(</span><span class="op" id="5809802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809806">return</span>&nbsp;<span class="ident" id="5809813">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5809818">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5809821">close</span><span class="op" id="5809826">(</span><span class="ident" id="5809827">db</span><span class="op" id="5809829">.</span><span class="ident" id="5809830">openerCh</span><span class="op" id="5809838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809841">var</span>&nbsp;<span class="ident" id="5809845">err</span>&nbsp;<span class="builtintype" id="5809849">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809856">fns</span>&nbsp;<span class="op" id="5809860">:=</span>&nbsp;<span class="builtinfunc" id="5809863">make</span><span class="op" id="5809867">(</span><span class="op" id="5809868">[</span><span class="op" id="5809869">]</span><span class="keyword" id="5809870">func</span><span class="op" id="5809874">(</span><span class="op" id="5809875">)</span>&nbsp;<span class="builtintype" id="5809877">error</span><span class="op" id="5809882">,</span>&nbsp;<span class="num" id="5809884">0</span><span class="op" id="5809885">,</span>&nbsp;<span class="builtinfunc" id="5809887">len</span><span class="op" id="5809890">(</span><span class="ident" id="5809891">db</span><span class="op" id="5809893">.</span><span class="ident" id="5809894">freeConn</span><span class="op" id="5809902">)</span><span class="op" id="5809903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5809906">for</span>&nbsp;<span class="ident" id="5809910">_</span><span class="op" id="5809911">,</span>&nbsp;<span class="ident" id="5809913">dc</span>&nbsp;<span class="op" id="5809916">:=</span>&nbsp;<span class="keyword" id="5809919">range</span>&nbsp;<span class="ident" id="5809925">db</span><span class="op" id="5809927">.</span><span class="ident" id="5809928">freeConn</span>&nbsp;<span class="op" id="5809937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809941">fns</span>&nbsp;<span class="op" id="5809945">=</span>&nbsp;<span class="builtinfunc" id="5809947">append</span><span class="op" id="5809953">(</span><span class="ident" id="5809954">fns</span><span class="op" id="5809957">,</span>&nbsp;<span class="ident" id="5809959">dc</span><span class="op" id="5809961">.</span><span class="ident" id="5809962">closeDBLocked</span><span class="op" id="5809975">(</span><span class="op" id="5809976">)</span><span class="op" id="5809977">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5809980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5809983">db</span><span class="op" id="5809985">.</span><span class="ident" id="5809986">freeConn</span>&nbsp;<span class="op" id="5809995">=</span>&nbsp;<span class="ident" id="5809997">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810002">db</span><span class="op" id="5810004">.</span><span class="ident" id="5810005">closed</span>&nbsp;<span class="op" id="5810012">=</span>&nbsp;<span class="builtintype" id="5810014">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810020">for</span>&nbsp;<span class="ident" id="5810024">_</span><span class="op" id="5810025">,</span>&nbsp;<span class="ident" id="5810027">req</span>&nbsp;<span class="op" id="5810031">:=</span>&nbsp;<span class="keyword" id="5810034">range</span>&nbsp;<span class="ident" id="5810040">db</span><span class="op" id="5810042">.</span><span class="ident" id="5810043">connRequests</span>&nbsp;<span class="op" id="5810056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5810060">close</span><span class="op" id="5810065">(</span><span class="ident" id="5810066">req</span><span class="op" id="5810069">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5810072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810075">db</span><span class="op" id="5810077">.</span><span class="ident" id="5810078">mu</span><span class="op" id="5810080">.</span><span class="ident" id="5810081">Unlock</span><span class="op" id="5810087">(</span><span class="op" id="5810088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810091">for</span>&nbsp;<span class="ident" id="5810095">_</span><span class="op" id="5810096">,</span>&nbsp;<span class="ident" id="5810098">fn</span>&nbsp;<span class="op" id="5810101">:=</span>&nbsp;<span class="keyword" id="5810104">range</span>&nbsp;<span class="ident" id="5810110">fns</span>&nbsp;<span class="op" id="5810114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810118">err1</span>&nbsp;<span class="op" id="5810123">:=</span>&nbsp;<span class="ident" id="5810126">fn</span><span class="op" id="5810128">(</span><span class="op" id="5810129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810133">if</span>&nbsp;<span class="ident" id="5810136">err1</span>&nbsp;<span class="op" id="5810141">!=</span>&nbsp;<span class="ident" id="5810144">nil</span>&nbsp;<span class="op" id="5810148">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810153">err</span>&nbsp;<span class="op" id="5810157">=</span>&nbsp;<span class="ident" id="5810159">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5810166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5810169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810172">return</span>&nbsp;<span class="ident" id="5810179">err</span><br>
<span class="lineno"></span><span class="op" id="5810183">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="5810186">const</span>&nbsp;<span class="ident" id="5810192">defaultMaxIdleConns</span>&nbsp;<span class="op" id="5810212">=</span>&nbsp;<span class="num" id="5810214">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5810217">func</span>&nbsp;<span class="op" id="5810222">(</span><span class="ident" id="5810223">db</span>&nbsp;<span class="op" id="5810226">*</span><span class="ident" id="5810227">DB</span><span class="op" id="5810229">)</span>&nbsp;<span class="ident" id="5810231">maxIdleConnsLocked</span><span class="op" id="5810249">(</span><span class="op" id="5810250">)</span>&nbsp;<span class="builtintype" id="5810252">int</span>&nbsp;<span class="op" id="5810256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810259">n</span>&nbsp;<span class="op" id="5810261">:=</span>&nbsp;<span class="ident" id="5810264">db</span><span class="op" id="5810266">.</span><span class="ident" id="5810267">maxIdle</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810276">switch</span>&nbsp;<span class="op" id="5810283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810286">case</span>&nbsp;<span class="ident" id="5810291">n</span>&nbsp;<span class="op" id="5810293">==</span>&nbsp;<span class="num" id="5810296">0</span><span class="op" id="5810297">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5810301">//&nbsp;TODO(bradfitz):&nbsp;ask&nbsp;driver,&nbsp;if&nbsp;supported,&nbsp;for&nbsp;its&nbsp;default&nbsp;preference</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810375">return</span>&nbsp;<span class="ident" id="5810382">defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810403">case</span>&nbsp;<span class="ident" id="5810408">n</span>&nbsp;<span class="op" id="5810410">&lt;</span>&nbsp;<span class="num" id="5810412">0</span><span class="op" id="5810413">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810417">return</span>&nbsp;<span class="num" id="5810424">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810427">default</span><span class="op" id="5810434">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810438">return</span>&nbsp;<span class="ident" id="5810445">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5810448">}</span><br>
<span class="lineno"></span><span class="op" id="5810450">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span><span class="comment" id="5810453">//&nbsp;SetMaxIdleConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;connections&nbsp;in&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="5810523">//&nbsp;connection&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="5810543">//</span><br>
<span class="lineno"></span><span class="comment" id="5810546">//&nbsp;If&nbsp;MaxOpenConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;but&nbsp;less&nbsp;than&nbsp;the&nbsp;new&nbsp;MaxIdleConns</span><br>
<span class="lineno">520</span><span class="comment" id="5810618">//&nbsp;then&nbsp;the&nbsp;new&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="5810695">//</span><br>
<span class="lineno"></span><span class="comment" id="5810698">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;no&nbsp;idle&nbsp;connections&nbsp;are&nbsp;retained.</span><br>
<span class="lineno"></span><span class="keyword" id="5810746">func</span>&nbsp;<span class="op" id="5810751">(</span><span class="ident" id="5810752">db</span>&nbsp;<span class="op" id="5810755">*</span><span class="ident" id="5810756">DB</span><span class="op" id="5810758">)</span>&nbsp;<span class="ident" id="5810760">SetMaxIdleConns</span><span class="op" id="5810775">(</span><span class="ident" id="5810776">n</span>&nbsp;<span class="builtintype" id="5810778">int</span><span class="op" id="5810781">)</span>&nbsp;<span class="op" id="5810783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810786">db</span><span class="op" id="5810788">.</span><span class="ident" id="5810789">mu</span><span class="op" id="5810791">.</span><span class="ident" id="5810792">Lock</span><span class="op" id="5810796">(</span><span class="op" id="5810797">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810800">if</span>&nbsp;<span class="ident" id="5810803">n</span>&nbsp;<span class="op" id="5810805">&gt;</span>&nbsp;<span class="num" id="5810807">0</span>&nbsp;<span class="op" id="5810809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810813">db</span><span class="op" id="5810815">.</span><span class="ident" id="5810816">maxIdle</span>&nbsp;<span class="op" id="5810824">=</span>&nbsp;<span class="ident" id="5810826">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5810829">}</span>&nbsp;<span class="keyword" id="5810831">else</span>&nbsp;<span class="op" id="5810836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5810840">//&nbsp;No&nbsp;idle&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810866">db</span><span class="op" id="5810868">.</span><span class="ident" id="5810869">maxIdle</span>&nbsp;<span class="op" id="5810877">=</span>&nbsp;<span class="op" id="5810879">-</span><span class="num" id="5810880">1</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5810883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5810886">//&nbsp;Make&nbsp;sure&nbsp;maxIdle&nbsp;doesn&#39;t&nbsp;exceed&nbsp;maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5810931">if</span>&nbsp;<span class="ident" id="5810934">db</span><span class="op" id="5810936">.</span><span class="ident" id="5810937">maxOpen</span>&nbsp;<span class="op" id="5810945">&gt;</span>&nbsp;<span class="num" id="5810947">0</span>&nbsp;<span class="op" id="5810949">&amp;&amp;</span>&nbsp;<span class="ident" id="5810952">db</span><span class="op" id="5810954">.</span><span class="ident" id="5810955">maxIdleConnsLocked</span><span class="op" id="5810973">(</span><span class="op" id="5810974">)</span>&nbsp;<span class="op" id="5810976">&gt;</span>&nbsp;<span class="ident" id="5810978">db</span><span class="op" id="5810980">.</span><span class="ident" id="5810981">maxOpen</span>&nbsp;<span class="op" id="5810989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5810993">db</span><span class="op" id="5810995">.</span><span class="ident" id="5810996">maxIdle</span>&nbsp;<span class="op" id="5811004">=</span>&nbsp;<span class="ident" id="5811006">db</span><span class="op" id="5811008">.</span><span class="ident" id="5811009">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811018">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811021">var</span>&nbsp;<span class="ident" id="5811025">closing</span>&nbsp;<span class="op" id="5811033">[</span><span class="op" id="5811034">]</span><span class="op" id="5811035">*</span><span class="ident" id="5811036">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811048">idleCount</span>&nbsp;<span class="op" id="5811058">:=</span>&nbsp;<span class="builtinfunc" id="5811061">len</span><span class="op" id="5811064">(</span><span class="ident" id="5811065">db</span><span class="op" id="5811067">.</span><span class="ident" id="5811068">freeConn</span><span class="op" id="5811076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811079">maxIdle</span>&nbsp;<span class="op" id="5811087">:=</span>&nbsp;<span class="ident" id="5811090">db</span><span class="op" id="5811092">.</span><span class="ident" id="5811093">maxIdleConnsLocked</span><span class="op" id="5811111">(</span><span class="op" id="5811112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811115">if</span>&nbsp;<span class="ident" id="5811118">idleCount</span>&nbsp;<span class="op" id="5811128">&gt;</span>&nbsp;<span class="ident" id="5811130">maxIdle</span>&nbsp;<span class="op" id="5811138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811142">closing</span>&nbsp;<span class="op" id="5811150">=</span>&nbsp;<span class="ident" id="5811152">db</span><span class="op" id="5811154">.</span><span class="ident" id="5811155">freeConn</span><span class="op" id="5811163">[</span><span class="ident" id="5811164">maxIdle</span><span class="op" id="5811171">:</span><span class="op" id="5811172">]</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811176">db</span><span class="op" id="5811178">.</span><span class="ident" id="5811179">freeConn</span>&nbsp;<span class="op" id="5811188">=</span>&nbsp;<span class="ident" id="5811190">db</span><span class="op" id="5811192">.</span><span class="ident" id="5811193">freeConn</span><span class="op" id="5811201">[</span><span class="op" id="5811202">:</span><span class="ident" id="5811203">maxIdle</span><span class="op" id="5811210">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811216">db</span><span class="op" id="5811218">.</span><span class="ident" id="5811219">mu</span><span class="op" id="5811221">.</span><span class="ident" id="5811222">Unlock</span><span class="op" id="5811228">(</span><span class="op" id="5811229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811232">for</span>&nbsp;<span class="ident" id="5811236">_</span><span class="op" id="5811237">,</span>&nbsp;<span class="ident" id="5811239">c</span>&nbsp;<span class="op" id="5811241">:=</span>&nbsp;<span class="keyword" id="5811244">range</span>&nbsp;<span class="ident" id="5811250">closing</span>&nbsp;<span class="op" id="5811258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811262">c</span><span class="op" id="5811263">.</span><span class="ident" id="5811264">Close</span><span class="op" id="5811269">(</span><span class="op" id="5811270">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811273">}</span><br>
<span class="lineno"></span><span class="op" id="5811275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5811278">//&nbsp;SetMaxOpenConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;the&nbsp;database.</span><br>
<span class="lineno"></span><span class="comment" id="5811358">//</span><br>
<span class="lineno">550</span><span class="comment" id="5811361">//&nbsp;If&nbsp;MaxIdleConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;and&nbsp;the&nbsp;new&nbsp;MaxOpenConns&nbsp;is&nbsp;less&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="5811436">//&nbsp;MaxIdleConns,&nbsp;then&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="5811504">//&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="5811526">//</span><br>
<span class="lineno"></span><span class="comment" id="5811529">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;then&nbsp;there&nbsp;is&nbsp;no&nbsp;limit&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections.</span><br>
<span class="lineno">555</span><span class="comment" id="5811601">//&nbsp;The&nbsp;default&nbsp;is&nbsp;0&nbsp;(unlimited).</span><br>
<span class="lineno"></span><span class="keyword" id="5811634">func</span>&nbsp;<span class="op" id="5811639">(</span><span class="ident" id="5811640">db</span>&nbsp;<span class="op" id="5811643">*</span><span class="ident" id="5811644">DB</span><span class="op" id="5811646">)</span>&nbsp;<span class="ident" id="5811648">SetMaxOpenConns</span><span class="op" id="5811663">(</span><span class="ident" id="5811664">n</span>&nbsp;<span class="builtintype" id="5811666">int</span><span class="op" id="5811669">)</span>&nbsp;<span class="op" id="5811671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811674">db</span><span class="op" id="5811676">.</span><span class="ident" id="5811677">mu</span><span class="op" id="5811679">.</span><span class="ident" id="5811680">Lock</span><span class="op" id="5811684">(</span><span class="op" id="5811685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811688">db</span><span class="op" id="5811690">.</span><span class="ident" id="5811691">maxOpen</span>&nbsp;<span class="op" id="5811699">=</span>&nbsp;<span class="ident" id="5811701">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811704">if</span>&nbsp;<span class="ident" id="5811707">n</span>&nbsp;<span class="op" id="5811709">&lt;</span>&nbsp;<span class="num" id="5811711">0</span>&nbsp;<span class="op" id="5811713">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811717">db</span><span class="op" id="5811719">.</span><span class="ident" id="5811720">maxOpen</span>&nbsp;<span class="op" id="5811728">=</span>&nbsp;<span class="num" id="5811730">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811736">syncMaxIdle</span>&nbsp;<span class="op" id="5811748">:=</span>&nbsp;<span class="ident" id="5811751">db</span><span class="op" id="5811753">.</span><span class="ident" id="5811754">maxOpen</span>&nbsp;<span class="op" id="5811762">&gt;</span>&nbsp;<span class="num" id="5811764">0</span>&nbsp;<span class="op" id="5811766">&amp;&amp;</span>&nbsp;<span class="ident" id="5811769">db</span><span class="op" id="5811771">.</span><span class="ident" id="5811772">maxIdleConnsLocked</span><span class="op" id="5811790">(</span><span class="op" id="5811791">)</span>&nbsp;<span class="op" id="5811793">&gt;</span>&nbsp;<span class="ident" id="5811795">db</span><span class="op" id="5811797">.</span><span class="ident" id="5811798">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811807">db</span><span class="op" id="5811809">.</span><span class="ident" id="5811810">mu</span><span class="op" id="5811812">.</span><span class="ident" id="5811813">Unlock</span><span class="op" id="5811819">(</span><span class="op" id="5811820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5811823">if</span>&nbsp;<span class="ident" id="5811826">syncMaxIdle</span>&nbsp;<span class="op" id="5811838">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5811842">db</span><span class="op" id="5811844">.</span><span class="ident" id="5811845">SetMaxIdleConns</span><span class="op" id="5811860">(</span><span class="ident" id="5811861">n</span><span class="op" id="5811862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5811865">}</span><br>
<span class="lineno"></span><span class="op" id="5811867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5811870">//&nbsp;Assumes&nbsp;db.mu&nbsp;is&nbsp;locked.</span><br>
<span class="lineno">570</span><span class="comment" id="5811898">//&nbsp;If&nbsp;there&nbsp;are&nbsp;connRequests&nbsp;and&nbsp;the&nbsp;connection&nbsp;limit&nbsp;hasn&#39;t&nbsp;been&nbsp;reached,</span><br>
<span class="lineno"></span><span class="comment" id="5811973">//&nbsp;then&nbsp;tell&nbsp;the&nbsp;connectionOpener&nbsp;to&nbsp;open&nbsp;new&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="5812032">func</span>&nbsp;<span class="op" id="5812037">(</span><span class="ident" id="5812038">db</span>&nbsp;<span class="op" id="5812041">*</span><span class="ident" id="5812042">DB</span><span class="op" id="5812044">)</span>&nbsp;<span class="ident" id="5812046">maybeOpenNewConnections</span><span class="op" id="5812069">(</span><span class="op" id="5812070">)</span>&nbsp;<span class="op" id="5812072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812075">numRequests</span>&nbsp;<span class="op" id="5812087">:=</span>&nbsp;<span class="builtinfunc" id="5812090">len</span><span class="op" id="5812093">(</span><span class="ident" id="5812094">db</span><span class="op" id="5812096">.</span><span class="ident" id="5812097">connRequests</span><span class="op" id="5812109">)</span>&nbsp;<span class="op" id="5812111">-</span>&nbsp;<span class="ident" id="5812113">db</span><span class="op" id="5812115">.</span><span class="ident" id="5812116">pendingOpens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5812130">if</span>&nbsp;<span class="ident" id="5812133">db</span><span class="op" id="5812135">.</span><span class="ident" id="5812136">maxOpen</span>&nbsp;<span class="op" id="5812144">&gt;</span>&nbsp;<span class="num" id="5812146">0</span>&nbsp;<span class="op" id="5812148">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812152">numCanOpen</span>&nbsp;<span class="op" id="5812163">:=</span>&nbsp;<span class="ident" id="5812166">db</span><span class="op" id="5812168">.</span><span class="ident" id="5812169">maxOpen</span>&nbsp;<span class="op" id="5812177">-</span>&nbsp;<span class="op" id="5812179">(</span><span class="ident" id="5812180">db</span><span class="op" id="5812182">.</span><span class="ident" id="5812183">numOpen</span>&nbsp;<span class="op" id="5812191">+</span>&nbsp;<span class="ident" id="5812193">db</span><span class="op" id="5812195">.</span><span class="ident" id="5812196">pendingOpens</span><span class="op" id="5812208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5812212">if</span>&nbsp;<span class="ident" id="5812215">numRequests</span>&nbsp;<span class="op" id="5812227">&gt;</span>&nbsp;<span class="ident" id="5812229">numCanOpen</span>&nbsp;<span class="op" id="5812240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812245">numRequests</span>&nbsp;<span class="op" id="5812257">=</span>&nbsp;<span class="ident" id="5812259">numCanOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5812272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5812275">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5812278">for</span>&nbsp;<span class="ident" id="5812282">numRequests</span>&nbsp;<span class="op" id="5812294">&gt;</span>&nbsp;<span class="num" id="5812296">0</span>&nbsp;<span class="op" id="5812298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812302">db</span><span class="op" id="5812304">.</span><span class="ident" id="5812305">pendingOpens</span><span class="op" id="5812317">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812322">numRequests</span><span class="op" id="5812333">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812338">db</span><span class="op" id="5812340">.</span><span class="ident" id="5812341">openerCh</span>&nbsp;<span class="op" id="5812350">&lt;-</span>&nbsp;<span class="keyword" id="5812353">struct</span><span class="op" id="5812359">{</span><span class="op" id="5812360">}</span><span class="op" id="5812361">{</span><span class="op" id="5812362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5812365">}</span><br>
<span class="lineno">585</span><span class="op" id="5812367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5812370">//&nbsp;Runs&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine,&nbsp;opens&nbsp;new&nbsp;connections&nbsp;when&nbsp;requested.</span><br>
<span class="lineno"></span><span class="keyword" id="5812441">func</span>&nbsp;<span class="op" id="5812446">(</span><span class="ident" id="5812447">db</span>&nbsp;<span class="op" id="5812450">*</span><span class="ident" id="5812451">DB</span><span class="op" id="5812453">)</span>&nbsp;<span class="ident" id="5812455">connectionOpener</span><span class="op" id="5812471">(</span><span class="op" id="5812472">)</span>&nbsp;<span class="op" id="5812474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5812477">for</span>&nbsp;<span class="keyword" id="5812481">range</span>&nbsp;<span class="ident" id="5812487">db</span><span class="op" id="5812489">.</span><span class="ident" id="5812490">openerCh</span>&nbsp;<span class="op" id="5812499">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812503">db</span><span class="op" id="5812505">.</span><span class="ident" id="5812506">openNewConnection</span><span class="op" id="5812523">(</span><span class="op" id="5812524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5812527">}</span><br>
<span class="lineno"></span><span class="op" id="5812529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5812532">//&nbsp;Open&nbsp;one&nbsp;new&nbsp;connection</span><br>
<span class="lineno">595</span><span class="keyword" id="5812559">func</span>&nbsp;<span class="op" id="5812564">(</span><span class="ident" id="5812565">db</span>&nbsp;<span class="op" id="5812568">*</span><span class="ident" id="5812569">DB</span><span class="op" id="5812571">)</span>&nbsp;<span class="ident" id="5812573">openNewConnection</span><span class="op" id="5812590">(</span><span class="op" id="5812591">)</span>&nbsp;<span class="op" id="5812593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812596">ci</span><span class="op" id="5812598">,</span>&nbsp;<span class="ident" id="5812600">err</span>&nbsp;<span class="op" id="5812604">:=</span>&nbsp;<span class="ident" id="5812607">db</span><span class="op" id="5812609">.</span><span class="ident" id="5812610">driver</span><span class="op" id="5812616">.</span><span class="ident" id="5812617">Open</span><span class="op" id="5812621">(</span><span class="ident" id="5812622">db</span><span class="op" id="5812624">.</span><span class="ident" id="5812625">dsn</span><span class="op" id="5812628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812631">db</span><span class="op" id="5812633">.</span><span class="ident" id="5812634">mu</span><span class="op" id="5812636">.</span><span class="ident" id="5812637">Lock</span><span class="op" id="5812641">(</span><span class="op" id="5812642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5812645">defer</span>&nbsp;<span class="ident" id="5812651">db</span><span class="op" id="5812653">.</span><span class="ident" id="5812654">mu</span><span class="op" id="5812656">.</span><span class="ident" id="5812657">Unlock</span><span class="op" id="5812663">(</span><span class="op" id="5812664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5812667">if</span>&nbsp;<span class="ident" id="5812670">db</span><span class="op" id="5812672">.</span><span class="ident" id="5812673">closed</span>&nbsp;<span class="op" id="5812680">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5812684">if</span>&nbsp;<span class="ident" id="5812687">err</span>&nbsp;<span class="op" id="5812691">==</span>&nbsp;<span class="ident" id="5812694">nil</span>&nbsp;<span class="op" id="5812698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812703">ci</span><span class="op" id="5812705">.</span><span class="ident" id="5812706">Close</span><span class="op" id="5812711">(</span><span class="op" id="5812712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5812716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5812720">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5812728">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812731">db</span><span class="op" id="5812733">.</span><span class="ident" id="5812734">pendingOpens</span><span class="op" id="5812746">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5812750">if</span>&nbsp;<span class="ident" id="5812753">err</span>&nbsp;<span class="op" id="5812757">!=</span>&nbsp;<span class="ident" id="5812760">nil</span>&nbsp;<span class="op" id="5812764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812768">db</span><span class="op" id="5812770">.</span><span class="ident" id="5812771">putConnDBLocked</span><span class="op" id="5812786">(</span><span class="ident" id="5812787">nil</span><span class="op" id="5812790">,</span>&nbsp;<span class="ident" id="5812792">err</span><span class="op" id="5812795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5812799">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5812807">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812810">dc</span>&nbsp;<span class="op" id="5812813">:=</span>&nbsp;<span class="op" id="5812816">&amp;</span><span class="ident" id="5812817">driverConn</span><span class="op" id="5812827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812831">db</span><span class="op" id="5812833">:</span>&nbsp;<span class="ident" id="5812835">db</span><span class="op" id="5812837">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812841">ci</span><span class="op" id="5812843">:</span>&nbsp;<span class="ident" id="5812845">ci</span><span class="op" id="5812847">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5812850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5812853">if</span>&nbsp;<span class="ident" id="5812856">db</span><span class="op" id="5812858">.</span><span class="ident" id="5812859">putConnDBLocked</span><span class="op" id="5812874">(</span><span class="ident" id="5812875">dc</span><span class="op" id="5812877">,</span>&nbsp;<span class="ident" id="5812879">err</span><span class="op" id="5812882">)</span>&nbsp;<span class="op" id="5812884">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812888">db</span><span class="op" id="5812890">.</span><span class="ident" id="5812891">addDepLocked</span><span class="op" id="5812903">(</span><span class="ident" id="5812904">dc</span><span class="op" id="5812906">,</span>&nbsp;<span class="ident" id="5812908">dc</span><span class="op" id="5812910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812914">db</span><span class="op" id="5812916">.</span><span class="ident" id="5812917">numOpen</span><span class="op" id="5812924">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5812928">}</span>&nbsp;<span class="keyword" id="5812930">else</span>&nbsp;<span class="op" id="5812935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5812939">ci</span><span class="op" id="5812941">.</span><span class="ident" id="5812942">Close</span><span class="op" id="5812947">(</span><span class="op" id="5812948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5812951">}</span><br>
<span class="lineno">620</span><span class="op" id="5812953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5812956">//&nbsp;connRequest&nbsp;represents&nbsp;one&nbsp;request&nbsp;for&nbsp;a&nbsp;new&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5813015">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;idle&nbsp;connections&nbsp;available,&nbsp;DB.conn&nbsp;will&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="5813084">//&nbsp;a&nbsp;new&nbsp;connRequest&nbsp;and&nbsp;put&nbsp;it&nbsp;on&nbsp;the&nbsp;db.connRequests&nbsp;list.</span><br>
<span class="lineno">625</span><span class="keyword" id="5813145">type</span>&nbsp;<span class="ident" id="5813150">connRequest</span>&nbsp;<span class="keyword" id="5813162">struct</span>&nbsp;<span class="op" id="5813169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813172">conn</span>&nbsp;<span class="op" id="5813177">*</span><span class="ident" id="5813178">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813190">err</span>&nbsp;&nbsp;<span class="builtintype" id="5813195">error</span><br>
<span class="lineno"></span><span class="op" id="5813201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="5813204">var</span>&nbsp;<span class="ident" id="5813208">errDBClosed</span>&nbsp;<span class="op" id="5813220">=</span>&nbsp;<span class="ident" id="5813222">errors</span><span class="op" id="5813228">.</span><span class="ident" id="5813229">New</span><span class="op" id="5813232">(</span><span class="string" id="5813233">&#34;sql:&nbsp;database&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5813258">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5813261">//&nbsp;conn&nbsp;returns&nbsp;a&nbsp;newly-opened&nbsp;or&nbsp;cached&nbsp;*driverConn</span><br>
<span class="lineno"></span><span class="keyword" id="5813314">func</span>&nbsp;<span class="op" id="5813319">(</span><span class="ident" id="5813320">db</span>&nbsp;<span class="op" id="5813323">*</span><span class="ident" id="5813324">DB</span><span class="op" id="5813326">)</span>&nbsp;<span class="ident" id="5813328">conn</span><span class="op" id="5813332">(</span><span class="op" id="5813333">)</span>&nbsp;<span class="op" id="5813335">(</span><span class="op" id="5813336">*</span><span class="ident" id="5813337">driverConn</span><span class="op" id="5813347">,</span>&nbsp;<span class="builtintype" id="5813349">error</span><span class="op" id="5813354">)</span>&nbsp;<span class="op" id="5813356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813359">db</span><span class="op" id="5813361">.</span><span class="ident" id="5813362">mu</span><span class="op" id="5813364">.</span><span class="ident" id="5813365">Lock</span><span class="op" id="5813369">(</span><span class="op" id="5813370">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813373">if</span>&nbsp;<span class="ident" id="5813376">db</span><span class="op" id="5813378">.</span><span class="ident" id="5813379">closed</span>&nbsp;<span class="op" id="5813386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813390">db</span><span class="op" id="5813392">.</span><span class="ident" id="5813393">mu</span><span class="op" id="5813395">.</span><span class="ident" id="5813396">Unlock</span><span class="op" id="5813402">(</span><span class="op" id="5813403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813407">return</span>&nbsp;<span class="ident" id="5813414">nil</span><span class="op" id="5813417">,</span>&nbsp;<span class="ident" id="5813419">errDBClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5813432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5813436">//&nbsp;If&nbsp;db.maxOpen&nbsp;&gt;&nbsp;0&nbsp;and&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;is&nbsp;over&nbsp;the&nbsp;limit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5813511">//&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;free&nbsp;connection,&nbsp;make&nbsp;a&nbsp;request&nbsp;and&nbsp;wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813574">if</span>&nbsp;<span class="ident" id="5813577">db</span><span class="op" id="5813579">.</span><span class="ident" id="5813580">maxOpen</span>&nbsp;<span class="op" id="5813588">&gt;</span>&nbsp;<span class="num" id="5813590">0</span>&nbsp;<span class="op" id="5813592">&amp;&amp;</span>&nbsp;<span class="ident" id="5813595">db</span><span class="op" id="5813597">.</span><span class="ident" id="5813598">numOpen</span>&nbsp;<span class="op" id="5813606">&gt;=</span>&nbsp;<span class="ident" id="5813609">db</span><span class="op" id="5813611">.</span><span class="ident" id="5813612">maxOpen</span>&nbsp;<span class="op" id="5813620">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5813623">len</span><span class="op" id="5813626">(</span><span class="ident" id="5813627">db</span><span class="op" id="5813629">.</span><span class="ident" id="5813630">freeConn</span><span class="op" id="5813638">)</span>&nbsp;<span class="op" id="5813640">==</span>&nbsp;<span class="num" id="5813643">0</span>&nbsp;<span class="op" id="5813645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5813649">//&nbsp;Make&nbsp;the&nbsp;connRequest&nbsp;channel.&nbsp;It&#39;s&nbsp;buffered&nbsp;so&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5813710">//&nbsp;connectionOpener&nbsp;doesn&#39;t&nbsp;block&nbsp;while&nbsp;waiting&nbsp;for&nbsp;the&nbsp;req&nbsp;to&nbsp;be&nbsp;read.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813784">req</span>&nbsp;<span class="op" id="5813788">:=</span>&nbsp;<span class="builtinfunc" id="5813791">make</span><span class="op" id="5813795">(</span><span class="keyword" id="5813796">chan</span>&nbsp;<span class="ident" id="5813801">connRequest</span><span class="op" id="5813812">,</span>&nbsp;<span class="num" id="5813814">1</span><span class="op" id="5813815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813819">db</span><span class="op" id="5813821">.</span><span class="ident" id="5813822">connRequests</span>&nbsp;<span class="op" id="5813835">=</span>&nbsp;<span class="builtinfunc" id="5813837">append</span><span class="op" id="5813843">(</span><span class="ident" id="5813844">db</span><span class="op" id="5813846">.</span><span class="ident" id="5813847">connRequests</span><span class="op" id="5813859">,</span>&nbsp;<span class="ident" id="5813861">req</span><span class="op" id="5813864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813868">db</span><span class="op" id="5813870">.</span><span class="ident" id="5813871">maybeOpenNewConnections</span><span class="op" id="5813894">(</span><span class="op" id="5813895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813899">db</span><span class="op" id="5813901">.</span><span class="ident" id="5813902">mu</span><span class="op" id="5813904">.</span><span class="ident" id="5813905">Unlock</span><span class="op" id="5813911">(</span><span class="op" id="5813912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813916">ret</span>&nbsp;<span class="op" id="5813920">:=</span>&nbsp;<span class="op" id="5813923">&lt;-</span><span class="ident" id="5813925">req</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813931">return</span>&nbsp;<span class="ident" id="5813938">ret</span><span class="op" id="5813941">.</span><span class="ident" id="5813942">conn</span><span class="op" id="5813946">,</span>&nbsp;<span class="ident" id="5813948">ret</span><span class="op" id="5813951">.</span><span class="ident" id="5813952">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5813957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5813961">if</span>&nbsp;<span class="ident" id="5813964">c</span>&nbsp;<span class="op" id="5813966">:=</span>&nbsp;<span class="builtinfunc" id="5813969">len</span><span class="op" id="5813972">(</span><span class="ident" id="5813973">db</span><span class="op" id="5813975">.</span><span class="ident" id="5813976">freeConn</span><span class="op" id="5813984">)</span><span class="op" id="5813985">;</span>&nbsp;<span class="ident" id="5813987">c</span>&nbsp;<span class="op" id="5813989">&gt;</span>&nbsp;<span class="num" id="5813991">0</span>&nbsp;<span class="op" id="5813993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5813997">conn</span>&nbsp;<span class="op" id="5814002">:=</span>&nbsp;<span class="ident" id="5814005">db</span><span class="op" id="5814007">.</span><span class="ident" id="5814008">freeConn</span><span class="op" id="5814016">[</span><span class="num" id="5814017">0</span><span class="op" id="5814018">]</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5814022">copy</span><span class="op" id="5814026">(</span><span class="ident" id="5814027">db</span><span class="op" id="5814029">.</span><span class="ident" id="5814030">freeConn</span><span class="op" id="5814038">,</span>&nbsp;<span class="ident" id="5814040">db</span><span class="op" id="5814042">.</span><span class="ident" id="5814043">freeConn</span><span class="op" id="5814051">[</span><span class="num" id="5814052">1</span><span class="op" id="5814053">:</span><span class="op" id="5814054">]</span><span class="op" id="5814055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814059">db</span><span class="op" id="5814061">.</span><span class="ident" id="5814062">freeConn</span>&nbsp;<span class="op" id="5814071">=</span>&nbsp;<span class="ident" id="5814073">db</span><span class="op" id="5814075">.</span><span class="ident" id="5814076">freeConn</span><span class="op" id="5814084">[</span><span class="op" id="5814085">:</span><span class="ident" id="5814086">c</span><span class="op" id="5814087">-</span><span class="num" id="5814088">1</span><span class="op" id="5814089">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814093">conn</span><span class="op" id="5814097">.</span><span class="ident" id="5814098">inUse</span>&nbsp;<span class="op" id="5814104">=</span>&nbsp;<span class="builtintype" id="5814106">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814113">db</span><span class="op" id="5814115">.</span><span class="ident" id="5814116">mu</span><span class="op" id="5814118">.</span><span class="ident" id="5814119">Unlock</span><span class="op" id="5814125">(</span><span class="op" id="5814126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814130">return</span>&nbsp;<span class="ident" id="5814137">conn</span><span class="op" id="5814141">,</span>&nbsp;<span class="ident" id="5814143">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5814148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814152">db</span><span class="op" id="5814154">.</span><span class="ident" id="5814155">numOpen</span><span class="op" id="5814162">++</span>&nbsp;<span class="comment" id="5814165">//&nbsp;optimistically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814184">db</span><span class="op" id="5814186">.</span><span class="ident" id="5814187">mu</span><span class="op" id="5814189">.</span><span class="ident" id="5814190">Unlock</span><span class="op" id="5814196">(</span><span class="op" id="5814197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814200">ci</span><span class="op" id="5814202">,</span>&nbsp;<span class="ident" id="5814204">err</span>&nbsp;<span class="op" id="5814208">:=</span>&nbsp;<span class="ident" id="5814211">db</span><span class="op" id="5814213">.</span><span class="ident" id="5814214">driver</span><span class="op" id="5814220">.</span><span class="ident" id="5814221">Open</span><span class="op" id="5814225">(</span><span class="ident" id="5814226">db</span><span class="op" id="5814228">.</span><span class="ident" id="5814229">dsn</span><span class="op" id="5814232">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814235">if</span>&nbsp;<span class="ident" id="5814238">err</span>&nbsp;<span class="op" id="5814242">!=</span>&nbsp;<span class="ident" id="5814245">nil</span>&nbsp;<span class="op" id="5814249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814253">db</span><span class="op" id="5814255">.</span><span class="ident" id="5814256">mu</span><span class="op" id="5814258">.</span><span class="ident" id="5814259">Lock</span><span class="op" id="5814263">(</span><span class="op" id="5814264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814268">db</span><span class="op" id="5814270">.</span><span class="ident" id="5814271">numOpen</span><span class="op" id="5814278">--</span>&nbsp;<span class="comment" id="5814281">//&nbsp;correct&nbsp;for&nbsp;earlier&nbsp;optimism</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814315">db</span><span class="op" id="5814317">.</span><span class="ident" id="5814318">mu</span><span class="op" id="5814320">.</span><span class="ident" id="5814321">Unlock</span><span class="op" id="5814327">(</span><span class="op" id="5814328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814332">return</span>&nbsp;<span class="ident" id="5814339">nil</span><span class="op" id="5814342">,</span>&nbsp;<span class="ident" id="5814344">err</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5814349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814352">db</span><span class="op" id="5814354">.</span><span class="ident" id="5814355">mu</span><span class="op" id="5814357">.</span><span class="ident" id="5814358">Lock</span><span class="op" id="5814362">(</span><span class="op" id="5814363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814366">dc</span>&nbsp;<span class="op" id="5814369">:=</span>&nbsp;<span class="op" id="5814372">&amp;</span><span class="ident" id="5814373">driverConn</span><span class="op" id="5814383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814387">db</span><span class="op" id="5814389">:</span>&nbsp;<span class="ident" id="5814391">db</span><span class="op" id="5814393">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814397">ci</span><span class="op" id="5814399">:</span>&nbsp;<span class="ident" id="5814401">ci</span><span class="op" id="5814403">,</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5814406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814409">db</span><span class="op" id="5814411">.</span><span class="ident" id="5814412">addDepLocked</span><span class="op" id="5814424">(</span><span class="ident" id="5814425">dc</span><span class="op" id="5814427">,</span>&nbsp;<span class="ident" id="5814429">dc</span><span class="op" id="5814431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814434">dc</span><span class="op" id="5814436">.</span><span class="ident" id="5814437">inUse</span>&nbsp;<span class="op" id="5814443">=</span>&nbsp;<span class="builtintype" id="5814445">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814451">db</span><span class="op" id="5814453">.</span><span class="ident" id="5814454">mu</span><span class="op" id="5814456">.</span><span class="ident" id="5814457">Unlock</span><span class="op" id="5814463">(</span><span class="op" id="5814464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5814467">return</span>&nbsp;<span class="ident" id="5814474">dc</span><span class="op" id="5814476">,</span>&nbsp;<span class="ident" id="5814478">nil</span><br>
<span class="lineno">680</span><span class="op" id="5814482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5814485">var</span>&nbsp;<span class="op" id="5814489">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814492">errConnClosed</span>&nbsp;<span class="op" id="5814506">=</span>&nbsp;<span class="ident" id="5814508">errors</span><span class="op" id="5814514">.</span><span class="ident" id="5814515">New</span><span class="op" id="5814518">(</span><span class="string" id="5814519">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5814574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814577">errConnBusy</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5814591">=</span>&nbsp;<span class="ident" id="5814593">errors</span><span class="op" id="5814599">.</span><span class="ident" id="5814600">New</span><span class="op" id="5814603">(</span><span class="string" id="5814604">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;busy&#34;</span><span class="op" id="5814657">)</span><br>
<span class="lineno">685</span><span class="op" id="5814659">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5814662">//&nbsp;connIfFree&nbsp;returns&nbsp;(wanted,&nbsp;nil)&nbsp;if&nbsp;wanted&nbsp;is&nbsp;still&nbsp;a&nbsp;valid&nbsp;conn&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5814734">//&nbsp;isn&#39;t&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="comment" id="5814751">//</span><br>
<span class="lineno">690</span><span class="comment" id="5814754">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnClosed&nbsp;if&nbsp;the&nbsp;connection&nbsp;if&nbsp;the&nbsp;requested&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5814830">//&nbsp;is&nbsp;invalid&nbsp;because&nbsp;it&#39;s&nbsp;been&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="5814870">//</span><br>
<span class="lineno"></span><span class="comment" id="5814873">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnBusy&nbsp;if&nbsp;the&nbsp;connection&nbsp;is&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="5814930">func</span>&nbsp;<span class="op" id="5814935">(</span><span class="ident" id="5814936">db</span>&nbsp;<span class="op" id="5814939">*</span><span class="ident" id="5814940">DB</span><span class="op" id="5814942">)</span>&nbsp;<span class="ident" id="5814944">connIfFree</span><span class="op" id="5814954">(</span><span class="ident" id="5814955">wanted</span>&nbsp;<span class="op" id="5814962">*</span><span class="ident" id="5814963">driverConn</span><span class="op" id="5814973">)</span>&nbsp;<span class="op" id="5814975">(</span><span class="op" id="5814976">*</span><span class="ident" id="5814977">driverConn</span><span class="op" id="5814987">,</span>&nbsp;<span class="builtintype" id="5814989">error</span><span class="op" id="5814994">)</span>&nbsp;<span class="op" id="5814996">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5814999">db</span><span class="op" id="5815001">.</span><span class="ident" id="5815002">mu</span><span class="op" id="5815004">.</span><span class="ident" id="5815005">Lock</span><span class="op" id="5815009">(</span><span class="op" id="5815010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815013">defer</span>&nbsp;<span class="ident" id="5815019">db</span><span class="op" id="5815021">.</span><span class="ident" id="5815022">mu</span><span class="op" id="5815024">.</span><span class="ident" id="5815025">Unlock</span><span class="op" id="5815031">(</span><span class="op" id="5815032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815035">if</span>&nbsp;<span class="ident" id="5815038">wanted</span><span class="op" id="5815044">.</span><span class="ident" id="5815045">dbmuClosed</span>&nbsp;<span class="op" id="5815056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815060">return</span>&nbsp;<span class="ident" id="5815067">nil</span><span class="op" id="5815070">,</span>&nbsp;<span class="ident" id="5815072">errConnClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5815087">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815090">if</span>&nbsp;<span class="ident" id="5815093">wanted</span><span class="op" id="5815099">.</span><span class="ident" id="5815100">inUse</span>&nbsp;<span class="op" id="5815106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815110">return</span>&nbsp;<span class="ident" id="5815117">nil</span><span class="op" id="5815120">,</span>&nbsp;<span class="ident" id="5815122">errConnBusy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5815135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815138">idx</span>&nbsp;<span class="op" id="5815142">:=</span>&nbsp;<span class="op" id="5815145">-</span><span class="num" id="5815146">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815149">for</span>&nbsp;<span class="ident" id="5815153">ii</span><span class="op" id="5815155">,</span>&nbsp;<span class="ident" id="5815157">v</span>&nbsp;<span class="op" id="5815159">:=</span>&nbsp;<span class="keyword" id="5815162">range</span>&nbsp;<span class="ident" id="5815168">db</span><span class="op" id="5815170">.</span><span class="ident" id="5815171">freeConn</span>&nbsp;<span class="op" id="5815180">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815184">if</span>&nbsp;<span class="ident" id="5815187">v</span>&nbsp;<span class="op" id="5815189">==</span>&nbsp;<span class="ident" id="5815192">wanted</span>&nbsp;<span class="op" id="5815199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815204">idx</span>&nbsp;<span class="op" id="5815208">=</span>&nbsp;<span class="ident" id="5815210">ii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815216">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5815224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5815227">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815230">if</span>&nbsp;<span class="ident" id="5815233">idx</span>&nbsp;<span class="op" id="5815237">&gt;=</span>&nbsp;<span class="num" id="5815240">0</span>&nbsp;<span class="op" id="5815242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815246">db</span><span class="op" id="5815248">.</span><span class="ident" id="5815249">freeConn</span>&nbsp;<span class="op" id="5815258">=</span>&nbsp;<span class="builtinfunc" id="5815260">append</span><span class="op" id="5815266">(</span><span class="ident" id="5815267">db</span><span class="op" id="5815269">.</span><span class="ident" id="5815270">freeConn</span><span class="op" id="5815278">[</span><span class="op" id="5815279">:</span><span class="ident" id="5815280">idx</span><span class="op" id="5815283">]</span><span class="op" id="5815284">,</span>&nbsp;<span class="ident" id="5815286">db</span><span class="op" id="5815288">.</span><span class="ident" id="5815289">freeConn</span><span class="op" id="5815297">[</span><span class="ident" id="5815298">idx</span><span class="op" id="5815301">+</span><span class="num" id="5815302">1</span><span class="op" id="5815303">:</span><span class="op" id="5815304">]</span><span class="op" id="5815305">...</span><span class="op" id="5815308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815312">wanted</span><span class="op" id="5815318">.</span><span class="ident" id="5815319">inUse</span>&nbsp;<span class="op" id="5815325">=</span>&nbsp;<span class="builtintype" id="5815327">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815334">return</span>&nbsp;<span class="ident" id="5815341">wanted</span><span class="op" id="5815347">,</span>&nbsp;<span class="ident" id="5815349">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5815354">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5815357">//&nbsp;TODO(bradfitz):&nbsp;shouldn&#39;t&nbsp;get&nbsp;here.&nbsp;After&nbsp;Go&nbsp;1.1,&nbsp;change&nbsp;this&nbsp;to:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5815427">//&nbsp;panic(&#34;connIfFree&nbsp;call&nbsp;requested&nbsp;a&nbsp;non-closed,&nbsp;non-busy,&nbsp;non-free&nbsp;conn&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5815504">//&nbsp;Which&nbsp;passes&nbsp;all&nbsp;the&nbsp;tests,&nbsp;but&nbsp;I&#39;m&nbsp;too&nbsp;paranoid&nbsp;to&nbsp;include&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5815573">//&nbsp;late&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5815593">//&nbsp;Instead,&nbsp;treat&nbsp;it&nbsp;like&nbsp;a&nbsp;busy&nbsp;connection:</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815639">return</span>&nbsp;<span class="ident" id="5815646">nil</span><span class="op" id="5815649">,</span>&nbsp;<span class="ident" id="5815651">errConnBusy</span><br>
<span class="lineno"></span><span class="op" id="5815663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5815666">//&nbsp;putConnHook&nbsp;is&nbsp;a&nbsp;hook&nbsp;for&nbsp;testing.</span><br>
<span class="lineno"></span><span class="keyword" id="5815704">var</span>&nbsp;<span class="ident" id="5815708">putConnHook</span>&nbsp;<span class="keyword" id="5815720">func</span><span class="op" id="5815724">(</span><span class="op" id="5815725">*</span><span class="ident" id="5815726">DB</span><span class="op" id="5815728">,</span>&nbsp;<span class="op" id="5815730">*</span><span class="ident" id="5815731">driverConn</span><span class="op" id="5815741">)</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="5815744">//&nbsp;noteUnusedDriverStatement&nbsp;notes&nbsp;that&nbsp;si&nbsp;is&nbsp;no&nbsp;longer&nbsp;used&nbsp;and&nbsp;should</span><br>
<span class="lineno"></span><span class="comment" id="5815816">//&nbsp;be&nbsp;closed&nbsp;whenever&nbsp;possible&nbsp;(when&nbsp;c&nbsp;is&nbsp;next&nbsp;not&nbsp;in&nbsp;use),&nbsp;unless&nbsp;c&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5815888">//&nbsp;already&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="5815907">func</span>&nbsp;<span class="op" id="5815912">(</span><span class="ident" id="5815913">db</span>&nbsp;<span class="op" id="5815916">*</span><span class="ident" id="5815917">DB</span><span class="op" id="5815919">)</span>&nbsp;<span class="ident" id="5815921">noteUnusedDriverStatement</span><span class="op" id="5815946">(</span><span class="ident" id="5815947">c</span>&nbsp;<span class="op" id="5815949">*</span><span class="ident" id="5815950">driverConn</span><span class="op" id="5815960">,</span>&nbsp;<span class="ident" id="5815962">si</span>&nbsp;<span class="ident" id="5815965">driver</span><span class="op" id="5815971">.</span><span class="ident" id="5815972">Stmt</span><span class="op" id="5815976">)</span>&nbsp;<span class="op" id="5815978">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5815981">db</span><span class="op" id="5815983">.</span><span class="ident" id="5815984">mu</span><span class="op" id="5815986">.</span><span class="ident" id="5815987">Lock</span><span class="op" id="5815991">(</span><span class="op" id="5815992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5815995">defer</span>&nbsp;<span class="ident" id="5816001">db</span><span class="op" id="5816003">.</span><span class="ident" id="5816004">mu</span><span class="op" id="5816006">.</span><span class="ident" id="5816007">Unlock</span><span class="op" id="5816013">(</span><span class="op" id="5816014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816017">if</span>&nbsp;<span class="ident" id="5816020">c</span><span class="op" id="5816021">.</span><span class="ident" id="5816022">inUse</span>&nbsp;<span class="op" id="5816028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816032">c</span><span class="op" id="5816033">.</span><span class="ident" id="5816034">onPut</span>&nbsp;<span class="op" id="5816040">=</span>&nbsp;<span class="builtinfunc" id="5816042">append</span><span class="op" id="5816048">(</span><span class="ident" id="5816049">c</span><span class="op" id="5816050">.</span><span class="ident" id="5816051">onPut</span><span class="op" id="5816056">,</span>&nbsp;<span class="keyword" id="5816058">func</span><span class="op" id="5816062">(</span><span class="op" id="5816063">)</span>&nbsp;<span class="op" id="5816065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816070">si</span><span class="op" id="5816072">.</span><span class="ident" id="5816073">Close</span><span class="op" id="5816078">(</span><span class="op" id="5816079">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5816083">}</span><span class="op" id="5816084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5816087">}</span>&nbsp;<span class="keyword" id="5816089">else</span>&nbsp;<span class="op" id="5816094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816098">c</span><span class="op" id="5816099">.</span><span class="ident" id="5816100">Lock</span><span class="op" id="5816104">(</span><span class="op" id="5816105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816109">defer</span>&nbsp;<span class="ident" id="5816115">c</span><span class="op" id="5816116">.</span><span class="ident" id="5816117">Unlock</span><span class="op" id="5816123">(</span><span class="op" id="5816124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816128">if</span>&nbsp;<span class="op" id="5816131">!</span><span class="ident" id="5816132">c</span><span class="op" id="5816133">.</span><span class="ident" id="5816134">finalClosed</span>&nbsp;<span class="op" id="5816146">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816151">si</span><span class="op" id="5816153">.</span><span class="ident" id="5816154">Close</span><span class="op" id="5816159">(</span><span class="op" id="5816160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5816164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5816167">}</span><br>
<span class="lineno"></span><span class="op" id="5816169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">745</span><span class="comment" id="5816172">//&nbsp;debugGetPut&nbsp;determines&nbsp;whether&nbsp;getConn&nbsp;&amp;&nbsp;putConn&nbsp;calls&#39;&nbsp;stack&nbsp;traces</span><br>
<span class="lineno"></span><span class="comment" id="5816244">//&nbsp;are&nbsp;returned&nbsp;for&nbsp;more&nbsp;verbose&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="5816286">const</span>&nbsp;<span class="ident" id="5816292">debugGetPut</span>&nbsp;<span class="op" id="5816304">=</span>&nbsp;<span class="builtintype" id="5816306">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5816313">//&nbsp;putConn&nbsp;adds&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;db&#39;s&nbsp;free&nbsp;pool.</span><br>
<span class="lineno">750</span><span class="comment" id="5816365">//&nbsp;err&nbsp;is&nbsp;optionally&nbsp;the&nbsp;last&nbsp;error&nbsp;that&nbsp;occurred&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5816435">func</span>&nbsp;<span class="op" id="5816440">(</span><span class="ident" id="5816441">db</span>&nbsp;<span class="op" id="5816444">*</span><span class="ident" id="5816445">DB</span><span class="op" id="5816447">)</span>&nbsp;<span class="ident" id="5816449">putConn</span><span class="op" id="5816456">(</span><span class="ident" id="5816457">dc</span>&nbsp;<span class="op" id="5816460">*</span><span class="ident" id="5816461">driverConn</span><span class="op" id="5816471">,</span>&nbsp;<span class="ident" id="5816473">err</span>&nbsp;<span class="builtintype" id="5816477">error</span><span class="op" id="5816482">)</span>&nbsp;<span class="op" id="5816484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816487">db</span><span class="op" id="5816489">.</span><span class="ident" id="5816490">mu</span><span class="op" id="5816492">.</span><span class="ident" id="5816493">Lock</span><span class="op" id="5816497">(</span><span class="op" id="5816498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816501">if</span>&nbsp;<span class="op" id="5816504">!</span><span class="ident" id="5816505">dc</span><span class="op" id="5816507">.</span><span class="ident" id="5816508">inUse</span>&nbsp;<span class="op" id="5816514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816518">if</span>&nbsp;<span class="ident" id="5816521">debugGetPut</span>&nbsp;<span class="op" id="5816533">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816538">fmt</span><span class="op" id="5816541">.</span><span class="ident" id="5816542">Printf</span><span class="op" id="5816548">(</span><span class="string" id="5816549">&#34;putConn(%v)&nbsp;DUPLICATE&nbsp;was:&nbsp;%s\n\nPREVIOUS&nbsp;was:&nbsp;%s&#34;</span><span class="op" id="5816600">,</span>&nbsp;<span class="ident" id="5816602">dc</span><span class="op" id="5816604">,</span>&nbsp;<span class="ident" id="5816606">stack</span><span class="op" id="5816611">(</span><span class="op" id="5816612">)</span><span class="op" id="5816613">,</span>&nbsp;<span class="ident" id="5816615">db</span><span class="op" id="5816617">.</span><span class="ident" id="5816618">lastPut</span><span class="op" id="5816625">[</span><span class="ident" id="5816626">dc</span><span class="op" id="5816628">]</span><span class="op" id="5816629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5816633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5816637">panic</span><span class="op" id="5816642">(</span><span class="string" id="5816643">&#34;sql:&nbsp;connection&nbsp;returned&nbsp;that&nbsp;was&nbsp;never&nbsp;out&#34;</span><span class="op" id="5816688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5816691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816694">if</span>&nbsp;<span class="ident" id="5816697">debugGetPut</span>&nbsp;<span class="op" id="5816709">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816713">db</span><span class="op" id="5816715">.</span><span class="ident" id="5816716">lastPut</span><span class="op" id="5816723">[</span><span class="ident" id="5816724">dc</span><span class="op" id="5816726">]</span>&nbsp;<span class="op" id="5816728">=</span>&nbsp;<span class="ident" id="5816730">stack</span><span class="op" id="5816735">(</span><span class="op" id="5816736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5816739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816742">dc</span><span class="op" id="5816744">.</span><span class="ident" id="5816745">inUse</span>&nbsp;<span class="op" id="5816751">=</span>&nbsp;<span class="builtintype" id="5816753">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816761">for</span>&nbsp;<span class="ident" id="5816765">_</span><span class="op" id="5816766">,</span>&nbsp;<span class="ident" id="5816768">fn</span>&nbsp;<span class="op" id="5816771">:=</span>&nbsp;<span class="keyword" id="5816774">range</span>&nbsp;<span class="ident" id="5816780">dc</span><span class="op" id="5816782">.</span><span class="ident" id="5816783">onPut</span>&nbsp;<span class="op" id="5816789">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816793">fn</span><span class="op" id="5816795">(</span><span class="op" id="5816796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5816799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5816802">dc</span><span class="op" id="5816804">.</span><span class="ident" id="5816805">onPut</span>&nbsp;<span class="op" id="5816811">=</span>&nbsp;<span class="ident" id="5816813">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5816819">if</span>&nbsp;<span class="ident" id="5816822">err</span>&nbsp;<span class="op" id="5816826">==</span>&nbsp;<span class="ident" id="5816829">driver</span><span class="op" id="5816835">.</span><span class="ident" id="5816836">ErrBadConn</span>&nbsp;<span class="op" id="5816847">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5816851">//&nbsp;Don&#39;t&nbsp;reuse&nbsp;bad&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5816885">//&nbsp;Since&nbsp;the&nbsp;conn&nbsp;is&nbsp;considered&nbsp;bad&nbsp;and&nbsp;is&nbsp;being&nbsp;discarded,&nbsp;treat&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5816956">//&nbsp;as&nbsp;closed.&nbsp;Don&#39;t&nbsp;decrement&nbsp;the&nbsp;open&nbsp;count&nbsp;here,&nbsp;finalClose&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5817025">//&nbsp;take&nbsp;care&nbsp;of&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5817049">db</span><span class="op" id="5817051">.</span><span class="ident" id="5817052">maybeOpenNewConnections</span><span class="op" id="5817075">(</span><span class="op" id="5817076">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5817080">db</span><span class="op" id="5817082">.</span><span class="ident" id="5817083">mu</span><span class="op" id="5817085">.</span><span class="ident" id="5817086">Unlock</span><span class="op" id="5817092">(</span><span class="op" id="5817093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5817097">dc</span><span class="op" id="5817099">.</span><span class="ident" id="5817100">Close</span><span class="op" id="5817105">(</span><span class="op" id="5817106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5817110">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5817118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5817121">if</span>&nbsp;<span class="ident" id="5817124">putConnHook</span>&nbsp;<span class="op" id="5817136">!=</span>&nbsp;<span class="ident" id="5817139">nil</span>&nbsp;<span class="op" id="5817143">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5817147">putConnHook</span><span class="op" id="5817158">(</span><span class="ident" id="5817159">db</span><span class="op" id="5817161">,</span>&nbsp;<span class="ident" id="5817163">dc</span><span class="op" id="5817165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5817168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5817171">added</span>&nbsp;<span class="op" id="5817177">:=</span>&nbsp;<span class="ident" id="5817180">db</span><span class="op" id="5817182">.</span><span class="ident" id="5817183">putConnDBLocked</span><span class="op" id="5817198">(</span><span class="ident" id="5817199">dc</span><span class="op" id="5817201">,</span>&nbsp;<span class="ident" id="5817203">nil</span><span class="op" id="5817206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5817209">db</span><span class="op" id="5817211">.</span><span class="ident" id="5817212">mu</span><span class="op" id="5817214">.</span><span class="ident" id="5817215">Unlock</span><span class="op" id="5817221">(</span><span class="op" id="5817222">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5817226">if</span>&nbsp;<span class="op" id="5817229">!</span><span class="ident" id="5817230">added</span>&nbsp;<span class="op" id="5817236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5817240">dc</span><span class="op" id="5817242">.</span><span class="ident" id="5817243">Close</span><span class="op" id="5817248">(</span><span class="op" id="5817249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5817252">}</span><br>
<span class="lineno"></span><span class="op" id="5817254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">790</span><span class="comment" id="5817257">//&nbsp;Satisfy&nbsp;a&nbsp;connRequest&nbsp;or&nbsp;put&nbsp;the&nbsp;driverConn&nbsp;in&nbsp;the&nbsp;idle&nbsp;pool&nbsp;and&nbsp;return&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="5817337">//&nbsp;or&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="5817357">//&nbsp;putConnDBLocked&nbsp;will&nbsp;satisfy&nbsp;a&nbsp;connRequest&nbsp;if&nbsp;there&nbsp;is&nbsp;one,&nbsp;or&nbsp;it&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="5817431">//&nbsp;return&nbsp;the&nbsp;*driverConn&nbsp;to&nbsp;the&nbsp;freeConn&nbsp;list&nbsp;if&nbsp;err&nbsp;==&nbsp;nil&nbsp;and&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="5817505">//&nbsp;connection&nbsp;limit&nbsp;will&nbsp;not&nbsp;be&nbsp;exceeded.</span><br>
<span class="lineno">795</span><span class="comment" id="5817547">//&nbsp;If&nbsp;err&nbsp;!=&nbsp;nil,&nbsp;the&nbsp;value&nbsp;of&nbsp;dc&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="5817593">//&nbsp;If&nbsp;err&nbsp;==&nbsp;nil,&nbsp;then&nbsp;dc&nbsp;must&nbsp;not&nbsp;equal&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="5817639">//&nbsp;If&nbsp;a&nbsp;connRequest&nbsp;was&nbsp;fulfilled&nbsp;or&nbsp;the&nbsp;*driverConn&nbsp;was&nbsp;placed&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5817710">//&nbsp;freeConn&nbsp;list,&nbsp;then&nbsp;true&nbsp;is&nbsp;returned,&nbsp;otherwise&nbsp;false&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5817780">func</span>&nbsp;<span class="op" id="5817785">(</span><span class="ident" id="5817786">db</span>&nbsp;<span class="op" id="5817789">*</span><span class="ident" id="5817790">DB</span><span class="op" id="5817792">)</span>&nbsp;<span class="ident" id="5817794">putConnDBLocked</span><span class="op" id="5817809">(</span><span class="ident" id="5817810">dc</span>&nbsp;<span class="op" id="5817813">*</span><span class="ident" id="5817814">driverConn</span><span class="op" id="5817824">,</span>&nbsp;<span class="ident" id="5817826">err</span>&nbsp;<span class="builtintype" id="5817830">error</span><span class="op" id="5817835">)</span>&nbsp;<span class="builtintype" id="5817837">bool</span>&nbsp;<span class="op" id="5817842">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5817845">if</span>&nbsp;<span class="ident" id="5817848">c</span>&nbsp;<span class="op" id="5817850">:=</span>&nbsp;<span class="builtinfunc" id="5817853">len</span><span class="op" id="5817856">(</span><span class="ident" id="5817857">db</span><span class="op" id="5817859">.</span><span class="ident" id="5817860">connRequests</span><span class="op" id="5817872">)</span><span class="op" id="5817873">;</span>&nbsp;<span class="ident" id="5817875">c</span>&nbsp;<span class="op" id="5817877">&gt;</span>&nbsp;<span class="num" id="5817879">0</span>&nbsp;<span class="op" id="5817881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5817885">req</span>&nbsp;<span class="op" id="5817889">:=</span>&nbsp;<span class="ident" id="5817892">db</span><span class="op" id="5817894">.</span><span class="ident" id="5817895">connRequests</span><span class="op" id="5817907">[</span><span class="num" id="5817908">0</span><span class="op" id="5817909">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5817913">//&nbsp;This&nbsp;copy&nbsp;is&nbsp;O(n)&nbsp;but&nbsp;in&nbsp;practice&nbsp;faster&nbsp;than&nbsp;a&nbsp;linked&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5817979">//&nbsp;TODO:&nbsp;consider&nbsp;compacting&nbsp;it&nbsp;down&nbsp;less&nbsp;often&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5818033">//&nbsp;moving&nbsp;the&nbsp;base&nbsp;instead?</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5818063">copy</span><span class="op" id="5818067">(</span><span class="ident" id="5818068">db</span><span class="op" id="5818070">.</span><span class="ident" id="5818071">connRequests</span><span class="op" id="5818083">,</span>&nbsp;<span class="ident" id="5818085">db</span><span class="op" id="5818087">.</span><span class="ident" id="5818088">connRequests</span><span class="op" id="5818100">[</span><span class="num" id="5818101">1</span><span class="op" id="5818102">:</span><span class="op" id="5818103">]</span><span class="op" id="5818104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818108">db</span><span class="op" id="5818110">.</span><span class="ident" id="5818111">connRequests</span>&nbsp;<span class="op" id="5818124">=</span>&nbsp;<span class="ident" id="5818126">db</span><span class="op" id="5818128">.</span><span class="ident" id="5818129">connRequests</span><span class="op" id="5818141">[</span><span class="op" id="5818142">:</span><span class="ident" id="5818143">c</span><span class="op" id="5818144">-</span><span class="num" id="5818145">1</span><span class="op" id="5818146">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818150">if</span>&nbsp;<span class="ident" id="5818153">err</span>&nbsp;<span class="op" id="5818157">==</span>&nbsp;<span class="ident" id="5818160">nil</span>&nbsp;<span class="op" id="5818164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818169">dc</span><span class="op" id="5818171">.</span><span class="ident" id="5818172">inUse</span>&nbsp;<span class="op" id="5818178">=</span>&nbsp;<span class="builtintype" id="5818180">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5818187">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818191">req</span>&nbsp;<span class="op" id="5818195">&lt;-</span>&nbsp;<span class="ident" id="5818198">connRequest</span><span class="op" id="5818209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818214">conn</span><span class="op" id="5818218">:</span>&nbsp;<span class="ident" id="5818220">dc</span><span class="op" id="5818222">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818227">err</span><span class="op" id="5818230">:</span>&nbsp;&nbsp;<span class="ident" id="5818233">err</span><span class="op" id="5818236">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5818240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818244">return</span>&nbsp;<span class="builtintype" id="5818251">true</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5818257">}</span>&nbsp;<span class="keyword" id="5818259">else</span>&nbsp;<span class="keyword" id="5818264">if</span>&nbsp;<span class="ident" id="5818267">err</span>&nbsp;<span class="op" id="5818271">==</span>&nbsp;<span class="ident" id="5818274">nil</span>&nbsp;<span class="op" id="5818278">&amp;&amp;</span>&nbsp;<span class="op" id="5818281">!</span><span class="ident" id="5818282">db</span><span class="op" id="5818284">.</span><span class="ident" id="5818285">closed</span>&nbsp;<span class="op" id="5818292">&amp;&amp;</span>&nbsp;<span class="ident" id="5818295">db</span><span class="op" id="5818297">.</span><span class="ident" id="5818298">maxIdleConnsLocked</span><span class="op" id="5818316">(</span><span class="op" id="5818317">)</span>&nbsp;<span class="op" id="5818319">&gt;</span>&nbsp;<span class="builtinfunc" id="5818321">len</span><span class="op" id="5818324">(</span><span class="ident" id="5818325">db</span><span class="op" id="5818327">.</span><span class="ident" id="5818328">freeConn</span><span class="op" id="5818336">)</span>&nbsp;<span class="op" id="5818338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818342">db</span><span class="op" id="5818344">.</span><span class="ident" id="5818345">freeConn</span>&nbsp;<span class="op" id="5818354">=</span>&nbsp;<span class="builtinfunc" id="5818356">append</span><span class="op" id="5818362">(</span><span class="ident" id="5818363">db</span><span class="op" id="5818365">.</span><span class="ident" id="5818366">freeConn</span><span class="op" id="5818374">,</span>&nbsp;<span class="ident" id="5818376">dc</span><span class="op" id="5818378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818382">return</span>&nbsp;<span class="builtintype" id="5818389">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5818395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818398">return</span>&nbsp;<span class="builtintype" id="5818405">false</span><br>
<span class="lineno">820</span><span class="op" id="5818411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5818414">//&nbsp;maxBadConnRetries&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;maximum&nbsp;retries&nbsp;if&nbsp;the&nbsp;driver&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5818490">//&nbsp;driver.ErrBadConn&nbsp;to&nbsp;signal&nbsp;a&nbsp;broken&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5818542">const</span>&nbsp;<span class="ident" id="5818548">maxBadConnRetries</span>&nbsp;<span class="op" id="5818566">=</span>&nbsp;<span class="num" id="5818568">10</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="comment" id="5818572">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;later&nbsp;queries&nbsp;or&nbsp;executions.</span><br>
<span class="lineno"></span><span class="comment" id="5818645">//&nbsp;Multiple&nbsp;queries&nbsp;or&nbsp;executions&nbsp;may&nbsp;be&nbsp;run&nbsp;concurrently&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5818712">//&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5818735">func</span>&nbsp;<span class="op" id="5818740">(</span><span class="ident" id="5818741">db</span>&nbsp;<span class="op" id="5818744">*</span><span class="ident" id="5818745">DB</span><span class="op" id="5818747">)</span>&nbsp;<span class="ident" id="5818749">Prepare</span><span class="op" id="5818756">(</span><span class="ident" id="5818757">query</span>&nbsp;<span class="builtintype" id="5818763">string</span><span class="op" id="5818769">)</span>&nbsp;<span class="op" id="5818771">(</span><span class="op" id="5818772">*</span><span class="ident" id="5818773">Stmt</span><span class="op" id="5818777">,</span>&nbsp;<span class="builtintype" id="5818779">error</span><span class="op" id="5818784">)</span>&nbsp;<span class="op" id="5818786">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818789">var</span>&nbsp;<span class="ident" id="5818793">stmt</span>&nbsp;<span class="op" id="5818798">*</span><span class="ident" id="5818799">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818805">var</span>&nbsp;<span class="ident" id="5818809">err</span>&nbsp;<span class="builtintype" id="5818813">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818820">for</span>&nbsp;<span class="ident" id="5818824">i</span>&nbsp;<span class="op" id="5818826">:=</span>&nbsp;<span class="num" id="5818829">0</span><span class="op" id="5818830">;</span>&nbsp;<span class="ident" id="5818832">i</span>&nbsp;<span class="op" id="5818834">&lt;</span>&nbsp;<span class="ident" id="5818836">maxBadConnRetries</span><span class="op" id="5818853">;</span>&nbsp;<span class="ident" id="5818855">i</span><span class="op" id="5818856">++</span>&nbsp;<span class="op" id="5818859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5818863">stmt</span><span class="op" id="5818867">,</span>&nbsp;<span class="ident" id="5818869">err</span>&nbsp;<span class="op" id="5818873">=</span>&nbsp;<span class="ident" id="5818875">db</span><span class="op" id="5818877">.</span><span class="ident" id="5818878">prepare</span><span class="op" id="5818885">(</span><span class="ident" id="5818886">query</span><span class="op" id="5818891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818895">if</span>&nbsp;<span class="ident" id="5818898">err</span>&nbsp;<span class="op" id="5818902">!=</span>&nbsp;<span class="ident" id="5818905">driver</span><span class="op" id="5818911">.</span><span class="ident" id="5818912">ErrBadConn</span>&nbsp;<span class="op" id="5818923">{</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818928">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5818936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5818939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5818942">return</span>&nbsp;<span class="ident" id="5818949">stmt</span><span class="op" id="5818953">,</span>&nbsp;<span class="ident" id="5818955">err</span><br>
<span class="lineno"></span><span class="op" id="5818959">}</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span><span class="keyword" id="5818962">func</span>&nbsp;<span class="op" id="5818967">(</span><span class="ident" id="5818968">db</span>&nbsp;<span class="op" id="5818971">*</span><span class="ident" id="5818972">DB</span><span class="op" id="5818974">)</span>&nbsp;<span class="ident" id="5818976">prepare</span><span class="op" id="5818983">(</span><span class="ident" id="5818984">query</span>&nbsp;<span class="builtintype" id="5818990">string</span><span class="op" id="5818996">)</span>&nbsp;<span class="op" id="5818998">(</span><span class="op" id="5818999">*</span><span class="ident" id="5819000">Stmt</span><span class="op" id="5819004">,</span>&nbsp;<span class="builtintype" id="5819006">error</span><span class="op" id="5819011">)</span>&nbsp;<span class="op" id="5819013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5819016">//&nbsp;TODO:&nbsp;check&nbsp;if&nbsp;db.driver&nbsp;supports&nbsp;an&nbsp;optional</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5819066">//&nbsp;driver.Preparer&nbsp;interface&nbsp;and&nbsp;call&nbsp;that&nbsp;instead,&nbsp;if&nbsp;so,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5819126">//&nbsp;otherwise&nbsp;we&nbsp;make&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;that&#39;s&nbsp;bound</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5819182">//&nbsp;to&nbsp;a&nbsp;connection,&nbsp;and&nbsp;to&nbsp;execute&nbsp;this&nbsp;prepared&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5819242">//&nbsp;we&nbsp;either&nbsp;need&nbsp;to&nbsp;use&nbsp;this&nbsp;connection&nbsp;(if&nbsp;it&#39;s&nbsp;free),&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5819305">//&nbsp;get&nbsp;a&nbsp;new&nbsp;connection&nbsp;+&nbsp;re-prepare&nbsp;+&nbsp;execute&nbsp;on&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819366">dc</span><span class="op" id="5819368">,</span>&nbsp;<span class="ident" id="5819370">err</span>&nbsp;<span class="op" id="5819374">:=</span>&nbsp;<span class="ident" id="5819377">db</span><span class="op" id="5819379">.</span><span class="ident" id="5819380">conn</span><span class="op" id="5819384">(</span><span class="op" id="5819385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5819388">if</span>&nbsp;<span class="ident" id="5819391">err</span>&nbsp;<span class="op" id="5819395">!=</span>&nbsp;<span class="ident" id="5819398">nil</span>&nbsp;<span class="op" id="5819402">{</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5819406">return</span>&nbsp;<span class="ident" id="5819413">nil</span><span class="op" id="5819416">,</span>&nbsp;<span class="ident" id="5819418">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5819423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819426">dc</span><span class="op" id="5819428">.</span><span class="ident" id="5819429">Lock</span><span class="op" id="5819433">(</span><span class="op" id="5819434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819437">si</span><span class="op" id="5819439">,</span>&nbsp;<span class="ident" id="5819441">err</span>&nbsp;<span class="op" id="5819445">:=</span>&nbsp;<span class="ident" id="5819448">dc</span><span class="op" id="5819450">.</span><span class="ident" id="5819451">prepareLocked</span><span class="op" id="5819464">(</span><span class="ident" id="5819465">query</span><span class="op" id="5819470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819473">dc</span><span class="op" id="5819475">.</span><span class="ident" id="5819476">Unlock</span><span class="op" id="5819482">(</span><span class="op" id="5819483">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5819486">if</span>&nbsp;<span class="ident" id="5819489">err</span>&nbsp;<span class="op" id="5819493">!=</span>&nbsp;<span class="ident" id="5819496">nil</span>&nbsp;<span class="op" id="5819500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819504">db</span><span class="op" id="5819506">.</span><span class="ident" id="5819507">putConn</span><span class="op" id="5819514">(</span><span class="ident" id="5819515">dc</span><span class="op" id="5819517">,</span>&nbsp;<span class="ident" id="5819519">err</span><span class="op" id="5819522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5819526">return</span>&nbsp;<span class="ident" id="5819533">nil</span><span class="op" id="5819536">,</span>&nbsp;<span class="ident" id="5819538">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5819543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819546">stmt</span>&nbsp;<span class="op" id="5819551">:=</span>&nbsp;<span class="op" id="5819554">&amp;</span><span class="ident" id="5819555">Stmt</span><span class="op" id="5819559">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819563">db</span><span class="op" id="5819565">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5819570">db</span><span class="op" id="5819572">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819576">query</span><span class="op" id="5819581">:</span>&nbsp;<span class="ident" id="5819583">query</span><span class="op" id="5819588">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819592">css</span><span class="op" id="5819595">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5819599">[</span><span class="op" id="5819600">]</span><span class="ident" id="5819601">connStmt</span><span class="op" id="5819609">{</span><span class="op" id="5819610">{</span><span class="ident" id="5819611">dc</span><span class="op" id="5819613">,</span>&nbsp;<span class="ident" id="5819615">si</span><span class="op" id="5819617">}</span><span class="op" id="5819618">}</span><span class="op" id="5819619">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5819622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819625">db</span><span class="op" id="5819627">.</span><span class="ident" id="5819628">addDep</span><span class="op" id="5819634">(</span><span class="ident" id="5819635">stmt</span><span class="op" id="5819639">,</span>&nbsp;<span class="ident" id="5819641">stmt</span><span class="op" id="5819645">)</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819648">db</span><span class="op" id="5819650">.</span><span class="ident" id="5819651">putConn</span><span class="op" id="5819658">(</span><span class="ident" id="5819659">dc</span><span class="op" id="5819661">,</span>&nbsp;<span class="ident" id="5819663">nil</span><span class="op" id="5819666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5819669">return</span>&nbsp;<span class="ident" id="5819676">stmt</span><span class="op" id="5819680">,</span>&nbsp;<span class="ident" id="5819682">nil</span><br>
<span class="lineno"></span><span class="op" id="5819686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5819689">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;without&nbsp;returning&nbsp;any&nbsp;rows.</span><br>
<span class="lineno">870</span><span class="comment" id="5819742">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno"></span><span class="keyword" id="5819803">func</span>&nbsp;<span class="op" id="5819808">(</span><span class="ident" id="5819809">db</span>&nbsp;<span class="op" id="5819812">*</span><span class="ident" id="5819813">DB</span><span class="op" id="5819815">)</span>&nbsp;<span class="ident" id="5819817">Exec</span><span class="op" id="5819821">(</span><span class="ident" id="5819822">query</span>&nbsp;<span class="builtintype" id="5819828">string</span><span class="op" id="5819834">,</span>&nbsp;<span class="ident" id="5819836">args</span>&nbsp;<span class="op" id="5819841">...</span><span class="keyword" id="5819844">interface</span><span class="op" id="5819853">{</span><span class="op" id="5819854">}</span><span class="op" id="5819855">)</span>&nbsp;<span class="op" id="5819857">(</span><span class="ident" id="5819858">Result</span><span class="op" id="5819864">,</span>&nbsp;<span class="builtintype" id="5819866">error</span><span class="op" id="5819871">)</span>&nbsp;<span class="op" id="5819873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5819876">var</span>&nbsp;<span class="ident" id="5819880">res</span>&nbsp;<span class="ident" id="5819884">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5819892">var</span>&nbsp;<span class="ident" id="5819896">err</span>&nbsp;<span class="builtintype" id="5819900">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5819907">for</span>&nbsp;<span class="ident" id="5819911">i</span>&nbsp;<span class="op" id="5819913">:=</span>&nbsp;<span class="num" id="5819916">0</span><span class="op" id="5819917">;</span>&nbsp;<span class="ident" id="5819919">i</span>&nbsp;<span class="op" id="5819921">&lt;</span>&nbsp;<span class="ident" id="5819923">maxBadConnRetries</span><span class="op" id="5819940">;</span>&nbsp;<span class="ident" id="5819942">i</span><span class="op" id="5819943">++</span>&nbsp;<span class="op" id="5819946">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5819950">res</span><span class="op" id="5819953">,</span>&nbsp;<span class="ident" id="5819955">err</span>&nbsp;<span class="op" id="5819959">=</span>&nbsp;<span class="ident" id="5819961">db</span><span class="op" id="5819963">.</span><span class="ident" id="5819964">exec</span><span class="op" id="5819968">(</span><span class="ident" id="5819969">query</span><span class="op" id="5819974">,</span>&nbsp;<span class="ident" id="5819976">args</span><span class="op" id="5819980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5819984">if</span>&nbsp;<span class="ident" id="5819987">err</span>&nbsp;<span class="op" id="5819991">!=</span>&nbsp;<span class="ident" id="5819994">driver</span><span class="op" id="5820000">.</span><span class="ident" id="5820001">ErrBadConn</span>&nbsp;<span class="op" id="5820012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820017">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5820025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5820028">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820031">return</span>&nbsp;<span class="ident" id="5820038">res</span><span class="op" id="5820041">,</span>&nbsp;<span class="ident" id="5820043">err</span><br>
<span class="lineno"></span><span class="op" id="5820047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5820050">func</span>&nbsp;<span class="op" id="5820055">(</span><span class="ident" id="5820056">db</span>&nbsp;<span class="op" id="5820059">*</span><span class="ident" id="5820060">DB</span><span class="op" id="5820062">)</span>&nbsp;<span class="ident" id="5820064">exec</span><span class="op" id="5820068">(</span><span class="ident" id="5820069">query</span>&nbsp;<span class="builtintype" id="5820075">string</span><span class="op" id="5820081">,</span>&nbsp;<span class="ident" id="5820083">args</span>&nbsp;<span class="op" id="5820088">[</span><span class="op" id="5820089">]</span><span class="keyword" id="5820090">interface</span><span class="op" id="5820099">{</span><span class="op" id="5820100">}</span><span class="op" id="5820101">)</span>&nbsp;<span class="op" id="5820103">(</span><span class="ident" id="5820104">res</span>&nbsp;<span class="ident" id="5820108">Result</span><span class="op" id="5820114">,</span>&nbsp;<span class="ident" id="5820116">err</span>&nbsp;<span class="builtintype" id="5820120">error</span><span class="op" id="5820125">)</span>&nbsp;<span class="op" id="5820127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5820130">dc</span><span class="op" id="5820132">,</span>&nbsp;<span class="ident" id="5820134">err</span>&nbsp;<span class="op" id="5820138">:=</span>&nbsp;<span class="ident" id="5820141">db</span><span class="op" id="5820143">.</span><span class="ident" id="5820144">conn</span><span class="op" id="5820148">(</span><span class="op" id="5820149">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820152">if</span>&nbsp;<span class="ident" id="5820155">err</span>&nbsp;<span class="op" id="5820159">!=</span>&nbsp;<span class="ident" id="5820162">nil</span>&nbsp;<span class="op" id="5820166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820170">return</span>&nbsp;<span class="ident" id="5820177">nil</span><span class="op" id="5820180">,</span>&nbsp;<span class="ident" id="5820182">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5820187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820190">defer</span>&nbsp;<span class="keyword" id="5820196">func</span><span class="op" id="5820200">(</span><span class="op" id="5820201">)</span>&nbsp;<span class="op" id="5820203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5820207">db</span><span class="op" id="5820209">.</span><span class="ident" id="5820210">putConn</span><span class="op" id="5820217">(</span><span class="ident" id="5820218">dc</span><span class="op" id="5820220">,</span>&nbsp;<span class="ident" id="5820222">err</span><span class="op" id="5820225">)</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5820228">}</span><span class="op" id="5820229">(</span><span class="op" id="5820230">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820234">if</span>&nbsp;<span class="ident" id="5820237">execer</span><span class="op" id="5820243">,</span>&nbsp;<span class="ident" id="5820245">ok</span>&nbsp;<span class="op" id="5820248">:=</span>&nbsp;<span class="ident" id="5820251">dc</span><span class="op" id="5820253">.</span><span class="ident" id="5820254">ci</span><span class="op" id="5820256">.</span><span class="op" id="5820257">(</span><span class="ident" id="5820258">driver</span><span class="op" id="5820264">.</span><span class="ident" id="5820265">Execer</span><span class="op" id="5820271">)</span><span class="op" id="5820272">;</span>&nbsp;<span class="ident" id="5820274">ok</span>&nbsp;<span class="op" id="5820277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5820281">dargs</span><span class="op" id="5820286">,</span>&nbsp;<span class="ident" id="5820288">err</span>&nbsp;<span class="op" id="5820292">:=</span>&nbsp;<span class="ident" id="5820295">driverArgs</span><span class="op" id="5820305">(</span><span class="ident" id="5820306">nil</span><span class="op" id="5820309">,</span>&nbsp;<span class="ident" id="5820311">args</span><span class="op" id="5820315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820319">if</span>&nbsp;<span class="ident" id="5820322">err</span>&nbsp;<span class="op" id="5820326">!=</span>&nbsp;<span class="ident" id="5820329">nil</span>&nbsp;<span class="op" id="5820333">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820338">return</span>&nbsp;<span class="ident" id="5820345">nil</span><span class="op" id="5820348">,</span>&nbsp;<span class="ident" id="5820350">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5820356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5820360">dc</span><span class="op" id="5820362">.</span><span class="ident" id="5820363">Lock</span><span class="op" id="5820367">(</span><span class="op" id="5820368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5820372">resi</span><span class="op" id="5820376">,</span>&nbsp;<span class="ident" id="5820378">err</span>&nbsp;<span class="op" id="5820382">:=</span>&nbsp;<span class="ident" id="5820385">execer</span><span class="op" id="5820391">.</span><span class="ident" id="5820392">Exec</span><span class="op" id="5820396">(</span><span class="ident" id="5820397">query</span><span class="op" id="5820402">,</span>&nbsp;<span class="ident" id="5820404">dargs</span><span class="op" id="5820409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5820413">dc</span><span class="op" id="5820415">.</span><span class="ident" id="5820416">Unlock</span><span class="op" id="5820422">(</span><span class="op" id="5820423">)</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820427">if</span>&nbsp;<span class="ident" id="5820430">err</span>&nbsp;<span class="op" id="5820434">!=</span>&nbsp;<span class="ident" id="5820437">driver</span><span class="op" id="5820443">.</span><span class="ident" id="5820444">ErrSkip</span>&nbsp;<span class="op" id="5820452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820457">if</span>&nbsp;<span class="ident" id="5820460">err</span>&nbsp;<span class="op" id="5820464">!=</span>&nbsp;<span class="ident" id="5820467">nil</span>&nbsp;<span class="op" id="5820471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820477">return</span>&nbsp;<span class="ident" id="5820484">nil</span><span class="op" id="5820487">,</span>&nbsp;<span class="ident" id="5820489">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5820496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820501">return</span>&nbsp;<span class="ident" id="5820508">driverResult</span><span class="op" id="5820520">{</span><span class="ident" id="5820521">dc</span><span class="op" id="5820523">,</span>&nbsp;<span class="ident" id="5820525">resi</span><span class="op" id="5820529">}</span><span class="op" id="5820530">,</span>&nbsp;<span class="ident" id="5820532">nil</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5820538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5820541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5820545">dc</span><span class="op" id="5820547">.</span><span class="ident" id="5820548">Lock</span><span class="op" id="5820552">(</span><span class="op" id="5820553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5820556">si</span><span class="op" id="5820558">,</span>&nbsp;<span class="ident" id="5820560">err</span>&nbsp;<span class="op" id="5820564">:=</span>&nbsp;<span class="ident" id="5820567">dc</span><span class="op" id="5820569">.</span><span class="ident" id="5820570">ci</span><span class="op" id="5820572">.</span><span class="ident" id="5820573">Prepare</span><span class="op" id="5820580">(</span><span class="ident" id="5820581">query</span><span class="op" id="5820586">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5820589">dc</span><span class="op" id="5820591">.</span><span class="ident" id="5820592">Unlock</span><span class="op" id="5820598">(</span><span class="op" id="5820599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820602">if</span>&nbsp;<span class="ident" id="5820605">err</span>&nbsp;<span class="op" id="5820609">!=</span>&nbsp;<span class="ident" id="5820612">nil</span>&nbsp;<span class="op" id="5820616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820620">return</span>&nbsp;<span class="ident" id="5820627">nil</span><span class="op" id="5820630">,</span>&nbsp;<span class="ident" id="5820632">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5820637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820640">defer</span>&nbsp;<span class="ident" id="5820646">withLock</span><span class="op" id="5820654">(</span><span class="ident" id="5820655">dc</span><span class="op" id="5820657">,</span>&nbsp;<span class="keyword" id="5820659">func</span><span class="op" id="5820663">(</span><span class="op" id="5820664">)</span>&nbsp;<span class="op" id="5820666">{</span>&nbsp;<span class="ident" id="5820668">si</span><span class="op" id="5820670">.</span><span class="ident" id="5820671">Close</span><span class="op" id="5820676">(</span><span class="op" id="5820677">)</span>&nbsp;<span class="op" id="5820679">}</span><span class="op" id="5820680">)</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820683">return</span>&nbsp;<span class="ident" id="5820690">resultFromStatement</span><span class="op" id="5820709">(</span><span class="ident" id="5820710">driverStmt</span><span class="op" id="5820720">{</span><span class="ident" id="5820721">dc</span><span class="op" id="5820723">,</span>&nbsp;<span class="ident" id="5820725">si</span><span class="op" id="5820727">}</span><span class="op" id="5820728">,</span>&nbsp;<span class="ident" id="5820730">args</span><span class="op" id="5820734">...</span><span class="op" id="5820737">)</span><br>
<span class="lineno"></span><span class="op" id="5820739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5820742">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="comment" id="5820807">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno">920</span><span class="keyword" id="5820868">func</span>&nbsp;<span class="op" id="5820873">(</span><span class="ident" id="5820874">db</span>&nbsp;<span class="op" id="5820877">*</span><span class="ident" id="5820878">DB</span><span class="op" id="5820880">)</span>&nbsp;<span class="ident" id="5820882">Query</span><span class="op" id="5820887">(</span><span class="ident" id="5820888">query</span>&nbsp;<span class="builtintype" id="5820894">string</span><span class="op" id="5820900">,</span>&nbsp;<span class="ident" id="5820902">args</span>&nbsp;<span class="op" id="5820907">...</span><span class="keyword" id="5820910">interface</span><span class="op" id="5820919">{</span><span class="op" id="5820920">}</span><span class="op" id="5820921">)</span>&nbsp;<span class="op" id="5820923">(</span><span class="op" id="5820924">*</span><span class="ident" id="5820925">Rows</span><span class="op" id="5820929">,</span>&nbsp;<span class="builtintype" id="5820931">error</span><span class="op" id="5820936">)</span>&nbsp;<span class="op" id="5820938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820941">var</span>&nbsp;<span class="ident" id="5820945">rows</span>&nbsp;<span class="op" id="5820950">*</span><span class="ident" id="5820951">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820957">var</span>&nbsp;<span class="ident" id="5820961">err</span>&nbsp;<span class="builtintype" id="5820965">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5820972">for</span>&nbsp;<span class="ident" id="5820976">i</span>&nbsp;<span class="op" id="5820978">:=</span>&nbsp;<span class="num" id="5820981">0</span><span class="op" id="5820982">;</span>&nbsp;<span class="ident" id="5820984">i</span>&nbsp;<span class="op" id="5820986">&lt;</span>&nbsp;<span class="ident" id="5820988">maxBadConnRetries</span><span class="op" id="5821005">;</span>&nbsp;<span class="ident" id="5821007">i</span><span class="op" id="5821008">++</span>&nbsp;<span class="op" id="5821011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5821015">rows</span><span class="op" id="5821019">,</span>&nbsp;<span class="ident" id="5821021">err</span>&nbsp;<span class="op" id="5821025">=</span>&nbsp;<span class="ident" id="5821027">db</span><span class="op" id="5821029">.</span><span class="ident" id="5821030">query</span><span class="op" id="5821035">(</span><span class="ident" id="5821036">query</span><span class="op" id="5821041">,</span>&nbsp;<span class="ident" id="5821043">args</span><span class="op" id="5821047">)</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821051">if</span>&nbsp;<span class="ident" id="5821054">err</span>&nbsp;<span class="op" id="5821058">!=</span>&nbsp;<span class="ident" id="5821061">driver</span><span class="op" id="5821067">.</span><span class="ident" id="5821068">ErrBadConn</span>&nbsp;<span class="op" id="5821079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821084">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5821092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5821095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821098">return</span>&nbsp;<span class="ident" id="5821105">rows</span><span class="op" id="5821109">,</span>&nbsp;<span class="ident" id="5821111">err</span><br>
<span class="lineno">930</span><span class="op" id="5821115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5821118">func</span>&nbsp;<span class="op" id="5821123">(</span><span class="ident" id="5821124">db</span>&nbsp;<span class="op" id="5821127">*</span><span class="ident" id="5821128">DB</span><span class="op" id="5821130">)</span>&nbsp;<span class="ident" id="5821132">query</span><span class="op" id="5821137">(</span><span class="ident" id="5821138">query</span>&nbsp;<span class="builtintype" id="5821144">string</span><span class="op" id="5821150">,</span>&nbsp;<span class="ident" id="5821152">args</span>&nbsp;<span class="op" id="5821157">[</span><span class="op" id="5821158">]</span><span class="keyword" id="5821159">interface</span><span class="op" id="5821168">{</span><span class="op" id="5821169">}</span><span class="op" id="5821170">)</span>&nbsp;<span class="op" id="5821172">(</span><span class="op" id="5821173">*</span><span class="ident" id="5821174">Rows</span><span class="op" id="5821178">,</span>&nbsp;<span class="builtintype" id="5821180">error</span><span class="op" id="5821185">)</span>&nbsp;<span class="op" id="5821187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5821190">ci</span><span class="op" id="5821192">,</span>&nbsp;<span class="ident" id="5821194">err</span>&nbsp;<span class="op" id="5821198">:=</span>&nbsp;<span class="ident" id="5821201">db</span><span class="op" id="5821203">.</span><span class="ident" id="5821204">conn</span><span class="op" id="5821208">(</span><span class="op" id="5821209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821212">if</span>&nbsp;<span class="ident" id="5821215">err</span>&nbsp;<span class="op" id="5821219">!=</span>&nbsp;<span class="ident" id="5821222">nil</span>&nbsp;<span class="op" id="5821226">{</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821230">return</span>&nbsp;<span class="ident" id="5821237">nil</span><span class="op" id="5821240">,</span>&nbsp;<span class="ident" id="5821242">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5821247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821251">return</span>&nbsp;<span class="ident" id="5821258">db</span><span class="op" id="5821260">.</span><span class="ident" id="5821261">queryConn</span><span class="op" id="5821270">(</span><span class="ident" id="5821271">ci</span><span class="op" id="5821273">,</span>&nbsp;<span class="ident" id="5821275">ci</span><span class="op" id="5821277">.</span><span class="ident" id="5821278">releaseConn</span><span class="op" id="5821289">,</span>&nbsp;<span class="ident" id="5821291">query</span><span class="op" id="5821296">,</span>&nbsp;<span class="ident" id="5821298">args</span><span class="op" id="5821302">)</span><br>
<span class="lineno"></span><span class="op" id="5821304">}</span><br>
<span class="lineno">940</span><br>
<span class="lineno"></span><span class="comment" id="5821307">//&nbsp;queryConn&nbsp;executes&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;given&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5821362">//&nbsp;The&nbsp;connection&nbsp;gets&nbsp;released&nbsp;by&nbsp;the&nbsp;releaseConn&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="5821423">func</span>&nbsp;<span class="op" id="5821428">(</span><span class="ident" id="5821429">db</span>&nbsp;<span class="op" id="5821432">*</span><span class="ident" id="5821433">DB</span><span class="op" id="5821435">)</span>&nbsp;<span class="ident" id="5821437">queryConn</span><span class="op" id="5821446">(</span><span class="ident" id="5821447">dc</span>&nbsp;<span class="op" id="5821450">*</span><span class="ident" id="5821451">driverConn</span><span class="op" id="5821461">,</span>&nbsp;<span class="ident" id="5821463">releaseConn</span>&nbsp;<span class="keyword" id="5821475">func</span><span class="op" id="5821479">(</span><span class="builtintype" id="5821480">error</span><span class="op" id="5821485">)</span><span class="op" id="5821486">,</span>&nbsp;<span class="ident" id="5821488">query</span>&nbsp;<span class="builtintype" id="5821494">string</span><span class="op" id="5821500">,</span>&nbsp;<span class="ident" id="5821502">args</span>&nbsp;<span class="op" id="5821507">[</span><span class="op" id="5821508">]</span><span class="keyword" id="5821509">interface</span><span class="op" id="5821518">{</span><span class="op" id="5821519">}</span><span class="op" id="5821520">)</span>&nbsp;<span class="op" id="5821522">(</span><span class="op" id="5821523">*</span><span class="ident" id="5821524">Rows</span><span class="op" id="5821528">,</span>&nbsp;<span class="builtintype" id="5821530">error</span><span class="op" id="5821535">)</span>&nbsp;<span class="op" id="5821537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821540">if</span>&nbsp;<span class="ident" id="5821543">queryer</span><span class="op" id="5821550">,</span>&nbsp;<span class="ident" id="5821552">ok</span>&nbsp;<span class="op" id="5821555">:=</span>&nbsp;<span class="ident" id="5821558">dc</span><span class="op" id="5821560">.</span><span class="ident" id="5821561">ci</span><span class="op" id="5821563">.</span><span class="op" id="5821564">(</span><span class="ident" id="5821565">driver</span><span class="op" id="5821571">.</span><span class="ident" id="5821572">Queryer</span><span class="op" id="5821579">)</span><span class="op" id="5821580">;</span>&nbsp;<span class="ident" id="5821582">ok</span>&nbsp;<span class="op" id="5821585">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5821589">dargs</span><span class="op" id="5821594">,</span>&nbsp;<span class="ident" id="5821596">err</span>&nbsp;<span class="op" id="5821600">:=</span>&nbsp;<span class="ident" id="5821603">driverArgs</span><span class="op" id="5821613">(</span><span class="ident" id="5821614">nil</span><span class="op" id="5821617">,</span>&nbsp;<span class="ident" id="5821619">args</span><span class="op" id="5821623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821627">if</span>&nbsp;<span class="ident" id="5821630">err</span>&nbsp;<span class="op" id="5821634">!=</span>&nbsp;<span class="ident" id="5821637">nil</span>&nbsp;<span class="op" id="5821641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5821646">releaseConn</span><span class="op" id="5821657">(</span><span class="ident" id="5821658">err</span><span class="op" id="5821661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821666">return</span>&nbsp;<span class="ident" id="5821673">nil</span><span class="op" id="5821676">,</span>&nbsp;<span class="ident" id="5821678">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5821684">}</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5821688">dc</span><span class="op" id="5821690">.</span><span class="ident" id="5821691">Lock</span><span class="op" id="5821695">(</span><span class="op" id="5821696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5821700">rowsi</span><span class="op" id="5821705">,</span>&nbsp;<span class="ident" id="5821707">err</span>&nbsp;<span class="op" id="5821711">:=</span>&nbsp;<span class="ident" id="5821714">queryer</span><span class="op" id="5821721">.</span><span class="ident" id="5821722">Query</span><span class="op" id="5821727">(</span><span class="ident" id="5821728">query</span><span class="op" id="5821733">,</span>&nbsp;<span class="ident" id="5821735">dargs</span><span class="op" id="5821740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5821744">dc</span><span class="op" id="5821746">.</span><span class="ident" id="5821747">Unlock</span><span class="op" id="5821753">(</span><span class="op" id="5821754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821758">if</span>&nbsp;<span class="ident" id="5821761">err</span>&nbsp;<span class="op" id="5821765">!=</span>&nbsp;<span class="ident" id="5821768">driver</span><span class="op" id="5821774">.</span><span class="ident" id="5821775">ErrSkip</span>&nbsp;<span class="op" id="5821783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821788">if</span>&nbsp;<span class="ident" id="5821791">err</span>&nbsp;<span class="op" id="5821795">!=</span>&nbsp;<span class="ident" id="5821798">nil</span>&nbsp;<span class="op" id="5821802">{</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5821808">releaseConn</span><span class="op" id="5821819">(</span><span class="ident" id="5821820">err</span><span class="op" id="5821823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5821829">return</span>&nbsp;<span class="ident" id="5821836">nil</span><span class="op" id="5821839">,</span>&nbsp;<span class="ident" id="5821841">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5821848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5821853">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;dc&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5821914">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5821938">rows</span>&nbsp;<span class="op" id="5821943">:=</span>&nbsp;<span class="op" id="5821946">&amp;</span><span class="ident" id="5821947">Rows</span><span class="op" id="5821951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5821957">dc</span><span class="op" id="5821959">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5821970">dc</span><span class="op" id="5821972">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5821978">releaseConn</span><span class="op" id="5821989">:</span>&nbsp;<span class="ident" id="5821991">releaseConn</span><span class="op" id="5822002">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822008">rowsi</span><span class="op" id="5822013">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5822021">rowsi</span><span class="op" id="5822026">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5822031">}</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5822036">return</span>&nbsp;<span class="ident" id="5822043">rows</span><span class="op" id="5822047">,</span>&nbsp;<span class="ident" id="5822049">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5822055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5822058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822062">dc</span><span class="op" id="5822064">.</span><span class="ident" id="5822065">Lock</span><span class="op" id="5822069">(</span><span class="op" id="5822070">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822073">si</span><span class="op" id="5822075">,</span>&nbsp;<span class="ident" id="5822077">err</span>&nbsp;<span class="op" id="5822081">:=</span>&nbsp;<span class="ident" id="5822084">dc</span><span class="op" id="5822086">.</span><span class="ident" id="5822087">ci</span><span class="op" id="5822089">.</span><span class="ident" id="5822090">Prepare</span><span class="op" id="5822097">(</span><span class="ident" id="5822098">query</span><span class="op" id="5822103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822106">dc</span><span class="op" id="5822108">.</span><span class="ident" id="5822109">Unlock</span><span class="op" id="5822115">(</span><span class="op" id="5822116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5822119">if</span>&nbsp;<span class="ident" id="5822122">err</span>&nbsp;<span class="op" id="5822126">!=</span>&nbsp;<span class="ident" id="5822129">nil</span>&nbsp;<span class="op" id="5822133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822137">releaseConn</span><span class="op" id="5822148">(</span><span class="ident" id="5822149">err</span><span class="op" id="5822152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5822156">return</span>&nbsp;<span class="ident" id="5822163">nil</span><span class="op" id="5822166">,</span>&nbsp;<span class="ident" id="5822168">err</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5822173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822177">ds</span>&nbsp;<span class="op" id="5822180">:=</span>&nbsp;<span class="ident" id="5822183">driverStmt</span><span class="op" id="5822193">{</span><span class="ident" id="5822194">dc</span><span class="op" id="5822196">,</span>&nbsp;<span class="ident" id="5822198">si</span><span class="op" id="5822200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822203">rowsi</span><span class="op" id="5822208">,</span>&nbsp;<span class="ident" id="5822210">err</span>&nbsp;<span class="op" id="5822214">:=</span>&nbsp;<span class="ident" id="5822217">rowsiFromStatement</span><span class="op" id="5822235">(</span><span class="ident" id="5822236">ds</span><span class="op" id="5822238">,</span>&nbsp;<span class="ident" id="5822240">args</span><span class="op" id="5822244">...</span><span class="op" id="5822247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5822250">if</span>&nbsp;<span class="ident" id="5822253">err</span>&nbsp;<span class="op" id="5822257">!=</span>&nbsp;<span class="ident" id="5822260">nil</span>&nbsp;<span class="op" id="5822264">{</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822268">dc</span><span class="op" id="5822270">.</span><span class="ident" id="5822271">Lock</span><span class="op" id="5822275">(</span><span class="op" id="5822276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822280">si</span><span class="op" id="5822282">.</span><span class="ident" id="5822283">Close</span><span class="op" id="5822288">(</span><span class="op" id="5822289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822293">dc</span><span class="op" id="5822295">.</span><span class="ident" id="5822296">Unlock</span><span class="op" id="5822302">(</span><span class="op" id="5822303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822307">releaseConn</span><span class="op" id="5822318">(</span><span class="ident" id="5822319">err</span><span class="op" id="5822322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5822326">return</span>&nbsp;<span class="ident" id="5822333">nil</span><span class="op" id="5822336">,</span>&nbsp;<span class="ident" id="5822338">err</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5822343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5822347">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5822406">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822428">rows</span>&nbsp;<span class="op" id="5822433">:=</span>&nbsp;<span class="op" id="5822436">&amp;</span><span class="ident" id="5822437">Rows</span><span class="op" id="5822441">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822445">dc</span><span class="op" id="5822447">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5822458">dc</span><span class="op" id="5822460">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822464">releaseConn</span><span class="op" id="5822475">:</span>&nbsp;<span class="ident" id="5822477">releaseConn</span><span class="op" id="5822488">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822492">rowsi</span><span class="op" id="5822497">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5822505">rowsi</span><span class="op" id="5822510">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822514">closeStmt</span><span class="op" id="5822523">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5822527">si</span><span class="op" id="5822529">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5822532">}</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5822535">return</span>&nbsp;<span class="ident" id="5822542">rows</span><span class="op" id="5822546">,</span>&nbsp;<span class="ident" id="5822548">nil</span><br>
<span class="lineno"></span><span class="op" id="5822552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5822555">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="5822628">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno">1000</span><span class="comment" id="5822697">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="5822729">func</span>&nbsp;<span class="op" id="5822734">(</span><span class="ident" id="5822735">db</span>&nbsp;<span class="op" id="5822738">*</span><span class="ident" id="5822739">DB</span><span class="op" id="5822741">)</span>&nbsp;<span class="ident" id="5822743">QueryRow</span><span class="op" id="5822751">(</span><span class="ident" id="5822752">query</span>&nbsp;<span class="builtintype" id="5822758">string</span><span class="op" id="5822764">,</span>&nbsp;<span class="ident" id="5822766">args</span>&nbsp;<span class="op" id="5822771">...</span><span class="keyword" id="5822774">interface</span><span class="op" id="5822783">{</span><span class="op" id="5822784">}</span><span class="op" id="5822785">)</span>&nbsp;<span class="op" id="5822787">*</span><span class="ident" id="5822788">Row</span>&nbsp;<span class="op" id="5822792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5822795">rows</span><span class="op" id="5822799">,</span>&nbsp;<span class="ident" id="5822801">err</span>&nbsp;<span class="op" id="5822805">:=</span>&nbsp;<span class="ident" id="5822808">db</span><span class="op" id="5822810">.</span><span class="ident" id="5822811">Query</span><span class="op" id="5822816">(</span><span class="ident" id="5822817">query</span><span class="op" id="5822822">,</span>&nbsp;<span class="ident" id="5822824">args</span><span class="op" id="5822828">...</span><span class="op" id="5822831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5822834">return</span>&nbsp;<span class="op" id="5822841">&amp;</span><span class="ident" id="5822842">Row</span><span class="op" id="5822845">{</span><span class="ident" id="5822846">rows</span><span class="op" id="5822850">:</span>&nbsp;<span class="ident" id="5822852">rows</span><span class="op" id="5822856">,</span>&nbsp;<span class="ident" id="5822858">err</span><span class="op" id="5822861">:</span>&nbsp;<span class="ident" id="5822863">err</span><span class="op" id="5822866">}</span><br>
<span class="lineno"></span><span class="op" id="5822868">}</span><br>
<span class="lineno">1005</span><br>
<span class="lineno"></span><span class="comment" id="5822871">//&nbsp;Begin&nbsp;starts&nbsp;a&nbsp;transaction.&nbsp;The&nbsp;isolation&nbsp;level&nbsp;is&nbsp;dependent&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="5822938">//&nbsp;the&nbsp;driver.</span><br>
<span class="lineno"></span><span class="keyword" id="5822953">func</span>&nbsp;<span class="op" id="5822958">(</span><span class="ident" id="5822959">db</span>&nbsp;<span class="op" id="5822962">*</span><span class="ident" id="5822963">DB</span><span class="op" id="5822965">)</span>&nbsp;<span class="ident" id="5822967">Begin</span><span class="op" id="5822972">(</span><span class="op" id="5822973">)</span>&nbsp;<span class="op" id="5822975">(</span><span class="op" id="5822976">*</span><span class="ident" id="5822977">Tx</span><span class="op" id="5822979">,</span>&nbsp;<span class="builtintype" id="5822981">error</span><span class="op" id="5822986">)</span>&nbsp;<span class="op" id="5822988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5822991">var</span>&nbsp;<span class="ident" id="5822995">tx</span>&nbsp;<span class="op" id="5822998">*</span><span class="ident" id="5822999">Tx</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823003">var</span>&nbsp;<span class="ident" id="5823007">err</span>&nbsp;<span class="builtintype" id="5823011">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823018">for</span>&nbsp;<span class="ident" id="5823022">i</span>&nbsp;<span class="op" id="5823024">:=</span>&nbsp;<span class="num" id="5823027">0</span><span class="op" id="5823028">;</span>&nbsp;<span class="ident" id="5823030">i</span>&nbsp;<span class="op" id="5823032">&lt;</span>&nbsp;<span class="ident" id="5823034">maxBadConnRetries</span><span class="op" id="5823051">;</span>&nbsp;<span class="ident" id="5823053">i</span><span class="op" id="5823054">++</span>&nbsp;<span class="op" id="5823057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5823061">tx</span><span class="op" id="5823063">,</span>&nbsp;<span class="ident" id="5823065">err</span>&nbsp;<span class="op" id="5823069">=</span>&nbsp;<span class="ident" id="5823071">db</span><span class="op" id="5823073">.</span><span class="ident" id="5823074">begin</span><span class="op" id="5823079">(</span><span class="op" id="5823080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823084">if</span>&nbsp;<span class="ident" id="5823087">err</span>&nbsp;<span class="op" id="5823091">!=</span>&nbsp;<span class="ident" id="5823094">driver</span><span class="op" id="5823100">.</span><span class="ident" id="5823101">ErrBadConn</span>&nbsp;<span class="op" id="5823112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823117">break</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5823125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5823128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823131">return</span>&nbsp;<span class="ident" id="5823138">tx</span><span class="op" id="5823140">,</span>&nbsp;<span class="ident" id="5823142">err</span><br>
<span class="lineno"></span><span class="op" id="5823146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1020</span><span class="keyword" id="5823149">func</span>&nbsp;<span class="op" id="5823154">(</span><span class="ident" id="5823155">db</span>&nbsp;<span class="op" id="5823158">*</span><span class="ident" id="5823159">DB</span><span class="op" id="5823161">)</span>&nbsp;<span class="ident" id="5823163">begin</span><span class="op" id="5823168">(</span><span class="op" id="5823169">)</span>&nbsp;<span class="op" id="5823171">(</span><span class="ident" id="5823172">tx</span>&nbsp;<span class="op" id="5823175">*</span><span class="ident" id="5823176">Tx</span><span class="op" id="5823178">,</span>&nbsp;<span class="ident" id="5823180">err</span>&nbsp;<span class="builtintype" id="5823184">error</span><span class="op" id="5823189">)</span>&nbsp;<span class="op" id="5823191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5823194">dc</span><span class="op" id="5823196">,</span>&nbsp;<span class="ident" id="5823198">err</span>&nbsp;<span class="op" id="5823202">:=</span>&nbsp;<span class="ident" id="5823205">db</span><span class="op" id="5823207">.</span><span class="ident" id="5823208">conn</span><span class="op" id="5823212">(</span><span class="op" id="5823213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823216">if</span>&nbsp;<span class="ident" id="5823219">err</span>&nbsp;<span class="op" id="5823223">!=</span>&nbsp;<span class="ident" id="5823226">nil</span>&nbsp;<span class="op" id="5823230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823234">return</span>&nbsp;<span class="ident" id="5823241">nil</span><span class="op" id="5823244">,</span>&nbsp;<span class="ident" id="5823246">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5823251">}</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5823254">dc</span><span class="op" id="5823256">.</span><span class="ident" id="5823257">Lock</span><span class="op" id="5823261">(</span><span class="op" id="5823262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5823265">txi</span><span class="op" id="5823268">,</span>&nbsp;<span class="ident" id="5823270">err</span>&nbsp;<span class="op" id="5823274">:=</span>&nbsp;<span class="ident" id="5823277">dc</span><span class="op" id="5823279">.</span><span class="ident" id="5823280">ci</span><span class="op" id="5823282">.</span><span class="ident" id="5823283">Begin</span><span class="op" id="5823288">(</span><span class="op" id="5823289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5823292">dc</span><span class="op" id="5823294">.</span><span class="ident" id="5823295">Unlock</span><span class="op" id="5823301">(</span><span class="op" id="5823302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823305">if</span>&nbsp;<span class="ident" id="5823308">err</span>&nbsp;<span class="op" id="5823312">!=</span>&nbsp;<span class="ident" id="5823315">nil</span>&nbsp;<span class="op" id="5823319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5823323">db</span><span class="op" id="5823325">.</span><span class="ident" id="5823326">putConn</span><span class="op" id="5823333">(</span><span class="ident" id="5823334">dc</span><span class="op" id="5823336">,</span>&nbsp;<span class="ident" id="5823338">err</span><span class="op" id="5823341">)</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823345">return</span>&nbsp;<span class="ident" id="5823352">nil</span><span class="op" id="5823355">,</span>&nbsp;<span class="ident" id="5823357">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5823362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823365">return</span>&nbsp;<span class="op" id="5823372">&amp;</span><span class="ident" id="5823373">Tx</span><span class="op" id="5823375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5823379">db</span><span class="op" id="5823381">:</span>&nbsp;&nbsp;<span class="ident" id="5823384">db</span><span class="op" id="5823386">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5823390">dc</span><span class="op" id="5823392">:</span>&nbsp;&nbsp;<span class="ident" id="5823395">dc</span><span class="op" id="5823397">,</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5823401">txi</span><span class="op" id="5823404">:</span>&nbsp;<span class="ident" id="5823406">txi</span><span class="op" id="5823409">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5823412">}</span><span class="op" id="5823413">,</span>&nbsp;<span class="ident" id="5823415">nil</span><br>
<span class="lineno"></span><span class="op" id="5823419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5823422">//&nbsp;Driver&nbsp;returns&nbsp;the&nbsp;database&#39;s&nbsp;underlying&nbsp;driver.</span><br>
<span class="lineno">1040</span><span class="keyword" id="5823474">func</span>&nbsp;<span class="op" id="5823479">(</span><span class="ident" id="5823480">db</span>&nbsp;<span class="op" id="5823483">*</span><span class="ident" id="5823484">DB</span><span class="op" id="5823486">)</span>&nbsp;<span class="ident" id="5823488">Driver</span><span class="op" id="5823494">(</span><span class="op" id="5823495">)</span>&nbsp;<span class="ident" id="5823497">driver</span><span class="op" id="5823503">.</span><span class="ident" id="5823504">Driver</span>&nbsp;<span class="op" id="5823511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5823514">return</span>&nbsp;<span class="ident" id="5823521">db</span><span class="op" id="5823523">.</span><span class="ident" id="5823524">driver</span><br>
<span class="lineno"></span><span class="op" id="5823531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5823534">//&nbsp;Tx&nbsp;is&nbsp;an&nbsp;in-progress&nbsp;database&nbsp;transaction.</span><br>
<span class="lineno">1045</span><span class="comment" id="5823580">//</span><br>
<span class="lineno"></span><span class="comment" id="5823583">//&nbsp;A&nbsp;transaction&nbsp;must&nbsp;end&nbsp;with&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback.</span><br>
<span class="lineno"></span><span class="comment" id="5823644">//</span><br>
<span class="lineno"></span><span class="comment" id="5823647">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;all&nbsp;operations&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5823708">//&nbsp;transaction&nbsp;fail&nbsp;with&nbsp;ErrTxDone.</span><br>
<span class="lineno">1050</span><span class="keyword" id="5823744">type</span>&nbsp;<span class="ident" id="5823749">Tx</span>&nbsp;<span class="keyword" id="5823752">struct</span>&nbsp;<span class="op" id="5823759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5823762">db</span>&nbsp;<span class="op" id="5823765">*</span><span class="ident" id="5823766">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823771">//&nbsp;dc&nbsp;is&nbsp;owned&nbsp;exclusively&nbsp;until&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;at&nbsp;which&nbsp;point</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823840">//&nbsp;it&#39;s&nbsp;returned&nbsp;with&nbsp;putConn.</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5823872">dc</span>&nbsp;&nbsp;<span class="op" id="5823876">*</span><span class="ident" id="5823877">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5823889">txi</span>&nbsp;<span class="ident" id="5823893">driver</span><span class="op" id="5823899">.</span><span class="ident" id="5823900">Tx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823905">//&nbsp;done&nbsp;transitions&nbsp;from&nbsp;false&nbsp;to&nbsp;true&nbsp;exactly&nbsp;once,&nbsp;on&nbsp;Commit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5823969">//&nbsp;or&nbsp;Rollback.&nbsp;once&nbsp;done,&nbsp;all&nbsp;operations&nbsp;fail&nbsp;with</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5824022">//&nbsp;ErrTxDone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824037">done</span>&nbsp;<span class="builtintype" id="5824042">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5824049">//&nbsp;All&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.&nbsp;&nbsp;These&nbsp;will&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5824126">//&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824177">stmts</span>&nbsp;<span class="keyword" id="5824183">struct</span>&nbsp;<span class="op" id="5824190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824194">sync</span><span class="op" id="5824198">.</span><span class="ident" id="5824199">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824207">v</span>&nbsp;<span class="op" id="5824209">[</span><span class="op" id="5824210">]</span><span class="op" id="5824211">*</span><span class="ident" id="5824212">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5824218">}</span><br>
<span class="lineno"></span><span class="op" id="5824220">}</span><br>
<span class="lineno">1070</span><br>
<span class="lineno"></span><span class="keyword" id="5824223">var</span>&nbsp;<span class="ident" id="5824227">ErrTxDone</span>&nbsp;<span class="op" id="5824237">=</span>&nbsp;<span class="ident" id="5824239">errors</span><span class="op" id="5824245">.</span><span class="ident" id="5824246">New</span><span class="op" id="5824249">(</span><span class="string" id="5824250">&#34;sql:&nbsp;Transaction&nbsp;has&nbsp;already&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back&#34;</span><span class="op" id="5824310">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5824313">func</span>&nbsp;<span class="op" id="5824318">(</span><span class="ident" id="5824319">tx</span>&nbsp;<span class="op" id="5824322">*</span><span class="ident" id="5824323">Tx</span><span class="op" id="5824325">)</span>&nbsp;<span class="builtinfunc" id="5824327">close</span><span class="op" id="5824332">(</span><span class="op" id="5824333">)</span>&nbsp;<span class="op" id="5824335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824338">if</span>&nbsp;<span class="ident" id="5824341">tx</span><span class="op" id="5824343">.</span><span class="ident" id="5824344">done</span>&nbsp;<span class="op" id="5824349">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5824353">panic</span><span class="op" id="5824358">(</span><span class="string" id="5824359">&#34;double&nbsp;close&#34;</span><span class="op" id="5824373">)</span>&nbsp;<span class="comment" id="5824375">//&nbsp;internal&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5824394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824397">tx</span><span class="op" id="5824399">.</span><span class="ident" id="5824400">done</span>&nbsp;<span class="op" id="5824405">=</span>&nbsp;<span class="builtintype" id="5824407">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824413">tx</span><span class="op" id="5824415">.</span><span class="ident" id="5824416">db</span><span class="op" id="5824418">.</span><span class="ident" id="5824419">putConn</span><span class="op" id="5824426">(</span><span class="ident" id="5824427">tx</span><span class="op" id="5824429">.</span><span class="ident" id="5824430">dc</span><span class="op" id="5824432">,</span>&nbsp;<span class="ident" id="5824434">nil</span><span class="op" id="5824437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824440">tx</span><span class="op" id="5824442">.</span><span class="ident" id="5824443">dc</span>&nbsp;<span class="op" id="5824446">=</span>&nbsp;<span class="ident" id="5824448">nil</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824453">tx</span><span class="op" id="5824455">.</span><span class="ident" id="5824456">txi</span>&nbsp;<span class="op" id="5824460">=</span>&nbsp;<span class="ident" id="5824462">nil</span><br>
<span class="lineno"></span><span class="op" id="5824466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5824469">func</span>&nbsp;<span class="op" id="5824474">(</span><span class="ident" id="5824475">tx</span>&nbsp;<span class="op" id="5824478">*</span><span class="ident" id="5824479">Tx</span><span class="op" id="5824481">)</span>&nbsp;<span class="ident" id="5824483">grabConn</span><span class="op" id="5824491">(</span><span class="op" id="5824492">)</span>&nbsp;<span class="op" id="5824494">(</span><span class="op" id="5824495">*</span><span class="ident" id="5824496">driverConn</span><span class="op" id="5824506">,</span>&nbsp;<span class="builtintype" id="5824508">error</span><span class="op" id="5824513">)</span>&nbsp;<span class="op" id="5824515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824518">if</span>&nbsp;<span class="ident" id="5824521">tx</span><span class="op" id="5824523">.</span><span class="ident" id="5824524">done</span>&nbsp;<span class="op" id="5824529">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824533">return</span>&nbsp;<span class="ident" id="5824540">nil</span><span class="op" id="5824543">,</span>&nbsp;<span class="ident" id="5824545">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5824556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824559">return</span>&nbsp;<span class="ident" id="5824566">tx</span><span class="op" id="5824568">.</span><span class="ident" id="5824569">dc</span><span class="op" id="5824571">,</span>&nbsp;<span class="ident" id="5824573">nil</span><br>
<span class="lineno"></span><span class="op" id="5824577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1090</span><span class="comment" id="5824580">//&nbsp;Closes&nbsp;all&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.</span><br>
<span class="lineno"></span><span class="keyword" id="5824631">func</span>&nbsp;<span class="op" id="5824636">(</span><span class="ident" id="5824637">tx</span>&nbsp;<span class="op" id="5824640">*</span><span class="ident" id="5824641">Tx</span><span class="op" id="5824643">)</span>&nbsp;<span class="ident" id="5824645">closePrepared</span><span class="op" id="5824658">(</span><span class="op" id="5824659">)</span>&nbsp;<span class="op" id="5824661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824664">tx</span><span class="op" id="5824666">.</span><span class="ident" id="5824667">stmts</span><span class="op" id="5824672">.</span><span class="ident" id="5824673">Lock</span><span class="op" id="5824677">(</span><span class="op" id="5824678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824681">for</span>&nbsp;<span class="ident" id="5824685">_</span><span class="op" id="5824686">,</span>&nbsp;<span class="ident" id="5824688">stmt</span>&nbsp;<span class="op" id="5824693">:=</span>&nbsp;<span class="keyword" id="5824696">range</span>&nbsp;<span class="ident" id="5824702">tx</span><span class="op" id="5824704">.</span><span class="ident" id="5824705">stmts</span><span class="op" id="5824710">.</span><span class="ident" id="5824711">v</span>&nbsp;<span class="op" id="5824713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824717">stmt</span><span class="op" id="5824721">.</span><span class="ident" id="5824722">Close</span><span class="op" id="5824727">(</span><span class="op" id="5824728">)</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5824731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824734">tx</span><span class="op" id="5824736">.</span><span class="ident" id="5824737">stmts</span><span class="op" id="5824742">.</span><span class="ident" id="5824743">Unlock</span><span class="op" id="5824749">(</span><span class="op" id="5824750">)</span><br>
<span class="lineno"></span><span class="op" id="5824752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5824755">//&nbsp;Commit&nbsp;commits&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1100</span><span class="keyword" id="5824790">func</span>&nbsp;<span class="op" id="5824795">(</span><span class="ident" id="5824796">tx</span>&nbsp;<span class="op" id="5824799">*</span><span class="ident" id="5824800">Tx</span><span class="op" id="5824802">)</span>&nbsp;<span class="ident" id="5824804">Commit</span><span class="op" id="5824810">(</span><span class="op" id="5824811">)</span>&nbsp;<span class="builtintype" id="5824813">error</span>&nbsp;<span class="op" id="5824819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824822">if</span>&nbsp;<span class="ident" id="5824825">tx</span><span class="op" id="5824827">.</span><span class="ident" id="5824828">done</span>&nbsp;<span class="op" id="5824833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824837">return</span>&nbsp;<span class="ident" id="5824844">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5824855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824858">defer</span>&nbsp;<span class="ident" id="5824864">tx</span><span class="op" id="5824866">.</span><span class="builtinfunc" id="5824867">close</span><span class="op" id="5824872">(</span><span class="op" id="5824873">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824876">tx</span><span class="op" id="5824878">.</span><span class="ident" id="5824879">dc</span><span class="op" id="5824881">.</span><span class="ident" id="5824882">Lock</span><span class="op" id="5824886">(</span><span class="op" id="5824887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824890">err</span>&nbsp;<span class="op" id="5824894">:=</span>&nbsp;<span class="ident" id="5824897">tx</span><span class="op" id="5824899">.</span><span class="ident" id="5824900">txi</span><span class="op" id="5824903">.</span><span class="ident" id="5824904">Commit</span><span class="op" id="5824910">(</span><span class="op" id="5824911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824914">tx</span><span class="op" id="5824916">.</span><span class="ident" id="5824917">dc</span><span class="op" id="5824919">.</span><span class="ident" id="5824920">Unlock</span><span class="op" id="5824926">(</span><span class="op" id="5824927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824930">if</span>&nbsp;<span class="ident" id="5824933">err</span>&nbsp;<span class="op" id="5824937">!=</span>&nbsp;<span class="ident" id="5824940">driver</span><span class="op" id="5824946">.</span><span class="ident" id="5824947">ErrBadConn</span>&nbsp;<span class="op" id="5824958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5824962">tx</span><span class="op" id="5824964">.</span><span class="ident" id="5824965">closePrepared</span><span class="op" id="5824978">(</span><span class="op" id="5824979">)</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5824982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5824985">return</span>&nbsp;<span class="ident" id="5824992">err</span><br>
<span class="lineno"></span><span class="op" id="5824996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5824999">//&nbsp;Rollback&nbsp;aborts&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1115</span><span class="keyword" id="5825035">func</span>&nbsp;<span class="op" id="5825040">(</span><span class="ident" id="5825041">tx</span>&nbsp;<span class="op" id="5825044">*</span><span class="ident" id="5825045">Tx</span><span class="op" id="5825047">)</span>&nbsp;<span class="ident" id="5825049">Rollback</span><span class="op" id="5825057">(</span><span class="op" id="5825058">)</span>&nbsp;<span class="builtintype" id="5825060">error</span>&nbsp;<span class="op" id="5825066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5825069">if</span>&nbsp;<span class="ident" id="5825072">tx</span><span class="op" id="5825074">.</span><span class="ident" id="5825075">done</span>&nbsp;<span class="op" id="5825080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5825084">return</span>&nbsp;<span class="ident" id="5825091">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5825102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5825105">defer</span>&nbsp;<span class="ident" id="5825111">tx</span><span class="op" id="5825113">.</span><span class="builtinfunc" id="5825114">close</span><span class="op" id="5825119">(</span><span class="op" id="5825120">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5825123">tx</span><span class="op" id="5825125">.</span><span class="ident" id="5825126">dc</span><span class="op" id="5825128">.</span><span class="ident" id="5825129">Lock</span><span class="op" id="5825133">(</span><span class="op" id="5825134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5825137">err</span>&nbsp;<span class="op" id="5825141">:=</span>&nbsp;<span class="ident" id="5825144">tx</span><span class="op" id="5825146">.</span><span class="ident" id="5825147">txi</span><span class="op" id="5825150">.</span><span class="ident" id="5825151">Rollback</span><span class="op" id="5825159">(</span><span class="op" id="5825160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5825163">tx</span><span class="op" id="5825165">.</span><span class="ident" id="5825166">dc</span><span class="op" id="5825168">.</span><span class="ident" id="5825169">Unlock</span><span class="op" id="5825175">(</span><span class="op" id="5825176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5825179">if</span>&nbsp;<span class="ident" id="5825182">err</span>&nbsp;<span class="op" id="5825186">!=</span>&nbsp;<span class="ident" id="5825189">driver</span><span class="op" id="5825195">.</span><span class="ident" id="5825196">ErrBadConn</span>&nbsp;<span class="op" id="5825207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5825211">tx</span><span class="op" id="5825213">.</span><span class="ident" id="5825214">closePrepared</span><span class="op" id="5825227">(</span><span class="op" id="5825228">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5825231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5825234">return</span>&nbsp;<span class="ident" id="5825241">err</span><br>
<span class="lineno"></span><span class="op" id="5825245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5825248">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;use&nbsp;within&nbsp;a&nbsp;transaction.</span><br>
<span class="lineno">1130</span><span class="comment" id="5825318">//</span><br>
<span class="lineno"></span><span class="comment" id="5825321">//&nbsp;The&nbsp;returned&nbsp;statement&nbsp;operates&nbsp;within&nbsp;the&nbsp;transaction&nbsp;and&nbsp;can&nbsp;no&nbsp;longer</span><br>
<span class="lineno"></span><span class="comment" id="5825397">//&nbsp;be&nbsp;used&nbsp;once&nbsp;the&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno"></span><span class="comment" id="5825464">//</span><br>
<span class="lineno"></span><span class="comment" id="5825467">//&nbsp;To&nbsp;use&nbsp;an&nbsp;existing&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;this&nbsp;transaction,&nbsp;see&nbsp;Tx.Stmt.</span><br>
<span class="lineno">1135</span><span class="keyword" id="5825542">func</span>&nbsp;<span class="op" id="5825547">(</span><span class="ident" id="5825548">tx</span>&nbsp;<span class="op" id="5825551">*</span><span class="ident" id="5825552">Tx</span><span class="op" id="5825554">)</span>&nbsp;<span class="ident" id="5825556">Prepare</span><span class="op" id="5825563">(</span><span class="ident" id="5825564">query</span>&nbsp;<span class="builtintype" id="5825570">string</span><span class="op" id="5825576">)</span>&nbsp;<span class="op" id="5825578">(</span><span class="op" id="5825579">*</span><span class="ident" id="5825580">Stmt</span><span class="op" id="5825584">,</span>&nbsp;<span class="builtintype" id="5825586">error</span><span class="op" id="5825591">)</span>&nbsp;<span class="op" id="5825593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5825596">//&nbsp;TODO(bradfitz):&nbsp;We&nbsp;could&nbsp;be&nbsp;more&nbsp;efficient&nbsp;here&nbsp;and&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5825659">//&nbsp;provide&nbsp;a&nbsp;method&nbsp;to&nbsp;take&nbsp;an&nbsp;existing&nbsp;Stmt&nbsp;(created&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5825717">//&nbsp;perhaps&nbsp;a&nbsp;different&nbsp;Conn),&nbsp;and&nbsp;re-create&nbsp;it&nbsp;on&nbsp;this&nbsp;Conn&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5825781">//&nbsp;necessary.&nbsp;Or,&nbsp;better:&nbsp;keep&nbsp;a&nbsp;map&nbsp;in&nbsp;DB&nbsp;of&nbsp;query&nbsp;string&nbsp;to</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5825844">//&nbsp;Stmts,&nbsp;and&nbsp;have&nbsp;Stmt.Execute&nbsp;do&nbsp;the&nbsp;right&nbsp;thing&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5825900">//&nbsp;re-prepare&nbsp;if&nbsp;the&nbsp;Conn&nbsp;in&nbsp;use&nbsp;doesn&#39;t&nbsp;have&nbsp;that&nbsp;prepared</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5825961">//&nbsp;statement.&nbsp;&nbsp;But&nbsp;we&#39;ll&nbsp;want&nbsp;to&nbsp;avoid&nbsp;caching&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5826023">//&nbsp;in&nbsp;the&nbsp;case&nbsp;where&nbsp;we&nbsp;only&nbsp;call&nbsp;conn.Prepare&nbsp;implicitly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5826082">//&nbsp;(such&nbsp;as&nbsp;in&nbsp;db.Exec&nbsp;or&nbsp;tx.Exec),&nbsp;but&nbsp;the&nbsp;caller&nbsp;package</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5826142">//&nbsp;can&#39;t&nbsp;be&nbsp;holding&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5826202">//&nbsp;Perhaps&nbsp;just&nbsp;looking&nbsp;at&nbsp;the&nbsp;reference&nbsp;count&nbsp;(by&nbsp;noting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5826261">//&nbsp;Stmt.Close)&nbsp;would&nbsp;be&nbsp;enough.&nbsp;We&nbsp;might&nbsp;also&nbsp;want&nbsp;a&nbsp;finalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5826325">//&nbsp;on&nbsp;Stmt&nbsp;to&nbsp;drop&nbsp;the&nbsp;reference&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5826366">dc</span><span class="op" id="5826368">,</span>&nbsp;<span class="ident" id="5826370">err</span>&nbsp;<span class="op" id="5826374">:=</span>&nbsp;<span class="ident" id="5826377">tx</span><span class="op" id="5826379">.</span><span class="ident" id="5826380">grabConn</span><span class="op" id="5826388">(</span><span class="op" id="5826389">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5826392">if</span>&nbsp;<span class="ident" id="5826395">err</span>&nbsp;<span class="op" id="5826399">!=</span>&nbsp;<span class="ident" id="5826402">nil</span>&nbsp;<span class="op" id="5826406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5826410">return</span>&nbsp;<span class="ident" id="5826417">nil</span><span class="op" id="5826420">,</span>&nbsp;<span class="ident" id="5826422">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5826427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5826431">dc</span><span class="op" id="5826433">.</span><span class="ident" id="5826434">Lock</span><span class="op" id="5826438">(</span><span class="op" id="5826439">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5826442">si</span><span class="op" id="5826444">,</span>&nbsp;<span class="ident" id="5826446">err</span>&nbsp;<span class="op" id="5826450">:=</span>&nbsp;<span class="ident" id="5826453">dc</span><span class="op" id="5826455">.</span><span class="ident" id="5826456">ci</span><span class="op" id="5826458">.</span><span class="ident" id="5826459">Prepare</span><span class="op" id="5826466">(</span><span class="ident" id="5826467">query</span><span class="op" id="5826472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5826475">dc</span><span class="op" id="5826477">.</span><span class="ident" id="5826478">Unlock</span><span class="op" id="5826484">(</span><span class="op" id="5826485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5826488">if</span>&nbsp;<span class="ident" id="5826491">err</span>&nbsp;<span class="op" id="5826495">!=</span>&nbsp;<span class="ident" id="5826498">nil</span>&nbsp;<span class="op" id="5826502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5826506">return</span>&nbsp;<span class="ident" id="5826513">nil</span><span class="op" id="5826516">,</span>&nbsp;<span class="ident" id="5826518">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5826523">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5826527">stmt</span>&nbsp;<span class="op" id="5826532">:=</span>&nbsp;<span class="op" id="5826535">&amp;</span><span class="ident" id="5826536">Stmt</span><span class="op" id="5826540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5826544">db</span><span class="op" id="5826546">:</span>&nbsp;<span class="ident" id="5826548">tx</span><span class="op" id="5826550">.</span><span class="ident" id="5826551">db</span><span class="op" id="5826553">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5826557">tx</span><span class="op" id="5826559">:</span>&nbsp;<span class="ident" id="5826561">tx</span><span class="op" id="5826563">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5826567">txsi</span><span class="op" id="5826571">:</span>&nbsp;<span class="op" id="5826573">&amp;</span><span class="ident" id="5826574">driverStmt</span><span class="op" id="5826584">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5826589">Locker</span><span class="op" id="5826595">:</span>&nbsp;<span class="ident" id="5826597">dc</span><span class="op" id="5826599">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5826604">si</span><span class="op" id="5826606">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5826612">si</span><span class="op" id="5826614">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5826618">}</span><span class="op" id="5826619">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5826623">query</span><span class="op" id="5826628">:</span>&nbsp;<span class="ident" id="5826630">query</span><span class="op" id="5826635">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5826638">}</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5826641">tx</span><span class="op" id="5826643">.</span><span class="ident" id="5826644">stmts</span><span class="op" id="5826649">.</span><span class="ident" id="5826650">Lock</span><span class="op" id="5826654">(</span><span class="op" id="5826655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5826658">tx</span><span class="op" id="5826660">.</span><span class="ident" id="5826661">stmts</span><span class="op" id="5826666">.</span><span class="ident" id="5826667">v</span>&nbsp;<span class="op" id="5826669">=</span>&nbsp;<span class="builtinfunc" id="5826671">append</span><span class="op" id="5826677">(</span><span class="ident" id="5826678">tx</span><span class="op" id="5826680">.</span><span class="ident" id="5826681">stmts</span><span class="op" id="5826686">.</span><span class="ident" id="5826687">v</span><span class="op" id="5826688">,</span>&nbsp;<span class="ident" id="5826690">stmt</span><span class="op" id="5826694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5826697">tx</span><span class="op" id="5826699">.</span><span class="ident" id="5826700">stmts</span><span class="op" id="5826705">.</span><span class="ident" id="5826706">Unlock</span><span class="op" id="5826712">(</span><span class="op" id="5826713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5826716">return</span>&nbsp;<span class="ident" id="5826723">stmt</span><span class="op" id="5826727">,</span>&nbsp;<span class="ident" id="5826729">nil</span><br>
<span class="lineno"></span><span class="op" id="5826733">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span><span class="comment" id="5826736">//&nbsp;Stmt&nbsp;returns&nbsp;a&nbsp;transaction-specific&nbsp;prepared&nbsp;statement&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="5826799">//&nbsp;an&nbsp;existing&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5826825">//</span><br>
<span class="lineno"></span><span class="comment" id="5826828">//&nbsp;Example:</span><br>
<span class="lineno">1180</span><span class="comment" id="5826840">//&nbsp;&nbsp;updateMoney,&nbsp;err&nbsp;:=&nbsp;db.Prepare(&#34;UPDATE&nbsp;balance&nbsp;SET&nbsp;money=money+?&nbsp;WHERE&nbsp;id=?&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="5826922">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5826930">//&nbsp;&nbsp;tx,&nbsp;err&nbsp;:=&nbsp;db.Begin()</span><br>
<span class="lineno"></span><span class="comment" id="5826956">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5826964">//&nbsp;&nbsp;res,&nbsp;err&nbsp;:=&nbsp;tx.Stmt(updateMoney).Exec(123.45,&nbsp;98293203)</span><br>
<span class="lineno">1185</span><span class="keyword" id="5827024">func</span>&nbsp;<span class="op" id="5827029">(</span><span class="ident" id="5827030">tx</span>&nbsp;<span class="op" id="5827033">*</span><span class="ident" id="5827034">Tx</span><span class="op" id="5827036">)</span>&nbsp;<span class="ident" id="5827038">Stmt</span><span class="op" id="5827042">(</span><span class="ident" id="5827043">stmt</span>&nbsp;<span class="op" id="5827048">*</span><span class="ident" id="5827049">Stmt</span><span class="op" id="5827053">)</span>&nbsp;<span class="op" id="5827055">*</span><span class="ident" id="5827056">Stmt</span>&nbsp;<span class="op" id="5827061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5827064">//&nbsp;TODO(bradfitz):&nbsp;optimize&nbsp;this.&nbsp;Currently&nbsp;this&nbsp;re-prepares</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5827126">//&nbsp;each&nbsp;time.&nbsp;&nbsp;This&nbsp;is&nbsp;fine&nbsp;for&nbsp;now&nbsp;to&nbsp;illustrate&nbsp;the&nbsp;API&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5827189">//&nbsp;we&nbsp;should&nbsp;really&nbsp;cache&nbsp;already-prepared&nbsp;statements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5827244">//&nbsp;per-Conn.&nbsp;See&nbsp;also&nbsp;the&nbsp;big&nbsp;comment&nbsp;in&nbsp;Tx.Prepare.</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5827299">if</span>&nbsp;<span class="ident" id="5827302">tx</span><span class="op" id="5827304">.</span><span class="ident" id="5827305">db</span>&nbsp;<span class="op" id="5827308">!=</span>&nbsp;<span class="ident" id="5827311">stmt</span><span class="op" id="5827315">.</span><span class="ident" id="5827316">db</span>&nbsp;<span class="op" id="5827319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5827323">return</span>&nbsp;<span class="op" id="5827330">&amp;</span><span class="ident" id="5827331">Stmt</span><span class="op" id="5827335">{</span><span class="ident" id="5827336">stickyErr</span><span class="op" id="5827345">:</span>&nbsp;<span class="ident" id="5827347">errors</span><span class="op" id="5827353">.</span><span class="ident" id="5827354">New</span><span class="op" id="5827357">(</span><span class="string" id="5827358">&#34;sql:&nbsp;Tx.Stmt:&nbsp;statement&nbsp;from&nbsp;different&nbsp;database&nbsp;used&#34;</span><span class="op" id="5827412">)</span><span class="op" id="5827413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5827416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827419">dc</span><span class="op" id="5827421">,</span>&nbsp;<span class="ident" id="5827423">err</span>&nbsp;<span class="op" id="5827427">:=</span>&nbsp;<span class="ident" id="5827430">tx</span><span class="op" id="5827432">.</span><span class="ident" id="5827433">grabConn</span><span class="op" id="5827441">(</span><span class="op" id="5827442">)</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5827445">if</span>&nbsp;<span class="ident" id="5827448">err</span>&nbsp;<span class="op" id="5827452">!=</span>&nbsp;<span class="ident" id="5827455">nil</span>&nbsp;<span class="op" id="5827459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5827463">return</span>&nbsp;<span class="op" id="5827470">&amp;</span><span class="ident" id="5827471">Stmt</span><span class="op" id="5827475">{</span><span class="ident" id="5827476">stickyErr</span><span class="op" id="5827485">:</span>&nbsp;<span class="ident" id="5827487">err</span><span class="op" id="5827490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5827493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827496">dc</span><span class="op" id="5827498">.</span><span class="ident" id="5827499">Lock</span><span class="op" id="5827503">(</span><span class="op" id="5827504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827507">si</span><span class="op" id="5827509">,</span>&nbsp;<span class="ident" id="5827511">err</span>&nbsp;<span class="op" id="5827515">:=</span>&nbsp;<span class="ident" id="5827518">dc</span><span class="op" id="5827520">.</span><span class="ident" id="5827521">ci</span><span class="op" id="5827523">.</span><span class="ident" id="5827524">Prepare</span><span class="op" id="5827531">(</span><span class="ident" id="5827532">stmt</span><span class="op" id="5827536">.</span><span class="ident" id="5827537">query</span><span class="op" id="5827542">)</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827545">dc</span><span class="op" id="5827547">.</span><span class="ident" id="5827548">Unlock</span><span class="op" id="5827554">(</span><span class="op" id="5827555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827558">txs</span>&nbsp;<span class="op" id="5827562">:=</span>&nbsp;<span class="op" id="5827565">&amp;</span><span class="ident" id="5827566">Stmt</span><span class="op" id="5827570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827574">db</span><span class="op" id="5827576">:</span>&nbsp;<span class="ident" id="5827578">tx</span><span class="op" id="5827580">.</span><span class="ident" id="5827581">db</span><span class="op" id="5827583">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827587">tx</span><span class="op" id="5827589">:</span>&nbsp;<span class="ident" id="5827591">tx</span><span class="op" id="5827593">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827597">txsi</span><span class="op" id="5827601">:</span>&nbsp;<span class="op" id="5827603">&amp;</span><span class="ident" id="5827604">driverStmt</span><span class="op" id="5827614">{</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827619">Locker</span><span class="op" id="5827625">:</span>&nbsp;<span class="ident" id="5827627">dc</span><span class="op" id="5827629">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827634">si</span><span class="op" id="5827636">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5827642">si</span><span class="op" id="5827644">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5827648">}</span><span class="op" id="5827649">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827653">query</span><span class="op" id="5827658">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5827664">stmt</span><span class="op" id="5827668">.</span><span class="ident" id="5827669">query</span><span class="op" id="5827674">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827678">stickyErr</span><span class="op" id="5827687">:</span>&nbsp;<span class="ident" id="5827689">err</span><span class="op" id="5827692">,</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5827695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827698">tx</span><span class="op" id="5827700">.</span><span class="ident" id="5827701">stmts</span><span class="op" id="5827706">.</span><span class="ident" id="5827707">Lock</span><span class="op" id="5827711">(</span><span class="op" id="5827712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827715">tx</span><span class="op" id="5827717">.</span><span class="ident" id="5827718">stmts</span><span class="op" id="5827723">.</span><span class="ident" id="5827724">v</span>&nbsp;<span class="op" id="5827726">=</span>&nbsp;<span class="builtinfunc" id="5827728">append</span><span class="op" id="5827734">(</span><span class="ident" id="5827735">tx</span><span class="op" id="5827737">.</span><span class="ident" id="5827738">stmts</span><span class="op" id="5827743">.</span><span class="ident" id="5827744">v</span><span class="op" id="5827745">,</span>&nbsp;<span class="ident" id="5827747">txs</span><span class="op" id="5827750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827753">tx</span><span class="op" id="5827755">.</span><span class="ident" id="5827756">stmts</span><span class="op" id="5827761">.</span><span class="ident" id="5827762">Unlock</span><span class="op" id="5827768">(</span><span class="op" id="5827769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5827772">return</span>&nbsp;<span class="ident" id="5827779">txs</span><br>
<span class="lineno">1215</span><span class="op" id="5827783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5827786">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;doesn&#39;t&nbsp;return&nbsp;rows.</span><br>
<span class="lineno"></span><span class="comment" id="5827837">//&nbsp;For&nbsp;example:&nbsp;an&nbsp;INSERT&nbsp;and&nbsp;UPDATE.</span><br>
<span class="lineno"></span><span class="keyword" id="5827875">func</span>&nbsp;<span class="op" id="5827880">(</span><span class="ident" id="5827881">tx</span>&nbsp;<span class="op" id="5827884">*</span><span class="ident" id="5827885">Tx</span><span class="op" id="5827887">)</span>&nbsp;<span class="ident" id="5827889">Exec</span><span class="op" id="5827893">(</span><span class="ident" id="5827894">query</span>&nbsp;<span class="builtintype" id="5827900">string</span><span class="op" id="5827906">,</span>&nbsp;<span class="ident" id="5827908">args</span>&nbsp;<span class="op" id="5827913">...</span><span class="keyword" id="5827916">interface</span><span class="op" id="5827925">{</span><span class="op" id="5827926">}</span><span class="op" id="5827927">)</span>&nbsp;<span class="op" id="5827929">(</span><span class="ident" id="5827930">Result</span><span class="op" id="5827936">,</span>&nbsp;<span class="builtintype" id="5827938">error</span><span class="op" id="5827943">)</span>&nbsp;<span class="op" id="5827945">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827948">dc</span><span class="op" id="5827950">,</span>&nbsp;<span class="ident" id="5827952">err</span>&nbsp;<span class="op" id="5827956">:=</span>&nbsp;<span class="ident" id="5827959">tx</span><span class="op" id="5827961">.</span><span class="ident" id="5827962">grabConn</span><span class="op" id="5827970">(</span><span class="op" id="5827971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5827974">if</span>&nbsp;<span class="ident" id="5827977">err</span>&nbsp;<span class="op" id="5827981">!=</span>&nbsp;<span class="ident" id="5827984">nil</span>&nbsp;<span class="op" id="5827988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5827992">return</span>&nbsp;<span class="ident" id="5827999">nil</span><span class="op" id="5828002">,</span>&nbsp;<span class="ident" id="5828004">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5828009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828013">if</span>&nbsp;<span class="ident" id="5828016">execer</span><span class="op" id="5828022">,</span>&nbsp;<span class="ident" id="5828024">ok</span>&nbsp;<span class="op" id="5828027">:=</span>&nbsp;<span class="ident" id="5828030">dc</span><span class="op" id="5828032">.</span><span class="ident" id="5828033">ci</span><span class="op" id="5828035">.</span><span class="op" id="5828036">(</span><span class="ident" id="5828037">driver</span><span class="op" id="5828043">.</span><span class="ident" id="5828044">Execer</span><span class="op" id="5828050">)</span><span class="op" id="5828051">;</span>&nbsp;<span class="ident" id="5828053">ok</span>&nbsp;<span class="op" id="5828056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828060">dargs</span><span class="op" id="5828065">,</span>&nbsp;<span class="ident" id="5828067">err</span>&nbsp;<span class="op" id="5828071">:=</span>&nbsp;<span class="ident" id="5828074">driverArgs</span><span class="op" id="5828084">(</span><span class="ident" id="5828085">nil</span><span class="op" id="5828088">,</span>&nbsp;<span class="ident" id="5828090">args</span><span class="op" id="5828094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828098">if</span>&nbsp;<span class="ident" id="5828101">err</span>&nbsp;<span class="op" id="5828105">!=</span>&nbsp;<span class="ident" id="5828108">nil</span>&nbsp;<span class="op" id="5828112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828117">return</span>&nbsp;<span class="ident" id="5828124">nil</span><span class="op" id="5828127">,</span>&nbsp;<span class="ident" id="5828129">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5828135">}</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828139">dc</span><span class="op" id="5828141">.</span><span class="ident" id="5828142">Lock</span><span class="op" id="5828146">(</span><span class="op" id="5828147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828151">resi</span><span class="op" id="5828155">,</span>&nbsp;<span class="ident" id="5828157">err</span>&nbsp;<span class="op" id="5828161">:=</span>&nbsp;<span class="ident" id="5828164">execer</span><span class="op" id="5828170">.</span><span class="ident" id="5828171">Exec</span><span class="op" id="5828175">(</span><span class="ident" id="5828176">query</span><span class="op" id="5828181">,</span>&nbsp;<span class="ident" id="5828183">dargs</span><span class="op" id="5828188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828192">dc</span><span class="op" id="5828194">.</span><span class="ident" id="5828195">Unlock</span><span class="op" id="5828201">(</span><span class="op" id="5828202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828206">if</span>&nbsp;<span class="ident" id="5828209">err</span>&nbsp;<span class="op" id="5828213">==</span>&nbsp;<span class="ident" id="5828216">nil</span>&nbsp;<span class="op" id="5828220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828225">return</span>&nbsp;<span class="ident" id="5828232">driverResult</span><span class="op" id="5828244">{</span><span class="ident" id="5828245">dc</span><span class="op" id="5828247">,</span>&nbsp;<span class="ident" id="5828249">resi</span><span class="op" id="5828253">}</span><span class="op" id="5828254">,</span>&nbsp;<span class="ident" id="5828256">nil</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5828262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828266">if</span>&nbsp;<span class="ident" id="5828269">err</span>&nbsp;<span class="op" id="5828273">!=</span>&nbsp;<span class="ident" id="5828276">driver</span><span class="op" id="5828282">.</span><span class="ident" id="5828283">ErrSkip</span>&nbsp;<span class="op" id="5828291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828296">return</span>&nbsp;<span class="ident" id="5828303">nil</span><span class="op" id="5828306">,</span>&nbsp;<span class="ident" id="5828308">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5828314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5828317">}</span><br>
<span class="lineno">1240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828321">dc</span><span class="op" id="5828323">.</span><span class="ident" id="5828324">Lock</span><span class="op" id="5828328">(</span><span class="op" id="5828329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828332">si</span><span class="op" id="5828334">,</span>&nbsp;<span class="ident" id="5828336">err</span>&nbsp;<span class="op" id="5828340">:=</span>&nbsp;<span class="ident" id="5828343">dc</span><span class="op" id="5828345">.</span><span class="ident" id="5828346">ci</span><span class="op" id="5828348">.</span><span class="ident" id="5828349">Prepare</span><span class="op" id="5828356">(</span><span class="ident" id="5828357">query</span><span class="op" id="5828362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828365">dc</span><span class="op" id="5828367">.</span><span class="ident" id="5828368">Unlock</span><span class="op" id="5828374">(</span><span class="op" id="5828375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828378">if</span>&nbsp;<span class="ident" id="5828381">err</span>&nbsp;<span class="op" id="5828385">!=</span>&nbsp;<span class="ident" id="5828388">nil</span>&nbsp;<span class="op" id="5828392">{</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828396">return</span>&nbsp;<span class="ident" id="5828403">nil</span><span class="op" id="5828406">,</span>&nbsp;<span class="ident" id="5828408">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5828413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828416">defer</span>&nbsp;<span class="ident" id="5828422">withLock</span><span class="op" id="5828430">(</span><span class="ident" id="5828431">dc</span><span class="op" id="5828433">,</span>&nbsp;<span class="keyword" id="5828435">func</span><span class="op" id="5828439">(</span><span class="op" id="5828440">)</span>&nbsp;<span class="op" id="5828442">{</span>&nbsp;<span class="ident" id="5828444">si</span><span class="op" id="5828446">.</span><span class="ident" id="5828447">Close</span><span class="op" id="5828452">(</span><span class="op" id="5828453">)</span>&nbsp;<span class="op" id="5828455">}</span><span class="op" id="5828456">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828460">return</span>&nbsp;<span class="ident" id="5828467">resultFromStatement</span><span class="op" id="5828486">(</span><span class="ident" id="5828487">driverStmt</span><span class="op" id="5828497">{</span><span class="ident" id="5828498">dc</span><span class="op" id="5828500">,</span>&nbsp;<span class="ident" id="5828502">si</span><span class="op" id="5828504">}</span><span class="op" id="5828505">,</span>&nbsp;<span class="ident" id="5828507">args</span><span class="op" id="5828511">...</span><span class="op" id="5828514">)</span><br>
<span class="lineno">1250</span><span class="op" id="5828516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5828519">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="keyword" id="5828584">func</span>&nbsp;<span class="op" id="5828589">(</span><span class="ident" id="5828590">tx</span>&nbsp;<span class="op" id="5828593">*</span><span class="ident" id="5828594">Tx</span><span class="op" id="5828596">)</span>&nbsp;<span class="ident" id="5828598">Query</span><span class="op" id="5828603">(</span><span class="ident" id="5828604">query</span>&nbsp;<span class="builtintype" id="5828610">string</span><span class="op" id="5828616">,</span>&nbsp;<span class="ident" id="5828618">args</span>&nbsp;<span class="op" id="5828623">...</span><span class="keyword" id="5828626">interface</span><span class="op" id="5828635">{</span><span class="op" id="5828636">}</span><span class="op" id="5828637">)</span>&nbsp;<span class="op" id="5828639">(</span><span class="op" id="5828640">*</span><span class="ident" id="5828641">Rows</span><span class="op" id="5828645">,</span>&nbsp;<span class="builtintype" id="5828647">error</span><span class="op" id="5828652">)</span>&nbsp;<span class="op" id="5828654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828657">dc</span><span class="op" id="5828659">,</span>&nbsp;<span class="ident" id="5828661">err</span>&nbsp;<span class="op" id="5828665">:=</span>&nbsp;<span class="ident" id="5828668">tx</span><span class="op" id="5828670">.</span><span class="ident" id="5828671">grabConn</span><span class="op" id="5828679">(</span><span class="op" id="5828680">)</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828683">if</span>&nbsp;<span class="ident" id="5828686">err</span>&nbsp;<span class="op" id="5828690">!=</span>&nbsp;<span class="ident" id="5828693">nil</span>&nbsp;<span class="op" id="5828697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828701">return</span>&nbsp;<span class="ident" id="5828708">nil</span><span class="op" id="5828711">,</span>&nbsp;<span class="ident" id="5828713">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5828718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828721">releaseConn</span>&nbsp;<span class="op" id="5828733">:=</span>&nbsp;<span class="keyword" id="5828736">func</span><span class="op" id="5828740">(</span><span class="builtintype" id="5828741">error</span><span class="op" id="5828746">)</span>&nbsp;<span class="op" id="5828748">{</span><span class="op" id="5828749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828752">return</span>&nbsp;<span class="ident" id="5828759">tx</span><span class="op" id="5828761">.</span><span class="ident" id="5828762">db</span><span class="op" id="5828764">.</span><span class="ident" id="5828765">queryConn</span><span class="op" id="5828774">(</span><span class="ident" id="5828775">dc</span><span class="op" id="5828777">,</span>&nbsp;<span class="ident" id="5828779">releaseConn</span><span class="op" id="5828790">,</span>&nbsp;<span class="ident" id="5828792">query</span><span class="op" id="5828797">,</span>&nbsp;<span class="ident" id="5828799">args</span><span class="op" id="5828803">)</span><br>
<span class="lineno">1260</span><span class="op" id="5828805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5828808">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="5828881">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="5828950">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno">1265</span><span class="keyword" id="5828982">func</span>&nbsp;<span class="op" id="5828987">(</span><span class="ident" id="5828988">tx</span>&nbsp;<span class="op" id="5828991">*</span><span class="ident" id="5828992">Tx</span><span class="op" id="5828994">)</span>&nbsp;<span class="ident" id="5828996">QueryRow</span><span class="op" id="5829004">(</span><span class="ident" id="5829005">query</span>&nbsp;<span class="builtintype" id="5829011">string</span><span class="op" id="5829017">,</span>&nbsp;<span class="ident" id="5829019">args</span>&nbsp;<span class="op" id="5829024">...</span><span class="keyword" id="5829027">interface</span><span class="op" id="5829036">{</span><span class="op" id="5829037">}</span><span class="op" id="5829038">)</span>&nbsp;<span class="op" id="5829040">*</span><span class="ident" id="5829041">Row</span>&nbsp;<span class="op" id="5829045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829048">rows</span><span class="op" id="5829052">,</span>&nbsp;<span class="ident" id="5829054">err</span>&nbsp;<span class="op" id="5829058">:=</span>&nbsp;<span class="ident" id="5829061">tx</span><span class="op" id="5829063">.</span><span class="ident" id="5829064">Query</span><span class="op" id="5829069">(</span><span class="ident" id="5829070">query</span><span class="op" id="5829075">,</span>&nbsp;<span class="ident" id="5829077">args</span><span class="op" id="5829081">...</span><span class="op" id="5829084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5829087">return</span>&nbsp;<span class="op" id="5829094">&amp;</span><span class="ident" id="5829095">Row</span><span class="op" id="5829098">{</span><span class="ident" id="5829099">rows</span><span class="op" id="5829103">:</span>&nbsp;<span class="ident" id="5829105">rows</span><span class="op" id="5829109">,</span>&nbsp;<span class="ident" id="5829111">err</span><span class="op" id="5829114">:</span>&nbsp;<span class="ident" id="5829116">err</span><span class="op" id="5829119">}</span><br>
<span class="lineno"></span><span class="op" id="5829121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="5829124">//&nbsp;connStmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;a&nbsp;particular&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5829188">type</span>&nbsp;<span class="ident" id="5829193">connStmt</span>&nbsp;<span class="keyword" id="5829202">struct</span>&nbsp;<span class="op" id="5829209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829212">dc</span>&nbsp;<span class="op" id="5829215">*</span><span class="ident" id="5829216">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829228">si</span>&nbsp;<span class="ident" id="5829231">driver</span><span class="op" id="5829237">.</span><span class="ident" id="5829238">Stmt</span><br>
<span class="lineno"></span><span class="op" id="5829243">}</span><br>
<span class="lineno">1275</span><br>
<span class="lineno"></span><span class="comment" id="5829246">//&nbsp;Stmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement.&nbsp;Stmt&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5829335">type</span>&nbsp;<span class="ident" id="5829340">Stmt</span>&nbsp;<span class="keyword" id="5829345">struct</span>&nbsp;<span class="op" id="5829352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5829355">//&nbsp;Immutable:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829370">db</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5829380">*</span><span class="ident" id="5829381">DB</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5829387">//&nbsp;where&nbsp;we&nbsp;came&nbsp;from</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829410">query</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5829420">string</span>&nbsp;<span class="comment" id="5829427">//&nbsp;that&nbsp;created&nbsp;the&nbsp;Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829453">stickyErr</span>&nbsp;<span class="builtintype" id="5829463">error</span>&nbsp;&nbsp;<span class="comment" id="5829470">//&nbsp;if&nbsp;non-nil,&nbsp;this&nbsp;error&nbsp;is&nbsp;returned&nbsp;for&nbsp;all&nbsp;operations</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829529">closemu</span>&nbsp;<span class="ident" id="5829537">sync</span><span class="op" id="5829541">.</span><span class="ident" id="5829542">RWMutex</span>&nbsp;<span class="comment" id="5829550">//&nbsp;held&nbsp;exclusively&nbsp;during&nbsp;close,&nbsp;for&nbsp;read&nbsp;otherwise.</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5829606">//&nbsp;If&nbsp;in&nbsp;a&nbsp;transaction,&nbsp;else&nbsp;both&nbsp;nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829646">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5829651">*</span><span class="ident" id="5829652">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829656">txsi</span>&nbsp;<span class="op" id="5829661">*</span><span class="ident" id="5829662">driverStmt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829675">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5829682">sync</span><span class="op" id="5829686">.</span><span class="ident" id="5829687">Mutex</span>&nbsp;<span class="comment" id="5829693">//&nbsp;protects&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;fields</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829729">closed</span>&nbsp;<span class="builtintype" id="5829736">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5829743">//&nbsp;css&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;underlying&nbsp;driver&nbsp;statement&nbsp;interfaces</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5829803">//&nbsp;that&nbsp;are&nbsp;valid&nbsp;on&nbsp;particular&nbsp;connections.&nbsp;&nbsp;This&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5829863">//&nbsp;used&nbsp;if&nbsp;tx&nbsp;==&nbsp;nil&nbsp;and&nbsp;one&nbsp;is&nbsp;found&nbsp;that&nbsp;has&nbsp;idle</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5829916">//&nbsp;connections.&nbsp;&nbsp;If&nbsp;tx&nbsp;!=&nbsp;nil,&nbsp;txsi&nbsp;is&nbsp;always&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829969">css</span>&nbsp;<span class="op" id="5829973">[</span><span class="op" id="5829974">]</span><span class="ident" id="5829975">connStmt</span><br>
<span class="lineno"></span><span class="op" id="5829984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5829987">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments&nbsp;and</span><br>
<span class="lineno">1300</span><span class="comment" id="5830054">//&nbsp;returns&nbsp;a&nbsp;Result&nbsp;summarizing&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5830115">func</span>&nbsp;<span class="op" id="5830120">(</span><span class="ident" id="5830121">s</span>&nbsp;<span class="op" id="5830123">*</span><span class="ident" id="5830124">Stmt</span><span class="op" id="5830128">)</span>&nbsp;<span class="ident" id="5830130">Exec</span><span class="op" id="5830134">(</span><span class="ident" id="5830135">args</span>&nbsp;<span class="op" id="5830140">...</span><span class="keyword" id="5830143">interface</span><span class="op" id="5830152">{</span><span class="op" id="5830153">}</span><span class="op" id="5830154">)</span>&nbsp;<span class="op" id="5830156">(</span><span class="ident" id="5830157">Result</span><span class="op" id="5830163">,</span>&nbsp;<span class="builtintype" id="5830165">error</span><span class="op" id="5830170">)</span>&nbsp;<span class="op" id="5830172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830175">s</span><span class="op" id="5830176">.</span><span class="ident" id="5830177">closemu</span><span class="op" id="5830184">.</span><span class="ident" id="5830185">RLock</span><span class="op" id="5830190">(</span><span class="op" id="5830191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830194">defer</span>&nbsp;<span class="ident" id="5830200">s</span><span class="op" id="5830201">.</span><span class="ident" id="5830202">closemu</span><span class="op" id="5830209">.</span><span class="ident" id="5830210">RUnlock</span><span class="op" id="5830217">(</span><span class="op" id="5830218">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830222">var</span>&nbsp;<span class="ident" id="5830226">res</span>&nbsp;<span class="ident" id="5830230">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830238">for</span>&nbsp;<span class="ident" id="5830242">i</span>&nbsp;<span class="op" id="5830244">:=</span>&nbsp;<span class="num" id="5830247">0</span><span class="op" id="5830248">;</span>&nbsp;<span class="ident" id="5830250">i</span>&nbsp;<span class="op" id="5830252">&lt;</span>&nbsp;<span class="ident" id="5830254">maxBadConnRetries</span><span class="op" id="5830271">;</span>&nbsp;<span class="ident" id="5830273">i</span><span class="op" id="5830274">++</span>&nbsp;<span class="op" id="5830277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830281">dc</span><span class="op" id="5830283">,</span>&nbsp;<span class="ident" id="5830285">releaseConn</span><span class="op" id="5830296">,</span>&nbsp;<span class="ident" id="5830298">si</span><span class="op" id="5830300">,</span>&nbsp;<span class="ident" id="5830302">err</span>&nbsp;<span class="op" id="5830306">:=</span>&nbsp;<span class="ident" id="5830309">s</span><span class="op" id="5830310">.</span><span class="ident" id="5830311">connStmt</span><span class="op" id="5830319">(</span><span class="op" id="5830320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830324">if</span>&nbsp;<span class="ident" id="5830327">err</span>&nbsp;<span class="op" id="5830331">!=</span>&nbsp;<span class="ident" id="5830334">nil</span>&nbsp;<span class="op" id="5830338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830343">if</span>&nbsp;<span class="ident" id="5830346">err</span>&nbsp;<span class="op" id="5830350">==</span>&nbsp;<span class="ident" id="5830353">driver</span><span class="op" id="5830359">.</span><span class="ident" id="5830360">ErrBadConn</span>&nbsp;<span class="op" id="5830371">{</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830377">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5830389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830394">return</span>&nbsp;<span class="ident" id="5830401">nil</span><span class="op" id="5830404">,</span>&nbsp;<span class="ident" id="5830406">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5830412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830417">res</span><span class="op" id="5830420">,</span>&nbsp;<span class="ident" id="5830422">err</span>&nbsp;<span class="op" id="5830426">=</span>&nbsp;<span class="ident" id="5830428">resultFromStatement</span><span class="op" id="5830447">(</span><span class="ident" id="5830448">driverStmt</span><span class="op" id="5830458">{</span><span class="ident" id="5830459">dc</span><span class="op" id="5830461">,</span>&nbsp;<span class="ident" id="5830463">si</span><span class="op" id="5830465">}</span><span class="op" id="5830466">,</span>&nbsp;<span class="ident" id="5830468">args</span><span class="op" id="5830472">...</span><span class="op" id="5830475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830479">releaseConn</span><span class="op" id="5830490">(</span><span class="ident" id="5830491">err</span><span class="op" id="5830494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830498">if</span>&nbsp;<span class="ident" id="5830501">err</span>&nbsp;<span class="op" id="5830505">!=</span>&nbsp;<span class="ident" id="5830508">driver</span><span class="op" id="5830514">.</span><span class="ident" id="5830515">ErrBadConn</span>&nbsp;<span class="op" id="5830526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830531">return</span>&nbsp;<span class="ident" id="5830538">res</span><span class="op" id="5830541">,</span>&nbsp;<span class="ident" id="5830543">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5830549">}</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5830552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830555">return</span>&nbsp;<span class="ident" id="5830562">nil</span><span class="op" id="5830565">,</span>&nbsp;<span class="ident" id="5830567">driver</span><span class="op" id="5830573">.</span><span class="ident" id="5830574">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="5830585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5830588">func</span>&nbsp;<span class="ident" id="5830593">resultFromStatement</span><span class="op" id="5830612">(</span><span class="ident" id="5830613">ds</span>&nbsp;<span class="ident" id="5830616">driverStmt</span><span class="op" id="5830626">,</span>&nbsp;<span class="ident" id="5830628">args</span>&nbsp;<span class="op" id="5830633">...</span><span class="keyword" id="5830636">interface</span><span class="op" id="5830645">{</span><span class="op" id="5830646">}</span><span class="op" id="5830647">)</span>&nbsp;<span class="op" id="5830649">(</span><span class="ident" id="5830650">Result</span><span class="op" id="5830656">,</span>&nbsp;<span class="builtintype" id="5830658">error</span><span class="op" id="5830663">)</span>&nbsp;<span class="op" id="5830665">{</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830668">ds</span><span class="op" id="5830670">.</span><span class="ident" id="5830671">Lock</span><span class="op" id="5830675">(</span><span class="op" id="5830676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830679">want</span>&nbsp;<span class="op" id="5830684">:=</span>&nbsp;<span class="ident" id="5830687">ds</span><span class="op" id="5830689">.</span><span class="ident" id="5830690">si</span><span class="op" id="5830692">.</span><span class="ident" id="5830693">NumInput</span><span class="op" id="5830701">(</span><span class="op" id="5830702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830705">ds</span><span class="op" id="5830707">.</span><span class="ident" id="5830708">Unlock</span><span class="op" id="5830714">(</span><span class="op" id="5830715">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5830719">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5830783">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5830857">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830886">if</span>&nbsp;<span class="ident" id="5830889">want</span>&nbsp;<span class="op" id="5830894">!=</span>&nbsp;<span class="op" id="5830897">-</span><span class="num" id="5830898">1</span>&nbsp;<span class="op" id="5830900">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5830903">len</span><span class="op" id="5830906">(</span><span class="ident" id="5830907">args</span><span class="op" id="5830911">)</span>&nbsp;<span class="op" id="5830913">!=</span>&nbsp;<span class="ident" id="5830916">want</span>&nbsp;<span class="op" id="5830921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830925">return</span>&nbsp;<span class="ident" id="5830932">nil</span><span class="op" id="5830935">,</span>&nbsp;<span class="ident" id="5830937">fmt</span><span class="op" id="5830940">.</span><span class="ident" id="5830941">Errorf</span><span class="op" id="5830947">(</span><span class="string" id="5830948">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;arguments,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="5830984">,</span>&nbsp;<span class="ident" id="5830986">want</span><span class="op" id="5830990">,</span>&nbsp;<span class="builtinfunc" id="5830992">len</span><span class="op" id="5830995">(</span><span class="ident" id="5830996">args</span><span class="op" id="5831000">)</span><span class="op" id="5831001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5831004">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831008">dargs</span><span class="op" id="5831013">,</span>&nbsp;<span class="ident" id="5831015">err</span>&nbsp;<span class="op" id="5831019">:=</span>&nbsp;<span class="ident" id="5831022">driverArgs</span><span class="op" id="5831032">(</span><span class="op" id="5831033">&amp;</span><span class="ident" id="5831034">ds</span><span class="op" id="5831036">,</span>&nbsp;<span class="ident" id="5831038">args</span><span class="op" id="5831042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831045">if</span>&nbsp;<span class="ident" id="5831048">err</span>&nbsp;<span class="op" id="5831052">!=</span>&nbsp;<span class="ident" id="5831055">nil</span>&nbsp;<span class="op" id="5831059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831063">return</span>&nbsp;<span class="ident" id="5831070">nil</span><span class="op" id="5831073">,</span>&nbsp;<span class="ident" id="5831075">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5831080">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831084">ds</span><span class="op" id="5831086">.</span><span class="ident" id="5831087">Lock</span><span class="op" id="5831091">(</span><span class="op" id="5831092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831095">resi</span><span class="op" id="5831099">,</span>&nbsp;<span class="ident" id="5831101">err</span>&nbsp;<span class="op" id="5831105">:=</span>&nbsp;<span class="ident" id="5831108">ds</span><span class="op" id="5831110">.</span><span class="ident" id="5831111">si</span><span class="op" id="5831113">.</span><span class="ident" id="5831114">Exec</span><span class="op" id="5831118">(</span><span class="ident" id="5831119">dargs</span><span class="op" id="5831124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831127">ds</span><span class="op" id="5831129">.</span><span class="ident" id="5831130">Unlock</span><span class="op" id="5831136">(</span><span class="op" id="5831137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831140">if</span>&nbsp;<span class="ident" id="5831143">err</span>&nbsp;<span class="op" id="5831147">!=</span>&nbsp;<span class="ident" id="5831150">nil</span>&nbsp;<span class="op" id="5831154">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831158">return</span>&nbsp;<span class="ident" id="5831165">nil</span><span class="op" id="5831168">,</span>&nbsp;<span class="ident" id="5831170">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5831175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831178">return</span>&nbsp;<span class="ident" id="5831185">driverResult</span><span class="op" id="5831197">{</span><span class="ident" id="5831198">ds</span><span class="op" id="5831200">.</span><span class="ident" id="5831201">Locker</span><span class="op" id="5831207">,</span>&nbsp;<span class="ident" id="5831209">resi</span><span class="op" id="5831213">}</span><span class="op" id="5831214">,</span>&nbsp;<span class="ident" id="5831216">nil</span><br>
<span class="lineno"></span><span class="op" id="5831220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1350</span><span class="comment" id="5831223">//&nbsp;connStmt&nbsp;returns&nbsp;a&nbsp;free&nbsp;driver&nbsp;connection&nbsp;on&nbsp;which&nbsp;to&nbsp;execute&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5831292">//&nbsp;statement,&nbsp;a&nbsp;function&nbsp;to&nbsp;call&nbsp;to&nbsp;release&nbsp;the&nbsp;connection,&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5831358">//&nbsp;statement&nbsp;bound&nbsp;to&nbsp;that&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5831397">func</span>&nbsp;<span class="op" id="5831402">(</span><span class="ident" id="5831403">s</span>&nbsp;<span class="op" id="5831405">*</span><span class="ident" id="5831406">Stmt</span><span class="op" id="5831410">)</span>&nbsp;<span class="ident" id="5831412">connStmt</span><span class="op" id="5831420">(</span><span class="op" id="5831421">)</span>&nbsp;<span class="op" id="5831423">(</span><span class="ident" id="5831424">ci</span>&nbsp;<span class="op" id="5831427">*</span><span class="ident" id="5831428">driverConn</span><span class="op" id="5831438">,</span>&nbsp;<span class="ident" id="5831440">releaseConn</span>&nbsp;<span class="keyword" id="5831452">func</span><span class="op" id="5831456">(</span><span class="builtintype" id="5831457">error</span><span class="op" id="5831462">)</span><span class="op" id="5831463">,</span>&nbsp;<span class="ident" id="5831465">si</span>&nbsp;<span class="ident" id="5831468">driver</span><span class="op" id="5831474">.</span><span class="ident" id="5831475">Stmt</span><span class="op" id="5831479">,</span>&nbsp;<span class="ident" id="5831481">err</span>&nbsp;<span class="builtintype" id="5831485">error</span><span class="op" id="5831490">)</span>&nbsp;<span class="op" id="5831492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831495">if</span>&nbsp;<span class="ident" id="5831498">err</span>&nbsp;<span class="op" id="5831502">=</span>&nbsp;<span class="ident" id="5831504">s</span><span class="op" id="5831505">.</span><span class="ident" id="5831506">stickyErr</span><span class="op" id="5831515">;</span>&nbsp;<span class="ident" id="5831517">err</span>&nbsp;<span class="op" id="5831521">!=</span>&nbsp;<span class="ident" id="5831524">nil</span>&nbsp;<span class="op" id="5831528">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831532">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5831540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831543">s</span><span class="op" id="5831544">.</span><span class="ident" id="5831545">mu</span><span class="op" id="5831547">.</span><span class="ident" id="5831548">Lock</span><span class="op" id="5831552">(</span><span class="op" id="5831553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831556">if</span>&nbsp;<span class="ident" id="5831559">s</span><span class="op" id="5831560">.</span><span class="ident" id="5831561">closed</span>&nbsp;<span class="op" id="5831568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831572">s</span><span class="op" id="5831573">.</span><span class="ident" id="5831574">mu</span><span class="op" id="5831576">.</span><span class="ident" id="5831577">Unlock</span><span class="op" id="5831583">(</span><span class="op" id="5831584">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831588">err</span>&nbsp;<span class="op" id="5831592">=</span>&nbsp;<span class="ident" id="5831594">errors</span><span class="op" id="5831600">.</span><span class="ident" id="5831601">New</span><span class="op" id="5831604">(</span><span class="string" id="5831605">&#34;sql:&nbsp;statement&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5831631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831635">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5831643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5831647">//&nbsp;In&nbsp;a&nbsp;transaction,&nbsp;we&nbsp;always&nbsp;use&nbsp;the&nbsp;connection&nbsp;that&nbsp;the</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5831707">//&nbsp;transaction&nbsp;was&nbsp;created&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831739">if</span>&nbsp;<span class="ident" id="5831742">s</span><span class="op" id="5831743">.</span><span class="ident" id="5831744">tx</span>&nbsp;<span class="op" id="5831747">!=</span>&nbsp;<span class="ident" id="5831750">nil</span>&nbsp;<span class="op" id="5831754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831758">s</span><span class="op" id="5831759">.</span><span class="ident" id="5831760">mu</span><span class="op" id="5831762">.</span><span class="ident" id="5831763">Unlock</span><span class="op" id="5831769">(</span><span class="op" id="5831770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831774">ci</span><span class="op" id="5831776">,</span>&nbsp;<span class="ident" id="5831778">err</span>&nbsp;<span class="op" id="5831782">=</span>&nbsp;<span class="ident" id="5831784">s</span><span class="op" id="5831785">.</span><span class="ident" id="5831786">tx</span><span class="op" id="5831788">.</span><span class="ident" id="5831789">grabConn</span><span class="op" id="5831797">(</span><span class="op" id="5831798">)</span>&nbsp;<span class="comment" id="5831800">//&nbsp;blocks,&nbsp;waiting&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831841">if</span>&nbsp;<span class="ident" id="5831844">err</span>&nbsp;<span class="op" id="5831848">!=</span>&nbsp;<span class="ident" id="5831851">nil</span>&nbsp;<span class="op" id="5831855">{</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831860">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5831869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831873">releaseConn</span>&nbsp;<span class="op" id="5831885">=</span>&nbsp;<span class="keyword" id="5831887">func</span><span class="op" id="5831891">(</span><span class="builtintype" id="5831892">error</span><span class="op" id="5831897">)</span>&nbsp;<span class="op" id="5831899">{</span><span class="op" id="5831900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831904">return</span>&nbsp;<span class="ident" id="5831911">ci</span><span class="op" id="5831913">,</span>&nbsp;<span class="ident" id="5831915">releaseConn</span><span class="op" id="5831926">,</span>&nbsp;<span class="ident" id="5831928">s</span><span class="op" id="5831929">.</span><span class="ident" id="5831930">txsi</span><span class="op" id="5831934">.</span><span class="ident" id="5831935">si</span><span class="op" id="5831937">,</span>&nbsp;<span class="ident" id="5831939">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5831944">}</span><br>
<span class="lineno">1375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831948">for</span>&nbsp;<span class="ident" id="5831952">i</span>&nbsp;<span class="op" id="5831954">:=</span>&nbsp;<span class="num" id="5831957">0</span><span class="op" id="5831958">;</span>&nbsp;<span class="ident" id="5831960">i</span>&nbsp;<span class="op" id="5831962">&lt;</span>&nbsp;<span class="builtinfunc" id="5831964">len</span><span class="op" id="5831967">(</span><span class="ident" id="5831968">s</span><span class="op" id="5831969">.</span><span class="ident" id="5831970">css</span><span class="op" id="5831973">)</span><span class="op" id="5831974">;</span>&nbsp;<span class="ident" id="5831976">i</span><span class="op" id="5831977">++</span>&nbsp;<span class="op" id="5831980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831984">v</span>&nbsp;<span class="op" id="5831986">:=</span>&nbsp;<span class="ident" id="5831989">s</span><span class="op" id="5831990">.</span><span class="ident" id="5831991">css</span><span class="op" id="5831994">[</span><span class="ident" id="5831995">i</span><span class="op" id="5831996">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832000">_</span><span class="op" id="5832001">,</span>&nbsp;<span class="ident" id="5832003">err</span>&nbsp;<span class="op" id="5832007">:=</span>&nbsp;<span class="ident" id="5832010">s</span><span class="op" id="5832011">.</span><span class="ident" id="5832012">db</span><span class="op" id="5832014">.</span><span class="ident" id="5832015">connIfFree</span><span class="op" id="5832025">(</span><span class="ident" id="5832026">v</span><span class="op" id="5832027">.</span><span class="ident" id="5832028">dc</span><span class="op" id="5832030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832034">if</span>&nbsp;<span class="ident" id="5832037">err</span>&nbsp;<span class="op" id="5832041">==</span>&nbsp;<span class="ident" id="5832044">nil</span>&nbsp;<span class="op" id="5832048">{</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832053">s</span><span class="op" id="5832054">.</span><span class="ident" id="5832055">mu</span><span class="op" id="5832057">.</span><span class="ident" id="5832058">Unlock</span><span class="op" id="5832064">(</span><span class="op" id="5832065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832070">return</span>&nbsp;<span class="ident" id="5832077">v</span><span class="op" id="5832078">.</span><span class="ident" id="5832079">dc</span><span class="op" id="5832081">,</span>&nbsp;<span class="ident" id="5832083">v</span><span class="op" id="5832084">.</span><span class="ident" id="5832085">dc</span><span class="op" id="5832087">.</span><span class="ident" id="5832088">releaseConn</span><span class="op" id="5832099">,</span>&nbsp;<span class="ident" id="5832101">v</span><span class="op" id="5832102">.</span><span class="ident" id="5832103">si</span><span class="op" id="5832105">,</span>&nbsp;<span class="ident" id="5832107">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832117">if</span>&nbsp;<span class="ident" id="5832120">err</span>&nbsp;<span class="op" id="5832124">==</span>&nbsp;<span class="ident" id="5832127">errConnClosed</span>&nbsp;<span class="op" id="5832141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5832146">//&nbsp;Lazily&nbsp;remove&nbsp;dead&nbsp;conn&nbsp;from&nbsp;our&nbsp;freelist.</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832195">s</span><span class="op" id="5832196">.</span><span class="ident" id="5832197">css</span><span class="op" id="5832200">[</span><span class="ident" id="5832201">i</span><span class="op" id="5832202">]</span>&nbsp;<span class="op" id="5832204">=</span>&nbsp;<span class="ident" id="5832206">s</span><span class="op" id="5832207">.</span><span class="ident" id="5832208">css</span><span class="op" id="5832211">[</span><span class="builtinfunc" id="5832212">len</span><span class="op" id="5832215">(</span><span class="ident" id="5832216">s</span><span class="op" id="5832217">.</span><span class="ident" id="5832218">css</span><span class="op" id="5832221">)</span><span class="op" id="5832222">-</span><span class="num" id="5832223">1</span><span class="op" id="5832224">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832229">s</span><span class="op" id="5832230">.</span><span class="ident" id="5832231">css</span>&nbsp;<span class="op" id="5832235">=</span>&nbsp;<span class="ident" id="5832237">s</span><span class="op" id="5832238">.</span><span class="ident" id="5832239">css</span><span class="op" id="5832242">[</span><span class="op" id="5832243">:</span><span class="builtinfunc" id="5832244">len</span><span class="op" id="5832247">(</span><span class="ident" id="5832248">s</span><span class="op" id="5832249">.</span><span class="ident" id="5832250">css</span><span class="op" id="5832253">)</span><span class="op" id="5832254">-</span><span class="num" id="5832255">1</span><span class="op" id="5832256">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832261">i</span><span class="op" id="5832262">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832274">s</span><span class="op" id="5832275">.</span><span class="ident" id="5832276">mu</span><span class="op" id="5832278">.</span><span class="ident" id="5832279">Unlock</span><span class="op" id="5832285">(</span><span class="op" id="5832286">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5832290">//&nbsp;If&nbsp;all&nbsp;connections&nbsp;are&nbsp;busy,&nbsp;either&nbsp;wait&nbsp;for&nbsp;one&nbsp;to&nbsp;become&nbsp;available&nbsp;(if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5832367">//&nbsp;we&#39;ve&nbsp;already&nbsp;hit&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections)&nbsp;or&nbsp;create&nbsp;a</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5832441">//&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5832454">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5832458">//&nbsp;TODO(bradfitz):&nbsp;or&nbsp;always&nbsp;wait&nbsp;for&nbsp;one?&nbsp;make&nbsp;configurable&nbsp;later?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832527">dc</span><span class="op" id="5832529">,</span>&nbsp;<span class="ident" id="5832531">err</span>&nbsp;<span class="op" id="5832535">:=</span>&nbsp;<span class="ident" id="5832538">s</span><span class="op" id="5832539">.</span><span class="ident" id="5832540">db</span><span class="op" id="5832542">.</span><span class="ident" id="5832543">conn</span><span class="op" id="5832547">(</span><span class="op" id="5832548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832551">if</span>&nbsp;<span class="ident" id="5832554">err</span>&nbsp;<span class="op" id="5832558">!=</span>&nbsp;<span class="ident" id="5832561">nil</span>&nbsp;<span class="op" id="5832565">{</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832569">return</span>&nbsp;<span class="ident" id="5832576">nil</span><span class="op" id="5832579">,</span>&nbsp;<span class="ident" id="5832581">nil</span><span class="op" id="5832584">,</span>&nbsp;<span class="ident" id="5832586">nil</span><span class="op" id="5832589">,</span>&nbsp;<span class="ident" id="5832591">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5832600">//&nbsp;Do&nbsp;another&nbsp;pass&nbsp;over&nbsp;the&nbsp;list&nbsp;to&nbsp;see&nbsp;whether&nbsp;this&nbsp;statement&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5832668">//&nbsp;already&nbsp;been&nbsp;prepared&nbsp;on&nbsp;the&nbsp;connection&nbsp;assigned&nbsp;to&nbsp;us.</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832728">s</span><span class="op" id="5832729">.</span><span class="ident" id="5832730">mu</span><span class="op" id="5832732">.</span><span class="ident" id="5832733">Lock</span><span class="op" id="5832737">(</span><span class="op" id="5832738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832741">for</span>&nbsp;<span class="ident" id="5832745">_</span><span class="op" id="5832746">,</span>&nbsp;<span class="ident" id="5832748">v</span>&nbsp;<span class="op" id="5832750">:=</span>&nbsp;<span class="keyword" id="5832753">range</span>&nbsp;<span class="ident" id="5832759">s</span><span class="op" id="5832760">.</span><span class="ident" id="5832761">css</span>&nbsp;<span class="op" id="5832765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832769">if</span>&nbsp;<span class="ident" id="5832772">v</span><span class="op" id="5832773">.</span><span class="ident" id="5832774">dc</span>&nbsp;<span class="op" id="5832777">==</span>&nbsp;<span class="ident" id="5832780">dc</span>&nbsp;<span class="op" id="5832783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832788">s</span><span class="op" id="5832789">.</span><span class="ident" id="5832790">mu</span><span class="op" id="5832792">.</span><span class="ident" id="5832793">Unlock</span><span class="op" id="5832799">(</span><span class="op" id="5832800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832805">return</span>&nbsp;<span class="ident" id="5832812">dc</span><span class="op" id="5832814">,</span>&nbsp;<span class="ident" id="5832816">dc</span><span class="op" id="5832818">.</span><span class="ident" id="5832819">releaseConn</span><span class="op" id="5832830">,</span>&nbsp;<span class="ident" id="5832832">v</span><span class="op" id="5832833">.</span><span class="ident" id="5832834">si</span><span class="op" id="5832836">,</span>&nbsp;<span class="ident" id="5832838">nil</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832850">s</span><span class="op" id="5832851">.</span><span class="ident" id="5832852">mu</span><span class="op" id="5832854">.</span><span class="ident" id="5832855">Unlock</span><span class="op" id="5832861">(</span><span class="op" id="5832862">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5832866">//&nbsp;No&nbsp;luck;&nbsp;we&nbsp;need&nbsp;to&nbsp;prepare&nbsp;the&nbsp;statement&nbsp;on&nbsp;this&nbsp;connection</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832931">dc</span><span class="op" id="5832933">.</span><span class="ident" id="5832934">Lock</span><span class="op" id="5832938">(</span><span class="op" id="5832939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832942">si</span><span class="op" id="5832944">,</span>&nbsp;<span class="ident" id="5832946">err</span>&nbsp;<span class="op" id="5832950">=</span>&nbsp;<span class="ident" id="5832952">dc</span><span class="op" id="5832954">.</span><span class="ident" id="5832955">prepareLocked</span><span class="op" id="5832968">(</span><span class="ident" id="5832969">s</span><span class="op" id="5832970">.</span><span class="ident" id="5832971">query</span><span class="op" id="5832976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832979">dc</span><span class="op" id="5832981">.</span><span class="ident" id="5832982">Unlock</span><span class="op" id="5832988">(</span><span class="op" id="5832989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832992">if</span>&nbsp;<span class="ident" id="5832995">err</span>&nbsp;<span class="op" id="5832999">!=</span>&nbsp;<span class="ident" id="5833002">nil</span>&nbsp;<span class="op" id="5833006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833010">s</span><span class="op" id="5833011">.</span><span class="ident" id="5833012">db</span><span class="op" id="5833014">.</span><span class="ident" id="5833015">putConn</span><span class="op" id="5833022">(</span><span class="ident" id="5833023">dc</span><span class="op" id="5833025">,</span>&nbsp;<span class="ident" id="5833027">err</span><span class="op" id="5833030">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833034">return</span>&nbsp;<span class="ident" id="5833041">nil</span><span class="op" id="5833044">,</span>&nbsp;<span class="ident" id="5833046">nil</span><span class="op" id="5833049">,</span>&nbsp;<span class="ident" id="5833051">nil</span><span class="op" id="5833054">,</span>&nbsp;<span class="ident" id="5833056">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5833061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833064">s</span><span class="op" id="5833065">.</span><span class="ident" id="5833066">mu</span><span class="op" id="5833068">.</span><span class="ident" id="5833069">Lock</span><span class="op" id="5833073">(</span><span class="op" id="5833074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833077">cs</span>&nbsp;<span class="op" id="5833080">:=</span>&nbsp;<span class="ident" id="5833083">connStmt</span><span class="op" id="5833091">{</span><span class="ident" id="5833092">dc</span><span class="op" id="5833094">,</span>&nbsp;<span class="ident" id="5833096">si</span><span class="op" id="5833098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833101">s</span><span class="op" id="5833102">.</span><span class="ident" id="5833103">css</span>&nbsp;<span class="op" id="5833107">=</span>&nbsp;<span class="builtinfunc" id="5833109">append</span><span class="op" id="5833115">(</span><span class="ident" id="5833116">s</span><span class="op" id="5833117">.</span><span class="ident" id="5833118">css</span><span class="op" id="5833121">,</span>&nbsp;<span class="ident" id="5833123">cs</span><span class="op" id="5833125">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833128">s</span><span class="op" id="5833129">.</span><span class="ident" id="5833130">mu</span><span class="op" id="5833132">.</span><span class="ident" id="5833133">Unlock</span><span class="op" id="5833139">(</span><span class="op" id="5833140">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833144">return</span>&nbsp;<span class="ident" id="5833151">dc</span><span class="op" id="5833153">,</span>&nbsp;<span class="ident" id="5833155">dc</span><span class="op" id="5833157">.</span><span class="ident" id="5833158">releaseConn</span><span class="op" id="5833169">,</span>&nbsp;<span class="ident" id="5833171">si</span><span class="op" id="5833173">,</span>&nbsp;<span class="ident" id="5833175">nil</span><br>
<span class="lineno"></span><span class="op" id="5833179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1430</span><span class="comment" id="5833182">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments</span><br>
<span class="lineno"></span><span class="comment" id="5833252">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;query&nbsp;results&nbsp;as&nbsp;a&nbsp;*Rows.</span><br>
<span class="lineno"></span><span class="keyword" id="5833297">func</span>&nbsp;<span class="op" id="5833302">(</span><span class="ident" id="5833303">s</span>&nbsp;<span class="op" id="5833305">*</span><span class="ident" id="5833306">Stmt</span><span class="op" id="5833310">)</span>&nbsp;<span class="ident" id="5833312">Query</span><span class="op" id="5833317">(</span><span class="ident" id="5833318">args</span>&nbsp;<span class="op" id="5833323">...</span><span class="keyword" id="5833326">interface</span><span class="op" id="5833335">{</span><span class="op" id="5833336">}</span><span class="op" id="5833337">)</span>&nbsp;<span class="op" id="5833339">(</span><span class="op" id="5833340">*</span><span class="ident" id="5833341">Rows</span><span class="op" id="5833345">,</span>&nbsp;<span class="builtintype" id="5833347">error</span><span class="op" id="5833352">)</span>&nbsp;<span class="op" id="5833354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833357">s</span><span class="op" id="5833358">.</span><span class="ident" id="5833359">closemu</span><span class="op" id="5833366">.</span><span class="ident" id="5833367">RLock</span><span class="op" id="5833372">(</span><span class="op" id="5833373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833376">defer</span>&nbsp;<span class="ident" id="5833382">s</span><span class="op" id="5833383">.</span><span class="ident" id="5833384">closemu</span><span class="op" id="5833391">.</span><span class="ident" id="5833392">RUnlock</span><span class="op" id="5833399">(</span><span class="op" id="5833400">)</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833404">var</span>&nbsp;<span class="ident" id="5833408">rowsi</span>&nbsp;<span class="ident" id="5833414">driver</span><span class="op" id="5833420">.</span><span class="ident" id="5833421">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833427">for</span>&nbsp;<span class="ident" id="5833431">i</span>&nbsp;<span class="op" id="5833433">:=</span>&nbsp;<span class="num" id="5833436">0</span><span class="op" id="5833437">;</span>&nbsp;<span class="ident" id="5833439">i</span>&nbsp;<span class="op" id="5833441">&lt;</span>&nbsp;<span class="ident" id="5833443">maxBadConnRetries</span><span class="op" id="5833460">;</span>&nbsp;<span class="ident" id="5833462">i</span><span class="op" id="5833463">++</span>&nbsp;<span class="op" id="5833466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833470">dc</span><span class="op" id="5833472">,</span>&nbsp;<span class="ident" id="5833474">releaseConn</span><span class="op" id="5833485">,</span>&nbsp;<span class="ident" id="5833487">si</span><span class="op" id="5833489">,</span>&nbsp;<span class="ident" id="5833491">err</span>&nbsp;<span class="op" id="5833495">:=</span>&nbsp;<span class="ident" id="5833498">s</span><span class="op" id="5833499">.</span><span class="ident" id="5833500">connStmt</span><span class="op" id="5833508">(</span><span class="op" id="5833509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833513">if</span>&nbsp;<span class="ident" id="5833516">err</span>&nbsp;<span class="op" id="5833520">!=</span>&nbsp;<span class="ident" id="5833523">nil</span>&nbsp;<span class="op" id="5833527">{</span><br>
<span class="lineno">1440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833532">if</span>&nbsp;<span class="ident" id="5833535">err</span>&nbsp;<span class="op" id="5833539">==</span>&nbsp;<span class="ident" id="5833542">driver</span><span class="op" id="5833548">.</span><span class="ident" id="5833549">ErrBadConn</span>&nbsp;<span class="op" id="5833560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833566">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5833578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833583">return</span>&nbsp;<span class="ident" id="5833590">nil</span><span class="op" id="5833593">,</span>&nbsp;<span class="ident" id="5833595">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5833601">}</span><br>
<span class="lineno">1445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833606">rowsi</span><span class="op" id="5833611">,</span>&nbsp;<span class="ident" id="5833613">err</span>&nbsp;<span class="op" id="5833617">=</span>&nbsp;<span class="ident" id="5833619">rowsiFromStatement</span><span class="op" id="5833637">(</span><span class="ident" id="5833638">driverStmt</span><span class="op" id="5833648">{</span><span class="ident" id="5833649">dc</span><span class="op" id="5833651">,</span>&nbsp;<span class="ident" id="5833653">si</span><span class="op" id="5833655">}</span><span class="op" id="5833656">,</span>&nbsp;<span class="ident" id="5833658">args</span><span class="op" id="5833662">...</span><span class="op" id="5833665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833669">if</span>&nbsp;<span class="ident" id="5833672">err</span>&nbsp;<span class="op" id="5833676">==</span>&nbsp;<span class="ident" id="5833679">nil</span>&nbsp;<span class="op" id="5833683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5833688">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5833749">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833773">rows</span>&nbsp;<span class="op" id="5833778">:=</span>&nbsp;<span class="op" id="5833781">&amp;</span><span class="ident" id="5833782">Rows</span><span class="op" id="5833786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833792">dc</span><span class="op" id="5833794">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5833799">dc</span><span class="op" id="5833801">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833807">rowsi</span><span class="op" id="5833812">:</span>&nbsp;<span class="ident" id="5833814">rowsi</span><span class="op" id="5833819">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5833825">//&nbsp;releaseConn&nbsp;set&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5833853">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833858">s</span><span class="op" id="5833859">.</span><span class="ident" id="5833860">db</span><span class="op" id="5833862">.</span><span class="ident" id="5833863">addDep</span><span class="op" id="5833869">(</span><span class="ident" id="5833870">s</span><span class="op" id="5833871">,</span>&nbsp;<span class="ident" id="5833873">rows</span><span class="op" id="5833877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833882">rows</span><span class="op" id="5833886">.</span><span class="ident" id="5833887">releaseConn</span>&nbsp;<span class="op" id="5833899">=</span>&nbsp;<span class="keyword" id="5833901">func</span><span class="op" id="5833905">(</span><span class="ident" id="5833906">err</span>&nbsp;<span class="builtintype" id="5833910">error</span><span class="op" id="5833915">)</span>&nbsp;<span class="op" id="5833917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833923">releaseConn</span><span class="op" id="5833934">(</span><span class="ident" id="5833935">err</span><span class="op" id="5833938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833944">s</span><span class="op" id="5833945">.</span><span class="ident" id="5833946">db</span><span class="op" id="5833948">.</span><span class="ident" id="5833949">removeDep</span><span class="op" id="5833958">(</span><span class="ident" id="5833959">s</span><span class="op" id="5833960">,</span>&nbsp;<span class="ident" id="5833962">rows</span><span class="op" id="5833966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5833971">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833976">return</span>&nbsp;<span class="ident" id="5833983">rows</span><span class="op" id="5833987">,</span>&nbsp;<span class="ident" id="5833989">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5833995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834000">releaseConn</span><span class="op" id="5834011">(</span><span class="ident" id="5834012">err</span><span class="op" id="5834015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834019">if</span>&nbsp;<span class="ident" id="5834022">err</span>&nbsp;<span class="op" id="5834026">!=</span>&nbsp;<span class="ident" id="5834029">driver</span><span class="op" id="5834035">.</span><span class="ident" id="5834036">ErrBadConn</span>&nbsp;<span class="op" id="5834047">{</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834052">return</span>&nbsp;<span class="ident" id="5834059">nil</span><span class="op" id="5834062">,</span>&nbsp;<span class="ident" id="5834064">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5834070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5834073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834076">return</span>&nbsp;<span class="ident" id="5834083">nil</span><span class="op" id="5834086">,</span>&nbsp;<span class="ident" id="5834088">driver</span><span class="op" id="5834094">.</span><span class="ident" id="5834095">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="5834106">}</span><br>
<span class="lineno">1470</span><br>
<span class="lineno"></span><span class="keyword" id="5834109">func</span>&nbsp;<span class="ident" id="5834114">rowsiFromStatement</span><span class="op" id="5834132">(</span><span class="ident" id="5834133">ds</span>&nbsp;<span class="ident" id="5834136">driverStmt</span><span class="op" id="5834146">,</span>&nbsp;<span class="ident" id="5834148">args</span>&nbsp;<span class="op" id="5834153">...</span><span class="keyword" id="5834156">interface</span><span class="op" id="5834165">{</span><span class="op" id="5834166">}</span><span class="op" id="5834167">)</span>&nbsp;<span class="op" id="5834169">(</span><span class="ident" id="5834170">driver</span><span class="op" id="5834176">.</span><span class="ident" id="5834177">Rows</span><span class="op" id="5834181">,</span>&nbsp;<span class="builtintype" id="5834183">error</span><span class="op" id="5834188">)</span>&nbsp;<span class="op" id="5834190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834193">ds</span><span class="op" id="5834195">.</span><span class="ident" id="5834196">Lock</span><span class="op" id="5834200">(</span><span class="op" id="5834201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834204">want</span>&nbsp;<span class="op" id="5834209">:=</span>&nbsp;<span class="ident" id="5834212">ds</span><span class="op" id="5834214">.</span><span class="ident" id="5834215">si</span><span class="op" id="5834217">.</span><span class="ident" id="5834218">NumInput</span><span class="op" id="5834226">(</span><span class="op" id="5834227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834230">ds</span><span class="op" id="5834232">.</span><span class="ident" id="5834233">Unlock</span><span class="op" id="5834239">(</span><span class="op" id="5834240">)</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5834244">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5834308">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5834382">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834411">if</span>&nbsp;<span class="ident" id="5834414">want</span>&nbsp;<span class="op" id="5834419">!=</span>&nbsp;<span class="op" id="5834422">-</span><span class="num" id="5834423">1</span>&nbsp;<span class="op" id="5834425">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5834428">len</span><span class="op" id="5834431">(</span><span class="ident" id="5834432">args</span><span class="op" id="5834436">)</span>&nbsp;<span class="op" id="5834438">!=</span>&nbsp;<span class="ident" id="5834441">want</span>&nbsp;<span class="op" id="5834446">{</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834450">return</span>&nbsp;<span class="ident" id="5834457">nil</span><span class="op" id="5834460">,</span>&nbsp;<span class="ident" id="5834462">fmt</span><span class="op" id="5834465">.</span><span class="ident" id="5834466">Errorf</span><span class="op" id="5834472">(</span><span class="string" id="5834473">&#34;sql:&nbsp;statement&nbsp;expects&nbsp;%d&nbsp;inputs;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="5834515">,</span>&nbsp;<span class="ident" id="5834517">want</span><span class="op" id="5834521">,</span>&nbsp;<span class="builtinfunc" id="5834523">len</span><span class="op" id="5834526">(</span><span class="ident" id="5834527">args</span><span class="op" id="5834531">)</span><span class="op" id="5834532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5834535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834539">dargs</span><span class="op" id="5834544">,</span>&nbsp;<span class="ident" id="5834546">err</span>&nbsp;<span class="op" id="5834550">:=</span>&nbsp;<span class="ident" id="5834553">driverArgs</span><span class="op" id="5834563">(</span><span class="op" id="5834564">&amp;</span><span class="ident" id="5834565">ds</span><span class="op" id="5834567">,</span>&nbsp;<span class="ident" id="5834569">args</span><span class="op" id="5834573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834576">if</span>&nbsp;<span class="ident" id="5834579">err</span>&nbsp;<span class="op" id="5834583">!=</span>&nbsp;<span class="ident" id="5834586">nil</span>&nbsp;<span class="op" id="5834590">{</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834594">return</span>&nbsp;<span class="ident" id="5834601">nil</span><span class="op" id="5834604">,</span>&nbsp;<span class="ident" id="5834606">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5834611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834615">ds</span><span class="op" id="5834617">.</span><span class="ident" id="5834618">Lock</span><span class="op" id="5834622">(</span><span class="op" id="5834623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834626">rowsi</span><span class="op" id="5834631">,</span>&nbsp;<span class="ident" id="5834633">err</span>&nbsp;<span class="op" id="5834637">:=</span>&nbsp;<span class="ident" id="5834640">ds</span><span class="op" id="5834642">.</span><span class="ident" id="5834643">si</span><span class="op" id="5834645">.</span><span class="ident" id="5834646">Query</span><span class="op" id="5834651">(</span><span class="ident" id="5834652">dargs</span><span class="op" id="5834657">)</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834660">ds</span><span class="op" id="5834662">.</span><span class="ident" id="5834663">Unlock</span><span class="op" id="5834669">(</span><span class="op" id="5834670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834673">if</span>&nbsp;<span class="ident" id="5834676">err</span>&nbsp;<span class="op" id="5834680">!=</span>&nbsp;<span class="ident" id="5834683">nil</span>&nbsp;<span class="op" id="5834687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834691">return</span>&nbsp;<span class="ident" id="5834698">nil</span><span class="op" id="5834701">,</span>&nbsp;<span class="ident" id="5834703">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5834708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834711">return</span>&nbsp;<span class="ident" id="5834718">rowsi</span><span class="op" id="5834723">,</span>&nbsp;<span class="ident" id="5834725">nil</span><br>
<span class="lineno">1495</span><span class="op" id="5834729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5834732">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="5834806">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;during&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;statement,&nbsp;that&nbsp;error&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="5834883">//&nbsp;be&nbsp;returned&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Scan&nbsp;on&nbsp;the&nbsp;returned&nbsp;*Row,&nbsp;which&nbsp;is&nbsp;always&nbsp;non-nil.</span><br>
<span class="lineno">1500</span><span class="comment" id="5834963">//&nbsp;If&nbsp;the&nbsp;query&nbsp;selects&nbsp;no&nbsp;rows,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;will&nbsp;return&nbsp;ErrNoRows.</span><br>
<span class="lineno"></span><span class="comment" id="5835035">//&nbsp;Otherwise,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;scans&nbsp;the&nbsp;first&nbsp;selected&nbsp;row&nbsp;and&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="5835107">//&nbsp;the&nbsp;rest.</span><br>
<span class="lineno"></span><span class="comment" id="5835120">//</span><br>
<span class="lineno"></span><span class="comment" id="5835123">//&nbsp;Example&nbsp;usage:</span><br>
<span class="lineno">1505</span><span class="comment" id="5835141">//</span><br>
<span class="lineno"></span><span class="comment" id="5835144">//&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5835164">//&nbsp;&nbsp;err&nbsp;:=&nbsp;nameByUseridStmt.QueryRow(id).Scan(&amp;name)</span><br>
<span class="lineno"></span><span class="keyword" id="5835217">func</span>&nbsp;<span class="op" id="5835222">(</span><span class="ident" id="5835223">s</span>&nbsp;<span class="op" id="5835225">*</span><span class="ident" id="5835226">Stmt</span><span class="op" id="5835230">)</span>&nbsp;<span class="ident" id="5835232">QueryRow</span><span class="op" id="5835240">(</span><span class="ident" id="5835241">args</span>&nbsp;<span class="op" id="5835246">...</span><span class="keyword" id="5835249">interface</span><span class="op" id="5835258">{</span><span class="op" id="5835259">}</span><span class="op" id="5835260">)</span>&nbsp;<span class="op" id="5835262">*</span><span class="ident" id="5835263">Row</span>&nbsp;<span class="op" id="5835267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835270">rows</span><span class="op" id="5835274">,</span>&nbsp;<span class="ident" id="5835276">err</span>&nbsp;<span class="op" id="5835280">:=</span>&nbsp;<span class="ident" id="5835283">s</span><span class="op" id="5835284">.</span><span class="ident" id="5835285">Query</span><span class="op" id="5835290">(</span><span class="ident" id="5835291">args</span><span class="op" id="5835295">...</span><span class="op" id="5835298">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835301">if</span>&nbsp;<span class="ident" id="5835304">err</span>&nbsp;<span class="op" id="5835308">!=</span>&nbsp;<span class="ident" id="5835311">nil</span>&nbsp;<span class="op" id="5835315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835319">return</span>&nbsp;<span class="op" id="5835326">&amp;</span><span class="ident" id="5835327">Row</span><span class="op" id="5835330">{</span><span class="ident" id="5835331">err</span><span class="op" id="5835334">:</span>&nbsp;<span class="ident" id="5835336">err</span><span class="op" id="5835339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5835342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835345">return</span>&nbsp;<span class="op" id="5835352">&amp;</span><span class="ident" id="5835353">Row</span><span class="op" id="5835356">{</span><span class="ident" id="5835357">rows</span><span class="op" id="5835361">:</span>&nbsp;<span class="ident" id="5835363">rows</span><span class="op" id="5835367">}</span><br>
<span class="lineno"></span><span class="op" id="5835369">}</span><br>
<span class="lineno">1515</span><br>
<span class="lineno"></span><span class="comment" id="5835372">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5835403">func</span>&nbsp;<span class="op" id="5835408">(</span><span class="ident" id="5835409">s</span>&nbsp;<span class="op" id="5835411">*</span><span class="ident" id="5835412">Stmt</span><span class="op" id="5835416">)</span>&nbsp;<span class="ident" id="5835418">Close</span><span class="op" id="5835423">(</span><span class="op" id="5835424">)</span>&nbsp;<span class="builtintype" id="5835426">error</span>&nbsp;<span class="op" id="5835432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835435">s</span><span class="op" id="5835436">.</span><span class="ident" id="5835437">closemu</span><span class="op" id="5835444">.</span><span class="ident" id="5835445">Lock</span><span class="op" id="5835449">(</span><span class="op" id="5835450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835453">defer</span>&nbsp;<span class="ident" id="5835459">s</span><span class="op" id="5835460">.</span><span class="ident" id="5835461">closemu</span><span class="op" id="5835468">.</span><span class="ident" id="5835469">Unlock</span><span class="op" id="5835475">(</span><span class="op" id="5835476">)</span><br>
<span class="lineno">1520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835480">if</span>&nbsp;<span class="ident" id="5835483">s</span><span class="op" id="5835484">.</span><span class="ident" id="5835485">stickyErr</span>&nbsp;<span class="op" id="5835495">!=</span>&nbsp;<span class="ident" id="5835498">nil</span>&nbsp;<span class="op" id="5835502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835506">return</span>&nbsp;<span class="ident" id="5835513">s</span><span class="op" id="5835514">.</span><span class="ident" id="5835515">stickyErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5835526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835529">s</span><span class="op" id="5835530">.</span><span class="ident" id="5835531">mu</span><span class="op" id="5835533">.</span><span class="ident" id="5835534">Lock</span><span class="op" id="5835538">(</span><span class="op" id="5835539">)</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835542">if</span>&nbsp;<span class="ident" id="5835545">s</span><span class="op" id="5835546">.</span><span class="ident" id="5835547">closed</span>&nbsp;<span class="op" id="5835554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835558">s</span><span class="op" id="5835559">.</span><span class="ident" id="5835560">mu</span><span class="op" id="5835562">.</span><span class="ident" id="5835563">Unlock</span><span class="op" id="5835569">(</span><span class="op" id="5835570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835574">return</span>&nbsp;<span class="ident" id="5835581">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5835586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835589">s</span><span class="op" id="5835590">.</span><span class="ident" id="5835591">closed</span>&nbsp;<span class="op" id="5835598">=</span>&nbsp;<span class="builtintype" id="5835600">true</span><br>
<span class="lineno">1530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835607">if</span>&nbsp;<span class="ident" id="5835610">s</span><span class="op" id="5835611">.</span><span class="ident" id="5835612">tx</span>&nbsp;<span class="op" id="5835615">!=</span>&nbsp;<span class="ident" id="5835618">nil</span>&nbsp;<span class="op" id="5835622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835626">s</span><span class="op" id="5835627">.</span><span class="ident" id="5835628">txsi</span><span class="op" id="5835632">.</span><span class="ident" id="5835633">Close</span><span class="op" id="5835638">(</span><span class="op" id="5835639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835643">s</span><span class="op" id="5835644">.</span><span class="ident" id="5835645">mu</span><span class="op" id="5835647">.</span><span class="ident" id="5835648">Unlock</span><span class="op" id="5835654">(</span><span class="op" id="5835655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835659">return</span>&nbsp;<span class="ident" id="5835666">nil</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5835671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835674">s</span><span class="op" id="5835675">.</span><span class="ident" id="5835676">mu</span><span class="op" id="5835678">.</span><span class="ident" id="5835679">Unlock</span><span class="op" id="5835685">(</span><span class="op" id="5835686">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835690">return</span>&nbsp;<span class="ident" id="5835697">s</span><span class="op" id="5835698">.</span><span class="ident" id="5835699">db</span><span class="op" id="5835701">.</span><span class="ident" id="5835702">removeDep</span><span class="op" id="5835711">(</span><span class="ident" id="5835712">s</span><span class="op" id="5835713">,</span>&nbsp;<span class="ident" id="5835715">s</span><span class="op" id="5835716">)</span><br>
<span class="lineno"></span><span class="op" id="5835718">}</span><br>
<span class="lineno">1540</span><br>
<span class="lineno"></span><span class="keyword" id="5835721">func</span>&nbsp;<span class="op" id="5835726">(</span><span class="ident" id="5835727">s</span>&nbsp;<span class="op" id="5835729">*</span><span class="ident" id="5835730">Stmt</span><span class="op" id="5835734">)</span>&nbsp;<span class="ident" id="5835736">finalClose</span><span class="op" id="5835746">(</span><span class="op" id="5835747">)</span>&nbsp;<span class="builtintype" id="5835749">error</span>&nbsp;<span class="op" id="5835755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835758">s</span><span class="op" id="5835759">.</span><span class="ident" id="5835760">mu</span><span class="op" id="5835762">.</span><span class="ident" id="5835763">Lock</span><span class="op" id="5835767">(</span><span class="op" id="5835768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835771">defer</span>&nbsp;<span class="ident" id="5835777">s</span><span class="op" id="5835778">.</span><span class="ident" id="5835779">mu</span><span class="op" id="5835781">.</span><span class="ident" id="5835782">Unlock</span><span class="op" id="5835788">(</span><span class="op" id="5835789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835792">if</span>&nbsp;<span class="ident" id="5835795">s</span><span class="op" id="5835796">.</span><span class="ident" id="5835797">css</span>&nbsp;<span class="op" id="5835801">!=</span>&nbsp;<span class="ident" id="5835804">nil</span>&nbsp;<span class="op" id="5835808">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835812">for</span>&nbsp;<span class="ident" id="5835816">_</span><span class="op" id="5835817">,</span>&nbsp;<span class="ident" id="5835819">v</span>&nbsp;<span class="op" id="5835821">:=</span>&nbsp;<span class="keyword" id="5835824">range</span>&nbsp;<span class="ident" id="5835830">s</span><span class="op" id="5835831">.</span><span class="ident" id="5835832">css</span>&nbsp;<span class="op" id="5835836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835841">s</span><span class="op" id="5835842">.</span><span class="ident" id="5835843">db</span><span class="op" id="5835845">.</span><span class="ident" id="5835846">noteUnusedDriverStatement</span><span class="op" id="5835871">(</span><span class="ident" id="5835872">v</span><span class="op" id="5835873">.</span><span class="ident" id="5835874">dc</span><span class="op" id="5835876">,</span>&nbsp;<span class="ident" id="5835878">v</span><span class="op" id="5835879">.</span><span class="ident" id="5835880">si</span><span class="op" id="5835882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835887">v</span><span class="op" id="5835888">.</span><span class="ident" id="5835889">dc</span><span class="op" id="5835891">.</span><span class="ident" id="5835892">removeOpenStmt</span><span class="op" id="5835906">(</span><span class="ident" id="5835907">v</span><span class="op" id="5835908">.</span><span class="ident" id="5835909">si</span><span class="op" id="5835911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5835915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835919">s</span><span class="op" id="5835920">.</span><span class="ident" id="5835921">css</span>&nbsp;<span class="op" id="5835925">=</span>&nbsp;<span class="ident" id="5835927">nil</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5835932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835935">return</span>&nbsp;<span class="ident" id="5835942">nil</span><br>
<span class="lineno"></span><span class="op" id="5835946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5835949">//&nbsp;Rows&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;query.&nbsp;Its&nbsp;cursor&nbsp;starts&nbsp;before&nbsp;the&nbsp;first&nbsp;row</span><br>
<span class="lineno">1555</span><span class="comment" id="5836022">//&nbsp;of&nbsp;the&nbsp;result&nbsp;set.&nbsp;Use&nbsp;Next&nbsp;to&nbsp;advance&nbsp;through&nbsp;the&nbsp;rows:</span><br>
<span class="lineno"></span><span class="comment" id="5836082">//</span><br>
<span class="lineno"></span><span class="comment" id="5836085">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rows,&nbsp;err&nbsp;:=&nbsp;db.Query(&#34;SELECT&nbsp;...&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="5836128">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5836139">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defer&nbsp;rows.Close()</span><br>
<span class="lineno">1560</span><span class="comment" id="5836165">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;rows.Next()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="5836190">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;id&nbsp;int</span><br>
<span class="lineno"></span><span class="comment" id="5836212">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5836239">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Scan(&amp;id,&nbsp;&amp;name)</span><br>
<span class="lineno"></span><span class="comment" id="5836278">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno">1565</span><span class="comment" id="5836293">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="5836302">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Err()&nbsp;//&nbsp;get&nbsp;any&nbsp;error&nbsp;encountered&nbsp;during&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="5836372">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="keyword" id="5836383">type</span>&nbsp;<span class="ident" id="5836388">Rows</span>&nbsp;<span class="keyword" id="5836393">struct</span>&nbsp;<span class="op" id="5836400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836403">dc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5836415">*</span><span class="ident" id="5836416">driverConn</span>&nbsp;<span class="comment" id="5836427">//&nbsp;owned;&nbsp;must&nbsp;call&nbsp;releaseConn&nbsp;when&nbsp;closed&nbsp;to&nbsp;release</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836483">releaseConn</span>&nbsp;<span class="keyword" id="5836495">func</span><span class="op" id="5836499">(</span><span class="builtintype" id="5836500">error</span><span class="op" id="5836505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836508">rowsi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5836520">driver</span><span class="op" id="5836526">.</span><span class="ident" id="5836527">Rows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836534">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5836544">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836550">lastcols</span>&nbsp;&nbsp;<span class="op" id="5836560">[</span><span class="op" id="5836561">]</span><span class="ident" id="5836562">driver</span><span class="op" id="5836568">.</span><span class="ident" id="5836569">Value</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836576">lasterr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5836586">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5836598">//&nbsp;non-nil&nbsp;only&nbsp;if&nbsp;closed&nbsp;is&nbsp;true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836633">closeStmt</span>&nbsp;<span class="ident" id="5836643">driver</span><span class="op" id="5836649">.</span><span class="ident" id="5836650">Stmt</span>&nbsp;<span class="comment" id="5836655">//&nbsp;if&nbsp;non-nil,&nbsp;statement&nbsp;to&nbsp;Close&nbsp;on&nbsp;close</span><br>
<span class="lineno"></span><span class="op" id="5836698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5836701">//&nbsp;Next&nbsp;prepares&nbsp;the&nbsp;next&nbsp;result&nbsp;row&nbsp;for&nbsp;reading&nbsp;with&nbsp;the&nbsp;Scan&nbsp;method.&nbsp;&nbsp;It</span><br>
<span class="lineno">1580</span><span class="comment" id="5836776">//&nbsp;returns&nbsp;true&nbsp;on&nbsp;success,&nbsp;or&nbsp;false&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;next&nbsp;result&nbsp;row&nbsp;or&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5836856">//&nbsp;happened&nbsp;while&nbsp;preparing&nbsp;it.&nbsp;&nbsp;Err&nbsp;should&nbsp;be&nbsp;consulted&nbsp;to&nbsp;distinguish&nbsp;between</span><br>
<span class="lineno"></span><span class="comment" id="5836936">//&nbsp;the&nbsp;two&nbsp;cases.</span><br>
<span class="lineno"></span><span class="comment" id="5836954">//</span><br>
<span class="lineno"></span><span class="comment" id="5836957">//&nbsp;Every&nbsp;call&nbsp;to&nbsp;Scan,&nbsp;even&nbsp;the&nbsp;first&nbsp;one,&nbsp;must&nbsp;be&nbsp;preceded&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Next.</span><br>
<span class="lineno">1585</span><span class="keyword" id="5837036">func</span>&nbsp;<span class="op" id="5837041">(</span><span class="ident" id="5837042">rs</span>&nbsp;<span class="op" id="5837045">*</span><span class="ident" id="5837046">Rows</span><span class="op" id="5837050">)</span>&nbsp;<span class="ident" id="5837052">Next</span><span class="op" id="5837056">(</span><span class="op" id="5837057">)</span>&nbsp;<span class="builtintype" id="5837059">bool</span>&nbsp;<span class="op" id="5837064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837067">if</span>&nbsp;<span class="ident" id="5837070">rs</span><span class="op" id="5837072">.</span><span class="ident" id="5837073">closed</span>&nbsp;<span class="op" id="5837080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837084">return</span>&nbsp;<span class="builtintype" id="5837091">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5837098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837101">if</span>&nbsp;<span class="ident" id="5837104">rs</span><span class="op" id="5837106">.</span><span class="ident" id="5837107">lastcols</span>&nbsp;<span class="op" id="5837116">==</span>&nbsp;<span class="ident" id="5837119">nil</span>&nbsp;<span class="op" id="5837123">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5837127">rs</span><span class="op" id="5837129">.</span><span class="ident" id="5837130">lastcols</span>&nbsp;<span class="op" id="5837139">=</span>&nbsp;<span class="builtinfunc" id="5837141">make</span><span class="op" id="5837145">(</span><span class="op" id="5837146">[</span><span class="op" id="5837147">]</span><span class="ident" id="5837148">driver</span><span class="op" id="5837154">.</span><span class="ident" id="5837155">Value</span><span class="op" id="5837160">,</span>&nbsp;<span class="builtinfunc" id="5837162">len</span><span class="op" id="5837165">(</span><span class="ident" id="5837166">rs</span><span class="op" id="5837168">.</span><span class="ident" id="5837169">rowsi</span><span class="op" id="5837174">.</span><span class="ident" id="5837175">Columns</span><span class="op" id="5837182">(</span><span class="op" id="5837183">)</span><span class="op" id="5837184">)</span><span class="op" id="5837185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5837188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5837191">rs</span><span class="op" id="5837193">.</span><span class="ident" id="5837194">lasterr</span>&nbsp;<span class="op" id="5837202">=</span>&nbsp;<span class="ident" id="5837204">rs</span><span class="op" id="5837206">.</span><span class="ident" id="5837207">rowsi</span><span class="op" id="5837212">.</span><span class="ident" id="5837213">Next</span><span class="op" id="5837217">(</span><span class="ident" id="5837218">rs</span><span class="op" id="5837220">.</span><span class="ident" id="5837221">lastcols</span><span class="op" id="5837229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837232">if</span>&nbsp;<span class="ident" id="5837235">rs</span><span class="op" id="5837237">.</span><span class="ident" id="5837238">lasterr</span>&nbsp;<span class="op" id="5837246">!=</span>&nbsp;<span class="ident" id="5837249">nil</span>&nbsp;<span class="op" id="5837253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5837257">rs</span><span class="op" id="5837259">.</span><span class="ident" id="5837260">Close</span><span class="op" id="5837265">(</span><span class="op" id="5837266">)</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837270">return</span>&nbsp;<span class="builtintype" id="5837277">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5837284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837287">return</span>&nbsp;<span class="builtintype" id="5837294">true</span><br>
<span class="lineno"></span><span class="op" id="5837299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="5837302">//&nbsp;Err&nbsp;returns&nbsp;the&nbsp;error,&nbsp;if&nbsp;any,&nbsp;that&nbsp;was&nbsp;encountered&nbsp;during&nbsp;iteration.</span><br>
<span class="lineno"></span><span class="comment" id="5837375">//&nbsp;Err&nbsp;may&nbsp;be&nbsp;called&nbsp;after&nbsp;an&nbsp;explicit&nbsp;or&nbsp;implicit&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="5837433">func</span>&nbsp;<span class="op" id="5837438">(</span><span class="ident" id="5837439">rs</span>&nbsp;<span class="op" id="5837442">*</span><span class="ident" id="5837443">Rows</span><span class="op" id="5837447">)</span>&nbsp;<span class="ident" id="5837449">Err</span><span class="op" id="5837452">(</span><span class="op" id="5837453">)</span>&nbsp;<span class="builtintype" id="5837455">error</span>&nbsp;<span class="op" id="5837461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837464">if</span>&nbsp;<span class="ident" id="5837467">rs</span><span class="op" id="5837469">.</span><span class="ident" id="5837470">lasterr</span>&nbsp;<span class="op" id="5837478">==</span>&nbsp;<span class="ident" id="5837481">io</span><span class="op" id="5837483">.</span><span class="ident" id="5837484">EOF</span>&nbsp;<span class="op" id="5837488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837492">return</span>&nbsp;<span class="ident" id="5837499">nil</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5837504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837507">return</span>&nbsp;<span class="ident" id="5837514">rs</span><span class="op" id="5837516">.</span><span class="ident" id="5837517">lasterr</span><br>
<span class="lineno"></span><span class="op" id="5837525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5837528">//&nbsp;Columns&nbsp;returns&nbsp;the&nbsp;column&nbsp;names.</span><br>
<span class="lineno">1610</span><span class="comment" id="5837565">//&nbsp;Columns&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;rows&nbsp;are&nbsp;closed,&nbsp;or&nbsp;if&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span><span class="comment" id="5837632">//&nbsp;are&nbsp;from&nbsp;QueryRow&nbsp;and&nbsp;there&nbsp;was&nbsp;a&nbsp;deferred&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="5837685">func</span>&nbsp;<span class="op" id="5837690">(</span><span class="ident" id="5837691">rs</span>&nbsp;<span class="op" id="5837694">*</span><span class="ident" id="5837695">Rows</span><span class="op" id="5837699">)</span>&nbsp;<span class="ident" id="5837701">Columns</span><span class="op" id="5837708">(</span><span class="op" id="5837709">)</span>&nbsp;<span class="op" id="5837711">(</span><span class="op" id="5837712">[</span><span class="op" id="5837713">]</span><span class="builtintype" id="5837714">string</span><span class="op" id="5837720">,</span>&nbsp;<span class="builtintype" id="5837722">error</span><span class="op" id="5837727">)</span>&nbsp;<span class="op" id="5837729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837732">if</span>&nbsp;<span class="ident" id="5837735">rs</span><span class="op" id="5837737">.</span><span class="ident" id="5837738">closed</span>&nbsp;<span class="op" id="5837745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837749">return</span>&nbsp;<span class="ident" id="5837756">nil</span><span class="op" id="5837759">,</span>&nbsp;<span class="ident" id="5837761">errors</span><span class="op" id="5837767">.</span><span class="ident" id="5837768">New</span><span class="op" id="5837771">(</span><span class="string" id="5837772">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="5837794">)</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5837797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837800">if</span>&nbsp;<span class="ident" id="5837803">rs</span><span class="op" id="5837805">.</span><span class="ident" id="5837806">rowsi</span>&nbsp;<span class="op" id="5837812">==</span>&nbsp;<span class="ident" id="5837815">nil</span>&nbsp;<span class="op" id="5837819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837823">return</span>&nbsp;<span class="ident" id="5837830">nil</span><span class="op" id="5837833">,</span>&nbsp;<span class="ident" id="5837835">errors</span><span class="op" id="5837841">.</span><span class="ident" id="5837842">New</span><span class="op" id="5837845">(</span><span class="string" id="5837846">&#34;sql:&nbsp;no&nbsp;Rows&nbsp;available&#34;</span><span class="op" id="5837870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5837873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837876">return</span>&nbsp;<span class="ident" id="5837883">rs</span><span class="op" id="5837885">.</span><span class="ident" id="5837886">rowsi</span><span class="op" id="5837891">.</span><span class="ident" id="5837892">Columns</span><span class="op" id="5837899">(</span><span class="op" id="5837900">)</span><span class="op" id="5837901">,</span>&nbsp;<span class="ident" id="5837903">nil</span><br>
<span class="lineno">1620</span><span class="op" id="5837907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5837910">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;in&nbsp;the&nbsp;current&nbsp;row&nbsp;into&nbsp;the&nbsp;values&nbsp;pointed</span><br>
<span class="lineno"></span><span class="comment" id="5837980">//&nbsp;at&nbsp;by&nbsp;dest.</span><br>
<span class="lineno"></span><span class="comment" id="5837995">//</span><br>
<span class="lineno">1625</span><span class="comment" id="5837998">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*[]byte,&nbsp;Scan&nbsp;saves&nbsp;in&nbsp;that&nbsp;argument&nbsp;a&nbsp;copy</span><br>
<span class="lineno"></span><span class="comment" id="5838069">//&nbsp;of&nbsp;the&nbsp;corresponding&nbsp;data.&nbsp;The&nbsp;copy&nbsp;is&nbsp;owned&nbsp;by&nbsp;the&nbsp;caller&nbsp;and&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="5838139">//&nbsp;be&nbsp;modified&nbsp;and&nbsp;held&nbsp;indefinitely.&nbsp;The&nbsp;copy&nbsp;can&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using</span><br>
<span class="lineno"></span><span class="comment" id="5838210">//&nbsp;an&nbsp;argument&nbsp;of&nbsp;type&nbsp;*RawBytes&nbsp;instead;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5838278">//&nbsp;RawBytes&nbsp;for&nbsp;restrictions&nbsp;on&nbsp;its&nbsp;use.</span><br>
<span class="lineno">1630</span><span class="comment" id="5838319">//</span><br>
<span class="lineno"></span><span class="comment" id="5838322">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*interface{},&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5838385">//&nbsp;provided&nbsp;by&nbsp;the&nbsp;underlying&nbsp;driver&nbsp;without&nbsp;conversion.&nbsp;If&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5838455">//&nbsp;is&nbsp;of&nbsp;type&nbsp;[]byte,&nbsp;a&nbsp;copy&nbsp;is&nbsp;made&nbsp;and&nbsp;the&nbsp;caller&nbsp;owns&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span><span class="keyword" id="5838524">func</span>&nbsp;<span class="op" id="5838529">(</span><span class="ident" id="5838530">rs</span>&nbsp;<span class="op" id="5838533">*</span><span class="ident" id="5838534">Rows</span><span class="op" id="5838538">)</span>&nbsp;<span class="ident" id="5838540">Scan</span><span class="op" id="5838544">(</span><span class="ident" id="5838545">dest</span>&nbsp;<span class="op" id="5838550">...</span><span class="keyword" id="5838553">interface</span><span class="op" id="5838562">{</span><span class="op" id="5838563">}</span><span class="op" id="5838564">)</span>&nbsp;<span class="builtintype" id="5838566">error</span>&nbsp;<span class="op" id="5838572">{</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5838575">if</span>&nbsp;<span class="ident" id="5838578">rs</span><span class="op" id="5838580">.</span><span class="ident" id="5838581">closed</span>&nbsp;<span class="op" id="5838588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5838592">return</span>&nbsp;<span class="ident" id="5838599">errors</span><span class="op" id="5838605">.</span><span class="ident" id="5838606">New</span><span class="op" id="5838609">(</span><span class="string" id="5838610">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="5838632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5838635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5838638">if</span>&nbsp;<span class="ident" id="5838641">rs</span><span class="op" id="5838643">.</span><span class="ident" id="5838644">lastcols</span>&nbsp;<span class="op" id="5838653">==</span>&nbsp;<span class="ident" id="5838656">nil</span>&nbsp;<span class="op" id="5838660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5838664">return</span>&nbsp;<span class="ident" id="5838671">errors</span><span class="op" id="5838677">.</span><span class="ident" id="5838678">New</span><span class="op" id="5838681">(</span><span class="string" id="5838682">&#34;sql:&nbsp;Scan&nbsp;called&nbsp;without&nbsp;calling&nbsp;Next&#34;</span><span class="op" id="5838721">)</span><br>
<span class="lineno">1640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5838724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5838727">if</span>&nbsp;<span class="builtinfunc" id="5838730">len</span><span class="op" id="5838733">(</span><span class="ident" id="5838734">dest</span><span class="op" id="5838738">)</span>&nbsp;<span class="op" id="5838740">!=</span>&nbsp;<span class="builtinfunc" id="5838743">len</span><span class="op" id="5838746">(</span><span class="ident" id="5838747">rs</span><span class="op" id="5838749">.</span><span class="ident" id="5838750">lastcols</span><span class="op" id="5838758">)</span>&nbsp;<span class="op" id="5838760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5838764">return</span>&nbsp;<span class="ident" id="5838771">fmt</span><span class="op" id="5838774">.</span><span class="ident" id="5838775">Errorf</span><span class="op" id="5838781">(</span><span class="string" id="5838782">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;destination&nbsp;arguments&nbsp;in&nbsp;Scan,&nbsp;not&nbsp;%d&#34;</span><span class="op" id="5838838">,</span>&nbsp;<span class="builtinfunc" id="5838840">len</span><span class="op" id="5838843">(</span><span class="ident" id="5838844">rs</span><span class="op" id="5838846">.</span><span class="ident" id="5838847">lastcols</span><span class="op" id="5838855">)</span><span class="op" id="5838856">,</span>&nbsp;<span class="builtinfunc" id="5838858">len</span><span class="op" id="5838861">(</span><span class="ident" id="5838862">dest</span><span class="op" id="5838866">)</span><span class="op" id="5838867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5838870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5838873">for</span>&nbsp;<span class="ident" id="5838877">i</span><span class="op" id="5838878">,</span>&nbsp;<span class="ident" id="5838880">sv</span>&nbsp;<span class="op" id="5838883">:=</span>&nbsp;<span class="keyword" id="5838886">range</span>&nbsp;<span class="ident" id="5838892">rs</span><span class="op" id="5838894">.</span><span class="ident" id="5838895">lastcols</span>&nbsp;<span class="op" id="5838904">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5838908">err</span>&nbsp;<span class="op" id="5838912">:=</span>&nbsp;<span class="ident" id="5838915">convertAssign</span><span class="op" id="5838928">(</span><span class="ident" id="5838929">dest</span><span class="op" id="5838933">[</span><span class="ident" id="5838934">i</span><span class="op" id="5838935">]</span><span class="op" id="5838936">,</span>&nbsp;<span class="ident" id="5838938">sv</span><span class="op" id="5838940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5838944">if</span>&nbsp;<span class="ident" id="5838947">err</span>&nbsp;<span class="op" id="5838951">!=</span>&nbsp;<span class="ident" id="5838954">nil</span>&nbsp;<span class="op" id="5838958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5838963">return</span>&nbsp;<span class="ident" id="5838970">fmt</span><span class="op" id="5838973">.</span><span class="ident" id="5838974">Errorf</span><span class="op" id="5838980">(</span><span class="string" id="5838981">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="5839021">,</span>&nbsp;<span class="ident" id="5839023">i</span><span class="op" id="5839024">,</span>&nbsp;<span class="ident" id="5839026">err</span><span class="op" id="5839029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5839033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5839036">}</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5839039">return</span>&nbsp;<span class="ident" id="5839046">nil</span><br>
<span class="lineno"></span><span class="op" id="5839050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5839053">var</span>&nbsp;<span class="ident" id="5839057">rowsCloseHook</span>&nbsp;<span class="keyword" id="5839071">func</span><span class="op" id="5839075">(</span><span class="op" id="5839076">*</span><span class="ident" id="5839077">Rows</span><span class="op" id="5839081">,</span>&nbsp;<span class="op" id="5839083">*</span><span class="builtintype" id="5839084">error</span><span class="op" id="5839089">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1655</span><span class="comment" id="5839092">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;Rows,&nbsp;preventing&nbsp;further&nbsp;enumeration.&nbsp;If&nbsp;Next&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5839166">//&nbsp;false,&nbsp;the&nbsp;Rows&nbsp;are&nbsp;closed&nbsp;automatically&nbsp;and&nbsp;it&nbsp;will&nbsp;suffice&nbsp;to&nbsp;check&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5839243">//&nbsp;result&nbsp;of&nbsp;Err.&nbsp;Close&nbsp;is&nbsp;idempotent&nbsp;and&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;result&nbsp;of&nbsp;Err.</span><br>
<span class="lineno"></span><span class="keyword" id="5839320">func</span>&nbsp;<span class="op" id="5839325">(</span><span class="ident" id="5839326">rs</span>&nbsp;<span class="op" id="5839329">*</span><span class="ident" id="5839330">Rows</span><span class="op" id="5839334">)</span>&nbsp;<span class="ident" id="5839336">Close</span><span class="op" id="5839341">(</span><span class="op" id="5839342">)</span>&nbsp;<span class="builtintype" id="5839344">error</span>&nbsp;<span class="op" id="5839350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5839353">if</span>&nbsp;<span class="ident" id="5839356">rs</span><span class="op" id="5839358">.</span><span class="ident" id="5839359">closed</span>&nbsp;<span class="op" id="5839366">{</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5839370">return</span>&nbsp;<span class="ident" id="5839377">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5839382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839385">rs</span><span class="op" id="5839387">.</span><span class="ident" id="5839388">closed</span>&nbsp;<span class="op" id="5839395">=</span>&nbsp;<span class="builtintype" id="5839397">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839403">err</span>&nbsp;<span class="op" id="5839407">:=</span>&nbsp;<span class="ident" id="5839410">rs</span><span class="op" id="5839412">.</span><span class="ident" id="5839413">rowsi</span><span class="op" id="5839418">.</span><span class="ident" id="5839419">Close</span><span class="op" id="5839424">(</span><span class="op" id="5839425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5839428">if</span>&nbsp;<span class="ident" id="5839431">fn</span>&nbsp;<span class="op" id="5839434">:=</span>&nbsp;<span class="ident" id="5839437">rowsCloseHook</span><span class="op" id="5839450">;</span>&nbsp;<span class="ident" id="5839452">fn</span>&nbsp;<span class="op" id="5839455">!=</span>&nbsp;<span class="ident" id="5839458">nil</span>&nbsp;<span class="op" id="5839462">{</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839466">fn</span><span class="op" id="5839468">(</span><span class="ident" id="5839469">rs</span><span class="op" id="5839471">,</span>&nbsp;<span class="op" id="5839473">&amp;</span><span class="ident" id="5839474">err</span><span class="op" id="5839477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5839480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5839483">if</span>&nbsp;<span class="ident" id="5839486">rs</span><span class="op" id="5839488">.</span><span class="ident" id="5839489">closeStmt</span>&nbsp;<span class="op" id="5839499">!=</span>&nbsp;<span class="ident" id="5839502">nil</span>&nbsp;<span class="op" id="5839506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839510">rs</span><span class="op" id="5839512">.</span><span class="ident" id="5839513">closeStmt</span><span class="op" id="5839522">.</span><span class="ident" id="5839523">Close</span><span class="op" id="5839528">(</span><span class="op" id="5839529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5839532">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839535">rs</span><span class="op" id="5839537">.</span><span class="ident" id="5839538">releaseConn</span><span class="op" id="5839549">(</span><span class="ident" id="5839550">err</span><span class="op" id="5839553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5839556">return</span>&nbsp;<span class="ident" id="5839563">err</span><br>
<span class="lineno"></span><span class="op" id="5839567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5839570">//&nbsp;Row&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;QueryRow&nbsp;to&nbsp;select&nbsp;a&nbsp;single&nbsp;row.</span><br>
<span class="lineno">1675</span><span class="keyword" id="5839635">type</span>&nbsp;<span class="ident" id="5839640">Row</span>&nbsp;<span class="keyword" id="5839644">struct</span>&nbsp;<span class="op" id="5839651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5839654">//&nbsp;One&nbsp;of&nbsp;these&nbsp;two&nbsp;will&nbsp;be&nbsp;non-nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839692">err</span>&nbsp;&nbsp;<span class="builtintype" id="5839697">error</span>&nbsp;<span class="comment" id="5839703">//&nbsp;deferred&nbsp;error&nbsp;for&nbsp;easy&nbsp;chaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839740">rows</span>&nbsp;<span class="op" id="5839745">*</span><span class="ident" id="5839746">Rows</span><br>
<span class="lineno"></span><span class="op" id="5839751">}</span><br>
<span class="lineno">1680</span><br>
<span class="lineno"></span><span class="comment" id="5839754">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;from&nbsp;the&nbsp;matched&nbsp;row&nbsp;into&nbsp;the&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="5839818">//&nbsp;pointed&nbsp;at&nbsp;by&nbsp;dest.&nbsp;&nbsp;If&nbsp;more&nbsp;than&nbsp;one&nbsp;row&nbsp;matches&nbsp;the&nbsp;query,</span><br>
<span class="lineno"></span><span class="comment" id="5839882">//&nbsp;Scan&nbsp;uses&nbsp;the&nbsp;first&nbsp;row&nbsp;and&nbsp;discards&nbsp;the&nbsp;rest.&nbsp;&nbsp;If&nbsp;no&nbsp;row&nbsp;matches</span><br>
<span class="lineno"></span><span class="comment" id="5839951">//&nbsp;the&nbsp;query,&nbsp;Scan&nbsp;returns&nbsp;ErrNoRows.</span><br>
<span class="lineno">1685</span><span class="keyword" id="5839989">func</span>&nbsp;<span class="op" id="5839994">(</span><span class="ident" id="5839995">r</span>&nbsp;<span class="op" id="5839997">*</span><span class="ident" id="5839998">Row</span><span class="op" id="5840001">)</span>&nbsp;<span class="ident" id="5840003">Scan</span><span class="op" id="5840007">(</span><span class="ident" id="5840008">dest</span>&nbsp;<span class="op" id="5840013">...</span><span class="keyword" id="5840016">interface</span><span class="op" id="5840025">{</span><span class="op" id="5840026">}</span><span class="op" id="5840027">)</span>&nbsp;<span class="builtintype" id="5840029">error</span>&nbsp;<span class="op" id="5840035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5840038">if</span>&nbsp;<span class="ident" id="5840041">r</span><span class="op" id="5840042">.</span><span class="ident" id="5840043">err</span>&nbsp;<span class="op" id="5840047">!=</span>&nbsp;<span class="ident" id="5840050">nil</span>&nbsp;<span class="op" id="5840054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5840058">return</span>&nbsp;<span class="ident" id="5840065">r</span><span class="op" id="5840066">.</span><span class="ident" id="5840067">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5840072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5840076">//&nbsp;TODO(bradfitz):&nbsp;for&nbsp;now&nbsp;we&nbsp;need&nbsp;to&nbsp;defensively&nbsp;clone&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5840137">//&nbsp;[]byte&nbsp;that&nbsp;the&nbsp;driver&nbsp;returned&nbsp;(not&nbsp;permitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5840189">//&nbsp;*RawBytes&nbsp;in&nbsp;Rows.Scan),&nbsp;since&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5840245">//&nbsp;the&nbsp;Rows&nbsp;in&nbsp;our&nbsp;defer,&nbsp;when&nbsp;we&nbsp;return&nbsp;from&nbsp;this&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5840307">//&nbsp;the&nbsp;contract&nbsp;with&nbsp;the&nbsp;driver.Next(...)&nbsp;interface&nbsp;is&nbsp;that&nbsp;it</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5840371">//&nbsp;can&nbsp;return&nbsp;slices&nbsp;into&nbsp;read-only&nbsp;temporary&nbsp;memory&nbsp;that&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5840432">//&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;Scan/Close.&nbsp;&nbsp;But&nbsp;the&nbsp;TODO&nbsp;is&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5840496">//&nbsp;for&nbsp;a&nbsp;lot&nbsp;of&nbsp;drivers,&nbsp;this&nbsp;copy&nbsp;will&nbsp;be&nbsp;unnecessary.&nbsp;&nbsp;We</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5840557">//&nbsp;should&nbsp;provide&nbsp;an&nbsp;optional&nbsp;interface&nbsp;for&nbsp;drivers&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5840613">//&nbsp;implement&nbsp;to&nbsp;say,&nbsp;&#34;don&#39;t&nbsp;worry,&nbsp;the&nbsp;[]bytes&nbsp;that&nbsp;I&nbsp;return</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5840675">//&nbsp;from&nbsp;Next&nbsp;will&nbsp;not&nbsp;be&nbsp;modified&nbsp;again.&#34;&nbsp;(for&nbsp;instance,&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5840736">//&nbsp;they&nbsp;were&nbsp;obtained&nbsp;from&nbsp;the&nbsp;network&nbsp;anyway)&nbsp;But&nbsp;for&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5840799">//&nbsp;don&#39;t&nbsp;care.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5840815">defer</span>&nbsp;<span class="ident" id="5840821">r</span><span class="op" id="5840822">.</span><span class="ident" id="5840823">rows</span><span class="op" id="5840827">.</span><span class="ident" id="5840828">Close</span><span class="op" id="5840833">(</span><span class="op" id="5840834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5840837">for</span>&nbsp;<span class="ident" id="5840841">_</span><span class="op" id="5840842">,</span>&nbsp;<span class="ident" id="5840844">dp</span>&nbsp;<span class="op" id="5840847">:=</span>&nbsp;<span class="keyword" id="5840850">range</span>&nbsp;<span class="ident" id="5840856">dest</span>&nbsp;<span class="op" id="5840861">{</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5840865">if</span>&nbsp;<span class="ident" id="5840868">_</span><span class="op" id="5840869">,</span>&nbsp;<span class="ident" id="5840871">ok</span>&nbsp;<span class="op" id="5840874">:=</span>&nbsp;<span class="ident" id="5840877">dp</span><span class="op" id="5840879">.</span><span class="op" id="5840880">(</span><span class="op" id="5840881">*</span><span class="ident" id="5840882">RawBytes</span><span class="op" id="5840890">)</span><span class="op" id="5840891">;</span>&nbsp;<span class="ident" id="5840893">ok</span>&nbsp;<span class="op" id="5840896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5840901">return</span>&nbsp;<span class="ident" id="5840908">errors</span><span class="op" id="5840914">.</span><span class="ident" id="5840915">New</span><span class="op" id="5840918">(</span><span class="string" id="5840919">&#34;sql:&nbsp;RawBytes&nbsp;isn&#39;t&nbsp;allowed&nbsp;on&nbsp;Row.Scan&#34;</span><span class="op" id="5840960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5840964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5840967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5840971">if</span>&nbsp;<span class="op" id="5840974">!</span><span class="ident" id="5840975">r</span><span class="op" id="5840976">.</span><span class="ident" id="5840977">rows</span><span class="op" id="5840981">.</span><span class="ident" id="5840982">Next</span><span class="op" id="5840986">(</span><span class="op" id="5840987">)</span>&nbsp;<span class="op" id="5840989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5840993">if</span>&nbsp;<span class="ident" id="5840996">err</span>&nbsp;<span class="op" id="5841000">:=</span>&nbsp;<span class="ident" id="5841003">r</span><span class="op" id="5841004">.</span><span class="ident" id="5841005">rows</span><span class="op" id="5841009">.</span><span class="ident" id="5841010">Err</span><span class="op" id="5841013">(</span><span class="op" id="5841014">)</span><span class="op" id="5841015">;</span>&nbsp;<span class="ident" id="5841017">err</span>&nbsp;<span class="op" id="5841021">!=</span>&nbsp;<span class="ident" id="5841024">nil</span>&nbsp;<span class="op" id="5841028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5841033">return</span>&nbsp;<span class="ident" id="5841040">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5841046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5841050">return</span>&nbsp;<span class="ident" id="5841057">ErrNoRows</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5841068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5841071">err</span>&nbsp;<span class="op" id="5841075">:=</span>&nbsp;<span class="ident" id="5841078">r</span><span class="op" id="5841079">.</span><span class="ident" id="5841080">rows</span><span class="op" id="5841084">.</span><span class="ident" id="5841085">Scan</span><span class="op" id="5841089">(</span><span class="ident" id="5841090">dest</span><span class="op" id="5841094">...</span><span class="op" id="5841097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5841100">if</span>&nbsp;<span class="ident" id="5841103">err</span>&nbsp;<span class="op" id="5841107">!=</span>&nbsp;<span class="ident" id="5841110">nil</span>&nbsp;<span class="op" id="5841114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5841118">return</span>&nbsp;<span class="ident" id="5841125">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5841130">}</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5841133">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;query&nbsp;can&nbsp;be&nbsp;processed&nbsp;to&nbsp;completion&nbsp;with&nbsp;no&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5841204">if</span>&nbsp;<span class="ident" id="5841207">err</span>&nbsp;<span class="op" id="5841211">:=</span>&nbsp;<span class="ident" id="5841214">r</span><span class="op" id="5841215">.</span><span class="ident" id="5841216">rows</span><span class="op" id="5841220">.</span><span class="ident" id="5841221">Close</span><span class="op" id="5841226">(</span><span class="op" id="5841227">)</span><span class="op" id="5841228">;</span>&nbsp;<span class="ident" id="5841230">err</span>&nbsp;<span class="op" id="5841234">!=</span>&nbsp;<span class="ident" id="5841237">nil</span>&nbsp;<span class="op" id="5841241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5841245">return</span>&nbsp;<span class="ident" id="5841252">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5841257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5841261">return</span>&nbsp;<span class="ident" id="5841268">nil</span><br>
<span class="lineno"></span><span class="op" id="5841272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5841275">//&nbsp;A&nbsp;Result&nbsp;summarizes&nbsp;an&nbsp;executed&nbsp;SQL&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="5841323">type</span>&nbsp;<span class="ident" id="5841328">Result</span>&nbsp;<span class="keyword" id="5841335">interface</span>&nbsp;<span class="op" id="5841345">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5841348">//&nbsp;LastInsertId&nbsp;returns&nbsp;the&nbsp;integer&nbsp;generated&nbsp;by&nbsp;the&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5841411">//&nbsp;in&nbsp;response&nbsp;to&nbsp;a&nbsp;command.&nbsp;Typically&nbsp;this&nbsp;will&nbsp;be&nbsp;from&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5841472">//&nbsp;&#34;auto&nbsp;increment&#34;&nbsp;column&nbsp;when&nbsp;inserting&nbsp;a&nbsp;new&nbsp;row.&nbsp;Not&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5841534">//&nbsp;databases&nbsp;support&nbsp;this&nbsp;feature,&nbsp;and&nbsp;the&nbsp;syntax&nbsp;of&nbsp;such</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5841593">//&nbsp;statements&nbsp;varies.</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5841616">LastInsertId</span><span class="op" id="5841628">(</span><span class="op" id="5841629">)</span>&nbsp;<span class="op" id="5841631">(</span><span class="ident" id="5841632">int64</span><span class="op" id="5841637">,</span>&nbsp;<span class="builtintype" id="5841639">error</span><span class="op" id="5841644">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5841648">//&nbsp;RowsAffected&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;rows&nbsp;affected&nbsp;by&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5841707">//&nbsp;update,&nbsp;insert,&nbsp;or&nbsp;delete.&nbsp;Not&nbsp;every&nbsp;database&nbsp;or&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5841769">//&nbsp;driver&nbsp;may&nbsp;support&nbsp;this.</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5841798">RowsAffected</span><span class="op" id="5841810">(</span><span class="op" id="5841811">)</span>&nbsp;<span class="op" id="5841813">(</span><span class="ident" id="5841814">int64</span><span class="op" id="5841819">,</span>&nbsp;<span class="builtintype" id="5841821">error</span><span class="op" id="5841826">)</span><br>
<span class="lineno"></span><span class="op" id="5841828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5841831">type</span>&nbsp;<span class="ident" id="5841836">driverResult</span>&nbsp;<span class="keyword" id="5841849">struct</span>&nbsp;<span class="op" id="5841856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5841859">sync</span><span class="op" id="5841863">.</span><span class="ident" id="5841864">Locker</span>&nbsp;<span class="comment" id="5841871">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5841891">resi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5841903">driver</span><span class="op" id="5841909">.</span><span class="ident" id="5841910">Result</span><br>
<span class="lineno"></span><span class="op" id="5841917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5841920">func</span>&nbsp;<span class="op" id="5841925">(</span><span class="ident" id="5841926">dr</span>&nbsp;<span class="ident" id="5841929">driverResult</span><span class="op" id="5841941">)</span>&nbsp;<span class="ident" id="5841943">LastInsertId</span><span class="op" id="5841955">(</span><span class="op" id="5841956">)</span>&nbsp;<span class="op" id="5841958">(</span><span class="ident" id="5841959">int64</span><span class="op" id="5841964">,</span>&nbsp;<span class="builtintype" id="5841966">error</span><span class="op" id="5841971">)</span>&nbsp;<span class="op" id="5841973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5841976">dr</span><span class="op" id="5841978">.</span><span class="ident" id="5841979">Lock</span><span class="op" id="5841983">(</span><span class="op" id="5841984">)</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5841987">defer</span>&nbsp;<span class="ident" id="5841993">dr</span><span class="op" id="5841995">.</span><span class="ident" id="5841996">Unlock</span><span class="op" id="5842002">(</span><span class="op" id="5842003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5842006">return</span>&nbsp;<span class="ident" id="5842013">dr</span><span class="op" id="5842015">.</span><span class="ident" id="5842016">resi</span><span class="op" id="5842020">.</span><span class="ident" id="5842021">LastInsertId</span><span class="op" id="5842033">(</span><span class="op" id="5842034">)</span><br>
<span class="lineno"></span><span class="op" id="5842036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5842039">func</span>&nbsp;<span class="op" id="5842044">(</span><span class="ident" id="5842045">dr</span>&nbsp;<span class="ident" id="5842048">driverResult</span><span class="op" id="5842060">)</span>&nbsp;<span class="ident" id="5842062">RowsAffected</span><span class="op" id="5842074">(</span><span class="op" id="5842075">)</span>&nbsp;<span class="op" id="5842077">(</span><span class="ident" id="5842078">int64</span><span class="op" id="5842083">,</span>&nbsp;<span class="builtintype" id="5842085">error</span><span class="op" id="5842090">)</span>&nbsp;<span class="op" id="5842092">{</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5842095">dr</span><span class="op" id="5842097">.</span><span class="ident" id="5842098">Lock</span><span class="op" id="5842102">(</span><span class="op" id="5842103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5842106">defer</span>&nbsp;<span class="ident" id="5842112">dr</span><span class="op" id="5842114">.</span><span class="ident" id="5842115">Unlock</span><span class="op" id="5842121">(</span><span class="op" id="5842122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5842125">return</span>&nbsp;<span class="ident" id="5842132">dr</span><span class="op" id="5842134">.</span><span class="ident" id="5842135">resi</span><span class="op" id="5842139">.</span><span class="ident" id="5842140">RowsAffected</span><span class="op" id="5842152">(</span><span class="op" id="5842153">)</span><br>
<span class="lineno"></span><span class="op" id="5842155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span><span class="keyword" id="5842158">func</span>&nbsp;<span class="ident" id="5842163">stack</span><span class="op" id="5842168">(</span><span class="op" id="5842169">)</span>&nbsp;<span class="builtintype" id="5842171">string</span>&nbsp;<span class="op" id="5842178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5842181">var</span>&nbsp;<span class="ident" id="5842185">buf</span>&nbsp;<span class="op" id="5842189">[</span><span class="num" id="5842190">2</span>&nbsp;<span class="op" id="5842192">&lt;&lt;</span>&nbsp;<span class="num" id="5842195">10</span><span class="op" id="5842197">]</span><span class="builtintype" id="5842198">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5842204">return</span>&nbsp;<span class="builtintype" id="5842211">string</span><span class="op" id="5842217">(</span><span class="ident" id="5842218">buf</span><span class="op" id="5842221">[</span><span class="op" id="5842222">:</span><span class="ident" id="5842223">runtime</span><span class="op" id="5842230">.</span><span class="ident" id="5842231">Stack</span><span class="op" id="5842236">(</span><span class="ident" id="5842237">buf</span><span class="op" id="5842240">[</span><span class="op" id="5842241">:</span><span class="op" id="5842242">]</span><span class="op" id="5842243">,</span>&nbsp;<span class="builtintype" id="5842245">false</span><span class="op" id="5842250">)</span><span class="op" id="5842251">]</span><span class="op" id="5842252">)</span><br>
<span class="lineno"></span><span class="op" id="5842254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1765</span><span class="comment" id="5842257">//&nbsp;withLock&nbsp;runs&nbsp;while&nbsp;holding&nbsp;lk.</span><br>
<span class="lineno"></span><span class="keyword" id="5842292">func</span>&nbsp;<span class="ident" id="5842297">withLock</span><span class="op" id="5842305">(</span><span class="ident" id="5842306">lk</span>&nbsp;<span class="ident" id="5842309">sync</span><span class="op" id="5842313">.</span><span class="ident" id="5842314">Locker</span><span class="op" id="5842320">,</span>&nbsp;<span class="ident" id="5842322">fn</span>&nbsp;<span class="keyword" id="5842325">func</span><span class="op" id="5842329">(</span><span class="op" id="5842330">)</span><span class="op" id="5842331">)</span>&nbsp;<span class="op" id="5842333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5842336">lk</span><span class="op" id="5842338">.</span><span class="ident" id="5842339">Lock</span><span class="op" id="5842343">(</span><span class="op" id="5842344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5842347">fn</span><span class="op" id="5842349">(</span><span class="op" id="5842350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5842353">lk</span><span class="op" id="5842355">.</span><span class="ident" id="5842356">Unlock</span><span class="op" id="5842362">(</span><span class="op" id="5842363">)</span><br>
<span class="lineno">1770</span><span class="op" id="5842365">}</span>
</div>
</body>
</html>
