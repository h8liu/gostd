<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html" class="current">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1675310">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1675365">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1675419">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1675470">package</span>&nbsp;<span class="ident" id="1675478">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1675487">import</span>&nbsp;<span class="string" id="1675494">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1675504">//&nbsp;The&nbsp;code&nbsp;in&nbsp;this&nbsp;file&nbsp;implements&nbsp;stack&nbsp;trace&nbsp;walking&nbsp;for&nbsp;all&nbsp;architectures.</span><br>
<span class="lineno">10</span><span class="comment" id="1675583">//&nbsp;The&nbsp;most&nbsp;important&nbsp;fact&nbsp;about&nbsp;a&nbsp;given&nbsp;architecture&nbsp;is&nbsp;whether&nbsp;it&nbsp;uses&nbsp;a&nbsp;link&nbsp;register.</span><br>
<span class="lineno"></span><span class="comment" id="1675673">//&nbsp;On&nbsp;systems&nbsp;with&nbsp;link&nbsp;registers,&nbsp;the&nbsp;prologue&nbsp;for&nbsp;a&nbsp;non-leaf&nbsp;function&nbsp;stores&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1675756">//&nbsp;incoming&nbsp;value&nbsp;of&nbsp;LR&nbsp;at&nbsp;the&nbsp;bottom&nbsp;of&nbsp;the&nbsp;newly&nbsp;allocated&nbsp;stack&nbsp;frame.</span><br>
<span class="lineno"></span><span class="comment" id="1675830">//&nbsp;On&nbsp;systems&nbsp;without&nbsp;link&nbsp;registers,&nbsp;the&nbsp;architecture&nbsp;pushes&nbsp;a&nbsp;return&nbsp;PC&nbsp;during</span><br>
<span class="lineno"></span><span class="comment" id="1675911">//&nbsp;the&nbsp;call&nbsp;instruction,&nbsp;so&nbsp;the&nbsp;return&nbsp;PC&nbsp;ends&nbsp;up&nbsp;above&nbsp;the&nbsp;stack&nbsp;frame.</span><br>
<span class="lineno">15</span><span class="comment" id="1675984">//&nbsp;In&nbsp;this&nbsp;file,&nbsp;the&nbsp;return&nbsp;PC&nbsp;is&nbsp;always&nbsp;called&nbsp;LR,&nbsp;no&nbsp;matter&nbsp;how&nbsp;it&nbsp;was&nbsp;found.</span><br>
<span class="lineno"></span><span class="comment" id="1676064">//</span><br>
<span class="lineno"></span><span class="comment" id="1676067">//&nbsp;To&nbsp;date,&nbsp;the&nbsp;opposite&nbsp;of&nbsp;a&nbsp;link&nbsp;register&nbsp;architecture&nbsp;is&nbsp;an&nbsp;x86&nbsp;architecture.</span><br>
<span class="lineno"></span><span class="comment" id="1676148">//&nbsp;This&nbsp;code&nbsp;may&nbsp;need&nbsp;to&nbsp;change&nbsp;if&nbsp;some&nbsp;other&nbsp;kind&nbsp;of&nbsp;non-link-register</span><br>
<span class="lineno"></span><span class="comment" id="1676220">//&nbsp;architecture&nbsp;comes&nbsp;along.</span><br>
<span class="lineno">20</span><span class="comment" id="1676249">//</span><br>
<span class="lineno"></span><span class="comment" id="1676252">//&nbsp;The&nbsp;other&nbsp;important&nbsp;fact&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;pointer:&nbsp;on&nbsp;32-bit&nbsp;systems&nbsp;the&nbsp;LR</span><br>
<span class="lineno"></span><span class="comment" id="1676331">//&nbsp;takes&nbsp;up&nbsp;only&nbsp;4&nbsp;bytes&nbsp;on&nbsp;the&nbsp;stack,&nbsp;while&nbsp;on&nbsp;64-bit&nbsp;systems&nbsp;it&nbsp;takes&nbsp;up&nbsp;8&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="1676415">//&nbsp;Typically&nbsp;this&nbsp;is&nbsp;ptrSize.</span><br>
<span class="lineno"></span><span class="comment" id="1676445">//</span><br>
<span class="lineno">25</span><span class="comment" id="1676448">//&nbsp;As&nbsp;an&nbsp;exception,&nbsp;amd64p32&nbsp;has&nbsp;ptrSize&nbsp;==&nbsp;4&nbsp;but&nbsp;the&nbsp;CALL&nbsp;instruction&nbsp;still</span><br>
<span class="lineno"></span><span class="comment" id="1676525">//&nbsp;stores&nbsp;an&nbsp;8-byte&nbsp;return&nbsp;PC&nbsp;onto&nbsp;the&nbsp;stack.&nbsp;To&nbsp;accommodate&nbsp;this,&nbsp;we&nbsp;use&nbsp;regSize</span><br>
<span class="lineno"></span><span class="comment" id="1676607">//&nbsp;as&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;architecture-pushed&nbsp;return&nbsp;PC.</span><br>
<span class="lineno"></span><span class="comment" id="1676660">//</span><br>
<span class="lineno"></span><span class="comment" id="1676663">//&nbsp;usesLR&nbsp;is&nbsp;defined&nbsp;below.&nbsp;ptrSize&nbsp;and&nbsp;regSize&nbsp;are&nbsp;defined&nbsp;in&nbsp;stubs.go.</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="1676737">const</span>&nbsp;<span class="ident" id="1676743">usesLR</span>&nbsp;<span class="op" id="1676750">=</span>&nbsp;<span class="ident" id="1676752">GOARCH</span>&nbsp;<span class="op" id="1676759">!=</span>&nbsp;<span class="string" id="1676762">&#34;amd64&#34;</span>&nbsp;<span class="op" id="1676770">&amp;&amp;</span>&nbsp;<span class="ident" id="1676773">GOARCH</span>&nbsp;<span class="op" id="1676780">!=</span>&nbsp;<span class="string" id="1676783">&#34;amd64p32&#34;</span>&nbsp;<span class="op" id="1676794">&amp;&amp;</span>&nbsp;<span class="ident" id="1676797">GOARCH</span>&nbsp;<span class="op" id="1676804">!=</span>&nbsp;<span class="string" id="1676807">&#34;386&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1676814">var</span>&nbsp;<span class="op" id="1676818">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1676821">//&nbsp;initialized&nbsp;in&nbsp;tracebackinit</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1676854">deferprocPC</span>&nbsp;<span class="builtintype" id="1676866">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1676875">goexitPC</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1676887">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1676896">jmpdeferPC</span>&nbsp;&nbsp;<span class="builtintype" id="1676908">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1676917">mcallPC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1676929">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1676938">morestackPC</span>&nbsp;<span class="builtintype" id="1676950">uintptr</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1676959">mstartPC</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1676971">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1676980">newprocPC</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1676992">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1677001">rt0_goPC</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1677013">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1677022">sigpanicPC</span>&nbsp;&nbsp;<span class="builtintype" id="1677034">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1677044">externalthreadhandlerp</span>&nbsp;<span class="builtintype" id="1677067">uintptr</span>&nbsp;<span class="comment" id="1677075">//&nbsp;initialized&nbsp;elsewhere</span><br>
<span class="lineno"></span><span class="op" id="1677100">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1677103">func</span>&nbsp;<span class="ident" id="1677108">tracebackinit</span><span class="op" id="1677121">(</span><span class="op" id="1677122">)</span>&nbsp;<span class="op" id="1677124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1677127">//&nbsp;Go&nbsp;variable&nbsp;initialization&nbsp;happens&nbsp;late&nbsp;during&nbsp;runtime&nbsp;startup.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1677195">//&nbsp;Instead&nbsp;of&nbsp;initializing&nbsp;the&nbsp;variables&nbsp;above&nbsp;in&nbsp;the&nbsp;declarations,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1677264">//&nbsp;schedinit&nbsp;calls&nbsp;this&nbsp;function&nbsp;so&nbsp;that&nbsp;the&nbsp;variables&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1677324">//&nbsp;initialized&nbsp;and&nbsp;available&nbsp;earlier&nbsp;in&nbsp;the&nbsp;startup&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1677387">deferprocPC</span>&nbsp;<span class="op" id="1677399">=</span>&nbsp;<span class="ident" id="1677401">funcPC</span><span class="op" id="1677407">(</span><span class="ident" id="1677408">deferproc</span><span class="op" id="1677417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1677420">goexitPC</span>&nbsp;<span class="op" id="1677429">=</span>&nbsp;<span class="ident" id="1677431">funcPC</span><span class="op" id="1677437">(</span><span class="ident" id="1677438">goexit</span><span class="op" id="1677444">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1677447">jmpdeferPC</span>&nbsp;<span class="op" id="1677458">=</span>&nbsp;<span class="ident" id="1677460">funcPC</span><span class="op" id="1677466">(</span><span class="ident" id="1677467">jmpdefer</span><span class="op" id="1677475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1677478">mcallPC</span>&nbsp;<span class="op" id="1677486">=</span>&nbsp;<span class="ident" id="1677488">funcPC</span><span class="op" id="1677494">(</span><span class="ident" id="1677495">mcall</span><span class="op" id="1677500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1677503">morestackPC</span>&nbsp;<span class="op" id="1677515">=</span>&nbsp;<span class="ident" id="1677517">funcPC</span><span class="op" id="1677523">(</span><span class="ident" id="1677524">morestack</span><span class="op" id="1677533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1677536">mstartPC</span>&nbsp;<span class="op" id="1677545">=</span>&nbsp;<span class="ident" id="1677547">funcPC</span><span class="op" id="1677553">(</span><span class="ident" id="1677554">mstart</span><span class="op" id="1677560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1677563">newprocPC</span>&nbsp;<span class="op" id="1677573">=</span>&nbsp;<span class="ident" id="1677575">funcPC</span><span class="op" id="1677581">(</span><span class="ident" id="1677582">newproc</span><span class="op" id="1677589">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1677592">rt0_goPC</span>&nbsp;<span class="op" id="1677601">=</span>&nbsp;<span class="ident" id="1677603">funcPC</span><span class="op" id="1677609">(</span><span class="ident" id="1677610">rt0_go</span><span class="op" id="1677616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1677619">sigpanicPC</span>&nbsp;<span class="op" id="1677630">=</span>&nbsp;<span class="ident" id="1677632">funcPC</span><span class="op" id="1677638">(</span><span class="ident" id="1677639">sigpanic</span><span class="op" id="1677647">)</span><br>
<span class="lineno"></span><span class="op" id="1677649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1677652">//&nbsp;Traceback&nbsp;over&nbsp;the&nbsp;deferred&nbsp;function&nbsp;calls.</span><br>
<span class="lineno">65</span><span class="comment" id="1677699">//&nbsp;Report&nbsp;them&nbsp;like&nbsp;calls&nbsp;that&nbsp;have&nbsp;been&nbsp;invoked&nbsp;but&nbsp;not&nbsp;started&nbsp;executing&nbsp;yet.</span><br>
<span class="lineno"></span><span class="keyword" id="1677779">func</span>&nbsp;<span class="ident" id="1677784">tracebackdefers</span><span class="op" id="1677799">(</span><span class="ident" id="1677800">gp</span>&nbsp;<span class="op" id="1677803">*</span><span class="ident" id="1677804">g</span><span class="op" id="1677805">,</span>&nbsp;<span class="ident" id="1677807">callback</span>&nbsp;<span class="keyword" id="1677816">func</span><span class="op" id="1677820">(</span><span class="op" id="1677821">*</span><span class="ident" id="1677822">stkframe</span><span class="op" id="1677830">,</span>&nbsp;<span class="ident" id="1677832">unsafe</span><span class="op" id="1677838">.</span><span class="ident" id="1677839">Pointer</span><span class="op" id="1677846">)</span>&nbsp;<span class="builtintype" id="1677848">bool</span><span class="op" id="1677852">,</span>&nbsp;<span class="ident" id="1677854">v</span>&nbsp;<span class="ident" id="1677856">unsafe</span><span class="op" id="1677862">.</span><span class="ident" id="1677863">Pointer</span><span class="op" id="1677870">)</span>&nbsp;<span class="op" id="1677872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1677875">var</span>&nbsp;<span class="ident" id="1677879">frame</span>&nbsp;<span class="ident" id="1677885">stkframe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1677895">for</span>&nbsp;<span class="ident" id="1677899">d</span>&nbsp;<span class="op" id="1677901">:=</span>&nbsp;<span class="ident" id="1677904">gp</span><span class="op" id="1677906">.</span><span class="ident" id="1677907">_defer</span><span class="op" id="1677913">;</span>&nbsp;<span class="ident" id="1677915">d</span>&nbsp;<span class="op" id="1677917">!=</span>&nbsp;<span class="builtintype" id="1677920">nil</span><span class="op" id="1677923">;</span>&nbsp;<span class="ident" id="1677925">d</span>&nbsp;<span class="op" id="1677927">=</span>&nbsp;<span class="ident" id="1677929">d</span><span class="op" id="1677930">.</span><span class="ident" id="1677931">link</span>&nbsp;<span class="op" id="1677936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1677940">fn</span>&nbsp;<span class="op" id="1677943">:=</span>&nbsp;<span class="ident" id="1677946">d</span><span class="op" id="1677947">.</span><span class="ident" id="1677948">fn</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1677953">if</span>&nbsp;<span class="ident" id="1677956">fn</span>&nbsp;<span class="op" id="1677959">==</span>&nbsp;<span class="builtintype" id="1677962">nil</span>&nbsp;<span class="op" id="1677966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1677971">//&nbsp;Defer&nbsp;of&nbsp;nil&nbsp;function.&nbsp;Args&nbsp;don&#39;t&nbsp;matter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1678019">frame</span><span class="op" id="1678024">.</span><span class="ident" id="1678025">pc</span>&nbsp;<span class="op" id="1678028">=</span>&nbsp;<span class="num" id="1678030">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1678035">frame</span><span class="op" id="1678040">.</span><span class="ident" id="1678041">fn</span>&nbsp;<span class="op" id="1678044">=</span>&nbsp;<span class="builtintype" id="1678046">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1678053">frame</span><span class="op" id="1678058">.</span><span class="ident" id="1678059">argp</span>&nbsp;<span class="op" id="1678064">=</span>&nbsp;<span class="num" id="1678066">0</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1678071">frame</span><span class="op" id="1678076">.</span><span class="ident" id="1678077">arglen</span>&nbsp;<span class="op" id="1678084">=</span>&nbsp;<span class="num" id="1678086">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1678091">frame</span><span class="op" id="1678096">.</span><span class="ident" id="1678097">argmap</span>&nbsp;<span class="op" id="1678104">=</span>&nbsp;<span class="builtintype" id="1678106">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1678112">}</span>&nbsp;<span class="keyword" id="1678114">else</span>&nbsp;<span class="op" id="1678119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1678124">frame</span><span class="op" id="1678129">.</span><span class="ident" id="1678130">pc</span>&nbsp;<span class="op" id="1678133">=</span>&nbsp;<span class="builtintype" id="1678135">uintptr</span><span class="op" id="1678142">(</span><span class="ident" id="1678143">fn</span><span class="op" id="1678145">.</span><span class="ident" id="1678146">fn</span><span class="op" id="1678148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1678153">f</span>&nbsp;<span class="op" id="1678155">:=</span>&nbsp;<span class="ident" id="1678158">findfunc</span><span class="op" id="1678166">(</span><span class="ident" id="1678167">frame</span><span class="op" id="1678172">.</span><span class="ident" id="1678173">pc</span><span class="op" id="1678175">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1678180">if</span>&nbsp;<span class="ident" id="1678183">f</span>&nbsp;<span class="op" id="1678185">==</span>&nbsp;<span class="builtintype" id="1678188">nil</span>&nbsp;<span class="op" id="1678192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1678198">print</span><span class="op" id="1678203">(</span><span class="string" id="1678204">&#34;runtime:&nbsp;unknown&nbsp;pc&nbsp;in&nbsp;defer&nbsp;&#34;</span><span class="op" id="1678235">,</span>&nbsp;<span class="ident" id="1678237">hex</span><span class="op" id="1678240">(</span><span class="ident" id="1678241">frame</span><span class="op" id="1678246">.</span><span class="ident" id="1678247">pc</span><span class="op" id="1678249">)</span><span class="op" id="1678250">,</span>&nbsp;<span class="string" id="1678252">&#34;\n&#34;</span><span class="op" id="1678256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1678262">gothrow</span><span class="op" id="1678269">(</span><span class="string" id="1678270">&#34;unknown&nbsp;pc&#34;</span><span class="op" id="1678282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1678287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1678292">frame</span><span class="op" id="1678297">.</span><span class="ident" id="1678298">fn</span>&nbsp;<span class="op" id="1678301">=</span>&nbsp;<span class="ident" id="1678303">f</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1678308">frame</span><span class="op" id="1678313">.</span><span class="ident" id="1678314">argp</span>&nbsp;<span class="op" id="1678319">=</span>&nbsp;<span class="builtintype" id="1678321">uintptr</span><span class="op" id="1678328">(</span><span class="ident" id="1678329">deferArgs</span><span class="op" id="1678338">(</span><span class="ident" id="1678339">d</span><span class="op" id="1678340">)</span><span class="op" id="1678341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1678346">setArgInfo</span><span class="op" id="1678356">(</span><span class="op" id="1678357">&amp;</span><span class="ident" id="1678358">frame</span><span class="op" id="1678363">,</span>&nbsp;<span class="ident" id="1678365">f</span><span class="op" id="1678366">,</span>&nbsp;<span class="builtintype" id="1678368">true</span><span class="op" id="1678372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1678376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1678380">frame</span><span class="op" id="1678385">.</span><span class="ident" id="1678386">continpc</span>&nbsp;<span class="op" id="1678395">=</span>&nbsp;<span class="ident" id="1678397">frame</span><span class="op" id="1678402">.</span><span class="ident" id="1678403">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1678408">if</span>&nbsp;<span class="op" id="1678411">!</span><span class="ident" id="1678412">callback</span><span class="op" id="1678420">(</span><span class="op" id="1678421">(</span><span class="op" id="1678422">*</span><span class="ident" id="1678423">stkframe</span><span class="op" id="1678431">)</span><span class="op" id="1678432">(</span><span class="ident" id="1678433">noescape</span><span class="op" id="1678441">(</span><span class="ident" id="1678442">unsafe</span><span class="op" id="1678448">.</span><span class="ident" id="1678449">Pointer</span><span class="op" id="1678456">(</span><span class="op" id="1678457">&amp;</span><span class="ident" id="1678458">frame</span><span class="op" id="1678463">)</span><span class="op" id="1678464">)</span><span class="op" id="1678465">)</span><span class="op" id="1678466">,</span>&nbsp;<span class="ident" id="1678468">v</span><span class="op" id="1678469">)</span>&nbsp;<span class="op" id="1678471">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1678476">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1678485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1678488">}</span><br>
<span class="lineno"></span><span class="op" id="1678490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="1678493">//&nbsp;Generic&nbsp;traceback.&nbsp;&nbsp;Handles&nbsp;runtime&nbsp;stack&nbsp;prints&nbsp;(pcbuf&nbsp;==&nbsp;nil),</span><br>
<span class="lineno"></span><span class="comment" id="1678561">//&nbsp;the&nbsp;runtime.Callers&nbsp;function&nbsp;(pcbuf&nbsp;!=&nbsp;nil),&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;garbage</span><br>
<span class="lineno"></span><span class="comment" id="1678632">//&nbsp;collector&nbsp;(callback&nbsp;!=&nbsp;nil).&nbsp;&nbsp;A&nbsp;little&nbsp;clunky&nbsp;to&nbsp;merge&nbsp;these,&nbsp;but&nbsp;avoids</span><br>
<span class="lineno"></span><span class="comment" id="1678708">//&nbsp;duplicating&nbsp;the&nbsp;code&nbsp;and&nbsp;all&nbsp;its&nbsp;subtlety.</span><br>
<span class="lineno"></span><span class="keyword" id="1678754">func</span>&nbsp;<span class="ident" id="1678759">gentraceback</span><span class="op" id="1678771">(</span><span class="ident" id="1678772">pc0</span>&nbsp;<span class="builtintype" id="1678776">uintptr</span><span class="op" id="1678783">,</span>&nbsp;<span class="ident" id="1678785">sp0</span>&nbsp;<span class="builtintype" id="1678789">uintptr</span><span class="op" id="1678796">,</span>&nbsp;<span class="ident" id="1678798">lr0</span>&nbsp;<span class="builtintype" id="1678802">uintptr</span><span class="op" id="1678809">,</span>&nbsp;<span class="ident" id="1678811">gp</span>&nbsp;<span class="op" id="1678814">*</span><span class="ident" id="1678815">g</span><span class="op" id="1678816">,</span>&nbsp;<span class="ident" id="1678818">skip</span>&nbsp;<span class="builtintype" id="1678823">int</span><span class="op" id="1678826">,</span>&nbsp;<span class="ident" id="1678828">pcbuf</span>&nbsp;<span class="op" id="1678834">*</span><span class="builtintype" id="1678835">uintptr</span><span class="op" id="1678842">,</span>&nbsp;<span class="ident" id="1678844">max</span>&nbsp;<span class="builtintype" id="1678848">int</span><span class="op" id="1678851">,</span>&nbsp;<span class="ident" id="1678853">callback</span>&nbsp;<span class="keyword" id="1678862">func</span><span class="op" id="1678866">(</span><span class="op" id="1678867">*</span><span class="ident" id="1678868">stkframe</span><span class="op" id="1678876">,</span>&nbsp;<span class="ident" id="1678878">unsafe</span><span class="op" id="1678884">.</span><span class="ident" id="1678885">Pointer</span><span class="op" id="1678892">)</span>&nbsp;<span class="builtintype" id="1678894">bool</span><span class="op" id="1678898">,</span>&nbsp;<span class="ident" id="1678900">v</span>&nbsp;<span class="ident" id="1678902">unsafe</span><span class="op" id="1678908">.</span><span class="ident" id="1678909">Pointer</span><span class="op" id="1678916">,</span>&nbsp;<span class="ident" id="1678918">flags</span>&nbsp;<span class="builtintype" id="1678924">uint</span><span class="op" id="1678928">)</span>&nbsp;<span class="builtintype" id="1678930">int</span>&nbsp;<span class="op" id="1678934">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1678937">if</span>&nbsp;<span class="ident" id="1678940">goexitPC</span>&nbsp;<span class="op" id="1678949">==</span>&nbsp;<span class="num" id="1678952">0</span>&nbsp;<span class="op" id="1678954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1678958">gothrow</span><span class="op" id="1678965">(</span><span class="string" id="1678966">&#34;gentraceback&nbsp;before&nbsp;goexitPC&nbsp;initialization&#34;</span><span class="op" id="1679011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1679014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1679017">g</span>&nbsp;<span class="op" id="1679019">:=</span>&nbsp;<span class="ident" id="1679022">getg</span><span class="op" id="1679026">(</span><span class="op" id="1679027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1679030">if</span>&nbsp;<span class="ident" id="1679033">g</span>&nbsp;<span class="op" id="1679035">==</span>&nbsp;<span class="ident" id="1679038">gp</span>&nbsp;<span class="op" id="1679041">&amp;&amp;</span>&nbsp;<span class="ident" id="1679044">g</span>&nbsp;<span class="op" id="1679046">==</span>&nbsp;<span class="ident" id="1679049">g</span><span class="op" id="1679050">.</span><span class="ident" id="1679051">m</span><span class="op" id="1679052">.</span><span class="ident" id="1679053">curg</span>&nbsp;<span class="op" id="1679058">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1679062">//&nbsp;The&nbsp;starting&nbsp;sp&nbsp;has&nbsp;been&nbsp;passed&nbsp;in&nbsp;as&nbsp;a&nbsp;uintptr,&nbsp;and&nbsp;the&nbsp;caller&nbsp;may</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1679135">//&nbsp;have&nbsp;other&nbsp;uintptr-typed&nbsp;stack&nbsp;references&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1679191">//&nbsp;If&nbsp;during&nbsp;one&nbsp;of&nbsp;the&nbsp;calls&nbsp;that&nbsp;got&nbsp;us&nbsp;here&nbsp;or&nbsp;during&nbsp;one&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1679261">//&nbsp;callbacks&nbsp;below&nbsp;the&nbsp;stack&nbsp;must&nbsp;be&nbsp;grown,&nbsp;all&nbsp;these&nbsp;uintptr&nbsp;references</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1679336">//&nbsp;to&nbsp;the&nbsp;stack&nbsp;will&nbsp;not&nbsp;be&nbsp;updated,&nbsp;and&nbsp;gentraceback&nbsp;will&nbsp;continue</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1679406">//&nbsp;to&nbsp;inspect&nbsp;the&nbsp;old&nbsp;stack&nbsp;memory,&nbsp;which&nbsp;may&nbsp;no&nbsp;longer&nbsp;be&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1679474">//&nbsp;Even&nbsp;if&nbsp;all&nbsp;the&nbsp;variables&nbsp;were&nbsp;updated&nbsp;correctly,&nbsp;it&nbsp;is&nbsp;not&nbsp;clear&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1679550">//&nbsp;we&nbsp;want&nbsp;to&nbsp;expose&nbsp;a&nbsp;traceback&nbsp;that&nbsp;begins&nbsp;on&nbsp;one&nbsp;stack&nbsp;and&nbsp;ends</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1679619">//&nbsp;on&nbsp;another&nbsp;stack.&nbsp;That&nbsp;could&nbsp;confuse&nbsp;callers&nbsp;quite&nbsp;a&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1679682">//&nbsp;Instead,&nbsp;we&nbsp;require&nbsp;that&nbsp;gentraceback&nbsp;and&nbsp;any&nbsp;other&nbsp;function&nbsp;that</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1679753">//&nbsp;accepts&nbsp;an&nbsp;sp&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;(typically&nbsp;obtained&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1679821">//&nbsp;calling&nbsp;getcallersp)&nbsp;must&nbsp;not&nbsp;run&nbsp;on&nbsp;that&nbsp;goroutine&#39;s&nbsp;stack&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1679890">//&nbsp;instead&nbsp;on&nbsp;the&nbsp;g0&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1679920">gothrow</span><span class="op" id="1679927">(</span><span class="string" id="1679928">&#34;gentraceback&nbsp;cannot&nbsp;trace&nbsp;user&nbsp;goroutine&nbsp;on&nbsp;its&nbsp;own&nbsp;stack&#34;</span><span class="op" id="1679987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1679990">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1679993">gotraceback</span>&nbsp;<span class="op" id="1680005">:=</span>&nbsp;<span class="ident" id="1680008">gotraceback</span><span class="op" id="1680019">(</span><span class="builtintype" id="1680020">nil</span><span class="op" id="1680023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1680026">if</span>&nbsp;<span class="ident" id="1680029">pc0</span>&nbsp;<span class="op" id="1680033">==</span>&nbsp;<span class="op" id="1680036">^</span><span class="builtintype" id="1680037">uintptr</span><span class="op" id="1680044">(</span><span class="num" id="1680045">0</span><span class="op" id="1680046">)</span>&nbsp;<span class="op" id="1680048">&amp;&amp;</span>&nbsp;<span class="ident" id="1680051">sp0</span>&nbsp;<span class="op" id="1680055">==</span>&nbsp;<span class="op" id="1680058">^</span><span class="builtintype" id="1680059">uintptr</span><span class="op" id="1680066">(</span><span class="num" id="1680067">0</span><span class="op" id="1680068">)</span>&nbsp;<span class="op" id="1680070">{</span>&nbsp;<span class="comment" id="1680072">//&nbsp;Signal&nbsp;to&nbsp;fetch&nbsp;saved&nbsp;values&nbsp;from&nbsp;gp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1680115">if</span>&nbsp;<span class="ident" id="1680118">gp</span><span class="op" id="1680120">.</span><span class="ident" id="1680121">syscallsp</span>&nbsp;<span class="op" id="1680131">!=</span>&nbsp;<span class="num" id="1680134">0</span>&nbsp;<span class="op" id="1680136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680141">pc0</span>&nbsp;<span class="op" id="1680145">=</span>&nbsp;<span class="ident" id="1680147">gp</span><span class="op" id="1680149">.</span><span class="ident" id="1680150">syscallpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680163">sp0</span>&nbsp;<span class="op" id="1680167">=</span>&nbsp;<span class="ident" id="1680169">gp</span><span class="op" id="1680171">.</span><span class="ident" id="1680172">syscallsp</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1680185">if</span>&nbsp;<span class="ident" id="1680188">usesLR</span>&nbsp;<span class="op" id="1680195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680201">lr0</span>&nbsp;<span class="op" id="1680205">=</span>&nbsp;<span class="num" id="1680207">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1680212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1680216">}</span>&nbsp;<span class="keyword" id="1680218">else</span>&nbsp;<span class="op" id="1680223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680228">pc0</span>&nbsp;<span class="op" id="1680232">=</span>&nbsp;<span class="ident" id="1680234">gp</span><span class="op" id="1680236">.</span><span class="ident" id="1680237">sched</span><span class="op" id="1680242">.</span><span class="ident" id="1680243">pc</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680249">sp0</span>&nbsp;<span class="op" id="1680253">=</span>&nbsp;<span class="ident" id="1680255">gp</span><span class="op" id="1680257">.</span><span class="ident" id="1680258">sched</span><span class="op" id="1680263">.</span><span class="ident" id="1680264">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1680270">if</span>&nbsp;<span class="ident" id="1680273">usesLR</span>&nbsp;<span class="op" id="1680280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680286">lr0</span>&nbsp;<span class="op" id="1680290">=</span>&nbsp;<span class="ident" id="1680292">gp</span><span class="op" id="1680294">.</span><span class="ident" id="1680295">sched</span><span class="op" id="1680300">.</span><span class="ident" id="1680301">lr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1680307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1680311">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1680314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680318">nprint</span>&nbsp;<span class="op" id="1680325">:=</span>&nbsp;<span class="num" id="1680328">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1680331">var</span>&nbsp;<span class="ident" id="1680335">frame</span>&nbsp;<span class="ident" id="1680341">stkframe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680351">frame</span><span class="op" id="1680356">.</span><span class="ident" id="1680357">pc</span>&nbsp;<span class="op" id="1680360">=</span>&nbsp;<span class="ident" id="1680362">pc0</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680367">frame</span><span class="op" id="1680372">.</span><span class="ident" id="1680373">sp</span>&nbsp;<span class="op" id="1680376">=</span>&nbsp;<span class="ident" id="1680378">sp0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1680383">if</span>&nbsp;<span class="ident" id="1680386">usesLR</span>&nbsp;<span class="op" id="1680393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680397">frame</span><span class="op" id="1680402">.</span><span class="ident" id="1680403">lr</span>&nbsp;<span class="op" id="1680406">=</span>&nbsp;<span class="ident" id="1680408">lr0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1680413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680416">waspanic</span>&nbsp;<span class="op" id="1680425">:=</span>&nbsp;<span class="builtintype" id="1680428">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680435">wasnewproc</span>&nbsp;<span class="op" id="1680446">:=</span>&nbsp;<span class="builtintype" id="1680449">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680456">printing</span>&nbsp;<span class="op" id="1680465">:=</span>&nbsp;<span class="ident" id="1680468">pcbuf</span>&nbsp;<span class="op" id="1680474">==</span>&nbsp;<span class="builtintype" id="1680477">nil</span>&nbsp;<span class="op" id="1680481">&amp;&amp;</span>&nbsp;<span class="ident" id="1680484">callback</span>&nbsp;<span class="op" id="1680493">==</span>&nbsp;<span class="builtintype" id="1680496">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680501">_defer</span>&nbsp;<span class="op" id="1680508">:=</span>&nbsp;<span class="ident" id="1680511">gp</span><span class="op" id="1680513">.</span><span class="ident" id="1680514">_defer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1680523">for</span>&nbsp;<span class="ident" id="1680527">_defer</span>&nbsp;<span class="op" id="1680534">!=</span>&nbsp;<span class="builtintype" id="1680537">nil</span>&nbsp;<span class="op" id="1680541">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1680544">uintptr</span><span class="op" id="1680551">(</span><span class="ident" id="1680552">_defer</span><span class="op" id="1680558">.</span><span class="ident" id="1680559">argp</span><span class="op" id="1680563">)</span>&nbsp;<span class="op" id="1680565">==</span>&nbsp;<span class="ident" id="1680568">_NoArgs</span>&nbsp;<span class="op" id="1680576">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680580">_defer</span>&nbsp;<span class="op" id="1680587">=</span>&nbsp;<span class="ident" id="1680589">_defer</span><span class="op" id="1680595">.</span><span class="ident" id="1680596">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1680602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1680606">//&nbsp;If&nbsp;the&nbsp;PC&nbsp;is&nbsp;zero,&nbsp;it&#39;s&nbsp;likely&nbsp;a&nbsp;nil&nbsp;function&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1680662">//&nbsp;Start&nbsp;in&nbsp;the&nbsp;caller&#39;s&nbsp;frame.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1680695">if</span>&nbsp;<span class="ident" id="1680698">frame</span><span class="op" id="1680703">.</span><span class="ident" id="1680704">pc</span>&nbsp;<span class="op" id="1680707">==</span>&nbsp;<span class="num" id="1680710">0</span>&nbsp;<span class="op" id="1680712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1680716">if</span>&nbsp;<span class="ident" id="1680719">usesLR</span>&nbsp;<span class="op" id="1680726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680731">frame</span><span class="op" id="1680736">.</span><span class="ident" id="1680737">pc</span>&nbsp;<span class="op" id="1680740">=</span>&nbsp;<span class="op" id="1680742">*</span><span class="op" id="1680743">(</span><span class="op" id="1680744">*</span><span class="builtintype" id="1680745">uintptr</span><span class="op" id="1680752">)</span><span class="op" id="1680753">(</span><span class="ident" id="1680754">unsafe</span><span class="op" id="1680760">.</span><span class="ident" id="1680761">Pointer</span><span class="op" id="1680768">(</span><span class="ident" id="1680769">frame</span><span class="op" id="1680774">.</span><span class="ident" id="1680775">sp</span><span class="op" id="1680777">)</span><span class="op" id="1680778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680783">frame</span><span class="op" id="1680788">.</span><span class="ident" id="1680789">lr</span>&nbsp;<span class="op" id="1680792">=</span>&nbsp;<span class="num" id="1680794">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1680798">}</span>&nbsp;<span class="keyword" id="1680800">else</span>&nbsp;<span class="op" id="1680805">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680810">frame</span><span class="op" id="1680815">.</span><span class="ident" id="1680816">pc</span>&nbsp;<span class="op" id="1680819">=</span>&nbsp;<span class="builtintype" id="1680821">uintptr</span><span class="op" id="1680828">(</span><span class="op" id="1680829">*</span><span class="op" id="1680830">(</span><span class="op" id="1680831">*</span><span class="ident" id="1680832">uintreg</span><span class="op" id="1680839">)</span><span class="op" id="1680840">(</span><span class="ident" id="1680841">unsafe</span><span class="op" id="1680847">.</span><span class="ident" id="1680848">Pointer</span><span class="op" id="1680855">(</span><span class="ident" id="1680856">frame</span><span class="op" id="1680861">.</span><span class="ident" id="1680862">sp</span><span class="op" id="1680864">)</span><span class="op" id="1680865">)</span><span class="op" id="1680866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680871">frame</span><span class="op" id="1680876">.</span><span class="ident" id="1680877">sp</span>&nbsp;<span class="op" id="1680880">+=</span>&nbsp;<span class="ident" id="1680883">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1680893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1680896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1680900">f</span>&nbsp;<span class="op" id="1680902">:=</span>&nbsp;<span class="ident" id="1680905">findfunc</span><span class="op" id="1680913">(</span><span class="ident" id="1680914">frame</span><span class="op" id="1680919">.</span><span class="ident" id="1680920">pc</span><span class="op" id="1680922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1680925">if</span>&nbsp;<span class="ident" id="1680928">f</span>&nbsp;<span class="op" id="1680930">==</span>&nbsp;<span class="builtintype" id="1680933">nil</span>&nbsp;<span class="op" id="1680937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1680941">if</span>&nbsp;<span class="ident" id="1680944">callback</span>&nbsp;<span class="op" id="1680953">!=</span>&nbsp;<span class="builtintype" id="1680956">nil</span>&nbsp;<span class="op" id="1680960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1680965">print</span><span class="op" id="1680970">(</span><span class="string" id="1680971">&#34;runtime:&nbsp;unknown&nbsp;pc&nbsp;&#34;</span><span class="op" id="1680993">,</span>&nbsp;<span class="ident" id="1680995">hex</span><span class="op" id="1680998">(</span><span class="ident" id="1680999">frame</span><span class="op" id="1681004">.</span><span class="ident" id="1681005">pc</span><span class="op" id="1681007">)</span><span class="op" id="1681008">,</span>&nbsp;<span class="string" id="1681010">&#34;\n&#34;</span><span class="op" id="1681014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1681019">gothrow</span><span class="op" id="1681026">(</span><span class="string" id="1681027">&#34;unknown&nbsp;pc&#34;</span><span class="op" id="1681039">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1681043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1681047">return</span>&nbsp;<span class="num" id="1681054">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1681057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1681060">frame</span><span class="op" id="1681065">.</span><span class="ident" id="1681066">fn</span>&nbsp;<span class="op" id="1681069">=</span>&nbsp;<span class="ident" id="1681071">f</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1681075">n</span>&nbsp;<span class="op" id="1681077">:=</span>&nbsp;<span class="num" id="1681080">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1681083">for</span>&nbsp;<span class="ident" id="1681087">n</span>&nbsp;<span class="op" id="1681089">&lt;</span>&nbsp;<span class="ident" id="1681091">max</span>&nbsp;<span class="op" id="1681095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1681099">//&nbsp;Typically:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1681115">//&nbsp;&nbsp;&nbsp;&nbsp;pc&nbsp;is&nbsp;the&nbsp;PC&nbsp;of&nbsp;the&nbsp;running&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1681158">//&nbsp;&nbsp;&nbsp;&nbsp;sp&nbsp;is&nbsp;the&nbsp;stack&nbsp;pointer&nbsp;at&nbsp;that&nbsp;program&nbsp;counter.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1681212">//&nbsp;&nbsp;&nbsp;&nbsp;fp&nbsp;is&nbsp;the&nbsp;frame&nbsp;pointer&nbsp;(caller&#39;s&nbsp;stack&nbsp;pointer)&nbsp;at&nbsp;that&nbsp;program&nbsp;counter,&nbsp;or&nbsp;nil&nbsp;if&nbsp;unknown.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1681310">//&nbsp;&nbsp;&nbsp;&nbsp;stk&nbsp;is&nbsp;the&nbsp;stack&nbsp;containing&nbsp;sp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1681347">//&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;caller&#39;s&nbsp;program&nbsp;counter&nbsp;is&nbsp;lr,&nbsp;unless&nbsp;lr&nbsp;is&nbsp;zero,&nbsp;in&nbsp;which&nbsp;case&nbsp;it&nbsp;is&nbsp;*(uintptr*)sp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1681442">f</span>&nbsp;<span class="op" id="1681444">=</span>&nbsp;<span class="ident" id="1681446">frame</span><span class="op" id="1681451">.</span><span class="ident" id="1681452">fn</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1681458">//&nbsp;Found&nbsp;an&nbsp;actual&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1681489">//&nbsp;Derive&nbsp;frame&nbsp;pointer&nbsp;and&nbsp;link&nbsp;register.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1681534">if</span>&nbsp;<span class="ident" id="1681537">frame</span><span class="op" id="1681542">.</span><span class="ident" id="1681543">fp</span>&nbsp;<span class="op" id="1681546">==</span>&nbsp;<span class="num" id="1681549">0</span>&nbsp;<span class="op" id="1681551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1681556">frame</span><span class="op" id="1681561">.</span><span class="ident" id="1681562">fp</span>&nbsp;<span class="op" id="1681565">=</span>&nbsp;<span class="ident" id="1681567">frame</span><span class="op" id="1681572">.</span><span class="ident" id="1681573">sp</span>&nbsp;<span class="op" id="1681576">+</span>&nbsp;<span class="builtintype" id="1681578">uintptr</span><span class="op" id="1681585">(</span><span class="ident" id="1681586">funcspdelta</span><span class="op" id="1681597">(</span><span class="ident" id="1681598">f</span><span class="op" id="1681599">,</span>&nbsp;<span class="ident" id="1681601">frame</span><span class="op" id="1681606">.</span><span class="ident" id="1681607">pc</span><span class="op" id="1681609">)</span><span class="op" id="1681610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1681615">if</span>&nbsp;<span class="op" id="1681618">!</span><span class="ident" id="1681619">usesLR</span>&nbsp;<span class="op" id="1681626">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1681632">//&nbsp;On&nbsp;x86,&nbsp;call&nbsp;instruction&nbsp;pushes&nbsp;return&nbsp;PC&nbsp;before&nbsp;entering&nbsp;new&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1681711">frame</span><span class="op" id="1681716">.</span><span class="ident" id="1681717">fp</span>&nbsp;<span class="op" id="1681720">+=</span>&nbsp;<span class="ident" id="1681723">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1681734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1681738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1681742">var</span>&nbsp;<span class="ident" id="1681746">flr</span>&nbsp;<span class="op" id="1681750">*</span><span class="ident" id="1681751">_func</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1681759">if</span>&nbsp;<span class="ident" id="1681762">topofstack</span><span class="op" id="1681772">(</span><span class="ident" id="1681773">f</span><span class="op" id="1681774">)</span>&nbsp;<span class="op" id="1681776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1681781">frame</span><span class="op" id="1681786">.</span><span class="ident" id="1681787">lr</span>&nbsp;<span class="op" id="1681790">=</span>&nbsp;<span class="num" id="1681792">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1681797">flr</span>&nbsp;<span class="op" id="1681801">=</span>&nbsp;<span class="builtintype" id="1681803">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1681809">}</span>&nbsp;<span class="keyword" id="1681811">else</span>&nbsp;<span class="keyword" id="1681816">if</span>&nbsp;<span class="ident" id="1681819">usesLR</span>&nbsp;<span class="op" id="1681826">&amp;&amp;</span>&nbsp;<span class="ident" id="1681829">f</span><span class="op" id="1681830">.</span><span class="ident" id="1681831">entry</span>&nbsp;<span class="op" id="1681837">==</span>&nbsp;<span class="ident" id="1681840">jmpdeferPC</span>&nbsp;<span class="op" id="1681851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1681856">//&nbsp;jmpdefer&nbsp;modifies&nbsp;SP/LR/PC&nbsp;non-atomically.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1681905">//&nbsp;If&nbsp;a&nbsp;profiling&nbsp;interrupt&nbsp;arrives&nbsp;during&nbsp;jmpdefer,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1681961">//&nbsp;the&nbsp;stack&nbsp;unwind&nbsp;may&nbsp;see&nbsp;a&nbsp;mismatched&nbsp;register&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1682018">//&nbsp;and&nbsp;get&nbsp;confused.&nbsp;Stop&nbsp;if&nbsp;we&nbsp;see&nbsp;PC&nbsp;within&nbsp;jmpdefer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1682076">//&nbsp;to&nbsp;avoid&nbsp;that&nbsp;confusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1682107">//&nbsp;See&nbsp;golang.org/issue/8153.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1682140">if</span>&nbsp;<span class="ident" id="1682143">callback</span>&nbsp;<span class="op" id="1682152">!=</span>&nbsp;<span class="builtintype" id="1682155">nil</span>&nbsp;<span class="op" id="1682159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1682165">gothrow</span><span class="op" id="1682172">(</span><span class="string" id="1682173">&#34;traceback_arm:&nbsp;found&nbsp;jmpdefer&nbsp;when&nbsp;tracing&nbsp;with&nbsp;callback&#34;</span><span class="op" id="1682231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1682236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1682241">frame</span><span class="op" id="1682246">.</span><span class="ident" id="1682247">lr</span>&nbsp;<span class="op" id="1682250">=</span>&nbsp;<span class="num" id="1682252">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1682256">}</span>&nbsp;<span class="keyword" id="1682258">else</span>&nbsp;<span class="op" id="1682263">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1682268">if</span>&nbsp;<span class="ident" id="1682271">usesLR</span>&nbsp;<span class="op" id="1682278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1682284">if</span>&nbsp;<span class="ident" id="1682287">n</span>&nbsp;<span class="op" id="1682289">==</span>&nbsp;<span class="num" id="1682292">0</span>&nbsp;<span class="op" id="1682294">&amp;&amp;</span>&nbsp;<span class="ident" id="1682297">frame</span><span class="op" id="1682302">.</span><span class="ident" id="1682303">sp</span>&nbsp;<span class="op" id="1682306">&lt;</span>&nbsp;<span class="ident" id="1682308">frame</span><span class="op" id="1682313">.</span><span class="ident" id="1682314">fp</span>&nbsp;<span class="op" id="1682317">||</span>&nbsp;<span class="ident" id="1682320">frame</span><span class="op" id="1682325">.</span><span class="ident" id="1682326">lr</span>&nbsp;<span class="op" id="1682329">==</span>&nbsp;<span class="num" id="1682332">0</span>&nbsp;<span class="op" id="1682334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1682341">frame</span><span class="op" id="1682346">.</span><span class="ident" id="1682347">lr</span>&nbsp;<span class="op" id="1682350">=</span>&nbsp;<span class="op" id="1682352">*</span><span class="op" id="1682353">(</span><span class="op" id="1682354">*</span><span class="builtintype" id="1682355">uintptr</span><span class="op" id="1682362">)</span><span class="op" id="1682363">(</span><span class="ident" id="1682364">unsafe</span><span class="op" id="1682370">.</span><span class="ident" id="1682371">Pointer</span><span class="op" id="1682378">(</span><span class="ident" id="1682379">frame</span><span class="op" id="1682384">.</span><span class="ident" id="1682385">sp</span><span class="op" id="1682387">)</span><span class="op" id="1682388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1682394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1682399">}</span>&nbsp;<span class="keyword" id="1682401">else</span>&nbsp;<span class="op" id="1682406">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1682412">if</span>&nbsp;<span class="ident" id="1682415">frame</span><span class="op" id="1682420">.</span><span class="ident" id="1682421">lr</span>&nbsp;<span class="op" id="1682424">==</span>&nbsp;<span class="num" id="1682427">0</span>&nbsp;<span class="op" id="1682429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1682436">frame</span><span class="op" id="1682441">.</span><span class="ident" id="1682442">lr</span>&nbsp;<span class="op" id="1682445">=</span>&nbsp;<span class="builtintype" id="1682447">uintptr</span><span class="op" id="1682454">(</span><span class="op" id="1682455">*</span><span class="op" id="1682456">(</span><span class="op" id="1682457">*</span><span class="ident" id="1682458">uintreg</span><span class="op" id="1682465">)</span><span class="op" id="1682466">(</span><span class="ident" id="1682467">unsafe</span><span class="op" id="1682473">.</span><span class="ident" id="1682474">Pointer</span><span class="op" id="1682481">(</span><span class="ident" id="1682482">frame</span><span class="op" id="1682487">.</span><span class="ident" id="1682488">fp</span>&nbsp;<span class="op" id="1682491">-</span>&nbsp;<span class="ident" id="1682493">regSize</span><span class="op" id="1682500">)</span><span class="op" id="1682501">)</span><span class="op" id="1682502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1682508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1682513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1682518">flr</span>&nbsp;<span class="op" id="1682522">=</span>&nbsp;<span class="ident" id="1682524">findfunc</span><span class="op" id="1682532">(</span><span class="ident" id="1682533">frame</span><span class="op" id="1682538">.</span><span class="ident" id="1682539">lr</span><span class="op" id="1682541">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1682546">if</span>&nbsp;<span class="ident" id="1682549">flr</span>&nbsp;<span class="op" id="1682553">==</span>&nbsp;<span class="builtintype" id="1682556">nil</span>&nbsp;<span class="op" id="1682560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1682566">//&nbsp;This&nbsp;happens&nbsp;if&nbsp;you&nbsp;get&nbsp;a&nbsp;profiling&nbsp;interrupt&nbsp;at&nbsp;just&nbsp;the&nbsp;wrong&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1682643">//&nbsp;In&nbsp;that&nbsp;context&nbsp;it&nbsp;is&nbsp;okay&nbsp;to&nbsp;stop&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1682692">//&nbsp;But&nbsp;if&nbsp;callback&nbsp;is&nbsp;set,&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;and&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1682765">//&nbsp;get&nbsp;everything,&nbsp;so&nbsp;crash&nbsp;loudly.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1682805">if</span>&nbsp;<span class="ident" id="1682808">callback</span>&nbsp;<span class="op" id="1682817">!=</span>&nbsp;<span class="builtintype" id="1682820">nil</span>&nbsp;<span class="op" id="1682824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1682831">print</span><span class="op" id="1682836">(</span><span class="string" id="1682837">&#34;runtime:&nbsp;unexpected&nbsp;return&nbsp;pc&nbsp;for&nbsp;&#34;</span><span class="op" id="1682873">,</span>&nbsp;<span class="ident" id="1682875">gofuncname</span><span class="op" id="1682885">(</span><span class="ident" id="1682886">f</span><span class="op" id="1682887">)</span><span class="op" id="1682888">,</span>&nbsp;<span class="string" id="1682890">&#34;&nbsp;called&nbsp;from&nbsp;&#34;</span><span class="op" id="1682905">,</span>&nbsp;<span class="ident" id="1682907">hex</span><span class="op" id="1682910">(</span><span class="ident" id="1682911">frame</span><span class="op" id="1682916">.</span><span class="ident" id="1682917">lr</span><span class="op" id="1682919">)</span><span class="op" id="1682920">,</span>&nbsp;<span class="string" id="1682922">&#34;\n&#34;</span><span class="op" id="1682926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1682933">gothrow</span><span class="op" id="1682940">(</span><span class="string" id="1682941">&#34;unknown&nbsp;caller&nbsp;pc&#34;</span><span class="op" id="1682960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1682966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1682971">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1682975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1682980">frame</span><span class="op" id="1682985">.</span><span class="ident" id="1682986">varp</span>&nbsp;<span class="op" id="1682991">=</span>&nbsp;<span class="ident" id="1682993">frame</span><span class="op" id="1682998">.</span><span class="ident" id="1682999">fp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1683004">if</span>&nbsp;<span class="op" id="1683007">!</span><span class="ident" id="1683008">usesLR</span>&nbsp;<span class="op" id="1683015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1683020">//&nbsp;On&nbsp;x86,&nbsp;call&nbsp;instruction&nbsp;pushes&nbsp;return&nbsp;PC&nbsp;before&nbsp;entering&nbsp;new&nbsp;function.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1683098">frame</span><span class="op" id="1683103">.</span><span class="ident" id="1683104">varp</span>&nbsp;<span class="op" id="1683109">-=</span>&nbsp;<span class="ident" id="1683112">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1683122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1683127">//&nbsp;Derive&nbsp;size&nbsp;of&nbsp;arguments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1683158">//&nbsp;Most&nbsp;functions&nbsp;have&nbsp;a&nbsp;fixed-size&nbsp;argument&nbsp;block,</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1683212">//&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;metadata&nbsp;about&nbsp;the&nbsp;function&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1683262">//&nbsp;Not&nbsp;all,&nbsp;though:&nbsp;there&nbsp;are&nbsp;some&nbsp;variadic&nbsp;functions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1683318">//&nbsp;in&nbsp;package&nbsp;runtime&nbsp;and&nbsp;reflect,&nbsp;and&nbsp;for&nbsp;those&nbsp;we&nbsp;use&nbsp;call-specific</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1683390">//&nbsp;metadata&nbsp;recorded&nbsp;by&nbsp;f&#39;s&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1683428">if</span>&nbsp;<span class="ident" id="1683431">callback</span>&nbsp;<span class="op" id="1683440">!=</span>&nbsp;<span class="builtintype" id="1683443">nil</span>&nbsp;<span class="op" id="1683447">||</span>&nbsp;<span class="ident" id="1683450">printing</span>&nbsp;<span class="op" id="1683459">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1683464">frame</span><span class="op" id="1683469">.</span><span class="ident" id="1683470">argp</span>&nbsp;<span class="op" id="1683475">=</span>&nbsp;<span class="ident" id="1683477">frame</span><span class="op" id="1683482">.</span><span class="ident" id="1683483">fp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1683489">if</span>&nbsp;<span class="ident" id="1683492">usesLR</span>&nbsp;<span class="op" id="1683499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1683505">frame</span><span class="op" id="1683510">.</span><span class="ident" id="1683511">argp</span>&nbsp;<span class="op" id="1683516">+=</span>&nbsp;<span class="ident" id="1683519">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1683530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1683535">setArgInfo</span><span class="op" id="1683545">(</span><span class="op" id="1683546">&amp;</span><span class="ident" id="1683547">frame</span><span class="op" id="1683552">,</span>&nbsp;<span class="ident" id="1683554">f</span><span class="op" id="1683555">,</span>&nbsp;<span class="ident" id="1683557">callback</span>&nbsp;<span class="op" id="1683566">!=</span>&nbsp;<span class="builtintype" id="1683569">nil</span><span class="op" id="1683572">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1683576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1683581">//&nbsp;Determine&nbsp;function&nbsp;SP&nbsp;where&nbsp;deferproc&nbsp;would&nbsp;find&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1683650">var</span>&nbsp;<span class="ident" id="1683654">sparg</span>&nbsp;<span class="builtintype" id="1683660">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1683670">if</span>&nbsp;<span class="ident" id="1683673">usesLR</span>&nbsp;<span class="op" id="1683680">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1683685">//&nbsp;On&nbsp;link&nbsp;register&nbsp;architectures,&nbsp;that&#39;s&nbsp;the&nbsp;standard&nbsp;bottom-of-stack&nbsp;plus&nbsp;1&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1683771">//&nbsp;for&nbsp;the&nbsp;saved&nbsp;LR.&nbsp;If&nbsp;the&nbsp;previous&nbsp;frame&nbsp;was&nbsp;a&nbsp;direct&nbsp;call&nbsp;to&nbsp;newproc/deferproc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1683857">//&nbsp;however,&nbsp;the&nbsp;SP&nbsp;is&nbsp;three&nbsp;words&nbsp;lower&nbsp;than&nbsp;normal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1683913">//&nbsp;If&nbsp;the&nbsp;function&nbsp;has&nbsp;no&nbsp;frame&nbsp;at&nbsp;all&nbsp;-&nbsp;perhaps&nbsp;it&nbsp;just&nbsp;started,&nbsp;or&nbsp;perhaps</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1683993">//&nbsp;it&nbsp;is&nbsp;a&nbsp;leaf&nbsp;with&nbsp;no&nbsp;local&nbsp;variables&nbsp;-&nbsp;then&nbsp;we&nbsp;cannot&nbsp;possibly&nbsp;find&nbsp;its</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1684071">//&nbsp;SP&nbsp;in&nbsp;a&nbsp;defer,&nbsp;and&nbsp;we&nbsp;might&nbsp;confuse&nbsp;its&nbsp;SP&nbsp;for&nbsp;its&nbsp;caller&#39;s&nbsp;SP,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1684144">//&nbsp;leave&nbsp;sparg=0&nbsp;in&nbsp;that&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1684178">if</span>&nbsp;<span class="ident" id="1684181">frame</span><span class="op" id="1684186">.</span><span class="ident" id="1684187">fp</span>&nbsp;<span class="op" id="1684190">!=</span>&nbsp;<span class="ident" id="1684193">frame</span><span class="op" id="1684198">.</span><span class="ident" id="1684199">sp</span>&nbsp;<span class="op" id="1684202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1684208">sparg</span>&nbsp;<span class="op" id="1684214">=</span>&nbsp;<span class="ident" id="1684216">frame</span><span class="op" id="1684221">.</span><span class="ident" id="1684222">sp</span>&nbsp;<span class="op" id="1684225">+</span>&nbsp;<span class="ident" id="1684227">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1684239">if</span>&nbsp;<span class="ident" id="1684242">wasnewproc</span>&nbsp;<span class="op" id="1684253">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1684260">sparg</span>&nbsp;<span class="op" id="1684266">+=</span>&nbsp;<span class="num" id="1684269">3</span>&nbsp;<span class="op" id="1684271">*</span>&nbsp;<span class="ident" id="1684273">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1684285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1684290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1684294">}</span>&nbsp;<span class="keyword" id="1684296">else</span>&nbsp;<span class="op" id="1684301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1684306">//&nbsp;On&nbsp;x86&nbsp;that&#39;s&nbsp;the&nbsp;standard&nbsp;bottom-of-stack,&nbsp;so&nbsp;SP&nbsp;exactly.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1684371">//&nbsp;If&nbsp;the&nbsp;previous&nbsp;frame&nbsp;was&nbsp;a&nbsp;direct&nbsp;call&nbsp;to&nbsp;newproc/deferproc,&nbsp;however,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1684448">//&nbsp;the&nbsp;SP&nbsp;is&nbsp;two&nbsp;words&nbsp;lower&nbsp;than&nbsp;normal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1684493">sparg</span>&nbsp;<span class="op" id="1684499">=</span>&nbsp;<span class="ident" id="1684501">frame</span><span class="op" id="1684506">.</span><span class="ident" id="1684507">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1684513">if</span>&nbsp;<span class="ident" id="1684516">wasnewproc</span>&nbsp;<span class="op" id="1684527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1684533">sparg</span>&nbsp;<span class="op" id="1684539">+=</span>&nbsp;<span class="num" id="1684542">2</span>&nbsp;<span class="op" id="1684544">*</span>&nbsp;<span class="ident" id="1684546">ptrSize</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1684557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1684561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1684566">//&nbsp;Determine&nbsp;frame&#39;s&nbsp;&#39;continuation&nbsp;PC&#39;,&nbsp;where&nbsp;it&nbsp;can&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1684631">//&nbsp;Normally&nbsp;this&nbsp;is&nbsp;the&nbsp;return&nbsp;address&nbsp;on&nbsp;the&nbsp;stack,&nbsp;but&nbsp;if&nbsp;sigpanic</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1684702">//&nbsp;is&nbsp;immediately&nbsp;below&nbsp;this&nbsp;function&nbsp;on&nbsp;the&nbsp;stack,&nbsp;then&nbsp;the&nbsp;frame</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1684771">//&nbsp;stopped&nbsp;executing&nbsp;due&nbsp;to&nbsp;a&nbsp;trap,&nbsp;and&nbsp;frame.pc&nbsp;is&nbsp;probably&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1684838">//&nbsp;a&nbsp;safe&nbsp;point&nbsp;for&nbsp;looking&nbsp;up&nbsp;liveness&nbsp;information.&nbsp;In&nbsp;this&nbsp;panicking&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1684917">//&nbsp;the&nbsp;function&nbsp;either&nbsp;doesn&#39;t&nbsp;return&nbsp;at&nbsp;all&nbsp;(if&nbsp;it&nbsp;has&nbsp;no&nbsp;defers&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1684995">//&nbsp;defers&nbsp;do&nbsp;not&nbsp;recover)&nbsp;or&nbsp;it&nbsp;returns&nbsp;from&nbsp;one&nbsp;of&nbsp;the&nbsp;calls&nbsp;to</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1685062">//&nbsp;deferproc&nbsp;a&nbsp;second&nbsp;time&nbsp;(if&nbsp;the&nbsp;corresponding&nbsp;deferred&nbsp;func&nbsp;recovers).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1685138">//&nbsp;It&nbsp;suffices&nbsp;to&nbsp;assume&nbsp;that&nbsp;the&nbsp;most&nbsp;recent&nbsp;deferproc&nbsp;is&nbsp;the&nbsp;one&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1685212">//&nbsp;returns;&nbsp;everything&nbsp;live&nbsp;at&nbsp;earlier&nbsp;deferprocs&nbsp;is&nbsp;still&nbsp;live&nbsp;at&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1685291">frame</span><span class="op" id="1685296">.</span><span class="ident" id="1685297">continpc</span>&nbsp;<span class="op" id="1685306">=</span>&nbsp;<span class="ident" id="1685308">frame</span><span class="op" id="1685313">.</span><span class="ident" id="1685314">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1685319">if</span>&nbsp;<span class="ident" id="1685322">waspanic</span>&nbsp;<span class="op" id="1685331">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1685336">if</span>&nbsp;<span class="ident" id="1685339">_defer</span>&nbsp;<span class="op" id="1685346">!=</span>&nbsp;<span class="builtintype" id="1685349">nil</span>&nbsp;<span class="op" id="1685353">&amp;&amp;</span>&nbsp;<span class="ident" id="1685356">_defer</span><span class="op" id="1685362">.</span><span class="ident" id="1685363">argp</span>&nbsp;<span class="op" id="1685368">==</span>&nbsp;<span class="ident" id="1685371">sparg</span>&nbsp;<span class="op" id="1685377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1685383">frame</span><span class="op" id="1685388">.</span><span class="ident" id="1685389">continpc</span>&nbsp;<span class="op" id="1685398">=</span>&nbsp;<span class="ident" id="1685400">_defer</span><span class="op" id="1685406">.</span><span class="ident" id="1685407">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1685413">}</span>&nbsp;<span class="keyword" id="1685415">else</span>&nbsp;<span class="op" id="1685420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1685426">frame</span><span class="op" id="1685431">.</span><span class="ident" id="1685432">continpc</span>&nbsp;<span class="op" id="1685441">=</span>&nbsp;<span class="num" id="1685443">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1685448">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1685452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1685457">//&nbsp;Unwind&nbsp;our&nbsp;local&nbsp;defer&nbsp;stack&nbsp;past&nbsp;this&nbsp;frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1685508">for</span>&nbsp;<span class="ident" id="1685512">_defer</span>&nbsp;<span class="op" id="1685519">!=</span>&nbsp;<span class="builtintype" id="1685522">nil</span>&nbsp;<span class="op" id="1685526">&amp;&amp;</span>&nbsp;<span class="op" id="1685529">(</span><span class="ident" id="1685530">_defer</span><span class="op" id="1685536">.</span><span class="ident" id="1685537">argp</span>&nbsp;<span class="op" id="1685542">==</span>&nbsp;<span class="ident" id="1685545">sparg</span>&nbsp;<span class="op" id="1685551">||</span>&nbsp;<span class="ident" id="1685554">_defer</span><span class="op" id="1685560">.</span><span class="ident" id="1685561">argp</span>&nbsp;<span class="op" id="1685566">==</span>&nbsp;<span class="ident" id="1685569">_NoArgs</span><span class="op" id="1685576">)</span>&nbsp;<span class="op" id="1685578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1685583">_defer</span>&nbsp;<span class="op" id="1685590">=</span>&nbsp;<span class="ident" id="1685592">_defer</span><span class="op" id="1685598">.</span><span class="ident" id="1685599">link</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1685606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1685611">if</span>&nbsp;<span class="ident" id="1685614">skip</span>&nbsp;<span class="op" id="1685619">&gt;</span>&nbsp;<span class="num" id="1685621">0</span>&nbsp;<span class="op" id="1685623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1685628">skip</span><span class="op" id="1685632">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1685638">goto</span>&nbsp;<span class="ident" id="1685643">skipped</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1685653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1685658">if</span>&nbsp;<span class="ident" id="1685661">pcbuf</span>&nbsp;<span class="op" id="1685667">!=</span>&nbsp;<span class="builtintype" id="1685670">nil</span>&nbsp;<span class="op" id="1685674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1685679">(</span><span class="op" id="1685680">*</span><span class="op" id="1685681">[</span><span class="num" id="1685682">1</span>&nbsp;<span class="op" id="1685684">&lt;&lt;</span>&nbsp;<span class="num" id="1685687">20</span><span class="op" id="1685689">]</span><span class="builtintype" id="1685690">uintptr</span><span class="op" id="1685697">)</span><span class="op" id="1685698">(</span><span class="ident" id="1685699">unsafe</span><span class="op" id="1685705">.</span><span class="ident" id="1685706">Pointer</span><span class="op" id="1685713">(</span><span class="ident" id="1685714">pcbuf</span><span class="op" id="1685719">)</span><span class="op" id="1685720">)</span><span class="op" id="1685721">[</span><span class="ident" id="1685722">n</span><span class="op" id="1685723">]</span>&nbsp;<span class="op" id="1685725">=</span>&nbsp;<span class="ident" id="1685727">frame</span><span class="op" id="1685732">.</span><span class="ident" id="1685733">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1685738">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1685742">if</span>&nbsp;<span class="ident" id="1685745">callback</span>&nbsp;<span class="op" id="1685754">!=</span>&nbsp;<span class="builtintype" id="1685757">nil</span>&nbsp;<span class="op" id="1685761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1685766">if</span>&nbsp;<span class="op" id="1685769">!</span><span class="ident" id="1685770">callback</span><span class="op" id="1685778">(</span><span class="op" id="1685779">(</span><span class="op" id="1685780">*</span><span class="ident" id="1685781">stkframe</span><span class="op" id="1685789">)</span><span class="op" id="1685790">(</span><span class="ident" id="1685791">noescape</span><span class="op" id="1685799">(</span><span class="ident" id="1685800">unsafe</span><span class="op" id="1685806">.</span><span class="ident" id="1685807">Pointer</span><span class="op" id="1685814">(</span><span class="op" id="1685815">&amp;</span><span class="ident" id="1685816">frame</span><span class="op" id="1685821">)</span><span class="op" id="1685822">)</span><span class="op" id="1685823">)</span><span class="op" id="1685824">,</span>&nbsp;<span class="ident" id="1685826">v</span><span class="op" id="1685827">)</span>&nbsp;<span class="op" id="1685829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1685835">return</span>&nbsp;<span class="ident" id="1685842">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1685847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1685851">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1685855">if</span>&nbsp;<span class="ident" id="1685858">printing</span>&nbsp;<span class="op" id="1685867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1685872">if</span>&nbsp;<span class="op" id="1685875">(</span><span class="ident" id="1685876">flags</span><span class="op" id="1685881">&amp;</span><span class="ident" id="1685882">_TraceRuntimeFrames</span><span class="op" id="1685901">)</span>&nbsp;<span class="op" id="1685903">!=</span>&nbsp;<span class="num" id="1685906">0</span>&nbsp;<span class="op" id="1685908">||</span>&nbsp;<span class="ident" id="1685911">showframe</span><span class="op" id="1685920">(</span><span class="ident" id="1685921">f</span><span class="op" id="1685922">,</span>&nbsp;<span class="ident" id="1685924">gp</span><span class="op" id="1685926">)</span>&nbsp;<span class="op" id="1685928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1685934">//&nbsp;Print&nbsp;during&nbsp;crash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1685961">//&nbsp;&nbsp;&nbsp;&nbsp;main(0x1,&nbsp;0x2,&nbsp;0x3)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1685988">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/home/rsc/go/src/runtime/x.go:23&nbsp;+0xf</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1686034">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1686041">tracepc</span>&nbsp;<span class="op" id="1686049">:=</span>&nbsp;<span class="ident" id="1686052">frame</span><span class="op" id="1686057">.</span><span class="ident" id="1686058">pc</span>&nbsp;<span class="comment" id="1686061">//&nbsp;back&nbsp;up&nbsp;to&nbsp;CALL&nbsp;instruction&nbsp;for&nbsp;funcline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1686110">if</span>&nbsp;<span class="op" id="1686113">(</span><span class="ident" id="1686114">n</span>&nbsp;<span class="op" id="1686116">&gt;</span>&nbsp;<span class="num" id="1686118">0</span>&nbsp;<span class="op" id="1686120">||</span>&nbsp;<span class="ident" id="1686123">flags</span><span class="op" id="1686128">&amp;</span><span class="ident" id="1686129">_TraceTrap</span>&nbsp;<span class="op" id="1686140">==</span>&nbsp;<span class="num" id="1686143">0</span><span class="op" id="1686144">)</span>&nbsp;<span class="op" id="1686146">&amp;&amp;</span>&nbsp;<span class="ident" id="1686149">frame</span><span class="op" id="1686154">.</span><span class="ident" id="1686155">pc</span>&nbsp;<span class="op" id="1686158">&gt;</span>&nbsp;<span class="ident" id="1686160">f</span><span class="op" id="1686161">.</span><span class="ident" id="1686162">entry</span>&nbsp;<span class="op" id="1686168">&amp;&amp;</span>&nbsp;<span class="op" id="1686171">!</span><span class="ident" id="1686172">waspanic</span>&nbsp;<span class="op" id="1686181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1686188">tracepc</span><span class="op" id="1686195">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1686202">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1686208">print</span><span class="op" id="1686213">(</span><span class="ident" id="1686214">gofuncname</span><span class="op" id="1686224">(</span><span class="ident" id="1686225">f</span><span class="op" id="1686226">)</span><span class="op" id="1686227">,</span>&nbsp;<span class="string" id="1686229">&#34;(&#34;</span><span class="op" id="1686232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1686238">argp</span>&nbsp;<span class="op" id="1686243">:=</span>&nbsp;<span class="op" id="1686246">(</span><span class="op" id="1686247">*</span><span class="op" id="1686248">[</span><span class="num" id="1686249">100</span><span class="op" id="1686252">]</span><span class="builtintype" id="1686253">uintptr</span><span class="op" id="1686260">)</span><span class="op" id="1686261">(</span><span class="ident" id="1686262">unsafe</span><span class="op" id="1686268">.</span><span class="ident" id="1686269">Pointer</span><span class="op" id="1686276">(</span><span class="ident" id="1686277">frame</span><span class="op" id="1686282">.</span><span class="ident" id="1686283">argp</span><span class="op" id="1686287">)</span><span class="op" id="1686288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1686294">for</span>&nbsp;<span class="ident" id="1686298">i</span>&nbsp;<span class="op" id="1686300">:=</span>&nbsp;<span class="builtintype" id="1686303">uintptr</span><span class="op" id="1686310">(</span><span class="num" id="1686311">0</span><span class="op" id="1686312">)</span><span class="op" id="1686313">;</span>&nbsp;<span class="ident" id="1686315">i</span>&nbsp;<span class="op" id="1686317">&lt;</span>&nbsp;<span class="ident" id="1686319">frame</span><span class="op" id="1686324">.</span><span class="ident" id="1686325">arglen</span><span class="op" id="1686331">/</span><span class="ident" id="1686332">ptrSize</span><span class="op" id="1686339">;</span>&nbsp;<span class="ident" id="1686341">i</span><span class="op" id="1686342">++</span>&nbsp;<span class="op" id="1686345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1686352">if</span>&nbsp;<span class="ident" id="1686355">i</span>&nbsp;<span class="op" id="1686357">&gt;=</span>&nbsp;<span class="num" id="1686360">10</span>&nbsp;<span class="op" id="1686363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1686371">print</span><span class="op" id="1686376">(</span><span class="string" id="1686377">&#34;,&nbsp;...&#34;</span><span class="op" id="1686384">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1686392">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1686403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1686410">if</span>&nbsp;<span class="ident" id="1686413">i</span>&nbsp;<span class="op" id="1686415">!=</span>&nbsp;<span class="num" id="1686418">0</span>&nbsp;<span class="op" id="1686420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1686428">print</span><span class="op" id="1686433">(</span><span class="string" id="1686434">&#34;,&nbsp;&#34;</span><span class="op" id="1686438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1686445">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1686452">print</span><span class="op" id="1686457">(</span><span class="ident" id="1686458">hex</span><span class="op" id="1686461">(</span><span class="ident" id="1686462">argp</span><span class="op" id="1686466">[</span><span class="ident" id="1686467">i</span><span class="op" id="1686468">]</span><span class="op" id="1686469">)</span><span class="op" id="1686470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1686476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1686482">print</span><span class="op" id="1686487">(</span><span class="string" id="1686488">&#34;)\n&#34;</span><span class="op" id="1686493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1686499">var</span>&nbsp;<span class="ident" id="1686503">file</span>&nbsp;<span class="builtintype" id="1686508">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1686519">line</span>&nbsp;<span class="op" id="1686524">:=</span>&nbsp;<span class="ident" id="1686527">funcline</span><span class="op" id="1686535">(</span><span class="ident" id="1686536">f</span><span class="op" id="1686537">,</span>&nbsp;<span class="ident" id="1686539">tracepc</span><span class="op" id="1686546">,</span>&nbsp;<span class="op" id="1686548">&amp;</span><span class="ident" id="1686549">file</span><span class="op" id="1686553">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1686559">print</span><span class="op" id="1686564">(</span><span class="string" id="1686565">&#34;\t&#34;</span><span class="op" id="1686569">,</span>&nbsp;<span class="ident" id="1686571">file</span><span class="op" id="1686575">,</span>&nbsp;<span class="string" id="1686577">&#34;:&#34;</span><span class="op" id="1686580">,</span>&nbsp;<span class="ident" id="1686582">line</span><span class="op" id="1686586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1686592">if</span>&nbsp;<span class="ident" id="1686595">frame</span><span class="op" id="1686600">.</span><span class="ident" id="1686601">pc</span>&nbsp;<span class="op" id="1686604">&gt;</span>&nbsp;<span class="ident" id="1686606">f</span><span class="op" id="1686607">.</span><span class="ident" id="1686608">entry</span>&nbsp;<span class="op" id="1686614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1686621">print</span><span class="op" id="1686626">(</span><span class="string" id="1686627">&#34;&nbsp;+&#34;</span><span class="op" id="1686631">,</span>&nbsp;<span class="ident" id="1686633">hex</span><span class="op" id="1686636">(</span><span class="ident" id="1686637">frame</span><span class="op" id="1686642">.</span><span class="ident" id="1686643">pc</span><span class="op" id="1686645">-</span><span class="ident" id="1686646">f</span><span class="op" id="1686647">.</span><span class="ident" id="1686648">entry</span><span class="op" id="1686653">)</span><span class="op" id="1686654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1686660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1686666">if</span>&nbsp;<span class="ident" id="1686669">g</span><span class="op" id="1686670">.</span><span class="ident" id="1686671">m</span><span class="op" id="1686672">.</span><span class="ident" id="1686673">throwing</span>&nbsp;<span class="op" id="1686682">&gt;</span>&nbsp;<span class="num" id="1686684">0</span>&nbsp;<span class="op" id="1686686">&amp;&amp;</span>&nbsp;<span class="ident" id="1686689">gp</span>&nbsp;<span class="op" id="1686692">==</span>&nbsp;<span class="ident" id="1686695">g</span><span class="op" id="1686696">.</span><span class="ident" id="1686697">m</span><span class="op" id="1686698">.</span><span class="ident" id="1686699">curg</span>&nbsp;<span class="op" id="1686704">||</span>&nbsp;<span class="ident" id="1686707">gotraceback</span>&nbsp;<span class="op" id="1686719">&gt;=</span>&nbsp;<span class="num" id="1686722">2</span>&nbsp;<span class="op" id="1686724">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1686731">print</span><span class="op" id="1686736">(</span><span class="string" id="1686737">&#34;&nbsp;fp=&#34;</span><span class="op" id="1686743">,</span>&nbsp;<span class="ident" id="1686745">hex</span><span class="op" id="1686748">(</span><span class="ident" id="1686749">frame</span><span class="op" id="1686754">.</span><span class="ident" id="1686755">fp</span><span class="op" id="1686757">)</span><span class="op" id="1686758">,</span>&nbsp;<span class="string" id="1686760">&#34;&nbsp;sp=&#34;</span><span class="op" id="1686766">,</span>&nbsp;<span class="ident" id="1686768">hex</span><span class="op" id="1686771">(</span><span class="ident" id="1686772">frame</span><span class="op" id="1686777">.</span><span class="ident" id="1686778">sp</span><span class="op" id="1686780">)</span><span class="op" id="1686781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1686787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1686793">print</span><span class="op" id="1686798">(</span><span class="string" id="1686799">&#34;\n&#34;</span><span class="op" id="1686803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1686809">nprint</span><span class="op" id="1686815">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1686821">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1686825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1686829">n</span><span class="op" id="1686830">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1686835">skipped</span><span class="op" id="1686842">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1686846">waspanic</span>&nbsp;<span class="op" id="1686855">=</span>&nbsp;<span class="ident" id="1686857">f</span><span class="op" id="1686858">.</span><span class="ident" id="1686859">entry</span>&nbsp;<span class="op" id="1686865">==</span>&nbsp;<span class="ident" id="1686868">sigpanicPC</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1686881">wasnewproc</span>&nbsp;<span class="op" id="1686892">=</span>&nbsp;<span class="ident" id="1686894">f</span><span class="op" id="1686895">.</span><span class="ident" id="1686896">entry</span>&nbsp;<span class="op" id="1686902">==</span>&nbsp;<span class="ident" id="1686905">newprocPC</span>&nbsp;<span class="op" id="1686915">||</span>&nbsp;<span class="ident" id="1686918">f</span><span class="op" id="1686919">.</span><span class="ident" id="1686920">entry</span>&nbsp;<span class="op" id="1686926">==</span>&nbsp;<span class="ident" id="1686929">deferprocPC</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1686944">//&nbsp;Do&nbsp;not&nbsp;unwind&nbsp;past&nbsp;the&nbsp;bottom&nbsp;of&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1686993">if</span>&nbsp;<span class="ident" id="1686996">flr</span>&nbsp;<span class="op" id="1687000">==</span>&nbsp;<span class="builtintype" id="1687003">nil</span>&nbsp;<span class="op" id="1687007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1687012">break</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1687020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1687025">//&nbsp;Unwind&nbsp;to&nbsp;next&nbsp;frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1687052">frame</span><span class="op" id="1687057">.</span><span class="ident" id="1687058">fn</span>&nbsp;<span class="op" id="1687061">=</span>&nbsp;<span class="ident" id="1687063">flr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1687069">frame</span><span class="op" id="1687074">.</span><span class="ident" id="1687075">pc</span>&nbsp;<span class="op" id="1687078">=</span>&nbsp;<span class="ident" id="1687080">frame</span><span class="op" id="1687085">.</span><span class="ident" id="1687086">lr</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1687091">frame</span><span class="op" id="1687096">.</span><span class="ident" id="1687097">lr</span>&nbsp;<span class="op" id="1687100">=</span>&nbsp;<span class="num" id="1687102">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1687106">frame</span><span class="op" id="1687111">.</span><span class="ident" id="1687112">sp</span>&nbsp;<span class="op" id="1687115">=</span>&nbsp;<span class="ident" id="1687117">frame</span><span class="op" id="1687122">.</span><span class="ident" id="1687123">fp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1687128">frame</span><span class="op" id="1687133">.</span><span class="ident" id="1687134">fp</span>&nbsp;<span class="op" id="1687137">=</span>&nbsp;<span class="num" id="1687139">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1687143">frame</span><span class="op" id="1687148">.</span><span class="ident" id="1687149">argmap</span>&nbsp;<span class="op" id="1687156">=</span>&nbsp;<span class="builtintype" id="1687158">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1687165">//&nbsp;On&nbsp;link&nbsp;register&nbsp;architectures,&nbsp;sighandler&nbsp;saves&nbsp;the&nbsp;LR&nbsp;on&nbsp;stack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1687235">//&nbsp;before&nbsp;faking&nbsp;a&nbsp;call&nbsp;to&nbsp;sigpanic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1687274">if</span>&nbsp;<span class="ident" id="1687277">usesLR</span>&nbsp;<span class="op" id="1687284">&amp;&amp;</span>&nbsp;<span class="ident" id="1687287">waspanic</span>&nbsp;<span class="op" id="1687296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1687301">x</span>&nbsp;<span class="op" id="1687303">:=</span>&nbsp;<span class="op" id="1687306">*</span><span class="op" id="1687307">(</span><span class="op" id="1687308">*</span><span class="builtintype" id="1687309">uintptr</span><span class="op" id="1687316">)</span><span class="op" id="1687317">(</span><span class="ident" id="1687318">unsafe</span><span class="op" id="1687324">.</span><span class="ident" id="1687325">Pointer</span><span class="op" id="1687332">(</span><span class="ident" id="1687333">frame</span><span class="op" id="1687338">.</span><span class="ident" id="1687339">sp</span><span class="op" id="1687341">)</span><span class="op" id="1687342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1687347">frame</span><span class="op" id="1687352">.</span><span class="ident" id="1687353">sp</span>&nbsp;<span class="op" id="1687356">+=</span>&nbsp;<span class="ident" id="1687359">ptrSize</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1687370">f</span>&nbsp;<span class="op" id="1687372">=</span>&nbsp;<span class="ident" id="1687374">findfunc</span><span class="op" id="1687382">(</span><span class="ident" id="1687383">frame</span><span class="op" id="1687388">.</span><span class="ident" id="1687389">pc</span><span class="op" id="1687391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1687396">frame</span><span class="op" id="1687401">.</span><span class="ident" id="1687402">fn</span>&nbsp;<span class="op" id="1687405">=</span>&nbsp;<span class="ident" id="1687407">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1687412">if</span>&nbsp;<span class="ident" id="1687415">f</span>&nbsp;<span class="op" id="1687417">==</span>&nbsp;<span class="builtintype" id="1687420">nil</span>&nbsp;<span class="op" id="1687424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1687430">frame</span><span class="op" id="1687435">.</span><span class="ident" id="1687436">pc</span>&nbsp;<span class="op" id="1687439">=</span>&nbsp;<span class="ident" id="1687441">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1687446">}</span>&nbsp;<span class="keyword" id="1687448">else</span>&nbsp;<span class="keyword" id="1687453">if</span>&nbsp;<span class="ident" id="1687456">f</span><span class="op" id="1687457">.</span><span class="ident" id="1687458">frame</span>&nbsp;<span class="op" id="1687464">==</span>&nbsp;<span class="num" id="1687467">0</span>&nbsp;<span class="op" id="1687469">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1687475">frame</span><span class="op" id="1687480">.</span><span class="ident" id="1687481">lr</span>&nbsp;<span class="op" id="1687484">=</span>&nbsp;<span class="ident" id="1687486">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1687491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1687495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1687498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1687502">if</span>&nbsp;<span class="ident" id="1687505">pcbuf</span>&nbsp;<span class="op" id="1687511">==</span>&nbsp;<span class="builtintype" id="1687514">nil</span>&nbsp;<span class="op" id="1687518">&amp;&amp;</span>&nbsp;<span class="ident" id="1687521">callback</span>&nbsp;<span class="op" id="1687530">==</span>&nbsp;<span class="builtintype" id="1687533">nil</span>&nbsp;<span class="op" id="1687537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1687541">n</span>&nbsp;<span class="op" id="1687543">=</span>&nbsp;<span class="ident" id="1687545">nprint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1687553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1687557">//&nbsp;If&nbsp;callback&nbsp;!=&nbsp;nil,&nbsp;we&#39;re&nbsp;being&nbsp;called&nbsp;to&nbsp;gather&nbsp;stack&nbsp;information&nbsp;during</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1687635">//&nbsp;garbage&nbsp;collection&nbsp;or&nbsp;stack&nbsp;growth.&nbsp;In&nbsp;that&nbsp;context,&nbsp;require&nbsp;that&nbsp;we&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1687713">//&nbsp;up&nbsp;the&nbsp;entire&nbsp;defer&nbsp;stack.&nbsp;If&nbsp;not,&nbsp;then&nbsp;there&nbsp;is&nbsp;a&nbsp;bug&nbsp;somewhere&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1687790">//&nbsp;garbage&nbsp;collection&nbsp;or&nbsp;stack&nbsp;growth&nbsp;may&nbsp;not&nbsp;have&nbsp;seen&nbsp;the&nbsp;correct&nbsp;picture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1687867">//&nbsp;of&nbsp;the&nbsp;stack.&nbsp;Crash&nbsp;now&nbsp;instead&nbsp;of&nbsp;silently&nbsp;executing&nbsp;the&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1687948">//&nbsp;or&nbsp;stack&nbsp;copy&nbsp;incorrectly&nbsp;and&nbsp;setting&nbsp;up&nbsp;for&nbsp;a&nbsp;mysterious&nbsp;crash&nbsp;later.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688023">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688027">//&nbsp;Note&nbsp;that&nbsp;panic&nbsp;!=&nbsp;nil&nbsp;is&nbsp;okay&nbsp;here:&nbsp;there&nbsp;can&nbsp;be&nbsp;leftover&nbsp;panics,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688098">//&nbsp;because&nbsp;the&nbsp;defers&nbsp;on&nbsp;the&nbsp;panic&nbsp;stack&nbsp;do&nbsp;not&nbsp;nest&nbsp;in&nbsp;frame&nbsp;order&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688170">//&nbsp;they&nbsp;do&nbsp;on&nbsp;the&nbsp;defer&nbsp;stack.&nbsp;If&nbsp;you&nbsp;have:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688215">//</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688219">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;1&nbsp;defers&nbsp;d1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688241">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;2&nbsp;defers&nbsp;d2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688263">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;3&nbsp;defers&nbsp;d3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688285">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;4&nbsp;panics</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688304">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;4&#39;s&nbsp;panic&nbsp;starts&nbsp;running&nbsp;defers</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688346">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;5,&nbsp;running&nbsp;d3,&nbsp;defers&nbsp;d4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688381">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;5&nbsp;panics</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688400">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;5&#39;s&nbsp;panic&nbsp;starts&nbsp;running&nbsp;defers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688442">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;6,&nbsp;running&nbsp;d4,&nbsp;garbage&nbsp;collects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688484">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;6,&nbsp;running&nbsp;d2,&nbsp;garbage&nbsp;collects</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688526">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688530">//&nbsp;During&nbsp;the&nbsp;execution&nbsp;of&nbsp;d4,&nbsp;the&nbsp;panic&nbsp;stack&nbsp;is&nbsp;d4&nbsp;-&gt;&nbsp;d3,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688597">//&nbsp;is&nbsp;nested&nbsp;properly,&nbsp;and&nbsp;we&#39;ll&nbsp;treat&nbsp;frame&nbsp;3&nbsp;as&nbsp;resumable,&nbsp;because&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688670">//&nbsp;can&nbsp;find&nbsp;d3.&nbsp;(And&nbsp;in&nbsp;fact&nbsp;frame&nbsp;3&nbsp;is&nbsp;resumable.&nbsp;If&nbsp;d4&nbsp;recovers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688737">//&nbsp;and&nbsp;frame&nbsp;5&nbsp;continues&nbsp;running,&nbsp;d3,&nbsp;d3&nbsp;can&nbsp;recover&nbsp;and&nbsp;we&#39;ll</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688801">//&nbsp;resume&nbsp;execution&nbsp;in&nbsp;(returning&nbsp;from)&nbsp;frame&nbsp;3.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688852">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688856">//&nbsp;During&nbsp;the&nbsp;execution&nbsp;of&nbsp;d2,&nbsp;however,&nbsp;the&nbsp;panic&nbsp;stack&nbsp;is&nbsp;d2&nbsp;-&gt;&nbsp;d3,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688926">//&nbsp;which&nbsp;is&nbsp;inverted.&nbsp;The&nbsp;scan&nbsp;will&nbsp;match&nbsp;d2&nbsp;to&nbsp;frame&nbsp;2&nbsp;but&nbsp;having</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1688994">//&nbsp;d2&nbsp;on&nbsp;the&nbsp;stack&nbsp;until&nbsp;then&nbsp;means&nbsp;it&nbsp;will&nbsp;not&nbsp;match&nbsp;d3&nbsp;to&nbsp;frame&nbsp;3.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1689064">//&nbsp;This&nbsp;is&nbsp;okay:&nbsp;if&nbsp;we&#39;re&nbsp;running&nbsp;d2,&nbsp;then&nbsp;all&nbsp;the&nbsp;defers&nbsp;after&nbsp;d2&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1689137">//&nbsp;completed&nbsp;and&nbsp;their&nbsp;corresponding&nbsp;frames&nbsp;are&nbsp;dead.&nbsp;Not&nbsp;finding&nbsp;d3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1689207">//&nbsp;for&nbsp;frame&nbsp;3&nbsp;means&nbsp;we&#39;ll&nbsp;set&nbsp;frame&nbsp;3&#39;s&nbsp;continpc&nbsp;==&nbsp;0,&nbsp;which&nbsp;is&nbsp;correct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1689281">//&nbsp;(frame&nbsp;3&nbsp;is&nbsp;dead).&nbsp;At&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;walk&nbsp;the&nbsp;panic&nbsp;stack&nbsp;can&nbsp;thus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1689352">//&nbsp;contain&nbsp;defers&nbsp;(d3&nbsp;in&nbsp;this&nbsp;case)&nbsp;for&nbsp;dead&nbsp;frames.&nbsp;The&nbsp;inversion&nbsp;here</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1689425">//&nbsp;always&nbsp;indicates&nbsp;a&nbsp;dead&nbsp;frame,&nbsp;and&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;inversion&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1689499">//&nbsp;scan&nbsp;is&nbsp;to&nbsp;hide&nbsp;those&nbsp;dead&nbsp;frames,&nbsp;so&nbsp;the&nbsp;scan&nbsp;is&nbsp;still&nbsp;okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1689565">//&nbsp;what&#39;s&nbsp;left&nbsp;on&nbsp;the&nbsp;panic&nbsp;stack&nbsp;are&nbsp;exactly&nbsp;(and&nbsp;only)&nbsp;the&nbsp;dead&nbsp;frames.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1689640">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1689644">//&nbsp;We&nbsp;require&nbsp;callback&nbsp;!=&nbsp;nil&nbsp;here&nbsp;because&nbsp;only&nbsp;when&nbsp;callback&nbsp;!=&nbsp;nil</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1689714">//&nbsp;do&nbsp;we&nbsp;know&nbsp;that&nbsp;gentraceback&nbsp;is&nbsp;being&nbsp;called&nbsp;in&nbsp;a&nbsp;&#34;must&nbsp;be&nbsp;correct&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1689786">//&nbsp;context&nbsp;as&nbsp;opposed&nbsp;to&nbsp;a&nbsp;&#34;best&nbsp;effort&#34;&nbsp;context.&nbsp;The&nbsp;tracebacks&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1689857">//&nbsp;callbacks&nbsp;only&nbsp;happen&nbsp;when&nbsp;everything&nbsp;is&nbsp;stopped&nbsp;nicely.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1689918">//&nbsp;At&nbsp;other&nbsp;times,&nbsp;such&nbsp;as&nbsp;when&nbsp;gathering&nbsp;a&nbsp;stack&nbsp;for&nbsp;a&nbsp;profiling&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1689992">//&nbsp;or&nbsp;when&nbsp;printing&nbsp;a&nbsp;traceback&nbsp;during&nbsp;a&nbsp;crash,&nbsp;everything&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1690063">//&nbsp;stopped&nbsp;nicely,&nbsp;and&nbsp;the&nbsp;stack&nbsp;walk&nbsp;may&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;complete.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1690131">//&nbsp;It&#39;s&nbsp;okay&nbsp;in&nbsp;those&nbsp;situations&nbsp;not&nbsp;to&nbsp;use&nbsp;up&nbsp;the&nbsp;entire&nbsp;defer&nbsp;stack:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1690203">//&nbsp;incomplete&nbsp;information&nbsp;then&nbsp;is&nbsp;still&nbsp;better&nbsp;than&nbsp;nothing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1690265">if</span>&nbsp;<span class="ident" id="1690268">callback</span>&nbsp;<span class="op" id="1690277">!=</span>&nbsp;<span class="builtintype" id="1690280">nil</span>&nbsp;<span class="op" id="1690284">&amp;&amp;</span>&nbsp;<span class="ident" id="1690287">n</span>&nbsp;<span class="op" id="1690289">&lt;</span>&nbsp;<span class="ident" id="1690291">max</span>&nbsp;<span class="op" id="1690295">&amp;&amp;</span>&nbsp;<span class="ident" id="1690298">_defer</span>&nbsp;<span class="op" id="1690305">!=</span>&nbsp;<span class="builtintype" id="1690308">nil</span>&nbsp;<span class="op" id="1690312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1690316">if</span>&nbsp;<span class="ident" id="1690319">_defer</span>&nbsp;<span class="op" id="1690326">!=</span>&nbsp;<span class="builtintype" id="1690329">nil</span>&nbsp;<span class="op" id="1690333">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1690338">print</span><span class="op" id="1690343">(</span><span class="string" id="1690344">&#34;runtime:&nbsp;g&#34;</span><span class="op" id="1690356">,</span>&nbsp;<span class="ident" id="1690358">gp</span><span class="op" id="1690360">.</span><span class="ident" id="1690361">goid</span><span class="op" id="1690365">,</span>&nbsp;<span class="string" id="1690367">&#34;:&nbsp;leftover&nbsp;defer&nbsp;argp=&#34;</span><span class="op" id="1690391">,</span>&nbsp;<span class="ident" id="1690393">hex</span><span class="op" id="1690396">(</span><span class="ident" id="1690397">_defer</span><span class="op" id="1690403">.</span><span class="ident" id="1690404">argp</span><span class="op" id="1690408">)</span><span class="op" id="1690409">,</span>&nbsp;<span class="string" id="1690411">&#34;&nbsp;pc=&#34;</span><span class="op" id="1690417">,</span>&nbsp;<span class="ident" id="1690419">hex</span><span class="op" id="1690422">(</span><span class="ident" id="1690423">_defer</span><span class="op" id="1690429">.</span><span class="ident" id="1690430">pc</span><span class="op" id="1690432">)</span><span class="op" id="1690433">,</span>&nbsp;<span class="string" id="1690435">&#34;\n&#34;</span><span class="op" id="1690439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1690443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1690447">for</span>&nbsp;<span class="ident" id="1690451">_defer</span>&nbsp;<span class="op" id="1690458">=</span>&nbsp;<span class="ident" id="1690460">gp</span><span class="op" id="1690462">.</span><span class="ident" id="1690463">_defer</span><span class="op" id="1690469">;</span>&nbsp;<span class="ident" id="1690471">_defer</span>&nbsp;<span class="op" id="1690478">!=</span>&nbsp;<span class="builtintype" id="1690481">nil</span><span class="op" id="1690484">;</span>&nbsp;<span class="ident" id="1690486">_defer</span>&nbsp;<span class="op" id="1690493">=</span>&nbsp;<span class="ident" id="1690495">_defer</span><span class="op" id="1690501">.</span><span class="ident" id="1690502">link</span>&nbsp;<span class="op" id="1690507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1690512">print</span><span class="op" id="1690517">(</span><span class="string" id="1690518">&#34;\tdefer&nbsp;&#34;</span><span class="op" id="1690528">,</span>&nbsp;<span class="ident" id="1690530">_defer</span><span class="op" id="1690536">,</span>&nbsp;<span class="string" id="1690538">&#34;&nbsp;argp=&#34;</span><span class="op" id="1690546">,</span>&nbsp;<span class="ident" id="1690548">hex</span><span class="op" id="1690551">(</span><span class="ident" id="1690552">_defer</span><span class="op" id="1690558">.</span><span class="ident" id="1690559">argp</span><span class="op" id="1690563">)</span><span class="op" id="1690564">,</span>&nbsp;<span class="string" id="1690566">&#34;&nbsp;pc=&#34;</span><span class="op" id="1690572">,</span>&nbsp;<span class="ident" id="1690574">hex</span><span class="op" id="1690577">(</span><span class="ident" id="1690578">_defer</span><span class="op" id="1690584">.</span><span class="ident" id="1690585">pc</span><span class="op" id="1690587">)</span><span class="op" id="1690588">,</span>&nbsp;<span class="string" id="1690590">&#34;\n&#34;</span><span class="op" id="1690594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1690598">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1690602">gothrow</span><span class="op" id="1690609">(</span><span class="string" id="1690610">&#34;traceback&nbsp;has&nbsp;leftover&nbsp;defers&#34;</span><span class="op" id="1690641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1690644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1690648">return</span>&nbsp;<span class="ident" id="1690655">n</span><br>
<span class="lineno"></span><span class="op" id="1690657">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword" id="1690660">func</span>&nbsp;<span class="ident" id="1690665">setArgInfo</span><span class="op" id="1690675">(</span><span class="ident" id="1690676">frame</span>&nbsp;<span class="op" id="1690682">*</span><span class="ident" id="1690683">stkframe</span><span class="op" id="1690691">,</span>&nbsp;<span class="ident" id="1690693">f</span>&nbsp;<span class="op" id="1690695">*</span><span class="ident" id="1690696">_func</span><span class="op" id="1690701">,</span>&nbsp;<span class="ident" id="1690703">needArgMap</span>&nbsp;<span class="builtintype" id="1690714">bool</span><span class="op" id="1690718">)</span>&nbsp;<span class="op" id="1690720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1690723">frame</span><span class="op" id="1690728">.</span><span class="ident" id="1690729">arglen</span>&nbsp;<span class="op" id="1690736">=</span>&nbsp;<span class="builtintype" id="1690738">uintptr</span><span class="op" id="1690745">(</span><span class="ident" id="1690746">f</span><span class="op" id="1690747">.</span><span class="ident" id="1690748">args</span><span class="op" id="1690752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1690755">if</span>&nbsp;<span class="ident" id="1690758">needArgMap</span>&nbsp;<span class="op" id="1690769">&amp;&amp;</span>&nbsp;<span class="ident" id="1690772">f</span><span class="op" id="1690773">.</span><span class="ident" id="1690774">args</span>&nbsp;<span class="op" id="1690779">==</span>&nbsp;<span class="ident" id="1690782">_ArgsSizeUnknown</span>&nbsp;<span class="op" id="1690799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1690803">//&nbsp;Extract&nbsp;argument&nbsp;bitmaps&nbsp;for&nbsp;reflect&nbsp;stubs&nbsp;from&nbsp;the&nbsp;calls&nbsp;they&nbsp;made&nbsp;to&nbsp;reflect.</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1690888">switch</span>&nbsp;<span class="ident" id="1690895">gofuncname</span><span class="op" id="1690905">(</span><span class="ident" id="1690906">f</span><span class="op" id="1690907">)</span>&nbsp;<span class="op" id="1690909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1690913">case</span>&nbsp;<span class="string" id="1690918">&#34;reflect.makeFuncStub&#34;</span><span class="op" id="1690940">,</span>&nbsp;<span class="string" id="1690942">&#34;reflect.methodValueCall&#34;</span><span class="op" id="1690967">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1690972">arg0</span>&nbsp;<span class="op" id="1690977">:=</span>&nbsp;<span class="ident" id="1690980">frame</span><span class="op" id="1690985">.</span><span class="ident" id="1690986">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1690992">if</span>&nbsp;<span class="ident" id="1690995">usesLR</span>&nbsp;<span class="op" id="1691002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1691008">arg0</span>&nbsp;<span class="op" id="1691013">+=</span>&nbsp;<span class="ident" id="1691016">ptrSize</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1691027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1691032">fn</span>&nbsp;<span class="op" id="1691035">:=</span>&nbsp;<span class="op" id="1691038">*</span><span class="op" id="1691039">(</span><span class="op" id="1691040">*</span><span class="op" id="1691041">*</span><span class="op" id="1691042">[</span><span class="num" id="1691043">2</span><span class="op" id="1691044">]</span><span class="builtintype" id="1691045">uintptr</span><span class="op" id="1691052">)</span><span class="op" id="1691053">(</span><span class="ident" id="1691054">unsafe</span><span class="op" id="1691060">.</span><span class="ident" id="1691061">Pointer</span><span class="op" id="1691068">(</span><span class="ident" id="1691069">arg0</span><span class="op" id="1691073">)</span><span class="op" id="1691074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1691079">if</span>&nbsp;<span class="ident" id="1691082">fn</span><span class="op" id="1691084">[</span><span class="num" id="1691085">0</span><span class="op" id="1691086">]</span>&nbsp;<span class="op" id="1691088">!=</span>&nbsp;<span class="ident" id="1691091">f</span><span class="op" id="1691092">.</span><span class="ident" id="1691093">entry</span>&nbsp;<span class="op" id="1691099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1691105">print</span><span class="op" id="1691110">(</span><span class="string" id="1691111">&#34;runtime:&nbsp;confused&nbsp;by&nbsp;&#34;</span><span class="op" id="1691134">,</span>&nbsp;<span class="ident" id="1691136">gofuncname</span><span class="op" id="1691146">(</span><span class="ident" id="1691147">f</span><span class="op" id="1691148">)</span><span class="op" id="1691149">,</span>&nbsp;<span class="string" id="1691151">&#34;\n&#34;</span><span class="op" id="1691155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1691161">gothrow</span><span class="op" id="1691168">(</span><span class="string" id="1691169">&#34;reflect&nbsp;mismatch&#34;</span><span class="op" id="1691187">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1691192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1691197">bv</span>&nbsp;<span class="op" id="1691200">:=</span>&nbsp;<span class="op" id="1691203">(</span><span class="op" id="1691204">*</span><span class="ident" id="1691205">bitvector</span><span class="op" id="1691214">)</span><span class="op" id="1691215">(</span><span class="ident" id="1691216">unsafe</span><span class="op" id="1691222">.</span><span class="ident" id="1691223">Pointer</span><span class="op" id="1691230">(</span><span class="ident" id="1691231">fn</span><span class="op" id="1691233">[</span><span class="num" id="1691234">1</span><span class="op" id="1691235">]</span><span class="op" id="1691236">)</span><span class="op" id="1691237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1691242">frame</span><span class="op" id="1691247">.</span><span class="ident" id="1691248">arglen</span>&nbsp;<span class="op" id="1691255">=</span>&nbsp;<span class="builtintype" id="1691257">uintptr</span><span class="op" id="1691264">(</span><span class="ident" id="1691265">bv</span><span class="op" id="1691267">.</span><span class="ident" id="1691268">n</span>&nbsp;<span class="op" id="1691270">/</span>&nbsp;<span class="num" id="1691272">2</span>&nbsp;<span class="op" id="1691274">*</span>&nbsp;<span class="ident" id="1691276">ptrSize</span><span class="op" id="1691283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1691288">frame</span><span class="op" id="1691293">.</span><span class="ident" id="1691294">argmap</span>&nbsp;<span class="op" id="1691301">=</span>&nbsp;<span class="ident" id="1691303">bv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1691308">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1691311">}</span><br>
<span class="lineno"></span><span class="op" id="1691313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1691316">func</span>&nbsp;<span class="ident" id="1691321">printcreatedby</span><span class="op" id="1691335">(</span><span class="ident" id="1691336">gp</span>&nbsp;<span class="op" id="1691339">*</span><span class="ident" id="1691340">g</span><span class="op" id="1691341">)</span>&nbsp;<span class="op" id="1691343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1691346">//&nbsp;Show&nbsp;what&nbsp;created&nbsp;goroutine,&nbsp;except&nbsp;main&nbsp;goroutine&nbsp;(goid&nbsp;1).</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1691411">pc</span>&nbsp;<span class="op" id="1691414">:=</span>&nbsp;<span class="ident" id="1691417">gp</span><span class="op" id="1691419">.</span><span class="ident" id="1691420">gopc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1691426">f</span>&nbsp;<span class="op" id="1691428">:=</span>&nbsp;<span class="ident" id="1691431">findfunc</span><span class="op" id="1691439">(</span><span class="ident" id="1691440">pc</span><span class="op" id="1691442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1691445">if</span>&nbsp;<span class="ident" id="1691448">f</span>&nbsp;<span class="op" id="1691450">!=</span>&nbsp;<span class="builtintype" id="1691453">nil</span>&nbsp;<span class="op" id="1691457">&amp;&amp;</span>&nbsp;<span class="ident" id="1691460">showframe</span><span class="op" id="1691469">(</span><span class="ident" id="1691470">f</span><span class="op" id="1691471">,</span>&nbsp;<span class="ident" id="1691473">gp</span><span class="op" id="1691475">)</span>&nbsp;<span class="op" id="1691477">&amp;&amp;</span>&nbsp;<span class="ident" id="1691480">gp</span><span class="op" id="1691482">.</span><span class="ident" id="1691483">goid</span>&nbsp;<span class="op" id="1691488">!=</span>&nbsp;<span class="num" id="1691491">1</span>&nbsp;<span class="op" id="1691493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1691497">print</span><span class="op" id="1691502">(</span><span class="string" id="1691503">&#34;created&nbsp;by&nbsp;&#34;</span><span class="op" id="1691516">,</span>&nbsp;<span class="ident" id="1691518">gofuncname</span><span class="op" id="1691528">(</span><span class="ident" id="1691529">f</span><span class="op" id="1691530">)</span><span class="op" id="1691531">,</span>&nbsp;<span class="string" id="1691533">&#34;\n&#34;</span><span class="op" id="1691537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1691541">tracepc</span>&nbsp;<span class="op" id="1691549">:=</span>&nbsp;<span class="ident" id="1691552">pc</span>&nbsp;<span class="comment" id="1691555">//&nbsp;back&nbsp;up&nbsp;to&nbsp;CALL&nbsp;instruction&nbsp;for&nbsp;funcline.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1691602">if</span>&nbsp;<span class="ident" id="1691605">pc</span>&nbsp;<span class="op" id="1691608">&gt;</span>&nbsp;<span class="ident" id="1691610">f</span><span class="op" id="1691611">.</span><span class="ident" id="1691612">entry</span>&nbsp;<span class="op" id="1691618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1691623">tracepc</span>&nbsp;<span class="op" id="1691631">-=</span>&nbsp;<span class="ident" id="1691634">_PCQuantum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1691647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1691651">var</span>&nbsp;<span class="ident" id="1691655">file</span>&nbsp;<span class="builtintype" id="1691660">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1691669">line</span>&nbsp;<span class="op" id="1691674">:=</span>&nbsp;<span class="ident" id="1691677">funcline</span><span class="op" id="1691685">(</span><span class="ident" id="1691686">f</span><span class="op" id="1691687">,</span>&nbsp;<span class="ident" id="1691689">tracepc</span><span class="op" id="1691696">,</span>&nbsp;<span class="op" id="1691698">&amp;</span><span class="ident" id="1691699">file</span><span class="op" id="1691703">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1691707">print</span><span class="op" id="1691712">(</span><span class="string" id="1691713">&#34;\t&#34;</span><span class="op" id="1691717">,</span>&nbsp;<span class="ident" id="1691719">file</span><span class="op" id="1691723">,</span>&nbsp;<span class="string" id="1691725">&#34;:&#34;</span><span class="op" id="1691728">,</span>&nbsp;<span class="ident" id="1691730">line</span><span class="op" id="1691734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1691738">if</span>&nbsp;<span class="ident" id="1691741">pc</span>&nbsp;<span class="op" id="1691744">&gt;</span>&nbsp;<span class="ident" id="1691746">f</span><span class="op" id="1691747">.</span><span class="ident" id="1691748">entry</span>&nbsp;<span class="op" id="1691754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1691759">print</span><span class="op" id="1691764">(</span><span class="string" id="1691765">&#34;&nbsp;+&#34;</span><span class="op" id="1691769">,</span>&nbsp;<span class="ident" id="1691771">hex</span><span class="op" id="1691774">(</span><span class="ident" id="1691775">pc</span><span class="op" id="1691777">-</span><span class="ident" id="1691778">f</span><span class="op" id="1691779">.</span><span class="ident" id="1691780">entry</span><span class="op" id="1691785">)</span><span class="op" id="1691786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1691790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1691794">print</span><span class="op" id="1691799">(</span><span class="string" id="1691800">&#34;\n&#34;</span><span class="op" id="1691804">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1691807">}</span><br>
<span class="lineno"></span><span class="op" id="1691809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1691812">func</span>&nbsp;<span class="ident" id="1691817">traceback</span><span class="op" id="1691826">(</span><span class="ident" id="1691827">pc</span>&nbsp;<span class="builtintype" id="1691830">uintptr</span><span class="op" id="1691837">,</span>&nbsp;<span class="ident" id="1691839">sp</span>&nbsp;<span class="builtintype" id="1691842">uintptr</span><span class="op" id="1691849">,</span>&nbsp;<span class="ident" id="1691851">lr</span>&nbsp;<span class="builtintype" id="1691854">uintptr</span><span class="op" id="1691861">,</span>&nbsp;<span class="ident" id="1691863">gp</span>&nbsp;<span class="op" id="1691866">*</span><span class="ident" id="1691867">g</span><span class="op" id="1691868">)</span>&nbsp;<span class="op" id="1691870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1691873">traceback1</span><span class="op" id="1691883">(</span><span class="ident" id="1691884">pc</span><span class="op" id="1691886">,</span>&nbsp;<span class="ident" id="1691888">sp</span><span class="op" id="1691890">,</span>&nbsp;<span class="ident" id="1691892">lr</span><span class="op" id="1691894">,</span>&nbsp;<span class="ident" id="1691896">gp</span><span class="op" id="1691898">,</span>&nbsp;<span class="num" id="1691900">0</span><span class="op" id="1691901">)</span><br>
<span class="lineno">495</span><span class="op" id="1691903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1691906">//&nbsp;tracebacktrap&nbsp;is&nbsp;like&nbsp;traceback&nbsp;but&nbsp;expects&nbsp;that&nbsp;the&nbsp;PC&nbsp;and&nbsp;SP&nbsp;were&nbsp;obtained</span><br>
<span class="lineno"></span><span class="comment" id="1691986">//&nbsp;from&nbsp;a&nbsp;trap,&nbsp;not&nbsp;from&nbsp;gp-&gt;sched&nbsp;or&nbsp;gp-&gt;syscallpc/gp-&gt;syscallsp&nbsp;or&nbsp;getcallerpc/getcallersp.</span><br>
<span class="lineno"></span><span class="comment" id="1692080">//&nbsp;Because&nbsp;they&nbsp;are&nbsp;from&nbsp;a&nbsp;trap&nbsp;instead&nbsp;of&nbsp;from&nbsp;a&nbsp;saved&nbsp;pair,</span><br>
<span class="lineno">500</span><span class="comment" id="1692142">//&nbsp;the&nbsp;initial&nbsp;PC&nbsp;must&nbsp;not&nbsp;be&nbsp;rewound&nbsp;to&nbsp;the&nbsp;previous&nbsp;instruction.</span><br>
<span class="lineno"></span><span class="comment" id="1692209">//&nbsp;(All&nbsp;the&nbsp;saved&nbsp;pairs&nbsp;record&nbsp;a&nbsp;PC&nbsp;that&nbsp;is&nbsp;a&nbsp;return&nbsp;address,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="1692277">//&nbsp;rewind&nbsp;it&nbsp;into&nbsp;the&nbsp;CALL&nbsp;instruction.)</span><br>
<span class="lineno"></span><span class="keyword" id="1692318">func</span>&nbsp;<span class="ident" id="1692323">tracebacktrap</span><span class="op" id="1692336">(</span><span class="ident" id="1692337">pc</span>&nbsp;<span class="builtintype" id="1692340">uintptr</span><span class="op" id="1692347">,</span>&nbsp;<span class="ident" id="1692349">sp</span>&nbsp;<span class="builtintype" id="1692352">uintptr</span><span class="op" id="1692359">,</span>&nbsp;<span class="ident" id="1692361">lr</span>&nbsp;<span class="builtintype" id="1692364">uintptr</span><span class="op" id="1692371">,</span>&nbsp;<span class="ident" id="1692373">gp</span>&nbsp;<span class="op" id="1692376">*</span><span class="ident" id="1692377">g</span><span class="op" id="1692378">)</span>&nbsp;<span class="op" id="1692380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1692383">traceback1</span><span class="op" id="1692393">(</span><span class="ident" id="1692394">pc</span><span class="op" id="1692396">,</span>&nbsp;<span class="ident" id="1692398">sp</span><span class="op" id="1692400">,</span>&nbsp;<span class="ident" id="1692402">lr</span><span class="op" id="1692404">,</span>&nbsp;<span class="ident" id="1692406">gp</span><span class="op" id="1692408">,</span>&nbsp;<span class="ident" id="1692410">_TraceTrap</span><span class="op" id="1692420">)</span><br>
<span class="lineno">505</span><span class="op" id="1692422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1692425">func</span>&nbsp;<span class="ident" id="1692430">traceback1</span><span class="op" id="1692440">(</span><span class="ident" id="1692441">pc</span>&nbsp;<span class="builtintype" id="1692444">uintptr</span><span class="op" id="1692451">,</span>&nbsp;<span class="ident" id="1692453">sp</span>&nbsp;<span class="builtintype" id="1692456">uintptr</span><span class="op" id="1692463">,</span>&nbsp;<span class="ident" id="1692465">lr</span>&nbsp;<span class="builtintype" id="1692468">uintptr</span><span class="op" id="1692475">,</span>&nbsp;<span class="ident" id="1692477">gp</span>&nbsp;<span class="op" id="1692480">*</span><span class="ident" id="1692481">g</span><span class="op" id="1692482">,</span>&nbsp;<span class="ident" id="1692484">flags</span>&nbsp;<span class="builtintype" id="1692490">uint</span><span class="op" id="1692494">)</span>&nbsp;<span class="op" id="1692496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1692499">var</span>&nbsp;<span class="ident" id="1692503">n</span>&nbsp;<span class="builtintype" id="1692505">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1692510">if</span>&nbsp;<span class="ident" id="1692513">readgstatus</span><span class="op" id="1692524">(</span><span class="ident" id="1692525">gp</span><span class="op" id="1692527">)</span><span class="op" id="1692528">&amp;^</span><span class="ident" id="1692530">_Gscan</span>&nbsp;<span class="op" id="1692537">==</span>&nbsp;<span class="ident" id="1692540">_Gsyscall</span>&nbsp;<span class="op" id="1692550">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1692554">//&nbsp;Override&nbsp;registers&nbsp;if&nbsp;blocked&nbsp;in&nbsp;system&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1692605">pc</span>&nbsp;<span class="op" id="1692608">=</span>&nbsp;<span class="ident" id="1692610">gp</span><span class="op" id="1692612">.</span><span class="ident" id="1692613">syscallpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1692625">sp</span>&nbsp;<span class="op" id="1692628">=</span>&nbsp;<span class="ident" id="1692630">gp</span><span class="op" id="1692632">.</span><span class="ident" id="1692633">syscallsp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1692645">flags</span>&nbsp;<span class="op" id="1692651">&amp;^=</span>&nbsp;<span class="ident" id="1692655">_TraceTrap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1692667">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1692670">//&nbsp;Print&nbsp;traceback.&nbsp;By&nbsp;default,&nbsp;omits&nbsp;runtime&nbsp;frames.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1692725">//&nbsp;If&nbsp;that&nbsp;means&nbsp;we&nbsp;print&nbsp;nothing&nbsp;at&nbsp;all,&nbsp;repeat&nbsp;forcing&nbsp;all&nbsp;frames&nbsp;printed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1692803">n</span>&nbsp;<span class="op" id="1692805">=</span>&nbsp;<span class="ident" id="1692807">gentraceback</span><span class="op" id="1692819">(</span><span class="ident" id="1692820">pc</span><span class="op" id="1692822">,</span>&nbsp;<span class="ident" id="1692824">sp</span><span class="op" id="1692826">,</span>&nbsp;<span class="ident" id="1692828">lr</span><span class="op" id="1692830">,</span>&nbsp;<span class="ident" id="1692832">gp</span><span class="op" id="1692834">,</span>&nbsp;<span class="num" id="1692836">0</span><span class="op" id="1692837">,</span>&nbsp;<span class="builtintype" id="1692839">nil</span><span class="op" id="1692842">,</span>&nbsp;<span class="ident" id="1692844">_TracebackMaxFrames</span><span class="op" id="1692863">,</span>&nbsp;<span class="builtintype" id="1692865">nil</span><span class="op" id="1692868">,</span>&nbsp;<span class="builtintype" id="1692870">nil</span><span class="op" id="1692873">,</span>&nbsp;<span class="ident" id="1692875">flags</span><span class="op" id="1692880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1692883">if</span>&nbsp;<span class="ident" id="1692886">n</span>&nbsp;<span class="op" id="1692888">==</span>&nbsp;<span class="num" id="1692891">0</span>&nbsp;<span class="op" id="1692893">&amp;&amp;</span>&nbsp;<span class="op" id="1692896">(</span><span class="ident" id="1692897">flags</span><span class="op" id="1692902">&amp;</span><span class="ident" id="1692903">_TraceRuntimeFrames</span><span class="op" id="1692922">)</span>&nbsp;<span class="op" id="1692924">==</span>&nbsp;<span class="num" id="1692927">0</span>&nbsp;<span class="op" id="1692929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1692933">n</span>&nbsp;<span class="op" id="1692935">=</span>&nbsp;<span class="ident" id="1692937">gentraceback</span><span class="op" id="1692949">(</span><span class="ident" id="1692950">pc</span><span class="op" id="1692952">,</span>&nbsp;<span class="ident" id="1692954">sp</span><span class="op" id="1692956">,</span>&nbsp;<span class="ident" id="1692958">lr</span><span class="op" id="1692960">,</span>&nbsp;<span class="ident" id="1692962">gp</span><span class="op" id="1692964">,</span>&nbsp;<span class="num" id="1692966">0</span><span class="op" id="1692967">,</span>&nbsp;<span class="builtintype" id="1692969">nil</span><span class="op" id="1692972">,</span>&nbsp;<span class="ident" id="1692974">_TracebackMaxFrames</span><span class="op" id="1692993">,</span>&nbsp;<span class="builtintype" id="1692995">nil</span><span class="op" id="1692998">,</span>&nbsp;<span class="builtintype" id="1693000">nil</span><span class="op" id="1693003">,</span>&nbsp;<span class="ident" id="1693005">flags</span><span class="op" id="1693010">|</span><span class="ident" id="1693011">_TraceRuntimeFrames</span><span class="op" id="1693030">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1693033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1693036">if</span>&nbsp;<span class="ident" id="1693039">n</span>&nbsp;<span class="op" id="1693041">==</span>&nbsp;<span class="ident" id="1693044">_TracebackMaxFrames</span>&nbsp;<span class="op" id="1693064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1693068">print</span><span class="op" id="1693073">(</span><span class="string" id="1693074">&#34;...additional&nbsp;frames&nbsp;elided...\n&#34;</span><span class="op" id="1693108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1693111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1693114">printcreatedby</span><span class="op" id="1693128">(</span><span class="ident" id="1693129">gp</span><span class="op" id="1693131">)</span><br>
<span class="lineno">525</span><span class="op" id="1693133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1693136">func</span>&nbsp;<span class="ident" id="1693141">callers</span><span class="op" id="1693148">(</span><span class="ident" id="1693149">skip</span>&nbsp;<span class="builtintype" id="1693154">int</span><span class="op" id="1693157">,</span>&nbsp;<span class="ident" id="1693159">pcbuf</span>&nbsp;<span class="op" id="1693165">*</span><span class="builtintype" id="1693166">uintptr</span><span class="op" id="1693173">,</span>&nbsp;<span class="ident" id="1693175">m</span>&nbsp;<span class="builtintype" id="1693177">int</span><span class="op" id="1693180">)</span>&nbsp;<span class="builtintype" id="1693182">int</span>&nbsp;<span class="op" id="1693186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1693189">sp</span>&nbsp;<span class="op" id="1693192">:=</span>&nbsp;<span class="ident" id="1693195">getcallersp</span><span class="op" id="1693206">(</span><span class="ident" id="1693207">unsafe</span><span class="op" id="1693213">.</span><span class="ident" id="1693214">Pointer</span><span class="op" id="1693221">(</span><span class="op" id="1693222">&amp;</span><span class="ident" id="1693223">skip</span><span class="op" id="1693227">)</span><span class="op" id="1693228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1693231">pc</span>&nbsp;<span class="op" id="1693234">:=</span>&nbsp;<span class="builtintype" id="1693237">uintptr</span><span class="op" id="1693244">(</span><span class="ident" id="1693245">getcallerpc</span><span class="op" id="1693256">(</span><span class="ident" id="1693257">unsafe</span><span class="op" id="1693263">.</span><span class="ident" id="1693264">Pointer</span><span class="op" id="1693271">(</span><span class="op" id="1693272">&amp;</span><span class="ident" id="1693273">skip</span><span class="op" id="1693277">)</span><span class="op" id="1693278">)</span><span class="op" id="1693279">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1693282">var</span>&nbsp;<span class="ident" id="1693286">n</span>&nbsp;<span class="builtintype" id="1693288">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1693293">onM</span><span class="op" id="1693296">(</span><span class="keyword" id="1693297">func</span><span class="op" id="1693301">(</span><span class="op" id="1693302">)</span>&nbsp;<span class="op" id="1693304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1693308">n</span>&nbsp;<span class="op" id="1693310">=</span>&nbsp;<span class="ident" id="1693312">gentraceback</span><span class="op" id="1693324">(</span><span class="ident" id="1693325">pc</span><span class="op" id="1693327">,</span>&nbsp;<span class="ident" id="1693329">sp</span><span class="op" id="1693331">,</span>&nbsp;<span class="num" id="1693333">0</span><span class="op" id="1693334">,</span>&nbsp;<span class="ident" id="1693336">getg</span><span class="op" id="1693340">(</span><span class="op" id="1693341">)</span><span class="op" id="1693342">,</span>&nbsp;<span class="ident" id="1693344">skip</span><span class="op" id="1693348">,</span>&nbsp;<span class="ident" id="1693350">pcbuf</span><span class="op" id="1693355">,</span>&nbsp;<span class="ident" id="1693357">m</span><span class="op" id="1693358">,</span>&nbsp;<span class="builtintype" id="1693360">nil</span><span class="op" id="1693363">,</span>&nbsp;<span class="builtintype" id="1693365">nil</span><span class="op" id="1693368">,</span>&nbsp;<span class="num" id="1693370">0</span><span class="op" id="1693371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1693374">}</span><span class="op" id="1693375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1693378">return</span>&nbsp;<span class="ident" id="1693385">n</span><br>
<span class="lineno">535</span><span class="op" id="1693387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1693390">func</span>&nbsp;<span class="ident" id="1693395">gcallers</span><span class="op" id="1693403">(</span><span class="ident" id="1693404">gp</span>&nbsp;<span class="op" id="1693407">*</span><span class="ident" id="1693408">g</span><span class="op" id="1693409">,</span>&nbsp;<span class="ident" id="1693411">skip</span>&nbsp;<span class="builtintype" id="1693416">int</span><span class="op" id="1693419">,</span>&nbsp;<span class="ident" id="1693421">pcbuf</span>&nbsp;<span class="op" id="1693427">*</span><span class="builtintype" id="1693428">uintptr</span><span class="op" id="1693435">,</span>&nbsp;<span class="ident" id="1693437">m</span>&nbsp;<span class="builtintype" id="1693439">int</span><span class="op" id="1693442">)</span>&nbsp;<span class="builtintype" id="1693444">int</span>&nbsp;<span class="op" id="1693448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1693451">return</span>&nbsp;<span class="ident" id="1693458">gentraceback</span><span class="op" id="1693470">(</span><span class="op" id="1693471">^</span><span class="builtintype" id="1693472">uintptr</span><span class="op" id="1693479">(</span><span class="num" id="1693480">0</span><span class="op" id="1693481">)</span><span class="op" id="1693482">,</span>&nbsp;<span class="op" id="1693484">^</span><span class="builtintype" id="1693485">uintptr</span><span class="op" id="1693492">(</span><span class="num" id="1693493">0</span><span class="op" id="1693494">)</span><span class="op" id="1693495">,</span>&nbsp;<span class="num" id="1693497">0</span><span class="op" id="1693498">,</span>&nbsp;<span class="ident" id="1693500">gp</span><span class="op" id="1693502">,</span>&nbsp;<span class="ident" id="1693504">skip</span><span class="op" id="1693508">,</span>&nbsp;<span class="ident" id="1693510">pcbuf</span><span class="op" id="1693515">,</span>&nbsp;<span class="ident" id="1693517">m</span><span class="op" id="1693518">,</span>&nbsp;<span class="builtintype" id="1693520">nil</span><span class="op" id="1693523">,</span>&nbsp;<span class="builtintype" id="1693525">nil</span><span class="op" id="1693528">,</span>&nbsp;<span class="num" id="1693530">0</span><span class="op" id="1693531">)</span><br>
<span class="lineno"></span><span class="op" id="1693533">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="1693536">func</span>&nbsp;<span class="ident" id="1693541">showframe</span><span class="op" id="1693550">(</span><span class="ident" id="1693551">f</span>&nbsp;<span class="op" id="1693553">*</span><span class="ident" id="1693554">_func</span><span class="op" id="1693559">,</span>&nbsp;<span class="ident" id="1693561">gp</span>&nbsp;<span class="op" id="1693564">*</span><span class="ident" id="1693565">g</span><span class="op" id="1693566">)</span>&nbsp;<span class="builtintype" id="1693568">bool</span>&nbsp;<span class="op" id="1693573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1693576">g</span>&nbsp;<span class="op" id="1693578">:=</span>&nbsp;<span class="ident" id="1693581">getg</span><span class="op" id="1693585">(</span><span class="op" id="1693586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1693589">if</span>&nbsp;<span class="ident" id="1693592">g</span><span class="op" id="1693593">.</span><span class="ident" id="1693594">m</span><span class="op" id="1693595">.</span><span class="ident" id="1693596">throwing</span>&nbsp;<span class="op" id="1693605">&gt;</span>&nbsp;<span class="num" id="1693607">0</span>&nbsp;<span class="op" id="1693609">&amp;&amp;</span>&nbsp;<span class="ident" id="1693612">gp</span>&nbsp;<span class="op" id="1693615">!=</span>&nbsp;<span class="builtintype" id="1693618">nil</span>&nbsp;<span class="op" id="1693622">&amp;&amp;</span>&nbsp;<span class="op" id="1693625">(</span><span class="ident" id="1693626">gp</span>&nbsp;<span class="op" id="1693629">==</span>&nbsp;<span class="ident" id="1693632">g</span><span class="op" id="1693633">.</span><span class="ident" id="1693634">m</span><span class="op" id="1693635">.</span><span class="ident" id="1693636">curg</span>&nbsp;<span class="op" id="1693641">||</span>&nbsp;<span class="ident" id="1693644">gp</span>&nbsp;<span class="op" id="1693647">==</span>&nbsp;<span class="ident" id="1693650">g</span><span class="op" id="1693651">.</span><span class="ident" id="1693652">m</span><span class="op" id="1693653">.</span><span class="ident" id="1693654">caughtsig</span><span class="op" id="1693663">)</span>&nbsp;<span class="op" id="1693665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1693669">return</span>&nbsp;<span class="builtintype" id="1693676">true</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1693682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1693685">traceback</span>&nbsp;<span class="op" id="1693695">:=</span>&nbsp;<span class="ident" id="1693698">gotraceback</span><span class="op" id="1693709">(</span><span class="builtintype" id="1693710">nil</span><span class="op" id="1693713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1693716">name</span>&nbsp;<span class="op" id="1693721">:=</span>&nbsp;<span class="ident" id="1693724">gostringnocopy</span><span class="op" id="1693738">(</span><span class="ident" id="1693739">funcname</span><span class="op" id="1693747">(</span><span class="ident" id="1693748">f</span><span class="op" id="1693749">)</span><span class="op" id="1693750">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1693754">//&nbsp;Special&nbsp;case:&nbsp;always&nbsp;show&nbsp;runtime.panic&nbsp;frame,&nbsp;so&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1693820">//&nbsp;see&nbsp;where&nbsp;a&nbsp;panic&nbsp;started&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;stack&nbsp;trace.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1693882">//&nbsp;See&nbsp;golang.org/issue/5832.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1693913">if</span>&nbsp;<span class="ident" id="1693916">name</span>&nbsp;<span class="op" id="1693921">==</span>&nbsp;<span class="string" id="1693924">&#34;runtime.panic&#34;</span>&nbsp;<span class="op" id="1693940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1693944">return</span>&nbsp;<span class="builtintype" id="1693951">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1693957">}</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1693961">return</span>&nbsp;<span class="ident" id="1693968">traceback</span>&nbsp;<span class="op" id="1693978">&gt;</span>&nbsp;<span class="num" id="1693980">1</span>&nbsp;<span class="op" id="1693982">||</span>&nbsp;<span class="ident" id="1693985">f</span>&nbsp;<span class="op" id="1693987">!=</span>&nbsp;<span class="builtintype" id="1693990">nil</span>&nbsp;<span class="op" id="1693994">&amp;&amp;</span>&nbsp;<span class="ident" id="1693997">contains</span><span class="op" id="1694005">(</span><span class="ident" id="1694006">name</span><span class="op" id="1694010">,</span>&nbsp;<span class="string" id="1694012">&#34;.&#34;</span><span class="op" id="1694015">)</span>&nbsp;<span class="op" id="1694017">&amp;&amp;</span>&nbsp;<span class="op" id="1694020">(</span><span class="op" id="1694021">!</span><span class="ident" id="1694022">hasprefix</span><span class="op" id="1694031">(</span><span class="ident" id="1694032">name</span><span class="op" id="1694036">,</span>&nbsp;<span class="string" id="1694038">&#34;runtime.&#34;</span><span class="op" id="1694048">)</span>&nbsp;<span class="op" id="1694050">||</span>&nbsp;<span class="ident" id="1694053">isExportedRuntime</span><span class="op" id="1694070">(</span><span class="ident" id="1694071">name</span><span class="op" id="1694075">)</span><span class="op" id="1694076">)</span><br>
<span class="lineno"></span><span class="op" id="1694078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1694081">//&nbsp;isExportedRuntime&nbsp;reports&nbsp;whether&nbsp;name&nbsp;is&nbsp;an&nbsp;exported&nbsp;runtime&nbsp;function.</span><br>
<span class="lineno">560</span><span class="comment" id="1694156">//&nbsp;It&nbsp;is&nbsp;only&nbsp;for&nbsp;runtime&nbsp;functions,&nbsp;so&nbsp;ASCII&nbsp;A-Z&nbsp;is&nbsp;fine.</span><br>
<span class="lineno"></span><span class="keyword" id="1694215">func</span>&nbsp;<span class="ident" id="1694220">isExportedRuntime</span><span class="op" id="1694237">(</span><span class="ident" id="1694238">name</span>&nbsp;<span class="builtintype" id="1694243">string</span><span class="op" id="1694249">)</span>&nbsp;<span class="builtintype" id="1694251">bool</span>&nbsp;<span class="op" id="1694256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1694259">const</span>&nbsp;<span class="ident" id="1694265">n</span>&nbsp;<span class="op" id="1694267">=</span>&nbsp;<span class="builtinfunc" id="1694269">len</span><span class="op" id="1694272">(</span><span class="string" id="1694273">&#34;runtime.&#34;</span><span class="op" id="1694283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1694286">return</span>&nbsp;<span class="builtinfunc" id="1694293">len</span><span class="op" id="1694296">(</span><span class="ident" id="1694297">name</span><span class="op" id="1694301">)</span>&nbsp;<span class="op" id="1694303">&gt;</span>&nbsp;<span class="ident" id="1694305">n</span>&nbsp;<span class="op" id="1694307">&amp;&amp;</span>&nbsp;<span class="ident" id="1694310">name</span><span class="op" id="1694314">[</span><span class="op" id="1694315">:</span><span class="ident" id="1694316">n</span><span class="op" id="1694317">]</span>&nbsp;<span class="op" id="1694319">==</span>&nbsp;<span class="string" id="1694322">&#34;runtime.&#34;</span>&nbsp;<span class="op" id="1694333">&amp;&amp;</span>&nbsp;<span class="string" id="1694336">&#39;A&#39;</span>&nbsp;<span class="op" id="1694340">&lt;=</span>&nbsp;<span class="ident" id="1694343">name</span><span class="op" id="1694347">[</span><span class="ident" id="1694348">n</span><span class="op" id="1694349">]</span>&nbsp;<span class="op" id="1694351">&amp;&amp;</span>&nbsp;<span class="ident" id="1694354">name</span><span class="op" id="1694358">[</span><span class="ident" id="1694359">n</span><span class="op" id="1694360">]</span>&nbsp;<span class="op" id="1694362">&lt;=</span>&nbsp;<span class="string" id="1694365">&#39;Z&#39;</span><br>
<span class="lineno"></span><span class="op" id="1694369">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword" id="1694372">var</span>&nbsp;<span class="ident" id="1694376">gStatusStrings</span>&nbsp;<span class="op" id="1694391">=</span>&nbsp;<span class="op" id="1694393">[</span><span class="op" id="1694394">...</span><span class="op" id="1694397">]</span><span class="builtintype" id="1694398">string</span><span class="op" id="1694404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1694407">_Gidle</span><span class="op" id="1694413">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1694420">&#34;idle&#34;</span><span class="op" id="1694426">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1694429">_Grunnable</span><span class="op" id="1694439">:</span>&nbsp;&nbsp;<span class="string" id="1694442">&#34;runnable&#34;</span><span class="op" id="1694452">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1694455">_Grunning</span><span class="op" id="1694464">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1694468">&#34;running&#34;</span><span class="op" id="1694477">,</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1694480">_Gsyscall</span><span class="op" id="1694489">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1694493">&#34;syscall&#34;</span><span class="op" id="1694502">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1694505">_Gwaiting</span><span class="op" id="1694514">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1694518">&#34;waiting&#34;</span><span class="op" id="1694527">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1694530">_Gdead</span><span class="op" id="1694536">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1694543">&#34;dead&#34;</span><span class="op" id="1694549">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1694552">_Genqueue</span><span class="op" id="1694561">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1694565">&#34;enqueue&#34;</span><span class="op" id="1694574">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1694577">_Gcopystack</span><span class="op" id="1694588">:</span>&nbsp;<span class="string" id="1694590">&#34;copystack&#34;</span><span class="op" id="1694601">,</span><br>
<span class="lineno">575</span><span class="op" id="1694603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1694606">var</span>&nbsp;<span class="ident" id="1694610">gScanStatusStrings</span>&nbsp;<span class="op" id="1694629">=</span>&nbsp;<span class="op" id="1694631">[</span><span class="op" id="1694632">...</span><span class="op" id="1694635">]</span><span class="builtintype" id="1694636">string</span><span class="op" id="1694642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="1694645">0</span><span class="op" id="1694646">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1694657">&#34;scan&#34;</span><span class="op" id="1694663">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1694666">_Grunnable</span><span class="op" id="1694676">:</span>&nbsp;<span class="string" id="1694678">&#34;scanrunnable&#34;</span><span class="op" id="1694692">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1694695">_Grunning</span><span class="op" id="1694704">:</span>&nbsp;&nbsp;<span class="string" id="1694707">&#34;scanrunning&#34;</span><span class="op" id="1694720">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1694723">_Gsyscall</span><span class="op" id="1694732">:</span>&nbsp;&nbsp;<span class="string" id="1694735">&#34;scansyscall&#34;</span><span class="op" id="1694748">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1694751">_Gwaiting</span><span class="op" id="1694760">:</span>&nbsp;&nbsp;<span class="string" id="1694763">&#34;scanwaiting&#34;</span><span class="op" id="1694776">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1694779">_Gdead</span><span class="op" id="1694785">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1694791">&#34;scandead&#34;</span><span class="op" id="1694801">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1694804">_Genqueue</span><span class="op" id="1694813">:</span>&nbsp;&nbsp;<span class="string" id="1694816">&#34;scanenqueue&#34;</span><span class="op" id="1694829">,</span><br>
<span class="lineno">585</span><span class="op" id="1694831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1694834">func</span>&nbsp;<span class="ident" id="1694839">goroutineheader</span><span class="op" id="1694854">(</span><span class="ident" id="1694855">gp</span>&nbsp;<span class="op" id="1694858">*</span><span class="ident" id="1694859">g</span><span class="op" id="1694860">)</span>&nbsp;<span class="op" id="1694862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1694865">gpstatus</span>&nbsp;<span class="op" id="1694874">:=</span>&nbsp;<span class="ident" id="1694877">readgstatus</span><span class="op" id="1694888">(</span><span class="ident" id="1694889">gp</span><span class="op" id="1694891">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1694895">//&nbsp;Basic&nbsp;string&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1694919">var</span>&nbsp;<span class="ident" id="1694923">status</span>&nbsp;<span class="builtintype" id="1694930">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1694938">if</span>&nbsp;<span class="num" id="1694941">0</span>&nbsp;<span class="op" id="1694943">&lt;=</span>&nbsp;<span class="ident" id="1694946">gpstatus</span>&nbsp;<span class="op" id="1694955">&amp;&amp;</span>&nbsp;<span class="ident" id="1694958">gpstatus</span>&nbsp;<span class="op" id="1694967">&lt;</span>&nbsp;<span class="builtintype" id="1694969">uint32</span><span class="op" id="1694975">(</span><span class="builtinfunc" id="1694976">len</span><span class="op" id="1694979">(</span><span class="ident" id="1694980">gStatusStrings</span><span class="op" id="1694994">)</span><span class="op" id="1694995">)</span>&nbsp;<span class="op" id="1694997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1695001">status</span>&nbsp;<span class="op" id="1695008">=</span>&nbsp;<span class="ident" id="1695010">gStatusStrings</span><span class="op" id="1695024">[</span><span class="ident" id="1695025">gpstatus</span><span class="op" id="1695033">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1695036">}</span>&nbsp;<span class="keyword" id="1695038">else</span>&nbsp;<span class="keyword" id="1695043">if</span>&nbsp;<span class="ident" id="1695046">gpstatus</span><span class="op" id="1695054">&amp;</span><span class="ident" id="1695055">_Gscan</span>&nbsp;<span class="op" id="1695062">!=</span>&nbsp;<span class="num" id="1695065">0</span>&nbsp;<span class="op" id="1695067">&amp;&amp;</span>&nbsp;<span class="num" id="1695070">0</span>&nbsp;<span class="op" id="1695072">&lt;=</span>&nbsp;<span class="ident" id="1695075">gpstatus</span><span class="op" id="1695083">&amp;^</span><span class="ident" id="1695085">_Gscan</span>&nbsp;<span class="op" id="1695092">&amp;&amp;</span>&nbsp;<span class="ident" id="1695095">gpstatus</span><span class="op" id="1695103">&amp;^</span><span class="ident" id="1695105">_Gscan</span>&nbsp;<span class="op" id="1695112">&lt;</span>&nbsp;<span class="builtintype" id="1695114">uint32</span><span class="op" id="1695120">(</span><span class="builtinfunc" id="1695121">len</span><span class="op" id="1695124">(</span><span class="ident" id="1695125">gStatusStrings</span><span class="op" id="1695139">)</span><span class="op" id="1695140">)</span>&nbsp;<span class="op" id="1695142">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1695146">status</span>&nbsp;<span class="op" id="1695153">=</span>&nbsp;<span class="ident" id="1695155">gStatusStrings</span><span class="op" id="1695169">[</span><span class="ident" id="1695170">gpstatus</span><span class="op" id="1695178">&amp;^</span><span class="ident" id="1695180">_Gscan</span><span class="op" id="1695186">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1695189">}</span>&nbsp;<span class="keyword" id="1695191">else</span>&nbsp;<span class="op" id="1695196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1695200">status</span>&nbsp;<span class="op" id="1695207">=</span>&nbsp;<span class="string" id="1695209">&#34;???&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1695216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1695220">//&nbsp;Override.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1695234">if</span>&nbsp;<span class="op" id="1695237">(</span><span class="ident" id="1695238">gpstatus</span>&nbsp;<span class="op" id="1695247">==</span>&nbsp;<span class="ident" id="1695250">_Gwaiting</span>&nbsp;<span class="op" id="1695260">||</span>&nbsp;<span class="ident" id="1695263">gpstatus</span>&nbsp;<span class="op" id="1695272">==</span>&nbsp;<span class="ident" id="1695275">_Gscanwaiting</span><span class="op" id="1695288">)</span>&nbsp;<span class="op" id="1695290">&amp;&amp;</span>&nbsp;<span class="ident" id="1695293">gp</span><span class="op" id="1695295">.</span><span class="ident" id="1695296">waitreason</span>&nbsp;<span class="op" id="1695307">!=</span>&nbsp;<span class="string" id="1695310">&#34;&#34;</span>&nbsp;<span class="op" id="1695313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1695317">status</span>&nbsp;<span class="op" id="1695324">=</span>&nbsp;<span class="ident" id="1695326">gp</span><span class="op" id="1695328">.</span><span class="ident" id="1695329">waitreason</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1695341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1695345">//&nbsp;approx&nbsp;time&nbsp;the&nbsp;G&nbsp;is&nbsp;blocked,&nbsp;in&nbsp;minutes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1695390">var</span>&nbsp;<span class="ident" id="1695394">waitfor</span>&nbsp;<span class="builtintype" id="1695402">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1695409">gpstatus</span>&nbsp;<span class="op" id="1695418">&amp;^=</span>&nbsp;<span class="ident" id="1695422">_Gscan</span>&nbsp;<span class="comment" id="1695429">//&nbsp;drop&nbsp;the&nbsp;scan&nbsp;bit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1695451">if</span>&nbsp;<span class="op" id="1695454">(</span><span class="ident" id="1695455">gpstatus</span>&nbsp;<span class="op" id="1695464">==</span>&nbsp;<span class="ident" id="1695467">_Gwaiting</span>&nbsp;<span class="op" id="1695477">||</span>&nbsp;<span class="ident" id="1695480">gpstatus</span>&nbsp;<span class="op" id="1695489">==</span>&nbsp;<span class="ident" id="1695492">_Gsyscall</span><span class="op" id="1695501">)</span>&nbsp;<span class="op" id="1695503">&amp;&amp;</span>&nbsp;<span class="ident" id="1695506">gp</span><span class="op" id="1695508">.</span><span class="ident" id="1695509">waitsince</span>&nbsp;<span class="op" id="1695519">!=</span>&nbsp;<span class="num" id="1695522">0</span>&nbsp;<span class="op" id="1695524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1695528">waitfor</span>&nbsp;<span class="op" id="1695536">=</span>&nbsp;<span class="op" id="1695538">(</span><span class="ident" id="1695539">nanotime</span><span class="op" id="1695547">(</span><span class="op" id="1695548">)</span>&nbsp;<span class="op" id="1695550">-</span>&nbsp;<span class="ident" id="1695552">gp</span><span class="op" id="1695554">.</span><span class="ident" id="1695555">waitsince</span><span class="op" id="1695564">)</span>&nbsp;<span class="op" id="1695566">/</span>&nbsp;<span class="num" id="1695568">60e9</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1695574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1695577">print</span><span class="op" id="1695582">(</span><span class="string" id="1695583">&#34;goroutine&nbsp;&#34;</span><span class="op" id="1695595">,</span>&nbsp;<span class="ident" id="1695597">gp</span><span class="op" id="1695599">.</span><span class="ident" id="1695600">goid</span><span class="op" id="1695604">,</span>&nbsp;<span class="string" id="1695606">&#34;&nbsp;[&#34;</span><span class="op" id="1695610">,</span>&nbsp;<span class="ident" id="1695612">status</span><span class="op" id="1695618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1695621">if</span>&nbsp;<span class="ident" id="1695624">waitfor</span>&nbsp;<span class="op" id="1695632">&gt;=</span>&nbsp;<span class="num" id="1695635">1</span>&nbsp;<span class="op" id="1695637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1695641">print</span><span class="op" id="1695646">(</span><span class="string" id="1695647">&#34;,&nbsp;&#34;</span><span class="op" id="1695651">,</span>&nbsp;<span class="ident" id="1695653">waitfor</span><span class="op" id="1695660">,</span>&nbsp;<span class="string" id="1695662">&#34;&nbsp;minutes&#34;</span><span class="op" id="1695672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1695675">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1695678">if</span>&nbsp;<span class="ident" id="1695681">gp</span><span class="op" id="1695683">.</span><span class="ident" id="1695684">lockedm</span>&nbsp;<span class="op" id="1695692">!=</span>&nbsp;<span class="builtintype" id="1695695">nil</span>&nbsp;<span class="op" id="1695699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1695703">print</span><span class="op" id="1695708">(</span><span class="string" id="1695709">&#34;,&nbsp;locked&nbsp;to&nbsp;thread&#34;</span><span class="op" id="1695729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1695732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1695735">print</span><span class="op" id="1695740">(</span><span class="string" id="1695741">&#34;]:\n&#34;</span><span class="op" id="1695747">)</span><br>
<span class="lineno"></span><span class="op" id="1695749">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="1695752">func</span>&nbsp;<span class="ident" id="1695757">tracebackothers</span><span class="op" id="1695772">(</span><span class="ident" id="1695773">me</span>&nbsp;<span class="op" id="1695776">*</span><span class="ident" id="1695777">g</span><span class="op" id="1695778">)</span>&nbsp;<span class="op" id="1695780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1695783">level</span>&nbsp;<span class="op" id="1695789">:=</span>&nbsp;<span class="ident" id="1695792">gotraceback</span><span class="op" id="1695803">(</span><span class="builtintype" id="1695804">nil</span><span class="op" id="1695807">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1695811">//&nbsp;Show&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;first,&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1695872">g</span>&nbsp;<span class="op" id="1695874">:=</span>&nbsp;<span class="ident" id="1695877">getg</span><span class="op" id="1695881">(</span><span class="op" id="1695882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1695885">gp</span>&nbsp;<span class="op" id="1695888">:=</span>&nbsp;<span class="ident" id="1695891">g</span><span class="op" id="1695892">.</span><span class="ident" id="1695893">m</span><span class="op" id="1695894">.</span><span class="ident" id="1695895">curg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1695901">if</span>&nbsp;<span class="ident" id="1695904">gp</span>&nbsp;<span class="op" id="1695907">!=</span>&nbsp;<span class="builtintype" id="1695910">nil</span>&nbsp;<span class="op" id="1695914">&amp;&amp;</span>&nbsp;<span class="ident" id="1695917">gp</span>&nbsp;<span class="op" id="1695920">!=</span>&nbsp;<span class="ident" id="1695923">me</span>&nbsp;<span class="op" id="1695926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1695930">print</span><span class="op" id="1695935">(</span><span class="string" id="1695936">&#34;\n&#34;</span><span class="op" id="1695940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1695944">goroutineheader</span><span class="op" id="1695959">(</span><span class="ident" id="1695960">gp</span><span class="op" id="1695962">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1695966">traceback</span><span class="op" id="1695975">(</span><span class="op" id="1695976">^</span><span class="builtintype" id="1695977">uintptr</span><span class="op" id="1695984">(</span><span class="num" id="1695985">0</span><span class="op" id="1695986">)</span><span class="op" id="1695987">,</span>&nbsp;<span class="op" id="1695989">^</span><span class="builtintype" id="1695990">uintptr</span><span class="op" id="1695997">(</span><span class="num" id="1695998">0</span><span class="op" id="1695999">)</span><span class="op" id="1696000">,</span>&nbsp;<span class="num" id="1696002">0</span><span class="op" id="1696003">,</span>&nbsp;<span class="ident" id="1696005">gp</span><span class="op" id="1696007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1696010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1696014">lock</span><span class="op" id="1696018">(</span><span class="op" id="1696019">&amp;</span><span class="ident" id="1696020">allglock</span><span class="op" id="1696028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1696031">for</span>&nbsp;<span class="ident" id="1696035">_</span><span class="op" id="1696036">,</span>&nbsp;<span class="ident" id="1696038">gp</span>&nbsp;<span class="op" id="1696041">:=</span>&nbsp;<span class="keyword" id="1696044">range</span>&nbsp;<span class="ident" id="1696050">allgs</span>&nbsp;<span class="op" id="1696056">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1696060">if</span>&nbsp;<span class="ident" id="1696063">gp</span>&nbsp;<span class="op" id="1696066">==</span>&nbsp;<span class="ident" id="1696069">me</span>&nbsp;<span class="op" id="1696072">||</span>&nbsp;<span class="ident" id="1696075">gp</span>&nbsp;<span class="op" id="1696078">==</span>&nbsp;<span class="ident" id="1696081">g</span><span class="op" id="1696082">.</span><span class="ident" id="1696083">m</span><span class="op" id="1696084">.</span><span class="ident" id="1696085">curg</span>&nbsp;<span class="op" id="1696090">||</span>&nbsp;<span class="ident" id="1696093">readgstatus</span><span class="op" id="1696104">(</span><span class="ident" id="1696105">gp</span><span class="op" id="1696107">)</span>&nbsp;<span class="op" id="1696109">==</span>&nbsp;<span class="ident" id="1696112">_Gdead</span>&nbsp;<span class="op" id="1696119">||</span>&nbsp;<span class="ident" id="1696122">gp</span><span class="op" id="1696124">.</span><span class="ident" id="1696125">issystem</span>&nbsp;<span class="op" id="1696134">&amp;&amp;</span>&nbsp;<span class="ident" id="1696137">level</span>&nbsp;<span class="op" id="1696143">&lt;</span>&nbsp;<span class="num" id="1696145">2</span>&nbsp;<span class="op" id="1696147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1696152">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1696163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1696167">print</span><span class="op" id="1696172">(</span><span class="string" id="1696173">&#34;\n&#34;</span><span class="op" id="1696177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1696181">goroutineheader</span><span class="op" id="1696196">(</span><span class="ident" id="1696197">gp</span><span class="op" id="1696199">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1696203">if</span>&nbsp;<span class="ident" id="1696206">readgstatus</span><span class="op" id="1696217">(</span><span class="ident" id="1696218">gp</span><span class="op" id="1696220">)</span><span class="op" id="1696221">&amp;^</span><span class="ident" id="1696223">_Gscan</span>&nbsp;<span class="op" id="1696230">==</span>&nbsp;<span class="ident" id="1696233">_Grunning</span>&nbsp;<span class="op" id="1696243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1696248">print</span><span class="op" id="1696253">(</span><span class="string" id="1696254">&#34;\tgoroutine&nbsp;running&nbsp;on&nbsp;other&nbsp;thread;&nbsp;stack&nbsp;unavailable\n&#34;</span><span class="op" id="1696312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1696317">printcreatedby</span><span class="op" id="1696331">(</span><span class="ident" id="1696332">gp</span><span class="op" id="1696334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1696338">}</span>&nbsp;<span class="keyword" id="1696340">else</span>&nbsp;<span class="op" id="1696345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1696350">traceback</span><span class="op" id="1696359">(</span><span class="op" id="1696360">^</span><span class="builtintype" id="1696361">uintptr</span><span class="op" id="1696368">(</span><span class="num" id="1696369">0</span><span class="op" id="1696370">)</span><span class="op" id="1696371">,</span>&nbsp;<span class="op" id="1696373">^</span><span class="builtintype" id="1696374">uintptr</span><span class="op" id="1696381">(</span><span class="num" id="1696382">0</span><span class="op" id="1696383">)</span><span class="op" id="1696384">,</span>&nbsp;<span class="num" id="1696386">0</span><span class="op" id="1696387">,</span>&nbsp;<span class="ident" id="1696389">gp</span><span class="op" id="1696391">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1696395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1696398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1696401">unlock</span><span class="op" id="1696407">(</span><span class="op" id="1696408">&amp;</span><span class="ident" id="1696409">allglock</span><span class="op" id="1696417">)</span><br>
<span class="lineno"></span><span class="op" id="1696419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="1696422">//&nbsp;Does&nbsp;f&nbsp;mark&nbsp;the&nbsp;top&nbsp;of&nbsp;a&nbsp;goroutine&nbsp;stack?</span><br>
<span class="lineno"></span><span class="keyword" id="1696467">func</span>&nbsp;<span class="ident" id="1696472">topofstack</span><span class="op" id="1696482">(</span><span class="ident" id="1696483">f</span>&nbsp;<span class="op" id="1696485">*</span><span class="ident" id="1696486">_func</span><span class="op" id="1696491">)</span>&nbsp;<span class="builtintype" id="1696493">bool</span>&nbsp;<span class="op" id="1696498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1696501">pc</span>&nbsp;<span class="op" id="1696504">:=</span>&nbsp;<span class="ident" id="1696507">f</span><span class="op" id="1696508">.</span><span class="ident" id="1696509">entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1696516">return</span>&nbsp;<span class="ident" id="1696523">pc</span>&nbsp;<span class="op" id="1696526">==</span>&nbsp;<span class="ident" id="1696529">goexitPC</span>&nbsp;<span class="op" id="1696538">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1696543">pc</span>&nbsp;<span class="op" id="1696546">==</span>&nbsp;<span class="ident" id="1696549">mstartPC</span>&nbsp;<span class="op" id="1696558">||</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1696563">pc</span>&nbsp;<span class="op" id="1696566">==</span>&nbsp;<span class="ident" id="1696569">mcallPC</span>&nbsp;<span class="op" id="1696577">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1696582">pc</span>&nbsp;<span class="op" id="1696585">==</span>&nbsp;<span class="ident" id="1696588">morestackPC</span>&nbsp;<span class="op" id="1696600">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1696605">pc</span>&nbsp;<span class="op" id="1696608">==</span>&nbsp;<span class="ident" id="1696611">rt0_goPC</span>&nbsp;<span class="op" id="1696620">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1696625">externalthreadhandlerp</span>&nbsp;<span class="op" id="1696648">!=</span>&nbsp;<span class="num" id="1696651">0</span>&nbsp;<span class="op" id="1696653">&amp;&amp;</span>&nbsp;<span class="ident" id="1696656">pc</span>&nbsp;<span class="op" id="1696659">==</span>&nbsp;<span class="ident" id="1696662">externalthreadhandlerp</span><br>
<span class="lineno"></span><span class="op" id="1696685">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
