<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">atomic</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;Value&nbsp;provides&nbsp;an&nbsp;atomic&nbsp;load&nbsp;and&nbsp;store&nbsp;of&nbsp;a&nbsp;consistently&nbsp;typed&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Values&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;data&nbsp;structures.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;Value&nbsp;returns&nbsp;nil&nbsp;from&nbsp;Load.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Once&nbsp;Store&nbsp;has&nbsp;been&nbsp;called,&nbsp;a&nbsp;Value&nbsp;must&nbsp;not&nbsp;be&nbsp;copied.</span><br>
<span class="lineno">15</span><span class="keyword">type</span>&nbsp;<span class="ident">Value</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ifaceWords&nbsp;is&nbsp;interface{}&nbsp;internal&nbsp;representation.</span><br>
<span class="lineno">20</span><span class="keyword">type</span>&nbsp;<span class="ident">ifaceWords</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typ</span>&nbsp;&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">data</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment">//&nbsp;Load&nbsp;returns&nbsp;the&nbsp;value&nbsp;set&nbsp;by&nbsp;the&nbsp;most&nbsp;recent&nbsp;Store.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;returns&nbsp;nil&nbsp;if&nbsp;there&nbsp;has&nbsp;been&nbsp;no&nbsp;call&nbsp;to&nbsp;Store&nbsp;for&nbsp;this&nbsp;Value.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">v</span>&nbsp;<span class="op">*</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="ident">Load</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">vp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">ifaceWords</span><span class="op">)</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typ</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">LoadPointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">vp</span><span class="op">.</span><span class="ident">typ</span><span class="op">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">typ</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">(</span><span class="ident">typ</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="op">^</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="num">0</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;First&nbsp;store&nbsp;not&nbsp;yet&nbsp;completed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">data</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">LoadPointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">vp</span><span class="op">.</span><span class="ident">data</span><span class="op">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">ifaceWords</span><span class="op">)</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">x</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xp</span><span class="op">.</span><span class="ident">typ</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">typ</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xp</span><span class="op">.</span><span class="ident">data</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Store&nbsp;sets&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;Value&nbsp;to&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;All&nbsp;calls&nbsp;to&nbsp;Store&nbsp;for&nbsp;a&nbsp;given&nbsp;Value&nbsp;must&nbsp;use&nbsp;values&nbsp;of&nbsp;the&nbsp;same&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Store&nbsp;of&nbsp;an&nbsp;inconsistent&nbsp;type&nbsp;panics,&nbsp;as&nbsp;does&nbsp;Store(nil).</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">v</span>&nbsp;<span class="op">*</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="ident">Store</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;sync/atomic:&nbsp;store&nbsp;of&nbsp;nil&nbsp;value&nbsp;into&nbsp;Value&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">vp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">ifaceWords</span><span class="op">)</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">ifaceWords</span><span class="op">)</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">x</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typ</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">LoadPointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">vp</span><span class="op">.</span><span class="ident">typ</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">typ</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Attempt&nbsp;to&nbsp;start&nbsp;first&nbsp;store.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Disable&nbsp;preemption&nbsp;so&nbsp;that&nbsp;other&nbsp;goroutines&nbsp;can&nbsp;use</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;active&nbsp;spin&nbsp;wait&nbsp;to&nbsp;wait&nbsp;for&nbsp;completion;&nbsp;and&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;GC&nbsp;does&nbsp;not&nbsp;see&nbsp;the&nbsp;fake&nbsp;type&nbsp;accidentally.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runtime_procPin</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">CompareAndSwapPointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">vp</span><span class="op">.</span><span class="ident">typ</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="op">^</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runtime_procUnpin</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Complete&nbsp;first&nbsp;store.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">StorePointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">vp</span><span class="op">.</span><span class="ident">data</span><span class="op">,</span>&nbsp;<span class="ident">xp</span><span class="op">.</span><span class="ident">data</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">StorePointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">vp</span><span class="op">.</span><span class="ident">typ</span><span class="op">,</span>&nbsp;<span class="ident">xp</span><span class="op">.</span><span class="ident">typ</span><span class="op">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runtime_procUnpin</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">(</span><span class="ident">typ</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="op">^</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="num">0</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;First&nbsp;store&nbsp;in&nbsp;progress.&nbsp;Wait.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Since&nbsp;we&nbsp;disable&nbsp;preemption&nbsp;around&nbsp;the&nbsp;first&nbsp;store,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;we&nbsp;can&nbsp;wait&nbsp;with&nbsp;active&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;First&nbsp;store&nbsp;completed.&nbsp;Check&nbsp;type&nbsp;and&nbsp;overwrite&nbsp;data.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">typ</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">xp</span><span class="op">.</span><span class="ident">typ</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;sync/atomic:&nbsp;store&nbsp;of&nbsp;inconsistently&nbsp;typed&nbsp;value&nbsp;into&nbsp;Value&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">StorePointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">vp</span><span class="op">.</span><span class="ident">data</span><span class="op">,</span>&nbsp;<span class="ident">xp</span><span class="op">.</span><span class="ident">data</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Disable/enable&nbsp;preemption,&nbsp;implemented&nbsp;in&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">runtime_procPin</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">85</span><span class="keyword">func</span>&nbsp;<span class="ident">runtime_procUnpin</span><span class="op">(</span><span class="op">)</span>
</div>
</body>
</html>
