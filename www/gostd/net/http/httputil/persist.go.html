<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html" class="current">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4982799">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4982854">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4982908">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4982959">package</span>&nbsp;<span class="ident" id="4982967">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4982977">import</span>&nbsp;<span class="op" id="4982984">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4982987">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4982996">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4983006">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4983012">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4983019">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4983031">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4983048">&#34;sync&#34;</span><br>
<span class="lineno">15</span><span class="op" id="4983055">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4983058">var</span>&nbsp;<span class="op" id="4983062">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4983065">ErrPersistEOF</span>&nbsp;<span class="op" id="4983079">=</span>&nbsp;<span class="op" id="4983081">&amp;</span><span class="ident" id="4983082">http</span><span class="op" id="4983086">.</span><span class="ident" id="4983087">ProtocolError</span><span class="op" id="4983100">{</span><span class="ident" id="4983101">ErrorString</span><span class="op" id="4983112">:</span>&nbsp;<span class="string" id="4983114">&#34;persistent&nbsp;connection&nbsp;closed&#34;</span><span class="op" id="4983144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4983147">ErrClosed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4983161">=</span>&nbsp;<span class="op" id="4983163">&amp;</span><span class="ident" id="4983164">http</span><span class="op" id="4983168">.</span><span class="ident" id="4983169">ProtocolError</span><span class="op" id="4983182">{</span><span class="ident" id="4983183">ErrorString</span><span class="op" id="4983194">:</span>&nbsp;<span class="string" id="4983196">&#34;connection&nbsp;closed&nbsp;by&nbsp;user&#34;</span><span class="op" id="4983223">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4983226">ErrPipeline</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4983240">=</span>&nbsp;<span class="op" id="4983242">&amp;</span><span class="ident" id="4983243">http</span><span class="op" id="4983247">.</span><span class="ident" id="4983248">ProtocolError</span><span class="op" id="4983261">{</span><span class="ident" id="4983262">ErrorString</span><span class="op" id="4983273">:</span>&nbsp;<span class="string" id="4983275">&#34;pipeline&nbsp;error&#34;</span><span class="op" id="4983291">}</span><br>
<span class="lineno"></span><span class="op" id="4983293">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4983296">//&nbsp;This&nbsp;is&nbsp;an&nbsp;API&nbsp;usage&nbsp;error&nbsp;-&nbsp;the&nbsp;local&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="4983354">//&nbsp;ErrPersistEOF&nbsp;(above)&nbsp;reports&nbsp;that&nbsp;the&nbsp;remote&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno">25</span><span class="keyword" id="4983419">var</span>&nbsp;<span class="ident" id="4983423">errClosed</span>&nbsp;<span class="op" id="4983433">=</span>&nbsp;<span class="ident" id="4983435">errors</span><span class="op" id="4983441">.</span><span class="ident" id="4983442">New</span><span class="op" id="4983445">(</span><span class="string" id="4983446">&#34;i/o&nbsp;operation&nbsp;on&nbsp;closed&nbsp;connection&#34;</span><span class="op" id="4983482">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4983485">//&nbsp;A&nbsp;ServerConn&nbsp;reads&nbsp;requests&nbsp;and&nbsp;sends&nbsp;responses&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="4983555">//&nbsp;connection,&nbsp;until&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic&nbsp;commands&nbsp;an&nbsp;end.&nbsp;ServerConn</span><br>
<span class="lineno"></span><span class="comment" id="4983629">//&nbsp;also&nbsp;allows&nbsp;hijacking&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;by&nbsp;calling&nbsp;Hijack</span><br>
<span class="lineno">30</span><span class="comment" id="4983698">//&nbsp;to&nbsp;regain&nbsp;control&nbsp;over&nbsp;the&nbsp;connection.&nbsp;ServerConn&nbsp;supports&nbsp;pipe-lining,</span><br>
<span class="lineno"></span><span class="comment" id="4983773">//&nbsp;i.e.&nbsp;requests&nbsp;can&nbsp;be&nbsp;read&nbsp;out&nbsp;of&nbsp;sync&nbsp;(but&nbsp;in&nbsp;the&nbsp;same&nbsp;order)&nbsp;while&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4983848">//&nbsp;respective&nbsp;responses&nbsp;are&nbsp;sent.</span><br>
<span class="lineno"></span><span class="comment" id="4983882">//</span><br>
<span class="lineno"></span><span class="comment" id="4983885">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno">35</span><span class="comment" id="4983960">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4983988">type</span>&nbsp;<span class="ident" id="4983993">ServerConn</span>&nbsp;<span class="keyword" id="4984004">struct</span>&nbsp;<span class="op" id="4984011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984014">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984030">sync</span><span class="op" id="4984034">.</span><span class="ident" id="4984035">Mutex</span>&nbsp;<span class="comment" id="4984041">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984086">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984102">net</span><span class="op" id="4984105">.</span><span class="ident" id="4984106">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984112">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4984128">*</span><span class="ident" id="4984129">bufio</span><span class="op" id="4984134">.</span><span class="ident" id="4984135">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984143">re</span><span class="op" id="4984145">,</span>&nbsp;<span class="ident" id="4984147">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4984159">error</span>&nbsp;<span class="comment" id="4984165">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984187">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984203">io</span><span class="op" id="4984205">.</span><span class="ident" id="4984206">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984218">nread</span><span class="op" id="4984223">,</span>&nbsp;<span class="ident" id="4984225">nwritten</span>&nbsp;<span class="builtintype" id="4984234">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984239">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4984255">map</span><span class="op" id="4984258">[</span><span class="op" id="4984259">*</span><span class="ident" id="4984260">http</span><span class="op" id="4984264">.</span><span class="ident" id="4984265">Request</span><span class="op" id="4984272">]</span><span class="builtintype" id="4984273">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984280">pipe</span>&nbsp;<span class="ident" id="4984285">textproto</span><span class="op" id="4984294">.</span><span class="ident" id="4984295">Pipeline</span><br>
<span class="lineno"></span><span class="op" id="4984304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4984307">//&nbsp;NewServerConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServerConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="4984384">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno">50</span><span class="comment" id="4984432">//</span><br>
<span class="lineno"></span><span class="comment" id="4984435">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno"></span><span class="comment" id="4984510">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4984538">func</span>&nbsp;<span class="ident" id="4984543">NewServerConn</span><span class="op" id="4984556">(</span><span class="ident" id="4984557">c</span>&nbsp;<span class="ident" id="4984559">net</span><span class="op" id="4984562">.</span><span class="ident" id="4984563">Conn</span><span class="op" id="4984567">,</span>&nbsp;<span class="ident" id="4984569">r</span>&nbsp;<span class="op" id="4984571">*</span><span class="ident" id="4984572">bufio</span><span class="op" id="4984577">.</span><span class="ident" id="4984578">Reader</span><span class="op" id="4984584">)</span>&nbsp;<span class="op" id="4984586">*</span><span class="ident" id="4984587">ServerConn</span>&nbsp;<span class="op" id="4984598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4984601">if</span>&nbsp;<span class="ident" id="4984604">r</span>&nbsp;<span class="op" id="4984606">==</span>&nbsp;<span class="builtintype" id="4984609">nil</span>&nbsp;<span class="op" id="4984613">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984617">r</span>&nbsp;<span class="op" id="4984619">=</span>&nbsp;<span class="ident" id="4984621">bufio</span><span class="op" id="4984626">.</span><span class="ident" id="4984627">NewReader</span><span class="op" id="4984636">(</span><span class="ident" id="4984637">c</span><span class="op" id="4984638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4984641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4984644">return</span>&nbsp;<span class="op" id="4984651">&amp;</span><span class="ident" id="4984652">ServerConn</span><span class="op" id="4984662">{</span><span class="ident" id="4984663">c</span><span class="op" id="4984664">:</span>&nbsp;<span class="ident" id="4984666">c</span><span class="op" id="4984667">,</span>&nbsp;<span class="ident" id="4984669">r</span><span class="op" id="4984670">:</span>&nbsp;<span class="ident" id="4984672">r</span><span class="op" id="4984673">,</span>&nbsp;<span class="ident" id="4984675">pipereq</span><span class="op" id="4984682">:</span>&nbsp;<span class="builtinfunc" id="4984684">make</span><span class="op" id="4984688">(</span><span class="keyword" id="4984689">map</span><span class="op" id="4984692">[</span><span class="op" id="4984693">*</span><span class="ident" id="4984694">http</span><span class="op" id="4984698">.</span><span class="ident" id="4984699">Request</span><span class="op" id="4984706">]</span><span class="builtintype" id="4984707">uint</span><span class="op" id="4984711">)</span><span class="op" id="4984712">}</span><br>
<span class="lineno"></span><span class="op" id="4984714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="4984717">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ServerConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="4984797">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4984873">//&nbsp;called&nbsp;before&nbsp;Read&nbsp;has&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive&nbsp;logic.&nbsp;The&nbsp;user</span><br>
<span class="lineno"></span><span class="comment" id="4984950">//&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="4985012">func</span>&nbsp;<span class="op" id="4985017">(</span><span class="ident" id="4985018">sc</span>&nbsp;<span class="op" id="4985021">*</span><span class="ident" id="4985022">ServerConn</span><span class="op" id="4985032">)</span>&nbsp;<span class="ident" id="4985034">Hijack</span><span class="op" id="4985040">(</span><span class="op" id="4985041">)</span>&nbsp;<span class="op" id="4985043">(</span><span class="ident" id="4985044">c</span>&nbsp;<span class="ident" id="4985046">net</span><span class="op" id="4985049">.</span><span class="ident" id="4985050">Conn</span><span class="op" id="4985054">,</span>&nbsp;<span class="ident" id="4985056">r</span>&nbsp;<span class="op" id="4985058">*</span><span class="ident" id="4985059">bufio</span><span class="op" id="4985064">.</span><span class="ident" id="4985065">Reader</span><span class="op" id="4985071">)</span>&nbsp;<span class="op" id="4985073">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985076">sc</span><span class="op" id="4985078">.</span><span class="ident" id="4985079">lk</span><span class="op" id="4985081">.</span><span class="ident" id="4985082">Lock</span><span class="op" id="4985086">(</span><span class="op" id="4985087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4985090">defer</span>&nbsp;<span class="ident" id="4985096">sc</span><span class="op" id="4985098">.</span><span class="ident" id="4985099">lk</span><span class="op" id="4985101">.</span><span class="ident" id="4985102">Unlock</span><span class="op" id="4985108">(</span><span class="op" id="4985109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985112">c</span>&nbsp;<span class="op" id="4985114">=</span>&nbsp;<span class="ident" id="4985116">sc</span><span class="op" id="4985118">.</span><span class="ident" id="4985119">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985122">r</span>&nbsp;<span class="op" id="4985124">=</span>&nbsp;<span class="ident" id="4985126">sc</span><span class="op" id="4985128">.</span><span class="ident" id="4985129">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985132">sc</span><span class="op" id="4985134">.</span><span class="ident" id="4985135">c</span>&nbsp;<span class="op" id="4985137">=</span>&nbsp;<span class="builtintype" id="4985139">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985144">sc</span><span class="op" id="4985146">.</span><span class="ident" id="4985147">r</span>&nbsp;<span class="op" id="4985149">=</span>&nbsp;<span class="builtintype" id="4985151">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4985156">return</span><br>
<span class="lineno"></span><span class="op" id="4985163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4985166">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">75</span><span class="keyword" id="4985235">func</span>&nbsp;<span class="op" id="4985240">(</span><span class="ident" id="4985241">sc</span>&nbsp;<span class="op" id="4985244">*</span><span class="ident" id="4985245">ServerConn</span><span class="op" id="4985255">)</span>&nbsp;<span class="ident" id="4985257">Close</span><span class="op" id="4985262">(</span><span class="op" id="4985263">)</span>&nbsp;<span class="builtintype" id="4985265">error</span>&nbsp;<span class="op" id="4985271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985274">c</span><span class="op" id="4985275">,</span>&nbsp;<span class="ident" id="4985277">_</span>&nbsp;<span class="op" id="4985279">:=</span>&nbsp;<span class="ident" id="4985282">sc</span><span class="op" id="4985284">.</span><span class="ident" id="4985285">Hijack</span><span class="op" id="4985291">(</span><span class="op" id="4985292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4985295">if</span>&nbsp;<span class="ident" id="4985298">c</span>&nbsp;<span class="op" id="4985300">!=</span>&nbsp;<span class="builtintype" id="4985303">nil</span>&nbsp;<span class="op" id="4985307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4985311">return</span>&nbsp;<span class="ident" id="4985318">c</span><span class="op" id="4985319">.</span><span class="ident" id="4985320">Close</span><span class="op" id="4985325">(</span><span class="op" id="4985326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4985329">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4985332">return</span>&nbsp;<span class="builtintype" id="4985339">nil</span><br>
<span class="lineno"></span><span class="op" id="4985343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4985346">//&nbsp;Read&nbsp;returns&nbsp;the&nbsp;next&nbsp;request&nbsp;on&nbsp;the&nbsp;wire.&nbsp;An&nbsp;ErrPersistEOF&nbsp;is&nbsp;returned&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4985424">//&nbsp;it&nbsp;is&nbsp;gracefully&nbsp;determined&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;requests&nbsp;(e.g.&nbsp;after&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="4985503">//&nbsp;first&nbsp;request&nbsp;on&nbsp;an&nbsp;HTTP/1.0&nbsp;connection,&nbsp;or&nbsp;after&nbsp;a&nbsp;Connection:close&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4985580">//&nbsp;HTTP/1.1&nbsp;connection).</span><br>
<span class="lineno"></span><span class="keyword" id="4985605">func</span>&nbsp;<span class="op" id="4985610">(</span><span class="ident" id="4985611">sc</span>&nbsp;<span class="op" id="4985614">*</span><span class="ident" id="4985615">ServerConn</span><span class="op" id="4985625">)</span>&nbsp;<span class="ident" id="4985627">Read</span><span class="op" id="4985631">(</span><span class="op" id="4985632">)</span>&nbsp;<span class="op" id="4985634">(</span><span class="ident" id="4985635">req</span>&nbsp;<span class="op" id="4985639">*</span><span class="ident" id="4985640">http</span><span class="op" id="4985644">.</span><span class="ident" id="4985645">Request</span><span class="op" id="4985652">,</span>&nbsp;<span class="ident" id="4985654">err</span>&nbsp;<span class="builtintype" id="4985658">error</span><span class="op" id="4985663">)</span>&nbsp;<span class="op" id="4985665">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4985669">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Reads&nbsp;and&nbsp;Writes</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985718">id</span>&nbsp;<span class="op" id="4985721">:=</span>&nbsp;<span class="ident" id="4985724">sc</span><span class="op" id="4985726">.</span><span class="ident" id="4985727">pipe</span><span class="op" id="4985731">.</span><span class="ident" id="4985732">Next</span><span class="op" id="4985736">(</span><span class="op" id="4985737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985740">sc</span><span class="op" id="4985742">.</span><span class="ident" id="4985743">pipe</span><span class="op" id="4985747">.</span><span class="ident" id="4985748">StartRequest</span><span class="op" id="4985760">(</span><span class="ident" id="4985761">id</span><span class="op" id="4985763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4985766">defer</span>&nbsp;<span class="keyword" id="4985772">func</span><span class="op" id="4985776">(</span><span class="op" id="4985777">)</span>&nbsp;<span class="op" id="4985779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985783">sc</span><span class="op" id="4985785">.</span><span class="ident" id="4985786">pipe</span><span class="op" id="4985790">.</span><span class="ident" id="4985791">EndRequest</span><span class="op" id="4985801">(</span><span class="ident" id="4985802">id</span><span class="op" id="4985804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4985808">if</span>&nbsp;<span class="ident" id="4985811">req</span>&nbsp;<span class="op" id="4985815">==</span>&nbsp;<span class="builtintype" id="4985818">nil</span>&nbsp;<span class="op" id="4985822">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985827">sc</span><span class="op" id="4985829">.</span><span class="ident" id="4985830">pipe</span><span class="op" id="4985834">.</span><span class="ident" id="4985835">StartResponse</span><span class="op" id="4985848">(</span><span class="ident" id="4985849">id</span><span class="op" id="4985851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985856">sc</span><span class="op" id="4985858">.</span><span class="ident" id="4985859">pipe</span><span class="op" id="4985863">.</span><span class="ident" id="4985864">EndResponse</span><span class="op" id="4985875">(</span><span class="ident" id="4985876">id</span><span class="op" id="4985878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4985882">}</span>&nbsp;<span class="keyword" id="4985884">else</span>&nbsp;<span class="op" id="4985889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4985894">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985941">sc</span><span class="op" id="4985943">.</span><span class="ident" id="4985944">lk</span><span class="op" id="4985946">.</span><span class="ident" id="4985947">Lock</span><span class="op" id="4985951">(</span><span class="op" id="4985952">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985957">sc</span><span class="op" id="4985959">.</span><span class="ident" id="4985960">pipereq</span><span class="op" id="4985967">[</span><span class="ident" id="4985968">req</span><span class="op" id="4985971">]</span>&nbsp;<span class="op" id="4985973">=</span>&nbsp;<span class="ident" id="4985975">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985981">sc</span><span class="op" id="4985983">.</span><span class="ident" id="4985984">lk</span><span class="op" id="4985986">.</span><span class="ident" id="4985987">Unlock</span><span class="op" id="4985993">(</span><span class="op" id="4985994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4985998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4986001">}</span><span class="op" id="4986002">(</span><span class="op" id="4986003">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4986007">sc</span><span class="op" id="4986009">.</span><span class="ident" id="4986010">lk</span><span class="op" id="4986012">.</span><span class="ident" id="4986013">Lock</span><span class="op" id="4986017">(</span><span class="op" id="4986018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4986021">if</span>&nbsp;<span class="ident" id="4986024">sc</span><span class="op" id="4986026">.</span><span class="ident" id="4986027">we</span>&nbsp;<span class="op" id="4986030">!=</span>&nbsp;<span class="builtintype" id="4986033">nil</span>&nbsp;<span class="op" id="4986037">{</span>&nbsp;<span class="comment" id="4986039">//&nbsp;no&nbsp;point&nbsp;receiving&nbsp;if&nbsp;write-side&nbsp;broken&nbsp;or&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4986094">defer</span>&nbsp;<span class="ident" id="4986100">sc</span><span class="op" id="4986102">.</span><span class="ident" id="4986103">lk</span><span class="op" id="4986105">.</span><span class="ident" id="4986106">Unlock</span><span class="op" id="4986112">(</span><span class="op" id="4986113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4986117">return</span>&nbsp;<span class="builtintype" id="4986124">nil</span><span class="op" id="4986127">,</span>&nbsp;<span class="ident" id="4986129">sc</span><span class="op" id="4986131">.</span><span class="ident" id="4986132">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4986136">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4986139">if</span>&nbsp;<span class="ident" id="4986142">sc</span><span class="op" id="4986144">.</span><span class="ident" id="4986145">re</span>&nbsp;<span class="op" id="4986148">!=</span>&nbsp;<span class="builtintype" id="4986151">nil</span>&nbsp;<span class="op" id="4986155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4986159">defer</span>&nbsp;<span class="ident" id="4986165">sc</span><span class="op" id="4986167">.</span><span class="ident" id="4986168">lk</span><span class="op" id="4986170">.</span><span class="ident" id="4986171">Unlock</span><span class="op" id="4986177">(</span><span class="op" id="4986178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4986182">return</span>&nbsp;<span class="builtintype" id="4986189">nil</span><span class="op" id="4986192">,</span>&nbsp;<span class="ident" id="4986194">sc</span><span class="op" id="4986196">.</span><span class="ident" id="4986197">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4986201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4986204">if</span>&nbsp;<span class="ident" id="4986207">sc</span><span class="op" id="4986209">.</span><span class="ident" id="4986210">r</span>&nbsp;<span class="op" id="4986212">==</span>&nbsp;<span class="builtintype" id="4986215">nil</span>&nbsp;<span class="op" id="4986219">{</span>&nbsp;<span class="comment" id="4986221">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4986268">defer</span>&nbsp;<span class="ident" id="4986274">sc</span><span class="op" id="4986276">.</span><span class="ident" id="4986277">lk</span><span class="op" id="4986279">.</span><span class="ident" id="4986280">Unlock</span><span class="op" id="4986286">(</span><span class="op" id="4986287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4986291">return</span>&nbsp;<span class="builtintype" id="4986298">nil</span><span class="op" id="4986301">,</span>&nbsp;<span class="ident" id="4986303">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4986314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4986317">r</span>&nbsp;<span class="op" id="4986319">:=</span>&nbsp;<span class="ident" id="4986322">sc</span><span class="op" id="4986324">.</span><span class="ident" id="4986325">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4986328">lastbody</span>&nbsp;<span class="op" id="4986337">:=</span>&nbsp;<span class="ident" id="4986340">sc</span><span class="op" id="4986342">.</span><span class="ident" id="4986343">lastbody</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4986353">sc</span><span class="op" id="4986355">.</span><span class="ident" id="4986356">lastbody</span>&nbsp;<span class="op" id="4986365">=</span>&nbsp;<span class="builtintype" id="4986367">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4986372">sc</span><span class="op" id="4986374">.</span><span class="ident" id="4986375">lk</span><span class="op" id="4986377">.</span><span class="ident" id="4986378">Unlock</span><span class="op" id="4986384">(</span><span class="op" id="4986385">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4986389">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4986465">if</span>&nbsp;<span class="ident" id="4986468">lastbody</span>&nbsp;<span class="op" id="4986477">!=</span>&nbsp;<span class="builtintype" id="4986480">nil</span>&nbsp;<span class="op" id="4986484">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4986488">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4986554">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4986612">//&nbsp;returned.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4986627">err</span>&nbsp;<span class="op" id="4986631">=</span>&nbsp;<span class="ident" id="4986633">lastbody</span><span class="op" id="4986641">.</span><span class="ident" id="4986642">Close</span><span class="op" id="4986647">(</span><span class="op" id="4986648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4986652">if</span>&nbsp;<span class="ident" id="4986655">err</span>&nbsp;<span class="op" id="4986659">!=</span>&nbsp;<span class="builtintype" id="4986662">nil</span>&nbsp;<span class="op" id="4986666">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4986671">sc</span><span class="op" id="4986673">.</span><span class="ident" id="4986674">lk</span><span class="op" id="4986676">.</span><span class="ident" id="4986677">Lock</span><span class="op" id="4986681">(</span><span class="op" id="4986682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4986687">defer</span>&nbsp;<span class="ident" id="4986693">sc</span><span class="op" id="4986695">.</span><span class="ident" id="4986696">lk</span><span class="op" id="4986698">.</span><span class="ident" id="4986699">Unlock</span><span class="op" id="4986705">(</span><span class="op" id="4986706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4986711">sc</span><span class="op" id="4986713">.</span><span class="ident" id="4986714">re</span>&nbsp;<span class="op" id="4986717">=</span>&nbsp;<span class="ident" id="4986719">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4986726">return</span>&nbsp;<span class="builtintype" id="4986733">nil</span><span class="op" id="4986736">,</span>&nbsp;<span class="ident" id="4986738">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4986744">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4986747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4986751">req</span><span class="op" id="4986754">,</span>&nbsp;<span class="ident" id="4986756">err</span>&nbsp;<span class="op" id="4986760">=</span>&nbsp;<span class="ident" id="4986762">http</span><span class="op" id="4986766">.</span><span class="ident" id="4986767">ReadRequest</span><span class="op" id="4986778">(</span><span class="ident" id="4986779">r</span><span class="op" id="4986780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4986783">sc</span><span class="op" id="4986785">.</span><span class="ident" id="4986786">lk</span><span class="op" id="4986788">.</span><span class="ident" id="4986789">Lock</span><span class="op" id="4986793">(</span><span class="op" id="4986794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4986797">defer</span>&nbsp;<span class="ident" id="4986803">sc</span><span class="op" id="4986805">.</span><span class="ident" id="4986806">lk</span><span class="op" id="4986808">.</span><span class="ident" id="4986809">Unlock</span><span class="op" id="4986815">(</span><span class="op" id="4986816">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4986819">if</span>&nbsp;<span class="ident" id="4986822">err</span>&nbsp;<span class="op" id="4986826">!=</span>&nbsp;<span class="builtintype" id="4986829">nil</span>&nbsp;<span class="op" id="4986833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4986837">if</span>&nbsp;<span class="ident" id="4986840">err</span>&nbsp;<span class="op" id="4986844">==</span>&nbsp;<span class="ident" id="4986847">io</span><span class="op" id="4986849">.</span><span class="ident" id="4986850">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="4986867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4986872">//&nbsp;A&nbsp;close&nbsp;from&nbsp;the&nbsp;opposing&nbsp;client&nbsp;is&nbsp;treated&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4986927">//&nbsp;graceful&nbsp;close,&nbsp;even&nbsp;if&nbsp;there&nbsp;was&nbsp;some&nbsp;unparse-able</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4986985">//&nbsp;data&nbsp;before&nbsp;the&nbsp;close.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4987014">sc</span><span class="op" id="4987016">.</span><span class="ident" id="4987017">re</span>&nbsp;<span class="op" id="4987020">=</span>&nbsp;<span class="ident" id="4987022">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4987039">return</span>&nbsp;<span class="builtintype" id="4987046">nil</span><span class="op" id="4987049">,</span>&nbsp;<span class="ident" id="4987051">sc</span><span class="op" id="4987053">.</span><span class="ident" id="4987054">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4987059">}</span>&nbsp;<span class="keyword" id="4987061">else</span>&nbsp;<span class="op" id="4987066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4987071">sc</span><span class="op" id="4987073">.</span><span class="ident" id="4987074">re</span>&nbsp;<span class="op" id="4987077">=</span>&nbsp;<span class="ident" id="4987079">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4987086">return</span>&nbsp;<span class="ident" id="4987093">req</span><span class="op" id="4987096">,</span>&nbsp;<span class="ident" id="4987098">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4987104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4987107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4987110">sc</span><span class="op" id="4987112">.</span><span class="ident" id="4987113">lastbody</span>&nbsp;<span class="op" id="4987122">=</span>&nbsp;<span class="ident" id="4987124">req</span><span class="op" id="4987127">.</span><span class="ident" id="4987128">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4987134">sc</span><span class="op" id="4987136">.</span><span class="ident" id="4987137">nread</span><span class="op" id="4987142">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4987146">if</span>&nbsp;<span class="ident" id="4987149">req</span><span class="op" id="4987152">.</span><span class="ident" id="4987153">Close</span>&nbsp;<span class="op" id="4987159">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4987163">sc</span><span class="op" id="4987165">.</span><span class="ident" id="4987166">re</span>&nbsp;<span class="op" id="4987169">=</span>&nbsp;<span class="ident" id="4987171">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4987187">return</span>&nbsp;<span class="ident" id="4987194">req</span><span class="op" id="4987197">,</span>&nbsp;<span class="ident" id="4987199">sc</span><span class="op" id="4987201">.</span><span class="ident" id="4987202">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4987206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4987209">return</span>&nbsp;<span class="ident" id="4987216">req</span><span class="op" id="4987219">,</span>&nbsp;<span class="ident" id="4987221">err</span><br>
<span class="lineno"></span><span class="op" id="4987225">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="4987228">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4987281">//&nbsp;that&nbsp;have&nbsp;been&nbsp;received&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4987327">func</span>&nbsp;<span class="op" id="4987332">(</span><span class="ident" id="4987333">sc</span>&nbsp;<span class="op" id="4987336">*</span><span class="ident" id="4987337">ServerConn</span><span class="op" id="4987347">)</span>&nbsp;<span class="ident" id="4987349">Pending</span><span class="op" id="4987356">(</span><span class="op" id="4987357">)</span>&nbsp;<span class="builtintype" id="4987359">int</span>&nbsp;<span class="op" id="4987363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4987366">sc</span><span class="op" id="4987368">.</span><span class="ident" id="4987369">lk</span><span class="op" id="4987371">.</span><span class="ident" id="4987372">Lock</span><span class="op" id="4987376">(</span><span class="op" id="4987377">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4987380">defer</span>&nbsp;<span class="ident" id="4987386">sc</span><span class="op" id="4987388">.</span><span class="ident" id="4987389">lk</span><span class="op" id="4987391">.</span><span class="ident" id="4987392">Unlock</span><span class="op" id="4987398">(</span><span class="op" id="4987399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4987402">return</span>&nbsp;<span class="ident" id="4987409">sc</span><span class="op" id="4987411">.</span><span class="ident" id="4987412">nread</span>&nbsp;<span class="op" id="4987418">-</span>&nbsp;<span class="ident" id="4987420">sc</span><span class="op" id="4987422">.</span><span class="ident" id="4987423">nwritten</span><br>
<span class="lineno"></span><span class="op" id="4987432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4987435">//&nbsp;Write&nbsp;writes&nbsp;resp&nbsp;in&nbsp;response&nbsp;to&nbsp;req.&nbsp;To&nbsp;close&nbsp;the&nbsp;connection&nbsp;gracefully,&nbsp;set&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="4987520">//&nbsp;Response.Close&nbsp;field&nbsp;to&nbsp;true.&nbsp;Write&nbsp;should&nbsp;be&nbsp;considered&nbsp;operational&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="4987598">//&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,&nbsp;regardless&nbsp;of&nbsp;any&nbsp;errors&nbsp;returned&nbsp;on&nbsp;the&nbsp;Read&nbsp;side.</span><br>
<span class="lineno"></span><span class="keyword" id="4987674">func</span>&nbsp;<span class="op" id="4987679">(</span><span class="ident" id="4987680">sc</span>&nbsp;<span class="op" id="4987683">*</span><span class="ident" id="4987684">ServerConn</span><span class="op" id="4987694">)</span>&nbsp;<span class="ident" id="4987696">Write</span><span class="op" id="4987701">(</span><span class="ident" id="4987702">req</span>&nbsp;<span class="op" id="4987706">*</span><span class="ident" id="4987707">http</span><span class="op" id="4987711">.</span><span class="ident" id="4987712">Request</span><span class="op" id="4987719">,</span>&nbsp;<span class="ident" id="4987721">resp</span>&nbsp;<span class="op" id="4987726">*</span><span class="ident" id="4987727">http</span><span class="op" id="4987731">.</span><span class="ident" id="4987732">Response</span><span class="op" id="4987740">)</span>&nbsp;<span class="builtintype" id="4987742">error</span>&nbsp;<span class="op" id="4987748">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4987752">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4987811">sc</span><span class="op" id="4987813">.</span><span class="ident" id="4987814">lk</span><span class="op" id="4987816">.</span><span class="ident" id="4987817">Lock</span><span class="op" id="4987821">(</span><span class="op" id="4987822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4987825">id</span><span class="op" id="4987827">,</span>&nbsp;<span class="ident" id="4987829">ok</span>&nbsp;<span class="op" id="4987832">:=</span>&nbsp;<span class="ident" id="4987835">sc</span><span class="op" id="4987837">.</span><span class="ident" id="4987838">pipereq</span><span class="op" id="4987845">[</span><span class="ident" id="4987846">req</span><span class="op" id="4987849">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4987852">delete</span><span class="op" id="4987858">(</span><span class="ident" id="4987859">sc</span><span class="op" id="4987861">.</span><span class="ident" id="4987862">pipereq</span><span class="op" id="4987869">,</span>&nbsp;<span class="ident" id="4987871">req</span><span class="op" id="4987874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4987877">if</span>&nbsp;<span class="op" id="4987880">!</span><span class="ident" id="4987881">ok</span>&nbsp;<span class="op" id="4987884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4987888">sc</span><span class="op" id="4987890">.</span><span class="ident" id="4987891">lk</span><span class="op" id="4987893">.</span><span class="ident" id="4987894">Unlock</span><span class="op" id="4987900">(</span><span class="op" id="4987901">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4987905">return</span>&nbsp;<span class="ident" id="4987912">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4987925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4987928">sc</span><span class="op" id="4987930">.</span><span class="ident" id="4987931">lk</span><span class="op" id="4987933">.</span><span class="ident" id="4987934">Unlock</span><span class="op" id="4987940">(</span><span class="op" id="4987941">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4987945">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4987971">sc</span><span class="op" id="4987973">.</span><span class="ident" id="4987974">pipe</span><span class="op" id="4987978">.</span><span class="ident" id="4987979">StartResponse</span><span class="op" id="4987992">(</span><span class="ident" id="4987993">id</span><span class="op" id="4987995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4987998">defer</span>&nbsp;<span class="ident" id="4988004">sc</span><span class="op" id="4988006">.</span><span class="ident" id="4988007">pipe</span><span class="op" id="4988011">.</span><span class="ident" id="4988012">EndResponse</span><span class="op" id="4988023">(</span><span class="ident" id="4988024">id</span><span class="op" id="4988026">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4988030">sc</span><span class="op" id="4988032">.</span><span class="ident" id="4988033">lk</span><span class="op" id="4988035">.</span><span class="ident" id="4988036">Lock</span><span class="op" id="4988040">(</span><span class="op" id="4988041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4988044">if</span>&nbsp;<span class="ident" id="4988047">sc</span><span class="op" id="4988049">.</span><span class="ident" id="4988050">we</span>&nbsp;<span class="op" id="4988053">!=</span>&nbsp;<span class="builtintype" id="4988056">nil</span>&nbsp;<span class="op" id="4988060">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4988064">defer</span>&nbsp;<span class="ident" id="4988070">sc</span><span class="op" id="4988072">.</span><span class="ident" id="4988073">lk</span><span class="op" id="4988075">.</span><span class="ident" id="4988076">Unlock</span><span class="op" id="4988082">(</span><span class="op" id="4988083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4988087">return</span>&nbsp;<span class="ident" id="4988094">sc</span><span class="op" id="4988096">.</span><span class="ident" id="4988097">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4988101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4988104">if</span>&nbsp;<span class="ident" id="4988107">sc</span><span class="op" id="4988109">.</span><span class="ident" id="4988110">c</span>&nbsp;<span class="op" id="4988112">==</span>&nbsp;<span class="builtintype" id="4988115">nil</span>&nbsp;<span class="op" id="4988119">{</span>&nbsp;<span class="comment" id="4988121">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4988168">defer</span>&nbsp;<span class="ident" id="4988174">sc</span><span class="op" id="4988176">.</span><span class="ident" id="4988177">lk</span><span class="op" id="4988179">.</span><span class="ident" id="4988180">Unlock</span><span class="op" id="4988186">(</span><span class="op" id="4988187">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4988191">return</span>&nbsp;<span class="ident" id="4988198">ErrClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4988209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4988212">c</span>&nbsp;<span class="op" id="4988214">:=</span>&nbsp;<span class="ident" id="4988217">sc</span><span class="op" id="4988219">.</span><span class="ident" id="4988220">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4988223">if</span>&nbsp;<span class="ident" id="4988226">sc</span><span class="op" id="4988228">.</span><span class="ident" id="4988229">nread</span>&nbsp;<span class="op" id="4988235">&lt;=</span>&nbsp;<span class="ident" id="4988238">sc</span><span class="op" id="4988240">.</span><span class="ident" id="4988241">nwritten</span>&nbsp;<span class="op" id="4988250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4988254">defer</span>&nbsp;<span class="ident" id="4988260">sc</span><span class="op" id="4988262">.</span><span class="ident" id="4988263">lk</span><span class="op" id="4988265">.</span><span class="ident" id="4988266">Unlock</span><span class="op" id="4988272">(</span><span class="op" id="4988273">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4988277">return</span>&nbsp;<span class="ident" id="4988284">errors</span><span class="op" id="4988290">.</span><span class="ident" id="4988291">New</span><span class="op" id="4988294">(</span><span class="string" id="4988295">&#34;persist&nbsp;server&nbsp;pipe&nbsp;count&#34;</span><span class="op" id="4988322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4988325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4988328">if</span>&nbsp;<span class="ident" id="4988331">resp</span><span class="op" id="4988335">.</span><span class="ident" id="4988336">Close</span>&nbsp;<span class="op" id="4988342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4988346">//&nbsp;After&nbsp;signaling&nbsp;a&nbsp;keep-alive&nbsp;close,&nbsp;any&nbsp;pipelined&nbsp;unread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4988408">//&nbsp;requests&nbsp;will&nbsp;be&nbsp;lost.&nbsp;It&nbsp;is&nbsp;up&nbsp;to&nbsp;the&nbsp;user&nbsp;to&nbsp;drain&nbsp;them</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4988471">//&nbsp;before&nbsp;signaling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4988494">sc</span><span class="op" id="4988496">.</span><span class="ident" id="4988497">re</span>&nbsp;<span class="op" id="4988500">=</span>&nbsp;<span class="ident" id="4988502">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4988517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4988520">sc</span><span class="op" id="4988522">.</span><span class="ident" id="4988523">lk</span><span class="op" id="4988525">.</span><span class="ident" id="4988526">Unlock</span><span class="op" id="4988532">(</span><span class="op" id="4988533">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4988537">err</span>&nbsp;<span class="op" id="4988541">:=</span>&nbsp;<span class="ident" id="4988544">resp</span><span class="op" id="4988548">.</span><span class="ident" id="4988549">Write</span><span class="op" id="4988554">(</span><span class="ident" id="4988555">c</span><span class="op" id="4988556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4988559">sc</span><span class="op" id="4988561">.</span><span class="ident" id="4988562">lk</span><span class="op" id="4988564">.</span><span class="ident" id="4988565">Lock</span><span class="op" id="4988569">(</span><span class="op" id="4988570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4988573">defer</span>&nbsp;<span class="ident" id="4988579">sc</span><span class="op" id="4988581">.</span><span class="ident" id="4988582">lk</span><span class="op" id="4988584">.</span><span class="ident" id="4988585">Unlock</span><span class="op" id="4988591">(</span><span class="op" id="4988592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4988595">if</span>&nbsp;<span class="ident" id="4988598">err</span>&nbsp;<span class="op" id="4988602">!=</span>&nbsp;<span class="builtintype" id="4988605">nil</span>&nbsp;<span class="op" id="4988609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4988613">sc</span><span class="op" id="4988615">.</span><span class="ident" id="4988616">we</span>&nbsp;<span class="op" id="4988619">=</span>&nbsp;<span class="ident" id="4988621">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4988627">return</span>&nbsp;<span class="ident" id="4988634">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4988639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4988642">sc</span><span class="op" id="4988644">.</span><span class="ident" id="4988645">nwritten</span><span class="op" id="4988653">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4988658">return</span>&nbsp;<span class="builtintype" id="4988665">nil</span><br>
<span class="lineno">220</span><span class="op" id="4988669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4988672">//&nbsp;A&nbsp;ClientConn&nbsp;sends&nbsp;request&nbsp;and&nbsp;receives&nbsp;headers&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="4988742">//&nbsp;connection,&nbsp;while&nbsp;respecting&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic.&nbsp;ClientConn</span><br>
<span class="lineno"></span><span class="comment" id="4988811">//&nbsp;supports&nbsp;hijacking&nbsp;the&nbsp;connection&nbsp;calling&nbsp;Hijack&nbsp;to</span><br>
<span class="lineno">225</span><span class="comment" id="4988866">//&nbsp;regain&nbsp;control&nbsp;of&nbsp;the&nbsp;underlying&nbsp;net.Conn&nbsp;and&nbsp;deal&nbsp;with&nbsp;it&nbsp;as&nbsp;desired.</span><br>
<span class="lineno"></span><span class="comment" id="4988940">//</span><br>
<span class="lineno"></span><span class="comment" id="4988943">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="4989011">//&nbsp;Client&nbsp;or&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4989059">type</span>&nbsp;<span class="ident" id="4989064">ClientConn</span>&nbsp;<span class="keyword" id="4989075">struct</span>&nbsp;<span class="op" id="4989082">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989085">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989101">sync</span><span class="op" id="4989105">.</span><span class="ident" id="4989106">Mutex</span>&nbsp;<span class="comment" id="4989112">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989157">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989173">net</span><span class="op" id="4989176">.</span><span class="ident" id="4989177">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989183">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4989199">*</span><span class="ident" id="4989200">bufio</span><span class="op" id="4989205">.</span><span class="ident" id="4989206">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989214">re</span><span class="op" id="4989216">,</span>&nbsp;<span class="ident" id="4989218">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4989230">error</span>&nbsp;<span class="comment" id="4989236">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989258">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989274">io</span><span class="op" id="4989276">.</span><span class="ident" id="4989277">ReadCloser</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989289">nread</span><span class="op" id="4989294">,</span>&nbsp;<span class="ident" id="4989296">nwritten</span>&nbsp;<span class="builtintype" id="4989305">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989310">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4989326">map</span><span class="op" id="4989329">[</span><span class="op" id="4989330">*</span><span class="ident" id="4989331">http</span><span class="op" id="4989335">.</span><span class="ident" id="4989336">Request</span><span class="op" id="4989343">]</span><span class="builtintype" id="4989344">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989351">pipe</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989360">textproto</span><span class="op" id="4989369">.</span><span class="ident" id="4989370">Pipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989380">writeReq</span>&nbsp;<span class="keyword" id="4989389">func</span><span class="op" id="4989393">(</span><span class="op" id="4989394">*</span><span class="ident" id="4989395">http</span><span class="op" id="4989399">.</span><span class="ident" id="4989400">Request</span><span class="op" id="4989407">,</span>&nbsp;<span class="ident" id="4989409">io</span><span class="op" id="4989411">.</span><span class="ident" id="4989412">Writer</span><span class="op" id="4989418">)</span>&nbsp;<span class="builtintype" id="4989420">error</span><br>
<span class="lineno">240</span><span class="op" id="4989426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4989429">//&nbsp;NewClientConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ClientConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="4989507">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno"></span><span class="comment" id="4989555">//</span><br>
<span class="lineno">245</span><span class="comment" id="4989558">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;use&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4989628">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4989666">func</span>&nbsp;<span class="ident" id="4989671">NewClientConn</span><span class="op" id="4989684">(</span><span class="ident" id="4989685">c</span>&nbsp;<span class="ident" id="4989687">net</span><span class="op" id="4989690">.</span><span class="ident" id="4989691">Conn</span><span class="op" id="4989695">,</span>&nbsp;<span class="ident" id="4989697">r</span>&nbsp;<span class="op" id="4989699">*</span><span class="ident" id="4989700">bufio</span><span class="op" id="4989705">.</span><span class="ident" id="4989706">Reader</span><span class="op" id="4989712">)</span>&nbsp;<span class="op" id="4989714">*</span><span class="ident" id="4989715">ClientConn</span>&nbsp;<span class="op" id="4989726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4989729">if</span>&nbsp;<span class="ident" id="4989732">r</span>&nbsp;<span class="op" id="4989734">==</span>&nbsp;<span class="builtintype" id="4989737">nil</span>&nbsp;<span class="op" id="4989741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989745">r</span>&nbsp;<span class="op" id="4989747">=</span>&nbsp;<span class="ident" id="4989749">bufio</span><span class="op" id="4989754">.</span><span class="ident" id="4989755">NewReader</span><span class="op" id="4989764">(</span><span class="ident" id="4989765">c</span><span class="op" id="4989766">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4989769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4989772">return</span>&nbsp;<span class="op" id="4989779">&amp;</span><span class="ident" id="4989780">ClientConn</span><span class="op" id="4989790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989794">c</span><span class="op" id="4989795">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989804">c</span><span class="op" id="4989805">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989809">r</span><span class="op" id="4989810">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989819">r</span><span class="op" id="4989820">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989824">pipereq</span><span class="op" id="4989831">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="4989834">make</span><span class="op" id="4989838">(</span><span class="keyword" id="4989839">map</span><span class="op" id="4989842">[</span><span class="op" id="4989843">*</span><span class="ident" id="4989844">http</span><span class="op" id="4989848">.</span><span class="ident" id="4989849">Request</span><span class="op" id="4989856">]</span><span class="builtintype" id="4989857">uint</span><span class="op" id="4989861">)</span><span class="op" id="4989862">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4989866">writeReq</span><span class="op" id="4989874">:</span>&nbsp;<span class="op" id="4989876">(</span><span class="op" id="4989877">*</span><span class="ident" id="4989878">http</span><span class="op" id="4989882">.</span><span class="ident" id="4989883">Request</span><span class="op" id="4989890">)</span><span class="op" id="4989891">.</span><span class="ident" id="4989892">Write</span><span class="op" id="4989897">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4989900">}</span><br>
<span class="lineno"></span><span class="op" id="4989902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4989905">//&nbsp;NewProxyClientConn&nbsp;works&nbsp;like&nbsp;NewClientConn&nbsp;but&nbsp;writes&nbsp;Requests</span><br>
<span class="lineno">260</span><span class="comment" id="4989972">//&nbsp;using&nbsp;Request&#39;s&nbsp;WriteProxy&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="4990010">//</span><br>
<span class="lineno"></span><span class="comment" id="4990013">//&nbsp;New&nbsp;code&nbsp;should&nbsp;not&nbsp;use&nbsp;NewProxyClientConn.&nbsp;See&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4990074">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="4990120">func</span>&nbsp;<span class="ident" id="4990125">NewProxyClientConn</span><span class="op" id="4990143">(</span><span class="ident" id="4990144">c</span>&nbsp;<span class="ident" id="4990146">net</span><span class="op" id="4990149">.</span><span class="ident" id="4990150">Conn</span><span class="op" id="4990154">,</span>&nbsp;<span class="ident" id="4990156">r</span>&nbsp;<span class="op" id="4990158">*</span><span class="ident" id="4990159">bufio</span><span class="op" id="4990164">.</span><span class="ident" id="4990165">Reader</span><span class="op" id="4990171">)</span>&nbsp;<span class="op" id="4990173">*</span><span class="ident" id="4990174">ClientConn</span>&nbsp;<span class="op" id="4990185">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990188">cc</span>&nbsp;<span class="op" id="4990191">:=</span>&nbsp;<span class="ident" id="4990194">NewClientConn</span><span class="op" id="4990207">(</span><span class="ident" id="4990208">c</span><span class="op" id="4990209">,</span>&nbsp;<span class="ident" id="4990211">r</span><span class="op" id="4990212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990215">cc</span><span class="op" id="4990217">.</span><span class="ident" id="4990218">writeReq</span>&nbsp;<span class="op" id="4990227">=</span>&nbsp;<span class="op" id="4990229">(</span><span class="op" id="4990230">*</span><span class="ident" id="4990231">http</span><span class="op" id="4990235">.</span><span class="ident" id="4990236">Request</span><span class="op" id="4990243">)</span><span class="op" id="4990244">.</span><span class="ident" id="4990245">WriteProxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4990257">return</span>&nbsp;<span class="ident" id="4990264">cc</span><br>
<span class="lineno"></span><span class="op" id="4990267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="4990270">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ClientConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="4990350">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4990426">//&nbsp;called&nbsp;before&nbsp;the&nbsp;user&nbsp;or&nbsp;Read&nbsp;have&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive</span><br>
<span class="lineno"></span><span class="comment" id="4990500">//&nbsp;logic.&nbsp;The&nbsp;user&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="4990578">func</span>&nbsp;<span class="op" id="4990583">(</span><span class="ident" id="4990584">cc</span>&nbsp;<span class="op" id="4990587">*</span><span class="ident" id="4990588">ClientConn</span><span class="op" id="4990598">)</span>&nbsp;<span class="ident" id="4990600">Hijack</span><span class="op" id="4990606">(</span><span class="op" id="4990607">)</span>&nbsp;<span class="op" id="4990609">(</span><span class="ident" id="4990610">c</span>&nbsp;<span class="ident" id="4990612">net</span><span class="op" id="4990615">.</span><span class="ident" id="4990616">Conn</span><span class="op" id="4990620">,</span>&nbsp;<span class="ident" id="4990622">r</span>&nbsp;<span class="op" id="4990624">*</span><span class="ident" id="4990625">bufio</span><span class="op" id="4990630">.</span><span class="ident" id="4990631">Reader</span><span class="op" id="4990637">)</span>&nbsp;<span class="op" id="4990639">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990642">cc</span><span class="op" id="4990644">.</span><span class="ident" id="4990645">lk</span><span class="op" id="4990647">.</span><span class="ident" id="4990648">Lock</span><span class="op" id="4990652">(</span><span class="op" id="4990653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4990656">defer</span>&nbsp;<span class="ident" id="4990662">cc</span><span class="op" id="4990664">.</span><span class="ident" id="4990665">lk</span><span class="op" id="4990667">.</span><span class="ident" id="4990668">Unlock</span><span class="op" id="4990674">(</span><span class="op" id="4990675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990678">c</span>&nbsp;<span class="op" id="4990680">=</span>&nbsp;<span class="ident" id="4990682">cc</span><span class="op" id="4990684">.</span><span class="ident" id="4990685">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990688">r</span>&nbsp;<span class="op" id="4990690">=</span>&nbsp;<span class="ident" id="4990692">cc</span><span class="op" id="4990694">.</span><span class="ident" id="4990695">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990698">cc</span><span class="op" id="4990700">.</span><span class="ident" id="4990701">c</span>&nbsp;<span class="op" id="4990703">=</span>&nbsp;<span class="builtintype" id="4990705">nil</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990710">cc</span><span class="op" id="4990712">.</span><span class="ident" id="4990713">r</span>&nbsp;<span class="op" id="4990715">=</span>&nbsp;<span class="builtintype" id="4990717">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4990722">return</span><br>
<span class="lineno"></span><span class="op" id="4990729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4990732">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">285</span><span class="keyword" id="4990801">func</span>&nbsp;<span class="op" id="4990806">(</span><span class="ident" id="4990807">cc</span>&nbsp;<span class="op" id="4990810">*</span><span class="ident" id="4990811">ClientConn</span><span class="op" id="4990821">)</span>&nbsp;<span class="ident" id="4990823">Close</span><span class="op" id="4990828">(</span><span class="op" id="4990829">)</span>&nbsp;<span class="builtintype" id="4990831">error</span>&nbsp;<span class="op" id="4990837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990840">c</span><span class="op" id="4990841">,</span>&nbsp;<span class="ident" id="4990843">_</span>&nbsp;<span class="op" id="4990845">:=</span>&nbsp;<span class="ident" id="4990848">cc</span><span class="op" id="4990850">.</span><span class="ident" id="4990851">Hijack</span><span class="op" id="4990857">(</span><span class="op" id="4990858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4990861">if</span>&nbsp;<span class="ident" id="4990864">c</span>&nbsp;<span class="op" id="4990866">!=</span>&nbsp;<span class="builtintype" id="4990869">nil</span>&nbsp;<span class="op" id="4990873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4990877">return</span>&nbsp;<span class="ident" id="4990884">c</span><span class="op" id="4990885">.</span><span class="ident" id="4990886">Close</span><span class="op" id="4990891">(</span><span class="op" id="4990892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4990895">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4990898">return</span>&nbsp;<span class="builtintype" id="4990905">nil</span><br>
<span class="lineno"></span><span class="op" id="4990909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4990912">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;request.&nbsp;An&nbsp;ErrPersistEOF&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="4990992">//&nbsp;has&nbsp;been&nbsp;closed&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;keepalive&nbsp;sense.&nbsp;If&nbsp;req.Close&nbsp;equals&nbsp;true,&nbsp;the</span><br>
<span class="lineno">295</span><span class="comment" id="4991069">//&nbsp;keepalive&nbsp;connection&nbsp;is&nbsp;logically&nbsp;closed&nbsp;after&nbsp;this&nbsp;request&nbsp;and&nbsp;the&nbsp;opposing</span><br>
<span class="lineno"></span><span class="comment" id="4991149">//&nbsp;server&nbsp;is&nbsp;informed.&nbsp;An&nbsp;ErrUnexpectedEOF&nbsp;indicates&nbsp;the&nbsp;remote&nbsp;closed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4991224">//&nbsp;underlying&nbsp;TCP&nbsp;connection,&nbsp;which&nbsp;is&nbsp;usually&nbsp;considered&nbsp;as&nbsp;graceful&nbsp;close.</span><br>
<span class="lineno"></span><span class="keyword" id="4991301">func</span>&nbsp;<span class="op" id="4991306">(</span><span class="ident" id="4991307">cc</span>&nbsp;<span class="op" id="4991310">*</span><span class="ident" id="4991311">ClientConn</span><span class="op" id="4991321">)</span>&nbsp;<span class="ident" id="4991323">Write</span><span class="op" id="4991328">(</span><span class="ident" id="4991329">req</span>&nbsp;<span class="op" id="4991333">*</span><span class="ident" id="4991334">http</span><span class="op" id="4991338">.</span><span class="ident" id="4991339">Request</span><span class="op" id="4991346">)</span>&nbsp;<span class="op" id="4991348">(</span><span class="ident" id="4991349">err</span>&nbsp;<span class="builtintype" id="4991353">error</span><span class="op" id="4991358">)</span>&nbsp;<span class="op" id="4991360">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4991364">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4991403">id</span>&nbsp;<span class="op" id="4991406">:=</span>&nbsp;<span class="ident" id="4991409">cc</span><span class="op" id="4991411">.</span><span class="ident" id="4991412">pipe</span><span class="op" id="4991416">.</span><span class="ident" id="4991417">Next</span><span class="op" id="4991421">(</span><span class="op" id="4991422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4991425">cc</span><span class="op" id="4991427">.</span><span class="ident" id="4991428">pipe</span><span class="op" id="4991432">.</span><span class="ident" id="4991433">StartRequest</span><span class="op" id="4991445">(</span><span class="ident" id="4991446">id</span><span class="op" id="4991448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4991451">defer</span>&nbsp;<span class="keyword" id="4991457">func</span><span class="op" id="4991461">(</span><span class="op" id="4991462">)</span>&nbsp;<span class="op" id="4991464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4991468">cc</span><span class="op" id="4991470">.</span><span class="ident" id="4991471">pipe</span><span class="op" id="4991475">.</span><span class="ident" id="4991476">EndRequest</span><span class="op" id="4991486">(</span><span class="ident" id="4991487">id</span><span class="op" id="4991489">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4991493">if</span>&nbsp;<span class="ident" id="4991496">err</span>&nbsp;<span class="op" id="4991500">!=</span>&nbsp;<span class="builtintype" id="4991503">nil</span>&nbsp;<span class="op" id="4991507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4991512">cc</span><span class="op" id="4991514">.</span><span class="ident" id="4991515">pipe</span><span class="op" id="4991519">.</span><span class="ident" id="4991520">StartResponse</span><span class="op" id="4991533">(</span><span class="ident" id="4991534">id</span><span class="op" id="4991536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4991541">cc</span><span class="op" id="4991543">.</span><span class="ident" id="4991544">pipe</span><span class="op" id="4991548">.</span><span class="ident" id="4991549">EndResponse</span><span class="op" id="4991560">(</span><span class="ident" id="4991561">id</span><span class="op" id="4991563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991567">}</span>&nbsp;<span class="keyword" id="4991569">else</span>&nbsp;<span class="op" id="4991574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4991579">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4991626">cc</span><span class="op" id="4991628">.</span><span class="ident" id="4991629">lk</span><span class="op" id="4991631">.</span><span class="ident" id="4991632">Lock</span><span class="op" id="4991636">(</span><span class="op" id="4991637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4991642">cc</span><span class="op" id="4991644">.</span><span class="ident" id="4991645">pipereq</span><span class="op" id="4991652">[</span><span class="ident" id="4991653">req</span><span class="op" id="4991656">]</span>&nbsp;<span class="op" id="4991658">=</span>&nbsp;<span class="ident" id="4991660">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4991666">cc</span><span class="op" id="4991668">.</span><span class="ident" id="4991669">lk</span><span class="op" id="4991671">.</span><span class="ident" id="4991672">Unlock</span><span class="op" id="4991678">(</span><span class="op" id="4991679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991686">}</span><span class="op" id="4991687">(</span><span class="op" id="4991688">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4991692">cc</span><span class="op" id="4991694">.</span><span class="ident" id="4991695">lk</span><span class="op" id="4991697">.</span><span class="ident" id="4991698">Lock</span><span class="op" id="4991702">(</span><span class="op" id="4991703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4991706">if</span>&nbsp;<span class="ident" id="4991709">cc</span><span class="op" id="4991711">.</span><span class="ident" id="4991712">re</span>&nbsp;<span class="op" id="4991715">!=</span>&nbsp;<span class="builtintype" id="4991718">nil</span>&nbsp;<span class="op" id="4991722">{</span>&nbsp;<span class="comment" id="4991724">//&nbsp;no&nbsp;point&nbsp;sending&nbsp;if&nbsp;read-side&nbsp;closed&nbsp;or&nbsp;broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4991776">defer</span>&nbsp;<span class="ident" id="4991782">cc</span><span class="op" id="4991784">.</span><span class="ident" id="4991785">lk</span><span class="op" id="4991787">.</span><span class="ident" id="4991788">Unlock</span><span class="op" id="4991794">(</span><span class="op" id="4991795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4991799">return</span>&nbsp;<span class="ident" id="4991806">cc</span><span class="op" id="4991808">.</span><span class="ident" id="4991809">re</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4991816">if</span>&nbsp;<span class="ident" id="4991819">cc</span><span class="op" id="4991821">.</span><span class="ident" id="4991822">we</span>&nbsp;<span class="op" id="4991825">!=</span>&nbsp;<span class="builtintype" id="4991828">nil</span>&nbsp;<span class="op" id="4991832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4991836">defer</span>&nbsp;<span class="ident" id="4991842">cc</span><span class="op" id="4991844">.</span><span class="ident" id="4991845">lk</span><span class="op" id="4991847">.</span><span class="ident" id="4991848">Unlock</span><span class="op" id="4991854">(</span><span class="op" id="4991855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4991859">return</span>&nbsp;<span class="ident" id="4991866">cc</span><span class="op" id="4991868">.</span><span class="ident" id="4991869">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991873">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4991876">if</span>&nbsp;<span class="ident" id="4991879">cc</span><span class="op" id="4991881">.</span><span class="ident" id="4991882">c</span>&nbsp;<span class="op" id="4991884">==</span>&nbsp;<span class="builtintype" id="4991887">nil</span>&nbsp;<span class="op" id="4991891">{</span>&nbsp;<span class="comment" id="4991893">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4991940">defer</span>&nbsp;<span class="ident" id="4991946">cc</span><span class="op" id="4991948">.</span><span class="ident" id="4991949">lk</span><span class="op" id="4991951">.</span><span class="ident" id="4991952">Unlock</span><span class="op" id="4991958">(</span><span class="op" id="4991959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4991963">return</span>&nbsp;<span class="ident" id="4991970">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4991984">c</span>&nbsp;<span class="op" id="4991986">:=</span>&nbsp;<span class="ident" id="4991989">cc</span><span class="op" id="4991991">.</span><span class="ident" id="4991992">c</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4991995">if</span>&nbsp;<span class="ident" id="4991998">req</span><span class="op" id="4992001">.</span><span class="ident" id="4992002">Close</span>&nbsp;<span class="op" id="4992008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4992012">//&nbsp;We&nbsp;write&nbsp;the&nbsp;EOF&nbsp;to&nbsp;the&nbsp;write-side&nbsp;error,&nbsp;because&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4992073">//&nbsp;still&nbsp;might&nbsp;be&nbsp;some&nbsp;pipelined&nbsp;reads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4992114">cc</span><span class="op" id="4992116">.</span><span class="ident" id="4992117">we</span>&nbsp;<span class="op" id="4992120">=</span>&nbsp;<span class="ident" id="4992122">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4992137">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4992140">cc</span><span class="op" id="4992142">.</span><span class="ident" id="4992143">lk</span><span class="op" id="4992145">.</span><span class="ident" id="4992146">Unlock</span><span class="op" id="4992152">(</span><span class="op" id="4992153">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4992157">err</span>&nbsp;<span class="op" id="4992161">=</span>&nbsp;<span class="ident" id="4992163">cc</span><span class="op" id="4992165">.</span><span class="ident" id="4992166">writeReq</span><span class="op" id="4992174">(</span><span class="ident" id="4992175">req</span><span class="op" id="4992178">,</span>&nbsp;<span class="ident" id="4992180">c</span><span class="op" id="4992181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4992184">cc</span><span class="op" id="4992186">.</span><span class="ident" id="4992187">lk</span><span class="op" id="4992189">.</span><span class="ident" id="4992190">Lock</span><span class="op" id="4992194">(</span><span class="op" id="4992195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4992198">defer</span>&nbsp;<span class="ident" id="4992204">cc</span><span class="op" id="4992206">.</span><span class="ident" id="4992207">lk</span><span class="op" id="4992209">.</span><span class="ident" id="4992210">Unlock</span><span class="op" id="4992216">(</span><span class="op" id="4992217">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4992220">if</span>&nbsp;<span class="ident" id="4992223">err</span>&nbsp;<span class="op" id="4992227">!=</span>&nbsp;<span class="builtintype" id="4992230">nil</span>&nbsp;<span class="op" id="4992234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4992238">cc</span><span class="op" id="4992240">.</span><span class="ident" id="4992241">we</span>&nbsp;<span class="op" id="4992244">=</span>&nbsp;<span class="ident" id="4992246">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4992252">return</span>&nbsp;<span class="ident" id="4992259">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4992264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4992267">cc</span><span class="op" id="4992269">.</span><span class="ident" id="4992270">nwritten</span><span class="op" id="4992278">++</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4992283">return</span>&nbsp;<span class="builtintype" id="4992290">nil</span><br>
<span class="lineno"></span><span class="op" id="4992294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4992297">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno">350</span><span class="comment" id="4992350">//&nbsp;that&nbsp;have&nbsp;been&nbsp;sent&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4992392">func</span>&nbsp;<span class="op" id="4992397">(</span><span class="ident" id="4992398">cc</span>&nbsp;<span class="op" id="4992401">*</span><span class="ident" id="4992402">ClientConn</span><span class="op" id="4992412">)</span>&nbsp;<span class="ident" id="4992414">Pending</span><span class="op" id="4992421">(</span><span class="op" id="4992422">)</span>&nbsp;<span class="builtintype" id="4992424">int</span>&nbsp;<span class="op" id="4992428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4992431">cc</span><span class="op" id="4992433">.</span><span class="ident" id="4992434">lk</span><span class="op" id="4992436">.</span><span class="ident" id="4992437">Lock</span><span class="op" id="4992441">(</span><span class="op" id="4992442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4992445">defer</span>&nbsp;<span class="ident" id="4992451">cc</span><span class="op" id="4992453">.</span><span class="ident" id="4992454">lk</span><span class="op" id="4992456">.</span><span class="ident" id="4992457">Unlock</span><span class="op" id="4992463">(</span><span class="op" id="4992464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4992467">return</span>&nbsp;<span class="ident" id="4992474">cc</span><span class="op" id="4992476">.</span><span class="ident" id="4992477">nwritten</span>&nbsp;<span class="op" id="4992486">-</span>&nbsp;<span class="ident" id="4992488">cc</span><span class="op" id="4992490">.</span><span class="ident" id="4992491">nread</span><br>
<span class="lineno">355</span><span class="op" id="4992497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4992500">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;next&nbsp;response&nbsp;from&nbsp;the&nbsp;wire.&nbsp;A&nbsp;valid&nbsp;response&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4992573">//&nbsp;returned&nbsp;together&nbsp;with&nbsp;an&nbsp;ErrPersistEOF,&nbsp;which&nbsp;means&nbsp;that&nbsp;the&nbsp;remote</span><br>
<span class="lineno"></span><span class="comment" id="4992645">//&nbsp;requested&nbsp;that&nbsp;this&nbsp;be&nbsp;the&nbsp;last&nbsp;request&nbsp;serviced.&nbsp;Read&nbsp;can&nbsp;be&nbsp;called</span><br>
<span class="lineno">360</span><span class="comment" id="4992717">//&nbsp;concurrently&nbsp;with&nbsp;Write,&nbsp;but&nbsp;not&nbsp;with&nbsp;another&nbsp;Read.</span><br>
<span class="lineno"></span><span class="keyword" id="4992772">func</span>&nbsp;<span class="op" id="4992777">(</span><span class="ident" id="4992778">cc</span>&nbsp;<span class="op" id="4992781">*</span><span class="ident" id="4992782">ClientConn</span><span class="op" id="4992792">)</span>&nbsp;<span class="ident" id="4992794">Read</span><span class="op" id="4992798">(</span><span class="ident" id="4992799">req</span>&nbsp;<span class="op" id="4992803">*</span><span class="ident" id="4992804">http</span><span class="op" id="4992808">.</span><span class="ident" id="4992809">Request</span><span class="op" id="4992816">)</span>&nbsp;<span class="op" id="4992818">(</span><span class="ident" id="4992819">resp</span>&nbsp;<span class="op" id="4992824">*</span><span class="ident" id="4992825">http</span><span class="op" id="4992829">.</span><span class="ident" id="4992830">Response</span><span class="op" id="4992838">,</span>&nbsp;<span class="ident" id="4992840">err</span>&nbsp;<span class="builtintype" id="4992844">error</span><span class="op" id="4992849">)</span>&nbsp;<span class="op" id="4992851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4992854">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4992913">cc</span><span class="op" id="4992915">.</span><span class="ident" id="4992916">lk</span><span class="op" id="4992918">.</span><span class="ident" id="4992919">Lock</span><span class="op" id="4992923">(</span><span class="op" id="4992924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4992927">id</span><span class="op" id="4992929">,</span>&nbsp;<span class="ident" id="4992931">ok</span>&nbsp;<span class="op" id="4992934">:=</span>&nbsp;<span class="ident" id="4992937">cc</span><span class="op" id="4992939">.</span><span class="ident" id="4992940">pipereq</span><span class="op" id="4992947">[</span><span class="ident" id="4992948">req</span><span class="op" id="4992951">]</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4992954">delete</span><span class="op" id="4992960">(</span><span class="ident" id="4992961">cc</span><span class="op" id="4992963">.</span><span class="ident" id="4992964">pipereq</span><span class="op" id="4992971">,</span>&nbsp;<span class="ident" id="4992973">req</span><span class="op" id="4992976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4992979">if</span>&nbsp;<span class="op" id="4992982">!</span><span class="ident" id="4992983">ok</span>&nbsp;<span class="op" id="4992986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4992990">cc</span><span class="op" id="4992992">.</span><span class="ident" id="4992993">lk</span><span class="op" id="4992995">.</span><span class="ident" id="4992996">Unlock</span><span class="op" id="4993002">(</span><span class="op" id="4993003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4993007">return</span>&nbsp;<span class="builtintype" id="4993014">nil</span><span class="op" id="4993017">,</span>&nbsp;<span class="ident" id="4993019">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4993032">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4993035">cc</span><span class="op" id="4993037">.</span><span class="ident" id="4993038">lk</span><span class="op" id="4993040">.</span><span class="ident" id="4993041">Unlock</span><span class="op" id="4993047">(</span><span class="op" id="4993048">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4993052">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4993078">cc</span><span class="op" id="4993080">.</span><span class="ident" id="4993081">pipe</span><span class="op" id="4993085">.</span><span class="ident" id="4993086">StartResponse</span><span class="op" id="4993099">(</span><span class="ident" id="4993100">id</span><span class="op" id="4993102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4993105">defer</span>&nbsp;<span class="ident" id="4993111">cc</span><span class="op" id="4993113">.</span><span class="ident" id="4993114">pipe</span><span class="op" id="4993118">.</span><span class="ident" id="4993119">EndResponse</span><span class="op" id="4993130">(</span><span class="ident" id="4993131">id</span><span class="op" id="4993133">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4993137">cc</span><span class="op" id="4993139">.</span><span class="ident" id="4993140">lk</span><span class="op" id="4993142">.</span><span class="ident" id="4993143">Lock</span><span class="op" id="4993147">(</span><span class="op" id="4993148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4993151">if</span>&nbsp;<span class="ident" id="4993154">cc</span><span class="op" id="4993156">.</span><span class="ident" id="4993157">re</span>&nbsp;<span class="op" id="4993160">!=</span>&nbsp;<span class="builtintype" id="4993163">nil</span>&nbsp;<span class="op" id="4993167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4993171">defer</span>&nbsp;<span class="ident" id="4993177">cc</span><span class="op" id="4993179">.</span><span class="ident" id="4993180">lk</span><span class="op" id="4993182">.</span><span class="ident" id="4993183">Unlock</span><span class="op" id="4993189">(</span><span class="op" id="4993190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4993194">return</span>&nbsp;<span class="builtintype" id="4993201">nil</span><span class="op" id="4993204">,</span>&nbsp;<span class="ident" id="4993206">cc</span><span class="op" id="4993208">.</span><span class="ident" id="4993209">re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4993213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4993216">if</span>&nbsp;<span class="ident" id="4993219">cc</span><span class="op" id="4993221">.</span><span class="ident" id="4993222">r</span>&nbsp;<span class="op" id="4993224">==</span>&nbsp;<span class="builtintype" id="4993227">nil</span>&nbsp;<span class="op" id="4993231">{</span>&nbsp;<span class="comment" id="4993233">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4993280">defer</span>&nbsp;<span class="ident" id="4993286">cc</span><span class="op" id="4993288">.</span><span class="ident" id="4993289">lk</span><span class="op" id="4993291">.</span><span class="ident" id="4993292">Unlock</span><span class="op" id="4993298">(</span><span class="op" id="4993299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4993303">return</span>&nbsp;<span class="builtintype" id="4993310">nil</span><span class="op" id="4993313">,</span>&nbsp;<span class="ident" id="4993315">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4993326">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4993329">r</span>&nbsp;<span class="op" id="4993331">:=</span>&nbsp;<span class="ident" id="4993334">cc</span><span class="op" id="4993336">.</span><span class="ident" id="4993337">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4993340">lastbody</span>&nbsp;<span class="op" id="4993349">:=</span>&nbsp;<span class="ident" id="4993352">cc</span><span class="op" id="4993354">.</span><span class="ident" id="4993355">lastbody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4993365">cc</span><span class="op" id="4993367">.</span><span class="ident" id="4993368">lastbody</span>&nbsp;<span class="op" id="4993377">=</span>&nbsp;<span class="builtintype" id="4993379">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4993384">cc</span><span class="op" id="4993386">.</span><span class="ident" id="4993387">lk</span><span class="op" id="4993389">.</span><span class="ident" id="4993390">Unlock</span><span class="op" id="4993396">(</span><span class="op" id="4993397">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4993401">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4993477">if</span>&nbsp;<span class="ident" id="4993480">lastbody</span>&nbsp;<span class="op" id="4993489">!=</span>&nbsp;<span class="builtintype" id="4993492">nil</span>&nbsp;<span class="op" id="4993496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4993500">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4993566">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4993624">//&nbsp;returned.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4993639">err</span>&nbsp;<span class="op" id="4993643">=</span>&nbsp;<span class="ident" id="4993645">lastbody</span><span class="op" id="4993653">.</span><span class="ident" id="4993654">Close</span><span class="op" id="4993659">(</span><span class="op" id="4993660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4993664">if</span>&nbsp;<span class="ident" id="4993667">err</span>&nbsp;<span class="op" id="4993671">!=</span>&nbsp;<span class="builtintype" id="4993674">nil</span>&nbsp;<span class="op" id="4993678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4993683">cc</span><span class="op" id="4993685">.</span><span class="ident" id="4993686">lk</span><span class="op" id="4993688">.</span><span class="ident" id="4993689">Lock</span><span class="op" id="4993693">(</span><span class="op" id="4993694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4993699">defer</span>&nbsp;<span class="ident" id="4993705">cc</span><span class="op" id="4993707">.</span><span class="ident" id="4993708">lk</span><span class="op" id="4993710">.</span><span class="ident" id="4993711">Unlock</span><span class="op" id="4993717">(</span><span class="op" id="4993718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4993723">cc</span><span class="op" id="4993725">.</span><span class="ident" id="4993726">re</span>&nbsp;<span class="op" id="4993729">=</span>&nbsp;<span class="ident" id="4993731">err</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4993738">return</span>&nbsp;<span class="builtintype" id="4993745">nil</span><span class="op" id="4993748">,</span>&nbsp;<span class="ident" id="4993750">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4993756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4993759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4993763">resp</span><span class="op" id="4993767">,</span>&nbsp;<span class="ident" id="4993769">err</span>&nbsp;<span class="op" id="4993773">=</span>&nbsp;<span class="ident" id="4993775">http</span><span class="op" id="4993779">.</span><span class="ident" id="4993780">ReadResponse</span><span class="op" id="4993792">(</span><span class="ident" id="4993793">r</span><span class="op" id="4993794">,</span>&nbsp;<span class="ident" id="4993796">req</span><span class="op" id="4993799">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4993802">cc</span><span class="op" id="4993804">.</span><span class="ident" id="4993805">lk</span><span class="op" id="4993807">.</span><span class="ident" id="4993808">Lock</span><span class="op" id="4993812">(</span><span class="op" id="4993813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4993816">defer</span>&nbsp;<span class="ident" id="4993822">cc</span><span class="op" id="4993824">.</span><span class="ident" id="4993825">lk</span><span class="op" id="4993827">.</span><span class="ident" id="4993828">Unlock</span><span class="op" id="4993834">(</span><span class="op" id="4993835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4993838">if</span>&nbsp;<span class="ident" id="4993841">err</span>&nbsp;<span class="op" id="4993845">!=</span>&nbsp;<span class="builtintype" id="4993848">nil</span>&nbsp;<span class="op" id="4993852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4993856">cc</span><span class="op" id="4993858">.</span><span class="ident" id="4993859">re</span>&nbsp;<span class="op" id="4993862">=</span>&nbsp;<span class="ident" id="4993864">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4993870">return</span>&nbsp;<span class="ident" id="4993877">resp</span><span class="op" id="4993881">,</span>&nbsp;<span class="ident" id="4993883">err</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4993888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4993891">cc</span><span class="op" id="4993893">.</span><span class="ident" id="4993894">lastbody</span>&nbsp;<span class="op" id="4993903">=</span>&nbsp;<span class="ident" id="4993905">resp</span><span class="op" id="4993909">.</span><span class="ident" id="4993910">Body</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4993917">cc</span><span class="op" id="4993919">.</span><span class="ident" id="4993920">nread</span><span class="op" id="4993925">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4993930">if</span>&nbsp;<span class="ident" id="4993933">resp</span><span class="op" id="4993937">.</span><span class="ident" id="4993938">Close</span>&nbsp;<span class="op" id="4993944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4993948">cc</span><span class="op" id="4993950">.</span><span class="ident" id="4993951">re</span>&nbsp;<span class="op" id="4993954">=</span>&nbsp;<span class="ident" id="4993956">ErrPersistEOF</span>&nbsp;<span class="comment" id="4993970">//&nbsp;don&#39;t&nbsp;send&nbsp;any&nbsp;more&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4994004">return</span>&nbsp;<span class="ident" id="4994011">resp</span><span class="op" id="4994015">,</span>&nbsp;<span class="ident" id="4994017">cc</span><span class="op" id="4994019">.</span><span class="ident" id="4994020">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4994024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4994027">return</span>&nbsp;<span class="ident" id="4994034">resp</span><span class="op" id="4994038">,</span>&nbsp;<span class="ident" id="4994040">err</span><br>
<span class="lineno">420</span><span class="op" id="4994044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4994047">//&nbsp;Do&nbsp;is&nbsp;convenience&nbsp;method&nbsp;that&nbsp;writes&nbsp;a&nbsp;request&nbsp;and&nbsp;reads&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4994119">func</span>&nbsp;<span class="op" id="4994124">(</span><span class="ident" id="4994125">cc</span>&nbsp;<span class="op" id="4994128">*</span><span class="ident" id="4994129">ClientConn</span><span class="op" id="4994139">)</span>&nbsp;<span class="ident" id="4994141">Do</span><span class="op" id="4994143">(</span><span class="ident" id="4994144">req</span>&nbsp;<span class="op" id="4994148">*</span><span class="ident" id="4994149">http</span><span class="op" id="4994153">.</span><span class="ident" id="4994154">Request</span><span class="op" id="4994161">)</span>&nbsp;<span class="op" id="4994163">(</span><span class="ident" id="4994164">resp</span>&nbsp;<span class="op" id="4994169">*</span><span class="ident" id="4994170">http</span><span class="op" id="4994174">.</span><span class="ident" id="4994175">Response</span><span class="op" id="4994183">,</span>&nbsp;<span class="ident" id="4994185">err</span>&nbsp;<span class="builtintype" id="4994189">error</span><span class="op" id="4994194">)</span>&nbsp;<span class="op" id="4994196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4994199">err</span>&nbsp;<span class="op" id="4994203">=</span>&nbsp;<span class="ident" id="4994205">cc</span><span class="op" id="4994207">.</span><span class="ident" id="4994208">Write</span><span class="op" id="4994213">(</span><span class="ident" id="4994214">req</span><span class="op" id="4994217">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4994220">if</span>&nbsp;<span class="ident" id="4994223">err</span>&nbsp;<span class="op" id="4994227">!=</span>&nbsp;<span class="builtintype" id="4994230">nil</span>&nbsp;<span class="op" id="4994234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4994238">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4994246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4994249">return</span>&nbsp;<span class="ident" id="4994256">cc</span><span class="op" id="4994258">.</span><span class="ident" id="4994259">Read</span><span class="op" id="4994263">(</span><span class="ident" id="4994264">req</span><span class="op" id="4994267">)</span><br>
<span class="lineno"></span><span class="op" id="4994269">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
