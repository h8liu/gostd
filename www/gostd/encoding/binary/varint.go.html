<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3736623">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3736679">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3736733">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3736784">package</span>&nbsp;<span class="ident" id="3736792">binary</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3736800">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;&#34;varint&#34;&nbsp;encoding&nbsp;of&nbsp;64-bit&nbsp;integers.</span><br>
<span class="lineno"></span><span class="comment" id="3736862">//&nbsp;The&nbsp;encoding&nbsp;is:</span><br>
<span class="lineno"></span><span class="comment" id="3736882">//&nbsp;-&nbsp;unsigned&nbsp;integers&nbsp;are&nbsp;serialized&nbsp;7&nbsp;bits&nbsp;at&nbsp;a&nbsp;time,&nbsp;starting&nbsp;with&nbsp;the</span><br>
<span class="lineno">10</span><span class="comment" id="3736956">//&nbsp;&nbsp;&nbsp;least&nbsp;significant&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="3736984">//&nbsp;-&nbsp;the&nbsp;most&nbsp;significant&nbsp;bit&nbsp;(msb)&nbsp;in&nbsp;each&nbsp;output&nbsp;byte&nbsp;indicates&nbsp;if&nbsp;there</span><br>
<span class="lineno"></span><span class="comment" id="3737059">//&nbsp;&nbsp;&nbsp;is&nbsp;a&nbsp;continuation&nbsp;byte&nbsp;(msb&nbsp;=&nbsp;1)</span><br>
<span class="lineno"></span><span class="comment" id="3737097">//&nbsp;-&nbsp;signed&nbsp;integers&nbsp;are&nbsp;mapped&nbsp;to&nbsp;unsigned&nbsp;integers&nbsp;using&nbsp;&#34;zig-zag&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3737166">//&nbsp;&nbsp;&nbsp;encoding:&nbsp;Positive&nbsp;values&nbsp;x&nbsp;are&nbsp;written&nbsp;as&nbsp;2*x&nbsp;+&nbsp;0,&nbsp;negative&nbsp;values</span><br>
<span class="lineno">15</span><span class="comment" id="3737239">//&nbsp;&nbsp;&nbsp;are&nbsp;written&nbsp;as&nbsp;2*(^x)&nbsp;+&nbsp;1;&nbsp;that&nbsp;is,&nbsp;negative&nbsp;numbers&nbsp;are&nbsp;complemented</span><br>
<span class="lineno"></span><span class="comment" id="3737314">//&nbsp;&nbsp;&nbsp;and&nbsp;whether&nbsp;to&nbsp;complement&nbsp;is&nbsp;encoded&nbsp;in&nbsp;bit&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="3737366">//</span><br>
<span class="lineno"></span><span class="comment" id="3737369">//&nbsp;Design&nbsp;note:</span><br>
<span class="lineno"></span><span class="comment" id="3737385">//&nbsp;At&nbsp;most&nbsp;10&nbsp;bytes&nbsp;are&nbsp;needed&nbsp;for&nbsp;64-bit&nbsp;values.&nbsp;The&nbsp;encoding&nbsp;could</span><br>
<span class="lineno">20</span><span class="comment" id="3737454">//&nbsp;be&nbsp;more&nbsp;dense:&nbsp;a&nbsp;full&nbsp;64-bit&nbsp;value&nbsp;needs&nbsp;an&nbsp;extra&nbsp;byte&nbsp;just&nbsp;to&nbsp;hold&nbsp;bit&nbsp;63.</span><br>
<span class="lineno"></span><span class="comment" id="3737533">//&nbsp;Instead,&nbsp;the&nbsp;msb&nbsp;of&nbsp;the&nbsp;previous&nbsp;byte&nbsp;could&nbsp;be&nbsp;used&nbsp;to&nbsp;hold&nbsp;bit&nbsp;63&nbsp;since&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="3737612">//&nbsp;know&nbsp;there&nbsp;can&#39;t&nbsp;be&nbsp;more&nbsp;than&nbsp;64&nbsp;bits.&nbsp;This&nbsp;is&nbsp;a&nbsp;trivial&nbsp;improvement&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3737688">//&nbsp;would&nbsp;reduce&nbsp;the&nbsp;maximum&nbsp;encoding&nbsp;length&nbsp;to&nbsp;9&nbsp;bytes.&nbsp;However,&nbsp;it&nbsp;breaks&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3737767">//&nbsp;invariant&nbsp;that&nbsp;the&nbsp;msb&nbsp;is&nbsp;always&nbsp;the&nbsp;&#34;continuation&nbsp;bit&#34;&nbsp;and&nbsp;thus&nbsp;makes&nbsp;the</span><br>
<span class="lineno">25</span><span class="comment" id="3737845">//&nbsp;format&nbsp;incompatible&nbsp;with&nbsp;a&nbsp;varint&nbsp;encoding&nbsp;for&nbsp;larger&nbsp;numbers&nbsp;(say&nbsp;128-bit).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3737926">import</span>&nbsp;<span class="op" id="3737933">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3737936">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3737946">&#34;io&#34;</span><br>
<span class="lineno">30</span><span class="op" id="3737951">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3737954">//&nbsp;MaxVarintLenN&nbsp;is&nbsp;the&nbsp;maximum&nbsp;length&nbsp;of&nbsp;a&nbsp;varint-encoded&nbsp;N-bit&nbsp;integer.</span><br>
<span class="lineno"></span><span class="keyword" id="3738028">const</span>&nbsp;<span class="op" id="3738034">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738037">MaxVarintLen16</span>&nbsp;<span class="op" id="3738052">=</span>&nbsp;<span class="num" id="3738054">3</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738057">MaxVarintLen32</span>&nbsp;<span class="op" id="3738072">=</span>&nbsp;<span class="num" id="3738074">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738077">MaxVarintLen64</span>&nbsp;<span class="op" id="3738092">=</span>&nbsp;<span class="num" id="3738094">10</span><br>
<span class="lineno"></span><span class="op" id="3738097">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3738100">//&nbsp;PutUvarint&nbsp;encodes&nbsp;a&nbsp;uint64&nbsp;into&nbsp;buf&nbsp;and&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written.</span><br>
<span class="lineno">40</span><span class="comment" id="3738181">//&nbsp;If&nbsp;the&nbsp;buffer&nbsp;is&nbsp;too&nbsp;small,&nbsp;PutUvarint&nbsp;will&nbsp;panic.</span><br>
<span class="lineno"></span><span class="keyword" id="3738235">func</span>&nbsp;<span class="ident" id="3738240">PutUvarint</span><span class="op" id="3738250">(</span><span class="ident" id="3738251">buf</span>&nbsp;<span class="op" id="3738255">[</span><span class="op" id="3738256">]</span><span class="builtintype" id="3738257">byte</span><span class="op" id="3738261">,</span>&nbsp;<span class="ident" id="3738263">x</span>&nbsp;<span class="ident" id="3738265">uint64</span><span class="op" id="3738271">)</span>&nbsp;<span class="builtintype" id="3738273">int</span>&nbsp;<span class="op" id="3738277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738280">i</span>&nbsp;<span class="op" id="3738282">:=</span>&nbsp;<span class="num" id="3738285">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738288">for</span>&nbsp;<span class="ident" id="3738292">x</span>&nbsp;<span class="op" id="3738294">&gt;=</span>&nbsp;<span class="num" id="3738297">0x80</span>&nbsp;<span class="op" id="3738302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738306">buf</span><span class="op" id="3738309">[</span><span class="ident" id="3738310">i</span><span class="op" id="3738311">]</span>&nbsp;<span class="op" id="3738313">=</span>&nbsp;<span class="builtintype" id="3738315">byte</span><span class="op" id="3738319">(</span><span class="ident" id="3738320">x</span><span class="op" id="3738321">)</span>&nbsp;<span class="op" id="3738323">|</span>&nbsp;<span class="num" id="3738325">0x80</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738332">x</span>&nbsp;<span class="op" id="3738334">&gt;&gt;=</span>&nbsp;<span class="num" id="3738338">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738342">i</span><span class="op" id="3738343">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3738347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738350">buf</span><span class="op" id="3738353">[</span><span class="ident" id="3738354">i</span><span class="op" id="3738355">]</span>&nbsp;<span class="op" id="3738357">=</span>&nbsp;<span class="builtintype" id="3738359">byte</span><span class="op" id="3738363">(</span><span class="ident" id="3738364">x</span><span class="op" id="3738365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738368">return</span>&nbsp;<span class="ident" id="3738375">i</span>&nbsp;<span class="op" id="3738377">+</span>&nbsp;<span class="num" id="3738379">1</span><br>
<span class="lineno">50</span><span class="op" id="3738381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3738384">//&nbsp;Uvarint&nbsp;decodes&nbsp;a&nbsp;uint64&nbsp;from&nbsp;buf&nbsp;and&nbsp;returns&nbsp;that&nbsp;value&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3738452">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;read&nbsp;(&gt;&nbsp;0).&nbsp;If&nbsp;an&nbsp;error&nbsp;occurred,&nbsp;the&nbsp;value&nbsp;is&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="3738520">//&nbsp;and&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;n&nbsp;is&nbsp;&lt;=&nbsp;0&nbsp;meaning:</span><br>
<span class="lineno">55</span><span class="comment" id="3738566">//</span><br>
<span class="lineno"></span><span class="comment" id="3738569">//&nbsp;&nbsp;&nbsp;&nbspn&nbsp;==&nbsp;0:&nbsp;buf&nbsp;too&nbsp;small</span><br>
<span class="lineno"></span><span class="comment" id="3738594">//&nbsp;&nbsp;&nbsp;&nbspn&nbsp;&nbsp;&lt;&nbsp;0:&nbsp;value&nbsp;larger&nbsp;than&nbsp;64&nbsp;bits&nbsp;(overflow)</span><br>
<span class="lineno"></span><span class="comment" id="3738642">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;-n&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="3738693">//</span><br>
<span class="lineno">60</span><span class="keyword" id="3738696">func</span>&nbsp;<span class="ident" id="3738701">Uvarint</span><span class="op" id="3738708">(</span><span class="ident" id="3738709">buf</span>&nbsp;<span class="op" id="3738713">[</span><span class="op" id="3738714">]</span><span class="builtintype" id="3738715">byte</span><span class="op" id="3738719">)</span>&nbsp;<span class="op" id="3738721">(</span><span class="ident" id="3738722">uint64</span><span class="op" id="3738728">,</span>&nbsp;<span class="builtintype" id="3738730">int</span><span class="op" id="3738733">)</span>&nbsp;<span class="op" id="3738735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738738">var</span>&nbsp;<span class="ident" id="3738742">x</span>&nbsp;<span class="ident" id="3738744">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738752">var</span>&nbsp;<span class="ident" id="3738756">s</span>&nbsp;<span class="builtintype" id="3738758">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738764">for</span>&nbsp;<span class="ident" id="3738768">i</span><span class="op" id="3738769">,</span>&nbsp;<span class="ident" id="3738771">b</span>&nbsp;<span class="op" id="3738773">:=</span>&nbsp;<span class="keyword" id="3738776">range</span>&nbsp;<span class="ident" id="3738782">buf</span>&nbsp;<span class="op" id="3738786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738790">if</span>&nbsp;<span class="ident" id="3738793">b</span>&nbsp;<span class="op" id="3738795">&lt;</span>&nbsp;<span class="num" id="3738797">0x80</span>&nbsp;<span class="op" id="3738802">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738807">if</span>&nbsp;<span class="ident" id="3738810">i</span>&nbsp;<span class="op" id="3738812">&gt;</span>&nbsp;<span class="num" id="3738814">9</span>&nbsp;<span class="op" id="3738816">||</span>&nbsp;<span class="ident" id="3738819">i</span>&nbsp;<span class="op" id="3738821">==</span>&nbsp;<span class="num" id="3738824">9</span>&nbsp;<span class="op" id="3738826">&amp;&amp;</span>&nbsp;<span class="ident" id="3738829">b</span>&nbsp;<span class="op" id="3738831">&gt;</span>&nbsp;<span class="num" id="3738833">1</span>&nbsp;<span class="op" id="3738835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738841">return</span>&nbsp;<span class="num" id="3738848">0</span><span class="op" id="3738849">,</span>&nbsp;<span class="op" id="3738851">-</span><span class="op" id="3738852">(</span><span class="ident" id="3738853">i</span>&nbsp;<span class="op" id="3738855">+</span>&nbsp;<span class="num" id="3738857">1</span><span class="op" id="3738858">)</span>&nbsp;<span class="comment" id="3738860">//&nbsp;overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3738875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738880">return</span>&nbsp;<span class="ident" id="3738887">x</span>&nbsp;<span class="op" id="3738889">|</span>&nbsp;<span class="ident" id="3738891">uint64</span><span class="op" id="3738897">(</span><span class="ident" id="3738898">b</span><span class="op" id="3738899">)</span><span class="op" id="3738900">&lt;&lt;</span><span class="ident" id="3738902">s</span><span class="op" id="3738903">,</span>&nbsp;<span class="ident" id="3738905">i</span>&nbsp;<span class="op" id="3738907">+</span>&nbsp;<span class="num" id="3738909">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3738913">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738917">x</span>&nbsp;<span class="op" id="3738919">|=</span>&nbsp;<span class="ident" id="3738922">uint64</span><span class="op" id="3738928">(</span><span class="ident" id="3738929">b</span><span class="op" id="3738930">&amp;</span><span class="num" id="3738931">0x7f</span><span class="op" id="3738935">)</span>&nbsp;<span class="op" id="3738937">&lt;&lt;</span>&nbsp;<span class="ident" id="3738940">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738944">s</span>&nbsp;<span class="op" id="3738946">+=</span>&nbsp;<span class="num" id="3738949">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3738952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738955">return</span>&nbsp;<span class="num" id="3738962">0</span><span class="op" id="3738963">,</span>&nbsp;<span class="num" id="3738965">0</span><br>
<span class="lineno"></span><span class="op" id="3738967">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="3738970">//&nbsp;PutVarint&nbsp;encodes&nbsp;an&nbsp;int64&nbsp;into&nbsp;buf&nbsp;and&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="3739050">//&nbsp;If&nbsp;the&nbsp;buffer&nbsp;is&nbsp;too&nbsp;small,&nbsp;PutVarint&nbsp;will&nbsp;panic.</span><br>
<span class="lineno"></span><span class="keyword" id="3739103">func</span>&nbsp;<span class="ident" id="3739108">PutVarint</span><span class="op" id="3739117">(</span><span class="ident" id="3739118">buf</span>&nbsp;<span class="op" id="3739122">[</span><span class="op" id="3739123">]</span><span class="builtintype" id="3739124">byte</span><span class="op" id="3739128">,</span>&nbsp;<span class="ident" id="3739130">x</span>&nbsp;<span class="ident" id="3739132">int64</span><span class="op" id="3739137">)</span>&nbsp;<span class="builtintype" id="3739139">int</span>&nbsp;<span class="op" id="3739143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739146">ux</span>&nbsp;<span class="op" id="3739149">:=</span>&nbsp;<span class="ident" id="3739152">uint64</span><span class="op" id="3739158">(</span><span class="ident" id="3739159">x</span><span class="op" id="3739160">)</span>&nbsp;<span class="op" id="3739162">&lt;&lt;</span>&nbsp;<span class="num" id="3739165">1</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739168">if</span>&nbsp;<span class="ident" id="3739171">x</span>&nbsp;<span class="op" id="3739173">&lt;</span>&nbsp;<span class="num" id="3739175">0</span>&nbsp;<span class="op" id="3739177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739181">ux</span>&nbsp;<span class="op" id="3739184">=</span>&nbsp;<span class="op" id="3739186">^</span><span class="ident" id="3739187">ux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3739191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739194">return</span>&nbsp;<span class="ident" id="3739201">PutUvarint</span><span class="op" id="3739211">(</span><span class="ident" id="3739212">buf</span><span class="op" id="3739215">,</span>&nbsp;<span class="ident" id="3739217">ux</span><span class="op" id="3739219">)</span><br>
<span class="lineno"></span><span class="op" id="3739221">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="3739224">//&nbsp;Varint&nbsp;decodes&nbsp;an&nbsp;int64&nbsp;from&nbsp;buf&nbsp;and&nbsp;returns&nbsp;that&nbsp;value&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3739291">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;read&nbsp;(&gt;&nbsp;0).&nbsp;If&nbsp;an&nbsp;error&nbsp;occurred,&nbsp;the&nbsp;value&nbsp;is&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="3739359">//&nbsp;and&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;n&nbsp;is&nbsp;&lt;=&nbsp;0&nbsp;with&nbsp;the&nbsp;following&nbsp;meaning:</span><br>
<span class="lineno"></span><span class="comment" id="3739424">//</span><br>
<span class="lineno">90</span><span class="comment" id="3739427">//&nbsp;&nbsp;&nbsp;&nbspn&nbsp;==&nbsp;0:&nbsp;buf&nbsp;too&nbsp;small</span><br>
<span class="lineno"></span><span class="comment" id="3739452">//&nbsp;&nbsp;&nbsp;&nbspn&nbsp;&nbsp;&lt;&nbsp;0:&nbsp;value&nbsp;larger&nbsp;than&nbsp;64&nbsp;bits&nbsp;(overflow)</span><br>
<span class="lineno"></span><span class="comment" id="3739500">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;-n&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="3739551">//</span><br>
<span class="lineno"></span><span class="keyword" id="3739554">func</span>&nbsp;<span class="ident" id="3739559">Varint</span><span class="op" id="3739565">(</span><span class="ident" id="3739566">buf</span>&nbsp;<span class="op" id="3739570">[</span><span class="op" id="3739571">]</span><span class="builtintype" id="3739572">byte</span><span class="op" id="3739576">)</span>&nbsp;<span class="op" id="3739578">(</span><span class="ident" id="3739579">int64</span><span class="op" id="3739584">,</span>&nbsp;<span class="builtintype" id="3739586">int</span><span class="op" id="3739589">)</span>&nbsp;<span class="op" id="3739591">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739594">ux</span><span class="op" id="3739596">,</span>&nbsp;<span class="ident" id="3739598">n</span>&nbsp;<span class="op" id="3739600">:=</span>&nbsp;<span class="ident" id="3739603">Uvarint</span><span class="op" id="3739610">(</span><span class="ident" id="3739611">buf</span><span class="op" id="3739614">)</span>&nbsp;<span class="comment" id="3739616">//&nbsp;ok&nbsp;to&nbsp;continue&nbsp;in&nbsp;presence&nbsp;of&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739656">x</span>&nbsp;<span class="op" id="3739658">:=</span>&nbsp;<span class="ident" id="3739661">int64</span><span class="op" id="3739666">(</span><span class="ident" id="3739667">ux</span>&nbsp;<span class="op" id="3739670">&gt;&gt;</span>&nbsp;<span class="num" id="3739673">1</span><span class="op" id="3739674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739677">if</span>&nbsp;<span class="ident" id="3739680">ux</span><span class="op" id="3739682">&amp;</span><span class="num" id="3739683">1</span>&nbsp;<span class="op" id="3739685">!=</span>&nbsp;<span class="num" id="3739688">0</span>&nbsp;<span class="op" id="3739690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739694">x</span>&nbsp;<span class="op" id="3739696">=</span>&nbsp;<span class="op" id="3739698">^</span><span class="ident" id="3739699">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3739702">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739705">return</span>&nbsp;<span class="ident" id="3739712">x</span><span class="op" id="3739713">,</span>&nbsp;<span class="ident" id="3739715">n</span><br>
<span class="lineno"></span><span class="op" id="3739717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3739720">var</span>&nbsp;<span class="ident" id="3739724">overflow</span>&nbsp;<span class="op" id="3739733">=</span>&nbsp;<span class="ident" id="3739735">errors</span><span class="op" id="3739741">.</span><span class="ident" id="3739742">New</span><span class="op" id="3739745">(</span><span class="string" id="3739746">&#34;binary:&nbsp;varint&nbsp;overflows&nbsp;a&nbsp;64-bit&nbsp;integer&#34;</span><span class="op" id="3739789">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="3739792">//&nbsp;ReadUvarint&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;a&nbsp;uint64.</span><br>
<span class="lineno"></span><span class="keyword" id="3739876">func</span>&nbsp;<span class="ident" id="3739881">ReadUvarint</span><span class="op" id="3739892">(</span><span class="ident" id="3739893">r</span>&nbsp;<span class="ident" id="3739895">io</span><span class="op" id="3739897">.</span><span class="ident" id="3739898">ByteReader</span><span class="op" id="3739908">)</span>&nbsp;<span class="op" id="3739910">(</span><span class="ident" id="3739911">uint64</span><span class="op" id="3739917">,</span>&nbsp;<span class="builtintype" id="3739919">error</span><span class="op" id="3739924">)</span>&nbsp;<span class="op" id="3739926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739929">var</span>&nbsp;<span class="ident" id="3739933">x</span>&nbsp;<span class="ident" id="3739935">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739943">var</span>&nbsp;<span class="ident" id="3739947">s</span>&nbsp;<span class="builtintype" id="3739949">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739955">for</span>&nbsp;<span class="ident" id="3739959">i</span>&nbsp;<span class="op" id="3739961">:=</span>&nbsp;<span class="num" id="3739964">0</span><span class="op" id="3739965">;</span>&nbsp;<span class="op" id="3739967">;</span>&nbsp;<span class="ident" id="3739969">i</span><span class="op" id="3739970">++</span>&nbsp;<span class="op" id="3739973">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739977">b</span><span class="op" id="3739978">,</span>&nbsp;<span class="ident" id="3739980">err</span>&nbsp;<span class="op" id="3739984">:=</span>&nbsp;<span class="ident" id="3739987">r</span><span class="op" id="3739988">.</span><span class="ident" id="3739989">ReadByte</span><span class="op" id="3739997">(</span><span class="op" id="3739998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740002">if</span>&nbsp;<span class="ident" id="3740005">err</span>&nbsp;<span class="op" id="3740009">!=</span>&nbsp;<span class="ident" id="3740012">nil</span>&nbsp;<span class="op" id="3740016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740021">return</span>&nbsp;<span class="ident" id="3740028">x</span><span class="op" id="3740029">,</span>&nbsp;<span class="ident" id="3740031">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3740037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740041">if</span>&nbsp;<span class="ident" id="3740044">b</span>&nbsp;<span class="op" id="3740046">&lt;</span>&nbsp;<span class="num" id="3740048">0x80</span>&nbsp;<span class="op" id="3740053">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740058">if</span>&nbsp;<span class="ident" id="3740061">i</span>&nbsp;<span class="op" id="3740063">&gt;</span>&nbsp;<span class="num" id="3740065">9</span>&nbsp;<span class="op" id="3740067">||</span>&nbsp;<span class="ident" id="3740070">i</span>&nbsp;<span class="op" id="3740072">==</span>&nbsp;<span class="num" id="3740075">9</span>&nbsp;<span class="op" id="3740077">&amp;&amp;</span>&nbsp;<span class="ident" id="3740080">b</span>&nbsp;<span class="op" id="3740082">&gt;</span>&nbsp;<span class="num" id="3740084">1</span>&nbsp;<span class="op" id="3740086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740092">return</span>&nbsp;<span class="ident" id="3740099">x</span><span class="op" id="3740100">,</span>&nbsp;<span class="ident" id="3740102">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3740114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740119">return</span>&nbsp;<span class="ident" id="3740126">x</span>&nbsp;<span class="op" id="3740128">|</span>&nbsp;<span class="ident" id="3740130">uint64</span><span class="op" id="3740136">(</span><span class="ident" id="3740137">b</span><span class="op" id="3740138">)</span><span class="op" id="3740139">&lt;&lt;</span><span class="ident" id="3740141">s</span><span class="op" id="3740142">,</span>&nbsp;<span class="ident" id="3740144">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3740150">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740154">x</span>&nbsp;<span class="op" id="3740156">|=</span>&nbsp;<span class="ident" id="3740159">uint64</span><span class="op" id="3740165">(</span><span class="ident" id="3740166">b</span><span class="op" id="3740167">&amp;</span><span class="num" id="3740168">0x7f</span><span class="op" id="3740172">)</span>&nbsp;<span class="op" id="3740174">&lt;&lt;</span>&nbsp;<span class="ident" id="3740177">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740181">s</span>&nbsp;<span class="op" id="3740183">+=</span>&nbsp;<span class="num" id="3740186">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3740189">}</span><br>
<span class="lineno"></span><span class="op" id="3740191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="3740194">//&nbsp;ReadVarint&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;signed&nbsp;integer&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;int64.</span><br>
<span class="lineno"></span><span class="keyword" id="3740275">func</span>&nbsp;<span class="ident" id="3740280">ReadVarint</span><span class="op" id="3740290">(</span><span class="ident" id="3740291">r</span>&nbsp;<span class="ident" id="3740293">io</span><span class="op" id="3740295">.</span><span class="ident" id="3740296">ByteReader</span><span class="op" id="3740306">)</span>&nbsp;<span class="op" id="3740308">(</span><span class="ident" id="3740309">int64</span><span class="op" id="3740314">,</span>&nbsp;<span class="builtintype" id="3740316">error</span><span class="op" id="3740321">)</span>&nbsp;<span class="op" id="3740323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740326">ux</span><span class="op" id="3740328">,</span>&nbsp;<span class="ident" id="3740330">err</span>&nbsp;<span class="op" id="3740334">:=</span>&nbsp;<span class="ident" id="3740337">ReadUvarint</span><span class="op" id="3740348">(</span><span class="ident" id="3740349">r</span><span class="op" id="3740350">)</span>&nbsp;<span class="comment" id="3740352">//&nbsp;ok&nbsp;to&nbsp;continue&nbsp;in&nbsp;presence&nbsp;of&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740392">x</span>&nbsp;<span class="op" id="3740394">:=</span>&nbsp;<span class="ident" id="3740397">int64</span><span class="op" id="3740402">(</span><span class="ident" id="3740403">ux</span>&nbsp;<span class="op" id="3740406">&gt;&gt;</span>&nbsp;<span class="num" id="3740409">1</span><span class="op" id="3740410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740413">if</span>&nbsp;<span class="ident" id="3740416">ux</span><span class="op" id="3740418">&amp;</span><span class="num" id="3740419">1</span>&nbsp;<span class="op" id="3740421">!=</span>&nbsp;<span class="num" id="3740424">0</span>&nbsp;<span class="op" id="3740426">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740430">x</span>&nbsp;<span class="op" id="3740432">=</span>&nbsp;<span class="op" id="3740434">^</span><span class="ident" id="3740435">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3740438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740441">return</span>&nbsp;<span class="ident" id="3740448">x</span><span class="op" id="3740449">,</span>&nbsp;<span class="ident" id="3740451">err</span><br>
<span class="lineno"></span><span class="op" id="3740455">}</span>
</div>
</body>
</html>
