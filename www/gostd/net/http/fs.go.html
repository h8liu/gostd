<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html" class="current">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2953660">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2953715">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2953769">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2953820">//&nbsp;HTTP&nbsp;file&nbsp;system&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2953857">package</span>&nbsp;<span class="ident" id="2953865">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2953871">import</span>&nbsp;<span class="op" id="2953878">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2953881">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2953891">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2953898">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2953904">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2953912">&#34;mime/multipart&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2953930">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2953947">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2953958">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2953964">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2953972">&#34;path/filepath&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2953989">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2954000">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2954011">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="2954018">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="2954021">//&nbsp;A&nbsp;Dir&nbsp;implements&nbsp;FileSystem&nbsp;using&nbsp;the&nbsp;native&nbsp;file&nbsp;system&nbsp;restricted&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="2954097">//&nbsp;specific&nbsp;directory&nbsp;tree.</span><br>
<span class="lineno"></span><span class="comment" id="2954125">//</span><br>
<span class="lineno"></span><span class="comment" id="2954128">//&nbsp;While&nbsp;the&nbsp;FileSystem.Open&nbsp;method&nbsp;takes&nbsp;&#39;/&#39;-separated&nbsp;paths,&nbsp;a&nbsp;Dir&#39;s&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="2954206">//&nbsp;value&nbsp;is&nbsp;a&nbsp;filename&nbsp;on&nbsp;the&nbsp;native&nbsp;file&nbsp;system,&nbsp;not&nbsp;a&nbsp;URL,&nbsp;so&nbsp;it&nbsp;is&nbsp;separated</span><br>
<span class="lineno">30</span><span class="comment" id="2954286">//&nbsp;by&nbsp;filepath.Separator,&nbsp;which&nbsp;isn&#39;t&nbsp;necessarily&nbsp;&#39;/&#39;.</span><br>
<span class="lineno"></span><span class="comment" id="2954341">//</span><br>
<span class="lineno"></span><span class="comment" id="2954344">//&nbsp;An&nbsp;empty&nbsp;Dir&nbsp;is&nbsp;treated&nbsp;as&nbsp;&#34;.&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="2954379">type</span>&nbsp;<span class="ident" id="2954384">Dir</span>&nbsp;<span class="builtintype" id="2954388">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="2954396">func</span>&nbsp;<span class="op" id="2954401">(</span><span class="ident" id="2954402">d</span>&nbsp;<span class="ident" id="2954404">Dir</span><span class="op" id="2954407">)</span>&nbsp;<span class="ident" id="2954409">Open</span><span class="op" id="2954413">(</span><span class="ident" id="2954414">name</span>&nbsp;<span class="builtintype" id="2954419">string</span><span class="op" id="2954425">)</span>&nbsp;<span class="op" id="2954427">(</span><span class="ident" id="2954428">File</span><span class="op" id="2954432">,</span>&nbsp;<span class="builtintype" id="2954434">error</span><span class="op" id="2954439">)</span>&nbsp;<span class="op" id="2954441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2954444">if</span>&nbsp;<span class="ident" id="2954447">filepath</span><span class="op" id="2954455">.</span><span class="ident" id="2954456">Separator</span>&nbsp;<span class="op" id="2954466">!=</span>&nbsp;<span class="string" id="2954469">&#39;/&#39;</span>&nbsp;<span class="op" id="2954473">&amp;&amp;</span>&nbsp;<span class="ident" id="2954476">strings</span><span class="op" id="2954483">.</span><span class="ident" id="2954484">IndexRune</span><span class="op" id="2954493">(</span><span class="ident" id="2954494">name</span><span class="op" id="2954498">,</span>&nbsp;<span class="ident" id="2954500">filepath</span><span class="op" id="2954508">.</span><span class="ident" id="2954509">Separator</span><span class="op" id="2954518">)</span>&nbsp;<span class="op" id="2954520">&gt;=</span>&nbsp;<span class="num" id="2954523">0</span>&nbsp;<span class="op" id="2954525">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2954530">strings</span><span class="op" id="2954537">.</span><span class="ident" id="2954538">Contains</span><span class="op" id="2954546">(</span><span class="ident" id="2954547">name</span><span class="op" id="2954551">,</span>&nbsp;<span class="string" id="2954553">&#34;\x00&#34;</span><span class="op" id="2954559">)</span>&nbsp;<span class="op" id="2954561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2954565">return</span>&nbsp;<span class="builtintype" id="2954572">nil</span><span class="op" id="2954575">,</span>&nbsp;<span class="ident" id="2954577">errors</span><span class="op" id="2954583">.</span><span class="ident" id="2954584">New</span><span class="op" id="2954587">(</span><span class="string" id="2954588">&#34;http:&nbsp;invalid&nbsp;character&nbsp;in&nbsp;file&nbsp;path&#34;</span><span class="op" id="2954626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2954629">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2954632">dir</span>&nbsp;<span class="op" id="2954636">:=</span>&nbsp;<span class="builtintype" id="2954639">string</span><span class="op" id="2954645">(</span><span class="ident" id="2954646">d</span><span class="op" id="2954647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2954650">if</span>&nbsp;<span class="ident" id="2954653">dir</span>&nbsp;<span class="op" id="2954657">==</span>&nbsp;<span class="string" id="2954660">&#34;&#34;</span>&nbsp;<span class="op" id="2954663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2954667">dir</span>&nbsp;<span class="op" id="2954671">=</span>&nbsp;<span class="string" id="2954673">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2954678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2954681">f</span><span class="op" id="2954682">,</span>&nbsp;<span class="ident" id="2954684">err</span>&nbsp;<span class="op" id="2954688">:=</span>&nbsp;<span class="ident" id="2954691">os</span><span class="op" id="2954693">.</span><span class="ident" id="2954694">Open</span><span class="op" id="2954698">(</span><span class="ident" id="2954699">filepath</span><span class="op" id="2954707">.</span><span class="ident" id="2954708">Join</span><span class="op" id="2954712">(</span><span class="ident" id="2954713">dir</span><span class="op" id="2954716">,</span>&nbsp;<span class="ident" id="2954718">filepath</span><span class="op" id="2954726">.</span><span class="ident" id="2954727">FromSlash</span><span class="op" id="2954736">(</span><span class="ident" id="2954737">path</span><span class="op" id="2954741">.</span><span class="ident" id="2954742">Clean</span><span class="op" id="2954747">(</span><span class="string" id="2954748">&#34;/&#34;</span><span class="op" id="2954751">+</span><span class="ident" id="2954752">name</span><span class="op" id="2954756">)</span><span class="op" id="2954757">)</span><span class="op" id="2954758">)</span><span class="op" id="2954759">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2954762">if</span>&nbsp;<span class="ident" id="2954765">err</span>&nbsp;<span class="op" id="2954769">!=</span>&nbsp;<span class="builtintype" id="2954772">nil</span>&nbsp;<span class="op" id="2954776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2954780">return</span>&nbsp;<span class="builtintype" id="2954787">nil</span><span class="op" id="2954790">,</span>&nbsp;<span class="ident" id="2954792">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2954797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2954800">return</span>&nbsp;<span class="ident" id="2954807">f</span><span class="op" id="2954808">,</span>&nbsp;<span class="builtintype" id="2954810">nil</span><br>
<span class="lineno"></span><span class="op" id="2954814">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="2954817">//&nbsp;A&nbsp;FileSystem&nbsp;implements&nbsp;access&nbsp;to&nbsp;a&nbsp;collection&nbsp;of&nbsp;named&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="2954883">//&nbsp;The&nbsp;elements&nbsp;in&nbsp;a&nbsp;file&nbsp;path&nbsp;are&nbsp;separated&nbsp;by&nbsp;slash&nbsp;(&#39;/&#39;,&nbsp;U+002F)</span><br>
<span class="lineno"></span><span class="comment" id="2954951">//&nbsp;characters,&nbsp;regardless&nbsp;of&nbsp;host&nbsp;operating&nbsp;system&nbsp;convention.</span><br>
<span class="lineno"></span><span class="keyword" id="2955014">type</span>&nbsp;<span class="ident" id="2955019">FileSystem</span>&nbsp;<span class="keyword" id="2955030">interface</span>&nbsp;<span class="op" id="2955040">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2955043">Open</span><span class="op" id="2955047">(</span><span class="ident" id="2955048">name</span>&nbsp;<span class="builtintype" id="2955053">string</span><span class="op" id="2955059">)</span>&nbsp;<span class="op" id="2955061">(</span><span class="ident" id="2955062">File</span><span class="op" id="2955066">,</span>&nbsp;<span class="builtintype" id="2955068">error</span><span class="op" id="2955073">)</span><br>
<span class="lineno"></span><span class="op" id="2955075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2955078">//&nbsp;A&nbsp;File&nbsp;is&nbsp;returned&nbsp;by&nbsp;a&nbsp;FileSystem&#39;s&nbsp;Open&nbsp;method&nbsp;and&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="2955141">//&nbsp;served&nbsp;by&nbsp;the&nbsp;FileServer&nbsp;implementation.</span><br>
<span class="lineno">60</span><span class="comment" id="2955185">//</span><br>
<span class="lineno"></span><span class="comment" id="2955188">//&nbsp;The&nbsp;methods&nbsp;should&nbsp;behave&nbsp;the&nbsp;same&nbsp;as&nbsp;those&nbsp;on&nbsp;an&nbsp;*os.File.</span><br>
<span class="lineno"></span><span class="keyword" id="2955251">type</span>&nbsp;<span class="ident" id="2955256">File</span>&nbsp;<span class="keyword" id="2955261">interface</span>&nbsp;<span class="op" id="2955271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2955274">io</span><span class="op" id="2955276">.</span><span class="ident" id="2955277">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2955285">io</span><span class="op" id="2955287">.</span><span class="ident" id="2955288">Reader</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2955296">Readdir</span><span class="op" id="2955303">(</span><span class="ident" id="2955304">count</span>&nbsp;<span class="builtintype" id="2955310">int</span><span class="op" id="2955313">)</span>&nbsp;<span class="op" id="2955315">(</span><span class="op" id="2955316">[</span><span class="op" id="2955317">]</span><span class="ident" id="2955318">os</span><span class="op" id="2955320">.</span><span class="ident" id="2955321">FileInfo</span><span class="op" id="2955329">,</span>&nbsp;<span class="builtintype" id="2955331">error</span><span class="op" id="2955336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2955339">Seek</span><span class="op" id="2955343">(</span><span class="ident" id="2955344">offset</span>&nbsp;<span class="ident" id="2955351">int64</span><span class="op" id="2955356">,</span>&nbsp;<span class="ident" id="2955358">whence</span>&nbsp;<span class="builtintype" id="2955365">int</span><span class="op" id="2955368">)</span>&nbsp;<span class="op" id="2955370">(</span><span class="ident" id="2955371">int64</span><span class="op" id="2955376">,</span>&nbsp;<span class="builtintype" id="2955378">error</span><span class="op" id="2955383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2955386">Stat</span><span class="op" id="2955390">(</span><span class="op" id="2955391">)</span>&nbsp;<span class="op" id="2955393">(</span><span class="ident" id="2955394">os</span><span class="op" id="2955396">.</span><span class="ident" id="2955397">FileInfo</span><span class="op" id="2955405">,</span>&nbsp;<span class="builtintype" id="2955407">error</span><span class="op" id="2955412">)</span><br>
<span class="lineno"></span><span class="op" id="2955414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="2955417">func</span>&nbsp;<span class="ident" id="2955422">dirList</span><span class="op" id="2955429">(</span><span class="ident" id="2955430">w</span>&nbsp;<span class="ident" id="2955432">ResponseWriter</span><span class="op" id="2955446">,</span>&nbsp;<span class="ident" id="2955448">f</span>&nbsp;<span class="ident" id="2955450">File</span><span class="op" id="2955454">)</span>&nbsp;<span class="op" id="2955456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2955459">w</span><span class="op" id="2955460">.</span><span class="ident" id="2955461">Header</span><span class="op" id="2955467">(</span><span class="op" id="2955468">)</span><span class="op" id="2955469">.</span><span class="ident" id="2955470">Set</span><span class="op" id="2955473">(</span><span class="string" id="2955474">&#34;Content-Type&#34;</span><span class="op" id="2955488">,</span>&nbsp;<span class="string" id="2955490">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="2955516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2955519">fmt</span><span class="op" id="2955522">.</span><span class="ident" id="2955523">Fprintf</span><span class="op" id="2955530">(</span><span class="ident" id="2955531">w</span><span class="op" id="2955532">,</span>&nbsp;<span class="string" id="2955534">&#34;&lt;pre&gt;\n&#34;</span><span class="op" id="2955543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2955546">for</span>&nbsp;<span class="op" id="2955550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2955554">dirs</span><span class="op" id="2955558">,</span>&nbsp;<span class="ident" id="2955560">err</span>&nbsp;<span class="op" id="2955564">:=</span>&nbsp;<span class="ident" id="2955567">f</span><span class="op" id="2955568">.</span><span class="ident" id="2955569">Readdir</span><span class="op" id="2955576">(</span><span class="num" id="2955577">100</span><span class="op" id="2955580">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2955584">if</span>&nbsp;<span class="ident" id="2955587">err</span>&nbsp;<span class="op" id="2955591">!=</span>&nbsp;<span class="builtintype" id="2955594">nil</span>&nbsp;<span class="op" id="2955598">||</span>&nbsp;<span class="builtinfunc" id="2955601">len</span><span class="op" id="2955604">(</span><span class="ident" id="2955605">dirs</span><span class="op" id="2955609">)</span>&nbsp;<span class="op" id="2955611">==</span>&nbsp;<span class="num" id="2955614">0</span>&nbsp;<span class="op" id="2955616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2955621">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2955629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2955633">for</span>&nbsp;<span class="ident" id="2955637">_</span><span class="op" id="2955638">,</span>&nbsp;<span class="ident" id="2955640">d</span>&nbsp;<span class="op" id="2955642">:=</span>&nbsp;<span class="keyword" id="2955645">range</span>&nbsp;<span class="ident" id="2955651">dirs</span>&nbsp;<span class="op" id="2955656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2955661">name</span>&nbsp;<span class="op" id="2955666">:=</span>&nbsp;<span class="ident" id="2955669">d</span><span class="op" id="2955670">.</span><span class="ident" id="2955671">Name</span><span class="op" id="2955675">(</span><span class="op" id="2955676">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2955681">if</span>&nbsp;<span class="ident" id="2955684">d</span><span class="op" id="2955685">.</span><span class="ident" id="2955686">IsDir</span><span class="op" id="2955691">(</span><span class="op" id="2955692">)</span>&nbsp;<span class="op" id="2955694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2955700">name</span>&nbsp;<span class="op" id="2955705">+=</span>&nbsp;<span class="string" id="2955708">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2955715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2955720">//&nbsp;name&nbsp;may&nbsp;contain&nbsp;&#39;?&#39;&nbsp;or&nbsp;&#39;#&#39;,&nbsp;which&nbsp;must&nbsp;be&nbsp;escaped&nbsp;to&nbsp;remain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2955787">//&nbsp;part&nbsp;of&nbsp;the&nbsp;URL&nbsp;path,&nbsp;and&nbsp;not&nbsp;indicate&nbsp;the&nbsp;start&nbsp;of&nbsp;a&nbsp;query</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2955853">//&nbsp;string&nbsp;or&nbsp;fragment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2955879">url</span>&nbsp;<span class="op" id="2955883">:=</span>&nbsp;<span class="ident" id="2955886">url</span><span class="op" id="2955889">.</span><span class="ident" id="2955890">URL</span><span class="op" id="2955893">{</span><span class="ident" id="2955894">Path</span><span class="op" id="2955898">:</span>&nbsp;<span class="ident" id="2955900">name</span><span class="op" id="2955904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2955909">fmt</span><span class="op" id="2955912">.</span><span class="ident" id="2955913">Fprintf</span><span class="op" id="2955920">(</span><span class="ident" id="2955921">w</span><span class="op" id="2955922">,</span>&nbsp;<span class="string" id="2955924">&#34;&lt;a&nbsp;href=\&#34;%s\&#34;&gt;%s&lt;/a&gt;\n&#34;</span><span class="op" id="2955949">,</span>&nbsp;<span class="ident" id="2955951">url</span><span class="op" id="2955954">.</span><span class="ident" id="2955955">String</span><span class="op" id="2955961">(</span><span class="op" id="2955962">)</span><span class="op" id="2955963">,</span>&nbsp;<span class="ident" id="2955965">htmlReplacer</span><span class="op" id="2955977">.</span><span class="ident" id="2955978">Replace</span><span class="op" id="2955985">(</span><span class="ident" id="2955986">name</span><span class="op" id="2955990">)</span><span class="op" id="2955991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2955995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2955998">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2956001">fmt</span><span class="op" id="2956004">.</span><span class="ident" id="2956005">Fprintf</span><span class="op" id="2956012">(</span><span class="ident" id="2956013">w</span><span class="op" id="2956014">,</span>&nbsp;<span class="string" id="2956016">&#34;&lt;/pre&gt;\n&#34;</span><span class="op" id="2956026">)</span><br>
<span class="lineno"></span><span class="op" id="2956028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2956031">//&nbsp;ServeContent&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;using&nbsp;the&nbsp;content&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2956095">//&nbsp;provided&nbsp;ReadSeeker.&nbsp;&nbsp;The&nbsp;main&nbsp;benefit&nbsp;of&nbsp;ServeContent&nbsp;over&nbsp;io.Copy</span><br>
<span class="lineno">95</span><span class="comment" id="2956166">//&nbsp;is&nbsp;that&nbsp;it&nbsp;handles&nbsp;Range&nbsp;requests&nbsp;properly,&nbsp;sets&nbsp;the&nbsp;MIME&nbsp;type,&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="2956237">//&nbsp;handles&nbsp;If-Modified-Since&nbsp;requests.</span><br>
<span class="lineno"></span><span class="comment" id="2956276">//</span><br>
<span class="lineno"></span><span class="comment" id="2956279">//&nbsp;If&nbsp;the&nbsp;response&#39;s&nbsp;Content-Type&nbsp;header&nbsp;is&nbsp;not&nbsp;set,&nbsp;ServeContent</span><br>
<span class="lineno"></span><span class="comment" id="2956345">//&nbsp;first&nbsp;tries&nbsp;to&nbsp;deduce&nbsp;the&nbsp;type&nbsp;from&nbsp;name&#39;s&nbsp;file&nbsp;extension&nbsp;and,</span><br>
<span class="lineno">100</span><span class="comment" id="2956411">//&nbsp;if&nbsp;that&nbsp;fails,&nbsp;falls&nbsp;back&nbsp;to&nbsp;reading&nbsp;the&nbsp;first&nbsp;block&nbsp;of&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="2956482">//&nbsp;and&nbsp;passing&nbsp;it&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span><span class="comment" id="2956522">//&nbsp;The&nbsp;name&nbsp;is&nbsp;otherwise&nbsp;unused;&nbsp;in&nbsp;particular&nbsp;it&nbsp;can&nbsp;be&nbsp;empty&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2956592">//&nbsp;never&nbsp;sent&nbsp;in&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="2956623">//</span><br>
<span class="lineno">105</span><span class="comment" id="2956626">//&nbsp;If&nbsp;modtime&nbsp;is&nbsp;not&nbsp;the&nbsp;zero&nbsp;time,&nbsp;ServeContent&nbsp;includes&nbsp;it&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="2956692">//&nbsp;Last-Modified&nbsp;header&nbsp;in&nbsp;the&nbsp;response.&nbsp;&nbsp;If&nbsp;the&nbsp;request&nbsp;includes&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="2956761">//&nbsp;If-Modified-Since&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;modtime&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span><span class="comment" id="2956826">//&nbsp;whether&nbsp;the&nbsp;content&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span><span class="comment" id="2956874">//</span><br>
<span class="lineno">110</span><span class="comment" id="2956877">//&nbsp;The&nbsp;content&#39;s&nbsp;Seek&nbsp;method&nbsp;must&nbsp;work:&nbsp;ServeContent&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="2956935">//&nbsp;a&nbsp;seek&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;content&nbsp;to&nbsp;determine&nbsp;its&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="2956994">//</span><br>
<span class="lineno"></span><span class="comment" id="2956997">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;has&nbsp;set&nbsp;w&#39;s&nbsp;ETag&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2957063">//&nbsp;handle&nbsp;requests&nbsp;using&nbsp;If-Range&nbsp;and&nbsp;If-None-Match.</span><br>
<span class="lineno">115</span><span class="comment" id="2957116">//</span><br>
<span class="lineno"></span><span class="comment" id="2957119">//&nbsp;Note&nbsp;that&nbsp;*os.File&nbsp;implements&nbsp;the&nbsp;io.ReadSeeker&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="2957181">func</span>&nbsp;<span class="ident" id="2957186">ServeContent</span><span class="op" id="2957198">(</span><span class="ident" id="2957199">w</span>&nbsp;<span class="ident" id="2957201">ResponseWriter</span><span class="op" id="2957215">,</span>&nbsp;<span class="ident" id="2957217">req</span>&nbsp;<span class="op" id="2957221">*</span><span class="ident" id="2957222">Request</span><span class="op" id="2957229">,</span>&nbsp;<span class="ident" id="2957231">name</span>&nbsp;<span class="builtintype" id="2957236">string</span><span class="op" id="2957242">,</span>&nbsp;<span class="ident" id="2957244">modtime</span>&nbsp;<span class="ident" id="2957252">time</span><span class="op" id="2957256">.</span><span class="ident" id="2957257">Time</span><span class="op" id="2957261">,</span>&nbsp;<span class="ident" id="2957263">content</span>&nbsp;<span class="ident" id="2957271">io</span><span class="op" id="2957273">.</span><span class="ident" id="2957274">ReadSeeker</span><span class="op" id="2957284">)</span>&nbsp;<span class="op" id="2957286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2957289">sizeFunc</span>&nbsp;<span class="op" id="2957298">:=</span>&nbsp;<span class="keyword" id="2957301">func</span><span class="op" id="2957305">(</span><span class="op" id="2957306">)</span>&nbsp;<span class="op" id="2957308">(</span><span class="ident" id="2957309">int64</span><span class="op" id="2957314">,</span>&nbsp;<span class="builtintype" id="2957316">error</span><span class="op" id="2957321">)</span>&nbsp;<span class="op" id="2957323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2957327">size</span><span class="op" id="2957331">,</span>&nbsp;<span class="ident" id="2957333">err</span>&nbsp;<span class="op" id="2957337">:=</span>&nbsp;<span class="ident" id="2957340">content</span><span class="op" id="2957347">.</span><span class="ident" id="2957348">Seek</span><span class="op" id="2957352">(</span><span class="num" id="2957353">0</span><span class="op" id="2957354">,</span>&nbsp;<span class="ident" id="2957356">os</span><span class="op" id="2957358">.</span><span class="ident" id="2957359">SEEK_END</span><span class="op" id="2957367">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2957371">if</span>&nbsp;<span class="ident" id="2957374">err</span>&nbsp;<span class="op" id="2957378">!=</span>&nbsp;<span class="builtintype" id="2957381">nil</span>&nbsp;<span class="op" id="2957385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2957390">return</span>&nbsp;<span class="num" id="2957397">0</span><span class="op" id="2957398">,</span>&nbsp;<span class="ident" id="2957400">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2957412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2957416">_</span><span class="op" id="2957417">,</span>&nbsp;<span class="ident" id="2957419">err</span>&nbsp;<span class="op" id="2957423">=</span>&nbsp;<span class="ident" id="2957425">content</span><span class="op" id="2957432">.</span><span class="ident" id="2957433">Seek</span><span class="op" id="2957437">(</span><span class="num" id="2957438">0</span><span class="op" id="2957439">,</span>&nbsp;<span class="ident" id="2957441">os</span><span class="op" id="2957443">.</span><span class="ident" id="2957444">SEEK_SET</span><span class="op" id="2957452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2957456">if</span>&nbsp;<span class="ident" id="2957459">err</span>&nbsp;<span class="op" id="2957463">!=</span>&nbsp;<span class="builtintype" id="2957466">nil</span>&nbsp;<span class="op" id="2957470">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2957475">return</span>&nbsp;<span class="num" id="2957482">0</span><span class="op" id="2957483">,</span>&nbsp;<span class="ident" id="2957485">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2957497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2957501">return</span>&nbsp;<span class="ident" id="2957508">size</span><span class="op" id="2957512">,</span>&nbsp;<span class="builtintype" id="2957514">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2957519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2957522">serveContent</span><span class="op" id="2957534">(</span><span class="ident" id="2957535">w</span><span class="op" id="2957536">,</span>&nbsp;<span class="ident" id="2957538">req</span><span class="op" id="2957541">,</span>&nbsp;<span class="ident" id="2957543">name</span><span class="op" id="2957547">,</span>&nbsp;<span class="ident" id="2957549">modtime</span><span class="op" id="2957556">,</span>&nbsp;<span class="ident" id="2957558">sizeFunc</span><span class="op" id="2957566">,</span>&nbsp;<span class="ident" id="2957568">content</span><span class="op" id="2957575">)</span><br>
<span class="lineno">130</span><span class="op" id="2957577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2957580">//&nbsp;errSeeker&nbsp;is&nbsp;returned&nbsp;by&nbsp;ServeContent&#39;s&nbsp;sizeFunc&nbsp;when&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="2957649">//&nbsp;doesn&#39;t&nbsp;seek&nbsp;properly.&nbsp;The&nbsp;underlying&nbsp;Seeker&#39;s&nbsp;error&nbsp;text&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="2957716">//&nbsp;included&nbsp;in&nbsp;the&nbsp;sizeFunc&nbsp;reply&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;sent&nbsp;over&nbsp;HTTP&nbsp;to&nbsp;end</span><br>
<span class="lineno">135</span><span class="comment" id="2957784">//&nbsp;users.</span><br>
<span class="lineno"></span><span class="keyword" id="2957794">var</span>&nbsp;<span class="ident" id="2957798">errSeeker</span>&nbsp;<span class="op" id="2957808">=</span>&nbsp;<span class="ident" id="2957810">errors</span><span class="op" id="2957816">.</span><span class="ident" id="2957817">New</span><span class="op" id="2957820">(</span><span class="string" id="2957821">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="2957840">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2957843">//&nbsp;if&nbsp;name&nbsp;is&nbsp;empty,&nbsp;filename&nbsp;is&nbsp;unknown.&nbsp;(used&nbsp;for&nbsp;mime&nbsp;type,&nbsp;before&nbsp;sniffing)</span><br>
<span class="lineno"></span><span class="comment" id="2957923">//&nbsp;if&nbsp;modtime.IsZero(),&nbsp;modtime&nbsp;is&nbsp;unknown.</span><br>
<span class="lineno">140</span><span class="comment" id="2957967">//&nbsp;content&nbsp;must&nbsp;be&nbsp;seeked&nbsp;to&nbsp;the&nbsp;beginning&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="2958023">//&nbsp;The&nbsp;sizeFunc&nbsp;is&nbsp;called&nbsp;at&nbsp;most&nbsp;once.&nbsp;Its&nbsp;error,&nbsp;if&nbsp;any,&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="2958112">func</span>&nbsp;<span class="ident" id="2958117">serveContent</span><span class="op" id="2958129">(</span><span class="ident" id="2958130">w</span>&nbsp;<span class="ident" id="2958132">ResponseWriter</span><span class="op" id="2958146">,</span>&nbsp;<span class="ident" id="2958148">r</span>&nbsp;<span class="op" id="2958150">*</span><span class="ident" id="2958151">Request</span><span class="op" id="2958158">,</span>&nbsp;<span class="ident" id="2958160">name</span>&nbsp;<span class="builtintype" id="2958165">string</span><span class="op" id="2958171">,</span>&nbsp;<span class="ident" id="2958173">modtime</span>&nbsp;<span class="ident" id="2958181">time</span><span class="op" id="2958185">.</span><span class="ident" id="2958186">Time</span><span class="op" id="2958190">,</span>&nbsp;<span class="ident" id="2958192">sizeFunc</span>&nbsp;<span class="keyword" id="2958201">func</span><span class="op" id="2958205">(</span><span class="op" id="2958206">)</span>&nbsp;<span class="op" id="2958208">(</span><span class="ident" id="2958209">int64</span><span class="op" id="2958214">,</span>&nbsp;<span class="builtintype" id="2958216">error</span><span class="op" id="2958221">)</span><span class="op" id="2958222">,</span>&nbsp;<span class="ident" id="2958224">content</span>&nbsp;<span class="ident" id="2958232">io</span><span class="op" id="2958234">.</span><span class="ident" id="2958235">ReadSeeker</span><span class="op" id="2958245">)</span>&nbsp;<span class="op" id="2958247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2958250">if</span>&nbsp;<span class="ident" id="2958253">checkLastModified</span><span class="op" id="2958270">(</span><span class="ident" id="2958271">w</span><span class="op" id="2958272">,</span>&nbsp;<span class="ident" id="2958274">r</span><span class="op" id="2958275">,</span>&nbsp;<span class="ident" id="2958277">modtime</span><span class="op" id="2958284">)</span>&nbsp;<span class="op" id="2958286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2958290">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2958298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2958301">rangeReq</span><span class="op" id="2958309">,</span>&nbsp;<span class="ident" id="2958311">done</span>&nbsp;<span class="op" id="2958316">:=</span>&nbsp;<span class="ident" id="2958319">checkETag</span><span class="op" id="2958328">(</span><span class="ident" id="2958329">w</span><span class="op" id="2958330">,</span>&nbsp;<span class="ident" id="2958332">r</span><span class="op" id="2958333">,</span>&nbsp;<span class="ident" id="2958335">modtime</span><span class="op" id="2958342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2958345">if</span>&nbsp;<span class="ident" id="2958348">done</span>&nbsp;<span class="op" id="2958353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2958357">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2958365">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2958369">code</span>&nbsp;<span class="op" id="2958374">:=</span>&nbsp;<span class="ident" id="2958377">StatusOK</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2958388">//&nbsp;If&nbsp;Content-Type&nbsp;isn&#39;t&nbsp;set,&nbsp;use&nbsp;the&nbsp;file&#39;s&nbsp;extension&nbsp;to&nbsp;find&nbsp;it,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2958460">//&nbsp;if&nbsp;the&nbsp;Content-Type&nbsp;is&nbsp;unset&nbsp;explicitly,&nbsp;do&nbsp;not&nbsp;sniff&nbsp;the&nbsp;type.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2958528">ctypes</span><span class="op" id="2958534">,</span>&nbsp;<span class="ident" id="2958536">haveType</span>&nbsp;<span class="op" id="2958545">:=</span>&nbsp;<span class="ident" id="2958548">w</span><span class="op" id="2958549">.</span><span class="ident" id="2958550">Header</span><span class="op" id="2958556">(</span><span class="op" id="2958557">)</span><span class="op" id="2958558">[</span><span class="string" id="2958559">&#34;Content-Type&#34;</span><span class="op" id="2958573">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2958576">var</span>&nbsp;<span class="ident" id="2958580">ctype</span>&nbsp;<span class="builtintype" id="2958586">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2958594">if</span>&nbsp;<span class="op" id="2958597">!</span><span class="ident" id="2958598">haveType</span>&nbsp;<span class="op" id="2958607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2958611">ctype</span>&nbsp;<span class="op" id="2958617">=</span>&nbsp;<span class="ident" id="2958619">mime</span><span class="op" id="2958623">.</span><span class="ident" id="2958624">TypeByExtension</span><span class="op" id="2958639">(</span><span class="ident" id="2958640">filepath</span><span class="op" id="2958648">.</span><span class="ident" id="2958649">Ext</span><span class="op" id="2958652">(</span><span class="ident" id="2958653">name</span><span class="op" id="2958657">)</span><span class="op" id="2958658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2958662">if</span>&nbsp;<span class="ident" id="2958665">ctype</span>&nbsp;<span class="op" id="2958671">==</span>&nbsp;<span class="string" id="2958674">&#34;&#34;</span>&nbsp;<span class="op" id="2958677">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2958682">//&nbsp;read&nbsp;a&nbsp;chunk&nbsp;to&nbsp;decide&nbsp;between&nbsp;utf-8&nbsp;text&nbsp;and&nbsp;binary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2958741">var</span>&nbsp;<span class="ident" id="2958745">buf</span>&nbsp;<span class="op" id="2958749">[</span><span class="ident" id="2958750">sniffLen</span><span class="op" id="2958758">]</span><span class="builtintype" id="2958759">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2958767">n</span><span class="op" id="2958768">,</span>&nbsp;<span class="ident" id="2958770">_</span>&nbsp;<span class="op" id="2958772">:=</span>&nbsp;<span class="ident" id="2958775">io</span><span class="op" id="2958777">.</span><span class="ident" id="2958778">ReadFull</span><span class="op" id="2958786">(</span><span class="ident" id="2958787">content</span><span class="op" id="2958794">,</span>&nbsp;<span class="ident" id="2958796">buf</span><span class="op" id="2958799">[</span><span class="op" id="2958800">:</span><span class="op" id="2958801">]</span><span class="op" id="2958802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2958807">ctype</span>&nbsp;<span class="op" id="2958813">=</span>&nbsp;<span class="ident" id="2958815">DetectContentType</span><span class="op" id="2958832">(</span><span class="ident" id="2958833">buf</span><span class="op" id="2958836">[</span><span class="op" id="2958837">:</span><span class="ident" id="2958838">n</span><span class="op" id="2958839">]</span><span class="op" id="2958840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2958845">_</span><span class="op" id="2958846">,</span>&nbsp;<span class="ident" id="2958848">err</span>&nbsp;<span class="op" id="2958852">:=</span>&nbsp;<span class="ident" id="2958855">content</span><span class="op" id="2958862">.</span><span class="ident" id="2958863">Seek</span><span class="op" id="2958867">(</span><span class="num" id="2958868">0</span><span class="op" id="2958869">,</span>&nbsp;<span class="ident" id="2958871">os</span><span class="op" id="2958873">.</span><span class="ident" id="2958874">SEEK_SET</span><span class="op" id="2958882">)</span>&nbsp;<span class="comment" id="2958884">//&nbsp;rewind&nbsp;to&nbsp;output&nbsp;whole&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2958918">if</span>&nbsp;<span class="ident" id="2958921">err</span>&nbsp;<span class="op" id="2958925">!=</span>&nbsp;<span class="builtintype" id="2958928">nil</span>&nbsp;<span class="op" id="2958932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2958938">Error</span><span class="op" id="2958943">(</span><span class="ident" id="2958944">w</span><span class="op" id="2958945">,</span>&nbsp;<span class="string" id="2958947">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="2958966">,</span>&nbsp;<span class="ident" id="2958968">StatusInternalServerError</span><span class="op" id="2958993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2958999">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2959009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2959013">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2959017">w</span><span class="op" id="2959018">.</span><span class="ident" id="2959019">Header</span><span class="op" id="2959025">(</span><span class="op" id="2959026">)</span><span class="op" id="2959027">.</span><span class="ident" id="2959028">Set</span><span class="op" id="2959031">(</span><span class="string" id="2959032">&#34;Content-Type&#34;</span><span class="op" id="2959046">,</span>&nbsp;<span class="ident" id="2959048">ctype</span><span class="op" id="2959053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2959056">}</span>&nbsp;<span class="keyword" id="2959058">else</span>&nbsp;<span class="keyword" id="2959063">if</span>&nbsp;<span class="builtinfunc" id="2959066">len</span><span class="op" id="2959069">(</span><span class="ident" id="2959070">ctypes</span><span class="op" id="2959076">)</span>&nbsp;<span class="op" id="2959078">&gt;</span>&nbsp;<span class="num" id="2959080">0</span>&nbsp;<span class="op" id="2959082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2959086">ctype</span>&nbsp;<span class="op" id="2959092">=</span>&nbsp;<span class="ident" id="2959094">ctypes</span><span class="op" id="2959100">[</span><span class="num" id="2959101">0</span><span class="op" id="2959102">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2959105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2959109">size</span><span class="op" id="2959113">,</span>&nbsp;<span class="ident" id="2959115">err</span>&nbsp;<span class="op" id="2959119">:=</span>&nbsp;<span class="ident" id="2959122">sizeFunc</span><span class="op" id="2959130">(</span><span class="op" id="2959131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2959134">if</span>&nbsp;<span class="ident" id="2959137">err</span>&nbsp;<span class="op" id="2959141">!=</span>&nbsp;<span class="builtintype" id="2959144">nil</span>&nbsp;<span class="op" id="2959148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2959152">Error</span><span class="op" id="2959157">(</span><span class="ident" id="2959158">w</span><span class="op" id="2959159">,</span>&nbsp;<span class="ident" id="2959161">err</span><span class="op" id="2959164">.</span><span class="ident" id="2959165">Error</span><span class="op" id="2959170">(</span><span class="op" id="2959171">)</span><span class="op" id="2959172">,</span>&nbsp;<span class="ident" id="2959174">StatusInternalServerError</span><span class="op" id="2959199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2959203">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2959211">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2959215">//&nbsp;handle&nbsp;Content-Range&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2959248">sendSize</span>&nbsp;<span class="op" id="2959257">:=</span>&nbsp;<span class="ident" id="2959260">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2959266">var</span>&nbsp;<span class="ident" id="2959270">sendContent</span>&nbsp;<span class="ident" id="2959282">io</span><span class="op" id="2959284">.</span><span class="ident" id="2959285">Reader</span>&nbsp;<span class="op" id="2959292">=</span>&nbsp;<span class="ident" id="2959294">content</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2959303">if</span>&nbsp;<span class="ident" id="2959306">size</span>&nbsp;<span class="op" id="2959311">&gt;=</span>&nbsp;<span class="num" id="2959314">0</span>&nbsp;<span class="op" id="2959316">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2959320">ranges</span><span class="op" id="2959326">,</span>&nbsp;<span class="ident" id="2959328">err</span>&nbsp;<span class="op" id="2959332">:=</span>&nbsp;<span class="ident" id="2959335">parseRange</span><span class="op" id="2959345">(</span><span class="ident" id="2959346">rangeReq</span><span class="op" id="2959354">,</span>&nbsp;<span class="ident" id="2959356">size</span><span class="op" id="2959360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2959364">if</span>&nbsp;<span class="ident" id="2959367">err</span>&nbsp;<span class="op" id="2959371">!=</span>&nbsp;<span class="builtintype" id="2959374">nil</span>&nbsp;<span class="op" id="2959378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2959383">Error</span><span class="op" id="2959388">(</span><span class="ident" id="2959389">w</span><span class="op" id="2959390">,</span>&nbsp;<span class="ident" id="2959392">err</span><span class="op" id="2959395">.</span><span class="ident" id="2959396">Error</span><span class="op" id="2959401">(</span><span class="op" id="2959402">)</span><span class="op" id="2959403">,</span>&nbsp;<span class="ident" id="2959405">StatusRequestedRangeNotSatisfiable</span><span class="op" id="2959439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2959444">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2959453">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2959457">if</span>&nbsp;<span class="ident" id="2959460">sumRangesSize</span><span class="op" id="2959473">(</span><span class="ident" id="2959474">ranges</span><span class="op" id="2959480">)</span>&nbsp;<span class="op" id="2959482">&gt;</span>&nbsp;<span class="ident" id="2959484">size</span>&nbsp;<span class="op" id="2959489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2959494">//&nbsp;The&nbsp;total&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;all&nbsp;the&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2959544">//&nbsp;is&nbsp;larger&nbsp;than&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;file&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2959589">//&nbsp;itself,&nbsp;so&nbsp;this&nbsp;is&nbsp;probably&nbsp;an&nbsp;attack,&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2959639">//&nbsp;dumb&nbsp;client.&nbsp;&nbsp;Ignore&nbsp;the&nbsp;range&nbsp;request.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2959685">ranges</span>&nbsp;<span class="op" id="2959692">=</span>&nbsp;<span class="builtintype" id="2959694">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2959700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2959704">switch</span>&nbsp;<span class="op" id="2959711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2959715">case</span>&nbsp;<span class="builtinfunc" id="2959720">len</span><span class="op" id="2959723">(</span><span class="ident" id="2959724">ranges</span><span class="op" id="2959730">)</span>&nbsp;<span class="op" id="2959732">==</span>&nbsp;<span class="num" id="2959735">1</span><span class="op" id="2959736">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2959741">//&nbsp;RFC&nbsp;2616,&nbsp;Section&nbsp;14.16:</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2959772">//&nbsp;&#34;When&nbsp;an&nbsp;HTTP&nbsp;message&nbsp;includes&nbsp;the&nbsp;content&nbsp;of&nbsp;a&nbsp;single</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2959833">//&nbsp;range&nbsp;(for&nbsp;example,&nbsp;a&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2959889">//&nbsp;single&nbsp;range,&nbsp;or&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;set&nbsp;of&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2959945">//&nbsp;that&nbsp;overlap&nbsp;without&nbsp;any&nbsp;holes),&nbsp;this&nbsp;content&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2960000">//&nbsp;transmitted&nbsp;with&nbsp;a&nbsp;Content-Range&nbsp;header,&nbsp;and&nbsp;a</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2960053">//&nbsp;Content-Length&nbsp;header&nbsp;showing&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2960109">//&nbsp;actually&nbsp;transferred.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2960137">//&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2960147">//&nbsp;A&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;single&nbsp;range&nbsp;MUST&nbsp;NOT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2960205">//&nbsp;be&nbsp;sent&nbsp;using&nbsp;the&nbsp;multipart/byteranges&nbsp;media&nbsp;type.&#34;</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2960263">ra</span>&nbsp;<span class="op" id="2960266">:=</span>&nbsp;<span class="ident" id="2960269">ranges</span><span class="op" id="2960275">[</span><span class="num" id="2960276">0</span><span class="op" id="2960277">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2960282">if</span>&nbsp;<span class="ident" id="2960285">_</span><span class="op" id="2960286">,</span>&nbsp;<span class="ident" id="2960288">err</span>&nbsp;<span class="op" id="2960292">:=</span>&nbsp;<span class="ident" id="2960295">content</span><span class="op" id="2960302">.</span><span class="ident" id="2960303">Seek</span><span class="op" id="2960307">(</span><span class="ident" id="2960308">ra</span><span class="op" id="2960310">.</span><span class="ident" id="2960311">start</span><span class="op" id="2960316">,</span>&nbsp;<span class="ident" id="2960318">os</span><span class="op" id="2960320">.</span><span class="ident" id="2960321">SEEK_SET</span><span class="op" id="2960329">)</span><span class="op" id="2960330">;</span>&nbsp;<span class="ident" id="2960332">err</span>&nbsp;<span class="op" id="2960336">!=</span>&nbsp;<span class="builtintype" id="2960339">nil</span>&nbsp;<span class="op" id="2960343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2960349">Error</span><span class="op" id="2960354">(</span><span class="ident" id="2960355">w</span><span class="op" id="2960356">,</span>&nbsp;<span class="ident" id="2960358">err</span><span class="op" id="2960361">.</span><span class="ident" id="2960362">Error</span><span class="op" id="2960367">(</span><span class="op" id="2960368">)</span><span class="op" id="2960369">,</span>&nbsp;<span class="ident" id="2960371">StatusRequestedRangeNotSatisfiable</span><span class="op" id="2960405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2960411">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2960421">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2960426">sendSize</span>&nbsp;<span class="op" id="2960435">=</span>&nbsp;<span class="ident" id="2960437">ra</span><span class="op" id="2960439">.</span><span class="ident" id="2960440">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2960450">code</span>&nbsp;<span class="op" id="2960455">=</span>&nbsp;<span class="ident" id="2960457">StatusPartialContent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2960481">w</span><span class="op" id="2960482">.</span><span class="ident" id="2960483">Header</span><span class="op" id="2960489">(</span><span class="op" id="2960490">)</span><span class="op" id="2960491">.</span><span class="ident" id="2960492">Set</span><span class="op" id="2960495">(</span><span class="string" id="2960496">&#34;Content-Range&#34;</span><span class="op" id="2960511">,</span>&nbsp;<span class="ident" id="2960513">ra</span><span class="op" id="2960515">.</span><span class="ident" id="2960516">contentRange</span><span class="op" id="2960528">(</span><span class="ident" id="2960529">size</span><span class="op" id="2960533">)</span><span class="op" id="2960534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2960538">case</span>&nbsp;<span class="builtinfunc" id="2960543">len</span><span class="op" id="2960546">(</span><span class="ident" id="2960547">ranges</span><span class="op" id="2960553">)</span>&nbsp;<span class="op" id="2960555">&gt;</span>&nbsp;<span class="num" id="2960557">1</span><span class="op" id="2960558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2960563">sendSize</span>&nbsp;<span class="op" id="2960572">=</span>&nbsp;<span class="ident" id="2960574">rangesMIMESize</span><span class="op" id="2960588">(</span><span class="ident" id="2960589">ranges</span><span class="op" id="2960595">,</span>&nbsp;<span class="ident" id="2960597">ctype</span><span class="op" id="2960602">,</span>&nbsp;<span class="ident" id="2960604">size</span><span class="op" id="2960608">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2960613">code</span>&nbsp;<span class="op" id="2960618">=</span>&nbsp;<span class="ident" id="2960620">StatusPartialContent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2960645">pr</span><span class="op" id="2960647">,</span>&nbsp;<span class="ident" id="2960649">pw</span>&nbsp;<span class="op" id="2960652">:=</span>&nbsp;<span class="ident" id="2960655">io</span><span class="op" id="2960657">.</span><span class="ident" id="2960658">Pipe</span><span class="op" id="2960662">(</span><span class="op" id="2960663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2960668">mw</span>&nbsp;<span class="op" id="2960671">:=</span>&nbsp;<span class="ident" id="2960674">multipart</span><span class="op" id="2960683">.</span><span class="ident" id="2960684">NewWriter</span><span class="op" id="2960693">(</span><span class="ident" id="2960694">pw</span><span class="op" id="2960696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2960701">w</span><span class="op" id="2960702">.</span><span class="ident" id="2960703">Header</span><span class="op" id="2960709">(</span><span class="op" id="2960710">)</span><span class="op" id="2960711">.</span><span class="ident" id="2960712">Set</span><span class="op" id="2960715">(</span><span class="string" id="2960716">&#34;Content-Type&#34;</span><span class="op" id="2960730">,</span>&nbsp;<span class="string" id="2960732">&#34;multipart/byteranges;&nbsp;boundary=&#34;</span><span class="op" id="2960765">+</span><span class="ident" id="2960766">mw</span><span class="op" id="2960768">.</span><span class="ident" id="2960769">Boundary</span><span class="op" id="2960777">(</span><span class="op" id="2960778">)</span><span class="op" id="2960779">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2960784">sendContent</span>&nbsp;<span class="op" id="2960796">=</span>&nbsp;<span class="ident" id="2960798">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2960804">defer</span>&nbsp;<span class="ident" id="2960810">pr</span><span class="op" id="2960812">.</span><span class="ident" id="2960813">Close</span><span class="op" id="2960818">(</span><span class="op" id="2960819">)</span>&nbsp;<span class="comment" id="2960821">//&nbsp;cause&nbsp;writing&nbsp;goroutine&nbsp;to&nbsp;fail&nbsp;and&nbsp;exit&nbsp;if&nbsp;CopyN&nbsp;doesn&#39;t&nbsp;finish.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2960893">go</span>&nbsp;<span class="keyword" id="2960896">func</span><span class="op" id="2960900">(</span><span class="op" id="2960901">)</span>&nbsp;<span class="op" id="2960903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2960909">for</span>&nbsp;<span class="ident" id="2960913">_</span><span class="op" id="2960914">,</span>&nbsp;<span class="ident" id="2960916">ra</span>&nbsp;<span class="op" id="2960919">:=</span>&nbsp;<span class="keyword" id="2960922">range</span>&nbsp;<span class="ident" id="2960928">ranges</span>&nbsp;<span class="op" id="2960935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2960942">part</span><span class="op" id="2960946">,</span>&nbsp;<span class="ident" id="2960948">err</span>&nbsp;<span class="op" id="2960952">:=</span>&nbsp;<span class="ident" id="2960955">mw</span><span class="op" id="2960957">.</span><span class="ident" id="2960958">CreatePart</span><span class="op" id="2960968">(</span><span class="ident" id="2960969">ra</span><span class="op" id="2960971">.</span><span class="ident" id="2960972">mimeHeader</span><span class="op" id="2960982">(</span><span class="ident" id="2960983">ctype</span><span class="op" id="2960988">,</span>&nbsp;<span class="ident" id="2960990">size</span><span class="op" id="2960994">)</span><span class="op" id="2960995">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2961002">if</span>&nbsp;<span class="ident" id="2961005">err</span>&nbsp;<span class="op" id="2961009">!=</span>&nbsp;<span class="builtintype" id="2961012">nil</span>&nbsp;<span class="op" id="2961016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2961024">pw</span><span class="op" id="2961026">.</span><span class="ident" id="2961027">CloseWithError</span><span class="op" id="2961041">(</span><span class="ident" id="2961042">err</span><span class="op" id="2961045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2961053">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2961065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2961072">if</span>&nbsp;<span class="ident" id="2961075">_</span><span class="op" id="2961076">,</span>&nbsp;<span class="ident" id="2961078">err</span>&nbsp;<span class="op" id="2961082">:=</span>&nbsp;<span class="ident" id="2961085">content</span><span class="op" id="2961092">.</span><span class="ident" id="2961093">Seek</span><span class="op" id="2961097">(</span><span class="ident" id="2961098">ra</span><span class="op" id="2961100">.</span><span class="ident" id="2961101">start</span><span class="op" id="2961106">,</span>&nbsp;<span class="ident" id="2961108">os</span><span class="op" id="2961110">.</span><span class="ident" id="2961111">SEEK_SET</span><span class="op" id="2961119">)</span><span class="op" id="2961120">;</span>&nbsp;<span class="ident" id="2961122">err</span>&nbsp;<span class="op" id="2961126">!=</span>&nbsp;<span class="builtintype" id="2961129">nil</span>&nbsp;<span class="op" id="2961133">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2961141">pw</span><span class="op" id="2961143">.</span><span class="ident" id="2961144">CloseWithError</span><span class="op" id="2961158">(</span><span class="ident" id="2961159">err</span><span class="op" id="2961162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2961170">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2961182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2961189">if</span>&nbsp;<span class="ident" id="2961192">_</span><span class="op" id="2961193">,</span>&nbsp;<span class="ident" id="2961195">err</span>&nbsp;<span class="op" id="2961199">:=</span>&nbsp;<span class="ident" id="2961202">io</span><span class="op" id="2961204">.</span><span class="ident" id="2961205">CopyN</span><span class="op" id="2961210">(</span><span class="ident" id="2961211">part</span><span class="op" id="2961215">,</span>&nbsp;<span class="ident" id="2961217">content</span><span class="op" id="2961224">,</span>&nbsp;<span class="ident" id="2961226">ra</span><span class="op" id="2961228">.</span><span class="ident" id="2961229">length</span><span class="op" id="2961235">)</span><span class="op" id="2961236">;</span>&nbsp;<span class="ident" id="2961238">err</span>&nbsp;<span class="op" id="2961242">!=</span>&nbsp;<span class="builtintype" id="2961245">nil</span>&nbsp;<span class="op" id="2961249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2961257">pw</span><span class="op" id="2961259">.</span><span class="ident" id="2961260">CloseWithError</span><span class="op" id="2961274">(</span><span class="ident" id="2961275">err</span><span class="op" id="2961278">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2961286">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2961298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2961304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2961310">mw</span><span class="op" id="2961312">.</span><span class="ident" id="2961313">Close</span><span class="op" id="2961318">(</span><span class="op" id="2961319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2961325">pw</span><span class="op" id="2961327">.</span><span class="ident" id="2961328">Close</span><span class="op" id="2961333">(</span><span class="op" id="2961334">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2961339">}</span><span class="op" id="2961340">(</span><span class="op" id="2961341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2961345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2961350">w</span><span class="op" id="2961351">.</span><span class="ident" id="2961352">Header</span><span class="op" id="2961358">(</span><span class="op" id="2961359">)</span><span class="op" id="2961360">.</span><span class="ident" id="2961361">Set</span><span class="op" id="2961364">(</span><span class="string" id="2961365">&#34;Accept-Ranges&#34;</span><span class="op" id="2961380">,</span>&nbsp;<span class="string" id="2961382">&#34;bytes&#34;</span><span class="op" id="2961389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2961393">if</span>&nbsp;<span class="ident" id="2961396">w</span><span class="op" id="2961397">.</span><span class="ident" id="2961398">Header</span><span class="op" id="2961404">(</span><span class="op" id="2961405">)</span><span class="op" id="2961406">.</span><span class="ident" id="2961407">Get</span><span class="op" id="2961410">(</span><span class="string" id="2961411">&#34;Content-Encoding&#34;</span><span class="op" id="2961429">)</span>&nbsp;<span class="op" id="2961431">==</span>&nbsp;<span class="string" id="2961434">&#34;&#34;</span>&nbsp;<span class="op" id="2961437">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2961442">w</span><span class="op" id="2961443">.</span><span class="ident" id="2961444">Header</span><span class="op" id="2961450">(</span><span class="op" id="2961451">)</span><span class="op" id="2961452">.</span><span class="ident" id="2961453">Set</span><span class="op" id="2961456">(</span><span class="string" id="2961457">&#34;Content-Length&#34;</span><span class="op" id="2961473">,</span>&nbsp;<span class="ident" id="2961475">strconv</span><span class="op" id="2961482">.</span><span class="ident" id="2961483">FormatInt</span><span class="op" id="2961492">(</span><span class="ident" id="2961493">sendSize</span><span class="op" id="2961501">,</span>&nbsp;<span class="num" id="2961503">10</span><span class="op" id="2961505">)</span><span class="op" id="2961506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2961510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2961513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2961517">w</span><span class="op" id="2961518">.</span><span class="ident" id="2961519">WriteHeader</span><span class="op" id="2961530">(</span><span class="ident" id="2961531">code</span><span class="op" id="2961535">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2961539">if</span>&nbsp;<span class="ident" id="2961542">r</span><span class="op" id="2961543">.</span><span class="ident" id="2961544">Method</span>&nbsp;<span class="op" id="2961551">!=</span>&nbsp;<span class="string" id="2961554">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="2961561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2961565">io</span><span class="op" id="2961567">.</span><span class="ident" id="2961568">CopyN</span><span class="op" id="2961573">(</span><span class="ident" id="2961574">w</span><span class="op" id="2961575">,</span>&nbsp;<span class="ident" id="2961577">sendContent</span><span class="op" id="2961588">,</span>&nbsp;<span class="ident" id="2961590">sendSize</span><span class="op" id="2961598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2961601">}</span><br>
<span class="lineno"></span><span class="op" id="2961603">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="2961606">//&nbsp;modtime&nbsp;is&nbsp;the&nbsp;modification&nbsp;time&nbsp;of&nbsp;the&nbsp;resource&nbsp;to&nbsp;be&nbsp;served,&nbsp;or&nbsp;IsZero().</span><br>
<span class="lineno"></span><span class="comment" id="2961685">//&nbsp;return&nbsp;value&nbsp;is&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;complete.</span><br>
<span class="lineno"></span><span class="keyword" id="2961742">func</span>&nbsp;<span class="ident" id="2961747">checkLastModified</span><span class="op" id="2961764">(</span><span class="ident" id="2961765">w</span>&nbsp;<span class="ident" id="2961767">ResponseWriter</span><span class="op" id="2961781">,</span>&nbsp;<span class="ident" id="2961783">r</span>&nbsp;<span class="op" id="2961785">*</span><span class="ident" id="2961786">Request</span><span class="op" id="2961793">,</span>&nbsp;<span class="ident" id="2961795">modtime</span>&nbsp;<span class="ident" id="2961803">time</span><span class="op" id="2961807">.</span><span class="ident" id="2961808">Time</span><span class="op" id="2961812">)</span>&nbsp;<span class="builtintype" id="2961814">bool</span>&nbsp;<span class="op" id="2961819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2961822">if</span>&nbsp;<span class="ident" id="2961825">modtime</span><span class="op" id="2961832">.</span><span class="ident" id="2961833">IsZero</span><span class="op" id="2961839">(</span><span class="op" id="2961840">)</span>&nbsp;<span class="op" id="2961842">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2961846">return</span>&nbsp;<span class="builtintype" id="2961853">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2961860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2961864">//&nbsp;The&nbsp;Date-Modified&nbsp;header&nbsp;truncates&nbsp;sub-second&nbsp;precision,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2961928">//&nbsp;use&nbsp;mtime&nbsp;&lt;&nbsp;t+1s&nbsp;instead&nbsp;of&nbsp;mtime&nbsp;&lt;=&nbsp;t&nbsp;to&nbsp;check&nbsp;for&nbsp;unmodified.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2961996">if</span>&nbsp;<span class="ident" id="2961999">t</span><span class="op" id="2962000">,</span>&nbsp;<span class="ident" id="2962002">err</span>&nbsp;<span class="op" id="2962006">:=</span>&nbsp;<span class="ident" id="2962009">time</span><span class="op" id="2962013">.</span><span class="ident" id="2962014">Parse</span><span class="op" id="2962019">(</span><span class="ident" id="2962020">TimeFormat</span><span class="op" id="2962030">,</span>&nbsp;<span class="ident" id="2962032">r</span><span class="op" id="2962033">.</span><span class="ident" id="2962034">Header</span><span class="op" id="2962040">.</span><span class="ident" id="2962041">Get</span><span class="op" id="2962044">(</span><span class="string" id="2962045">&#34;If-Modified-Since&#34;</span><span class="op" id="2962064">)</span><span class="op" id="2962065">)</span><span class="op" id="2962066">;</span>&nbsp;<span class="ident" id="2962068">err</span>&nbsp;<span class="op" id="2962072">==</span>&nbsp;<span class="builtintype" id="2962075">nil</span>&nbsp;<span class="op" id="2962079">&amp;&amp;</span>&nbsp;<span class="ident" id="2962082">modtime</span><span class="op" id="2962089">.</span><span class="ident" id="2962090">Before</span><span class="op" id="2962096">(</span><span class="ident" id="2962097">t</span><span class="op" id="2962098">.</span><span class="ident" id="2962099">Add</span><span class="op" id="2962102">(</span><span class="num" id="2962103">1</span><span class="op" id="2962104">*</span><span class="ident" id="2962105">time</span><span class="op" id="2962109">.</span><span class="ident" id="2962110">Second</span><span class="op" id="2962116">)</span><span class="op" id="2962117">)</span>&nbsp;<span class="op" id="2962119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2962123">h</span>&nbsp;<span class="op" id="2962125">:=</span>&nbsp;<span class="ident" id="2962128">w</span><span class="op" id="2962129">.</span><span class="ident" id="2962130">Header</span><span class="op" id="2962136">(</span><span class="op" id="2962137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2962141">delete</span><span class="op" id="2962147">(</span><span class="ident" id="2962148">h</span><span class="op" id="2962149">,</span>&nbsp;<span class="string" id="2962151">&#34;Content-Type&#34;</span><span class="op" id="2962165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2962169">delete</span><span class="op" id="2962175">(</span><span class="ident" id="2962176">h</span><span class="op" id="2962177">,</span>&nbsp;<span class="string" id="2962179">&#34;Content-Length&#34;</span><span class="op" id="2962195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2962199">w</span><span class="op" id="2962200">.</span><span class="ident" id="2962201">WriteHeader</span><span class="op" id="2962212">(</span><span class="ident" id="2962213">StatusNotModified</span><span class="op" id="2962230">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2962234">return</span>&nbsp;<span class="builtintype" id="2962241">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2962247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2962250">w</span><span class="op" id="2962251">.</span><span class="ident" id="2962252">Header</span><span class="op" id="2962258">(</span><span class="op" id="2962259">)</span><span class="op" id="2962260">.</span><span class="ident" id="2962261">Set</span><span class="op" id="2962264">(</span><span class="string" id="2962265">&#34;Last-Modified&#34;</span><span class="op" id="2962280">,</span>&nbsp;<span class="ident" id="2962282">modtime</span><span class="op" id="2962289">.</span><span class="ident" id="2962290">UTC</span><span class="op" id="2962293">(</span><span class="op" id="2962294">)</span><span class="op" id="2962295">.</span><span class="ident" id="2962296">Format</span><span class="op" id="2962302">(</span><span class="ident" id="2962303">TimeFormat</span><span class="op" id="2962313">)</span><span class="op" id="2962314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2962317">return</span>&nbsp;<span class="builtintype" id="2962324">false</span><br>
<span class="lineno"></span><span class="op" id="2962330">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="2962333">//&nbsp;checkETag&nbsp;implements&nbsp;If-None-Match&nbsp;and&nbsp;If-Range&nbsp;checks.</span><br>
<span class="lineno"></span><span class="comment" id="2962392">//</span><br>
<span class="lineno"></span><span class="comment" id="2962395">//&nbsp;The&nbsp;ETag&nbsp;or&nbsp;modtime&nbsp;must&nbsp;have&nbsp;been&nbsp;previously&nbsp;set&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2962455">//&nbsp;ResponseWriter&#39;s&nbsp;headers.&nbsp;&nbsp;The&nbsp;modtime&nbsp;is&nbsp;only&nbsp;compared&nbsp;at&nbsp;second</span><br>
<span class="lineno">285</span><span class="comment" id="2962524">//&nbsp;granularity&nbsp;and&nbsp;may&nbsp;be&nbsp;the&nbsp;zero&nbsp;value&nbsp;to&nbsp;mean&nbsp;unknown.</span><br>
<span class="lineno"></span><span class="comment" id="2962582">//</span><br>
<span class="lineno"></span><span class="comment" id="2962585">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;effective&nbsp;request&nbsp;&#34;Range&#34;&nbsp;header&nbsp;to&nbsp;use&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="2962656">//&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;considered&nbsp;done.</span><br>
<span class="lineno"></span><span class="keyword" id="2962704">func</span>&nbsp;<span class="ident" id="2962709">checkETag</span><span class="op" id="2962718">(</span><span class="ident" id="2962719">w</span>&nbsp;<span class="ident" id="2962721">ResponseWriter</span><span class="op" id="2962735">,</span>&nbsp;<span class="ident" id="2962737">r</span>&nbsp;<span class="op" id="2962739">*</span><span class="ident" id="2962740">Request</span><span class="op" id="2962747">,</span>&nbsp;<span class="ident" id="2962749">modtime</span>&nbsp;<span class="ident" id="2962757">time</span><span class="op" id="2962761">.</span><span class="ident" id="2962762">Time</span><span class="op" id="2962766">)</span>&nbsp;<span class="op" id="2962768">(</span><span class="ident" id="2962769">rangeReq</span>&nbsp;<span class="builtintype" id="2962778">string</span><span class="op" id="2962784">,</span>&nbsp;<span class="ident" id="2962786">done</span>&nbsp;<span class="builtintype" id="2962791">bool</span><span class="op" id="2962795">)</span>&nbsp;<span class="op" id="2962797">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2962800">etag</span>&nbsp;<span class="op" id="2962805">:=</span>&nbsp;<span class="ident" id="2962808">w</span><span class="op" id="2962809">.</span><span class="ident" id="2962810">Header</span><span class="op" id="2962816">(</span><span class="op" id="2962817">)</span><span class="op" id="2962818">.</span><span class="ident" id="2962819">get</span><span class="op" id="2962822">(</span><span class="string" id="2962823">&#34;Etag&#34;</span><span class="op" id="2962829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2962832">rangeReq</span>&nbsp;<span class="op" id="2962841">=</span>&nbsp;<span class="ident" id="2962843">r</span><span class="op" id="2962844">.</span><span class="ident" id="2962845">Header</span><span class="op" id="2962851">.</span><span class="ident" id="2962852">get</span><span class="op" id="2962855">(</span><span class="string" id="2962856">&#34;Range&#34;</span><span class="op" id="2962863">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2962867">//&nbsp;Invalidate&nbsp;the&nbsp;range&nbsp;request&nbsp;if&nbsp;the&nbsp;entity&nbsp;doesn&#39;t&nbsp;match&nbsp;the&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2962936">//&nbsp;the&nbsp;client&nbsp;was&nbsp;expecting.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2962966">//&nbsp;&#34;If-Range:&nbsp;version&#34;&nbsp;means&nbsp;&#34;ignore&nbsp;the&nbsp;Range:&nbsp;header&nbsp;unless&nbsp;version&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2963049">//&nbsp;current&nbsp;file.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2963068">//&nbsp;We&nbsp;only&nbsp;support&nbsp;ETag&nbsp;versions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2963103">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;have&nbsp;set&nbsp;the&nbsp;ETag&nbsp;on&nbsp;the&nbsp;response&nbsp;already.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2963166">if</span>&nbsp;<span class="ident" id="2963169">ir</span>&nbsp;<span class="op" id="2963172">:=</span>&nbsp;<span class="ident" id="2963175">r</span><span class="op" id="2963176">.</span><span class="ident" id="2963177">Header</span><span class="op" id="2963183">.</span><span class="ident" id="2963184">get</span><span class="op" id="2963187">(</span><span class="string" id="2963188">&#34;If-Range&#34;</span><span class="op" id="2963198">)</span><span class="op" id="2963199">;</span>&nbsp;<span class="ident" id="2963201">ir</span>&nbsp;<span class="op" id="2963204">!=</span>&nbsp;<span class="string" id="2963207">&#34;&#34;</span>&nbsp;<span class="op" id="2963210">&amp;&amp;</span>&nbsp;<span class="ident" id="2963213">ir</span>&nbsp;<span class="op" id="2963216">!=</span>&nbsp;<span class="ident" id="2963219">etag</span>&nbsp;<span class="op" id="2963224">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2963228">//&nbsp;The&nbsp;If-Range&nbsp;value&nbsp;is&nbsp;typically&nbsp;the&nbsp;ETag&nbsp;value,&nbsp;but&nbsp;it&nbsp;may&nbsp;also&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2963300">//&nbsp;the&nbsp;modtime&nbsp;date.&nbsp;See&nbsp;golang.org/issue/8367.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2963350">timeMatches</span>&nbsp;<span class="op" id="2963362">:=</span>&nbsp;<span class="builtintype" id="2963365">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2963373">if</span>&nbsp;<span class="op" id="2963376">!</span><span class="ident" id="2963377">modtime</span><span class="op" id="2963384">.</span><span class="ident" id="2963385">IsZero</span><span class="op" id="2963391">(</span><span class="op" id="2963392">)</span>&nbsp;<span class="op" id="2963394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2963399">if</span>&nbsp;<span class="ident" id="2963402">t</span><span class="op" id="2963403">,</span>&nbsp;<span class="ident" id="2963405">err</span>&nbsp;<span class="op" id="2963409">:=</span>&nbsp;<span class="ident" id="2963412">ParseTime</span><span class="op" id="2963421">(</span><span class="ident" id="2963422">ir</span><span class="op" id="2963424">)</span><span class="op" id="2963425">;</span>&nbsp;<span class="ident" id="2963427">err</span>&nbsp;<span class="op" id="2963431">==</span>&nbsp;<span class="builtintype" id="2963434">nil</span>&nbsp;<span class="op" id="2963438">&amp;&amp;</span>&nbsp;<span class="ident" id="2963441">t</span><span class="op" id="2963442">.</span><span class="ident" id="2963443">Unix</span><span class="op" id="2963447">(</span><span class="op" id="2963448">)</span>&nbsp;<span class="op" id="2963450">==</span>&nbsp;<span class="ident" id="2963453">modtime</span><span class="op" id="2963460">.</span><span class="ident" id="2963461">Unix</span><span class="op" id="2963465">(</span><span class="op" id="2963466">)</span>&nbsp;<span class="op" id="2963468">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2963474">timeMatches</span>&nbsp;<span class="op" id="2963486">=</span>&nbsp;<span class="builtintype" id="2963488">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2963496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2963500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2963504">if</span>&nbsp;<span class="op" id="2963507">!</span><span class="ident" id="2963508">timeMatches</span>&nbsp;<span class="op" id="2963520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2963525">rangeReq</span>&nbsp;<span class="op" id="2963534">=</span>&nbsp;<span class="string" id="2963536">&#34;&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2963541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2963544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2963548">if</span>&nbsp;<span class="ident" id="2963551">inm</span>&nbsp;<span class="op" id="2963555">:=</span>&nbsp;<span class="ident" id="2963558">r</span><span class="op" id="2963559">.</span><span class="ident" id="2963560">Header</span><span class="op" id="2963566">.</span><span class="ident" id="2963567">get</span><span class="op" id="2963570">(</span><span class="string" id="2963571">&#34;If-None-Match&#34;</span><span class="op" id="2963586">)</span><span class="op" id="2963587">;</span>&nbsp;<span class="ident" id="2963589">inm</span>&nbsp;<span class="op" id="2963593">!=</span>&nbsp;<span class="string" id="2963596">&#34;&#34;</span>&nbsp;<span class="op" id="2963599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2963603">//&nbsp;Must&nbsp;know&nbsp;ETag.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2963624">if</span>&nbsp;<span class="ident" id="2963627">etag</span>&nbsp;<span class="op" id="2963632">==</span>&nbsp;<span class="string" id="2963635">&#34;&#34;</span>&nbsp;<span class="op" id="2963638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2963643">return</span>&nbsp;<span class="ident" id="2963650">rangeReq</span><span class="op" id="2963658">,</span>&nbsp;<span class="builtintype" id="2963660">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2963668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2963673">//&nbsp;TODO(bradfitz):&nbsp;non-GET/HEAD&nbsp;requests&nbsp;require&nbsp;more&nbsp;work:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2963735">//&nbsp;sending&nbsp;a&nbsp;different&nbsp;status&nbsp;code&nbsp;on&nbsp;matches,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2963788">//&nbsp;also&nbsp;can&#39;t&nbsp;use&nbsp;weak&nbsp;cache&nbsp;validators&nbsp;(those&nbsp;with&nbsp;a&nbsp;&#34;W/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2963848">//&nbsp;prefix).&nbsp;&nbsp;But&nbsp;most&nbsp;users&nbsp;of&nbsp;ServeContent&nbsp;will&nbsp;be&nbsp;using</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2963908">//&nbsp;it&nbsp;on&nbsp;GET&nbsp;or&nbsp;HEAD,&nbsp;so&nbsp;only&nbsp;support&nbsp;those&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2963963">if</span>&nbsp;<span class="ident" id="2963966">r</span><span class="op" id="2963967">.</span><span class="ident" id="2963968">Method</span>&nbsp;<span class="op" id="2963975">!=</span>&nbsp;<span class="string" id="2963978">&#34;GET&#34;</span>&nbsp;<span class="op" id="2963984">&amp;&amp;</span>&nbsp;<span class="ident" id="2963987">r</span><span class="op" id="2963988">.</span><span class="ident" id="2963989">Method</span>&nbsp;<span class="op" id="2963996">!=</span>&nbsp;<span class="string" id="2963999">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="2964006">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2964011">return</span>&nbsp;<span class="ident" id="2964018">rangeReq</span><span class="op" id="2964026">,</span>&nbsp;<span class="builtintype" id="2964028">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2964036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2964041">//&nbsp;TODO(bradfitz):&nbsp;deal&nbsp;with&nbsp;comma-separated&nbsp;or&nbsp;multiple-valued</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2964107">//&nbsp;list&nbsp;of&nbsp;If-None-match&nbsp;values.&nbsp;&nbsp;For&nbsp;now&nbsp;just&nbsp;handle&nbsp;the&nbsp;common</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2964174">//&nbsp;case&nbsp;of&nbsp;a&nbsp;single&nbsp;item.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2964202">if</span>&nbsp;<span class="ident" id="2964205">inm</span>&nbsp;<span class="op" id="2964209">==</span>&nbsp;<span class="ident" id="2964212">etag</span>&nbsp;<span class="op" id="2964217">||</span>&nbsp;<span class="ident" id="2964220">inm</span>&nbsp;<span class="op" id="2964224">==</span>&nbsp;<span class="string" id="2964227">&#34;*&#34;</span>&nbsp;<span class="op" id="2964231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2964236">h</span>&nbsp;<span class="op" id="2964238">:=</span>&nbsp;<span class="ident" id="2964241">w</span><span class="op" id="2964242">.</span><span class="ident" id="2964243">Header</span><span class="op" id="2964249">(</span><span class="op" id="2964250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2964255">delete</span><span class="op" id="2964261">(</span><span class="ident" id="2964262">h</span><span class="op" id="2964263">,</span>&nbsp;<span class="string" id="2964265">&#34;Content-Type&#34;</span><span class="op" id="2964279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2964284">delete</span><span class="op" id="2964290">(</span><span class="ident" id="2964291">h</span><span class="op" id="2964292">,</span>&nbsp;<span class="string" id="2964294">&#34;Content-Length&#34;</span><span class="op" id="2964310">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2964315">w</span><span class="op" id="2964316">.</span><span class="ident" id="2964317">WriteHeader</span><span class="op" id="2964328">(</span><span class="ident" id="2964329">StatusNotModified</span><span class="op" id="2964346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2964351">return</span>&nbsp;<span class="string" id="2964358">&#34;&#34;</span><span class="op" id="2964360">,</span>&nbsp;<span class="builtintype" id="2964362">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2964369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2964372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2964375">return</span>&nbsp;<span class="ident" id="2964382">rangeReq</span><span class="op" id="2964390">,</span>&nbsp;<span class="builtintype" id="2964392">false</span><br>
<span class="lineno">340</span><span class="op" id="2964398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2964401">//&nbsp;name&nbsp;is&nbsp;&#39;/&#39;-separated,&nbsp;not&nbsp;filepath.Separator.</span><br>
<span class="lineno"></span><span class="keyword" id="2964451">func</span>&nbsp;<span class="ident" id="2964456">serveFile</span><span class="op" id="2964465">(</span><span class="ident" id="2964466">w</span>&nbsp;<span class="ident" id="2964468">ResponseWriter</span><span class="op" id="2964482">,</span>&nbsp;<span class="ident" id="2964484">r</span>&nbsp;<span class="op" id="2964486">*</span><span class="ident" id="2964487">Request</span><span class="op" id="2964494">,</span>&nbsp;<span class="ident" id="2964496">fs</span>&nbsp;<span class="ident" id="2964499">FileSystem</span><span class="op" id="2964509">,</span>&nbsp;<span class="ident" id="2964511">name</span>&nbsp;<span class="builtintype" id="2964516">string</span><span class="op" id="2964522">,</span>&nbsp;<span class="ident" id="2964524">redirect</span>&nbsp;<span class="builtintype" id="2964533">bool</span><span class="op" id="2964537">)</span>&nbsp;<span class="op" id="2964539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2964542">const</span>&nbsp;<span class="ident" id="2964548">indexPage</span>&nbsp;<span class="op" id="2964558">=</span>&nbsp;<span class="string" id="2964560">&#34;/index.html&#34;</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2964576">//&nbsp;redirect&nbsp;.../index.html&nbsp;to&nbsp;.../</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2964612">//&nbsp;can&#39;t&nbsp;use&nbsp;Redirect()&nbsp;because&nbsp;that&nbsp;would&nbsp;make&nbsp;the&nbsp;path&nbsp;absolute,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2964680">//&nbsp;which&nbsp;would&nbsp;be&nbsp;a&nbsp;problem&nbsp;running&nbsp;under&nbsp;StripPrefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2964735">if</span>&nbsp;<span class="ident" id="2964738">strings</span><span class="op" id="2964745">.</span><span class="ident" id="2964746">HasSuffix</span><span class="op" id="2964755">(</span><span class="ident" id="2964756">r</span><span class="op" id="2964757">.</span><span class="ident" id="2964758">URL</span><span class="op" id="2964761">.</span><span class="ident" id="2964762">Path</span><span class="op" id="2964766">,</span>&nbsp;<span class="ident" id="2964768">indexPage</span><span class="op" id="2964777">)</span>&nbsp;<span class="op" id="2964779">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2964783">localRedirect</span><span class="op" id="2964796">(</span><span class="ident" id="2964797">w</span><span class="op" id="2964798">,</span>&nbsp;<span class="ident" id="2964800">r</span><span class="op" id="2964801">,</span>&nbsp;<span class="string" id="2964803">&#34;./&#34;</span><span class="op" id="2964807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2964811">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2964819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2964823">f</span><span class="op" id="2964824">,</span>&nbsp;<span class="ident" id="2964826">err</span>&nbsp;<span class="op" id="2964830">:=</span>&nbsp;<span class="ident" id="2964833">fs</span><span class="op" id="2964835">.</span><span class="ident" id="2964836">Open</span><span class="op" id="2964840">(</span><span class="ident" id="2964841">name</span><span class="op" id="2964845">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2964848">if</span>&nbsp;<span class="ident" id="2964851">err</span>&nbsp;<span class="op" id="2964855">!=</span>&nbsp;<span class="builtintype" id="2964858">nil</span>&nbsp;<span class="op" id="2964862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2964866">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2964897">NotFound</span><span class="op" id="2964905">(</span><span class="ident" id="2964906">w</span><span class="op" id="2964907">,</span>&nbsp;<span class="ident" id="2964909">r</span><span class="op" id="2964910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2964914">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2964922">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2964925">defer</span>&nbsp;<span class="ident" id="2964931">f</span><span class="op" id="2964932">.</span><span class="ident" id="2964933">Close</span><span class="op" id="2964938">(</span><span class="op" id="2964939">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2964943">d</span><span class="op" id="2964944">,</span>&nbsp;<span class="ident" id="2964946">err1</span>&nbsp;<span class="op" id="2964951">:=</span>&nbsp;<span class="ident" id="2964954">f</span><span class="op" id="2964955">.</span><span class="ident" id="2964956">Stat</span><span class="op" id="2964960">(</span><span class="op" id="2964961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2964964">if</span>&nbsp;<span class="ident" id="2964967">err1</span>&nbsp;<span class="op" id="2964972">!=</span>&nbsp;<span class="builtintype" id="2964975">nil</span>&nbsp;<span class="op" id="2964979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2964983">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2965014">NotFound</span><span class="op" id="2965022">(</span><span class="ident" id="2965023">w</span><span class="op" id="2965024">,</span>&nbsp;<span class="ident" id="2965026">r</span><span class="op" id="2965027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2965031">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2965039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2965043">if</span>&nbsp;<span class="ident" id="2965046">redirect</span>&nbsp;<span class="op" id="2965055">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2965059">//&nbsp;redirect&nbsp;to&nbsp;canonical&nbsp;path:&nbsp;/&nbsp;at&nbsp;end&nbsp;of&nbsp;directory&nbsp;url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2965118">//&nbsp;r.URL.Path&nbsp;always&nbsp;begins&nbsp;with&nbsp;/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2965155">url</span>&nbsp;<span class="op" id="2965159">:=</span>&nbsp;<span class="ident" id="2965162">r</span><span class="op" id="2965163">.</span><span class="ident" id="2965164">URL</span><span class="op" id="2965167">.</span><span class="ident" id="2965168">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2965175">if</span>&nbsp;<span class="ident" id="2965178">d</span><span class="op" id="2965179">.</span><span class="ident" id="2965180">IsDir</span><span class="op" id="2965185">(</span><span class="op" id="2965186">)</span>&nbsp;<span class="op" id="2965188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2965193">if</span>&nbsp;<span class="ident" id="2965196">url</span><span class="op" id="2965199">[</span><span class="builtinfunc" id="2965200">len</span><span class="op" id="2965203">(</span><span class="ident" id="2965204">url</span><span class="op" id="2965207">)</span><span class="op" id="2965208">-</span><span class="num" id="2965209">1</span><span class="op" id="2965210">]</span>&nbsp;<span class="op" id="2965212">!=</span>&nbsp;<span class="string" id="2965215">&#39;/&#39;</span>&nbsp;<span class="op" id="2965219">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2965225">localRedirect</span><span class="op" id="2965238">(</span><span class="ident" id="2965239">w</span><span class="op" id="2965240">,</span>&nbsp;<span class="ident" id="2965242">r</span><span class="op" id="2965243">,</span>&nbsp;<span class="ident" id="2965245">path</span><span class="op" id="2965249">.</span><span class="ident" id="2965250">Base</span><span class="op" id="2965254">(</span><span class="ident" id="2965255">url</span><span class="op" id="2965258">)</span><span class="op" id="2965259">+</span><span class="string" id="2965260">&#34;/&#34;</span><span class="op" id="2965263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2965269">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2965279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2965283">}</span>&nbsp;<span class="keyword" id="2965285">else</span>&nbsp;<span class="op" id="2965290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2965295">if</span>&nbsp;<span class="ident" id="2965298">url</span><span class="op" id="2965301">[</span><span class="builtinfunc" id="2965302">len</span><span class="op" id="2965305">(</span><span class="ident" id="2965306">url</span><span class="op" id="2965309">)</span><span class="op" id="2965310">-</span><span class="num" id="2965311">1</span><span class="op" id="2965312">]</span>&nbsp;<span class="op" id="2965314">==</span>&nbsp;<span class="string" id="2965317">&#39;/&#39;</span>&nbsp;<span class="op" id="2965321">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2965327">localRedirect</span><span class="op" id="2965340">(</span><span class="ident" id="2965341">w</span><span class="op" id="2965342">,</span>&nbsp;<span class="ident" id="2965344">r</span><span class="op" id="2965345">,</span>&nbsp;<span class="string" id="2965347">&#34;../&#34;</span><span class="op" id="2965352">+</span><span class="ident" id="2965353">path</span><span class="op" id="2965357">.</span><span class="ident" id="2965358">Base</span><span class="op" id="2965362">(</span><span class="ident" id="2965363">url</span><span class="op" id="2965366">)</span><span class="op" id="2965367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2965373">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2965383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2965387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2965390">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2965394">//&nbsp;use&nbsp;contents&nbsp;of&nbsp;index.html&nbsp;for&nbsp;directory,&nbsp;if&nbsp;present</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2965451">if</span>&nbsp;<span class="ident" id="2965454">d</span><span class="op" id="2965455">.</span><span class="ident" id="2965456">IsDir</span><span class="op" id="2965461">(</span><span class="op" id="2965462">)</span>&nbsp;<span class="op" id="2965464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2965468">index</span>&nbsp;<span class="op" id="2965474">:=</span>&nbsp;<span class="ident" id="2965477">strings</span><span class="op" id="2965484">.</span><span class="ident" id="2965485">TrimSuffix</span><span class="op" id="2965495">(</span><span class="ident" id="2965496">name</span><span class="op" id="2965500">,</span>&nbsp;<span class="string" id="2965502">&#34;/&#34;</span><span class="op" id="2965505">)</span>&nbsp;<span class="op" id="2965507">+</span>&nbsp;<span class="ident" id="2965509">indexPage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2965521">ff</span><span class="op" id="2965523">,</span>&nbsp;<span class="ident" id="2965525">err</span>&nbsp;<span class="op" id="2965529">:=</span>&nbsp;<span class="ident" id="2965532">fs</span><span class="op" id="2965534">.</span><span class="ident" id="2965535">Open</span><span class="op" id="2965539">(</span><span class="ident" id="2965540">index</span><span class="op" id="2965545">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2965549">if</span>&nbsp;<span class="ident" id="2965552">err</span>&nbsp;<span class="op" id="2965556">==</span>&nbsp;<span class="builtintype" id="2965559">nil</span>&nbsp;<span class="op" id="2965563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2965568">defer</span>&nbsp;<span class="ident" id="2965574">ff</span><span class="op" id="2965576">.</span><span class="ident" id="2965577">Close</span><span class="op" id="2965582">(</span><span class="op" id="2965583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2965588">dd</span><span class="op" id="2965590">,</span>&nbsp;<span class="ident" id="2965592">err</span>&nbsp;<span class="op" id="2965596">:=</span>&nbsp;<span class="ident" id="2965599">ff</span><span class="op" id="2965601">.</span><span class="ident" id="2965602">Stat</span><span class="op" id="2965606">(</span><span class="op" id="2965607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2965612">if</span>&nbsp;<span class="ident" id="2965615">err</span>&nbsp;<span class="op" id="2965619">==</span>&nbsp;<span class="builtintype" id="2965622">nil</span>&nbsp;<span class="op" id="2965626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2965632">name</span>&nbsp;<span class="op" id="2965637">=</span>&nbsp;<span class="ident" id="2965639">index</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2965649">d</span>&nbsp;<span class="op" id="2965651">=</span>&nbsp;<span class="ident" id="2965653">dd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2965660">f</span>&nbsp;<span class="op" id="2965662">=</span>&nbsp;<span class="ident" id="2965664">ff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2965670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2965674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2965677">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2965681">//&nbsp;Still&nbsp;a&nbsp;directory?&nbsp;(we&nbsp;didn&#39;t&nbsp;find&nbsp;an&nbsp;index.html&nbsp;file)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2965740">if</span>&nbsp;<span class="ident" id="2965743">d</span><span class="op" id="2965744">.</span><span class="ident" id="2965745">IsDir</span><span class="op" id="2965750">(</span><span class="op" id="2965751">)</span>&nbsp;<span class="op" id="2965753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2965757">if</span>&nbsp;<span class="ident" id="2965760">checkLastModified</span><span class="op" id="2965777">(</span><span class="ident" id="2965778">w</span><span class="op" id="2965779">,</span>&nbsp;<span class="ident" id="2965781">r</span><span class="op" id="2965782">,</span>&nbsp;<span class="ident" id="2965784">d</span><span class="op" id="2965785">.</span><span class="ident" id="2965786">ModTime</span><span class="op" id="2965793">(</span><span class="op" id="2965794">)</span><span class="op" id="2965795">)</span>&nbsp;<span class="op" id="2965797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2965802">return</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2965811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2965815">dirList</span><span class="op" id="2965822">(</span><span class="ident" id="2965823">w</span><span class="op" id="2965824">,</span>&nbsp;<span class="ident" id="2965826">f</span><span class="op" id="2965827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2965831">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2965839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2965843">//&nbsp;serveContent&nbsp;will&nbsp;check&nbsp;modification&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2965889">sizeFunc</span>&nbsp;<span class="op" id="2965898">:=</span>&nbsp;<span class="keyword" id="2965901">func</span><span class="op" id="2965905">(</span><span class="op" id="2965906">)</span>&nbsp;<span class="op" id="2965908">(</span><span class="ident" id="2965909">int64</span><span class="op" id="2965914">,</span>&nbsp;<span class="builtintype" id="2965916">error</span><span class="op" id="2965921">)</span>&nbsp;<span class="op" id="2965923">{</span>&nbsp;<span class="keyword" id="2965925">return</span>&nbsp;<span class="ident" id="2965932">d</span><span class="op" id="2965933">.</span><span class="ident" id="2965934">Size</span><span class="op" id="2965938">(</span><span class="op" id="2965939">)</span><span class="op" id="2965940">,</span>&nbsp;<span class="builtintype" id="2965942">nil</span>&nbsp;<span class="op" id="2965946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2965949">serveContent</span><span class="op" id="2965961">(</span><span class="ident" id="2965962">w</span><span class="op" id="2965963">,</span>&nbsp;<span class="ident" id="2965965">r</span><span class="op" id="2965966">,</span>&nbsp;<span class="ident" id="2965968">d</span><span class="op" id="2965969">.</span><span class="ident" id="2965970">Name</span><span class="op" id="2965974">(</span><span class="op" id="2965975">)</span><span class="op" id="2965976">,</span>&nbsp;<span class="ident" id="2965978">d</span><span class="op" id="2965979">.</span><span class="ident" id="2965980">ModTime</span><span class="op" id="2965987">(</span><span class="op" id="2965988">)</span><span class="op" id="2965989">,</span>&nbsp;<span class="ident" id="2965991">sizeFunc</span><span class="op" id="2965999">,</span>&nbsp;<span class="ident" id="2966001">f</span><span class="op" id="2966002">)</span><br>
<span class="lineno"></span><span class="op" id="2966004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="2966007">//&nbsp;localRedirect&nbsp;gives&nbsp;a&nbsp;Moved&nbsp;Permanently&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="2966060">//&nbsp;It&nbsp;does&nbsp;not&nbsp;convert&nbsp;relative&nbsp;paths&nbsp;to&nbsp;absolute&nbsp;paths&nbsp;like&nbsp;Redirect&nbsp;does.</span><br>
<span class="lineno"></span><span class="keyword" id="2966136">func</span>&nbsp;<span class="ident" id="2966141">localRedirect</span><span class="op" id="2966154">(</span><span class="ident" id="2966155">w</span>&nbsp;<span class="ident" id="2966157">ResponseWriter</span><span class="op" id="2966171">,</span>&nbsp;<span class="ident" id="2966173">r</span>&nbsp;<span class="op" id="2966175">*</span><span class="ident" id="2966176">Request</span><span class="op" id="2966183">,</span>&nbsp;<span class="ident" id="2966185">newPath</span>&nbsp;<span class="builtintype" id="2966193">string</span><span class="op" id="2966199">)</span>&nbsp;<span class="op" id="2966201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2966204">if</span>&nbsp;<span class="ident" id="2966207">q</span>&nbsp;<span class="op" id="2966209">:=</span>&nbsp;<span class="ident" id="2966212">r</span><span class="op" id="2966213">.</span><span class="ident" id="2966214">URL</span><span class="op" id="2966217">.</span><span class="ident" id="2966218">RawQuery</span><span class="op" id="2966226">;</span>&nbsp;<span class="ident" id="2966228">q</span>&nbsp;<span class="op" id="2966230">!=</span>&nbsp;<span class="string" id="2966233">&#34;&#34;</span>&nbsp;<span class="op" id="2966236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2966240">newPath</span>&nbsp;<span class="op" id="2966248">+=</span>&nbsp;<span class="string" id="2966251">&#34;?&#34;</span>&nbsp;<span class="op" id="2966255">+</span>&nbsp;<span class="ident" id="2966257">q</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2966260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2966263">w</span><span class="op" id="2966264">.</span><span class="ident" id="2966265">Header</span><span class="op" id="2966271">(</span><span class="op" id="2966272">)</span><span class="op" id="2966273">.</span><span class="ident" id="2966274">Set</span><span class="op" id="2966277">(</span><span class="string" id="2966278">&#34;Location&#34;</span><span class="op" id="2966288">,</span>&nbsp;<span class="ident" id="2966290">newPath</span><span class="op" id="2966297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2966300">w</span><span class="op" id="2966301">.</span><span class="ident" id="2966302">WriteHeader</span><span class="op" id="2966313">(</span><span class="ident" id="2966314">StatusMovedPermanently</span><span class="op" id="2966336">)</span><br>
<span class="lineno"></span><span class="op" id="2966338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span><span class="comment" id="2966341">//&nbsp;ServeFile&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;named&nbsp;file&nbsp;or&nbsp;directory.</span><br>
<span class="lineno"></span><span class="keyword" id="2966427">func</span>&nbsp;<span class="ident" id="2966432">ServeFile</span><span class="op" id="2966441">(</span><span class="ident" id="2966442">w</span>&nbsp;<span class="ident" id="2966444">ResponseWriter</span><span class="op" id="2966458">,</span>&nbsp;<span class="ident" id="2966460">r</span>&nbsp;<span class="op" id="2966462">*</span><span class="ident" id="2966463">Request</span><span class="op" id="2966470">,</span>&nbsp;<span class="ident" id="2966472">name</span>&nbsp;<span class="builtintype" id="2966477">string</span><span class="op" id="2966483">)</span>&nbsp;<span class="op" id="2966485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2966488">dir</span><span class="op" id="2966491">,</span>&nbsp;<span class="ident" id="2966493">file</span>&nbsp;<span class="op" id="2966498">:=</span>&nbsp;<span class="ident" id="2966501">filepath</span><span class="op" id="2966509">.</span><span class="ident" id="2966510">Split</span><span class="op" id="2966515">(</span><span class="ident" id="2966516">name</span><span class="op" id="2966520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2966523">serveFile</span><span class="op" id="2966532">(</span><span class="ident" id="2966533">w</span><span class="op" id="2966534">,</span>&nbsp;<span class="ident" id="2966536">r</span><span class="op" id="2966537">,</span>&nbsp;<span class="ident" id="2966539">Dir</span><span class="op" id="2966542">(</span><span class="ident" id="2966543">dir</span><span class="op" id="2966546">)</span><span class="op" id="2966547">,</span>&nbsp;<span class="ident" id="2966549">file</span><span class="op" id="2966553">,</span>&nbsp;<span class="builtintype" id="2966555">false</span><span class="op" id="2966560">)</span><br>
<span class="lineno"></span><span class="op" id="2966562">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="2966565">type</span>&nbsp;<span class="ident" id="2966570">fileHandler</span>&nbsp;<span class="keyword" id="2966582">struct</span>&nbsp;<span class="op" id="2966589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2966592">root</span>&nbsp;<span class="ident" id="2966597">FileSystem</span><br>
<span class="lineno"></span><span class="op" id="2966608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="comment" id="2966611">//&nbsp;FileServer&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="2966669">//&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;file&nbsp;system&nbsp;rooted&nbsp;at&nbsp;root.</span><br>
<span class="lineno"></span><span class="comment" id="2966725">//</span><br>
<span class="lineno"></span><span class="comment" id="2966728">//&nbsp;To&nbsp;use&nbsp;the&nbsp;operating&nbsp;system&#39;s&nbsp;file&nbsp;system&nbsp;implementation,</span><br>
<span class="lineno"></span><span class="comment" id="2966789">//&nbsp;use&nbsp;http.Dir:</span><br>
<span class="lineno">440</span><span class="comment" id="2966806">//</span><br>
<span class="lineno"></span><span class="comment" id="2966809">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.Handle(&#34;/&#34;,&nbsp;http.FileServer(http.Dir(&#34;/tmp&#34;)))</span><br>
<span class="lineno"></span><span class="keyword" id="2966868">func</span>&nbsp;<span class="ident" id="2966873">FileServer</span><span class="op" id="2966883">(</span><span class="ident" id="2966884">root</span>&nbsp;<span class="ident" id="2966889">FileSystem</span><span class="op" id="2966899">)</span>&nbsp;<span class="ident" id="2966901">Handler</span>&nbsp;<span class="op" id="2966909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2966912">return</span>&nbsp;<span class="op" id="2966919">&amp;</span><span class="ident" id="2966920">fileHandler</span><span class="op" id="2966931">{</span><span class="ident" id="2966932">root</span><span class="op" id="2966936">}</span><br>
<span class="lineno"></span><span class="op" id="2966938">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span><span class="keyword" id="2966941">func</span>&nbsp;<span class="op" id="2966946">(</span><span class="ident" id="2966947">f</span>&nbsp;<span class="op" id="2966949">*</span><span class="ident" id="2966950">fileHandler</span><span class="op" id="2966961">)</span>&nbsp;<span class="ident" id="2966963">ServeHTTP</span><span class="op" id="2966972">(</span><span class="ident" id="2966973">w</span>&nbsp;<span class="ident" id="2966975">ResponseWriter</span><span class="op" id="2966989">,</span>&nbsp;<span class="ident" id="2966991">r</span>&nbsp;<span class="op" id="2966993">*</span><span class="ident" id="2966994">Request</span><span class="op" id="2967001">)</span>&nbsp;<span class="op" id="2967003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2967006">upath</span>&nbsp;<span class="op" id="2967012">:=</span>&nbsp;<span class="ident" id="2967015">r</span><span class="op" id="2967016">.</span><span class="ident" id="2967017">URL</span><span class="op" id="2967020">.</span><span class="ident" id="2967021">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2967027">if</span>&nbsp;<span class="op" id="2967030">!</span><span class="ident" id="2967031">strings</span><span class="op" id="2967038">.</span><span class="ident" id="2967039">HasPrefix</span><span class="op" id="2967048">(</span><span class="ident" id="2967049">upath</span><span class="op" id="2967054">,</span>&nbsp;<span class="string" id="2967056">&#34;/&#34;</span><span class="op" id="2967059">)</span>&nbsp;<span class="op" id="2967061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2967065">upath</span>&nbsp;<span class="op" id="2967071">=</span>&nbsp;<span class="string" id="2967073">&#34;/&#34;</span>&nbsp;<span class="op" id="2967077">+</span>&nbsp;<span class="ident" id="2967079">upath</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2967087">r</span><span class="op" id="2967088">.</span><span class="ident" id="2967089">URL</span><span class="op" id="2967092">.</span><span class="ident" id="2967093">Path</span>&nbsp;<span class="op" id="2967098">=</span>&nbsp;<span class="ident" id="2967100">upath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2967107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2967110">serveFile</span><span class="op" id="2967119">(</span><span class="ident" id="2967120">w</span><span class="op" id="2967121">,</span>&nbsp;<span class="ident" id="2967123">r</span><span class="op" id="2967124">,</span>&nbsp;<span class="ident" id="2967126">f</span><span class="op" id="2967127">.</span><span class="ident" id="2967128">root</span><span class="op" id="2967132">,</span>&nbsp;<span class="ident" id="2967134">path</span><span class="op" id="2967138">.</span><span class="ident" id="2967139">Clean</span><span class="op" id="2967144">(</span><span class="ident" id="2967145">upath</span><span class="op" id="2967150">)</span><span class="op" id="2967151">,</span>&nbsp;<span class="builtintype" id="2967153">true</span><span class="op" id="2967157">)</span><br>
<span class="lineno"></span><span class="op" id="2967159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="2967162">//&nbsp;httpRange&nbsp;specifies&nbsp;the&nbsp;byte&nbsp;range&nbsp;to&nbsp;be&nbsp;sent&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="2967226">type</span>&nbsp;<span class="ident" id="2967231">httpRange</span>&nbsp;<span class="keyword" id="2967241">struct</span>&nbsp;<span class="op" id="2967248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2967251">start</span><span class="op" id="2967256">,</span>&nbsp;<span class="ident" id="2967258">length</span>&nbsp;<span class="ident" id="2967265">int64</span><br>
<span class="lineno"></span><span class="op" id="2967271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="keyword" id="2967274">func</span>&nbsp;<span class="op" id="2967279">(</span><span class="ident" id="2967280">r</span>&nbsp;<span class="ident" id="2967282">httpRange</span><span class="op" id="2967291">)</span>&nbsp;<span class="ident" id="2967293">contentRange</span><span class="op" id="2967305">(</span><span class="ident" id="2967306">size</span>&nbsp;<span class="ident" id="2967311">int64</span><span class="op" id="2967316">)</span>&nbsp;<span class="builtintype" id="2967318">string</span>&nbsp;<span class="op" id="2967325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2967328">return</span>&nbsp;<span class="ident" id="2967335">fmt</span><span class="op" id="2967338">.</span><span class="ident" id="2967339">Sprintf</span><span class="op" id="2967346">(</span><span class="string" id="2967347">&#34;bytes&nbsp;%d-%d/%d&#34;</span><span class="op" id="2967363">,</span>&nbsp;<span class="ident" id="2967365">r</span><span class="op" id="2967366">.</span><span class="ident" id="2967367">start</span><span class="op" id="2967372">,</span>&nbsp;<span class="ident" id="2967374">r</span><span class="op" id="2967375">.</span><span class="ident" id="2967376">start</span><span class="op" id="2967381">+</span><span class="ident" id="2967382">r</span><span class="op" id="2967383">.</span><span class="ident" id="2967384">length</span><span class="op" id="2967390">-</span><span class="num" id="2967391">1</span><span class="op" id="2967392">,</span>&nbsp;<span class="ident" id="2967394">size</span><span class="op" id="2967398">)</span><br>
<span class="lineno"></span><span class="op" id="2967400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2967403">func</span>&nbsp;<span class="op" id="2967408">(</span><span class="ident" id="2967409">r</span>&nbsp;<span class="ident" id="2967411">httpRange</span><span class="op" id="2967420">)</span>&nbsp;<span class="ident" id="2967422">mimeHeader</span><span class="op" id="2967432">(</span><span class="ident" id="2967433">contentType</span>&nbsp;<span class="builtintype" id="2967445">string</span><span class="op" id="2967451">,</span>&nbsp;<span class="ident" id="2967453">size</span>&nbsp;<span class="ident" id="2967458">int64</span><span class="op" id="2967463">)</span>&nbsp;<span class="ident" id="2967465">textproto</span><span class="op" id="2967474">.</span><span class="ident" id="2967475">MIMEHeader</span>&nbsp;<span class="op" id="2967486">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2967489">return</span>&nbsp;<span class="ident" id="2967496">textproto</span><span class="op" id="2967505">.</span><span class="ident" id="2967506">MIMEHeader</span><span class="op" id="2967516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2967520">&#34;Content-Range&#34;</span><span class="op" id="2967535">:</span>&nbsp;<span class="op" id="2967537">{</span><span class="ident" id="2967538">r</span><span class="op" id="2967539">.</span><span class="ident" id="2967540">contentRange</span><span class="op" id="2967552">(</span><span class="ident" id="2967553">size</span><span class="op" id="2967557">)</span><span class="op" id="2967558">}</span><span class="op" id="2967559">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2967563">&#34;Content-Type&#34;</span><span class="op" id="2967577">:</span>&nbsp;&nbsp;<span class="op" id="2967580">{</span><span class="ident" id="2967581">contentType</span><span class="op" id="2967592">}</span><span class="op" id="2967593">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2967596">}</span><br>
<span class="lineno"></span><span class="op" id="2967598">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="comment" id="2967601">//&nbsp;parseRange&nbsp;parses&nbsp;a&nbsp;Range&nbsp;header&nbsp;string&nbsp;as&nbsp;per&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="keyword" id="2967661">func</span>&nbsp;<span class="ident" id="2967666">parseRange</span><span class="op" id="2967676">(</span><span class="ident" id="2967677">s</span>&nbsp;<span class="builtintype" id="2967679">string</span><span class="op" id="2967685">,</span>&nbsp;<span class="ident" id="2967687">size</span>&nbsp;<span class="ident" id="2967692">int64</span><span class="op" id="2967697">)</span>&nbsp;<span class="op" id="2967699">(</span><span class="op" id="2967700">[</span><span class="op" id="2967701">]</span><span class="ident" id="2967702">httpRange</span><span class="op" id="2967711">,</span>&nbsp;<span class="builtintype" id="2967713">error</span><span class="op" id="2967718">)</span>&nbsp;<span class="op" id="2967720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2967723">if</span>&nbsp;<span class="ident" id="2967726">s</span>&nbsp;<span class="op" id="2967728">==</span>&nbsp;<span class="string" id="2967731">&#34;&#34;</span>&nbsp;<span class="op" id="2967734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2967738">return</span>&nbsp;<span class="builtintype" id="2967745">nil</span><span class="op" id="2967748">,</span>&nbsp;<span class="builtintype" id="2967750">nil</span>&nbsp;<span class="comment" id="2967754">//&nbsp;header&nbsp;not&nbsp;present</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2967777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2967780">const</span>&nbsp;<span class="ident" id="2967786">b</span>&nbsp;<span class="op" id="2967788">=</span>&nbsp;<span class="string" id="2967790">&#34;bytes=&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2967800">if</span>&nbsp;<span class="op" id="2967803">!</span><span class="ident" id="2967804">strings</span><span class="op" id="2967811">.</span><span class="ident" id="2967812">HasPrefix</span><span class="op" id="2967821">(</span><span class="ident" id="2967822">s</span><span class="op" id="2967823">,</span>&nbsp;<span class="ident" id="2967825">b</span><span class="op" id="2967826">)</span>&nbsp;<span class="op" id="2967828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2967832">return</span>&nbsp;<span class="builtintype" id="2967839">nil</span><span class="op" id="2967842">,</span>&nbsp;<span class="ident" id="2967844">errors</span><span class="op" id="2967850">.</span><span class="ident" id="2967851">New</span><span class="op" id="2967854">(</span><span class="string" id="2967855">&#34;invalid&nbsp;range&#34;</span><span class="op" id="2967870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2967873">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2967876">var</span>&nbsp;<span class="ident" id="2967880">ranges</span>&nbsp;<span class="op" id="2967887">[</span><span class="op" id="2967888">]</span><span class="ident" id="2967889">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2967900">for</span>&nbsp;<span class="ident" id="2967904">_</span><span class="op" id="2967905">,</span>&nbsp;<span class="ident" id="2967907">ra</span>&nbsp;<span class="op" id="2967910">:=</span>&nbsp;<span class="keyword" id="2967913">range</span>&nbsp;<span class="ident" id="2967919">strings</span><span class="op" id="2967926">.</span><span class="ident" id="2967927">Split</span><span class="op" id="2967932">(</span><span class="ident" id="2967933">s</span><span class="op" id="2967934">[</span><span class="builtinfunc" id="2967935">len</span><span class="op" id="2967938">(</span><span class="ident" id="2967939">b</span><span class="op" id="2967940">)</span><span class="op" id="2967941">:</span><span class="op" id="2967942">]</span><span class="op" id="2967943">,</span>&nbsp;<span class="string" id="2967945">&#34;,&#34;</span><span class="op" id="2967948">)</span>&nbsp;<span class="op" id="2967950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2967954">ra</span>&nbsp;<span class="op" id="2967957">=</span>&nbsp;<span class="ident" id="2967959">strings</span><span class="op" id="2967966">.</span><span class="ident" id="2967967">TrimSpace</span><span class="op" id="2967976">(</span><span class="ident" id="2967977">ra</span><span class="op" id="2967979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2967983">if</span>&nbsp;<span class="ident" id="2967986">ra</span>&nbsp;<span class="op" id="2967989">==</span>&nbsp;<span class="string" id="2967992">&#34;&#34;</span>&nbsp;<span class="op" id="2967995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2968000">continue</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2968011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2968015">i</span>&nbsp;<span class="op" id="2968017">:=</span>&nbsp;<span class="ident" id="2968020">strings</span><span class="op" id="2968027">.</span><span class="ident" id="2968028">Index</span><span class="op" id="2968033">(</span><span class="ident" id="2968034">ra</span><span class="op" id="2968036">,</span>&nbsp;<span class="string" id="2968038">&#34;-&#34;</span><span class="op" id="2968041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2968045">if</span>&nbsp;<span class="ident" id="2968048">i</span>&nbsp;<span class="op" id="2968050">&lt;</span>&nbsp;<span class="num" id="2968052">0</span>&nbsp;<span class="op" id="2968054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2968059">return</span>&nbsp;<span class="builtintype" id="2968066">nil</span><span class="op" id="2968069">,</span>&nbsp;<span class="ident" id="2968071">errors</span><span class="op" id="2968077">.</span><span class="ident" id="2968078">New</span><span class="op" id="2968081">(</span><span class="string" id="2968082">&#34;invalid&nbsp;range&#34;</span><span class="op" id="2968097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2968101">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2968105">start</span><span class="op" id="2968110">,</span>&nbsp;<span class="ident" id="2968112">end</span>&nbsp;<span class="op" id="2968116">:=</span>&nbsp;<span class="ident" id="2968119">strings</span><span class="op" id="2968126">.</span><span class="ident" id="2968127">TrimSpace</span><span class="op" id="2968136">(</span><span class="ident" id="2968137">ra</span><span class="op" id="2968139">[</span><span class="op" id="2968140">:</span><span class="ident" id="2968141">i</span><span class="op" id="2968142">]</span><span class="op" id="2968143">)</span><span class="op" id="2968144">,</span>&nbsp;<span class="ident" id="2968146">strings</span><span class="op" id="2968153">.</span><span class="ident" id="2968154">TrimSpace</span><span class="op" id="2968163">(</span><span class="ident" id="2968164">ra</span><span class="op" id="2968166">[</span><span class="ident" id="2968167">i</span><span class="op" id="2968168">+</span><span class="num" id="2968169">1</span><span class="op" id="2968170">:</span><span class="op" id="2968171">]</span><span class="op" id="2968172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2968176">var</span>&nbsp;<span class="ident" id="2968180">r</span>&nbsp;<span class="ident" id="2968182">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2968194">if</span>&nbsp;<span class="ident" id="2968197">start</span>&nbsp;<span class="op" id="2968203">==</span>&nbsp;<span class="string" id="2968206">&#34;&#34;</span>&nbsp;<span class="op" id="2968209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2968214">//&nbsp;If&nbsp;no&nbsp;start&nbsp;is&nbsp;specified,&nbsp;end&nbsp;specifies&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2968264">//&nbsp;range&nbsp;start&nbsp;relative&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2968315">i</span><span class="op" id="2968316">,</span>&nbsp;<span class="ident" id="2968318">err</span>&nbsp;<span class="op" id="2968322">:=</span>&nbsp;<span class="ident" id="2968325">strconv</span><span class="op" id="2968332">.</span><span class="ident" id="2968333">ParseInt</span><span class="op" id="2968341">(</span><span class="ident" id="2968342">end</span><span class="op" id="2968345">,</span>&nbsp;<span class="num" id="2968347">10</span><span class="op" id="2968349">,</span>&nbsp;<span class="num" id="2968351">64</span><span class="op" id="2968353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2968358">if</span>&nbsp;<span class="ident" id="2968361">err</span>&nbsp;<span class="op" id="2968365">!=</span>&nbsp;<span class="builtintype" id="2968368">nil</span>&nbsp;<span class="op" id="2968372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2968378">return</span>&nbsp;<span class="builtintype" id="2968385">nil</span><span class="op" id="2968388">,</span>&nbsp;<span class="ident" id="2968390">errors</span><span class="op" id="2968396">.</span><span class="ident" id="2968397">New</span><span class="op" id="2968400">(</span><span class="string" id="2968401">&#34;invalid&nbsp;range&#34;</span><span class="op" id="2968416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2968421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2968426">if</span>&nbsp;<span class="ident" id="2968429">i</span>&nbsp;<span class="op" id="2968431">&gt;</span>&nbsp;<span class="ident" id="2968433">size</span>&nbsp;<span class="op" id="2968438">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2968444">i</span>&nbsp;<span class="op" id="2968446">=</span>&nbsp;<span class="ident" id="2968448">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2968456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2968461">r</span><span class="op" id="2968462">.</span><span class="ident" id="2968463">start</span>&nbsp;<span class="op" id="2968469">=</span>&nbsp;<span class="ident" id="2968471">size</span>&nbsp;<span class="op" id="2968476">-</span>&nbsp;<span class="ident" id="2968478">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2968483">r</span><span class="op" id="2968484">.</span><span class="ident" id="2968485">length</span>&nbsp;<span class="op" id="2968492">=</span>&nbsp;<span class="ident" id="2968494">size</span>&nbsp;<span class="op" id="2968499">-</span>&nbsp;<span class="ident" id="2968501">r</span><span class="op" id="2968502">.</span><span class="ident" id="2968503">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2968511">}</span>&nbsp;<span class="keyword" id="2968513">else</span>&nbsp;<span class="op" id="2968518">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2968523">i</span><span class="op" id="2968524">,</span>&nbsp;<span class="ident" id="2968526">err</span>&nbsp;<span class="op" id="2968530">:=</span>&nbsp;<span class="ident" id="2968533">strconv</span><span class="op" id="2968540">.</span><span class="ident" id="2968541">ParseInt</span><span class="op" id="2968549">(</span><span class="ident" id="2968550">start</span><span class="op" id="2968555">,</span>&nbsp;<span class="num" id="2968557">10</span><span class="op" id="2968559">,</span>&nbsp;<span class="num" id="2968561">64</span><span class="op" id="2968563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2968568">if</span>&nbsp;<span class="ident" id="2968571">err</span>&nbsp;<span class="op" id="2968575">!=</span>&nbsp;<span class="builtintype" id="2968578">nil</span>&nbsp;<span class="op" id="2968582">||</span>&nbsp;<span class="ident" id="2968585">i</span>&nbsp;<span class="op" id="2968587">&gt;</span>&nbsp;<span class="ident" id="2968589">size</span>&nbsp;<span class="op" id="2968594">||</span>&nbsp;<span class="ident" id="2968597">i</span>&nbsp;<span class="op" id="2968599">&lt;</span>&nbsp;<span class="num" id="2968601">0</span>&nbsp;<span class="op" id="2968603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2968609">return</span>&nbsp;<span class="builtintype" id="2968616">nil</span><span class="op" id="2968619">,</span>&nbsp;<span class="ident" id="2968621">errors</span><span class="op" id="2968627">.</span><span class="ident" id="2968628">New</span><span class="op" id="2968631">(</span><span class="string" id="2968632">&#34;invalid&nbsp;range&#34;</span><span class="op" id="2968647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2968652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2968657">r</span><span class="op" id="2968658">.</span><span class="ident" id="2968659">start</span>&nbsp;<span class="op" id="2968665">=</span>&nbsp;<span class="ident" id="2968667">i</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2968672">if</span>&nbsp;<span class="ident" id="2968675">end</span>&nbsp;<span class="op" id="2968679">==</span>&nbsp;<span class="string" id="2968682">&#34;&#34;</span>&nbsp;<span class="op" id="2968685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2968691">//&nbsp;If&nbsp;no&nbsp;end&nbsp;is&nbsp;specified,&nbsp;range&nbsp;extends&nbsp;to&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2968756">r</span><span class="op" id="2968757">.</span><span class="ident" id="2968758">length</span>&nbsp;<span class="op" id="2968765">=</span>&nbsp;<span class="ident" id="2968767">size</span>&nbsp;<span class="op" id="2968772">-</span>&nbsp;<span class="ident" id="2968774">r</span><span class="op" id="2968775">.</span><span class="ident" id="2968776">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2968785">}</span>&nbsp;<span class="keyword" id="2968787">else</span>&nbsp;<span class="op" id="2968792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2968798">i</span><span class="op" id="2968799">,</span>&nbsp;<span class="ident" id="2968801">err</span>&nbsp;<span class="op" id="2968805">:=</span>&nbsp;<span class="ident" id="2968808">strconv</span><span class="op" id="2968815">.</span><span class="ident" id="2968816">ParseInt</span><span class="op" id="2968824">(</span><span class="ident" id="2968825">end</span><span class="op" id="2968828">,</span>&nbsp;<span class="num" id="2968830">10</span><span class="op" id="2968832">,</span>&nbsp;<span class="num" id="2968834">64</span><span class="op" id="2968836">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2968842">if</span>&nbsp;<span class="ident" id="2968845">err</span>&nbsp;<span class="op" id="2968849">!=</span>&nbsp;<span class="builtintype" id="2968852">nil</span>&nbsp;<span class="op" id="2968856">||</span>&nbsp;<span class="ident" id="2968859">r</span><span class="op" id="2968860">.</span><span class="ident" id="2968861">start</span>&nbsp;<span class="op" id="2968867">&gt;</span>&nbsp;<span class="ident" id="2968869">i</span>&nbsp;<span class="op" id="2968871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2968878">return</span>&nbsp;<span class="builtintype" id="2968885">nil</span><span class="op" id="2968888">,</span>&nbsp;<span class="ident" id="2968890">errors</span><span class="op" id="2968896">.</span><span class="ident" id="2968897">New</span><span class="op" id="2968900">(</span><span class="string" id="2968901">&#34;invalid&nbsp;range&#34;</span><span class="op" id="2968916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2968922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2968928">if</span>&nbsp;<span class="ident" id="2968931">i</span>&nbsp;<span class="op" id="2968933">&gt;=</span>&nbsp;<span class="ident" id="2968936">size</span>&nbsp;<span class="op" id="2968941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2968948">i</span>&nbsp;<span class="op" id="2968950">=</span>&nbsp;<span class="ident" id="2968952">size</span>&nbsp;<span class="op" id="2968957">-</span>&nbsp;<span class="num" id="2968959">1</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2968965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2968971">r</span><span class="op" id="2968972">.</span><span class="ident" id="2968973">length</span>&nbsp;<span class="op" id="2968980">=</span>&nbsp;<span class="ident" id="2968982">i</span>&nbsp;<span class="op" id="2968984">-</span>&nbsp;<span class="ident" id="2968986">r</span><span class="op" id="2968987">.</span><span class="ident" id="2968988">start</span>&nbsp;<span class="op" id="2968994">+</span>&nbsp;<span class="num" id="2968996">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2969001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2969005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2969009">ranges</span>&nbsp;<span class="op" id="2969016">=</span>&nbsp;<span class="builtinfunc" id="2969018">append</span><span class="op" id="2969024">(</span><span class="ident" id="2969025">ranges</span><span class="op" id="2969031">,</span>&nbsp;<span class="ident" id="2969033">r</span><span class="op" id="2969034">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2969037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2969040">return</span>&nbsp;<span class="ident" id="2969047">ranges</span><span class="op" id="2969053">,</span>&nbsp;<span class="builtintype" id="2969055">nil</span><br>
<span class="lineno"></span><span class="op" id="2969059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2969062">//&nbsp;countingWriter&nbsp;counts&nbsp;how&nbsp;many&nbsp;bytes&nbsp;have&nbsp;been&nbsp;written&nbsp;to&nbsp;it.</span><br>
<span class="lineno">530</span><span class="keyword" id="2969127">type</span>&nbsp;<span class="ident" id="2969132">countingWriter</span>&nbsp;<span class="ident" id="2969147">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2969154">func</span>&nbsp;<span class="op" id="2969159">(</span><span class="ident" id="2969160">w</span>&nbsp;<span class="op" id="2969162">*</span><span class="ident" id="2969163">countingWriter</span><span class="op" id="2969177">)</span>&nbsp;<span class="ident" id="2969179">Write</span><span class="op" id="2969184">(</span><span class="ident" id="2969185">p</span>&nbsp;<span class="op" id="2969187">[</span><span class="op" id="2969188">]</span><span class="builtintype" id="2969189">byte</span><span class="op" id="2969193">)</span>&nbsp;<span class="op" id="2969195">(</span><span class="ident" id="2969196">n</span>&nbsp;<span class="builtintype" id="2969198">int</span><span class="op" id="2969201">,</span>&nbsp;<span class="ident" id="2969203">err</span>&nbsp;<span class="builtintype" id="2969207">error</span><span class="op" id="2969212">)</span>&nbsp;<span class="op" id="2969214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2969217">*</span><span class="ident" id="2969218">w</span>&nbsp;<span class="op" id="2969220">+=</span>&nbsp;<span class="ident" id="2969223">countingWriter</span><span class="op" id="2969237">(</span><span class="builtinfunc" id="2969238">len</span><span class="op" id="2969241">(</span><span class="ident" id="2969242">p</span><span class="op" id="2969243">)</span><span class="op" id="2969244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2969247">return</span>&nbsp;<span class="builtinfunc" id="2969254">len</span><span class="op" id="2969257">(</span><span class="ident" id="2969258">p</span><span class="op" id="2969259">)</span><span class="op" id="2969260">,</span>&nbsp;<span class="builtintype" id="2969262">nil</span><br>
<span class="lineno">535</span><span class="op" id="2969266">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2969269">//&nbsp;rangesMIMESize&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;it&nbsp;takes&nbsp;to&nbsp;encode&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2969338">//&nbsp;provided&nbsp;ranges&nbsp;as&nbsp;a&nbsp;multipart&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="2969382">func</span>&nbsp;<span class="ident" id="2969387">rangesMIMESize</span><span class="op" id="2969401">(</span><span class="ident" id="2969402">ranges</span>&nbsp;<span class="op" id="2969409">[</span><span class="op" id="2969410">]</span><span class="ident" id="2969411">httpRange</span><span class="op" id="2969420">,</span>&nbsp;<span class="ident" id="2969422">contentType</span>&nbsp;<span class="builtintype" id="2969434">string</span><span class="op" id="2969440">,</span>&nbsp;<span class="ident" id="2969442">contentSize</span>&nbsp;<span class="ident" id="2969454">int64</span><span class="op" id="2969459">)</span>&nbsp;<span class="op" id="2969461">(</span><span class="ident" id="2969462">encSize</span>&nbsp;<span class="ident" id="2969470">int64</span><span class="op" id="2969475">)</span>&nbsp;<span class="op" id="2969477">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2969480">var</span>&nbsp;<span class="ident" id="2969484">w</span>&nbsp;<span class="ident" id="2969486">countingWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2969502">mw</span>&nbsp;<span class="op" id="2969505">:=</span>&nbsp;<span class="ident" id="2969508">multipart</span><span class="op" id="2969517">.</span><span class="ident" id="2969518">NewWriter</span><span class="op" id="2969527">(</span><span class="op" id="2969528">&amp;</span><span class="ident" id="2969529">w</span><span class="op" id="2969530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2969533">for</span>&nbsp;<span class="ident" id="2969537">_</span><span class="op" id="2969538">,</span>&nbsp;<span class="ident" id="2969540">ra</span>&nbsp;<span class="op" id="2969543">:=</span>&nbsp;<span class="keyword" id="2969546">range</span>&nbsp;<span class="ident" id="2969552">ranges</span>&nbsp;<span class="op" id="2969559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2969563">mw</span><span class="op" id="2969565">.</span><span class="ident" id="2969566">CreatePart</span><span class="op" id="2969576">(</span><span class="ident" id="2969577">ra</span><span class="op" id="2969579">.</span><span class="ident" id="2969580">mimeHeader</span><span class="op" id="2969590">(</span><span class="ident" id="2969591">contentType</span><span class="op" id="2969602">,</span>&nbsp;<span class="ident" id="2969604">contentSize</span><span class="op" id="2969615">)</span><span class="op" id="2969616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2969620">encSize</span>&nbsp;<span class="op" id="2969628">+=</span>&nbsp;<span class="ident" id="2969631">ra</span><span class="op" id="2969633">.</span><span class="ident" id="2969634">length</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2969642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2969645">mw</span><span class="op" id="2969647">.</span><span class="ident" id="2969648">Close</span><span class="op" id="2969653">(</span><span class="op" id="2969654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2969657">encSize</span>&nbsp;<span class="op" id="2969665">+=</span>&nbsp;<span class="ident" id="2969668">int64</span><span class="op" id="2969673">(</span><span class="ident" id="2969674">w</span><span class="op" id="2969675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2969678">return</span><br>
<span class="lineno"></span><span class="op" id="2969685">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="2969688">func</span>&nbsp;<span class="ident" id="2969693">sumRangesSize</span><span class="op" id="2969706">(</span><span class="ident" id="2969707">ranges</span>&nbsp;<span class="op" id="2969714">[</span><span class="op" id="2969715">]</span><span class="ident" id="2969716">httpRange</span><span class="op" id="2969725">)</span>&nbsp;<span class="op" id="2969727">(</span><span class="ident" id="2969728">size</span>&nbsp;<span class="ident" id="2969733">int64</span><span class="op" id="2969738">)</span>&nbsp;<span class="op" id="2969740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2969743">for</span>&nbsp;<span class="ident" id="2969747">_</span><span class="op" id="2969748">,</span>&nbsp;<span class="ident" id="2969750">ra</span>&nbsp;<span class="op" id="2969753">:=</span>&nbsp;<span class="keyword" id="2969756">range</span>&nbsp;<span class="ident" id="2969762">ranges</span>&nbsp;<span class="op" id="2969769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2969773">size</span>&nbsp;<span class="op" id="2969778">+=</span>&nbsp;<span class="ident" id="2969781">ra</span><span class="op" id="2969783">.</span><span class="ident" id="2969784">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2969792">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2969795">return</span><br>
<span class="lineno"></span><span class="op" id="2969802">}</span>
</div>
</body>
</html>
