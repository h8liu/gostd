<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rsa</h2>
<ul>
<li><a href="/gostd/crypto/rsa/pkcs1v15.go.html" class="current">pkcs1v15.go</a></li>
<li><a href="/gostd/crypto/rsa/pkcs1v15_test.go.html">pkcs1v15_test.go</a></li>
<li><a href="/gostd/crypto/rsa/pss.go.html">pss.go</a></li>
<li><a href="/gostd/crypto/rsa/pss_test.go.html">pss_test.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa.go.html">rsa.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa_test.go.html">rsa_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4013033">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4013088">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4013142">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4013193">package</span>&nbsp;<span class="ident" id="4013201">rsa</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4013206">import</span>&nbsp;<span class="op" id="4013213">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4013216">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4013226">&#34;crypto/subtle&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4013243">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4013253">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4013259">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="4013270">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="4013273">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;encryption&nbsp;and&nbsp;decryption&nbsp;using&nbsp;PKCS#1&nbsp;v1.5&nbsp;padding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4013351">//&nbsp;EncryptPKCS1v15&nbsp;encrypts&nbsp;the&nbsp;given&nbsp;message&nbsp;with&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4013447">//&nbsp;The&nbsp;message&nbsp;must&nbsp;be&nbsp;no&nbsp;longer&nbsp;than&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;public&nbsp;modulus&nbsp;minus&nbsp;11&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="4013534">//&nbsp;WARNING:&nbsp;use&nbsp;of&nbsp;this&nbsp;function&nbsp;to&nbsp;encrypt&nbsp;plaintexts&nbsp;other&nbsp;than&nbsp;session&nbsp;keys</span><br>
<span class="lineno">20</span><span class="comment" id="4013613">//&nbsp;is&nbsp;dangerous.&nbsp;Use&nbsp;RSA&nbsp;OAEP&nbsp;in&nbsp;new&nbsp;protocols.</span><br>
<span class="lineno"></span><span class="keyword" id="4013661">func</span>&nbsp;<span class="ident" id="4013666">EncryptPKCS1v15</span><span class="op" id="4013681">(</span><span class="ident" id="4013682">rand</span>&nbsp;<span class="ident" id="4013687">io</span><span class="op" id="4013689">.</span><span class="ident" id="4013690">Reader</span><span class="op" id="4013696">,</span>&nbsp;<span class="ident" id="4013698">pub</span>&nbsp;<span class="op" id="4013702">*</span><span class="ident" id="4013703">PublicKey</span><span class="op" id="4013712">,</span>&nbsp;<span class="ident" id="4013714">msg</span>&nbsp;<span class="op" id="4013718">[</span><span class="op" id="4013719">]</span><span class="builtintype" id="4013720">byte</span><span class="op" id="4013724">)</span>&nbsp;<span class="op" id="4013726">(</span><span class="ident" id="4013727">out</span>&nbsp;<span class="op" id="4013731">[</span><span class="op" id="4013732">]</span><span class="builtintype" id="4013733">byte</span><span class="op" id="4013737">,</span>&nbsp;<span class="ident" id="4013739">err</span>&nbsp;<span class="builtintype" id="4013743">error</span><span class="op" id="4013748">)</span>&nbsp;<span class="op" id="4013750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4013753">if</span>&nbsp;<span class="ident" id="4013756">err</span>&nbsp;<span class="op" id="4013760">:=</span>&nbsp;<span class="ident" id="4013763">checkPub</span><span class="op" id="4013771">(</span><span class="ident" id="4013772">pub</span><span class="op" id="4013775">)</span><span class="op" id="4013776">;</span>&nbsp;<span class="ident" id="4013778">err</span>&nbsp;<span class="op" id="4013782">!=</span>&nbsp;<span class="builtintype" id="4013785">nil</span>&nbsp;<span class="op" id="4013789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4013793">return</span>&nbsp;<span class="builtintype" id="4013800">nil</span><span class="op" id="4013803">,</span>&nbsp;<span class="ident" id="4013805">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4013810">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4013813">k</span>&nbsp;<span class="op" id="4013815">:=</span>&nbsp;<span class="op" id="4013818">(</span><span class="ident" id="4013819">pub</span><span class="op" id="4013822">.</span><span class="ident" id="4013823">N</span><span class="op" id="4013824">.</span><span class="ident" id="4013825">BitLen</span><span class="op" id="4013831">(</span><span class="op" id="4013832">)</span>&nbsp;<span class="op" id="4013834">+</span>&nbsp;<span class="num" id="4013836">7</span><span class="op" id="4013837">)</span>&nbsp;<span class="op" id="4013839">/</span>&nbsp;<span class="num" id="4013841">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4013844">if</span>&nbsp;<span class="builtinfunc" id="4013847">len</span><span class="op" id="4013850">(</span><span class="ident" id="4013851">msg</span><span class="op" id="4013854">)</span>&nbsp;<span class="op" id="4013856">&gt;</span>&nbsp;<span class="ident" id="4013858">k</span><span class="op" id="4013859">-</span><span class="num" id="4013860">11</span>&nbsp;<span class="op" id="4013863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4013867">err</span>&nbsp;<span class="op" id="4013871">=</span>&nbsp;<span class="ident" id="4013873">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4013893">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4013901">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4013905">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x02&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;M</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4013946">em</span>&nbsp;<span class="op" id="4013949">:=</span>&nbsp;<span class="builtinfunc" id="4013952">make</span><span class="op" id="4013956">(</span><span class="op" id="4013957">[</span><span class="op" id="4013958">]</span><span class="builtintype" id="4013959">byte</span><span class="op" id="4013963">,</span>&nbsp;<span class="ident" id="4013965">k</span><span class="op" id="4013966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4013969">em</span><span class="op" id="4013971">[</span><span class="num" id="4013972">1</span><span class="op" id="4013973">]</span>&nbsp;<span class="op" id="4013975">=</span>&nbsp;<span class="num" id="4013977">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4013980">ps</span><span class="op" id="4013982">,</span>&nbsp;<span class="ident" id="4013984">mm</span>&nbsp;<span class="op" id="4013987">:=</span>&nbsp;<span class="ident" id="4013990">em</span><span class="op" id="4013992">[</span><span class="num" id="4013993">2</span><span class="op" id="4013994">:</span><span class="builtinfunc" id="4013995">len</span><span class="op" id="4013998">(</span><span class="ident" id="4013999">em</span><span class="op" id="4014001">)</span><span class="op" id="4014002">-</span><span class="builtinfunc" id="4014003">len</span><span class="op" id="4014006">(</span><span class="ident" id="4014007">msg</span><span class="op" id="4014010">)</span><span class="op" id="4014011">-</span><span class="num" id="4014012">1</span><span class="op" id="4014013">]</span><span class="op" id="4014014">,</span>&nbsp;<span class="ident" id="4014016">em</span><span class="op" id="4014018">[</span><span class="builtinfunc" id="4014019">len</span><span class="op" id="4014022">(</span><span class="ident" id="4014023">em</span><span class="op" id="4014025">)</span><span class="op" id="4014026">-</span><span class="builtinfunc" id="4014027">len</span><span class="op" id="4014030">(</span><span class="ident" id="4014031">msg</span><span class="op" id="4014034">)</span><span class="op" id="4014035">:</span><span class="op" id="4014036">]</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4014039">err</span>&nbsp;<span class="op" id="4014043">=</span>&nbsp;<span class="ident" id="4014045">nonZeroRandomBytes</span><span class="op" id="4014063">(</span><span class="ident" id="4014064">ps</span><span class="op" id="4014066">,</span>&nbsp;<span class="ident" id="4014068">rand</span><span class="op" id="4014072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4014075">if</span>&nbsp;<span class="ident" id="4014078">err</span>&nbsp;<span class="op" id="4014082">!=</span>&nbsp;<span class="builtintype" id="4014085">nil</span>&nbsp;<span class="op" id="4014089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4014093">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4014101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4014104">em</span><span class="op" id="4014106">[</span><span class="builtinfunc" id="4014107">len</span><span class="op" id="4014110">(</span><span class="ident" id="4014111">em</span><span class="op" id="4014113">)</span><span class="op" id="4014114">-</span><span class="builtinfunc" id="4014115">len</span><span class="op" id="4014118">(</span><span class="ident" id="4014119">msg</span><span class="op" id="4014122">)</span><span class="op" id="4014123">-</span><span class="num" id="4014124">1</span><span class="op" id="4014125">]</span>&nbsp;<span class="op" id="4014127">=</span>&nbsp;<span class="num" id="4014129">0</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4014132">copy</span><span class="op" id="4014136">(</span><span class="ident" id="4014137">mm</span><span class="op" id="4014139">,</span>&nbsp;<span class="ident" id="4014141">msg</span><span class="op" id="4014144">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4014148">m</span>&nbsp;<span class="op" id="4014150">:=</span>&nbsp;<span class="builtinfunc" id="4014153">new</span><span class="op" id="4014156">(</span><span class="ident" id="4014157">big</span><span class="op" id="4014160">.</span><span class="ident" id="4014161">Int</span><span class="op" id="4014164">)</span><span class="op" id="4014165">.</span><span class="ident" id="4014166">SetBytes</span><span class="op" id="4014174">(</span><span class="ident" id="4014175">em</span><span class="op" id="4014177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4014180">c</span>&nbsp;<span class="op" id="4014182">:=</span>&nbsp;<span class="ident" id="4014185">encrypt</span><span class="op" id="4014192">(</span><span class="builtinfunc" id="4014193">new</span><span class="op" id="4014196">(</span><span class="ident" id="4014197">big</span><span class="op" id="4014200">.</span><span class="ident" id="4014201">Int</span><span class="op" id="4014204">)</span><span class="op" id="4014205">,</span>&nbsp;<span class="ident" id="4014207">pub</span><span class="op" id="4014210">,</span>&nbsp;<span class="ident" id="4014212">m</span><span class="op" id="4014213">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4014217">copyWithLeftPad</span><span class="op" id="4014232">(</span><span class="ident" id="4014233">em</span><span class="op" id="4014235">,</span>&nbsp;<span class="ident" id="4014237">c</span><span class="op" id="4014238">.</span><span class="ident" id="4014239">Bytes</span><span class="op" id="4014244">(</span><span class="op" id="4014245">)</span><span class="op" id="4014246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4014249">out</span>&nbsp;<span class="op" id="4014253">=</span>&nbsp;<span class="ident" id="4014255">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4014259">return</span><br>
<span class="lineno"></span><span class="op" id="4014266">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4014269">//&nbsp;DecryptPKCS1v15&nbsp;decrypts&nbsp;a&nbsp;plaintext&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4014360">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="keyword" id="4014438">func</span>&nbsp;<span class="ident" id="4014443">DecryptPKCS1v15</span><span class="op" id="4014458">(</span><span class="ident" id="4014459">rand</span>&nbsp;<span class="ident" id="4014464">io</span><span class="op" id="4014466">.</span><span class="ident" id="4014467">Reader</span><span class="op" id="4014473">,</span>&nbsp;<span class="ident" id="4014475">priv</span>&nbsp;<span class="op" id="4014480">*</span><span class="ident" id="4014481">PrivateKey</span><span class="op" id="4014491">,</span>&nbsp;<span class="ident" id="4014493">ciphertext</span>&nbsp;<span class="op" id="4014504">[</span><span class="op" id="4014505">]</span><span class="builtintype" id="4014506">byte</span><span class="op" id="4014510">)</span>&nbsp;<span class="op" id="4014512">(</span><span class="ident" id="4014513">out</span>&nbsp;<span class="op" id="4014517">[</span><span class="op" id="4014518">]</span><span class="builtintype" id="4014519">byte</span><span class="op" id="4014523">,</span>&nbsp;<span class="ident" id="4014525">err</span>&nbsp;<span class="builtintype" id="4014529">error</span><span class="op" id="4014534">)</span>&nbsp;<span class="op" id="4014536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4014539">if</span>&nbsp;<span class="ident" id="4014542">err</span>&nbsp;<span class="op" id="4014546">:=</span>&nbsp;<span class="ident" id="4014549">checkPub</span><span class="op" id="4014557">(</span><span class="op" id="4014558">&amp;</span><span class="ident" id="4014559">priv</span><span class="op" id="4014563">.</span><span class="ident" id="4014564">PublicKey</span><span class="op" id="4014573">)</span><span class="op" id="4014574">;</span>&nbsp;<span class="ident" id="4014576">err</span>&nbsp;<span class="op" id="4014580">!=</span>&nbsp;<span class="builtintype" id="4014583">nil</span>&nbsp;<span class="op" id="4014587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4014591">return</span>&nbsp;<span class="builtintype" id="4014598">nil</span><span class="op" id="4014601">,</span>&nbsp;<span class="ident" id="4014603">err</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4014608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4014611">valid</span><span class="op" id="4014616">,</span>&nbsp;<span class="ident" id="4014618">out</span><span class="op" id="4014621">,</span>&nbsp;<span class="ident" id="4014623">index</span><span class="op" id="4014628">,</span>&nbsp;<span class="ident" id="4014630">err</span>&nbsp;<span class="op" id="4014634">:=</span>&nbsp;<span class="ident" id="4014637">decryptPKCS1v15</span><span class="op" id="4014652">(</span><span class="ident" id="4014653">rand</span><span class="op" id="4014657">,</span>&nbsp;<span class="ident" id="4014659">priv</span><span class="op" id="4014663">,</span>&nbsp;<span class="ident" id="4014665">ciphertext</span><span class="op" id="4014675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4014678">if</span>&nbsp;<span class="ident" id="4014681">err</span>&nbsp;<span class="op" id="4014685">!=</span>&nbsp;<span class="builtintype" id="4014688">nil</span>&nbsp;<span class="op" id="4014692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4014696">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4014704">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4014707">if</span>&nbsp;<span class="ident" id="4014710">valid</span>&nbsp;<span class="op" id="4014716">==</span>&nbsp;<span class="num" id="4014719">0</span>&nbsp;<span class="op" id="4014721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4014725">return</span>&nbsp;<span class="builtintype" id="4014732">nil</span><span class="op" id="4014735">,</span>&nbsp;<span class="ident" id="4014737">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4014752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4014755">out</span>&nbsp;<span class="op" id="4014759">=</span>&nbsp;<span class="ident" id="4014761">out</span><span class="op" id="4014764">[</span><span class="ident" id="4014765">index</span><span class="op" id="4014770">:</span><span class="op" id="4014771">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4014774">return</span><br>
<span class="lineno">65</span><span class="op" id="4014781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4014784">//&nbsp;DecryptPKCS1v15SessionKey&nbsp;decrypts&nbsp;a&nbsp;session&nbsp;key&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4014887">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="comment" id="4014965">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;ciphertext&nbsp;is&nbsp;the&nbsp;wrong&nbsp;length&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="4015036">//&nbsp;ciphertext&nbsp;is&nbsp;greater&nbsp;than&nbsp;the&nbsp;public&nbsp;modulus.&nbsp;Otherwise,&nbsp;no&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4015109">//&nbsp;returned.&nbsp;If&nbsp;the&nbsp;padding&nbsp;is&nbsp;valid,&nbsp;the&nbsp;resulting&nbsp;plaintext&nbsp;message&nbsp;is&nbsp;copied</span><br>
<span class="lineno"></span><span class="comment" id="4015189">//&nbsp;into&nbsp;key.&nbsp;Otherwise,&nbsp;key&nbsp;is&nbsp;unchanged.&nbsp;These&nbsp;alternatives&nbsp;occur&nbsp;in&nbsp;constant</span><br>
<span class="lineno"></span><span class="comment" id="4015268">//&nbsp;time.&nbsp;It&nbsp;is&nbsp;intended&nbsp;that&nbsp;the&nbsp;user&nbsp;of&nbsp;this&nbsp;function&nbsp;generate&nbsp;a&nbsp;random</span><br>
<span class="lineno"></span><span class="comment" id="4015341">//&nbsp;session&nbsp;key&nbsp;beforehand&nbsp;and&nbsp;continue&nbsp;the&nbsp;protocol&nbsp;with&nbsp;the&nbsp;resulting&nbsp;value.</span><br>
<span class="lineno">75</span><span class="comment" id="4015419">//&nbsp;This&nbsp;will&nbsp;remove&nbsp;any&nbsp;possibility&nbsp;that&nbsp;an&nbsp;attacker&nbsp;can&nbsp;learn&nbsp;any&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="4015498">//&nbsp;about&nbsp;the&nbsp;plaintext.</span><br>
<span class="lineno"></span><span class="comment" id="4015522">//&nbsp;See&nbsp;``Chosen&nbsp;Ciphertext&nbsp;Attacks&nbsp;Against&nbsp;Protocols&nbsp;Based&nbsp;on&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span><span class="comment" id="4015592">//&nbsp;Encryption&nbsp;Standard&nbsp;PKCS&nbsp;#1&#39;&#39;,&nbsp;Daniel&nbsp;Bleichenbacher,&nbsp;Advances&nbsp;in&nbsp;Cryptology</span><br>
<span class="lineno"></span><span class="comment" id="4015672">//&nbsp;(Crypto&nbsp;&#39;98).</span><br>
<span class="lineno">80</span><span class="keyword" id="4015689">func</span>&nbsp;<span class="ident" id="4015694">DecryptPKCS1v15SessionKey</span><span class="op" id="4015719">(</span><span class="ident" id="4015720">rand</span>&nbsp;<span class="ident" id="4015725">io</span><span class="op" id="4015727">.</span><span class="ident" id="4015728">Reader</span><span class="op" id="4015734">,</span>&nbsp;<span class="ident" id="4015736">priv</span>&nbsp;<span class="op" id="4015741">*</span><span class="ident" id="4015742">PrivateKey</span><span class="op" id="4015752">,</span>&nbsp;<span class="ident" id="4015754">ciphertext</span>&nbsp;<span class="op" id="4015765">[</span><span class="op" id="4015766">]</span><span class="builtintype" id="4015767">byte</span><span class="op" id="4015771">,</span>&nbsp;<span class="ident" id="4015773">key</span>&nbsp;<span class="op" id="4015777">[</span><span class="op" id="4015778">]</span><span class="builtintype" id="4015779">byte</span><span class="op" id="4015783">)</span>&nbsp;<span class="op" id="4015785">(</span><span class="ident" id="4015786">err</span>&nbsp;<span class="builtintype" id="4015790">error</span><span class="op" id="4015795">)</span>&nbsp;<span class="op" id="4015797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4015800">if</span>&nbsp;<span class="ident" id="4015803">err</span>&nbsp;<span class="op" id="4015807">:=</span>&nbsp;<span class="ident" id="4015810">checkPub</span><span class="op" id="4015818">(</span><span class="op" id="4015819">&amp;</span><span class="ident" id="4015820">priv</span><span class="op" id="4015824">.</span><span class="ident" id="4015825">PublicKey</span><span class="op" id="4015834">)</span><span class="op" id="4015835">;</span>&nbsp;<span class="ident" id="4015837">err</span>&nbsp;<span class="op" id="4015841">!=</span>&nbsp;<span class="builtintype" id="4015844">nil</span>&nbsp;<span class="op" id="4015848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4015852">return</span>&nbsp;<span class="ident" id="4015859">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4015864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4015867">k</span>&nbsp;<span class="op" id="4015869">:=</span>&nbsp;<span class="op" id="4015872">(</span><span class="ident" id="4015873">priv</span><span class="op" id="4015877">.</span><span class="ident" id="4015878">N</span><span class="op" id="4015879">.</span><span class="ident" id="4015880">BitLen</span><span class="op" id="4015886">(</span><span class="op" id="4015887">)</span>&nbsp;<span class="op" id="4015889">+</span>&nbsp;<span class="num" id="4015891">7</span><span class="op" id="4015892">)</span>&nbsp;<span class="op" id="4015894">/</span>&nbsp;<span class="num" id="4015896">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4015899">if</span>&nbsp;<span class="ident" id="4015902">k</span><span class="op" id="4015903">-</span><span class="op" id="4015904">(</span><span class="builtinfunc" id="4015905">len</span><span class="op" id="4015908">(</span><span class="ident" id="4015909">key</span><span class="op" id="4015912">)</span><span class="op" id="4015913">+</span><span class="num" id="4015914">3</span><span class="op" id="4015915">+</span><span class="num" id="4015916">8</span><span class="op" id="4015917">)</span>&nbsp;<span class="op" id="4015919">&lt;</span>&nbsp;<span class="num" id="4015921">0</span>&nbsp;<span class="op" id="4015923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4015927">return</span>&nbsp;<span class="ident" id="4015934">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4015949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4015953">valid</span><span class="op" id="4015958">,</span>&nbsp;<span class="ident" id="4015960">em</span><span class="op" id="4015962">,</span>&nbsp;<span class="ident" id="4015964">index</span><span class="op" id="4015969">,</span>&nbsp;<span class="ident" id="4015971">err</span>&nbsp;<span class="op" id="4015975">:=</span>&nbsp;<span class="ident" id="4015978">decryptPKCS1v15</span><span class="op" id="4015993">(</span><span class="ident" id="4015994">rand</span><span class="op" id="4015998">,</span>&nbsp;<span class="ident" id="4016000">priv</span><span class="op" id="4016004">,</span>&nbsp;<span class="ident" id="4016006">ciphertext</span><span class="op" id="4016016">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4016019">if</span>&nbsp;<span class="ident" id="4016022">err</span>&nbsp;<span class="op" id="4016026">!=</span>&nbsp;<span class="builtintype" id="4016029">nil</span>&nbsp;<span class="op" id="4016033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4016037">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4016045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4016049">if</span>&nbsp;<span class="builtinfunc" id="4016052">len</span><span class="op" id="4016055">(</span><span class="ident" id="4016056">em</span><span class="op" id="4016058">)</span>&nbsp;<span class="op" id="4016060">!=</span>&nbsp;<span class="ident" id="4016063">k</span>&nbsp;<span class="op" id="4016065">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4016069">//&nbsp;This&nbsp;should&nbsp;be&nbsp;impossible&nbsp;because&nbsp;decryptPKCS1v15&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4016131">//&nbsp;returns&nbsp;the&nbsp;full&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4016160">return</span>&nbsp;<span class="ident" id="4016167">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4016182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4016186">valid</span>&nbsp;<span class="op" id="4016192">&amp;=</span>&nbsp;<span class="ident" id="4016195">subtle</span><span class="op" id="4016201">.</span><span class="ident" id="4016202">ConstantTimeEq</span><span class="op" id="4016216">(</span><span class="builtintype" id="4016217">int32</span><span class="op" id="4016222">(</span><span class="builtinfunc" id="4016223">len</span><span class="op" id="4016226">(</span><span class="ident" id="4016227">em</span><span class="op" id="4016229">)</span><span class="op" id="4016230">-</span><span class="ident" id="4016231">index</span><span class="op" id="4016236">)</span><span class="op" id="4016237">,</span>&nbsp;<span class="builtintype" id="4016239">int32</span><span class="op" id="4016244">(</span><span class="builtinfunc" id="4016245">len</span><span class="op" id="4016248">(</span><span class="ident" id="4016249">key</span><span class="op" id="4016252">)</span><span class="op" id="4016253">)</span><span class="op" id="4016254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4016257">subtle</span><span class="op" id="4016263">.</span><span class="ident" id="4016264">ConstantTimeCopy</span><span class="op" id="4016280">(</span><span class="ident" id="4016281">valid</span><span class="op" id="4016286">,</span>&nbsp;<span class="ident" id="4016288">key</span><span class="op" id="4016291">,</span>&nbsp;<span class="ident" id="4016293">em</span><span class="op" id="4016295">[</span><span class="builtinfunc" id="4016296">len</span><span class="op" id="4016299">(</span><span class="ident" id="4016300">em</span><span class="op" id="4016302">)</span><span class="op" id="4016303">-</span><span class="builtinfunc" id="4016304">len</span><span class="op" id="4016307">(</span><span class="ident" id="4016308">key</span><span class="op" id="4016311">)</span><span class="op" id="4016312">:</span><span class="op" id="4016313">]</span><span class="op" id="4016314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4016317">return</span><br>
<span class="lineno"></span><span class="op" id="4016324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4016327">//&nbsp;decryptPKCS1v15&nbsp;decrypts&nbsp;ciphertext&nbsp;using&nbsp;priv&nbsp;and&nbsp;blinds&nbsp;the&nbsp;operation&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4016405">//&nbsp;rand&nbsp;is&nbsp;not&nbsp;nil.&nbsp;It&nbsp;returns&nbsp;one&nbsp;or&nbsp;zero&nbsp;in&nbsp;valid&nbsp;that&nbsp;indicates&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4016484">//&nbsp;plaintext&nbsp;was&nbsp;correctly&nbsp;structured.&nbsp;In&nbsp;either&nbsp;case,&nbsp;the&nbsp;plaintext&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4016556">//&nbsp;returned&nbsp;in&nbsp;em&nbsp;so&nbsp;that&nbsp;it&nbsp;may&nbsp;be&nbsp;read&nbsp;independently&nbsp;of&nbsp;whether&nbsp;it&nbsp;was&nbsp;valid</span><br>
<span class="lineno"></span><span class="comment" id="4016635">//&nbsp;in&nbsp;order&nbsp;to&nbsp;maintain&nbsp;constant&nbsp;memory&nbsp;access&nbsp;patterns.&nbsp;If&nbsp;the&nbsp;plaintext&nbsp;was</span><br>
<span class="lineno">110</span><span class="comment" id="4016713">//&nbsp;valid&nbsp;then&nbsp;index&nbsp;contains&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;original&nbsp;message&nbsp;in&nbsp;em.</span><br>
<span class="lineno"></span><span class="keyword" id="4016783">func</span>&nbsp;<span class="ident" id="4016788">decryptPKCS1v15</span><span class="op" id="4016803">(</span><span class="ident" id="4016804">rand</span>&nbsp;<span class="ident" id="4016809">io</span><span class="op" id="4016811">.</span><span class="ident" id="4016812">Reader</span><span class="op" id="4016818">,</span>&nbsp;<span class="ident" id="4016820">priv</span>&nbsp;<span class="op" id="4016825">*</span><span class="ident" id="4016826">PrivateKey</span><span class="op" id="4016836">,</span>&nbsp;<span class="ident" id="4016838">ciphertext</span>&nbsp;<span class="op" id="4016849">[</span><span class="op" id="4016850">]</span><span class="builtintype" id="4016851">byte</span><span class="op" id="4016855">)</span>&nbsp;<span class="op" id="4016857">(</span><span class="ident" id="4016858">valid</span>&nbsp;<span class="builtintype" id="4016864">int</span><span class="op" id="4016867">,</span>&nbsp;<span class="ident" id="4016869">em</span>&nbsp;<span class="op" id="4016872">[</span><span class="op" id="4016873">]</span><span class="builtintype" id="4016874">byte</span><span class="op" id="4016878">,</span>&nbsp;<span class="ident" id="4016880">index</span>&nbsp;<span class="builtintype" id="4016886">int</span><span class="op" id="4016889">,</span>&nbsp;<span class="ident" id="4016891">err</span>&nbsp;<span class="builtintype" id="4016895">error</span><span class="op" id="4016900">)</span>&nbsp;<span class="op" id="4016902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4016905">k</span>&nbsp;<span class="op" id="4016907">:=</span>&nbsp;<span class="op" id="4016910">(</span><span class="ident" id="4016911">priv</span><span class="op" id="4016915">.</span><span class="ident" id="4016916">N</span><span class="op" id="4016917">.</span><span class="ident" id="4016918">BitLen</span><span class="op" id="4016924">(</span><span class="op" id="4016925">)</span>&nbsp;<span class="op" id="4016927">+</span>&nbsp;<span class="num" id="4016929">7</span><span class="op" id="4016930">)</span>&nbsp;<span class="op" id="4016932">/</span>&nbsp;<span class="num" id="4016934">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4016937">if</span>&nbsp;<span class="ident" id="4016940">k</span>&nbsp;<span class="op" id="4016942">&lt;</span>&nbsp;<span class="num" id="4016944">11</span>&nbsp;<span class="op" id="4016947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4016951">err</span>&nbsp;<span class="op" id="4016955">=</span>&nbsp;<span class="ident" id="4016957">ErrDecryption</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4016973">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4016981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4016985">c</span>&nbsp;<span class="op" id="4016987">:=</span>&nbsp;<span class="builtinfunc" id="4016990">new</span><span class="op" id="4016993">(</span><span class="ident" id="4016994">big</span><span class="op" id="4016997">.</span><span class="ident" id="4016998">Int</span><span class="op" id="4017001">)</span><span class="op" id="4017002">.</span><span class="ident" id="4017003">SetBytes</span><span class="op" id="4017011">(</span><span class="ident" id="4017012">ciphertext</span><span class="op" id="4017022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4017025">m</span><span class="op" id="4017026">,</span>&nbsp;<span class="ident" id="4017028">err</span>&nbsp;<span class="op" id="4017032">:=</span>&nbsp;<span class="ident" id="4017035">decrypt</span><span class="op" id="4017042">(</span><span class="ident" id="4017043">rand</span><span class="op" id="4017047">,</span>&nbsp;<span class="ident" id="4017049">priv</span><span class="op" id="4017053">,</span>&nbsp;<span class="ident" id="4017055">c</span><span class="op" id="4017056">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017059">if</span>&nbsp;<span class="ident" id="4017062">err</span>&nbsp;<span class="op" id="4017066">!=</span>&nbsp;<span class="builtintype" id="4017069">nil</span>&nbsp;<span class="op" id="4017073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017077">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4017085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4017089">em</span>&nbsp;<span class="op" id="4017092">=</span>&nbsp;<span class="ident" id="4017094">leftPad</span><span class="op" id="4017101">(</span><span class="ident" id="4017102">m</span><span class="op" id="4017103">.</span><span class="ident" id="4017104">Bytes</span><span class="op" id="4017109">(</span><span class="op" id="4017110">)</span><span class="op" id="4017111">,</span>&nbsp;<span class="ident" id="4017113">k</span><span class="op" id="4017114">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4017117">firstByteIsZero</span>&nbsp;<span class="op" id="4017133">:=</span>&nbsp;<span class="ident" id="4017136">subtle</span><span class="op" id="4017142">.</span><span class="ident" id="4017143">ConstantTimeByteEq</span><span class="op" id="4017161">(</span><span class="ident" id="4017162">em</span><span class="op" id="4017164">[</span><span class="num" id="4017165">0</span><span class="op" id="4017166">]</span><span class="op" id="4017167">,</span>&nbsp;<span class="num" id="4017169">0</span><span class="op" id="4017170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4017173">secondByteIsTwo</span>&nbsp;<span class="op" id="4017189">:=</span>&nbsp;<span class="ident" id="4017192">subtle</span><span class="op" id="4017198">.</span><span class="ident" id="4017199">ConstantTimeByteEq</span><span class="op" id="4017217">(</span><span class="ident" id="4017218">em</span><span class="op" id="4017220">[</span><span class="num" id="4017221">1</span><span class="op" id="4017222">]</span><span class="op" id="4017223">,</span>&nbsp;<span class="num" id="4017225">2</span><span class="op" id="4017226">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4017230">//&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;plaintext&nbsp;must&nbsp;be&nbsp;a&nbsp;string&nbsp;of&nbsp;non-zero&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4017301">//&nbsp;octets,&nbsp;followed&nbsp;by&nbsp;a&nbsp;0,&nbsp;followed&nbsp;by&nbsp;the&nbsp;message.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4017355">//&nbsp;&nbsp;&nbsp;lookingForIndex:&nbsp;1&nbsp;iff&nbsp;we&nbsp;are&nbsp;still&nbsp;looking&nbsp;for&nbsp;the&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4017419">//&nbsp;&nbsp;&nbsp;index:&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;first&nbsp;zero&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4017467">lookingForIndex</span>&nbsp;<span class="op" id="4017483">:=</span>&nbsp;<span class="num" id="4017486">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017490">for</span>&nbsp;<span class="ident" id="4017494">i</span>&nbsp;<span class="op" id="4017496">:=</span>&nbsp;<span class="num" id="4017499">2</span><span class="op" id="4017500">;</span>&nbsp;<span class="ident" id="4017502">i</span>&nbsp;<span class="op" id="4017504">&lt;</span>&nbsp;<span class="builtinfunc" id="4017506">len</span><span class="op" id="4017509">(</span><span class="ident" id="4017510">em</span><span class="op" id="4017512">)</span><span class="op" id="4017513">;</span>&nbsp;<span class="ident" id="4017515">i</span><span class="op" id="4017516">++</span>&nbsp;<span class="op" id="4017519">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4017523">equals0</span>&nbsp;<span class="op" id="4017531">:=</span>&nbsp;<span class="ident" id="4017534">subtle</span><span class="op" id="4017540">.</span><span class="ident" id="4017541">ConstantTimeByteEq</span><span class="op" id="4017559">(</span><span class="ident" id="4017560">em</span><span class="op" id="4017562">[</span><span class="ident" id="4017563">i</span><span class="op" id="4017564">]</span><span class="op" id="4017565">,</span>&nbsp;<span class="num" id="4017567">0</span><span class="op" id="4017568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4017572">index</span>&nbsp;<span class="op" id="4017578">=</span>&nbsp;<span class="ident" id="4017580">subtle</span><span class="op" id="4017586">.</span><span class="ident" id="4017587">ConstantTimeSelect</span><span class="op" id="4017605">(</span><span class="ident" id="4017606">lookingForIndex</span><span class="op" id="4017621">&amp;</span><span class="ident" id="4017622">equals0</span><span class="op" id="4017629">,</span>&nbsp;<span class="ident" id="4017631">i</span><span class="op" id="4017632">,</span>&nbsp;<span class="ident" id="4017634">index</span><span class="op" id="4017639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4017643">lookingForIndex</span>&nbsp;<span class="op" id="4017659">=</span>&nbsp;<span class="ident" id="4017661">subtle</span><span class="op" id="4017667">.</span><span class="ident" id="4017668">ConstantTimeSelect</span><span class="op" id="4017686">(</span><span class="ident" id="4017687">equals0</span><span class="op" id="4017694">,</span>&nbsp;<span class="num" id="4017696">0</span><span class="op" id="4017697">,</span>&nbsp;<span class="ident" id="4017699">lookingForIndex</span><span class="op" id="4017714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4017717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4017721">//&nbsp;The&nbsp;PS&nbsp;padding&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;8&nbsp;bytes&nbsp;long,&nbsp;and&nbsp;it&nbsp;starts&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4017789">//&nbsp;bytes&nbsp;into&nbsp;em.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4017808">validPS</span>&nbsp;<span class="op" id="4017816">:=</span>&nbsp;<span class="ident" id="4017819">subtle</span><span class="op" id="4017825">.</span><span class="ident" id="4017826">ConstantTimeLessOrEq</span><span class="op" id="4017846">(</span><span class="num" id="4017847">2</span><span class="op" id="4017848">+</span><span class="num" id="4017849">8</span><span class="op" id="4017850">,</span>&nbsp;<span class="ident" id="4017852">index</span><span class="op" id="4017857">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4017861">valid</span>&nbsp;<span class="op" id="4017867">=</span>&nbsp;<span class="ident" id="4017869">firstByteIsZero</span>&nbsp;<span class="op" id="4017885">&amp;</span>&nbsp;<span class="ident" id="4017887">secondByteIsTwo</span>&nbsp;<span class="op" id="4017903">&amp;</span>&nbsp;<span class="op" id="4017905">(</span><span class="op" id="4017906">^</span><span class="ident" id="4017907">lookingForIndex</span>&nbsp;<span class="op" id="4017923">&amp;</span>&nbsp;<span class="num" id="4017925">1</span><span class="op" id="4017926">)</span>&nbsp;<span class="op" id="4017928">&amp;</span>&nbsp;<span class="ident" id="4017930">validPS</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4017939">index</span>&nbsp;<span class="op" id="4017945">=</span>&nbsp;<span class="ident" id="4017947">subtle</span><span class="op" id="4017953">.</span><span class="ident" id="4017954">ConstantTimeSelect</span><span class="op" id="4017972">(</span><span class="ident" id="4017973">valid</span><span class="op" id="4017978">,</span>&nbsp;<span class="ident" id="4017980">index</span><span class="op" id="4017985">+</span><span class="num" id="4017986">1</span><span class="op" id="4017987">,</span>&nbsp;<span class="num" id="4017989">0</span><span class="op" id="4017990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4017993">return</span>&nbsp;<span class="ident" id="4018000">valid</span><span class="op" id="4018005">,</span>&nbsp;<span class="ident" id="4018007">em</span><span class="op" id="4018009">,</span>&nbsp;<span class="ident" id="4018011">index</span><span class="op" id="4018016">,</span>&nbsp;<span class="builtintype" id="4018018">nil</span><br>
<span class="lineno"></span><span class="op" id="4018022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4018025">//&nbsp;nonZeroRandomBytes&nbsp;fills&nbsp;the&nbsp;given&nbsp;slice&nbsp;with&nbsp;non-zero&nbsp;random&nbsp;octets.</span><br>
<span class="lineno">150</span><span class="keyword" id="4018098">func</span>&nbsp;<span class="ident" id="4018103">nonZeroRandomBytes</span><span class="op" id="4018121">(</span><span class="ident" id="4018122">s</span>&nbsp;<span class="op" id="4018124">[</span><span class="op" id="4018125">]</span><span class="builtintype" id="4018126">byte</span><span class="op" id="4018130">,</span>&nbsp;<span class="ident" id="4018132">rand</span>&nbsp;<span class="ident" id="4018137">io</span><span class="op" id="4018139">.</span><span class="ident" id="4018140">Reader</span><span class="op" id="4018146">)</span>&nbsp;<span class="op" id="4018148">(</span><span class="ident" id="4018149">err</span>&nbsp;<span class="builtintype" id="4018153">error</span><span class="op" id="4018158">)</span>&nbsp;<span class="op" id="4018160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4018163">_</span><span class="op" id="4018164">,</span>&nbsp;<span class="ident" id="4018166">err</span>&nbsp;<span class="op" id="4018170">=</span>&nbsp;<span class="ident" id="4018172">io</span><span class="op" id="4018174">.</span><span class="ident" id="4018175">ReadFull</span><span class="op" id="4018183">(</span><span class="ident" id="4018184">rand</span><span class="op" id="4018188">,</span>&nbsp;<span class="ident" id="4018190">s</span><span class="op" id="4018191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4018194">if</span>&nbsp;<span class="ident" id="4018197">err</span>&nbsp;<span class="op" id="4018201">!=</span>&nbsp;<span class="builtintype" id="4018204">nil</span>&nbsp;<span class="op" id="4018208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4018212">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4018220">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4018224">for</span>&nbsp;<span class="ident" id="4018228">i</span>&nbsp;<span class="op" id="4018230">:=</span>&nbsp;<span class="num" id="4018233">0</span><span class="op" id="4018234">;</span>&nbsp;<span class="ident" id="4018236">i</span>&nbsp;<span class="op" id="4018238">&lt;</span>&nbsp;<span class="builtinfunc" id="4018240">len</span><span class="op" id="4018243">(</span><span class="ident" id="4018244">s</span><span class="op" id="4018245">)</span><span class="op" id="4018246">;</span>&nbsp;<span class="ident" id="4018248">i</span><span class="op" id="4018249">++</span>&nbsp;<span class="op" id="4018252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4018256">for</span>&nbsp;<span class="ident" id="4018260">s</span><span class="op" id="4018261">[</span><span class="ident" id="4018262">i</span><span class="op" id="4018263">]</span>&nbsp;<span class="op" id="4018265">==</span>&nbsp;<span class="num" id="4018268">0</span>&nbsp;<span class="op" id="4018270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4018275">_</span><span class="op" id="4018276">,</span>&nbsp;<span class="ident" id="4018278">err</span>&nbsp;<span class="op" id="4018282">=</span>&nbsp;<span class="ident" id="4018284">io</span><span class="op" id="4018286">.</span><span class="ident" id="4018287">ReadFull</span><span class="op" id="4018295">(</span><span class="ident" id="4018296">rand</span><span class="op" id="4018300">,</span>&nbsp;<span class="ident" id="4018302">s</span><span class="op" id="4018303">[</span><span class="ident" id="4018304">i</span><span class="op" id="4018305">:</span><span class="ident" id="4018306">i</span><span class="op" id="4018307">+</span><span class="num" id="4018308">1</span><span class="op" id="4018309">]</span><span class="op" id="4018310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4018315">if</span>&nbsp;<span class="ident" id="4018318">err</span>&nbsp;<span class="op" id="4018322">!=</span>&nbsp;<span class="builtintype" id="4018325">nil</span>&nbsp;<span class="op" id="4018329">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4018335">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4018345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4018350">//&nbsp;In&nbsp;tests,&nbsp;the&nbsp;PRNG&nbsp;may&nbsp;return&nbsp;all&nbsp;zeros&nbsp;so&nbsp;we&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4018405">//&nbsp;this&nbsp;to&nbsp;break&nbsp;the&nbsp;loop.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4018435">s</span><span class="op" id="4018436">[</span><span class="ident" id="4018437">i</span><span class="op" id="4018438">]</span>&nbsp;<span class="op" id="4018440">^=</span>&nbsp;<span class="num" id="4018443">0x42</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4018450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4018453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4018457">return</span><br>
<span class="lineno"></span><span class="op" id="4018464">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="4018467">//&nbsp;These&nbsp;are&nbsp;ASN1&nbsp;DER&nbsp;structures:</span><br>
<span class="lineno"></span><span class="comment" id="4018501">//&nbsp;&nbsp;&nbsp;DigestInfo&nbsp;::=&nbsp;SEQUENCE&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4018532">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digestAlgorithm&nbsp;AlgorithmIdentifier,</span><br>
<span class="lineno"></span><span class="comment" id="4018576">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digest&nbsp;OCTET&nbsp;STRING</span><br>
<span class="lineno">175</span><span class="comment" id="4018603">//&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="4018610">//&nbsp;For&nbsp;performance,&nbsp;we&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;generic&nbsp;ASN1&nbsp;encoder.&nbsp;Rather,&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="4018680">//&nbsp;precompute&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;digest&nbsp;value&nbsp;that&nbsp;makes&nbsp;a&nbsp;valid&nbsp;ASN1&nbsp;DER&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="4018758">//&nbsp;with&nbsp;the&nbsp;correct&nbsp;contents.</span><br>
<span class="lineno"></span><span class="keyword" id="4018788">var</span>&nbsp;<span class="ident" id="4018792">hashPrefixes</span>&nbsp;<span class="op" id="4018805">=</span>&nbsp;<span class="keyword" id="4018807">map</span><span class="op" id="4018810">[</span><span class="ident" id="4018811">crypto</span><span class="op" id="4018817">.</span><span class="ident" id="4018818">Hash</span><span class="op" id="4018822">]</span><span class="op" id="4018823">[</span><span class="op" id="4018824">]</span><span class="builtintype" id="4018825">byte</span><span class="op" id="4018829">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4018832">crypto</span><span class="op" id="4018838">.</span><span class="ident" id="4018839">MD5</span><span class="op" id="4018842">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4018850">{</span><span class="num" id="4018851">0x30</span><span class="op" id="4018855">,</span>&nbsp;<span class="num" id="4018857">0x20</span><span class="op" id="4018861">,</span>&nbsp;<span class="num" id="4018863">0x30</span><span class="op" id="4018867">,</span>&nbsp;<span class="num" id="4018869">0x0c</span><span class="op" id="4018873">,</span>&nbsp;<span class="num" id="4018875">0x06</span><span class="op" id="4018879">,</span>&nbsp;<span class="num" id="4018881">0x08</span><span class="op" id="4018885">,</span>&nbsp;<span class="num" id="4018887">0x2a</span><span class="op" id="4018891">,</span>&nbsp;<span class="num" id="4018893">0x86</span><span class="op" id="4018897">,</span>&nbsp;<span class="num" id="4018899">0x48</span><span class="op" id="4018903">,</span>&nbsp;<span class="num" id="4018905">0x86</span><span class="op" id="4018909">,</span>&nbsp;<span class="num" id="4018911">0xf7</span><span class="op" id="4018915">,</span>&nbsp;<span class="num" id="4018917">0x0d</span><span class="op" id="4018921">,</span>&nbsp;<span class="num" id="4018923">0x02</span><span class="op" id="4018927">,</span>&nbsp;<span class="num" id="4018929">0x05</span><span class="op" id="4018933">,</span>&nbsp;<span class="num" id="4018935">0x05</span><span class="op" id="4018939">,</span>&nbsp;<span class="num" id="4018941">0x00</span><span class="op" id="4018945">,</span>&nbsp;<span class="num" id="4018947">0x04</span><span class="op" id="4018951">,</span>&nbsp;<span class="num" id="4018953">0x10</span><span class="op" id="4018957">}</span><span class="op" id="4018958">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4018961">crypto</span><span class="op" id="4018967">.</span><span class="ident" id="4018968">SHA1</span><span class="op" id="4018972">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4018979">{</span><span class="num" id="4018980">0x30</span><span class="op" id="4018984">,</span>&nbsp;<span class="num" id="4018986">0x21</span><span class="op" id="4018990">,</span>&nbsp;<span class="num" id="4018992">0x30</span><span class="op" id="4018996">,</span>&nbsp;<span class="num" id="4018998">0x09</span><span class="op" id="4019002">,</span>&nbsp;<span class="num" id="4019004">0x06</span><span class="op" id="4019008">,</span>&nbsp;<span class="num" id="4019010">0x05</span><span class="op" id="4019014">,</span>&nbsp;<span class="num" id="4019016">0x2b</span><span class="op" id="4019020">,</span>&nbsp;<span class="num" id="4019022">0x0e</span><span class="op" id="4019026">,</span>&nbsp;<span class="num" id="4019028">0x03</span><span class="op" id="4019032">,</span>&nbsp;<span class="num" id="4019034">0x02</span><span class="op" id="4019038">,</span>&nbsp;<span class="num" id="4019040">0x1a</span><span class="op" id="4019044">,</span>&nbsp;<span class="num" id="4019046">0x05</span><span class="op" id="4019050">,</span>&nbsp;<span class="num" id="4019052">0x00</span><span class="op" id="4019056">,</span>&nbsp;<span class="num" id="4019058">0x04</span><span class="op" id="4019062">,</span>&nbsp;<span class="num" id="4019064">0x14</span><span class="op" id="4019068">}</span><span class="op" id="4019069">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4019072">crypto</span><span class="op" id="4019078">.</span><span class="ident" id="4019079">SHA224</span><span class="op" id="4019085">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4019090">{</span><span class="num" id="4019091">0x30</span><span class="op" id="4019095">,</span>&nbsp;<span class="num" id="4019097">0x2d</span><span class="op" id="4019101">,</span>&nbsp;<span class="num" id="4019103">0x30</span><span class="op" id="4019107">,</span>&nbsp;<span class="num" id="4019109">0x0d</span><span class="op" id="4019113">,</span>&nbsp;<span class="num" id="4019115">0x06</span><span class="op" id="4019119">,</span>&nbsp;<span class="num" id="4019121">0x09</span><span class="op" id="4019125">,</span>&nbsp;<span class="num" id="4019127">0x60</span><span class="op" id="4019131">,</span>&nbsp;<span class="num" id="4019133">0x86</span><span class="op" id="4019137">,</span>&nbsp;<span class="num" id="4019139">0x48</span><span class="op" id="4019143">,</span>&nbsp;<span class="num" id="4019145">0x01</span><span class="op" id="4019149">,</span>&nbsp;<span class="num" id="4019151">0x65</span><span class="op" id="4019155">,</span>&nbsp;<span class="num" id="4019157">0x03</span><span class="op" id="4019161">,</span>&nbsp;<span class="num" id="4019163">0x04</span><span class="op" id="4019167">,</span>&nbsp;<span class="num" id="4019169">0x02</span><span class="op" id="4019173">,</span>&nbsp;<span class="num" id="4019175">0x04</span><span class="op" id="4019179">,</span>&nbsp;<span class="num" id="4019181">0x05</span><span class="op" id="4019185">,</span>&nbsp;<span class="num" id="4019187">0x00</span><span class="op" id="4019191">,</span>&nbsp;<span class="num" id="4019193">0x04</span><span class="op" id="4019197">,</span>&nbsp;<span class="num" id="4019199">0x1c</span><span class="op" id="4019203">}</span><span class="op" id="4019204">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4019207">crypto</span><span class="op" id="4019213">.</span><span class="ident" id="4019214">SHA256</span><span class="op" id="4019220">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4019225">{</span><span class="num" id="4019226">0x30</span><span class="op" id="4019230">,</span>&nbsp;<span class="num" id="4019232">0x31</span><span class="op" id="4019236">,</span>&nbsp;<span class="num" id="4019238">0x30</span><span class="op" id="4019242">,</span>&nbsp;<span class="num" id="4019244">0x0d</span><span class="op" id="4019248">,</span>&nbsp;<span class="num" id="4019250">0x06</span><span class="op" id="4019254">,</span>&nbsp;<span class="num" id="4019256">0x09</span><span class="op" id="4019260">,</span>&nbsp;<span class="num" id="4019262">0x60</span><span class="op" id="4019266">,</span>&nbsp;<span class="num" id="4019268">0x86</span><span class="op" id="4019272">,</span>&nbsp;<span class="num" id="4019274">0x48</span><span class="op" id="4019278">,</span>&nbsp;<span class="num" id="4019280">0x01</span><span class="op" id="4019284">,</span>&nbsp;<span class="num" id="4019286">0x65</span><span class="op" id="4019290">,</span>&nbsp;<span class="num" id="4019292">0x03</span><span class="op" id="4019296">,</span>&nbsp;<span class="num" id="4019298">0x04</span><span class="op" id="4019302">,</span>&nbsp;<span class="num" id="4019304">0x02</span><span class="op" id="4019308">,</span>&nbsp;<span class="num" id="4019310">0x01</span><span class="op" id="4019314">,</span>&nbsp;<span class="num" id="4019316">0x05</span><span class="op" id="4019320">,</span>&nbsp;<span class="num" id="4019322">0x00</span><span class="op" id="4019326">,</span>&nbsp;<span class="num" id="4019328">0x04</span><span class="op" id="4019332">,</span>&nbsp;<span class="num" id="4019334">0x20</span><span class="op" id="4019338">}</span><span class="op" id="4019339">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4019342">crypto</span><span class="op" id="4019348">.</span><span class="ident" id="4019349">SHA384</span><span class="op" id="4019355">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4019360">{</span><span class="num" id="4019361">0x30</span><span class="op" id="4019365">,</span>&nbsp;<span class="num" id="4019367">0x41</span><span class="op" id="4019371">,</span>&nbsp;<span class="num" id="4019373">0x30</span><span class="op" id="4019377">,</span>&nbsp;<span class="num" id="4019379">0x0d</span><span class="op" id="4019383">,</span>&nbsp;<span class="num" id="4019385">0x06</span><span class="op" id="4019389">,</span>&nbsp;<span class="num" id="4019391">0x09</span><span class="op" id="4019395">,</span>&nbsp;<span class="num" id="4019397">0x60</span><span class="op" id="4019401">,</span>&nbsp;<span class="num" id="4019403">0x86</span><span class="op" id="4019407">,</span>&nbsp;<span class="num" id="4019409">0x48</span><span class="op" id="4019413">,</span>&nbsp;<span class="num" id="4019415">0x01</span><span class="op" id="4019419">,</span>&nbsp;<span class="num" id="4019421">0x65</span><span class="op" id="4019425">,</span>&nbsp;<span class="num" id="4019427">0x03</span><span class="op" id="4019431">,</span>&nbsp;<span class="num" id="4019433">0x04</span><span class="op" id="4019437">,</span>&nbsp;<span class="num" id="4019439">0x02</span><span class="op" id="4019443">,</span>&nbsp;<span class="num" id="4019445">0x02</span><span class="op" id="4019449">,</span>&nbsp;<span class="num" id="4019451">0x05</span><span class="op" id="4019455">,</span>&nbsp;<span class="num" id="4019457">0x00</span><span class="op" id="4019461">,</span>&nbsp;<span class="num" id="4019463">0x04</span><span class="op" id="4019467">,</span>&nbsp;<span class="num" id="4019469">0x30</span><span class="op" id="4019473">}</span><span class="op" id="4019474">,</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4019477">crypto</span><span class="op" id="4019483">.</span><span class="ident" id="4019484">SHA512</span><span class="op" id="4019490">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4019495">{</span><span class="num" id="4019496">0x30</span><span class="op" id="4019500">,</span>&nbsp;<span class="num" id="4019502">0x51</span><span class="op" id="4019506">,</span>&nbsp;<span class="num" id="4019508">0x30</span><span class="op" id="4019512">,</span>&nbsp;<span class="num" id="4019514">0x0d</span><span class="op" id="4019518">,</span>&nbsp;<span class="num" id="4019520">0x06</span><span class="op" id="4019524">,</span>&nbsp;<span class="num" id="4019526">0x09</span><span class="op" id="4019530">,</span>&nbsp;<span class="num" id="4019532">0x60</span><span class="op" id="4019536">,</span>&nbsp;<span class="num" id="4019538">0x86</span><span class="op" id="4019542">,</span>&nbsp;<span class="num" id="4019544">0x48</span><span class="op" id="4019548">,</span>&nbsp;<span class="num" id="4019550">0x01</span><span class="op" id="4019554">,</span>&nbsp;<span class="num" id="4019556">0x65</span><span class="op" id="4019560">,</span>&nbsp;<span class="num" id="4019562">0x03</span><span class="op" id="4019566">,</span>&nbsp;<span class="num" id="4019568">0x04</span><span class="op" id="4019572">,</span>&nbsp;<span class="num" id="4019574">0x02</span><span class="op" id="4019578">,</span>&nbsp;<span class="num" id="4019580">0x03</span><span class="op" id="4019584">,</span>&nbsp;<span class="num" id="4019586">0x05</span><span class="op" id="4019590">,</span>&nbsp;<span class="num" id="4019592">0x00</span><span class="op" id="4019596">,</span>&nbsp;<span class="num" id="4019598">0x04</span><span class="op" id="4019602">,</span>&nbsp;<span class="num" id="4019604">0x40</span><span class="op" id="4019608">}</span><span class="op" id="4019609">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4019612">crypto</span><span class="op" id="4019618">.</span><span class="ident" id="4019619">MD5SHA1</span><span class="op" id="4019626">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4019630">{</span><span class="op" id="4019631">}</span><span class="op" id="4019632">,</span>&nbsp;<span class="comment" id="4019634">//&nbsp;A&nbsp;special&nbsp;TLS&nbsp;case&nbsp;which&nbsp;doesn&#39;t&nbsp;use&nbsp;an&nbsp;ASN1&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4019691">crypto</span><span class="op" id="4019697">.</span><span class="ident" id="4019698">RIPEMD160</span><span class="op" id="4019707">:</span>&nbsp;<span class="op" id="4019709">{</span><span class="num" id="4019710">0x30</span><span class="op" id="4019714">,</span>&nbsp;<span class="num" id="4019716">0x20</span><span class="op" id="4019720">,</span>&nbsp;<span class="num" id="4019722">0x30</span><span class="op" id="4019726">,</span>&nbsp;<span class="num" id="4019728">0x08</span><span class="op" id="4019732">,</span>&nbsp;<span class="num" id="4019734">0x06</span><span class="op" id="4019738">,</span>&nbsp;<span class="num" id="4019740">0x06</span><span class="op" id="4019744">,</span>&nbsp;<span class="num" id="4019746">0x28</span><span class="op" id="4019750">,</span>&nbsp;<span class="num" id="4019752">0xcf</span><span class="op" id="4019756">,</span>&nbsp;<span class="num" id="4019758">0x06</span><span class="op" id="4019762">,</span>&nbsp;<span class="num" id="4019764">0x03</span><span class="op" id="4019768">,</span>&nbsp;<span class="num" id="4019770">0x00</span><span class="op" id="4019774">,</span>&nbsp;<span class="num" id="4019776">0x31</span><span class="op" id="4019780">,</span>&nbsp;<span class="num" id="4019782">0x04</span><span class="op" id="4019786">,</span>&nbsp;<span class="num" id="4019788">0x14</span><span class="op" id="4019792">}</span><span class="op" id="4019793">,</span><br>
<span class="lineno"></span><span class="op" id="4019795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="comment" id="4019798">//&nbsp;SignPKCS1v15&nbsp;calculates&nbsp;the&nbsp;signature&nbsp;of&nbsp;hashed&nbsp;using&nbsp;RSASSA-PKCS1-V1_5-SIGN&nbsp;from&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4019900">//&nbsp;Note&nbsp;that&nbsp;hashed&nbsp;must&nbsp;be&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4019978">//&nbsp;given&nbsp;hash&nbsp;function.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero,&nbsp;hashed&nbsp;is&nbsp;signed&nbsp;directly.&nbsp;This&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="4020057">//&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="4020099">func</span>&nbsp;<span class="ident" id="4020104">SignPKCS1v15</span><span class="op" id="4020116">(</span><span class="ident" id="4020117">rand</span>&nbsp;<span class="ident" id="4020122">io</span><span class="op" id="4020124">.</span><span class="ident" id="4020125">Reader</span><span class="op" id="4020131">,</span>&nbsp;<span class="ident" id="4020133">priv</span>&nbsp;<span class="op" id="4020138">*</span><span class="ident" id="4020139">PrivateKey</span><span class="op" id="4020149">,</span>&nbsp;<span class="ident" id="4020151">hash</span>&nbsp;<span class="ident" id="4020156">crypto</span><span class="op" id="4020162">.</span><span class="ident" id="4020163">Hash</span><span class="op" id="4020167">,</span>&nbsp;<span class="ident" id="4020169">hashed</span>&nbsp;<span class="op" id="4020176">[</span><span class="op" id="4020177">]</span><span class="builtintype" id="4020178">byte</span><span class="op" id="4020182">)</span>&nbsp;<span class="op" id="4020184">(</span><span class="ident" id="4020185">s</span>&nbsp;<span class="op" id="4020187">[</span><span class="op" id="4020188">]</span><span class="builtintype" id="4020189">byte</span><span class="op" id="4020193">,</span>&nbsp;<span class="ident" id="4020195">err</span>&nbsp;<span class="builtintype" id="4020199">error</span><span class="op" id="4020204">)</span>&nbsp;<span class="op" id="4020206">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4020209">hashLen</span><span class="op" id="4020216">,</span>&nbsp;<span class="ident" id="4020218">prefix</span><span class="op" id="4020224">,</span>&nbsp;<span class="ident" id="4020226">err</span>&nbsp;<span class="op" id="4020230">:=</span>&nbsp;<span class="ident" id="4020233">pkcs1v15HashInfo</span><span class="op" id="4020249">(</span><span class="ident" id="4020250">hash</span><span class="op" id="4020254">,</span>&nbsp;<span class="builtinfunc" id="4020256">len</span><span class="op" id="4020259">(</span><span class="ident" id="4020260">hashed</span><span class="op" id="4020266">)</span><span class="op" id="4020267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4020270">if</span>&nbsp;<span class="ident" id="4020273">err</span>&nbsp;<span class="op" id="4020277">!=</span>&nbsp;<span class="builtintype" id="4020280">nil</span>&nbsp;<span class="op" id="4020284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4020288">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4020296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4020300">tLen</span>&nbsp;<span class="op" id="4020305">:=</span>&nbsp;<span class="builtinfunc" id="4020308">len</span><span class="op" id="4020311">(</span><span class="ident" id="4020312">prefix</span><span class="op" id="4020318">)</span>&nbsp;<span class="op" id="4020320">+</span>&nbsp;<span class="ident" id="4020322">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4020331">k</span>&nbsp;<span class="op" id="4020333">:=</span>&nbsp;<span class="op" id="4020336">(</span><span class="ident" id="4020337">priv</span><span class="op" id="4020341">.</span><span class="ident" id="4020342">N</span><span class="op" id="4020343">.</span><span class="ident" id="4020344">BitLen</span><span class="op" id="4020350">(</span><span class="op" id="4020351">)</span>&nbsp;<span class="op" id="4020353">+</span>&nbsp;<span class="num" id="4020355">7</span><span class="op" id="4020356">)</span>&nbsp;<span class="op" id="4020358">/</span>&nbsp;<span class="num" id="4020360">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4020363">if</span>&nbsp;<span class="ident" id="4020366">k</span>&nbsp;<span class="op" id="4020368">&lt;</span>&nbsp;<span class="ident" id="4020370">tLen</span><span class="op" id="4020374">+</span><span class="num" id="4020375">11</span>&nbsp;<span class="op" id="4020378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4020382">return</span>&nbsp;<span class="builtintype" id="4020389">nil</span><span class="op" id="4020392">,</span>&nbsp;<span class="ident" id="4020394">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4020413">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4020417">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4020458">em</span>&nbsp;<span class="op" id="4020461">:=</span>&nbsp;<span class="builtinfunc" id="4020464">make</span><span class="op" id="4020468">(</span><span class="op" id="4020469">[</span><span class="op" id="4020470">]</span><span class="builtintype" id="4020471">byte</span><span class="op" id="4020475">,</span>&nbsp;<span class="ident" id="4020477">k</span><span class="op" id="4020478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4020481">em</span><span class="op" id="4020483">[</span><span class="num" id="4020484">1</span><span class="op" id="4020485">]</span>&nbsp;<span class="op" id="4020487">=</span>&nbsp;<span class="num" id="4020489">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4020492">for</span>&nbsp;<span class="ident" id="4020496">i</span>&nbsp;<span class="op" id="4020498">:=</span>&nbsp;<span class="num" id="4020501">2</span><span class="op" id="4020502">;</span>&nbsp;<span class="ident" id="4020504">i</span>&nbsp;<span class="op" id="4020506">&lt;</span>&nbsp;<span class="ident" id="4020508">k</span><span class="op" id="4020509">-</span><span class="ident" id="4020510">tLen</span><span class="op" id="4020514">-</span><span class="num" id="4020515">1</span><span class="op" id="4020516">;</span>&nbsp;<span class="ident" id="4020518">i</span><span class="op" id="4020519">++</span>&nbsp;<span class="op" id="4020522">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4020526">em</span><span class="op" id="4020528">[</span><span class="ident" id="4020529">i</span><span class="op" id="4020530">]</span>&nbsp;<span class="op" id="4020532">=</span>&nbsp;<span class="num" id="4020534">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4020540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4020543">copy</span><span class="op" id="4020547">(</span><span class="ident" id="4020548">em</span><span class="op" id="4020550">[</span><span class="ident" id="4020551">k</span><span class="op" id="4020552">-</span><span class="ident" id="4020553">tLen</span><span class="op" id="4020557">:</span><span class="ident" id="4020558">k</span><span class="op" id="4020559">-</span><span class="ident" id="4020560">hashLen</span><span class="op" id="4020567">]</span><span class="op" id="4020568">,</span>&nbsp;<span class="ident" id="4020570">prefix</span><span class="op" id="4020576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4020579">copy</span><span class="op" id="4020583">(</span><span class="ident" id="4020584">em</span><span class="op" id="4020586">[</span><span class="ident" id="4020587">k</span><span class="op" id="4020588">-</span><span class="ident" id="4020589">hashLen</span><span class="op" id="4020596">:</span><span class="ident" id="4020597">k</span><span class="op" id="4020598">]</span><span class="op" id="4020599">,</span>&nbsp;<span class="ident" id="4020601">hashed</span><span class="op" id="4020607">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4020611">m</span>&nbsp;<span class="op" id="4020613">:=</span>&nbsp;<span class="builtinfunc" id="4020616">new</span><span class="op" id="4020619">(</span><span class="ident" id="4020620">big</span><span class="op" id="4020623">.</span><span class="ident" id="4020624">Int</span><span class="op" id="4020627">)</span><span class="op" id="4020628">.</span><span class="ident" id="4020629">SetBytes</span><span class="op" id="4020637">(</span><span class="ident" id="4020638">em</span><span class="op" id="4020640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4020643">c</span><span class="op" id="4020644">,</span>&nbsp;<span class="ident" id="4020646">err</span>&nbsp;<span class="op" id="4020650">:=</span>&nbsp;<span class="ident" id="4020653">decrypt</span><span class="op" id="4020660">(</span><span class="ident" id="4020661">rand</span><span class="op" id="4020665">,</span>&nbsp;<span class="ident" id="4020667">priv</span><span class="op" id="4020671">,</span>&nbsp;<span class="ident" id="4020673">m</span><span class="op" id="4020674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4020677">if</span>&nbsp;<span class="ident" id="4020680">err</span>&nbsp;<span class="op" id="4020684">!=</span>&nbsp;<span class="builtintype" id="4020687">nil</span>&nbsp;<span class="op" id="4020691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4020695">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4020703">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4020707">copyWithLeftPad</span><span class="op" id="4020722">(</span><span class="ident" id="4020723">em</span><span class="op" id="4020725">,</span>&nbsp;<span class="ident" id="4020727">c</span><span class="op" id="4020728">.</span><span class="ident" id="4020729">Bytes</span><span class="op" id="4020734">(</span><span class="op" id="4020735">)</span><span class="op" id="4020736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4020739">s</span>&nbsp;<span class="op" id="4020741">=</span>&nbsp;<span class="ident" id="4020743">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4020747">return</span><br>
<span class="lineno"></span><span class="op" id="4020754">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="4020757">//&nbsp;VerifyPKCS1v15&nbsp;verifies&nbsp;an&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5&nbsp;signature.</span><br>
<span class="lineno"></span><span class="comment" id="4020814">//&nbsp;hashed&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the&nbsp;given&nbsp;hash</span><br>
<span class="lineno"></span><span class="comment" id="4020888">//&nbsp;function&nbsp;and&nbsp;sig&nbsp;is&nbsp;the&nbsp;signature.&nbsp;A&nbsp;valid&nbsp;signature&nbsp;is&nbsp;indicated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4020960">//&nbsp;returning&nbsp;a&nbsp;nil&nbsp;error.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero&nbsp;then&nbsp;hashed&nbsp;is&nbsp;used&nbsp;directly.&nbsp;This</span><br>
<span class="lineno">230</span><span class="comment" id="4021037">//&nbsp;isn&#39;t&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="4021085">func</span>&nbsp;<span class="ident" id="4021090">VerifyPKCS1v15</span><span class="op" id="4021104">(</span><span class="ident" id="4021105">pub</span>&nbsp;<span class="op" id="4021109">*</span><span class="ident" id="4021110">PublicKey</span><span class="op" id="4021119">,</span>&nbsp;<span class="ident" id="4021121">hash</span>&nbsp;<span class="ident" id="4021126">crypto</span><span class="op" id="4021132">.</span><span class="ident" id="4021133">Hash</span><span class="op" id="4021137">,</span>&nbsp;<span class="ident" id="4021139">hashed</span>&nbsp;<span class="op" id="4021146">[</span><span class="op" id="4021147">]</span><span class="builtintype" id="4021148">byte</span><span class="op" id="4021152">,</span>&nbsp;<span class="ident" id="4021154">sig</span>&nbsp;<span class="op" id="4021158">[</span><span class="op" id="4021159">]</span><span class="builtintype" id="4021160">byte</span><span class="op" id="4021164">)</span>&nbsp;<span class="op" id="4021166">(</span><span class="ident" id="4021167">err</span>&nbsp;<span class="builtintype" id="4021171">error</span><span class="op" id="4021176">)</span>&nbsp;<span class="op" id="4021178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4021181">hashLen</span><span class="op" id="4021188">,</span>&nbsp;<span class="ident" id="4021190">prefix</span><span class="op" id="4021196">,</span>&nbsp;<span class="ident" id="4021198">err</span>&nbsp;<span class="op" id="4021202">:=</span>&nbsp;<span class="ident" id="4021205">pkcs1v15HashInfo</span><span class="op" id="4021221">(</span><span class="ident" id="4021222">hash</span><span class="op" id="4021226">,</span>&nbsp;<span class="builtinfunc" id="4021228">len</span><span class="op" id="4021231">(</span><span class="ident" id="4021232">hashed</span><span class="op" id="4021238">)</span><span class="op" id="4021239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4021242">if</span>&nbsp;<span class="ident" id="4021245">err</span>&nbsp;<span class="op" id="4021249">!=</span>&nbsp;<span class="builtintype" id="4021252">nil</span>&nbsp;<span class="op" id="4021256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4021260">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4021268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4021272">tLen</span>&nbsp;<span class="op" id="4021277">:=</span>&nbsp;<span class="builtinfunc" id="4021280">len</span><span class="op" id="4021283">(</span><span class="ident" id="4021284">prefix</span><span class="op" id="4021290">)</span>&nbsp;<span class="op" id="4021292">+</span>&nbsp;<span class="ident" id="4021294">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4021303">k</span>&nbsp;<span class="op" id="4021305">:=</span>&nbsp;<span class="op" id="4021308">(</span><span class="ident" id="4021309">pub</span><span class="op" id="4021312">.</span><span class="ident" id="4021313">N</span><span class="op" id="4021314">.</span><span class="ident" id="4021315">BitLen</span><span class="op" id="4021321">(</span><span class="op" id="4021322">)</span>&nbsp;<span class="op" id="4021324">+</span>&nbsp;<span class="num" id="4021326">7</span><span class="op" id="4021327">)</span>&nbsp;<span class="op" id="4021329">/</span>&nbsp;<span class="num" id="4021331">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4021334">if</span>&nbsp;<span class="ident" id="4021337">k</span>&nbsp;<span class="op" id="4021339">&lt;</span>&nbsp;<span class="ident" id="4021341">tLen</span><span class="op" id="4021345">+</span><span class="num" id="4021346">11</span>&nbsp;<span class="op" id="4021349">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4021353">err</span>&nbsp;<span class="op" id="4021357">=</span>&nbsp;<span class="ident" id="4021359">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4021377">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4021385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4021389">c</span>&nbsp;<span class="op" id="4021391">:=</span>&nbsp;<span class="builtinfunc" id="4021394">new</span><span class="op" id="4021397">(</span><span class="ident" id="4021398">big</span><span class="op" id="4021401">.</span><span class="ident" id="4021402">Int</span><span class="op" id="4021405">)</span><span class="op" id="4021406">.</span><span class="ident" id="4021407">SetBytes</span><span class="op" id="4021415">(</span><span class="ident" id="4021416">sig</span><span class="op" id="4021419">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4021422">m</span>&nbsp;<span class="op" id="4021424">:=</span>&nbsp;<span class="ident" id="4021427">encrypt</span><span class="op" id="4021434">(</span><span class="builtinfunc" id="4021435">new</span><span class="op" id="4021438">(</span><span class="ident" id="4021439">big</span><span class="op" id="4021442">.</span><span class="ident" id="4021443">Int</span><span class="op" id="4021446">)</span><span class="op" id="4021447">,</span>&nbsp;<span class="ident" id="4021449">pub</span><span class="op" id="4021452">,</span>&nbsp;<span class="ident" id="4021454">c</span><span class="op" id="4021455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4021458">em</span>&nbsp;<span class="op" id="4021461">:=</span>&nbsp;<span class="ident" id="4021464">leftPad</span><span class="op" id="4021471">(</span><span class="ident" id="4021472">m</span><span class="op" id="4021473">.</span><span class="ident" id="4021474">Bytes</span><span class="op" id="4021479">(</span><span class="op" id="4021480">)</span><span class="op" id="4021481">,</span>&nbsp;<span class="ident" id="4021483">k</span><span class="op" id="4021484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4021487">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4021529">ok</span>&nbsp;<span class="op" id="4021532">:=</span>&nbsp;<span class="ident" id="4021535">subtle</span><span class="op" id="4021541">.</span><span class="ident" id="4021542">ConstantTimeByteEq</span><span class="op" id="4021560">(</span><span class="ident" id="4021561">em</span><span class="op" id="4021563">[</span><span class="num" id="4021564">0</span><span class="op" id="4021565">]</span><span class="op" id="4021566">,</span>&nbsp;<span class="num" id="4021568">0</span><span class="op" id="4021569">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4021572">ok</span>&nbsp;<span class="op" id="4021575">&amp;=</span>&nbsp;<span class="ident" id="4021578">subtle</span><span class="op" id="4021584">.</span><span class="ident" id="4021585">ConstantTimeByteEq</span><span class="op" id="4021603">(</span><span class="ident" id="4021604">em</span><span class="op" id="4021606">[</span><span class="num" id="4021607">1</span><span class="op" id="4021608">]</span><span class="op" id="4021609">,</span>&nbsp;<span class="num" id="4021611">1</span><span class="op" id="4021612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4021615">ok</span>&nbsp;<span class="op" id="4021618">&amp;=</span>&nbsp;<span class="ident" id="4021621">subtle</span><span class="op" id="4021627">.</span><span class="ident" id="4021628">ConstantTimeCompare</span><span class="op" id="4021647">(</span><span class="ident" id="4021648">em</span><span class="op" id="4021650">[</span><span class="ident" id="4021651">k</span><span class="op" id="4021652">-</span><span class="ident" id="4021653">hashLen</span><span class="op" id="4021660">:</span><span class="ident" id="4021661">k</span><span class="op" id="4021662">]</span><span class="op" id="4021663">,</span>&nbsp;<span class="ident" id="4021665">hashed</span><span class="op" id="4021671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4021674">ok</span>&nbsp;<span class="op" id="4021677">&amp;=</span>&nbsp;<span class="ident" id="4021680">subtle</span><span class="op" id="4021686">.</span><span class="ident" id="4021687">ConstantTimeCompare</span><span class="op" id="4021706">(</span><span class="ident" id="4021707">em</span><span class="op" id="4021709">[</span><span class="ident" id="4021710">k</span><span class="op" id="4021711">-</span><span class="ident" id="4021712">tLen</span><span class="op" id="4021716">:</span><span class="ident" id="4021717">k</span><span class="op" id="4021718">-</span><span class="ident" id="4021719">hashLen</span><span class="op" id="4021726">]</span><span class="op" id="4021727">,</span>&nbsp;<span class="ident" id="4021729">prefix</span><span class="op" id="4021735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4021738">ok</span>&nbsp;<span class="op" id="4021741">&amp;=</span>&nbsp;<span class="ident" id="4021744">subtle</span><span class="op" id="4021750">.</span><span class="ident" id="4021751">ConstantTimeByteEq</span><span class="op" id="4021769">(</span><span class="ident" id="4021770">em</span><span class="op" id="4021772">[</span><span class="ident" id="4021773">k</span><span class="op" id="4021774">-</span><span class="ident" id="4021775">tLen</span><span class="op" id="4021779">-</span><span class="num" id="4021780">1</span><span class="op" id="4021781">]</span><span class="op" id="4021782">,</span>&nbsp;<span class="num" id="4021784">0</span><span class="op" id="4021785">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4021789">for</span>&nbsp;<span class="ident" id="4021793">i</span>&nbsp;<span class="op" id="4021795">:=</span>&nbsp;<span class="num" id="4021798">2</span><span class="op" id="4021799">;</span>&nbsp;<span class="ident" id="4021801">i</span>&nbsp;<span class="op" id="4021803">&lt;</span>&nbsp;<span class="ident" id="4021805">k</span><span class="op" id="4021806">-</span><span class="ident" id="4021807">tLen</span><span class="op" id="4021811">-</span><span class="num" id="4021812">1</span><span class="op" id="4021813">;</span>&nbsp;<span class="ident" id="4021815">i</span><span class="op" id="4021816">++</span>&nbsp;<span class="op" id="4021819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4021823">ok</span>&nbsp;<span class="op" id="4021826">&amp;=</span>&nbsp;<span class="ident" id="4021829">subtle</span><span class="op" id="4021835">.</span><span class="ident" id="4021836">ConstantTimeByteEq</span><span class="op" id="4021854">(</span><span class="ident" id="4021855">em</span><span class="op" id="4021857">[</span><span class="ident" id="4021858">i</span><span class="op" id="4021859">]</span><span class="op" id="4021860">,</span>&nbsp;<span class="num" id="4021862">0xff</span><span class="op" id="4021866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4021869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4021873">if</span>&nbsp;<span class="ident" id="4021876">ok</span>&nbsp;<span class="op" id="4021879">!=</span>&nbsp;<span class="num" id="4021882">1</span>&nbsp;<span class="op" id="4021884">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4021888">return</span>&nbsp;<span class="ident" id="4021895">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4021912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4021916">return</span>&nbsp;<span class="builtintype" id="4021923">nil</span><br>
<span class="lineno"></span><span class="op" id="4021927">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="4021930">func</span>&nbsp;<span class="ident" id="4021935">pkcs1v15HashInfo</span><span class="op" id="4021951">(</span><span class="ident" id="4021952">hash</span>&nbsp;<span class="ident" id="4021957">crypto</span><span class="op" id="4021963">.</span><span class="ident" id="4021964">Hash</span><span class="op" id="4021968">,</span>&nbsp;<span class="ident" id="4021970">inLen</span>&nbsp;<span class="builtintype" id="4021976">int</span><span class="op" id="4021979">)</span>&nbsp;<span class="op" id="4021981">(</span><span class="ident" id="4021982">hashLen</span>&nbsp;<span class="builtintype" id="4021990">int</span><span class="op" id="4021993">,</span>&nbsp;<span class="ident" id="4021995">prefix</span>&nbsp;<span class="op" id="4022002">[</span><span class="op" id="4022003">]</span><span class="builtintype" id="4022004">byte</span><span class="op" id="4022008">,</span>&nbsp;<span class="ident" id="4022010">err</span>&nbsp;<span class="builtintype" id="4022014">error</span><span class="op" id="4022019">)</span>&nbsp;<span class="op" id="4022021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4022024">//&nbsp;Special&nbsp;case:&nbsp;crypto.Hash(0)&nbsp;is&nbsp;used&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4022094">//&nbsp;signed&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4022115">if</span>&nbsp;<span class="ident" id="4022118">hash</span>&nbsp;<span class="op" id="4022123">==</span>&nbsp;<span class="num" id="4022126">0</span>&nbsp;<span class="op" id="4022128">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4022132">return</span>&nbsp;<span class="ident" id="4022139">inLen</span><span class="op" id="4022144">,</span>&nbsp;<span class="builtintype" id="4022146">nil</span><span class="op" id="4022149">,</span>&nbsp;<span class="builtintype" id="4022151">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4022156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4022160">hashLen</span>&nbsp;<span class="op" id="4022168">=</span>&nbsp;<span class="ident" id="4022170">hash</span><span class="op" id="4022174">.</span><span class="ident" id="4022175">Size</span><span class="op" id="4022179">(</span><span class="op" id="4022180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4022183">if</span>&nbsp;<span class="ident" id="4022186">inLen</span>&nbsp;<span class="op" id="4022192">!=</span>&nbsp;<span class="ident" id="4022195">hashLen</span>&nbsp;<span class="op" id="4022203">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4022207">return</span>&nbsp;<span class="num" id="4022214">0</span><span class="op" id="4022215">,</span>&nbsp;<span class="builtintype" id="4022217">nil</span><span class="op" id="4022220">,</span>&nbsp;<span class="ident" id="4022222">errors</span><span class="op" id="4022228">.</span><span class="ident" id="4022229">New</span><span class="op" id="4022232">(</span><span class="string" id="4022233">&#34;crypto/rsa:&nbsp;input&nbsp;must&nbsp;be&nbsp;hashed&nbsp;message&#34;</span><span class="op" id="4022275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4022278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4022281">prefix</span><span class="op" id="4022287">,</span>&nbsp;<span class="ident" id="4022289">ok</span>&nbsp;<span class="op" id="4022292">:=</span>&nbsp;<span class="ident" id="4022295">hashPrefixes</span><span class="op" id="4022307">[</span><span class="ident" id="4022308">hash</span><span class="op" id="4022312">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4022315">if</span>&nbsp;<span class="op" id="4022318">!</span><span class="ident" id="4022319">ok</span>&nbsp;<span class="op" id="4022322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4022326">return</span>&nbsp;<span class="num" id="4022333">0</span><span class="op" id="4022334">,</span>&nbsp;<span class="builtintype" id="4022336">nil</span><span class="op" id="4022339">,</span>&nbsp;<span class="ident" id="4022341">errors</span><span class="op" id="4022347">.</span><span class="ident" id="4022348">New</span><span class="op" id="4022351">(</span><span class="string" id="4022352">&#34;crypto/rsa:&nbsp;unsupported&nbsp;hash&nbsp;function&#34;</span><span class="op" id="4022391">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4022394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4022397">return</span><br>
<span class="lineno"></span><span class="op" id="4022404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4022407">//&nbsp;copyWithLeftPad&nbsp;copies&nbsp;src&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;dest,&nbsp;padding&nbsp;with&nbsp;zero&nbsp;bytes&nbsp;as</span><br>
<span class="lineno">285</span><span class="comment" id="4022484">//&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="4022495">func</span>&nbsp;<span class="ident" id="4022500">copyWithLeftPad</span><span class="op" id="4022515">(</span><span class="ident" id="4022516">dest</span><span class="op" id="4022520">,</span>&nbsp;<span class="ident" id="4022522">src</span>&nbsp;<span class="op" id="4022526">[</span><span class="op" id="4022527">]</span><span class="builtintype" id="4022528">byte</span><span class="op" id="4022532">)</span>&nbsp;<span class="op" id="4022534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4022537">numPaddingBytes</span>&nbsp;<span class="op" id="4022553">:=</span>&nbsp;<span class="builtinfunc" id="4022556">len</span><span class="op" id="4022559">(</span><span class="ident" id="4022560">dest</span><span class="op" id="4022564">)</span>&nbsp;<span class="op" id="4022566">-</span>&nbsp;<span class="builtinfunc" id="4022568">len</span><span class="op" id="4022571">(</span><span class="ident" id="4022572">src</span><span class="op" id="4022575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4022578">for</span>&nbsp;<span class="ident" id="4022582">i</span>&nbsp;<span class="op" id="4022584">:=</span>&nbsp;<span class="num" id="4022587">0</span><span class="op" id="4022588">;</span>&nbsp;<span class="ident" id="4022590">i</span>&nbsp;<span class="op" id="4022592">&lt;</span>&nbsp;<span class="ident" id="4022594">numPaddingBytes</span><span class="op" id="4022609">;</span>&nbsp;<span class="ident" id="4022611">i</span><span class="op" id="4022612">++</span>&nbsp;<span class="op" id="4022615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4022619">dest</span><span class="op" id="4022623">[</span><span class="ident" id="4022624">i</span><span class="op" id="4022625">]</span>&nbsp;<span class="op" id="4022627">=</span>&nbsp;<span class="num" id="4022629">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4022632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4022635">copy</span><span class="op" id="4022639">(</span><span class="ident" id="4022640">dest</span><span class="op" id="4022644">[</span><span class="ident" id="4022645">numPaddingBytes</span><span class="op" id="4022660">:</span><span class="op" id="4022661">]</span><span class="op" id="4022662">,</span>&nbsp;<span class="ident" id="4022664">src</span><span class="op" id="4022667">)</span><br>
<span class="lineno"></span><span class="op" id="4022669">}</span>
</div>
</body>
</html>
