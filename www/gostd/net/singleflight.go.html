<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html" class="current">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3160739">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3160795">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3160849">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3160900">package</span>&nbsp;<span class="ident" id="3160908">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3160913">import</span>&nbsp;<span class="string" id="3160920">&#34;sync&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3160928">//&nbsp;call&nbsp;is&nbsp;an&nbsp;in-flight&nbsp;or&nbsp;completed&nbsp;singleflight.Do&nbsp;call</span><br>
<span class="lineno">10</span><span class="keyword" id="3160986">type</span>&nbsp;<span class="ident" id="3160991">call</span>&nbsp;<span class="keyword" id="3160996">struct</span>&nbsp;<span class="op" id="3161003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3161006">wg</span>&nbsp;<span class="ident" id="3161009">sync</span><span class="op" id="3161013">.</span><span class="ident" id="3161014">WaitGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3161026">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;written&nbsp;once&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3161089">//&nbsp;and&nbsp;are&nbsp;only&nbsp;read&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3161140">val</span>&nbsp;<span class="keyword" id="3161144">interface</span><span class="op" id="3161153">{</span><span class="op" id="3161154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3161157">err</span>&nbsp;<span class="builtintype" id="3161161">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3161169">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;read&nbsp;and&nbsp;written&nbsp;with&nbsp;the&nbsp;singleflight</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3161229">//&nbsp;mutex&nbsp;held&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done,&nbsp;and&nbsp;are&nbsp;read&nbsp;but</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3161291">//&nbsp;not&nbsp;written&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3161336">dups</span>&nbsp;&nbsp;<span class="builtintype" id="3161342">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3161347">chans</span>&nbsp;<span class="op" id="3161353">[</span><span class="op" id="3161354">]</span><span class="keyword" id="3161355">chan</span><span class="op" id="3161359">&lt;-</span>&nbsp;<span class="ident" id="3161362">singleflightResult</span><br>
<span class="lineno"></span><span class="op" id="3161381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3161384">//&nbsp;singleflight&nbsp;represents&nbsp;a&nbsp;class&nbsp;of&nbsp;work&nbsp;and&nbsp;forms&nbsp;a&nbsp;namespace&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3161452">//&nbsp;which&nbsp;units&nbsp;of&nbsp;work&nbsp;can&nbsp;be&nbsp;executed&nbsp;with&nbsp;duplicate&nbsp;suppression.</span><br>
<span class="lineno"></span><span class="keyword" id="3161519">type</span>&nbsp;<span class="ident" id="3161524">singleflight</span>&nbsp;<span class="keyword" id="3161537">struct</span>&nbsp;<span class="op" id="3161544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3161547">mu</span>&nbsp;<span class="ident" id="3161550">sync</span><span class="op" id="3161554">.</span><span class="ident" id="3161555">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3161567">//&nbsp;protects&nbsp;m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3161582">m</span>&nbsp;&nbsp;<span class="keyword" id="3161585">map</span><span class="op" id="3161588">[</span><span class="builtintype" id="3161589">string</span><span class="op" id="3161595">]</span><span class="op" id="3161596">*</span><span class="ident" id="3161597">call</span>&nbsp;<span class="comment" id="3161602">//&nbsp;lazily&nbsp;initialized</span><br>
<span class="lineno">30</span><span class="op" id="3161624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3161627">//&nbsp;singleflightResult&nbsp;holds&nbsp;the&nbsp;results&nbsp;of&nbsp;Do,&nbsp;so&nbsp;they&nbsp;can&nbsp;be&nbsp;passed</span><br>
<span class="lineno"></span><span class="comment" id="3161696">//&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="3161713">type</span>&nbsp;<span class="ident" id="3161718">singleflightResult</span>&nbsp;<span class="keyword" id="3161737">struct</span>&nbsp;<span class="op" id="3161744">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3161747">v</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3161754">interface</span><span class="op" id="3161763">{</span><span class="op" id="3161764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3161767">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3161774">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3161781">shared</span>&nbsp;<span class="builtintype" id="3161788">bool</span><br>
<span class="lineno"></span><span class="op" id="3161793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="3161796">//&nbsp;Do&nbsp;executes&nbsp;and&nbsp;returns&nbsp;the&nbsp;results&nbsp;of&nbsp;the&nbsp;given&nbsp;function,&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3161865">//&nbsp;sure&nbsp;that&nbsp;only&nbsp;one&nbsp;execution&nbsp;is&nbsp;in-flight&nbsp;for&nbsp;a&nbsp;given&nbsp;key&nbsp;at&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3161931">//&nbsp;time.&nbsp;If&nbsp;a&nbsp;duplicate&nbsp;comes&nbsp;in,&nbsp;the&nbsp;duplicate&nbsp;caller&nbsp;waits&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3162000">//&nbsp;original&nbsp;to&nbsp;complete&nbsp;and&nbsp;receives&nbsp;the&nbsp;same&nbsp;results.</span><br>
<span class="lineno"></span><span class="comment" id="3162055">//&nbsp;The&nbsp;return&nbsp;value&nbsp;shared&nbsp;indicates&nbsp;whether&nbsp;v&nbsp;was&nbsp;given&nbsp;to&nbsp;multiple&nbsp;callers.</span><br>
<span class="lineno">45</span><span class="keyword" id="3162133">func</span>&nbsp;<span class="op" id="3162138">(</span><span class="ident" id="3162139">g</span>&nbsp;<span class="op" id="3162141">*</span><span class="ident" id="3162142">singleflight</span><span class="op" id="3162154">)</span>&nbsp;<span class="ident" id="3162156">Do</span><span class="op" id="3162158">(</span><span class="ident" id="3162159">key</span>&nbsp;<span class="builtintype" id="3162163">string</span><span class="op" id="3162169">,</span>&nbsp;<span class="ident" id="3162171">fn</span>&nbsp;<span class="keyword" id="3162174">func</span><span class="op" id="3162178">(</span><span class="op" id="3162179">)</span>&nbsp;<span class="op" id="3162181">(</span><span class="keyword" id="3162182">interface</span><span class="op" id="3162191">{</span><span class="op" id="3162192">}</span><span class="op" id="3162193">,</span>&nbsp;<span class="builtintype" id="3162195">error</span><span class="op" id="3162200">)</span><span class="op" id="3162201">)</span>&nbsp;<span class="op" id="3162203">(</span><span class="ident" id="3162204">v</span>&nbsp;<span class="keyword" id="3162206">interface</span><span class="op" id="3162215">{</span><span class="op" id="3162216">}</span><span class="op" id="3162217">,</span>&nbsp;<span class="ident" id="3162219">err</span>&nbsp;<span class="builtintype" id="3162223">error</span><span class="op" id="3162228">,</span>&nbsp;<span class="ident" id="3162230">shared</span>&nbsp;<span class="builtintype" id="3162237">bool</span><span class="op" id="3162241">)</span>&nbsp;<span class="op" id="3162243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162246">g</span><span class="op" id="3162247">.</span><span class="ident" id="3162248">mu</span><span class="op" id="3162250">.</span><span class="ident" id="3162251">Lock</span><span class="op" id="3162255">(</span><span class="op" id="3162256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3162259">if</span>&nbsp;<span class="ident" id="3162262">g</span><span class="op" id="3162263">.</span><span class="ident" id="3162264">m</span>&nbsp;<span class="op" id="3162266">==</span>&nbsp;<span class="ident" id="3162269">nil</span>&nbsp;<span class="op" id="3162273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162277">g</span><span class="op" id="3162278">.</span><span class="ident" id="3162279">m</span>&nbsp;<span class="op" id="3162281">=</span>&nbsp;<span class="builtinfunc" id="3162283">make</span><span class="op" id="3162287">(</span><span class="keyword" id="3162288">map</span><span class="op" id="3162291">[</span><span class="builtintype" id="3162292">string</span><span class="op" id="3162298">]</span><span class="op" id="3162299">*</span><span class="ident" id="3162300">call</span><span class="op" id="3162304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3162307">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3162310">if</span>&nbsp;<span class="ident" id="3162313">c</span><span class="op" id="3162314">,</span>&nbsp;<span class="ident" id="3162316">ok</span>&nbsp;<span class="op" id="3162319">:=</span>&nbsp;<span class="ident" id="3162322">g</span><span class="op" id="3162323">.</span><span class="ident" id="3162324">m</span><span class="op" id="3162325">[</span><span class="ident" id="3162326">key</span><span class="op" id="3162329">]</span><span class="op" id="3162330">;</span>&nbsp;<span class="ident" id="3162332">ok</span>&nbsp;<span class="op" id="3162335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162339">c</span><span class="op" id="3162340">.</span><span class="ident" id="3162341">dups</span><span class="op" id="3162345">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162350">g</span><span class="op" id="3162351">.</span><span class="ident" id="3162352">mu</span><span class="op" id="3162354">.</span><span class="ident" id="3162355">Unlock</span><span class="op" id="3162361">(</span><span class="op" id="3162362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162366">c</span><span class="op" id="3162367">.</span><span class="ident" id="3162368">wg</span><span class="op" id="3162370">.</span><span class="ident" id="3162371">Wait</span><span class="op" id="3162375">(</span><span class="op" id="3162376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3162380">return</span>&nbsp;<span class="ident" id="3162387">c</span><span class="op" id="3162388">.</span><span class="ident" id="3162389">val</span><span class="op" id="3162392">,</span>&nbsp;<span class="ident" id="3162394">c</span><span class="op" id="3162395">.</span><span class="ident" id="3162396">err</span><span class="op" id="3162399">,</span>&nbsp;<span class="builtintype" id="3162401">true</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3162407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162410">c</span>&nbsp;<span class="op" id="3162412">:=</span>&nbsp;<span class="builtinfunc" id="3162415">new</span><span class="op" id="3162418">(</span><span class="ident" id="3162419">call</span><span class="op" id="3162423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162426">c</span><span class="op" id="3162427">.</span><span class="ident" id="3162428">wg</span><span class="op" id="3162430">.</span><span class="ident" id="3162431">Add</span><span class="op" id="3162434">(</span><span class="num" id="3162435">1</span><span class="op" id="3162436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162439">g</span><span class="op" id="3162440">.</span><span class="ident" id="3162441">m</span><span class="op" id="3162442">[</span><span class="ident" id="3162443">key</span><span class="op" id="3162446">]</span>&nbsp;<span class="op" id="3162448">=</span>&nbsp;<span class="ident" id="3162450">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162453">g</span><span class="op" id="3162454">.</span><span class="ident" id="3162455">mu</span><span class="op" id="3162457">.</span><span class="ident" id="3162458">Unlock</span><span class="op" id="3162464">(</span><span class="op" id="3162465">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162469">g</span><span class="op" id="3162470">.</span><span class="ident" id="3162471">doCall</span><span class="op" id="3162477">(</span><span class="ident" id="3162478">c</span><span class="op" id="3162479">,</span>&nbsp;<span class="ident" id="3162481">key</span><span class="op" id="3162484">,</span>&nbsp;<span class="ident" id="3162486">fn</span><span class="op" id="3162488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3162491">return</span>&nbsp;<span class="ident" id="3162498">c</span><span class="op" id="3162499">.</span><span class="ident" id="3162500">val</span><span class="op" id="3162503">,</span>&nbsp;<span class="ident" id="3162505">c</span><span class="op" id="3162506">.</span><span class="ident" id="3162507">err</span><span class="op" id="3162510">,</span>&nbsp;<span class="ident" id="3162512">c</span><span class="op" id="3162513">.</span><span class="ident" id="3162514">dups</span>&nbsp;<span class="op" id="3162519">&gt;</span>&nbsp;<span class="num" id="3162521">0</span><br>
<span class="lineno"></span><span class="op" id="3162523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3162526">//&nbsp;DoChan&nbsp;is&nbsp;like&nbsp;Do&nbsp;but&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;will&nbsp;receive&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3162591">//&nbsp;results&nbsp;when&nbsp;they&nbsp;are&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3162623">func</span>&nbsp;<span class="op" id="3162628">(</span><span class="ident" id="3162629">g</span>&nbsp;<span class="op" id="3162631">*</span><span class="ident" id="3162632">singleflight</span><span class="op" id="3162644">)</span>&nbsp;<span class="ident" id="3162646">DoChan</span><span class="op" id="3162652">(</span><span class="ident" id="3162653">key</span>&nbsp;<span class="builtintype" id="3162657">string</span><span class="op" id="3162663">,</span>&nbsp;<span class="ident" id="3162665">fn</span>&nbsp;<span class="keyword" id="3162668">func</span><span class="op" id="3162672">(</span><span class="op" id="3162673">)</span>&nbsp;<span class="op" id="3162675">(</span><span class="keyword" id="3162676">interface</span><span class="op" id="3162685">{</span><span class="op" id="3162686">}</span><span class="op" id="3162687">,</span>&nbsp;<span class="builtintype" id="3162689">error</span><span class="op" id="3162694">)</span><span class="op" id="3162695">)</span>&nbsp;<span class="op" id="3162697">&lt;-</span><span class="keyword" id="3162699">chan</span>&nbsp;<span class="ident" id="3162704">singleflightResult</span>&nbsp;<span class="op" id="3162723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162726">ch</span>&nbsp;<span class="op" id="3162729">:=</span>&nbsp;<span class="builtinfunc" id="3162732">make</span><span class="op" id="3162736">(</span><span class="keyword" id="3162737">chan</span>&nbsp;<span class="ident" id="3162742">singleflightResult</span><span class="op" id="3162760">,</span>&nbsp;<span class="num" id="3162762">1</span><span class="op" id="3162763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162766">g</span><span class="op" id="3162767">.</span><span class="ident" id="3162768">mu</span><span class="op" id="3162770">.</span><span class="ident" id="3162771">Lock</span><span class="op" id="3162775">(</span><span class="op" id="3162776">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3162779">if</span>&nbsp;<span class="ident" id="3162782">g</span><span class="op" id="3162783">.</span><span class="ident" id="3162784">m</span>&nbsp;<span class="op" id="3162786">==</span>&nbsp;<span class="ident" id="3162789">nil</span>&nbsp;<span class="op" id="3162793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162797">g</span><span class="op" id="3162798">.</span><span class="ident" id="3162799">m</span>&nbsp;<span class="op" id="3162801">=</span>&nbsp;<span class="builtinfunc" id="3162803">make</span><span class="op" id="3162807">(</span><span class="keyword" id="3162808">map</span><span class="op" id="3162811">[</span><span class="builtintype" id="3162812">string</span><span class="op" id="3162818">]</span><span class="op" id="3162819">*</span><span class="ident" id="3162820">call</span><span class="op" id="3162824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3162827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3162830">if</span>&nbsp;<span class="ident" id="3162833">c</span><span class="op" id="3162834">,</span>&nbsp;<span class="ident" id="3162836">ok</span>&nbsp;<span class="op" id="3162839">:=</span>&nbsp;<span class="ident" id="3162842">g</span><span class="op" id="3162843">.</span><span class="ident" id="3162844">m</span><span class="op" id="3162845">[</span><span class="ident" id="3162846">key</span><span class="op" id="3162849">]</span><span class="op" id="3162850">;</span>&nbsp;<span class="ident" id="3162852">ok</span>&nbsp;<span class="op" id="3162855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162859">c</span><span class="op" id="3162860">.</span><span class="ident" id="3162861">dups</span><span class="op" id="3162865">++</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162870">c</span><span class="op" id="3162871">.</span><span class="ident" id="3162872">chans</span>&nbsp;<span class="op" id="3162878">=</span>&nbsp;<span class="builtinfunc" id="3162880">append</span><span class="op" id="3162886">(</span><span class="ident" id="3162887">c</span><span class="op" id="3162888">.</span><span class="ident" id="3162889">chans</span><span class="op" id="3162894">,</span>&nbsp;<span class="ident" id="3162896">ch</span><span class="op" id="3162898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162902">g</span><span class="op" id="3162903">.</span><span class="ident" id="3162904">mu</span><span class="op" id="3162906">.</span><span class="ident" id="3162907">Unlock</span><span class="op" id="3162913">(</span><span class="op" id="3162914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3162918">return</span>&nbsp;<span class="ident" id="3162925">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3162929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162932">c</span>&nbsp;<span class="op" id="3162934">:=</span>&nbsp;<span class="op" id="3162937">&amp;</span><span class="ident" id="3162938">call</span><span class="op" id="3162942">{</span><span class="ident" id="3162943">chans</span><span class="op" id="3162948">:</span>&nbsp;<span class="op" id="3162950">[</span><span class="op" id="3162951">]</span><span class="keyword" id="3162952">chan</span><span class="op" id="3162956">&lt;-</span>&nbsp;<span class="ident" id="3162959">singleflightResult</span><span class="op" id="3162977">{</span><span class="ident" id="3162978">ch</span><span class="op" id="3162980">}</span><span class="op" id="3162981">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162984">c</span><span class="op" id="3162985">.</span><span class="ident" id="3162986">wg</span><span class="op" id="3162988">.</span><span class="ident" id="3162989">Add</span><span class="op" id="3162992">(</span><span class="num" id="3162993">1</span><span class="op" id="3162994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3162997">g</span><span class="op" id="3162998">.</span><span class="ident" id="3162999">m</span><span class="op" id="3163000">[</span><span class="ident" id="3163001">key</span><span class="op" id="3163004">]</span>&nbsp;<span class="op" id="3163006">=</span>&nbsp;<span class="ident" id="3163008">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3163011">g</span><span class="op" id="3163012">.</span><span class="ident" id="3163013">mu</span><span class="op" id="3163015">.</span><span class="ident" id="3163016">Unlock</span><span class="op" id="3163022">(</span><span class="op" id="3163023">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3163027">go</span>&nbsp;<span class="ident" id="3163030">g</span><span class="op" id="3163031">.</span><span class="ident" id="3163032">doCall</span><span class="op" id="3163038">(</span><span class="ident" id="3163039">c</span><span class="op" id="3163040">,</span>&nbsp;<span class="ident" id="3163042">key</span><span class="op" id="3163045">,</span>&nbsp;<span class="ident" id="3163047">fn</span><span class="op" id="3163049">)</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3163053">return</span>&nbsp;<span class="ident" id="3163060">ch</span><br>
<span class="lineno"></span><span class="op" id="3163063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3163066">//&nbsp;doCall&nbsp;handles&nbsp;the&nbsp;single&nbsp;call&nbsp;for&nbsp;a&nbsp;key.</span><br>
<span class="lineno">90</span><span class="keyword" id="3163111">func</span>&nbsp;<span class="op" id="3163116">(</span><span class="ident" id="3163117">g</span>&nbsp;<span class="op" id="3163119">*</span><span class="ident" id="3163120">singleflight</span><span class="op" id="3163132">)</span>&nbsp;<span class="ident" id="3163134">doCall</span><span class="op" id="3163140">(</span><span class="ident" id="3163141">c</span>&nbsp;<span class="op" id="3163143">*</span><span class="ident" id="3163144">call</span><span class="op" id="3163148">,</span>&nbsp;<span class="ident" id="3163150">key</span>&nbsp;<span class="builtintype" id="3163154">string</span><span class="op" id="3163160">,</span>&nbsp;<span class="ident" id="3163162">fn</span>&nbsp;<span class="keyword" id="3163165">func</span><span class="op" id="3163169">(</span><span class="op" id="3163170">)</span>&nbsp;<span class="op" id="3163172">(</span><span class="keyword" id="3163173">interface</span><span class="op" id="3163182">{</span><span class="op" id="3163183">}</span><span class="op" id="3163184">,</span>&nbsp;<span class="builtintype" id="3163186">error</span><span class="op" id="3163191">)</span><span class="op" id="3163192">)</span>&nbsp;<span class="op" id="3163194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3163197">c</span><span class="op" id="3163198">.</span><span class="ident" id="3163199">val</span><span class="op" id="3163202">,</span>&nbsp;<span class="ident" id="3163204">c</span><span class="op" id="3163205">.</span><span class="ident" id="3163206">err</span>&nbsp;<span class="op" id="3163210">=</span>&nbsp;<span class="ident" id="3163212">fn</span><span class="op" id="3163214">(</span><span class="op" id="3163215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3163218">c</span><span class="op" id="3163219">.</span><span class="ident" id="3163220">wg</span><span class="op" id="3163222">.</span><span class="ident" id="3163223">Done</span><span class="op" id="3163227">(</span><span class="op" id="3163228">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3163232">g</span><span class="op" id="3163233">.</span><span class="ident" id="3163234">mu</span><span class="op" id="3163236">.</span><span class="ident" id="3163237">Lock</span><span class="op" id="3163241">(</span><span class="op" id="3163242">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3163245">delete</span><span class="op" id="3163251">(</span><span class="ident" id="3163252">g</span><span class="op" id="3163253">.</span><span class="ident" id="3163254">m</span><span class="op" id="3163255">,</span>&nbsp;<span class="ident" id="3163257">key</span><span class="op" id="3163260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3163263">for</span>&nbsp;<span class="ident" id="3163267">_</span><span class="op" id="3163268">,</span>&nbsp;<span class="ident" id="3163270">ch</span>&nbsp;<span class="op" id="3163273">:=</span>&nbsp;<span class="keyword" id="3163276">range</span>&nbsp;<span class="ident" id="3163282">c</span><span class="op" id="3163283">.</span><span class="ident" id="3163284">chans</span>&nbsp;<span class="op" id="3163290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3163294">ch</span>&nbsp;<span class="op" id="3163297">&lt;-</span>&nbsp;<span class="ident" id="3163300">singleflightResult</span><span class="op" id="3163318">{</span><span class="ident" id="3163319">c</span><span class="op" id="3163320">.</span><span class="ident" id="3163321">val</span><span class="op" id="3163324">,</span>&nbsp;<span class="ident" id="3163326">c</span><span class="op" id="3163327">.</span><span class="ident" id="3163328">err</span><span class="op" id="3163331">,</span>&nbsp;<span class="ident" id="3163333">c</span><span class="op" id="3163334">.</span><span class="ident" id="3163335">dups</span>&nbsp;<span class="op" id="3163340">&gt;</span>&nbsp;<span class="num" id="3163342">0</span><span class="op" id="3163343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3163346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3163349">g</span><span class="op" id="3163350">.</span><span class="ident" id="3163351">mu</span><span class="op" id="3163353">.</span><span class="ident" id="3163354">Unlock</span><span class="op" id="3163360">(</span><span class="op" id="3163361">)</span><br>
<span class="lineno">100</span><span class="op" id="3163363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3163366">//&nbsp;Forget&nbsp;tells&nbsp;the&nbsp;singleflight&nbsp;to&nbsp;forget&nbsp;about&nbsp;a&nbsp;key.&nbsp;&nbsp;Future&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3163436">//&nbsp;to&nbsp;Do&nbsp;for&nbsp;this&nbsp;key&nbsp;will&nbsp;call&nbsp;the&nbsp;function&nbsp;rather&nbsp;than&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3163505">//&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;complete.</span><br>
<span class="lineno">105</span><span class="keyword" id="3163537">func</span>&nbsp;<span class="op" id="3163542">(</span><span class="ident" id="3163543">g</span>&nbsp;<span class="op" id="3163545">*</span><span class="ident" id="3163546">singleflight</span><span class="op" id="3163558">)</span>&nbsp;<span class="ident" id="3163560">Forget</span><span class="op" id="3163566">(</span><span class="ident" id="3163567">key</span>&nbsp;<span class="builtintype" id="3163571">string</span><span class="op" id="3163577">)</span>&nbsp;<span class="op" id="3163579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3163582">g</span><span class="op" id="3163583">.</span><span class="ident" id="3163584">mu</span><span class="op" id="3163586">.</span><span class="ident" id="3163587">Lock</span><span class="op" id="3163591">(</span><span class="op" id="3163592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3163595">delete</span><span class="op" id="3163601">(</span><span class="ident" id="3163602">g</span><span class="op" id="3163603">.</span><span class="ident" id="3163604">m</span><span class="op" id="3163605">,</span>&nbsp;<span class="ident" id="3163607">key</span><span class="op" id="3163610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3163613">g</span><span class="op" id="3163614">.</span><span class="ident" id="3163615">mu</span><span class="op" id="3163617">.</span><span class="ident" id="3163618">Unlock</span><span class="op" id="3163624">(</span><span class="op" id="3163625">)</span><br>
<span class="lineno"></span><span class="op" id="3163627">}</span>
</div>
</body>
</html>
