<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7276239">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7276294">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7276348">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7276399">package</span>&nbsp;<span class="ident" id="7276407">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7276413">import</span>&nbsp;<span class="op" id="7276420">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7276423">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7276432">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7276439">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7276448">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7276463">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7276469">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7276482">&#34;math/rand&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7276495">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7276501">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7276512">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="7276522">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="7276525">//&nbsp;TestDecodeProgressive&nbsp;tests&nbsp;that&nbsp;decoding&nbsp;the&nbsp;baseline&nbsp;and&nbsp;progressive</span><br>
<span class="lineno"></span><span class="comment" id="7276599">//&nbsp;versions&nbsp;of&nbsp;the&nbsp;same&nbsp;image&nbsp;result&nbsp;in&nbsp;exactly&nbsp;the&nbsp;same&nbsp;pixel&nbsp;data,&nbsp;in&nbsp;YCbCr</span><br>
<span class="lineno"></span><span class="comment" id="7276677">//&nbsp;space&nbsp;for&nbsp;color&nbsp;images,&nbsp;and&nbsp;Y&nbsp;space&nbsp;for&nbsp;grayscale&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="7276738">func</span>&nbsp;<span class="ident" id="7276743">TestDecodeProgressive</span><span class="op" id="7276764">(</span><span class="ident" id="7276765">t</span>&nbsp;<span class="op" id="7276767">*</span><span class="ident" id="7276768">testing</span><span class="op" id="7276775">.</span><span class="ident" id="7276776">T</span><span class="op" id="7276777">)</span>&nbsp;<span class="op" id="7276779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7276782">testCases</span>&nbsp;<span class="op" id="7276792">:=</span>&nbsp;<span class="op" id="7276795">[</span><span class="op" id="7276796">]</span><span class="builtintype" id="7276797">string</span><span class="op" id="7276803">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7276807">&#34;../testdata/video-001&#34;</span><span class="op" id="7276830">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7276834">&#34;../testdata/video-001.q50.420&#34;</span><span class="op" id="7276865">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7276869">&#34;../testdata/video-001.q50.422&#34;</span><span class="op" id="7276900">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7276904">&#34;../testdata/video-001.q50.440&#34;</span><span class="op" id="7276935">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7276939">&#34;../testdata/video-001.q50.444&#34;</span><span class="op" id="7276970">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7276974">&#34;../testdata/video-005.gray.q50&#34;</span><span class="op" id="7277006">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7277010">&#34;../testdata/video-005.gray.q50.2x2&#34;</span><span class="op" id="7277046">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7277050">&#34;../testdata/video-001.separate.dc.progression&#34;</span><span class="op" id="7277097">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7277100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277103">for</span>&nbsp;<span class="ident" id="7277107">_</span><span class="op" id="7277108">,</span>&nbsp;<span class="ident" id="7277110">tc</span>&nbsp;<span class="op" id="7277113">:=</span>&nbsp;<span class="keyword" id="7277116">range</span>&nbsp;<span class="ident" id="7277122">testCases</span>&nbsp;<span class="op" id="7277132">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277136">m0</span><span class="op" id="7277138">,</span>&nbsp;<span class="ident" id="7277140">err</span>&nbsp;<span class="op" id="7277144">:=</span>&nbsp;<span class="ident" id="7277147">decodeFile</span><span class="op" id="7277157">(</span><span class="ident" id="7277158">tc</span>&nbsp;<span class="op" id="7277161">+</span>&nbsp;<span class="string" id="7277163">&#34;.jpeg&#34;</span><span class="op" id="7277170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277174">if</span>&nbsp;<span class="ident" id="7277177">err</span>&nbsp;<span class="op" id="7277181">!=</span>&nbsp;<span class="ident" id="7277184">nil</span>&nbsp;<span class="op" id="7277188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277193">t</span><span class="op" id="7277194">.</span><span class="ident" id="7277195">Errorf</span><span class="op" id="7277201">(</span><span class="string" id="7277202">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7277210">,</span>&nbsp;<span class="ident" id="7277212">tc</span><span class="op" id="7277214">+</span><span class="string" id="7277215">&#34;.jpeg&#34;</span><span class="op" id="7277222">,</span>&nbsp;<span class="ident" id="7277224">err</span><span class="op" id="7277227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277232">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7277243">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277247">m1</span><span class="op" id="7277249">,</span>&nbsp;<span class="ident" id="7277251">err</span>&nbsp;<span class="op" id="7277255">:=</span>&nbsp;<span class="ident" id="7277258">decodeFile</span><span class="op" id="7277268">(</span><span class="ident" id="7277269">tc</span>&nbsp;<span class="op" id="7277272">+</span>&nbsp;<span class="string" id="7277274">&#34;.progressive.jpeg&#34;</span><span class="op" id="7277293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277297">if</span>&nbsp;<span class="ident" id="7277300">err</span>&nbsp;<span class="op" id="7277304">!=</span>&nbsp;<span class="ident" id="7277307">nil</span>&nbsp;<span class="op" id="7277311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277316">t</span><span class="op" id="7277317">.</span><span class="ident" id="7277318">Errorf</span><span class="op" id="7277324">(</span><span class="string" id="7277325">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7277333">,</span>&nbsp;<span class="ident" id="7277335">tc</span><span class="op" id="7277337">+</span><span class="string" id="7277338">&#34;.progressive.jpeg&#34;</span><span class="op" id="7277357">,</span>&nbsp;<span class="ident" id="7277359">err</span><span class="op" id="7277362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277367">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7277378">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277382">if</span>&nbsp;<span class="ident" id="7277385">m0</span><span class="op" id="7277387">.</span><span class="ident" id="7277388">Bounds</span><span class="op" id="7277394">(</span><span class="op" id="7277395">)</span>&nbsp;<span class="op" id="7277397">!=</span>&nbsp;<span class="ident" id="7277400">m1</span><span class="op" id="7277402">.</span><span class="ident" id="7277403">Bounds</span><span class="op" id="7277409">(</span><span class="op" id="7277410">)</span>&nbsp;<span class="op" id="7277412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277417">t</span><span class="op" id="7277418">.</span><span class="ident" id="7277419">Errorf</span><span class="op" id="7277425">(</span><span class="string" id="7277426">&#34;%s:&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7277456">,</span>&nbsp;<span class="ident" id="7277458">tc</span><span class="op" id="7277460">,</span>&nbsp;<span class="ident" id="7277462">m0</span><span class="op" id="7277464">.</span><span class="ident" id="7277465">Bounds</span><span class="op" id="7277471">(</span><span class="op" id="7277472">)</span><span class="op" id="7277473">,</span>&nbsp;<span class="ident" id="7277475">m1</span><span class="op" id="7277477">.</span><span class="ident" id="7277478">Bounds</span><span class="op" id="7277484">(</span><span class="op" id="7277485">)</span><span class="op" id="7277486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277491">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7277502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7277506">//&nbsp;All&nbsp;of&nbsp;the&nbsp;video-*.jpeg&nbsp;files&nbsp;are&nbsp;150x103.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277554">if</span>&nbsp;<span class="ident" id="7277557">m0</span><span class="op" id="7277559">.</span><span class="ident" id="7277560">Bounds</span><span class="op" id="7277566">(</span><span class="op" id="7277567">)</span>&nbsp;<span class="op" id="7277569">!=</span>&nbsp;<span class="ident" id="7277572">image</span><span class="op" id="7277577">.</span><span class="ident" id="7277578">Rect</span><span class="op" id="7277582">(</span><span class="num" id="7277583">0</span><span class="op" id="7277584">,</span>&nbsp;<span class="num" id="7277586">0</span><span class="op" id="7277587">,</span>&nbsp;<span class="num" id="7277589">150</span><span class="op" id="7277592">,</span>&nbsp;<span class="num" id="7277594">103</span><span class="op" id="7277597">)</span>&nbsp;<span class="op" id="7277599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277604">t</span><span class="op" id="7277605">.</span><span class="ident" id="7277606">Errorf</span><span class="op" id="7277612">(</span><span class="string" id="7277613">&#34;%s:&nbsp;bad&nbsp;bounds:&nbsp;%v&#34;</span><span class="op" id="7277633">,</span>&nbsp;<span class="ident" id="7277635">tc</span><span class="op" id="7277637">,</span>&nbsp;<span class="ident" id="7277639">m0</span><span class="op" id="7277641">.</span><span class="ident" id="7277642">Bounds</span><span class="op" id="7277648">(</span><span class="op" id="7277649">)</span><span class="op" id="7277650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277655">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7277666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277671">switch</span>&nbsp;<span class="ident" id="7277678">m0</span>&nbsp;<span class="op" id="7277681">:=</span>&nbsp;<span class="ident" id="7277684">m0</span><span class="op" id="7277686">.</span><span class="op" id="7277687">(</span><span class="keyword" id="7277688">type</span><span class="op" id="7277692">)</span>&nbsp;<span class="op" id="7277694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277698">case</span>&nbsp;<span class="op" id="7277703">*</span><span class="ident" id="7277704">image</span><span class="op" id="7277709">.</span><span class="ident" id="7277710">YCbCr</span><span class="op" id="7277715">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277720">m1</span>&nbsp;<span class="op" id="7277723">:=</span>&nbsp;<span class="ident" id="7277726">m1</span><span class="op" id="7277728">.</span><span class="op" id="7277729">(</span><span class="op" id="7277730">*</span><span class="ident" id="7277731">image</span><span class="op" id="7277736">.</span><span class="ident" id="7277737">YCbCr</span><span class="op" id="7277742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277747">if</span>&nbsp;<span class="ident" id="7277750">err</span>&nbsp;<span class="op" id="7277754">:=</span>&nbsp;<span class="ident" id="7277757">check</span><span class="op" id="7277762">(</span><span class="ident" id="7277763">m0</span><span class="op" id="7277765">.</span><span class="ident" id="7277766">Bounds</span><span class="op" id="7277772">(</span><span class="op" id="7277773">)</span><span class="op" id="7277774">,</span>&nbsp;<span class="ident" id="7277776">m0</span><span class="op" id="7277778">.</span><span class="ident" id="7277779">Y</span><span class="op" id="7277780">,</span>&nbsp;<span class="ident" id="7277782">m1</span><span class="op" id="7277784">.</span><span class="ident" id="7277785">Y</span><span class="op" id="7277786">,</span>&nbsp;<span class="ident" id="7277788">m0</span><span class="op" id="7277790">.</span><span class="ident" id="7277791">YStride</span><span class="op" id="7277798">,</span>&nbsp;<span class="ident" id="7277800">m1</span><span class="op" id="7277802">.</span><span class="ident" id="7277803">YStride</span><span class="op" id="7277810">)</span><span class="op" id="7277811">;</span>&nbsp;<span class="ident" id="7277813">err</span>&nbsp;<span class="op" id="7277817">!=</span>&nbsp;<span class="ident" id="7277820">nil</span>&nbsp;<span class="op" id="7277824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277830">t</span><span class="op" id="7277831">.</span><span class="ident" id="7277832">Errorf</span><span class="op" id="7277838">(</span><span class="string" id="7277839">&#34;%s&nbsp;(Y):&nbsp;%v&#34;</span><span class="op" id="7277851">,</span>&nbsp;<span class="ident" id="7277853">tc</span><span class="op" id="7277855">,</span>&nbsp;<span class="ident" id="7277857">err</span><span class="op" id="7277860">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277866">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7277878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7277883">if</span>&nbsp;<span class="ident" id="7277886">err</span>&nbsp;<span class="op" id="7277890">:=</span>&nbsp;<span class="ident" id="7277893">check</span><span class="op" id="7277898">(</span><span class="ident" id="7277899">m0</span><span class="op" id="7277901">.</span><span class="ident" id="7277902">Bounds</span><span class="op" id="7277908">(</span><span class="op" id="7277909">)</span><span class="op" id="7277910">,</span>&nbsp;<span class="ident" id="7277912">m0</span><span class="op" id="7277914">.</span><span class="ident" id="7277915">Cb</span><span class="op" id="7277917">,</span>&nbsp;<span class="ident" id="7277919">m1</span><span class="op" id="7277921">.</span><span class="ident" id="7277922">Cb</span><span class="op" id="7277924">,</span>&nbsp;<span class="ident" id="7277926">m0</span><span class="op" id="7277928">.</span><span class="ident" id="7277929">CStride</span><span class="op" id="7277936">,</span>&nbsp;<span class="ident" id="7277938">m1</span><span class="op" id="7277940">.</span><span class="ident" id="7277941">CStride</span><span class="op" id="7277948">)</span><span class="op" id="7277949">;</span>&nbsp;<span class="ident" id="7277951">err</span>&nbsp;<span class="op" id="7277955">!=</span>&nbsp;<span class="ident" id="7277958">nil</span>&nbsp;<span class="op" id="7277962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7277968">t</span><span class="op" id="7277969">.</span><span class="ident" id="7277970">Errorf</span><span class="op" id="7277976">(</span><span class="string" id="7277977">&#34;%s&nbsp;(Cb):&nbsp;%v&#34;</span><span class="op" id="7277990">,</span>&nbsp;<span class="ident" id="7277992">tc</span><span class="op" id="7277994">,</span>&nbsp;<span class="ident" id="7277996">err</span><span class="op" id="7277999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278005">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7278017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278022">if</span>&nbsp;<span class="ident" id="7278025">err</span>&nbsp;<span class="op" id="7278029">:=</span>&nbsp;<span class="ident" id="7278032">check</span><span class="op" id="7278037">(</span><span class="ident" id="7278038">m0</span><span class="op" id="7278040">.</span><span class="ident" id="7278041">Bounds</span><span class="op" id="7278047">(</span><span class="op" id="7278048">)</span><span class="op" id="7278049">,</span>&nbsp;<span class="ident" id="7278051">m0</span><span class="op" id="7278053">.</span><span class="ident" id="7278054">Cr</span><span class="op" id="7278056">,</span>&nbsp;<span class="ident" id="7278058">m1</span><span class="op" id="7278060">.</span><span class="ident" id="7278061">Cr</span><span class="op" id="7278063">,</span>&nbsp;<span class="ident" id="7278065">m0</span><span class="op" id="7278067">.</span><span class="ident" id="7278068">CStride</span><span class="op" id="7278075">,</span>&nbsp;<span class="ident" id="7278077">m1</span><span class="op" id="7278079">.</span><span class="ident" id="7278080">CStride</span><span class="op" id="7278087">)</span><span class="op" id="7278088">;</span>&nbsp;<span class="ident" id="7278090">err</span>&nbsp;<span class="op" id="7278094">!=</span>&nbsp;<span class="ident" id="7278097">nil</span>&nbsp;<span class="op" id="7278101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278107">t</span><span class="op" id="7278108">.</span><span class="ident" id="7278109">Errorf</span><span class="op" id="7278115">(</span><span class="string" id="7278116">&#34;%s&nbsp;(Cr):&nbsp;%v&#34;</span><span class="op" id="7278129">,</span>&nbsp;<span class="ident" id="7278131">tc</span><span class="op" id="7278133">,</span>&nbsp;<span class="ident" id="7278135">err</span><span class="op" id="7278138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278144">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7278156">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278160">case</span>&nbsp;<span class="op" id="7278165">*</span><span class="ident" id="7278166">image</span><span class="op" id="7278171">.</span><span class="ident" id="7278172">Gray</span><span class="op" id="7278176">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278181">m1</span>&nbsp;<span class="op" id="7278184">:=</span>&nbsp;<span class="ident" id="7278187">m1</span><span class="op" id="7278189">.</span><span class="op" id="7278190">(</span><span class="op" id="7278191">*</span><span class="ident" id="7278192">image</span><span class="op" id="7278197">.</span><span class="ident" id="7278198">Gray</span><span class="op" id="7278202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278207">if</span>&nbsp;<span class="ident" id="7278210">err</span>&nbsp;<span class="op" id="7278214">:=</span>&nbsp;<span class="ident" id="7278217">check</span><span class="op" id="7278222">(</span><span class="ident" id="7278223">m0</span><span class="op" id="7278225">.</span><span class="ident" id="7278226">Bounds</span><span class="op" id="7278232">(</span><span class="op" id="7278233">)</span><span class="op" id="7278234">,</span>&nbsp;<span class="ident" id="7278236">m0</span><span class="op" id="7278238">.</span><span class="ident" id="7278239">Pix</span><span class="op" id="7278242">,</span>&nbsp;<span class="ident" id="7278244">m1</span><span class="op" id="7278246">.</span><span class="ident" id="7278247">Pix</span><span class="op" id="7278250">,</span>&nbsp;<span class="ident" id="7278252">m0</span><span class="op" id="7278254">.</span><span class="ident" id="7278255">Stride</span><span class="op" id="7278261">,</span>&nbsp;<span class="ident" id="7278263">m1</span><span class="op" id="7278265">.</span><span class="ident" id="7278266">Stride</span><span class="op" id="7278272">)</span><span class="op" id="7278273">;</span>&nbsp;<span class="ident" id="7278275">err</span>&nbsp;<span class="op" id="7278279">!=</span>&nbsp;<span class="ident" id="7278282">nil</span>&nbsp;<span class="op" id="7278286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278292">t</span><span class="op" id="7278293">.</span><span class="ident" id="7278294">Errorf</span><span class="op" id="7278300">(</span><span class="string" id="7278301">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7278309">,</span>&nbsp;<span class="ident" id="7278311">tc</span><span class="op" id="7278313">,</span>&nbsp;<span class="ident" id="7278315">err</span><span class="op" id="7278318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278324">continue</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7278336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278340">default</span><span class="op" id="7278347">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278352">t</span><span class="op" id="7278353">.</span><span class="ident" id="7278354">Errorf</span><span class="op" id="7278360">(</span><span class="string" id="7278361">&#34;%s:&nbsp;unexpected&nbsp;image&nbsp;type&nbsp;%T&#34;</span><span class="op" id="7278391">,</span>&nbsp;<span class="ident" id="7278393">tc</span><span class="op" id="7278395">,</span>&nbsp;<span class="ident" id="7278397">m0</span><span class="op" id="7278399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278404">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7278415">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7278418">}</span><br>
<span class="lineno"></span><span class="op" id="7278420">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7278423">func</span>&nbsp;<span class="ident" id="7278428">decodeFile</span><span class="op" id="7278438">(</span><span class="ident" id="7278439">filename</span>&nbsp;<span class="builtintype" id="7278448">string</span><span class="op" id="7278454">)</span>&nbsp;<span class="op" id="7278456">(</span><span class="ident" id="7278457">image</span><span class="op" id="7278462">.</span><span class="ident" id="7278463">Image</span><span class="op" id="7278468">,</span>&nbsp;<span class="builtintype" id="7278470">error</span><span class="op" id="7278475">)</span>&nbsp;<span class="op" id="7278477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278480">f</span><span class="op" id="7278481">,</span>&nbsp;<span class="ident" id="7278483">err</span>&nbsp;<span class="op" id="7278487">:=</span>&nbsp;<span class="ident" id="7278490">os</span><span class="op" id="7278492">.</span><span class="ident" id="7278493">Open</span><span class="op" id="7278497">(</span><span class="ident" id="7278498">filename</span><span class="op" id="7278506">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278509">if</span>&nbsp;<span class="ident" id="7278512">err</span>&nbsp;<span class="op" id="7278516">!=</span>&nbsp;<span class="ident" id="7278519">nil</span>&nbsp;<span class="op" id="7278523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278527">return</span>&nbsp;<span class="ident" id="7278534">nil</span><span class="op" id="7278537">,</span>&nbsp;<span class="ident" id="7278539">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7278544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278547">defer</span>&nbsp;<span class="ident" id="7278553">f</span><span class="op" id="7278554">.</span><span class="ident" id="7278555">Close</span><span class="op" id="7278560">(</span><span class="op" id="7278561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278564">return</span>&nbsp;<span class="ident" id="7278571">Decode</span><span class="op" id="7278577">(</span><span class="ident" id="7278578">f</span><span class="op" id="7278579">)</span><br>
<span class="lineno">90</span><span class="op" id="7278581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7278584">type</span>&nbsp;<span class="ident" id="7278589">eofReader</span>&nbsp;<span class="keyword" id="7278599">struct</span>&nbsp;<span class="op" id="7278606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278609">data</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7278618">[</span><span class="op" id="7278619">]</span><span class="builtintype" id="7278620">byte</span>&nbsp;<span class="comment" id="7278625">//&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;without&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278659">dataEOF</span>&nbsp;&nbsp;<span class="op" id="7278668">[</span><span class="op" id="7278669">]</span><span class="builtintype" id="7278670">byte</span>&nbsp;<span class="comment" id="7278675">//&nbsp;then&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;with&nbsp;EOF&nbsp;on&nbsp;last&nbsp;chunk</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278725">lenAtEOF</span>&nbsp;<span class="builtintype" id="7278734">int</span><br>
<span class="lineno"></span><span class="op" id="7278738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7278741">func</span>&nbsp;<span class="op" id="7278746">(</span><span class="ident" id="7278747">r</span>&nbsp;<span class="op" id="7278749">*</span><span class="ident" id="7278750">eofReader</span><span class="op" id="7278759">)</span>&nbsp;<span class="ident" id="7278761">Read</span><span class="op" id="7278765">(</span><span class="ident" id="7278766">b</span>&nbsp;<span class="op" id="7278768">[</span><span class="op" id="7278769">]</span><span class="builtintype" id="7278770">byte</span><span class="op" id="7278774">)</span>&nbsp;<span class="op" id="7278776">(</span><span class="ident" id="7278777">n</span>&nbsp;<span class="builtintype" id="7278779">int</span><span class="op" id="7278782">,</span>&nbsp;<span class="ident" id="7278784">err</span>&nbsp;<span class="builtintype" id="7278788">error</span><span class="op" id="7278793">)</span>&nbsp;<span class="op" id="7278795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278798">if</span>&nbsp;<span class="builtinfunc" id="7278801">len</span><span class="op" id="7278804">(</span><span class="ident" id="7278805">r</span><span class="op" id="7278806">.</span><span class="ident" id="7278807">data</span><span class="op" id="7278811">)</span>&nbsp;<span class="op" id="7278813">&gt;</span>&nbsp;<span class="num" id="7278815">0</span>&nbsp;<span class="op" id="7278817">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278821">n</span>&nbsp;<span class="op" id="7278823">=</span>&nbsp;<span class="builtinfunc" id="7278825">copy</span><span class="op" id="7278829">(</span><span class="ident" id="7278830">b</span><span class="op" id="7278831">,</span>&nbsp;<span class="ident" id="7278833">r</span><span class="op" id="7278834">.</span><span class="ident" id="7278835">data</span><span class="op" id="7278839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278843">r</span><span class="op" id="7278844">.</span><span class="ident" id="7278845">data</span>&nbsp;<span class="op" id="7278850">=</span>&nbsp;<span class="ident" id="7278852">r</span><span class="op" id="7278853">.</span><span class="ident" id="7278854">data</span><span class="op" id="7278858">[</span><span class="ident" id="7278859">n</span><span class="op" id="7278860">:</span><span class="op" id="7278861">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7278864">}</span>&nbsp;<span class="keyword" id="7278866">else</span>&nbsp;<span class="op" id="7278871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278875">n</span>&nbsp;<span class="op" id="7278877">=</span>&nbsp;<span class="builtinfunc" id="7278879">copy</span><span class="op" id="7278883">(</span><span class="ident" id="7278884">b</span><span class="op" id="7278885">,</span>&nbsp;<span class="ident" id="7278887">r</span><span class="op" id="7278888">.</span><span class="ident" id="7278889">dataEOF</span><span class="op" id="7278896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278900">r</span><span class="op" id="7278901">.</span><span class="ident" id="7278902">dataEOF</span>&nbsp;<span class="op" id="7278910">=</span>&nbsp;<span class="ident" id="7278912">r</span><span class="op" id="7278913">.</span><span class="ident" id="7278914">dataEOF</span><span class="op" id="7278921">[</span><span class="ident" id="7278922">n</span><span class="op" id="7278923">:</span><span class="op" id="7278924">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278928">if</span>&nbsp;<span class="builtinfunc" id="7278931">len</span><span class="op" id="7278934">(</span><span class="ident" id="7278935">r</span><span class="op" id="7278936">.</span><span class="ident" id="7278937">dataEOF</span><span class="op" id="7278944">)</span>&nbsp;<span class="op" id="7278946">==</span>&nbsp;<span class="num" id="7278949">0</span>&nbsp;<span class="op" id="7278951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278956">err</span>&nbsp;<span class="op" id="7278960">=</span>&nbsp;<span class="ident" id="7278962">io</span><span class="op" id="7278964">.</span><span class="ident" id="7278965">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7278972">if</span>&nbsp;<span class="ident" id="7278975">r</span><span class="op" id="7278976">.</span><span class="ident" id="7278977">lenAtEOF</span>&nbsp;<span class="op" id="7278986">==</span>&nbsp;<span class="op" id="7278989">-</span><span class="num" id="7278990">1</span>&nbsp;<span class="op" id="7278992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7278998">r</span><span class="op" id="7278999">.</span><span class="ident" id="7279000">lenAtEOF</span>&nbsp;<span class="op" id="7279009">=</span>&nbsp;<span class="ident" id="7279011">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279016">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279026">return</span><br>
<span class="lineno"></span><span class="op" id="7279033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="7279036">func</span>&nbsp;<span class="ident" id="7279041">TestDecodeEOF</span><span class="op" id="7279054">(</span><span class="ident" id="7279055">t</span>&nbsp;<span class="op" id="7279057">*</span><span class="ident" id="7279058">testing</span><span class="op" id="7279065">.</span><span class="ident" id="7279066">T</span><span class="op" id="7279067">)</span>&nbsp;<span class="op" id="7279069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7279072">//&nbsp;Check&nbsp;that&nbsp;if&nbsp;reader&nbsp;returns&nbsp;final&nbsp;data&nbsp;and&nbsp;EOF&nbsp;at&nbsp;same&nbsp;time,&nbsp;jpeg&nbsp;handles&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279155">data</span><span class="op" id="7279159">,</span>&nbsp;<span class="ident" id="7279161">err</span>&nbsp;<span class="op" id="7279165">:=</span>&nbsp;<span class="ident" id="7279168">ioutil</span><span class="op" id="7279174">.</span><span class="ident" id="7279175">ReadFile</span><span class="op" id="7279183">(</span><span class="string" id="7279184">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7279212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279215">if</span>&nbsp;<span class="ident" id="7279218">err</span>&nbsp;<span class="op" id="7279222">!=</span>&nbsp;<span class="ident" id="7279225">nil</span>&nbsp;<span class="op" id="7279229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279233">t</span><span class="op" id="7279234">.</span><span class="ident" id="7279235">Fatal</span><span class="op" id="7279240">(</span><span class="ident" id="7279241">err</span><span class="op" id="7279244">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279251">n</span>&nbsp;<span class="op" id="7279253">:=</span>&nbsp;<span class="builtinfunc" id="7279256">len</span><span class="op" id="7279259">(</span><span class="ident" id="7279260">data</span><span class="op" id="7279264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279267">for</span>&nbsp;<span class="ident" id="7279271">i</span>&nbsp;<span class="op" id="7279273">:=</span>&nbsp;<span class="num" id="7279276">0</span><span class="op" id="7279277">;</span>&nbsp;<span class="ident" id="7279279">i</span>&nbsp;<span class="op" id="7279281">&lt;</span>&nbsp;<span class="ident" id="7279283">n</span><span class="op" id="7279284">;</span>&nbsp;<span class="op" id="7279286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279290">r</span>&nbsp;<span class="op" id="7279292">:=</span>&nbsp;<span class="op" id="7279295">&amp;</span><span class="ident" id="7279296">eofReader</span><span class="op" id="7279305">{</span><span class="ident" id="7279306">data</span><span class="op" id="7279310">[</span><span class="op" id="7279311">:</span><span class="ident" id="7279312">n</span><span class="op" id="7279313">-</span><span class="ident" id="7279314">i</span><span class="op" id="7279315">]</span><span class="op" id="7279316">,</span>&nbsp;<span class="ident" id="7279318">data</span><span class="op" id="7279322">[</span><span class="ident" id="7279323">n</span><span class="op" id="7279324">-</span><span class="ident" id="7279325">i</span><span class="op" id="7279326">:</span><span class="op" id="7279327">]</span><span class="op" id="7279328">,</span>&nbsp;<span class="op" id="7279330">-</span><span class="num" id="7279331">1</span><span class="op" id="7279332">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279336">_</span><span class="op" id="7279337">,</span>&nbsp;<span class="ident" id="7279339">err</span>&nbsp;<span class="op" id="7279343">:=</span>&nbsp;<span class="ident" id="7279346">Decode</span><span class="op" id="7279352">(</span><span class="ident" id="7279353">r</span><span class="op" id="7279354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279358">if</span>&nbsp;<span class="ident" id="7279361">err</span>&nbsp;<span class="op" id="7279365">!=</span>&nbsp;<span class="ident" id="7279368">nil</span>&nbsp;<span class="op" id="7279372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279377">t</span><span class="op" id="7279378">.</span><span class="ident" id="7279379">Errorf</span><span class="op" id="7279385">(</span><span class="string" id="7279386">&#34;Decode&nbsp;with&nbsp;Read()&nbsp;=&nbsp;%d,&nbsp;EOF:&nbsp;%v&#34;</span><span class="op" id="7279420">,</span>&nbsp;<span class="ident" id="7279422">r</span><span class="op" id="7279423">.</span><span class="ident" id="7279424">lenAtEOF</span><span class="op" id="7279432">,</span>&nbsp;<span class="ident" id="7279434">err</span><span class="op" id="7279437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279445">if</span>&nbsp;<span class="ident" id="7279448">i</span>&nbsp;<span class="op" id="7279450">==</span>&nbsp;<span class="num" id="7279453">0</span>&nbsp;<span class="op" id="7279455">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279460">i</span>&nbsp;<span class="op" id="7279462">=</span>&nbsp;<span class="num" id="7279464">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279468">}</span>&nbsp;<span class="keyword" id="7279470">else</span>&nbsp;<span class="op" id="7279475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7279480">i</span>&nbsp;<span class="op" id="7279482">*=</span>&nbsp;<span class="num" id="7279485">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279492">}</span><br>
<span class="lineno">135</span><span class="op" id="7279494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7279497">//&nbsp;check&nbsp;checks&nbsp;that&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;are&nbsp;equal,&nbsp;within&nbsp;the&nbsp;given&nbsp;bounds.</span><br>
<span class="lineno"></span><span class="keyword" id="7279571">func</span>&nbsp;<span class="ident" id="7279576">check</span><span class="op" id="7279581">(</span><span class="ident" id="7279582">bounds</span>&nbsp;<span class="ident" id="7279589">image</span><span class="op" id="7279594">.</span><span class="ident" id="7279595">Rectangle</span><span class="op" id="7279604">,</span>&nbsp;<span class="ident" id="7279606">pix0</span><span class="op" id="7279610">,</span>&nbsp;<span class="ident" id="7279612">pix1</span>&nbsp;<span class="op" id="7279617">[</span><span class="op" id="7279618">]</span><span class="builtintype" id="7279619">byte</span><span class="op" id="7279623">,</span>&nbsp;<span class="ident" id="7279625">stride0</span><span class="op" id="7279632">,</span>&nbsp;<span class="ident" id="7279634">stride1</span>&nbsp;<span class="builtintype" id="7279642">int</span><span class="op" id="7279645">)</span>&nbsp;<span class="builtintype" id="7279647">error</span>&nbsp;<span class="op" id="7279653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279656">if</span>&nbsp;<span class="ident" id="7279659">stride0</span>&nbsp;<span class="op" id="7279667">&lt;=</span>&nbsp;<span class="num" id="7279670">0</span>&nbsp;<span class="op" id="7279672">||</span>&nbsp;<span class="ident" id="7279675">stride0</span><span class="op" id="7279682">%</span><span class="num" id="7279683">8</span>&nbsp;<span class="op" id="7279685">!=</span>&nbsp;<span class="num" id="7279688">0</span>&nbsp;<span class="op" id="7279690">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279694">return</span>&nbsp;<span class="ident" id="7279701">fmt</span><span class="op" id="7279704">.</span><span class="ident" id="7279705">Errorf</span><span class="op" id="7279711">(</span><span class="string" id="7279712">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7279727">,</span>&nbsp;<span class="ident" id="7279729">stride0</span><span class="op" id="7279736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279742">if</span>&nbsp;<span class="ident" id="7279745">stride1</span>&nbsp;<span class="op" id="7279753">&lt;=</span>&nbsp;<span class="num" id="7279756">0</span>&nbsp;<span class="op" id="7279758">||</span>&nbsp;<span class="ident" id="7279761">stride1</span><span class="op" id="7279768">%</span><span class="num" id="7279769">8</span>&nbsp;<span class="op" id="7279771">!=</span>&nbsp;<span class="num" id="7279774">0</span>&nbsp;<span class="op" id="7279776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279780">return</span>&nbsp;<span class="ident" id="7279787">fmt</span><span class="op" id="7279790">.</span><span class="ident" id="7279791">Errorf</span><span class="op" id="7279797">(</span><span class="string" id="7279798">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7279813">,</span>&nbsp;<span class="ident" id="7279815">stride1</span><span class="op" id="7279822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7279825">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7279828">//&nbsp;Compare&nbsp;the&nbsp;two&nbsp;pix&nbsp;data,&nbsp;one&nbsp;8x8&nbsp;block&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279883">for</span>&nbsp;<span class="ident" id="7279887">y</span>&nbsp;<span class="op" id="7279889">:=</span>&nbsp;<span class="num" id="7279892">0</span><span class="op" id="7279893">;</span>&nbsp;<span class="ident" id="7279895">y</span>&nbsp;<span class="op" id="7279897">&lt;</span>&nbsp;<span class="builtinfunc" id="7279899">len</span><span class="op" id="7279902">(</span><span class="ident" id="7279903">pix0</span><span class="op" id="7279907">)</span><span class="op" id="7279908">/</span><span class="ident" id="7279909">stride0</span>&nbsp;<span class="op" id="7279917">&amp;&amp;</span>&nbsp;<span class="ident" id="7279920">y</span>&nbsp;<span class="op" id="7279922">&lt;</span>&nbsp;<span class="builtinfunc" id="7279924">len</span><span class="op" id="7279927">(</span><span class="ident" id="7279928">pix1</span><span class="op" id="7279932">)</span><span class="op" id="7279933">/</span><span class="ident" id="7279934">stride1</span><span class="op" id="7279941">;</span>&nbsp;<span class="ident" id="7279943">y</span>&nbsp;<span class="op" id="7279945">+=</span>&nbsp;<span class="num" id="7279948">8</span>&nbsp;<span class="op" id="7279950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7279954">for</span>&nbsp;<span class="ident" id="7279958">x</span>&nbsp;<span class="op" id="7279960">:=</span>&nbsp;<span class="num" id="7279963">0</span><span class="op" id="7279964">;</span>&nbsp;<span class="ident" id="7279966">x</span>&nbsp;<span class="op" id="7279968">&lt;</span>&nbsp;<span class="ident" id="7279970">stride0</span>&nbsp;<span class="op" id="7279978">&amp;&amp;</span>&nbsp;<span class="ident" id="7279981">x</span>&nbsp;<span class="op" id="7279983">&lt;</span>&nbsp;<span class="ident" id="7279985">stride1</span><span class="op" id="7279992">;</span>&nbsp;<span class="ident" id="7279994">x</span>&nbsp;<span class="op" id="7279996">+=</span>&nbsp;<span class="num" id="7279999">8</span>&nbsp;<span class="op" id="7280001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280006">if</span>&nbsp;<span class="ident" id="7280009">x</span>&nbsp;<span class="op" id="7280011">&gt;=</span>&nbsp;<span class="ident" id="7280014">bounds</span><span class="op" id="7280020">.</span><span class="ident" id="7280021">Max</span><span class="op" id="7280024">.</span><span class="ident" id="7280025">X</span>&nbsp;<span class="op" id="7280027">||</span>&nbsp;<span class="ident" id="7280030">y</span>&nbsp;<span class="op" id="7280032">&gt;=</span>&nbsp;<span class="ident" id="7280035">bounds</span><span class="op" id="7280041">.</span><span class="ident" id="7280042">Max</span><span class="op" id="7280045">.</span><span class="ident" id="7280046">Y</span>&nbsp;<span class="op" id="7280048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7280054">//&nbsp;We&nbsp;don&#39;t&nbsp;care&nbsp;if&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;differ&nbsp;if&nbsp;the&nbsp;8x8&nbsp;block&nbsp;is</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7280122">//&nbsp;entirely&nbsp;outside&nbsp;of&nbsp;the&nbsp;image&#39;s&nbsp;bounds.&nbsp;For&nbsp;example,&nbsp;this&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7280191">//&nbsp;occur&nbsp;with&nbsp;a&nbsp;4:2:0&nbsp;chroma&nbsp;subsampling&nbsp;and&nbsp;a&nbsp;1x1&nbsp;image.&nbsp;Baseline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7280262">//&nbsp;decoding&nbsp;works&nbsp;on&nbsp;the&nbsp;one&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole;&nbsp;progressive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7280329">//&nbsp;decoding&#39;s&nbsp;first&nbsp;pass&nbsp;works&nbsp;on&nbsp;that&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7280397">//&nbsp;refinement&nbsp;passes&nbsp;only&nbsp;process&nbsp;one&nbsp;8x8&nbsp;block&nbsp;within&nbsp;the&nbsp;MCU.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280465">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7280477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280483">for</span>&nbsp;<span class="ident" id="7280487">j</span>&nbsp;<span class="op" id="7280489">:=</span>&nbsp;<span class="num" id="7280492">0</span><span class="op" id="7280493">;</span>&nbsp;<span class="ident" id="7280495">j</span>&nbsp;<span class="op" id="7280497">&lt;</span>&nbsp;<span class="num" id="7280499">8</span><span class="op" id="7280500">;</span>&nbsp;<span class="ident" id="7280502">j</span><span class="op" id="7280503">++</span>&nbsp;<span class="op" id="7280506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280512">for</span>&nbsp;<span class="ident" id="7280516">i</span>&nbsp;<span class="op" id="7280518">:=</span>&nbsp;<span class="num" id="7280521">0</span><span class="op" id="7280522">;</span>&nbsp;<span class="ident" id="7280524">i</span>&nbsp;<span class="op" id="7280526">&lt;</span>&nbsp;<span class="num" id="7280528">8</span><span class="op" id="7280529">;</span>&nbsp;<span class="ident" id="7280531">i</span><span class="op" id="7280532">++</span>&nbsp;<span class="op" id="7280535">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280542">index0</span>&nbsp;<span class="op" id="7280549">:=</span>&nbsp;<span class="op" id="7280552">(</span><span class="ident" id="7280553">y</span><span class="op" id="7280554">+</span><span class="ident" id="7280555">j</span><span class="op" id="7280556">)</span><span class="op" id="7280557">*</span><span class="ident" id="7280558">stride0</span>&nbsp;<span class="op" id="7280566">+</span>&nbsp;<span class="op" id="7280568">(</span><span class="ident" id="7280569">x</span>&nbsp;<span class="op" id="7280571">+</span>&nbsp;<span class="ident" id="7280573">i</span><span class="op" id="7280574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280581">index1</span>&nbsp;<span class="op" id="7280588">:=</span>&nbsp;<span class="op" id="7280591">(</span><span class="ident" id="7280592">y</span><span class="op" id="7280593">+</span><span class="ident" id="7280594">j</span><span class="op" id="7280595">)</span><span class="op" id="7280596">*</span><span class="ident" id="7280597">stride1</span>&nbsp;<span class="op" id="7280605">+</span>&nbsp;<span class="op" id="7280607">(</span><span class="ident" id="7280608">x</span>&nbsp;<span class="op" id="7280610">+</span>&nbsp;<span class="ident" id="7280612">i</span><span class="op" id="7280613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280620">if</span>&nbsp;<span class="ident" id="7280623">pix0</span><span class="op" id="7280627">[</span><span class="ident" id="7280628">index0</span><span class="op" id="7280634">]</span>&nbsp;<span class="op" id="7280636">!=</span>&nbsp;<span class="ident" id="7280639">pix1</span><span class="op" id="7280643">[</span><span class="ident" id="7280644">index1</span><span class="op" id="7280650">]</span>&nbsp;<span class="op" id="7280652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280660">return</span>&nbsp;<span class="ident" id="7280667">fmt</span><span class="op" id="7280670">.</span><span class="ident" id="7280671">Errorf</span><span class="op" id="7280677">(</span><span class="string" id="7280678">&#34;blocks&nbsp;at&nbsp;(%d,&nbsp;%d)&nbsp;differ:\n%sand\n%s&#34;</span><span class="op" id="7280717">,</span>&nbsp;<span class="ident" id="7280719">x</span><span class="op" id="7280720">,</span>&nbsp;<span class="ident" id="7280722">y</span><span class="op" id="7280723">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280732">pixString</span><span class="op" id="7280741">(</span><span class="ident" id="7280742">pix0</span><span class="op" id="7280746">,</span>&nbsp;<span class="ident" id="7280748">stride0</span><span class="op" id="7280755">,</span>&nbsp;<span class="ident" id="7280757">x</span><span class="op" id="7280758">,</span>&nbsp;<span class="ident" id="7280760">y</span><span class="op" id="7280761">)</span><span class="op" id="7280762">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280771">pixString</span><span class="op" id="7280780">(</span><span class="ident" id="7280781">pix1</span><span class="op" id="7280785">,</span>&nbsp;<span class="ident" id="7280787">stride1</span><span class="op" id="7280794">,</span>&nbsp;<span class="ident" id="7280796">x</span><span class="op" id="7280797">,</span>&nbsp;<span class="ident" id="7280799">y</span><span class="op" id="7280800">)</span><span class="op" id="7280801">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7280809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7280816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7280822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7280827">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7280831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7280834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280837">return</span>&nbsp;<span class="ident" id="7280844">nil</span><br>
<span class="lineno"></span><span class="op" id="7280848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="7280851">func</span>&nbsp;<span class="ident" id="7280856">pixString</span><span class="op" id="7280865">(</span><span class="ident" id="7280866">pix</span>&nbsp;<span class="op" id="7280870">[</span><span class="op" id="7280871">]</span><span class="builtintype" id="7280872">byte</span><span class="op" id="7280876">,</span>&nbsp;<span class="ident" id="7280878">stride</span><span class="op" id="7280884">,</span>&nbsp;<span class="ident" id="7280886">x</span><span class="op" id="7280887">,</span>&nbsp;<span class="ident" id="7280889">y</span>&nbsp;<span class="builtintype" id="7280891">int</span><span class="op" id="7280894">)</span>&nbsp;<span class="builtintype" id="7280896">string</span>&nbsp;<span class="op" id="7280903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280906">s</span>&nbsp;<span class="op" id="7280908">:=</span>&nbsp;<span class="ident" id="7280911">bytes</span><span class="op" id="7280916">.</span><span class="ident" id="7280917">NewBuffer</span><span class="op" id="7280926">(</span><span class="ident" id="7280927">nil</span><span class="op" id="7280930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280933">for</span>&nbsp;<span class="ident" id="7280937">j</span>&nbsp;<span class="op" id="7280939">:=</span>&nbsp;<span class="num" id="7280942">0</span><span class="op" id="7280943">;</span>&nbsp;<span class="ident" id="7280945">j</span>&nbsp;<span class="op" id="7280947">&lt;</span>&nbsp;<span class="num" id="7280949">8</span><span class="op" id="7280950">;</span>&nbsp;<span class="ident" id="7280952">j</span><span class="op" id="7280953">++</span>&nbsp;<span class="op" id="7280956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7280960">fmt</span><span class="op" id="7280963">.</span><span class="ident" id="7280964">Fprintf</span><span class="op" id="7280971">(</span><span class="ident" id="7280972">s</span><span class="op" id="7280973">,</span>&nbsp;<span class="string" id="7280975">&#34;\t&#34;</span><span class="op" id="7280979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7280983">for</span>&nbsp;<span class="ident" id="7280987">i</span>&nbsp;<span class="op" id="7280989">:=</span>&nbsp;<span class="num" id="7280992">0</span><span class="op" id="7280993">;</span>&nbsp;<span class="ident" id="7280995">i</span>&nbsp;<span class="op" id="7280997">&lt;</span>&nbsp;<span class="num" id="7280999">8</span><span class="op" id="7281000">;</span>&nbsp;<span class="ident" id="7281002">i</span><span class="op" id="7281003">++</span>&nbsp;<span class="op" id="7281006">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281011">fmt</span><span class="op" id="7281014">.</span><span class="ident" id="7281015">Fprintf</span><span class="op" id="7281022">(</span><span class="ident" id="7281023">s</span><span class="op" id="7281024">,</span>&nbsp;<span class="string" id="7281026">&#34;%02x&nbsp;&#34;</span><span class="op" id="7281033">,</span>&nbsp;<span class="ident" id="7281035">pix</span><span class="op" id="7281038">[</span><span class="op" id="7281039">(</span><span class="ident" id="7281040">y</span><span class="op" id="7281041">+</span><span class="ident" id="7281042">j</span><span class="op" id="7281043">)</span><span class="op" id="7281044">*</span><span class="ident" id="7281045">stride</span><span class="op" id="7281051">+</span><span class="op" id="7281052">(</span><span class="ident" id="7281053">x</span><span class="op" id="7281054">+</span><span class="ident" id="7281055">i</span><span class="op" id="7281056">)</span><span class="op" id="7281057">]</span><span class="op" id="7281058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7281062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281066">fmt</span><span class="op" id="7281069">.</span><span class="ident" id="7281070">Fprintf</span><span class="op" id="7281077">(</span><span class="ident" id="7281078">s</span><span class="op" id="7281079">,</span>&nbsp;<span class="string" id="7281081">&#34;\n&#34;</span><span class="op" id="7281085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7281088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7281091">return</span>&nbsp;<span class="ident" id="7281098">s</span><span class="op" id="7281099">.</span><span class="ident" id="7281100">String</span><span class="op" id="7281106">(</span><span class="op" id="7281107">)</span><br>
<span class="lineno">185</span><span class="op" id="7281109">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7281112">func</span>&nbsp;<span class="ident" id="7281117">TestExtraneousData</span><span class="op" id="7281135">(</span><span class="ident" id="7281136">t</span>&nbsp;<span class="op" id="7281138">*</span><span class="ident" id="7281139">testing</span><span class="op" id="7281146">.</span><span class="ident" id="7281147">T</span><span class="op" id="7281148">)</span>&nbsp;<span class="op" id="7281150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7281153">//&nbsp;Encode&nbsp;a&nbsp;1x1&nbsp;red&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281181">src</span>&nbsp;<span class="op" id="7281185">:=</span>&nbsp;<span class="ident" id="7281188">image</span><span class="op" id="7281193">.</span><span class="ident" id="7281194">NewRGBA</span><span class="op" id="7281201">(</span><span class="ident" id="7281202">image</span><span class="op" id="7281207">.</span><span class="ident" id="7281208">Rect</span><span class="op" id="7281212">(</span><span class="num" id="7281213">0</span><span class="op" id="7281214">,</span>&nbsp;<span class="num" id="7281216">0</span><span class="op" id="7281217">,</span>&nbsp;<span class="num" id="7281219">1</span><span class="op" id="7281220">,</span>&nbsp;<span class="num" id="7281222">1</span><span class="op" id="7281223">)</span><span class="op" id="7281224">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281227">src</span><span class="op" id="7281230">.</span><span class="ident" id="7281231">Set</span><span class="op" id="7281234">(</span><span class="num" id="7281235">0</span><span class="op" id="7281236">,</span>&nbsp;<span class="num" id="7281238">0</span><span class="op" id="7281239">,</span>&nbsp;<span class="ident" id="7281241">color</span><span class="op" id="7281246">.</span><span class="ident" id="7281247">RGBA</span><span class="op" id="7281251">{</span><span class="num" id="7281252">0xff</span><span class="op" id="7281256">,</span>&nbsp;<span class="num" id="7281258">0x00</span><span class="op" id="7281262">,</span>&nbsp;<span class="num" id="7281264">0x00</span><span class="op" id="7281268">,</span>&nbsp;<span class="num" id="7281270">0xff</span><span class="op" id="7281274">}</span><span class="op" id="7281275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281278">buf</span>&nbsp;<span class="op" id="7281282">:=</span>&nbsp;<span class="builtinfunc" id="7281285">new</span><span class="op" id="7281288">(</span><span class="ident" id="7281289">bytes</span><span class="op" id="7281294">.</span><span class="ident" id="7281295">Buffer</span><span class="op" id="7281301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7281304">if</span>&nbsp;<span class="ident" id="7281307">err</span>&nbsp;<span class="op" id="7281311">:=</span>&nbsp;<span class="ident" id="7281314">Encode</span><span class="op" id="7281320">(</span><span class="ident" id="7281321">buf</span><span class="op" id="7281324">,</span>&nbsp;<span class="ident" id="7281326">src</span><span class="op" id="7281329">,</span>&nbsp;<span class="ident" id="7281331">nil</span><span class="op" id="7281334">)</span><span class="op" id="7281335">;</span>&nbsp;<span class="ident" id="7281337">err</span>&nbsp;<span class="op" id="7281341">!=</span>&nbsp;<span class="ident" id="7281344">nil</span>&nbsp;<span class="op" id="7281348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281352">t</span><span class="op" id="7281353">.</span><span class="ident" id="7281354">Fatalf</span><span class="op" id="7281360">(</span><span class="string" id="7281361">&#34;encode:&nbsp;%v&#34;</span><span class="op" id="7281373">,</span>&nbsp;<span class="ident" id="7281375">err</span><span class="op" id="7281378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7281381">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281384">enc</span>&nbsp;<span class="op" id="7281388">:=</span>&nbsp;<span class="ident" id="7281391">buf</span><span class="op" id="7281394">.</span><span class="ident" id="7281395">String</span><span class="op" id="7281401">(</span><span class="op" id="7281402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7281405">//&nbsp;Sanity&nbsp;check&nbsp;that&nbsp;the&nbsp;encoded&nbsp;JPEG&nbsp;is&nbsp;long&nbsp;enough,&nbsp;that&nbsp;it&nbsp;ends&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7281478">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker,&nbsp;and&nbsp;that&nbsp;it&nbsp;contains&nbsp;a&nbsp;&#34;\xff\xda&#34;&nbsp;SOS&nbsp;marker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7281550">//&nbsp;somewhere&nbsp;in&nbsp;the&nbsp;final&nbsp;64&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7281587">if</span>&nbsp;<span class="builtinfunc" id="7281590">len</span><span class="op" id="7281593">(</span><span class="ident" id="7281594">enc</span><span class="op" id="7281597">)</span>&nbsp;<span class="op" id="7281599">&lt;</span>&nbsp;<span class="num" id="7281601">64</span>&nbsp;<span class="op" id="7281604">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281608">t</span><span class="op" id="7281609">.</span><span class="ident" id="7281610">Fatalf</span><span class="op" id="7281616">(</span><span class="string" id="7281617">&#34;encoded&nbsp;JPEG&nbsp;is&nbsp;too&nbsp;short:&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="7281654">,</span>&nbsp;<span class="builtinfunc" id="7281656">len</span><span class="op" id="7281659">(</span><span class="ident" id="7281660">enc</span><span class="op" id="7281663">)</span><span class="op" id="7281664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7281667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7281670">if</span>&nbsp;<span class="ident" id="7281673">got</span><span class="op" id="7281676">,</span>&nbsp;<span class="ident" id="7281678">want</span>&nbsp;<span class="op" id="7281683">:=</span>&nbsp;<span class="ident" id="7281686">enc</span><span class="op" id="7281689">[</span><span class="builtinfunc" id="7281690">len</span><span class="op" id="7281693">(</span><span class="ident" id="7281694">enc</span><span class="op" id="7281697">)</span><span class="op" id="7281698">-</span><span class="num" id="7281699">2</span><span class="op" id="7281700">:</span><span class="op" id="7281701">]</span><span class="op" id="7281702">,</span>&nbsp;<span class="string" id="7281704">&#34;\xff\xd9&#34;</span><span class="op" id="7281714">;</span>&nbsp;<span class="ident" id="7281716">got</span>&nbsp;<span class="op" id="7281720">!=</span>&nbsp;<span class="ident" id="7281723">want</span>&nbsp;<span class="op" id="7281728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281732">t</span><span class="op" id="7281733">.</span><span class="ident" id="7281734">Fatalf</span><span class="op" id="7281740">(</span><span class="string" id="7281741">&#34;encoded&nbsp;JPEG&nbsp;ends&nbsp;with&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7281777">,</span>&nbsp;<span class="ident" id="7281779">got</span><span class="op" id="7281782">,</span>&nbsp;<span class="ident" id="7281784">want</span><span class="op" id="7281788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7281791">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7281794">if</span>&nbsp;<span class="ident" id="7281797">s</span>&nbsp;<span class="op" id="7281799">:=</span>&nbsp;<span class="ident" id="7281802">enc</span><span class="op" id="7281805">[</span><span class="builtinfunc" id="7281806">len</span><span class="op" id="7281809">(</span><span class="ident" id="7281810">enc</span><span class="op" id="7281813">)</span><span class="op" id="7281814">-</span><span class="num" id="7281815">64</span><span class="op" id="7281817">:</span><span class="op" id="7281818">]</span><span class="op" id="7281819">;</span>&nbsp;<span class="op" id="7281821">!</span><span class="ident" id="7281822">strings</span><span class="op" id="7281829">.</span><span class="ident" id="7281830">Contains</span><span class="op" id="7281838">(</span><span class="ident" id="7281839">s</span><span class="op" id="7281840">,</span>&nbsp;<span class="string" id="7281842">&#34;\xff\xda&#34;</span><span class="op" id="7281852">)</span>&nbsp;<span class="op" id="7281854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7281858">t</span><span class="op" id="7281859">.</span><span class="ident" id="7281860">Fatalf</span><span class="op" id="7281866">(</span><span class="string" id="7281867">&#34;encoded&nbsp;JPEG&nbsp;does&nbsp;not&nbsp;contain&nbsp;a&nbsp;SOS&nbsp;marker&nbsp;(ff&nbsp;da)&nbsp;near&nbsp;the&nbsp;end:&nbsp;%&nbsp;x&#34;</span><span class="op" id="7281937">,</span>&nbsp;<span class="ident" id="7281939">s</span><span class="op" id="7281940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7281943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7281946">//&nbsp;Test&nbsp;that&nbsp;adding&nbsp;some&nbsp;random&nbsp;junk&nbsp;between&nbsp;the&nbsp;SOS&nbsp;marker&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7282015">//&nbsp;EOI&nbsp;marker&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;decoding.</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282060">rnd</span>&nbsp;<span class="op" id="7282064">:=</span>&nbsp;<span class="ident" id="7282067">rand</span><span class="op" id="7282071">.</span><span class="ident" id="7282072">New</span><span class="op" id="7282075">(</span><span class="ident" id="7282076">rand</span><span class="op" id="7282080">.</span><span class="ident" id="7282081">NewSource</span><span class="op" id="7282090">(</span><span class="num" id="7282091">1</span><span class="op" id="7282092">)</span><span class="op" id="7282093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282096">for</span>&nbsp;<span class="ident" id="7282100">i</span><span class="op" id="7282101">,</span>&nbsp;<span class="ident" id="7282103">nerr</span>&nbsp;<span class="op" id="7282108">:=</span>&nbsp;<span class="num" id="7282111">0</span><span class="op" id="7282112">,</span>&nbsp;<span class="num" id="7282114">0</span><span class="op" id="7282115">;</span>&nbsp;<span class="ident" id="7282117">i</span>&nbsp;<span class="op" id="7282119">&lt;</span>&nbsp;<span class="num" id="7282121">1000</span>&nbsp;<span class="op" id="7282126">&amp;&amp;</span>&nbsp;<span class="ident" id="7282129">nerr</span>&nbsp;<span class="op" id="7282134">&lt;</span>&nbsp;<span class="num" id="7282136">10</span><span class="op" id="7282138">;</span>&nbsp;<span class="ident" id="7282140">i</span><span class="op" id="7282141">++</span>&nbsp;<span class="op" id="7282144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282148">buf</span><span class="op" id="7282151">.</span><span class="ident" id="7282152">Reset</span><span class="op" id="7282157">(</span><span class="op" id="7282158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7282162">//&nbsp;Write&nbsp;all&nbsp;but&nbsp;the&nbsp;trailing&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282217">buf</span><span class="op" id="7282220">.</span><span class="ident" id="7282221">WriteString</span><span class="op" id="7282232">(</span><span class="ident" id="7282233">enc</span><span class="op" id="7282236">[</span><span class="op" id="7282237">:</span><span class="builtinfunc" id="7282238">len</span><span class="op" id="7282241">(</span><span class="ident" id="7282242">enc</span><span class="op" id="7282245">)</span><span class="op" id="7282246">-</span><span class="num" id="7282247">2</span><span class="op" id="7282248">]</span><span class="op" id="7282249">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7282253">//&nbsp;Write&nbsp;some&nbsp;random&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282293">for</span>&nbsp;<span class="ident" id="7282297">n</span>&nbsp;<span class="op" id="7282299">:=</span>&nbsp;<span class="ident" id="7282302">rnd</span><span class="op" id="7282305">.</span><span class="ident" id="7282306">Intn</span><span class="op" id="7282310">(</span><span class="num" id="7282311">10</span><span class="op" id="7282313">)</span><span class="op" id="7282314">;</span>&nbsp;<span class="ident" id="7282316">n</span>&nbsp;<span class="op" id="7282318">&gt;</span>&nbsp;<span class="num" id="7282320">0</span><span class="op" id="7282321">;</span>&nbsp;<span class="ident" id="7282323">n</span><span class="op" id="7282324">--</span>&nbsp;<span class="op" id="7282327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282332">if</span>&nbsp;<span class="ident" id="7282335">x</span>&nbsp;<span class="op" id="7282337">:=</span>&nbsp;<span class="builtintype" id="7282340">byte</span><span class="op" id="7282344">(</span><span class="ident" id="7282345">rnd</span><span class="op" id="7282348">.</span><span class="ident" id="7282349">Intn</span><span class="op" id="7282353">(</span><span class="num" id="7282354">256</span><span class="op" id="7282357">)</span><span class="op" id="7282358">)</span><span class="op" id="7282359">;</span>&nbsp;<span class="ident" id="7282361">x</span>&nbsp;<span class="op" id="7282363">!=</span>&nbsp;<span class="num" id="7282366">0xff</span>&nbsp;<span class="op" id="7282371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282377">buf</span><span class="op" id="7282380">.</span><span class="ident" id="7282381">WriteByte</span><span class="op" id="7282390">(</span><span class="ident" id="7282391">x</span><span class="op" id="7282392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7282397">}</span>&nbsp;<span class="keyword" id="7282399">else</span>&nbsp;<span class="op" id="7282404">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7282410">//&nbsp;The&nbsp;JPEG&nbsp;format&nbsp;escapes&nbsp;a&nbsp;SOS&nbsp;0xff&nbsp;data&nbsp;byte&nbsp;as&nbsp;&#34;\xff\x00&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282477">buf</span><span class="op" id="7282480">.</span><span class="ident" id="7282481">WriteString</span><span class="op" id="7282492">(</span><span class="string" id="7282493">&#34;\xff\x00&#34;</span><span class="op" id="7282503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7282508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7282512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7282516">//&nbsp;Write&nbsp;the&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282554">buf</span><span class="op" id="7282557">.</span><span class="ident" id="7282558">WriteString</span><span class="op" id="7282569">(</span><span class="string" id="7282570">&#34;\xff\xd9&#34;</span><span class="op" id="7282580">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7282585">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;can&nbsp;still&nbsp;decode&nbsp;the&nbsp;resultant&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282642">got</span><span class="op" id="7282645">,</span>&nbsp;<span class="ident" id="7282647">err</span>&nbsp;<span class="op" id="7282651">:=</span>&nbsp;<span class="ident" id="7282654">Decode</span><span class="op" id="7282660">(</span><span class="ident" id="7282661">buf</span><span class="op" id="7282664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282668">if</span>&nbsp;<span class="ident" id="7282671">err</span>&nbsp;<span class="op" id="7282675">!=</span>&nbsp;<span class="ident" id="7282678">nil</span>&nbsp;<span class="op" id="7282682">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282687">t</span><span class="op" id="7282688">.</span><span class="ident" id="7282689">Errorf</span><span class="op" id="7282695">(</span><span class="string" id="7282696">&#34;could&nbsp;not&nbsp;decode&nbsp;image&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="7282728">,</span>&nbsp;<span class="ident" id="7282730">i</span><span class="op" id="7282731">,</span>&nbsp;<span class="ident" id="7282733">err</span><span class="op" id="7282736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282741">nerr</span><span class="op" id="7282745">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282751">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7282762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282766">if</span>&nbsp;<span class="ident" id="7282769">got</span><span class="op" id="7282772">.</span><span class="ident" id="7282773">Bounds</span><span class="op" id="7282779">(</span><span class="op" id="7282780">)</span>&nbsp;<span class="op" id="7282782">!=</span>&nbsp;<span class="ident" id="7282785">src</span><span class="op" id="7282788">.</span><span class="ident" id="7282789">Bounds</span><span class="op" id="7282795">(</span><span class="op" id="7282796">)</span>&nbsp;<span class="op" id="7282798">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282803">t</span><span class="op" id="7282804">.</span><span class="ident" id="7282805">Errorf</span><span class="op" id="7282811">(</span><span class="string" id="7282812">&#34;image&nbsp;#%d,&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7282849">,</span>&nbsp;<span class="ident" id="7282851">i</span><span class="op" id="7282852">,</span>&nbsp;<span class="ident" id="7282854">got</span><span class="op" id="7282857">.</span><span class="ident" id="7282858">Bounds</span><span class="op" id="7282864">(</span><span class="op" id="7282865">)</span><span class="op" id="7282866">,</span>&nbsp;<span class="ident" id="7282868">src</span><span class="op" id="7282871">.</span><span class="ident" id="7282872">Bounds</span><span class="op" id="7282878">(</span><span class="op" id="7282879">)</span><span class="op" id="7282880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282885">nerr</span><span class="op" id="7282889">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282895">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7282906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7282910">if</span>&nbsp;<span class="ident" id="7282913">averageDelta</span><span class="op" id="7282925">(</span><span class="ident" id="7282926">got</span><span class="op" id="7282929">,</span>&nbsp;<span class="ident" id="7282931">src</span><span class="op" id="7282934">)</span>&nbsp;<span class="op" id="7282936">&gt;</span>&nbsp;<span class="num" id="7282938">2</span><span class="op" id="7282939">&lt;&lt;</span><span class="num" id="7282941">8</span>&nbsp;<span class="op" id="7282943">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7282948">t</span><span class="op" id="7282949">.</span><span class="ident" id="7282950">Errorf</span><span class="op" id="7282956">(</span><span class="string" id="7282957">&#34;image&nbsp;#%d&nbsp;changed&nbsp;too&nbsp;much&nbsp;after&nbsp;a&nbsp;round&nbsp;trip&#34;</span><span class="op" id="7283004">,</span>&nbsp;<span class="ident" id="7283006">i</span><span class="op" id="7283007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283012">nerr</span><span class="op" id="7283016">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7283022">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7283033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7283036">}</span><br>
<span class="lineno">245</span><span class="op" id="7283038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7283041">func</span>&nbsp;<span class="ident" id="7283046">benchmarkDecode</span><span class="op" id="7283061">(</span><span class="ident" id="7283062">b</span>&nbsp;<span class="op" id="7283064">*</span><span class="ident" id="7283065">testing</span><span class="op" id="7283072">.</span><span class="ident" id="7283073">B</span><span class="op" id="7283074">,</span>&nbsp;<span class="ident" id="7283076">filename</span>&nbsp;<span class="builtintype" id="7283085">string</span><span class="op" id="7283091">)</span>&nbsp;<span class="op" id="7283093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283096">b</span><span class="op" id="7283097">.</span><span class="ident" id="7283098">StopTimer</span><span class="op" id="7283107">(</span><span class="op" id="7283108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283111">data</span><span class="op" id="7283115">,</span>&nbsp;<span class="ident" id="7283117">err</span>&nbsp;<span class="op" id="7283121">:=</span>&nbsp;<span class="ident" id="7283124">ioutil</span><span class="op" id="7283130">.</span><span class="ident" id="7283131">ReadFile</span><span class="op" id="7283139">(</span><span class="ident" id="7283140">filename</span><span class="op" id="7283148">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7283151">if</span>&nbsp;<span class="ident" id="7283154">err</span>&nbsp;<span class="op" id="7283158">!=</span>&nbsp;<span class="ident" id="7283161">nil</span>&nbsp;<span class="op" id="7283165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283169">b</span><span class="op" id="7283170">.</span><span class="ident" id="7283171">Fatal</span><span class="op" id="7283176">(</span><span class="ident" id="7283177">err</span><span class="op" id="7283180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7283183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283186">cfg</span><span class="op" id="7283189">,</span>&nbsp;<span class="ident" id="7283191">err</span>&nbsp;<span class="op" id="7283195">:=</span>&nbsp;<span class="ident" id="7283198">DecodeConfig</span><span class="op" id="7283210">(</span><span class="ident" id="7283211">bytes</span><span class="op" id="7283216">.</span><span class="ident" id="7283217">NewReader</span><span class="op" id="7283226">(</span><span class="ident" id="7283227">data</span><span class="op" id="7283231">)</span><span class="op" id="7283232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7283235">if</span>&nbsp;<span class="ident" id="7283238">err</span>&nbsp;<span class="op" id="7283242">!=</span>&nbsp;<span class="ident" id="7283245">nil</span>&nbsp;<span class="op" id="7283249">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283253">b</span><span class="op" id="7283254">.</span><span class="ident" id="7283255">Fatal</span><span class="op" id="7283260">(</span><span class="ident" id="7283261">err</span><span class="op" id="7283264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7283267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283270">b</span><span class="op" id="7283271">.</span><span class="ident" id="7283272">SetBytes</span><span class="op" id="7283280">(</span><span class="ident" id="7283281">int64</span><span class="op" id="7283286">(</span><span class="ident" id="7283287">cfg</span><span class="op" id="7283290">.</span><span class="ident" id="7283291">Width</span>&nbsp;<span class="op" id="7283297">*</span>&nbsp;<span class="ident" id="7283299">cfg</span><span class="op" id="7283302">.</span><span class="ident" id="7283303">Height</span>&nbsp;<span class="op" id="7283310">*</span>&nbsp;<span class="num" id="7283312">4</span><span class="op" id="7283313">)</span><span class="op" id="7283314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283317">b</span><span class="op" id="7283318">.</span><span class="ident" id="7283319">StartTimer</span><span class="op" id="7283329">(</span><span class="op" id="7283330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7283333">for</span>&nbsp;<span class="ident" id="7283337">i</span>&nbsp;<span class="op" id="7283339">:=</span>&nbsp;<span class="num" id="7283342">0</span><span class="op" id="7283343">;</span>&nbsp;<span class="ident" id="7283345">i</span>&nbsp;<span class="op" id="7283347">&lt;</span>&nbsp;<span class="ident" id="7283349">b</span><span class="op" id="7283350">.</span><span class="ident" id="7283351">N</span><span class="op" id="7283352">;</span>&nbsp;<span class="ident" id="7283354">i</span><span class="op" id="7283355">++</span>&nbsp;<span class="op" id="7283358">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283362">Decode</span><span class="op" id="7283368">(</span><span class="ident" id="7283369">bytes</span><span class="op" id="7283374">.</span><span class="ident" id="7283375">NewReader</span><span class="op" id="7283384">(</span><span class="ident" id="7283385">data</span><span class="op" id="7283389">)</span><span class="op" id="7283390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7283393">}</span><br>
<span class="lineno"></span><span class="op" id="7283395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7283398">func</span>&nbsp;<span class="ident" id="7283403">BenchmarkDecodeBaseline</span><span class="op" id="7283426">(</span><span class="ident" id="7283427">b</span>&nbsp;<span class="op" id="7283429">*</span><span class="ident" id="7283430">testing</span><span class="op" id="7283437">.</span><span class="ident" id="7283438">B</span><span class="op" id="7283439">)</span>&nbsp;<span class="op" id="7283441">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283444">benchmarkDecode</span><span class="op" id="7283459">(</span><span class="ident" id="7283460">b</span><span class="op" id="7283461">,</span>&nbsp;<span class="string" id="7283463">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7283491">)</span><br>
<span class="lineno"></span><span class="op" id="7283493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7283496">func</span>&nbsp;<span class="ident" id="7283501">BenchmarkDecodeProgressive</span><span class="op" id="7283527">(</span><span class="ident" id="7283528">b</span>&nbsp;<span class="op" id="7283530">*</span><span class="ident" id="7283531">testing</span><span class="op" id="7283538">.</span><span class="ident" id="7283539">B</span><span class="op" id="7283540">)</span>&nbsp;<span class="op" id="7283542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7283545">benchmarkDecode</span><span class="op" id="7283560">(</span><span class="ident" id="7283561">b</span><span class="op" id="7283562">,</span>&nbsp;<span class="string" id="7283564">&#34;../testdata/video-001.progressive.jpeg&#34;</span><span class="op" id="7283604">)</span><br>
<span class="lineno">270</span><span class="op" id="7283606">}</span>
</div>
</body>
</html>
