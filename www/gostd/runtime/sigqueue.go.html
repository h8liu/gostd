<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1630242">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1630297">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1630351">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1630402">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;runtime&nbsp;support&nbsp;for&nbsp;signal&nbsp;handling.</span><br>
<span class="lineno"></span><span class="comment" id="1630463">//</span><br>
<span class="lineno"></span><span class="comment" id="1630466">//&nbsp;Most&nbsp;synchronization&nbsp;primitives&nbsp;are&nbsp;not&nbsp;available&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="1630524">//&nbsp;the&nbsp;signal&nbsp;handler&nbsp;(it&nbsp;cannot&nbsp;block,&nbsp;allocate&nbsp;memory,&nbsp;or&nbsp;use&nbsp;locks)</span><br>
<span class="lineno"></span><span class="comment" id="1630595">//&nbsp;so&nbsp;the&nbsp;handler&nbsp;communicates&nbsp;with&nbsp;a&nbsp;processing&nbsp;goroutine</span><br>
<span class="lineno">10</span><span class="comment" id="1630654">//&nbsp;via&nbsp;struct&nbsp;sig,&nbsp;below.</span><br>
<span class="lineno"></span><span class="comment" id="1630680">//</span><br>
<span class="lineno"></span><span class="comment" id="1630683">//&nbsp;sigsend&nbsp;is&nbsp;called&nbsp;by&nbsp;the&nbsp;signal&nbsp;handler&nbsp;to&nbsp;queue&nbsp;a&nbsp;new&nbsp;signal.</span><br>
<span class="lineno"></span><span class="comment" id="1630749">//&nbsp;signal_recv&nbsp;is&nbsp;called&nbsp;by&nbsp;the&nbsp;Go&nbsp;program&nbsp;to&nbsp;receive&nbsp;a&nbsp;newly&nbsp;queued&nbsp;signal.</span><br>
<span class="lineno"></span><span class="comment" id="1630826">//&nbsp;Synchronization&nbsp;between&nbsp;sigsend&nbsp;and&nbsp;signal_recv&nbsp;is&nbsp;based&nbsp;on&nbsp;the&nbsp;sig.state</span><br>
<span class="lineno">15</span><span class="comment" id="1630903">//&nbsp;variable.&nbsp;&nbsp;It&nbsp;can&nbsp;be&nbsp;in&nbsp;3&nbsp;states:&nbsp;sigIdle,&nbsp;sigReceiving&nbsp;and&nbsp;sigSending.</span><br>
<span class="lineno"></span><span class="comment" id="1630978">//&nbsp;sigReceiving&nbsp;means&nbsp;that&nbsp;signal_recv&nbsp;is&nbsp;blocked&nbsp;on&nbsp;sig.Note&nbsp;and&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="1631057">//&nbsp;new&nbsp;pending&nbsp;signals.</span><br>
<span class="lineno"></span><span class="comment" id="1631081">//&nbsp;sigSending&nbsp;means&nbsp;that&nbsp;sig.mask&nbsp;*may*&nbsp;contain&nbsp;new&nbsp;pending&nbsp;signals,</span><br>
<span class="lineno"></span><span class="comment" id="1631150">//&nbsp;signal_recv&nbsp;can&#39;t&nbsp;be&nbsp;blocked&nbsp;in&nbsp;this&nbsp;state.</span><br>
<span class="lineno">20</span><span class="comment" id="1631197">//&nbsp;sigIdle&nbsp;means&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;new&nbsp;pending&nbsp;signals&nbsp;and&nbsp;signal_recv&nbsp;is&nbsp;not&nbsp;blocked.</span><br>
<span class="lineno"></span><span class="comment" id="1631284">//&nbsp;Transitions&nbsp;between&nbsp;states&nbsp;are&nbsp;done&nbsp;atomically&nbsp;with&nbsp;CAS.</span><br>
<span class="lineno"></span><span class="comment" id="1631344">//&nbsp;When&nbsp;signal_recv&nbsp;is&nbsp;unblocked,&nbsp;it&nbsp;resets&nbsp;sig.Note&nbsp;and&nbsp;rechecks&nbsp;sig.mask.</span><br>
<span class="lineno"></span><span class="comment" id="1631420">//&nbsp;If&nbsp;several&nbsp;sigsends&nbsp;and&nbsp;signal_recv&nbsp;execute&nbsp;concurrently,&nbsp;it&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1631496">//&nbsp;unnecessary&nbsp;rechecks&nbsp;of&nbsp;sig.mask,&nbsp;but&nbsp;it&nbsp;cannot&nbsp;lead&nbsp;to&nbsp;missed&nbsp;signals</span><br>
<span class="lineno">25</span><span class="comment" id="1631570">//&nbsp;nor&nbsp;deadlocks.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1631589">package</span>&nbsp;<span class="ident" id="1631597">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1631606">import</span>&nbsp;<span class="string" id="1631613">&#34;unsafe&#34;</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="1631623">var</span>&nbsp;<span class="ident" id="1631627">sig</span>&nbsp;<span class="keyword" id="1631631">struct</span>&nbsp;<span class="op" id="1631638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631641">note</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1631648">note</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631654">mask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1631661">[</span><span class="op" id="1631662">(</span><span class="ident" id="1631663">_NSIG</span>&nbsp;<span class="op" id="1631669">+</span>&nbsp;<span class="num" id="1631671">31</span><span class="op" id="1631673">)</span>&nbsp;<span class="op" id="1631675">/</span>&nbsp;<span class="num" id="1631677">32</span><span class="op" id="1631679">]</span><span class="builtintype" id="1631680">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631688">wanted</span>&nbsp;<span class="op" id="1631695">[</span><span class="op" id="1631696">(</span><span class="ident" id="1631697">_NSIG</span>&nbsp;<span class="op" id="1631703">+</span>&nbsp;<span class="num" id="1631705">31</span><span class="op" id="1631707">)</span>&nbsp;<span class="op" id="1631709">/</span>&nbsp;<span class="num" id="1631711">32</span><span class="op" id="1631713">]</span><span class="builtintype" id="1631714">uint32</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631722">recv</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1631729">[</span><span class="op" id="1631730">(</span><span class="ident" id="1631731">_NSIG</span>&nbsp;<span class="op" id="1631737">+</span>&nbsp;<span class="num" id="1631739">31</span><span class="op" id="1631741">)</span>&nbsp;<span class="op" id="1631743">/</span>&nbsp;<span class="num" id="1631745">32</span><span class="op" id="1631747">]</span><span class="builtintype" id="1631748">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631756">state</span>&nbsp;&nbsp;<span class="builtintype" id="1631763">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631771">inuse</span>&nbsp;&nbsp;<span class="builtintype" id="1631778">bool</span><br>
<span class="lineno"></span><span class="op" id="1631783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="1631786">const</span>&nbsp;<span class="op" id="1631792">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631795">sigIdle</span>&nbsp;<span class="op" id="1631803">=</span>&nbsp;<span class="ident" id="1631805">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631811">sigReceiving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631825">sigSending</span><br>
<span class="lineno"></span><span class="op" id="1631836">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="1631839">//&nbsp;Called&nbsp;from&nbsp;sighandler&nbsp;to&nbsp;send&nbsp;a&nbsp;signal&nbsp;back&nbsp;out&nbsp;of&nbsp;the&nbsp;signal&nbsp;handling&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1631922">//&nbsp;Reports&nbsp;whether&nbsp;the&nbsp;signal&nbsp;was&nbsp;sent.&nbsp;If&nbsp;not,&nbsp;the&nbsp;caller&nbsp;typically&nbsp;crashes&nbsp;the&nbsp;program.</span><br>
<span class="lineno"></span><span class="keyword" id="1632012">func</span>&nbsp;<span class="ident" id="1632017">sigsend</span><span class="op" id="1632024">(</span><span class="ident" id="1632025">s</span>&nbsp;<span class="builtintype" id="1632027">int32</span><span class="op" id="1632032">)</span>&nbsp;<span class="builtintype" id="1632034">bool</span>&nbsp;<span class="op" id="1632039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632042">bit</span>&nbsp;<span class="op" id="1632046">:=</span>&nbsp;<span class="builtintype" id="1632049">uint32</span><span class="op" id="1632055">(</span><span class="num" id="1632056">1</span><span class="op" id="1632057">)</span>&nbsp;<span class="op" id="1632059">&lt;&lt;</span>&nbsp;<span class="builtintype" id="1632062">uint</span><span class="op" id="1632066">(</span><span class="ident" id="1632067">s</span><span class="op" id="1632068">&amp;</span><span class="num" id="1632069">31</span><span class="op" id="1632071">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632074">if</span>&nbsp;<span class="op" id="1632077">!</span><span class="ident" id="1632078">sig</span><span class="op" id="1632081">.</span><span class="ident" id="1632082">inuse</span>&nbsp;<span class="op" id="1632088">||</span>&nbsp;<span class="ident" id="1632091">s</span>&nbsp;<span class="op" id="1632093">&lt;</span>&nbsp;<span class="num" id="1632095">0</span>&nbsp;<span class="op" id="1632097">||</span>&nbsp;<span class="builtintype" id="1632100">int</span><span class="op" id="1632103">(</span><span class="ident" id="1632104">s</span><span class="op" id="1632105">)</span>&nbsp;<span class="op" id="1632107">&gt;=</span>&nbsp;<span class="num" id="1632110">32</span><span class="op" id="1632112">*</span><span class="builtinfunc" id="1632113">len</span><span class="op" id="1632116">(</span><span class="ident" id="1632117">sig</span><span class="op" id="1632120">.</span><span class="ident" id="1632121">wanted</span><span class="op" id="1632127">)</span>&nbsp;<span class="op" id="1632129">||</span>&nbsp;<span class="ident" id="1632132">sig</span><span class="op" id="1632135">.</span><span class="ident" id="1632136">wanted</span><span class="op" id="1632142">[</span><span class="ident" id="1632143">s</span><span class="op" id="1632144">/</span><span class="num" id="1632145">32</span><span class="op" id="1632147">]</span><span class="op" id="1632148">&amp;</span><span class="ident" id="1632149">bit</span>&nbsp;<span class="op" id="1632153">==</span>&nbsp;<span class="num" id="1632156">0</span>&nbsp;<span class="op" id="1632158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632162">return</span>&nbsp;<span class="builtintype" id="1632169">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632180">//&nbsp;Add&nbsp;signal&nbsp;to&nbsp;outgoing&nbsp;queue.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632214">for</span>&nbsp;<span class="op" id="1632218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632222">mask</span>&nbsp;<span class="op" id="1632227">:=</span>&nbsp;<span class="ident" id="1632230">sig</span><span class="op" id="1632233">.</span><span class="ident" id="1632234">mask</span><span class="op" id="1632238">[</span><span class="ident" id="1632239">s</span><span class="op" id="1632240">/</span><span class="num" id="1632241">32</span><span class="op" id="1632243">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632247">if</span>&nbsp;<span class="ident" id="1632250">mask</span><span class="op" id="1632254">&amp;</span><span class="ident" id="1632255">bit</span>&nbsp;<span class="op" id="1632259">!=</span>&nbsp;<span class="num" id="1632262">0</span>&nbsp;<span class="op" id="1632264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632269">return</span>&nbsp;<span class="builtintype" id="1632276">true</span>&nbsp;<span class="comment" id="1632281">//&nbsp;signal&nbsp;already&nbsp;in&nbsp;queue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632310">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632314">if</span>&nbsp;<span class="ident" id="1632317">cas</span><span class="op" id="1632320">(</span><span class="op" id="1632321">&amp;</span><span class="ident" id="1632322">sig</span><span class="op" id="1632325">.</span><span class="ident" id="1632326">mask</span><span class="op" id="1632330">[</span><span class="ident" id="1632331">s</span><span class="op" id="1632332">/</span><span class="num" id="1632333">32</span><span class="op" id="1632335">]</span><span class="op" id="1632336">,</span>&nbsp;<span class="ident" id="1632338">mask</span><span class="op" id="1632342">,</span>&nbsp;<span class="ident" id="1632344">mask</span><span class="op" id="1632348">|</span><span class="ident" id="1632349">bit</span><span class="op" id="1632352">)</span>&nbsp;<span class="op" id="1632354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632359">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632374">//&nbsp;Notify&nbsp;receiver&nbsp;that&nbsp;queue&nbsp;has&nbsp;new&nbsp;bit.</span><br>
<span class="lineno"></span><span class="ident" id="1632417">Send</span><span class="op" id="1632421">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632424">for</span>&nbsp;<span class="op" id="1632428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632432">switch</span>&nbsp;<span class="ident" id="1632439">atomicload</span><span class="op" id="1632449">(</span><span class="op" id="1632450">&amp;</span><span class="ident" id="1632451">sig</span><span class="op" id="1632454">.</span><span class="ident" id="1632455">state</span><span class="op" id="1632460">)</span>&nbsp;<span class="op" id="1632462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632466">default</span><span class="op" id="1632473">:</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632478">gothrow</span><span class="op" id="1632485">(</span><span class="string" id="1632486">&#34;sigsend:&nbsp;inconsistent&nbsp;state&#34;</span><span class="op" id="1632515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632519">case</span>&nbsp;<span class="ident" id="1632524">sigIdle</span><span class="op" id="1632531">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632536">if</span>&nbsp;<span class="ident" id="1632539">cas</span><span class="op" id="1632542">(</span><span class="op" id="1632543">&amp;</span><span class="ident" id="1632544">sig</span><span class="op" id="1632547">.</span><span class="ident" id="1632548">state</span><span class="op" id="1632553">,</span>&nbsp;<span class="ident" id="1632555">sigIdle</span><span class="op" id="1632562">,</span>&nbsp;<span class="ident" id="1632564">sigSending</span><span class="op" id="1632574">)</span>&nbsp;<span class="op" id="1632576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632582">break</span>&nbsp;<span class="ident" id="1632588">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632596">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632600">case</span>&nbsp;<span class="ident" id="1632605">sigSending</span><span class="op" id="1632615">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632620">//&nbsp;notification&nbsp;already&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632655">break</span>&nbsp;<span class="ident" id="1632661">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632668">case</span>&nbsp;<span class="ident" id="1632673">sigReceiving</span><span class="op" id="1632685">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632690">if</span>&nbsp;<span class="ident" id="1632693">cas</span><span class="op" id="1632696">(</span><span class="op" id="1632697">&amp;</span><span class="ident" id="1632698">sig</span><span class="op" id="1632701">.</span><span class="ident" id="1632702">state</span><span class="op" id="1632707">,</span>&nbsp;<span class="ident" id="1632709">sigReceiving</span><span class="op" id="1632721">,</span>&nbsp;<span class="ident" id="1632723">sigIdle</span><span class="op" id="1632730">)</span>&nbsp;<span class="op" id="1632732">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632738">notewakeup</span><span class="op" id="1632748">(</span><span class="op" id="1632749">&amp;</span><span class="ident" id="1632750">sig</span><span class="op" id="1632753">.</span><span class="ident" id="1632754">note</span><span class="op" id="1632758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632764">break</span>&nbsp;<span class="ident" id="1632770">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632785">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632789">return</span>&nbsp;<span class="builtintype" id="1632796">true</span><br>
<span class="lineno"></span><span class="op" id="1632801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1632804">//&nbsp;Called&nbsp;to&nbsp;receive&nbsp;the&nbsp;next&nbsp;queued&nbsp;signal.</span><br>
<span class="lineno">90</span><span class="comment" id="1632849">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1632907">func</span>&nbsp;<span class="ident" id="1632912">signal_recv</span><span class="op" id="1632923">(</span><span class="op" id="1632924">)</span>&nbsp;<span class="builtintype" id="1632926">uint32</span>&nbsp;<span class="op" id="1632933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632936">for</span>&nbsp;<span class="op" id="1632940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632944">//&nbsp;Serve&nbsp;any&nbsp;signals&nbsp;from&nbsp;local&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632984">for</span>&nbsp;<span class="ident" id="1632988">i</span>&nbsp;<span class="op" id="1632990">:=</span>&nbsp;<span class="builtintype" id="1632993">uint32</span><span class="op" id="1632999">(</span><span class="num" id="1633000">0</span><span class="op" id="1633001">)</span><span class="op" id="1633002">;</span>&nbsp;<span class="ident" id="1633004">i</span>&nbsp;<span class="op" id="1633006">&lt;</span>&nbsp;<span class="ident" id="1633008">_NSIG</span><span class="op" id="1633013">;</span>&nbsp;<span class="ident" id="1633015">i</span><span class="op" id="1633016">++</span>&nbsp;<span class="op" id="1633019">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633024">if</span>&nbsp;<span class="ident" id="1633027">sig</span><span class="op" id="1633030">.</span><span class="ident" id="1633031">recv</span><span class="op" id="1633035">[</span><span class="ident" id="1633036">i</span><span class="op" id="1633037">/</span><span class="num" id="1633038">32</span><span class="op" id="1633040">]</span><span class="op" id="1633041">&amp;</span><span class="op" id="1633042">(</span><span class="num" id="1633043">1</span><span class="op" id="1633044">&lt;&lt;</span><span class="op" id="1633046">(</span><span class="ident" id="1633047">i</span><span class="op" id="1633048">&amp;</span><span class="num" id="1633049">31</span><span class="op" id="1633051">)</span><span class="op" id="1633052">)</span>&nbsp;<span class="op" id="1633054">!=</span>&nbsp;<span class="num" id="1633057">0</span>&nbsp;<span class="op" id="1633059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633065">sig</span><span class="op" id="1633068">.</span><span class="ident" id="1633069">recv</span><span class="op" id="1633073">[</span><span class="ident" id="1633074">i</span><span class="op" id="1633075">/</span><span class="num" id="1633076">32</span><span class="op" id="1633078">]</span>&nbsp;<span class="op" id="1633080">&amp;^=</span>&nbsp;<span class="num" id="1633084">1</span>&nbsp;<span class="op" id="1633086">&lt;&lt;</span>&nbsp;<span class="op" id="1633089">(</span><span class="ident" id="1633090">i</span>&nbsp;<span class="op" id="1633092">&amp;</span>&nbsp;<span class="num" id="1633094">31</span><span class="op" id="1633096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633102">return</span>&nbsp;<span class="ident" id="1633109">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633118">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1633123">//&nbsp;Wait&nbsp;for&nbsp;updates&nbsp;to&nbsp;be&nbsp;available&nbsp;from&nbsp;signal&nbsp;sender.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633180">Receive</span><span class="op" id="1633187">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633191">for</span>&nbsp;<span class="op" id="1633195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633200">switch</span>&nbsp;<span class="ident" id="1633207">atomicload</span><span class="op" id="1633217">(</span><span class="op" id="1633218">&amp;</span><span class="ident" id="1633219">sig</span><span class="op" id="1633222">.</span><span class="ident" id="1633223">state</span><span class="op" id="1633228">)</span>&nbsp;<span class="op" id="1633230">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633235">default</span><span class="op" id="1633242">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633248">gothrow</span><span class="op" id="1633255">(</span><span class="string" id="1633256">&#34;signal_recv:&nbsp;inconsistent&nbsp;state&#34;</span><span class="op" id="1633289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633294">case</span>&nbsp;<span class="ident" id="1633299">sigIdle</span><span class="op" id="1633306">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633312">if</span>&nbsp;<span class="ident" id="1633315">cas</span><span class="op" id="1633318">(</span><span class="op" id="1633319">&amp;</span><span class="ident" id="1633320">sig</span><span class="op" id="1633323">.</span><span class="ident" id="1633324">state</span><span class="op" id="1633329">,</span>&nbsp;<span class="ident" id="1633331">sigIdle</span><span class="op" id="1633338">,</span>&nbsp;<span class="ident" id="1633340">sigReceiving</span><span class="op" id="1633352">)</span>&nbsp;<span class="op" id="1633354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633361">notetsleepg</span><span class="op" id="1633372">(</span><span class="op" id="1633373">&amp;</span><span class="ident" id="1633374">sig</span><span class="op" id="1633377">.</span><span class="ident" id="1633378">note</span><span class="op" id="1633382">,</span>&nbsp;<span class="op" id="1633384">-</span><span class="num" id="1633385">1</span><span class="op" id="1633386">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633393">noteclear</span><span class="op" id="1633402">(</span><span class="op" id="1633403">&amp;</span><span class="ident" id="1633404">sig</span><span class="op" id="1633407">.</span><span class="ident" id="1633408">note</span><span class="op" id="1633412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633419">break</span>&nbsp;<span class="ident" id="1633425">Receive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633442">case</span>&nbsp;<span class="ident" id="1633447">sigSending</span><span class="op" id="1633457">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633463">if</span>&nbsp;<span class="ident" id="1633466">cas</span><span class="op" id="1633469">(</span><span class="op" id="1633470">&amp;</span><span class="ident" id="1633471">sig</span><span class="op" id="1633474">.</span><span class="ident" id="1633475">state</span><span class="op" id="1633480">,</span>&nbsp;<span class="ident" id="1633482">sigSending</span><span class="op" id="1633492">,</span>&nbsp;<span class="ident" id="1633494">sigIdle</span><span class="op" id="1633501">)</span>&nbsp;<span class="op" id="1633503">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633510">break</span>&nbsp;<span class="ident" id="1633516">Receive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1633542">//&nbsp;Incorporate&nbsp;updates&nbsp;from&nbsp;sender&nbsp;into&nbsp;local&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633596">for</span>&nbsp;<span class="ident" id="1633600">i</span>&nbsp;<span class="op" id="1633602">:=</span>&nbsp;<span class="keyword" id="1633605">range</span>&nbsp;<span class="ident" id="1633611">sig</span><span class="op" id="1633614">.</span><span class="ident" id="1633615">mask</span>&nbsp;<span class="op" id="1633620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633625">sig</span><span class="op" id="1633628">.</span><span class="ident" id="1633629">recv</span><span class="op" id="1633633">[</span><span class="ident" id="1633634">i</span><span class="op" id="1633635">]</span>&nbsp;<span class="op" id="1633637">=</span>&nbsp;<span class="ident" id="1633639">xchg</span><span class="op" id="1633643">(</span><span class="op" id="1633644">&amp;</span><span class="ident" id="1633645">sig</span><span class="op" id="1633648">.</span><span class="ident" id="1633649">mask</span><span class="op" id="1633653">[</span><span class="ident" id="1633654">i</span><span class="op" id="1633655">]</span><span class="op" id="1633656">,</span>&nbsp;<span class="num" id="1633658">0</span><span class="op" id="1633659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633666">}</span><br>
<span class="lineno">125</span><span class="op" id="1633668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1633671">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1633729">func</span>&nbsp;<span class="ident" id="1633734">signal_enable</span><span class="op" id="1633747">(</span><span class="ident" id="1633748">s</span>&nbsp;<span class="builtintype" id="1633750">uint32</span><span class="op" id="1633756">)</span>&nbsp;<span class="op" id="1633758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633761">if</span>&nbsp;<span class="op" id="1633764">!</span><span class="ident" id="1633765">sig</span><span class="op" id="1633768">.</span><span class="ident" id="1633769">inuse</span>&nbsp;<span class="op" id="1633775">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1633779">//&nbsp;The&nbsp;first&nbsp;call&nbsp;to&nbsp;signal_enable&nbsp;is&nbsp;for&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1633826">//&nbsp;to&nbsp;use&nbsp;for&nbsp;initialization.&nbsp;&nbsp;It&nbsp;does&nbsp;not&nbsp;pass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1633876">//&nbsp;signal&nbsp;information&nbsp;in&nbsp;m.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633906">sig</span><span class="op" id="1633909">.</span><span class="ident" id="1633910">inuse</span>&nbsp;<span class="op" id="1633916">=</span>&nbsp;<span class="builtintype" id="1633918">true</span>&nbsp;<span class="comment" id="1633923">//&nbsp;enable&nbsp;reception&nbsp;of&nbsp;signals;&nbsp;cannot&nbsp;disable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633972">noteclear</span><span class="op" id="1633981">(</span><span class="op" id="1633982">&amp;</span><span class="ident" id="1633983">sig</span><span class="op" id="1633986">.</span><span class="ident" id="1633987">note</span><span class="op" id="1633991">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633995">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634007">if</span>&nbsp;<span class="builtintype" id="1634010">int</span><span class="op" id="1634013">(</span><span class="ident" id="1634014">s</span><span class="op" id="1634015">)</span>&nbsp;<span class="op" id="1634017">&gt;=</span>&nbsp;<span class="builtinfunc" id="1634020">len</span><span class="op" id="1634023">(</span><span class="ident" id="1634024">sig</span><span class="op" id="1634027">.</span><span class="ident" id="1634028">wanted</span><span class="op" id="1634034">)</span><span class="op" id="1634035">*</span><span class="num" id="1634036">32</span>&nbsp;<span class="op" id="1634039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634043">return</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634054">sig</span><span class="op" id="1634057">.</span><span class="ident" id="1634058">wanted</span><span class="op" id="1634064">[</span><span class="ident" id="1634065">s</span><span class="op" id="1634066">/</span><span class="num" id="1634067">32</span><span class="op" id="1634069">]</span>&nbsp;<span class="op" id="1634071">|=</span>&nbsp;<span class="num" id="1634074">1</span>&nbsp;<span class="op" id="1634076">&lt;&lt;</span>&nbsp;<span class="op" id="1634079">(</span><span class="ident" id="1634080">s</span>&nbsp;<span class="op" id="1634082">&amp;</span>&nbsp;<span class="num" id="1634084">31</span><span class="op" id="1634086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634089">sigenable_go</span><span class="op" id="1634101">(</span><span class="ident" id="1634102">s</span><span class="op" id="1634103">)</span><br>
<span class="lineno"></span><span class="op" id="1634105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="1634108">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1634166">func</span>&nbsp;<span class="ident" id="1634171">signal_disable</span><span class="op" id="1634185">(</span><span class="ident" id="1634186">s</span>&nbsp;<span class="builtintype" id="1634188">uint32</span><span class="op" id="1634194">)</span>&nbsp;<span class="op" id="1634196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634199">if</span>&nbsp;<span class="builtintype" id="1634202">int</span><span class="op" id="1634205">(</span><span class="ident" id="1634206">s</span><span class="op" id="1634207">)</span>&nbsp;<span class="op" id="1634209">&gt;=</span>&nbsp;<span class="builtinfunc" id="1634212">len</span><span class="op" id="1634215">(</span><span class="ident" id="1634216">sig</span><span class="op" id="1634219">.</span><span class="ident" id="1634220">wanted</span><span class="op" id="1634226">)</span><span class="op" id="1634227">*</span><span class="num" id="1634228">32</span>&nbsp;<span class="op" id="1634231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634235">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634243">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634246">sig</span><span class="op" id="1634249">.</span><span class="ident" id="1634250">wanted</span><span class="op" id="1634256">[</span><span class="ident" id="1634257">s</span><span class="op" id="1634258">/</span><span class="num" id="1634259">32</span><span class="op" id="1634261">]</span>&nbsp;<span class="op" id="1634263">&amp;^=</span>&nbsp;<span class="num" id="1634267">1</span>&nbsp;<span class="op" id="1634269">&lt;&lt;</span>&nbsp;<span class="op" id="1634272">(</span><span class="ident" id="1634273">s</span>&nbsp;<span class="op" id="1634275">&amp;</span>&nbsp;<span class="num" id="1634277">31</span><span class="op" id="1634279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634282">sigdisable_go</span><span class="op" id="1634295">(</span><span class="ident" id="1634296">s</span><span class="op" id="1634297">)</span><br>
<span class="lineno"></span><span class="op" id="1634299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1634302">//&nbsp;This&nbsp;runs&nbsp;on&nbsp;a&nbsp;foreign&nbsp;stack,&nbsp;without&nbsp;an&nbsp;m&nbsp;or&nbsp;a&nbsp;g.&nbsp;&nbsp;No&nbsp;stack&nbsp;split.</span><br>
<span class="lineno">155</span><span class="comment" id="1634373">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1634386">func</span>&nbsp;<span class="ident" id="1634391">badsignal</span><span class="op" id="1634400">(</span><span class="ident" id="1634401">sig</span>&nbsp;<span class="builtintype" id="1634405">uintptr</span><span class="op" id="1634412">)</span>&nbsp;<span class="op" id="1634414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634417">cgocallback</span><span class="op" id="1634428">(</span><span class="ident" id="1634429">unsafe</span><span class="op" id="1634435">.</span><span class="ident" id="1634436">Pointer</span><span class="op" id="1634443">(</span><span class="ident" id="1634444">funcPC</span><span class="op" id="1634450">(</span><span class="ident" id="1634451">sigsend</span><span class="op" id="1634458">)</span><span class="op" id="1634459">)</span><span class="op" id="1634460">,</span>&nbsp;<span class="ident" id="1634462">noescape</span><span class="op" id="1634470">(</span><span class="ident" id="1634471">unsafe</span><span class="op" id="1634477">.</span><span class="ident" id="1634478">Pointer</span><span class="op" id="1634485">(</span><span class="op" id="1634486">&amp;</span><span class="ident" id="1634487">sig</span><span class="op" id="1634490">)</span><span class="op" id="1634491">)</span><span class="op" id="1634492">,</span>&nbsp;<span class="ident" id="1634494">unsafe</span><span class="op" id="1634500">.</span><span class="ident" id="1634501">Sizeof</span><span class="op" id="1634507">(</span><span class="ident" id="1634508">sig</span><span class="op" id="1634511">)</span><span class="op" id="1634512">)</span><br>
<span class="lineno"></span><span class="op" id="1634514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="1634517">func</span>&nbsp;<span class="ident" id="1634522">sigenable_m</span><span class="op" id="1634533">(</span><span class="op" id="1634534">)</span><br>
<span class="lineno"></span><span class="keyword" id="1634536">func</span>&nbsp;<span class="ident" id="1634541">sigdisable_m</span><span class="op" id="1634553">(</span><span class="op" id="1634554">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1634557">func</span>&nbsp;<span class="ident" id="1634562">sigenable_go</span><span class="op" id="1634574">(</span><span class="ident" id="1634575">s</span>&nbsp;<span class="builtintype" id="1634577">uint32</span><span class="op" id="1634583">)</span>&nbsp;<span class="op" id="1634585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634588">g</span>&nbsp;<span class="op" id="1634590">:=</span>&nbsp;<span class="ident" id="1634593">getg</span><span class="op" id="1634597">(</span><span class="op" id="1634598">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634601">g</span><span class="op" id="1634602">.</span><span class="ident" id="1634603">m</span><span class="op" id="1634604">.</span><span class="ident" id="1634605">scalararg</span><span class="op" id="1634614">[</span><span class="num" id="1634615">0</span><span class="op" id="1634616">]</span>&nbsp;<span class="op" id="1634618">=</span>&nbsp;<span class="builtintype" id="1634620">uintptr</span><span class="op" id="1634627">(</span><span class="ident" id="1634628">s</span><span class="op" id="1634629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634632">onM</span><span class="op" id="1634635">(</span><span class="ident" id="1634636">sigenable_m</span><span class="op" id="1634647">)</span><br>
<span class="lineno"></span><span class="op" id="1634649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1634652">func</span>&nbsp;<span class="ident" id="1634657">sigdisable_go</span><span class="op" id="1634670">(</span><span class="ident" id="1634671">s</span>&nbsp;<span class="builtintype" id="1634673">uint32</span><span class="op" id="1634679">)</span>&nbsp;<span class="op" id="1634681">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634684">g</span>&nbsp;<span class="op" id="1634686">:=</span>&nbsp;<span class="ident" id="1634689">getg</span><span class="op" id="1634693">(</span><span class="op" id="1634694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634697">g</span><span class="op" id="1634698">.</span><span class="ident" id="1634699">m</span><span class="op" id="1634700">.</span><span class="ident" id="1634701">scalararg</span><span class="op" id="1634710">[</span><span class="num" id="1634711">0</span><span class="op" id="1634712">]</span>&nbsp;<span class="op" id="1634714">=</span>&nbsp;<span class="builtintype" id="1634716">uintptr</span><span class="op" id="1634723">(</span><span class="ident" id="1634724">s</span><span class="op" id="1634725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634728">onM</span><span class="op" id="1634731">(</span><span class="ident" id="1634732">sigdisable_m</span><span class="op" id="1634744">)</span><br>
<span class="lineno"></span><span class="op" id="1634746">}</span>
</div>
</body>
</html>
