<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>expvar</h2>
<ul>
<li><a href="/gostd/expvar/expvar.go.html">expvar.go</a></li>
<li><a href="/gostd/expvar/expvar_test.go.html">expvar_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5434641">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5434696">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5434750">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5434801">//&nbsp;Package&nbsp;expvar&nbsp;provides&nbsp;a&nbsp;standardized&nbsp;interface&nbsp;to&nbsp;public&nbsp;variables,&nbsp;such</span><br>
<span class="lineno"></span><span class="comment" id="5434879">//&nbsp;as&nbsp;operation&nbsp;counters&nbsp;in&nbsp;servers.&nbsp;It&nbsp;exposes&nbsp;these&nbsp;variables&nbsp;via&nbsp;HTTP&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5434955">//&nbsp;/debug/vars&nbsp;in&nbsp;JSON&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="5434986">//</span><br>
<span class="lineno"></span><span class="comment" id="5434989">//&nbsp;Operations&nbsp;to&nbsp;set&nbsp;or&nbsp;modify&nbsp;these&nbsp;public&nbsp;variables&nbsp;are&nbsp;atomic.</span><br>
<span class="lineno">10</span><span class="comment" id="5435055">//</span><br>
<span class="lineno"></span><span class="comment" id="5435058">//&nbsp;In&nbsp;addition&nbsp;to&nbsp;adding&nbsp;the&nbsp;HTTP&nbsp;handler,&nbsp;this&nbsp;package&nbsp;registers&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5435128">//&nbsp;following&nbsp;variables:</span><br>
<span class="lineno"></span><span class="comment" id="5435152">//</span><br>
<span class="lineno"></span><span class="comment" id="5435155">//&nbsp;&nbsp;&nbsp;&nbspcmdline&nbsp;&nbsp;&nbsp;os.Args</span><br>
<span class="lineno">15</span><span class="comment" id="5435176">//&nbsp;&nbsp;&nbsp;&nbspmemstats&nbsp;&nbsp;runtime.Memstats</span><br>
<span class="lineno"></span><span class="comment" id="5435206">//</span><br>
<span class="lineno"></span><span class="comment" id="5435209">//&nbsp;The&nbsp;package&nbsp;is&nbsp;sometimes&nbsp;only&nbsp;imported&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5435274">//&nbsp;registering&nbsp;its&nbsp;HTTP&nbsp;handler&nbsp;and&nbsp;the&nbsp;above&nbsp;variables.&nbsp;&nbsp;To&nbsp;use&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5435342">//&nbsp;this&nbsp;way,&nbsp;link&nbsp;this&nbsp;package&nbsp;into&nbsp;your&nbsp;program:</span><br>
<span class="lineno">20</span><span class="comment" id="5435392">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;_&nbsp;&#34;expvar&#34;</span><br>
<span class="lineno"></span><span class="comment" id="5435413">//</span><br>
<span class="lineno"></span><span class="keyword" id="5435416">package</span>&nbsp;<span class="ident" id="5435424">expvar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5435432">import</span>&nbsp;<span class="op" id="5435439">(</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5435442">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5435451">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5435468">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5435475">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5435482">&#34;net/http&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5435494">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5435500">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5435511">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5435519">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5435530">&#34;sync&#34;</span><br>
<span class="lineno">35</span><span class="op" id="5435537">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5435540">//&nbsp;Var&nbsp;is&nbsp;an&nbsp;abstract&nbsp;type&nbsp;for&nbsp;all&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5435595">type</span>&nbsp;<span class="ident" id="5435600">Var</span>&nbsp;<span class="keyword" id="5435604">interface</span>&nbsp;<span class="op" id="5435614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5435617">String</span><span class="op" id="5435623">(</span><span class="op" id="5435624">)</span>&nbsp;<span class="builtintype" id="5435626">string</span><br>
<span class="lineno">40</span><span class="op" id="5435633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5435636">//&nbsp;Int&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;integer&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5435706">type</span>&nbsp;<span class="ident" id="5435711">Int</span>&nbsp;<span class="keyword" id="5435715">struct</span>&nbsp;<span class="op" id="5435722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5435725">mu</span>&nbsp;<span class="ident" id="5435728">sync</span><span class="op" id="5435732">.</span><span class="ident" id="5435733">RWMutex</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5435742">i</span>&nbsp;&nbsp;<span class="ident" id="5435745">int64</span><br>
<span class="lineno"></span><span class="op" id="5435751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5435754">func</span>&nbsp;<span class="op" id="5435759">(</span><span class="ident" id="5435760">v</span>&nbsp;<span class="op" id="5435762">*</span><span class="ident" id="5435763">Int</span><span class="op" id="5435766">)</span>&nbsp;<span class="ident" id="5435768">String</span><span class="op" id="5435774">(</span><span class="op" id="5435775">)</span>&nbsp;<span class="builtintype" id="5435777">string</span>&nbsp;<span class="op" id="5435784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5435787">v</span><span class="op" id="5435788">.</span><span class="ident" id="5435789">mu</span><span class="op" id="5435791">.</span><span class="ident" id="5435792">RLock</span><span class="op" id="5435797">(</span><span class="op" id="5435798">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5435801">defer</span>&nbsp;<span class="ident" id="5435807">v</span><span class="op" id="5435808">.</span><span class="ident" id="5435809">mu</span><span class="op" id="5435811">.</span><span class="ident" id="5435812">RUnlock</span><span class="op" id="5435819">(</span><span class="op" id="5435820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5435823">return</span>&nbsp;<span class="ident" id="5435830">strconv</span><span class="op" id="5435837">.</span><span class="ident" id="5435838">FormatInt</span><span class="op" id="5435847">(</span><span class="ident" id="5435848">v</span><span class="op" id="5435849">.</span><span class="ident" id="5435850">i</span><span class="op" id="5435851">,</span>&nbsp;<span class="num" id="5435853">10</span><span class="op" id="5435855">)</span><br>
<span class="lineno"></span><span class="op" id="5435857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5435860">func</span>&nbsp;<span class="op" id="5435865">(</span><span class="ident" id="5435866">v</span>&nbsp;<span class="op" id="5435868">*</span><span class="ident" id="5435869">Int</span><span class="op" id="5435872">)</span>&nbsp;<span class="ident" id="5435874">Add</span><span class="op" id="5435877">(</span><span class="ident" id="5435878">delta</span>&nbsp;<span class="ident" id="5435884">int64</span><span class="op" id="5435889">)</span>&nbsp;<span class="op" id="5435891">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5435894">v</span><span class="op" id="5435895">.</span><span class="ident" id="5435896">mu</span><span class="op" id="5435898">.</span><span class="ident" id="5435899">Lock</span><span class="op" id="5435903">(</span><span class="op" id="5435904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5435907">defer</span>&nbsp;<span class="ident" id="5435913">v</span><span class="op" id="5435914">.</span><span class="ident" id="5435915">mu</span><span class="op" id="5435917">.</span><span class="ident" id="5435918">Unlock</span><span class="op" id="5435924">(</span><span class="op" id="5435925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5435928">v</span><span class="op" id="5435929">.</span><span class="ident" id="5435930">i</span>&nbsp;<span class="op" id="5435932">+=</span>&nbsp;<span class="ident" id="5435935">delta</span><br>
<span class="lineno"></span><span class="op" id="5435941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5435944">func</span>&nbsp;<span class="op" id="5435949">(</span><span class="ident" id="5435950">v</span>&nbsp;<span class="op" id="5435952">*</span><span class="ident" id="5435953">Int</span><span class="op" id="5435956">)</span>&nbsp;<span class="ident" id="5435958">Set</span><span class="op" id="5435961">(</span><span class="ident" id="5435962">value</span>&nbsp;<span class="ident" id="5435968">int64</span><span class="op" id="5435973">)</span>&nbsp;<span class="op" id="5435975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5435978">v</span><span class="op" id="5435979">.</span><span class="ident" id="5435980">mu</span><span class="op" id="5435982">.</span><span class="ident" id="5435983">Lock</span><span class="op" id="5435987">(</span><span class="op" id="5435988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5435991">defer</span>&nbsp;<span class="ident" id="5435997">v</span><span class="op" id="5435998">.</span><span class="ident" id="5435999">mu</span><span class="op" id="5436001">.</span><span class="ident" id="5436002">Unlock</span><span class="op" id="5436008">(</span><span class="op" id="5436009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436012">v</span><span class="op" id="5436013">.</span><span class="ident" id="5436014">i</span>&nbsp;<span class="op" id="5436016">=</span>&nbsp;<span class="ident" id="5436018">value</span><br>
<span class="lineno"></span><span class="op" id="5436024">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="5436027">//&nbsp;Float&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;float&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5436097">type</span>&nbsp;<span class="ident" id="5436102">Float</span>&nbsp;<span class="keyword" id="5436108">struct</span>&nbsp;<span class="op" id="5436115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436118">mu</span>&nbsp;<span class="ident" id="5436121">sync</span><span class="op" id="5436125">.</span><span class="ident" id="5436126">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436135">f</span>&nbsp;&nbsp;<span class="builtintype" id="5436138">float64</span><br>
<span class="lineno">70</span><span class="op" id="5436146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5436149">func</span>&nbsp;<span class="op" id="5436154">(</span><span class="ident" id="5436155">v</span>&nbsp;<span class="op" id="5436157">*</span><span class="ident" id="5436158">Float</span><span class="op" id="5436163">)</span>&nbsp;<span class="ident" id="5436165">String</span><span class="op" id="5436171">(</span><span class="op" id="5436172">)</span>&nbsp;<span class="builtintype" id="5436174">string</span>&nbsp;<span class="op" id="5436181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436184">v</span><span class="op" id="5436185">.</span><span class="ident" id="5436186">mu</span><span class="op" id="5436188">.</span><span class="ident" id="5436189">RLock</span><span class="op" id="5436194">(</span><span class="op" id="5436195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5436198">defer</span>&nbsp;<span class="ident" id="5436204">v</span><span class="op" id="5436205">.</span><span class="ident" id="5436206">mu</span><span class="op" id="5436208">.</span><span class="ident" id="5436209">RUnlock</span><span class="op" id="5436216">(</span><span class="op" id="5436217">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5436220">return</span>&nbsp;<span class="ident" id="5436227">strconv</span><span class="op" id="5436234">.</span><span class="ident" id="5436235">FormatFloat</span><span class="op" id="5436246">(</span><span class="ident" id="5436247">v</span><span class="op" id="5436248">.</span><span class="ident" id="5436249">f</span><span class="op" id="5436250">,</span>&nbsp;<span class="string" id="5436252">&#39;g&#39;</span><span class="op" id="5436255">,</span>&nbsp;<span class="op" id="5436257">-</span><span class="num" id="5436258">1</span><span class="op" id="5436259">,</span>&nbsp;<span class="num" id="5436261">64</span><span class="op" id="5436263">)</span><br>
<span class="lineno"></span><span class="op" id="5436265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5436268">//&nbsp;Add&nbsp;adds&nbsp;delta&nbsp;to&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5436292">func</span>&nbsp;<span class="op" id="5436297">(</span><span class="ident" id="5436298">v</span>&nbsp;<span class="op" id="5436300">*</span><span class="ident" id="5436301">Float</span><span class="op" id="5436306">)</span>&nbsp;<span class="ident" id="5436308">Add</span><span class="op" id="5436311">(</span><span class="ident" id="5436312">delta</span>&nbsp;<span class="builtintype" id="5436318">float64</span><span class="op" id="5436325">)</span>&nbsp;<span class="op" id="5436327">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436330">v</span><span class="op" id="5436331">.</span><span class="ident" id="5436332">mu</span><span class="op" id="5436334">.</span><span class="ident" id="5436335">Lock</span><span class="op" id="5436339">(</span><span class="op" id="5436340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5436343">defer</span>&nbsp;<span class="ident" id="5436349">v</span><span class="op" id="5436350">.</span><span class="ident" id="5436351">mu</span><span class="op" id="5436353">.</span><span class="ident" id="5436354">Unlock</span><span class="op" id="5436360">(</span><span class="op" id="5436361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436364">v</span><span class="op" id="5436365">.</span><span class="ident" id="5436366">f</span>&nbsp;<span class="op" id="5436368">+=</span>&nbsp;<span class="ident" id="5436371">delta</span><br>
<span class="lineno"></span><span class="op" id="5436377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="5436380">//&nbsp;Set&nbsp;sets&nbsp;v&nbsp;to&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5436404">func</span>&nbsp;<span class="op" id="5436409">(</span><span class="ident" id="5436410">v</span>&nbsp;<span class="op" id="5436412">*</span><span class="ident" id="5436413">Float</span><span class="op" id="5436418">)</span>&nbsp;<span class="ident" id="5436420">Set</span><span class="op" id="5436423">(</span><span class="ident" id="5436424">value</span>&nbsp;<span class="builtintype" id="5436430">float64</span><span class="op" id="5436437">)</span>&nbsp;<span class="op" id="5436439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436442">v</span><span class="op" id="5436443">.</span><span class="ident" id="5436444">mu</span><span class="op" id="5436446">.</span><span class="ident" id="5436447">Lock</span><span class="op" id="5436451">(</span><span class="op" id="5436452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5436455">defer</span>&nbsp;<span class="ident" id="5436461">v</span><span class="op" id="5436462">.</span><span class="ident" id="5436463">mu</span><span class="op" id="5436465">.</span><span class="ident" id="5436466">Unlock</span><span class="op" id="5436472">(</span><span class="op" id="5436473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436476">v</span><span class="op" id="5436477">.</span><span class="ident" id="5436478">f</span>&nbsp;<span class="op" id="5436480">=</span>&nbsp;<span class="ident" id="5436482">value</span><br>
<span class="lineno">90</span><span class="op" id="5436488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5436491">//&nbsp;Map&nbsp;is&nbsp;a&nbsp;string-to-Var&nbsp;map&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5436564">type</span>&nbsp;<span class="ident" id="5436569">Map</span>&nbsp;<span class="keyword" id="5436573">struct</span>&nbsp;<span class="op" id="5436580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436583">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5436588">sync</span><span class="op" id="5436592">.</span><span class="ident" id="5436593">RWMutex</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436602">m</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5436607">map</span><span class="op" id="5436610">[</span><span class="builtintype" id="5436611">string</span><span class="op" id="5436617">]</span><span class="ident" id="5436618">Var</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436623">keys</span>&nbsp;<span class="op" id="5436628">[</span><span class="op" id="5436629">]</span><span class="builtintype" id="5436630">string</span>&nbsp;<span class="comment" id="5436637">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="5436647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5436650">//&nbsp;KeyValue&nbsp;represents&nbsp;a&nbsp;single&nbsp;entry&nbsp;in&nbsp;a&nbsp;Map.</span><br>
<span class="lineno">100</span><span class="keyword" id="5436698">type</span>&nbsp;<span class="ident" id="5436703">KeyValue</span>&nbsp;<span class="keyword" id="5436712">struct</span>&nbsp;<span class="op" id="5436719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436722">Key</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5436728">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436736">Value</span>&nbsp;<span class="ident" id="5436742">Var</span><br>
<span class="lineno"></span><span class="op" id="5436746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="5436749">func</span>&nbsp;<span class="op" id="5436754">(</span><span class="ident" id="5436755">v</span>&nbsp;<span class="op" id="5436757">*</span><span class="ident" id="5436758">Map</span><span class="op" id="5436761">)</span>&nbsp;<span class="ident" id="5436763">String</span><span class="op" id="5436769">(</span><span class="op" id="5436770">)</span>&nbsp;<span class="builtintype" id="5436772">string</span>&nbsp;<span class="op" id="5436779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436782">v</span><span class="op" id="5436783">.</span><span class="ident" id="5436784">mu</span><span class="op" id="5436786">.</span><span class="ident" id="5436787">RLock</span><span class="op" id="5436792">(</span><span class="op" id="5436793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5436796">defer</span>&nbsp;<span class="ident" id="5436802">v</span><span class="op" id="5436803">.</span><span class="ident" id="5436804">mu</span><span class="op" id="5436806">.</span><span class="ident" id="5436807">RUnlock</span><span class="op" id="5436814">(</span><span class="op" id="5436815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5436818">var</span>&nbsp;<span class="ident" id="5436822">b</span>&nbsp;<span class="ident" id="5436824">bytes</span><span class="op" id="5436829">.</span><span class="ident" id="5436830">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436838">fmt</span><span class="op" id="5436841">.</span><span class="ident" id="5436842">Fprintf</span><span class="op" id="5436849">(</span><span class="op" id="5436850">&amp;</span><span class="ident" id="5436851">b</span><span class="op" id="5436852">,</span>&nbsp;<span class="string" id="5436854">&#34;{&#34;</span><span class="op" id="5436857">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436860">first</span>&nbsp;<span class="op" id="5436866">:=</span>&nbsp;<span class="builtintype" id="5436869">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436875">v</span><span class="op" id="5436876">.</span><span class="ident" id="5436877">doLocked</span><span class="op" id="5436885">(</span><span class="keyword" id="5436886">func</span><span class="op" id="5436890">(</span><span class="ident" id="5436891">kv</span>&nbsp;<span class="ident" id="5436894">KeyValue</span><span class="op" id="5436902">)</span>&nbsp;<span class="op" id="5436904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5436908">if</span>&nbsp;<span class="op" id="5436911">!</span><span class="ident" id="5436912">first</span>&nbsp;<span class="op" id="5436918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436923">fmt</span><span class="op" id="5436926">.</span><span class="ident" id="5436927">Fprintf</span><span class="op" id="5436934">(</span><span class="op" id="5436935">&amp;</span><span class="ident" id="5436936">b</span><span class="op" id="5436937">,</span>&nbsp;<span class="string" id="5436939">&#34;,&nbsp;&#34;</span><span class="op" id="5436943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5436947">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436951">fmt</span><span class="op" id="5436954">.</span><span class="ident" id="5436955">Fprintf</span><span class="op" id="5436962">(</span><span class="op" id="5436963">&amp;</span><span class="ident" id="5436964">b</span><span class="op" id="5436965">,</span>&nbsp;<span class="string" id="5436967">&#34;%q:&nbsp;%v&#34;</span><span class="op" id="5436975">,</span>&nbsp;<span class="ident" id="5436977">kv</span><span class="op" id="5436979">.</span><span class="ident" id="5436980">Key</span><span class="op" id="5436983">,</span>&nbsp;<span class="ident" id="5436985">kv</span><span class="op" id="5436987">.</span><span class="ident" id="5436988">Value</span><span class="op" id="5436993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5436997">first</span>&nbsp;<span class="op" id="5437003">=</span>&nbsp;<span class="builtintype" id="5437005">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5437012">}</span><span class="op" id="5437013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437016">fmt</span><span class="op" id="5437019">.</span><span class="ident" id="5437020">Fprintf</span><span class="op" id="5437027">(</span><span class="op" id="5437028">&amp;</span><span class="ident" id="5437029">b</span><span class="op" id="5437030">,</span>&nbsp;<span class="string" id="5437032">&#34;}&#34;</span><span class="op" id="5437035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5437038">return</span>&nbsp;<span class="ident" id="5437045">b</span><span class="op" id="5437046">.</span><span class="ident" id="5437047">String</span><span class="op" id="5437053">(</span><span class="op" id="5437054">)</span><br>
<span class="lineno">120</span><span class="op" id="5437056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5437059">func</span>&nbsp;<span class="op" id="5437064">(</span><span class="ident" id="5437065">v</span>&nbsp;<span class="op" id="5437067">*</span><span class="ident" id="5437068">Map</span><span class="op" id="5437071">)</span>&nbsp;<span class="ident" id="5437073">Init</span><span class="op" id="5437077">(</span><span class="op" id="5437078">)</span>&nbsp;<span class="op" id="5437080">*</span><span class="ident" id="5437081">Map</span>&nbsp;<span class="op" id="5437085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437088">v</span><span class="op" id="5437089">.</span><span class="ident" id="5437090">m</span>&nbsp;<span class="op" id="5437092">=</span>&nbsp;<span class="builtinfunc" id="5437094">make</span><span class="op" id="5437098">(</span><span class="keyword" id="5437099">map</span><span class="op" id="5437102">[</span><span class="builtintype" id="5437103">string</span><span class="op" id="5437109">]</span><span class="ident" id="5437110">Var</span><span class="op" id="5437113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5437116">return</span>&nbsp;<span class="ident" id="5437123">v</span><br>
<span class="lineno">125</span><span class="op" id="5437125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5437128">//&nbsp;updateKeys&nbsp;updates&nbsp;the&nbsp;sorted&nbsp;list&nbsp;of&nbsp;keys&nbsp;in&nbsp;v.keys.</span><br>
<span class="lineno"></span><span class="comment" id="5437185">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;v.mu&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="5437219">func</span>&nbsp;<span class="op" id="5437224">(</span><span class="ident" id="5437225">v</span>&nbsp;<span class="op" id="5437227">*</span><span class="ident" id="5437228">Map</span><span class="op" id="5437231">)</span>&nbsp;<span class="ident" id="5437233">updateKeys</span><span class="op" id="5437243">(</span><span class="op" id="5437244">)</span>&nbsp;<span class="op" id="5437246">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5437249">if</span>&nbsp;<span class="builtinfunc" id="5437252">len</span><span class="op" id="5437255">(</span><span class="ident" id="5437256">v</span><span class="op" id="5437257">.</span><span class="ident" id="5437258">m</span><span class="op" id="5437259">)</span>&nbsp;<span class="op" id="5437261">==</span>&nbsp;<span class="builtinfunc" id="5437264">len</span><span class="op" id="5437267">(</span><span class="ident" id="5437268">v</span><span class="op" id="5437269">.</span><span class="ident" id="5437270">keys</span><span class="op" id="5437274">)</span>&nbsp;<span class="op" id="5437276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5437280">//&nbsp;No&nbsp;new&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5437297">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5437305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437308">v</span><span class="op" id="5437309">.</span><span class="ident" id="5437310">keys</span>&nbsp;<span class="op" id="5437315">=</span>&nbsp;<span class="ident" id="5437317">v</span><span class="op" id="5437318">.</span><span class="ident" id="5437319">keys</span><span class="op" id="5437323">[</span><span class="op" id="5437324">:</span><span class="num" id="5437325">0</span><span class="op" id="5437326">]</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5437329">for</span>&nbsp;<span class="ident" id="5437333">k</span>&nbsp;<span class="op" id="5437335">:=</span>&nbsp;<span class="keyword" id="5437338">range</span>&nbsp;<span class="ident" id="5437344">v</span><span class="op" id="5437345">.</span><span class="ident" id="5437346">m</span>&nbsp;<span class="op" id="5437348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437352">v</span><span class="op" id="5437353">.</span><span class="ident" id="5437354">keys</span>&nbsp;<span class="op" id="5437359">=</span>&nbsp;<span class="builtinfunc" id="5437361">append</span><span class="op" id="5437367">(</span><span class="ident" id="5437368">v</span><span class="op" id="5437369">.</span><span class="ident" id="5437370">keys</span><span class="op" id="5437374">,</span>&nbsp;<span class="ident" id="5437376">k</span><span class="op" id="5437377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5437380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437383">sort</span><span class="op" id="5437387">.</span><span class="ident" id="5437388">Strings</span><span class="op" id="5437395">(</span><span class="ident" id="5437396">v</span><span class="op" id="5437397">.</span><span class="ident" id="5437398">keys</span><span class="op" id="5437402">)</span><br>
<span class="lineno"></span><span class="op" id="5437404">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="5437407">func</span>&nbsp;<span class="op" id="5437412">(</span><span class="ident" id="5437413">v</span>&nbsp;<span class="op" id="5437415">*</span><span class="ident" id="5437416">Map</span><span class="op" id="5437419">)</span>&nbsp;<span class="ident" id="5437421">Get</span><span class="op" id="5437424">(</span><span class="ident" id="5437425">key</span>&nbsp;<span class="builtintype" id="5437429">string</span><span class="op" id="5437435">)</span>&nbsp;<span class="ident" id="5437437">Var</span>&nbsp;<span class="op" id="5437441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437444">v</span><span class="op" id="5437445">.</span><span class="ident" id="5437446">mu</span><span class="op" id="5437448">.</span><span class="ident" id="5437449">RLock</span><span class="op" id="5437454">(</span><span class="op" id="5437455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5437458">defer</span>&nbsp;<span class="ident" id="5437464">v</span><span class="op" id="5437465">.</span><span class="ident" id="5437466">mu</span><span class="op" id="5437468">.</span><span class="ident" id="5437469">RUnlock</span><span class="op" id="5437476">(</span><span class="op" id="5437477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5437480">return</span>&nbsp;<span class="ident" id="5437487">v</span><span class="op" id="5437488">.</span><span class="ident" id="5437489">m</span><span class="op" id="5437490">[</span><span class="ident" id="5437491">key</span><span class="op" id="5437494">]</span><br>
<span class="lineno">145</span><span class="op" id="5437496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5437499">func</span>&nbsp;<span class="op" id="5437504">(</span><span class="ident" id="5437505">v</span>&nbsp;<span class="op" id="5437507">*</span><span class="ident" id="5437508">Map</span><span class="op" id="5437511">)</span>&nbsp;<span class="ident" id="5437513">Set</span><span class="op" id="5437516">(</span><span class="ident" id="5437517">key</span>&nbsp;<span class="builtintype" id="5437521">string</span><span class="op" id="5437527">,</span>&nbsp;<span class="ident" id="5437529">av</span>&nbsp;<span class="ident" id="5437532">Var</span><span class="op" id="5437535">)</span>&nbsp;<span class="op" id="5437537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437540">v</span><span class="op" id="5437541">.</span><span class="ident" id="5437542">mu</span><span class="op" id="5437544">.</span><span class="ident" id="5437545">Lock</span><span class="op" id="5437549">(</span><span class="op" id="5437550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5437553">defer</span>&nbsp;<span class="ident" id="5437559">v</span><span class="op" id="5437560">.</span><span class="ident" id="5437561">mu</span><span class="op" id="5437563">.</span><span class="ident" id="5437564">Unlock</span><span class="op" id="5437570">(</span><span class="op" id="5437571">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437574">v</span><span class="op" id="5437575">.</span><span class="ident" id="5437576">m</span><span class="op" id="5437577">[</span><span class="ident" id="5437578">key</span><span class="op" id="5437581">]</span>&nbsp;<span class="op" id="5437583">=</span>&nbsp;<span class="ident" id="5437585">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437589">v</span><span class="op" id="5437590">.</span><span class="ident" id="5437591">updateKeys</span><span class="op" id="5437601">(</span><span class="op" id="5437602">)</span><br>
<span class="lineno"></span><span class="op" id="5437604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5437607">func</span>&nbsp;<span class="op" id="5437612">(</span><span class="ident" id="5437613">v</span>&nbsp;<span class="op" id="5437615">*</span><span class="ident" id="5437616">Map</span><span class="op" id="5437619">)</span>&nbsp;<span class="ident" id="5437621">Add</span><span class="op" id="5437624">(</span><span class="ident" id="5437625">key</span>&nbsp;<span class="builtintype" id="5437629">string</span><span class="op" id="5437635">,</span>&nbsp;<span class="ident" id="5437637">delta</span>&nbsp;<span class="ident" id="5437643">int64</span><span class="op" id="5437648">)</span>&nbsp;<span class="op" id="5437650">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437653">v</span><span class="op" id="5437654">.</span><span class="ident" id="5437655">mu</span><span class="op" id="5437657">.</span><span class="ident" id="5437658">RLock</span><span class="op" id="5437663">(</span><span class="op" id="5437664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437667">av</span><span class="op" id="5437669">,</span>&nbsp;<span class="ident" id="5437671">ok</span>&nbsp;<span class="op" id="5437674">:=</span>&nbsp;<span class="ident" id="5437677">v</span><span class="op" id="5437678">.</span><span class="ident" id="5437679">m</span><span class="op" id="5437680">[</span><span class="ident" id="5437681">key</span><span class="op" id="5437684">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437687">v</span><span class="op" id="5437688">.</span><span class="ident" id="5437689">mu</span><span class="op" id="5437691">.</span><span class="ident" id="5437692">RUnlock</span><span class="op" id="5437699">(</span><span class="op" id="5437700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5437703">if</span>&nbsp;<span class="op" id="5437706">!</span><span class="ident" id="5437707">ok</span>&nbsp;<span class="op" id="5437710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5437714">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437752">v</span><span class="op" id="5437753">.</span><span class="ident" id="5437754">mu</span><span class="op" id="5437756">.</span><span class="ident" id="5437757">Lock</span><span class="op" id="5437761">(</span><span class="op" id="5437762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437766">av</span><span class="op" id="5437768">,</span>&nbsp;<span class="ident" id="5437770">ok</span>&nbsp;<span class="op" id="5437773">=</span>&nbsp;<span class="ident" id="5437775">v</span><span class="op" id="5437776">.</span><span class="ident" id="5437777">m</span><span class="op" id="5437778">[</span><span class="ident" id="5437779">key</span><span class="op" id="5437782">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5437786">if</span>&nbsp;<span class="op" id="5437789">!</span><span class="ident" id="5437790">ok</span>&nbsp;<span class="op" id="5437793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437798">av</span>&nbsp;<span class="op" id="5437801">=</span>&nbsp;<span class="builtinfunc" id="5437803">new</span><span class="op" id="5437806">(</span><span class="ident" id="5437807">Int</span><span class="op" id="5437810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437815">v</span><span class="op" id="5437816">.</span><span class="ident" id="5437817">m</span><span class="op" id="5437818">[</span><span class="ident" id="5437819">key</span><span class="op" id="5437822">]</span>&nbsp;<span class="op" id="5437824">=</span>&nbsp;<span class="ident" id="5437826">av</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437832">v</span><span class="op" id="5437833">.</span><span class="ident" id="5437834">updateKeys</span><span class="op" id="5437844">(</span><span class="op" id="5437845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5437849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437853">v</span><span class="op" id="5437854">.</span><span class="ident" id="5437855">mu</span><span class="op" id="5437857">.</span><span class="ident" id="5437858">Unlock</span><span class="op" id="5437864">(</span><span class="op" id="5437865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5437868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5437872">//&nbsp;Add&nbsp;to&nbsp;Int;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5437906">if</span>&nbsp;<span class="ident" id="5437909">iv</span><span class="op" id="5437911">,</span>&nbsp;<span class="ident" id="5437913">ok</span>&nbsp;<span class="op" id="5437916">:=</span>&nbsp;<span class="ident" id="5437919">av</span><span class="op" id="5437921">.</span><span class="op" id="5437922">(</span><span class="op" id="5437923">*</span><span class="ident" id="5437924">Int</span><span class="op" id="5437927">)</span><span class="op" id="5437928">;</span>&nbsp;<span class="ident" id="5437930">ok</span>&nbsp;<span class="op" id="5437933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5437937">iv</span><span class="op" id="5437939">.</span><span class="ident" id="5437940">Add</span><span class="op" id="5437943">(</span><span class="ident" id="5437944">delta</span><span class="op" id="5437949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5437952">}</span><br>
<span class="lineno"></span><span class="op" id="5437954">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span><span class="comment" id="5437957">//&nbsp;AddFloat&nbsp;adds&nbsp;delta&nbsp;to&nbsp;the&nbsp;*Float&nbsp;value&nbsp;stored&nbsp;under&nbsp;the&nbsp;given&nbsp;map&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="5438032">func</span>&nbsp;<span class="op" id="5438037">(</span><span class="ident" id="5438038">v</span>&nbsp;<span class="op" id="5438040">*</span><span class="ident" id="5438041">Map</span><span class="op" id="5438044">)</span>&nbsp;<span class="ident" id="5438046">AddFloat</span><span class="op" id="5438054">(</span><span class="ident" id="5438055">key</span>&nbsp;<span class="builtintype" id="5438059">string</span><span class="op" id="5438065">,</span>&nbsp;<span class="ident" id="5438067">delta</span>&nbsp;<span class="builtintype" id="5438073">float64</span><span class="op" id="5438080">)</span>&nbsp;<span class="op" id="5438082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5438085">v</span><span class="op" id="5438086">.</span><span class="ident" id="5438087">mu</span><span class="op" id="5438089">.</span><span class="ident" id="5438090">RLock</span><span class="op" id="5438095">(</span><span class="op" id="5438096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5438099">av</span><span class="op" id="5438101">,</span>&nbsp;<span class="ident" id="5438103">ok</span>&nbsp;<span class="op" id="5438106">:=</span>&nbsp;<span class="ident" id="5438109">v</span><span class="op" id="5438110">.</span><span class="ident" id="5438111">m</span><span class="op" id="5438112">[</span><span class="ident" id="5438113">key</span><span class="op" id="5438116">]</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5438119">v</span><span class="op" id="5438120">.</span><span class="ident" id="5438121">mu</span><span class="op" id="5438123">.</span><span class="ident" id="5438124">RUnlock</span><span class="op" id="5438131">(</span><span class="op" id="5438132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5438135">if</span>&nbsp;<span class="op" id="5438138">!</span><span class="ident" id="5438139">ok</span>&nbsp;<span class="op" id="5438142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5438146">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5438184">v</span><span class="op" id="5438185">.</span><span class="ident" id="5438186">mu</span><span class="op" id="5438188">.</span><span class="ident" id="5438189">Lock</span><span class="op" id="5438193">(</span><span class="op" id="5438194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5438198">av</span><span class="op" id="5438200">,</span>&nbsp;<span class="ident" id="5438202">ok</span>&nbsp;<span class="op" id="5438205">=</span>&nbsp;<span class="ident" id="5438207">v</span><span class="op" id="5438208">.</span><span class="ident" id="5438209">m</span><span class="op" id="5438210">[</span><span class="ident" id="5438211">key</span><span class="op" id="5438214">]</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5438218">if</span>&nbsp;<span class="op" id="5438221">!</span><span class="ident" id="5438222">ok</span>&nbsp;<span class="op" id="5438225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5438230">av</span>&nbsp;<span class="op" id="5438233">=</span>&nbsp;<span class="builtinfunc" id="5438235">new</span><span class="op" id="5438238">(</span><span class="ident" id="5438239">Float</span><span class="op" id="5438244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5438249">v</span><span class="op" id="5438250">.</span><span class="ident" id="5438251">m</span><span class="op" id="5438252">[</span><span class="ident" id="5438253">key</span><span class="op" id="5438256">]</span>&nbsp;<span class="op" id="5438258">=</span>&nbsp;<span class="ident" id="5438260">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5438266">v</span><span class="op" id="5438267">.</span><span class="ident" id="5438268">updateKeys</span><span class="op" id="5438278">(</span><span class="op" id="5438279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5438283">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5438287">v</span><span class="op" id="5438288">.</span><span class="ident" id="5438289">mu</span><span class="op" id="5438291">.</span><span class="ident" id="5438292">Unlock</span><span class="op" id="5438298">(</span><span class="op" id="5438299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5438302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5438306">//&nbsp;Add&nbsp;to&nbsp;Float;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5438342">if</span>&nbsp;<span class="ident" id="5438345">iv</span><span class="op" id="5438347">,</span>&nbsp;<span class="ident" id="5438349">ok</span>&nbsp;<span class="op" id="5438352">:=</span>&nbsp;<span class="ident" id="5438355">av</span><span class="op" id="5438357">.</span><span class="op" id="5438358">(</span><span class="op" id="5438359">*</span><span class="ident" id="5438360">Float</span><span class="op" id="5438365">)</span><span class="op" id="5438366">;</span>&nbsp;<span class="ident" id="5438368">ok</span>&nbsp;<span class="op" id="5438371">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5438375">iv</span><span class="op" id="5438377">.</span><span class="ident" id="5438378">Add</span><span class="op" id="5438381">(</span><span class="ident" id="5438382">delta</span><span class="op" id="5438387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5438390">}</span><br>
<span class="lineno"></span><span class="op" id="5438392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5438395">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">200</span><span class="comment" id="5438436">//&nbsp;The&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="5438479">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="5438532">func</span>&nbsp;<span class="op" id="5438537">(</span><span class="ident" id="5438538">v</span>&nbsp;<span class="op" id="5438540">*</span><span class="ident" id="5438541">Map</span><span class="op" id="5438544">)</span>&nbsp;<span class="ident" id="5438546">Do</span><span class="op" id="5438548">(</span><span class="ident" id="5438549">f</span>&nbsp;<span class="keyword" id="5438551">func</span><span class="op" id="5438555">(</span><span class="ident" id="5438556">KeyValue</span><span class="op" id="5438564">)</span><span class="op" id="5438565">)</span>&nbsp;<span class="op" id="5438567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5438570">v</span><span class="op" id="5438571">.</span><span class="ident" id="5438572">mu</span><span class="op" id="5438574">.</span><span class="ident" id="5438575">RLock</span><span class="op" id="5438580">(</span><span class="op" id="5438581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5438584">defer</span>&nbsp;<span class="ident" id="5438590">v</span><span class="op" id="5438591">.</span><span class="ident" id="5438592">mu</span><span class="op" id="5438594">.</span><span class="ident" id="5438595">RUnlock</span><span class="op" id="5438602">(</span><span class="op" id="5438603">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5438606">v</span><span class="op" id="5438607">.</span><span class="ident" id="5438608">doLocked</span><span class="op" id="5438616">(</span><span class="ident" id="5438617">f</span><span class="op" id="5438618">)</span><br>
<span class="lineno"></span><span class="op" id="5438620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5438623">//&nbsp;doLocked&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="5438670">//&nbsp;v.mu&nbsp;must&nbsp;be&nbsp;held&nbsp;for&nbsp;reads.</span><br>
<span class="lineno">210</span><span class="keyword" id="5438702">func</span>&nbsp;<span class="op" id="5438707">(</span><span class="ident" id="5438708">v</span>&nbsp;<span class="op" id="5438710">*</span><span class="ident" id="5438711">Map</span><span class="op" id="5438714">)</span>&nbsp;<span class="ident" id="5438716">doLocked</span><span class="op" id="5438724">(</span><span class="ident" id="5438725">f</span>&nbsp;<span class="keyword" id="5438727">func</span><span class="op" id="5438731">(</span><span class="ident" id="5438732">KeyValue</span><span class="op" id="5438740">)</span><span class="op" id="5438741">)</span>&nbsp;<span class="op" id="5438743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5438746">for</span>&nbsp;<span class="ident" id="5438750">_</span><span class="op" id="5438751">,</span>&nbsp;<span class="ident" id="5438753">k</span>&nbsp;<span class="op" id="5438755">:=</span>&nbsp;<span class="keyword" id="5438758">range</span>&nbsp;<span class="ident" id="5438764">v</span><span class="op" id="5438765">.</span><span class="ident" id="5438766">keys</span>&nbsp;<span class="op" id="5438771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5438775">f</span><span class="op" id="5438776">(</span><span class="ident" id="5438777">KeyValue</span><span class="op" id="5438785">{</span><span class="ident" id="5438786">k</span><span class="op" id="5438787">,</span>&nbsp;<span class="ident" id="5438789">v</span><span class="op" id="5438790">.</span><span class="ident" id="5438791">m</span><span class="op" id="5438792">[</span><span class="ident" id="5438793">k</span><span class="op" id="5438794">]</span><span class="op" id="5438795">}</span><span class="op" id="5438796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5438799">}</span><br>
<span class="lineno"></span><span class="op" id="5438801">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="5438804">//&nbsp;String&nbsp;is&nbsp;a&nbsp;string&nbsp;variable,&nbsp;and&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5438869">type</span>&nbsp;<span class="ident" id="5438874">String</span>&nbsp;<span class="keyword" id="5438881">struct</span>&nbsp;<span class="op" id="5438888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5438891">mu</span>&nbsp;<span class="ident" id="5438894">sync</span><span class="op" id="5438898">.</span><span class="ident" id="5438899">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5438908">s</span>&nbsp;&nbsp;<span class="builtintype" id="5438911">string</span><br>
<span class="lineno">220</span><span class="op" id="5438918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5438921">func</span>&nbsp;<span class="op" id="5438926">(</span><span class="ident" id="5438927">v</span>&nbsp;<span class="op" id="5438929">*</span><span class="ident" id="5438930">String</span><span class="op" id="5438936">)</span>&nbsp;<span class="ident" id="5438938">String</span><span class="op" id="5438944">(</span><span class="op" id="5438945">)</span>&nbsp;<span class="builtintype" id="5438947">string</span>&nbsp;<span class="op" id="5438954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5438957">v</span><span class="op" id="5438958">.</span><span class="ident" id="5438959">mu</span><span class="op" id="5438961">.</span><span class="ident" id="5438962">RLock</span><span class="op" id="5438967">(</span><span class="op" id="5438968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5438971">defer</span>&nbsp;<span class="ident" id="5438977">v</span><span class="op" id="5438978">.</span><span class="ident" id="5438979">mu</span><span class="op" id="5438981">.</span><span class="ident" id="5438982">RUnlock</span><span class="op" id="5438989">(</span><span class="op" id="5438990">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5438993">return</span>&nbsp;<span class="ident" id="5439000">strconv</span><span class="op" id="5439007">.</span><span class="ident" id="5439008">Quote</span><span class="op" id="5439013">(</span><span class="ident" id="5439014">v</span><span class="op" id="5439015">.</span><span class="ident" id="5439016">s</span><span class="op" id="5439017">)</span><br>
<span class="lineno"></span><span class="op" id="5439019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5439022">func</span>&nbsp;<span class="op" id="5439027">(</span><span class="ident" id="5439028">v</span>&nbsp;<span class="op" id="5439030">*</span><span class="ident" id="5439031">String</span><span class="op" id="5439037">)</span>&nbsp;<span class="ident" id="5439039">Set</span><span class="op" id="5439042">(</span><span class="ident" id="5439043">value</span>&nbsp;<span class="builtintype" id="5439049">string</span><span class="op" id="5439055">)</span>&nbsp;<span class="op" id="5439057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5439060">v</span><span class="op" id="5439061">.</span><span class="ident" id="5439062">mu</span><span class="op" id="5439064">.</span><span class="ident" id="5439065">Lock</span><span class="op" id="5439069">(</span><span class="op" id="5439070">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5439073">defer</span>&nbsp;<span class="ident" id="5439079">v</span><span class="op" id="5439080">.</span><span class="ident" id="5439081">mu</span><span class="op" id="5439083">.</span><span class="ident" id="5439084">Unlock</span><span class="op" id="5439090">(</span><span class="op" id="5439091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5439094">v</span><span class="op" id="5439095">.</span><span class="ident" id="5439096">s</span>&nbsp;<span class="op" id="5439098">=</span>&nbsp;<span class="ident" id="5439100">value</span><br>
<span class="lineno"></span><span class="op" id="5439106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5439109">//&nbsp;Func&nbsp;implements&nbsp;Var&nbsp;by&nbsp;calling&nbsp;the&nbsp;function</span><br>
<span class="lineno">235</span><span class="comment" id="5439156">//&nbsp;and&nbsp;formatting&nbsp;the&nbsp;returned&nbsp;value&nbsp;using&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="5439205">type</span>&nbsp;<span class="ident" id="5439210">Func</span>&nbsp;<span class="keyword" id="5439215">func</span><span class="op" id="5439219">(</span><span class="op" id="5439220">)</span>&nbsp;<span class="keyword" id="5439222">interface</span><span class="op" id="5439231">{</span><span class="op" id="5439232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5439235">func</span>&nbsp;<span class="op" id="5439240">(</span><span class="ident" id="5439241">f</span>&nbsp;<span class="ident" id="5439243">Func</span><span class="op" id="5439247">)</span>&nbsp;<span class="ident" id="5439249">String</span><span class="op" id="5439255">(</span><span class="op" id="5439256">)</span>&nbsp;<span class="builtintype" id="5439258">string</span>&nbsp;<span class="op" id="5439265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5439268">v</span><span class="op" id="5439269">,</span>&nbsp;<span class="ident" id="5439271">_</span>&nbsp;<span class="op" id="5439273">:=</span>&nbsp;<span class="ident" id="5439276">json</span><span class="op" id="5439280">.</span><span class="ident" id="5439281">Marshal</span><span class="op" id="5439288">(</span><span class="ident" id="5439289">f</span><span class="op" id="5439290">(</span><span class="op" id="5439291">)</span><span class="op" id="5439292">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5439295">return</span>&nbsp;<span class="builtintype" id="5439302">string</span><span class="op" id="5439308">(</span><span class="ident" id="5439309">v</span><span class="op" id="5439310">)</span><br>
<span class="lineno"></span><span class="op" id="5439312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5439315">//&nbsp;All&nbsp;published&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5439343">var</span>&nbsp;<span class="op" id="5439347">(</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5439350">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5439358">sync</span><span class="op" id="5439362">.</span><span class="ident" id="5439363">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5439372">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5439380">=</span>&nbsp;<span class="builtinfunc" id="5439382">make</span><span class="op" id="5439386">(</span><span class="keyword" id="5439387">map</span><span class="op" id="5439390">[</span><span class="builtintype" id="5439391">string</span><span class="op" id="5439397">]</span><span class="ident" id="5439398">Var</span><span class="op" id="5439401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5439404">varKeys</span>&nbsp;<span class="op" id="5439412">[</span><span class="op" id="5439413">]</span><span class="builtintype" id="5439414">string</span>&nbsp;<span class="comment" id="5439421">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="5439431">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="comment" id="5439434">//&nbsp;Publish&nbsp;declares&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.&nbsp;This&nbsp;should&nbsp;be&nbsp;called&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5439510">//&nbsp;package&#39;s&nbsp;init&nbsp;function&nbsp;when&nbsp;it&nbsp;creates&nbsp;its&nbsp;Vars.&nbsp;If&nbsp;the&nbsp;name&nbsp;is&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="5439586">//&nbsp;registered&nbsp;then&nbsp;this&nbsp;will&nbsp;log.Panic.</span><br>
<span class="lineno"></span><span class="keyword" id="5439626">func</span>&nbsp;<span class="ident" id="5439631">Publish</span><span class="op" id="5439638">(</span><span class="ident" id="5439639">name</span>&nbsp;<span class="builtintype" id="5439644">string</span><span class="op" id="5439650">,</span>&nbsp;<span class="ident" id="5439652">v</span>&nbsp;<span class="ident" id="5439654">Var</span><span class="op" id="5439657">)</span>&nbsp;<span class="op" id="5439659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5439662">mutex</span><span class="op" id="5439667">.</span><span class="ident" id="5439668">Lock</span><span class="op" id="5439672">(</span><span class="op" id="5439673">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5439676">defer</span>&nbsp;<span class="ident" id="5439682">mutex</span><span class="op" id="5439687">.</span><span class="ident" id="5439688">Unlock</span><span class="op" id="5439694">(</span><span class="op" id="5439695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5439698">if</span>&nbsp;<span class="ident" id="5439701">_</span><span class="op" id="5439702">,</span>&nbsp;<span class="ident" id="5439704">existing</span>&nbsp;<span class="op" id="5439713">:=</span>&nbsp;<span class="ident" id="5439716">vars</span><span class="op" id="5439720">[</span><span class="ident" id="5439721">name</span><span class="op" id="5439725">]</span><span class="op" id="5439726">;</span>&nbsp;<span class="ident" id="5439728">existing</span>&nbsp;<span class="op" id="5439737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5439741">log</span><span class="op" id="5439744">.</span><span class="ident" id="5439745">Panicln</span><span class="op" id="5439752">(</span><span class="string" id="5439753">&#34;Reuse&nbsp;of&nbsp;exported&nbsp;var&nbsp;name:&#34;</span><span class="op" id="5439782">,</span>&nbsp;<span class="ident" id="5439784">name</span><span class="op" id="5439788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5439791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5439794">vars</span><span class="op" id="5439798">[</span><span class="ident" id="5439799">name</span><span class="op" id="5439803">]</span>&nbsp;<span class="op" id="5439805">=</span>&nbsp;<span class="ident" id="5439807">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5439810">varKeys</span>&nbsp;<span class="op" id="5439818">=</span>&nbsp;<span class="builtinfunc" id="5439820">append</span><span class="op" id="5439826">(</span><span class="ident" id="5439827">varKeys</span><span class="op" id="5439834">,</span>&nbsp;<span class="ident" id="5439836">name</span><span class="op" id="5439840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5439843">sort</span><span class="op" id="5439847">.</span><span class="ident" id="5439848">Strings</span><span class="op" id="5439855">(</span><span class="ident" id="5439856">varKeys</span><span class="op" id="5439863">)</span><br>
<span class="lineno"></span><span class="op" id="5439865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5439868">//&nbsp;Get&nbsp;retrieves&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno">265</span><span class="keyword" id="5439912">func</span>&nbsp;<span class="ident" id="5439917">Get</span><span class="op" id="5439920">(</span><span class="ident" id="5439921">name</span>&nbsp;<span class="builtintype" id="5439926">string</span><span class="op" id="5439932">)</span>&nbsp;<span class="ident" id="5439934">Var</span>&nbsp;<span class="op" id="5439938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5439941">mutex</span><span class="op" id="5439946">.</span><span class="ident" id="5439947">RLock</span><span class="op" id="5439952">(</span><span class="op" id="5439953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5439956">defer</span>&nbsp;<span class="ident" id="5439962">mutex</span><span class="op" id="5439967">.</span><span class="ident" id="5439968">RUnlock</span><span class="op" id="5439975">(</span><span class="op" id="5439976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5439979">return</span>&nbsp;<span class="ident" id="5439986">vars</span><span class="op" id="5439990">[</span><span class="ident" id="5439991">name</span><span class="op" id="5439995">]</span><br>
<span class="lineno"></span><span class="op" id="5439997">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="comment" id="5440000">//&nbsp;Convenience&nbsp;functions&nbsp;for&nbsp;creating&nbsp;new&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5440063">func</span>&nbsp;<span class="ident" id="5440068">NewInt</span><span class="op" id="5440074">(</span><span class="ident" id="5440075">name</span>&nbsp;<span class="builtintype" id="5440080">string</span><span class="op" id="5440086">)</span>&nbsp;<span class="op" id="5440088">*</span><span class="ident" id="5440089">Int</span>&nbsp;<span class="op" id="5440093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440096">v</span>&nbsp;<span class="op" id="5440098">:=</span>&nbsp;<span class="builtinfunc" id="5440101">new</span><span class="op" id="5440104">(</span><span class="ident" id="5440105">Int</span><span class="op" id="5440108">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440111">Publish</span><span class="op" id="5440118">(</span><span class="ident" id="5440119">name</span><span class="op" id="5440123">,</span>&nbsp;<span class="ident" id="5440125">v</span><span class="op" id="5440126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5440129">return</span>&nbsp;<span class="ident" id="5440136">v</span><br>
<span class="lineno"></span><span class="op" id="5440138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5440141">func</span>&nbsp;<span class="ident" id="5440146">NewFloat</span><span class="op" id="5440154">(</span><span class="ident" id="5440155">name</span>&nbsp;<span class="builtintype" id="5440160">string</span><span class="op" id="5440166">)</span>&nbsp;<span class="op" id="5440168">*</span><span class="ident" id="5440169">Float</span>&nbsp;<span class="op" id="5440175">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440178">v</span>&nbsp;<span class="op" id="5440180">:=</span>&nbsp;<span class="builtinfunc" id="5440183">new</span><span class="op" id="5440186">(</span><span class="ident" id="5440187">Float</span><span class="op" id="5440192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440195">Publish</span><span class="op" id="5440202">(</span><span class="ident" id="5440203">name</span><span class="op" id="5440207">,</span>&nbsp;<span class="ident" id="5440209">v</span><span class="op" id="5440210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5440213">return</span>&nbsp;<span class="ident" id="5440220">v</span><br>
<span class="lineno"></span><span class="op" id="5440222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="5440225">func</span>&nbsp;<span class="ident" id="5440230">NewMap</span><span class="op" id="5440236">(</span><span class="ident" id="5440237">name</span>&nbsp;<span class="builtintype" id="5440242">string</span><span class="op" id="5440248">)</span>&nbsp;<span class="op" id="5440250">*</span><span class="ident" id="5440251">Map</span>&nbsp;<span class="op" id="5440255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440258">v</span>&nbsp;<span class="op" id="5440260">:=</span>&nbsp;<span class="builtinfunc" id="5440263">new</span><span class="op" id="5440266">(</span><span class="ident" id="5440267">Map</span><span class="op" id="5440270">)</span><span class="op" id="5440271">.</span><span class="ident" id="5440272">Init</span><span class="op" id="5440276">(</span><span class="op" id="5440277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440280">Publish</span><span class="op" id="5440287">(</span><span class="ident" id="5440288">name</span><span class="op" id="5440292">,</span>&nbsp;<span class="ident" id="5440294">v</span><span class="op" id="5440295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5440298">return</span>&nbsp;<span class="ident" id="5440305">v</span><br>
<span class="lineno"></span><span class="op" id="5440307">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span><span class="keyword" id="5440310">func</span>&nbsp;<span class="ident" id="5440315">NewString</span><span class="op" id="5440324">(</span><span class="ident" id="5440325">name</span>&nbsp;<span class="builtintype" id="5440330">string</span><span class="op" id="5440336">)</span>&nbsp;<span class="op" id="5440338">*</span><span class="ident" id="5440339">String</span>&nbsp;<span class="op" id="5440346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440349">v</span>&nbsp;<span class="op" id="5440351">:=</span>&nbsp;<span class="builtinfunc" id="5440354">new</span><span class="op" id="5440357">(</span><span class="ident" id="5440358">String</span><span class="op" id="5440364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440367">Publish</span><span class="op" id="5440374">(</span><span class="ident" id="5440375">name</span><span class="op" id="5440379">,</span>&nbsp;<span class="ident" id="5440381">v</span><span class="op" id="5440382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5440385">return</span>&nbsp;<span class="ident" id="5440392">v</span><br>
<span class="lineno">295</span><span class="op" id="5440394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5440397">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="5440439">//&nbsp;The&nbsp;global&nbsp;variable&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="5440498">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno">300</span><span class="keyword" id="5440551">func</span>&nbsp;<span class="ident" id="5440556">Do</span><span class="op" id="5440558">(</span><span class="ident" id="5440559">f</span>&nbsp;<span class="keyword" id="5440561">func</span><span class="op" id="5440565">(</span><span class="ident" id="5440566">KeyValue</span><span class="op" id="5440574">)</span><span class="op" id="5440575">)</span>&nbsp;<span class="op" id="5440577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440580">mutex</span><span class="op" id="5440585">.</span><span class="ident" id="5440586">RLock</span><span class="op" id="5440591">(</span><span class="op" id="5440592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5440595">defer</span>&nbsp;<span class="ident" id="5440601">mutex</span><span class="op" id="5440606">.</span><span class="ident" id="5440607">RUnlock</span><span class="op" id="5440614">(</span><span class="op" id="5440615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5440618">for</span>&nbsp;<span class="ident" id="5440622">_</span><span class="op" id="5440623">,</span>&nbsp;<span class="ident" id="5440625">k</span>&nbsp;<span class="op" id="5440627">:=</span>&nbsp;<span class="keyword" id="5440630">range</span>&nbsp;<span class="ident" id="5440636">varKeys</span>&nbsp;<span class="op" id="5440644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440648">f</span><span class="op" id="5440649">(</span><span class="ident" id="5440650">KeyValue</span><span class="op" id="5440658">{</span><span class="ident" id="5440659">k</span><span class="op" id="5440660">,</span>&nbsp;<span class="ident" id="5440662">vars</span><span class="op" id="5440666">[</span><span class="ident" id="5440667">k</span><span class="op" id="5440668">]</span><span class="op" id="5440669">}</span><span class="op" id="5440670">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5440673">}</span><br>
<span class="lineno"></span><span class="op" id="5440675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5440678">func</span>&nbsp;<span class="ident" id="5440683">expvarHandler</span><span class="op" id="5440696">(</span><span class="ident" id="5440697">w</span>&nbsp;<span class="ident" id="5440699">http</span><span class="op" id="5440703">.</span><span class="ident" id="5440704">ResponseWriter</span><span class="op" id="5440718">,</span>&nbsp;<span class="ident" id="5440720">r</span>&nbsp;<span class="op" id="5440722">*</span><span class="ident" id="5440723">http</span><span class="op" id="5440727">.</span><span class="ident" id="5440728">Request</span><span class="op" id="5440735">)</span>&nbsp;<span class="op" id="5440737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440740">w</span><span class="op" id="5440741">.</span><span class="ident" id="5440742">Header</span><span class="op" id="5440748">(</span><span class="op" id="5440749">)</span><span class="op" id="5440750">.</span><span class="ident" id="5440751">Set</span><span class="op" id="5440754">(</span><span class="string" id="5440755">&#34;Content-Type&#34;</span><span class="op" id="5440769">,</span>&nbsp;<span class="string" id="5440771">&#34;application/json;&nbsp;charset=utf-8&#34;</span><span class="op" id="5440804">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440807">fmt</span><span class="op" id="5440810">.</span><span class="ident" id="5440811">Fprintf</span><span class="op" id="5440818">(</span><span class="ident" id="5440819">w</span><span class="op" id="5440820">,</span>&nbsp;<span class="string" id="5440822">&#34;{\n&#34;</span><span class="op" id="5440827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440830">first</span>&nbsp;<span class="op" id="5440836">:=</span>&nbsp;<span class="builtintype" id="5440839">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440845">Do</span><span class="op" id="5440847">(</span><span class="keyword" id="5440848">func</span><span class="op" id="5440852">(</span><span class="ident" id="5440853">kv</span>&nbsp;<span class="ident" id="5440856">KeyValue</span><span class="op" id="5440864">)</span>&nbsp;<span class="op" id="5440866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5440870">if</span>&nbsp;<span class="op" id="5440873">!</span><span class="ident" id="5440874">first</span>&nbsp;<span class="op" id="5440880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440885">fmt</span><span class="op" id="5440888">.</span><span class="ident" id="5440889">Fprintf</span><span class="op" id="5440896">(</span><span class="ident" id="5440897">w</span><span class="op" id="5440898">,</span>&nbsp;<span class="string" id="5440900">&#34;,\n&#34;</span><span class="op" id="5440905">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5440909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440913">first</span>&nbsp;<span class="op" id="5440919">=</span>&nbsp;<span class="builtintype" id="5440921">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440929">fmt</span><span class="op" id="5440932">.</span><span class="ident" id="5440933">Fprintf</span><span class="op" id="5440940">(</span><span class="ident" id="5440941">w</span><span class="op" id="5440942">,</span>&nbsp;<span class="string" id="5440944">&#34;%q:&nbsp;%s&#34;</span><span class="op" id="5440952">,</span>&nbsp;<span class="ident" id="5440954">kv</span><span class="op" id="5440956">.</span><span class="ident" id="5440957">Key</span><span class="op" id="5440960">,</span>&nbsp;<span class="ident" id="5440962">kv</span><span class="op" id="5440964">.</span><span class="ident" id="5440965">Value</span><span class="op" id="5440970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5440973">}</span><span class="op" id="5440974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5440977">fmt</span><span class="op" id="5440980">.</span><span class="ident" id="5440981">Fprintf</span><span class="op" id="5440988">(</span><span class="ident" id="5440989">w</span><span class="op" id="5440990">,</span>&nbsp;<span class="string" id="5440992">&#34;\n}\n&#34;</span><span class="op" id="5440999">)</span><br>
<span class="lineno">320</span><span class="op" id="5441001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5441004">func</span>&nbsp;<span class="ident" id="5441009">cmdline</span><span class="op" id="5441016">(</span><span class="op" id="5441017">)</span>&nbsp;<span class="keyword" id="5441019">interface</span><span class="op" id="5441028">{</span><span class="op" id="5441029">}</span>&nbsp;<span class="op" id="5441031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5441034">return</span>&nbsp;<span class="ident" id="5441041">os</span><span class="op" id="5441043">.</span><span class="ident" id="5441044">Args</span><br>
<span class="lineno"></span><span class="op" id="5441049">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="5441052">func</span>&nbsp;<span class="ident" id="5441057">memstats</span><span class="op" id="5441065">(</span><span class="op" id="5441066">)</span>&nbsp;<span class="keyword" id="5441068">interface</span><span class="op" id="5441077">{</span><span class="op" id="5441078">}</span>&nbsp;<span class="op" id="5441080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5441083">stats</span>&nbsp;<span class="op" id="5441089">:=</span>&nbsp;<span class="builtinfunc" id="5441092">new</span><span class="op" id="5441095">(</span><span class="ident" id="5441096">runtime</span><span class="op" id="5441103">.</span><span class="ident" id="5441104">MemStats</span><span class="op" id="5441112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5441115">runtime</span><span class="op" id="5441122">.</span><span class="ident" id="5441123">ReadMemStats</span><span class="op" id="5441135">(</span><span class="ident" id="5441136">stats</span><span class="op" id="5441141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5441144">return</span>&nbsp;<span class="op" id="5441151">*</span><span class="ident" id="5441152">stats</span><br>
<span class="lineno">330</span><span class="op" id="5441158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5441161">func</span>&nbsp;<span class="ident" id="5441166">init</span><span class="op" id="5441170">(</span><span class="op" id="5441171">)</span>&nbsp;<span class="op" id="5441173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5441176">http</span><span class="op" id="5441180">.</span><span class="ident" id="5441181">HandleFunc</span><span class="op" id="5441191">(</span><span class="string" id="5441192">&#34;/debug/vars&#34;</span><span class="op" id="5441205">,</span>&nbsp;<span class="ident" id="5441207">expvarHandler</span><span class="op" id="5441220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5441223">Publish</span><span class="op" id="5441230">(</span><span class="string" id="5441231">&#34;cmdline&#34;</span><span class="op" id="5441240">,</span>&nbsp;<span class="ident" id="5441242">Func</span><span class="op" id="5441246">(</span><span class="ident" id="5441247">cmdline</span><span class="op" id="5441254">)</span><span class="op" id="5441255">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5441258">Publish</span><span class="op" id="5441265">(</span><span class="string" id="5441266">&#34;memstats&#34;</span><span class="op" id="5441276">,</span>&nbsp;<span class="ident" id="5441278">Func</span><span class="op" id="5441282">(</span><span class="ident" id="5441283">memstats</span><span class="op" id="5441291">)</span><span class="op" id="5441292">)</span><br>
<span class="lineno"></span><span class="op" id="5441294">}</span>
</div>
</body>
</html>
