<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7006267">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7006322">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7006376">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7006427">//&nbsp;Tests&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;program&nbsp;running&nbsp;under&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;host&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="7006490">//&nbsp;Further,&nbsp;the&nbsp;two&nbsp;programs&nbsp;are&nbsp;the&nbsp;same&nbsp;binary,&nbsp;just&nbsp;checking</span><br>
<span class="lineno"></span><span class="comment" id="7006554">//&nbsp;their&nbsp;environment&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&nbsp;mode&nbsp;to&nbsp;run&nbsp;in.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7006611">package</span>&nbsp;<span class="ident" id="7006619">cgi</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="7006624">import</span>&nbsp;<span class="op" id="7006631">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7006634">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7006643">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7006653">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7006660">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7006666">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7006678">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7006699">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7006705">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7006716">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7006727">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7006734">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7006737">//&nbsp;This&nbsp;test&nbsp;is&nbsp;a&nbsp;CGI&nbsp;host&nbsp;(testing&nbsp;host.go)&nbsp;that&nbsp;runs&nbsp;its&nbsp;own&nbsp;binary</span><br>
<span class="lineno">25</span><span class="comment" id="7006807">//&nbsp;as&nbsp;a&nbsp;child&nbsp;process&nbsp;testing&nbsp;the&nbsp;other&nbsp;half&nbsp;of&nbsp;CGI&nbsp;(child.go).</span><br>
<span class="lineno"></span><span class="keyword" id="7006871">func</span>&nbsp;<span class="ident" id="7006876">TestHostingOurselves</span><span class="op" id="7006896">(</span><span class="ident" id="7006897">t</span>&nbsp;<span class="op" id="7006899">*</span><span class="ident" id="7006900">testing</span><span class="op" id="7006907">.</span><span class="ident" id="7006908">T</span><span class="op" id="7006909">)</span>&nbsp;<span class="op" id="7006911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7006914">if</span>&nbsp;<span class="ident" id="7006917">runtime</span><span class="op" id="7006924">.</span><span class="ident" id="7006925">GOOS</span>&nbsp;<span class="op" id="7006930">==</span>&nbsp;<span class="string" id="7006933">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7006940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006944">t</span><span class="op" id="7006945">.</span><span class="ident" id="7006946">Skip</span><span class="op" id="7006950">(</span><span class="string" id="7006951">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7006969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7006972">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006976">h</span>&nbsp;<span class="op" id="7006978">:=</span>&nbsp;<span class="op" id="7006981">&amp;</span><span class="ident" id="7006982">Handler</span><span class="op" id="7006989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7006993">Path</span><span class="op" id="7006997">:</span>&nbsp;<span class="ident" id="7006999">os</span><span class="op" id="7007001">.</span><span class="ident" id="7007002">Args</span><span class="op" id="7007006">[</span><span class="num" id="7007007">0</span><span class="op" id="7007008">]</span><span class="op" id="7007009">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007013">Root</span><span class="op" id="7007017">:</span>&nbsp;<span class="string" id="7007019">&#34;/test.go&#34;</span><span class="op" id="7007029">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007033">Args</span><span class="op" id="7007037">:</span>&nbsp;<span class="op" id="7007039">[</span><span class="op" id="7007040">]</span><span class="builtintype" id="7007041">string</span><span class="op" id="7007047">{</span><span class="string" id="7007048">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7007081">}</span><span class="op" id="7007082">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7007085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007088">expectedMap</span>&nbsp;<span class="op" id="7007100">:=</span>&nbsp;<span class="keyword" id="7007103">map</span><span class="op" id="7007106">[</span><span class="builtintype" id="7007107">string</span><span class="op" id="7007113">]</span><span class="builtintype" id="7007114">string</span><span class="op" id="7007120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7007124">&#34;test&#34;</span><span class="op" id="7007130">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7007149">&#34;Hello&nbsp;CGI-in-CGI&#34;</span><span class="op" id="7007167">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7007171">&#34;param-a&#34;</span><span class="op" id="7007180">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7007196">&#34;b&#34;</span><span class="op" id="7007199">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7007203">&#34;param-foo&#34;</span><span class="op" id="7007214">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7007228">&#34;bar&#34;</span><span class="op" id="7007233">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7007237">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="7007260">:</span>&nbsp;<span class="string" id="7007262">&#34;CGI/1.1&#34;</span><span class="op" id="7007271">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7007275">&#34;env-HTTP_HOST&#34;</span><span class="op" id="7007290">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7007300">&#34;example.com&#34;</span><span class="op" id="7007313">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7007317">&#34;env-PATH_INFO&#34;</span><span class="op" id="7007332">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7007342">&#34;&#34;</span><span class="op" id="7007344">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7007348">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7007366">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7007373">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="7007386">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7007390">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="7007407">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7007415">&#34;1.2.3.4&#34;</span><span class="op" id="7007424">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7007428">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="7007445">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7007453">&#34;1.2.3.4&#34;</span><span class="op" id="7007462">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7007466">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7007486">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7007491">&#34;GET&#34;</span><span class="op" id="7007496">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7007500">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7007517">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7007525">&#34;/test.go?foo=bar&amp;a=b&#34;</span><span class="op" id="7007547">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7007551">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7007572">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7007576">os</span><span class="op" id="7007578">.</span><span class="ident" id="7007579">Args</span><span class="op" id="7007583">[</span><span class="num" id="7007584">0</span><span class="op" id="7007585">]</span><span class="op" id="7007586">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7007590">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7007607">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7007615">&#34;/test.go&#34;</span><span class="op" id="7007625">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7007629">&#34;env-SERVER_NAME&#34;</span><span class="op" id="7007646">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7007654">&#34;example.com&#34;</span><span class="op" id="7007667">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7007671">&#34;env-SERVER_PORT&#34;</span><span class="op" id="7007688">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7007696">&#34;80&#34;</span><span class="op" id="7007700">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7007704">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="7007725">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7007729">&#34;go&#34;</span><span class="op" id="7007733">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7007736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007739">replay</span>&nbsp;<span class="op" id="7007746">:=</span>&nbsp;<span class="ident" id="7007749">runCgiTest</span><span class="op" id="7007759">(</span><span class="ident" id="7007760">t</span><span class="op" id="7007761">,</span>&nbsp;<span class="ident" id="7007763">h</span><span class="op" id="7007764">,</span>&nbsp;<span class="string" id="7007766">&#34;GET&nbsp;/test.go?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7007824">,</span>&nbsp;<span class="ident" id="7007826">expectedMap</span><span class="op" id="7007837">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7007841">if</span>&nbsp;<span class="ident" id="7007844">expected</span><span class="op" id="7007852">,</span>&nbsp;<span class="ident" id="7007854">got</span>&nbsp;<span class="op" id="7007858">:=</span>&nbsp;<span class="string" id="7007861">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="7007887">,</span>&nbsp;<span class="ident" id="7007889">replay</span><span class="op" id="7007895">.</span><span class="ident" id="7007896">Header</span><span class="op" id="7007902">(</span><span class="op" id="7007903">)</span><span class="op" id="7007904">.</span><span class="ident" id="7007905">Get</span><span class="op" id="7007908">(</span><span class="string" id="7007909">&#34;Content-Type&#34;</span><span class="op" id="7007923">)</span><span class="op" id="7007924">;</span>&nbsp;<span class="ident" id="7007926">got</span>&nbsp;<span class="op" id="7007930">!=</span>&nbsp;<span class="ident" id="7007933">expected</span>&nbsp;<span class="op" id="7007942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7007946">t</span><span class="op" id="7007947">.</span><span class="ident" id="7007948">Errorf</span><span class="op" id="7007954">(</span><span class="string" id="7007955">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7007994">,</span>&nbsp;<span class="ident" id="7007996">got</span><span class="op" id="7007999">,</span>&nbsp;<span class="ident" id="7008001">expected</span><span class="op" id="7008009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7008012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008015">if</span>&nbsp;<span class="ident" id="7008018">expected</span><span class="op" id="7008026">,</span>&nbsp;<span class="ident" id="7008028">got</span>&nbsp;<span class="op" id="7008032">:=</span>&nbsp;<span class="string" id="7008035">&#34;X-Test-Value&#34;</span><span class="op" id="7008049">,</span>&nbsp;<span class="ident" id="7008051">replay</span><span class="op" id="7008057">.</span><span class="ident" id="7008058">Header</span><span class="op" id="7008064">(</span><span class="op" id="7008065">)</span><span class="op" id="7008066">.</span><span class="ident" id="7008067">Get</span><span class="op" id="7008070">(</span><span class="string" id="7008071">&#34;X-Test-Header&#34;</span><span class="op" id="7008086">)</span><span class="op" id="7008087">;</span>&nbsp;<span class="ident" id="7008089">got</span>&nbsp;<span class="op" id="7008093">!=</span>&nbsp;<span class="ident" id="7008096">expected</span>&nbsp;<span class="op" id="7008105">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008109">t</span><span class="op" id="7008110">.</span><span class="ident" id="7008111">Errorf</span><span class="op" id="7008117">(</span><span class="string" id="7008118">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7008158">,</span>&nbsp;<span class="ident" id="7008160">got</span><span class="op" id="7008163">,</span>&nbsp;<span class="ident" id="7008165">expected</span><span class="op" id="7008173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7008176">}</span><br>
<span class="lineno"></span><span class="op" id="7008178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7008181">type</span>&nbsp;<span class="ident" id="7008186">customWriterRecorder</span>&nbsp;<span class="keyword" id="7008207">struct</span>&nbsp;<span class="op" id="7008214">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008217">w</span>&nbsp;<span class="ident" id="7008219">io</span><span class="op" id="7008221">.</span><span class="ident" id="7008222">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7008230">*</span><span class="ident" id="7008231">httptest</span><span class="op" id="7008239">.</span><span class="ident" id="7008240">ResponseRecorder</span><br>
<span class="lineno"></span><span class="op" id="7008257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7008260">func</span>&nbsp;<span class="op" id="7008265">(</span><span class="ident" id="7008266">r</span>&nbsp;<span class="op" id="7008268">*</span><span class="ident" id="7008269">customWriterRecorder</span><span class="op" id="7008289">)</span>&nbsp;<span class="ident" id="7008291">Write</span><span class="op" id="7008296">(</span><span class="ident" id="7008297">p</span>&nbsp;<span class="op" id="7008299">[</span><span class="op" id="7008300">]</span><span class="builtintype" id="7008301">byte</span><span class="op" id="7008305">)</span>&nbsp;<span class="op" id="7008307">(</span><span class="ident" id="7008308">n</span>&nbsp;<span class="builtintype" id="7008310">int</span><span class="op" id="7008313">,</span>&nbsp;<span class="ident" id="7008315">err</span>&nbsp;<span class="builtintype" id="7008319">error</span><span class="op" id="7008324">)</span>&nbsp;<span class="op" id="7008326">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008329">return</span>&nbsp;<span class="ident" id="7008336">r</span><span class="op" id="7008337">.</span><span class="ident" id="7008338">w</span><span class="op" id="7008339">.</span><span class="ident" id="7008340">Write</span><span class="op" id="7008345">(</span><span class="ident" id="7008346">p</span><span class="op" id="7008347">)</span><br>
<span class="lineno"></span><span class="op" id="7008349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7008352">type</span>&nbsp;<span class="ident" id="7008357">limitWriter</span>&nbsp;<span class="keyword" id="7008369">struct</span>&nbsp;<span class="op" id="7008376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008379">w</span>&nbsp;<span class="ident" id="7008381">io</span><span class="op" id="7008383">.</span><span class="ident" id="7008384">Writer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008392">n</span>&nbsp;<span class="builtintype" id="7008394">int</span><br>
<span class="lineno"></span><span class="op" id="7008398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7008401">func</span>&nbsp;<span class="op" id="7008406">(</span><span class="ident" id="7008407">w</span>&nbsp;<span class="op" id="7008409">*</span><span class="ident" id="7008410">limitWriter</span><span class="op" id="7008421">)</span>&nbsp;<span class="ident" id="7008423">Write</span><span class="op" id="7008428">(</span><span class="ident" id="7008429">p</span>&nbsp;<span class="op" id="7008431">[</span><span class="op" id="7008432">]</span><span class="builtintype" id="7008433">byte</span><span class="op" id="7008437">)</span>&nbsp;<span class="op" id="7008439">(</span><span class="ident" id="7008440">n</span>&nbsp;<span class="builtintype" id="7008442">int</span><span class="op" id="7008445">,</span>&nbsp;<span class="ident" id="7008447">err</span>&nbsp;<span class="builtintype" id="7008451">error</span><span class="op" id="7008456">)</span>&nbsp;<span class="op" id="7008458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008461">if</span>&nbsp;<span class="builtinfunc" id="7008464">len</span><span class="op" id="7008467">(</span><span class="ident" id="7008468">p</span><span class="op" id="7008469">)</span>&nbsp;<span class="op" id="7008471">&gt;</span>&nbsp;<span class="ident" id="7008473">w</span><span class="op" id="7008474">.</span><span class="ident" id="7008475">n</span>&nbsp;<span class="op" id="7008477">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008481">p</span>&nbsp;<span class="op" id="7008483">=</span>&nbsp;<span class="ident" id="7008485">p</span><span class="op" id="7008486">[</span><span class="op" id="7008487">:</span><span class="ident" id="7008488">w</span><span class="op" id="7008489">.</span><span class="ident" id="7008490">n</span><span class="op" id="7008491">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7008494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008497">if</span>&nbsp;<span class="builtinfunc" id="7008500">len</span><span class="op" id="7008503">(</span><span class="ident" id="7008504">p</span><span class="op" id="7008505">)</span>&nbsp;<span class="op" id="7008507">&gt;</span>&nbsp;<span class="num" id="7008509">0</span>&nbsp;<span class="op" id="7008511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008515">n</span><span class="op" id="7008516">,</span>&nbsp;<span class="ident" id="7008518">err</span>&nbsp;<span class="op" id="7008522">=</span>&nbsp;<span class="ident" id="7008524">w</span><span class="op" id="7008525">.</span><span class="ident" id="7008526">w</span><span class="op" id="7008527">.</span><span class="ident" id="7008528">Write</span><span class="op" id="7008533">(</span><span class="ident" id="7008534">p</span><span class="op" id="7008535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008539">w</span><span class="op" id="7008540">.</span><span class="ident" id="7008541">n</span>&nbsp;<span class="op" id="7008543">-=</span>&nbsp;<span class="ident" id="7008546">n</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7008549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008552">if</span>&nbsp;<span class="ident" id="7008555">w</span><span class="op" id="7008556">.</span><span class="ident" id="7008557">n</span>&nbsp;<span class="op" id="7008559">==</span>&nbsp;<span class="num" id="7008562">0</span>&nbsp;<span class="op" id="7008564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008568">err</span>&nbsp;<span class="op" id="7008572">=</span>&nbsp;<span class="ident" id="7008574">errors</span><span class="op" id="7008580">.</span><span class="ident" id="7008581">New</span><span class="op" id="7008584">(</span><span class="string" id="7008585">&#34;past&nbsp;write&nbsp;limit&#34;</span><span class="op" id="7008603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7008606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008609">return</span><br>
<span class="lineno">90</span><span class="op" id="7008616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7008619">//&nbsp;If&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying&nbsp;the&nbsp;child&#39;s&nbsp;output&nbsp;to&nbsp;the&nbsp;parent,&nbsp;test</span><br>
<span class="lineno"></span><span class="comment" id="7008689">//&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword" id="7008716">func</span>&nbsp;<span class="ident" id="7008721">TestKillChildAfterCopyError</span><span class="op" id="7008748">(</span><span class="ident" id="7008749">t</span>&nbsp;<span class="op" id="7008751">*</span><span class="ident" id="7008752">testing</span><span class="op" id="7008759">.</span><span class="ident" id="7008760">T</span><span class="op" id="7008761">)</span>&nbsp;<span class="op" id="7008763">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008766">if</span>&nbsp;<span class="ident" id="7008769">runtime</span><span class="op" id="7008776">.</span><span class="ident" id="7008777">GOOS</span>&nbsp;<span class="op" id="7008782">==</span>&nbsp;<span class="string" id="7008785">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7008792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008796">t</span><span class="op" id="7008797">.</span><span class="ident" id="7008798">Skip</span><span class="op" id="7008802">(</span><span class="string" id="7008803">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7008821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7008824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7008828">defer</span>&nbsp;<span class="keyword" id="7008834">func</span><span class="op" id="7008838">(</span><span class="op" id="7008839">)</span>&nbsp;<span class="op" id="7008841">{</span>&nbsp;<span class="ident" id="7008843">testHookStartProcess</span>&nbsp;<span class="op" id="7008864">=</span>&nbsp;<span class="ident" id="7008866">nil</span>&nbsp;<span class="op" id="7008870">}</span><span class="op" id="7008871">(</span><span class="op" id="7008872">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008875">proc</span>&nbsp;<span class="op" id="7008880">:=</span>&nbsp;<span class="builtinfunc" id="7008883">make</span><span class="op" id="7008887">(</span><span class="keyword" id="7008888">chan</span>&nbsp;<span class="op" id="7008893">*</span><span class="ident" id="7008894">os</span><span class="op" id="7008896">.</span><span class="ident" id="7008897">Process</span><span class="op" id="7008904">,</span>&nbsp;<span class="num" id="7008906">1</span><span class="op" id="7008907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008910">testHookStartProcess</span>&nbsp;<span class="op" id="7008931">=</span>&nbsp;<span class="keyword" id="7008933">func</span><span class="op" id="7008937">(</span><span class="ident" id="7008938">p</span>&nbsp;<span class="op" id="7008940">*</span><span class="ident" id="7008941">os</span><span class="op" id="7008943">.</span><span class="ident" id="7008944">Process</span><span class="op" id="7008951">)</span>&nbsp;<span class="op" id="7008953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008957">proc</span>&nbsp;<span class="op" id="7008962">&lt;-</span>&nbsp;<span class="ident" id="7008965">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7008968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008972">h</span>&nbsp;<span class="op" id="7008974">:=</span>&nbsp;<span class="op" id="7008977">&amp;</span><span class="ident" id="7008978">Handler</span><span class="op" id="7008985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7008989">Path</span><span class="op" id="7008993">:</span>&nbsp;<span class="ident" id="7008995">os</span><span class="op" id="7008997">.</span><span class="ident" id="7008998">Args</span><span class="op" id="7009002">[</span><span class="num" id="7009003">0</span><span class="op" id="7009004">]</span><span class="op" id="7009005">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009009">Root</span><span class="op" id="7009013">:</span>&nbsp;<span class="string" id="7009015">&#34;/test.go&#34;</span><span class="op" id="7009025">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009029">Args</span><span class="op" id="7009033">:</span>&nbsp;<span class="op" id="7009035">[</span><span class="op" id="7009036">]</span><span class="builtintype" id="7009037">string</span><span class="op" id="7009043">{</span><span class="string" id="7009044">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7009077">}</span><span class="op" id="7009078">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009081">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009084">req</span><span class="op" id="7009087">,</span>&nbsp;<span class="ident" id="7009089">_</span>&nbsp;<span class="op" id="7009091">:=</span>&nbsp;<span class="ident" id="7009094">http</span><span class="op" id="7009098">.</span><span class="ident" id="7009099">NewRequest</span><span class="op" id="7009109">(</span><span class="string" id="7009110">&#34;GET&#34;</span><span class="op" id="7009115">,</span>&nbsp;<span class="string" id="7009117">&#34;http://example.com/test.cgi?write-forever=1&#34;</span><span class="op" id="7009162">,</span>&nbsp;<span class="ident" id="7009164">nil</span><span class="op" id="7009167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009170">rec</span>&nbsp;<span class="op" id="7009174">:=</span>&nbsp;<span class="ident" id="7009177">httptest</span><span class="op" id="7009185">.</span><span class="ident" id="7009186">NewRecorder</span><span class="op" id="7009197">(</span><span class="op" id="7009198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009201">var</span>&nbsp;<span class="ident" id="7009205">out</span>&nbsp;<span class="ident" id="7009209">bytes</span><span class="op" id="7009214">.</span><span class="ident" id="7009215">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009223">const</span>&nbsp;<span class="ident" id="7009229">writeLen</span>&nbsp;<span class="op" id="7009238">=</span>&nbsp;<span class="num" id="7009240">50</span>&nbsp;<span class="op" id="7009243">&lt;&lt;</span>&nbsp;<span class="num" id="7009246">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009250">rw</span>&nbsp;<span class="op" id="7009253">:=</span>&nbsp;<span class="op" id="7009256">&amp;</span><span class="ident" id="7009257">customWriterRecorder</span><span class="op" id="7009277">{</span><span class="op" id="7009278">&amp;</span><span class="ident" id="7009279">limitWriter</span><span class="op" id="7009290">{</span><span class="op" id="7009291">&amp;</span><span class="ident" id="7009292">out</span><span class="op" id="7009295">,</span>&nbsp;<span class="ident" id="7009297">writeLen</span><span class="op" id="7009305">}</span><span class="op" id="7009306">,</span>&nbsp;<span class="ident" id="7009308">rec</span><span class="op" id="7009311">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009315">donec</span>&nbsp;<span class="op" id="7009321">:=</span>&nbsp;<span class="builtinfunc" id="7009324">make</span><span class="op" id="7009328">(</span><span class="keyword" id="7009329">chan</span>&nbsp;<span class="builtintype" id="7009334">bool</span><span class="op" id="7009338">,</span>&nbsp;<span class="num" id="7009340">1</span><span class="op" id="7009341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009344">go</span>&nbsp;<span class="keyword" id="7009347">func</span><span class="op" id="7009351">(</span><span class="op" id="7009352">)</span>&nbsp;<span class="op" id="7009354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009358">h</span><span class="op" id="7009359">.</span><span class="ident" id="7009360">ServeHTTP</span><span class="op" id="7009369">(</span><span class="ident" id="7009370">rw</span><span class="op" id="7009372">,</span>&nbsp;<span class="ident" id="7009374">req</span><span class="op" id="7009377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009381">donec</span>&nbsp;<span class="op" id="7009387">&lt;-</span>&nbsp;<span class="builtintype" id="7009390">true</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009396">}</span><span class="op" id="7009397">(</span><span class="op" id="7009398">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009402">select</span>&nbsp;<span class="op" id="7009409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009412">case</span>&nbsp;<span class="op" id="7009417">&lt;-</span><span class="ident" id="7009419">donec</span><span class="op" id="7009424">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009428">if</span>&nbsp;<span class="ident" id="7009431">out</span><span class="op" id="7009434">.</span><span class="ident" id="7009435">Len</span><span class="op" id="7009438">(</span><span class="op" id="7009439">)</span>&nbsp;<span class="op" id="7009441">!=</span>&nbsp;<span class="ident" id="7009444">writeLen</span>&nbsp;<span class="op" id="7009453">||</span>&nbsp;<span class="ident" id="7009456">out</span><span class="op" id="7009459">.</span><span class="ident" id="7009460">Bytes</span><span class="op" id="7009465">(</span><span class="op" id="7009466">)</span><span class="op" id="7009467">[</span><span class="num" id="7009468">0</span><span class="op" id="7009469">]</span>&nbsp;<span class="op" id="7009471">!=</span>&nbsp;<span class="string" id="7009474">&#39;a&#39;</span>&nbsp;<span class="op" id="7009478">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009483">t</span><span class="op" id="7009484">.</span><span class="ident" id="7009485">Errorf</span><span class="op" id="7009491">(</span><span class="string" id="7009492">&#34;unexpected&nbsp;output:&nbsp;%q&#34;</span><span class="op" id="7009515">,</span>&nbsp;<span class="ident" id="7009517">out</span><span class="op" id="7009520">.</span><span class="ident" id="7009521">Bytes</span><span class="op" id="7009526">(</span><span class="op" id="7009527">)</span><span class="op" id="7009528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009535">case</span>&nbsp;<span class="op" id="7009540">&lt;-</span><span class="ident" id="7009542">time</span><span class="op" id="7009546">.</span><span class="ident" id="7009547">After</span><span class="op" id="7009552">(</span><span class="num" id="7009553">5</span>&nbsp;<span class="op" id="7009555">*</span>&nbsp;<span class="ident" id="7009557">time</span><span class="op" id="7009561">.</span><span class="ident" id="7009562">Second</span><span class="op" id="7009568">)</span><span class="op" id="7009569">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009573">t</span><span class="op" id="7009574">.</span><span class="ident" id="7009575">Errorf</span><span class="op" id="7009581">(</span><span class="string" id="7009582">&#34;timeout.&nbsp;ServeHTTP&nbsp;hung&nbsp;and&nbsp;didn&#39;t&nbsp;kill&nbsp;the&nbsp;child&nbsp;process?&#34;</span><span class="op" id="7009642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009646">select</span>&nbsp;<span class="op" id="7009653">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009657">case</span>&nbsp;<span class="ident" id="7009662">p</span>&nbsp;<span class="op" id="7009664">:=</span>&nbsp;<span class="op" id="7009667">&lt;-</span><span class="ident" id="7009669">proc</span><span class="op" id="7009673">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009678">p</span><span class="op" id="7009679">.</span><span class="ident" id="7009680">Kill</span><span class="op" id="7009684">(</span><span class="op" id="7009685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009690">t</span><span class="op" id="7009691">.</span><span class="ident" id="7009692">Logf</span><span class="op" id="7009696">(</span><span class="string" id="7009697">&#34;killed&nbsp;process&#34;</span><span class="op" id="7009713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009717">default</span><span class="op" id="7009724">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009729">t</span><span class="op" id="7009730">.</span><span class="ident" id="7009731">Logf</span><span class="op" id="7009735">(</span><span class="string" id="7009736">&#34;didn&#39;t&nbsp;kill&nbsp;process&#34;</span><span class="op" id="7009757">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009764">}</span><br>
<span class="lineno"></span><span class="op" id="7009766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7009769">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;child&nbsp;handler&nbsp;writing&nbsp;only&nbsp;headers&nbsp;works.</span><br>
<span class="lineno">140</span><span class="comment" id="7009826">//&nbsp;golang.org/issue/7196</span><br>
<span class="lineno"></span><span class="keyword" id="7009851">func</span>&nbsp;<span class="ident" id="7009856">TestChildOnlyHeaders</span><span class="op" id="7009876">(</span><span class="ident" id="7009877">t</span>&nbsp;<span class="op" id="7009879">*</span><span class="ident" id="7009880">testing</span><span class="op" id="7009887">.</span><span class="ident" id="7009888">T</span><span class="op" id="7009889">)</span>&nbsp;<span class="op" id="7009891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7009894">if</span>&nbsp;<span class="ident" id="7009897">runtime</span><span class="op" id="7009904">.</span><span class="ident" id="7009905">GOOS</span>&nbsp;<span class="op" id="7009910">==</span>&nbsp;<span class="string" id="7009913">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7009920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009924">t</span><span class="op" id="7009925">.</span><span class="ident" id="7009926">Skip</span><span class="op" id="7009930">(</span><span class="string" id="7009931">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7009949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7009952">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009956">h</span>&nbsp;<span class="op" id="7009958">:=</span>&nbsp;<span class="op" id="7009961">&amp;</span><span class="ident" id="7009962">Handler</span><span class="op" id="7009969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009973">Path</span><span class="op" id="7009977">:</span>&nbsp;<span class="ident" id="7009979">os</span><span class="op" id="7009981">.</span><span class="ident" id="7009982">Args</span><span class="op" id="7009986">[</span><span class="num" id="7009987">0</span><span class="op" id="7009988">]</span><span class="op" id="7009989">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7009993">Root</span><span class="op" id="7009997">:</span>&nbsp;<span class="string" id="7009999">&#34;/test.go&#34;</span><span class="op" id="7010009">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010013">Args</span><span class="op" id="7010017">:</span>&nbsp;<span class="op" id="7010019">[</span><span class="op" id="7010020">]</span><span class="builtintype" id="7010021">string</span><span class="op" id="7010027">{</span><span class="string" id="7010028">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7010061">}</span><span class="op" id="7010062">,</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010068">expectedMap</span>&nbsp;<span class="op" id="7010080">:=</span>&nbsp;<span class="keyword" id="7010083">map</span><span class="op" id="7010086">[</span><span class="builtintype" id="7010087">string</span><span class="op" id="7010093">]</span><span class="builtintype" id="7010094">string</span><span class="op" id="7010100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010104">&#34;_body&#34;</span><span class="op" id="7010111">:</span>&nbsp;<span class="string" id="7010113">&#34;&#34;</span><span class="op" id="7010115">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010121">replay</span>&nbsp;<span class="op" id="7010128">:=</span>&nbsp;<span class="ident" id="7010131">runCgiTest</span><span class="op" id="7010141">(</span><span class="ident" id="7010142">t</span><span class="op" id="7010143">,</span>&nbsp;<span class="ident" id="7010145">h</span><span class="op" id="7010146">,</span>&nbsp;<span class="string" id="7010148">&#34;GET&nbsp;/test.go?no-body=1&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7010204">,</span>&nbsp;<span class="ident" id="7010206">expectedMap</span><span class="op" id="7010217">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010220">if</span>&nbsp;<span class="ident" id="7010223">expected</span><span class="op" id="7010231">,</span>&nbsp;<span class="ident" id="7010233">got</span>&nbsp;<span class="op" id="7010237">:=</span>&nbsp;<span class="string" id="7010240">&#34;X-Test-Value&#34;</span><span class="op" id="7010254">,</span>&nbsp;<span class="ident" id="7010256">replay</span><span class="op" id="7010262">.</span><span class="ident" id="7010263">Header</span><span class="op" id="7010269">(</span><span class="op" id="7010270">)</span><span class="op" id="7010271">.</span><span class="ident" id="7010272">Get</span><span class="op" id="7010275">(</span><span class="string" id="7010276">&#34;X-Test-Header&#34;</span><span class="op" id="7010291">)</span><span class="op" id="7010292">;</span>&nbsp;<span class="ident" id="7010294">got</span>&nbsp;<span class="op" id="7010298">!=</span>&nbsp;<span class="ident" id="7010301">expected</span>&nbsp;<span class="op" id="7010310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010314">t</span><span class="op" id="7010315">.</span><span class="ident" id="7010316">Errorf</span><span class="op" id="7010322">(</span><span class="string" id="7010323">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7010363">,</span>&nbsp;<span class="ident" id="7010365">got</span><span class="op" id="7010368">,</span>&nbsp;<span class="ident" id="7010370">expected</span><span class="op" id="7010378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010381">}</span><br>
<span class="lineno"></span><span class="op" id="7010383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="7010386">//&nbsp;golang.org/issue/7198</span><br>
<span class="lineno"></span><span class="keyword" id="7010411">func</span>&nbsp;<span class="ident" id="7010416">Test500WithNoHeaders</span><span class="op" id="7010436">(</span><span class="ident" id="7010437">t</span>&nbsp;<span class="op" id="7010439">*</span><span class="ident" id="7010440">testing</span><span class="op" id="7010447">.</span><span class="ident" id="7010448">T</span><span class="op" id="7010449">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7010455">{</span>&nbsp;<span class="ident" id="7010457">want500Test</span><span class="op" id="7010468">(</span><span class="ident" id="7010469">t</span><span class="op" id="7010470">,</span>&nbsp;<span class="string" id="7010472">&#34;/immediate-disconnect&#34;</span><span class="op" id="7010495">)</span>&nbsp;<span class="op" id="7010497">}</span><br>
<span class="lineno"></span><span class="keyword" id="7010499">func</span>&nbsp;<span class="ident" id="7010504">Test500WithNoContentType</span><span class="op" id="7010528">(</span><span class="ident" id="7010529">t</span>&nbsp;<span class="op" id="7010531">*</span><span class="ident" id="7010532">testing</span><span class="op" id="7010539">.</span><span class="ident" id="7010540">T</span><span class="op" id="7010541">)</span>&nbsp;<span class="op" id="7010543">{</span>&nbsp;<span class="ident" id="7010545">want500Test</span><span class="op" id="7010556">(</span><span class="ident" id="7010557">t</span><span class="op" id="7010558">,</span>&nbsp;<span class="string" id="7010560">&#34;/no-content-type&#34;</span><span class="op" id="7010578">)</span>&nbsp;<span class="op" id="7010580">}</span><br>
<span class="lineno"></span><span class="keyword" id="7010582">func</span>&nbsp;<span class="ident" id="7010587">Test500WithEmptyHeaders</span><span class="op" id="7010610">(</span><span class="ident" id="7010611">t</span>&nbsp;<span class="op" id="7010613">*</span><span class="ident" id="7010614">testing</span><span class="op" id="7010621">.</span><span class="ident" id="7010622">T</span><span class="op" id="7010623">)</span>&nbsp;&nbsp;<span class="op" id="7010626">{</span>&nbsp;<span class="ident" id="7010628">want500Test</span><span class="op" id="7010639">(</span><span class="ident" id="7010640">t</span><span class="op" id="7010641">,</span>&nbsp;<span class="string" id="7010643">&#34;/empty-headers&#34;</span><span class="op" id="7010659">)</span>&nbsp;<span class="op" id="7010661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7010664">func</span>&nbsp;<span class="ident" id="7010669">want500Test</span><span class="op" id="7010680">(</span><span class="ident" id="7010681">t</span>&nbsp;<span class="op" id="7010683">*</span><span class="ident" id="7010684">testing</span><span class="op" id="7010691">.</span><span class="ident" id="7010692">T</span><span class="op" id="7010693">,</span>&nbsp;<span class="ident" id="7010695">path</span>&nbsp;<span class="builtintype" id="7010700">string</span><span class="op" id="7010706">)</span>&nbsp;<span class="op" id="7010708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010711">h</span>&nbsp;<span class="op" id="7010713">:=</span>&nbsp;<span class="op" id="7010716">&amp;</span><span class="ident" id="7010717">Handler</span><span class="op" id="7010724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010728">Path</span><span class="op" id="7010732">:</span>&nbsp;<span class="ident" id="7010734">os</span><span class="op" id="7010736">.</span><span class="ident" id="7010737">Args</span><span class="op" id="7010741">[</span><span class="num" id="7010742">0</span><span class="op" id="7010743">]</span><span class="op" id="7010744">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010748">Root</span><span class="op" id="7010752">:</span>&nbsp;<span class="string" id="7010754">&#34;/test.go&#34;</span><span class="op" id="7010764">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010768">Args</span><span class="op" id="7010772">:</span>&nbsp;<span class="op" id="7010774">[</span><span class="op" id="7010775">]</span><span class="builtintype" id="7010776">string</span><span class="op" id="7010782">{</span><span class="string" id="7010783">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7010816">}</span><span class="op" id="7010817">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010823">expectedMap</span>&nbsp;<span class="op" id="7010835">:=</span>&nbsp;<span class="keyword" id="7010838">map</span><span class="op" id="7010841">[</span><span class="builtintype" id="7010842">string</span><span class="op" id="7010848">]</span><span class="builtintype" id="7010849">string</span><span class="op" id="7010855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010859">&#34;_body&#34;</span><span class="op" id="7010866">:</span>&nbsp;<span class="string" id="7010868">&#34;&#34;</span><span class="op" id="7010870">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010876">replay</span>&nbsp;<span class="op" id="7010883">:=</span>&nbsp;<span class="ident" id="7010886">runCgiTest</span><span class="op" id="7010896">(</span><span class="ident" id="7010897">t</span><span class="op" id="7010898">,</span>&nbsp;<span class="ident" id="7010900">h</span><span class="op" id="7010901">,</span>&nbsp;<span class="string" id="7010903">&#34;GET&nbsp;&#34;</span><span class="op" id="7010909">+</span><span class="ident" id="7010910">path</span><span class="op" id="7010914">+</span><span class="string" id="7010915">&#34;&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7010949">,</span>&nbsp;<span class="ident" id="7010951">expectedMap</span><span class="op" id="7010962">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010965">if</span>&nbsp;<span class="ident" id="7010968">replay</span><span class="op" id="7010974">.</span><span class="ident" id="7010975">Code</span>&nbsp;<span class="op" id="7010980">!=</span>&nbsp;<span class="num" id="7010983">500</span>&nbsp;<span class="op" id="7010987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010991">t</span><span class="op" id="7010992">.</span><span class="ident" id="7010993">Errorf</span><span class="op" id="7010999">(</span><span class="string" id="7011000">&#34;Got&nbsp;code&nbsp;%d;&nbsp;want&nbsp;500&#34;</span><span class="op" id="7011023">,</span>&nbsp;<span class="ident" id="7011025">replay</span><span class="op" id="7011031">.</span><span class="ident" id="7011032">Code</span><span class="op" id="7011036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011039">}</span><br>
<span class="lineno"></span><span class="op" id="7011041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="7011044">type</span>&nbsp;<span class="ident" id="7011049">neverEnding</span>&nbsp;<span class="builtintype" id="7011061">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7011067">func</span>&nbsp;<span class="op" id="7011072">(</span><span class="ident" id="7011073">b</span>&nbsp;<span class="ident" id="7011075">neverEnding</span><span class="op" id="7011086">)</span>&nbsp;<span class="ident" id="7011088">Read</span><span class="op" id="7011092">(</span><span class="ident" id="7011093">p</span>&nbsp;<span class="op" id="7011095">[</span><span class="op" id="7011096">]</span><span class="builtintype" id="7011097">byte</span><span class="op" id="7011101">)</span>&nbsp;<span class="op" id="7011103">(</span><span class="ident" id="7011104">n</span>&nbsp;<span class="builtintype" id="7011106">int</span><span class="op" id="7011109">,</span>&nbsp;<span class="ident" id="7011111">err</span>&nbsp;<span class="builtintype" id="7011115">error</span><span class="op" id="7011120">)</span>&nbsp;<span class="op" id="7011122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011125">for</span>&nbsp;<span class="ident" id="7011129">i</span>&nbsp;<span class="op" id="7011131">:=</span>&nbsp;<span class="keyword" id="7011134">range</span>&nbsp;<span class="ident" id="7011140">p</span>&nbsp;<span class="op" id="7011142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011146">p</span><span class="op" id="7011147">[</span><span class="ident" id="7011148">i</span><span class="op" id="7011149">]</span>&nbsp;<span class="op" id="7011151">=</span>&nbsp;<span class="builtintype" id="7011153">byte</span><span class="op" id="7011157">(</span><span class="ident" id="7011158">b</span><span class="op" id="7011159">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011165">return</span>&nbsp;<span class="builtinfunc" id="7011172">len</span><span class="op" id="7011175">(</span><span class="ident" id="7011176">p</span><span class="op" id="7011177">)</span><span class="op" id="7011178">,</span>&nbsp;<span class="ident" id="7011180">nil</span><br>
<span class="lineno"></span><span class="op" id="7011184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7011187">//&nbsp;Note:&nbsp;not&nbsp;actually&nbsp;a&nbsp;test.</span><br>
<span class="lineno">190</span><span class="keyword" id="7011217">func</span>&nbsp;<span class="ident" id="7011222">TestBeChildCGIProcess</span><span class="op" id="7011243">(</span><span class="ident" id="7011244">t</span>&nbsp;<span class="op" id="7011246">*</span><span class="ident" id="7011247">testing</span><span class="op" id="7011254">.</span><span class="ident" id="7011255">T</span><span class="op" id="7011256">)</span>&nbsp;<span class="op" id="7011258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011261">if</span>&nbsp;<span class="ident" id="7011264">os</span><span class="op" id="7011266">.</span><span class="ident" id="7011267">Getenv</span><span class="op" id="7011273">(</span><span class="string" id="7011274">&#34;REQUEST_METHOD&#34;</span><span class="op" id="7011290">)</span>&nbsp;<span class="op" id="7011292">==</span>&nbsp;<span class="string" id="7011295">&#34;&#34;</span>&nbsp;<span class="op" id="7011298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7011302">//&nbsp;Not&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment;&nbsp;skipping&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011348">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011356">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011359">switch</span>&nbsp;<span class="ident" id="7011366">os</span><span class="op" id="7011368">.</span><span class="ident" id="7011369">Getenv</span><span class="op" id="7011375">(</span><span class="string" id="7011376">&#34;REQUEST_URI&#34;</span><span class="op" id="7011389">)</span>&nbsp;<span class="op" id="7011391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011394">case</span>&nbsp;<span class="string" id="7011399">&#34;/immediate-disconnect&#34;</span><span class="op" id="7011422">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011426">os</span><span class="op" id="7011428">.</span><span class="ident" id="7011429">Exit</span><span class="op" id="7011433">(</span><span class="num" id="7011434">0</span><span class="op" id="7011435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011438">case</span>&nbsp;<span class="string" id="7011443">&#34;/no-content-type&#34;</span><span class="op" id="7011461">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011465">fmt</span><span class="op" id="7011468">.</span><span class="ident" id="7011469">Printf</span><span class="op" id="7011475">(</span><span class="string" id="7011476">&#34;Content-Length:&nbsp;6\n\nHello\n&#34;</span><span class="op" id="7011506">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011510">os</span><span class="op" id="7011512">.</span><span class="ident" id="7011513">Exit</span><span class="op" id="7011517">(</span><span class="num" id="7011518">0</span><span class="op" id="7011519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011522">case</span>&nbsp;<span class="string" id="7011527">&#34;/empty-headers&#34;</span><span class="op" id="7011543">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011547">fmt</span><span class="op" id="7011550">.</span><span class="ident" id="7011551">Printf</span><span class="op" id="7011557">(</span><span class="string" id="7011558">&#34;\nHello&#34;</span><span class="op" id="7011567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011571">os</span><span class="op" id="7011573">.</span><span class="ident" id="7011574">Exit</span><span class="op" id="7011578">(</span><span class="num" id="7011579">0</span><span class="op" id="7011580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011583">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011586">Serve</span><span class="op" id="7011591">(</span><span class="ident" id="7011592">http</span><span class="op" id="7011596">.</span><span class="ident" id="7011597">HandlerFunc</span><span class="op" id="7011608">(</span><span class="keyword" id="7011609">func</span><span class="op" id="7011613">(</span><span class="ident" id="7011614">rw</span>&nbsp;<span class="ident" id="7011617">http</span><span class="op" id="7011621">.</span><span class="ident" id="7011622">ResponseWriter</span><span class="op" id="7011636">,</span>&nbsp;<span class="ident" id="7011638">req</span>&nbsp;<span class="op" id="7011642">*</span><span class="ident" id="7011643">http</span><span class="op" id="7011647">.</span><span class="ident" id="7011648">Request</span><span class="op" id="7011655">)</span>&nbsp;<span class="op" id="7011657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011661">rw</span><span class="op" id="7011663">.</span><span class="ident" id="7011664">Header</span><span class="op" id="7011670">(</span><span class="op" id="7011671">)</span><span class="op" id="7011672">.</span><span class="ident" id="7011673">Set</span><span class="op" id="7011676">(</span><span class="string" id="7011677">&#34;X-Test-Header&#34;</span><span class="op" id="7011692">,</span>&nbsp;<span class="string" id="7011694">&#34;X-Test-Value&#34;</span><span class="op" id="7011708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011712">req</span><span class="op" id="7011715">.</span><span class="ident" id="7011716">ParseForm</span><span class="op" id="7011725">(</span><span class="op" id="7011726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011730">if</span>&nbsp;<span class="ident" id="7011733">req</span><span class="op" id="7011736">.</span><span class="ident" id="7011737">FormValue</span><span class="op" id="7011746">(</span><span class="string" id="7011747">&#34;no-body&#34;</span><span class="op" id="7011756">)</span>&nbsp;<span class="op" id="7011758">==</span>&nbsp;<span class="string" id="7011761">&#34;1&#34;</span>&nbsp;<span class="op" id="7011765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011770">return</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011783">if</span>&nbsp;<span class="ident" id="7011786">req</span><span class="op" id="7011789">.</span><span class="ident" id="7011790">FormValue</span><span class="op" id="7011799">(</span><span class="string" id="7011800">&#34;write-forever&#34;</span><span class="op" id="7011815">)</span>&nbsp;<span class="op" id="7011817">==</span>&nbsp;<span class="string" id="7011820">&#34;1&#34;</span>&nbsp;<span class="op" id="7011824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011829">io</span><span class="op" id="7011831">.</span><span class="ident" id="7011832">Copy</span><span class="op" id="7011836">(</span><span class="ident" id="7011837">rw</span><span class="op" id="7011839">,</span>&nbsp;<span class="ident" id="7011841">neverEnding</span><span class="op" id="7011852">(</span><span class="string" id="7011853">&#39;a&#39;</span><span class="op" id="7011856">)</span><span class="op" id="7011857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011862">for</span>&nbsp;<span class="op" id="7011866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011872">time</span><span class="op" id="7011876">.</span><span class="ident" id="7011877">Sleep</span><span class="op" id="7011882">(</span><span class="num" id="7011883">5</span>&nbsp;<span class="op" id="7011885">*</span>&nbsp;<span class="ident" id="7011887">time</span><span class="op" id="7011891">.</span><span class="ident" id="7011892">Second</span><span class="op" id="7011898">)</span>&nbsp;<span class="comment" id="7011900">//&nbsp;hang&nbsp;forever,&nbsp;until&nbsp;killed</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011941">fmt</span><span class="op" id="7011944">.</span><span class="ident" id="7011945">Fprintf</span><span class="op" id="7011952">(</span><span class="ident" id="7011953">rw</span><span class="op" id="7011955">,</span>&nbsp;<span class="string" id="7011957">&#34;test=Hello&nbsp;CGI-in-CGI\n&#34;</span><span class="op" id="7011982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011986">for</span>&nbsp;<span class="ident" id="7011990">k</span><span class="op" id="7011991">,</span>&nbsp;<span class="ident" id="7011993">vv</span>&nbsp;<span class="op" id="7011996">:=</span>&nbsp;<span class="keyword" id="7011999">range</span>&nbsp;<span class="ident" id="7012005">req</span><span class="op" id="7012008">.</span><span class="ident" id="7012009">Form</span>&nbsp;<span class="op" id="7012014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012019">for</span>&nbsp;<span class="ident" id="7012023">_</span><span class="op" id="7012024">,</span>&nbsp;<span class="ident" id="7012026">v</span>&nbsp;<span class="op" id="7012028">:=</span>&nbsp;<span class="keyword" id="7012031">range</span>&nbsp;<span class="ident" id="7012037">vv</span>&nbsp;<span class="op" id="7012040">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012046">fmt</span><span class="op" id="7012049">.</span><span class="ident" id="7012050">Fprintf</span><span class="op" id="7012057">(</span><span class="ident" id="7012058">rw</span><span class="op" id="7012060">,</span>&nbsp;<span class="string" id="7012062">&#34;param-%s=%s\n&#34;</span><span class="op" id="7012077">,</span>&nbsp;<span class="ident" id="7012079">k</span><span class="op" id="7012080">,</span>&nbsp;<span class="ident" id="7012082">v</span><span class="op" id="7012083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012096">for</span>&nbsp;<span class="ident" id="7012100">_</span><span class="op" id="7012101">,</span>&nbsp;<span class="ident" id="7012103">kv</span>&nbsp;<span class="op" id="7012106">:=</span>&nbsp;<span class="keyword" id="7012109">range</span>&nbsp;<span class="ident" id="7012115">os</span><span class="op" id="7012117">.</span><span class="ident" id="7012118">Environ</span><span class="op" id="7012125">(</span><span class="op" id="7012126">)</span>&nbsp;<span class="op" id="7012128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012133">fmt</span><span class="op" id="7012136">.</span><span class="ident" id="7012137">Fprintf</span><span class="op" id="7012144">(</span><span class="ident" id="7012145">rw</span><span class="op" id="7012147">,</span>&nbsp;<span class="string" id="7012149">&#34;env-%s\n&#34;</span><span class="op" id="7012159">,</span>&nbsp;<span class="ident" id="7012161">kv</span><span class="op" id="7012163">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012170">}</span><span class="op" id="7012171">)</span><span class="op" id="7012172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012175">os</span><span class="op" id="7012177">.</span><span class="ident" id="7012178">Exit</span><span class="op" id="7012182">(</span><span class="num" id="7012183">0</span><span class="op" id="7012184">)</span><br>
<span class="lineno"></span><span class="op" id="7012186">}</span>
</div>
</body>
</html>
