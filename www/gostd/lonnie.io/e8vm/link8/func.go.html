<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>lonnie.io/e8vm/link8</h2>
<ul>
<li><a href="/gostd/lonnie.io/e8vm/link8/func.go.html">func.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/layout.go.html">layout.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/link.go.html">link.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/linker.go.html">linker.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/package.go.html">package.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/pkg_sym.go.html">pkg_sym.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/symbol.go.html">symbol.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/trace_used.go.html">trace_used.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/var.go.html">var.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/writer.go.html">writer.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="keyword" id="4811232">package</span>&nbsp;<span class="ident" id="4811240">link8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4811247">import</span>&nbsp;<span class="op" id="4811254">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4811257">&#34;math&#34;</span><br>
<span class="lineno">5</span><span class="op" id="4811264">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4811267">//&nbsp;link&nbsp;is&nbsp;a&nbsp;piece&nbsp;of&nbsp;linking&nbsp;information&nbsp;for&nbsp;an&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="4811328">//&nbsp;in&nbsp;a&nbsp;code&nbsp;section&nbsp;at&nbsp;a&nbsp;particular&nbsp;offset.</span><br>
<span class="lineno"></span><span class="comment" id="4811373">//&nbsp;it&nbsp;uses&nbsp;the&nbsp;indices&nbsp;in&nbsp;the&nbsp;package&nbsp;for&nbsp;symbol&nbsp;lookup</span><br>
<span class="lineno">10</span><span class="keyword" id="4811429">type</span>&nbsp;<span class="ident" id="4811434">link</span>&nbsp;<span class="keyword" id="4811439">struct</span>&nbsp;<span class="op" id="4811446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811449">offset</span>&nbsp;<span class="builtintype" id="4811456">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811464">pkg</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4811471">uint32</span>&nbsp;<span class="comment" id="4811478">//&nbsp;relative&nbsp;package&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811505">sym</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4811512">uint32</span><br>
<span class="lineno"></span><span class="op" id="4811519">}</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="4811522">//&nbsp;Func&nbsp;is&nbsp;a&nbsp;relocatable&nbsp;code&nbsp;section</span><br>
<span class="lineno"></span><span class="keyword" id="4811560">type</span>&nbsp;<span class="ident" id="4811565">Func</span>&nbsp;<span class="keyword" id="4811570">struct</span>&nbsp;<span class="op" id="4811577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811580">insts</span>&nbsp;<span class="op" id="4811586">[</span><span class="op" id="4811587">]</span><span class="builtintype" id="4811588">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811596">links</span>&nbsp;<span class="op" id="4811602">[</span><span class="op" id="4811603">]</span><span class="op" id="4811604">*</span><span class="ident" id="4811605">link</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811612">addr</span>&nbsp;<span class="builtintype" id="4811617">uint32</span><br>
<span class="lineno"></span><span class="op" id="4811624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4811627">//&nbsp;NewFunc&nbsp;creates&nbsp;a&nbsp;new&nbsp;relocatable&nbsp;code&nbsp;section.</span><br>
<span class="lineno">25</span><span class="keyword" id="4811678">func</span>&nbsp;<span class="ident" id="4811683">NewFunc</span><span class="op" id="4811690">(</span><span class="op" id="4811691">)</span>&nbsp;<span class="op" id="4811693">*</span><span class="ident" id="4811694">Func</span>&nbsp;<span class="op" id="4811699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811702">return</span>&nbsp;<span class="builtinfunc" id="4811709">new</span><span class="op" id="4811712">(</span><span class="ident" id="4811713">Func</span><span class="op" id="4811717">)</span><br>
<span class="lineno"></span><span class="op" id="4811719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4811722">//&nbsp;AddInst&nbsp;appends&nbsp;an&nbsp;instruction&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;function.</span><br>
<span class="lineno">30</span><span class="keyword" id="4811784">func</span>&nbsp;<span class="op" id="4811789">(</span><span class="ident" id="4811790">f</span>&nbsp;<span class="op" id="4811792">*</span><span class="ident" id="4811793">Func</span><span class="op" id="4811797">)</span>&nbsp;<span class="ident" id="4811799">AddInst</span><span class="op" id="4811806">(</span><span class="ident" id="4811807">i</span>&nbsp;<span class="builtintype" id="4811809">uint32</span><span class="op" id="4811815">)</span>&nbsp;<span class="op" id="4811817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4811820">f</span><span class="op" id="4811821">.</span><span class="ident" id="4811822">insts</span>&nbsp;<span class="op" id="4811828">=</span>&nbsp;<span class="builtinfunc" id="4811830">append</span><span class="op" id="4811836">(</span><span class="ident" id="4811837">f</span><span class="op" id="4811838">.</span><span class="ident" id="4811839">insts</span><span class="op" id="4811844">,</span>&nbsp;<span class="ident" id="4811846">i</span><span class="op" id="4811847">)</span><br>
<span class="lineno"></span><span class="op" id="4811849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4811852">//&nbsp;TooLarge&nbsp;checks&nbsp;if&nbsp;the&nbsp;function&nbsp;size&nbsp;is&nbsp;larger&nbsp;than&nbsp;4GB.</span><br>
<span class="lineno">35</span><span class="keyword" id="4811912">func</span>&nbsp;<span class="op" id="4811917">(</span><span class="ident" id="4811918">f</span>&nbsp;<span class="op" id="4811920">*</span><span class="ident" id="4811921">Func</span><span class="op" id="4811925">)</span>&nbsp;<span class="ident" id="4811927">TooLarge</span><span class="op" id="4811935">(</span><span class="op" id="4811936">)</span>&nbsp;<span class="builtintype" id="4811938">bool</span>&nbsp;<span class="op" id="4811943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4811946">return</span>&nbsp;<span class="builtinfunc" id="4811953">len</span><span class="op" id="4811956">(</span><span class="ident" id="4811957">f</span><span class="op" id="4811958">.</span><span class="ident" id="4811959">insts</span><span class="op" id="4811964">)</span><span class="op" id="4811965">*</span><span class="num" id="4811966">4</span>&nbsp;<span class="op" id="4811968">&gt;=</span>&nbsp;<span class="ident" id="4811971">math</span><span class="op" id="4811975">.</span><span class="ident" id="4811976">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="4811985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4811988">//&nbsp;Size&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;function.</span><br>
<span class="lineno">40</span><span class="keyword" id="4812030">func</span>&nbsp;<span class="op" id="4812035">(</span><span class="ident" id="4812036">f</span>&nbsp;<span class="op" id="4812038">*</span><span class="ident" id="4812039">Func</span><span class="op" id="4812043">)</span>&nbsp;<span class="ident" id="4812045">Size</span><span class="op" id="4812049">(</span><span class="op" id="4812050">)</span>&nbsp;<span class="builtintype" id="4812052">uint32</span>&nbsp;<span class="op" id="4812059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4812062">return</span>&nbsp;<span class="builtintype" id="4812069">uint32</span><span class="op" id="4812075">(</span><span class="builtinfunc" id="4812076">len</span><span class="op" id="4812079">(</span><span class="ident" id="4812080">f</span><span class="op" id="4812081">.</span><span class="ident" id="4812082">insts</span><span class="op" id="4812087">)</span>&nbsp;<span class="op" id="4812089">*</span>&nbsp;<span class="num" id="4812091">4</span><span class="op" id="4812092">)</span><br>
<span class="lineno"></span><span class="op" id="4812094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4812097">//&nbsp;AddLink&nbsp;links&nbsp;the&nbsp;last&nbsp;instruction&nbsp;in&nbsp;inst&nbsp;to</span><br>
<span class="lineno">45</span><span class="comment" id="4812146">//&nbsp;the&nbsp;symbol&nbsp;pkg.sym,&nbsp;where&nbsp;pkg&nbsp;and&nbsp;sym&nbsp;are&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4812201">//&nbsp;indexing&nbsp;of&nbsp;the&nbsp;object&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="4812233">//&nbsp;fill&nbsp;field&nbsp;must&nbsp;be&nbsp;less&nbsp;than&nbsp;4&nbsp;so&nbsp;that&nbsp;it&nbsp;fits&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4812290">//&nbsp;lowest&nbsp;2&nbsp;bits&nbsp;in&nbsp;the&nbsp;offset&nbsp;field.&nbsp;The&nbsp;other&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="4812343">//&nbsp;of&nbsp;the&nbsp;offset&nbsp;fields&nbsp;will&nbsp;be&nbsp;automatically&nbsp;calculated</span><br>
<span class="lineno">50</span><span class="comment" id="4812400">//&nbsp;based&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;instructions&nbsp;in&nbsp;insts.</span><br>
<span class="lineno"></span><span class="keyword" id="4812449">func</span>&nbsp;<span class="op" id="4812454">(</span><span class="ident" id="4812455">f</span>&nbsp;<span class="op" id="4812457">*</span><span class="ident" id="4812458">Func</span><span class="op" id="4812462">)</span>&nbsp;<span class="ident" id="4812464">AddLink</span><span class="op" id="4812471">(</span><span class="ident" id="4812472">fill</span>&nbsp;<span class="builtintype" id="4812477">int</span><span class="op" id="4812480">,</span>&nbsp;<span class="ident" id="4812482">pkg</span><span class="op" id="4812485">,</span>&nbsp;<span class="ident" id="4812487">sym</span>&nbsp;<span class="builtintype" id="4812491">uint32</span><span class="op" id="4812497">)</span>&nbsp;<span class="op" id="4812499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4812502">if</span>&nbsp;<span class="builtinfunc" id="4812505">len</span><span class="op" id="4812508">(</span><span class="ident" id="4812509">f</span><span class="op" id="4812510">.</span><span class="ident" id="4812511">insts</span><span class="op" id="4812516">)</span>&nbsp;<span class="op" id="4812518">==</span>&nbsp;<span class="num" id="4812521">0</span>&nbsp;<span class="op" id="4812523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4812527">panic</span><span class="op" id="4812532">(</span><span class="string" id="4812533">&#34;no&nbsp;inst&nbsp;to&nbsp;link&#34;</span><span class="op" id="4812550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4812553">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4812556">if</span>&nbsp;<span class="op" id="4812559">!</span><span class="op" id="4812560">(</span><span class="ident" id="4812561">fill</span>&nbsp;<span class="op" id="4812566">&gt;</span>&nbsp;<span class="num" id="4812568">0</span>&nbsp;<span class="op" id="4812570">&amp;&amp;</span>&nbsp;<span class="ident" id="4812573">fill</span>&nbsp;<span class="op" id="4812578">&lt;=</span>&nbsp;<span class="num" id="4812581">3</span><span class="op" id="4812582">)</span>&nbsp;<span class="op" id="4812584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4812588">panic</span><span class="op" id="4812593">(</span><span class="string" id="4812594">&#34;invalid&nbsp;fill&#34;</span><span class="op" id="4812608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4812611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812615">offset</span>&nbsp;<span class="op" id="4812622">:=</span>&nbsp;<span class="builtintype" id="4812625">uint32</span><span class="op" id="4812631">(</span><span class="builtinfunc" id="4812632">len</span><span class="op" id="4812635">(</span><span class="ident" id="4812636">f</span><span class="op" id="4812637">.</span><span class="ident" id="4812638">insts</span><span class="op" id="4812643">)</span><span class="op" id="4812644">)</span><span class="op" id="4812645">*</span><span class="num" id="4812646">4</span>&nbsp;<span class="op" id="4812648">-</span>&nbsp;<span class="num" id="4812650">4</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812653">offset</span>&nbsp;<span class="op" id="4812660">|=</span>&nbsp;<span class="builtintype" id="4812663">uint32</span><span class="op" id="4812669">(</span><span class="ident" id="4812670">fill</span><span class="op" id="4812674">)</span>&nbsp;<span class="op" id="4812676">&amp;</span>&nbsp;<span class="num" id="4812678">0x3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812683">link</span>&nbsp;<span class="op" id="4812688">:=</span>&nbsp;<span class="op" id="4812691">&amp;</span><span class="ident" id="4812692">link</span><span class="op" id="4812696">{</span><span class="ident" id="4812697">offset</span><span class="op" id="4812703">:</span>&nbsp;<span class="ident" id="4812705">offset</span><span class="op" id="4812711">,</span>&nbsp;<span class="ident" id="4812713">pkg</span><span class="op" id="4812716">:</span>&nbsp;<span class="ident" id="4812718">pkg</span><span class="op" id="4812721">,</span>&nbsp;<span class="ident" id="4812723">sym</span><span class="op" id="4812726">:</span>&nbsp;<span class="ident" id="4812728">sym</span><span class="op" id="4812731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812734">f</span><span class="op" id="4812735">.</span><span class="ident" id="4812736">links</span>&nbsp;<span class="op" id="4812742">=</span>&nbsp;<span class="builtinfunc" id="4812744">append</span><span class="op" id="4812750">(</span><span class="ident" id="4812751">f</span><span class="op" id="4812752">.</span><span class="ident" id="4812753">links</span><span class="op" id="4812758">,</span>&nbsp;<span class="ident" id="4812760">link</span><span class="op" id="4812764">)</span><br>
<span class="lineno"></span><span class="op" id="4812766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4812769">//&nbsp;Constant&nbsp;fill-later&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="4812801">const</span>&nbsp;<span class="op" id="4812807">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812810">FillNone</span>&nbsp;<span class="op" id="4812819">=</span>&nbsp;<span class="ident" id="4812821">iota</span>&nbsp;<span class="comment" id="4812826">//&nbsp;no&nbsp;fill</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812838">FillLink</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4812854">//&nbsp;fill&nbsp;as&nbsp;linking&nbsp;offset&nbsp;for&nbsp;jump&nbsp;instructions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812903">FillLow</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4812919">//&nbsp;fill&nbsp;with&nbsp;the&nbsp;lower&nbsp;16&nbsp;bits</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4812951">FillHigh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4812967">//&nbsp;fill&nbsp;with&nbsp;the&nbsp;higher&nbsp;16&nbsp;bits</span><br>
<span class="lineno"></span><span class="op" id="4812999">)</span>
</div>
</body>
</html>
