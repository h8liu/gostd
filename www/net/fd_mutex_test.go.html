<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7426765">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7426820">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7426874">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7426925">package</span>&nbsp;<span class="ident" id="7426933">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7426938">import</span>&nbsp;<span class="op" id="7426945">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7426948">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7426961">&#34;runtime&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7426972">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7426983">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7426990">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7426993">func</span>&nbsp;<span class="ident" id="7426998">TestMutexLock</span><span class="op" id="7427011">(</span><span class="ident" id="7427012">t</span>&nbsp;<span class="op" id="7427014">*</span><span class="ident" id="7427015">testing</span><span class="op" id="7427022">.</span><span class="ident" id="7427023">T</span><span class="op" id="7427024">)</span>&nbsp;<span class="op" id="7427026">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427029">var</span>&nbsp;<span class="ident" id="7427033">mu</span>&nbsp;<span class="ident" id="7427036">fdMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427046">if</span>&nbsp;<span class="op" id="7427049">!</span><span class="ident" id="7427050">mu</span><span class="op" id="7427052">.</span><span class="ident" id="7427053">Incref</span><span class="op" id="7427059">(</span><span class="op" id="7427060">)</span>&nbsp;<span class="op" id="7427062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427066">t</span><span class="op" id="7427067">.</span><span class="ident" id="7427068">Fatal</span><span class="op" id="7427073">(</span><span class="string" id="7427074">&#34;broken&#34;</span><span class="op" id="7427082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7427085">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427088">if</span>&nbsp;<span class="ident" id="7427091">mu</span><span class="op" id="7427093">.</span><span class="ident" id="7427094">Decref</span><span class="op" id="7427100">(</span><span class="op" id="7427101">)</span>&nbsp;<span class="op" id="7427103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427107">t</span><span class="op" id="7427108">.</span><span class="ident" id="7427109">Fatal</span><span class="op" id="7427114">(</span><span class="string" id="7427115">&#34;broken&#34;</span><span class="op" id="7427123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7427126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427130">if</span>&nbsp;<span class="op" id="7427133">!</span><span class="ident" id="7427134">mu</span><span class="op" id="7427136">.</span><span class="ident" id="7427137">RWLock</span><span class="op" id="7427143">(</span><span class="ident" id="7427144">true</span><span class="op" id="7427148">)</span>&nbsp;<span class="op" id="7427150">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427154">t</span><span class="op" id="7427155">.</span><span class="ident" id="7427156">Fatal</span><span class="op" id="7427161">(</span><span class="string" id="7427162">&#34;broken&#34;</span><span class="op" id="7427170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7427173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427176">if</span>&nbsp;<span class="ident" id="7427179">mu</span><span class="op" id="7427181">.</span><span class="ident" id="7427182">RWUnlock</span><span class="op" id="7427190">(</span><span class="ident" id="7427191">true</span><span class="op" id="7427195">)</span>&nbsp;<span class="op" id="7427197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427201">t</span><span class="op" id="7427202">.</span><span class="ident" id="7427203">Fatal</span><span class="op" id="7427208">(</span><span class="string" id="7427209">&#34;broken&#34;</span><span class="op" id="7427217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7427220">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427224">if</span>&nbsp;<span class="op" id="7427227">!</span><span class="ident" id="7427228">mu</span><span class="op" id="7427230">.</span><span class="ident" id="7427231">RWLock</span><span class="op" id="7427237">(</span><span class="ident" id="7427238">false</span><span class="op" id="7427243">)</span>&nbsp;<span class="op" id="7427245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427249">t</span><span class="op" id="7427250">.</span><span class="ident" id="7427251">Fatal</span><span class="op" id="7427256">(</span><span class="string" id="7427257">&#34;broken&#34;</span><span class="op" id="7427265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7427268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427271">if</span>&nbsp;<span class="ident" id="7427274">mu</span><span class="op" id="7427276">.</span><span class="ident" id="7427277">RWUnlock</span><span class="op" id="7427285">(</span><span class="ident" id="7427286">false</span><span class="op" id="7427291">)</span>&nbsp;<span class="op" id="7427293">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427297">t</span><span class="op" id="7427298">.</span><span class="ident" id="7427299">Fatal</span><span class="op" id="7427304">(</span><span class="string" id="7427305">&#34;broken&#34;</span><span class="op" id="7427313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7427316">}</span><br>
<span class="lineno"></span><span class="op" id="7427318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7427321">func</span>&nbsp;<span class="ident" id="7427326">TestMutexClose</span><span class="op" id="7427340">(</span><span class="ident" id="7427341">t</span>&nbsp;<span class="op" id="7427343">*</span><span class="ident" id="7427344">testing</span><span class="op" id="7427351">.</span><span class="ident" id="7427352">T</span><span class="op" id="7427353">)</span>&nbsp;<span class="op" id="7427355">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427358">var</span>&nbsp;<span class="ident" id="7427362">mu</span>&nbsp;<span class="ident" id="7427365">fdMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427374">if</span>&nbsp;<span class="op" id="7427377">!</span><span class="ident" id="7427378">mu</span><span class="op" id="7427380">.</span><span class="ident" id="7427381">IncrefAndClose</span><span class="op" id="7427395">(</span><span class="op" id="7427396">)</span>&nbsp;<span class="op" id="7427398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427402">t</span><span class="op" id="7427403">.</span><span class="ident" id="7427404">Fatal</span><span class="op" id="7427409">(</span><span class="string" id="7427410">&#34;broken&#34;</span><span class="op" id="7427418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7427421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427425">if</span>&nbsp;<span class="ident" id="7427428">mu</span><span class="op" id="7427430">.</span><span class="ident" id="7427431">Incref</span><span class="op" id="7427437">(</span><span class="op" id="7427438">)</span>&nbsp;<span class="op" id="7427440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427444">t</span><span class="op" id="7427445">.</span><span class="ident" id="7427446">Fatal</span><span class="op" id="7427451">(</span><span class="string" id="7427452">&#34;broken&#34;</span><span class="op" id="7427460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7427463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427466">if</span>&nbsp;<span class="ident" id="7427469">mu</span><span class="op" id="7427471">.</span><span class="ident" id="7427472">RWLock</span><span class="op" id="7427478">(</span><span class="ident" id="7427479">true</span><span class="op" id="7427483">)</span>&nbsp;<span class="op" id="7427485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427489">t</span><span class="op" id="7427490">.</span><span class="ident" id="7427491">Fatal</span><span class="op" id="7427496">(</span><span class="string" id="7427497">&#34;broken&#34;</span><span class="op" id="7427505">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7427508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427511">if</span>&nbsp;<span class="ident" id="7427514">mu</span><span class="op" id="7427516">.</span><span class="ident" id="7427517">RWLock</span><span class="op" id="7427523">(</span><span class="ident" id="7427524">false</span><span class="op" id="7427529">)</span>&nbsp;<span class="op" id="7427531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427535">t</span><span class="op" id="7427536">.</span><span class="ident" id="7427537">Fatal</span><span class="op" id="7427542">(</span><span class="string" id="7427543">&#34;broken&#34;</span><span class="op" id="7427551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7427554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427557">if</span>&nbsp;<span class="ident" id="7427560">mu</span><span class="op" id="7427562">.</span><span class="ident" id="7427563">IncrefAndClose</span><span class="op" id="7427577">(</span><span class="op" id="7427578">)</span>&nbsp;<span class="op" id="7427580">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427584">t</span><span class="op" id="7427585">.</span><span class="ident" id="7427586">Fatal</span><span class="op" id="7427591">(</span><span class="string" id="7427592">&#34;broken&#34;</span><span class="op" id="7427600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7427603">}</span><br>
<span class="lineno"></span><span class="op" id="7427605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7427608">func</span>&nbsp;<span class="ident" id="7427613">TestMutexCloseUnblock</span><span class="op" id="7427634">(</span><span class="ident" id="7427635">t</span>&nbsp;<span class="op" id="7427637">*</span><span class="ident" id="7427638">testing</span><span class="op" id="7427645">.</span><span class="ident" id="7427646">T</span><span class="op" id="7427647">)</span>&nbsp;<span class="op" id="7427649">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427652">c</span>&nbsp;<span class="op" id="7427654">:=</span>&nbsp;<span class="builtinfunc" id="7427657">make</span><span class="op" id="7427661">(</span><span class="keyword" id="7427662">chan</span>&nbsp;<span class="builtintype" id="7427667">bool</span><span class="op" id="7427671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427674">var</span>&nbsp;<span class="ident" id="7427678">mu</span>&nbsp;<span class="ident" id="7427681">fdMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427690">mu</span><span class="op" id="7427692">.</span><span class="ident" id="7427693">RWLock</span><span class="op" id="7427699">(</span><span class="ident" id="7427700">true</span><span class="op" id="7427704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427707">for</span>&nbsp;<span class="ident" id="7427711">i</span>&nbsp;<span class="op" id="7427713">:=</span>&nbsp;<span class="num" id="7427716">0</span><span class="op" id="7427717">;</span>&nbsp;<span class="ident" id="7427719">i</span>&nbsp;<span class="op" id="7427721">&lt;</span>&nbsp;<span class="num" id="7427723">4</span><span class="op" id="7427724">;</span>&nbsp;<span class="ident" id="7427726">i</span><span class="op" id="7427727">++</span>&nbsp;<span class="op" id="7427730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427734">go</span>&nbsp;<span class="keyword" id="7427737">func</span><span class="op" id="7427741">(</span><span class="op" id="7427742">)</span>&nbsp;<span class="op" id="7427744">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427749">if</span>&nbsp;<span class="ident" id="7427752">mu</span><span class="op" id="7427754">.</span><span class="ident" id="7427755">RWLock</span><span class="op" id="7427761">(</span><span class="ident" id="7427762">true</span><span class="op" id="7427766">)</span>&nbsp;<span class="op" id="7427768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427774">t</span><span class="op" id="7427775">.</span><span class="ident" id="7427776">Error</span><span class="op" id="7427781">(</span><span class="string" id="7427782">&#34;broken&#34;</span><span class="op" id="7427790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427796">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7427806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427811">c</span>&nbsp;<span class="op" id="7427813">&lt;-</span>&nbsp;<span class="ident" id="7427816">true</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7427823">}</span><span class="op" id="7427824">(</span><span class="op" id="7427825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7427828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7427831">//&nbsp;Concurrent&nbsp;goroutines&nbsp;must&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;read&nbsp;lock&nbsp;the&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427898">time</span><span class="op" id="7427902">.</span><span class="ident" id="7427903">Sleep</span><span class="op" id="7427908">(</span><span class="ident" id="7427909">time</span><span class="op" id="7427913">.</span><span class="ident" id="7427914">Millisecond</span><span class="op" id="7427925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427928">select</span>&nbsp;<span class="op" id="7427935">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427938">case</span>&nbsp;<span class="op" id="7427943">&lt;-</span><span class="ident" id="7427945">c</span><span class="op" id="7427946">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427950">t</span><span class="op" id="7427951">.</span><span class="ident" id="7427952">Fatal</span><span class="op" id="7427957">(</span><span class="string" id="7427958">&#34;broken&#34;</span><span class="op" id="7427966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7427969">default</span><span class="op" id="7427976">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7427979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7427982">mu</span><span class="op" id="7427984">.</span><span class="ident" id="7427985">IncrefAndClose</span><span class="op" id="7427999">(</span><span class="op" id="7428000">)</span>&nbsp;<span class="comment" id="7428002">//&nbsp;Must&nbsp;unblock&nbsp;the&nbsp;readers.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7428032">for</span>&nbsp;<span class="ident" id="7428036">i</span>&nbsp;<span class="op" id="7428038">:=</span>&nbsp;<span class="num" id="7428041">0</span><span class="op" id="7428042">;</span>&nbsp;<span class="ident" id="7428044">i</span>&nbsp;<span class="op" id="7428046">&lt;</span>&nbsp;<span class="num" id="7428048">4</span><span class="op" id="7428049">;</span>&nbsp;<span class="ident" id="7428051">i</span><span class="op" id="7428052">++</span>&nbsp;<span class="op" id="7428055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7428059">select</span>&nbsp;<span class="op" id="7428066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7428070">case</span>&nbsp;<span class="op" id="7428075">&lt;-</span><span class="ident" id="7428077">c</span><span class="op" id="7428078">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7428082">case</span>&nbsp;<span class="op" id="7428087">&lt;-</span><span class="ident" id="7428089">time</span><span class="op" id="7428093">.</span><span class="ident" id="7428094">After</span><span class="op" id="7428099">(</span><span class="num" id="7428100">10</span>&nbsp;<span class="op" id="7428103">*</span>&nbsp;<span class="ident" id="7428105">time</span><span class="op" id="7428109">.</span><span class="ident" id="7428110">Second</span><span class="op" id="7428116">)</span><span class="op" id="7428117">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428122">t</span><span class="op" id="7428123">.</span><span class="ident" id="7428124">Fatal</span><span class="op" id="7428129">(</span><span class="string" id="7428130">&#34;broken&#34;</span><span class="op" id="7428138">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7428142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7428145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7428148">if</span>&nbsp;<span class="ident" id="7428151">mu</span><span class="op" id="7428153">.</span><span class="ident" id="7428154">Decref</span><span class="op" id="7428160">(</span><span class="op" id="7428161">)</span>&nbsp;<span class="op" id="7428163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428167">t</span><span class="op" id="7428168">.</span><span class="ident" id="7428169">Fatal</span><span class="op" id="7428174">(</span><span class="string" id="7428175">&#34;broken&#34;</span><span class="op" id="7428183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7428186">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7428189">if</span>&nbsp;<span class="op" id="7428192">!</span><span class="ident" id="7428193">mu</span><span class="op" id="7428195">.</span><span class="ident" id="7428196">RWUnlock</span><span class="op" id="7428204">(</span><span class="ident" id="7428205">true</span><span class="op" id="7428209">)</span>&nbsp;<span class="op" id="7428211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428215">t</span><span class="op" id="7428216">.</span><span class="ident" id="7428217">Fatal</span><span class="op" id="7428222">(</span><span class="string" id="7428223">&#34;broken&#34;</span><span class="op" id="7428231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7428234">}</span><br>
<span class="lineno"></span><span class="op" id="7428236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7428239">func</span>&nbsp;<span class="ident" id="7428244">TestMutexPanic</span><span class="op" id="7428258">(</span><span class="ident" id="7428259">t</span>&nbsp;<span class="op" id="7428261">*</span><span class="ident" id="7428262">testing</span><span class="op" id="7428269">.</span><span class="ident" id="7428270">T</span><span class="op" id="7428271">)</span>&nbsp;<span class="op" id="7428273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428276">ensurePanics</span>&nbsp;<span class="op" id="7428289">:=</span>&nbsp;<span class="keyword" id="7428292">func</span><span class="op" id="7428296">(</span><span class="ident" id="7428297">f</span>&nbsp;<span class="keyword" id="7428299">func</span><span class="op" id="7428303">(</span><span class="op" id="7428304">)</span><span class="op" id="7428305">)</span>&nbsp;<span class="op" id="7428307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7428311">defer</span>&nbsp;<span class="keyword" id="7428317">func</span><span class="op" id="7428321">(</span><span class="op" id="7428322">)</span>&nbsp;<span class="op" id="7428324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7428329">if</span>&nbsp;<span class="builtinfunc" id="7428332">recover</span><span class="op" id="7428339">(</span><span class="op" id="7428340">)</span>&nbsp;<span class="op" id="7428342">==</span>&nbsp;<span class="ident" id="7428345">nil</span>&nbsp;<span class="op" id="7428349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428355">t</span><span class="op" id="7428356">.</span><span class="ident" id="7428357">Fatal</span><span class="op" id="7428362">(</span><span class="string" id="7428363">&#34;does&nbsp;not&nbsp;panic&#34;</span><span class="op" id="7428379">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7428384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7428388">}</span><span class="op" id="7428389">(</span><span class="op" id="7428390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428394">f</span><span class="op" id="7428395">(</span><span class="op" id="7428396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7428399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7428403">var</span>&nbsp;<span class="ident" id="7428407">mu</span>&nbsp;<span class="ident" id="7428410">fdMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428419">ensurePanics</span><span class="op" id="7428431">(</span><span class="keyword" id="7428432">func</span><span class="op" id="7428436">(</span><span class="op" id="7428437">)</span>&nbsp;<span class="op" id="7428439">{</span>&nbsp;<span class="ident" id="7428441">mu</span><span class="op" id="7428443">.</span><span class="ident" id="7428444">Decref</span><span class="op" id="7428450">(</span><span class="op" id="7428451">)</span>&nbsp;<span class="op" id="7428453">}</span><span class="op" id="7428454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428457">ensurePanics</span><span class="op" id="7428469">(</span><span class="keyword" id="7428470">func</span><span class="op" id="7428474">(</span><span class="op" id="7428475">)</span>&nbsp;<span class="op" id="7428477">{</span>&nbsp;<span class="ident" id="7428479">mu</span><span class="op" id="7428481">.</span><span class="ident" id="7428482">RWUnlock</span><span class="op" id="7428490">(</span><span class="ident" id="7428491">true</span><span class="op" id="7428495">)</span>&nbsp;<span class="op" id="7428497">}</span><span class="op" id="7428498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428501">ensurePanics</span><span class="op" id="7428513">(</span><span class="keyword" id="7428514">func</span><span class="op" id="7428518">(</span><span class="op" id="7428519">)</span>&nbsp;<span class="op" id="7428521">{</span>&nbsp;<span class="ident" id="7428523">mu</span><span class="op" id="7428525">.</span><span class="ident" id="7428526">RWUnlock</span><span class="op" id="7428534">(</span><span class="ident" id="7428535">false</span><span class="op" id="7428540">)</span>&nbsp;<span class="op" id="7428542">}</span><span class="op" id="7428543">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428547">ensurePanics</span><span class="op" id="7428559">(</span><span class="keyword" id="7428560">func</span><span class="op" id="7428564">(</span><span class="op" id="7428565">)</span>&nbsp;<span class="op" id="7428567">{</span>&nbsp;<span class="ident" id="7428569">mu</span><span class="op" id="7428571">.</span><span class="ident" id="7428572">Incref</span><span class="op" id="7428578">(</span><span class="op" id="7428579">)</span><span class="op" id="7428580">;</span>&nbsp;<span class="ident" id="7428582">mu</span><span class="op" id="7428584">.</span><span class="ident" id="7428585">Decref</span><span class="op" id="7428591">(</span><span class="op" id="7428592">)</span><span class="op" id="7428593">;</span>&nbsp;<span class="ident" id="7428595">mu</span><span class="op" id="7428597">.</span><span class="ident" id="7428598">Decref</span><span class="op" id="7428604">(</span><span class="op" id="7428605">)</span>&nbsp;<span class="op" id="7428607">}</span><span class="op" id="7428608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428611">ensurePanics</span><span class="op" id="7428623">(</span><span class="keyword" id="7428624">func</span><span class="op" id="7428628">(</span><span class="op" id="7428629">)</span>&nbsp;<span class="op" id="7428631">{</span>&nbsp;<span class="ident" id="7428633">mu</span><span class="op" id="7428635">.</span><span class="ident" id="7428636">RWLock</span><span class="op" id="7428642">(</span><span class="ident" id="7428643">true</span><span class="op" id="7428647">)</span><span class="op" id="7428648">;</span>&nbsp;<span class="ident" id="7428650">mu</span><span class="op" id="7428652">.</span><span class="ident" id="7428653">RWUnlock</span><span class="op" id="7428661">(</span><span class="ident" id="7428662">true</span><span class="op" id="7428666">)</span><span class="op" id="7428667">;</span>&nbsp;<span class="ident" id="7428669">mu</span><span class="op" id="7428671">.</span><span class="ident" id="7428672">RWUnlock</span><span class="op" id="7428680">(</span><span class="ident" id="7428681">true</span><span class="op" id="7428685">)</span>&nbsp;<span class="op" id="7428687">}</span><span class="op" id="7428688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428691">ensurePanics</span><span class="op" id="7428703">(</span><span class="keyword" id="7428704">func</span><span class="op" id="7428708">(</span><span class="op" id="7428709">)</span>&nbsp;<span class="op" id="7428711">{</span>&nbsp;<span class="ident" id="7428713">mu</span><span class="op" id="7428715">.</span><span class="ident" id="7428716">RWLock</span><span class="op" id="7428722">(</span><span class="ident" id="7428723">false</span><span class="op" id="7428728">)</span><span class="op" id="7428729">;</span>&nbsp;<span class="ident" id="7428731">mu</span><span class="op" id="7428733">.</span><span class="ident" id="7428734">RWUnlock</span><span class="op" id="7428742">(</span><span class="ident" id="7428743">false</span><span class="op" id="7428748">)</span><span class="op" id="7428749">;</span>&nbsp;<span class="ident" id="7428751">mu</span><span class="op" id="7428753">.</span><span class="ident" id="7428754">RWUnlock</span><span class="op" id="7428762">(</span><span class="ident" id="7428763">false</span><span class="op" id="7428768">)</span>&nbsp;<span class="op" id="7428770">}</span><span class="op" id="7428771">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7428775">//&nbsp;ensure&nbsp;that&nbsp;it&#39;s&nbsp;still&nbsp;not&nbsp;broken</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428813">mu</span><span class="op" id="7428815">.</span><span class="ident" id="7428816">Incref</span><span class="op" id="7428822">(</span><span class="op" id="7428823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428826">mu</span><span class="op" id="7428828">.</span><span class="ident" id="7428829">Decref</span><span class="op" id="7428835">(</span><span class="op" id="7428836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428839">mu</span><span class="op" id="7428841">.</span><span class="ident" id="7428842">RWLock</span><span class="op" id="7428848">(</span><span class="ident" id="7428849">true</span><span class="op" id="7428853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428856">mu</span><span class="op" id="7428858">.</span><span class="ident" id="7428859">RWUnlock</span><span class="op" id="7428867">(</span><span class="ident" id="7428868">true</span><span class="op" id="7428872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428875">mu</span><span class="op" id="7428877">.</span><span class="ident" id="7428878">RWLock</span><span class="op" id="7428884">(</span><span class="ident" id="7428885">false</span><span class="op" id="7428890">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428893">mu</span><span class="op" id="7428895">.</span><span class="ident" id="7428896">RWUnlock</span><span class="op" id="7428904">(</span><span class="ident" id="7428905">false</span><span class="op" id="7428910">)</span><br>
<span class="lineno"></span><span class="op" id="7428912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7428915">func</span>&nbsp;<span class="ident" id="7428920">TestMutexStress</span><span class="op" id="7428935">(</span><span class="ident" id="7428936">t</span>&nbsp;<span class="op" id="7428938">*</span><span class="ident" id="7428939">testing</span><span class="op" id="7428946">.</span><span class="ident" id="7428947">T</span><span class="op" id="7428948">)</span>&nbsp;<span class="op" id="7428950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428953">P</span>&nbsp;<span class="op" id="7428955">:=</span>&nbsp;<span class="num" id="7428958">8</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428961">N</span>&nbsp;<span class="op" id="7428963">:=</span>&nbsp;<span class="builtintype" id="7428966">int</span><span class="op" id="7428969">(</span><span class="num" id="7428970">1e6</span><span class="op" id="7428973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7428976">if</span>&nbsp;<span class="ident" id="7428979">testing</span><span class="op" id="7428986">.</span><span class="ident" id="7428987">Short</span><span class="op" id="7428992">(</span><span class="op" id="7428993">)</span>&nbsp;<span class="op" id="7428995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7428999">P</span>&nbsp;<span class="op" id="7429001">=</span>&nbsp;<span class="num" id="7429003">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7429007">N</span>&nbsp;<span class="op" id="7429009">=</span>&nbsp;<span class="num" id="7429011">1e4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7429016">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429019">defer</span>&nbsp;<span class="ident" id="7429025">runtime</span><span class="op" id="7429032">.</span><span class="ident" id="7429033">GOMAXPROCS</span><span class="op" id="7429043">(</span><span class="ident" id="7429044">runtime</span><span class="op" id="7429051">.</span><span class="ident" id="7429052">GOMAXPROCS</span><span class="op" id="7429062">(</span><span class="ident" id="7429063">P</span><span class="op" id="7429064">)</span><span class="op" id="7429065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7429068">done</span>&nbsp;<span class="op" id="7429073">:=</span>&nbsp;<span class="builtinfunc" id="7429076">make</span><span class="op" id="7429080">(</span><span class="keyword" id="7429081">chan</span>&nbsp;<span class="builtintype" id="7429086">bool</span><span class="op" id="7429090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429093">var</span>&nbsp;<span class="ident" id="7429097">mu</span>&nbsp;<span class="ident" id="7429100">fdMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429109">var</span>&nbsp;<span class="ident" id="7429113">readState</span>&nbsp;<span class="op" id="7429123">[</span><span class="num" id="7429124">2</span><span class="op" id="7429125">]</span><span class="ident" id="7429126">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429134">var</span>&nbsp;<span class="ident" id="7429138">writeState</span>&nbsp;<span class="op" id="7429149">[</span><span class="num" id="7429150">2</span><span class="op" id="7429151">]</span><span class="ident" id="7429152">uint64</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429160">for</span>&nbsp;<span class="ident" id="7429164">p</span>&nbsp;<span class="op" id="7429166">:=</span>&nbsp;<span class="num" id="7429169">0</span><span class="op" id="7429170">;</span>&nbsp;<span class="ident" id="7429172">p</span>&nbsp;<span class="op" id="7429174">&lt;</span>&nbsp;<span class="ident" id="7429176">P</span><span class="op" id="7429177">;</span>&nbsp;<span class="ident" id="7429179">p</span><span class="op" id="7429180">++</span>&nbsp;<span class="op" id="7429183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429187">go</span>&nbsp;<span class="keyword" id="7429190">func</span><span class="op" id="7429194">(</span><span class="op" id="7429195">)</span>&nbsp;<span class="op" id="7429197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7429202">r</span>&nbsp;<span class="op" id="7429204">:=</span>&nbsp;<span class="ident" id="7429207">rand</span><span class="op" id="7429211">.</span><span class="ident" id="7429212">New</span><span class="op" id="7429215">(</span><span class="ident" id="7429216">rand</span><span class="op" id="7429220">.</span><span class="ident" id="7429221">NewSource</span><span class="op" id="7429230">(</span><span class="ident" id="7429231">rand</span><span class="op" id="7429235">.</span><span class="ident" id="7429236">Int63</span><span class="op" id="7429241">(</span><span class="op" id="7429242">)</span><span class="op" id="7429243">)</span><span class="op" id="7429244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429249">for</span>&nbsp;<span class="ident" id="7429253">i</span>&nbsp;<span class="op" id="7429255">:=</span>&nbsp;<span class="num" id="7429258">0</span><span class="op" id="7429259">;</span>&nbsp;<span class="ident" id="7429261">i</span>&nbsp;<span class="op" id="7429263">&lt;</span>&nbsp;<span class="ident" id="7429265">N</span><span class="op" id="7429266">;</span>&nbsp;<span class="ident" id="7429268">i</span><span class="op" id="7429269">++</span>&nbsp;<span class="op" id="7429272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429278">switch</span>&nbsp;<span class="ident" id="7429285">r</span><span class="op" id="7429286">.</span><span class="ident" id="7429287">Intn</span><span class="op" id="7429291">(</span><span class="num" id="7429292">3</span><span class="op" id="7429293">)</span>&nbsp;<span class="op" id="7429295">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429301">case</span>&nbsp;<span class="num" id="7429306">0</span><span class="op" id="7429307">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429314">if</span>&nbsp;<span class="op" id="7429317">!</span><span class="ident" id="7429318">mu</span><span class="op" id="7429320">.</span><span class="ident" id="7429321">Incref</span><span class="op" id="7429327">(</span><span class="op" id="7429328">)</span>&nbsp;<span class="op" id="7429330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7429338">t</span><span class="op" id="7429339">.</span><span class="ident" id="7429340">Error</span><span class="op" id="7429345">(</span><span class="string" id="7429346">&#34;broken&#34;</span><span class="op" id="7429354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429362">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7429374">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429381">if</span>&nbsp;<span class="ident" id="7429384">mu</span><span class="op" id="7429386">.</span><span class="ident" id="7429387">Decref</span><span class="op" id="7429393">(</span><span class="op" id="7429394">)</span>&nbsp;<span class="op" id="7429396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7429404">t</span><span class="op" id="7429405">.</span><span class="ident" id="7429406">Error</span><span class="op" id="7429411">(</span><span class="string" id="7429412">&#34;broken&#34;</span><span class="op" id="7429420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429428">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7429440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429446">case</span>&nbsp;<span class="num" id="7429451">1</span><span class="op" id="7429452">:</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429459">if</span>&nbsp;<span class="op" id="7429462">!</span><span class="ident" id="7429463">mu</span><span class="op" id="7429465">.</span><span class="ident" id="7429466">RWLock</span><span class="op" id="7429472">(</span><span class="ident" id="7429473">true</span><span class="op" id="7429477">)</span>&nbsp;<span class="op" id="7429479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7429487">t</span><span class="op" id="7429488">.</span><span class="ident" id="7429489">Error</span><span class="op" id="7429494">(</span><span class="string" id="7429495">&#34;broken&#34;</span><span class="op" id="7429503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429511">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7429523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7429530">//&nbsp;Ensure&nbsp;that&nbsp;it&nbsp;provides&nbsp;mutual&nbsp;exclusion&nbsp;for&nbsp;readers.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429592">if</span>&nbsp;<span class="ident" id="7429595">readState</span><span class="op" id="7429604">[</span><span class="num" id="7429605">0</span><span class="op" id="7429606">]</span>&nbsp;<span class="op" id="7429608">!=</span>&nbsp;<span class="ident" id="7429611">readState</span><span class="op" id="7429620">[</span><span class="num" id="7429621">1</span><span class="op" id="7429622">]</span>&nbsp;<span class="op" id="7429624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7429632">t</span><span class="op" id="7429633">.</span><span class="ident" id="7429634">Error</span><span class="op" id="7429639">(</span><span class="string" id="7429640">&#34;broken&#34;</span><span class="op" id="7429648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429656">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7429668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7429675">readState</span><span class="op" id="7429684">[</span><span class="num" id="7429685">0</span><span class="op" id="7429686">]</span><span class="op" id="7429687">++</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7429695">readState</span><span class="op" id="7429704">[</span><span class="num" id="7429705">1</span><span class="op" id="7429706">]</span><span class="op" id="7429707">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429715">if</span>&nbsp;<span class="ident" id="7429718">mu</span><span class="op" id="7429720">.</span><span class="ident" id="7429721">RWUnlock</span><span class="op" id="7429729">(</span><span class="ident" id="7429730">true</span><span class="op" id="7429734">)</span>&nbsp;<span class="op" id="7429736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7429744">t</span><span class="op" id="7429745">.</span><span class="ident" id="7429746">Error</span><span class="op" id="7429751">(</span><span class="string" id="7429752">&#34;broken&#34;</span><span class="op" id="7429760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429768">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7429780">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429786">case</span>&nbsp;<span class="num" id="7429791">2</span><span class="op" id="7429792">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429799">if</span>&nbsp;<span class="op" id="7429802">!</span><span class="ident" id="7429803">mu</span><span class="op" id="7429805">.</span><span class="ident" id="7429806">RWLock</span><span class="op" id="7429812">(</span><span class="ident" id="7429813">false</span><span class="op" id="7429818">)</span>&nbsp;<span class="op" id="7429820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7429828">t</span><span class="op" id="7429829">.</span><span class="ident" id="7429830">Error</span><span class="op" id="7429835">(</span><span class="string" id="7429836">&#34;broken&#34;</span><span class="op" id="7429844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429852">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7429864">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7429871">//&nbsp;Ensure&nbsp;that&nbsp;it&nbsp;provides&nbsp;mutual&nbsp;exclusion&nbsp;for&nbsp;writers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429933">if</span>&nbsp;<span class="ident" id="7429936">writeState</span><span class="op" id="7429946">[</span><span class="num" id="7429947">0</span><span class="op" id="7429948">]</span>&nbsp;<span class="op" id="7429950">!=</span>&nbsp;<span class="ident" id="7429953">writeState</span><span class="op" id="7429963">[</span><span class="num" id="7429964">1</span><span class="op" id="7429965">]</span>&nbsp;<span class="op" id="7429967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7429975">t</span><span class="op" id="7429976">.</span><span class="ident" id="7429977">Error</span><span class="op" id="7429982">(</span><span class="string" id="7429983">&#34;broken&#34;</span><span class="op" id="7429991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7429999">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7430011">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7430018">writeState</span><span class="op" id="7430028">[</span><span class="num" id="7430029">0</span><span class="op" id="7430030">]</span><span class="op" id="7430031">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7430039">writeState</span><span class="op" id="7430049">[</span><span class="num" id="7430050">1</span><span class="op" id="7430051">]</span><span class="op" id="7430052">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7430060">if</span>&nbsp;<span class="ident" id="7430063">mu</span><span class="op" id="7430065">.</span><span class="ident" id="7430066">RWUnlock</span><span class="op" id="7430074">(</span><span class="ident" id="7430075">false</span><span class="op" id="7430080">)</span>&nbsp;<span class="op" id="7430082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7430090">t</span><span class="op" id="7430091">.</span><span class="ident" id="7430092">Error</span><span class="op" id="7430097">(</span><span class="string" id="7430098">&#34;broken&#34;</span><span class="op" id="7430106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7430114">return</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7430126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7430132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7430137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7430142">done</span>&nbsp;<span class="op" id="7430147">&lt;-</span>&nbsp;<span class="ident" id="7430150">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7430157">}</span><span class="op" id="7430158">(</span><span class="op" id="7430159">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7430162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7430165">for</span>&nbsp;<span class="ident" id="7430169">p</span>&nbsp;<span class="op" id="7430171">:=</span>&nbsp;<span class="num" id="7430174">0</span><span class="op" id="7430175">;</span>&nbsp;<span class="ident" id="7430177">p</span>&nbsp;<span class="op" id="7430179">&lt;</span>&nbsp;<span class="ident" id="7430181">P</span><span class="op" id="7430182">;</span>&nbsp;<span class="ident" id="7430184">p</span><span class="op" id="7430185">++</span>&nbsp;<span class="op" id="7430188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7430192">&lt;-</span><span class="ident" id="7430194">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7430200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7430203">if</span>&nbsp;<span class="op" id="7430206">!</span><span class="ident" id="7430207">mu</span><span class="op" id="7430209">.</span><span class="ident" id="7430210">IncrefAndClose</span><span class="op" id="7430224">(</span><span class="op" id="7430225">)</span>&nbsp;<span class="op" id="7430227">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7430231">t</span><span class="op" id="7430232">.</span><span class="ident" id="7430233">Fatal</span><span class="op" id="7430238">(</span><span class="string" id="7430239">&#34;broken&#34;</span><span class="op" id="7430247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7430250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7430253">if</span>&nbsp;<span class="op" id="7430256">!</span><span class="ident" id="7430257">mu</span><span class="op" id="7430259">.</span><span class="ident" id="7430260">Decref</span><span class="op" id="7430266">(</span><span class="op" id="7430267">)</span>&nbsp;<span class="op" id="7430269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7430273">t</span><span class="op" id="7430274">.</span><span class="ident" id="7430275">Fatal</span><span class="op" id="7430280">(</span><span class="string" id="7430281">&#34;broken&#34;</span><span class="op" id="7430289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7430292">}</span><br>
<span class="lineno">195</span><span class="op" id="7430294">}</span>
</div>
</body>
</html>
