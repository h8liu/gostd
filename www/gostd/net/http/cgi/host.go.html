<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html" class="current">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5606474">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5606529">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5606583">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5606634">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;the&nbsp;host&nbsp;side&nbsp;of&nbsp;CGI&nbsp;(being&nbsp;the&nbsp;webserver</span><br>
<span class="lineno"></span><span class="comment" id="5606700">//&nbsp;parent&nbsp;process).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5606721">//&nbsp;Package&nbsp;cgi&nbsp;implements&nbsp;CGI&nbsp;(Common&nbsp;Gateway&nbsp;Interface)&nbsp;as&nbsp;specified</span><br>
<span class="lineno"></span><span class="comment" id="5606791">//&nbsp;in&nbsp;RFC&nbsp;3875.</span><br>
<span class="lineno">10</span><span class="comment" id="5606807">//</span><br>
<span class="lineno"></span><span class="comment" id="5606810">//&nbsp;Note&nbsp;that&nbsp;using&nbsp;CGI&nbsp;means&nbsp;starting&nbsp;a&nbsp;new&nbsp;process&nbsp;to&nbsp;handle&nbsp;each</span><br>
<span class="lineno"></span><span class="comment" id="5606877">//&nbsp;request,&nbsp;which&nbsp;is&nbsp;typically&nbsp;less&nbsp;efficient&nbsp;than&nbsp;using&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5606936">//&nbsp;long-running&nbsp;server.&nbsp;&nbsp;This&nbsp;package&nbsp;is&nbsp;intended&nbsp;primarily&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5607000">//&nbsp;compatibility&nbsp;with&nbsp;existing&nbsp;systems.</span><br>
<span class="lineno">15</span><span class="keyword" id="5607040">package</span>&nbsp;<span class="ident" id="5607048">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5607053">import</span>&nbsp;<span class="op" id="5607060">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607063">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607072">&#34;fmt&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607079">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607085">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607092">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607104">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607110">&#34;os/exec&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607121">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607138">&#34;regexp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607148">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607159">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607170">&#34;strings&#34;</span><br>
<span class="lineno">30</span><span class="op" id="5607180">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5607183">var</span>&nbsp;<span class="ident" id="5607187">trailingPort</span>&nbsp;<span class="op" id="5607200">=</span>&nbsp;<span class="ident" id="5607202">regexp</span><span class="op" id="5607208">.</span><span class="ident" id="5607209">MustCompile</span><span class="op" id="5607220">(</span><span class="string" id="5607221">`:([0-9]+)$`</span><span class="op" id="5607233">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5607236">var</span>&nbsp;<span class="ident" id="5607240">osDefaultInheritEnv</span>&nbsp;<span class="op" id="5607260">=</span>&nbsp;<span class="keyword" id="5607262">map</span><span class="op" id="5607265">[</span><span class="builtintype" id="5607266">string</span><span class="op" id="5607272">]</span><span class="op" id="5607273">[</span><span class="op" id="5607274">]</span><span class="builtintype" id="5607275">string</span><span class="op" id="5607281">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607284">&#34;darwin&#34;</span><span class="op" id="5607292">:</span>&nbsp;&nbsp;<span class="op" id="5607295">{</span><span class="string" id="5607296">&#34;DYLD_LIBRARY_PATH&#34;</span><span class="op" id="5607315">}</span><span class="op" id="5607316">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607319">&#34;freebsd&#34;</span><span class="op" id="5607328">:</span>&nbsp;<span class="op" id="5607330">{</span><span class="string" id="5607331">&#34;LD_LIBRARY_PATH&#34;</span><span class="op" id="5607348">}</span><span class="op" id="5607349">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607352">&#34;hpux&#34;</span><span class="op" id="5607358">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5607363">{</span><span class="string" id="5607364">&#34;LD_LIBRARY_PATH&#34;</span><span class="op" id="5607381">,</span>&nbsp;<span class="string" id="5607383">&#34;SHLIB_PATH&#34;</span><span class="op" id="5607395">}</span><span class="op" id="5607396">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607399">&#34;irix&#34;</span><span class="op" id="5607405">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5607410">{</span><span class="string" id="5607411">&#34;LD_LIBRARY_PATH&#34;</span><span class="op" id="5607428">,</span>&nbsp;<span class="string" id="5607430">&#34;LD_LIBRARYN32_PATH&#34;</span><span class="op" id="5607450">,</span>&nbsp;<span class="string" id="5607452">&#34;LD_LIBRARY64_PATH&#34;</span><span class="op" id="5607471">}</span><span class="op" id="5607472">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607475">&#34;linux&#34;</span><span class="op" id="5607482">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5607486">{</span><span class="string" id="5607487">&#34;LD_LIBRARY_PATH&#34;</span><span class="op" id="5607504">}</span><span class="op" id="5607505">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607508">&#34;openbsd&#34;</span><span class="op" id="5607517">:</span>&nbsp;<span class="op" id="5607519">{</span><span class="string" id="5607520">&#34;LD_LIBRARY_PATH&#34;</span><span class="op" id="5607537">}</span><span class="op" id="5607538">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607541">&#34;solaris&#34;</span><span class="op" id="5607550">:</span>&nbsp;<span class="op" id="5607552">{</span><span class="string" id="5607553">&#34;LD_LIBRARY_PATH&#34;</span><span class="op" id="5607570">,</span>&nbsp;<span class="string" id="5607572">&#34;LD_LIBRARY_PATH_32&#34;</span><span class="op" id="5607592">,</span>&nbsp;<span class="string" id="5607594">&#34;LD_LIBRARY_PATH_64&#34;</span><span class="op" id="5607614">}</span><span class="op" id="5607615">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5607618">&#34;windows&#34;</span><span class="op" id="5607627">:</span>&nbsp;<span class="op" id="5607629">{</span><span class="string" id="5607630">&#34;SystemRoot&#34;</span><span class="op" id="5607642">,</span>&nbsp;<span class="string" id="5607644">&#34;COMSPEC&#34;</span><span class="op" id="5607653">,</span>&nbsp;<span class="string" id="5607655">&#34;PATHEXT&#34;</span><span class="op" id="5607664">,</span>&nbsp;<span class="string" id="5607666">&#34;WINDIR&#34;</span><span class="op" id="5607674">}</span><span class="op" id="5607675">,</span><br>
<span class="lineno"></span><span class="op" id="5607677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5607680">//&nbsp;Handler&nbsp;runs&nbsp;an&nbsp;executable&nbsp;in&nbsp;a&nbsp;subprocess&nbsp;with&nbsp;a&nbsp;CGI&nbsp;environment.</span><br>
<span class="lineno"></span><span class="keyword" id="5607750">type</span>&nbsp;<span class="ident" id="5607755">Handler</span>&nbsp;<span class="keyword" id="5607763">struct</span>&nbsp;<span class="op" id="5607770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5607773">Path</span>&nbsp;<span class="builtintype" id="5607778">string</span>&nbsp;<span class="comment" id="5607785">//&nbsp;path&nbsp;to&nbsp;the&nbsp;CGI&nbsp;executable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5607816">Root</span>&nbsp;<span class="builtintype" id="5607821">string</span>&nbsp;<span class="comment" id="5607828">//&nbsp;root&nbsp;URI&nbsp;prefix&nbsp;of&nbsp;handler&nbsp;or&nbsp;empty&nbsp;for&nbsp;&#34;/&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5607877">//&nbsp;Dir&nbsp;specifies&nbsp;the&nbsp;CGI&nbsp;executable&#39;s&nbsp;working&nbsp;directory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5607935">//&nbsp;If&nbsp;Dir&nbsp;is&nbsp;empty,&nbsp;the&nbsp;base&nbsp;directory&nbsp;of&nbsp;Path&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5607992">//&nbsp;If&nbsp;Path&nbsp;has&nbsp;no&nbsp;base&nbsp;directory,&nbsp;the&nbsp;current&nbsp;working</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5608047">//&nbsp;directory&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5608070">Dir</span>&nbsp;<span class="builtintype" id="5608074">string</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5608083">Env</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5608094">[</span><span class="op" id="5608095">]</span><span class="builtintype" id="5608096">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5608106">//&nbsp;extra&nbsp;environment&nbsp;variables&nbsp;to&nbsp;set,&nbsp;if&nbsp;any,&nbsp;as&nbsp;&#34;key=value&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5608169">InheritEnv</span>&nbsp;<span class="op" id="5608180">[</span><span class="op" id="5608181">]</span><span class="builtintype" id="5608182">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5608192">//&nbsp;environment&nbsp;variables&nbsp;to&nbsp;inherit&nbsp;from&nbsp;host,&nbsp;as&nbsp;&#34;key&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5608249">Logger</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5608260">*</span><span class="ident" id="5608261">log</span><span class="op" id="5608264">.</span><span class="ident" id="5608265">Logger</span>&nbsp;<span class="comment" id="5608272">//&nbsp;optional&nbsp;log&nbsp;for&nbsp;errors&nbsp;or&nbsp;nil&nbsp;to&nbsp;use&nbsp;log.Print</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5608324">Args</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5608335">[</span><span class="op" id="5608336">]</span><span class="builtintype" id="5608337">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5608347">//&nbsp;optional&nbsp;arguments&nbsp;to&nbsp;pass&nbsp;to&nbsp;child&nbsp;process</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5608396">//&nbsp;PathLocationHandler&nbsp;specifies&nbsp;the&nbsp;root&nbsp;http&nbsp;Handler&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5608457">//&nbsp;should&nbsp;handle&nbsp;internal&nbsp;redirects&nbsp;when&nbsp;the&nbsp;CGI&nbsp;process</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5608515">//&nbsp;returns&nbsp;a&nbsp;Location&nbsp;header&nbsp;value&nbsp;starting&nbsp;with&nbsp;a&nbsp;&#34;/&#34;,&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5608575">//&nbsp;specified&nbsp;in&nbsp;RFC&nbsp;3875&nbsp;ยง&nbsp;6.3.2.&nbsp;This&nbsp;will&nbsp;likely&nbsp;be</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5608631">//&nbsp;http.DefaultServeMux.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5608657">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5608661">//&nbsp;If&nbsp;nil,&nbsp;a&nbsp;CGI&nbsp;response&nbsp;with&nbsp;a&nbsp;local&nbsp;URI&nbsp;path&nbsp;is&nbsp;instead&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5608726">//&nbsp;back&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;not&nbsp;redirected&nbsp;internally.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5608780">PathLocationHandler</span>&nbsp;<span class="ident" id="5608800">http</span><span class="op" id="5608804">.</span><span class="ident" id="5608805">Handler</span><br>
<span class="lineno">70</span><span class="op" id="5608813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5608816">//&nbsp;removeLeadingDuplicates&nbsp;remove&nbsp;leading&nbsp;duplicate&nbsp;in&nbsp;environments.</span><br>
<span class="lineno"></span><span class="comment" id="5608885">//&nbsp;It&#39;s&nbsp;possible&nbsp;to&nbsp;override&nbsp;environment&nbsp;like&nbsp;following.</span><br>
<span class="lineno"></span><span class="comment" id="5608942">//&nbsp;&nbsp;&nbsp;&nbsp;cgi.Handler{</span><br>
<span class="lineno">75</span><span class="comment" id="5608961">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5608973">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Env:&nbsp;[]string{&#34;SCRIPT_FILENAME=foo.php&#34;},</span><br>
<span class="lineno"></span><span class="comment" id="5609023">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="keyword" id="5609031">func</span>&nbsp;<span class="ident" id="5609036">removeLeadingDuplicates</span><span class="op" id="5609059">(</span><span class="ident" id="5609060">env</span>&nbsp;<span class="op" id="5609064">[</span><span class="op" id="5609065">]</span><span class="builtintype" id="5609066">string</span><span class="op" id="5609072">)</span>&nbsp;<span class="op" id="5609074">(</span><span class="ident" id="5609075">ret</span>&nbsp;<span class="op" id="5609079">[</span><span class="op" id="5609080">]</span><span class="builtintype" id="5609081">string</span><span class="op" id="5609087">)</span>&nbsp;<span class="op" id="5609089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5609092">n</span>&nbsp;<span class="op" id="5609094">:=</span>&nbsp;<span class="builtinfunc" id="5609097">len</span><span class="op" id="5609100">(</span><span class="ident" id="5609101">env</span><span class="op" id="5609104">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5609107">for</span>&nbsp;<span class="ident" id="5609111">i</span>&nbsp;<span class="op" id="5609113">:=</span>&nbsp;<span class="num" id="5609116">0</span><span class="op" id="5609117">;</span>&nbsp;<span class="ident" id="5609119">i</span>&nbsp;<span class="op" id="5609121">&lt;</span>&nbsp;<span class="ident" id="5609123">n</span><span class="op" id="5609124">;</span>&nbsp;<span class="ident" id="5609126">i</span><span class="op" id="5609127">++</span>&nbsp;<span class="op" id="5609130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5609134">e</span>&nbsp;<span class="op" id="5609136">:=</span>&nbsp;<span class="ident" id="5609139">env</span><span class="op" id="5609142">[</span><span class="ident" id="5609143">i</span><span class="op" id="5609144">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5609148">s</span>&nbsp;<span class="op" id="5609150">:=</span>&nbsp;<span class="ident" id="5609153">strings</span><span class="op" id="5609160">.</span><span class="ident" id="5609161">SplitN</span><span class="op" id="5609167">(</span><span class="ident" id="5609168">e</span><span class="op" id="5609169">,</span>&nbsp;<span class="string" id="5609171">&#34;=&#34;</span><span class="op" id="5609174">,</span>&nbsp;<span class="num" id="5609176">2</span><span class="op" id="5609177">)</span><span class="op" id="5609178">[</span><span class="num" id="5609179">0</span><span class="op" id="5609180">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5609184">found</span>&nbsp;<span class="op" id="5609190">:=</span>&nbsp;<span class="builtintype" id="5609193">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5609201">for</span>&nbsp;<span class="ident" id="5609205">j</span>&nbsp;<span class="op" id="5609207">:=</span>&nbsp;<span class="ident" id="5609210">i</span>&nbsp;<span class="op" id="5609212">+</span>&nbsp;<span class="num" id="5609214">1</span><span class="op" id="5609215">;</span>&nbsp;<span class="ident" id="5609217">j</span>&nbsp;<span class="op" id="5609219">&lt;</span>&nbsp;<span class="ident" id="5609221">n</span><span class="op" id="5609222">;</span>&nbsp;<span class="ident" id="5609224">j</span><span class="op" id="5609225">++</span>&nbsp;<span class="op" id="5609228">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5609233">if</span>&nbsp;<span class="ident" id="5609236">s</span>&nbsp;<span class="op" id="5609238">==</span>&nbsp;<span class="ident" id="5609241">strings</span><span class="op" id="5609248">.</span><span class="ident" id="5609249">SplitN</span><span class="op" id="5609255">(</span><span class="ident" id="5609256">env</span><span class="op" id="5609259">[</span><span class="ident" id="5609260">j</span><span class="op" id="5609261">]</span><span class="op" id="5609262">,</span>&nbsp;<span class="string" id="5609264">&#34;=&#34;</span><span class="op" id="5609267">,</span>&nbsp;<span class="num" id="5609269">2</span><span class="op" id="5609270">)</span><span class="op" id="5609271">[</span><span class="num" id="5609272">0</span><span class="op" id="5609273">]</span>&nbsp;<span class="op" id="5609275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5609281">found</span>&nbsp;<span class="op" id="5609287">=</span>&nbsp;<span class="builtintype" id="5609289">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5609298">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5609307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5609311">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5609315">if</span>&nbsp;<span class="op" id="5609318">!</span><span class="ident" id="5609319">found</span>&nbsp;<span class="op" id="5609325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5609330">ret</span>&nbsp;<span class="op" id="5609334">=</span>&nbsp;<span class="builtinfunc" id="5609336">append</span><span class="op" id="5609342">(</span><span class="ident" id="5609343">ret</span><span class="op" id="5609346">,</span>&nbsp;<span class="ident" id="5609348">e</span><span class="op" id="5609349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5609353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5609356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5609359">return</span><br>
<span class="lineno">95</span><span class="op" id="5609366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5609369">func</span>&nbsp;<span class="op" id="5609374">(</span><span class="ident" id="5609375">h</span>&nbsp;<span class="op" id="5609377">*</span><span class="ident" id="5609378">Handler</span><span class="op" id="5609385">)</span>&nbsp;<span class="ident" id="5609387">ServeHTTP</span><span class="op" id="5609396">(</span><span class="ident" id="5609397">rw</span>&nbsp;<span class="ident" id="5609400">http</span><span class="op" id="5609404">.</span><span class="ident" id="5609405">ResponseWriter</span><span class="op" id="5609419">,</span>&nbsp;<span class="ident" id="5609421">req</span>&nbsp;<span class="op" id="5609425">*</span><span class="ident" id="5609426">http</span><span class="op" id="5609430">.</span><span class="ident" id="5609431">Request</span><span class="op" id="5609438">)</span>&nbsp;<span class="op" id="5609440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5609443">root</span>&nbsp;<span class="op" id="5609448">:=</span>&nbsp;<span class="ident" id="5609451">h</span><span class="op" id="5609452">.</span><span class="ident" id="5609453">Root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5609459">if</span>&nbsp;<span class="ident" id="5609462">root</span>&nbsp;<span class="op" id="5609467">==</span>&nbsp;<span class="string" id="5609470">&#34;&#34;</span>&nbsp;<span class="op" id="5609473">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5609477">root</span>&nbsp;<span class="op" id="5609482">=</span>&nbsp;<span class="string" id="5609484">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5609489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5609493">if</span>&nbsp;<span class="builtinfunc" id="5609496">len</span><span class="op" id="5609499">(</span><span class="ident" id="5609500">req</span><span class="op" id="5609503">.</span><span class="ident" id="5609504">TransferEncoding</span><span class="op" id="5609520">)</span>&nbsp;<span class="op" id="5609522">&gt;</span>&nbsp;<span class="num" id="5609524">0</span>&nbsp;<span class="op" id="5609526">&amp;&amp;</span>&nbsp;<span class="ident" id="5609529">req</span><span class="op" id="5609532">.</span><span class="ident" id="5609533">TransferEncoding</span><span class="op" id="5609549">[</span><span class="num" id="5609550">0</span><span class="op" id="5609551">]</span>&nbsp;<span class="op" id="5609553">==</span>&nbsp;<span class="string" id="5609556">&#34;chunked&#34;</span>&nbsp;<span class="op" id="5609566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5609570">rw</span><span class="op" id="5609572">.</span><span class="ident" id="5609573">WriteHeader</span><span class="op" id="5609584">(</span><span class="ident" id="5609585">http</span><span class="op" id="5609589">.</span><span class="ident" id="5609590">StatusBadRequest</span><span class="op" id="5609606">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5609610">rw</span><span class="op" id="5609612">.</span><span class="ident" id="5609613">Write</span><span class="op" id="5609618">(</span><span class="op" id="5609619">[</span><span class="op" id="5609620">]</span><span class="builtintype" id="5609621">byte</span><span class="op" id="5609625">(</span><span class="string" id="5609626">&#34;Chunked&nbsp;request&nbsp;bodies&nbsp;are&nbsp;not&nbsp;supported&nbsp;by&nbsp;CGI.&#34;</span><span class="op" id="5609676">)</span><span class="op" id="5609677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5609681">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5609689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5609693">pathInfo</span>&nbsp;<span class="op" id="5609702">:=</span>&nbsp;<span class="ident" id="5609705">req</span><span class="op" id="5609708">.</span><span class="ident" id="5609709">URL</span><span class="op" id="5609712">.</span><span class="ident" id="5609713">Path</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5609719">if</span>&nbsp;<span class="ident" id="5609722">root</span>&nbsp;<span class="op" id="5609727">!=</span>&nbsp;<span class="string" id="5609730">&#34;/&#34;</span>&nbsp;<span class="op" id="5609734">&amp;&amp;</span>&nbsp;<span class="ident" id="5609737">strings</span><span class="op" id="5609744">.</span><span class="ident" id="5609745">HasPrefix</span><span class="op" id="5609754">(</span><span class="ident" id="5609755">pathInfo</span><span class="op" id="5609763">,</span>&nbsp;<span class="ident" id="5609765">root</span><span class="op" id="5609769">)</span>&nbsp;<span class="op" id="5609771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5609775">pathInfo</span>&nbsp;<span class="op" id="5609784">=</span>&nbsp;<span class="ident" id="5609786">pathInfo</span><span class="op" id="5609794">[</span><span class="builtinfunc" id="5609795">len</span><span class="op" id="5609798">(</span><span class="ident" id="5609799">root</span><span class="op" id="5609803">)</span><span class="op" id="5609804">:</span><span class="op" id="5609805">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5609808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5609812">port</span>&nbsp;<span class="op" id="5609817">:=</span>&nbsp;<span class="string" id="5609820">&#34;80&#34;</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5609826">if</span>&nbsp;<span class="ident" id="5609829">matches</span>&nbsp;<span class="op" id="5609837">:=</span>&nbsp;<span class="ident" id="5609840">trailingPort</span><span class="op" id="5609852">.</span><span class="ident" id="5609853">FindStringSubmatch</span><span class="op" id="5609871">(</span><span class="ident" id="5609872">req</span><span class="op" id="5609875">.</span><span class="ident" id="5609876">Host</span><span class="op" id="5609880">)</span><span class="op" id="5609881">;</span>&nbsp;<span class="builtinfunc" id="5609883">len</span><span class="op" id="5609886">(</span><span class="ident" id="5609887">matches</span><span class="op" id="5609894">)</span>&nbsp;<span class="op" id="5609896">!=</span>&nbsp;<span class="num" id="5609899">0</span>&nbsp;<span class="op" id="5609901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5609905">port</span>&nbsp;<span class="op" id="5609910">=</span>&nbsp;<span class="ident" id="5609912">matches</span><span class="op" id="5609919">[</span><span class="num" id="5609920">1</span><span class="op" id="5609921">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5609924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5609928">env</span>&nbsp;<span class="op" id="5609932">:=</span>&nbsp;<span class="op" id="5609935">[</span><span class="op" id="5609936">]</span><span class="builtintype" id="5609937">string</span><span class="op" id="5609943">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5609947">&#34;SERVER_SOFTWARE=go&#34;</span><span class="op" id="5609967">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5609971">&#34;SERVER_NAME=&#34;</span>&nbsp;<span class="op" id="5609986">+</span>&nbsp;<span class="ident" id="5609988">req</span><span class="op" id="5609991">.</span><span class="ident" id="5609992">Host</span><span class="op" id="5609996">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5610000">&#34;SERVER_PROTOCOL=HTTP/1.1&#34;</span><span class="op" id="5610026">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5610030">&#34;HTTP_HOST=&#34;</span>&nbsp;<span class="op" id="5610043">+</span>&nbsp;<span class="ident" id="5610045">req</span><span class="op" id="5610048">.</span><span class="ident" id="5610049">Host</span><span class="op" id="5610053">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5610057">&#34;GATEWAY_INTERFACE=CGI/1.1&#34;</span><span class="op" id="5610084">,</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5610088">&#34;REQUEST_METHOD=&#34;</span>&nbsp;<span class="op" id="5610106">+</span>&nbsp;<span class="ident" id="5610108">req</span><span class="op" id="5610111">.</span><span class="ident" id="5610112">Method</span><span class="op" id="5610118">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5610122">&#34;QUERY_STRING=&#34;</span>&nbsp;<span class="op" id="5610138">+</span>&nbsp;<span class="ident" id="5610140">req</span><span class="op" id="5610143">.</span><span class="ident" id="5610144">URL</span><span class="op" id="5610147">.</span><span class="ident" id="5610148">RawQuery</span><span class="op" id="5610156">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5610160">&#34;REQUEST_URI=&#34;</span>&nbsp;<span class="op" id="5610175">+</span>&nbsp;<span class="ident" id="5610177">req</span><span class="op" id="5610180">.</span><span class="ident" id="5610181">URL</span><span class="op" id="5610184">.</span><span class="ident" id="5610185">RequestURI</span><span class="op" id="5610195">(</span><span class="op" id="5610196">)</span><span class="op" id="5610197">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5610201">&#34;PATH_INFO=&#34;</span>&nbsp;<span class="op" id="5610214">+</span>&nbsp;<span class="ident" id="5610216">pathInfo</span><span class="op" id="5610224">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5610228">&#34;SCRIPT_NAME=&#34;</span>&nbsp;<span class="op" id="5610243">+</span>&nbsp;<span class="ident" id="5610245">root</span><span class="op" id="5610249">,</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5610253">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="5610272">+</span>&nbsp;<span class="ident" id="5610274">h</span><span class="op" id="5610275">.</span><span class="ident" id="5610276">Path</span><span class="op" id="5610280">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5610284">&#34;REMOTE_ADDR=&#34;</span>&nbsp;<span class="op" id="5610299">+</span>&nbsp;<span class="ident" id="5610301">req</span><span class="op" id="5610304">.</span><span class="ident" id="5610305">RemoteAddr</span><span class="op" id="5610315">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5610319">&#34;REMOTE_HOST=&#34;</span>&nbsp;<span class="op" id="5610334">+</span>&nbsp;<span class="ident" id="5610336">req</span><span class="op" id="5610339">.</span><span class="ident" id="5610340">RemoteAddr</span><span class="op" id="5610350">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5610354">&#34;SERVER_PORT=&#34;</span>&nbsp;<span class="op" id="5610369">+</span>&nbsp;<span class="ident" id="5610371">port</span><span class="op" id="5610375">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5610378">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5610382">if</span>&nbsp;<span class="ident" id="5610385">req</span><span class="op" id="5610388">.</span><span class="ident" id="5610389">TLS</span>&nbsp;<span class="op" id="5610393">!=</span>&nbsp;<span class="builtintype" id="5610396">nil</span>&nbsp;<span class="op" id="5610400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5610404">env</span>&nbsp;<span class="op" id="5610408">=</span>&nbsp;<span class="builtinfunc" id="5610410">append</span><span class="op" id="5610416">(</span><span class="ident" id="5610417">env</span><span class="op" id="5610420">,</span>&nbsp;<span class="string" id="5610422">&#34;HTTPS=on&#34;</span><span class="op" id="5610432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5610435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5610439">for</span>&nbsp;<span class="ident" id="5610443">k</span><span class="op" id="5610444">,</span>&nbsp;<span class="ident" id="5610446">v</span>&nbsp;<span class="op" id="5610448">:=</span>&nbsp;<span class="keyword" id="5610451">range</span>&nbsp;<span class="ident" id="5610457">req</span><span class="op" id="5610460">.</span><span class="ident" id="5610461">Header</span>&nbsp;<span class="op" id="5610468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5610472">k</span>&nbsp;<span class="op" id="5610474">=</span>&nbsp;<span class="ident" id="5610476">strings</span><span class="op" id="5610483">.</span><span class="ident" id="5610484">Map</span><span class="op" id="5610487">(</span><span class="ident" id="5610488">upperCaseAndUnderscore</span><span class="op" id="5610510">,</span>&nbsp;<span class="ident" id="5610512">k</span><span class="op" id="5610513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5610517">joinStr</span>&nbsp;<span class="op" id="5610525">:=</span>&nbsp;<span class="string" id="5610528">&#34;,&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5610535">if</span>&nbsp;<span class="ident" id="5610538">k</span>&nbsp;<span class="op" id="5610540">==</span>&nbsp;<span class="string" id="5610543">&#34;COOKIE&#34;</span>&nbsp;<span class="op" id="5610552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5610557">joinStr</span>&nbsp;<span class="op" id="5610565">=</span>&nbsp;<span class="string" id="5610567">&#34;;&nbsp;&#34;</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5610574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5610578">env</span>&nbsp;<span class="op" id="5610582">=</span>&nbsp;<span class="builtinfunc" id="5610584">append</span><span class="op" id="5610590">(</span><span class="ident" id="5610591">env</span><span class="op" id="5610594">,</span>&nbsp;<span class="string" id="5610596">&#34;HTTP_&#34;</span><span class="op" id="5610603">+</span><span class="ident" id="5610604">k</span><span class="op" id="5610605">+</span><span class="string" id="5610606">&#34;=&#34;</span><span class="op" id="5610609">+</span><span class="ident" id="5610610">strings</span><span class="op" id="5610617">.</span><span class="ident" id="5610618">Join</span><span class="op" id="5610622">(</span><span class="ident" id="5610623">v</span><span class="op" id="5610624">,</span>&nbsp;<span class="ident" id="5610626">joinStr</span><span class="op" id="5610633">)</span><span class="op" id="5610634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5610637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5610641">if</span>&nbsp;<span class="ident" id="5610644">req</span><span class="op" id="5610647">.</span><span class="ident" id="5610648">ContentLength</span>&nbsp;<span class="op" id="5610662">&gt;</span>&nbsp;<span class="num" id="5610664">0</span>&nbsp;<span class="op" id="5610666">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5610670">env</span>&nbsp;<span class="op" id="5610674">=</span>&nbsp;<span class="builtinfunc" id="5610676">append</span><span class="op" id="5610682">(</span><span class="ident" id="5610683">env</span><span class="op" id="5610686">,</span>&nbsp;<span class="ident" id="5610688">fmt</span><span class="op" id="5610691">.</span><span class="ident" id="5610692">Sprintf</span><span class="op" id="5610699">(</span><span class="string" id="5610700">&#34;CONTENT_LENGTH=%d&#34;</span><span class="op" id="5610719">,</span>&nbsp;<span class="ident" id="5610721">req</span><span class="op" id="5610724">.</span><span class="ident" id="5610725">ContentLength</span><span class="op" id="5610738">)</span><span class="op" id="5610739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5610742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5610745">if</span>&nbsp;<span class="ident" id="5610748">ctype</span>&nbsp;<span class="op" id="5610754">:=</span>&nbsp;<span class="ident" id="5610757">req</span><span class="op" id="5610760">.</span><span class="ident" id="5610761">Header</span><span class="op" id="5610767">.</span><span class="ident" id="5610768">Get</span><span class="op" id="5610771">(</span><span class="string" id="5610772">&#34;Content-Type&#34;</span><span class="op" id="5610786">)</span><span class="op" id="5610787">;</span>&nbsp;<span class="ident" id="5610789">ctype</span>&nbsp;<span class="op" id="5610795">!=</span>&nbsp;<span class="string" id="5610798">&#34;&#34;</span>&nbsp;<span class="op" id="5610801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5610805">env</span>&nbsp;<span class="op" id="5610809">=</span>&nbsp;<span class="builtinfunc" id="5610811">append</span><span class="op" id="5610817">(</span><span class="ident" id="5610818">env</span><span class="op" id="5610821">,</span>&nbsp;<span class="string" id="5610823">&#34;CONTENT_TYPE=&#34;</span><span class="op" id="5610838">+</span><span class="ident" id="5610839">ctype</span><span class="op" id="5610844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5610847">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5610851">if</span>&nbsp;<span class="ident" id="5610854">h</span><span class="op" id="5610855">.</span><span class="ident" id="5610856">Env</span>&nbsp;<span class="op" id="5610860">!=</span>&nbsp;<span class="builtintype" id="5610863">nil</span>&nbsp;<span class="op" id="5610867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5610871">env</span>&nbsp;<span class="op" id="5610875">=</span>&nbsp;<span class="builtinfunc" id="5610877">append</span><span class="op" id="5610883">(</span><span class="ident" id="5610884">env</span><span class="op" id="5610887">,</span>&nbsp;<span class="ident" id="5610889">h</span><span class="op" id="5610890">.</span><span class="ident" id="5610891">Env</span><span class="op" id="5610894">...</span><span class="op" id="5610897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5610900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5610904">envPath</span>&nbsp;<span class="op" id="5610912">:=</span>&nbsp;<span class="ident" id="5610915">os</span><span class="op" id="5610917">.</span><span class="ident" id="5610918">Getenv</span><span class="op" id="5610924">(</span><span class="string" id="5610925">&#34;PATH&#34;</span><span class="op" id="5610931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5610934">if</span>&nbsp;<span class="ident" id="5610937">envPath</span>&nbsp;<span class="op" id="5610945">==</span>&nbsp;<span class="string" id="5610948">&#34;&#34;</span>&nbsp;<span class="op" id="5610951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5610955">envPath</span>&nbsp;<span class="op" id="5610963">=</span>&nbsp;<span class="string" id="5610965">&#34;/bin:/usr/bin:/usr/ucb:/usr/bsd:/usr/local/bin&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5611015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611018">env</span>&nbsp;<span class="op" id="5611022">=</span>&nbsp;<span class="builtinfunc" id="5611024">append</span><span class="op" id="5611030">(</span><span class="ident" id="5611031">env</span><span class="op" id="5611034">,</span>&nbsp;<span class="string" id="5611036">&#34;PATH=&#34;</span><span class="op" id="5611043">+</span><span class="ident" id="5611044">envPath</span><span class="op" id="5611051">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5611055">for</span>&nbsp;<span class="ident" id="5611059">_</span><span class="op" id="5611060">,</span>&nbsp;<span class="ident" id="5611062">e</span>&nbsp;<span class="op" id="5611064">:=</span>&nbsp;<span class="keyword" id="5611067">range</span>&nbsp;<span class="ident" id="5611073">h</span><span class="op" id="5611074">.</span><span class="ident" id="5611075">InheritEnv</span>&nbsp;<span class="op" id="5611086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5611090">if</span>&nbsp;<span class="ident" id="5611093">v</span>&nbsp;<span class="op" id="5611095">:=</span>&nbsp;<span class="ident" id="5611098">os</span><span class="op" id="5611100">.</span><span class="ident" id="5611101">Getenv</span><span class="op" id="5611107">(</span><span class="ident" id="5611108">e</span><span class="op" id="5611109">)</span><span class="op" id="5611110">;</span>&nbsp;<span class="ident" id="5611112">v</span>&nbsp;<span class="op" id="5611114">!=</span>&nbsp;<span class="string" id="5611117">&#34;&#34;</span>&nbsp;<span class="op" id="5611120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611125">env</span>&nbsp;<span class="op" id="5611129">=</span>&nbsp;<span class="builtinfunc" id="5611131">append</span><span class="op" id="5611137">(</span><span class="ident" id="5611138">env</span><span class="op" id="5611141">,</span>&nbsp;<span class="ident" id="5611143">e</span><span class="op" id="5611144">+</span><span class="string" id="5611145">&#34;=&#34;</span><span class="op" id="5611148">+</span><span class="ident" id="5611149">v</span><span class="op" id="5611150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5611154">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5611157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5611161">for</span>&nbsp;<span class="ident" id="5611165">_</span><span class="op" id="5611166">,</span>&nbsp;<span class="ident" id="5611168">e</span>&nbsp;<span class="op" id="5611170">:=</span>&nbsp;<span class="keyword" id="5611173">range</span>&nbsp;<span class="ident" id="5611179">osDefaultInheritEnv</span><span class="op" id="5611198">[</span><span class="ident" id="5611199">runtime</span><span class="op" id="5611206">.</span><span class="ident" id="5611207">GOOS</span><span class="op" id="5611211">]</span>&nbsp;<span class="op" id="5611213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5611217">if</span>&nbsp;<span class="ident" id="5611220">v</span>&nbsp;<span class="op" id="5611222">:=</span>&nbsp;<span class="ident" id="5611225">os</span><span class="op" id="5611227">.</span><span class="ident" id="5611228">Getenv</span><span class="op" id="5611234">(</span><span class="ident" id="5611235">e</span><span class="op" id="5611236">)</span><span class="op" id="5611237">;</span>&nbsp;<span class="ident" id="5611239">v</span>&nbsp;<span class="op" id="5611241">!=</span>&nbsp;<span class="string" id="5611244">&#34;&#34;</span>&nbsp;<span class="op" id="5611247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611252">env</span>&nbsp;<span class="op" id="5611256">=</span>&nbsp;<span class="builtinfunc" id="5611258">append</span><span class="op" id="5611264">(</span><span class="ident" id="5611265">env</span><span class="op" id="5611268">,</span>&nbsp;<span class="ident" id="5611270">e</span><span class="op" id="5611271">+</span><span class="string" id="5611272">&#34;=&#34;</span><span class="op" id="5611275">+</span><span class="ident" id="5611276">v</span><span class="op" id="5611277">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5611281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5611284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611288">env</span>&nbsp;<span class="op" id="5611292">=</span>&nbsp;<span class="ident" id="5611294">removeLeadingDuplicates</span><span class="op" id="5611317">(</span><span class="ident" id="5611318">env</span><span class="op" id="5611321">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5611325">var</span>&nbsp;<span class="ident" id="5611329">cwd</span><span class="op" id="5611332">,</span>&nbsp;<span class="ident" id="5611334">path</span>&nbsp;<span class="builtintype" id="5611339">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5611347">if</span>&nbsp;<span class="ident" id="5611350">h</span><span class="op" id="5611351">.</span><span class="ident" id="5611352">Dir</span>&nbsp;<span class="op" id="5611356">!=</span>&nbsp;<span class="string" id="5611359">&#34;&#34;</span>&nbsp;<span class="op" id="5611362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611366">path</span>&nbsp;<span class="op" id="5611371">=</span>&nbsp;<span class="ident" id="5611373">h</span><span class="op" id="5611374">.</span><span class="ident" id="5611375">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611382">cwd</span>&nbsp;<span class="op" id="5611386">=</span>&nbsp;<span class="ident" id="5611388">h</span><span class="op" id="5611389">.</span><span class="ident" id="5611390">Dir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5611395">}</span>&nbsp;<span class="keyword" id="5611397">else</span>&nbsp;<span class="op" id="5611402">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611406">cwd</span><span class="op" id="5611409">,</span>&nbsp;<span class="ident" id="5611411">path</span>&nbsp;<span class="op" id="5611416">=</span>&nbsp;<span class="ident" id="5611418">filepath</span><span class="op" id="5611426">.</span><span class="ident" id="5611427">Split</span><span class="op" id="5611432">(</span><span class="ident" id="5611433">h</span><span class="op" id="5611434">.</span><span class="ident" id="5611435">Path</span><span class="op" id="5611439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5611442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5611445">if</span>&nbsp;<span class="ident" id="5611448">cwd</span>&nbsp;<span class="op" id="5611452">==</span>&nbsp;<span class="string" id="5611455">&#34;&#34;</span>&nbsp;<span class="op" id="5611458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611462">cwd</span>&nbsp;<span class="op" id="5611466">=</span>&nbsp;<span class="string" id="5611468">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5611473">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611477">internalError</span>&nbsp;<span class="op" id="5611491">:=</span>&nbsp;<span class="keyword" id="5611494">func</span><span class="op" id="5611498">(</span><span class="ident" id="5611499">err</span>&nbsp;<span class="builtintype" id="5611503">error</span><span class="op" id="5611508">)</span>&nbsp;<span class="op" id="5611510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611514">rw</span><span class="op" id="5611516">.</span><span class="ident" id="5611517">WriteHeader</span><span class="op" id="5611528">(</span><span class="ident" id="5611529">http</span><span class="op" id="5611533">.</span><span class="ident" id="5611534">StatusInternalServerError</span><span class="op" id="5611559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611563">h</span><span class="op" id="5611564">.</span><span class="ident" id="5611565">printf</span><span class="op" id="5611571">(</span><span class="string" id="5611572">&#34;CGI&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="5611587">,</span>&nbsp;<span class="ident" id="5611589">err</span><span class="op" id="5611592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5611595">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611599">cmd</span>&nbsp;<span class="op" id="5611603">:=</span>&nbsp;<span class="op" id="5611606">&amp;</span><span class="ident" id="5611607">exec</span><span class="op" id="5611611">.</span><span class="ident" id="5611612">Cmd</span><span class="op" id="5611615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611619">Path</span><span class="op" id="5611623">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5611627">path</span><span class="op" id="5611631">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611635">Args</span><span class="op" id="5611639">:</span>&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5611643">append</span><span class="op" id="5611649">(</span><span class="op" id="5611650">[</span><span class="op" id="5611651">]</span><span class="builtintype" id="5611652">string</span><span class="op" id="5611658">{</span><span class="ident" id="5611659">h</span><span class="op" id="5611660">.</span><span class="ident" id="5611661">Path</span><span class="op" id="5611665">}</span><span class="op" id="5611666">,</span>&nbsp;<span class="ident" id="5611668">h</span><span class="op" id="5611669">.</span><span class="ident" id="5611670">Args</span><span class="op" id="5611674">...</span><span class="op" id="5611677">)</span><span class="op" id="5611678">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611682">Dir</span><span class="op" id="5611685">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611690">cwd</span><span class="op" id="5611693">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611697">Env</span><span class="op" id="5611700">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611705">env</span><span class="op" id="5611708">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611712">Stderr</span><span class="op" id="5611718">:</span>&nbsp;<span class="ident" id="5611720">os</span><span class="op" id="5611722">.</span><span class="ident" id="5611723">Stderr</span><span class="op" id="5611729">,</span>&nbsp;<span class="comment" id="5611731">//&nbsp;for&nbsp;now</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5611743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5611746">if</span>&nbsp;<span class="ident" id="5611749">req</span><span class="op" id="5611752">.</span><span class="ident" id="5611753">ContentLength</span>&nbsp;<span class="op" id="5611767">!=</span>&nbsp;<span class="num" id="5611770">0</span>&nbsp;<span class="op" id="5611772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611776">cmd</span><span class="op" id="5611779">.</span><span class="ident" id="5611780">Stdin</span>&nbsp;<span class="op" id="5611786">=</span>&nbsp;<span class="ident" id="5611788">req</span><span class="op" id="5611791">.</span><span class="ident" id="5611792">Body</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5611798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611801">stdoutRead</span><span class="op" id="5611811">,</span>&nbsp;<span class="ident" id="5611813">err</span>&nbsp;<span class="op" id="5611817">:=</span>&nbsp;<span class="ident" id="5611820">cmd</span><span class="op" id="5611823">.</span><span class="ident" id="5611824">StdoutPipe</span><span class="op" id="5611834">(</span><span class="op" id="5611835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5611838">if</span>&nbsp;<span class="ident" id="5611841">err</span>&nbsp;<span class="op" id="5611845">!=</span>&nbsp;<span class="builtintype" id="5611848">nil</span>&nbsp;<span class="op" id="5611852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611856">internalError</span><span class="op" id="5611869">(</span><span class="ident" id="5611870">err</span><span class="op" id="5611873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5611877">return</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5611885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611889">err</span>&nbsp;<span class="op" id="5611893">=</span>&nbsp;<span class="ident" id="5611895">cmd</span><span class="op" id="5611898">.</span><span class="ident" id="5611899">Start</span><span class="op" id="5611904">(</span><span class="op" id="5611905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5611908">if</span>&nbsp;<span class="ident" id="5611911">err</span>&nbsp;<span class="op" id="5611915">!=</span>&nbsp;<span class="builtintype" id="5611918">nil</span>&nbsp;<span class="op" id="5611922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5611926">internalError</span><span class="op" id="5611939">(</span><span class="ident" id="5611940">err</span><span class="op" id="5611943">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5611947">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5611955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5611958">if</span>&nbsp;<span class="ident" id="5611961">hook</span>&nbsp;<span class="op" id="5611966">:=</span>&nbsp;<span class="ident" id="5611969">testHookStartProcess</span><span class="op" id="5611989">;</span>&nbsp;<span class="ident" id="5611991">hook</span>&nbsp;<span class="op" id="5611996">!=</span>&nbsp;<span class="builtintype" id="5611999">nil</span>&nbsp;<span class="op" id="5612003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612007">hook</span><span class="op" id="5612011">(</span><span class="ident" id="5612012">cmd</span><span class="op" id="5612015">.</span><span class="ident" id="5612016">Process</span><span class="op" id="5612023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5612026">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612029">defer</span>&nbsp;<span class="ident" id="5612035">cmd</span><span class="op" id="5612038">.</span><span class="ident" id="5612039">Wait</span><span class="op" id="5612043">(</span><span class="op" id="5612044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612047">defer</span>&nbsp;<span class="ident" id="5612053">stdoutRead</span><span class="op" id="5612063">.</span><span class="ident" id="5612064">Close</span><span class="op" id="5612069">(</span><span class="op" id="5612070">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612074">linebody</span>&nbsp;<span class="op" id="5612083">:=</span>&nbsp;<span class="ident" id="5612086">bufio</span><span class="op" id="5612091">.</span><span class="ident" id="5612092">NewReaderSize</span><span class="op" id="5612105">(</span><span class="ident" id="5612106">stdoutRead</span><span class="op" id="5612116">,</span>&nbsp;<span class="num" id="5612118">1024</span><span class="op" id="5612122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612125">headers</span>&nbsp;<span class="op" id="5612133">:=</span>&nbsp;<span class="builtinfunc" id="5612136">make</span><span class="op" id="5612140">(</span><span class="ident" id="5612141">http</span><span class="op" id="5612145">.</span><span class="ident" id="5612146">Header</span><span class="op" id="5612152">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612155">statusCode</span>&nbsp;<span class="op" id="5612166">:=</span>&nbsp;<span class="num" id="5612169">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612172">headerLines</span>&nbsp;<span class="op" id="5612184">:=</span>&nbsp;<span class="num" id="5612187">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612190">sawBlankLine</span>&nbsp;<span class="op" id="5612203">:=</span>&nbsp;<span class="builtintype" id="5612206">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612213">for</span>&nbsp;<span class="op" id="5612217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612221">line</span><span class="op" id="5612225">,</span>&nbsp;<span class="ident" id="5612227">isPrefix</span><span class="op" id="5612235">,</span>&nbsp;<span class="ident" id="5612237">err</span>&nbsp;<span class="op" id="5612241">:=</span>&nbsp;<span class="ident" id="5612244">linebody</span><span class="op" id="5612252">.</span><span class="ident" id="5612253">ReadLine</span><span class="op" id="5612261">(</span><span class="op" id="5612262">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612266">if</span>&nbsp;<span class="ident" id="5612269">isPrefix</span>&nbsp;<span class="op" id="5612278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612283">rw</span><span class="op" id="5612285">.</span><span class="ident" id="5612286">WriteHeader</span><span class="op" id="5612297">(</span><span class="ident" id="5612298">http</span><span class="op" id="5612302">.</span><span class="ident" id="5612303">StatusInternalServerError</span><span class="op" id="5612328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612333">h</span><span class="op" id="5612334">.</span><span class="ident" id="5612335">printf</span><span class="op" id="5612341">(</span><span class="string" id="5612342">&#34;cgi:&nbsp;long&nbsp;header&nbsp;line&nbsp;from&nbsp;subprocess.&#34;</span><span class="op" id="5612382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612387">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5612396">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612400">if</span>&nbsp;<span class="ident" id="5612403">err</span>&nbsp;<span class="op" id="5612407">==</span>&nbsp;<span class="ident" id="5612410">io</span><span class="op" id="5612412">.</span><span class="ident" id="5612413">EOF</span>&nbsp;<span class="op" id="5612417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612422">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5612430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612434">if</span>&nbsp;<span class="ident" id="5612437">err</span>&nbsp;<span class="op" id="5612441">!=</span>&nbsp;<span class="builtintype" id="5612444">nil</span>&nbsp;<span class="op" id="5612448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612453">rw</span><span class="op" id="5612455">.</span><span class="ident" id="5612456">WriteHeader</span><span class="op" id="5612467">(</span><span class="ident" id="5612468">http</span><span class="op" id="5612472">.</span><span class="ident" id="5612473">StatusInternalServerError</span><span class="op" id="5612498">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612503">h</span><span class="op" id="5612504">.</span><span class="ident" id="5612505">printf</span><span class="op" id="5612511">(</span><span class="string" id="5612512">&#34;cgi:&nbsp;error&nbsp;reading&nbsp;headers:&nbsp;%v&#34;</span><span class="op" id="5612544">,</span>&nbsp;<span class="ident" id="5612546">err</span><span class="op" id="5612549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612554">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5612563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612567">if</span>&nbsp;<span class="builtinfunc" id="5612570">len</span><span class="op" id="5612573">(</span><span class="ident" id="5612574">line</span><span class="op" id="5612578">)</span>&nbsp;<span class="op" id="5612580">==</span>&nbsp;<span class="num" id="5612583">0</span>&nbsp;<span class="op" id="5612585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612590">sawBlankLine</span>&nbsp;<span class="op" id="5612603">=</span>&nbsp;<span class="builtintype" id="5612605">true</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612613">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5612621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612625">headerLines</span><span class="op" id="5612636">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612641">parts</span>&nbsp;<span class="op" id="5612647">:=</span>&nbsp;<span class="ident" id="5612650">strings</span><span class="op" id="5612657">.</span><span class="ident" id="5612658">SplitN</span><span class="op" id="5612664">(</span><span class="builtintype" id="5612665">string</span><span class="op" id="5612671">(</span><span class="ident" id="5612672">line</span><span class="op" id="5612676">)</span><span class="op" id="5612677">,</span>&nbsp;<span class="string" id="5612679">&#34;:&#34;</span><span class="op" id="5612682">,</span>&nbsp;<span class="num" id="5612684">2</span><span class="op" id="5612685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612689">if</span>&nbsp;<span class="builtinfunc" id="5612692">len</span><span class="op" id="5612695">(</span><span class="ident" id="5612696">parts</span><span class="op" id="5612701">)</span>&nbsp;<span class="op" id="5612703">&lt;</span>&nbsp;<span class="num" id="5612705">2</span>&nbsp;<span class="op" id="5612707">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612712">h</span><span class="op" id="5612713">.</span><span class="ident" id="5612714">printf</span><span class="op" id="5612720">(</span><span class="string" id="5612721">&#34;cgi:&nbsp;bogus&nbsp;header&nbsp;line:&nbsp;%s&#34;</span><span class="op" id="5612749">,</span>&nbsp;<span class="builtintype" id="5612751">string</span><span class="op" id="5612757">(</span><span class="ident" id="5612758">line</span><span class="op" id="5612762">)</span><span class="op" id="5612763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612768">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5612779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612783">header</span><span class="op" id="5612789">,</span>&nbsp;<span class="ident" id="5612791">val</span>&nbsp;<span class="op" id="5612795">:=</span>&nbsp;<span class="ident" id="5612798">parts</span><span class="op" id="5612803">[</span><span class="num" id="5612804">0</span><span class="op" id="5612805">]</span><span class="op" id="5612806">,</span>&nbsp;<span class="ident" id="5612808">parts</span><span class="op" id="5612813">[</span><span class="num" id="5612814">1</span><span class="op" id="5612815">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612819">header</span>&nbsp;<span class="op" id="5612826">=</span>&nbsp;<span class="ident" id="5612828">strings</span><span class="op" id="5612835">.</span><span class="ident" id="5612836">TrimSpace</span><span class="op" id="5612845">(</span><span class="ident" id="5612846">header</span><span class="op" id="5612852">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612856">val</span>&nbsp;<span class="op" id="5612860">=</span>&nbsp;<span class="ident" id="5612862">strings</span><span class="op" id="5612869">.</span><span class="ident" id="5612870">TrimSpace</span><span class="op" id="5612879">(</span><span class="ident" id="5612880">val</span><span class="op" id="5612883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612887">switch</span>&nbsp;<span class="op" id="5612894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612898">case</span>&nbsp;<span class="ident" id="5612903">header</span>&nbsp;<span class="op" id="5612910">==</span>&nbsp;<span class="string" id="5612913">&#34;Status&#34;</span><span class="op" id="5612921">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612926">if</span>&nbsp;<span class="builtinfunc" id="5612929">len</span><span class="op" id="5612932">(</span><span class="ident" id="5612933">val</span><span class="op" id="5612936">)</span>&nbsp;<span class="op" id="5612938">&lt;</span>&nbsp;<span class="num" id="5612940">3</span>&nbsp;<span class="op" id="5612942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612948">h</span><span class="op" id="5612949">.</span><span class="ident" id="5612950">printf</span><span class="op" id="5612956">(</span><span class="string" id="5612957">&#34;cgi:&nbsp;bogus&nbsp;status&nbsp;(short):&nbsp;%q&#34;</span><span class="op" id="5612988">,</span>&nbsp;<span class="ident" id="5612990">val</span><span class="op" id="5612993">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5612999">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5613009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5613014">code</span><span class="op" id="5613018">,</span>&nbsp;<span class="ident" id="5613020">err</span>&nbsp;<span class="op" id="5613024">:=</span>&nbsp;<span class="ident" id="5613027">strconv</span><span class="op" id="5613034">.</span><span class="ident" id="5613035">Atoi</span><span class="op" id="5613039">(</span><span class="ident" id="5613040">val</span><span class="op" id="5613043">[</span><span class="num" id="5613044">0</span><span class="op" id="5613045">:</span><span class="num" id="5613046">3</span><span class="op" id="5613047">]</span><span class="op" id="5613048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5613053">if</span>&nbsp;<span class="ident" id="5613056">err</span>&nbsp;<span class="op" id="5613060">!=</span>&nbsp;<span class="builtintype" id="5613063">nil</span>&nbsp;<span class="op" id="5613067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5613073">h</span><span class="op" id="5613074">.</span><span class="ident" id="5613075">printf</span><span class="op" id="5613081">(</span><span class="string" id="5613082">&#34;cgi:&nbsp;bogus&nbsp;status:&nbsp;%q&#34;</span><span class="op" id="5613105">,</span>&nbsp;<span class="ident" id="5613107">val</span><span class="op" id="5613110">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5613116">h</span><span class="op" id="5613117">.</span><span class="ident" id="5613118">printf</span><span class="op" id="5613124">(</span><span class="string" id="5613125">&#34;cgi:&nbsp;line&nbsp;was&nbsp;%q&#34;</span><span class="op" id="5613143">,</span>&nbsp;<span class="ident" id="5613145">line</span><span class="op" id="5613149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5613155">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5613165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5613170">statusCode</span>&nbsp;<span class="op" id="5613181">=</span>&nbsp;<span class="ident" id="5613183">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5613190">default</span><span class="op" id="5613197">:</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5613202">headers</span><span class="op" id="5613209">.</span><span class="ident" id="5613210">Add</span><span class="op" id="5613213">(</span><span class="ident" id="5613214">header</span><span class="op" id="5613220">,</span>&nbsp;<span class="ident" id="5613222">val</span><span class="op" id="5613225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5613229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5613232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5613235">if</span>&nbsp;<span class="ident" id="5613238">headerLines</span>&nbsp;<span class="op" id="5613250">==</span>&nbsp;<span class="num" id="5613253">0</span>&nbsp;<span class="op" id="5613255">||</span>&nbsp;<span class="op" id="5613258">!</span><span class="ident" id="5613259">sawBlankLine</span>&nbsp;<span class="op" id="5613272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5613276">rw</span><span class="op" id="5613278">.</span><span class="ident" id="5613279">WriteHeader</span><span class="op" id="5613290">(</span><span class="ident" id="5613291">http</span><span class="op" id="5613295">.</span><span class="ident" id="5613296">StatusInternalServerError</span><span class="op" id="5613321">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5613325">h</span><span class="op" id="5613326">.</span><span class="ident" id="5613327">printf</span><span class="op" id="5613333">(</span><span class="string" id="5613334">&#34;cgi:&nbsp;no&nbsp;headers&#34;</span><span class="op" id="5613351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5613355">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5613363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5613367">if</span>&nbsp;<span class="ident" id="5613370">loc</span>&nbsp;<span class="op" id="5613374">:=</span>&nbsp;<span class="ident" id="5613377">headers</span><span class="op" id="5613384">.</span><span class="ident" id="5613385">Get</span><span class="op" id="5613388">(</span><span class="string" id="5613389">&#34;Location&#34;</span><span class="op" id="5613399">)</span><span class="op" id="5613400">;</span>&nbsp;<span class="ident" id="5613402">loc</span>&nbsp;<span class="op" id="5613406">!=</span>&nbsp;<span class="string" id="5613409">&#34;&#34;</span>&nbsp;<span class="op" id="5613412">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5613416">if</span>&nbsp;<span class="ident" id="5613419">strings</span><span class="op" id="5613426">.</span><span class="ident" id="5613427">HasPrefix</span><span class="op" id="5613436">(</span><span class="ident" id="5613437">loc</span><span class="op" id="5613440">,</span>&nbsp;<span class="string" id="5613442">&#34;/&#34;</span><span class="op" id="5613445">)</span>&nbsp;<span class="op" id="5613447">&amp;&amp;</span>&nbsp;<span class="ident" id="5613450">h</span><span class="op" id="5613451">.</span><span class="ident" id="5613452">PathLocationHandler</span>&nbsp;<span class="op" id="5613472">!=</span>&nbsp;<span class="builtintype" id="5613475">nil</span>&nbsp;<span class="op" id="5613479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5613484">h</span><span class="op" id="5613485">.</span><span class="ident" id="5613486">handleInternalRedirect</span><span class="op" id="5613508">(</span><span class="ident" id="5613509">rw</span><span class="op" id="5613511">,</span>&nbsp;<span class="ident" id="5613513">req</span><span class="op" id="5613516">,</span>&nbsp;<span class="ident" id="5613518">loc</span><span class="op" id="5613521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5613526">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5613535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5613539">if</span>&nbsp;<span class="ident" id="5613542">statusCode</span>&nbsp;<span class="op" id="5613553">==</span>&nbsp;<span class="num" id="5613556">0</span>&nbsp;<span class="op" id="5613558">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5613563">statusCode</span>&nbsp;<span class="op" id="5613574">=</span>&nbsp;<span class="ident" id="5613576">http</span><span class="op" id="5613580">.</span><span class="ident" id="5613581">StatusFound</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5613595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5613598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5613602">if</span>&nbsp;<span class="ident" id="5613605">statusCode</span>&nbsp;<span class="op" id="5613616">==</span>&nbsp;<span class="num" id="5613619">0</span>&nbsp;<span class="op" id="5613621">&amp;&amp;</span>&nbsp;<span class="ident" id="5613624">headers</span><span class="op" id="5613631">.</span><span class="ident" id="5613632">Get</span><span class="op" id="5613635">(</span><span class="string" id="5613636">&#34;Content-Type&#34;</span><span class="op" id="5613650">)</span>&nbsp;<span class="op" id="5613652">==</span>&nbsp;<span class="string" id="5613655">&#34;&#34;</span>&nbsp;<span class="op" id="5613658">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5613662">rw</span><span class="op" id="5613664">.</span><span class="ident" id="5613665">WriteHeader</span><span class="op" id="5613676">(</span><span class="ident" id="5613677">http</span><span class="op" id="5613681">.</span><span class="ident" id="5613682">StatusInternalServerError</span><span class="op" id="5613707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5613711">h</span><span class="op" id="5613712">.</span><span class="ident" id="5613713">printf</span><span class="op" id="5613719">(</span><span class="string" id="5613720">&#34;cgi:&nbsp;missing&nbsp;required&nbsp;Content-Type&nbsp;in&nbsp;headers&#34;</span><span class="op" id="5613767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5613771">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5613779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5613783">if</span>&nbsp;<span class="ident" id="5613786">statusCode</span>&nbsp;<span class="op" id="5613797">==</span>&nbsp;<span class="num" id="5613800">0</span>&nbsp;<span class="op" id="5613802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5613806">statusCode</span>&nbsp;<span class="op" id="5613817">=</span>&nbsp;<span class="ident" id="5613819">http</span><span class="op" id="5613823">.</span><span class="ident" id="5613824">StatusOK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5613834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5613838">//&nbsp;Copy&nbsp;headers&nbsp;to&nbsp;rw&#39;s&nbsp;headers,&nbsp;after&nbsp;we&#39;ve&nbsp;decided&nbsp;not&nbsp;to</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5613899">//&nbsp;go&nbsp;into&nbsp;handleInternalRedirect,&nbsp;which&nbsp;won&#39;t&nbsp;want&nbsp;its&nbsp;rw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5613959">//&nbsp;headers&nbsp;to&nbsp;have&nbsp;been&nbsp;touched.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5613993">for</span>&nbsp;<span class="ident" id="5613997">k</span><span class="op" id="5613998">,</span>&nbsp;<span class="ident" id="5614000">vv</span>&nbsp;<span class="op" id="5614003">:=</span>&nbsp;<span class="keyword" id="5614006">range</span>&nbsp;<span class="ident" id="5614012">headers</span>&nbsp;<span class="op" id="5614020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5614024">for</span>&nbsp;<span class="ident" id="5614028">_</span><span class="op" id="5614029">,</span>&nbsp;<span class="ident" id="5614031">v</span>&nbsp;<span class="op" id="5614033">:=</span>&nbsp;<span class="keyword" id="5614036">range</span>&nbsp;<span class="ident" id="5614042">vv</span>&nbsp;<span class="op" id="5614045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5614050">rw</span><span class="op" id="5614052">.</span><span class="ident" id="5614053">Header</span><span class="op" id="5614059">(</span><span class="op" id="5614060">)</span><span class="op" id="5614061">.</span><span class="ident" id="5614062">Add</span><span class="op" id="5614065">(</span><span class="ident" id="5614066">k</span><span class="op" id="5614067">,</span>&nbsp;<span class="ident" id="5614069">v</span><span class="op" id="5614070">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5614074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5614077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5614081">rw</span><span class="op" id="5614083">.</span><span class="ident" id="5614084">WriteHeader</span><span class="op" id="5614095">(</span><span class="ident" id="5614096">statusCode</span><span class="op" id="5614106">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5614110">_</span><span class="op" id="5614111">,</span>&nbsp;<span class="ident" id="5614113">err</span>&nbsp;<span class="op" id="5614117">=</span>&nbsp;<span class="ident" id="5614119">io</span><span class="op" id="5614121">.</span><span class="ident" id="5614122">Copy</span><span class="op" id="5614126">(</span><span class="ident" id="5614127">rw</span><span class="op" id="5614129">,</span>&nbsp;<span class="ident" id="5614131">linebody</span><span class="op" id="5614139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5614142">if</span>&nbsp;<span class="ident" id="5614145">err</span>&nbsp;<span class="op" id="5614149">!=</span>&nbsp;<span class="builtintype" id="5614152">nil</span>&nbsp;<span class="op" id="5614156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5614160">h</span><span class="op" id="5614161">.</span><span class="ident" id="5614162">printf</span><span class="op" id="5614168">(</span><span class="string" id="5614169">&#34;cgi:&nbsp;copy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="5614190">,</span>&nbsp;<span class="ident" id="5614192">err</span><span class="op" id="5614195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5614199">//&nbsp;And&nbsp;kill&nbsp;the&nbsp;child&nbsp;CGI&nbsp;process&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;hang&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5614255">//&nbsp;the&nbsp;deferred&nbsp;cmd.Wait&nbsp;above&nbsp;if&nbsp;the&nbsp;error&nbsp;was&nbsp;just</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5614310">//&nbsp;the&nbsp;client&nbsp;(rw)&nbsp;going&nbsp;away.&nbsp;If&nbsp;it&nbsp;was&nbsp;a&nbsp;read&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5614366">//&nbsp;(because&nbsp;the&nbsp;child&nbsp;died&nbsp;itself),&nbsp;then&nbsp;the&nbsp;extra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5614419">//&nbsp;kill&nbsp;of&nbsp;an&nbsp;already-dead&nbsp;process&nbsp;is&nbsp;harmless&nbsp;(the&nbsp;PID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5614477">//&nbsp;won&#39;t&nbsp;be&nbsp;reused&nbsp;until&nbsp;the&nbsp;Wait&nbsp;above).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5614521">cmd</span><span class="op" id="5614524">.</span><span class="ident" id="5614525">Process</span><span class="op" id="5614532">.</span><span class="ident" id="5614533">Kill</span><span class="op" id="5614537">(</span><span class="op" id="5614538">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5614541">}</span><br>
<span class="lineno"></span><span class="op" id="5614543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5614546">func</span>&nbsp;<span class="op" id="5614551">(</span><span class="ident" id="5614552">h</span>&nbsp;<span class="op" id="5614554">*</span><span class="ident" id="5614555">Handler</span><span class="op" id="5614562">)</span>&nbsp;<span class="ident" id="5614564">printf</span><span class="op" id="5614570">(</span><span class="ident" id="5614571">format</span>&nbsp;<span class="builtintype" id="5614578">string</span><span class="op" id="5614584">,</span>&nbsp;<span class="ident" id="5614586">v</span>&nbsp;<span class="op" id="5614588">...</span><span class="keyword" id="5614591">interface</span><span class="op" id="5614600">{</span><span class="op" id="5614601">}</span><span class="op" id="5614602">)</span>&nbsp;<span class="op" id="5614604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5614607">if</span>&nbsp;<span class="ident" id="5614610">h</span><span class="op" id="5614611">.</span><span class="ident" id="5614612">Logger</span>&nbsp;<span class="op" id="5614619">!=</span>&nbsp;<span class="builtintype" id="5614622">nil</span>&nbsp;<span class="op" id="5614626">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5614630">h</span><span class="op" id="5614631">.</span><span class="ident" id="5614632">Logger</span><span class="op" id="5614638">.</span><span class="ident" id="5614639">Printf</span><span class="op" id="5614645">(</span><span class="ident" id="5614646">format</span><span class="op" id="5614652">,</span>&nbsp;<span class="ident" id="5614654">v</span><span class="op" id="5614655">...</span><span class="op" id="5614658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5614661">}</span>&nbsp;<span class="keyword" id="5614663">else</span>&nbsp;<span class="op" id="5614668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5614672">log</span><span class="op" id="5614675">.</span><span class="ident" id="5614676">Printf</span><span class="op" id="5614682">(</span><span class="ident" id="5614683">format</span><span class="op" id="5614689">,</span>&nbsp;<span class="ident" id="5614691">v</span><span class="op" id="5614692">...</span><span class="op" id="5614695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5614698">}</span><br>
<span class="lineno"></span><span class="op" id="5614700">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="keyword" id="5614703">func</span>&nbsp;<span class="op" id="5614708">(</span><span class="ident" id="5614709">h</span>&nbsp;<span class="op" id="5614711">*</span><span class="ident" id="5614712">Handler</span><span class="op" id="5614719">)</span>&nbsp;<span class="ident" id="5614721">handleInternalRedirect</span><span class="op" id="5614743">(</span><span class="ident" id="5614744">rw</span>&nbsp;<span class="ident" id="5614747">http</span><span class="op" id="5614751">.</span><span class="ident" id="5614752">ResponseWriter</span><span class="op" id="5614766">,</span>&nbsp;<span class="ident" id="5614768">req</span>&nbsp;<span class="op" id="5614772">*</span><span class="ident" id="5614773">http</span><span class="op" id="5614777">.</span><span class="ident" id="5614778">Request</span><span class="op" id="5614785">,</span>&nbsp;<span class="ident" id="5614787">path</span>&nbsp;<span class="builtintype" id="5614792">string</span><span class="op" id="5614798">)</span>&nbsp;<span class="op" id="5614800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5614803">url</span><span class="op" id="5614806">,</span>&nbsp;<span class="ident" id="5614808">err</span>&nbsp;<span class="op" id="5614812">:=</span>&nbsp;<span class="ident" id="5614815">req</span><span class="op" id="5614818">.</span><span class="ident" id="5614819">URL</span><span class="op" id="5614822">.</span><span class="ident" id="5614823">Parse</span><span class="op" id="5614828">(</span><span class="ident" id="5614829">path</span><span class="op" id="5614833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5614836">if</span>&nbsp;<span class="ident" id="5614839">err</span>&nbsp;<span class="op" id="5614843">!=</span>&nbsp;<span class="builtintype" id="5614846">nil</span>&nbsp;<span class="op" id="5614850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5614854">rw</span><span class="op" id="5614856">.</span><span class="ident" id="5614857">WriteHeader</span><span class="op" id="5614868">(</span><span class="ident" id="5614869">http</span><span class="op" id="5614873">.</span><span class="ident" id="5614874">StatusInternalServerError</span><span class="op" id="5614899">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5614903">h</span><span class="op" id="5614904">.</span><span class="ident" id="5614905">printf</span><span class="op" id="5614911">(</span><span class="string" id="5614912">&#34;cgi:&nbsp;error&nbsp;resolving&nbsp;local&nbsp;URI&nbsp;path&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="5614956">,</span>&nbsp;<span class="ident" id="5614958">path</span><span class="op" id="5614962">,</span>&nbsp;<span class="ident" id="5614964">err</span><span class="op" id="5614967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5614971">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5614979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5614982">//&nbsp;TODO:&nbsp;RFC&nbsp;3875&nbsp;isn&#39;t&nbsp;clear&nbsp;if&nbsp;only&nbsp;GET&nbsp;is&nbsp;supported,&nbsp;but&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5615046">//&nbsp;suggests&nbsp;so:&nbsp;&#34;Note&nbsp;that&nbsp;any&nbsp;message-body&nbsp;attached&nbsp;to&nbsp;the</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5615107">//&nbsp;request&nbsp;(such&nbsp;as&nbsp;for&nbsp;a&nbsp;POST&nbsp;request)&nbsp;may&nbsp;not&nbsp;be&nbsp;available</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5615169">//&nbsp;to&nbsp;the&nbsp;resource&nbsp;that&nbsp;is&nbsp;the&nbsp;target&nbsp;of&nbsp;the&nbsp;redirect.&#34;&nbsp;&nbsp;We</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5615230">//&nbsp;should&nbsp;do&nbsp;some&nbsp;tests&nbsp;against&nbsp;Apache&nbsp;to&nbsp;see&nbsp;how&nbsp;it&nbsp;handles</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5615292">//&nbsp;POST,&nbsp;HEAD,&nbsp;etc.&nbsp;Does&nbsp;the&nbsp;internal&nbsp;redirect&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5615353">//&nbsp;method&nbsp;or&nbsp;just&nbsp;GET?&nbsp;What&nbsp;about&nbsp;incoming&nbsp;headers?</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5615406">//&nbsp;(e.g.&nbsp;Cookies)&nbsp;Which&nbsp;headers,&nbsp;if&nbsp;any,&nbsp;are&nbsp;copied&nbsp;into&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5615468">//&nbsp;second&nbsp;request?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5615488">newReq</span>&nbsp;<span class="op" id="5615495">:=</span>&nbsp;<span class="op" id="5615498">&amp;</span><span class="ident" id="5615499">http</span><span class="op" id="5615503">.</span><span class="ident" id="5615504">Request</span><span class="op" id="5615511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5615515">Method</span><span class="op" id="5615521">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5615527">&#34;GET&#34;</span><span class="op" id="5615532">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5615536">URL</span><span class="op" id="5615539">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5615548">url</span><span class="op" id="5615551">,</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5615555">Proto</span><span class="op" id="5615560">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5615567">&#34;HTTP/1.1&#34;</span><span class="op" id="5615577">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5615581">ProtoMajor</span><span class="op" id="5615591">:</span>&nbsp;<span class="num" id="5615593">1</span><span class="op" id="5615594">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5615598">ProtoMinor</span><span class="op" id="5615608">:</span>&nbsp;<span class="num" id="5615610">1</span><span class="op" id="5615611">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5615615">Header</span><span class="op" id="5615621">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5615627">make</span><span class="op" id="5615631">(</span><span class="ident" id="5615632">http</span><span class="op" id="5615636">.</span><span class="ident" id="5615637">Header</span><span class="op" id="5615643">)</span><span class="op" id="5615644">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5615648">Host</span><span class="op" id="5615652">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5615660">url</span><span class="op" id="5615663">.</span><span class="ident" id="5615664">Host</span><span class="op" id="5615668">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5615672">RemoteAddr</span><span class="op" id="5615682">:</span>&nbsp;<span class="ident" id="5615684">req</span><span class="op" id="5615687">.</span><span class="ident" id="5615688">RemoteAddr</span><span class="op" id="5615698">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5615702">TLS</span><span class="op" id="5615705">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5615714">req</span><span class="op" id="5615717">.</span><span class="ident" id="5615718">TLS</span><span class="op" id="5615721">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5615724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5615727">h</span><span class="op" id="5615728">.</span><span class="ident" id="5615729">PathLocationHandler</span><span class="op" id="5615748">.</span><span class="ident" id="5615749">ServeHTTP</span><span class="op" id="5615758">(</span><span class="ident" id="5615759">rw</span><span class="op" id="5615761">,</span>&nbsp;<span class="ident" id="5615763">newReq</span><span class="op" id="5615769">)</span><br>
<span class="lineno"></span><span class="op" id="5615771">}</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="5615774">func</span>&nbsp;<span class="ident" id="5615779">upperCaseAndUnderscore</span><span class="op" id="5615801">(</span><span class="ident" id="5615802">r</span>&nbsp;<span class="builtintype" id="5615804">rune</span><span class="op" id="5615808">)</span>&nbsp;<span class="builtintype" id="5615810">rune</span>&nbsp;<span class="op" id="5615815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5615818">switch</span>&nbsp;<span class="op" id="5615825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5615828">case</span>&nbsp;<span class="ident" id="5615833">r</span>&nbsp;<span class="op" id="5615835">&gt;=</span>&nbsp;<span class="string" id="5615838">&#39;a&#39;</span>&nbsp;<span class="op" id="5615842">&amp;&amp;</span>&nbsp;<span class="ident" id="5615845">r</span>&nbsp;<span class="op" id="5615847">&lt;=</span>&nbsp;<span class="string" id="5615850">&#39;z&#39;</span><span class="op" id="5615853">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5615857">return</span>&nbsp;<span class="ident" id="5615864">r</span>&nbsp;<span class="op" id="5615866">-</span>&nbsp;<span class="op" id="5615868">(</span><span class="string" id="5615869">&#39;a&#39;</span>&nbsp;<span class="op" id="5615873">-</span>&nbsp;<span class="string" id="5615875">&#39;A&#39;</span><span class="op" id="5615878">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5615881">case</span>&nbsp;<span class="ident" id="5615886">r</span>&nbsp;<span class="op" id="5615888">==</span>&nbsp;<span class="string" id="5615891">&#39;-&#39;</span><span class="op" id="5615894">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5615898">return</span>&nbsp;<span class="string" id="5615905">&#39;_&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5615910">case</span>&nbsp;<span class="ident" id="5615915">r</span>&nbsp;<span class="op" id="5615917">==</span>&nbsp;<span class="string" id="5615920">&#39;=&#39;</span><span class="op" id="5615923">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5615927">//&nbsp;Maybe&nbsp;not&nbsp;part&nbsp;of&nbsp;the&nbsp;CGI&nbsp;&#39;spec&#39;&nbsp;but&nbsp;would&nbsp;mess&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5615983">//&nbsp;the&nbsp;environment&nbsp;in&nbsp;any&nbsp;case,&nbsp;as&nbsp;Go&nbsp;represents&nbsp;the</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5616038">//&nbsp;environment&nbsp;as&nbsp;a&nbsp;slice&nbsp;of&nbsp;&#34;key=value&#34;&nbsp;strings.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5616090">return</span>&nbsp;<span class="string" id="5616097">&#39;_&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5616102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5616105">//&nbsp;TODO:&nbsp;other&nbsp;transformations&nbsp;in&nbsp;spec&nbsp;or&nbsp;practice?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5616158">return</span>&nbsp;<span class="ident" id="5616165">r</span><br>
<span class="lineno">375</span><span class="op" id="5616167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5616170">var</span>&nbsp;<span class="ident" id="5616174">testHookStartProcess</span>&nbsp;<span class="keyword" id="5616195">func</span><span class="op" id="5616199">(</span><span class="op" id="5616200">*</span><span class="ident" id="5616201">os</span><span class="op" id="5616203">.</span><span class="ident" id="5616204">Process</span><span class="op" id="5616211">)</span>&nbsp;<span class="comment" id="5616213">//&nbsp;nil&nbsp;except&nbsp;for&nbsp;some&nbsp;tests</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
