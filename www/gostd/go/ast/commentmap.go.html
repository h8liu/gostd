<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1362657">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1362712">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1362766">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1362817">package</span>&nbsp;<span class="ident" id="1362825">ast</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1362830">import</span>&nbsp;<span class="op" id="1362837">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1362840">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1362849">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1362856">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1362868">&#34;sort&#34;</span><br>
<span class="lineno"></span><span class="op" id="1362875">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1362878">type</span>&nbsp;<span class="ident" id="1362883">byPos</span>&nbsp;<span class="op" id="1362889">[</span><span class="op" id="1362890">]</span><span class="op" id="1362891">*</span><span class="ident" id="1362892">CommentGroup</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="1362906">func</span>&nbsp;<span class="op" id="1362911">(</span><span class="ident" id="1362912">a</span>&nbsp;<span class="ident" id="1362914">byPos</span><span class="op" id="1362919">)</span>&nbsp;<span class="ident" id="1362921">Len</span><span class="op" id="1362924">(</span><span class="op" id="1362925">)</span>&nbsp;<span class="builtintype" id="1362927">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1362941">{</span>&nbsp;<span class="keyword" id="1362943">return</span>&nbsp;<span class="builtinfunc" id="1362950">len</span><span class="op" id="1362953">(</span><span class="ident" id="1362954">a</span><span class="op" id="1362955">)</span>&nbsp;<span class="op" id="1362957">}</span><br>
<span class="lineno"></span><span class="keyword" id="1362959">func</span>&nbsp;<span class="op" id="1362964">(</span><span class="ident" id="1362965">a</span>&nbsp;<span class="ident" id="1362967">byPos</span><span class="op" id="1362972">)</span>&nbsp;<span class="ident" id="1362974">Less</span><span class="op" id="1362978">(</span><span class="ident" id="1362979">i</span><span class="op" id="1362980">,</span>&nbsp;<span class="ident" id="1362982">j</span>&nbsp;<span class="builtintype" id="1362984">int</span><span class="op" id="1362987">)</span>&nbsp;<span class="builtintype" id="1362989">bool</span>&nbsp;<span class="op" id="1362994">{</span>&nbsp;<span class="keyword" id="1362996">return</span>&nbsp;<span class="ident" id="1363003">a</span><span class="op" id="1363004">[</span><span class="ident" id="1363005">i</span><span class="op" id="1363006">]</span><span class="op" id="1363007">.</span><span class="ident" id="1363008">Pos</span><span class="op" id="1363011">(</span><span class="op" id="1363012">)</span>&nbsp;<span class="op" id="1363014">&lt;</span>&nbsp;<span class="ident" id="1363016">a</span><span class="op" id="1363017">[</span><span class="ident" id="1363018">j</span><span class="op" id="1363019">]</span><span class="op" id="1363020">.</span><span class="ident" id="1363021">Pos</span><span class="op" id="1363024">(</span><span class="op" id="1363025">)</span>&nbsp;<span class="op" id="1363027">}</span><br>
<span class="lineno"></span><span class="keyword" id="1363029">func</span>&nbsp;<span class="op" id="1363034">(</span><span class="ident" id="1363035">a</span>&nbsp;<span class="ident" id="1363037">byPos</span><span class="op" id="1363042">)</span>&nbsp;<span class="ident" id="1363044">Swap</span><span class="op" id="1363048">(</span><span class="ident" id="1363049">i</span><span class="op" id="1363050">,</span>&nbsp;<span class="ident" id="1363052">j</span>&nbsp;<span class="builtintype" id="1363054">int</span><span class="op" id="1363057">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1363064">{</span>&nbsp;<span class="ident" id="1363066">a</span><span class="op" id="1363067">[</span><span class="ident" id="1363068">i</span><span class="op" id="1363069">]</span><span class="op" id="1363070">,</span>&nbsp;<span class="ident" id="1363072">a</span><span class="op" id="1363073">[</span><span class="ident" id="1363074">j</span><span class="op" id="1363075">]</span>&nbsp;<span class="op" id="1363077">=</span>&nbsp;<span class="ident" id="1363079">a</span><span class="op" id="1363080">[</span><span class="ident" id="1363081">j</span><span class="op" id="1363082">]</span><span class="op" id="1363083">,</span>&nbsp;<span class="ident" id="1363085">a</span><span class="op" id="1363086">[</span><span class="ident" id="1363087">i</span><span class="op" id="1363088">]</span>&nbsp;<span class="op" id="1363090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="1363093">//&nbsp;sortComments&nbsp;sorts&nbsp;the&nbsp;list&nbsp;of&nbsp;comment&nbsp;groups&nbsp;in&nbsp;source&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="1363159">//</span><br>
<span class="lineno"></span><span class="keyword" id="1363162">func</span>&nbsp;<span class="ident" id="1363167">sortComments</span><span class="op" id="1363179">(</span><span class="ident" id="1363180">list</span>&nbsp;<span class="op" id="1363185">[</span><span class="op" id="1363186">]</span><span class="op" id="1363187">*</span><span class="ident" id="1363188">CommentGroup</span><span class="op" id="1363200">)</span>&nbsp;<span class="op" id="1363202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1363205">//&nbsp;TODO(gri):&nbsp;Does&nbsp;it&nbsp;make&nbsp;sense&nbsp;to&nbsp;check&nbsp;for&nbsp;sorted-ness</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1363264">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first&nbsp;(because&nbsp;we&nbsp;know&nbsp;that&nbsp;sorted-ness&nbsp;is</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1363322">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;very&nbsp;likely)?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363351">if</span>&nbsp;<span class="ident" id="1363354">orderedList</span>&nbsp;<span class="op" id="1363366">:=</span>&nbsp;<span class="ident" id="1363369">byPos</span><span class="op" id="1363374">(</span><span class="ident" id="1363375">list</span><span class="op" id="1363379">)</span><span class="op" id="1363380">;</span>&nbsp;<span class="op" id="1363382">!</span><span class="ident" id="1363383">sort</span><span class="op" id="1363387">.</span><span class="ident" id="1363388">IsSorted</span><span class="op" id="1363396">(</span><span class="ident" id="1363397">orderedList</span><span class="op" id="1363408">)</span>&nbsp;<span class="op" id="1363410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363414">sort</span><span class="op" id="1363418">.</span><span class="ident" id="1363419">Sort</span><span class="op" id="1363423">(</span><span class="ident" id="1363424">orderedList</span><span class="op" id="1363435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1363438">}</span><br>
<span class="lineno"></span><span class="op" id="1363440">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="1363443">//&nbsp;A&nbsp;CommentMap&nbsp;maps&nbsp;an&nbsp;AST&nbsp;node&nbsp;to&nbsp;a&nbsp;list&nbsp;of&nbsp;comment&nbsp;groups</span><br>
<span class="lineno"></span><span class="comment" id="1363504">//&nbsp;associated&nbsp;with&nbsp;it.&nbsp;See&nbsp;NewCommentMap&nbsp;for&nbsp;a&nbsp;description&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1363566">//&nbsp;the&nbsp;association.</span><br>
<span class="lineno"></span><span class="comment" id="1363586">//</span><br>
<span class="lineno">35</span><span class="keyword" id="1363589">type</span>&nbsp;<span class="ident" id="1363594">CommentMap</span>&nbsp;<span class="keyword" id="1363605">map</span><span class="op" id="1363608">[</span><span class="ident" id="1363609">Node</span><span class="op" id="1363613">]</span><span class="op" id="1363614">[</span><span class="op" id="1363615">]</span><span class="op" id="1363616">*</span><span class="ident" id="1363617">CommentGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1363631">func</span>&nbsp;<span class="op" id="1363636">(</span><span class="ident" id="1363637">cmap</span>&nbsp;<span class="ident" id="1363642">CommentMap</span><span class="op" id="1363652">)</span>&nbsp;<span class="ident" id="1363654">addComment</span><span class="op" id="1363664">(</span><span class="ident" id="1363665">n</span>&nbsp;<span class="ident" id="1363667">Node</span><span class="op" id="1363671">,</span>&nbsp;<span class="ident" id="1363673">c</span>&nbsp;<span class="op" id="1363675">*</span><span class="ident" id="1363676">CommentGroup</span><span class="op" id="1363688">)</span>&nbsp;<span class="op" id="1363690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363693">list</span>&nbsp;<span class="op" id="1363698">:=</span>&nbsp;<span class="ident" id="1363701">cmap</span><span class="op" id="1363705">[</span><span class="ident" id="1363706">n</span><span class="op" id="1363707">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363710">if</span>&nbsp;<span class="builtinfunc" id="1363713">len</span><span class="op" id="1363716">(</span><span class="ident" id="1363717">list</span><span class="op" id="1363721">)</span>&nbsp;<span class="op" id="1363723">==</span>&nbsp;<span class="num" id="1363726">0</span>&nbsp;<span class="op" id="1363728">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363732">list</span>&nbsp;<span class="op" id="1363737">=</span>&nbsp;<span class="op" id="1363739">[</span><span class="op" id="1363740">]</span><span class="op" id="1363741">*</span><span class="ident" id="1363742">CommentGroup</span><span class="op" id="1363754">{</span><span class="ident" id="1363755">c</span><span class="op" id="1363756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1363759">}</span>&nbsp;<span class="keyword" id="1363761">else</span>&nbsp;<span class="op" id="1363766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363770">list</span>&nbsp;<span class="op" id="1363775">=</span>&nbsp;<span class="builtinfunc" id="1363777">append</span><span class="op" id="1363783">(</span><span class="ident" id="1363784">list</span><span class="op" id="1363788">,</span>&nbsp;<span class="ident" id="1363790">c</span><span class="op" id="1363791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1363794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363797">cmap</span><span class="op" id="1363801">[</span><span class="ident" id="1363802">n</span><span class="op" id="1363803">]</span>&nbsp;<span class="op" id="1363805">=</span>&nbsp;<span class="ident" id="1363807">list</span><br>
<span class="lineno">45</span><span class="op" id="1363812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1363815">type</span>&nbsp;<span class="ident" id="1363820">byInterval</span>&nbsp;<span class="op" id="1363831">[</span><span class="op" id="1363832">]</span><span class="ident" id="1363833">Node</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1363839">func</span>&nbsp;<span class="op" id="1363844">(</span><span class="ident" id="1363845">a</span>&nbsp;<span class="ident" id="1363847">byInterval</span><span class="op" id="1363857">)</span>&nbsp;<span class="ident" id="1363859">Len</span><span class="op" id="1363862">(</span><span class="op" id="1363863">)</span>&nbsp;<span class="builtintype" id="1363865">int</span>&nbsp;<span class="op" id="1363869">{</span>&nbsp;<span class="keyword" id="1363871">return</span>&nbsp;<span class="builtinfunc" id="1363878">len</span><span class="op" id="1363881">(</span><span class="ident" id="1363882">a</span><span class="op" id="1363883">)</span>&nbsp;<span class="op" id="1363885">}</span><br>
<span class="lineno">50</span><span class="keyword" id="1363887">func</span>&nbsp;<span class="op" id="1363892">(</span><span class="ident" id="1363893">a</span>&nbsp;<span class="ident" id="1363895">byInterval</span><span class="op" id="1363905">)</span>&nbsp;<span class="ident" id="1363907">Less</span><span class="op" id="1363911">(</span><span class="ident" id="1363912">i</span><span class="op" id="1363913">,</span>&nbsp;<span class="ident" id="1363915">j</span>&nbsp;<span class="builtintype" id="1363917">int</span><span class="op" id="1363920">)</span>&nbsp;<span class="builtintype" id="1363922">bool</span>&nbsp;<span class="op" id="1363927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1363930">pi</span><span class="op" id="1363932">,</span>&nbsp;<span class="ident" id="1363934">pj</span>&nbsp;<span class="op" id="1363937">:=</span>&nbsp;<span class="ident" id="1363940">a</span><span class="op" id="1363941">[</span><span class="ident" id="1363942">i</span><span class="op" id="1363943">]</span><span class="op" id="1363944">.</span><span class="ident" id="1363945">Pos</span><span class="op" id="1363948">(</span><span class="op" id="1363949">)</span><span class="op" id="1363950">,</span>&nbsp;<span class="ident" id="1363952">a</span><span class="op" id="1363953">[</span><span class="ident" id="1363954">j</span><span class="op" id="1363955">]</span><span class="op" id="1363956">.</span><span class="ident" id="1363957">Pos</span><span class="op" id="1363960">(</span><span class="op" id="1363961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1363964">return</span>&nbsp;<span class="ident" id="1363971">pi</span>&nbsp;<span class="op" id="1363974">&lt;</span>&nbsp;<span class="ident" id="1363976">pj</span>&nbsp;<span class="op" id="1363979">||</span>&nbsp;<span class="ident" id="1363982">pi</span>&nbsp;<span class="op" id="1363985">==</span>&nbsp;<span class="ident" id="1363988">pj</span>&nbsp;<span class="op" id="1363991">&amp;&amp;</span>&nbsp;<span class="ident" id="1363994">a</span><span class="op" id="1363995">[</span><span class="ident" id="1363996">i</span><span class="op" id="1363997">]</span><span class="op" id="1363998">.</span><span class="ident" id="1363999">End</span><span class="op" id="1364002">(</span><span class="op" id="1364003">)</span>&nbsp;<span class="op" id="1364005">&gt;</span>&nbsp;<span class="ident" id="1364007">a</span><span class="op" id="1364008">[</span><span class="ident" id="1364009">j</span><span class="op" id="1364010">]</span><span class="op" id="1364011">.</span><span class="ident" id="1364012">End</span><span class="op" id="1364015">(</span><span class="op" id="1364016">)</span><br>
<span class="lineno"></span><span class="op" id="1364018">}</span><br>
<span class="lineno"></span><span class="keyword" id="1364020">func</span>&nbsp;<span class="op" id="1364025">(</span><span class="ident" id="1364026">a</span>&nbsp;<span class="ident" id="1364028">byInterval</span><span class="op" id="1364038">)</span>&nbsp;<span class="ident" id="1364040">Swap</span><span class="op" id="1364044">(</span><span class="ident" id="1364045">i</span><span class="op" id="1364046">,</span>&nbsp;<span class="ident" id="1364048">j</span>&nbsp;<span class="builtintype" id="1364050">int</span><span class="op" id="1364053">)</span>&nbsp;<span class="op" id="1364055">{</span>&nbsp;<span class="ident" id="1364057">a</span><span class="op" id="1364058">[</span><span class="ident" id="1364059">i</span><span class="op" id="1364060">]</span><span class="op" id="1364061">,</span>&nbsp;<span class="ident" id="1364063">a</span><span class="op" id="1364064">[</span><span class="ident" id="1364065">j</span><span class="op" id="1364066">]</span>&nbsp;<span class="op" id="1364068">=</span>&nbsp;<span class="ident" id="1364070">a</span><span class="op" id="1364071">[</span><span class="ident" id="1364072">j</span><span class="op" id="1364073">]</span><span class="op" id="1364074">,</span>&nbsp;<span class="ident" id="1364076">a</span><span class="op" id="1364077">[</span><span class="ident" id="1364078">i</span><span class="op" id="1364079">]</span>&nbsp;<span class="op" id="1364081">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="1364084">//&nbsp;nodeList&nbsp;returns&nbsp;the&nbsp;list&nbsp;of&nbsp;nodes&nbsp;of&nbsp;the&nbsp;AST&nbsp;n&nbsp;in&nbsp;source&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="1364152">//</span><br>
<span class="lineno"></span><span class="keyword" id="1364155">func</span>&nbsp;<span class="ident" id="1364160">nodeList</span><span class="op" id="1364168">(</span><span class="ident" id="1364169">n</span>&nbsp;<span class="ident" id="1364171">Node</span><span class="op" id="1364175">)</span>&nbsp;<span class="op" id="1364177">[</span><span class="op" id="1364178">]</span><span class="ident" id="1364179">Node</span>&nbsp;<span class="op" id="1364184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364187">var</span>&nbsp;<span class="ident" id="1364191">list</span>&nbsp;<span class="op" id="1364196">[</span><span class="op" id="1364197">]</span><span class="ident" id="1364198">Node</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364204">Inspect</span><span class="op" id="1364211">(</span><span class="ident" id="1364212">n</span><span class="op" id="1364213">,</span>&nbsp;<span class="keyword" id="1364215">func</span><span class="op" id="1364219">(</span><span class="ident" id="1364220">n</span>&nbsp;<span class="ident" id="1364222">Node</span><span class="op" id="1364226">)</span>&nbsp;<span class="builtintype" id="1364228">bool</span>&nbsp;<span class="op" id="1364233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1364237">//&nbsp;don&#39;t&nbsp;collect&nbsp;comments</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364265">switch</span>&nbsp;<span class="ident" id="1364272">n</span><span class="op" id="1364273">.</span><span class="op" id="1364274">(</span><span class="keyword" id="1364275">type</span><span class="op" id="1364279">)</span>&nbsp;<span class="op" id="1364281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364285">case</span>&nbsp;<span class="ident" id="1364290">nil</span><span class="op" id="1364293">,</span>&nbsp;<span class="op" id="1364295">*</span><span class="ident" id="1364296">CommentGroup</span><span class="op" id="1364308">,</span>&nbsp;<span class="op" id="1364310">*</span><span class="ident" id="1364311">Comment</span><span class="op" id="1364318">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364323">return</span>&nbsp;<span class="builtintype" id="1364330">false</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1364338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364342">list</span>&nbsp;<span class="op" id="1364347">=</span>&nbsp;<span class="builtinfunc" id="1364349">append</span><span class="op" id="1364355">(</span><span class="ident" id="1364356">list</span><span class="op" id="1364360">,</span>&nbsp;<span class="ident" id="1364362">n</span><span class="op" id="1364363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364367">return</span>&nbsp;<span class="builtintype" id="1364374">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1364380">}</span><span class="op" id="1364381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1364384">//&nbsp;Note:&nbsp;The&nbsp;current&nbsp;implementation&nbsp;assumes&nbsp;that&nbsp;Inspect&nbsp;traverses&nbsp;the</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1364456">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AST&nbsp;in&nbsp;depth-first&nbsp;and&nbsp;thus&nbsp;_source_&nbsp;order.&nbsp;If&nbsp;AST&nbsp;traversal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1364527">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;does&nbsp;not&nbsp;follow&nbsp;source&nbsp;order,&nbsp;the&nbsp;sorting&nbsp;call&nbsp;below&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1364598">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1364618">//&nbsp;sort.Sort(byInterval(list))</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1364650">return</span>&nbsp;<span class="ident" id="1364657">list</span><br>
<span class="lineno">75</span><span class="op" id="1364662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1364665">//&nbsp;A&nbsp;commentListReader&nbsp;helps&nbsp;iterating&nbsp;through&nbsp;a&nbsp;list&nbsp;of&nbsp;comment&nbsp;groups.</span><br>
<span class="lineno"></span><span class="comment" id="1364738">//</span><br>
<span class="lineno"></span><span class="keyword" id="1364741">type</span>&nbsp;<span class="ident" id="1364746">commentListReader</span>&nbsp;<span class="keyword" id="1364764">struct</span>&nbsp;<span class="op" id="1364771">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364774">fset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1364783">*</span><span class="ident" id="1364784">token</span><span class="op" id="1364789">.</span><span class="ident" id="1364790">FileSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364799">list</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1364808">[</span><span class="op" id="1364809">]</span><span class="op" id="1364810">*</span><span class="ident" id="1364811">CommentGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364825">index</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1364834">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364839">comment</span>&nbsp;&nbsp;<span class="op" id="1364848">*</span><span class="ident" id="1364849">CommentGroup</span>&nbsp;&nbsp;<span class="comment" id="1364863">//&nbsp;comment&nbsp;group&nbsp;at&nbsp;current&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1364898">pos</span><span class="op" id="1364901">,</span>&nbsp;<span class="ident" id="1364903">end</span>&nbsp;<span class="ident" id="1364907">token</span><span class="op" id="1364912">.</span><span class="ident" id="1364913">Position</span>&nbsp;<span class="comment" id="1364922">//&nbsp;source&nbsp;interval&nbsp;of&nbsp;comment&nbsp;group&nbsp;at&nbsp;current&nbsp;index</span><br>
<span class="lineno">85</span><span class="op" id="1364975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1364978">func</span>&nbsp;<span class="op" id="1364983">(</span><span class="ident" id="1364984">r</span>&nbsp;<span class="op" id="1364986">*</span><span class="ident" id="1364987">commentListReader</span><span class="op" id="1365004">)</span>&nbsp;<span class="ident" id="1365006">eol</span><span class="op" id="1365009">(</span><span class="op" id="1365010">)</span>&nbsp;<span class="builtintype" id="1365012">bool</span>&nbsp;<span class="op" id="1365017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1365020">return</span>&nbsp;<span class="ident" id="1365027">r</span><span class="op" id="1365028">.</span><span class="ident" id="1365029">index</span>&nbsp;<span class="op" id="1365035">&gt;=</span>&nbsp;<span class="builtinfunc" id="1365038">len</span><span class="op" id="1365041">(</span><span class="ident" id="1365042">r</span><span class="op" id="1365043">.</span><span class="ident" id="1365044">list</span><span class="op" id="1365048">)</span><br>
<span class="lineno"></span><span class="op" id="1365050">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="1365053">func</span>&nbsp;<span class="op" id="1365058">(</span><span class="ident" id="1365059">r</span>&nbsp;<span class="op" id="1365061">*</span><span class="ident" id="1365062">commentListReader</span><span class="op" id="1365079">)</span>&nbsp;<span class="ident" id="1365081">next</span><span class="op" id="1365085">(</span><span class="op" id="1365086">)</span>&nbsp;<span class="op" id="1365088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1365091">if</span>&nbsp;<span class="op" id="1365094">!</span><span class="ident" id="1365095">r</span><span class="op" id="1365096">.</span><span class="ident" id="1365097">eol</span><span class="op" id="1365100">(</span><span class="op" id="1365101">)</span>&nbsp;<span class="op" id="1365103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365107">r</span><span class="op" id="1365108">.</span><span class="ident" id="1365109">comment</span>&nbsp;<span class="op" id="1365117">=</span>&nbsp;<span class="ident" id="1365119">r</span><span class="op" id="1365120">.</span><span class="ident" id="1365121">list</span><span class="op" id="1365125">[</span><span class="ident" id="1365126">r</span><span class="op" id="1365127">.</span><span class="ident" id="1365128">index</span><span class="op" id="1365133">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365137">r</span><span class="op" id="1365138">.</span><span class="ident" id="1365139">pos</span>&nbsp;<span class="op" id="1365143">=</span>&nbsp;<span class="ident" id="1365145">r</span><span class="op" id="1365146">.</span><span class="ident" id="1365147">fset</span><span class="op" id="1365151">.</span><span class="ident" id="1365152">Position</span><span class="op" id="1365160">(</span><span class="ident" id="1365161">r</span><span class="op" id="1365162">.</span><span class="ident" id="1365163">comment</span><span class="op" id="1365170">.</span><span class="ident" id="1365171">Pos</span><span class="op" id="1365174">(</span><span class="op" id="1365175">)</span><span class="op" id="1365176">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365180">r</span><span class="op" id="1365181">.</span><span class="ident" id="1365182">end</span>&nbsp;<span class="op" id="1365186">=</span>&nbsp;<span class="ident" id="1365188">r</span><span class="op" id="1365189">.</span><span class="ident" id="1365190">fset</span><span class="op" id="1365194">.</span><span class="ident" id="1365195">Position</span><span class="op" id="1365203">(</span><span class="ident" id="1365204">r</span><span class="op" id="1365205">.</span><span class="ident" id="1365206">comment</span><span class="op" id="1365213">.</span><span class="ident" id="1365214">End</span><span class="op" id="1365217">(</span><span class="op" id="1365218">)</span><span class="op" id="1365219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365223">r</span><span class="op" id="1365224">.</span><span class="ident" id="1365225">index</span><span class="op" id="1365230">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1365234">}</span><br>
<span class="lineno"></span><span class="op" id="1365236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="1365239">//&nbsp;A&nbsp;nodeStack&nbsp;keeps&nbsp;track&nbsp;of&nbsp;nested&nbsp;nodes.</span><br>
<span class="lineno"></span><span class="comment" id="1365283">//&nbsp;A&nbsp;node&nbsp;lower&nbsp;on&nbsp;the&nbsp;stack&nbsp;lexically&nbsp;contains&nbsp;the&nbsp;nodes&nbsp;higher&nbsp;on&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1365362">//</span><br>
<span class="lineno"></span><span class="keyword" id="1365365">type</span>&nbsp;<span class="ident" id="1365370">nodeStack</span>&nbsp;<span class="op" id="1365380">[</span><span class="op" id="1365381">]</span><span class="ident" id="1365382">Node</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="1365388">//&nbsp;push&nbsp;pops&nbsp;all&nbsp;nodes&nbsp;that&nbsp;appear&nbsp;lexically&nbsp;before&nbsp;n</span><br>
<span class="lineno"></span><span class="comment" id="1365442">//&nbsp;and&nbsp;then&nbsp;pushes&nbsp;n&nbsp;on&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1365477">//</span><br>
<span class="lineno"></span><span class="keyword" id="1365480">func</span>&nbsp;<span class="op" id="1365485">(</span><span class="ident" id="1365486">s</span>&nbsp;<span class="op" id="1365488">*</span><span class="ident" id="1365489">nodeStack</span><span class="op" id="1365498">)</span>&nbsp;<span class="ident" id="1365500">push</span><span class="op" id="1365504">(</span><span class="ident" id="1365505">n</span>&nbsp;<span class="ident" id="1365507">Node</span><span class="op" id="1365511">)</span>&nbsp;<span class="op" id="1365513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365516">s</span><span class="op" id="1365517">.</span><span class="ident" id="1365518">pop</span><span class="op" id="1365521">(</span><span class="ident" id="1365522">n</span><span class="op" id="1365523">.</span><span class="ident" id="1365524">Pos</span><span class="op" id="1365527">(</span><span class="op" id="1365528">)</span><span class="op" id="1365529">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1365532">*</span><span class="ident" id="1365533">s</span>&nbsp;<span class="op" id="1365535">=</span>&nbsp;<span class="builtinfunc" id="1365537">append</span><span class="op" id="1365543">(</span><span class="op" id="1365544">(</span><span class="op" id="1365545">*</span><span class="ident" id="1365546">s</span><span class="op" id="1365547">)</span><span class="op" id="1365548">,</span>&nbsp;<span class="ident" id="1365550">n</span><span class="op" id="1365551">)</span><br>
<span class="lineno"></span><span class="op" id="1365553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1365556">//&nbsp;pop&nbsp;pops&nbsp;all&nbsp;nodes&nbsp;that&nbsp;appear&nbsp;lexically&nbsp;before&nbsp;pos</span><br>
<span class="lineno"></span><span class="comment" id="1365611">//&nbsp;(i.e.,&nbsp;whose&nbsp;lexical&nbsp;extent&nbsp;has&nbsp;ended&nbsp;before&nbsp;or&nbsp;at&nbsp;pos).</span><br>
<span class="lineno">115</span><span class="comment" id="1365671">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;last&nbsp;node&nbsp;popped.</span><br>
<span class="lineno"></span><span class="comment" id="1365707">//</span><br>
<span class="lineno"></span><span class="keyword" id="1365710">func</span>&nbsp;<span class="op" id="1365715">(</span><span class="ident" id="1365716">s</span>&nbsp;<span class="op" id="1365718">*</span><span class="ident" id="1365719">nodeStack</span><span class="op" id="1365728">)</span>&nbsp;<span class="ident" id="1365730">pop</span><span class="op" id="1365733">(</span><span class="ident" id="1365734">pos</span>&nbsp;<span class="ident" id="1365738">token</span><span class="op" id="1365743">.</span><span class="ident" id="1365744">Pos</span><span class="op" id="1365747">)</span>&nbsp;<span class="op" id="1365749">(</span><span class="ident" id="1365750">top</span>&nbsp;<span class="ident" id="1365754">Node</span><span class="op" id="1365758">)</span>&nbsp;<span class="op" id="1365760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365763">i</span>&nbsp;<span class="op" id="1365765">:=</span>&nbsp;<span class="builtinfunc" id="1365768">len</span><span class="op" id="1365771">(</span><span class="op" id="1365772">*</span><span class="ident" id="1365773">s</span><span class="op" id="1365774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1365777">for</span>&nbsp;<span class="ident" id="1365781">i</span>&nbsp;<span class="op" id="1365783">&gt;</span>&nbsp;<span class="num" id="1365785">0</span>&nbsp;<span class="op" id="1365787">&amp;&amp;</span>&nbsp;<span class="op" id="1365790">(</span><span class="op" id="1365791">*</span><span class="ident" id="1365792">s</span><span class="op" id="1365793">)</span><span class="op" id="1365794">[</span><span class="ident" id="1365795">i</span><span class="op" id="1365796">-</span><span class="num" id="1365797">1</span><span class="op" id="1365798">]</span><span class="op" id="1365799">.</span><span class="ident" id="1365800">End</span><span class="op" id="1365803">(</span><span class="op" id="1365804">)</span>&nbsp;<span class="op" id="1365806">&lt;=</span>&nbsp;<span class="ident" id="1365809">pos</span>&nbsp;<span class="op" id="1365813">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365817">top</span>&nbsp;<span class="op" id="1365821">=</span>&nbsp;<span class="op" id="1365823">(</span><span class="op" id="1365824">*</span><span class="ident" id="1365825">s</span><span class="op" id="1365826">)</span><span class="op" id="1365827">[</span><span class="ident" id="1365828">i</span><span class="op" id="1365829">-</span><span class="num" id="1365830">1</span><span class="op" id="1365831">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1365835">i</span><span class="op" id="1365836">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1365840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1365843">*</span><span class="ident" id="1365844">s</span>&nbsp;<span class="op" id="1365846">=</span>&nbsp;<span class="op" id="1365848">(</span><span class="op" id="1365849">*</span><span class="ident" id="1365850">s</span><span class="op" id="1365851">)</span><span class="op" id="1365852">[</span><span class="num" id="1365853">0</span><span class="op" id="1365854">:</span><span class="ident" id="1365855">i</span><span class="op" id="1365856">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1365859">return</span>&nbsp;<span class="ident" id="1365866">top</span><br>
<span class="lineno">125</span><span class="op" id="1365870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1365873">//&nbsp;NewCommentMap&nbsp;creates&nbsp;a&nbsp;new&nbsp;comment&nbsp;map&nbsp;by&nbsp;associating&nbsp;comment&nbsp;groups</span><br>
<span class="lineno"></span><span class="comment" id="1365946">//&nbsp;of&nbsp;the&nbsp;comments&nbsp;list&nbsp;with&nbsp;the&nbsp;nodes&nbsp;of&nbsp;the&nbsp;AST&nbsp;specified&nbsp;by&nbsp;node.</span><br>
<span class="lineno"></span><span class="comment" id="1366015">//</span><br>
<span class="lineno">130</span><span class="comment" id="1366018">//&nbsp;A&nbsp;comment&nbsp;group&nbsp;g&nbsp;is&nbsp;associated&nbsp;with&nbsp;a&nbsp;node&nbsp;n&nbsp;if:</span><br>
<span class="lineno"></span><span class="comment" id="1366071">//</span><br>
<span class="lineno"></span><span class="comment" id="1366074">//&nbsp;&nbsp;&nbsp;-&nbsp;g&nbsp;starts&nbsp;on&nbsp;the&nbsp;same&nbsp;line&nbsp;as&nbsp;n&nbsp;ends</span><br>
<span class="lineno"></span><span class="comment" id="1366117">//&nbsp;&nbsp;&nbsp;-&nbsp;g&nbsp;starts&nbsp;on&nbsp;the&nbsp;line&nbsp;immediately&nbsp;following&nbsp;n,&nbsp;and&nbsp;there&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1366183">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;least&nbsp;one&nbsp;empty&nbsp;line&nbsp;after&nbsp;g&nbsp;and&nbsp;before&nbsp;the&nbsp;next&nbsp;node</span><br>
<span class="lineno">135</span><span class="comment" id="1366247">//&nbsp;&nbsp;&nbsp;-&nbsp;g&nbsp;starts&nbsp;before&nbsp;n&nbsp;and&nbsp;is&nbsp;not&nbsp;associated&nbsp;to&nbsp;the&nbsp;node&nbsp;before&nbsp;n</span><br>
<span class="lineno"></span><span class="comment" id="1366315">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;via&nbsp;the&nbsp;previous&nbsp;rules</span><br>
<span class="lineno"></span><span class="comment" id="1366345">//</span><br>
<span class="lineno"></span><span class="comment" id="1366348">//&nbsp;NewCommentMap&nbsp;tries&nbsp;to&nbsp;associate&nbsp;a&nbsp;comment&nbsp;group&nbsp;to&nbsp;the&nbsp;&#34;largest&#34;</span><br>
<span class="lineno"></span><span class="comment" id="1366417">//&nbsp;node&nbsp;possible:&nbsp;For&nbsp;instance,&nbsp;if&nbsp;the&nbsp;comment&nbsp;is&nbsp;a&nbsp;line&nbsp;comment</span><br>
<span class="lineno">140</span><span class="comment" id="1366482">//&nbsp;trailing&nbsp;an&nbsp;assignment,&nbsp;the&nbsp;comment&nbsp;is&nbsp;associated&nbsp;with&nbsp;the&nbsp;entire</span><br>
<span class="lineno"></span><span class="comment" id="1366551">//&nbsp;assignment&nbsp;rather&nbsp;than&nbsp;just&nbsp;the&nbsp;last&nbsp;operand&nbsp;in&nbsp;the&nbsp;assignment.</span><br>
<span class="lineno"></span><span class="comment" id="1366618">//</span><br>
<span class="lineno"></span><span class="keyword" id="1366621">func</span>&nbsp;<span class="ident" id="1366626">NewCommentMap</span><span class="op" id="1366639">(</span><span class="ident" id="1366640">fset</span>&nbsp;<span class="op" id="1366645">*</span><span class="ident" id="1366646">token</span><span class="op" id="1366651">.</span><span class="ident" id="1366652">FileSet</span><span class="op" id="1366659">,</span>&nbsp;<span class="ident" id="1366661">node</span>&nbsp;<span class="ident" id="1366666">Node</span><span class="op" id="1366670">,</span>&nbsp;<span class="ident" id="1366672">comments</span>&nbsp;<span class="op" id="1366681">[</span><span class="op" id="1366682">]</span><span class="op" id="1366683">*</span><span class="ident" id="1366684">CommentGroup</span><span class="op" id="1366696">)</span>&nbsp;<span class="ident" id="1366698">CommentMap</span>&nbsp;<span class="op" id="1366709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366712">if</span>&nbsp;<span class="builtinfunc" id="1366715">len</span><span class="op" id="1366718">(</span><span class="ident" id="1366719">comments</span><span class="op" id="1366727">)</span>&nbsp;<span class="op" id="1366729">==</span>&nbsp;<span class="num" id="1366732">0</span>&nbsp;<span class="op" id="1366734">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1366738">return</span>&nbsp;<span class="ident" id="1366745">nil</span>&nbsp;<span class="comment" id="1366749">//&nbsp;no&nbsp;comments&nbsp;to&nbsp;map</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1366772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366776">cmap</span>&nbsp;<span class="op" id="1366781">:=</span>&nbsp;<span class="builtinfunc" id="1366784">make</span><span class="op" id="1366788">(</span><span class="ident" id="1366789">CommentMap</span><span class="op" id="1366799">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1366803">//&nbsp;set&nbsp;up&nbsp;comment&nbsp;reader&nbsp;r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366831">tmp</span>&nbsp;<span class="op" id="1366835">:=</span>&nbsp;<span class="builtinfunc" id="1366838">make</span><span class="op" id="1366842">(</span><span class="op" id="1366843">[</span><span class="op" id="1366844">]</span><span class="op" id="1366845">*</span><span class="ident" id="1366846">CommentGroup</span><span class="op" id="1366858">,</span>&nbsp;<span class="builtinfunc" id="1366860">len</span><span class="op" id="1366863">(</span><span class="ident" id="1366864">comments</span><span class="op" id="1366872">)</span><span class="op" id="1366873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1366876">copy</span><span class="op" id="1366880">(</span><span class="ident" id="1366881">tmp</span><span class="op" id="1366884">,</span>&nbsp;<span class="ident" id="1366886">comments</span><span class="op" id="1366894">)</span>&nbsp;<span class="comment" id="1366896">//&nbsp;don&#39;t&nbsp;change&nbsp;incoming&nbsp;comments</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366931">sortComments</span><span class="op" id="1366943">(</span><span class="ident" id="1366944">tmp</span><span class="op" id="1366947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1366950">r</span>&nbsp;<span class="op" id="1366952">:=</span>&nbsp;<span class="ident" id="1366955">commentListReader</span><span class="op" id="1366972">{</span><span class="ident" id="1366973">fset</span><span class="op" id="1366977">:</span>&nbsp;<span class="ident" id="1366979">fset</span><span class="op" id="1366983">,</span>&nbsp;<span class="ident" id="1366985">list</span><span class="op" id="1366989">:</span>&nbsp;<span class="ident" id="1366991">tmp</span><span class="op" id="1366994">}</span>&nbsp;<span class="comment" id="1366996">//&nbsp;!r.eol()&nbsp;because&nbsp;len(comments)&nbsp;&gt;&nbsp;0</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367035">r</span><span class="op" id="1367036">.</span><span class="ident" id="1367037">next</span><span class="op" id="1367041">(</span><span class="op" id="1367042">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1367046">//&nbsp;create&nbsp;node&nbsp;list&nbsp;in&nbsp;lexical&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367084">nodes</span>&nbsp;<span class="op" id="1367090">:=</span>&nbsp;<span class="ident" id="1367093">nodeList</span><span class="op" id="1367101">(</span><span class="ident" id="1367102">node</span><span class="op" id="1367106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367109">nodes</span>&nbsp;<span class="op" id="1367115">=</span>&nbsp;<span class="builtinfunc" id="1367117">append</span><span class="op" id="1367123">(</span><span class="ident" id="1367124">nodes</span><span class="op" id="1367129">,</span>&nbsp;<span class="ident" id="1367131">nil</span><span class="op" id="1367134">)</span>&nbsp;<span class="comment" id="1367136">//&nbsp;append&nbsp;sentinel</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1367157">//&nbsp;set&nbsp;up&nbsp;iteration&nbsp;variables</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367188">var</span>&nbsp;<span class="op" id="1367192">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367196">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1367202">Node</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1367217">//&nbsp;previous&nbsp;node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367236">pend</span>&nbsp;&nbsp;<span class="ident" id="1367242">token</span><span class="op" id="1367247">.</span><span class="ident" id="1367248">Position</span>&nbsp;<span class="comment" id="1367257">//&nbsp;end&nbsp;of&nbsp;p</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367271">pg</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1367277">Node</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1367292">//&nbsp;previous&nbsp;node&nbsp;group&nbsp;(enclosing&nbsp;nodes&nbsp;of&nbsp;&#34;importance&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367351">pgend</span>&nbsp;<span class="ident" id="1367357">token</span><span class="op" id="1367362">.</span><span class="ident" id="1367363">Position</span>&nbsp;<span class="comment" id="1367372">//&nbsp;end&nbsp;of&nbsp;pg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367387">stack</span>&nbsp;<span class="ident" id="1367393">nodeStack</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1367408">//&nbsp;stack&nbsp;of&nbsp;node&nbsp;groups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1367433">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367437">for</span>&nbsp;<span class="ident" id="1367441">_</span><span class="op" id="1367442">,</span>&nbsp;<span class="ident" id="1367444">q</span>&nbsp;<span class="op" id="1367446">:=</span>&nbsp;<span class="keyword" id="1367449">range</span>&nbsp;<span class="ident" id="1367455">nodes</span>&nbsp;<span class="op" id="1367461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367465">var</span>&nbsp;<span class="ident" id="1367469">qpos</span>&nbsp;<span class="ident" id="1367474">token</span><span class="op" id="1367479">.</span><span class="ident" id="1367480">Position</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367491">if</span>&nbsp;<span class="ident" id="1367494">q</span>&nbsp;<span class="op" id="1367496">!=</span>&nbsp;<span class="ident" id="1367499">nil</span>&nbsp;<span class="op" id="1367503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367508">qpos</span>&nbsp;<span class="op" id="1367513">=</span>&nbsp;<span class="ident" id="1367515">fset</span><span class="op" id="1367519">.</span><span class="ident" id="1367520">Position</span><span class="op" id="1367528">(</span><span class="ident" id="1367529">q</span><span class="op" id="1367530">.</span><span class="ident" id="1367531">Pos</span><span class="op" id="1367534">(</span><span class="op" id="1367535">)</span><span class="op" id="1367536">)</span>&nbsp;<span class="comment" id="1367538">//&nbsp;current&nbsp;node&nbsp;position</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1367565">}</span>&nbsp;<span class="keyword" id="1367567">else</span>&nbsp;<span class="op" id="1367572">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1367577">//&nbsp;set&nbsp;fake&nbsp;sentinel&nbsp;position&nbsp;to&nbsp;infinity&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1367630">//&nbsp;all&nbsp;comments&nbsp;get&nbsp;processed&nbsp;before&nbsp;the&nbsp;sentinel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367683">const</span>&nbsp;<span class="ident" id="1367689">infinity</span>&nbsp;<span class="op" id="1367698">=</span>&nbsp;<span class="num" id="1367700">1</span>&nbsp;<span class="op" id="1367702">&lt;&lt;</span>&nbsp;<span class="num" id="1367705">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367711">qpos</span><span class="op" id="1367715">.</span><span class="ident" id="1367716">Offset</span>&nbsp;<span class="op" id="1367723">=</span>&nbsp;<span class="ident" id="1367725">infinity</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367737">qpos</span><span class="op" id="1367741">.</span><span class="ident" id="1367742">Line</span>&nbsp;<span class="op" id="1367747">=</span>&nbsp;<span class="ident" id="1367749">infinity</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1367760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1367765">//&nbsp;process&nbsp;comments&nbsp;before&nbsp;current&nbsp;node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367807">for</span>&nbsp;<span class="ident" id="1367811">r</span><span class="op" id="1367812">.</span><span class="ident" id="1367813">end</span><span class="op" id="1367816">.</span><span class="ident" id="1367817">Offset</span>&nbsp;<span class="op" id="1367824">&lt;=</span>&nbsp;<span class="ident" id="1367827">qpos</span><span class="op" id="1367831">.</span><span class="ident" id="1367832">Offset</span>&nbsp;<span class="op" id="1367839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1367844">//&nbsp;determine&nbsp;recent&nbsp;node&nbsp;group</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1367878">if</span>&nbsp;<span class="ident" id="1367881">top</span>&nbsp;<span class="op" id="1367885">:=</span>&nbsp;<span class="ident" id="1367888">stack</span><span class="op" id="1367893">.</span><span class="ident" id="1367894">pop</span><span class="op" id="1367897">(</span><span class="ident" id="1367898">r</span><span class="op" id="1367899">.</span><span class="ident" id="1367900">comment</span><span class="op" id="1367907">.</span><span class="ident" id="1367908">Pos</span><span class="op" id="1367911">(</span><span class="op" id="1367912">)</span><span class="op" id="1367913">)</span><span class="op" id="1367914">;</span>&nbsp;<span class="ident" id="1367916">top</span>&nbsp;<span class="op" id="1367920">!=</span>&nbsp;<span class="ident" id="1367923">nil</span>&nbsp;<span class="op" id="1367927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367933">pg</span>&nbsp;<span class="op" id="1367936">=</span>&nbsp;<span class="ident" id="1367938">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1367946">pgend</span>&nbsp;<span class="op" id="1367952">=</span>&nbsp;<span class="ident" id="1367954">fset</span><span class="op" id="1367958">.</span><span class="ident" id="1367959">Position</span><span class="op" id="1367967">(</span><span class="ident" id="1367968">pg</span><span class="op" id="1367970">.</span><span class="ident" id="1367971">End</span><span class="op" id="1367974">(</span><span class="op" id="1367975">)</span><span class="op" id="1367976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1367981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1367986">//&nbsp;Try&nbsp;to&nbsp;associate&nbsp;a&nbsp;comment&nbsp;first&nbsp;with&nbsp;a&nbsp;node&nbsp;group</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368043">//&nbsp;(i.e.,&nbsp;a&nbsp;node&nbsp;of&nbsp;&#34;importance&#34;&nbsp;such&nbsp;as&nbsp;a&nbsp;declaration);</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368103">//&nbsp;if&nbsp;that&nbsp;fails,&nbsp;try&nbsp;to&nbsp;associate&nbsp;it&nbsp;with&nbsp;the&nbsp;most&nbsp;recent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368165">//&nbsp;node.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368177">//&nbsp;TODO(gri)&nbsp;try&nbsp;to&nbsp;simplify&nbsp;the&nbsp;logic&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1368225">var</span>&nbsp;<span class="ident" id="1368229">assoc</span>&nbsp;<span class="ident" id="1368235">Node</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1368243">switch</span>&nbsp;<span class="op" id="1368250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1368255">case</span>&nbsp;<span class="ident" id="1368260">pg</span>&nbsp;<span class="op" id="1368263">!=</span>&nbsp;<span class="ident" id="1368266">nil</span>&nbsp;<span class="op" id="1368270">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1368277">(</span><span class="ident" id="1368278">pgend</span><span class="op" id="1368283">.</span><span class="ident" id="1368284">Line</span>&nbsp;<span class="op" id="1368289">==</span>&nbsp;<span class="ident" id="1368292">r</span><span class="op" id="1368293">.</span><span class="ident" id="1368294">pos</span><span class="op" id="1368297">.</span><span class="ident" id="1368298">Line</span>&nbsp;<span class="op" id="1368303">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1368311">pgend</span><span class="op" id="1368316">.</span><span class="ident" id="1368317">Line</span><span class="op" id="1368321">+</span><span class="num" id="1368322">1</span>&nbsp;<span class="op" id="1368324">==</span>&nbsp;<span class="ident" id="1368327">r</span><span class="op" id="1368328">.</span><span class="ident" id="1368329">pos</span><span class="op" id="1368332">.</span><span class="ident" id="1368333">Line</span>&nbsp;<span class="op" id="1368338">&amp;&amp;</span>&nbsp;<span class="ident" id="1368341">r</span><span class="op" id="1368342">.</span><span class="ident" id="1368343">end</span><span class="op" id="1368346">.</span><span class="ident" id="1368347">Line</span><span class="op" id="1368351">+</span><span class="num" id="1368352">1</span>&nbsp;<span class="op" id="1368354">&lt;</span>&nbsp;<span class="ident" id="1368356">qpos</span><span class="op" id="1368360">.</span><span class="ident" id="1368361">Line</span><span class="op" id="1368365">)</span><span class="op" id="1368366">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368372">//&nbsp;1)&nbsp;comment&nbsp;starts&nbsp;on&nbsp;same&nbsp;line&nbsp;as&nbsp;previous&nbsp;node&nbsp;group&nbsp;ends,&nbsp;or</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368442">//&nbsp;2)&nbsp;comment&nbsp;starts&nbsp;on&nbsp;the&nbsp;line&nbsp;immediately&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368501">//&nbsp;&nbsp;&nbsp;&nbsp;previous&nbsp;node&nbsp;group&nbsp;and&nbsp;there&nbsp;is&nbsp;an&nbsp;empty&nbsp;line&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368565">//&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;current&nbsp;node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368592">//&nbsp;=&gt;&nbsp;associate&nbsp;comment&nbsp;with&nbsp;previous&nbsp;node&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1368645">assoc</span>&nbsp;<span class="op" id="1368651">=</span>&nbsp;<span class="ident" id="1368653">pg</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1368659">case</span>&nbsp;<span class="ident" id="1368664">p</span>&nbsp;<span class="op" id="1368666">!=</span>&nbsp;<span class="ident" id="1368669">nil</span>&nbsp;<span class="op" id="1368673">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1368680">(</span><span class="ident" id="1368681">pend</span><span class="op" id="1368685">.</span><span class="ident" id="1368686">Line</span>&nbsp;<span class="op" id="1368691">==</span>&nbsp;<span class="ident" id="1368694">r</span><span class="op" id="1368695">.</span><span class="ident" id="1368696">pos</span><span class="op" id="1368699">.</span><span class="ident" id="1368700">Line</span>&nbsp;<span class="op" id="1368705">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1368713">pend</span><span class="op" id="1368717">.</span><span class="ident" id="1368718">Line</span><span class="op" id="1368722">+</span><span class="num" id="1368723">1</span>&nbsp;<span class="op" id="1368725">==</span>&nbsp;<span class="ident" id="1368728">r</span><span class="op" id="1368729">.</span><span class="ident" id="1368730">pos</span><span class="op" id="1368733">.</span><span class="ident" id="1368734">Line</span>&nbsp;<span class="op" id="1368739">&amp;&amp;</span>&nbsp;<span class="ident" id="1368742">r</span><span class="op" id="1368743">.</span><span class="ident" id="1368744">end</span><span class="op" id="1368747">.</span><span class="ident" id="1368748">Line</span><span class="op" id="1368752">+</span><span class="num" id="1368753">1</span>&nbsp;<span class="op" id="1368755">&lt;</span>&nbsp;<span class="ident" id="1368757">qpos</span><span class="op" id="1368761">.</span><span class="ident" id="1368762">Line</span>&nbsp;<span class="op" id="1368767">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1368775">q</span>&nbsp;<span class="op" id="1368777">==</span>&nbsp;<span class="ident" id="1368780">nil</span><span class="op" id="1368783">)</span><span class="op" id="1368784">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368790">//&nbsp;same&nbsp;rules&nbsp;apply&nbsp;as&nbsp;above&nbsp;for&nbsp;p&nbsp;rather&nbsp;than&nbsp;pg,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368845">//&nbsp;but&nbsp;also&nbsp;associate&nbsp;with&nbsp;p&nbsp;if&nbsp;we&nbsp;are&nbsp;at&nbsp;the&nbsp;end&nbsp;(q&nbsp;==&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1368910">assoc</span>&nbsp;<span class="op" id="1368916">=</span>&nbsp;<span class="ident" id="1368918">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1368923">default</span><span class="op" id="1368930">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1368936">//&nbsp;otherwise,&nbsp;associate&nbsp;comment&nbsp;with&nbsp;current&nbsp;node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1368990">if</span>&nbsp;<span class="ident" id="1368993">q</span>&nbsp;<span class="op" id="1368995">==</span>&nbsp;<span class="ident" id="1368998">nil</span>&nbsp;<span class="op" id="1369002">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1369009">//&nbsp;we&nbsp;can&nbsp;only&nbsp;reach&nbsp;here&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1369058">//&nbsp;which&nbsp;would&nbsp;imply&nbsp;that&nbsp;there&nbsp;were&nbsp;no&nbsp;nodes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1369109">panic</span><span class="op" id="1369114">(</span><span class="string" id="1369115">&#34;internal&nbsp;error:&nbsp;no&nbsp;comments&nbsp;should&nbsp;be&nbsp;associated&nbsp;with&nbsp;sentinel&#34;</span><span class="op" id="1369179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369191">assoc</span>&nbsp;<span class="op" id="1369197">=</span>&nbsp;<span class="ident" id="1369199">q</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369209">cmap</span><span class="op" id="1369213">.</span><span class="ident" id="1369214">addComment</span><span class="op" id="1369224">(</span><span class="ident" id="1369225">assoc</span><span class="op" id="1369230">,</span>&nbsp;<span class="ident" id="1369232">r</span><span class="op" id="1369233">.</span><span class="ident" id="1369234">comment</span><span class="op" id="1369241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369246">if</span>&nbsp;<span class="ident" id="1369249">r</span><span class="op" id="1369250">.</span><span class="ident" id="1369251">eol</span><span class="op" id="1369254">(</span><span class="op" id="1369255">)</span>&nbsp;<span class="op" id="1369257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369263">return</span>&nbsp;<span class="ident" id="1369270">cmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369278">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369283">r</span><span class="op" id="1369284">.</span><span class="ident" id="1369285">next</span><span class="op" id="1369289">(</span><span class="op" id="1369290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1369299">//&nbsp;update&nbsp;previous&nbsp;node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369325">p</span>&nbsp;<span class="op" id="1369327">=</span>&nbsp;<span class="ident" id="1369329">q</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369333">pend</span>&nbsp;<span class="op" id="1369338">=</span>&nbsp;<span class="ident" id="1369340">fset</span><span class="op" id="1369344">.</span><span class="ident" id="1369345">Position</span><span class="op" id="1369353">(</span><span class="ident" id="1369354">p</span><span class="op" id="1369355">.</span><span class="ident" id="1369356">End</span><span class="op" id="1369359">(</span><span class="op" id="1369360">)</span><span class="op" id="1369361">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1369366">//&nbsp;update&nbsp;previous&nbsp;node&nbsp;group&nbsp;if&nbsp;we&nbsp;see&nbsp;an&nbsp;&#34;important&#34;&nbsp;node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369428">switch</span>&nbsp;<span class="ident" id="1369435">q</span><span class="op" id="1369436">.</span><span class="op" id="1369437">(</span><span class="keyword" id="1369438">type</span><span class="op" id="1369442">)</span>&nbsp;<span class="op" id="1369444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369448">case</span>&nbsp;<span class="op" id="1369453">*</span><span class="ident" id="1369454">File</span><span class="op" id="1369458">,</span>&nbsp;<span class="op" id="1369460">*</span><span class="ident" id="1369461">Field</span><span class="op" id="1369466">,</span>&nbsp;<span class="ident" id="1369468">Decl</span><span class="op" id="1369472">,</span>&nbsp;<span class="ident" id="1369474">Spec</span><span class="op" id="1369478">,</span>&nbsp;<span class="ident" id="1369480">Stmt</span><span class="op" id="1369484">:</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369489">stack</span><span class="op" id="1369494">.</span><span class="ident" id="1369495">push</span><span class="op" id="1369499">(</span><span class="ident" id="1369500">q</span><span class="op" id="1369501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369512">return</span>&nbsp;<span class="ident" id="1369519">cmap</span><br>
<span class="lineno">240</span><span class="op" id="1369524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1369527">//&nbsp;Update&nbsp;replaces&nbsp;an&nbsp;old&nbsp;node&nbsp;in&nbsp;the&nbsp;comment&nbsp;map&nbsp;with&nbsp;the&nbsp;new&nbsp;node</span><br>
<span class="lineno"></span><span class="comment" id="1369595">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;new&nbsp;node.&nbsp;Comments&nbsp;that&nbsp;were&nbsp;associated&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1369663">//&nbsp;old&nbsp;node&nbsp;are&nbsp;associated&nbsp;with&nbsp;the&nbsp;new&nbsp;node.</span><br>
<span class="lineno">245</span><span class="comment" id="1369709">//</span><br>
<span class="lineno"></span><span class="keyword" id="1369712">func</span>&nbsp;<span class="op" id="1369717">(</span><span class="ident" id="1369718">cmap</span>&nbsp;<span class="ident" id="1369723">CommentMap</span><span class="op" id="1369733">)</span>&nbsp;<span class="ident" id="1369735">Update</span><span class="op" id="1369741">(</span><span class="ident" id="1369742">old</span><span class="op" id="1369745">,</span>&nbsp;<span class="builtinfunc" id="1369747">new</span>&nbsp;<span class="ident" id="1369751">Node</span><span class="op" id="1369755">)</span>&nbsp;<span class="ident" id="1369757">Node</span>&nbsp;<span class="op" id="1369762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369765">if</span>&nbsp;<span class="ident" id="1369768">list</span>&nbsp;<span class="op" id="1369773">:=</span>&nbsp;<span class="ident" id="1369776">cmap</span><span class="op" id="1369780">[</span><span class="ident" id="1369781">old</span><span class="op" id="1369784">]</span><span class="op" id="1369785">;</span>&nbsp;<span class="builtinfunc" id="1369787">len</span><span class="op" id="1369790">(</span><span class="ident" id="1369791">list</span><span class="op" id="1369795">)</span>&nbsp;<span class="op" id="1369797">&gt;</span>&nbsp;<span class="num" id="1369799">0</span>&nbsp;<span class="op" id="1369801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1369805">delete</span><span class="op" id="1369811">(</span><span class="ident" id="1369812">cmap</span><span class="op" id="1369816">,</span>&nbsp;<span class="ident" id="1369818">old</span><span class="op" id="1369821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1369825">cmap</span><span class="op" id="1369829">[</span><span class="builtinfunc" id="1369830">new</span><span class="op" id="1369833">]</span>&nbsp;<span class="op" id="1369835">=</span>&nbsp;<span class="builtinfunc" id="1369837">append</span><span class="op" id="1369843">(</span><span class="ident" id="1369844">cmap</span><span class="op" id="1369848">[</span><span class="builtinfunc" id="1369849">new</span><span class="op" id="1369852">]</span><span class="op" id="1369853">,</span>&nbsp;<span class="ident" id="1369855">list</span><span class="op" id="1369859">...</span><span class="op" id="1369862">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1369865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1369868">return</span>&nbsp;<span class="builtinfunc" id="1369875">new</span><br>
<span class="lineno"></span><span class="op" id="1369879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1369882">//&nbsp;Filter&nbsp;returns&nbsp;a&nbsp;new&nbsp;comment&nbsp;map&nbsp;consisting&nbsp;of&nbsp;only&nbsp;those</span><br>
<span class="lineno">255</span><span class="comment" id="1369943">//&nbsp;entries&nbsp;of&nbsp;cmap&nbsp;for&nbsp;which&nbsp;a&nbsp;corresponding&nbsp;node&nbsp;exists&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1370003">//&nbsp;the&nbsp;AST&nbsp;specified&nbsp;by&nbsp;node.</span><br>
<span class="lineno"></span><span class="comment" id="1370033">//</span><br>
<span class="lineno"></span><span class="keyword" id="1370036">func</span>&nbsp;<span class="op" id="1370041">(</span><span class="ident" id="1370042">cmap</span>&nbsp;<span class="ident" id="1370047">CommentMap</span><span class="op" id="1370057">)</span>&nbsp;<span class="ident" id="1370059">Filter</span><span class="op" id="1370065">(</span><span class="ident" id="1370066">node</span>&nbsp;<span class="ident" id="1370071">Node</span><span class="op" id="1370075">)</span>&nbsp;<span class="ident" id="1370077">CommentMap</span>&nbsp;<span class="op" id="1370088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370091">umap</span>&nbsp;<span class="op" id="1370096">:=</span>&nbsp;<span class="builtinfunc" id="1370099">make</span><span class="op" id="1370103">(</span><span class="ident" id="1370104">CommentMap</span><span class="op" id="1370114">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370117">Inspect</span><span class="op" id="1370124">(</span><span class="ident" id="1370125">node</span><span class="op" id="1370129">,</span>&nbsp;<span class="keyword" id="1370131">func</span><span class="op" id="1370135">(</span><span class="ident" id="1370136">n</span>&nbsp;<span class="ident" id="1370138">Node</span><span class="op" id="1370142">)</span>&nbsp;<span class="builtintype" id="1370144">bool</span>&nbsp;<span class="op" id="1370149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370153">if</span>&nbsp;<span class="ident" id="1370156">g</span>&nbsp;<span class="op" id="1370158">:=</span>&nbsp;<span class="ident" id="1370161">cmap</span><span class="op" id="1370165">[</span><span class="ident" id="1370166">n</span><span class="op" id="1370167">]</span><span class="op" id="1370168">;</span>&nbsp;<span class="builtinfunc" id="1370170">len</span><span class="op" id="1370173">(</span><span class="ident" id="1370174">g</span><span class="op" id="1370175">)</span>&nbsp;<span class="op" id="1370177">&gt;</span>&nbsp;<span class="num" id="1370179">0</span>&nbsp;<span class="op" id="1370181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370186">umap</span><span class="op" id="1370190">[</span><span class="ident" id="1370191">n</span><span class="op" id="1370192">]</span>&nbsp;<span class="op" id="1370194">=</span>&nbsp;<span class="ident" id="1370196">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1370200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370204">return</span>&nbsp;<span class="builtintype" id="1370211">true</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1370217">}</span><span class="op" id="1370218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370221">return</span>&nbsp;<span class="ident" id="1370228">umap</span><br>
<span class="lineno"></span><span class="op" id="1370233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1370236">//&nbsp;Comments&nbsp;returns&nbsp;the&nbsp;list&nbsp;of&nbsp;comment&nbsp;groups&nbsp;in&nbsp;the&nbsp;comment&nbsp;map.</span><br>
<span class="lineno">270</span><span class="comment" id="1370303">//&nbsp;The&nbsp;result&nbsp;is&nbsp;sorted&nbsp;is&nbsp;source&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="1370344">//</span><br>
<span class="lineno"></span><span class="keyword" id="1370347">func</span>&nbsp;<span class="op" id="1370352">(</span><span class="ident" id="1370353">cmap</span>&nbsp;<span class="ident" id="1370358">CommentMap</span><span class="op" id="1370368">)</span>&nbsp;<span class="ident" id="1370370">Comments</span><span class="op" id="1370378">(</span><span class="op" id="1370379">)</span>&nbsp;<span class="op" id="1370381">[</span><span class="op" id="1370382">]</span><span class="op" id="1370383">*</span><span class="ident" id="1370384">CommentGroup</span>&nbsp;<span class="op" id="1370397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370400">list</span>&nbsp;<span class="op" id="1370405">:=</span>&nbsp;<span class="builtinfunc" id="1370408">make</span><span class="op" id="1370412">(</span><span class="op" id="1370413">[</span><span class="op" id="1370414">]</span><span class="op" id="1370415">*</span><span class="ident" id="1370416">CommentGroup</span><span class="op" id="1370428">,</span>&nbsp;<span class="num" id="1370430">0</span><span class="op" id="1370431">,</span>&nbsp;<span class="builtinfunc" id="1370433">len</span><span class="op" id="1370436">(</span><span class="ident" id="1370437">cmap</span><span class="op" id="1370441">)</span><span class="op" id="1370442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370445">for</span>&nbsp;<span class="ident" id="1370449">_</span><span class="op" id="1370450">,</span>&nbsp;<span class="ident" id="1370452">e</span>&nbsp;<span class="op" id="1370454">:=</span>&nbsp;<span class="keyword" id="1370457">range</span>&nbsp;<span class="ident" id="1370463">cmap</span>&nbsp;<span class="op" id="1370468">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370472">list</span>&nbsp;<span class="op" id="1370477">=</span>&nbsp;<span class="builtinfunc" id="1370479">append</span><span class="op" id="1370485">(</span><span class="ident" id="1370486">list</span><span class="op" id="1370490">,</span>&nbsp;<span class="ident" id="1370492">e</span><span class="op" id="1370493">...</span><span class="op" id="1370496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1370499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370502">sortComments</span><span class="op" id="1370514">(</span><span class="ident" id="1370515">list</span><span class="op" id="1370519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370522">return</span>&nbsp;<span class="ident" id="1370529">list</span><br>
<span class="lineno"></span><span class="op" id="1370534">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="keyword" id="1370537">func</span>&nbsp;<span class="ident" id="1370542">summary</span><span class="op" id="1370549">(</span><span class="ident" id="1370550">list</span>&nbsp;<span class="op" id="1370555">[</span><span class="op" id="1370556">]</span><span class="op" id="1370557">*</span><span class="ident" id="1370558">CommentGroup</span><span class="op" id="1370570">)</span>&nbsp;<span class="builtintype" id="1370572">string</span>&nbsp;<span class="op" id="1370579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370582">const</span>&nbsp;<span class="ident" id="1370588">maxLen</span>&nbsp;<span class="op" id="1370595">=</span>&nbsp;<span class="num" id="1370597">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370601">var</span>&nbsp;<span class="ident" id="1370605">buf</span>&nbsp;<span class="ident" id="1370609">bytes</span><span class="op" id="1370614">.</span><span class="ident" id="1370615">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370624">//&nbsp;collect&nbsp;comments&nbsp;text</span><br>
<span class="lineno"></span><span class="ident" id="1370649">loop</span><span class="op" id="1370653">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370656">for</span>&nbsp;<span class="ident" id="1370660">_</span><span class="op" id="1370661">,</span>&nbsp;<span class="ident" id="1370663">group</span>&nbsp;<span class="op" id="1370669">:=</span>&nbsp;<span class="keyword" id="1370672">range</span>&nbsp;<span class="ident" id="1370678">list</span>&nbsp;<span class="op" id="1370683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370687">//&nbsp;Note:&nbsp;CommentGroup.Text()&nbsp;does&nbsp;too&nbsp;much&nbsp;work&nbsp;for&nbsp;what&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370749">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;need&nbsp;and&nbsp;would&nbsp;only&nbsp;replace&nbsp;this&nbsp;innermost&nbsp;loop.</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370809">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Just&nbsp;do&nbsp;it&nbsp;explicitly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370843">for</span>&nbsp;<span class="ident" id="1370847">_</span><span class="op" id="1370848">,</span>&nbsp;<span class="ident" id="1370850">comment</span>&nbsp;<span class="op" id="1370858">:=</span>&nbsp;<span class="keyword" id="1370861">range</span>&nbsp;<span class="ident" id="1370867">group</span><span class="op" id="1370872">.</span><span class="ident" id="1370873">List</span>&nbsp;<span class="op" id="1370878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370883">if</span>&nbsp;<span class="ident" id="1370886">buf</span><span class="op" id="1370889">.</span><span class="ident" id="1370890">Len</span><span class="op" id="1370893">(</span><span class="op" id="1370894">)</span>&nbsp;<span class="op" id="1370896">&gt;=</span>&nbsp;<span class="ident" id="1370899">maxLen</span>&nbsp;<span class="op" id="1370906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370912">break</span>&nbsp;<span class="ident" id="1370918">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1370926">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370931">buf</span><span class="op" id="1370934">.</span><span class="ident" id="1370935">WriteString</span><span class="op" id="1370946">(</span><span class="ident" id="1370947">comment</span><span class="op" id="1370954">.</span><span class="ident" id="1370955">Text</span><span class="op" id="1370959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1370963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1370966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370970">//&nbsp;truncate&nbsp;if&nbsp;too&nbsp;long</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1370995">if</span>&nbsp;<span class="ident" id="1370998">buf</span><span class="op" id="1371001">.</span><span class="ident" id="1371002">Len</span><span class="op" id="1371005">(</span><span class="op" id="1371006">)</span>&nbsp;<span class="op" id="1371008">&gt;</span>&nbsp;<span class="ident" id="1371010">maxLen</span>&nbsp;<span class="op" id="1371017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371021">buf</span><span class="op" id="1371024">.</span><span class="ident" id="1371025">Truncate</span><span class="op" id="1371033">(</span><span class="ident" id="1371034">maxLen</span>&nbsp;<span class="op" id="1371041">-</span>&nbsp;<span class="num" id="1371043">3</span><span class="op" id="1371044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371048">buf</span><span class="op" id="1371051">.</span><span class="ident" id="1371052">WriteString</span><span class="op" id="1371063">(</span><span class="string" id="1371064">&#34;...&#34;</span><span class="op" id="1371069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1371076">//&nbsp;replace&nbsp;any&nbsp;invisibles&nbsp;with&nbsp;blanks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371115">bytes</span>&nbsp;<span class="op" id="1371121">:=</span>&nbsp;<span class="ident" id="1371124">buf</span><span class="op" id="1371127">.</span><span class="ident" id="1371128">Bytes</span><span class="op" id="1371133">(</span><span class="op" id="1371134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371137">for</span>&nbsp;<span class="ident" id="1371141">i</span><span class="op" id="1371142">,</span>&nbsp;<span class="ident" id="1371144">b</span>&nbsp;<span class="op" id="1371146">:=</span>&nbsp;<span class="keyword" id="1371149">range</span>&nbsp;<span class="ident" id="1371155">bytes</span>&nbsp;<span class="op" id="1371161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371165">switch</span>&nbsp;<span class="ident" id="1371172">b</span>&nbsp;<span class="op" id="1371174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371178">case</span>&nbsp;<span class="string" id="1371183">&#39;\t&#39;</span><span class="op" id="1371187">,</span>&nbsp;<span class="string" id="1371189">&#39;\n&#39;</span><span class="op" id="1371193">,</span>&nbsp;<span class="string" id="1371195">&#39;\r&#39;</span><span class="op" id="1371199">:</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371204">bytes</span><span class="op" id="1371209">[</span><span class="ident" id="1371210">i</span><span class="op" id="1371211">]</span>&nbsp;<span class="op" id="1371213">=</span>&nbsp;<span class="string" id="1371215">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371228">return</span>&nbsp;<span class="builtintype" id="1371235">string</span><span class="op" id="1371241">(</span><span class="ident" id="1371242">bytes</span><span class="op" id="1371247">)</span><br>
<span class="lineno">315</span><span class="op" id="1371249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1371252">func</span>&nbsp;<span class="op" id="1371257">(</span><span class="ident" id="1371258">cmap</span>&nbsp;<span class="ident" id="1371263">CommentMap</span><span class="op" id="1371273">)</span>&nbsp;<span class="ident" id="1371275">String</span><span class="op" id="1371281">(</span><span class="op" id="1371282">)</span>&nbsp;<span class="builtintype" id="1371284">string</span>&nbsp;<span class="op" id="1371291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371294">var</span>&nbsp;<span class="ident" id="1371298">buf</span>&nbsp;<span class="ident" id="1371302">bytes</span><span class="op" id="1371307">.</span><span class="ident" id="1371308">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371316">fmt</span><span class="op" id="1371319">.</span><span class="ident" id="1371320">Fprintln</span><span class="op" id="1371328">(</span><span class="op" id="1371329">&amp;</span><span class="ident" id="1371330">buf</span><span class="op" id="1371333">,</span>&nbsp;<span class="string" id="1371335">&#34;CommentMap&nbsp;{&#34;</span><span class="op" id="1371349">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371352">for</span>&nbsp;<span class="ident" id="1371356">node</span><span class="op" id="1371360">,</span>&nbsp;<span class="ident" id="1371362">comment</span>&nbsp;<span class="op" id="1371370">:=</span>&nbsp;<span class="keyword" id="1371373">range</span>&nbsp;<span class="ident" id="1371379">cmap</span>&nbsp;<span class="op" id="1371384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1371388">//&nbsp;print&nbsp;name&nbsp;of&nbsp;identifiers;&nbsp;print&nbsp;node&nbsp;type&nbsp;for&nbsp;other&nbsp;nodes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371452">var</span>&nbsp;<span class="ident" id="1371456">s</span>&nbsp;<span class="builtintype" id="1371458">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371467">if</span>&nbsp;<span class="ident" id="1371470">ident</span><span class="op" id="1371475">,</span>&nbsp;<span class="ident" id="1371477">ok</span>&nbsp;<span class="op" id="1371480">:=</span>&nbsp;<span class="ident" id="1371483">node</span><span class="op" id="1371487">.</span><span class="op" id="1371488">(</span><span class="op" id="1371489">*</span><span class="ident" id="1371490">Ident</span><span class="op" id="1371495">)</span><span class="op" id="1371496">;</span>&nbsp;<span class="ident" id="1371498">ok</span>&nbsp;<span class="op" id="1371501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371506">s</span>&nbsp;<span class="op" id="1371508">=</span>&nbsp;<span class="ident" id="1371510">ident</span><span class="op" id="1371515">.</span><span class="ident" id="1371516">Name</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371523">}</span>&nbsp;<span class="keyword" id="1371525">else</span>&nbsp;<span class="op" id="1371530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371535">s</span>&nbsp;<span class="op" id="1371537">=</span>&nbsp;<span class="ident" id="1371539">fmt</span><span class="op" id="1371542">.</span><span class="ident" id="1371543">Sprintf</span><span class="op" id="1371550">(</span><span class="string" id="1371551">&#34;%T&#34;</span><span class="op" id="1371555">,</span>&nbsp;<span class="ident" id="1371557">node</span><span class="op" id="1371561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371569">fmt</span><span class="op" id="1371572">.</span><span class="ident" id="1371573">Fprintf</span><span class="op" id="1371580">(</span><span class="op" id="1371581">&amp;</span><span class="ident" id="1371582">buf</span><span class="op" id="1371585">,</span>&nbsp;<span class="string" id="1371587">&#34;\t%p&nbsp;&nbsp;%20s:&nbsp;&nbsp;%s\n&#34;</span><span class="op" id="1371606">,</span>&nbsp;<span class="ident" id="1371608">node</span><span class="op" id="1371612">,</span>&nbsp;<span class="ident" id="1371614">s</span><span class="op" id="1371615">,</span>&nbsp;<span class="ident" id="1371617">summary</span><span class="op" id="1371624">(</span><span class="ident" id="1371625">comment</span><span class="op" id="1371632">)</span><span class="op" id="1371633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371636">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371639">fmt</span><span class="op" id="1371642">.</span><span class="ident" id="1371643">Fprintln</span><span class="op" id="1371651">(</span><span class="op" id="1371652">&amp;</span><span class="ident" id="1371653">buf</span><span class="op" id="1371656">,</span>&nbsp;<span class="string" id="1371658">&#34;}&#34;</span><span class="op" id="1371661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371664">return</span>&nbsp;<span class="ident" id="1371671">buf</span><span class="op" id="1371674">.</span><span class="ident" id="1371675">String</span><span class="op" id="1371681">(</span><span class="op" id="1371682">)</span><br>
<span class="lineno"></span><span class="op" id="1371684">}</span>
</div>
</body>
</html>
