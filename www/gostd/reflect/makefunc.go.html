<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>reflect</h2>
<ul>
<li><a href="/gostd/reflect/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/reflect/deepequal.go.html">deepequal.go</a></li>
<li><a href="/gostd/reflect/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/reflect/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/reflect/makefunc.go.html">makefunc.go</a></li>
<li><a href="/gostd/reflect/set_test.go.html">set_test.go</a></li>
<li><a href="/gostd/reflect/tostring_test.go.html">tostring_test.go</a></li>
<li><a href="/gostd/reflect/type.go.html">type.go</a></li>
<li><a href="/gostd/reflect/value.go.html">value.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2660407">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2660463">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2660517">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2660568">//&nbsp;MakeFunc&nbsp;implementation.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2660597">package</span>&nbsp;<span class="ident" id="2660605">reflect</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2660614">import</span>&nbsp;<span class="op" id="2660621">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2660624">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2660633">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2660636">//&nbsp;makeFuncImpl&nbsp;is&nbsp;the&nbsp;closure&nbsp;value&nbsp;implementing&nbsp;the&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2660699">//&nbsp;returned&nbsp;by&nbsp;MakeFunc.</span><br>
<span class="lineno">15</span><span class="keyword" id="2660724">type</span>&nbsp;<span class="ident" id="2660729">makeFuncImpl</span>&nbsp;<span class="keyword" id="2660742">struct</span>&nbsp;<span class="op" id="2660749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2660752">code</span>&nbsp;&nbsp;<span class="builtintype" id="2660758">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2660767">stack</span>&nbsp;<span class="op" id="2660773">*</span><span class="ident" id="2660774">bitVector</span>&nbsp;<span class="comment" id="2660784">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2660836">typ</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2660842">*</span><span class="ident" id="2660843">funcType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2660853">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2660859">func</span><span class="op" id="2660863">(</span><span class="op" id="2660864">[</span><span class="op" id="2660865">]</span><span class="ident" id="2660866">Value</span><span class="op" id="2660871">)</span>&nbsp;<span class="op" id="2660873">[</span><span class="op" id="2660874">]</span><span class="ident" id="2660875">Value</span><br>
<span class="lineno">20</span><span class="op" id="2660881">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2660884">//&nbsp;MakeFunc&nbsp;returns&nbsp;a&nbsp;new&nbsp;function&nbsp;of&nbsp;the&nbsp;given&nbsp;Type</span><br>
<span class="lineno"></span><span class="comment" id="2660937">//&nbsp;that&nbsp;wraps&nbsp;the&nbsp;function&nbsp;fn.&nbsp;When&nbsp;called,&nbsp;that&nbsp;new&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2660999">//&nbsp;does&nbsp;the&nbsp;following:</span><br>
<span class="lineno">25</span><span class="comment" id="2661022">//</span><br>
<span class="lineno"></span><span class="comment" id="2661025">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;converts&nbsp;its&nbsp;arguments&nbsp;to&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values.</span><br>
<span class="lineno"></span><span class="comment" id="2661075">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;runs&nbsp;results&nbsp;:=&nbsp;fn(args).</span><br>
<span class="lineno"></span><span class="comment" id="2661106">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;returns&nbsp;the&nbsp;results&nbsp;as&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values,&nbsp;one&nbsp;per&nbsp;formal&nbsp;result.</span><br>
<span class="lineno"></span><span class="comment" id="2661176">//</span><br>
<span class="lineno">30</span><span class="comment" id="2661179">//&nbsp;The&nbsp;implementation&nbsp;fn&nbsp;can&nbsp;assume&nbsp;that&nbsp;the&nbsp;argument&nbsp;Value&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="2661245">//&nbsp;has&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;arguments&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2661299">//&nbsp;If&nbsp;typ&nbsp;describes&nbsp;a&nbsp;variadic&nbsp;function,&nbsp;the&nbsp;final&nbsp;Value&nbsp;is&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2661366">//&nbsp;a&nbsp;slice&nbsp;representing&nbsp;the&nbsp;variadic&nbsp;arguments,&nbsp;as&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2661424">//&nbsp;body&nbsp;of&nbsp;a&nbsp;variadic&nbsp;function.&nbsp;The&nbsp;result&nbsp;Value&nbsp;slice&nbsp;returned&nbsp;by&nbsp;fn</span><br>
<span class="lineno">35</span><span class="comment" id="2661494">//&nbsp;must&nbsp;have&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;results&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2661552">//</span><br>
<span class="lineno"></span><span class="comment" id="2661555">//&nbsp;The&nbsp;Value.Call&nbsp;method&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;invoke&nbsp;a&nbsp;typed&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2661625">//&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values;&nbsp;in&nbsp;contrast,&nbsp;MakeFunc&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;implement</span><br>
<span class="lineno"></span><span class="comment" id="2661701">//&nbsp;a&nbsp;typed&nbsp;function&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values.</span><br>
<span class="lineno">40</span><span class="comment" id="2661741">//</span><br>
<span class="lineno"></span><span class="comment" id="2661744">//&nbsp;The&nbsp;Examples&nbsp;section&nbsp;of&nbsp;the&nbsp;documentation&nbsp;includes&nbsp;an&nbsp;illustration</span><br>
<span class="lineno"></span><span class="comment" id="2661814">//&nbsp;of&nbsp;how&nbsp;to&nbsp;use&nbsp;MakeFunc&nbsp;to&nbsp;build&nbsp;a&nbsp;swap&nbsp;function&nbsp;for&nbsp;different&nbsp;types.</span><br>
<span class="lineno"></span><span class="comment" id="2661886">//</span><br>
<span class="lineno"></span><span class="keyword" id="2661889">func</span>&nbsp;<span class="ident" id="2661894">MakeFunc</span><span class="op" id="2661902">(</span><span class="ident" id="2661903">typ</span>&nbsp;<span class="ident" id="2661907">Type</span><span class="op" id="2661911">,</span>&nbsp;<span class="ident" id="2661913">fn</span>&nbsp;<span class="keyword" id="2661916">func</span><span class="op" id="2661920">(</span><span class="ident" id="2661921">args</span>&nbsp;<span class="op" id="2661926">[</span><span class="op" id="2661927">]</span><span class="ident" id="2661928">Value</span><span class="op" id="2661933">)</span>&nbsp;<span class="op" id="2661935">(</span><span class="ident" id="2661936">results</span>&nbsp;<span class="op" id="2661944">[</span><span class="op" id="2661945">]</span><span class="ident" id="2661946">Value</span><span class="op" id="2661951">)</span><span class="op" id="2661952">)</span>&nbsp;<span class="ident" id="2661954">Value</span>&nbsp;<span class="op" id="2661960">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2661963">if</span>&nbsp;<span class="ident" id="2661966">typ</span><span class="op" id="2661969">.</span><span class="ident" id="2661970">Kind</span><span class="op" id="2661974">(</span><span class="op" id="2661975">)</span>&nbsp;<span class="op" id="2661977">!=</span>&nbsp;<span class="ident" id="2661980">Func</span>&nbsp;<span class="op" id="2661985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2661989">panic</span><span class="op" id="2661994">(</span><span class="string" id="2661995">&#34;reflect:&nbsp;call&nbsp;of&nbsp;MakeFunc&nbsp;with&nbsp;non-Func&nbsp;type&#34;</span><span class="op" id="2662041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2662044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662048">t</span>&nbsp;<span class="op" id="2662050">:=</span>&nbsp;<span class="ident" id="2662053">typ</span><span class="op" id="2662056">.</span><span class="ident" id="2662057">common</span><span class="op" id="2662063">(</span><span class="op" id="2662064">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662067">ftyp</span>&nbsp;<span class="op" id="2662072">:=</span>&nbsp;<span class="op" id="2662075">(</span><span class="op" id="2662076">*</span><span class="ident" id="2662077">funcType</span><span class="op" id="2662085">)</span><span class="op" id="2662086">(</span><span class="ident" id="2662087">unsafe</span><span class="op" id="2662093">.</span><span class="ident" id="2662094">Pointer</span><span class="op" id="2662101">(</span><span class="ident" id="2662102">t</span><span class="op" id="2662103">)</span><span class="op" id="2662104">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2662108">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2662153">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2662208">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662268">dummy</span>&nbsp;<span class="op" id="2662274">:=</span>&nbsp;<span class="ident" id="2662277">makeFuncStub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662291">code</span>&nbsp;<span class="op" id="2662296">:=</span>&nbsp;<span class="op" id="2662299">*</span><span class="op" id="2662300">*</span><span class="op" id="2662301">(</span><span class="op" id="2662302">*</span><span class="op" id="2662303">*</span><span class="builtintype" id="2662304">uintptr</span><span class="op" id="2662311">)</span><span class="op" id="2662312">(</span><span class="ident" id="2662313">unsafe</span><span class="op" id="2662319">.</span><span class="ident" id="2662320">Pointer</span><span class="op" id="2662327">(</span><span class="op" id="2662328">&amp;</span><span class="ident" id="2662329">dummy</span><span class="op" id="2662334">)</span><span class="op" id="2662335">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2662339">//&nbsp;makeFuncImpl&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662400">_</span><span class="op" id="2662401">,</span>&nbsp;<span class="ident" id="2662403">_</span><span class="op" id="2662404">,</span>&nbsp;<span class="ident" id="2662406">_</span><span class="op" id="2662407">,</span>&nbsp;<span class="ident" id="2662409">stack</span>&nbsp;<span class="op" id="2662415">:=</span>&nbsp;<span class="ident" id="2662418">funcLayout</span><span class="op" id="2662428">(</span><span class="ident" id="2662429">t</span><span class="op" id="2662430">,</span>&nbsp;<span class="ident" id="2662432">nil</span><span class="op" id="2662435">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662439">impl</span>&nbsp;<span class="op" id="2662444">:=</span>&nbsp;<span class="op" id="2662447">&amp;</span><span class="ident" id="2662448">makeFuncImpl</span><span class="op" id="2662460">{</span><span class="ident" id="2662461">code</span><span class="op" id="2662465">:</span>&nbsp;<span class="ident" id="2662467">code</span><span class="op" id="2662471">,</span>&nbsp;<span class="ident" id="2662473">stack</span><span class="op" id="2662478">:</span>&nbsp;<span class="ident" id="2662480">stack</span><span class="op" id="2662485">,</span>&nbsp;<span class="ident" id="2662487">typ</span><span class="op" id="2662490">:</span>&nbsp;<span class="ident" id="2662492">ftyp</span><span class="op" id="2662496">,</span>&nbsp;<span class="ident" id="2662498">fn</span><span class="op" id="2662500">:</span>&nbsp;<span class="ident" id="2662502">fn</span><span class="op" id="2662504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2662508">return</span>&nbsp;<span class="ident" id="2662515">Value</span><span class="op" id="2662520">{</span><span class="ident" id="2662521">t</span><span class="op" id="2662522">,</span>&nbsp;<span class="ident" id="2662524">unsafe</span><span class="op" id="2662530">.</span><span class="ident" id="2662531">Pointer</span><span class="op" id="2662538">(</span><span class="ident" id="2662539">impl</span><span class="op" id="2662543">)</span><span class="op" id="2662544">,</span>&nbsp;<span class="ident" id="2662546">flag</span><span class="op" id="2662550">(</span><span class="ident" id="2662551">Func</span><span class="op" id="2662555">)</span><span class="op" id="2662556">}</span><br>
<span class="lineno"></span><span class="op" id="2662558">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2662561">//&nbsp;makeFuncStub&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2662626">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;MakeFunc.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*callReflectFunc</span><br>
<span class="lineno"></span><span class="comment" id="2662696">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callReflect(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2662774">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno">70</span><span class="comment" id="2662848">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2662889">func</span>&nbsp;<span class="ident" id="2662894">makeFuncStub</span><span class="op" id="2662906">(</span><span class="op" id="2662907">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2662910">type</span>&nbsp;<span class="ident" id="2662915">methodValue</span>&nbsp;<span class="keyword" id="2662927">struct</span>&nbsp;<span class="op" id="2662934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662937">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2662944">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2662953">stack</span>&nbsp;&nbsp;<span class="op" id="2662960">*</span><span class="ident" id="2662961">bitVector</span>&nbsp;<span class="comment" id="2662971">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2663023">method</span>&nbsp;<span class="builtintype" id="2663030">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2663035">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2663042">Value</span><br>
<span class="lineno"></span><span class="op" id="2663048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="2663051">//&nbsp;makeMethodValue&nbsp;converts&nbsp;v&nbsp;from&nbsp;the&nbsp;rcvr+method&nbsp;index&nbsp;representation</span><br>
<span class="lineno"></span><span class="comment" id="2663123">//&nbsp;of&nbsp;a&nbsp;method&nbsp;value&nbsp;to&nbsp;an&nbsp;actual&nbsp;method&nbsp;func&nbsp;value,&nbsp;which&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2663185">//&nbsp;basically&nbsp;the&nbsp;receiver&nbsp;value&nbsp;with&nbsp;a&nbsp;special&nbsp;bit&nbsp;set,&nbsp;into&nbsp;a&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="2663253">//&nbsp;func&nbsp;value&nbsp;-&nbsp;a&nbsp;value&nbsp;holding&nbsp;an&nbsp;actual&nbsp;func.&nbsp;The&nbsp;output&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2663315">//&nbsp;semantically&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;input&nbsp;as&nbsp;far&nbsp;as&nbsp;the&nbsp;user&nbsp;of&nbsp;package</span><br>
<span class="lineno">85</span><span class="comment" id="2663385">//&nbsp;reflect&nbsp;can&nbsp;tell,&nbsp;but&nbsp;the&nbsp;true&nbsp;func&nbsp;representation&nbsp;can&nbsp;be&nbsp;handled</span><br>
<span class="lineno"></span><span class="comment" id="2663454">//&nbsp;by&nbsp;code&nbsp;like&nbsp;Convert&nbsp;and&nbsp;Interface&nbsp;and&nbsp;Assign.</span><br>
<span class="lineno"></span><span class="keyword" id="2663504">func</span>&nbsp;<span class="ident" id="2663509">makeMethodValue</span><span class="op" id="2663524">(</span><span class="ident" id="2663525">op</span>&nbsp;<span class="builtintype" id="2663528">string</span><span class="op" id="2663534">,</span>&nbsp;<span class="ident" id="2663536">v</span>&nbsp;<span class="ident" id="2663538">Value</span><span class="op" id="2663543">)</span>&nbsp;<span class="ident" id="2663545">Value</span>&nbsp;<span class="op" id="2663551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2663554">if</span>&nbsp;<span class="ident" id="2663557">v</span><span class="op" id="2663558">.</span><span class="ident" id="2663559">flag</span><span class="op" id="2663563">&amp;</span><span class="ident" id="2663564">flagMethod</span>&nbsp;<span class="op" id="2663575">==</span>&nbsp;<span class="num" id="2663578">0</span>&nbsp;<span class="op" id="2663580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2663584">panic</span><span class="op" id="2663589">(</span><span class="string" id="2663590">&#34;reflect:&nbsp;internal&nbsp;error:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;makeMethodValue&#34;</span><span class="op" id="2663647">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2663650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2663654">//&nbsp;Ignoring&nbsp;the&nbsp;flagMethod&nbsp;bit,&nbsp;v&nbsp;describes&nbsp;the&nbsp;receiver,&nbsp;not&nbsp;the&nbsp;method&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2663734">fl</span>&nbsp;<span class="op" id="2663737">:=</span>&nbsp;<span class="ident" id="2663740">v</span><span class="op" id="2663741">.</span><span class="ident" id="2663742">flag</span>&nbsp;<span class="op" id="2663747">&amp;</span>&nbsp;<span class="op" id="2663749">(</span><span class="ident" id="2663750">flagRO</span>&nbsp;<span class="op" id="2663757">|</span>&nbsp;<span class="ident" id="2663759">flagAddr</span>&nbsp;<span class="op" id="2663768">|</span>&nbsp;<span class="ident" id="2663770">flagIndir</span><span class="op" id="2663779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2663782">fl</span>&nbsp;<span class="op" id="2663785">|=</span>&nbsp;<span class="ident" id="2663788">flag</span><span class="op" id="2663792">(</span><span class="ident" id="2663793">v</span><span class="op" id="2663794">.</span><span class="ident" id="2663795">typ</span><span class="op" id="2663798">.</span><span class="ident" id="2663799">Kind</span><span class="op" id="2663803">(</span><span class="op" id="2663804">)</span><span class="op" id="2663805">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2663808">rcvr</span>&nbsp;<span class="op" id="2663813">:=</span>&nbsp;<span class="ident" id="2663816">Value</span><span class="op" id="2663821">{</span><span class="ident" id="2663822">v</span><span class="op" id="2663823">.</span><span class="ident" id="2663824">typ</span><span class="op" id="2663827">,</span>&nbsp;<span class="ident" id="2663829">v</span><span class="op" id="2663830">.</span><span class="ident" id="2663831">ptr</span><span class="op" id="2663834">,</span>&nbsp;<span class="ident" id="2663836">fl</span><span class="op" id="2663838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2663842">//&nbsp;v.Type&nbsp;returns&nbsp;the&nbsp;actual&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2663898">funcType</span>&nbsp;<span class="op" id="2663907">:=</span>&nbsp;<span class="ident" id="2663910">v</span><span class="op" id="2663911">.</span><span class="ident" id="2663912">Type</span><span class="op" id="2663916">(</span><span class="op" id="2663917">)</span><span class="op" id="2663918">.</span><span class="op" id="2663919">(</span><span class="op" id="2663920">*</span><span class="ident" id="2663921">rtype</span><span class="op" id="2663926">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2663930">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2663975">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2664030">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2664090">dummy</span>&nbsp;<span class="op" id="2664096">:=</span>&nbsp;<span class="ident" id="2664099">methodValueCall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2664116">code</span>&nbsp;<span class="op" id="2664121">:=</span>&nbsp;<span class="op" id="2664124">*</span><span class="op" id="2664125">*</span><span class="op" id="2664126">(</span><span class="op" id="2664127">*</span><span class="op" id="2664128">*</span><span class="builtintype" id="2664129">uintptr</span><span class="op" id="2664136">)</span><span class="op" id="2664137">(</span><span class="ident" id="2664138">unsafe</span><span class="op" id="2664144">.</span><span class="ident" id="2664145">Pointer</span><span class="op" id="2664152">(</span><span class="op" id="2664153">&amp;</span><span class="ident" id="2664154">dummy</span><span class="op" id="2664159">)</span><span class="op" id="2664160">)</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2664164">//&nbsp;methodValue&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2664224">_</span><span class="op" id="2664225">,</span>&nbsp;<span class="ident" id="2664227">_</span><span class="op" id="2664228">,</span>&nbsp;<span class="ident" id="2664230">_</span><span class="op" id="2664231">,</span>&nbsp;<span class="ident" id="2664233">stack</span>&nbsp;<span class="op" id="2664239">:=</span>&nbsp;<span class="ident" id="2664242">funcLayout</span><span class="op" id="2664252">(</span><span class="ident" id="2664253">funcType</span><span class="op" id="2664261">,</span>&nbsp;<span class="ident" id="2664263">nil</span><span class="op" id="2664266">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2664270">fv</span>&nbsp;<span class="op" id="2664273">:=</span>&nbsp;<span class="op" id="2664276">&amp;</span><span class="ident" id="2664277">methodValue</span><span class="op" id="2664288">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2664292">fn</span><span class="op" id="2664294">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2664300">code</span><span class="op" id="2664304">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2664308">stack</span><span class="op" id="2664313">:</span>&nbsp;&nbsp;<span class="ident" id="2664316">stack</span><span class="op" id="2664321">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2664325">method</span><span class="op" id="2664331">:</span>&nbsp;<span class="builtintype" id="2664333">int</span><span class="op" id="2664336">(</span><span class="ident" id="2664337">v</span><span class="op" id="2664338">.</span><span class="ident" id="2664339">flag</span><span class="op" id="2664343">)</span>&nbsp;<span class="op" id="2664345">&gt;&gt;</span>&nbsp;<span class="ident" id="2664348">flagMethodShift</span><span class="op" id="2664363">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2664367">rcvr</span><span class="op" id="2664371">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2664375">rcvr</span><span class="op" id="2664379">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2664382">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2664386">//&nbsp;Cause&nbsp;panic&nbsp;if&nbsp;method&nbsp;is&nbsp;not&nbsp;appropriate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2664432">//&nbsp;The&nbsp;panic&nbsp;would&nbsp;still&nbsp;happen&nbsp;during&nbsp;the&nbsp;call&nbsp;if&nbsp;we&nbsp;omit&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2664498">//&nbsp;but&nbsp;we&nbsp;want&nbsp;Interface()&nbsp;and&nbsp;other&nbsp;operations&nbsp;to&nbsp;fail&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2664562">methodReceiver</span><span class="op" id="2664576">(</span><span class="ident" id="2664577">op</span><span class="op" id="2664579">,</span>&nbsp;<span class="ident" id="2664581">fv</span><span class="op" id="2664583">.</span><span class="ident" id="2664584">rcvr</span><span class="op" id="2664588">,</span>&nbsp;<span class="ident" id="2664590">fv</span><span class="op" id="2664592">.</span><span class="ident" id="2664593">method</span><span class="op" id="2664599">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2664603">return</span>&nbsp;<span class="ident" id="2664610">Value</span><span class="op" id="2664615">{</span><span class="ident" id="2664616">funcType</span><span class="op" id="2664624">,</span>&nbsp;<span class="ident" id="2664626">unsafe</span><span class="op" id="2664632">.</span><span class="ident" id="2664633">Pointer</span><span class="op" id="2664640">(</span><span class="ident" id="2664641">fv</span><span class="op" id="2664643">)</span><span class="op" id="2664644">,</span>&nbsp;<span class="ident" id="2664646">v</span><span class="op" id="2664647">.</span><span class="ident" id="2664648">flag</span><span class="op" id="2664652">&amp;</span><span class="ident" id="2664653">flagRO</span>&nbsp;<span class="op" id="2664660">|</span>&nbsp;<span class="ident" id="2664662">flag</span><span class="op" id="2664666">(</span><span class="ident" id="2664667">Func</span><span class="op" id="2664671">)</span><span class="op" id="2664672">}</span><br>
<span class="lineno"></span><span class="op" id="2664674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2664677">//&nbsp;methodValueCall&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno">125</span><span class="comment" id="2664745">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;makeMethodValue.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*methodValue</span><br>
<span class="lineno"></span><span class="comment" id="2664818">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callMethod(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2664895">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="2664969">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2665010">func</span>&nbsp;<span class="ident" id="2665015">methodValueCall</span><span class="op" id="2665030">(</span><span class="op" id="2665031">)</span>
</div>
</body>
</html>
