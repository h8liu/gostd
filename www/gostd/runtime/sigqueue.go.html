<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1878590">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1878645">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1878699">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1878750">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;runtime&nbsp;support&nbsp;for&nbsp;signal&nbsp;handling.</span><br>
<span class="lineno"></span><span class="comment" id="1878811">//</span><br>
<span class="lineno"></span><span class="comment" id="1878814">//&nbsp;Most&nbsp;synchronization&nbsp;primitives&nbsp;are&nbsp;not&nbsp;available&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="1878872">//&nbsp;the&nbsp;signal&nbsp;handler&nbsp;(it&nbsp;cannot&nbsp;block,&nbsp;allocate&nbsp;memory,&nbsp;or&nbsp;use&nbsp;locks)</span><br>
<span class="lineno"></span><span class="comment" id="1878943">//&nbsp;so&nbsp;the&nbsp;handler&nbsp;communicates&nbsp;with&nbsp;a&nbsp;processing&nbsp;goroutine</span><br>
<span class="lineno">10</span><span class="comment" id="1879002">//&nbsp;via&nbsp;struct&nbsp;sig,&nbsp;below.</span><br>
<span class="lineno"></span><span class="comment" id="1879028">//</span><br>
<span class="lineno"></span><span class="comment" id="1879031">//&nbsp;sigsend&nbsp;is&nbsp;called&nbsp;by&nbsp;the&nbsp;signal&nbsp;handler&nbsp;to&nbsp;queue&nbsp;a&nbsp;new&nbsp;signal.</span><br>
<span class="lineno"></span><span class="comment" id="1879097">//&nbsp;signal_recv&nbsp;is&nbsp;called&nbsp;by&nbsp;the&nbsp;Go&nbsp;program&nbsp;to&nbsp;receive&nbsp;a&nbsp;newly&nbsp;queued&nbsp;signal.</span><br>
<span class="lineno"></span><span class="comment" id="1879174">//&nbsp;Synchronization&nbsp;between&nbsp;sigsend&nbsp;and&nbsp;signal_recv&nbsp;is&nbsp;based&nbsp;on&nbsp;the&nbsp;sig.state</span><br>
<span class="lineno">15</span><span class="comment" id="1879251">//&nbsp;variable.&nbsp;&nbsp;It&nbsp;can&nbsp;be&nbsp;in&nbsp;3&nbsp;states:&nbsp;sigIdle,&nbsp;sigReceiving&nbsp;and&nbsp;sigSending.</span><br>
<span class="lineno"></span><span class="comment" id="1879326">//&nbsp;sigReceiving&nbsp;means&nbsp;that&nbsp;signal_recv&nbsp;is&nbsp;blocked&nbsp;on&nbsp;sig.Note&nbsp;and&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="1879405">//&nbsp;new&nbsp;pending&nbsp;signals.</span><br>
<span class="lineno"></span><span class="comment" id="1879429">//&nbsp;sigSending&nbsp;means&nbsp;that&nbsp;sig.mask&nbsp;*may*&nbsp;contain&nbsp;new&nbsp;pending&nbsp;signals,</span><br>
<span class="lineno"></span><span class="comment" id="1879498">//&nbsp;signal_recv&nbsp;can&#39;t&nbsp;be&nbsp;blocked&nbsp;in&nbsp;this&nbsp;state.</span><br>
<span class="lineno">20</span><span class="comment" id="1879545">//&nbsp;sigIdle&nbsp;means&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;new&nbsp;pending&nbsp;signals&nbsp;and&nbsp;signal_recv&nbsp;is&nbsp;not&nbsp;blocked.</span><br>
<span class="lineno"></span><span class="comment" id="1879632">//&nbsp;Transitions&nbsp;between&nbsp;states&nbsp;are&nbsp;done&nbsp;atomically&nbsp;with&nbsp;CAS.</span><br>
<span class="lineno"></span><span class="comment" id="1879692">//&nbsp;When&nbsp;signal_recv&nbsp;is&nbsp;unblocked,&nbsp;it&nbsp;resets&nbsp;sig.Note&nbsp;and&nbsp;rechecks&nbsp;sig.mask.</span><br>
<span class="lineno"></span><span class="comment" id="1879768">//&nbsp;If&nbsp;several&nbsp;sigsends&nbsp;and&nbsp;signal_recv&nbsp;execute&nbsp;concurrently,&nbsp;it&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1879844">//&nbsp;unnecessary&nbsp;rechecks&nbsp;of&nbsp;sig.mask,&nbsp;but&nbsp;it&nbsp;cannot&nbsp;lead&nbsp;to&nbsp;missed&nbsp;signals</span><br>
<span class="lineno">25</span><span class="comment" id="1879918">//&nbsp;nor&nbsp;deadlocks.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1879937">package</span>&nbsp;<span class="ident" id="1879945">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1879954">import</span>&nbsp;<span class="string" id="1879961">&#34;unsafe&#34;</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="1879971">var</span>&nbsp;<span class="ident" id="1879975">sig</span>&nbsp;<span class="keyword" id="1879979">struct</span>&nbsp;<span class="op" id="1879986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1879989">note</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1879996">note</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880002">mask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1880009">[</span><span class="op" id="1880010">(</span><span class="ident" id="1880011">_NSIG</span>&nbsp;<span class="op" id="1880017">+</span>&nbsp;<span class="num" id="1880019">31</span><span class="op" id="1880021">)</span>&nbsp;<span class="op" id="1880023">/</span>&nbsp;<span class="num" id="1880025">32</span><span class="op" id="1880027">]</span><span class="builtintype" id="1880028">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880036">wanted</span>&nbsp;<span class="op" id="1880043">[</span><span class="op" id="1880044">(</span><span class="ident" id="1880045">_NSIG</span>&nbsp;<span class="op" id="1880051">+</span>&nbsp;<span class="num" id="1880053">31</span><span class="op" id="1880055">)</span>&nbsp;<span class="op" id="1880057">/</span>&nbsp;<span class="num" id="1880059">32</span><span class="op" id="1880061">]</span><span class="builtintype" id="1880062">uint32</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880070">recv</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1880077">[</span><span class="op" id="1880078">(</span><span class="ident" id="1880079">_NSIG</span>&nbsp;<span class="op" id="1880085">+</span>&nbsp;<span class="num" id="1880087">31</span><span class="op" id="1880089">)</span>&nbsp;<span class="op" id="1880091">/</span>&nbsp;<span class="num" id="1880093">32</span><span class="op" id="1880095">]</span><span class="builtintype" id="1880096">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880104">state</span>&nbsp;&nbsp;<span class="builtintype" id="1880111">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880119">inuse</span>&nbsp;&nbsp;<span class="builtintype" id="1880126">bool</span><br>
<span class="lineno"></span><span class="op" id="1880131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="1880134">const</span>&nbsp;<span class="op" id="1880140">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880143">sigIdle</span>&nbsp;<span class="op" id="1880151">=</span>&nbsp;<span class="ident" id="1880153">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880159">sigReceiving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880173">sigSending</span><br>
<span class="lineno"></span><span class="op" id="1880184">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="1880187">//&nbsp;Called&nbsp;from&nbsp;sighandler&nbsp;to&nbsp;send&nbsp;a&nbsp;signal&nbsp;back&nbsp;out&nbsp;of&nbsp;the&nbsp;signal&nbsp;handling&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1880270">//&nbsp;Reports&nbsp;whether&nbsp;the&nbsp;signal&nbsp;was&nbsp;sent.&nbsp;If&nbsp;not,&nbsp;the&nbsp;caller&nbsp;typically&nbsp;crashes&nbsp;the&nbsp;program.</span><br>
<span class="lineno"></span><span class="keyword" id="1880360">func</span>&nbsp;<span class="ident" id="1880365">sigsend</span><span class="op" id="1880372">(</span><span class="ident" id="1880373">s</span>&nbsp;<span class="builtintype" id="1880375">int32</span><span class="op" id="1880380">)</span>&nbsp;<span class="builtintype" id="1880382">bool</span>&nbsp;<span class="op" id="1880387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880390">bit</span>&nbsp;<span class="op" id="1880394">:=</span>&nbsp;<span class="builtintype" id="1880397">uint32</span><span class="op" id="1880403">(</span><span class="num" id="1880404">1</span><span class="op" id="1880405">)</span>&nbsp;<span class="op" id="1880407">&lt;&lt;</span>&nbsp;<span class="builtintype" id="1880410">uint</span><span class="op" id="1880414">(</span><span class="ident" id="1880415">s</span><span class="op" id="1880416">&amp;</span><span class="num" id="1880417">31</span><span class="op" id="1880419">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880422">if</span>&nbsp;<span class="op" id="1880425">!</span><span class="ident" id="1880426">sig</span><span class="op" id="1880429">.</span><span class="ident" id="1880430">inuse</span>&nbsp;<span class="op" id="1880436">||</span>&nbsp;<span class="ident" id="1880439">s</span>&nbsp;<span class="op" id="1880441">&lt;</span>&nbsp;<span class="num" id="1880443">0</span>&nbsp;<span class="op" id="1880445">||</span>&nbsp;<span class="builtintype" id="1880448">int</span><span class="op" id="1880451">(</span><span class="ident" id="1880452">s</span><span class="op" id="1880453">)</span>&nbsp;<span class="op" id="1880455">&gt;=</span>&nbsp;<span class="num" id="1880458">32</span><span class="op" id="1880460">*</span><span class="builtinfunc" id="1880461">len</span><span class="op" id="1880464">(</span><span class="ident" id="1880465">sig</span><span class="op" id="1880468">.</span><span class="ident" id="1880469">wanted</span><span class="op" id="1880475">)</span>&nbsp;<span class="op" id="1880477">||</span>&nbsp;<span class="ident" id="1880480">sig</span><span class="op" id="1880483">.</span><span class="ident" id="1880484">wanted</span><span class="op" id="1880490">[</span><span class="ident" id="1880491">s</span><span class="op" id="1880492">/</span><span class="num" id="1880493">32</span><span class="op" id="1880495">]</span><span class="op" id="1880496">&amp;</span><span class="ident" id="1880497">bit</span>&nbsp;<span class="op" id="1880501">==</span>&nbsp;<span class="num" id="1880504">0</span>&nbsp;<span class="op" id="1880506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880510">return</span>&nbsp;<span class="builtintype" id="1880517">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1880524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1880528">//&nbsp;Add&nbsp;signal&nbsp;to&nbsp;outgoing&nbsp;queue.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880562">for</span>&nbsp;<span class="op" id="1880566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880570">mask</span>&nbsp;<span class="op" id="1880575">:=</span>&nbsp;<span class="ident" id="1880578">sig</span><span class="op" id="1880581">.</span><span class="ident" id="1880582">mask</span><span class="op" id="1880586">[</span><span class="ident" id="1880587">s</span><span class="op" id="1880588">/</span><span class="num" id="1880589">32</span><span class="op" id="1880591">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880595">if</span>&nbsp;<span class="ident" id="1880598">mask</span><span class="op" id="1880602">&amp;</span><span class="ident" id="1880603">bit</span>&nbsp;<span class="op" id="1880607">!=</span>&nbsp;<span class="num" id="1880610">0</span>&nbsp;<span class="op" id="1880612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880617">return</span>&nbsp;<span class="builtintype" id="1880624">true</span>&nbsp;<span class="comment" id="1880629">//&nbsp;signal&nbsp;already&nbsp;in&nbsp;queue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1880658">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880662">if</span>&nbsp;<span class="ident" id="1880665">cas</span><span class="op" id="1880668">(</span><span class="op" id="1880669">&amp;</span><span class="ident" id="1880670">sig</span><span class="op" id="1880673">.</span><span class="ident" id="1880674">mask</span><span class="op" id="1880678">[</span><span class="ident" id="1880679">s</span><span class="op" id="1880680">/</span><span class="num" id="1880681">32</span><span class="op" id="1880683">]</span><span class="op" id="1880684">,</span>&nbsp;<span class="ident" id="1880686">mask</span><span class="op" id="1880690">,</span>&nbsp;<span class="ident" id="1880692">mask</span><span class="op" id="1880696">|</span><span class="ident" id="1880697">bit</span><span class="op" id="1880700">)</span>&nbsp;<span class="op" id="1880702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880707">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1880715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1880718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1880722">//&nbsp;Notify&nbsp;receiver&nbsp;that&nbsp;queue&nbsp;has&nbsp;new&nbsp;bit.</span><br>
<span class="lineno"></span><span class="ident" id="1880765">Send</span><span class="op" id="1880769">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880772">for</span>&nbsp;<span class="op" id="1880776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880780">switch</span>&nbsp;<span class="ident" id="1880787">atomicload</span><span class="op" id="1880797">(</span><span class="op" id="1880798">&amp;</span><span class="ident" id="1880799">sig</span><span class="op" id="1880802">.</span><span class="ident" id="1880803">state</span><span class="op" id="1880808">)</span>&nbsp;<span class="op" id="1880810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880814">default</span><span class="op" id="1880821">:</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880826">gothrow</span><span class="op" id="1880833">(</span><span class="string" id="1880834">&#34;sigsend:&nbsp;inconsistent&nbsp;state&#34;</span><span class="op" id="1880863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880867">case</span>&nbsp;<span class="ident" id="1880872">sigIdle</span><span class="op" id="1880879">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880884">if</span>&nbsp;<span class="ident" id="1880887">cas</span><span class="op" id="1880890">(</span><span class="op" id="1880891">&amp;</span><span class="ident" id="1880892">sig</span><span class="op" id="1880895">.</span><span class="ident" id="1880896">state</span><span class="op" id="1880901">,</span>&nbsp;<span class="ident" id="1880903">sigIdle</span><span class="op" id="1880910">,</span>&nbsp;<span class="ident" id="1880912">sigSending</span><span class="op" id="1880922">)</span>&nbsp;<span class="op" id="1880924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880930">break</span>&nbsp;<span class="ident" id="1880936">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1880944">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880948">case</span>&nbsp;<span class="ident" id="1880953">sigSending</span><span class="op" id="1880963">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1880968">//&nbsp;notification&nbsp;already&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881003">break</span>&nbsp;<span class="ident" id="1881009">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881016">case</span>&nbsp;<span class="ident" id="1881021">sigReceiving</span><span class="op" id="1881033">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881038">if</span>&nbsp;<span class="ident" id="1881041">cas</span><span class="op" id="1881044">(</span><span class="op" id="1881045">&amp;</span><span class="ident" id="1881046">sig</span><span class="op" id="1881049">.</span><span class="ident" id="1881050">state</span><span class="op" id="1881055">,</span>&nbsp;<span class="ident" id="1881057">sigReceiving</span><span class="op" id="1881069">,</span>&nbsp;<span class="ident" id="1881071">sigIdle</span><span class="op" id="1881078">)</span>&nbsp;<span class="op" id="1881080">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881086">notewakeup</span><span class="op" id="1881096">(</span><span class="op" id="1881097">&amp;</span><span class="ident" id="1881098">sig</span><span class="op" id="1881101">.</span><span class="ident" id="1881102">note</span><span class="op" id="1881106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881112">break</span>&nbsp;<span class="ident" id="1881118">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881133">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881137">return</span>&nbsp;<span class="builtintype" id="1881144">true</span><br>
<span class="lineno"></span><span class="op" id="1881149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1881152">//&nbsp;Called&nbsp;to&nbsp;receive&nbsp;the&nbsp;next&nbsp;queued&nbsp;signal.</span><br>
<span class="lineno">90</span><span class="comment" id="1881197">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1881255">func</span>&nbsp;<span class="ident" id="1881260">signal_recv</span><span class="op" id="1881271">(</span><span class="op" id="1881272">)</span>&nbsp;<span class="builtintype" id="1881274">uint32</span>&nbsp;<span class="op" id="1881281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881284">for</span>&nbsp;<span class="op" id="1881288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1881292">//&nbsp;Serve&nbsp;any&nbsp;signals&nbsp;from&nbsp;local&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881332">for</span>&nbsp;<span class="ident" id="1881336">i</span>&nbsp;<span class="op" id="1881338">:=</span>&nbsp;<span class="builtintype" id="1881341">uint32</span><span class="op" id="1881347">(</span><span class="num" id="1881348">0</span><span class="op" id="1881349">)</span><span class="op" id="1881350">;</span>&nbsp;<span class="ident" id="1881352">i</span>&nbsp;<span class="op" id="1881354">&lt;</span>&nbsp;<span class="ident" id="1881356">_NSIG</span><span class="op" id="1881361">;</span>&nbsp;<span class="ident" id="1881363">i</span><span class="op" id="1881364">++</span>&nbsp;<span class="op" id="1881367">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881372">if</span>&nbsp;<span class="ident" id="1881375">sig</span><span class="op" id="1881378">.</span><span class="ident" id="1881379">recv</span><span class="op" id="1881383">[</span><span class="ident" id="1881384">i</span><span class="op" id="1881385">/</span><span class="num" id="1881386">32</span><span class="op" id="1881388">]</span><span class="op" id="1881389">&amp;</span><span class="op" id="1881390">(</span><span class="num" id="1881391">1</span><span class="op" id="1881392">&lt;&lt;</span><span class="op" id="1881394">(</span><span class="ident" id="1881395">i</span><span class="op" id="1881396">&amp;</span><span class="num" id="1881397">31</span><span class="op" id="1881399">)</span><span class="op" id="1881400">)</span>&nbsp;<span class="op" id="1881402">!=</span>&nbsp;<span class="num" id="1881405">0</span>&nbsp;<span class="op" id="1881407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881413">sig</span><span class="op" id="1881416">.</span><span class="ident" id="1881417">recv</span><span class="op" id="1881421">[</span><span class="ident" id="1881422">i</span><span class="op" id="1881423">/</span><span class="num" id="1881424">32</span><span class="op" id="1881426">]</span>&nbsp;<span class="op" id="1881428">&amp;^=</span>&nbsp;<span class="num" id="1881432">1</span>&nbsp;<span class="op" id="1881434">&lt;&lt;</span>&nbsp;<span class="op" id="1881437">(</span><span class="ident" id="1881438">i</span>&nbsp;<span class="op" id="1881440">&amp;</span>&nbsp;<span class="num" id="1881442">31</span><span class="op" id="1881444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881450">return</span>&nbsp;<span class="ident" id="1881457">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881466">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1881471">//&nbsp;Wait&nbsp;for&nbsp;updates&nbsp;to&nbsp;be&nbsp;available&nbsp;from&nbsp;signal&nbsp;sender.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881528">Receive</span><span class="op" id="1881535">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881539">for</span>&nbsp;<span class="op" id="1881543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881548">switch</span>&nbsp;<span class="ident" id="1881555">atomicload</span><span class="op" id="1881565">(</span><span class="op" id="1881566">&amp;</span><span class="ident" id="1881567">sig</span><span class="op" id="1881570">.</span><span class="ident" id="1881571">state</span><span class="op" id="1881576">)</span>&nbsp;<span class="op" id="1881578">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881583">default</span><span class="op" id="1881590">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881596">gothrow</span><span class="op" id="1881603">(</span><span class="string" id="1881604">&#34;signal_recv:&nbsp;inconsistent&nbsp;state&#34;</span><span class="op" id="1881637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881642">case</span>&nbsp;<span class="ident" id="1881647">sigIdle</span><span class="op" id="1881654">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881660">if</span>&nbsp;<span class="ident" id="1881663">cas</span><span class="op" id="1881666">(</span><span class="op" id="1881667">&amp;</span><span class="ident" id="1881668">sig</span><span class="op" id="1881671">.</span><span class="ident" id="1881672">state</span><span class="op" id="1881677">,</span>&nbsp;<span class="ident" id="1881679">sigIdle</span><span class="op" id="1881686">,</span>&nbsp;<span class="ident" id="1881688">sigReceiving</span><span class="op" id="1881700">)</span>&nbsp;<span class="op" id="1881702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881709">notetsleepg</span><span class="op" id="1881720">(</span><span class="op" id="1881721">&amp;</span><span class="ident" id="1881722">sig</span><span class="op" id="1881725">.</span><span class="ident" id="1881726">note</span><span class="op" id="1881730">,</span>&nbsp;<span class="op" id="1881732">-</span><span class="num" id="1881733">1</span><span class="op" id="1881734">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881741">noteclear</span><span class="op" id="1881750">(</span><span class="op" id="1881751">&amp;</span><span class="ident" id="1881752">sig</span><span class="op" id="1881755">.</span><span class="ident" id="1881756">note</span><span class="op" id="1881760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881767">break</span>&nbsp;<span class="ident" id="1881773">Receive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881790">case</span>&nbsp;<span class="ident" id="1881795">sigSending</span><span class="op" id="1881805">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881811">if</span>&nbsp;<span class="ident" id="1881814">cas</span><span class="op" id="1881817">(</span><span class="op" id="1881818">&amp;</span><span class="ident" id="1881819">sig</span><span class="op" id="1881822">.</span><span class="ident" id="1881823">state</span><span class="op" id="1881828">,</span>&nbsp;<span class="ident" id="1881830">sigSending</span><span class="op" id="1881840">,</span>&nbsp;<span class="ident" id="1881842">sigIdle</span><span class="op" id="1881849">)</span>&nbsp;<span class="op" id="1881851">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881858">break</span>&nbsp;<span class="ident" id="1881864">Receive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1881890">//&nbsp;Incorporate&nbsp;updates&nbsp;from&nbsp;sender&nbsp;into&nbsp;local&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881944">for</span>&nbsp;<span class="ident" id="1881948">i</span>&nbsp;<span class="op" id="1881950">:=</span>&nbsp;<span class="keyword" id="1881953">range</span>&nbsp;<span class="ident" id="1881959">sig</span><span class="op" id="1881962">.</span><span class="ident" id="1881963">mask</span>&nbsp;<span class="op" id="1881968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881973">sig</span><span class="op" id="1881976">.</span><span class="ident" id="1881977">recv</span><span class="op" id="1881981">[</span><span class="ident" id="1881982">i</span><span class="op" id="1881983">]</span>&nbsp;<span class="op" id="1881985">=</span>&nbsp;<span class="ident" id="1881987">xchg</span><span class="op" id="1881991">(</span><span class="op" id="1881992">&amp;</span><span class="ident" id="1881993">sig</span><span class="op" id="1881996">.</span><span class="ident" id="1881997">mask</span><span class="op" id="1882001">[</span><span class="ident" id="1882002">i</span><span class="op" id="1882003">]</span><span class="op" id="1882004">,</span>&nbsp;<span class="num" id="1882006">0</span><span class="op" id="1882007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1882011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1882014">}</span><br>
<span class="lineno">125</span><span class="op" id="1882016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1882019">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1882077">func</span>&nbsp;<span class="ident" id="1882082">signal_enable</span><span class="op" id="1882095">(</span><span class="ident" id="1882096">s</span>&nbsp;<span class="builtintype" id="1882098">uint32</span><span class="op" id="1882104">)</span>&nbsp;<span class="op" id="1882106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1882109">if</span>&nbsp;<span class="op" id="1882112">!</span><span class="ident" id="1882113">sig</span><span class="op" id="1882116">.</span><span class="ident" id="1882117">inuse</span>&nbsp;<span class="op" id="1882123">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1882127">//&nbsp;The&nbsp;first&nbsp;call&nbsp;to&nbsp;signal_enable&nbsp;is&nbsp;for&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1882174">//&nbsp;to&nbsp;use&nbsp;for&nbsp;initialization.&nbsp;&nbsp;It&nbsp;does&nbsp;not&nbsp;pass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1882224">//&nbsp;signal&nbsp;information&nbsp;in&nbsp;m.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882254">sig</span><span class="op" id="1882257">.</span><span class="ident" id="1882258">inuse</span>&nbsp;<span class="op" id="1882264">=</span>&nbsp;<span class="builtintype" id="1882266">true</span>&nbsp;<span class="comment" id="1882271">//&nbsp;enable&nbsp;reception&nbsp;of&nbsp;signals;&nbsp;cannot&nbsp;disable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882320">noteclear</span><span class="op" id="1882329">(</span><span class="op" id="1882330">&amp;</span><span class="ident" id="1882331">sig</span><span class="op" id="1882334">.</span><span class="ident" id="1882335">note</span><span class="op" id="1882339">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1882343">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1882351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1882355">if</span>&nbsp;<span class="builtintype" id="1882358">int</span><span class="op" id="1882361">(</span><span class="ident" id="1882362">s</span><span class="op" id="1882363">)</span>&nbsp;<span class="op" id="1882365">&gt;=</span>&nbsp;<span class="builtinfunc" id="1882368">len</span><span class="op" id="1882371">(</span><span class="ident" id="1882372">sig</span><span class="op" id="1882375">.</span><span class="ident" id="1882376">wanted</span><span class="op" id="1882382">)</span><span class="op" id="1882383">*</span><span class="num" id="1882384">32</span>&nbsp;<span class="op" id="1882387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1882391">return</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1882399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882402">sig</span><span class="op" id="1882405">.</span><span class="ident" id="1882406">wanted</span><span class="op" id="1882412">[</span><span class="ident" id="1882413">s</span><span class="op" id="1882414">/</span><span class="num" id="1882415">32</span><span class="op" id="1882417">]</span>&nbsp;<span class="op" id="1882419">|=</span>&nbsp;<span class="num" id="1882422">1</span>&nbsp;<span class="op" id="1882424">&lt;&lt;</span>&nbsp;<span class="op" id="1882427">(</span><span class="ident" id="1882428">s</span>&nbsp;<span class="op" id="1882430">&amp;</span>&nbsp;<span class="num" id="1882432">31</span><span class="op" id="1882434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882437">sigenable_go</span><span class="op" id="1882449">(</span><span class="ident" id="1882450">s</span><span class="op" id="1882451">)</span><br>
<span class="lineno"></span><span class="op" id="1882453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="1882456">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1882514">func</span>&nbsp;<span class="ident" id="1882519">signal_disable</span><span class="op" id="1882533">(</span><span class="ident" id="1882534">s</span>&nbsp;<span class="builtintype" id="1882536">uint32</span><span class="op" id="1882542">)</span>&nbsp;<span class="op" id="1882544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1882547">if</span>&nbsp;<span class="builtintype" id="1882550">int</span><span class="op" id="1882553">(</span><span class="ident" id="1882554">s</span><span class="op" id="1882555">)</span>&nbsp;<span class="op" id="1882557">&gt;=</span>&nbsp;<span class="builtinfunc" id="1882560">len</span><span class="op" id="1882563">(</span><span class="ident" id="1882564">sig</span><span class="op" id="1882567">.</span><span class="ident" id="1882568">wanted</span><span class="op" id="1882574">)</span><span class="op" id="1882575">*</span><span class="num" id="1882576">32</span>&nbsp;<span class="op" id="1882579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1882583">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1882591">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882594">sig</span><span class="op" id="1882597">.</span><span class="ident" id="1882598">wanted</span><span class="op" id="1882604">[</span><span class="ident" id="1882605">s</span><span class="op" id="1882606">/</span><span class="num" id="1882607">32</span><span class="op" id="1882609">]</span>&nbsp;<span class="op" id="1882611">&amp;^=</span>&nbsp;<span class="num" id="1882615">1</span>&nbsp;<span class="op" id="1882617">&lt;&lt;</span>&nbsp;<span class="op" id="1882620">(</span><span class="ident" id="1882621">s</span>&nbsp;<span class="op" id="1882623">&amp;</span>&nbsp;<span class="num" id="1882625">31</span><span class="op" id="1882627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882630">sigdisable_go</span><span class="op" id="1882643">(</span><span class="ident" id="1882644">s</span><span class="op" id="1882645">)</span><br>
<span class="lineno"></span><span class="op" id="1882647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1882650">//&nbsp;This&nbsp;runs&nbsp;on&nbsp;a&nbsp;foreign&nbsp;stack,&nbsp;without&nbsp;an&nbsp;m&nbsp;or&nbsp;a&nbsp;g.&nbsp;&nbsp;No&nbsp;stack&nbsp;split.</span><br>
<span class="lineno">155</span><span class="comment" id="1882721">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1882734">func</span>&nbsp;<span class="ident" id="1882739">badsignal</span><span class="op" id="1882748">(</span><span class="ident" id="1882749">sig</span>&nbsp;<span class="builtintype" id="1882753">uintptr</span><span class="op" id="1882760">)</span>&nbsp;<span class="op" id="1882762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882765">cgocallback</span><span class="op" id="1882776">(</span><span class="ident" id="1882777">unsafe</span><span class="op" id="1882783">.</span><span class="ident" id="1882784">Pointer</span><span class="op" id="1882791">(</span><span class="ident" id="1882792">funcPC</span><span class="op" id="1882798">(</span><span class="ident" id="1882799">sigsend</span><span class="op" id="1882806">)</span><span class="op" id="1882807">)</span><span class="op" id="1882808">,</span>&nbsp;<span class="ident" id="1882810">noescape</span><span class="op" id="1882818">(</span><span class="ident" id="1882819">unsafe</span><span class="op" id="1882825">.</span><span class="ident" id="1882826">Pointer</span><span class="op" id="1882833">(</span><span class="op" id="1882834">&amp;</span><span class="ident" id="1882835">sig</span><span class="op" id="1882838">)</span><span class="op" id="1882839">)</span><span class="op" id="1882840">,</span>&nbsp;<span class="ident" id="1882842">unsafe</span><span class="op" id="1882848">.</span><span class="ident" id="1882849">Sizeof</span><span class="op" id="1882855">(</span><span class="ident" id="1882856">sig</span><span class="op" id="1882859">)</span><span class="op" id="1882860">)</span><br>
<span class="lineno"></span><span class="op" id="1882862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="1882865">func</span>&nbsp;<span class="ident" id="1882870">sigenable_m</span><span class="op" id="1882881">(</span><span class="op" id="1882882">)</span><br>
<span class="lineno"></span><span class="keyword" id="1882884">func</span>&nbsp;<span class="ident" id="1882889">sigdisable_m</span><span class="op" id="1882901">(</span><span class="op" id="1882902">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1882905">func</span>&nbsp;<span class="ident" id="1882910">sigenable_go</span><span class="op" id="1882922">(</span><span class="ident" id="1882923">s</span>&nbsp;<span class="builtintype" id="1882925">uint32</span><span class="op" id="1882931">)</span>&nbsp;<span class="op" id="1882933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882936">g</span>&nbsp;<span class="op" id="1882938">:=</span>&nbsp;<span class="ident" id="1882941">getg</span><span class="op" id="1882945">(</span><span class="op" id="1882946">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882949">g</span><span class="op" id="1882950">.</span><span class="ident" id="1882951">m</span><span class="op" id="1882952">.</span><span class="ident" id="1882953">scalararg</span><span class="op" id="1882962">[</span><span class="num" id="1882963">0</span><span class="op" id="1882964">]</span>&nbsp;<span class="op" id="1882966">=</span>&nbsp;<span class="builtintype" id="1882968">uintptr</span><span class="op" id="1882975">(</span><span class="ident" id="1882976">s</span><span class="op" id="1882977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882980">onM</span><span class="op" id="1882983">(</span><span class="ident" id="1882984">sigenable_m</span><span class="op" id="1882995">)</span><br>
<span class="lineno"></span><span class="op" id="1882997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1883000">func</span>&nbsp;<span class="ident" id="1883005">sigdisable_go</span><span class="op" id="1883018">(</span><span class="ident" id="1883019">s</span>&nbsp;<span class="builtintype" id="1883021">uint32</span><span class="op" id="1883027">)</span>&nbsp;<span class="op" id="1883029">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883032">g</span>&nbsp;<span class="op" id="1883034">:=</span>&nbsp;<span class="ident" id="1883037">getg</span><span class="op" id="1883041">(</span><span class="op" id="1883042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883045">g</span><span class="op" id="1883046">.</span><span class="ident" id="1883047">m</span><span class="op" id="1883048">.</span><span class="ident" id="1883049">scalararg</span><span class="op" id="1883058">[</span><span class="num" id="1883059">0</span><span class="op" id="1883060">]</span>&nbsp;<span class="op" id="1883062">=</span>&nbsp;<span class="builtintype" id="1883064">uintptr</span><span class="op" id="1883071">(</span><span class="ident" id="1883072">s</span><span class="op" id="1883073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883076">onM</span><span class="op" id="1883079">(</span><span class="ident" id="1883080">sigdisable_m</span><span class="op" id="1883092">)</span><br>
<span class="lineno"></span><span class="op" id="1883094">}</span>
</div>
</body>
</html>
