<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5584555">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5584610">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5584664">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5584715">//&nbsp;Package&nbsp;fcgi&nbsp;implements&nbsp;the&nbsp;FastCGI&nbsp;protocol.</span><br>
<span class="lineno"></span><span class="comment" id="5584764">//&nbsp;Currently&nbsp;only&nbsp;the&nbsp;responder&nbsp;role&nbsp;is&nbsp;supported.</span><br>
<span class="lineno"></span><span class="comment" id="5584815">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;defined&nbsp;at&nbsp;http://www.fastcgi.com/drupal/node/6?q=node/22</span><br>
<span class="lineno"></span><span class="keyword" id="5584892">package</span>&nbsp;<span class="ident" id="5584900">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="5584906">//&nbsp;This&nbsp;file&nbsp;defines&nbsp;the&nbsp;raw&nbsp;protocol&nbsp;and&nbsp;some&nbsp;utilities&nbsp;used&nbsp;by&nbsp;the&nbsp;child&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5584985">//&nbsp;the&nbsp;host.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5584999">import</span>&nbsp;<span class="op" id="5585006">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5585009">&#34;bufio&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5585018">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5585027">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5585046">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5585056">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5585062">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="5585069">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5585072">//&nbsp;recType&nbsp;is&nbsp;a&nbsp;record&nbsp;type,&nbsp;as&nbsp;defined&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5585115">//&nbsp;http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S8</span><br>
<span class="lineno"></span><span class="keyword" id="5585170">type</span>&nbsp;<span class="ident" id="5585175">recType</span>&nbsp;<span class="builtintype" id="5585183">uint8</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="5585190">const</span>&nbsp;<span class="op" id="5585196">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585199">typeBeginRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5585219">recType</span>&nbsp;<span class="op" id="5585227">=</span>&nbsp;<span class="num" id="5585229">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585232">typeAbortRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5585252">recType</span>&nbsp;<span class="op" id="5585260">=</span>&nbsp;<span class="num" id="5585262">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585265">typeEndRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5585285">recType</span>&nbsp;<span class="op" id="5585293">=</span>&nbsp;<span class="num" id="5585295">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585298">typeParams</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5585318">recType</span>&nbsp;<span class="op" id="5585326">=</span>&nbsp;<span class="num" id="5585328">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585331">typeStdin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5585351">recType</span>&nbsp;<span class="op" id="5585359">=</span>&nbsp;<span class="num" id="5585361">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585364">typeStdout</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5585384">recType</span>&nbsp;<span class="op" id="5585392">=</span>&nbsp;<span class="num" id="5585394">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585397">typeStderr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5585417">recType</span>&nbsp;<span class="op" id="5585425">=</span>&nbsp;<span class="num" id="5585427">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585430">typeData</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5585450">recType</span>&nbsp;<span class="op" id="5585458">=</span>&nbsp;<span class="num" id="5585460">8</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585463">typeGetValues</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5585483">recType</span>&nbsp;<span class="op" id="5585491">=</span>&nbsp;<span class="num" id="5585493">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585496">typeGetValuesResult</span>&nbsp;<span class="ident" id="5585516">recType</span>&nbsp;<span class="op" id="5585524">=</span>&nbsp;<span class="num" id="5585526">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585530">typeUnknownType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5585550">recType</span>&nbsp;<span class="op" id="5585558">=</span>&nbsp;<span class="num" id="5585560">11</span><br>
<span class="lineno"></span><span class="op" id="5585563">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="5585566">//&nbsp;keep&nbsp;the&nbsp;connection&nbsp;between&nbsp;web-server&nbsp;and&nbsp;responder&nbsp;open&nbsp;after&nbsp;request</span><br>
<span class="lineno"></span><span class="keyword" id="5585641">const</span>&nbsp;<span class="ident" id="5585647">flagKeepConn</span>&nbsp;<span class="op" id="5585660">=</span>&nbsp;<span class="num" id="5585662">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5585665">const</span>&nbsp;<span class="op" id="5585671">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585674">maxWrite</span>&nbsp;<span class="op" id="5585683">=</span>&nbsp;<span class="num" id="5585685">65535</span>&nbsp;<span class="comment" id="5585691">//&nbsp;maximum&nbsp;record&nbsp;body</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585715">maxPad</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5585724">=</span>&nbsp;<span class="num" id="5585726">255</span><br>
<span class="lineno"></span><span class="op" id="5585730">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5585733">const</span>&nbsp;<span class="op" id="5585739">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585742">roleResponder</span>&nbsp;<span class="op" id="5585756">=</span>&nbsp;<span class="ident" id="5585758">iota</span>&nbsp;<span class="op" id="5585763">+</span>&nbsp;<span class="num" id="5585765">1</span>&nbsp;<span class="comment" id="5585767">//&nbsp;only&nbsp;Responders&nbsp;are&nbsp;implemented.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585804">roleAuthorizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585820">roleFilter</span><br>
<span class="lineno"></span><span class="op" id="5585831">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5585834">const</span>&nbsp;<span class="op" id="5585840">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585843">statusRequestComplete</span>&nbsp;<span class="op" id="5585865">=</span>&nbsp;<span class="ident" id="5585867">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585873">statusCantMultiplex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585894">statusOverloaded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585912">statusUnknownRole</span><br>
<span class="lineno"></span><span class="op" id="5585930">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="5585933">const</span>&nbsp;<span class="ident" id="5585939">headerLen</span>&nbsp;<span class="op" id="5585949">=</span>&nbsp;<span class="num" id="5585951">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5585954">type</span>&nbsp;<span class="ident" id="5585959">header</span>&nbsp;<span class="keyword" id="5585966">struct</span>&nbsp;<span class="op" id="5585973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585976">Version</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5585990">uint8</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585997">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5586011">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586020">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5586034">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586042">ContentLength</span>&nbsp;<span class="builtintype" id="5586056">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586064">PaddingLength</span>&nbsp;<span class="builtintype" id="5586078">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586085">Reserved</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5586099">uint8</span><br>
<span class="lineno">70</span><span class="op" id="5586105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5586108">type</span>&nbsp;<span class="ident" id="5586113">beginRequest</span>&nbsp;<span class="keyword" id="5586126">struct</span>&nbsp;<span class="op" id="5586133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586136">role</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5586145">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586153">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5586162">uint8</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586169">reserved</span>&nbsp;<span class="op" id="5586178">[</span><span class="num" id="5586179">5</span><span class="op" id="5586180">]</span><span class="builtintype" id="5586181">uint8</span><br>
<span class="lineno"></span><span class="op" id="5586187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5586190">func</span>&nbsp;<span class="op" id="5586195">(</span><span class="ident" id="5586196">br</span>&nbsp;<span class="op" id="5586199">*</span><span class="ident" id="5586200">beginRequest</span><span class="op" id="5586212">)</span>&nbsp;<span class="ident" id="5586214">read</span><span class="op" id="5586218">(</span><span class="ident" id="5586219">content</span>&nbsp;<span class="op" id="5586227">[</span><span class="op" id="5586228">]</span><span class="builtintype" id="5586229">byte</span><span class="op" id="5586233">)</span>&nbsp;<span class="builtintype" id="5586235">error</span>&nbsp;<span class="op" id="5586241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5586244">if</span>&nbsp;<span class="builtinfunc" id="5586247">len</span><span class="op" id="5586250">(</span><span class="ident" id="5586251">content</span><span class="op" id="5586258">)</span>&nbsp;<span class="op" id="5586260">!=</span>&nbsp;<span class="num" id="5586263">8</span>&nbsp;<span class="op" id="5586265">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5586269">return</span>&nbsp;<span class="ident" id="5586276">errors</span><span class="op" id="5586282">.</span><span class="ident" id="5586283">New</span><span class="op" id="5586286">(</span><span class="string" id="5586287">&#34;fcgi:&nbsp;invalid&nbsp;begin&nbsp;request&nbsp;record&#34;</span><span class="op" id="5586323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5586326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586329">br</span><span class="op" id="5586331">.</span><span class="ident" id="5586332">role</span>&nbsp;<span class="op" id="5586337">=</span>&nbsp;<span class="ident" id="5586339">binary</span><span class="op" id="5586345">.</span><span class="ident" id="5586346">BigEndian</span><span class="op" id="5586355">.</span><span class="ident" id="5586356">Uint16</span><span class="op" id="5586362">(</span><span class="ident" id="5586363">content</span><span class="op" id="5586370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586373">br</span><span class="op" id="5586375">.</span><span class="ident" id="5586376">flags</span>&nbsp;<span class="op" id="5586382">=</span>&nbsp;<span class="ident" id="5586384">content</span><span class="op" id="5586391">[</span><span class="num" id="5586392">2</span><span class="op" id="5586393">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5586396">return</span>&nbsp;<span class="ident" id="5586403">nil</span><br>
<span class="lineno">85</span><span class="op" id="5586407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5586410">//&nbsp;for&nbsp;padding&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to&nbsp;allocate&nbsp;all&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="5586467">//&nbsp;not&nbsp;synchronized&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;care&nbsp;what&nbsp;the&nbsp;contents&nbsp;are</span><br>
<span class="lineno"></span><span class="keyword" id="5586531">var</span>&nbsp;<span class="ident" id="5586535">pad</span>&nbsp;<span class="op" id="5586539">[</span><span class="ident" id="5586540">maxPad</span><span class="op" id="5586546">]</span><span class="builtintype" id="5586547">byte</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="5586553">func</span>&nbsp;<span class="op" id="5586558">(</span><span class="ident" id="5586559">h</span>&nbsp;<span class="op" id="5586561">*</span><span class="ident" id="5586562">header</span><span class="op" id="5586568">)</span>&nbsp;<span class="ident" id="5586570">init</span><span class="op" id="5586574">(</span><span class="ident" id="5586575">recType</span>&nbsp;<span class="ident" id="5586583">recType</span><span class="op" id="5586590">,</span>&nbsp;<span class="ident" id="5586592">reqId</span>&nbsp;<span class="builtintype" id="5586598">uint16</span><span class="op" id="5586604">,</span>&nbsp;<span class="ident" id="5586606">contentLength</span>&nbsp;<span class="builtintype" id="5586620">int</span><span class="op" id="5586623">)</span>&nbsp;<span class="op" id="5586625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586628">h</span><span class="op" id="5586629">.</span><span class="ident" id="5586630">Version</span>&nbsp;<span class="op" id="5586638">=</span>&nbsp;<span class="num" id="5586640">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586643">h</span><span class="op" id="5586644">.</span><span class="ident" id="5586645">Type</span>&nbsp;<span class="op" id="5586650">=</span>&nbsp;<span class="ident" id="5586652">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586661">h</span><span class="op" id="5586662">.</span><span class="ident" id="5586663">Id</span>&nbsp;<span class="op" id="5586666">=</span>&nbsp;<span class="ident" id="5586668">reqId</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586675">h</span><span class="op" id="5586676">.</span><span class="ident" id="5586677">ContentLength</span>&nbsp;<span class="op" id="5586691">=</span>&nbsp;<span class="builtintype" id="5586693">uint16</span><span class="op" id="5586699">(</span><span class="ident" id="5586700">contentLength</span><span class="op" id="5586713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586716">h</span><span class="op" id="5586717">.</span><span class="ident" id="5586718">PaddingLength</span>&nbsp;<span class="op" id="5586732">=</span>&nbsp;<span class="builtintype" id="5586734">uint8</span><span class="op" id="5586739">(</span><span class="op" id="5586740">-</span><span class="ident" id="5586741">contentLength</span>&nbsp;<span class="op" id="5586755">&amp;</span>&nbsp;<span class="num" id="5586757">7</span><span class="op" id="5586758">)</span><br>
<span class="lineno"></span><span class="op" id="5586760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5586763">//&nbsp;conn&nbsp;sends&nbsp;records&nbsp;over&nbsp;rwc</span><br>
<span class="lineno">100</span><span class="keyword" id="5586794">type</span>&nbsp;<span class="ident" id="5586799">conn</span>&nbsp;<span class="keyword" id="5586804">struct</span>&nbsp;<span class="op" id="5586811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586814">mutex</span>&nbsp;<span class="ident" id="5586820">sync</span><span class="op" id="5586824">.</span><span class="ident" id="5586825">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586832">rwc</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5586838">io</span><span class="op" id="5586840">.</span><span class="ident" id="5586841">ReadWriteCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5586859">//&nbsp;to&nbsp;avoid&nbsp;allocations</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586884">buf</span>&nbsp;<span class="ident" id="5586888">bytes</span><span class="op" id="5586893">.</span><span class="ident" id="5586894">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586902">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5586906">header</span><br>
<span class="lineno"></span><span class="op" id="5586913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5586916">func</span>&nbsp;<span class="ident" id="5586921">newConn</span><span class="op" id="5586928">(</span><span class="ident" id="5586929">rwc</span>&nbsp;<span class="ident" id="5586933">io</span><span class="op" id="5586935">.</span><span class="ident" id="5586936">ReadWriteCloser</span><span class="op" id="5586951">)</span>&nbsp;<span class="op" id="5586953">*</span><span class="ident" id="5586954">conn</span>&nbsp;<span class="op" id="5586959">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5586962">return</span>&nbsp;<span class="op" id="5586969">&amp;</span><span class="ident" id="5586970">conn</span><span class="op" id="5586974">{</span><span class="ident" id="5586975">rwc</span><span class="op" id="5586978">:</span>&nbsp;<span class="ident" id="5586980">rwc</span><span class="op" id="5586983">}</span><br>
<span class="lineno"></span><span class="op" id="5586985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5586988">func</span>&nbsp;<span class="op" id="5586993">(</span><span class="ident" id="5586994">c</span>&nbsp;<span class="op" id="5586996">*</span><span class="ident" id="5586997">conn</span><span class="op" id="5587001">)</span>&nbsp;<span class="ident" id="5587003">Close</span><span class="op" id="5587008">(</span><span class="op" id="5587009">)</span>&nbsp;<span class="builtintype" id="5587011">error</span>&nbsp;<span class="op" id="5587017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587020">c</span><span class="op" id="5587021">.</span><span class="ident" id="5587022">mutex</span><span class="op" id="5587027">.</span><span class="ident" id="5587028">Lock</span><span class="op" id="5587032">(</span><span class="op" id="5587033">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587036">defer</span>&nbsp;<span class="ident" id="5587042">c</span><span class="op" id="5587043">.</span><span class="ident" id="5587044">mutex</span><span class="op" id="5587049">.</span><span class="ident" id="5587050">Unlock</span><span class="op" id="5587056">(</span><span class="op" id="5587057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587060">return</span>&nbsp;<span class="ident" id="5587067">c</span><span class="op" id="5587068">.</span><span class="ident" id="5587069">rwc</span><span class="op" id="5587072">.</span><span class="ident" id="5587073">Close</span><span class="op" id="5587078">(</span><span class="op" id="5587079">)</span><br>
<span class="lineno"></span><span class="op" id="5587081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5587084">type</span>&nbsp;<span class="ident" id="5587089">record</span>&nbsp;<span class="keyword" id="5587096">struct</span>&nbsp;<span class="op" id="5587103">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587106">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5587110">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587118">buf</span>&nbsp;<span class="op" id="5587122">[</span><span class="ident" id="5587123">maxWrite</span>&nbsp;<span class="op" id="5587132">+</span>&nbsp;<span class="ident" id="5587134">maxPad</span><span class="op" id="5587140">]</span><span class="builtintype" id="5587141">byte</span><br>
<span class="lineno"></span><span class="op" id="5587146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5587149">func</span>&nbsp;<span class="op" id="5587154">(</span><span class="ident" id="5587155">rec</span>&nbsp;<span class="op" id="5587159">*</span><span class="ident" id="5587160">record</span><span class="op" id="5587166">)</span>&nbsp;<span class="ident" id="5587168">read</span><span class="op" id="5587172">(</span><span class="ident" id="5587173">r</span>&nbsp;<span class="ident" id="5587175">io</span><span class="op" id="5587177">.</span><span class="ident" id="5587178">Reader</span><span class="op" id="5587184">)</span>&nbsp;<span class="op" id="5587186">(</span><span class="ident" id="5587187">err</span>&nbsp;<span class="builtintype" id="5587191">error</span><span class="op" id="5587196">)</span>&nbsp;<span class="op" id="5587198">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587201">if</span>&nbsp;<span class="ident" id="5587204">err</span>&nbsp;<span class="op" id="5587208">=</span>&nbsp;<span class="ident" id="5587210">binary</span><span class="op" id="5587216">.</span><span class="ident" id="5587217">Read</span><span class="op" id="5587221">(</span><span class="ident" id="5587222">r</span><span class="op" id="5587223">,</span>&nbsp;<span class="ident" id="5587225">binary</span><span class="op" id="5587231">.</span><span class="ident" id="5587232">BigEndian</span><span class="op" id="5587241">,</span>&nbsp;<span class="op" id="5587243">&amp;</span><span class="ident" id="5587244">rec</span><span class="op" id="5587247">.</span><span class="ident" id="5587248">h</span><span class="op" id="5587249">)</span><span class="op" id="5587250">;</span>&nbsp;<span class="ident" id="5587252">err</span>&nbsp;<span class="op" id="5587256">!=</span>&nbsp;<span class="ident" id="5587259">nil</span>&nbsp;<span class="op" id="5587263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587267">return</span>&nbsp;<span class="ident" id="5587274">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5587279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587282">if</span>&nbsp;<span class="ident" id="5587285">rec</span><span class="op" id="5587288">.</span><span class="ident" id="5587289">h</span><span class="op" id="5587290">.</span><span class="ident" id="5587291">Version</span>&nbsp;<span class="op" id="5587299">!=</span>&nbsp;<span class="num" id="5587302">1</span>&nbsp;<span class="op" id="5587304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587308">return</span>&nbsp;<span class="ident" id="5587315">errors</span><span class="op" id="5587321">.</span><span class="ident" id="5587322">New</span><span class="op" id="5587325">(</span><span class="string" id="5587326">&#34;fcgi:&nbsp;invalid&nbsp;header&nbsp;version&#34;</span><span class="op" id="5587356">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5587359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587362">n</span>&nbsp;<span class="op" id="5587364">:=</span>&nbsp;<span class="builtintype" id="5587367">int</span><span class="op" id="5587370">(</span><span class="ident" id="5587371">rec</span><span class="op" id="5587374">.</span><span class="ident" id="5587375">h</span><span class="op" id="5587376">.</span><span class="ident" id="5587377">ContentLength</span><span class="op" id="5587390">)</span>&nbsp;<span class="op" id="5587392">+</span>&nbsp;<span class="builtintype" id="5587394">int</span><span class="op" id="5587397">(</span><span class="ident" id="5587398">rec</span><span class="op" id="5587401">.</span><span class="ident" id="5587402">h</span><span class="op" id="5587403">.</span><span class="ident" id="5587404">PaddingLength</span><span class="op" id="5587417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587420">if</span>&nbsp;<span class="ident" id="5587423">_</span><span class="op" id="5587424">,</span>&nbsp;<span class="ident" id="5587426">err</span>&nbsp;<span class="op" id="5587430">=</span>&nbsp;<span class="ident" id="5587432">io</span><span class="op" id="5587434">.</span><span class="ident" id="5587435">ReadFull</span><span class="op" id="5587443">(</span><span class="ident" id="5587444">r</span><span class="op" id="5587445">,</span>&nbsp;<span class="ident" id="5587447">rec</span><span class="op" id="5587450">.</span><span class="ident" id="5587451">buf</span><span class="op" id="5587454">[</span><span class="op" id="5587455">:</span><span class="ident" id="5587456">n</span><span class="op" id="5587457">]</span><span class="op" id="5587458">)</span><span class="op" id="5587459">;</span>&nbsp;<span class="ident" id="5587461">err</span>&nbsp;<span class="op" id="5587465">!=</span>&nbsp;<span class="ident" id="5587468">nil</span>&nbsp;<span class="op" id="5587472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587476">return</span>&nbsp;<span class="ident" id="5587483">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5587488">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587491">return</span>&nbsp;<span class="ident" id="5587498">nil</span><br>
<span class="lineno"></span><span class="op" id="5587502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5587505">func</span>&nbsp;<span class="op" id="5587510">(</span><span class="ident" id="5587511">r</span>&nbsp;<span class="op" id="5587513">*</span><span class="ident" id="5587514">record</span><span class="op" id="5587520">)</span>&nbsp;<span class="ident" id="5587522">content</span><span class="op" id="5587529">(</span><span class="op" id="5587530">)</span>&nbsp;<span class="op" id="5587532">[</span><span class="op" id="5587533">]</span><span class="builtintype" id="5587534">byte</span>&nbsp;<span class="op" id="5587539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587542">return</span>&nbsp;<span class="ident" id="5587549">r</span><span class="op" id="5587550">.</span><span class="ident" id="5587551">buf</span><span class="op" id="5587554">[</span><span class="op" id="5587555">:</span><span class="ident" id="5587556">r</span><span class="op" id="5587557">.</span><span class="ident" id="5587558">h</span><span class="op" id="5587559">.</span><span class="ident" id="5587560">ContentLength</span><span class="op" id="5587573">]</span><br>
<span class="lineno">140</span><span class="op" id="5587575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5587578">//&nbsp;writeRecord&nbsp;writes&nbsp;and&nbsp;sends&nbsp;a&nbsp;single&nbsp;record.</span><br>
<span class="lineno"></span><span class="keyword" id="5587627">func</span>&nbsp;<span class="op" id="5587632">(</span><span class="ident" id="5587633">c</span>&nbsp;<span class="op" id="5587635">*</span><span class="ident" id="5587636">conn</span><span class="op" id="5587640">)</span>&nbsp;<span class="ident" id="5587642">writeRecord</span><span class="op" id="5587653">(</span><span class="ident" id="5587654">recType</span>&nbsp;<span class="ident" id="5587662">recType</span><span class="op" id="5587669">,</span>&nbsp;<span class="ident" id="5587671">reqId</span>&nbsp;<span class="builtintype" id="5587677">uint16</span><span class="op" id="5587683">,</span>&nbsp;<span class="ident" id="5587685">b</span>&nbsp;<span class="op" id="5587687">[</span><span class="op" id="5587688">]</span><span class="builtintype" id="5587689">byte</span><span class="op" id="5587693">)</span>&nbsp;<span class="builtintype" id="5587695">error</span>&nbsp;<span class="op" id="5587701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587704">c</span><span class="op" id="5587705">.</span><span class="ident" id="5587706">mutex</span><span class="op" id="5587711">.</span><span class="ident" id="5587712">Lock</span><span class="op" id="5587716">(</span><span class="op" id="5587717">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587720">defer</span>&nbsp;<span class="ident" id="5587726">c</span><span class="op" id="5587727">.</span><span class="ident" id="5587728">mutex</span><span class="op" id="5587733">.</span><span class="ident" id="5587734">Unlock</span><span class="op" id="5587740">(</span><span class="op" id="5587741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587744">c</span><span class="op" id="5587745">.</span><span class="ident" id="5587746">buf</span><span class="op" id="5587749">.</span><span class="ident" id="5587750">Reset</span><span class="op" id="5587755">(</span><span class="op" id="5587756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587759">c</span><span class="op" id="5587760">.</span><span class="ident" id="5587761">h</span><span class="op" id="5587762">.</span><span class="ident" id="5587763">init</span><span class="op" id="5587767">(</span><span class="ident" id="5587768">recType</span><span class="op" id="5587775">,</span>&nbsp;<span class="ident" id="5587777">reqId</span><span class="op" id="5587782">,</span>&nbsp;<span class="builtinfunc" id="5587784">len</span><span class="op" id="5587787">(</span><span class="ident" id="5587788">b</span><span class="op" id="5587789">)</span><span class="op" id="5587790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587793">if</span>&nbsp;<span class="ident" id="5587796">err</span>&nbsp;<span class="op" id="5587800">:=</span>&nbsp;<span class="ident" id="5587803">binary</span><span class="op" id="5587809">.</span><span class="ident" id="5587810">Write</span><span class="op" id="5587815">(</span><span class="op" id="5587816">&amp;</span><span class="ident" id="5587817">c</span><span class="op" id="5587818">.</span><span class="ident" id="5587819">buf</span><span class="op" id="5587822">,</span>&nbsp;<span class="ident" id="5587824">binary</span><span class="op" id="5587830">.</span><span class="ident" id="5587831">BigEndian</span><span class="op" id="5587840">,</span>&nbsp;<span class="ident" id="5587842">c</span><span class="op" id="5587843">.</span><span class="ident" id="5587844">h</span><span class="op" id="5587845">)</span><span class="op" id="5587846">;</span>&nbsp;<span class="ident" id="5587848">err</span>&nbsp;<span class="op" id="5587852">!=</span>&nbsp;<span class="ident" id="5587855">nil</span>&nbsp;<span class="op" id="5587859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587863">return</span>&nbsp;<span class="ident" id="5587870">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5587875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587878">if</span>&nbsp;<span class="ident" id="5587881">_</span><span class="op" id="5587882">,</span>&nbsp;<span class="ident" id="5587884">err</span>&nbsp;<span class="op" id="5587888">:=</span>&nbsp;<span class="ident" id="5587891">c</span><span class="op" id="5587892">.</span><span class="ident" id="5587893">buf</span><span class="op" id="5587896">.</span><span class="ident" id="5587897">Write</span><span class="op" id="5587902">(</span><span class="ident" id="5587903">b</span><span class="op" id="5587904">)</span><span class="op" id="5587905">;</span>&nbsp;<span class="ident" id="5587907">err</span>&nbsp;<span class="op" id="5587911">!=</span>&nbsp;<span class="ident" id="5587914">nil</span>&nbsp;<span class="op" id="5587918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587922">return</span>&nbsp;<span class="ident" id="5587929">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5587934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587937">if</span>&nbsp;<span class="ident" id="5587940">_</span><span class="op" id="5587941">,</span>&nbsp;<span class="ident" id="5587943">err</span>&nbsp;<span class="op" id="5587947">:=</span>&nbsp;<span class="ident" id="5587950">c</span><span class="op" id="5587951">.</span><span class="ident" id="5587952">buf</span><span class="op" id="5587955">.</span><span class="ident" id="5587956">Write</span><span class="op" id="5587961">(</span><span class="ident" id="5587962">pad</span><span class="op" id="5587965">[</span><span class="op" id="5587966">:</span><span class="ident" id="5587967">c</span><span class="op" id="5587968">.</span><span class="ident" id="5587969">h</span><span class="op" id="5587970">.</span><span class="ident" id="5587971">PaddingLength</span><span class="op" id="5587984">]</span><span class="op" id="5587985">)</span><span class="op" id="5587986">;</span>&nbsp;<span class="ident" id="5587988">err</span>&nbsp;<span class="op" id="5587992">!=</span>&nbsp;<span class="ident" id="5587995">nil</span>&nbsp;<span class="op" id="5587999">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588003">return</span>&nbsp;<span class="ident" id="5588010">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5588015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588018">_</span><span class="op" id="5588019">,</span>&nbsp;<span class="ident" id="5588021">err</span>&nbsp;<span class="op" id="5588025">:=</span>&nbsp;<span class="ident" id="5588028">c</span><span class="op" id="5588029">.</span><span class="ident" id="5588030">rwc</span><span class="op" id="5588033">.</span><span class="ident" id="5588034">Write</span><span class="op" id="5588039">(</span><span class="ident" id="5588040">c</span><span class="op" id="5588041">.</span><span class="ident" id="5588042">buf</span><span class="op" id="5588045">.</span><span class="ident" id="5588046">Bytes</span><span class="op" id="5588051">(</span><span class="op" id="5588052">)</span><span class="op" id="5588053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588056">return</span>&nbsp;<span class="ident" id="5588063">err</span><br>
<span class="lineno"></span><span class="op" id="5588067">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="keyword" id="5588070">func</span>&nbsp;<span class="op" id="5588075">(</span><span class="ident" id="5588076">c</span>&nbsp;<span class="op" id="5588078">*</span><span class="ident" id="5588079">conn</span><span class="op" id="5588083">)</span>&nbsp;<span class="ident" id="5588085">writeBeginRequest</span><span class="op" id="5588102">(</span><span class="ident" id="5588103">reqId</span>&nbsp;<span class="builtintype" id="5588109">uint16</span><span class="op" id="5588115">,</span>&nbsp;<span class="ident" id="5588117">role</span>&nbsp;<span class="builtintype" id="5588122">uint16</span><span class="op" id="5588128">,</span>&nbsp;<span class="ident" id="5588130">flags</span>&nbsp;<span class="builtintype" id="5588136">uint8</span><span class="op" id="5588141">)</span>&nbsp;<span class="builtintype" id="5588143">error</span>&nbsp;<span class="op" id="5588149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588152">b</span>&nbsp;<span class="op" id="5588154">:=</span>&nbsp;<span class="op" id="5588157">[</span><span class="num" id="5588158">8</span><span class="op" id="5588159">]</span><span class="builtintype" id="5588160">byte</span><span class="op" id="5588164">{</span><span class="builtintype" id="5588165">byte</span><span class="op" id="5588169">(</span><span class="ident" id="5588170">role</span>&nbsp;<span class="op" id="5588175">&gt;&gt;</span>&nbsp;<span class="num" id="5588178">8</span><span class="op" id="5588179">)</span><span class="op" id="5588180">,</span>&nbsp;<span class="builtintype" id="5588182">byte</span><span class="op" id="5588186">(</span><span class="ident" id="5588187">role</span><span class="op" id="5588191">)</span><span class="op" id="5588192">,</span>&nbsp;<span class="ident" id="5588194">flags</span><span class="op" id="5588199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588202">return</span>&nbsp;<span class="ident" id="5588209">c</span><span class="op" id="5588210">.</span><span class="ident" id="5588211">writeRecord</span><span class="op" id="5588222">(</span><span class="ident" id="5588223">typeBeginRequest</span><span class="op" id="5588239">,</span>&nbsp;<span class="ident" id="5588241">reqId</span><span class="op" id="5588246">,</span>&nbsp;<span class="ident" id="5588248">b</span><span class="op" id="5588249">[</span><span class="op" id="5588250">:</span><span class="op" id="5588251">]</span><span class="op" id="5588252">)</span><br>
<span class="lineno"></span><span class="op" id="5588254">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="5588257">func</span>&nbsp;<span class="op" id="5588262">(</span><span class="ident" id="5588263">c</span>&nbsp;<span class="op" id="5588265">*</span><span class="ident" id="5588266">conn</span><span class="op" id="5588270">)</span>&nbsp;<span class="ident" id="5588272">writeEndRequest</span><span class="op" id="5588287">(</span><span class="ident" id="5588288">reqId</span>&nbsp;<span class="builtintype" id="5588294">uint16</span><span class="op" id="5588300">,</span>&nbsp;<span class="ident" id="5588302">appStatus</span>&nbsp;<span class="builtintype" id="5588312">int</span><span class="op" id="5588315">,</span>&nbsp;<span class="ident" id="5588317">protocolStatus</span>&nbsp;<span class="builtintype" id="5588332">uint8</span><span class="op" id="5588337">)</span>&nbsp;<span class="builtintype" id="5588339">error</span>&nbsp;<span class="op" id="5588345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588348">b</span>&nbsp;<span class="op" id="5588350">:=</span>&nbsp;<span class="builtinfunc" id="5588353">make</span><span class="op" id="5588357">(</span><span class="op" id="5588358">[</span><span class="op" id="5588359">]</span><span class="builtintype" id="5588360">byte</span><span class="op" id="5588364">,</span>&nbsp;<span class="num" id="5588366">8</span><span class="op" id="5588367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588370">binary</span><span class="op" id="5588376">.</span><span class="ident" id="5588377">BigEndian</span><span class="op" id="5588386">.</span><span class="ident" id="5588387">PutUint32</span><span class="op" id="5588396">(</span><span class="ident" id="5588397">b</span><span class="op" id="5588398">,</span>&nbsp;<span class="builtintype" id="5588400">uint32</span><span class="op" id="5588406">(</span><span class="ident" id="5588407">appStatus</span><span class="op" id="5588416">)</span><span class="op" id="5588417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588420">b</span><span class="op" id="5588421">[</span><span class="num" id="5588422">4</span><span class="op" id="5588423">]</span>&nbsp;<span class="op" id="5588425">=</span>&nbsp;<span class="ident" id="5588427">protocolStatus</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588443">return</span>&nbsp;<span class="ident" id="5588450">c</span><span class="op" id="5588451">.</span><span class="ident" id="5588452">writeRecord</span><span class="op" id="5588463">(</span><span class="ident" id="5588464">typeEndRequest</span><span class="op" id="5588478">,</span>&nbsp;<span class="ident" id="5588480">reqId</span><span class="op" id="5588485">,</span>&nbsp;<span class="ident" id="5588487">b</span><span class="op" id="5588488">)</span><br>
<span class="lineno"></span><span class="op" id="5588490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5588493">func</span>&nbsp;<span class="op" id="5588498">(</span><span class="ident" id="5588499">c</span>&nbsp;<span class="op" id="5588501">*</span><span class="ident" id="5588502">conn</span><span class="op" id="5588506">)</span>&nbsp;<span class="ident" id="5588508">writePairs</span><span class="op" id="5588518">(</span><span class="ident" id="5588519">recType</span>&nbsp;<span class="ident" id="5588527">recType</span><span class="op" id="5588534">,</span>&nbsp;<span class="ident" id="5588536">reqId</span>&nbsp;<span class="builtintype" id="5588542">uint16</span><span class="op" id="5588548">,</span>&nbsp;<span class="ident" id="5588550">pairs</span>&nbsp;<span class="keyword" id="5588556">map</span><span class="op" id="5588559">[</span><span class="builtintype" id="5588560">string</span><span class="op" id="5588566">]</span><span class="builtintype" id="5588567">string</span><span class="op" id="5588573">)</span>&nbsp;<span class="builtintype" id="5588575">error</span>&nbsp;<span class="op" id="5588581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588584">w</span>&nbsp;<span class="op" id="5588586">:=</span>&nbsp;<span class="ident" id="5588589">newWriter</span><span class="op" id="5588598">(</span><span class="ident" id="5588599">c</span><span class="op" id="5588600">,</span>&nbsp;<span class="ident" id="5588602">recType</span><span class="op" id="5588609">,</span>&nbsp;<span class="ident" id="5588611">reqId</span><span class="op" id="5588616">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588619">b</span>&nbsp;<span class="op" id="5588621">:=</span>&nbsp;<span class="builtinfunc" id="5588624">make</span><span class="op" id="5588628">(</span><span class="op" id="5588629">[</span><span class="op" id="5588630">]</span><span class="builtintype" id="5588631">byte</span><span class="op" id="5588635">,</span>&nbsp;<span class="num" id="5588637">8</span><span class="op" id="5588638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588641">for</span>&nbsp;<span class="ident" id="5588645">k</span><span class="op" id="5588646">,</span>&nbsp;<span class="ident" id="5588648">v</span>&nbsp;<span class="op" id="5588650">:=</span>&nbsp;<span class="keyword" id="5588653">range</span>&nbsp;<span class="ident" id="5588659">pairs</span>&nbsp;<span class="op" id="5588665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588669">n</span>&nbsp;<span class="op" id="5588671">:=</span>&nbsp;<span class="ident" id="5588674">encodeSize</span><span class="op" id="5588684">(</span><span class="ident" id="5588685">b</span><span class="op" id="5588686">,</span>&nbsp;<span class="builtintype" id="5588688">uint32</span><span class="op" id="5588694">(</span><span class="builtinfunc" id="5588695">len</span><span class="op" id="5588698">(</span><span class="ident" id="5588699">k</span><span class="op" id="5588700">)</span><span class="op" id="5588701">)</span><span class="op" id="5588702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588706">n</span>&nbsp;<span class="op" id="5588708">+=</span>&nbsp;<span class="ident" id="5588711">encodeSize</span><span class="op" id="5588721">(</span><span class="ident" id="5588722">b</span><span class="op" id="5588723">[</span><span class="ident" id="5588724">n</span><span class="op" id="5588725">:</span><span class="op" id="5588726">]</span><span class="op" id="5588727">,</span>&nbsp;<span class="builtintype" id="5588729">uint32</span><span class="op" id="5588735">(</span><span class="builtinfunc" id="5588736">len</span><span class="op" id="5588739">(</span><span class="ident" id="5588740">v</span><span class="op" id="5588741">)</span><span class="op" id="5588742">)</span><span class="op" id="5588743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588747">if</span>&nbsp;<span class="ident" id="5588750">_</span><span class="op" id="5588751">,</span>&nbsp;<span class="ident" id="5588753">err</span>&nbsp;<span class="op" id="5588757">:=</span>&nbsp;<span class="ident" id="5588760">w</span><span class="op" id="5588761">.</span><span class="ident" id="5588762">Write</span><span class="op" id="5588767">(</span><span class="ident" id="5588768">b</span><span class="op" id="5588769">[</span><span class="op" id="5588770">:</span><span class="ident" id="5588771">n</span><span class="op" id="5588772">]</span><span class="op" id="5588773">)</span><span class="op" id="5588774">;</span>&nbsp;<span class="ident" id="5588776">err</span>&nbsp;<span class="op" id="5588780">!=</span>&nbsp;<span class="ident" id="5588783">nil</span>&nbsp;<span class="op" id="5588787">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588792">return</span>&nbsp;<span class="ident" id="5588799">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5588805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588809">if</span>&nbsp;<span class="ident" id="5588812">_</span><span class="op" id="5588813">,</span>&nbsp;<span class="ident" id="5588815">err</span>&nbsp;<span class="op" id="5588819">:=</span>&nbsp;<span class="ident" id="5588822">w</span><span class="op" id="5588823">.</span><span class="ident" id="5588824">WriteString</span><span class="op" id="5588835">(</span><span class="ident" id="5588836">k</span><span class="op" id="5588837">)</span><span class="op" id="5588838">;</span>&nbsp;<span class="ident" id="5588840">err</span>&nbsp;<span class="op" id="5588844">!=</span>&nbsp;<span class="ident" id="5588847">nil</span>&nbsp;<span class="op" id="5588851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588856">return</span>&nbsp;<span class="ident" id="5588863">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5588869">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588873">if</span>&nbsp;<span class="ident" id="5588876">_</span><span class="op" id="5588877">,</span>&nbsp;<span class="ident" id="5588879">err</span>&nbsp;<span class="op" id="5588883">:=</span>&nbsp;<span class="ident" id="5588886">w</span><span class="op" id="5588887">.</span><span class="ident" id="5588888">WriteString</span><span class="op" id="5588899">(</span><span class="ident" id="5588900">v</span><span class="op" id="5588901">)</span><span class="op" id="5588902">;</span>&nbsp;<span class="ident" id="5588904">err</span>&nbsp;<span class="op" id="5588908">!=</span>&nbsp;<span class="ident" id="5588911">nil</span>&nbsp;<span class="op" id="5588915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588920">return</span>&nbsp;<span class="ident" id="5588927">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5588933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5588936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588939">w</span><span class="op" id="5588940">.</span><span class="ident" id="5588941">Close</span><span class="op" id="5588946">(</span><span class="op" id="5588947">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588950">return</span>&nbsp;<span class="ident" id="5588957">nil</span><br>
<span class="lineno"></span><span class="op" id="5588961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5588964">func</span>&nbsp;<span class="ident" id="5588969">readSize</span><span class="op" id="5588977">(</span><span class="ident" id="5588978">s</span>&nbsp;<span class="op" id="5588980">[</span><span class="op" id="5588981">]</span><span class="builtintype" id="5588982">byte</span><span class="op" id="5588986">)</span>&nbsp;<span class="op" id="5588988">(</span><span class="builtintype" id="5588989">uint32</span><span class="op" id="5588995">,</span>&nbsp;<span class="builtintype" id="5588997">int</span><span class="op" id="5589000">)</span>&nbsp;<span class="op" id="5589002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589005">if</span>&nbsp;<span class="builtinfunc" id="5589008">len</span><span class="op" id="5589011">(</span><span class="ident" id="5589012">s</span><span class="op" id="5589013">)</span>&nbsp;<span class="op" id="5589015">==</span>&nbsp;<span class="num" id="5589018">0</span>&nbsp;<span class="op" id="5589020">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589024">return</span>&nbsp;<span class="num" id="5589031">0</span><span class="op" id="5589032">,</span>&nbsp;<span class="num" id="5589034">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589040">size</span><span class="op" id="5589044">,</span>&nbsp;<span class="ident" id="5589046">n</span>&nbsp;<span class="op" id="5589048">:=</span>&nbsp;<span class="builtintype" id="5589051">uint32</span><span class="op" id="5589057">(</span><span class="ident" id="5589058">s</span><span class="op" id="5589059">[</span><span class="num" id="5589060">0</span><span class="op" id="5589061">]</span><span class="op" id="5589062">)</span><span class="op" id="5589063">,</span>&nbsp;<span class="num" id="5589065">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589068">if</span>&nbsp;<span class="ident" id="5589071">size</span><span class="op" id="5589075">&amp;</span><span class="op" id="5589076">(</span><span class="num" id="5589077">1</span><span class="op" id="5589078">&lt;&lt;</span><span class="num" id="5589080">7</span><span class="op" id="5589081">)</span>&nbsp;<span class="op" id="5589083">!=</span>&nbsp;<span class="num" id="5589086">0</span>&nbsp;<span class="op" id="5589088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589092">if</span>&nbsp;<span class="builtinfunc" id="5589095">len</span><span class="op" id="5589098">(</span><span class="ident" id="5589099">s</span><span class="op" id="5589100">)</span>&nbsp;<span class="op" id="5589102">&lt;</span>&nbsp;<span class="num" id="5589104">4</span>&nbsp;<span class="op" id="5589106">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589111">return</span>&nbsp;<span class="num" id="5589118">0</span><span class="op" id="5589119">,</span>&nbsp;<span class="num" id="5589121">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589129">n</span>&nbsp;<span class="op" id="5589131">=</span>&nbsp;<span class="num" id="5589133">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589137">size</span>&nbsp;<span class="op" id="5589142">=</span>&nbsp;<span class="ident" id="5589144">binary</span><span class="op" id="5589150">.</span><span class="ident" id="5589151">BigEndian</span><span class="op" id="5589160">.</span><span class="ident" id="5589161">Uint32</span><span class="op" id="5589167">(</span><span class="ident" id="5589168">s</span><span class="op" id="5589169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589173">size</span>&nbsp;<span class="op" id="5589178">&amp;^=</span>&nbsp;<span class="num" id="5589182">1</span>&nbsp;<span class="op" id="5589184">&lt;&lt;</span>&nbsp;<span class="num" id="5589187">31</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589194">return</span>&nbsp;<span class="ident" id="5589201">size</span><span class="op" id="5589205">,</span>&nbsp;<span class="ident" id="5589207">n</span><br>
<span class="lineno"></span><span class="op" id="5589209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5589212">func</span>&nbsp;<span class="ident" id="5589217">readString</span><span class="op" id="5589227">(</span><span class="ident" id="5589228">s</span>&nbsp;<span class="op" id="5589230">[</span><span class="op" id="5589231">]</span><span class="builtintype" id="5589232">byte</span><span class="op" id="5589236">,</span>&nbsp;<span class="ident" id="5589238">size</span>&nbsp;<span class="builtintype" id="5589243">uint32</span><span class="op" id="5589249">)</span>&nbsp;<span class="builtintype" id="5589251">string</span>&nbsp;<span class="op" id="5589258">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589261">if</span>&nbsp;<span class="ident" id="5589264">size</span>&nbsp;<span class="op" id="5589269">&gt;</span>&nbsp;<span class="builtintype" id="5589271">uint32</span><span class="op" id="5589277">(</span><span class="builtinfunc" id="5589278">len</span><span class="op" id="5589281">(</span><span class="ident" id="5589282">s</span><span class="op" id="5589283">)</span><span class="op" id="5589284">)</span>&nbsp;<span class="op" id="5589286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589290">return</span>&nbsp;<span class="string" id="5589297">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589304">return</span>&nbsp;<span class="builtintype" id="5589311">string</span><span class="op" id="5589317">(</span><span class="ident" id="5589318">s</span><span class="op" id="5589319">[</span><span class="op" id="5589320">:</span><span class="ident" id="5589321">size</span><span class="op" id="5589325">]</span><span class="op" id="5589326">)</span><br>
<span class="lineno"></span><span class="op" id="5589328">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="5589331">func</span>&nbsp;<span class="ident" id="5589336">encodeSize</span><span class="op" id="5589346">(</span><span class="ident" id="5589347">b</span>&nbsp;<span class="op" id="5589349">[</span><span class="op" id="5589350">]</span><span class="builtintype" id="5589351">byte</span><span class="op" id="5589355">,</span>&nbsp;<span class="ident" id="5589357">size</span>&nbsp;<span class="builtintype" id="5589362">uint32</span><span class="op" id="5589368">)</span>&nbsp;<span class="builtintype" id="5589370">int</span>&nbsp;<span class="op" id="5589374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589377">if</span>&nbsp;<span class="ident" id="5589380">size</span>&nbsp;<span class="op" id="5589385">&gt;</span>&nbsp;<span class="num" id="5589387">127</span>&nbsp;<span class="op" id="5589391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589395">size</span>&nbsp;<span class="op" id="5589400">|=</span>&nbsp;<span class="num" id="5589403">1</span>&nbsp;<span class="op" id="5589405">&lt;&lt;</span>&nbsp;<span class="num" id="5589408">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589413">binary</span><span class="op" id="5589419">.</span><span class="ident" id="5589420">BigEndian</span><span class="op" id="5589429">.</span><span class="ident" id="5589430">PutUint32</span><span class="op" id="5589439">(</span><span class="ident" id="5589440">b</span><span class="op" id="5589441">,</span>&nbsp;<span class="ident" id="5589443">size</span><span class="op" id="5589447">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589451">return</span>&nbsp;<span class="num" id="5589458">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589464">b</span><span class="op" id="5589465">[</span><span class="num" id="5589466">0</span><span class="op" id="5589467">]</span>&nbsp;<span class="op" id="5589469">=</span>&nbsp;<span class="builtintype" id="5589471">byte</span><span class="op" id="5589475">(</span><span class="ident" id="5589476">size</span><span class="op" id="5589480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589483">return</span>&nbsp;<span class="num" id="5589490">1</span><br>
<span class="lineno"></span><span class="op" id="5589492">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="5589495">//&nbsp;bufWriter&nbsp;encapsulates&nbsp;bufio.Writer&nbsp;but&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;stream&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5589577">//&nbsp;Closed.</span><br>
<span class="lineno"></span><span class="keyword" id="5589588">type</span>&nbsp;<span class="ident" id="5589593">bufWriter</span>&nbsp;<span class="keyword" id="5589603">struct</span>&nbsp;<span class="op" id="5589610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589613">closer</span>&nbsp;<span class="ident" id="5589620">io</span><span class="op" id="5589622">.</span><span class="ident" id="5589623">Closer</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589631">*</span><span class="ident" id="5589632">bufio</span><span class="op" id="5589637">.</span><span class="ident" id="5589638">Writer</span><br>
<span class="lineno"></span><span class="op" id="5589645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5589648">func</span>&nbsp;<span class="op" id="5589653">(</span><span class="ident" id="5589654">w</span>&nbsp;<span class="op" id="5589656">*</span><span class="ident" id="5589657">bufWriter</span><span class="op" id="5589666">)</span>&nbsp;<span class="ident" id="5589668">Close</span><span class="op" id="5589673">(</span><span class="op" id="5589674">)</span>&nbsp;<span class="builtintype" id="5589676">error</span>&nbsp;<span class="op" id="5589682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589685">if</span>&nbsp;<span class="ident" id="5589688">err</span>&nbsp;<span class="op" id="5589692">:=</span>&nbsp;<span class="ident" id="5589695">w</span><span class="op" id="5589696">.</span><span class="ident" id="5589697">Writer</span><span class="op" id="5589703">.</span><span class="ident" id="5589704">Flush</span><span class="op" id="5589709">(</span><span class="op" id="5589710">)</span><span class="op" id="5589711">;</span>&nbsp;<span class="ident" id="5589713">err</span>&nbsp;<span class="op" id="5589717">!=</span>&nbsp;<span class="ident" id="5589720">nil</span>&nbsp;<span class="op" id="5589724">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589728">w</span><span class="op" id="5589729">.</span><span class="ident" id="5589730">closer</span><span class="op" id="5589736">.</span><span class="ident" id="5589737">Close</span><span class="op" id="5589742">(</span><span class="op" id="5589743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589747">return</span>&nbsp;<span class="ident" id="5589754">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589762">return</span>&nbsp;<span class="ident" id="5589769">w</span><span class="op" id="5589770">.</span><span class="ident" id="5589771">closer</span><span class="op" id="5589777">.</span><span class="ident" id="5589778">Close</span><span class="op" id="5589783">(</span><span class="op" id="5589784">)</span><br>
<span class="lineno"></span><span class="op" id="5589786">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword" id="5589789">func</span>&nbsp;<span class="ident" id="5589794">newWriter</span><span class="op" id="5589803">(</span><span class="ident" id="5589804">c</span>&nbsp;<span class="op" id="5589806">*</span><span class="ident" id="5589807">conn</span><span class="op" id="5589811">,</span>&nbsp;<span class="ident" id="5589813">recType</span>&nbsp;<span class="ident" id="5589821">recType</span><span class="op" id="5589828">,</span>&nbsp;<span class="ident" id="5589830">reqId</span>&nbsp;<span class="builtintype" id="5589836">uint16</span><span class="op" id="5589842">)</span>&nbsp;<span class="op" id="5589844">*</span><span class="ident" id="5589845">bufWriter</span>&nbsp;<span class="op" id="5589855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589858">s</span>&nbsp;<span class="op" id="5589860">:=</span>&nbsp;<span class="op" id="5589863">&amp;</span><span class="ident" id="5589864">streamWriter</span><span class="op" id="5589876">{</span><span class="ident" id="5589877">c</span><span class="op" id="5589878">:</span>&nbsp;<span class="ident" id="5589880">c</span><span class="op" id="5589881">,</span>&nbsp;<span class="ident" id="5589883">recType</span><span class="op" id="5589890">:</span>&nbsp;<span class="ident" id="5589892">recType</span><span class="op" id="5589899">,</span>&nbsp;<span class="ident" id="5589901">reqId</span><span class="op" id="5589906">:</span>&nbsp;<span class="ident" id="5589908">reqId</span><span class="op" id="5589913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589916">w</span>&nbsp;<span class="op" id="5589918">:=</span>&nbsp;<span class="ident" id="5589921">bufio</span><span class="op" id="5589926">.</span><span class="ident" id="5589927">NewWriterSize</span><span class="op" id="5589940">(</span><span class="ident" id="5589941">s</span><span class="op" id="5589942">,</span>&nbsp;<span class="ident" id="5589944">maxWrite</span><span class="op" id="5589952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589955">return</span>&nbsp;<span class="op" id="5589962">&amp;</span><span class="ident" id="5589963">bufWriter</span><span class="op" id="5589972">{</span><span class="ident" id="5589973">s</span><span class="op" id="5589974">,</span>&nbsp;<span class="ident" id="5589976">w</span><span class="op" id="5589977">}</span><br>
<span class="lineno">245</span><span class="op" id="5589979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5589982">//&nbsp;streamWriter&nbsp;abstracts&nbsp;out&nbsp;the&nbsp;separation&nbsp;of&nbsp;a&nbsp;stream&nbsp;into&nbsp;discrete&nbsp;records.</span><br>
<span class="lineno"></span><span class="comment" id="5590062">//&nbsp;It&nbsp;only&nbsp;writes&nbsp;maxWrite&nbsp;bytes&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="5590106">type</span>&nbsp;<span class="ident" id="5590111">streamWriter</span>&nbsp;<span class="keyword" id="5590124">struct</span>&nbsp;<span class="op" id="5590131">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590134">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5590142">*</span><span class="ident" id="5590143">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590149">recType</span>&nbsp;<span class="ident" id="5590157">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590166">reqId</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5590174">uint16</span><br>
<span class="lineno"></span><span class="op" id="5590181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="5590184">func</span>&nbsp;<span class="op" id="5590189">(</span><span class="ident" id="5590190">w</span>&nbsp;<span class="op" id="5590192">*</span><span class="ident" id="5590193">streamWriter</span><span class="op" id="5590205">)</span>&nbsp;<span class="ident" id="5590207">Write</span><span class="op" id="5590212">(</span><span class="ident" id="5590213">p</span>&nbsp;<span class="op" id="5590215">[</span><span class="op" id="5590216">]</span><span class="builtintype" id="5590217">byte</span><span class="op" id="5590221">)</span>&nbsp;<span class="op" id="5590223">(</span><span class="builtintype" id="5590224">int</span><span class="op" id="5590227">,</span>&nbsp;<span class="builtintype" id="5590229">error</span><span class="op" id="5590234">)</span>&nbsp;<span class="op" id="5590236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590239">nn</span>&nbsp;<span class="op" id="5590242">:=</span>&nbsp;<span class="num" id="5590245">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5590248">for</span>&nbsp;<span class="builtinfunc" id="5590252">len</span><span class="op" id="5590255">(</span><span class="ident" id="5590256">p</span><span class="op" id="5590257">)</span>&nbsp;<span class="op" id="5590259">&gt;</span>&nbsp;<span class="num" id="5590261">0</span>&nbsp;<span class="op" id="5590263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590267">n</span>&nbsp;<span class="op" id="5590269">:=</span>&nbsp;<span class="builtinfunc" id="5590272">len</span><span class="op" id="5590275">(</span><span class="ident" id="5590276">p</span><span class="op" id="5590277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5590281">if</span>&nbsp;<span class="ident" id="5590284">n</span>&nbsp;<span class="op" id="5590286">&gt;</span>&nbsp;<span class="ident" id="5590288">maxWrite</span>&nbsp;<span class="op" id="5590297">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590302">n</span>&nbsp;<span class="op" id="5590304">=</span>&nbsp;<span class="ident" id="5590306">maxWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5590317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5590321">if</span>&nbsp;<span class="ident" id="5590324">err</span>&nbsp;<span class="op" id="5590328">:=</span>&nbsp;<span class="ident" id="5590331">w</span><span class="op" id="5590332">.</span><span class="ident" id="5590333">c</span><span class="op" id="5590334">.</span><span class="ident" id="5590335">writeRecord</span><span class="op" id="5590346">(</span><span class="ident" id="5590347">w</span><span class="op" id="5590348">.</span><span class="ident" id="5590349">recType</span><span class="op" id="5590356">,</span>&nbsp;<span class="ident" id="5590358">w</span><span class="op" id="5590359">.</span><span class="ident" id="5590360">reqId</span><span class="op" id="5590365">,</span>&nbsp;<span class="ident" id="5590367">p</span><span class="op" id="5590368">[</span><span class="op" id="5590369">:</span><span class="ident" id="5590370">n</span><span class="op" id="5590371">]</span><span class="op" id="5590372">)</span><span class="op" id="5590373">;</span>&nbsp;<span class="ident" id="5590375">err</span>&nbsp;<span class="op" id="5590379">!=</span>&nbsp;<span class="ident" id="5590382">nil</span>&nbsp;<span class="op" id="5590386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5590391">return</span>&nbsp;<span class="ident" id="5590398">nn</span><span class="op" id="5590400">,</span>&nbsp;<span class="ident" id="5590402">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5590408">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590412">nn</span>&nbsp;<span class="op" id="5590415">+=</span>&nbsp;<span class="ident" id="5590418">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590422">p</span>&nbsp;<span class="op" id="5590424">=</span>&nbsp;<span class="ident" id="5590426">p</span><span class="op" id="5590427">[</span><span class="ident" id="5590428">n</span><span class="op" id="5590429">:</span><span class="op" id="5590430">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5590433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5590436">return</span>&nbsp;<span class="ident" id="5590443">nn</span><span class="op" id="5590445">,</span>&nbsp;<span class="ident" id="5590447">nil</span><br>
<span class="lineno"></span><span class="op" id="5590451">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="5590454">func</span>&nbsp;<span class="op" id="5590459">(</span><span class="ident" id="5590460">w</span>&nbsp;<span class="op" id="5590462">*</span><span class="ident" id="5590463">streamWriter</span><span class="op" id="5590475">)</span>&nbsp;<span class="ident" id="5590477">Close</span><span class="op" id="5590482">(</span><span class="op" id="5590483">)</span>&nbsp;<span class="builtintype" id="5590485">error</span>&nbsp;<span class="op" id="5590491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5590494">//&nbsp;send&nbsp;empty&nbsp;record&nbsp;to&nbsp;close&nbsp;the&nbsp;stream</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5590536">return</span>&nbsp;<span class="ident" id="5590543">w</span><span class="op" id="5590544">.</span><span class="ident" id="5590545">c</span><span class="op" id="5590546">.</span><span class="ident" id="5590547">writeRecord</span><span class="op" id="5590558">(</span><span class="ident" id="5590559">w</span><span class="op" id="5590560">.</span><span class="ident" id="5590561">recType</span><span class="op" id="5590568">,</span>&nbsp;<span class="ident" id="5590570">w</span><span class="op" id="5590571">.</span><span class="ident" id="5590572">reqId</span><span class="op" id="5590577">,</span>&nbsp;<span class="ident" id="5590579">nil</span><span class="op" id="5590582">)</span><br>
<span class="lineno"></span><span class="op" id="5590584">}</span>
</div>
</body>
</html>
