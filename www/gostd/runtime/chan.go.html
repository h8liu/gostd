<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1481607">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1481662">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1481716">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1481767">package</span>&nbsp;<span class="ident" id="1481775">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1481784">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;channels.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1481842">import</span>&nbsp;<span class="string" id="1481849">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1481859">const</span>&nbsp;<span class="op" id="1481865">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481868">maxAlign</span>&nbsp;&nbsp;<span class="op" id="1481878">=</span>&nbsp;<span class="num" id="1481880">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481883">hchanSize</span>&nbsp;<span class="op" id="1481893">=</span>&nbsp;<span class="ident" id="1481895">unsafe</span><span class="op" id="1481901">.</span><span class="ident" id="1481902">Sizeof</span><span class="op" id="1481908">(</span><span class="ident" id="1481909">hchan</span><span class="op" id="1481914">{</span><span class="op" id="1481915">}</span><span class="op" id="1481916">)</span>&nbsp;<span class="op" id="1481918">+</span>&nbsp;<span class="builtintype" id="1481920">uintptr</span><span class="op" id="1481927">(</span><span class="op" id="1481928">-</span><span class="builtintype" id="1481929">int</span><span class="op" id="1481932">(</span><span class="ident" id="1481933">unsafe</span><span class="op" id="1481939">.</span><span class="ident" id="1481940">Sizeof</span><span class="op" id="1481946">(</span><span class="ident" id="1481947">hchan</span><span class="op" id="1481952">{</span><span class="op" id="1481953">}</span><span class="op" id="1481954">)</span><span class="op" id="1481955">)</span><span class="op" id="1481956">&amp;</span><span class="op" id="1481957">(</span><span class="ident" id="1481958">maxAlign</span><span class="op" id="1481966">-</span><span class="num" id="1481967">1</span><span class="op" id="1481968">)</span><span class="op" id="1481969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481972">debugChan</span>&nbsp;<span class="op" id="1481982">=</span>&nbsp;<span class="builtintype" id="1481984">false</span><br>
<span class="lineno">15</span><span class="op" id="1481990">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1481993">//&nbsp;TODO(khr):&nbsp;make&nbsp;hchan.buf&nbsp;an&nbsp;unsafe.Pointer,&nbsp;not&nbsp;a&nbsp;*uint8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1482055">func</span>&nbsp;<span class="ident" id="1482060">makechan</span><span class="op" id="1482068">(</span><span class="ident" id="1482069">t</span>&nbsp;<span class="op" id="1482071">*</span><span class="ident" id="1482072">chantype</span><span class="op" id="1482080">,</span>&nbsp;<span class="ident" id="1482082">size</span>&nbsp;<span class="ident" id="1482087">int64</span><span class="op" id="1482092">)</span>&nbsp;<span class="op" id="1482094">*</span><span class="ident" id="1482095">hchan</span>&nbsp;<span class="op" id="1482101">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1482104">elem</span>&nbsp;<span class="op" id="1482109">:=</span>&nbsp;<span class="ident" id="1482112">t</span><span class="op" id="1482113">.</span><span class="ident" id="1482114">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482121">//&nbsp;compiler&nbsp;checks&nbsp;this&nbsp;but&nbsp;be&nbsp;safe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1482159">if</span>&nbsp;<span class="ident" id="1482162">elem</span><span class="op" id="1482166">.</span><span class="ident" id="1482167">size</span>&nbsp;<span class="op" id="1482172">&gt;=</span>&nbsp;<span class="num" id="1482175">1</span><span class="op" id="1482176">&lt;&lt;</span><span class="num" id="1482178">16</span>&nbsp;<span class="op" id="1482181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1482185">gothrow</span><span class="op" id="1482192">(</span><span class="string" id="1482193">&#34;makechan:&nbsp;invalid&nbsp;channel&nbsp;element&nbsp;type&#34;</span><span class="op" id="1482233">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1482239">if</span>&nbsp;<span class="ident" id="1482242">hchanSize</span><span class="op" id="1482251">%</span><span class="ident" id="1482252">maxAlign</span>&nbsp;<span class="op" id="1482261">!=</span>&nbsp;<span class="num" id="1482264">0</span>&nbsp;<span class="op" id="1482266">||</span>&nbsp;<span class="ident" id="1482269">elem</span><span class="op" id="1482273">.</span><span class="ident" id="1482274">align</span>&nbsp;<span class="op" id="1482280">&gt;</span>&nbsp;<span class="ident" id="1482282">maxAlign</span>&nbsp;<span class="op" id="1482291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1482295">gothrow</span><span class="op" id="1482302">(</span><span class="string" id="1482303">&#34;makechan:&nbsp;bad&nbsp;alignment&#34;</span><span class="op" id="1482328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1482334">if</span>&nbsp;<span class="ident" id="1482337">size</span>&nbsp;<span class="op" id="1482342">&lt;</span>&nbsp;<span class="num" id="1482344">0</span>&nbsp;<span class="op" id="1482346">||</span>&nbsp;<span class="ident" id="1482349">int64</span><span class="op" id="1482354">(</span><span class="builtintype" id="1482355">uintptr</span><span class="op" id="1482362">(</span><span class="ident" id="1482363">size</span><span class="op" id="1482367">)</span><span class="op" id="1482368">)</span>&nbsp;<span class="op" id="1482370">!=</span>&nbsp;<span class="ident" id="1482373">size</span>&nbsp;<span class="op" id="1482378">||</span>&nbsp;<span class="op" id="1482381">(</span><span class="ident" id="1482382">elem</span><span class="op" id="1482386">.</span><span class="ident" id="1482387">size</span>&nbsp;<span class="op" id="1482392">&gt;</span>&nbsp;<span class="num" id="1482394">0</span>&nbsp;<span class="op" id="1482396">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1482399">uintptr</span><span class="op" id="1482406">(</span><span class="ident" id="1482407">size</span><span class="op" id="1482411">)</span>&nbsp;<span class="op" id="1482413">&gt;</span>&nbsp;<span class="op" id="1482415">(</span><span class="ident" id="1482416">maxmem</span><span class="op" id="1482422">-</span><span class="ident" id="1482423">hchanSize</span><span class="op" id="1482432">)</span><span class="op" id="1482433">/</span><span class="builtintype" id="1482434">uintptr</span><span class="op" id="1482441">(</span><span class="ident" id="1482442">elem</span><span class="op" id="1482446">.</span><span class="ident" id="1482447">size</span><span class="op" id="1482451">)</span><span class="op" id="1482452">)</span>&nbsp;<span class="op" id="1482454">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1482458">panic</span><span class="op" id="1482463">(</span><span class="string" id="1482464">&#34;makechan:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1482493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1482500">var</span>&nbsp;<span class="ident" id="1482504">c</span>&nbsp;<span class="op" id="1482506">*</span><span class="ident" id="1482507">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1482514">if</span>&nbsp;<span class="ident" id="1482517">elem</span><span class="op" id="1482521">.</span><span class="ident" id="1482522">kind</span><span class="op" id="1482526">&amp;</span><span class="ident" id="1482527">kindNoPointers</span>&nbsp;<span class="op" id="1482542">!=</span>&nbsp;<span class="num" id="1482545">0</span>&nbsp;<span class="op" id="1482547">||</span>&nbsp;<span class="ident" id="1482550">size</span>&nbsp;<span class="op" id="1482555">==</span>&nbsp;<span class="num" id="1482558">0</span>&nbsp;<span class="op" id="1482560">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482564">//&nbsp;Allocate&nbsp;memory&nbsp;in&nbsp;one&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482598">//&nbsp;Hchan&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC&nbsp;in&nbsp;this&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482668">//&nbsp;buf&nbsp;points&nbsp;into&nbsp;the&nbsp;same&nbsp;allocation,&nbsp;elemtype&nbsp;is&nbsp;persistent.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482734">//&nbsp;SudoG&#39;s&nbsp;are&nbsp;referenced&nbsp;from&nbsp;their&nbsp;owning&nbsp;thread&nbsp;so&nbsp;they&nbsp;can&#39;t&nbsp;be&nbsp;collected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482815">//&nbsp;TODO(dvyukov,rlh):&nbsp;Rethink&nbsp;when&nbsp;collector&nbsp;can&nbsp;move&nbsp;allocated&nbsp;objects.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1482890">c</span>&nbsp;<span class="op" id="1482892">=</span>&nbsp;<span class="op" id="1482894">(</span><span class="op" id="1482895">*</span><span class="ident" id="1482896">hchan</span><span class="op" id="1482901">)</span><span class="op" id="1482902">(</span><span class="ident" id="1482903">mallocgc</span><span class="op" id="1482911">(</span><span class="ident" id="1482912">hchanSize</span><span class="op" id="1482921">+</span><span class="builtintype" id="1482922">uintptr</span><span class="op" id="1482929">(</span><span class="ident" id="1482930">size</span><span class="op" id="1482934">)</span><span class="op" id="1482935">*</span><span class="builtintype" id="1482936">uintptr</span><span class="op" id="1482943">(</span><span class="ident" id="1482944">elem</span><span class="op" id="1482948">.</span><span class="ident" id="1482949">size</span><span class="op" id="1482953">)</span><span class="op" id="1482954">,</span>&nbsp;<span class="ident" id="1482956">nil</span><span class="op" id="1482959">,</span>&nbsp;<span class="ident" id="1482961">flagNoScan</span><span class="op" id="1482971">)</span><span class="op" id="1482972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1482976">if</span>&nbsp;<span class="ident" id="1482979">size</span>&nbsp;<span class="op" id="1482984">&gt;</span>&nbsp;<span class="num" id="1482986">0</span>&nbsp;<span class="op" id="1482988">&amp;&amp;</span>&nbsp;<span class="ident" id="1482991">elem</span><span class="op" id="1482995">.</span><span class="ident" id="1482996">size</span>&nbsp;<span class="op" id="1483001">!=</span>&nbsp;<span class="num" id="1483004">0</span>&nbsp;<span class="op" id="1483006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483011">c</span><span class="op" id="1483012">.</span><span class="ident" id="1483013">buf</span>&nbsp;<span class="op" id="1483017">=</span>&nbsp;<span class="op" id="1483019">(</span><span class="op" id="1483020">*</span><span class="builtintype" id="1483021">uint8</span><span class="op" id="1483026">)</span><span class="op" id="1483027">(</span><span class="ident" id="1483028">add</span><span class="op" id="1483031">(</span><span class="ident" id="1483032">unsafe</span><span class="op" id="1483038">.</span><span class="ident" id="1483039">Pointer</span><span class="op" id="1483046">(</span><span class="ident" id="1483047">c</span><span class="op" id="1483048">)</span><span class="op" id="1483049">,</span>&nbsp;<span class="ident" id="1483051">hchanSize</span><span class="op" id="1483060">)</span><span class="op" id="1483061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483065">}</span>&nbsp;<span class="keyword" id="1483067">else</span>&nbsp;<span class="op" id="1483072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483077">c</span><span class="op" id="1483078">.</span><span class="ident" id="1483079">buf</span>&nbsp;<span class="op" id="1483083">=</span>&nbsp;<span class="op" id="1483085">(</span><span class="op" id="1483086">*</span><span class="builtintype" id="1483087">uint8</span><span class="op" id="1483092">)</span><span class="op" id="1483093">(</span><span class="ident" id="1483094">unsafe</span><span class="op" id="1483100">.</span><span class="ident" id="1483101">Pointer</span><span class="op" id="1483108">(</span><span class="ident" id="1483109">c</span><span class="op" id="1483110">)</span><span class="op" id="1483111">)</span>&nbsp;<span class="comment" id="1483113">//&nbsp;race&nbsp;detector&nbsp;uses&nbsp;this&nbsp;location&nbsp;for&nbsp;synchronization</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483174">}</span>&nbsp;<span class="keyword" id="1483176">else</span>&nbsp;<span class="op" id="1483181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483185">c</span>&nbsp;<span class="op" id="1483187">=</span>&nbsp;<span class="builtinfunc" id="1483189">new</span><span class="op" id="1483192">(</span><span class="ident" id="1483193">hchan</span><span class="op" id="1483198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483202">c</span><span class="op" id="1483203">.</span><span class="ident" id="1483204">buf</span>&nbsp;<span class="op" id="1483208">=</span>&nbsp;<span class="op" id="1483210">(</span><span class="op" id="1483211">*</span><span class="builtintype" id="1483212">uint8</span><span class="op" id="1483217">)</span><span class="op" id="1483218">(</span><span class="ident" id="1483219">newarray</span><span class="op" id="1483227">(</span><span class="ident" id="1483228">elem</span><span class="op" id="1483232">,</span>&nbsp;<span class="builtintype" id="1483234">uintptr</span><span class="op" id="1483241">(</span><span class="ident" id="1483242">size</span><span class="op" id="1483246">)</span><span class="op" id="1483247">)</span><span class="op" id="1483248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483251">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483254">c</span><span class="op" id="1483255">.</span><span class="ident" id="1483256">elemsize</span>&nbsp;<span class="op" id="1483265">=</span>&nbsp;<span class="builtintype" id="1483267">uint16</span><span class="op" id="1483273">(</span><span class="ident" id="1483274">elem</span><span class="op" id="1483278">.</span><span class="ident" id="1483279">size</span><span class="op" id="1483283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483286">c</span><span class="op" id="1483287">.</span><span class="ident" id="1483288">elemtype</span>&nbsp;<span class="op" id="1483297">=</span>&nbsp;<span class="ident" id="1483299">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483305">c</span><span class="op" id="1483306">.</span><span class="ident" id="1483307">dataqsiz</span>&nbsp;<span class="op" id="1483316">=</span>&nbsp;<span class="builtintype" id="1483318">uint</span><span class="op" id="1483322">(</span><span class="ident" id="1483323">size</span><span class="op" id="1483327">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483331">if</span>&nbsp;<span class="ident" id="1483334">debugChan</span>&nbsp;<span class="op" id="1483344">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1483348">print</span><span class="op" id="1483353">(</span><span class="string" id="1483354">&#34;makechan:&nbsp;chan=&#34;</span><span class="op" id="1483371">,</span>&nbsp;<span class="ident" id="1483373">c</span><span class="op" id="1483374">,</span>&nbsp;<span class="string" id="1483376">&#34;;&nbsp;elemsize=&#34;</span><span class="op" id="1483389">,</span>&nbsp;<span class="ident" id="1483391">elem</span><span class="op" id="1483395">.</span><span class="ident" id="1483396">size</span><span class="op" id="1483400">,</span>&nbsp;<span class="string" id="1483402">&#34;;&nbsp;elemalg=&#34;</span><span class="op" id="1483414">,</span>&nbsp;<span class="ident" id="1483416">elem</span><span class="op" id="1483420">.</span><span class="ident" id="1483421">alg</span><span class="op" id="1483424">,</span>&nbsp;<span class="string" id="1483426">&#34;;&nbsp;dataqsiz=&#34;</span><span class="op" id="1483439">,</span>&nbsp;<span class="ident" id="1483441">size</span><span class="op" id="1483445">,</span>&nbsp;<span class="string" id="1483447">&#34;\n&#34;</span><span class="op" id="1483451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483457">return</span>&nbsp;<span class="ident" id="1483464">c</span><br>
<span class="lineno"></span><span class="op" id="1483466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1483469">//&nbsp;chanbuf(c,&nbsp;i)&nbsp;is&nbsp;pointer&nbsp;to&nbsp;the&nbsp;i&#39;th&nbsp;slot&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="1483529">func</span>&nbsp;<span class="ident" id="1483534">chanbuf</span><span class="op" id="1483541">(</span><span class="ident" id="1483542">c</span>&nbsp;<span class="op" id="1483544">*</span><span class="ident" id="1483545">hchan</span><span class="op" id="1483550">,</span>&nbsp;<span class="ident" id="1483552">i</span>&nbsp;<span class="builtintype" id="1483554">uint</span><span class="op" id="1483558">)</span>&nbsp;<span class="ident" id="1483560">unsafe</span><span class="op" id="1483566">.</span><span class="ident" id="1483567">Pointer</span>&nbsp;<span class="op" id="1483575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483578">return</span>&nbsp;<span class="ident" id="1483585">add</span><span class="op" id="1483588">(</span><span class="ident" id="1483589">unsafe</span><span class="op" id="1483595">.</span><span class="ident" id="1483596">Pointer</span><span class="op" id="1483603">(</span><span class="ident" id="1483604">c</span><span class="op" id="1483605">.</span><span class="ident" id="1483606">buf</span><span class="op" id="1483609">)</span><span class="op" id="1483610">,</span>&nbsp;<span class="builtintype" id="1483612">uintptr</span><span class="op" id="1483619">(</span><span class="ident" id="1483620">i</span><span class="op" id="1483621">)</span><span class="op" id="1483622">*</span><span class="builtintype" id="1483623">uintptr</span><span class="op" id="1483630">(</span><span class="ident" id="1483631">c</span><span class="op" id="1483632">.</span><span class="ident" id="1483633">elemsize</span><span class="op" id="1483641">)</span><span class="op" id="1483642">)</span><br>
<span class="lineno"></span><span class="op" id="1483644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="1483647">//&nbsp;entry&nbsp;point&nbsp;for&nbsp;c&nbsp;&lt;-&nbsp;x&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1483692">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1483705">func</span>&nbsp;<span class="ident" id="1483710">chansend1</span><span class="op" id="1483719">(</span><span class="ident" id="1483720">t</span>&nbsp;<span class="op" id="1483722">*</span><span class="ident" id="1483723">chantype</span><span class="op" id="1483731">,</span>&nbsp;<span class="ident" id="1483733">c</span>&nbsp;<span class="op" id="1483735">*</span><span class="ident" id="1483736">hchan</span><span class="op" id="1483741">,</span>&nbsp;<span class="ident" id="1483743">elem</span>&nbsp;<span class="ident" id="1483748">unsafe</span><span class="op" id="1483754">.</span><span class="ident" id="1483755">Pointer</span><span class="op" id="1483762">)</span>&nbsp;<span class="op" id="1483764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483767">chansend</span><span class="op" id="1483775">(</span><span class="ident" id="1483776">t</span><span class="op" id="1483777">,</span>&nbsp;<span class="ident" id="1483779">c</span><span class="op" id="1483780">,</span>&nbsp;<span class="ident" id="1483782">elem</span><span class="op" id="1483786">,</span>&nbsp;<span class="builtintype" id="1483788">true</span><span class="op" id="1483792">,</span>&nbsp;<span class="ident" id="1483794">getcallerpc</span><span class="op" id="1483805">(</span><span class="ident" id="1483806">unsafe</span><span class="op" id="1483812">.</span><span class="ident" id="1483813">Pointer</span><span class="op" id="1483820">(</span><span class="op" id="1483821">&amp;</span><span class="ident" id="1483822">t</span><span class="op" id="1483823">)</span><span class="op" id="1483824">)</span><span class="op" id="1483825">)</span><br>
<span class="lineno"></span><span class="op" id="1483827">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="1483830">/*<br>
<span class="lineno"></span>&nbsp;*&nbsp;generic&nbsp;single&nbsp;channel&nbsp;send/recv<br>
<span class="lineno"></span>&nbsp;*&nbsp;If&nbsp;block&nbsp;is&nbsp;not&nbsp;nil,<br>
<span class="lineno"></span>&nbsp;*&nbsp;then&nbsp;the&nbsp;protocol&nbsp;will&nbsp;not<br>
<span class="lineno">75</span>&nbsp;*&nbsp;sleep&nbsp;but&nbsp;return&nbsp;if&nbsp;it&nbsp;could<br>
<span class="lineno"></span>&nbsp;*&nbsp;not&nbsp;complete.<br>
<span class="lineno"></span>&nbsp;*<br>
<span class="lineno"></span>&nbsp;*&nbsp;sleep&nbsp;can&nbsp;wake&nbsp;up&nbsp;with&nbsp;g.param&nbsp;==&nbsp;nil<br>
<span class="lineno"></span>&nbsp;*&nbsp;when&nbsp;a&nbsp;channel&nbsp;involved&nbsp;in&nbsp;the&nbsp;sleep&nbsp;has<br>
<span class="lineno">80</span>&nbsp;*&nbsp;been&nbsp;closed.&nbsp;&nbsp;it&nbsp;is&nbsp;easiest&nbsp;to&nbsp;loop&nbsp;and&nbsp;re-run<br>
<span class="lineno"></span>&nbsp;*&nbsp;the&nbsp;operation;&nbsp;we&#39;ll&nbsp;see&nbsp;that&nbsp;it&#39;s&nbsp;now&nbsp;closed.<br>
<span class="lineno"></span>&nbsp;*/</span><br>
<span class="lineno"></span><span class="keyword" id="1484164">func</span>&nbsp;<span class="ident" id="1484169">chansend</span><span class="op" id="1484177">(</span><span class="ident" id="1484178">t</span>&nbsp;<span class="op" id="1484180">*</span><span class="ident" id="1484181">chantype</span><span class="op" id="1484189">,</span>&nbsp;<span class="ident" id="1484191">c</span>&nbsp;<span class="op" id="1484193">*</span><span class="ident" id="1484194">hchan</span><span class="op" id="1484199">,</span>&nbsp;<span class="ident" id="1484201">ep</span>&nbsp;<span class="ident" id="1484204">unsafe</span><span class="op" id="1484210">.</span><span class="ident" id="1484211">Pointer</span><span class="op" id="1484218">,</span>&nbsp;<span class="ident" id="1484220">block</span>&nbsp;<span class="builtintype" id="1484226">bool</span><span class="op" id="1484230">,</span>&nbsp;<span class="ident" id="1484232">callerpc</span>&nbsp;<span class="builtintype" id="1484241">uintptr</span><span class="op" id="1484248">)</span>&nbsp;<span class="builtintype" id="1484250">bool</span>&nbsp;<span class="op" id="1484255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484258">if</span>&nbsp;<span class="ident" id="1484261">raceenabled</span>&nbsp;<span class="op" id="1484273">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484277">raceReadObjectPC</span><span class="op" id="1484293">(</span><span class="ident" id="1484294">t</span><span class="op" id="1484295">.</span><span class="ident" id="1484296">elem</span><span class="op" id="1484300">,</span>&nbsp;<span class="ident" id="1484302">ep</span><span class="op" id="1484304">,</span>&nbsp;<span class="ident" id="1484306">callerpc</span><span class="op" id="1484314">,</span>&nbsp;<span class="ident" id="1484316">funcPC</span><span class="op" id="1484322">(</span><span class="ident" id="1484323">chansend</span><span class="op" id="1484331">)</span><span class="op" id="1484332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1484335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484339">if</span>&nbsp;<span class="ident" id="1484342">c</span>&nbsp;<span class="op" id="1484344">==</span>&nbsp;<span class="ident" id="1484347">nil</span>&nbsp;<span class="op" id="1484351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484355">if</span>&nbsp;<span class="op" id="1484358">!</span><span class="ident" id="1484359">block</span>&nbsp;<span class="op" id="1484365">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484370">return</span>&nbsp;<span class="builtintype" id="1484377">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1484385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484389">gopark</span><span class="op" id="1484395">(</span><span class="ident" id="1484396">nil</span><span class="op" id="1484399">,</span>&nbsp;<span class="ident" id="1484401">nil</span><span class="op" id="1484404">,</span>&nbsp;<span class="string" id="1484406">&#34;chan&nbsp;send&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1484428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484432">gothrow</span><span class="op" id="1484439">(</span><span class="string" id="1484440">&#34;unreachable&#34;</span><span class="op" id="1484453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1484456">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484460">if</span>&nbsp;<span class="ident" id="1484463">debugChan</span>&nbsp;<span class="op" id="1484473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1484477">print</span><span class="op" id="1484482">(</span><span class="string" id="1484483">&#34;chansend:&nbsp;chan=&#34;</span><span class="op" id="1484500">,</span>&nbsp;<span class="ident" id="1484502">c</span><span class="op" id="1484503">,</span>&nbsp;<span class="string" id="1484505">&#34;\n&#34;</span><span class="op" id="1484509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1484512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484516">if</span>&nbsp;<span class="ident" id="1484519">raceenabled</span>&nbsp;<span class="op" id="1484531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1484535">racereadpc</span><span class="op" id="1484545">(</span><span class="ident" id="1484546">unsafe</span><span class="op" id="1484552">.</span><span class="ident" id="1484553">Pointer</span><span class="op" id="1484560">(</span><span class="ident" id="1484561">c</span><span class="op" id="1484562">)</span><span class="op" id="1484563">,</span>&nbsp;<span class="ident" id="1484565">callerpc</span><span class="op" id="1484573">,</span>&nbsp;<span class="ident" id="1484575">funcPC</span><span class="op" id="1484581">(</span><span class="ident" id="1484582">chansend</span><span class="op" id="1484590">)</span><span class="op" id="1484591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1484594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1484598">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1484681">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1484685">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1484768">//&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1484850">//&nbsp;(first&nbsp;c.closed&nbsp;and&nbsp;second&nbsp;c.recvq.first&nbsp;or&nbsp;c.qcount&nbsp;depending&nbsp;on&nbsp;kind&nbsp;of&nbsp;channel).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1484938">//&nbsp;Because&nbsp;a&nbsp;closed&nbsp;channel&nbsp;cannot&nbsp;transition&nbsp;from&nbsp;&#39;ready&nbsp;for&nbsp;sending&#39;&nbsp;to</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1485013">//&nbsp;&#39;not&nbsp;ready&nbsp;for&nbsp;sending&#39;,&nbsp;even&nbsp;if&nbsp;the&nbsp;channel&nbsp;is&nbsp;closed&nbsp;between&nbsp;the&nbsp;two&nbsp;observations,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1485102">//&nbsp;they&nbsp;imply&nbsp;a&nbsp;moment&nbsp;between&nbsp;the&nbsp;two&nbsp;when&nbsp;the&nbsp;channel&nbsp;was&nbsp;both&nbsp;not&nbsp;yet&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1485183">//&nbsp;and&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1485270">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;send&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1485315">//</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1485319">//&nbsp;It&nbsp;is&nbsp;okay&nbsp;if&nbsp;the&nbsp;reads&nbsp;are&nbsp;reordered&nbsp;here:&nbsp;if&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1485405">//&nbsp;ready&nbsp;for&nbsp;sending&nbsp;and&nbsp;then&nbsp;observe&nbsp;that&nbsp;it&nbsp;is&nbsp;not&nbsp;closed,&nbsp;that&nbsp;implies&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1485489">//&nbsp;channel&nbsp;wasn&#39;t&nbsp;closed&nbsp;during&nbsp;the&nbsp;first&nbsp;observation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485545">if</span>&nbsp;<span class="op" id="1485548">!</span><span class="ident" id="1485549">block</span>&nbsp;<span class="op" id="1485555">&amp;&amp;</span>&nbsp;<span class="ident" id="1485558">c</span><span class="op" id="1485559">.</span><span class="ident" id="1485560">closed</span>&nbsp;<span class="op" id="1485567">==</span>&nbsp;<span class="num" id="1485570">0</span>&nbsp;<span class="op" id="1485572">&amp;&amp;</span>&nbsp;<span class="op" id="1485575">(</span><span class="op" id="1485576">(</span><span class="ident" id="1485577">c</span><span class="op" id="1485578">.</span><span class="ident" id="1485579">dataqsiz</span>&nbsp;<span class="op" id="1485588">==</span>&nbsp;<span class="num" id="1485591">0</span>&nbsp;<span class="op" id="1485593">&amp;&amp;</span>&nbsp;<span class="ident" id="1485596">c</span><span class="op" id="1485597">.</span><span class="ident" id="1485598">recvq</span><span class="op" id="1485603">.</span><span class="ident" id="1485604">first</span>&nbsp;<span class="op" id="1485610">==</span>&nbsp;<span class="ident" id="1485613">nil</span><span class="op" id="1485616">)</span>&nbsp;<span class="op" id="1485618">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1485623">(</span><span class="ident" id="1485624">c</span><span class="op" id="1485625">.</span><span class="ident" id="1485626">dataqsiz</span>&nbsp;<span class="op" id="1485635">&gt;</span>&nbsp;<span class="num" id="1485637">0</span>&nbsp;<span class="op" id="1485639">&amp;&amp;</span>&nbsp;<span class="ident" id="1485642">c</span><span class="op" id="1485643">.</span><span class="ident" id="1485644">qcount</span>&nbsp;<span class="op" id="1485651">==</span>&nbsp;<span class="ident" id="1485654">c</span><span class="op" id="1485655">.</span><span class="ident" id="1485656">dataqsiz</span><span class="op" id="1485664">)</span><span class="op" id="1485665">)</span>&nbsp;<span class="op" id="1485667">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485671">return</span>&nbsp;<span class="builtintype" id="1485678">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1485685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485689">var</span>&nbsp;<span class="ident" id="1485693">t0</span>&nbsp;<span class="ident" id="1485696">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485703">if</span>&nbsp;<span class="ident" id="1485706">blockprofilerate</span>&nbsp;<span class="op" id="1485723">&gt;</span>&nbsp;<span class="num" id="1485725">0</span>&nbsp;<span class="op" id="1485727">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485731">t0</span>&nbsp;<span class="op" id="1485734">=</span>&nbsp;<span class="ident" id="1485736">cputicks</span><span class="op" id="1485744">(</span><span class="op" id="1485745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1485748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485752">lock</span><span class="op" id="1485756">(</span><span class="op" id="1485757">&amp;</span><span class="ident" id="1485758">c</span><span class="op" id="1485759">.</span><span class="ident" id="1485760">lock</span><span class="op" id="1485764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485767">if</span>&nbsp;<span class="ident" id="1485770">c</span><span class="op" id="1485771">.</span><span class="ident" id="1485772">closed</span>&nbsp;<span class="op" id="1485779">!=</span>&nbsp;<span class="num" id="1485782">0</span>&nbsp;<span class="op" id="1485784">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485788">unlock</span><span class="op" id="1485794">(</span><span class="op" id="1485795">&amp;</span><span class="ident" id="1485796">c</span><span class="op" id="1485797">.</span><span class="ident" id="1485798">lock</span><span class="op" id="1485802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1485806">panic</span><span class="op" id="1485811">(</span><span class="string" id="1485812">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1485836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1485839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485843">if</span>&nbsp;<span class="ident" id="1485846">c</span><span class="op" id="1485847">.</span><span class="ident" id="1485848">dataqsiz</span>&nbsp;<span class="op" id="1485857">==</span>&nbsp;<span class="num" id="1485860">0</span>&nbsp;<span class="op" id="1485862">{</span>&nbsp;<span class="comment" id="1485864">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485889">sg</span>&nbsp;<span class="op" id="1485892">:=</span>&nbsp;<span class="ident" id="1485895">c</span><span class="op" id="1485896">.</span><span class="ident" id="1485897">recvq</span><span class="op" id="1485902">.</span><span class="ident" id="1485903">dequeue</span><span class="op" id="1485910">(</span><span class="op" id="1485911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485915">if</span>&nbsp;<span class="ident" id="1485918">sg</span>&nbsp;<span class="op" id="1485921">!=</span>&nbsp;<span class="ident" id="1485924">nil</span>&nbsp;<span class="op" id="1485928">{</span>&nbsp;<span class="comment" id="1485930">//&nbsp;found&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1485961">if</span>&nbsp;<span class="ident" id="1485964">raceenabled</span>&nbsp;<span class="op" id="1485976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485982">racesync</span><span class="op" id="1485990">(</span><span class="ident" id="1485991">c</span><span class="op" id="1485992">,</span>&nbsp;<span class="ident" id="1485994">sg</span><span class="op" id="1485996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1486001">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486006">unlock</span><span class="op" id="1486012">(</span><span class="op" id="1486013">&amp;</span><span class="ident" id="1486014">c</span><span class="op" id="1486015">.</span><span class="ident" id="1486016">lock</span><span class="op" id="1486020">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486026">recvg</span>&nbsp;<span class="op" id="1486032">:=</span>&nbsp;<span class="ident" id="1486035">sg</span><span class="op" id="1486037">.</span><span class="ident" id="1486038">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1486043">if</span>&nbsp;<span class="ident" id="1486046">sg</span><span class="op" id="1486048">.</span><span class="ident" id="1486049">elem</span>&nbsp;<span class="op" id="1486054">!=</span>&nbsp;<span class="ident" id="1486057">nil</span>&nbsp;<span class="op" id="1486061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486067">memmove</span><span class="op" id="1486074">(</span><span class="ident" id="1486075">unsafe</span><span class="op" id="1486081">.</span><span class="ident" id="1486082">Pointer</span><span class="op" id="1486089">(</span><span class="ident" id="1486090">sg</span><span class="op" id="1486092">.</span><span class="ident" id="1486093">elem</span><span class="op" id="1486097">)</span><span class="op" id="1486098">,</span>&nbsp;<span class="ident" id="1486100">ep</span><span class="op" id="1486102">,</span>&nbsp;<span class="builtintype" id="1486104">uintptr</span><span class="op" id="1486111">(</span><span class="ident" id="1486112">c</span><span class="op" id="1486113">.</span><span class="ident" id="1486114">elemsize</span><span class="op" id="1486122">)</span><span class="op" id="1486123">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486129">sg</span><span class="op" id="1486131">.</span><span class="ident" id="1486132">elem</span>&nbsp;<span class="op" id="1486137">=</span>&nbsp;<span class="ident" id="1486139">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1486146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486151">recvg</span><span class="op" id="1486156">.</span><span class="ident" id="1486157">param</span>&nbsp;<span class="op" id="1486163">=</span>&nbsp;<span class="ident" id="1486165">unsafe</span><span class="op" id="1486171">.</span><span class="ident" id="1486172">Pointer</span><span class="op" id="1486179">(</span><span class="ident" id="1486180">sg</span><span class="op" id="1486182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1486187">if</span>&nbsp;<span class="ident" id="1486190">sg</span><span class="op" id="1486192">.</span><span class="ident" id="1486193">releasetime</span>&nbsp;<span class="op" id="1486205">!=</span>&nbsp;<span class="num" id="1486208">0</span>&nbsp;<span class="op" id="1486210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486216">sg</span><span class="op" id="1486218">.</span><span class="ident" id="1486219">releasetime</span>&nbsp;<span class="op" id="1486231">=</span>&nbsp;<span class="ident" id="1486233">cputicks</span><span class="op" id="1486241">(</span><span class="op" id="1486242">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1486247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486252">goready</span><span class="op" id="1486259">(</span><span class="ident" id="1486260">recvg</span><span class="op" id="1486265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1486270">return</span>&nbsp;<span class="builtintype" id="1486277">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1486284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1486289">if</span>&nbsp;<span class="op" id="1486292">!</span><span class="ident" id="1486293">block</span>&nbsp;<span class="op" id="1486299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486304">unlock</span><span class="op" id="1486310">(</span><span class="op" id="1486311">&amp;</span><span class="ident" id="1486312">c</span><span class="op" id="1486313">.</span><span class="ident" id="1486314">lock</span><span class="op" id="1486318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1486323">return</span>&nbsp;<span class="builtintype" id="1486330">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1486338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1486343">//&nbsp;no&nbsp;receiver&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486394">gp</span>&nbsp;<span class="op" id="1486397">:=</span>&nbsp;<span class="ident" id="1486400">getg</span><span class="op" id="1486404">(</span><span class="op" id="1486405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486409">mysg</span>&nbsp;<span class="op" id="1486414">:=</span>&nbsp;<span class="ident" id="1486417">acquireSudog</span><span class="op" id="1486429">(</span><span class="op" id="1486430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486434">mysg</span><span class="op" id="1486438">.</span><span class="ident" id="1486439">releasetime</span>&nbsp;<span class="op" id="1486451">=</span>&nbsp;<span class="num" id="1486453">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1486457">if</span>&nbsp;<span class="ident" id="1486460">t0</span>&nbsp;<span class="op" id="1486463">!=</span>&nbsp;<span class="num" id="1486466">0</span>&nbsp;<span class="op" id="1486468">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486473">mysg</span><span class="op" id="1486477">.</span><span class="ident" id="1486478">releasetime</span>&nbsp;<span class="op" id="1486490">=</span>&nbsp;<span class="op" id="1486492">-</span><span class="num" id="1486493">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1486497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486501">mysg</span><span class="op" id="1486505">.</span><span class="ident" id="1486506">elem</span>&nbsp;<span class="op" id="1486511">=</span>&nbsp;<span class="ident" id="1486513">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486518">mysg</span><span class="op" id="1486522">.</span><span class="ident" id="1486523">waitlink</span>&nbsp;<span class="op" id="1486532">=</span>&nbsp;<span class="ident" id="1486534">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486540">gp</span><span class="op" id="1486542">.</span><span class="ident" id="1486543">waiting</span>&nbsp;<span class="op" id="1486551">=</span>&nbsp;<span class="ident" id="1486553">mysg</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486560">mysg</span><span class="op" id="1486564">.</span><span class="ident" id="1486565">g</span>&nbsp;<span class="op" id="1486567">=</span>&nbsp;<span class="ident" id="1486569">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486574">mysg</span><span class="op" id="1486578">.</span><span class="ident" id="1486579">selectdone</span>&nbsp;<span class="op" id="1486590">=</span>&nbsp;<span class="ident" id="1486592">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486598">gp</span><span class="op" id="1486600">.</span><span class="ident" id="1486601">param</span>&nbsp;<span class="op" id="1486607">=</span>&nbsp;<span class="ident" id="1486609">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486615">c</span><span class="op" id="1486616">.</span><span class="ident" id="1486617">sendq</span><span class="op" id="1486622">.</span><span class="ident" id="1486623">enqueue</span><span class="op" id="1486630">(</span><span class="ident" id="1486631">mysg</span><span class="op" id="1486635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486639">goparkunlock</span><span class="op" id="1486651">(</span><span class="op" id="1486652">&amp;</span><span class="ident" id="1486653">c</span><span class="op" id="1486654">.</span><span class="ident" id="1486655">lock</span><span class="op" id="1486659">,</span>&nbsp;<span class="string" id="1486661">&#34;chan&nbsp;send&#34;</span><span class="op" id="1486672">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1486677">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1486702">if</span>&nbsp;<span class="ident" id="1486705">mysg</span>&nbsp;<span class="op" id="1486710">!=</span>&nbsp;<span class="ident" id="1486713">gp</span><span class="op" id="1486715">.</span><span class="ident" id="1486716">waiting</span>&nbsp;<span class="op" id="1486724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486729">gothrow</span><span class="op" id="1486736">(</span><span class="string" id="1486737">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1486767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1486771">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486775">gp</span><span class="op" id="1486777">.</span><span class="ident" id="1486778">waiting</span>&nbsp;<span class="op" id="1486786">=</span>&nbsp;<span class="ident" id="1486788">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1486794">if</span>&nbsp;<span class="ident" id="1486797">gp</span><span class="op" id="1486799">.</span><span class="ident" id="1486800">param</span>&nbsp;<span class="op" id="1486806">==</span>&nbsp;<span class="ident" id="1486809">nil</span>&nbsp;<span class="op" id="1486813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1486818">if</span>&nbsp;<span class="ident" id="1486821">c</span><span class="op" id="1486822">.</span><span class="ident" id="1486823">closed</span>&nbsp;<span class="op" id="1486830">==</span>&nbsp;<span class="num" id="1486833">0</span>&nbsp;<span class="op" id="1486835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486841">gothrow</span><span class="op" id="1486848">(</span><span class="string" id="1486849">&#34;chansend:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1486876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1486881">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1486886">panic</span><span class="op" id="1486891">(</span><span class="string" id="1486892">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1486916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1486920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486924">gp</span><span class="op" id="1486926">.</span><span class="ident" id="1486927">param</span>&nbsp;<span class="op" id="1486933">=</span>&nbsp;<span class="ident" id="1486935">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1486941">if</span>&nbsp;<span class="ident" id="1486944">mysg</span><span class="op" id="1486948">.</span><span class="ident" id="1486949">releasetime</span>&nbsp;<span class="op" id="1486961">&gt;</span>&nbsp;<span class="num" id="1486963">0</span>&nbsp;<span class="op" id="1486965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486970">blockevent</span><span class="op" id="1486980">(</span><span class="ident" id="1486981">int64</span><span class="op" id="1486986">(</span><span class="ident" id="1486987">mysg</span><span class="op" id="1486991">.</span><span class="ident" id="1486992">releasetime</span><span class="op" id="1487003">)</span><span class="op" id="1487004">-</span><span class="ident" id="1487005">t0</span><span class="op" id="1487007">,</span>&nbsp;<span class="num" id="1487009">2</span><span class="op" id="1487010">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1487014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487018">releaseSudog</span><span class="op" id="1487030">(</span><span class="ident" id="1487031">mysg</span><span class="op" id="1487035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487039">return</span>&nbsp;<span class="builtintype" id="1487046">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1487052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487056">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487081">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;space&nbsp;to&nbsp;write&nbsp;our&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487123">var</span>&nbsp;<span class="ident" id="1487127">t1</span>&nbsp;<span class="ident" id="1487130">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487137">for</span>&nbsp;<span class="ident" id="1487141">c</span><span class="op" id="1487142">.</span><span class="ident" id="1487143">qcount</span>&nbsp;<span class="op" id="1487150">&gt;=</span>&nbsp;<span class="ident" id="1487153">c</span><span class="op" id="1487154">.</span><span class="ident" id="1487155">dataqsiz</span>&nbsp;<span class="op" id="1487164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487168">if</span>&nbsp;<span class="op" id="1487171">!</span><span class="ident" id="1487172">block</span>&nbsp;<span class="op" id="1487178">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487183">unlock</span><span class="op" id="1487189">(</span><span class="op" id="1487190">&amp;</span><span class="ident" id="1487191">c</span><span class="op" id="1487192">.</span><span class="ident" id="1487193">lock</span><span class="op" id="1487197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487202">return</span>&nbsp;<span class="builtintype" id="1487209">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1487217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487221">gp</span>&nbsp;<span class="op" id="1487224">:=</span>&nbsp;<span class="ident" id="1487227">getg</span><span class="op" id="1487231">(</span><span class="op" id="1487232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487236">mysg</span>&nbsp;<span class="op" id="1487241">:=</span>&nbsp;<span class="ident" id="1487244">acquireSudog</span><span class="op" id="1487256">(</span><span class="op" id="1487257">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487261">mysg</span><span class="op" id="1487265">.</span><span class="ident" id="1487266">releasetime</span>&nbsp;<span class="op" id="1487278">=</span>&nbsp;<span class="num" id="1487280">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487284">if</span>&nbsp;<span class="ident" id="1487287">t0</span>&nbsp;<span class="op" id="1487290">!=</span>&nbsp;<span class="num" id="1487293">0</span>&nbsp;<span class="op" id="1487295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487300">mysg</span><span class="op" id="1487304">.</span><span class="ident" id="1487305">releasetime</span>&nbsp;<span class="op" id="1487317">=</span>&nbsp;<span class="op" id="1487319">-</span><span class="num" id="1487320">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1487324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487328">mysg</span><span class="op" id="1487332">.</span><span class="ident" id="1487333">g</span>&nbsp;<span class="op" id="1487335">=</span>&nbsp;<span class="ident" id="1487337">gp</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487342">mysg</span><span class="op" id="1487346">.</span><span class="ident" id="1487347">elem</span>&nbsp;<span class="op" id="1487352">=</span>&nbsp;<span class="ident" id="1487354">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487360">mysg</span><span class="op" id="1487364">.</span><span class="ident" id="1487365">selectdone</span>&nbsp;<span class="op" id="1487376">=</span>&nbsp;<span class="ident" id="1487378">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487384">c</span><span class="op" id="1487385">.</span><span class="ident" id="1487386">sendq</span><span class="op" id="1487391">.</span><span class="ident" id="1487392">enqueue</span><span class="op" id="1487399">(</span><span class="ident" id="1487400">mysg</span><span class="op" id="1487404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487408">goparkunlock</span><span class="op" id="1487420">(</span><span class="op" id="1487421">&amp;</span><span class="ident" id="1487422">c</span><span class="op" id="1487423">.</span><span class="ident" id="1487424">lock</span><span class="op" id="1487428">,</span>&nbsp;<span class="string" id="1487430">&#34;chan&nbsp;send&#34;</span><span class="op" id="1487441">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487446">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487482">if</span>&nbsp;<span class="ident" id="1487485">mysg</span><span class="op" id="1487489">.</span><span class="ident" id="1487490">releasetime</span>&nbsp;<span class="op" id="1487502">&gt;</span>&nbsp;<span class="num" id="1487504">0</span>&nbsp;<span class="op" id="1487506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487511">t1</span>&nbsp;<span class="op" id="1487514">=</span>&nbsp;<span class="ident" id="1487516">mysg</span><span class="op" id="1487520">.</span><span class="ident" id="1487521">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1487535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487539">releaseSudog</span><span class="op" id="1487551">(</span><span class="ident" id="1487552">mysg</span><span class="op" id="1487556">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487560">lock</span><span class="op" id="1487564">(</span><span class="op" id="1487565">&amp;</span><span class="ident" id="1487566">c</span><span class="op" id="1487567">.</span><span class="ident" id="1487568">lock</span><span class="op" id="1487572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487576">if</span>&nbsp;<span class="ident" id="1487579">c</span><span class="op" id="1487580">.</span><span class="ident" id="1487581">closed</span>&nbsp;<span class="op" id="1487588">!=</span>&nbsp;<span class="num" id="1487591">0</span>&nbsp;<span class="op" id="1487593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487598">unlock</span><span class="op" id="1487604">(</span><span class="op" id="1487605">&amp;</span><span class="ident" id="1487606">c</span><span class="op" id="1487607">.</span><span class="ident" id="1487608">lock</span><span class="op" id="1487612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1487617">panic</span><span class="op" id="1487622">(</span><span class="string" id="1487623">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1487647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1487651">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1487654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487658">//&nbsp;write&nbsp;our&nbsp;data&nbsp;into&nbsp;the&nbsp;channel&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487701">if</span>&nbsp;<span class="ident" id="1487704">raceenabled</span>&nbsp;<span class="op" id="1487716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487720">raceacquire</span><span class="op" id="1487731">(</span><span class="ident" id="1487732">chanbuf</span><span class="op" id="1487739">(</span><span class="ident" id="1487740">c</span><span class="op" id="1487741">,</span>&nbsp;<span class="ident" id="1487743">c</span><span class="op" id="1487744">.</span><span class="ident" id="1487745">sendx</span><span class="op" id="1487750">)</span><span class="op" id="1487751">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487755">racerelease</span><span class="op" id="1487766">(</span><span class="ident" id="1487767">chanbuf</span><span class="op" id="1487774">(</span><span class="ident" id="1487775">c</span><span class="op" id="1487776">,</span>&nbsp;<span class="ident" id="1487778">c</span><span class="op" id="1487779">.</span><span class="ident" id="1487780">sendx</span><span class="op" id="1487785">)</span><span class="op" id="1487786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1487789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487792">memmove</span><span class="op" id="1487799">(</span><span class="ident" id="1487800">chanbuf</span><span class="op" id="1487807">(</span><span class="ident" id="1487808">c</span><span class="op" id="1487809">,</span>&nbsp;<span class="ident" id="1487811">c</span><span class="op" id="1487812">.</span><span class="ident" id="1487813">sendx</span><span class="op" id="1487818">)</span><span class="op" id="1487819">,</span>&nbsp;<span class="ident" id="1487821">ep</span><span class="op" id="1487823">,</span>&nbsp;<span class="builtintype" id="1487825">uintptr</span><span class="op" id="1487832">(</span><span class="ident" id="1487833">c</span><span class="op" id="1487834">.</span><span class="ident" id="1487835">elemsize</span><span class="op" id="1487843">)</span><span class="op" id="1487844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487847">c</span><span class="op" id="1487848">.</span><span class="ident" id="1487849">sendx</span><span class="op" id="1487854">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487858">if</span>&nbsp;<span class="ident" id="1487861">c</span><span class="op" id="1487862">.</span><span class="ident" id="1487863">sendx</span>&nbsp;<span class="op" id="1487869">==</span>&nbsp;<span class="ident" id="1487872">c</span><span class="op" id="1487873">.</span><span class="ident" id="1487874">dataqsiz</span>&nbsp;<span class="op" id="1487883">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487887">c</span><span class="op" id="1487888">.</span><span class="ident" id="1487889">sendx</span>&nbsp;<span class="op" id="1487895">=</span>&nbsp;<span class="num" id="1487897">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1487900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487903">c</span><span class="op" id="1487904">.</span><span class="ident" id="1487905">qcount</span><span class="op" id="1487911">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1487916">//&nbsp;wake&nbsp;up&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487947">sg</span>&nbsp;<span class="op" id="1487950">:=</span>&nbsp;<span class="ident" id="1487953">c</span><span class="op" id="1487954">.</span><span class="ident" id="1487955">recvq</span><span class="op" id="1487960">.</span><span class="ident" id="1487961">dequeue</span><span class="op" id="1487968">(</span><span class="op" id="1487969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487972">if</span>&nbsp;<span class="ident" id="1487975">sg</span>&nbsp;<span class="op" id="1487978">!=</span>&nbsp;<span class="ident" id="1487981">nil</span>&nbsp;<span class="op" id="1487985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487989">recvg</span>&nbsp;<span class="op" id="1487995">:=</span>&nbsp;<span class="ident" id="1487998">sg</span><span class="op" id="1488000">.</span><span class="ident" id="1488001">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488005">unlock</span><span class="op" id="1488011">(</span><span class="op" id="1488012">&amp;</span><span class="ident" id="1488013">c</span><span class="op" id="1488014">.</span><span class="ident" id="1488015">lock</span><span class="op" id="1488019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488023">if</span>&nbsp;<span class="ident" id="1488026">sg</span><span class="op" id="1488028">.</span><span class="ident" id="1488029">releasetime</span>&nbsp;<span class="op" id="1488041">!=</span>&nbsp;<span class="num" id="1488044">0</span>&nbsp;<span class="op" id="1488046">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488051">sg</span><span class="op" id="1488053">.</span><span class="ident" id="1488054">releasetime</span>&nbsp;<span class="op" id="1488066">=</span>&nbsp;<span class="ident" id="1488068">cputicks</span><span class="op" id="1488076">(</span><span class="op" id="1488077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488085">goready</span><span class="op" id="1488092">(</span><span class="ident" id="1488093">recvg</span><span class="op" id="1488098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488101">}</span>&nbsp;<span class="keyword" id="1488103">else</span>&nbsp;<span class="op" id="1488108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488112">unlock</span><span class="op" id="1488118">(</span><span class="op" id="1488119">&amp;</span><span class="ident" id="1488120">c</span><span class="op" id="1488121">.</span><span class="ident" id="1488122">lock</span><span class="op" id="1488126">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488132">if</span>&nbsp;<span class="ident" id="1488135">t1</span>&nbsp;<span class="op" id="1488138">&gt;</span>&nbsp;<span class="num" id="1488140">0</span>&nbsp;<span class="op" id="1488142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488146">blockevent</span><span class="op" id="1488156">(</span><span class="ident" id="1488157">t1</span><span class="op" id="1488159">-</span><span class="ident" id="1488160">t0</span><span class="op" id="1488162">,</span>&nbsp;<span class="num" id="1488164">2</span><span class="op" id="1488165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488171">return</span>&nbsp;<span class="builtintype" id="1488178">true</span><br>
<span class="lineno">255</span><span class="op" id="1488183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1488186">func</span>&nbsp;<span class="ident" id="1488191">closechan</span><span class="op" id="1488200">(</span><span class="ident" id="1488201">c</span>&nbsp;<span class="op" id="1488203">*</span><span class="ident" id="1488204">hchan</span><span class="op" id="1488209">)</span>&nbsp;<span class="op" id="1488211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488214">if</span>&nbsp;<span class="ident" id="1488217">c</span>&nbsp;<span class="op" id="1488219">==</span>&nbsp;<span class="ident" id="1488222">nil</span>&nbsp;<span class="op" id="1488226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1488230">panic</span><span class="op" id="1488235">(</span><span class="string" id="1488236">&#34;close&nbsp;of&nbsp;nil&nbsp;channel&#34;</span><span class="op" id="1488258">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488265">lock</span><span class="op" id="1488269">(</span><span class="op" id="1488270">&amp;</span><span class="ident" id="1488271">c</span><span class="op" id="1488272">.</span><span class="ident" id="1488273">lock</span><span class="op" id="1488277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488280">if</span>&nbsp;<span class="ident" id="1488283">c</span><span class="op" id="1488284">.</span><span class="ident" id="1488285">closed</span>&nbsp;<span class="op" id="1488292">!=</span>&nbsp;<span class="num" id="1488295">0</span>&nbsp;<span class="op" id="1488297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488301">unlock</span><span class="op" id="1488307">(</span><span class="op" id="1488308">&amp;</span><span class="ident" id="1488309">c</span><span class="op" id="1488310">.</span><span class="ident" id="1488311">lock</span><span class="op" id="1488315">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1488319">panic</span><span class="op" id="1488324">(</span><span class="string" id="1488325">&#34;close&nbsp;of&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1488350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488357">if</span>&nbsp;<span class="ident" id="1488360">raceenabled</span>&nbsp;<span class="op" id="1488372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488376">callerpc</span>&nbsp;<span class="op" id="1488385">:=</span>&nbsp;<span class="ident" id="1488388">getcallerpc</span><span class="op" id="1488399">(</span><span class="ident" id="1488400">unsafe</span><span class="op" id="1488406">.</span><span class="ident" id="1488407">Pointer</span><span class="op" id="1488414">(</span><span class="op" id="1488415">&amp;</span><span class="ident" id="1488416">c</span><span class="op" id="1488417">)</span><span class="op" id="1488418">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488422">racewritepc</span><span class="op" id="1488433">(</span><span class="ident" id="1488434">unsafe</span><span class="op" id="1488440">.</span><span class="ident" id="1488441">Pointer</span><span class="op" id="1488448">(</span><span class="ident" id="1488449">c</span><span class="op" id="1488450">)</span><span class="op" id="1488451">,</span>&nbsp;<span class="ident" id="1488453">callerpc</span><span class="op" id="1488461">,</span>&nbsp;<span class="ident" id="1488463">funcPC</span><span class="op" id="1488469">(</span><span class="ident" id="1488470">closechan</span><span class="op" id="1488479">)</span><span class="op" id="1488480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488484">racerelease</span><span class="op" id="1488495">(</span><span class="ident" id="1488496">unsafe</span><span class="op" id="1488502">.</span><span class="ident" id="1488503">Pointer</span><span class="op" id="1488510">(</span><span class="ident" id="1488511">c</span><span class="op" id="1488512">)</span><span class="op" id="1488513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488520">c</span><span class="op" id="1488521">.</span><span class="ident" id="1488522">closed</span>&nbsp;<span class="op" id="1488529">=</span>&nbsp;<span class="num" id="1488531">1</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1488535">//&nbsp;release&nbsp;all&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488559">for</span>&nbsp;<span class="op" id="1488563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488567">sg</span>&nbsp;<span class="op" id="1488570">:=</span>&nbsp;<span class="ident" id="1488573">c</span><span class="op" id="1488574">.</span><span class="ident" id="1488575">recvq</span><span class="op" id="1488580">.</span><span class="ident" id="1488581">dequeue</span><span class="op" id="1488588">(</span><span class="op" id="1488589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488593">if</span>&nbsp;<span class="ident" id="1488596">sg</span>&nbsp;<span class="op" id="1488599">==</span>&nbsp;<span class="ident" id="1488602">nil</span>&nbsp;<span class="op" id="1488606">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488611">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488623">gp</span>&nbsp;<span class="op" id="1488626">:=</span>&nbsp;<span class="ident" id="1488629">sg</span><span class="op" id="1488631">.</span><span class="ident" id="1488632">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488636">sg</span><span class="op" id="1488638">.</span><span class="ident" id="1488639">elem</span>&nbsp;<span class="op" id="1488644">=</span>&nbsp;<span class="ident" id="1488646">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488652">gp</span><span class="op" id="1488654">.</span><span class="ident" id="1488655">param</span>&nbsp;<span class="op" id="1488661">=</span>&nbsp;<span class="ident" id="1488663">nil</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488669">if</span>&nbsp;<span class="ident" id="1488672">sg</span><span class="op" id="1488674">.</span><span class="ident" id="1488675">releasetime</span>&nbsp;<span class="op" id="1488687">!=</span>&nbsp;<span class="num" id="1488690">0</span>&nbsp;<span class="op" id="1488692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488697">sg</span><span class="op" id="1488699">.</span><span class="ident" id="1488700">releasetime</span>&nbsp;<span class="op" id="1488712">=</span>&nbsp;<span class="ident" id="1488714">cputicks</span><span class="op" id="1488722">(</span><span class="op" id="1488723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488731">goready</span><span class="op" id="1488738">(</span><span class="ident" id="1488739">gp</span><span class="op" id="1488741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488744">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1488748">//&nbsp;release&nbsp;all&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488772">for</span>&nbsp;<span class="op" id="1488776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488780">sg</span>&nbsp;<span class="op" id="1488783">:=</span>&nbsp;<span class="ident" id="1488786">c</span><span class="op" id="1488787">.</span><span class="ident" id="1488788">sendq</span><span class="op" id="1488793">.</span><span class="ident" id="1488794">dequeue</span><span class="op" id="1488801">(</span><span class="op" id="1488802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488806">if</span>&nbsp;<span class="ident" id="1488809">sg</span>&nbsp;<span class="op" id="1488812">==</span>&nbsp;<span class="ident" id="1488815">nil</span>&nbsp;<span class="op" id="1488819">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488824">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488836">gp</span>&nbsp;<span class="op" id="1488839">:=</span>&nbsp;<span class="ident" id="1488842">sg</span><span class="op" id="1488844">.</span><span class="ident" id="1488845">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488849">sg</span><span class="op" id="1488851">.</span><span class="ident" id="1488852">elem</span>&nbsp;<span class="op" id="1488857">=</span>&nbsp;<span class="ident" id="1488859">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488865">gp</span><span class="op" id="1488867">.</span><span class="ident" id="1488868">param</span>&nbsp;<span class="op" id="1488874">=</span>&nbsp;<span class="ident" id="1488876">nil</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488882">if</span>&nbsp;<span class="ident" id="1488885">sg</span><span class="op" id="1488887">.</span><span class="ident" id="1488888">releasetime</span>&nbsp;<span class="op" id="1488900">!=</span>&nbsp;<span class="num" id="1488903">0</span>&nbsp;<span class="op" id="1488905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488910">sg</span><span class="op" id="1488912">.</span><span class="ident" id="1488913">releasetime</span>&nbsp;<span class="op" id="1488925">=</span>&nbsp;<span class="ident" id="1488927">cputicks</span><span class="op" id="1488935">(</span><span class="op" id="1488936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488944">goready</span><span class="op" id="1488951">(</span><span class="ident" id="1488952">gp</span><span class="op" id="1488954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488957">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488960">unlock</span><span class="op" id="1488966">(</span><span class="op" id="1488967">&amp;</span><span class="ident" id="1488968">c</span><span class="op" id="1488969">.</span><span class="ident" id="1488970">lock</span><span class="op" id="1488974">)</span><br>
<span class="lineno"></span><span class="op" id="1488976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1488979">//&nbsp;entry&nbsp;points&nbsp;for&nbsp;&lt;-&nbsp;c&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1489023">//go:nosplit</span><br>
<span class="lineno">310</span><span class="keyword" id="1489036">func</span>&nbsp;<span class="ident" id="1489041">chanrecv1</span><span class="op" id="1489050">(</span><span class="ident" id="1489051">t</span>&nbsp;<span class="op" id="1489053">*</span><span class="ident" id="1489054">chantype</span><span class="op" id="1489062">,</span>&nbsp;<span class="ident" id="1489064">c</span>&nbsp;<span class="op" id="1489066">*</span><span class="ident" id="1489067">hchan</span><span class="op" id="1489072">,</span>&nbsp;<span class="ident" id="1489074">elem</span>&nbsp;<span class="ident" id="1489079">unsafe</span><span class="op" id="1489085">.</span><span class="ident" id="1489086">Pointer</span><span class="op" id="1489093">)</span>&nbsp;<span class="op" id="1489095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489098">chanrecv</span><span class="op" id="1489106">(</span><span class="ident" id="1489107">t</span><span class="op" id="1489108">,</span>&nbsp;<span class="ident" id="1489110">c</span><span class="op" id="1489111">,</span>&nbsp;<span class="ident" id="1489113">elem</span><span class="op" id="1489117">,</span>&nbsp;<span class="builtintype" id="1489119">true</span><span class="op" id="1489123">)</span><br>
<span class="lineno"></span><span class="op" id="1489125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1489128">//go:nosplit</span><br>
<span class="lineno">315</span><span class="keyword" id="1489141">func</span>&nbsp;<span class="ident" id="1489146">chanrecv2</span><span class="op" id="1489155">(</span><span class="ident" id="1489156">t</span>&nbsp;<span class="op" id="1489158">*</span><span class="ident" id="1489159">chantype</span><span class="op" id="1489167">,</span>&nbsp;<span class="ident" id="1489169">c</span>&nbsp;<span class="op" id="1489171">*</span><span class="ident" id="1489172">hchan</span><span class="op" id="1489177">,</span>&nbsp;<span class="ident" id="1489179">elem</span>&nbsp;<span class="ident" id="1489184">unsafe</span><span class="op" id="1489190">.</span><span class="ident" id="1489191">Pointer</span><span class="op" id="1489198">)</span>&nbsp;<span class="op" id="1489200">(</span><span class="ident" id="1489201">received</span>&nbsp;<span class="builtintype" id="1489210">bool</span><span class="op" id="1489214">)</span>&nbsp;<span class="op" id="1489216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489219">_</span><span class="op" id="1489220">,</span>&nbsp;<span class="ident" id="1489222">received</span>&nbsp;<span class="op" id="1489231">=</span>&nbsp;<span class="ident" id="1489233">chanrecv</span><span class="op" id="1489241">(</span><span class="ident" id="1489242">t</span><span class="op" id="1489243">,</span>&nbsp;<span class="ident" id="1489245">c</span><span class="op" id="1489246">,</span>&nbsp;<span class="ident" id="1489248">elem</span><span class="op" id="1489252">,</span>&nbsp;<span class="builtintype" id="1489254">true</span><span class="op" id="1489258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489261">return</span><br>
<span class="lineno"></span><span class="op" id="1489268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span><span class="comment" id="1489271">//&nbsp;chanrecv&nbsp;receives&nbsp;on&nbsp;channel&nbsp;c&nbsp;and&nbsp;writes&nbsp;the&nbsp;received&nbsp;data&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span><span class="comment" id="1489341">//&nbsp;ep&nbsp;may&nbsp;be&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;received&nbsp;data&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="1489399">//&nbsp;If&nbsp;block&nbsp;==&nbsp;false&nbsp;and&nbsp;no&nbsp;elements&nbsp;are&nbsp;available,&nbsp;returns&nbsp;(false,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1489475">//&nbsp;Otherwise,&nbsp;if&nbsp;c&nbsp;is&nbsp;closed,&nbsp;zeros&nbsp;*ep&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1489542">//&nbsp;Otherwise,&nbsp;fills&nbsp;in&nbsp;*ep&nbsp;with&nbsp;an&nbsp;element&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;true).</span><br>
<span class="lineno">325</span><span class="keyword" id="1489611">func</span>&nbsp;<span class="ident" id="1489616">chanrecv</span><span class="op" id="1489624">(</span><span class="ident" id="1489625">t</span>&nbsp;<span class="op" id="1489627">*</span><span class="ident" id="1489628">chantype</span><span class="op" id="1489636">,</span>&nbsp;<span class="ident" id="1489638">c</span>&nbsp;<span class="op" id="1489640">*</span><span class="ident" id="1489641">hchan</span><span class="op" id="1489646">,</span>&nbsp;<span class="ident" id="1489648">ep</span>&nbsp;<span class="ident" id="1489651">unsafe</span><span class="op" id="1489657">.</span><span class="ident" id="1489658">Pointer</span><span class="op" id="1489665">,</span>&nbsp;<span class="ident" id="1489667">block</span>&nbsp;<span class="builtintype" id="1489673">bool</span><span class="op" id="1489677">)</span>&nbsp;<span class="op" id="1489679">(</span><span class="ident" id="1489680">selected</span><span class="op" id="1489688">,</span>&nbsp;<span class="ident" id="1489690">received</span>&nbsp;<span class="builtintype" id="1489699">bool</span><span class="op" id="1489703">)</span>&nbsp;<span class="op" id="1489705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1489708">//&nbsp;raceenabled:&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;check&nbsp;ep,&nbsp;as&nbsp;it&nbsp;is&nbsp;always&nbsp;on&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489780">if</span>&nbsp;<span class="ident" id="1489783">debugChan</span>&nbsp;<span class="op" id="1489793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1489797">print</span><span class="op" id="1489802">(</span><span class="string" id="1489803">&#34;chanrecv:&nbsp;chan=&#34;</span><span class="op" id="1489820">,</span>&nbsp;<span class="ident" id="1489822">c</span><span class="op" id="1489823">,</span>&nbsp;<span class="string" id="1489825">&#34;\n&#34;</span><span class="op" id="1489829">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1489832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489836">if</span>&nbsp;<span class="ident" id="1489839">c</span>&nbsp;<span class="op" id="1489841">==</span>&nbsp;<span class="ident" id="1489844">nil</span>&nbsp;<span class="op" id="1489848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489852">if</span>&nbsp;<span class="op" id="1489855">!</span><span class="ident" id="1489856">block</span>&nbsp;<span class="op" id="1489862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489867">return</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1489876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489880">gopark</span><span class="op" id="1489886">(</span><span class="ident" id="1489887">nil</span><span class="op" id="1489890">,</span>&nbsp;<span class="ident" id="1489892">nil</span><span class="op" id="1489895">,</span>&nbsp;<span class="string" id="1489897">&#34;chan&nbsp;receive&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1489922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489926">gothrow</span><span class="op" id="1489933">(</span><span class="string" id="1489934">&#34;unreachable&#34;</span><span class="op" id="1489947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1489950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1489954">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1490037">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1490041">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;ready&nbsp;for&nbsp;receiving,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1490126">//&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1490208">//&nbsp;(first&nbsp;c.sendq.first&nbsp;or&nbsp;c.qcount,&nbsp;and&nbsp;second&nbsp;c.closed).</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1490268">//&nbsp;Because&nbsp;a&nbsp;channel&nbsp;cannot&nbsp;be&nbsp;reopened,&nbsp;the&nbsp;later&nbsp;observation&nbsp;of&nbsp;the&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1490347">//&nbsp;being&nbsp;not&nbsp;closed&nbsp;implies&nbsp;that&nbsp;it&nbsp;was&nbsp;also&nbsp;not&nbsp;closed&nbsp;at&nbsp;the&nbsp;moment&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1490425">//&nbsp;first&nbsp;observation.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1490503">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;receive&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1490551">//</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1490555">//&nbsp;The&nbsp;order&nbsp;of&nbsp;operations&nbsp;is&nbsp;important&nbsp;here:&nbsp;reversing&nbsp;the&nbsp;operations&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1490639">//&nbsp;incorrect&nbsp;behavior&nbsp;when&nbsp;racing&nbsp;with&nbsp;a&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490688">if</span>&nbsp;<span class="op" id="1490691">!</span><span class="ident" id="1490692">block</span>&nbsp;<span class="op" id="1490698">&amp;&amp;</span>&nbsp;<span class="op" id="1490701">(</span><span class="ident" id="1490702">c</span><span class="op" id="1490703">.</span><span class="ident" id="1490704">dataqsiz</span>&nbsp;<span class="op" id="1490713">==</span>&nbsp;<span class="num" id="1490716">0</span>&nbsp;<span class="op" id="1490718">&amp;&amp;</span>&nbsp;<span class="ident" id="1490721">c</span><span class="op" id="1490722">.</span><span class="ident" id="1490723">sendq</span><span class="op" id="1490728">.</span><span class="ident" id="1490729">first</span>&nbsp;<span class="op" id="1490735">==</span>&nbsp;<span class="ident" id="1490738">nil</span>&nbsp;<span class="op" id="1490742">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490747">c</span><span class="op" id="1490748">.</span><span class="ident" id="1490749">dataqsiz</span>&nbsp;<span class="op" id="1490758">&gt;</span>&nbsp;<span class="num" id="1490760">0</span>&nbsp;<span class="op" id="1490762">&amp;&amp;</span>&nbsp;<span class="ident" id="1490765">atomicloaduint</span><span class="op" id="1490779">(</span><span class="op" id="1490780">&amp;</span><span class="ident" id="1490781">c</span><span class="op" id="1490782">.</span><span class="ident" id="1490783">qcount</span><span class="op" id="1490789">)</span>&nbsp;<span class="op" id="1490791">==</span>&nbsp;<span class="num" id="1490794">0</span><span class="op" id="1490795">)</span>&nbsp;<span class="op" id="1490797">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490802">atomicload</span><span class="op" id="1490812">(</span><span class="op" id="1490813">&amp;</span><span class="ident" id="1490814">c</span><span class="op" id="1490815">.</span><span class="ident" id="1490816">closed</span><span class="op" id="1490822">)</span>&nbsp;<span class="op" id="1490824">==</span>&nbsp;<span class="num" id="1490827">0</span>&nbsp;<span class="op" id="1490829">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490833">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490845">var</span>&nbsp;<span class="ident" id="1490849">t0</span>&nbsp;<span class="ident" id="1490852">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490859">if</span>&nbsp;<span class="ident" id="1490862">blockprofilerate</span>&nbsp;<span class="op" id="1490879">&gt;</span>&nbsp;<span class="num" id="1490881">0</span>&nbsp;<span class="op" id="1490883">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490887">t0</span>&nbsp;<span class="op" id="1490890">=</span>&nbsp;<span class="ident" id="1490892">cputicks</span><span class="op" id="1490900">(</span><span class="op" id="1490901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490908">lock</span><span class="op" id="1490912">(</span><span class="op" id="1490913">&amp;</span><span class="ident" id="1490914">c</span><span class="op" id="1490915">.</span><span class="ident" id="1490916">lock</span><span class="op" id="1490920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490923">if</span>&nbsp;<span class="ident" id="1490926">c</span><span class="op" id="1490927">.</span><span class="ident" id="1490928">dataqsiz</span>&nbsp;<span class="op" id="1490937">==</span>&nbsp;<span class="num" id="1490940">0</span>&nbsp;<span class="op" id="1490942">{</span>&nbsp;<span class="comment" id="1490944">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490969">if</span>&nbsp;<span class="ident" id="1490972">c</span><span class="op" id="1490973">.</span><span class="ident" id="1490974">closed</span>&nbsp;<span class="op" id="1490981">!=</span>&nbsp;<span class="num" id="1490984">0</span>&nbsp;<span class="op" id="1490986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490991">return</span>&nbsp;<span class="ident" id="1490998">recvclosed</span><span class="op" id="1491008">(</span><span class="ident" id="1491009">c</span><span class="op" id="1491010">,</span>&nbsp;<span class="ident" id="1491012">ep</span><span class="op" id="1491014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491023">sg</span>&nbsp;<span class="op" id="1491026">:=</span>&nbsp;<span class="ident" id="1491029">c</span><span class="op" id="1491030">.</span><span class="ident" id="1491031">sendq</span><span class="op" id="1491036">.</span><span class="ident" id="1491037">dequeue</span><span class="op" id="1491044">(</span><span class="op" id="1491045">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491049">if</span>&nbsp;<span class="ident" id="1491052">sg</span>&nbsp;<span class="op" id="1491055">!=</span>&nbsp;<span class="ident" id="1491058">nil</span>&nbsp;<span class="op" id="1491062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491067">if</span>&nbsp;<span class="ident" id="1491070">raceenabled</span>&nbsp;<span class="op" id="1491082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491088">racesync</span><span class="op" id="1491096">(</span><span class="ident" id="1491097">c</span><span class="op" id="1491098">,</span>&nbsp;<span class="ident" id="1491100">sg</span><span class="op" id="1491102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491112">unlock</span><span class="op" id="1491118">(</span><span class="op" id="1491119">&amp;</span><span class="ident" id="1491120">c</span><span class="op" id="1491121">.</span><span class="ident" id="1491122">lock</span><span class="op" id="1491126">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491132">if</span>&nbsp;<span class="ident" id="1491135">ep</span>&nbsp;<span class="op" id="1491138">!=</span>&nbsp;<span class="ident" id="1491141">nil</span>&nbsp;<span class="op" id="1491145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491151">memmove</span><span class="op" id="1491158">(</span><span class="ident" id="1491159">ep</span><span class="op" id="1491161">,</span>&nbsp;<span class="ident" id="1491163">sg</span><span class="op" id="1491165">.</span><span class="ident" id="1491166">elem</span><span class="op" id="1491170">,</span>&nbsp;<span class="builtintype" id="1491172">uintptr</span><span class="op" id="1491179">(</span><span class="ident" id="1491180">c</span><span class="op" id="1491181">.</span><span class="ident" id="1491182">elemsize</span><span class="op" id="1491190">)</span><span class="op" id="1491191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491201">sg</span><span class="op" id="1491203">.</span><span class="ident" id="1491204">elem</span>&nbsp;<span class="op" id="1491209">=</span>&nbsp;<span class="ident" id="1491211">nil</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491218">gp</span>&nbsp;<span class="op" id="1491221">:=</span>&nbsp;<span class="ident" id="1491224">sg</span><span class="op" id="1491226">.</span><span class="ident" id="1491227">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491232">gp</span><span class="op" id="1491234">.</span><span class="ident" id="1491235">param</span>&nbsp;<span class="op" id="1491241">=</span>&nbsp;<span class="ident" id="1491243">unsafe</span><span class="op" id="1491249">.</span><span class="ident" id="1491250">Pointer</span><span class="op" id="1491257">(</span><span class="ident" id="1491258">sg</span><span class="op" id="1491260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491265">if</span>&nbsp;<span class="ident" id="1491268">sg</span><span class="op" id="1491270">.</span><span class="ident" id="1491271">releasetime</span>&nbsp;<span class="op" id="1491283">!=</span>&nbsp;<span class="num" id="1491286">0</span>&nbsp;<span class="op" id="1491288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491294">sg</span><span class="op" id="1491296">.</span><span class="ident" id="1491297">releasetime</span>&nbsp;<span class="op" id="1491309">=</span>&nbsp;<span class="ident" id="1491311">cputicks</span><span class="op" id="1491319">(</span><span class="op" id="1491320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491325">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491330">goready</span><span class="op" id="1491337">(</span><span class="ident" id="1491338">gp</span><span class="op" id="1491340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491345">selected</span>&nbsp;<span class="op" id="1491354">=</span>&nbsp;<span class="builtintype" id="1491356">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491364">received</span>&nbsp;<span class="op" id="1491373">=</span>&nbsp;<span class="builtintype" id="1491375">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491383">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491392">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491397">if</span>&nbsp;<span class="op" id="1491400">!</span><span class="ident" id="1491401">block</span>&nbsp;<span class="op" id="1491407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491412">unlock</span><span class="op" id="1491418">(</span><span class="op" id="1491419">&amp;</span><span class="ident" id="1491420">c</span><span class="op" id="1491421">.</span><span class="ident" id="1491422">lock</span><span class="op" id="1491426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491431">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491440">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1491445">//&nbsp;no&nbsp;sender&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491494">gp</span>&nbsp;<span class="op" id="1491497">:=</span>&nbsp;<span class="ident" id="1491500">getg</span><span class="op" id="1491504">(</span><span class="op" id="1491505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491509">mysg</span>&nbsp;<span class="op" id="1491514">:=</span>&nbsp;<span class="ident" id="1491517">acquireSudog</span><span class="op" id="1491529">(</span><span class="op" id="1491530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491534">mysg</span><span class="op" id="1491538">.</span><span class="ident" id="1491539">releasetime</span>&nbsp;<span class="op" id="1491551">=</span>&nbsp;<span class="num" id="1491553">0</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491557">if</span>&nbsp;<span class="ident" id="1491560">t0</span>&nbsp;<span class="op" id="1491563">!=</span>&nbsp;<span class="num" id="1491566">0</span>&nbsp;<span class="op" id="1491568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491573">mysg</span><span class="op" id="1491577">.</span><span class="ident" id="1491578">releasetime</span>&nbsp;<span class="op" id="1491590">=</span>&nbsp;<span class="op" id="1491592">-</span><span class="num" id="1491593">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491601">mysg</span><span class="op" id="1491605">.</span><span class="ident" id="1491606">elem</span>&nbsp;<span class="op" id="1491611">=</span>&nbsp;<span class="ident" id="1491613">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491618">mysg</span><span class="op" id="1491622">.</span><span class="ident" id="1491623">waitlink</span>&nbsp;<span class="op" id="1491632">=</span>&nbsp;<span class="ident" id="1491634">nil</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491640">gp</span><span class="op" id="1491642">.</span><span class="ident" id="1491643">waiting</span>&nbsp;<span class="op" id="1491651">=</span>&nbsp;<span class="ident" id="1491653">mysg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491660">mysg</span><span class="op" id="1491664">.</span><span class="ident" id="1491665">g</span>&nbsp;<span class="op" id="1491667">=</span>&nbsp;<span class="ident" id="1491669">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491674">mysg</span><span class="op" id="1491678">.</span><span class="ident" id="1491679">selectdone</span>&nbsp;<span class="op" id="1491690">=</span>&nbsp;<span class="ident" id="1491692">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491698">gp</span><span class="op" id="1491700">.</span><span class="ident" id="1491701">param</span>&nbsp;<span class="op" id="1491707">=</span>&nbsp;<span class="ident" id="1491709">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491715">c</span><span class="op" id="1491716">.</span><span class="ident" id="1491717">recvq</span><span class="op" id="1491722">.</span><span class="ident" id="1491723">enqueue</span><span class="op" id="1491730">(</span><span class="ident" id="1491731">mysg</span><span class="op" id="1491735">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491739">goparkunlock</span><span class="op" id="1491751">(</span><span class="op" id="1491752">&amp;</span><span class="ident" id="1491753">c</span><span class="op" id="1491754">.</span><span class="ident" id="1491755">lock</span><span class="op" id="1491759">,</span>&nbsp;<span class="string" id="1491761">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1491775">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1491780">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491804">if</span>&nbsp;<span class="ident" id="1491807">mysg</span>&nbsp;<span class="op" id="1491812">!=</span>&nbsp;<span class="ident" id="1491815">gp</span><span class="op" id="1491817">.</span><span class="ident" id="1491818">waiting</span>&nbsp;<span class="op" id="1491826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491831">gothrow</span><span class="op" id="1491838">(</span><span class="string" id="1491839">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1491869">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491877">gp</span><span class="op" id="1491879">.</span><span class="ident" id="1491880">waiting</span>&nbsp;<span class="op" id="1491888">=</span>&nbsp;<span class="ident" id="1491890">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491896">if</span>&nbsp;<span class="ident" id="1491899">mysg</span><span class="op" id="1491903">.</span><span class="ident" id="1491904">releasetime</span>&nbsp;<span class="op" id="1491916">&gt;</span>&nbsp;<span class="num" id="1491918">0</span>&nbsp;<span class="op" id="1491920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491925">blockevent</span><span class="op" id="1491935">(</span><span class="ident" id="1491936">mysg</span><span class="op" id="1491940">.</span><span class="ident" id="1491941">releasetime</span><span class="op" id="1491952">-</span><span class="ident" id="1491953">t0</span><span class="op" id="1491955">,</span>&nbsp;<span class="num" id="1491957">2</span><span class="op" id="1491958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491962">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491966">haveData</span>&nbsp;<span class="op" id="1491975">:=</span>&nbsp;<span class="ident" id="1491978">gp</span><span class="op" id="1491980">.</span><span class="ident" id="1491981">param</span>&nbsp;<span class="op" id="1491987">!=</span>&nbsp;<span class="ident" id="1491990">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491996">gp</span><span class="op" id="1491998">.</span><span class="ident" id="1491999">param</span>&nbsp;<span class="op" id="1492005">=</span>&nbsp;<span class="ident" id="1492007">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492013">releaseSudog</span><span class="op" id="1492025">(</span><span class="ident" id="1492026">mysg</span><span class="op" id="1492030">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492035">if</span>&nbsp;<span class="ident" id="1492038">haveData</span>&nbsp;<span class="op" id="1492047">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492052">//&nbsp;a&nbsp;sender&nbsp;sent&nbsp;us&nbsp;some&nbsp;data.&nbsp;It&nbsp;already&nbsp;wrote&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492110">selected</span>&nbsp;<span class="op" id="1492119">=</span>&nbsp;<span class="builtintype" id="1492121">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492129">received</span>&nbsp;<span class="op" id="1492138">=</span>&nbsp;<span class="builtintype" id="1492140">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492148">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492157">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492162">lock</span><span class="op" id="1492166">(</span><span class="op" id="1492167">&amp;</span><span class="ident" id="1492168">c</span><span class="op" id="1492169">.</span><span class="ident" id="1492170">lock</span><span class="op" id="1492174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492178">if</span>&nbsp;<span class="ident" id="1492181">c</span><span class="op" id="1492182">.</span><span class="ident" id="1492183">closed</span>&nbsp;<span class="op" id="1492190">==</span>&nbsp;<span class="num" id="1492193">0</span>&nbsp;<span class="op" id="1492195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492200">gothrow</span><span class="op" id="1492207">(</span><span class="string" id="1492208">&#34;chanrecv:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1492235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492239">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492243">return</span>&nbsp;<span class="ident" id="1492250">recvclosed</span><span class="op" id="1492260">(</span><span class="ident" id="1492261">c</span><span class="op" id="1492262">,</span>&nbsp;<span class="ident" id="1492264">ep</span><span class="op" id="1492266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492273">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492298">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;data&nbsp;to&nbsp;appear</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492331">var</span>&nbsp;<span class="ident" id="1492335">t1</span>&nbsp;<span class="ident" id="1492338">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492345">for</span>&nbsp;<span class="ident" id="1492349">c</span><span class="op" id="1492350">.</span><span class="ident" id="1492351">qcount</span>&nbsp;<span class="op" id="1492358">&lt;=</span>&nbsp;<span class="num" id="1492361">0</span>&nbsp;<span class="op" id="1492363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492367">if</span>&nbsp;<span class="ident" id="1492370">c</span><span class="op" id="1492371">.</span><span class="ident" id="1492372">closed</span>&nbsp;<span class="op" id="1492379">!=</span>&nbsp;<span class="num" id="1492382">0</span>&nbsp;<span class="op" id="1492384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492389">selected</span><span class="op" id="1492397">,</span>&nbsp;<span class="ident" id="1492399">received</span>&nbsp;<span class="op" id="1492408">=</span>&nbsp;<span class="ident" id="1492410">recvclosed</span><span class="op" id="1492420">(</span><span class="ident" id="1492421">c</span><span class="op" id="1492422">,</span>&nbsp;<span class="ident" id="1492424">ep</span><span class="op" id="1492426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492431">if</span>&nbsp;<span class="ident" id="1492434">t1</span>&nbsp;<span class="op" id="1492437">&gt;</span>&nbsp;<span class="num" id="1492439">0</span>&nbsp;<span class="op" id="1492441">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492447">blockevent</span><span class="op" id="1492457">(</span><span class="ident" id="1492458">t1</span><span class="op" id="1492460">-</span><span class="ident" id="1492461">t0</span><span class="op" id="1492463">,</span>&nbsp;<span class="num" id="1492465">2</span><span class="op" id="1492466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492476">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492490">if</span>&nbsp;<span class="op" id="1492493">!</span><span class="ident" id="1492494">block</span>&nbsp;<span class="op" id="1492500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492505">unlock</span><span class="op" id="1492511">(</span><span class="op" id="1492512">&amp;</span><span class="ident" id="1492513">c</span><span class="op" id="1492514">.</span><span class="ident" id="1492515">lock</span><span class="op" id="1492519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492524">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492538">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;send&nbsp;an&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492579">gp</span>&nbsp;<span class="op" id="1492582">:=</span>&nbsp;<span class="ident" id="1492585">getg</span><span class="op" id="1492589">(</span><span class="op" id="1492590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492594">mysg</span>&nbsp;<span class="op" id="1492599">:=</span>&nbsp;<span class="ident" id="1492602">acquireSudog</span><span class="op" id="1492614">(</span><span class="op" id="1492615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492619">mysg</span><span class="op" id="1492623">.</span><span class="ident" id="1492624">releasetime</span>&nbsp;<span class="op" id="1492636">=</span>&nbsp;<span class="num" id="1492638">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492642">if</span>&nbsp;<span class="ident" id="1492645">t0</span>&nbsp;<span class="op" id="1492648">!=</span>&nbsp;<span class="num" id="1492651">0</span>&nbsp;<span class="op" id="1492653">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492658">mysg</span><span class="op" id="1492662">.</span><span class="ident" id="1492663">releasetime</span>&nbsp;<span class="op" id="1492675">=</span>&nbsp;<span class="op" id="1492677">-</span><span class="num" id="1492678">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492686">mysg</span><span class="op" id="1492690">.</span><span class="ident" id="1492691">elem</span>&nbsp;<span class="op" id="1492696">=</span>&nbsp;<span class="ident" id="1492698">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492704">mysg</span><span class="op" id="1492708">.</span><span class="ident" id="1492709">g</span>&nbsp;<span class="op" id="1492711">=</span>&nbsp;<span class="ident" id="1492713">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492718">mysg</span><span class="op" id="1492722">.</span><span class="ident" id="1492723">selectdone</span>&nbsp;<span class="op" id="1492734">=</span>&nbsp;<span class="ident" id="1492736">nil</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492743">c</span><span class="op" id="1492744">.</span><span class="ident" id="1492745">recvq</span><span class="op" id="1492750">.</span><span class="ident" id="1492751">enqueue</span><span class="op" id="1492758">(</span><span class="ident" id="1492759">mysg</span><span class="op" id="1492763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492767">goparkunlock</span><span class="op" id="1492779">(</span><span class="op" id="1492780">&amp;</span><span class="ident" id="1492781">c</span><span class="op" id="1492782">.</span><span class="ident" id="1492783">lock</span><span class="op" id="1492787">,</span>&nbsp;<span class="string" id="1492789">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1492803">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492808">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492844">if</span>&nbsp;<span class="ident" id="1492847">mysg</span><span class="op" id="1492851">.</span><span class="ident" id="1492852">releasetime</span>&nbsp;<span class="op" id="1492864">&gt;</span>&nbsp;<span class="num" id="1492866">0</span>&nbsp;<span class="op" id="1492868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492873">t1</span>&nbsp;<span class="op" id="1492876">=</span>&nbsp;<span class="ident" id="1492878">mysg</span><span class="op" id="1492882">.</span><span class="ident" id="1492883">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492901">releaseSudog</span><span class="op" id="1492913">(</span><span class="ident" id="1492914">mysg</span><span class="op" id="1492918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492922">lock</span><span class="op" id="1492926">(</span><span class="op" id="1492927">&amp;</span><span class="ident" id="1492928">c</span><span class="op" id="1492929">.</span><span class="ident" id="1492930">lock</span><span class="op" id="1492934">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492941">if</span>&nbsp;<span class="ident" id="1492944">raceenabled</span>&nbsp;<span class="op" id="1492956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492960">raceacquire</span><span class="op" id="1492971">(</span><span class="ident" id="1492972">chanbuf</span><span class="op" id="1492979">(</span><span class="ident" id="1492980">c</span><span class="op" id="1492981">,</span>&nbsp;<span class="ident" id="1492983">c</span><span class="op" id="1492984">.</span><span class="ident" id="1492985">recvx</span><span class="op" id="1492990">)</span><span class="op" id="1492991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492995">racerelease</span><span class="op" id="1493006">(</span><span class="ident" id="1493007">chanbuf</span><span class="op" id="1493014">(</span><span class="ident" id="1493015">c</span><span class="op" id="1493016">,</span>&nbsp;<span class="ident" id="1493018">c</span><span class="op" id="1493019">.</span><span class="ident" id="1493020">recvx</span><span class="op" id="1493025">)</span><span class="op" id="1493026">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493032">if</span>&nbsp;<span class="ident" id="1493035">ep</span>&nbsp;<span class="op" id="1493038">!=</span>&nbsp;<span class="ident" id="1493041">nil</span>&nbsp;<span class="op" id="1493045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493049">memmove</span><span class="op" id="1493056">(</span><span class="ident" id="1493057">ep</span><span class="op" id="1493059">,</span>&nbsp;<span class="ident" id="1493061">chanbuf</span><span class="op" id="1493068">(</span><span class="ident" id="1493069">c</span><span class="op" id="1493070">,</span>&nbsp;<span class="ident" id="1493072">c</span><span class="op" id="1493073">.</span><span class="ident" id="1493074">recvx</span><span class="op" id="1493079">)</span><span class="op" id="1493080">,</span>&nbsp;<span class="builtintype" id="1493082">uintptr</span><span class="op" id="1493089">(</span><span class="ident" id="1493090">c</span><span class="op" id="1493091">.</span><span class="ident" id="1493092">elemsize</span><span class="op" id="1493100">)</span><span class="op" id="1493101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493107">memclr</span><span class="op" id="1493113">(</span><span class="ident" id="1493114">chanbuf</span><span class="op" id="1493121">(</span><span class="ident" id="1493122">c</span><span class="op" id="1493123">,</span>&nbsp;<span class="ident" id="1493125">c</span><span class="op" id="1493126">.</span><span class="ident" id="1493127">recvx</span><span class="op" id="1493132">)</span><span class="op" id="1493133">,</span>&nbsp;<span class="builtintype" id="1493135">uintptr</span><span class="op" id="1493142">(</span><span class="ident" id="1493143">c</span><span class="op" id="1493144">.</span><span class="ident" id="1493145">elemsize</span><span class="op" id="1493153">)</span><span class="op" id="1493154">)</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493158">c</span><span class="op" id="1493159">.</span><span class="ident" id="1493160">recvx</span><span class="op" id="1493165">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493169">if</span>&nbsp;<span class="ident" id="1493172">c</span><span class="op" id="1493173">.</span><span class="ident" id="1493174">recvx</span>&nbsp;<span class="op" id="1493180">==</span>&nbsp;<span class="ident" id="1493183">c</span><span class="op" id="1493184">.</span><span class="ident" id="1493185">dataqsiz</span>&nbsp;<span class="op" id="1493194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493198">c</span><span class="op" id="1493199">.</span><span class="ident" id="1493200">recvx</span>&nbsp;<span class="op" id="1493206">=</span>&nbsp;<span class="num" id="1493208">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493211">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493214">c</span><span class="op" id="1493215">.</span><span class="ident" id="1493216">qcount</span><span class="op" id="1493222">--</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1493227">//&nbsp;ping&nbsp;a&nbsp;sender&nbsp;now&nbsp;that&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493269">sg</span>&nbsp;<span class="op" id="1493272">:=</span>&nbsp;<span class="ident" id="1493275">c</span><span class="op" id="1493276">.</span><span class="ident" id="1493277">sendq</span><span class="op" id="1493282">.</span><span class="ident" id="1493283">dequeue</span><span class="op" id="1493290">(</span><span class="op" id="1493291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493294">if</span>&nbsp;<span class="ident" id="1493297">sg</span>&nbsp;<span class="op" id="1493300">!=</span>&nbsp;<span class="ident" id="1493303">nil</span>&nbsp;<span class="op" id="1493307">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493311">gp</span>&nbsp;<span class="op" id="1493314">:=</span>&nbsp;<span class="ident" id="1493317">sg</span><span class="op" id="1493319">.</span><span class="ident" id="1493320">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493324">unlock</span><span class="op" id="1493330">(</span><span class="op" id="1493331">&amp;</span><span class="ident" id="1493332">c</span><span class="op" id="1493333">.</span><span class="ident" id="1493334">lock</span><span class="op" id="1493338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493342">if</span>&nbsp;<span class="ident" id="1493345">sg</span><span class="op" id="1493347">.</span><span class="ident" id="1493348">releasetime</span>&nbsp;<span class="op" id="1493360">!=</span>&nbsp;<span class="num" id="1493363">0</span>&nbsp;<span class="op" id="1493365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493370">sg</span><span class="op" id="1493372">.</span><span class="ident" id="1493373">releasetime</span>&nbsp;<span class="op" id="1493385">=</span>&nbsp;<span class="ident" id="1493387">cputicks</span><span class="op" id="1493395">(</span><span class="op" id="1493396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493400">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493404">goready</span><span class="op" id="1493411">(</span><span class="ident" id="1493412">gp</span><span class="op" id="1493414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493417">}</span>&nbsp;<span class="keyword" id="1493419">else</span>&nbsp;<span class="op" id="1493424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493428">unlock</span><span class="op" id="1493434">(</span><span class="op" id="1493435">&amp;</span><span class="ident" id="1493436">c</span><span class="op" id="1493437">.</span><span class="ident" id="1493438">lock</span><span class="op" id="1493442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493449">if</span>&nbsp;<span class="ident" id="1493452">t1</span>&nbsp;<span class="op" id="1493455">&gt;</span>&nbsp;<span class="num" id="1493457">0</span>&nbsp;<span class="op" id="1493459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493463">blockevent</span><span class="op" id="1493473">(</span><span class="ident" id="1493474">t1</span><span class="op" id="1493476">-</span><span class="ident" id="1493477">t0</span><span class="op" id="1493479">,</span>&nbsp;<span class="num" id="1493481">2</span><span class="op" id="1493482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493488">selected</span>&nbsp;<span class="op" id="1493497">=</span>&nbsp;<span class="builtintype" id="1493499">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493505">received</span>&nbsp;<span class="op" id="1493514">=</span>&nbsp;<span class="builtintype" id="1493516">true</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493522">return</span><br>
<span class="lineno"></span><span class="op" id="1493529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1493532">//&nbsp;recvclosed&nbsp;is&nbsp;a&nbsp;helper&nbsp;function&nbsp;for&nbsp;chanrecv.&nbsp;&nbsp;Handles&nbsp;cleanup</span><br>
<span class="lineno"></span><span class="comment" id="1493598">//&nbsp;when&nbsp;the&nbsp;receiver&nbsp;encounters&nbsp;a&nbsp;closed&nbsp;channel.</span><br>
<span class="lineno">515</span><span class="comment" id="1493648">//&nbsp;Caller&nbsp;must&nbsp;hold&nbsp;c.lock,&nbsp;recvclosed&nbsp;will&nbsp;release&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1493710">func</span>&nbsp;<span class="ident" id="1493715">recvclosed</span><span class="op" id="1493725">(</span><span class="ident" id="1493726">c</span>&nbsp;<span class="op" id="1493728">*</span><span class="ident" id="1493729">hchan</span><span class="op" id="1493734">,</span>&nbsp;<span class="ident" id="1493736">ep</span>&nbsp;<span class="ident" id="1493739">unsafe</span><span class="op" id="1493745">.</span><span class="ident" id="1493746">Pointer</span><span class="op" id="1493753">)</span>&nbsp;<span class="op" id="1493755">(</span><span class="ident" id="1493756">selected</span><span class="op" id="1493764">,</span>&nbsp;<span class="ident" id="1493766">recevied</span>&nbsp;<span class="builtintype" id="1493775">bool</span><span class="op" id="1493779">)</span>&nbsp;<span class="op" id="1493781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493784">if</span>&nbsp;<span class="ident" id="1493787">raceenabled</span>&nbsp;<span class="op" id="1493799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493803">raceacquire</span><span class="op" id="1493814">(</span><span class="ident" id="1493815">unsafe</span><span class="op" id="1493821">.</span><span class="ident" id="1493822">Pointer</span><span class="op" id="1493829">(</span><span class="ident" id="1493830">c</span><span class="op" id="1493831">)</span><span class="op" id="1493832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493835">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493838">unlock</span><span class="op" id="1493844">(</span><span class="op" id="1493845">&amp;</span><span class="ident" id="1493846">c</span><span class="op" id="1493847">.</span><span class="ident" id="1493848">lock</span><span class="op" id="1493852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493855">if</span>&nbsp;<span class="ident" id="1493858">ep</span>&nbsp;<span class="op" id="1493861">!=</span>&nbsp;<span class="ident" id="1493864">nil</span>&nbsp;<span class="op" id="1493868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493872">memclr</span><span class="op" id="1493878">(</span><span class="ident" id="1493879">ep</span><span class="op" id="1493881">,</span>&nbsp;<span class="builtintype" id="1493883">uintptr</span><span class="op" id="1493890">(</span><span class="ident" id="1493891">c</span><span class="op" id="1493892">.</span><span class="ident" id="1493893">elemsize</span><span class="op" id="1493901">)</span><span class="op" id="1493902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493908">return</span>&nbsp;<span class="builtintype" id="1493915">true</span><span class="op" id="1493919">,</span>&nbsp;<span class="builtintype" id="1493921">false</span><br>
<span class="lineno">525</span><span class="op" id="1493927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1493930">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1493953">//</span><br>
<span class="lineno"></span><span class="comment" id="1493956">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno">530</span><span class="comment" id="1493968">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;c&nbsp;&lt;-&nbsp;v:</span><br>
<span class="lineno"></span><span class="comment" id="1493984">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1493996">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1494008">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1494020">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">535</span><span class="comment" id="1494025">//</span><br>
<span class="lineno"></span><span class="comment" id="1494028">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1494034">//</span><br>
<span class="lineno"></span><span class="comment" id="1494037">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;selectnbsend(c,&nbsp;v)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1494064">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno">540</span><span class="comment" id="1494076">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1494088">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1494100">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1494105">//</span><br>
<span class="lineno"></span><span class="keyword" id="1494108">func</span>&nbsp;<span class="ident" id="1494113">selectnbsend</span><span class="op" id="1494125">(</span><span class="ident" id="1494126">t</span>&nbsp;<span class="op" id="1494128">*</span><span class="ident" id="1494129">chantype</span><span class="op" id="1494137">,</span>&nbsp;<span class="ident" id="1494139">c</span>&nbsp;<span class="op" id="1494141">*</span><span class="ident" id="1494142">hchan</span><span class="op" id="1494147">,</span>&nbsp;<span class="ident" id="1494149">elem</span>&nbsp;<span class="ident" id="1494154">unsafe</span><span class="op" id="1494160">.</span><span class="ident" id="1494161">Pointer</span><span class="op" id="1494168">)</span>&nbsp;<span class="op" id="1494170">(</span><span class="ident" id="1494171">selected</span>&nbsp;<span class="builtintype" id="1494180">bool</span><span class="op" id="1494184">)</span>&nbsp;<span class="op" id="1494186">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494189">return</span>&nbsp;<span class="ident" id="1494196">chansend</span><span class="op" id="1494204">(</span><span class="ident" id="1494205">t</span><span class="op" id="1494206">,</span>&nbsp;<span class="ident" id="1494208">c</span><span class="op" id="1494209">,</span>&nbsp;<span class="ident" id="1494211">elem</span><span class="op" id="1494215">,</span>&nbsp;<span class="builtintype" id="1494217">false</span><span class="op" id="1494222">,</span>&nbsp;<span class="ident" id="1494224">getcallerpc</span><span class="op" id="1494235">(</span><span class="ident" id="1494236">unsafe</span><span class="op" id="1494242">.</span><span class="ident" id="1494243">Pointer</span><span class="op" id="1494250">(</span><span class="op" id="1494251">&amp;</span><span class="ident" id="1494252">t</span><span class="op" id="1494253">)</span><span class="op" id="1494254">)</span><span class="op" id="1494255">)</span><br>
<span class="lineno"></span><span class="op" id="1494257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1494260">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1494283">//</span><br>
<span class="lineno">550</span><span class="comment" id="1494286">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1494298">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;v&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1494315">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1494327">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1494339">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno">555</span><span class="comment" id="1494351">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1494356">//</span><br>
<span class="lineno"></span><span class="comment" id="1494359">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1494365">//</span><br>
<span class="lineno"></span><span class="comment" id="1494368">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;selectnbrecv(&amp;v,&nbsp;c)&nbsp;{</span><br>
<span class="lineno">560</span><span class="comment" id="1494396">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1494408">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1494420">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1494432">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1494437">//</span><br>
<span class="lineno">565</span><span class="keyword" id="1494440">func</span>&nbsp;<span class="ident" id="1494445">selectnbrecv</span><span class="op" id="1494457">(</span><span class="ident" id="1494458">t</span>&nbsp;<span class="op" id="1494460">*</span><span class="ident" id="1494461">chantype</span><span class="op" id="1494469">,</span>&nbsp;<span class="ident" id="1494471">elem</span>&nbsp;<span class="ident" id="1494476">unsafe</span><span class="op" id="1494482">.</span><span class="ident" id="1494483">Pointer</span><span class="op" id="1494490">,</span>&nbsp;<span class="ident" id="1494492">c</span>&nbsp;<span class="op" id="1494494">*</span><span class="ident" id="1494495">hchan</span><span class="op" id="1494500">)</span>&nbsp;<span class="op" id="1494502">(</span><span class="ident" id="1494503">selected</span>&nbsp;<span class="builtintype" id="1494512">bool</span><span class="op" id="1494516">)</span>&nbsp;<span class="op" id="1494518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494521">selected</span><span class="op" id="1494529">,</span>&nbsp;<span class="ident" id="1494531">_</span>&nbsp;<span class="op" id="1494533">=</span>&nbsp;<span class="ident" id="1494535">chanrecv</span><span class="op" id="1494543">(</span><span class="ident" id="1494544">t</span><span class="op" id="1494545">,</span>&nbsp;<span class="ident" id="1494547">c</span><span class="op" id="1494548">,</span>&nbsp;<span class="ident" id="1494550">elem</span><span class="op" id="1494554">,</span>&nbsp;<span class="builtintype" id="1494556">false</span><span class="op" id="1494561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494564">return</span><br>
<span class="lineno"></span><span class="op" id="1494571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">570</span><span class="comment" id="1494574">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1494597">//</span><br>
<span class="lineno"></span><span class="comment" id="1494600">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1494612">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;v,&nbsp;ok&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1494633">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno">575</span><span class="comment" id="1494645">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1494657">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1494669">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1494674">//</span><br>
<span class="lineno"></span><span class="comment" id="1494677">//&nbsp;as</span><br>
<span class="lineno">580</span><span class="comment" id="1494683">//</span><br>
<span class="lineno"></span><span class="comment" id="1494686">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;c&nbsp;!=&nbsp;nil&nbsp;&amp;&amp;&nbsp;selectnbrecv2(&amp;v,&nbsp;&amp;ok,&nbsp;c)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1494732">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1494744">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1494756">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno">585</span><span class="comment" id="1494768">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1494773">//</span><br>
<span class="lineno"></span><span class="keyword" id="1494776">func</span>&nbsp;<span class="ident" id="1494781">selectnbrecv2</span><span class="op" id="1494794">(</span><span class="ident" id="1494795">t</span>&nbsp;<span class="op" id="1494797">*</span><span class="ident" id="1494798">chantype</span><span class="op" id="1494806">,</span>&nbsp;<span class="ident" id="1494808">elem</span>&nbsp;<span class="ident" id="1494813">unsafe</span><span class="op" id="1494819">.</span><span class="ident" id="1494820">Pointer</span><span class="op" id="1494827">,</span>&nbsp;<span class="ident" id="1494829">received</span>&nbsp;<span class="op" id="1494838">*</span><span class="builtintype" id="1494839">bool</span><span class="op" id="1494843">,</span>&nbsp;<span class="ident" id="1494845">c</span>&nbsp;<span class="op" id="1494847">*</span><span class="ident" id="1494848">hchan</span><span class="op" id="1494853">)</span>&nbsp;<span class="op" id="1494855">(</span><span class="ident" id="1494856">selected</span>&nbsp;<span class="builtintype" id="1494865">bool</span><span class="op" id="1494869">)</span>&nbsp;<span class="op" id="1494871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1494874">//&nbsp;TODO(khr):&nbsp;just&nbsp;return&nbsp;2&nbsp;values&nbsp;from&nbsp;this&nbsp;function,&nbsp;now&nbsp;that&nbsp;it&nbsp;is&nbsp;in&nbsp;Go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494952">selected</span><span class="op" id="1494960">,</span>&nbsp;<span class="op" id="1494962">*</span><span class="ident" id="1494963">received</span>&nbsp;<span class="op" id="1494972">=</span>&nbsp;<span class="ident" id="1494974">chanrecv</span><span class="op" id="1494982">(</span><span class="ident" id="1494983">t</span><span class="op" id="1494984">,</span>&nbsp;<span class="ident" id="1494986">c</span><span class="op" id="1494987">,</span>&nbsp;<span class="ident" id="1494989">elem</span><span class="op" id="1494993">,</span>&nbsp;<span class="builtintype" id="1494995">false</span><span class="op" id="1495000">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495003">return</span><br>
<span class="lineno"></span><span class="op" id="1495010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1495013">func</span>&nbsp;<span class="ident" id="1495018">reflect_chansend</span><span class="op" id="1495034">(</span><span class="ident" id="1495035">t</span>&nbsp;<span class="op" id="1495037">*</span><span class="ident" id="1495038">chantype</span><span class="op" id="1495046">,</span>&nbsp;<span class="ident" id="1495048">c</span>&nbsp;<span class="op" id="1495050">*</span><span class="ident" id="1495051">hchan</span><span class="op" id="1495056">,</span>&nbsp;<span class="ident" id="1495058">elem</span>&nbsp;<span class="ident" id="1495063">unsafe</span><span class="op" id="1495069">.</span><span class="ident" id="1495070">Pointer</span><span class="op" id="1495077">,</span>&nbsp;<span class="ident" id="1495079">nb</span>&nbsp;<span class="builtintype" id="1495082">bool</span><span class="op" id="1495086">)</span>&nbsp;<span class="op" id="1495088">(</span><span class="ident" id="1495089">selected</span>&nbsp;<span class="builtintype" id="1495098">bool</span><span class="op" id="1495102">)</span>&nbsp;<span class="op" id="1495104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495107">return</span>&nbsp;<span class="ident" id="1495114">chansend</span><span class="op" id="1495122">(</span><span class="ident" id="1495123">t</span><span class="op" id="1495124">,</span>&nbsp;<span class="ident" id="1495126">c</span><span class="op" id="1495127">,</span>&nbsp;<span class="ident" id="1495129">elem</span><span class="op" id="1495133">,</span>&nbsp;<span class="op" id="1495135">!</span><span class="ident" id="1495136">nb</span><span class="op" id="1495138">,</span>&nbsp;<span class="ident" id="1495140">getcallerpc</span><span class="op" id="1495151">(</span><span class="ident" id="1495152">unsafe</span><span class="op" id="1495158">.</span><span class="ident" id="1495159">Pointer</span><span class="op" id="1495166">(</span><span class="op" id="1495167">&amp;</span><span class="ident" id="1495168">t</span><span class="op" id="1495169">)</span><span class="op" id="1495170">)</span><span class="op" id="1495171">)</span><br>
<span class="lineno">595</span><span class="op" id="1495173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1495176">func</span>&nbsp;<span class="ident" id="1495181">reflect_chanrecv</span><span class="op" id="1495197">(</span><span class="ident" id="1495198">t</span>&nbsp;<span class="op" id="1495200">*</span><span class="ident" id="1495201">chantype</span><span class="op" id="1495209">,</span>&nbsp;<span class="ident" id="1495211">c</span>&nbsp;<span class="op" id="1495213">*</span><span class="ident" id="1495214">hchan</span><span class="op" id="1495219">,</span>&nbsp;<span class="ident" id="1495221">nb</span>&nbsp;<span class="builtintype" id="1495224">bool</span><span class="op" id="1495228">,</span>&nbsp;<span class="ident" id="1495230">elem</span>&nbsp;<span class="ident" id="1495235">unsafe</span><span class="op" id="1495241">.</span><span class="ident" id="1495242">Pointer</span><span class="op" id="1495249">)</span>&nbsp;<span class="op" id="1495251">(</span><span class="ident" id="1495252">selected</span>&nbsp;<span class="builtintype" id="1495261">bool</span><span class="op" id="1495265">,</span>&nbsp;<span class="ident" id="1495267">received</span>&nbsp;<span class="builtintype" id="1495276">bool</span><span class="op" id="1495280">)</span>&nbsp;<span class="op" id="1495282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495285">return</span>&nbsp;<span class="ident" id="1495292">chanrecv</span><span class="op" id="1495300">(</span><span class="ident" id="1495301">t</span><span class="op" id="1495302">,</span>&nbsp;<span class="ident" id="1495304">c</span><span class="op" id="1495305">,</span>&nbsp;<span class="ident" id="1495307">elem</span><span class="op" id="1495311">,</span>&nbsp;<span class="op" id="1495313">!</span><span class="ident" id="1495314">nb</span><span class="op" id="1495316">)</span><br>
<span class="lineno"></span><span class="op" id="1495318">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="1495321">func</span>&nbsp;<span class="ident" id="1495326">reflect_chanlen</span><span class="op" id="1495341">(</span><span class="ident" id="1495342">c</span>&nbsp;<span class="op" id="1495344">*</span><span class="ident" id="1495345">hchan</span><span class="op" id="1495350">)</span>&nbsp;<span class="builtintype" id="1495352">int</span>&nbsp;<span class="op" id="1495356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495359">if</span>&nbsp;<span class="ident" id="1495362">c</span>&nbsp;<span class="op" id="1495364">==</span>&nbsp;<span class="ident" id="1495367">nil</span>&nbsp;<span class="op" id="1495371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495375">return</span>&nbsp;<span class="num" id="1495382">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495385">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495388">return</span>&nbsp;<span class="builtintype" id="1495395">int</span><span class="op" id="1495398">(</span><span class="ident" id="1495399">c</span><span class="op" id="1495400">.</span><span class="ident" id="1495401">qcount</span><span class="op" id="1495407">)</span><br>
<span class="lineno"></span><span class="op" id="1495409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1495412">func</span>&nbsp;<span class="ident" id="1495417">reflect_chancap</span><span class="op" id="1495432">(</span><span class="ident" id="1495433">c</span>&nbsp;<span class="op" id="1495435">*</span><span class="ident" id="1495436">hchan</span><span class="op" id="1495441">)</span>&nbsp;<span class="builtintype" id="1495443">int</span>&nbsp;<span class="op" id="1495447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495450">if</span>&nbsp;<span class="ident" id="1495453">c</span>&nbsp;<span class="op" id="1495455">==</span>&nbsp;<span class="ident" id="1495458">nil</span>&nbsp;<span class="op" id="1495462">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495466">return</span>&nbsp;<span class="num" id="1495473">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495479">return</span>&nbsp;<span class="builtintype" id="1495486">int</span><span class="op" id="1495489">(</span><span class="ident" id="1495490">c</span><span class="op" id="1495491">.</span><span class="ident" id="1495492">dataqsiz</span><span class="op" id="1495500">)</span><br>
<span class="lineno"></span><span class="op" id="1495502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="keyword" id="1495505">func</span>&nbsp;<span class="op" id="1495510">(</span><span class="ident" id="1495511">q</span>&nbsp;<span class="op" id="1495513">*</span><span class="ident" id="1495514">waitq</span><span class="op" id="1495519">)</span>&nbsp;<span class="ident" id="1495521">enqueue</span><span class="op" id="1495528">(</span><span class="ident" id="1495529">sgp</span>&nbsp;<span class="op" id="1495533">*</span><span class="ident" id="1495534">sudog</span><span class="op" id="1495539">)</span>&nbsp;<span class="op" id="1495541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495544">sgp</span><span class="op" id="1495547">.</span><span class="ident" id="1495548">next</span>&nbsp;<span class="op" id="1495553">=</span>&nbsp;<span class="ident" id="1495555">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495560">if</span>&nbsp;<span class="ident" id="1495563">q</span><span class="op" id="1495564">.</span><span class="ident" id="1495565">first</span>&nbsp;<span class="op" id="1495571">==</span>&nbsp;<span class="ident" id="1495574">nil</span>&nbsp;<span class="op" id="1495578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495582">q</span><span class="op" id="1495583">.</span><span class="ident" id="1495584">first</span>&nbsp;<span class="op" id="1495590">=</span>&nbsp;<span class="ident" id="1495592">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495598">q</span><span class="op" id="1495599">.</span><span class="ident" id="1495600">last</span>&nbsp;<span class="op" id="1495605">=</span>&nbsp;<span class="ident" id="1495607">sgp</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495613">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495624">q</span><span class="op" id="1495625">.</span><span class="ident" id="1495626">last</span><span class="op" id="1495630">.</span><span class="ident" id="1495631">next</span>&nbsp;<span class="op" id="1495636">=</span>&nbsp;<span class="ident" id="1495638">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495643">q</span><span class="op" id="1495644">.</span><span class="ident" id="1495645">last</span>&nbsp;<span class="op" id="1495650">=</span>&nbsp;<span class="ident" id="1495652">sgp</span><br>
<span class="lineno"></span><span class="op" id="1495656">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span><span class="keyword" id="1495659">func</span>&nbsp;<span class="op" id="1495664">(</span><span class="ident" id="1495665">q</span>&nbsp;<span class="op" id="1495667">*</span><span class="ident" id="1495668">waitq</span><span class="op" id="1495673">)</span>&nbsp;<span class="ident" id="1495675">dequeue</span><span class="op" id="1495682">(</span><span class="op" id="1495683">)</span>&nbsp;<span class="op" id="1495685">*</span><span class="ident" id="1495686">sudog</span>&nbsp;<span class="op" id="1495692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495695">for</span>&nbsp;<span class="op" id="1495699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495703">sgp</span>&nbsp;<span class="op" id="1495707">:=</span>&nbsp;<span class="ident" id="1495710">q</span><span class="op" id="1495711">.</span><span class="ident" id="1495712">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495720">if</span>&nbsp;<span class="ident" id="1495723">sgp</span>&nbsp;<span class="op" id="1495727">==</span>&nbsp;<span class="ident" id="1495730">nil</span>&nbsp;<span class="op" id="1495734">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495739">return</span>&nbsp;<span class="ident" id="1495746">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495756">q</span><span class="op" id="1495757">.</span><span class="ident" id="1495758">first</span>&nbsp;<span class="op" id="1495764">=</span>&nbsp;<span class="ident" id="1495766">sgp</span><span class="op" id="1495769">.</span><span class="ident" id="1495770">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495777">sgp</span><span class="op" id="1495780">.</span><span class="ident" id="1495781">next</span>&nbsp;<span class="op" id="1495786">=</span>&nbsp;<span class="ident" id="1495788">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495794">if</span>&nbsp;<span class="ident" id="1495797">q</span><span class="op" id="1495798">.</span><span class="ident" id="1495799">last</span>&nbsp;<span class="op" id="1495804">==</span>&nbsp;<span class="ident" id="1495807">sgp</span>&nbsp;<span class="op" id="1495811">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495816">q</span><span class="op" id="1495817">.</span><span class="ident" id="1495818">last</span>&nbsp;<span class="op" id="1495823">=</span>&nbsp;<span class="ident" id="1495825">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1495836">//&nbsp;if&nbsp;sgp&nbsp;participates&nbsp;in&nbsp;a&nbsp;select&nbsp;and&nbsp;is&nbsp;already&nbsp;signaled,&nbsp;ignore&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495908">if</span>&nbsp;<span class="ident" id="1495911">sgp</span><span class="op" id="1495914">.</span><span class="ident" id="1495915">selectdone</span>&nbsp;<span class="op" id="1495926">!=</span>&nbsp;<span class="ident" id="1495929">nil</span>&nbsp;<span class="op" id="1495933">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1495938">//&nbsp;claim&nbsp;the&nbsp;right&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495970">if</span>&nbsp;<span class="op" id="1495973">*</span><span class="ident" id="1495974">sgp</span><span class="op" id="1495977">.</span><span class="ident" id="1495978">selectdone</span>&nbsp;<span class="op" id="1495989">!=</span>&nbsp;<span class="num" id="1495992">0</span>&nbsp;<span class="op" id="1495994">||</span>&nbsp;<span class="op" id="1495997">!</span><span class="ident" id="1495998">cas</span><span class="op" id="1496001">(</span><span class="ident" id="1496002">sgp</span><span class="op" id="1496005">.</span><span class="ident" id="1496006">selectdone</span><span class="op" id="1496016">,</span>&nbsp;<span class="num" id="1496018">0</span><span class="op" id="1496019">,</span>&nbsp;<span class="num" id="1496021">1</span><span class="op" id="1496022">)</span>&nbsp;<span class="op" id="1496024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496030">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1496042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1496046">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496051">return</span>&nbsp;<span class="ident" id="1496058">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1496063">}</span><br>
<span class="lineno"></span><span class="op" id="1496065">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="keyword" id="1496068">func</span>&nbsp;<span class="ident" id="1496073">racesync</span><span class="op" id="1496081">(</span><span class="ident" id="1496082">c</span>&nbsp;<span class="op" id="1496084">*</span><span class="ident" id="1496085">hchan</span><span class="op" id="1496090">,</span>&nbsp;<span class="ident" id="1496092">sg</span>&nbsp;<span class="op" id="1496095">*</span><span class="ident" id="1496096">sudog</span><span class="op" id="1496101">)</span>&nbsp;<span class="op" id="1496103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496106">racerelease</span><span class="op" id="1496117">(</span><span class="ident" id="1496118">chanbuf</span><span class="op" id="1496125">(</span><span class="ident" id="1496126">c</span><span class="op" id="1496127">,</span>&nbsp;<span class="num" id="1496129">0</span><span class="op" id="1496130">)</span><span class="op" id="1496131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496134">raceacquireg</span><span class="op" id="1496146">(</span><span class="ident" id="1496147">sg</span><span class="op" id="1496149">.</span><span class="ident" id="1496150">g</span><span class="op" id="1496151">,</span>&nbsp;<span class="ident" id="1496153">chanbuf</span><span class="op" id="1496160">(</span><span class="ident" id="1496161">c</span><span class="op" id="1496162">,</span>&nbsp;<span class="num" id="1496164">0</span><span class="op" id="1496165">)</span><span class="op" id="1496166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496169">racereleaseg</span><span class="op" id="1496181">(</span><span class="ident" id="1496182">sg</span><span class="op" id="1496184">.</span><span class="ident" id="1496185">g</span><span class="op" id="1496186">,</span>&nbsp;<span class="ident" id="1496188">chanbuf</span><span class="op" id="1496195">(</span><span class="ident" id="1496196">c</span><span class="op" id="1496197">,</span>&nbsp;<span class="num" id="1496199">0</span><span class="op" id="1496200">)</span><span class="op" id="1496201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496204">raceacquire</span><span class="op" id="1496215">(</span><span class="ident" id="1496216">chanbuf</span><span class="op" id="1496223">(</span><span class="ident" id="1496224">c</span><span class="op" id="1496225">,</span>&nbsp;<span class="num" id="1496227">0</span><span class="op" id="1496228">)</span><span class="op" id="1496229">)</span><br>
<span class="lineno">655</span><span class="op" id="1496231">}</span>
</div>
</body>
</html>
