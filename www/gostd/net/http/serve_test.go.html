<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html" class="current">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="475308">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="475363">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="475417">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="475468">//&nbsp;End-to-end&nbsp;serving&nbsp;tests</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="475497">package</span>&nbsp;<span class="ident" id="475505">http_test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="475516">import</span>&nbsp;<span class="op" id="475523">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475526">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475535">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475544">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475558">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475568">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475575">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475581">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475594">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475601">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475614">&#34;net&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="475621">.</span>&nbsp;<span class="string" id="475623">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475635">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475656">&#34;net/http/httputil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475677">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475688">&#34;os&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475694">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475705">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475716">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475727">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475738">&#34;strings&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475749">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475757">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475772">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475783">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="475794">&#34;time&#34;</span><br>
<span class="lineno">35</span><span class="op" id="475801">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="475804">type</span>&nbsp;<span class="ident" id="475809">dummyAddr</span>&nbsp;<span class="builtintype" id="475819">string</span><br>
<span class="lineno"></span><span class="keyword" id="475826">type</span>&nbsp;<span class="ident" id="475831">oneConnListener</span>&nbsp;<span class="keyword" id="475847">struct</span>&nbsp;<span class="op" id="475854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="475857">conn</span>&nbsp;<span class="ident" id="475862">net</span><span class="op" id="475865">.</span><span class="ident" id="475866">Conn</span><br>
<span class="lineno">40</span><span class="op" id="475871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="475874">func</span>&nbsp;<span class="op" id="475879">(</span><span class="ident" id="475880">l</span>&nbsp;<span class="op" id="475882">*</span><span class="ident" id="475883">oneConnListener</span><span class="op" id="475898">)</span>&nbsp;<span class="ident" id="475900">Accept</span><span class="op" id="475906">(</span><span class="op" id="475907">)</span>&nbsp;<span class="op" id="475909">(</span><span class="ident" id="475910">c</span>&nbsp;<span class="ident" id="475912">net</span><span class="op" id="475915">.</span><span class="ident" id="475916">Conn</span><span class="op" id="475920">,</span>&nbsp;<span class="ident" id="475922">err</span>&nbsp;<span class="builtintype" id="475926">error</span><span class="op" id="475931">)</span>&nbsp;<span class="op" id="475933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="475936">c</span>&nbsp;<span class="op" id="475938">=</span>&nbsp;<span class="ident" id="475940">l</span><span class="op" id="475941">.</span><span class="ident" id="475942">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="475948">if</span>&nbsp;<span class="ident" id="475951">c</span>&nbsp;<span class="op" id="475953">==</span>&nbsp;<span class="builtintype" id="475956">nil</span>&nbsp;<span class="op" id="475960">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="475964">err</span>&nbsp;<span class="op" id="475968">=</span>&nbsp;<span class="ident" id="475970">io</span><span class="op" id="475972">.</span><span class="ident" id="475973">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="475979">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="475987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="475990">err</span>&nbsp;<span class="op" id="475994">=</span>&nbsp;<span class="builtintype" id="475996">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="476001">l</span><span class="op" id="476002">.</span><span class="ident" id="476003">conn</span>&nbsp;<span class="op" id="476008">=</span>&nbsp;<span class="builtintype" id="476010">nil</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="476015">return</span><br>
<span class="lineno"></span><span class="op" id="476022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="476025">func</span>&nbsp;<span class="op" id="476030">(</span><span class="ident" id="476031">l</span>&nbsp;<span class="op" id="476033">*</span><span class="ident" id="476034">oneConnListener</span><span class="op" id="476049">)</span>&nbsp;<span class="ident" id="476051">Close</span><span class="op" id="476056">(</span><span class="op" id="476057">)</span>&nbsp;<span class="builtintype" id="476059">error</span>&nbsp;<span class="op" id="476065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="476068">return</span>&nbsp;<span class="builtintype" id="476075">nil</span><br>
<span class="lineno">55</span><span class="op" id="476079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="476082">func</span>&nbsp;<span class="op" id="476087">(</span><span class="ident" id="476088">l</span>&nbsp;<span class="op" id="476090">*</span><span class="ident" id="476091">oneConnListener</span><span class="op" id="476106">)</span>&nbsp;<span class="ident" id="476108">Addr</span><span class="op" id="476112">(</span><span class="op" id="476113">)</span>&nbsp;<span class="ident" id="476115">net</span><span class="op" id="476118">.</span><span class="ident" id="476119">Addr</span>&nbsp;<span class="op" id="476124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="476127">return</span>&nbsp;<span class="ident" id="476134">dummyAddr</span><span class="op" id="476143">(</span><span class="string" id="476144">&#34;test-address&#34;</span><span class="op" id="476158">)</span><br>
<span class="lineno"></span><span class="op" id="476160">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="476163">func</span>&nbsp;<span class="op" id="476168">(</span><span class="ident" id="476169">a</span>&nbsp;<span class="ident" id="476171">dummyAddr</span><span class="op" id="476180">)</span>&nbsp;<span class="ident" id="476182">Network</span><span class="op" id="476189">(</span><span class="op" id="476190">)</span>&nbsp;<span class="builtintype" id="476192">string</span>&nbsp;<span class="op" id="476199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="476202">return</span>&nbsp;<span class="builtintype" id="476209">string</span><span class="op" id="476215">(</span><span class="ident" id="476216">a</span><span class="op" id="476217">)</span><br>
<span class="lineno"></span><span class="op" id="476219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="476222">func</span>&nbsp;<span class="op" id="476227">(</span><span class="ident" id="476228">a</span>&nbsp;<span class="ident" id="476230">dummyAddr</span><span class="op" id="476239">)</span>&nbsp;<span class="ident" id="476241">String</span><span class="op" id="476247">(</span><span class="op" id="476248">)</span>&nbsp;<span class="builtintype" id="476250">string</span>&nbsp;<span class="op" id="476257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="476260">return</span>&nbsp;<span class="builtintype" id="476267">string</span><span class="op" id="476273">(</span><span class="ident" id="476274">a</span><span class="op" id="476275">)</span><br>
<span class="lineno"></span><span class="op" id="476277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="476280">type</span>&nbsp;<span class="ident" id="476285">noopConn</span>&nbsp;<span class="keyword" id="476294">struct</span><span class="op" id="476300">{</span><span class="op" id="476301">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="476304">func</span>&nbsp;<span class="op" id="476309">(</span><span class="ident" id="476310">noopConn</span><span class="op" id="476318">)</span>&nbsp;<span class="ident" id="476320">LocalAddr</span><span class="op" id="476329">(</span><span class="op" id="476330">)</span>&nbsp;<span class="ident" id="476332">net</span><span class="op" id="476335">.</span><span class="ident" id="476336">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="476356">{</span>&nbsp;<span class="keyword" id="476358">return</span>&nbsp;<span class="ident" id="476365">dummyAddr</span><span class="op" id="476374">(</span><span class="string" id="476375">&#34;local-addr&#34;</span><span class="op" id="476387">)</span>&nbsp;<span class="op" id="476389">}</span><br>
<span class="lineno"></span><span class="keyword" id="476391">func</span>&nbsp;<span class="op" id="476396">(</span><span class="ident" id="476397">noopConn</span><span class="op" id="476405">)</span>&nbsp;<span class="ident" id="476407">RemoteAddr</span><span class="op" id="476417">(</span><span class="op" id="476418">)</span>&nbsp;<span class="ident" id="476420">net</span><span class="op" id="476423">.</span><span class="ident" id="476424">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="476443">{</span>&nbsp;<span class="keyword" id="476445">return</span>&nbsp;<span class="ident" id="476452">dummyAddr</span><span class="op" id="476461">(</span><span class="string" id="476462">&#34;remote-addr&#34;</span><span class="op" id="476475">)</span>&nbsp;<span class="op" id="476477">}</span><br>
<span class="lineno"></span><span class="keyword" id="476479">func</span>&nbsp;<span class="op" id="476484">(</span><span class="ident" id="476485">noopConn</span><span class="op" id="476493">)</span>&nbsp;<span class="ident" id="476495">SetDeadline</span><span class="op" id="476506">(</span><span class="ident" id="476507">t</span>&nbsp;<span class="ident" id="476509">time</span><span class="op" id="476513">.</span><span class="ident" id="476514">Time</span><span class="op" id="476518">)</span>&nbsp;<span class="builtintype" id="476520">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="476531">{</span>&nbsp;<span class="keyword" id="476533">return</span>&nbsp;<span class="builtintype" id="476540">nil</span>&nbsp;<span class="op" id="476544">}</span><br>
<span class="lineno"></span><span class="keyword" id="476546">func</span>&nbsp;<span class="op" id="476551">(</span><span class="ident" id="476552">noopConn</span><span class="op" id="476560">)</span>&nbsp;<span class="ident" id="476562">SetReadDeadline</span><span class="op" id="476577">(</span><span class="ident" id="476578">t</span>&nbsp;<span class="ident" id="476580">time</span><span class="op" id="476584">.</span><span class="ident" id="476585">Time</span><span class="op" id="476589">)</span>&nbsp;<span class="builtintype" id="476591">error</span>&nbsp;&nbsp;<span class="op" id="476598">{</span>&nbsp;<span class="keyword" id="476600">return</span>&nbsp;<span class="builtintype" id="476607">nil</span>&nbsp;<span class="op" id="476611">}</span><br>
<span class="lineno">75</span><span class="keyword" id="476613">func</span>&nbsp;<span class="op" id="476618">(</span><span class="ident" id="476619">noopConn</span><span class="op" id="476627">)</span>&nbsp;<span class="ident" id="476629">SetWriteDeadline</span><span class="op" id="476645">(</span><span class="ident" id="476646">t</span>&nbsp;<span class="ident" id="476648">time</span><span class="op" id="476652">.</span><span class="ident" id="476653">Time</span><span class="op" id="476657">)</span>&nbsp;<span class="builtintype" id="476659">error</span>&nbsp;<span class="op" id="476665">{</span>&nbsp;<span class="keyword" id="476667">return</span>&nbsp;<span class="builtintype" id="476674">nil</span>&nbsp;<span class="op" id="476678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="476681">type</span>&nbsp;<span class="ident" id="476686">rwTestConn</span>&nbsp;<span class="keyword" id="476697">struct</span>&nbsp;<span class="op" id="476704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="476707">io</span><span class="op" id="476709">.</span><span class="ident" id="476710">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="476718">io</span><span class="op" id="476720">.</span><span class="ident" id="476721">Writer</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="476729">noopConn</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="476740">closeFunc</span>&nbsp;<span class="keyword" id="476750">func</span><span class="op" id="476754">(</span><span class="op" id="476755">)</span>&nbsp;<span class="builtintype" id="476757">error</span>&nbsp;<span class="comment" id="476763">//&nbsp;called&nbsp;if&nbsp;non-nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="476785">closec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="476795">chan</span>&nbsp;<span class="builtintype" id="476800">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="476808">//&nbsp;else,&nbsp;if&nbsp;non-nil,&nbsp;send&nbsp;value&nbsp;to&nbsp;it&nbsp;on&nbsp;close</span><br>
<span class="lineno"></span><span class="op" id="476855">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="476858">func</span>&nbsp;<span class="op" id="476863">(</span><span class="ident" id="476864">c</span>&nbsp;<span class="op" id="476866">*</span><span class="ident" id="476867">rwTestConn</span><span class="op" id="476877">)</span>&nbsp;<span class="ident" id="476879">Close</span><span class="op" id="476884">(</span><span class="op" id="476885">)</span>&nbsp;<span class="builtintype" id="476887">error</span>&nbsp;<span class="op" id="476893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="476896">if</span>&nbsp;<span class="ident" id="476899">c</span><span class="op" id="476900">.</span><span class="ident" id="476901">closeFunc</span>&nbsp;<span class="op" id="476911">!=</span>&nbsp;<span class="builtintype" id="476914">nil</span>&nbsp;<span class="op" id="476918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="476922">return</span>&nbsp;<span class="ident" id="476929">c</span><span class="op" id="476930">.</span><span class="ident" id="476931">closeFunc</span><span class="op" id="476940">(</span><span class="op" id="476941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="476944">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="476947">select</span>&nbsp;<span class="op" id="476954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="476957">case</span>&nbsp;<span class="ident" id="476962">c</span><span class="op" id="476963">.</span><span class="ident" id="476964">closec</span>&nbsp;<span class="op" id="476971">&lt;-</span>&nbsp;<span class="builtintype" id="476974">true</span><span class="op" id="476978">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="476981">default</span><span class="op" id="476988">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="476991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="476994">return</span>&nbsp;<span class="builtintype" id="477001">nil</span><br>
<span class="lineno">95</span><span class="op" id="477005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="477008">type</span>&nbsp;<span class="ident" id="477013">testConn</span>&nbsp;<span class="keyword" id="477022">struct</span>&nbsp;<span class="op" id="477029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="477032">readBuf</span>&nbsp;&nbsp;<span class="ident" id="477041">bytes</span><span class="op" id="477046">.</span><span class="ident" id="477047">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="477055">writeBuf</span>&nbsp;<span class="ident" id="477064">bytes</span><span class="op" id="477069">.</span><span class="ident" id="477070">Buffer</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="477078">closec</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="477087">chan</span>&nbsp;<span class="builtintype" id="477092">bool</span>&nbsp;<span class="comment" id="477097">//&nbsp;if&nbsp;non-nil,&nbsp;send&nbsp;value&nbsp;to&nbsp;it&nbsp;on&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="477139">noopConn</span><br>
<span class="lineno"></span><span class="op" id="477148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="477151">func</span>&nbsp;<span class="op" id="477156">(</span><span class="ident" id="477157">c</span>&nbsp;<span class="op" id="477159">*</span><span class="ident" id="477160">testConn</span><span class="op" id="477168">)</span>&nbsp;<span class="ident" id="477170">Read</span><span class="op" id="477174">(</span><span class="ident" id="477175">b</span>&nbsp;<span class="op" id="477177">[</span><span class="op" id="477178">]</span><span class="builtintype" id="477179">byte</span><span class="op" id="477183">)</span>&nbsp;<span class="op" id="477185">(</span><span class="builtintype" id="477186">int</span><span class="op" id="477189">,</span>&nbsp;<span class="builtintype" id="477191">error</span><span class="op" id="477196">)</span>&nbsp;<span class="op" id="477198">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="477201">return</span>&nbsp;<span class="ident" id="477208">c</span><span class="op" id="477209">.</span><span class="ident" id="477210">readBuf</span><span class="op" id="477217">.</span><span class="ident" id="477218">Read</span><span class="op" id="477222">(</span><span class="ident" id="477223">b</span><span class="op" id="477224">)</span><br>
<span class="lineno"></span><span class="op" id="477226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="477229">func</span>&nbsp;<span class="op" id="477234">(</span><span class="ident" id="477235">c</span>&nbsp;<span class="op" id="477237">*</span><span class="ident" id="477238">testConn</span><span class="op" id="477246">)</span>&nbsp;<span class="ident" id="477248">Write</span><span class="op" id="477253">(</span><span class="ident" id="477254">b</span>&nbsp;<span class="op" id="477256">[</span><span class="op" id="477257">]</span><span class="builtintype" id="477258">byte</span><span class="op" id="477262">)</span>&nbsp;<span class="op" id="477264">(</span><span class="builtintype" id="477265">int</span><span class="op" id="477268">,</span>&nbsp;<span class="builtintype" id="477270">error</span><span class="op" id="477275">)</span>&nbsp;<span class="op" id="477277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="477280">return</span>&nbsp;<span class="ident" id="477287">c</span><span class="op" id="477288">.</span><span class="ident" id="477289">writeBuf</span><span class="op" id="477297">.</span><span class="ident" id="477298">Write</span><span class="op" id="477303">(</span><span class="ident" id="477304">b</span><span class="op" id="477305">)</span><br>
<span class="lineno">110</span><span class="op" id="477307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="477310">func</span>&nbsp;<span class="op" id="477315">(</span><span class="ident" id="477316">c</span>&nbsp;<span class="op" id="477318">*</span><span class="ident" id="477319">testConn</span><span class="op" id="477327">)</span>&nbsp;<span class="ident" id="477329">Close</span><span class="op" id="477334">(</span><span class="op" id="477335">)</span>&nbsp;<span class="builtintype" id="477337">error</span>&nbsp;<span class="op" id="477343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="477346">select</span>&nbsp;<span class="op" id="477353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="477356">case</span>&nbsp;<span class="ident" id="477361">c</span><span class="op" id="477362">.</span><span class="ident" id="477363">closec</span>&nbsp;<span class="op" id="477370">&lt;-</span>&nbsp;<span class="builtintype" id="477373">true</span><span class="op" id="477377">:</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="477380">default</span><span class="op" id="477387">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="477390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="477393">return</span>&nbsp;<span class="builtintype" id="477400">nil</span><br>
<span class="lineno"></span><span class="op" id="477404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="477407">//&nbsp;reqBytes&nbsp;treats&nbsp;req&nbsp;as&nbsp;a&nbsp;request&nbsp;(with&nbsp;\n&nbsp;delimiters)&nbsp;and&nbsp;returns&nbsp;it&nbsp;with&nbsp;\r\n&nbsp;delimiters,</span><br>
<span class="lineno"></span><span class="comment" id="477501">//&nbsp;ending&nbsp;in&nbsp;\r\n\r\n</span><br>
<span class="lineno"></span><span class="keyword" id="477523">func</span>&nbsp;<span class="ident" id="477528">reqBytes</span><span class="op" id="477536">(</span><span class="ident" id="477537">req</span>&nbsp;<span class="builtintype" id="477541">string</span><span class="op" id="477547">)</span>&nbsp;<span class="op" id="477549">[</span><span class="op" id="477550">]</span><span class="builtintype" id="477551">byte</span>&nbsp;<span class="op" id="477556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="477559">return</span>&nbsp;<span class="op" id="477566">[</span><span class="op" id="477567">]</span><span class="builtintype" id="477568">byte</span><span class="op" id="477572">(</span><span class="ident" id="477573">strings</span><span class="op" id="477580">.</span><span class="ident" id="477581">Replace</span><span class="op" id="477588">(</span><span class="ident" id="477589">strings</span><span class="op" id="477596">.</span><span class="ident" id="477597">TrimSpace</span><span class="op" id="477606">(</span><span class="ident" id="477607">req</span><span class="op" id="477610">)</span><span class="op" id="477611">,</span>&nbsp;<span class="string" id="477613">&#34;\n&#34;</span><span class="op" id="477617">,</span>&nbsp;<span class="string" id="477619">&#34;\r\n&#34;</span><span class="op" id="477625">,</span>&nbsp;<span class="op" id="477627">-</span><span class="num" id="477628">1</span><span class="op" id="477629">)</span>&nbsp;<span class="op" id="477631">+</span>&nbsp;<span class="string" id="477633">&#34;\r\n\r\n&#34;</span><span class="op" id="477643">)</span><br>
<span class="lineno"></span><span class="op" id="477645">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="477648">type</span>&nbsp;<span class="ident" id="477653">handlerTest</span>&nbsp;<span class="keyword" id="477665">struct</span>&nbsp;<span class="op" id="477672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="477675">handler</span>&nbsp;<span class="ident" id="477683">Handler</span><br>
<span class="lineno"></span><span class="op" id="477691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="477694">func</span>&nbsp;<span class="ident" id="477699">newHandlerTest</span><span class="op" id="477713">(</span><span class="ident" id="477714">h</span>&nbsp;<span class="ident" id="477716">Handler</span><span class="op" id="477723">)</span>&nbsp;<span class="ident" id="477725">handlerTest</span>&nbsp;<span class="op" id="477737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="477740">return</span>&nbsp;<span class="ident" id="477747">handlerTest</span><span class="op" id="477758">{</span><span class="ident" id="477759">h</span><span class="op" id="477760">}</span><br>
<span class="lineno"></span><span class="op" id="477762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="477765">func</span>&nbsp;<span class="op" id="477770">(</span><span class="ident" id="477771">ht</span>&nbsp;<span class="ident" id="477774">handlerTest</span><span class="op" id="477785">)</span>&nbsp;<span class="ident" id="477787">rawResponse</span><span class="op" id="477798">(</span><span class="ident" id="477799">req</span>&nbsp;<span class="builtintype" id="477803">string</span><span class="op" id="477809">)</span>&nbsp;<span class="builtintype" id="477811">string</span>&nbsp;<span class="op" id="477818">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="477821">reqb</span>&nbsp;<span class="op" id="477826">:=</span>&nbsp;<span class="ident" id="477829">reqBytes</span><span class="op" id="477837">(</span><span class="ident" id="477838">req</span><span class="op" id="477841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="477844">var</span>&nbsp;<span class="ident" id="477848">output</span>&nbsp;<span class="ident" id="477855">bytes</span><span class="op" id="477860">.</span><span class="ident" id="477861">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="477869">conn</span>&nbsp;<span class="op" id="477874">:=</span>&nbsp;<span class="op" id="477877">&amp;</span><span class="ident" id="477878">rwTestConn</span><span class="op" id="477888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="477892">Reader</span><span class="op" id="477898">:</span>&nbsp;<span class="ident" id="477900">bytes</span><span class="op" id="477905">.</span><span class="ident" id="477906">NewReader</span><span class="op" id="477915">(</span><span class="ident" id="477916">reqb</span><span class="op" id="477920">)</span><span class="op" id="477921">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="477925">Writer</span><span class="op" id="477931">:</span>&nbsp;<span class="op" id="477933">&amp;</span><span class="ident" id="477934">output</span><span class="op" id="477940">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="477944">closec</span><span class="op" id="477950">:</span>&nbsp;<span class="builtinfunc" id="477952">make</span><span class="op" id="477956">(</span><span class="keyword" id="477957">chan</span>&nbsp;<span class="builtintype" id="477962">bool</span><span class="op" id="477966">,</span>&nbsp;<span class="num" id="477968">1</span><span class="op" id="477969">)</span><span class="op" id="477970">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="477973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="477976">ln</span>&nbsp;<span class="op" id="477979">:=</span>&nbsp;<span class="op" id="477982">&amp;</span><span class="ident" id="477983">oneConnListener</span><span class="op" id="477998">{</span><span class="ident" id="477999">conn</span><span class="op" id="478003">:</span>&nbsp;<span class="ident" id="478005">conn</span><span class="op" id="478009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="478012">go</span>&nbsp;<span class="ident" id="478015">Serve</span><span class="op" id="478020">(</span><span class="ident" id="478021">ln</span><span class="op" id="478023">,</span>&nbsp;<span class="ident" id="478025">ht</span><span class="op" id="478027">.</span><span class="ident" id="478028">handler</span><span class="op" id="478035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="478038">&lt;-</span><span class="ident" id="478040">conn</span><span class="op" id="478044">.</span><span class="ident" id="478045">closec</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="478053">return</span>&nbsp;<span class="ident" id="478060">output</span><span class="op" id="478066">.</span><span class="ident" id="478067">String</span><span class="op" id="478073">(</span><span class="op" id="478074">)</span><br>
<span class="lineno"></span><span class="op" id="478076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="478079">func</span>&nbsp;<span class="ident" id="478084">TestConsumingBodyOnNextConn</span><span class="op" id="478111">(</span><span class="ident" id="478112">t</span>&nbsp;<span class="op" id="478114">*</span><span class="ident" id="478115">testing</span><span class="op" id="478122">.</span><span class="ident" id="478123">T</span><span class="op" id="478124">)</span>&nbsp;<span class="op" id="478126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478129">conn</span>&nbsp;<span class="op" id="478134">:=</span>&nbsp;<span class="builtinfunc" id="478137">new</span><span class="op" id="478140">(</span><span class="ident" id="478141">testConn</span><span class="op" id="478149">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="478152">for</span>&nbsp;<span class="ident" id="478156">i</span>&nbsp;<span class="op" id="478158">:=</span>&nbsp;<span class="num" id="478161">0</span><span class="op" id="478162">;</span>&nbsp;<span class="ident" id="478164">i</span>&nbsp;<span class="op" id="478166">&lt;</span>&nbsp;<span class="num" id="478168">2</span><span class="op" id="478169">;</span>&nbsp;<span class="ident" id="478171">i</span><span class="op" id="478172">++</span>&nbsp;<span class="op" id="478175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478179">conn</span><span class="op" id="478183">.</span><span class="ident" id="478184">readBuf</span><span class="op" id="478191">.</span><span class="ident" id="478192">Write</span><span class="op" id="478197">(</span><span class="op" id="478198">[</span><span class="op" id="478199">]</span><span class="builtintype" id="478200">byte</span><span class="op" id="478204">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="478209">&#34;POST&nbsp;/&nbsp;HTTP/1.1\r\n&#34;</span>&nbsp;<span class="op" id="478231">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="478237">&#34;Host:&nbsp;test\r\n&#34;</span>&nbsp;<span class="op" id="478254">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="478260">&#34;Content-Length:&nbsp;11\r\n&#34;</span>&nbsp;<span class="op" id="478285">+</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="478291">&#34;\r\n&#34;</span>&nbsp;<span class="op" id="478298">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="478304">&#34;foo=1&amp;bar=1&#34;</span><span class="op" id="478317">)</span><span class="op" id="478318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="478321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478325">reqNum</span>&nbsp;<span class="op" id="478332">:=</span>&nbsp;<span class="num" id="478335">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478338">ch</span>&nbsp;<span class="op" id="478341">:=</span>&nbsp;<span class="builtinfunc" id="478344">make</span><span class="op" id="478348">(</span><span class="keyword" id="478349">chan</span>&nbsp;<span class="op" id="478354">*</span><span class="ident" id="478355">Request</span><span class="op" id="478362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478365">servech</span>&nbsp;<span class="op" id="478373">:=</span>&nbsp;<span class="builtinfunc" id="478376">make</span><span class="op" id="478380">(</span><span class="keyword" id="478381">chan</span>&nbsp;<span class="builtintype" id="478386">error</span><span class="op" id="478391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478394">listener</span>&nbsp;<span class="op" id="478403">:=</span>&nbsp;<span class="op" id="478406">&amp;</span><span class="ident" id="478407">oneConnListener</span><span class="op" id="478422">{</span><span class="ident" id="478423">conn</span><span class="op" id="478427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478430">handler</span>&nbsp;<span class="op" id="478438">:=</span>&nbsp;<span class="keyword" id="478441">func</span><span class="op" id="478445">(</span><span class="ident" id="478446">res</span>&nbsp;<span class="ident" id="478450">ResponseWriter</span><span class="op" id="478464">,</span>&nbsp;<span class="ident" id="478466">req</span>&nbsp;<span class="op" id="478470">*</span><span class="ident" id="478471">Request</span><span class="op" id="478478">)</span>&nbsp;<span class="op" id="478480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478484">reqNum</span><span class="op" id="478490">++</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478495">ch</span>&nbsp;<span class="op" id="478498">&lt;-</span>&nbsp;<span class="ident" id="478501">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="478506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="478510">go</span>&nbsp;<span class="keyword" id="478513">func</span><span class="op" id="478517">(</span><span class="op" id="478518">)</span>&nbsp;<span class="op" id="478520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478524">servech</span>&nbsp;<span class="op" id="478532">&lt;-</span>&nbsp;<span class="ident" id="478535">Serve</span><span class="op" id="478540">(</span><span class="ident" id="478541">listener</span><span class="op" id="478549">,</span>&nbsp;<span class="ident" id="478551">HandlerFunc</span><span class="op" id="478562">(</span><span class="ident" id="478563">handler</span><span class="op" id="478570">)</span><span class="op" id="478571">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="478574">}</span><span class="op" id="478575">(</span><span class="op" id="478576">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="478580">var</span>&nbsp;<span class="ident" id="478584">req</span>&nbsp;<span class="op" id="478588">*</span><span class="ident" id="478589">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478598">req</span>&nbsp;<span class="op" id="478602">=</span>&nbsp;<span class="op" id="478604">&lt;-</span><span class="ident" id="478606">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="478610">if</span>&nbsp;<span class="ident" id="478613">req</span>&nbsp;<span class="op" id="478617">==</span>&nbsp;<span class="builtintype" id="478620">nil</span>&nbsp;<span class="op" id="478624">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478628">t</span><span class="op" id="478629">.</span><span class="ident" id="478630">Fatal</span><span class="op" id="478635">(</span><span class="string" id="478636">&#34;Got&nbsp;nil&nbsp;first&nbsp;request.&#34;</span><span class="op" id="478660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="478663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="478666">if</span>&nbsp;<span class="ident" id="478669">req</span><span class="op" id="478672">.</span><span class="ident" id="478673">Method</span>&nbsp;<span class="op" id="478680">!=</span>&nbsp;<span class="string" id="478683">&#34;POST&#34;</span>&nbsp;<span class="op" id="478690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478694">t</span><span class="op" id="478695">.</span><span class="ident" id="478696">Errorf</span><span class="op" id="478702">(</span><span class="string" id="478703">&#34;For&nbsp;request&nbsp;#1&#39;s&nbsp;method,&nbsp;got&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="478749">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478754">req</span><span class="op" id="478757">.</span><span class="ident" id="478758">Method</span><span class="op" id="478764">,</span>&nbsp;<span class="string" id="478766">&#34;POST&#34;</span><span class="op" id="478772">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="478775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478779">req</span>&nbsp;<span class="op" id="478783">=</span>&nbsp;<span class="op" id="478785">&lt;-</span><span class="ident" id="478787">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="478791">if</span>&nbsp;<span class="ident" id="478794">req</span>&nbsp;<span class="op" id="478798">==</span>&nbsp;<span class="builtintype" id="478801">nil</span>&nbsp;<span class="op" id="478805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478809">t</span><span class="op" id="478810">.</span><span class="ident" id="478811">Fatal</span><span class="op" id="478816">(</span><span class="string" id="478817">&#34;Got&nbsp;nil&nbsp;first&nbsp;request.&#34;</span><span class="op" id="478841">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="478844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="478847">if</span>&nbsp;<span class="ident" id="478850">req</span><span class="op" id="478853">.</span><span class="ident" id="478854">Method</span>&nbsp;<span class="op" id="478861">!=</span>&nbsp;<span class="string" id="478864">&#34;POST&#34;</span>&nbsp;<span class="op" id="478871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478875">t</span><span class="op" id="478876">.</span><span class="ident" id="478877">Errorf</span><span class="op" id="478883">(</span><span class="string" id="478884">&#34;For&nbsp;request&nbsp;#2&#39;s&nbsp;method,&nbsp;got&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="478930">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="478935">req</span><span class="op" id="478938">.</span><span class="ident" id="478939">Method</span><span class="op" id="478945">,</span>&nbsp;<span class="string" id="478947">&#34;POST&#34;</span><span class="op" id="478953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="478956">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="478960">if</span>&nbsp;<span class="ident" id="478963">serveerr</span>&nbsp;<span class="op" id="478972">:=</span>&nbsp;<span class="op" id="478975">&lt;-</span><span class="ident" id="478977">servech</span><span class="op" id="478984">;</span>&nbsp;<span class="ident" id="478986">serveerr</span>&nbsp;<span class="op" id="478995">!=</span>&nbsp;<span class="ident" id="478998">io</span><span class="op" id="479000">.</span><span class="ident" id="479001">EOF</span>&nbsp;<span class="op" id="479005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="479009">t</span><span class="op" id="479010">.</span><span class="ident" id="479011">Errorf</span><span class="op" id="479017">(</span><span class="string" id="479018">&#34;Serve&nbsp;returned&nbsp;%q;&nbsp;expected&nbsp;EOF&#34;</span><span class="op" id="479051">,</span>&nbsp;<span class="ident" id="479053">serveerr</span><span class="op" id="479061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="479064">}</span><br>
<span class="lineno"></span><span class="op" id="479066">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="479069">type</span>&nbsp;<span class="ident" id="479074">stringHandler</span>&nbsp;<span class="builtintype" id="479088">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="479096">func</span>&nbsp;<span class="op" id="479101">(</span><span class="ident" id="479102">s</span>&nbsp;<span class="ident" id="479104">stringHandler</span><span class="op" id="479117">)</span>&nbsp;<span class="ident" id="479119">ServeHTTP</span><span class="op" id="479128">(</span><span class="ident" id="479129">w</span>&nbsp;<span class="ident" id="479131">ResponseWriter</span><span class="op" id="479145">,</span>&nbsp;<span class="ident" id="479147">r</span>&nbsp;<span class="op" id="479149">*</span><span class="ident" id="479150">Request</span><span class="op" id="479157">)</span>&nbsp;<span class="op" id="479159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="479162">w</span><span class="op" id="479163">.</span><span class="ident" id="479164">Header</span><span class="op" id="479170">(</span><span class="op" id="479171">)</span><span class="op" id="479172">.</span><span class="ident" id="479173">Set</span><span class="op" id="479176">(</span><span class="string" id="479177">&#34;Result&#34;</span><span class="op" id="479185">,</span>&nbsp;<span class="builtintype" id="479187">string</span><span class="op" id="479193">(</span><span class="ident" id="479194">s</span><span class="op" id="479195">)</span><span class="op" id="479196">)</span><br>
<span class="lineno">200</span><span class="op" id="479198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="479201">var</span>&nbsp;<span class="ident" id="479205">handlers</span>&nbsp;<span class="op" id="479214">=</span>&nbsp;<span class="op" id="479216">[</span><span class="op" id="479217">]</span><span class="keyword" id="479218">struct</span>&nbsp;<span class="op" id="479225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="479228">pattern</span>&nbsp;<span class="builtintype" id="479236">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="479244">msg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="479252">string</span><br>
<span class="lineno">205</span><span class="op" id="479259">}</span><span class="op" id="479260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="479263">{</span><span class="string" id="479264">&#34;/&#34;</span><span class="op" id="479267">,</span>&nbsp;<span class="string" id="479269">&#34;Default&#34;</span><span class="op" id="479278">}</span><span class="op" id="479279">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="479282">{</span><span class="string" id="479283">&#34;/someDir/&#34;</span><span class="op" id="479294">,</span>&nbsp;<span class="string" id="479296">&#34;someDir&#34;</span><span class="op" id="479305">}</span><span class="op" id="479306">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="479309">{</span><span class="string" id="479310">&#34;someHost.com/someDir/&#34;</span><span class="op" id="479333">,</span>&nbsp;<span class="string" id="479335">&#34;someHost.com/someDir&#34;</span><span class="op" id="479357">}</span><span class="op" id="479358">,</span><br>
<span class="lineno"></span><span class="op" id="479360">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="keyword" id="479363">var</span>&nbsp;<span class="ident" id="479367">vtests</span>&nbsp;<span class="op" id="479374">=</span>&nbsp;<span class="op" id="479376">[</span><span class="op" id="479377">]</span><span class="keyword" id="479378">struct</span>&nbsp;<span class="op" id="479385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="479388">url</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="479397">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="479405">expected</span>&nbsp;<span class="builtintype" id="479414">string</span><br>
<span class="lineno"></span><span class="op" id="479421">}</span><span class="op" id="479422">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="479425">{</span><span class="string" id="479426">&#34;http://localhost/someDir/apage&#34;</span><span class="op" id="479458">,</span>&nbsp;<span class="string" id="479460">&#34;someDir&#34;</span><span class="op" id="479469">}</span><span class="op" id="479470">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="479473">{</span><span class="string" id="479474">&#34;http://localhost/otherDir/apage&#34;</span><span class="op" id="479507">,</span>&nbsp;<span class="string" id="479509">&#34;Default&#34;</span><span class="op" id="479518">}</span><span class="op" id="479519">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="479522">{</span><span class="string" id="479523">&#34;http://someHost.com/someDir/apage&#34;</span><span class="op" id="479558">,</span>&nbsp;<span class="string" id="479560">&#34;someHost.com/someDir&#34;</span><span class="op" id="479582">}</span><span class="op" id="479583">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="479586">{</span><span class="string" id="479587">&#34;http://otherHost.com/someDir/apage&#34;</span><span class="op" id="479623">,</span>&nbsp;<span class="string" id="479625">&#34;someDir&#34;</span><span class="op" id="479634">}</span><span class="op" id="479635">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="479638">{</span><span class="string" id="479639">&#34;http://otherHost.com/aDir/apage&#34;</span><span class="op" id="479672">,</span>&nbsp;<span class="string" id="479674">&#34;Default&#34;</span><span class="op" id="479683">}</span><span class="op" id="479684">,</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="479687">//&nbsp;redirections&nbsp;for&nbsp;trees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="479714">{</span><span class="string" id="479715">&#34;http://localhost/someDir&#34;</span><span class="op" id="479741">,</span>&nbsp;<span class="string" id="479743">&#34;/someDir/&#34;</span><span class="op" id="479754">}</span><span class="op" id="479755">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="479758">{</span><span class="string" id="479759">&#34;http://someHost.com/someDir&#34;</span><span class="op" id="479788">,</span>&nbsp;<span class="string" id="479790">&#34;/someDir/&#34;</span><span class="op" id="479801">}</span><span class="op" id="479802">,</span><br>
<span class="lineno"></span><span class="op" id="479804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="479807">func</span>&nbsp;<span class="ident" id="479812">TestHostHandlers</span><span class="op" id="479828">(</span><span class="ident" id="479829">t</span>&nbsp;<span class="op" id="479831">*</span><span class="ident" id="479832">testing</span><span class="op" id="479839">.</span><span class="ident" id="479840">T</span><span class="op" id="479841">)</span>&nbsp;<span class="op" id="479843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="479846">defer</span>&nbsp;<span class="ident" id="479852">afterTest</span><span class="op" id="479861">(</span><span class="ident" id="479862">t</span><span class="op" id="479863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="479866">mux</span>&nbsp;<span class="op" id="479870">:=</span>&nbsp;<span class="ident" id="479873">NewServeMux</span><span class="op" id="479884">(</span><span class="op" id="479885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="479888">for</span>&nbsp;<span class="ident" id="479892">_</span><span class="op" id="479893">,</span>&nbsp;<span class="ident" id="479895">h</span>&nbsp;<span class="op" id="479897">:=</span>&nbsp;<span class="keyword" id="479900">range</span>&nbsp;<span class="ident" id="479906">handlers</span>&nbsp;<span class="op" id="479915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="479919">mux</span><span class="op" id="479922">.</span><span class="ident" id="479923">Handle</span><span class="op" id="479929">(</span><span class="ident" id="479930">h</span><span class="op" id="479931">.</span><span class="ident" id="479932">pattern</span><span class="op" id="479939">,</span>&nbsp;<span class="ident" id="479941">stringHandler</span><span class="op" id="479954">(</span><span class="ident" id="479955">h</span><span class="op" id="479956">.</span><span class="ident" id="479957">msg</span><span class="op" id="479960">)</span><span class="op" id="479961">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="479964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="479967">ts</span>&nbsp;<span class="op" id="479970">:=</span>&nbsp;<span class="ident" id="479973">httptest</span><span class="op" id="479981">.</span><span class="ident" id="479982">NewServer</span><span class="op" id="479991">(</span><span class="ident" id="479992">mux</span><span class="op" id="479995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="479998">defer</span>&nbsp;<span class="ident" id="480004">ts</span><span class="op" id="480006">.</span><span class="ident" id="480007">Close</span><span class="op" id="480012">(</span><span class="op" id="480013">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="480017">conn</span><span class="op" id="480021">,</span>&nbsp;<span class="ident" id="480023">err</span>&nbsp;<span class="op" id="480027">:=</span>&nbsp;<span class="ident" id="480030">net</span><span class="op" id="480033">.</span><span class="ident" id="480034">Dial</span><span class="op" id="480038">(</span><span class="string" id="480039">&#34;tcp&#34;</span><span class="op" id="480044">,</span>&nbsp;<span class="ident" id="480046">ts</span><span class="op" id="480048">.</span><span class="ident" id="480049">Listener</span><span class="op" id="480057">.</span><span class="ident" id="480058">Addr</span><span class="op" id="480062">(</span><span class="op" id="480063">)</span><span class="op" id="480064">.</span><span class="ident" id="480065">String</span><span class="op" id="480071">(</span><span class="op" id="480072">)</span><span class="op" id="480073">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480076">if</span>&nbsp;<span class="ident" id="480079">err</span>&nbsp;<span class="op" id="480083">!=</span>&nbsp;<span class="builtintype" id="480086">nil</span>&nbsp;<span class="op" id="480090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="480094">t</span><span class="op" id="480095">.</span><span class="ident" id="480096">Fatal</span><span class="op" id="480101">(</span><span class="ident" id="480102">err</span><span class="op" id="480105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="480108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480111">defer</span>&nbsp;<span class="ident" id="480117">conn</span><span class="op" id="480121">.</span><span class="ident" id="480122">Close</span><span class="op" id="480127">(</span><span class="op" id="480128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="480131">cc</span>&nbsp;<span class="op" id="480134">:=</span>&nbsp;<span class="ident" id="480137">httputil</span><span class="op" id="480145">.</span><span class="ident" id="480146">NewClientConn</span><span class="op" id="480159">(</span><span class="ident" id="480160">conn</span><span class="op" id="480164">,</span>&nbsp;<span class="builtintype" id="480166">nil</span><span class="op" id="480169">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480172">for</span>&nbsp;<span class="ident" id="480176">_</span><span class="op" id="480177">,</span>&nbsp;<span class="ident" id="480179">vt</span>&nbsp;<span class="op" id="480182">:=</span>&nbsp;<span class="keyword" id="480185">range</span>&nbsp;<span class="ident" id="480191">vtests</span>&nbsp;<span class="op" id="480198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480202">var</span>&nbsp;<span class="ident" id="480206">r</span>&nbsp;<span class="op" id="480208">*</span><span class="ident" id="480209">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480220">var</span>&nbsp;<span class="ident" id="480224">req</span>&nbsp;<span class="ident" id="480228">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480238">if</span>&nbsp;<span class="ident" id="480241">req</span><span class="op" id="480244">.</span><span class="ident" id="480245">URL</span><span class="op" id="480248">,</span>&nbsp;<span class="ident" id="480250">err</span>&nbsp;<span class="op" id="480254">=</span>&nbsp;<span class="ident" id="480256">url</span><span class="op" id="480259">.</span><span class="ident" id="480260">Parse</span><span class="op" id="480265">(</span><span class="ident" id="480266">vt</span><span class="op" id="480268">.</span><span class="ident" id="480269">url</span><span class="op" id="480272">)</span><span class="op" id="480273">;</span>&nbsp;<span class="ident" id="480275">err</span>&nbsp;<span class="op" id="480279">!=</span>&nbsp;<span class="builtintype" id="480282">nil</span>&nbsp;<span class="op" id="480286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="480291">t</span><span class="op" id="480292">.</span><span class="ident" id="480293">Errorf</span><span class="op" id="480299">(</span><span class="string" id="480300">&#34;cannot&nbsp;parse&nbsp;url:&nbsp;%v&#34;</span><span class="op" id="480322">,</span>&nbsp;<span class="ident" id="480324">err</span><span class="op" id="480327">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480332">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="480343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480347">if</span>&nbsp;<span class="ident" id="480350">err</span>&nbsp;<span class="op" id="480354">:=</span>&nbsp;<span class="ident" id="480357">cc</span><span class="op" id="480359">.</span><span class="ident" id="480360">Write</span><span class="op" id="480365">(</span><span class="op" id="480366">&amp;</span><span class="ident" id="480367">req</span><span class="op" id="480370">)</span><span class="op" id="480371">;</span>&nbsp;<span class="ident" id="480373">err</span>&nbsp;<span class="op" id="480377">!=</span>&nbsp;<span class="builtintype" id="480380">nil</span>&nbsp;<span class="op" id="480384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="480389">t</span><span class="op" id="480390">.</span><span class="ident" id="480391">Errorf</span><span class="op" id="480397">(</span><span class="string" id="480398">&#34;writing&nbsp;request:&nbsp;%v&#34;</span><span class="op" id="480419">,</span>&nbsp;<span class="ident" id="480421">err</span><span class="op" id="480424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480429">continue</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="480440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="480444">r</span><span class="op" id="480445">,</span>&nbsp;<span class="ident" id="480447">err</span>&nbsp;<span class="op" id="480451">:=</span>&nbsp;<span class="ident" id="480454">cc</span><span class="op" id="480456">.</span><span class="ident" id="480457">Read</span><span class="op" id="480461">(</span><span class="op" id="480462">&amp;</span><span class="ident" id="480463">req</span><span class="op" id="480466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480470">if</span>&nbsp;<span class="ident" id="480473">err</span>&nbsp;<span class="op" id="480477">!=</span>&nbsp;<span class="builtintype" id="480480">nil</span>&nbsp;<span class="op" id="480484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="480489">t</span><span class="op" id="480490">.</span><span class="ident" id="480491">Errorf</span><span class="op" id="480497">(</span><span class="string" id="480498">&#34;reading&nbsp;response:&nbsp;%v&#34;</span><span class="op" id="480520">,</span>&nbsp;<span class="ident" id="480522">err</span><span class="op" id="480525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480530">continue</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="480541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480545">switch</span>&nbsp;<span class="ident" id="480552">r</span><span class="op" id="480553">.</span><span class="ident" id="480554">StatusCode</span>&nbsp;<span class="op" id="480565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480569">case</span>&nbsp;<span class="ident" id="480574">StatusOK</span><span class="op" id="480582">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="480587">s</span>&nbsp;<span class="op" id="480589">:=</span>&nbsp;<span class="ident" id="480592">r</span><span class="op" id="480593">.</span><span class="ident" id="480594">Header</span><span class="op" id="480600">.</span><span class="ident" id="480601">Get</span><span class="op" id="480604">(</span><span class="string" id="480605">&#34;Result&#34;</span><span class="op" id="480613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480618">if</span>&nbsp;<span class="ident" id="480621">s</span>&nbsp;<span class="op" id="480623">!=</span>&nbsp;<span class="ident" id="480626">vt</span><span class="op" id="480628">.</span><span class="ident" id="480629">expected</span>&nbsp;<span class="op" id="480638">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="480644">t</span><span class="op" id="480645">.</span><span class="ident" id="480646">Errorf</span><span class="op" id="480652">(</span><span class="string" id="480653">&#34;Get(%q)&nbsp;=&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="480676">,</span>&nbsp;<span class="ident" id="480678">vt</span><span class="op" id="480680">.</span><span class="ident" id="480681">url</span><span class="op" id="480684">,</span>&nbsp;<span class="ident" id="480686">s</span><span class="op" id="480687">,</span>&nbsp;<span class="ident" id="480689">vt</span><span class="op" id="480691">.</span><span class="ident" id="480692">expected</span><span class="op" id="480700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="480705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480709">case</span>&nbsp;<span class="ident" id="480714">StatusMovedPermanently</span><span class="op" id="480736">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="480741">s</span>&nbsp;<span class="op" id="480743">:=</span>&nbsp;<span class="ident" id="480746">r</span><span class="op" id="480747">.</span><span class="ident" id="480748">Header</span><span class="op" id="480754">.</span><span class="ident" id="480755">Get</span><span class="op" id="480758">(</span><span class="string" id="480759">&#34;Location&#34;</span><span class="op" id="480769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480774">if</span>&nbsp;<span class="ident" id="480777">s</span>&nbsp;<span class="op" id="480779">!=</span>&nbsp;<span class="ident" id="480782">vt</span><span class="op" id="480784">.</span><span class="ident" id="480785">expected</span>&nbsp;<span class="op" id="480794">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="480800">t</span><span class="op" id="480801">.</span><span class="ident" id="480802">Errorf</span><span class="op" id="480808">(</span><span class="string" id="480809">&#34;Get(%q)&nbsp;=&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="480832">,</span>&nbsp;<span class="ident" id="480834">vt</span><span class="op" id="480836">.</span><span class="ident" id="480837">url</span><span class="op" id="480840">,</span>&nbsp;<span class="ident" id="480842">s</span><span class="op" id="480843">,</span>&nbsp;<span class="ident" id="480845">vt</span><span class="op" id="480847">.</span><span class="ident" id="480848">expected</span><span class="op" id="480856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="480861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="480865">default</span><span class="op" id="480872">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="480877">t</span><span class="op" id="480878">.</span><span class="ident" id="480879">Errorf</span><span class="op" id="480885">(</span><span class="string" id="480886">&#34;Get(%q)&nbsp;unhandled&nbsp;status&nbsp;code&nbsp;%d&#34;</span><span class="op" id="480920">,</span>&nbsp;<span class="ident" id="480922">vt</span><span class="op" id="480924">.</span><span class="ident" id="480925">url</span><span class="op" id="480928">,</span>&nbsp;<span class="ident" id="480930">r</span><span class="op" id="480931">.</span><span class="ident" id="480932">StatusCode</span><span class="op" id="480942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="480946">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="480949">}</span><br>
<span class="lineno"></span><span class="op" id="480951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="480954">var</span>&nbsp;<span class="ident" id="480958">serveMuxRegister</span>&nbsp;<span class="op" id="480975">=</span>&nbsp;<span class="op" id="480977">[</span><span class="op" id="480978">]</span><span class="keyword" id="480979">struct</span>&nbsp;<span class="op" id="480986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="480989">pattern</span>&nbsp;<span class="builtintype" id="480997">string</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="481005">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="481013">Handler</span><br>
<span class="lineno"></span><span class="op" id="481021">}</span><span class="op" id="481022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="481025">{</span><span class="string" id="481026">&#34;/dir/&#34;</span><span class="op" id="481033">,</span>&nbsp;<span class="ident" id="481035">serve</span><span class="op" id="481040">(</span><span class="num" id="481041">200</span><span class="op" id="481044">)</span><span class="op" id="481045">}</span><span class="op" id="481046">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="481049">{</span><span class="string" id="481050">&#34;/search&#34;</span><span class="op" id="481059">,</span>&nbsp;<span class="ident" id="481061">serve</span><span class="op" id="481066">(</span><span class="num" id="481067">201</span><span class="op" id="481070">)</span><span class="op" id="481071">}</span><span class="op" id="481072">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="481075">{</span><span class="string" id="481076">&#34;codesearch.google.com/search&#34;</span><span class="op" id="481106">,</span>&nbsp;<span class="ident" id="481108">serve</span><span class="op" id="481113">(</span><span class="num" id="481114">202</span><span class="op" id="481117">)</span><span class="op" id="481118">}</span><span class="op" id="481119">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="481122">{</span><span class="string" id="481123">&#34;codesearch.google.com/&#34;</span><span class="op" id="481147">,</span>&nbsp;<span class="ident" id="481149">serve</span><span class="op" id="481154">(</span><span class="num" id="481155">203</span><span class="op" id="481158">)</span><span class="op" id="481159">}</span><span class="op" id="481160">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="481163">{</span><span class="string" id="481164">&#34;example.com/&#34;</span><span class="op" id="481178">,</span>&nbsp;<span class="ident" id="481180">HandlerFunc</span><span class="op" id="481191">(</span><span class="ident" id="481192">checkQueryStringHandler</span><span class="op" id="481215">)</span><span class="op" id="481216">}</span><span class="op" id="481217">,</span><br>
<span class="lineno"></span><span class="op" id="481219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="481222">//&nbsp;serve&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;sends&nbsp;a&nbsp;response&nbsp;with&nbsp;the&nbsp;given&nbsp;code.</span><br>
<span class="lineno">285</span><span class="keyword" id="481292">func</span>&nbsp;<span class="ident" id="481297">serve</span><span class="op" id="481302">(</span><span class="ident" id="481303">code</span>&nbsp;<span class="builtintype" id="481308">int</span><span class="op" id="481311">)</span>&nbsp;<span class="ident" id="481313">HandlerFunc</span>&nbsp;<span class="op" id="481325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="481328">return</span>&nbsp;<span class="keyword" id="481335">func</span><span class="op" id="481339">(</span><span class="ident" id="481340">w</span>&nbsp;<span class="ident" id="481342">ResponseWriter</span><span class="op" id="481356">,</span>&nbsp;<span class="ident" id="481358">r</span>&nbsp;<span class="op" id="481360">*</span><span class="ident" id="481361">Request</span><span class="op" id="481368">)</span>&nbsp;<span class="op" id="481370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="481374">w</span><span class="op" id="481375">.</span><span class="ident" id="481376">WriteHeader</span><span class="op" id="481387">(</span><span class="ident" id="481388">code</span><span class="op" id="481392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="481395">}</span><br>
<span class="lineno"></span><span class="op" id="481397">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span><span class="comment" id="481400">//&nbsp;checkQueryStringHandler&nbsp;checks&nbsp;if&nbsp;r.URL.RawQuery&nbsp;has&nbsp;the&nbsp;same&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="481471">//&nbsp;as&nbsp;the&nbsp;URL&nbsp;excluding&nbsp;the&nbsp;scheme&nbsp;and&nbsp;the&nbsp;query&nbsp;string&nbsp;and&nbsp;sends&nbsp;200</span><br>
<span class="lineno"></span><span class="comment" id="481541">//&nbsp;response&nbsp;code&nbsp;if&nbsp;it&nbsp;is,&nbsp;500&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword" id="481583">func</span>&nbsp;<span class="ident" id="481588">checkQueryStringHandler</span><span class="op" id="481611">(</span><span class="ident" id="481612">w</span>&nbsp;<span class="ident" id="481614">ResponseWriter</span><span class="op" id="481628">,</span>&nbsp;<span class="ident" id="481630">r</span>&nbsp;<span class="op" id="481632">*</span><span class="ident" id="481633">Request</span><span class="op" id="481640">)</span>&nbsp;<span class="op" id="481642">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="481645">u</span>&nbsp;<span class="op" id="481647">:=</span>&nbsp;<span class="op" id="481650">*</span><span class="ident" id="481651">r</span><span class="op" id="481652">.</span><span class="ident" id="481653">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="481658">u</span><span class="op" id="481659">.</span><span class="ident" id="481660">Scheme</span>&nbsp;<span class="op" id="481667">=</span>&nbsp;<span class="string" id="481669">&#34;http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="481677">u</span><span class="op" id="481678">.</span><span class="ident" id="481679">Host</span>&nbsp;<span class="op" id="481684">=</span>&nbsp;<span class="ident" id="481686">r</span><span class="op" id="481687">.</span><span class="ident" id="481688">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="481694">u</span><span class="op" id="481695">.</span><span class="ident" id="481696">RawQuery</span>&nbsp;<span class="op" id="481705">=</span>&nbsp;<span class="string" id="481707">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="481711">if</span>&nbsp;<span class="string" id="481714">&#34;http://&#34;</span><span class="op" id="481723">+</span><span class="ident" id="481724">r</span><span class="op" id="481725">.</span><span class="ident" id="481726">URL</span><span class="op" id="481729">.</span><span class="ident" id="481730">RawQuery</span>&nbsp;<span class="op" id="481739">==</span>&nbsp;<span class="ident" id="481742">u</span><span class="op" id="481743">.</span><span class="ident" id="481744">String</span><span class="op" id="481750">(</span><span class="op" id="481751">)</span>&nbsp;<span class="op" id="481753">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="481757">w</span><span class="op" id="481758">.</span><span class="ident" id="481759">WriteHeader</span><span class="op" id="481770">(</span><span class="num" id="481771">200</span><span class="op" id="481774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="481777">}</span>&nbsp;<span class="keyword" id="481779">else</span>&nbsp;<span class="op" id="481784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="481788">w</span><span class="op" id="481789">.</span><span class="ident" id="481790">WriteHeader</span><span class="op" id="481801">(</span><span class="num" id="481802">500</span><span class="op" id="481805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="481808">}</span><br>
<span class="lineno"></span><span class="op" id="481810">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="481813">var</span>&nbsp;<span class="ident" id="481817">serveMuxTests</span>&nbsp;<span class="op" id="481831">=</span>&nbsp;<span class="op" id="481833">[</span><span class="op" id="481834">]</span><span class="keyword" id="481835">struct</span>&nbsp;<span class="op" id="481842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="481845">method</span>&nbsp;&nbsp;<span class="builtintype" id="481853">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="481861">host</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="481869">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="481877">path</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="481885">string</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="481893">code</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="481901">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="481906">pattern</span>&nbsp;<span class="builtintype" id="481914">string</span><br>
<span class="lineno"></span><span class="op" id="481921">}</span><span class="op" id="481922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="481925">{</span><span class="string" id="481926">&#34;GET&#34;</span><span class="op" id="481931">,</span>&nbsp;<span class="string" id="481933">&#34;google.com&#34;</span><span class="op" id="481945">,</span>&nbsp;<span class="string" id="481947">&#34;/&#34;</span><span class="op" id="481950">,</span>&nbsp;<span class="num" id="481952">404</span><span class="op" id="481955">,</span>&nbsp;<span class="string" id="481957">&#34;&#34;</span><span class="op" id="481959">}</span><span class="op" id="481960">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="481963">{</span><span class="string" id="481964">&#34;GET&#34;</span><span class="op" id="481969">,</span>&nbsp;<span class="string" id="481971">&#34;google.com&#34;</span><span class="op" id="481983">,</span>&nbsp;<span class="string" id="481985">&#34;/dir&#34;</span><span class="op" id="481991">,</span>&nbsp;<span class="num" id="481993">301</span><span class="op" id="481996">,</span>&nbsp;<span class="string" id="481998">&#34;/dir/&#34;</span><span class="op" id="482005">}</span><span class="op" id="482006">,</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="482009">{</span><span class="string" id="482010">&#34;GET&#34;</span><span class="op" id="482015">,</span>&nbsp;<span class="string" id="482017">&#34;google.com&#34;</span><span class="op" id="482029">,</span>&nbsp;<span class="string" id="482031">&#34;/dir/&#34;</span><span class="op" id="482038">,</span>&nbsp;<span class="num" id="482040">200</span><span class="op" id="482043">,</span>&nbsp;<span class="string" id="482045">&#34;/dir/&#34;</span><span class="op" id="482052">}</span><span class="op" id="482053">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="482056">{</span><span class="string" id="482057">&#34;GET&#34;</span><span class="op" id="482062">,</span>&nbsp;<span class="string" id="482064">&#34;google.com&#34;</span><span class="op" id="482076">,</span>&nbsp;<span class="string" id="482078">&#34;/dir/file&#34;</span><span class="op" id="482089">,</span>&nbsp;<span class="num" id="482091">200</span><span class="op" id="482094">,</span>&nbsp;<span class="string" id="482096">&#34;/dir/&#34;</span><span class="op" id="482103">}</span><span class="op" id="482104">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="482107">{</span><span class="string" id="482108">&#34;GET&#34;</span><span class="op" id="482113">,</span>&nbsp;<span class="string" id="482115">&#34;google.com&#34;</span><span class="op" id="482127">,</span>&nbsp;<span class="string" id="482129">&#34;/search&#34;</span><span class="op" id="482138">,</span>&nbsp;<span class="num" id="482140">201</span><span class="op" id="482143">,</span>&nbsp;<span class="string" id="482145">&#34;/search&#34;</span><span class="op" id="482154">}</span><span class="op" id="482155">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="482158">{</span><span class="string" id="482159">&#34;GET&#34;</span><span class="op" id="482164">,</span>&nbsp;<span class="string" id="482166">&#34;google.com&#34;</span><span class="op" id="482178">,</span>&nbsp;<span class="string" id="482180">&#34;/search/&#34;</span><span class="op" id="482190">,</span>&nbsp;<span class="num" id="482192">404</span><span class="op" id="482195">,</span>&nbsp;<span class="string" id="482197">&#34;&#34;</span><span class="op" id="482199">}</span><span class="op" id="482200">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="482203">{</span><span class="string" id="482204">&#34;GET&#34;</span><span class="op" id="482209">,</span>&nbsp;<span class="string" id="482211">&#34;google.com&#34;</span><span class="op" id="482223">,</span>&nbsp;<span class="string" id="482225">&#34;/search/foo&#34;</span><span class="op" id="482238">,</span>&nbsp;<span class="num" id="482240">404</span><span class="op" id="482243">,</span>&nbsp;<span class="string" id="482245">&#34;&#34;</span><span class="op" id="482247">}</span><span class="op" id="482248">,</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="482251">{</span><span class="string" id="482252">&#34;GET&#34;</span><span class="op" id="482257">,</span>&nbsp;<span class="string" id="482259">&#34;codesearch.google.com&#34;</span><span class="op" id="482282">,</span>&nbsp;<span class="string" id="482284">&#34;/search&#34;</span><span class="op" id="482293">,</span>&nbsp;<span class="num" id="482295">202</span><span class="op" id="482298">,</span>&nbsp;<span class="string" id="482300">&#34;codesearch.google.com/search&#34;</span><span class="op" id="482330">}</span><span class="op" id="482331">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="482334">{</span><span class="string" id="482335">&#34;GET&#34;</span><span class="op" id="482340">,</span>&nbsp;<span class="string" id="482342">&#34;codesearch.google.com&#34;</span><span class="op" id="482365">,</span>&nbsp;<span class="string" id="482367">&#34;/search/&#34;</span><span class="op" id="482377">,</span>&nbsp;<span class="num" id="482379">203</span><span class="op" id="482382">,</span>&nbsp;<span class="string" id="482384">&#34;codesearch.google.com/&#34;</span><span class="op" id="482408">}</span><span class="op" id="482409">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="482412">{</span><span class="string" id="482413">&#34;GET&#34;</span><span class="op" id="482418">,</span>&nbsp;<span class="string" id="482420">&#34;codesearch.google.com&#34;</span><span class="op" id="482443">,</span>&nbsp;<span class="string" id="482445">&#34;/search/foo&#34;</span><span class="op" id="482458">,</span>&nbsp;<span class="num" id="482460">203</span><span class="op" id="482463">,</span>&nbsp;<span class="string" id="482465">&#34;codesearch.google.com/&#34;</span><span class="op" id="482489">}</span><span class="op" id="482490">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="482493">{</span><span class="string" id="482494">&#34;GET&#34;</span><span class="op" id="482499">,</span>&nbsp;<span class="string" id="482501">&#34;codesearch.google.com&#34;</span><span class="op" id="482524">,</span>&nbsp;<span class="string" id="482526">&#34;/&#34;</span><span class="op" id="482529">,</span>&nbsp;<span class="num" id="482531">203</span><span class="op" id="482534">,</span>&nbsp;<span class="string" id="482536">&#34;codesearch.google.com/&#34;</span><span class="op" id="482560">}</span><span class="op" id="482561">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="482564">{</span><span class="string" id="482565">&#34;GET&#34;</span><span class="op" id="482570">,</span>&nbsp;<span class="string" id="482572">&#34;images.google.com&#34;</span><span class="op" id="482591">,</span>&nbsp;<span class="string" id="482593">&#34;/search&#34;</span><span class="op" id="482602">,</span>&nbsp;<span class="num" id="482604">201</span><span class="op" id="482607">,</span>&nbsp;<span class="string" id="482609">&#34;/search&#34;</span><span class="op" id="482618">}</span><span class="op" id="482619">,</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="482622">{</span><span class="string" id="482623">&#34;GET&#34;</span><span class="op" id="482628">,</span>&nbsp;<span class="string" id="482630">&#34;images.google.com&#34;</span><span class="op" id="482649">,</span>&nbsp;<span class="string" id="482651">&#34;/search/&#34;</span><span class="op" id="482661">,</span>&nbsp;<span class="num" id="482663">404</span><span class="op" id="482666">,</span>&nbsp;<span class="string" id="482668">&#34;&#34;</span><span class="op" id="482670">}</span><span class="op" id="482671">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="482674">{</span><span class="string" id="482675">&#34;GET&#34;</span><span class="op" id="482680">,</span>&nbsp;<span class="string" id="482682">&#34;images.google.com&#34;</span><span class="op" id="482701">,</span>&nbsp;<span class="string" id="482703">&#34;/search/foo&#34;</span><span class="op" id="482716">,</span>&nbsp;<span class="num" id="482718">404</span><span class="op" id="482721">,</span>&nbsp;<span class="string" id="482723">&#34;&#34;</span><span class="op" id="482725">}</span><span class="op" id="482726">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="482729">{</span><span class="string" id="482730">&#34;GET&#34;</span><span class="op" id="482735">,</span>&nbsp;<span class="string" id="482737">&#34;google.com&#34;</span><span class="op" id="482749">,</span>&nbsp;<span class="string" id="482751">&#34;/../search&#34;</span><span class="op" id="482763">,</span>&nbsp;<span class="num" id="482765">301</span><span class="op" id="482768">,</span>&nbsp;<span class="string" id="482770">&#34;/search&#34;</span><span class="op" id="482779">}</span><span class="op" id="482780">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="482783">{</span><span class="string" id="482784">&#34;GET&#34;</span><span class="op" id="482789">,</span>&nbsp;<span class="string" id="482791">&#34;google.com&#34;</span><span class="op" id="482803">,</span>&nbsp;<span class="string" id="482805">&#34;/dir/..&#34;</span><span class="op" id="482814">,</span>&nbsp;<span class="num" id="482816">301</span><span class="op" id="482819">,</span>&nbsp;<span class="string" id="482821">&#34;&#34;</span><span class="op" id="482823">}</span><span class="op" id="482824">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="482827">{</span><span class="string" id="482828">&#34;GET&#34;</span><span class="op" id="482833">,</span>&nbsp;<span class="string" id="482835">&#34;google.com&#34;</span><span class="op" id="482847">,</span>&nbsp;<span class="string" id="482849">&#34;/dir/..&#34;</span><span class="op" id="482858">,</span>&nbsp;<span class="num" id="482860">301</span><span class="op" id="482863">,</span>&nbsp;<span class="string" id="482865">&#34;&#34;</span><span class="op" id="482867">}</span><span class="op" id="482868">,</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="482871">{</span><span class="string" id="482872">&#34;GET&#34;</span><span class="op" id="482877">,</span>&nbsp;<span class="string" id="482879">&#34;google.com&#34;</span><span class="op" id="482891">,</span>&nbsp;<span class="string" id="482893">&#34;/dir/./file&#34;</span><span class="op" id="482906">,</span>&nbsp;<span class="num" id="482908">301</span><span class="op" id="482911">,</span>&nbsp;<span class="string" id="482913">&#34;/dir/&#34;</span><span class="op" id="482920">}</span><span class="op" id="482921">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="482925">//&nbsp;The&nbsp;/foo&nbsp;-&gt;&nbsp;/foo/&nbsp;redirect&nbsp;applies&nbsp;to&nbsp;CONNECT&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="482984">//&nbsp;but&nbsp;the&nbsp;path&nbsp;canonicalization&nbsp;does&nbsp;not.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="483028">{</span><span class="string" id="483029">&#34;CONNECT&#34;</span><span class="op" id="483038">,</span>&nbsp;<span class="string" id="483040">&#34;google.com&#34;</span><span class="op" id="483052">,</span>&nbsp;<span class="string" id="483054">&#34;/dir&#34;</span><span class="op" id="483060">,</span>&nbsp;<span class="num" id="483062">301</span><span class="op" id="483065">,</span>&nbsp;<span class="string" id="483067">&#34;/dir/&#34;</span><span class="op" id="483074">}</span><span class="op" id="483075">,</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="483078">{</span><span class="string" id="483079">&#34;CONNECT&#34;</span><span class="op" id="483088">,</span>&nbsp;<span class="string" id="483090">&#34;google.com&#34;</span><span class="op" id="483102">,</span>&nbsp;<span class="string" id="483104">&#34;/../search&#34;</span><span class="op" id="483116">,</span>&nbsp;<span class="num" id="483118">404</span><span class="op" id="483121">,</span>&nbsp;<span class="string" id="483123">&#34;&#34;</span><span class="op" id="483125">}</span><span class="op" id="483126">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="483129">{</span><span class="string" id="483130">&#34;CONNECT&#34;</span><span class="op" id="483139">,</span>&nbsp;<span class="string" id="483141">&#34;google.com&#34;</span><span class="op" id="483153">,</span>&nbsp;<span class="string" id="483155">&#34;/dir/..&#34;</span><span class="op" id="483164">,</span>&nbsp;<span class="num" id="483166">200</span><span class="op" id="483169">,</span>&nbsp;<span class="string" id="483171">&#34;/dir/&#34;</span><span class="op" id="483178">}</span><span class="op" id="483179">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="483182">{</span><span class="string" id="483183">&#34;CONNECT&#34;</span><span class="op" id="483192">,</span>&nbsp;<span class="string" id="483194">&#34;google.com&#34;</span><span class="op" id="483206">,</span>&nbsp;<span class="string" id="483208">&#34;/dir/..&#34;</span><span class="op" id="483217">,</span>&nbsp;<span class="num" id="483219">200</span><span class="op" id="483222">,</span>&nbsp;<span class="string" id="483224">&#34;/dir/&#34;</span><span class="op" id="483231">}</span><span class="op" id="483232">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="483235">{</span><span class="string" id="483236">&#34;CONNECT&#34;</span><span class="op" id="483245">,</span>&nbsp;<span class="string" id="483247">&#34;google.com&#34;</span><span class="op" id="483259">,</span>&nbsp;<span class="string" id="483261">&#34;/dir/./file&#34;</span><span class="op" id="483274">,</span>&nbsp;<span class="num" id="483276">200</span><span class="op" id="483279">,</span>&nbsp;<span class="string" id="483281">&#34;/dir/&#34;</span><span class="op" id="483288">}</span><span class="op" id="483289">,</span><br>
<span class="lineno"></span><span class="op" id="483291">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="keyword" id="483294">func</span>&nbsp;<span class="ident" id="483299">TestServeMuxHandler</span><span class="op" id="483318">(</span><span class="ident" id="483319">t</span>&nbsp;<span class="op" id="483321">*</span><span class="ident" id="483322">testing</span><span class="op" id="483329">.</span><span class="ident" id="483330">T</span><span class="op" id="483331">)</span>&nbsp;<span class="op" id="483333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="483336">mux</span>&nbsp;<span class="op" id="483340">:=</span>&nbsp;<span class="ident" id="483343">NewServeMux</span><span class="op" id="483354">(</span><span class="op" id="483355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="483358">for</span>&nbsp;<span class="ident" id="483362">_</span><span class="op" id="483363">,</span>&nbsp;<span class="ident" id="483365">e</span>&nbsp;<span class="op" id="483367">:=</span>&nbsp;<span class="keyword" id="483370">range</span>&nbsp;<span class="ident" id="483376">serveMuxRegister</span>&nbsp;<span class="op" id="483393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="483397">mux</span><span class="op" id="483400">.</span><span class="ident" id="483401">Handle</span><span class="op" id="483407">(</span><span class="ident" id="483408">e</span><span class="op" id="483409">.</span><span class="ident" id="483410">pattern</span><span class="op" id="483417">,</span>&nbsp;<span class="ident" id="483419">e</span><span class="op" id="483420">.</span><span class="ident" id="483421">h</span><span class="op" id="483422">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="483425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="483429">for</span>&nbsp;<span class="ident" id="483433">_</span><span class="op" id="483434">,</span>&nbsp;<span class="ident" id="483436">tt</span>&nbsp;<span class="op" id="483439">:=</span>&nbsp;<span class="keyword" id="483442">range</span>&nbsp;<span class="ident" id="483448">serveMuxTests</span>&nbsp;<span class="op" id="483462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="483466">r</span>&nbsp;<span class="op" id="483468">:=</span>&nbsp;<span class="op" id="483471">&amp;</span><span class="ident" id="483472">Request</span><span class="op" id="483479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="483484">Method</span><span class="op" id="483490">:</span>&nbsp;<span class="ident" id="483492">tt</span><span class="op" id="483494">.</span><span class="ident" id="483495">method</span><span class="op" id="483501">,</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="483506">Host</span><span class="op" id="483510">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="483514">tt</span><span class="op" id="483516">.</span><span class="ident" id="483517">host</span><span class="op" id="483521">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="483526">URL</span><span class="op" id="483529">:</span>&nbsp;<span class="op" id="483531">&amp;</span><span class="ident" id="483532">url</span><span class="op" id="483535">.</span><span class="ident" id="483536">URL</span><span class="op" id="483539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="483545">Path</span><span class="op" id="483549">:</span>&nbsp;<span class="ident" id="483551">tt</span><span class="op" id="483553">.</span><span class="ident" id="483554">path</span><span class="op" id="483558">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="483563">}</span><span class="op" id="483564">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="483568">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="483572">h</span><span class="op" id="483573">,</span>&nbsp;<span class="ident" id="483575">pattern</span>&nbsp;<span class="op" id="483583">:=</span>&nbsp;<span class="ident" id="483586">mux</span><span class="op" id="483589">.</span><span class="ident" id="483590">Handler</span><span class="op" id="483597">(</span><span class="ident" id="483598">r</span><span class="op" id="483599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="483603">rr</span>&nbsp;<span class="op" id="483606">:=</span>&nbsp;<span class="ident" id="483609">httptest</span><span class="op" id="483617">.</span><span class="ident" id="483618">NewRecorder</span><span class="op" id="483629">(</span><span class="op" id="483630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="483634">h</span><span class="op" id="483635">.</span><span class="ident" id="483636">ServeHTTP</span><span class="op" id="483645">(</span><span class="ident" id="483646">rr</span><span class="op" id="483648">,</span>&nbsp;<span class="ident" id="483650">r</span><span class="op" id="483651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="483655">if</span>&nbsp;<span class="ident" id="483658">pattern</span>&nbsp;<span class="op" id="483666">!=</span>&nbsp;<span class="ident" id="483669">tt</span><span class="op" id="483671">.</span><span class="ident" id="483672">pattern</span>&nbsp;<span class="op" id="483680">||</span>&nbsp;<span class="ident" id="483683">rr</span><span class="op" id="483685">.</span><span class="ident" id="483686">Code</span>&nbsp;<span class="op" id="483691">!=</span>&nbsp;<span class="ident" id="483694">tt</span><span class="op" id="483696">.</span><span class="ident" id="483697">code</span>&nbsp;<span class="op" id="483702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="483707">t</span><span class="op" id="483708">.</span><span class="ident" id="483709">Errorf</span><span class="op" id="483715">(</span><span class="string" id="483716">&#34;%s&nbsp;%s&nbsp;%s&nbsp;=&nbsp;%d,&nbsp;%q,&nbsp;want&nbsp;%d,&nbsp;%q&#34;</span><span class="op" id="483748">,</span>&nbsp;<span class="ident" id="483750">tt</span><span class="op" id="483752">.</span><span class="ident" id="483753">method</span><span class="op" id="483759">,</span>&nbsp;<span class="ident" id="483761">tt</span><span class="op" id="483763">.</span><span class="ident" id="483764">host</span><span class="op" id="483768">,</span>&nbsp;<span class="ident" id="483770">tt</span><span class="op" id="483772">.</span><span class="ident" id="483773">path</span><span class="op" id="483777">,</span>&nbsp;<span class="ident" id="483779">rr</span><span class="op" id="483781">.</span><span class="ident" id="483782">Code</span><span class="op" id="483786">,</span>&nbsp;<span class="ident" id="483788">pattern</span><span class="op" id="483795">,</span>&nbsp;<span class="ident" id="483797">tt</span><span class="op" id="483799">.</span><span class="ident" id="483800">code</span><span class="op" id="483804">,</span>&nbsp;<span class="ident" id="483806">tt</span><span class="op" id="483808">.</span><span class="ident" id="483809">pattern</span><span class="op" id="483816">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="483820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="483823">}</span><br>
<span class="lineno"></span><span class="op" id="483825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="483828">var</span>&nbsp;<span class="ident" id="483832">serveMuxTests2</span>&nbsp;<span class="op" id="483847">=</span>&nbsp;<span class="op" id="483849">[</span><span class="op" id="483850">]</span><span class="keyword" id="483851">struct</span>&nbsp;<span class="op" id="483858">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="483861">method</span>&nbsp;&nbsp;<span class="builtintype" id="483869">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="483877">host</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="483885">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="483893">url</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="483901">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="483909">code</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="483917">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="483922">redirOk</span>&nbsp;<span class="builtintype" id="483930">bool</span><br>
<span class="lineno">370</span><span class="op" id="483935">}</span><span class="op" id="483936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="483939">{</span><span class="string" id="483940">&#34;GET&#34;</span><span class="op" id="483945">,</span>&nbsp;<span class="string" id="483947">&#34;google.com&#34;</span><span class="op" id="483959">,</span>&nbsp;<span class="string" id="483961">&#34;/&#34;</span><span class="op" id="483964">,</span>&nbsp;<span class="num" id="483966">404</span><span class="op" id="483969">,</span>&nbsp;<span class="builtintype" id="483971">false</span><span class="op" id="483976">}</span><span class="op" id="483977">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="483980">{</span><span class="string" id="483981">&#34;GET&#34;</span><span class="op" id="483986">,</span>&nbsp;<span class="string" id="483988">&#34;example.com&#34;</span><span class="op" id="484001">,</span>&nbsp;<span class="string" id="484003">&#34;/test/?example.com/test/&#34;</span><span class="op" id="484029">,</span>&nbsp;<span class="num" id="484031">200</span><span class="op" id="484034">,</span>&nbsp;<span class="builtintype" id="484036">false</span><span class="op" id="484041">}</span><span class="op" id="484042">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="484045">{</span><span class="string" id="484046">&#34;GET&#34;</span><span class="op" id="484051">,</span>&nbsp;<span class="string" id="484053">&#34;example.com&#34;</span><span class="op" id="484066">,</span>&nbsp;<span class="string" id="484068">&#34;test/?example.com/test/&#34;</span><span class="op" id="484093">,</span>&nbsp;<span class="num" id="484095">200</span><span class="op" id="484098">,</span>&nbsp;<span class="builtintype" id="484100">true</span><span class="op" id="484104">}</span><span class="op" id="484105">,</span><br>
<span class="lineno"></span><span class="op" id="484107">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="comment" id="484110">//&nbsp;TestServeMuxHandlerRedirects&nbsp;tests&nbsp;that&nbsp;automatic&nbsp;redirects&nbsp;generated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="484186">//&nbsp;mux.Handler()&nbsp;shouldn&#39;t&nbsp;clear&nbsp;the&nbsp;request&#39;s&nbsp;query&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="484247">func</span>&nbsp;<span class="ident" id="484252">TestServeMuxHandlerRedirects</span><span class="op" id="484280">(</span><span class="ident" id="484281">t</span>&nbsp;<span class="op" id="484283">*</span><span class="ident" id="484284">testing</span><span class="op" id="484291">.</span><span class="ident" id="484292">T</span><span class="op" id="484293">)</span>&nbsp;<span class="op" id="484295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484298">mux</span>&nbsp;<span class="op" id="484302">:=</span>&nbsp;<span class="ident" id="484305">NewServeMux</span><span class="op" id="484316">(</span><span class="op" id="484317">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="484320">for</span>&nbsp;<span class="ident" id="484324">_</span><span class="op" id="484325">,</span>&nbsp;<span class="ident" id="484327">e</span>&nbsp;<span class="op" id="484329">:=</span>&nbsp;<span class="keyword" id="484332">range</span>&nbsp;<span class="ident" id="484338">serveMuxRegister</span>&nbsp;<span class="op" id="484355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484359">mux</span><span class="op" id="484362">.</span><span class="ident" id="484363">Handle</span><span class="op" id="484369">(</span><span class="ident" id="484370">e</span><span class="op" id="484371">.</span><span class="ident" id="484372">pattern</span><span class="op" id="484379">,</span>&nbsp;<span class="ident" id="484381">e</span><span class="op" id="484382">.</span><span class="ident" id="484383">h</span><span class="op" id="484384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="484387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="484391">for</span>&nbsp;<span class="ident" id="484395">_</span><span class="op" id="484396">,</span>&nbsp;<span class="ident" id="484398">tt</span>&nbsp;<span class="op" id="484401">:=</span>&nbsp;<span class="keyword" id="484404">range</span>&nbsp;<span class="ident" id="484410">serveMuxTests2</span>&nbsp;<span class="op" id="484425">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484429">tries</span>&nbsp;<span class="op" id="484435">:=</span>&nbsp;<span class="num" id="484438">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484442">turl</span>&nbsp;<span class="op" id="484447">:=</span>&nbsp;<span class="ident" id="484450">tt</span><span class="op" id="484452">.</span><span class="ident" id="484453">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="484459">for</span>&nbsp;<span class="ident" id="484463">tries</span>&nbsp;<span class="op" id="484469">&gt;</span>&nbsp;<span class="num" id="484471">0</span>&nbsp;<span class="op" id="484473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484478">u</span><span class="op" id="484479">,</span>&nbsp;<span class="ident" id="484481">e</span>&nbsp;<span class="op" id="484483">:=</span>&nbsp;<span class="ident" id="484486">url</span><span class="op" id="484489">.</span><span class="ident" id="484490">Parse</span><span class="op" id="484495">(</span><span class="ident" id="484496">turl</span><span class="op" id="484500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="484505">if</span>&nbsp;<span class="ident" id="484508">e</span>&nbsp;<span class="op" id="484510">!=</span>&nbsp;<span class="builtintype" id="484513">nil</span>&nbsp;<span class="op" id="484517">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484523">t</span><span class="op" id="484524">.</span><span class="ident" id="484525">Fatal</span><span class="op" id="484530">(</span><span class="ident" id="484531">e</span><span class="op" id="484532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="484537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484542">r</span>&nbsp;<span class="op" id="484544">:=</span>&nbsp;<span class="op" id="484547">&amp;</span><span class="ident" id="484548">Request</span><span class="op" id="484555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484561">Method</span><span class="op" id="484567">:</span>&nbsp;<span class="ident" id="484569">tt</span><span class="op" id="484571">.</span><span class="ident" id="484572">method</span><span class="op" id="484578">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484584">Host</span><span class="op" id="484588">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="484592">tt</span><span class="op" id="484594">.</span><span class="ident" id="484595">host</span><span class="op" id="484599">,</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484605">URL</span><span class="op" id="484608">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484613">u</span><span class="op" id="484614">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="484619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484624">h</span><span class="op" id="484625">,</span>&nbsp;<span class="ident" id="484627">_</span>&nbsp;<span class="op" id="484629">:=</span>&nbsp;<span class="ident" id="484632">mux</span><span class="op" id="484635">.</span><span class="ident" id="484636">Handler</span><span class="op" id="484643">(</span><span class="ident" id="484644">r</span><span class="op" id="484645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484650">rr</span>&nbsp;<span class="op" id="484653">:=</span>&nbsp;<span class="ident" id="484656">httptest</span><span class="op" id="484664">.</span><span class="ident" id="484665">NewRecorder</span><span class="op" id="484676">(</span><span class="op" id="484677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484682">h</span><span class="op" id="484683">.</span><span class="ident" id="484684">ServeHTTP</span><span class="op" id="484693">(</span><span class="ident" id="484694">rr</span><span class="op" id="484696">,</span>&nbsp;<span class="ident" id="484698">r</span><span class="op" id="484699">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="484704">if</span>&nbsp;<span class="ident" id="484707">rr</span><span class="op" id="484709">.</span><span class="ident" id="484710">Code</span>&nbsp;<span class="op" id="484715">!=</span>&nbsp;<span class="num" id="484718">301</span>&nbsp;<span class="op" id="484722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="484728">if</span>&nbsp;<span class="ident" id="484731">rr</span><span class="op" id="484733">.</span><span class="ident" id="484734">Code</span>&nbsp;<span class="op" id="484739">!=</span>&nbsp;<span class="ident" id="484742">tt</span><span class="op" id="484744">.</span><span class="ident" id="484745">code</span>&nbsp;<span class="op" id="484750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484757">t</span><span class="op" id="484758">.</span><span class="ident" id="484759">Errorf</span><span class="op" id="484765">(</span><span class="string" id="484766">&#34;%s&nbsp;%s&nbsp;%s&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="484790">,</span>&nbsp;<span class="ident" id="484792">tt</span><span class="op" id="484794">.</span><span class="ident" id="484795">method</span><span class="op" id="484801">,</span>&nbsp;<span class="ident" id="484803">tt</span><span class="op" id="484805">.</span><span class="ident" id="484806">host</span><span class="op" id="484810">,</span>&nbsp;<span class="ident" id="484812">tt</span><span class="op" id="484814">.</span><span class="ident" id="484815">url</span><span class="op" id="484818">,</span>&nbsp;<span class="ident" id="484820">rr</span><span class="op" id="484822">.</span><span class="ident" id="484823">Code</span><span class="op" id="484827">,</span>&nbsp;<span class="ident" id="484829">tt</span><span class="op" id="484831">.</span><span class="ident" id="484832">code</span><span class="op" id="484836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="484842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="484848">break</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="484857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="484862">if</span>&nbsp;<span class="op" id="484865">!</span><span class="ident" id="484866">tt</span><span class="op" id="484868">.</span><span class="ident" id="484869">redirOk</span>&nbsp;<span class="op" id="484877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484883">t</span><span class="op" id="484884">.</span><span class="ident" id="484885">Errorf</span><span class="op" id="484891">(</span><span class="string" id="484892">&#34;%s&nbsp;%s&nbsp;%s,&nbsp;unexpected&nbsp;redirect&#34;</span><span class="op" id="484923">,</span>&nbsp;<span class="ident" id="484925">tt</span><span class="op" id="484927">.</span><span class="ident" id="484928">method</span><span class="op" id="484934">,</span>&nbsp;<span class="ident" id="484936">tt</span><span class="op" id="484938">.</span><span class="ident" id="484939">host</span><span class="op" id="484943">,</span>&nbsp;<span class="ident" id="484945">tt</span><span class="op" id="484947">.</span><span class="ident" id="484948">url</span><span class="op" id="484951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="484957">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="484966">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="484971">turl</span>&nbsp;<span class="op" id="484976">=</span>&nbsp;<span class="ident" id="484978">rr</span><span class="op" id="484980">.</span><span class="ident" id="484981">HeaderMap</span><span class="op" id="484990">.</span><span class="ident" id="484991">Get</span><span class="op" id="484994">(</span><span class="string" id="484995">&#34;Location&#34;</span><span class="op" id="485005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="485010">tries</span><span class="op" id="485015">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="485020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="485024">if</span>&nbsp;<span class="ident" id="485027">tries</span>&nbsp;<span class="op" id="485033">&lt;</span>&nbsp;<span class="num" id="485035">0</span>&nbsp;<span class="op" id="485037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="485042">t</span><span class="op" id="485043">.</span><span class="ident" id="485044">Errorf</span><span class="op" id="485050">(</span><span class="string" id="485051">&#34;%s&nbsp;%s&nbsp;%s,&nbsp;too&nbsp;many&nbsp;redirects&#34;</span><span class="op" id="485081">,</span>&nbsp;<span class="ident" id="485083">tt</span><span class="op" id="485085">.</span><span class="ident" id="485086">method</span><span class="op" id="485092">,</span>&nbsp;<span class="ident" id="485094">tt</span><span class="op" id="485096">.</span><span class="ident" id="485097">host</span><span class="op" id="485101">,</span>&nbsp;<span class="ident" id="485103">tt</span><span class="op" id="485105">.</span><span class="ident" id="485106">url</span><span class="op" id="485109">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="485113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="485116">}</span><br>
<span class="lineno"></span><span class="op" id="485118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="485121">//&nbsp;Tests&nbsp;for&nbsp;http://code.google.com/p/go/issues/detail?id=900</span><br>
<span class="lineno">420</span><span class="keyword" id="485183">func</span>&nbsp;<span class="ident" id="485188">TestMuxRedirectLeadingSlashes</span><span class="op" id="485217">(</span><span class="ident" id="485218">t</span>&nbsp;<span class="op" id="485220">*</span><span class="ident" id="485221">testing</span><span class="op" id="485228">.</span><span class="ident" id="485229">T</span><span class="op" id="485230">)</span>&nbsp;<span class="op" id="485232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="485235">paths</span>&nbsp;<span class="op" id="485241">:=</span>&nbsp;<span class="op" id="485244">[</span><span class="op" id="485245">]</span><span class="builtintype" id="485246">string</span><span class="op" id="485252">{</span><span class="string" id="485253">&#34;//foo.txt&#34;</span><span class="op" id="485264">,</span>&nbsp;<span class="string" id="485266">&#34;///foo.txt&#34;</span><span class="op" id="485278">,</span>&nbsp;<span class="string" id="485280">&#34;/../../foo.txt&#34;</span><span class="op" id="485296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="485299">for</span>&nbsp;<span class="ident" id="485303">_</span><span class="op" id="485304">,</span>&nbsp;<span class="ident" id="485306">path</span>&nbsp;<span class="op" id="485311">:=</span>&nbsp;<span class="keyword" id="485314">range</span>&nbsp;<span class="ident" id="485320">paths</span>&nbsp;<span class="op" id="485326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="485330">req</span><span class="op" id="485333">,</span>&nbsp;<span class="ident" id="485335">err</span>&nbsp;<span class="op" id="485339">:=</span>&nbsp;<span class="ident" id="485342">ReadRequest</span><span class="op" id="485353">(</span><span class="ident" id="485354">bufio</span><span class="op" id="485359">.</span><span class="ident" id="485360">NewReader</span><span class="op" id="485369">(</span><span class="ident" id="485370">strings</span><span class="op" id="485377">.</span><span class="ident" id="485378">NewReader</span><span class="op" id="485387">(</span><span class="string" id="485388">&#34;GET&nbsp;&#34;</span>&nbsp;<span class="op" id="485395">+</span>&nbsp;<span class="ident" id="485397">path</span>&nbsp;<span class="op" id="485402">+</span>&nbsp;<span class="string" id="485404">&#34;&nbsp;HTTP/1.1\r\nHost:&nbsp;test\r\n\r\n&#34;</span><span class="op" id="485437">)</span><span class="op" id="485438">)</span><span class="op" id="485439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="485443">if</span>&nbsp;<span class="ident" id="485446">err</span>&nbsp;<span class="op" id="485450">!=</span>&nbsp;<span class="builtintype" id="485453">nil</span>&nbsp;<span class="op" id="485457">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="485462">t</span><span class="op" id="485463">.</span><span class="ident" id="485464">Errorf</span><span class="op" id="485470">(</span><span class="string" id="485471">&#34;%s&#34;</span><span class="op" id="485475">,</span>&nbsp;<span class="ident" id="485477">err</span><span class="op" id="485480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="485484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="485488">mux</span>&nbsp;<span class="op" id="485492">:=</span>&nbsp;<span class="ident" id="485495">NewServeMux</span><span class="op" id="485506">(</span><span class="op" id="485507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="485511">resp</span>&nbsp;<span class="op" id="485516">:=</span>&nbsp;<span class="ident" id="485519">httptest</span><span class="op" id="485527">.</span><span class="ident" id="485528">NewRecorder</span><span class="op" id="485539">(</span><span class="op" id="485540">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="485545">mux</span><span class="op" id="485548">.</span><span class="ident" id="485549">ServeHTTP</span><span class="op" id="485558">(</span><span class="ident" id="485559">resp</span><span class="op" id="485563">,</span>&nbsp;<span class="ident" id="485565">req</span><span class="op" id="485568">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="485573">if</span>&nbsp;<span class="ident" id="485576">loc</span><span class="op" id="485579">,</span>&nbsp;<span class="ident" id="485581">expected</span>&nbsp;<span class="op" id="485590">:=</span>&nbsp;<span class="ident" id="485593">resp</span><span class="op" id="485597">.</span><span class="ident" id="485598">Header</span><span class="op" id="485604">(</span><span class="op" id="485605">)</span><span class="op" id="485606">.</span><span class="ident" id="485607">Get</span><span class="op" id="485610">(</span><span class="string" id="485611">&#34;Location&#34;</span><span class="op" id="485621">)</span><span class="op" id="485622">,</span>&nbsp;<span class="string" id="485624">&#34;/foo.txt&#34;</span><span class="op" id="485634">;</span>&nbsp;<span class="ident" id="485636">loc</span>&nbsp;<span class="op" id="485640">!=</span>&nbsp;<span class="ident" id="485643">expected</span>&nbsp;<span class="op" id="485652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="485657">t</span><span class="op" id="485658">.</span><span class="ident" id="485659">Errorf</span><span class="op" id="485665">(</span><span class="string" id="485666">&#34;Expected&nbsp;Location&nbsp;header&nbsp;set&nbsp;to&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="485710">,</span>&nbsp;<span class="ident" id="485712">expected</span><span class="op" id="485720">,</span>&nbsp;<span class="ident" id="485722">loc</span><span class="op" id="485725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="485730">return</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="485739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="485744">if</span>&nbsp;<span class="ident" id="485747">code</span><span class="op" id="485751">,</span>&nbsp;<span class="ident" id="485753">expected</span>&nbsp;<span class="op" id="485762">:=</span>&nbsp;<span class="ident" id="485765">resp</span><span class="op" id="485769">.</span><span class="ident" id="485770">Code</span><span class="op" id="485774">,</span>&nbsp;<span class="ident" id="485776">StatusMovedPermanently</span><span class="op" id="485798">;</span>&nbsp;<span class="ident" id="485800">code</span>&nbsp;<span class="op" id="485805">!=</span>&nbsp;<span class="ident" id="485808">expected</span>&nbsp;<span class="op" id="485817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="485822">t</span><span class="op" id="485823">.</span><span class="ident" id="485824">Errorf</span><span class="op" id="485830">(</span><span class="string" id="485831">&#34;Expected&nbsp;response&nbsp;code&nbsp;of&nbsp;StatusMovedPermanently;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="485889">,</span>&nbsp;<span class="ident" id="485891">code</span><span class="op" id="485895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="485900">return</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="485909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="485912">}</span><br>
<span class="lineno"></span><span class="op" id="485914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="485917">func</span>&nbsp;<span class="ident" id="485922">TestServerTimeouts</span><span class="op" id="485940">(</span><span class="ident" id="485941">t</span>&nbsp;<span class="op" id="485943">*</span><span class="ident" id="485944">testing</span><span class="op" id="485951">.</span><span class="ident" id="485952">T</span><span class="op" id="485953">)</span>&nbsp;<span class="op" id="485955">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="485958">if</span>&nbsp;<span class="ident" id="485961">runtime</span><span class="op" id="485968">.</span><span class="ident" id="485969">GOOS</span>&nbsp;<span class="op" id="485974">==</span>&nbsp;<span class="string" id="485977">&#34;plan9&#34;</span>&nbsp;<span class="op" id="485985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="485989">t</span><span class="op" id="485990">.</span><span class="ident" id="485991">Skip</span><span class="op" id="485995">(</span><span class="string" id="485996">&#34;skipping&nbsp;test;&nbsp;see&nbsp;http://golang.org/issue/7237&#34;</span><span class="op" id="486045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="486048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="486051">defer</span>&nbsp;<span class="ident" id="486057">afterTest</span><span class="op" id="486066">(</span><span class="ident" id="486067">t</span><span class="op" id="486068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486071">reqNum</span>&nbsp;<span class="op" id="486078">:=</span>&nbsp;<span class="num" id="486081">0</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486084">ts</span>&nbsp;<span class="op" id="486087">:=</span>&nbsp;<span class="ident" id="486090">httptest</span><span class="op" id="486098">.</span><span class="ident" id="486099">NewUnstartedServer</span><span class="op" id="486117">(</span><span class="ident" id="486118">HandlerFunc</span><span class="op" id="486129">(</span><span class="keyword" id="486130">func</span><span class="op" id="486134">(</span><span class="ident" id="486135">res</span>&nbsp;<span class="ident" id="486139">ResponseWriter</span><span class="op" id="486153">,</span>&nbsp;<span class="ident" id="486155">req</span>&nbsp;<span class="op" id="486159">*</span><span class="ident" id="486160">Request</span><span class="op" id="486167">)</span>&nbsp;<span class="op" id="486169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486173">reqNum</span><span class="op" id="486179">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486184">fmt</span><span class="op" id="486187">.</span><span class="ident" id="486188">Fprintf</span><span class="op" id="486195">(</span><span class="ident" id="486196">res</span><span class="op" id="486199">,</span>&nbsp;<span class="string" id="486201">&#34;req=%d&#34;</span><span class="op" id="486209">,</span>&nbsp;<span class="ident" id="486211">reqNum</span><span class="op" id="486217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="486220">}</span><span class="op" id="486221">)</span><span class="op" id="486222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486225">ts</span><span class="op" id="486227">.</span><span class="ident" id="486228">Config</span><span class="op" id="486234">.</span><span class="ident" id="486235">ReadTimeout</span>&nbsp;<span class="op" id="486247">=</span>&nbsp;<span class="num" id="486249">250</span>&nbsp;<span class="op" id="486253">*</span>&nbsp;<span class="ident" id="486255">time</span><span class="op" id="486259">.</span><span class="ident" id="486260">Millisecond</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486273">ts</span><span class="op" id="486275">.</span><span class="ident" id="486276">Config</span><span class="op" id="486282">.</span><span class="ident" id="486283">WriteTimeout</span>&nbsp;<span class="op" id="486296">=</span>&nbsp;<span class="num" id="486298">250</span>&nbsp;<span class="op" id="486302">*</span>&nbsp;<span class="ident" id="486304">time</span><span class="op" id="486308">.</span><span class="ident" id="486309">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486322">ts</span><span class="op" id="486324">.</span><span class="ident" id="486325">Start</span><span class="op" id="486330">(</span><span class="op" id="486331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="486334">defer</span>&nbsp;<span class="ident" id="486340">ts</span><span class="op" id="486342">.</span><span class="ident" id="486343">Close</span><span class="op" id="486348">(</span><span class="op" id="486349">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="486353">//&nbsp;Hit&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;successfully.</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486391">tr</span>&nbsp;<span class="op" id="486394">:=</span>&nbsp;<span class="op" id="486397">&amp;</span><span class="ident" id="486398">Transport</span><span class="op" id="486407">{</span><span class="ident" id="486408">DisableKeepAlives</span><span class="op" id="486425">:</span>&nbsp;<span class="builtintype" id="486427">true</span><span class="op" id="486431">}</span>&nbsp;<span class="comment" id="486433">//&nbsp;they&nbsp;interfere&nbsp;with&nbsp;this&nbsp;test</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="486467">defer</span>&nbsp;<span class="ident" id="486473">tr</span><span class="op" id="486475">.</span><span class="ident" id="486476">CloseIdleConnections</span><span class="op" id="486496">(</span><span class="op" id="486497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486500">c</span>&nbsp;<span class="op" id="486502">:=</span>&nbsp;<span class="op" id="486505">&amp;</span><span class="ident" id="486506">Client</span><span class="op" id="486512">{</span><span class="ident" id="486513">Transport</span><span class="op" id="486522">:</span>&nbsp;<span class="ident" id="486524">tr</span><span class="op" id="486526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486529">r</span><span class="op" id="486530">,</span>&nbsp;<span class="ident" id="486532">err</span>&nbsp;<span class="op" id="486536">:=</span>&nbsp;<span class="ident" id="486539">c</span><span class="op" id="486540">.</span><span class="ident" id="486541">Get</span><span class="op" id="486544">(</span><span class="ident" id="486545">ts</span><span class="op" id="486547">.</span><span class="ident" id="486548">URL</span><span class="op" id="486551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="486554">if</span>&nbsp;<span class="ident" id="486557">err</span>&nbsp;<span class="op" id="486561">!=</span>&nbsp;<span class="builtintype" id="486564">nil</span>&nbsp;<span class="op" id="486568">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486572">t</span><span class="op" id="486573">.</span><span class="ident" id="486574">Fatalf</span><span class="op" id="486580">(</span><span class="string" id="486581">&#34;http&nbsp;Get&nbsp;#1:&nbsp;%v&#34;</span><span class="op" id="486598">,</span>&nbsp;<span class="ident" id="486600">err</span><span class="op" id="486603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="486606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486609">got</span><span class="op" id="486612">,</span>&nbsp;<span class="ident" id="486614">_</span>&nbsp;<span class="op" id="486616">:=</span>&nbsp;<span class="ident" id="486619">ioutil</span><span class="op" id="486625">.</span><span class="ident" id="486626">ReadAll</span><span class="op" id="486633">(</span><span class="ident" id="486634">r</span><span class="op" id="486635">.</span><span class="ident" id="486636">Body</span><span class="op" id="486640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486643">expected</span>&nbsp;<span class="op" id="486652">:=</span>&nbsp;<span class="string" id="486655">&#34;req=1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="486664">if</span>&nbsp;<span class="builtintype" id="486667">string</span><span class="op" id="486673">(</span><span class="ident" id="486674">got</span><span class="op" id="486677">)</span>&nbsp;<span class="op" id="486679">!=</span>&nbsp;<span class="ident" id="486682">expected</span>&nbsp;<span class="op" id="486691">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486695">t</span><span class="op" id="486696">.</span><span class="ident" id="486697">Errorf</span><span class="op" id="486703">(</span><span class="string" id="486704">&#34;Unexpected&nbsp;response&nbsp;for&nbsp;request&nbsp;#1;&nbsp;got&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="486761">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="486766">string</span><span class="op" id="486772">(</span><span class="ident" id="486773">got</span><span class="op" id="486776">)</span><span class="op" id="486777">,</span>&nbsp;<span class="ident" id="486779">expected</span><span class="op" id="486787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="486790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="486794">//&nbsp;Slow&nbsp;client&nbsp;that&nbsp;should&nbsp;timeout.</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486831">t1</span>&nbsp;<span class="op" id="486834">:=</span>&nbsp;<span class="ident" id="486837">time</span><span class="op" id="486841">.</span><span class="ident" id="486842">Now</span><span class="op" id="486845">(</span><span class="op" id="486846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486849">conn</span><span class="op" id="486853">,</span>&nbsp;<span class="ident" id="486855">err</span>&nbsp;<span class="op" id="486859">:=</span>&nbsp;<span class="ident" id="486862">net</span><span class="op" id="486865">.</span><span class="ident" id="486866">Dial</span><span class="op" id="486870">(</span><span class="string" id="486871">&#34;tcp&#34;</span><span class="op" id="486876">,</span>&nbsp;<span class="ident" id="486878">ts</span><span class="op" id="486880">.</span><span class="ident" id="486881">Listener</span><span class="op" id="486889">.</span><span class="ident" id="486890">Addr</span><span class="op" id="486894">(</span><span class="op" id="486895">)</span><span class="op" id="486896">.</span><span class="ident" id="486897">String</span><span class="op" id="486903">(</span><span class="op" id="486904">)</span><span class="op" id="486905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="486908">if</span>&nbsp;<span class="ident" id="486911">err</span>&nbsp;<span class="op" id="486915">!=</span>&nbsp;<span class="builtintype" id="486918">nil</span>&nbsp;<span class="op" id="486922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486926">t</span><span class="op" id="486927">.</span><span class="ident" id="486928">Fatalf</span><span class="op" id="486934">(</span><span class="string" id="486935">&#34;Dial:&nbsp;%v&#34;</span><span class="op" id="486945">,</span>&nbsp;<span class="ident" id="486947">err</span><span class="op" id="486950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="486953">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486956">buf</span>&nbsp;<span class="op" id="486960">:=</span>&nbsp;<span class="builtinfunc" id="486963">make</span><span class="op" id="486967">(</span><span class="op" id="486968">[</span><span class="op" id="486969">]</span><span class="builtintype" id="486970">byte</span><span class="op" id="486974">,</span>&nbsp;<span class="num" id="486976">1</span><span class="op" id="486977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="486980">n</span><span class="op" id="486981">,</span>&nbsp;<span class="ident" id="486983">err</span>&nbsp;<span class="op" id="486987">:=</span>&nbsp;<span class="ident" id="486990">conn</span><span class="op" id="486994">.</span><span class="ident" id="486995">Read</span><span class="op" id="486999">(</span><span class="ident" id="487000">buf</span><span class="op" id="487003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="487006">latency</span>&nbsp;<span class="op" id="487014">:=</span>&nbsp;<span class="ident" id="487017">time</span><span class="op" id="487021">.</span><span class="ident" id="487022">Since</span><span class="op" id="487027">(</span><span class="ident" id="487028">t1</span><span class="op" id="487030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="487033">if</span>&nbsp;<span class="ident" id="487036">n</span>&nbsp;<span class="op" id="487038">!=</span>&nbsp;<span class="num" id="487041">0</span>&nbsp;<span class="op" id="487043">||</span>&nbsp;<span class="ident" id="487046">err</span>&nbsp;<span class="op" id="487050">!=</span>&nbsp;<span class="ident" id="487053">io</span><span class="op" id="487055">.</span><span class="ident" id="487056">EOF</span>&nbsp;<span class="op" id="487060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="487064">t</span><span class="op" id="487065">.</span><span class="ident" id="487066">Errorf</span><span class="op" id="487072">(</span><span class="string" id="487073">&#34;Read&nbsp;=&nbsp;%v,&nbsp;%v,&nbsp;wanted&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="487103">,</span>&nbsp;<span class="ident" id="487105">n</span><span class="op" id="487106">,</span>&nbsp;<span class="ident" id="487108">err</span><span class="op" id="487111">,</span>&nbsp;<span class="num" id="487113">0</span><span class="op" id="487114">,</span>&nbsp;<span class="ident" id="487116">io</span><span class="op" id="487118">.</span><span class="ident" id="487119">EOF</span><span class="op" id="487122">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="487125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="487128">if</span>&nbsp;<span class="ident" id="487131">latency</span>&nbsp;<span class="op" id="487139">&lt;</span>&nbsp;<span class="num" id="487141">200</span><span class="op" id="487144">*</span><span class="ident" id="487145">time</span><span class="op" id="487149">.</span><span class="ident" id="487150">Millisecond</span>&nbsp;<span class="comment" id="487162">/*&nbsp;fudge&nbsp;from&nbsp;250&nbsp;ms&nbsp;above&nbsp;*/</span>&nbsp;<span class="op" id="487192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="487196">t</span><span class="op" id="487197">.</span><span class="ident" id="487198">Errorf</span><span class="op" id="487204">(</span><span class="string" id="487205">&#34;got&nbsp;EOF&nbsp;after&nbsp;%s,&nbsp;want&nbsp;&gt;=&nbsp;%s&#34;</span><span class="op" id="487235">,</span>&nbsp;<span class="ident" id="487237">latency</span><span class="op" id="487244">,</span>&nbsp;<span class="num" id="487246">200</span><span class="op" id="487249">*</span><span class="ident" id="487250">time</span><span class="op" id="487254">.</span><span class="ident" id="487255">Millisecond</span><span class="op" id="487266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="487269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="487273">//&nbsp;Hit&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;successfully&nbsp;again,&nbsp;verifying&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="487336">//&nbsp;previous&nbsp;slow&nbsp;connection&nbsp;didn&#39;t&nbsp;run&nbsp;our&nbsp;handler.&nbsp;&nbsp;(that&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="487399">//&nbsp;get&nbsp;&#34;req=2&#34;,&nbsp;not&nbsp;&#34;req=3&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="487429">r</span><span class="op" id="487430">,</span>&nbsp;<span class="ident" id="487432">err</span>&nbsp;<span class="op" id="487436">=</span>&nbsp;<span class="ident" id="487438">Get</span><span class="op" id="487441">(</span><span class="ident" id="487442">ts</span><span class="op" id="487444">.</span><span class="ident" id="487445">URL</span><span class="op" id="487448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="487451">if</span>&nbsp;<span class="ident" id="487454">err</span>&nbsp;<span class="op" id="487458">!=</span>&nbsp;<span class="builtintype" id="487461">nil</span>&nbsp;<span class="op" id="487465">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="487469">t</span><span class="op" id="487470">.</span><span class="ident" id="487471">Fatalf</span><span class="op" id="487477">(</span><span class="string" id="487478">&#34;http&nbsp;Get&nbsp;#2:&nbsp;%v&#34;</span><span class="op" id="487495">,</span>&nbsp;<span class="ident" id="487497">err</span><span class="op" id="487500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="487503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="487506">got</span><span class="op" id="487509">,</span>&nbsp;<span class="ident" id="487511">_</span>&nbsp;<span class="op" id="487513">=</span>&nbsp;<span class="ident" id="487515">ioutil</span><span class="op" id="487521">.</span><span class="ident" id="487522">ReadAll</span><span class="op" id="487529">(</span><span class="ident" id="487530">r</span><span class="op" id="487531">.</span><span class="ident" id="487532">Body</span><span class="op" id="487536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="487539">expected</span>&nbsp;<span class="op" id="487548">=</span>&nbsp;<span class="string" id="487550">&#34;req=2&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="487559">if</span>&nbsp;<span class="builtintype" id="487562">string</span><span class="op" id="487568">(</span><span class="ident" id="487569">got</span><span class="op" id="487572">)</span>&nbsp;<span class="op" id="487574">!=</span>&nbsp;<span class="ident" id="487577">expected</span>&nbsp;<span class="op" id="487586">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="487590">t</span><span class="op" id="487591">.</span><span class="ident" id="487592">Errorf</span><span class="op" id="487598">(</span><span class="string" id="487599">&#34;Get&nbsp;#2&nbsp;got&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="487623">,</span>&nbsp;<span class="builtintype" id="487625">string</span><span class="op" id="487631">(</span><span class="ident" id="487632">got</span><span class="op" id="487635">)</span><span class="op" id="487636">,</span>&nbsp;<span class="ident" id="487638">expected</span><span class="op" id="487646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="487649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="487653">if</span>&nbsp;<span class="op" id="487656">!</span><span class="ident" id="487657">testing</span><span class="op" id="487664">.</span><span class="ident" id="487665">Short</span><span class="op" id="487670">(</span><span class="op" id="487671">)</span>&nbsp;<span class="op" id="487673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="487677">conn</span><span class="op" id="487681">,</span>&nbsp;<span class="ident" id="487683">err</span>&nbsp;<span class="op" id="487687">:=</span>&nbsp;<span class="ident" id="487690">net</span><span class="op" id="487693">.</span><span class="ident" id="487694">Dial</span><span class="op" id="487698">(</span><span class="string" id="487699">&#34;tcp&#34;</span><span class="op" id="487704">,</span>&nbsp;<span class="ident" id="487706">ts</span><span class="op" id="487708">.</span><span class="ident" id="487709">Listener</span><span class="op" id="487717">.</span><span class="ident" id="487718">Addr</span><span class="op" id="487722">(</span><span class="op" id="487723">)</span><span class="op" id="487724">.</span><span class="ident" id="487725">String</span><span class="op" id="487731">(</span><span class="op" id="487732">)</span><span class="op" id="487733">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="487737">if</span>&nbsp;<span class="ident" id="487740">err</span>&nbsp;<span class="op" id="487744">!=</span>&nbsp;<span class="builtintype" id="487747">nil</span>&nbsp;<span class="op" id="487751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="487756">t</span><span class="op" id="487757">.</span><span class="ident" id="487758">Fatalf</span><span class="op" id="487764">(</span><span class="string" id="487765">&#34;Dial:&nbsp;%v&#34;</span><span class="op" id="487775">,</span>&nbsp;<span class="ident" id="487777">err</span><span class="op" id="487780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="487784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="487788">defer</span>&nbsp;<span class="ident" id="487794">conn</span><span class="op" id="487798">.</span><span class="ident" id="487799">Close</span><span class="op" id="487804">(</span><span class="op" id="487805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="487809">go</span>&nbsp;<span class="ident" id="487812">io</span><span class="op" id="487814">.</span><span class="ident" id="487815">Copy</span><span class="op" id="487819">(</span><span class="ident" id="487820">ioutil</span><span class="op" id="487826">.</span><span class="ident" id="487827">Discard</span><span class="op" id="487834">,</span>&nbsp;<span class="ident" id="487836">conn</span><span class="op" id="487840">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="487844">for</span>&nbsp;<span class="ident" id="487848">i</span>&nbsp;<span class="op" id="487850">:=</span>&nbsp;<span class="num" id="487853">0</span><span class="op" id="487854">;</span>&nbsp;<span class="ident" id="487856">i</span>&nbsp;<span class="op" id="487858">&lt;</span>&nbsp;<span class="num" id="487860">5</span><span class="op" id="487861">;</span>&nbsp;<span class="ident" id="487863">i</span><span class="op" id="487864">++</span>&nbsp;<span class="op" id="487867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="487872">_</span><span class="op" id="487873">,</span>&nbsp;<span class="ident" id="487875">err</span>&nbsp;<span class="op" id="487879">:=</span>&nbsp;<span class="ident" id="487882">conn</span><span class="op" id="487886">.</span><span class="ident" id="487887">Write</span><span class="op" id="487892">(</span><span class="op" id="487893">[</span><span class="op" id="487894">]</span><span class="builtintype" id="487895">byte</span><span class="op" id="487899">(</span><span class="string" id="487900">&#34;GET&nbsp;/&nbsp;HTTP/1.1\r\nHost:&nbsp;foo\r\n\r\n&#34;</span><span class="op" id="487937">)</span><span class="op" id="487938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="487943">if</span>&nbsp;<span class="ident" id="487946">err</span>&nbsp;<span class="op" id="487950">!=</span>&nbsp;<span class="builtintype" id="487953">nil</span>&nbsp;<span class="op" id="487957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="487963">t</span><span class="op" id="487964">.</span><span class="ident" id="487965">Fatalf</span><span class="op" id="487971">(</span><span class="string" id="487972">&#34;on&nbsp;write&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="487989">,</span>&nbsp;<span class="ident" id="487991">i</span><span class="op" id="487992">,</span>&nbsp;<span class="ident" id="487994">err</span><span class="op" id="487997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="488002">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="488007">time</span><span class="op" id="488011">.</span><span class="ident" id="488012">Sleep</span><span class="op" id="488017">(</span><span class="ident" id="488018">ts</span><span class="op" id="488020">.</span><span class="ident" id="488021">Config</span><span class="op" id="488027">.</span><span class="ident" id="488028">ReadTimeout</span>&nbsp;<span class="op" id="488040">/</span>&nbsp;<span class="num" id="488042">2</span><span class="op" id="488043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="488047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="488050">}</span><br>
<span class="lineno"></span><span class="op" id="488052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">520</span><span class="comment" id="488055">//&nbsp;golang.org/issue/4741&nbsp;--&nbsp;setting&nbsp;only&nbsp;a&nbsp;write&nbsp;timeout&nbsp;that&nbsp;triggers</span><br>
<span class="lineno"></span><span class="comment" id="488126">//&nbsp;shouldn&#39;t&nbsp;cause&nbsp;a&nbsp;handler&nbsp;to&nbsp;block&nbsp;forever&nbsp;on&nbsp;reads&nbsp;(next&nbsp;HTTP</span><br>
<span class="lineno"></span><span class="comment" id="488192">//&nbsp;request)&nbsp;that&nbsp;will&nbsp;never&nbsp;happen.</span><br>
<span class="lineno"></span><span class="keyword" id="488228">func</span>&nbsp;<span class="ident" id="488233">TestOnlyWriteTimeout</span><span class="op" id="488253">(</span><span class="ident" id="488254">t</span>&nbsp;<span class="op" id="488256">*</span><span class="ident" id="488257">testing</span><span class="op" id="488264">.</span><span class="ident" id="488265">T</span><span class="op" id="488266">)</span>&nbsp;<span class="op" id="488268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="488271">if</span>&nbsp;<span class="ident" id="488274">runtime</span><span class="op" id="488281">.</span><span class="ident" id="488282">GOOS</span>&nbsp;<span class="op" id="488287">==</span>&nbsp;<span class="string" id="488290">&#34;plan9&#34;</span>&nbsp;<span class="op" id="488298">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="488302">t</span><span class="op" id="488303">.</span><span class="ident" id="488304">Skip</span><span class="op" id="488308">(</span><span class="string" id="488309">&#34;skipping&nbsp;test;&nbsp;see&nbsp;http://golang.org/issue/7237&#34;</span><span class="op" id="488358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="488361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="488364">defer</span>&nbsp;<span class="ident" id="488370">afterTest</span><span class="op" id="488379">(</span><span class="ident" id="488380">t</span><span class="op" id="488381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="488384">var</span>&nbsp;<span class="ident" id="488388">conn</span>&nbsp;<span class="ident" id="488393">net</span><span class="op" id="488396">.</span><span class="ident" id="488397">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="488403">var</span>&nbsp;<span class="ident" id="488407">afterTimeoutErrc</span>&nbsp;<span class="op" id="488424">=</span>&nbsp;<span class="builtinfunc" id="488426">make</span><span class="op" id="488430">(</span><span class="keyword" id="488431">chan</span>&nbsp;<span class="builtintype" id="488436">error</span><span class="op" id="488441">,</span>&nbsp;<span class="num" id="488443">1</span><span class="op" id="488444">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="488447">ts</span>&nbsp;<span class="op" id="488450">:=</span>&nbsp;<span class="ident" id="488453">httptest</span><span class="op" id="488461">.</span><span class="ident" id="488462">NewUnstartedServer</span><span class="op" id="488480">(</span><span class="ident" id="488481">HandlerFunc</span><span class="op" id="488492">(</span><span class="keyword" id="488493">func</span><span class="op" id="488497">(</span><span class="ident" id="488498">w</span>&nbsp;<span class="ident" id="488500">ResponseWriter</span><span class="op" id="488514">,</span>&nbsp;<span class="ident" id="488516">req</span>&nbsp;<span class="op" id="488520">*</span><span class="ident" id="488521">Request</span><span class="op" id="488528">)</span>&nbsp;<span class="op" id="488530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="488534">buf</span>&nbsp;<span class="op" id="488538">:=</span>&nbsp;<span class="builtinfunc" id="488541">make</span><span class="op" id="488545">(</span><span class="op" id="488546">[</span><span class="op" id="488547">]</span><span class="builtintype" id="488548">byte</span><span class="op" id="488552">,</span>&nbsp;<span class="num" id="488554">512</span><span class="op" id="488557">&lt;&lt;</span><span class="num" id="488559">10</span><span class="op" id="488561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="488565">_</span><span class="op" id="488566">,</span>&nbsp;<span class="ident" id="488568">err</span>&nbsp;<span class="op" id="488572">:=</span>&nbsp;<span class="ident" id="488575">w</span><span class="op" id="488576">.</span><span class="ident" id="488577">Write</span><span class="op" id="488582">(</span><span class="ident" id="488583">buf</span><span class="op" id="488586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="488590">if</span>&nbsp;<span class="ident" id="488593">err</span>&nbsp;<span class="op" id="488597">!=</span>&nbsp;<span class="builtintype" id="488600">nil</span>&nbsp;<span class="op" id="488604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="488609">t</span><span class="op" id="488610">.</span><span class="ident" id="488611">Errorf</span><span class="op" id="488617">(</span><span class="string" id="488618">&#34;handler&nbsp;Write&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="488643">,</span>&nbsp;<span class="ident" id="488645">err</span><span class="op" id="488648">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="488653">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="488662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="488666">conn</span><span class="op" id="488670">.</span><span class="ident" id="488671">SetWriteDeadline</span><span class="op" id="488687">(</span><span class="ident" id="488688">time</span><span class="op" id="488692">.</span><span class="ident" id="488693">Now</span><span class="op" id="488696">(</span><span class="op" id="488697">)</span><span class="op" id="488698">.</span><span class="ident" id="488699">Add</span><span class="op" id="488702">(</span><span class="op" id="488703">-</span><span class="num" id="488704">30</span>&nbsp;<span class="op" id="488707">*</span>&nbsp;<span class="ident" id="488709">time</span><span class="op" id="488713">.</span><span class="ident" id="488714">Second</span><span class="op" id="488720">)</span><span class="op" id="488721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="488725">_</span><span class="op" id="488726">,</span>&nbsp;<span class="ident" id="488728">err</span>&nbsp;<span class="op" id="488732">=</span>&nbsp;<span class="ident" id="488734">w</span><span class="op" id="488735">.</span><span class="ident" id="488736">Write</span><span class="op" id="488741">(</span><span class="ident" id="488742">buf</span><span class="op" id="488745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="488749">afterTimeoutErrc</span>&nbsp;<span class="op" id="488766">&lt;-</span>&nbsp;<span class="ident" id="488769">err</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="488774">}</span><span class="op" id="488775">)</span><span class="op" id="488776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="488779">ts</span><span class="op" id="488781">.</span><span class="ident" id="488782">Listener</span>&nbsp;<span class="op" id="488791">=</span>&nbsp;<span class="ident" id="488793">trackLastConnListener</span><span class="op" id="488814">{</span><span class="ident" id="488815">ts</span><span class="op" id="488817">.</span><span class="ident" id="488818">Listener</span><span class="op" id="488826">,</span>&nbsp;<span class="op" id="488828">&amp;</span><span class="ident" id="488829">conn</span><span class="op" id="488833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="488836">ts</span><span class="op" id="488838">.</span><span class="ident" id="488839">Start</span><span class="op" id="488844">(</span><span class="op" id="488845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="488848">defer</span>&nbsp;<span class="ident" id="488854">ts</span><span class="op" id="488856">.</span><span class="ident" id="488857">Close</span><span class="op" id="488862">(</span><span class="op" id="488863">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="488867">tr</span>&nbsp;<span class="op" id="488870">:=</span>&nbsp;<span class="op" id="488873">&amp;</span><span class="ident" id="488874">Transport</span><span class="op" id="488883">{</span><span class="ident" id="488884">DisableKeepAlives</span><span class="op" id="488901">:</span>&nbsp;<span class="builtintype" id="488903">false</span><span class="op" id="488908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="488911">defer</span>&nbsp;<span class="ident" id="488917">tr</span><span class="op" id="488919">.</span><span class="ident" id="488920">CloseIdleConnections</span><span class="op" id="488940">(</span><span class="op" id="488941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="488944">c</span>&nbsp;<span class="op" id="488946">:=</span>&nbsp;<span class="op" id="488949">&amp;</span><span class="ident" id="488950">Client</span><span class="op" id="488956">{</span><span class="ident" id="488957">Transport</span><span class="op" id="488966">:</span>&nbsp;<span class="ident" id="488968">tr</span><span class="op" id="488970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="488974">errc</span>&nbsp;<span class="op" id="488979">:=</span>&nbsp;<span class="builtinfunc" id="488982">make</span><span class="op" id="488986">(</span><span class="keyword" id="488987">chan</span>&nbsp;<span class="builtintype" id="488992">error</span><span class="op" id="488997">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="489000">go</span>&nbsp;<span class="keyword" id="489003">func</span><span class="op" id="489007">(</span><span class="op" id="489008">)</span>&nbsp;<span class="op" id="489010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="489014">res</span><span class="op" id="489017">,</span>&nbsp;<span class="ident" id="489019">err</span>&nbsp;<span class="op" id="489023">:=</span>&nbsp;<span class="ident" id="489026">c</span><span class="op" id="489027">.</span><span class="ident" id="489028">Get</span><span class="op" id="489031">(</span><span class="ident" id="489032">ts</span><span class="op" id="489034">.</span><span class="ident" id="489035">URL</span><span class="op" id="489038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="489042">if</span>&nbsp;<span class="ident" id="489045">err</span>&nbsp;<span class="op" id="489049">!=</span>&nbsp;<span class="builtintype" id="489052">nil</span>&nbsp;<span class="op" id="489056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="489061">errc</span>&nbsp;<span class="op" id="489066">&lt;-</span>&nbsp;<span class="ident" id="489069">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="489076">return</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="489085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="489089">_</span><span class="op" id="489090">,</span>&nbsp;<span class="ident" id="489092">err</span>&nbsp;<span class="op" id="489096">=</span>&nbsp;<span class="ident" id="489098">io</span><span class="op" id="489100">.</span><span class="ident" id="489101">Copy</span><span class="op" id="489105">(</span><span class="ident" id="489106">ioutil</span><span class="op" id="489112">.</span><span class="ident" id="489113">Discard</span><span class="op" id="489120">,</span>&nbsp;<span class="ident" id="489122">res</span><span class="op" id="489125">.</span><span class="ident" id="489126">Body</span><span class="op" id="489130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="489134">errc</span>&nbsp;<span class="op" id="489139">&lt;-</span>&nbsp;<span class="ident" id="489142">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="489147">}</span><span class="op" id="489148">(</span><span class="op" id="489149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="489152">select</span>&nbsp;<span class="op" id="489159">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="489162">case</span>&nbsp;<span class="ident" id="489167">err</span>&nbsp;<span class="op" id="489171">:=</span>&nbsp;<span class="op" id="489174">&lt;-</span><span class="ident" id="489176">errc</span><span class="op" id="489180">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="489184">if</span>&nbsp;<span class="ident" id="489187">err</span>&nbsp;<span class="op" id="489191">==</span>&nbsp;<span class="builtintype" id="489194">nil</span>&nbsp;<span class="op" id="489198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="489203">t</span><span class="op" id="489204">.</span><span class="ident" id="489205">Errorf</span><span class="op" id="489211">(</span><span class="string" id="489212">&#34;expected&nbsp;an&nbsp;error&nbsp;from&nbsp;Get&nbsp;request&#34;</span><span class="op" id="489248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="489252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="489255">case</span>&nbsp;<span class="op" id="489260">&lt;-</span><span class="ident" id="489262">time</span><span class="op" id="489266">.</span><span class="ident" id="489267">After</span><span class="op" id="489272">(</span><span class="num" id="489273">5</span>&nbsp;<span class="op" id="489275">*</span>&nbsp;<span class="ident" id="489277">time</span><span class="op" id="489281">.</span><span class="ident" id="489282">Second</span><span class="op" id="489288">)</span><span class="op" id="489289">:</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="489293">t</span><span class="op" id="489294">.</span><span class="ident" id="489295">Fatal</span><span class="op" id="489300">(</span><span class="string" id="489301">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;Get&nbsp;error&#34;</span><span class="op" id="489332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="489335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="489338">if</span>&nbsp;<span class="ident" id="489341">err</span>&nbsp;<span class="op" id="489345">:=</span>&nbsp;<span class="op" id="489348">&lt;-</span><span class="ident" id="489350">afterTimeoutErrc</span><span class="op" id="489366">;</span>&nbsp;<span class="ident" id="489368">err</span>&nbsp;<span class="op" id="489372">==</span>&nbsp;<span class="builtintype" id="489375">nil</span>&nbsp;<span class="op" id="489379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="489383">t</span><span class="op" id="489384">.</span><span class="ident" id="489385">Error</span><span class="op" id="489390">(</span><span class="string" id="489391">&#34;expected&nbsp;write&nbsp;error&nbsp;after&nbsp;timeout&#34;</span><span class="op" id="489427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="489430">}</span><br>
<span class="lineno">570</span><span class="op" id="489432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="489435">//&nbsp;trackLastConnListener&nbsp;tracks&nbsp;the&nbsp;last&nbsp;net.Conn&nbsp;that&nbsp;was&nbsp;accepted.</span><br>
<span class="lineno"></span><span class="keyword" id="489504">type</span>&nbsp;<span class="ident" id="489509">trackLastConnListener</span>&nbsp;<span class="keyword" id="489531">struct</span>&nbsp;<span class="op" id="489538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="489541">net</span><span class="op" id="489544">.</span><span class="ident" id="489545">Listener</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="489555">last</span>&nbsp;<span class="op" id="489560">*</span><span class="ident" id="489561">net</span><span class="op" id="489564">.</span><span class="ident" id="489565">Conn</span>&nbsp;<span class="comment" id="489570">//&nbsp;destination</span><br>
<span class="lineno"></span><span class="op" id="489585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="489588">func</span>&nbsp;<span class="op" id="489593">(</span><span class="ident" id="489594">l</span>&nbsp;<span class="ident" id="489596">trackLastConnListener</span><span class="op" id="489617">)</span>&nbsp;<span class="ident" id="489619">Accept</span><span class="op" id="489625">(</span><span class="op" id="489626">)</span>&nbsp;<span class="op" id="489628">(</span><span class="ident" id="489629">c</span>&nbsp;<span class="ident" id="489631">net</span><span class="op" id="489634">.</span><span class="ident" id="489635">Conn</span><span class="op" id="489639">,</span>&nbsp;<span class="ident" id="489641">err</span>&nbsp;<span class="builtintype" id="489645">error</span><span class="op" id="489650">)</span>&nbsp;<span class="op" id="489652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="489655">c</span><span class="op" id="489656">,</span>&nbsp;<span class="ident" id="489658">err</span>&nbsp;<span class="op" id="489662">=</span>&nbsp;<span class="ident" id="489664">l</span><span class="op" id="489665">.</span><span class="ident" id="489666">Listener</span><span class="op" id="489674">.</span><span class="ident" id="489675">Accept</span><span class="op" id="489681">(</span><span class="op" id="489682">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="489685">*</span><span class="ident" id="489686">l</span><span class="op" id="489687">.</span><span class="ident" id="489688">last</span>&nbsp;<span class="op" id="489693">=</span>&nbsp;<span class="ident" id="489695">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="489698">return</span><br>
<span class="lineno"></span><span class="op" id="489705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="489708">//&nbsp;TestIdentityResponse&nbsp;verifies&nbsp;that&nbsp;a&nbsp;handler&nbsp;can&nbsp;unset</span><br>
<span class="lineno">585</span><span class="keyword" id="489766">func</span>&nbsp;<span class="ident" id="489771">TestIdentityResponse</span><span class="op" id="489791">(</span><span class="ident" id="489792">t</span>&nbsp;<span class="op" id="489794">*</span><span class="ident" id="489795">testing</span><span class="op" id="489802">.</span><span class="ident" id="489803">T</span><span class="op" id="489804">)</span>&nbsp;<span class="op" id="489806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="489809">defer</span>&nbsp;<span class="ident" id="489815">afterTest</span><span class="op" id="489824">(</span><span class="ident" id="489825">t</span><span class="op" id="489826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="489829">handler</span>&nbsp;<span class="op" id="489837">:=</span>&nbsp;<span class="ident" id="489840">HandlerFunc</span><span class="op" id="489851">(</span><span class="keyword" id="489852">func</span><span class="op" id="489856">(</span><span class="ident" id="489857">rw</span>&nbsp;<span class="ident" id="489860">ResponseWriter</span><span class="op" id="489874">,</span>&nbsp;<span class="ident" id="489876">req</span>&nbsp;<span class="op" id="489880">*</span><span class="ident" id="489881">Request</span><span class="op" id="489888">)</span>&nbsp;<span class="op" id="489890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="489894">rw</span><span class="op" id="489896">.</span><span class="ident" id="489897">Header</span><span class="op" id="489903">(</span><span class="op" id="489904">)</span><span class="op" id="489905">.</span><span class="ident" id="489906">Set</span><span class="op" id="489909">(</span><span class="string" id="489910">&#34;Content-Length&#34;</span><span class="op" id="489926">,</span>&nbsp;<span class="string" id="489928">&#34;3&#34;</span><span class="op" id="489931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="489935">rw</span><span class="op" id="489937">.</span><span class="ident" id="489938">Header</span><span class="op" id="489944">(</span><span class="op" id="489945">)</span><span class="op" id="489946">.</span><span class="ident" id="489947">Set</span><span class="op" id="489950">(</span><span class="string" id="489951">&#34;Transfer-Encoding&#34;</span><span class="op" id="489970">,</span>&nbsp;<span class="ident" id="489972">req</span><span class="op" id="489975">.</span><span class="ident" id="489976">FormValue</span><span class="op" id="489985">(</span><span class="string" id="489986">&#34;te&#34;</span><span class="op" id="489990">)</span><span class="op" id="489991">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="489995">switch</span>&nbsp;<span class="op" id="490002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="490006">case</span>&nbsp;<span class="ident" id="490011">req</span><span class="op" id="490014">.</span><span class="ident" id="490015">FormValue</span><span class="op" id="490024">(</span><span class="string" id="490025">&#34;overwrite&#34;</span><span class="op" id="490036">)</span>&nbsp;<span class="op" id="490038">==</span>&nbsp;<span class="string" id="490041">&#34;1&#34;</span><span class="op" id="490044">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="490049">_</span><span class="op" id="490050">,</span>&nbsp;<span class="ident" id="490052">err</span>&nbsp;<span class="op" id="490056">:=</span>&nbsp;<span class="ident" id="490059">rw</span><span class="op" id="490061">.</span><span class="ident" id="490062">Write</span><span class="op" id="490067">(</span><span class="op" id="490068">[</span><span class="op" id="490069">]</span><span class="builtintype" id="490070">byte</span><span class="op" id="490074">(</span><span class="string" id="490075">&#34;foo&nbsp;TOO&nbsp;LONG&#34;</span><span class="op" id="490089">)</span><span class="op" id="490090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="490095">if</span>&nbsp;<span class="ident" id="490098">err</span>&nbsp;<span class="op" id="490102">!=</span>&nbsp;<span class="ident" id="490105">ErrContentLength</span>&nbsp;<span class="op" id="490122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="490128">t</span><span class="op" id="490129">.</span><span class="ident" id="490130">Errorf</span><span class="op" id="490136">(</span><span class="string" id="490137">&#34;expected&nbsp;ErrContentLength;&nbsp;got&nbsp;%v&#34;</span><span class="op" id="490172">,</span>&nbsp;<span class="ident" id="490174">err</span><span class="op" id="490177">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="490182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="490186">case</span>&nbsp;<span class="ident" id="490191">req</span><span class="op" id="490194">.</span><span class="ident" id="490195">FormValue</span><span class="op" id="490204">(</span><span class="string" id="490205">&#34;underwrite&#34;</span><span class="op" id="490217">)</span>&nbsp;<span class="op" id="490219">==</span>&nbsp;<span class="string" id="490222">&#34;1&#34;</span><span class="op" id="490225">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="490230">rw</span><span class="op" id="490232">.</span><span class="ident" id="490233">Header</span><span class="op" id="490239">(</span><span class="op" id="490240">)</span><span class="op" id="490241">.</span><span class="ident" id="490242">Set</span><span class="op" id="490245">(</span><span class="string" id="490246">&#34;Content-Length&#34;</span><span class="op" id="490262">,</span>&nbsp;<span class="string" id="490264">&#34;500&#34;</span><span class="op" id="490269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="490274">rw</span><span class="op" id="490276">.</span><span class="ident" id="490277">Write</span><span class="op" id="490282">(</span><span class="op" id="490283">[</span><span class="op" id="490284">]</span><span class="builtintype" id="490285">byte</span><span class="op" id="490289">(</span><span class="string" id="490290">&#34;too&nbsp;short&#34;</span><span class="op" id="490301">)</span><span class="op" id="490302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="490306">default</span><span class="op" id="490313">:</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="490318">rw</span><span class="op" id="490320">.</span><span class="ident" id="490321">Write</span><span class="op" id="490326">(</span><span class="op" id="490327">[</span><span class="op" id="490328">]</span><span class="builtintype" id="490329">byte</span><span class="op" id="490333">(</span><span class="string" id="490334">&#34;foo&#34;</span><span class="op" id="490339">)</span><span class="op" id="490340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="490344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="490347">}</span><span class="op" id="490348">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="490352">ts</span>&nbsp;<span class="op" id="490355">:=</span>&nbsp;<span class="ident" id="490358">httptest</span><span class="op" id="490366">.</span><span class="ident" id="490367">NewServer</span><span class="op" id="490376">(</span><span class="ident" id="490377">handler</span><span class="op" id="490384">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="490387">defer</span>&nbsp;<span class="ident" id="490393">ts</span><span class="op" id="490395">.</span><span class="ident" id="490396">Close</span><span class="op" id="490401">(</span><span class="op" id="490402">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="490406">//&nbsp;Note:&nbsp;this&nbsp;relies&nbsp;on&nbsp;the&nbsp;assumption&nbsp;(which&nbsp;is&nbsp;true)&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="490467">//&nbsp;Get&nbsp;sends&nbsp;HTTP/1.1&nbsp;or&nbsp;greater&nbsp;requests.&nbsp;&nbsp;Otherwise&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="490526">//&nbsp;server&nbsp;wouldn&#39;t&nbsp;have&nbsp;the&nbsp;choice&nbsp;to&nbsp;send&nbsp;back&nbsp;chunked</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="490583">//&nbsp;responses.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="490598">for</span>&nbsp;<span class="ident" id="490602">_</span><span class="op" id="490603">,</span>&nbsp;<span class="ident" id="490605">te</span>&nbsp;<span class="op" id="490608">:=</span>&nbsp;<span class="keyword" id="490611">range</span>&nbsp;<span class="op" id="490617">[</span><span class="op" id="490618">]</span><span class="builtintype" id="490619">string</span><span class="op" id="490625">{</span><span class="string" id="490626">&#34;&#34;</span><span class="op" id="490628">,</span>&nbsp;<span class="string" id="490630">&#34;identity&#34;</span><span class="op" id="490640">}</span>&nbsp;<span class="op" id="490642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="490646">url</span>&nbsp;<span class="op" id="490650">:=</span>&nbsp;<span class="ident" id="490653">ts</span><span class="op" id="490655">.</span><span class="ident" id="490656">URL</span>&nbsp;<span class="op" id="490660">+</span>&nbsp;<span class="string" id="490662">&#34;/?te=&#34;</span>&nbsp;<span class="op" id="490670">+</span>&nbsp;<span class="ident" id="490672">te</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="490677">res</span><span class="op" id="490680">,</span>&nbsp;<span class="ident" id="490682">err</span>&nbsp;<span class="op" id="490686">:=</span>&nbsp;<span class="ident" id="490689">Get</span><span class="op" id="490692">(</span><span class="ident" id="490693">url</span><span class="op" id="490696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="490700">if</span>&nbsp;<span class="ident" id="490703">err</span>&nbsp;<span class="op" id="490707">!=</span>&nbsp;<span class="builtintype" id="490710">nil</span>&nbsp;<span class="op" id="490714">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="490719">t</span><span class="op" id="490720">.</span><span class="ident" id="490721">Fatalf</span><span class="op" id="490727">(</span><span class="string" id="490728">&#34;error&nbsp;with&nbsp;Get&nbsp;of&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="490754">,</span>&nbsp;<span class="ident" id="490756">url</span><span class="op" id="490759">,</span>&nbsp;<span class="ident" id="490761">err</span><span class="op" id="490764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="490768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="490772">if</span>&nbsp;<span class="ident" id="490775">cl</span><span class="op" id="490777">,</span>&nbsp;<span class="ident" id="490779">expected</span>&nbsp;<span class="op" id="490788">:=</span>&nbsp;<span class="ident" id="490791">res</span><span class="op" id="490794">.</span><span class="ident" id="490795">ContentLength</span><span class="op" id="490808">,</span>&nbsp;<span class="ident" id="490810">int64</span><span class="op" id="490815">(</span><span class="num" id="490816">3</span><span class="op" id="490817">)</span><span class="op" id="490818">;</span>&nbsp;<span class="ident" id="490820">cl</span>&nbsp;<span class="op" id="490823">!=</span>&nbsp;<span class="ident" id="490826">expected</span>&nbsp;<span class="op" id="490835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="490840">t</span><span class="op" id="490841">.</span><span class="ident" id="490842">Errorf</span><span class="op" id="490848">(</span><span class="string" id="490849">&#34;for&nbsp;%s&nbsp;expected&nbsp;res.ContentLength&nbsp;of&nbsp;%d;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="490898">,</span>&nbsp;<span class="ident" id="490900">url</span><span class="op" id="490903">,</span>&nbsp;<span class="ident" id="490905">expected</span><span class="op" id="490913">,</span>&nbsp;<span class="ident" id="490915">cl</span><span class="op" id="490917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="490921">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="490925">if</span>&nbsp;<span class="ident" id="490928">cl</span><span class="op" id="490930">,</span>&nbsp;<span class="ident" id="490932">expected</span>&nbsp;<span class="op" id="490941">:=</span>&nbsp;<span class="ident" id="490944">res</span><span class="op" id="490947">.</span><span class="ident" id="490948">Header</span><span class="op" id="490954">.</span><span class="ident" id="490955">Get</span><span class="op" id="490958">(</span><span class="string" id="490959">&#34;Content-Length&#34;</span><span class="op" id="490975">)</span><span class="op" id="490976">,</span>&nbsp;<span class="string" id="490978">&#34;3&#34;</span><span class="op" id="490981">;</span>&nbsp;<span class="ident" id="490983">cl</span>&nbsp;<span class="op" id="490986">!=</span>&nbsp;<span class="ident" id="490989">expected</span>&nbsp;<span class="op" id="490998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="491003">t</span><span class="op" id="491004">.</span><span class="ident" id="491005">Errorf</span><span class="op" id="491011">(</span><span class="string" id="491012">&#34;for&nbsp;%s&nbsp;expected&nbsp;Content-Length&nbsp;header&nbsp;of&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="491065">,</span>&nbsp;<span class="ident" id="491067">url</span><span class="op" id="491070">,</span>&nbsp;<span class="ident" id="491072">expected</span><span class="op" id="491080">,</span>&nbsp;<span class="ident" id="491082">cl</span><span class="op" id="491084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="491088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="491092">if</span>&nbsp;<span class="ident" id="491095">tl</span><span class="op" id="491097">,</span>&nbsp;<span class="ident" id="491099">expected</span>&nbsp;<span class="op" id="491108">:=</span>&nbsp;<span class="builtinfunc" id="491111">len</span><span class="op" id="491114">(</span><span class="ident" id="491115">res</span><span class="op" id="491118">.</span><span class="ident" id="491119">TransferEncoding</span><span class="op" id="491135">)</span><span class="op" id="491136">,</span>&nbsp;<span class="num" id="491138">0</span><span class="op" id="491139">;</span>&nbsp;<span class="ident" id="491141">tl</span>&nbsp;<span class="op" id="491144">!=</span>&nbsp;<span class="ident" id="491147">expected</span>&nbsp;<span class="op" id="491156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="491161">t</span><span class="op" id="491162">.</span><span class="ident" id="491163">Errorf</span><span class="op" id="491169">(</span><span class="string" id="491170">&#34;for&nbsp;%s&nbsp;expected&nbsp;len(res.TransferEncoding)&nbsp;of&nbsp;%d;&nbsp;got&nbsp;%d&nbsp;(%v)&#34;</span><span class="op" id="491232">,</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="491238">url</span><span class="op" id="491241">,</span>&nbsp;<span class="ident" id="491243">expected</span><span class="op" id="491251">,</span>&nbsp;<span class="ident" id="491253">tl</span><span class="op" id="491255">,</span>&nbsp;<span class="ident" id="491257">res</span><span class="op" id="491260">.</span><span class="ident" id="491261">TransferEncoding</span><span class="op" id="491277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="491281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="491285">res</span><span class="op" id="491288">.</span><span class="ident" id="491289">Body</span><span class="op" id="491293">.</span><span class="ident" id="491294">Close</span><span class="op" id="491299">(</span><span class="op" id="491300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="491303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="491307">//&nbsp;Verify&nbsp;that&nbsp;ErrContentLength&nbsp;is&nbsp;returned</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="491352">url</span>&nbsp;<span class="op" id="491356">:=</span>&nbsp;<span class="ident" id="491359">ts</span><span class="op" id="491361">.</span><span class="ident" id="491362">URL</span>&nbsp;<span class="op" id="491366">+</span>&nbsp;<span class="string" id="491368">&#34;/?overwrite=1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="491385">res</span><span class="op" id="491388">,</span>&nbsp;<span class="ident" id="491390">err</span>&nbsp;<span class="op" id="491394">:=</span>&nbsp;<span class="ident" id="491397">Get</span><span class="op" id="491400">(</span><span class="ident" id="491401">url</span><span class="op" id="491404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="491407">if</span>&nbsp;<span class="ident" id="491410">err</span>&nbsp;<span class="op" id="491414">!=</span>&nbsp;<span class="builtintype" id="491417">nil</span>&nbsp;<span class="op" id="491421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="491425">t</span><span class="op" id="491426">.</span><span class="ident" id="491427">Fatalf</span><span class="op" id="491433">(</span><span class="string" id="491434">&#34;error&nbsp;with&nbsp;Get&nbsp;of&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="491460">,</span>&nbsp;<span class="ident" id="491462">url</span><span class="op" id="491465">,</span>&nbsp;<span class="ident" id="491467">err</span><span class="op" id="491470">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="491473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="491476">res</span><span class="op" id="491479">.</span><span class="ident" id="491480">Body</span><span class="op" id="491484">.</span><span class="ident" id="491485">Close</span><span class="op" id="491490">(</span><span class="op" id="491491">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="491495">//&nbsp;Verify&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;closed&nbsp;when&nbsp;the&nbsp;declared&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="491569">//&nbsp;is&nbsp;larger&nbsp;than&nbsp;what&nbsp;the&nbsp;handler&nbsp;wrote.</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="491612">conn</span><span class="op" id="491616">,</span>&nbsp;<span class="ident" id="491618">err</span>&nbsp;<span class="op" id="491622">:=</span>&nbsp;<span class="ident" id="491625">net</span><span class="op" id="491628">.</span><span class="ident" id="491629">Dial</span><span class="op" id="491633">(</span><span class="string" id="491634">&#34;tcp&#34;</span><span class="op" id="491639">,</span>&nbsp;<span class="ident" id="491641">ts</span><span class="op" id="491643">.</span><span class="ident" id="491644">Listener</span><span class="op" id="491652">.</span><span class="ident" id="491653">Addr</span><span class="op" id="491657">(</span><span class="op" id="491658">)</span><span class="op" id="491659">.</span><span class="ident" id="491660">String</span><span class="op" id="491666">(</span><span class="op" id="491667">)</span><span class="op" id="491668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="491671">if</span>&nbsp;<span class="ident" id="491674">err</span>&nbsp;<span class="op" id="491678">!=</span>&nbsp;<span class="builtintype" id="491681">nil</span>&nbsp;<span class="op" id="491685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="491689">t</span><span class="op" id="491690">.</span><span class="ident" id="491691">Fatalf</span><span class="op" id="491697">(</span><span class="string" id="491698">&#34;error&nbsp;dialing:&nbsp;%v&#34;</span><span class="op" id="491717">,</span>&nbsp;<span class="ident" id="491719">err</span><span class="op" id="491722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="491725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="491728">_</span><span class="op" id="491729">,</span>&nbsp;<span class="ident" id="491731">err</span>&nbsp;<span class="op" id="491735">=</span>&nbsp;<span class="ident" id="491737">conn</span><span class="op" id="491741">.</span><span class="ident" id="491742">Write</span><span class="op" id="491747">(</span><span class="op" id="491748">[</span><span class="op" id="491749">]</span><span class="builtintype" id="491750">byte</span><span class="op" id="491754">(</span><span class="string" id="491755">&#34;GET&nbsp;/?underwrite=1&nbsp;HTTP/1.1\r\nHost:&nbsp;foo\r\n\r\n&#34;</span><span class="op" id="491805">)</span><span class="op" id="491806">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="491809">if</span>&nbsp;<span class="ident" id="491812">err</span>&nbsp;<span class="op" id="491816">!=</span>&nbsp;<span class="builtintype" id="491819">nil</span>&nbsp;<span class="op" id="491823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="491827">t</span><span class="op" id="491828">.</span><span class="ident" id="491829">Fatalf</span><span class="op" id="491835">(</span><span class="string" id="491836">&#34;error&nbsp;writing:&nbsp;%v&#34;</span><span class="op" id="491855">,</span>&nbsp;<span class="ident" id="491857">err</span><span class="op" id="491860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="491863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="491867">//&nbsp;The&nbsp;ReadAll&nbsp;will&nbsp;hang&nbsp;for&nbsp;a&nbsp;failing&nbsp;test,&nbsp;so&nbsp;use&nbsp;a&nbsp;Timer&nbsp;to</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="491931">//&nbsp;fail&nbsp;explicitly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="491952">goTimeout</span><span class="op" id="491961">(</span><span class="ident" id="491962">t</span><span class="op" id="491963">,</span>&nbsp;<span class="num" id="491965">2</span><span class="op" id="491966">*</span><span class="ident" id="491967">time</span><span class="op" id="491971">.</span><span class="ident" id="491972">Second</span><span class="op" id="491978">,</span>&nbsp;<span class="keyword" id="491980">func</span><span class="op" id="491984">(</span><span class="op" id="491985">)</span>&nbsp;<span class="op" id="491987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="491991">got</span><span class="op" id="491994">,</span>&nbsp;<span class="ident" id="491996">_</span>&nbsp;<span class="op" id="491998">:=</span>&nbsp;<span class="ident" id="492001">ioutil</span><span class="op" id="492007">.</span><span class="ident" id="492008">ReadAll</span><span class="op" id="492015">(</span><span class="ident" id="492016">conn</span><span class="op" id="492020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="492024">expectedSuffix</span>&nbsp;<span class="op" id="492039">:=</span>&nbsp;<span class="string" id="492042">&#34;\r\n\r\ntoo&nbsp;short&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="492064">if</span>&nbsp;<span class="op" id="492067">!</span><span class="ident" id="492068">strings</span><span class="op" id="492075">.</span><span class="ident" id="492076">HasSuffix</span><span class="op" id="492085">(</span><span class="builtintype" id="492086">string</span><span class="op" id="492092">(</span><span class="ident" id="492093">got</span><span class="op" id="492096">)</span><span class="op" id="492097">,</span>&nbsp;<span class="ident" id="492099">expectedSuffix</span><span class="op" id="492113">)</span>&nbsp;<span class="op" id="492115">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="492120">t</span><span class="op" id="492121">.</span><span class="ident" id="492122">Errorf</span><span class="op" id="492128">(</span><span class="string" id="492129">&#34;Expected&nbsp;output&nbsp;to&nbsp;end&nbsp;with&nbsp;%q;&nbsp;got&nbsp;response&nbsp;body&nbsp;%q&#34;</span><span class="op" id="492183">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="492189">expectedSuffix</span><span class="op" id="492203">,</span>&nbsp;<span class="builtintype" id="492205">string</span><span class="op" id="492211">(</span><span class="ident" id="492212">got</span><span class="op" id="492215">)</span><span class="op" id="492216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="492220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="492223">}</span><span class="op" id="492224">)</span><br>
<span class="lineno"></span><span class="op" id="492226">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="keyword" id="492229">func</span>&nbsp;<span class="ident" id="492234">testTCPConnectionCloses</span><span class="op" id="492257">(</span><span class="ident" id="492258">t</span>&nbsp;<span class="op" id="492260">*</span><span class="ident" id="492261">testing</span><span class="op" id="492268">.</span><span class="ident" id="492269">T</span><span class="op" id="492270">,</span>&nbsp;<span class="ident" id="492272">req</span>&nbsp;<span class="builtintype" id="492276">string</span><span class="op" id="492282">,</span>&nbsp;<span class="ident" id="492284">h</span>&nbsp;<span class="ident" id="492286">Handler</span><span class="op" id="492293">)</span>&nbsp;<span class="op" id="492295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="492298">defer</span>&nbsp;<span class="ident" id="492304">afterTest</span><span class="op" id="492313">(</span><span class="ident" id="492314">t</span><span class="op" id="492315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="492318">s</span>&nbsp;<span class="op" id="492320">:=</span>&nbsp;<span class="ident" id="492323">httptest</span><span class="op" id="492331">.</span><span class="ident" id="492332">NewServer</span><span class="op" id="492341">(</span><span class="ident" id="492342">h</span><span class="op" id="492343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="492346">defer</span>&nbsp;<span class="ident" id="492352">s</span><span class="op" id="492353">.</span><span class="ident" id="492354">Close</span><span class="op" id="492359">(</span><span class="op" id="492360">)</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="492364">conn</span><span class="op" id="492368">,</span>&nbsp;<span class="ident" id="492370">err</span>&nbsp;<span class="op" id="492374">:=</span>&nbsp;<span class="ident" id="492377">net</span><span class="op" id="492380">.</span><span class="ident" id="492381">Dial</span><span class="op" id="492385">(</span><span class="string" id="492386">&#34;tcp&#34;</span><span class="op" id="492391">,</span>&nbsp;<span class="ident" id="492393">s</span><span class="op" id="492394">.</span><span class="ident" id="492395">Listener</span><span class="op" id="492403">.</span><span class="ident" id="492404">Addr</span><span class="op" id="492408">(</span><span class="op" id="492409">)</span><span class="op" id="492410">.</span><span class="ident" id="492411">String</span><span class="op" id="492417">(</span><span class="op" id="492418">)</span><span class="op" id="492419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="492422">if</span>&nbsp;<span class="ident" id="492425">err</span>&nbsp;<span class="op" id="492429">!=</span>&nbsp;<span class="builtintype" id="492432">nil</span>&nbsp;<span class="op" id="492436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="492440">t</span><span class="op" id="492441">.</span><span class="ident" id="492442">Fatal</span><span class="op" id="492447">(</span><span class="string" id="492448">&#34;dial&nbsp;error:&#34;</span><span class="op" id="492461">,</span>&nbsp;<span class="ident" id="492463">err</span><span class="op" id="492466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="492469">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="492472">defer</span>&nbsp;<span class="ident" id="492478">conn</span><span class="op" id="492482">.</span><span class="ident" id="492483">Close</span><span class="op" id="492488">(</span><span class="op" id="492489">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="492493">_</span><span class="op" id="492494">,</span>&nbsp;<span class="ident" id="492496">err</span>&nbsp;<span class="op" id="492500">=</span>&nbsp;<span class="ident" id="492502">fmt</span><span class="op" id="492505">.</span><span class="ident" id="492506">Fprint</span><span class="op" id="492512">(</span><span class="ident" id="492513">conn</span><span class="op" id="492517">,</span>&nbsp;<span class="ident" id="492519">req</span><span class="op" id="492522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="492525">if</span>&nbsp;<span class="ident" id="492528">err</span>&nbsp;<span class="op" id="492532">!=</span>&nbsp;<span class="builtintype" id="492535">nil</span>&nbsp;<span class="op" id="492539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="492543">t</span><span class="op" id="492544">.</span><span class="ident" id="492545">Fatal</span><span class="op" id="492550">(</span><span class="string" id="492551">&#34;print&nbsp;error:&#34;</span><span class="op" id="492565">,</span>&nbsp;<span class="ident" id="492567">err</span><span class="op" id="492570">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="492573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="492577">r</span>&nbsp;<span class="op" id="492579">:=</span>&nbsp;<span class="ident" id="492582">bufio</span><span class="op" id="492587">.</span><span class="ident" id="492588">NewReader</span><span class="op" id="492597">(</span><span class="ident" id="492598">conn</span><span class="op" id="492602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="492605">res</span><span class="op" id="492608">,</span>&nbsp;<span class="ident" id="492610">err</span>&nbsp;<span class="op" id="492614">:=</span>&nbsp;<span class="ident" id="492617">ReadResponse</span><span class="op" id="492629">(</span><span class="ident" id="492630">r</span><span class="op" id="492631">,</span>&nbsp;<span class="op" id="492633">&amp;</span><span class="ident" id="492634">Request</span><span class="op" id="492641">{</span><span class="ident" id="492642">Method</span><span class="op" id="492648">:</span>&nbsp;<span class="string" id="492650">&#34;GET&#34;</span><span class="op" id="492655">}</span><span class="op" id="492656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="492659">if</span>&nbsp;<span class="ident" id="492662">err</span>&nbsp;<span class="op" id="492666">!=</span>&nbsp;<span class="builtintype" id="492669">nil</span>&nbsp;<span class="op" id="492673">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="492677">t</span><span class="op" id="492678">.</span><span class="ident" id="492679">Fatal</span><span class="op" id="492684">(</span><span class="string" id="492685">&#34;ReadResponse&nbsp;error:&#34;</span><span class="op" id="492706">,</span>&nbsp;<span class="ident" id="492708">err</span><span class="op" id="492711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="492714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="492718">didReadAll</span>&nbsp;<span class="op" id="492729">:=</span>&nbsp;<span class="builtinfunc" id="492732">make</span><span class="op" id="492736">(</span><span class="keyword" id="492737">chan</span>&nbsp;<span class="builtintype" id="492742">bool</span><span class="op" id="492746">,</span>&nbsp;<span class="num" id="492748">1</span><span class="op" id="492749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="492752">go</span>&nbsp;<span class="keyword" id="492755">func</span><span class="op" id="492759">(</span><span class="op" id="492760">)</span>&nbsp;<span class="op" id="492762">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="492766">select</span>&nbsp;<span class="op" id="492773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="492777">case</span>&nbsp;<span class="op" id="492782">&lt;-</span><span class="ident" id="492784">time</span><span class="op" id="492788">.</span><span class="ident" id="492789">After</span><span class="op" id="492794">(</span><span class="num" id="492795">5</span>&nbsp;<span class="op" id="492797">*</span>&nbsp;<span class="ident" id="492799">time</span><span class="op" id="492803">.</span><span class="ident" id="492804">Second</span><span class="op" id="492810">)</span><span class="op" id="492811">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="492816">t</span><span class="op" id="492817">.</span><span class="ident" id="492818">Error</span><span class="op" id="492823">(</span><span class="string" id="492824">&#34;body&nbsp;not&nbsp;closed&nbsp;after&nbsp;5s&#34;</span><span class="op" id="492850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="492855">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="492864">case</span>&nbsp;<span class="op" id="492869">&lt;-</span><span class="ident" id="492871">didReadAll</span><span class="op" id="492881">:</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="492885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="492888">}</span><span class="op" id="492889">(</span><span class="op" id="492890">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="492894">_</span><span class="op" id="492895">,</span>&nbsp;<span class="ident" id="492897">err</span>&nbsp;<span class="op" id="492901">=</span>&nbsp;<span class="ident" id="492903">ioutil</span><span class="op" id="492909">.</span><span class="ident" id="492910">ReadAll</span><span class="op" id="492917">(</span><span class="ident" id="492918">r</span><span class="op" id="492919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="492922">if</span>&nbsp;<span class="ident" id="492925">err</span>&nbsp;<span class="op" id="492929">!=</span>&nbsp;<span class="builtintype" id="492932">nil</span>&nbsp;<span class="op" id="492936">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="492940">t</span><span class="op" id="492941">.</span><span class="ident" id="492942">Fatal</span><span class="op" id="492947">(</span><span class="string" id="492948">&#34;read&nbsp;error:&#34;</span><span class="op" id="492961">,</span>&nbsp;<span class="ident" id="492963">err</span><span class="op" id="492966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="492969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="492972">didReadAll</span>&nbsp;<span class="op" id="492983">&lt;-</span>&nbsp;<span class="builtintype" id="492986">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="492993">if</span>&nbsp;<span class="op" id="492996">!</span><span class="ident" id="492997">res</span><span class="op" id="493000">.</span><span class="ident" id="493001">Close</span>&nbsp;<span class="op" id="493007">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="493011">t</span><span class="op" id="493012">.</span><span class="ident" id="493013">Errorf</span><span class="op" id="493019">(</span><span class="string" id="493020">&#34;Response.Close&nbsp;=&nbsp;false;&nbsp;want&nbsp;true&#34;</span><span class="op" id="493055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="493058">}</span><br>
<span class="lineno"></span><span class="op" id="493060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="493063">//&nbsp;TestServeHTTP10Close&nbsp;verifies&nbsp;that&nbsp;HTTP/1.0&nbsp;requests&nbsp;won&#39;t&nbsp;be&nbsp;kept&nbsp;alive.</span><br>
<span class="lineno">705</span><span class="keyword" id="493140">func</span>&nbsp;<span class="ident" id="493145">TestServeHTTP10Close</span><span class="op" id="493165">(</span><span class="ident" id="493166">t</span>&nbsp;<span class="op" id="493168">*</span><span class="ident" id="493169">testing</span><span class="op" id="493176">.</span><span class="ident" id="493177">T</span><span class="op" id="493178">)</span>&nbsp;<span class="op" id="493180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="493183">testTCPConnectionCloses</span><span class="op" id="493206">(</span><span class="ident" id="493207">t</span><span class="op" id="493208">,</span>&nbsp;<span class="string" id="493210">&#34;GET&nbsp;/&nbsp;HTTP/1.0\r\n\r\n&#34;</span><span class="op" id="493234">,</span>&nbsp;<span class="ident" id="493236">HandlerFunc</span><span class="op" id="493247">(</span><span class="keyword" id="493248">func</span><span class="op" id="493252">(</span><span class="ident" id="493253">w</span>&nbsp;<span class="ident" id="493255">ResponseWriter</span><span class="op" id="493269">,</span>&nbsp;<span class="ident" id="493271">r</span>&nbsp;<span class="op" id="493273">*</span><span class="ident" id="493274">Request</span><span class="op" id="493281">)</span>&nbsp;<span class="op" id="493283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="493287">ServeFile</span><span class="op" id="493296">(</span><span class="ident" id="493297">w</span><span class="op" id="493298">,</span>&nbsp;<span class="ident" id="493300">r</span><span class="op" id="493301">,</span>&nbsp;<span class="string" id="493303">&#34;testdata/file&#34;</span><span class="op" id="493318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="493321">}</span><span class="op" id="493322">)</span><span class="op" id="493323">)</span><br>
<span class="lineno"></span><span class="op" id="493325">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="493328">//&nbsp;TestClientCanClose&nbsp;verifies&nbsp;that&nbsp;clients&nbsp;can&nbsp;also&nbsp;force&nbsp;a&nbsp;connection&nbsp;to&nbsp;close.</span><br>
<span class="lineno"></span><span class="keyword" id="493410">func</span>&nbsp;<span class="ident" id="493415">TestClientCanClose</span><span class="op" id="493433">(</span><span class="ident" id="493434">t</span>&nbsp;<span class="op" id="493436">*</span><span class="ident" id="493437">testing</span><span class="op" id="493444">.</span><span class="ident" id="493445">T</span><span class="op" id="493446">)</span>&nbsp;<span class="op" id="493448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="493451">testTCPConnectionCloses</span><span class="op" id="493474">(</span><span class="ident" id="493475">t</span><span class="op" id="493476">,</span>&nbsp;<span class="string" id="493478">&#34;GET&nbsp;/&nbsp;HTTP/1.1\r\nConnection:&nbsp;close\r\n\r\n&#34;</span><span class="op" id="493523">,</span>&nbsp;<span class="ident" id="493525">HandlerFunc</span><span class="op" id="493536">(</span><span class="keyword" id="493537">func</span><span class="op" id="493541">(</span><span class="ident" id="493542">w</span>&nbsp;<span class="ident" id="493544">ResponseWriter</span><span class="op" id="493558">,</span>&nbsp;<span class="ident" id="493560">r</span>&nbsp;<span class="op" id="493562">*</span><span class="ident" id="493563">Request</span><span class="op" id="493570">)</span>&nbsp;<span class="op" id="493572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="493576">//&nbsp;Nothing.</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="493589">}</span><span class="op" id="493590">)</span><span class="op" id="493591">)</span><br>
<span class="lineno"></span><span class="op" id="493593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="493596">//&nbsp;TestHandlersCanSetConnectionClose&nbsp;verifies&nbsp;that&nbsp;handlers&nbsp;can&nbsp;force&nbsp;a&nbsp;connection&nbsp;to&nbsp;close,</span><br>
<span class="lineno"></span><span class="comment" id="493689">//&nbsp;even&nbsp;for&nbsp;HTTP/1.1&nbsp;requests.</span><br>
<span class="lineno">720</span><span class="keyword" id="493720">func</span>&nbsp;<span class="ident" id="493725">TestHandlersCanSetConnectionClose11</span><span class="op" id="493760">(</span><span class="ident" id="493761">t</span>&nbsp;<span class="op" id="493763">*</span><span class="ident" id="493764">testing</span><span class="op" id="493771">.</span><span class="ident" id="493772">T</span><span class="op" id="493773">)</span>&nbsp;<span class="op" id="493775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="493778">testTCPConnectionCloses</span><span class="op" id="493801">(</span><span class="ident" id="493802">t</span><span class="op" id="493803">,</span>&nbsp;<span class="string" id="493805">&#34;GET&nbsp;/&nbsp;HTTP/1.1\r\n\r\n&#34;</span><span class="op" id="493829">,</span>&nbsp;<span class="ident" id="493831">HandlerFunc</span><span class="op" id="493842">(</span><span class="keyword" id="493843">func</span><span class="op" id="493847">(</span><span class="ident" id="493848">w</span>&nbsp;<span class="ident" id="493850">ResponseWriter</span><span class="op" id="493864">,</span>&nbsp;<span class="ident" id="493866">r</span>&nbsp;<span class="op" id="493868">*</span><span class="ident" id="493869">Request</span><span class="op" id="493876">)</span>&nbsp;<span class="op" id="493878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="493882">w</span><span class="op" id="493883">.</span><span class="ident" id="493884">Header</span><span class="op" id="493890">(</span><span class="op" id="493891">)</span><span class="op" id="493892">.</span><span class="ident" id="493893">Set</span><span class="op" id="493896">(</span><span class="string" id="493897">&#34;Connection&#34;</span><span class="op" id="493909">,</span>&nbsp;<span class="string" id="493911">&#34;close&#34;</span><span class="op" id="493918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="493921">}</span><span class="op" id="493922">)</span><span class="op" id="493923">)</span><br>
<span class="lineno"></span><span class="op" id="493925">}</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="keyword" id="493928">func</span>&nbsp;<span class="ident" id="493933">TestHandlersCanSetConnectionClose10</span><span class="op" id="493968">(</span><span class="ident" id="493969">t</span>&nbsp;<span class="op" id="493971">*</span><span class="ident" id="493972">testing</span><span class="op" id="493979">.</span><span class="ident" id="493980">T</span><span class="op" id="493981">)</span>&nbsp;<span class="op" id="493983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="493986">testTCPConnectionCloses</span><span class="op" id="494009">(</span><span class="ident" id="494010">t</span><span class="op" id="494011">,</span>&nbsp;<span class="string" id="494013">&#34;GET&nbsp;/&nbsp;HTTP/1.0\r\nConnection:&nbsp;keep-alive\r\n\r\n&#34;</span><span class="op" id="494063">,</span>&nbsp;<span class="ident" id="494065">HandlerFunc</span><span class="op" id="494076">(</span><span class="keyword" id="494077">func</span><span class="op" id="494081">(</span><span class="ident" id="494082">w</span>&nbsp;<span class="ident" id="494084">ResponseWriter</span><span class="op" id="494098">,</span>&nbsp;<span class="ident" id="494100">r</span>&nbsp;<span class="op" id="494102">*</span><span class="ident" id="494103">Request</span><span class="op" id="494110">)</span>&nbsp;<span class="op" id="494112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="494116">w</span><span class="op" id="494117">.</span><span class="ident" id="494118">Header</span><span class="op" id="494124">(</span><span class="op" id="494125">)</span><span class="op" id="494126">.</span><span class="ident" id="494127">Set</span><span class="op" id="494130">(</span><span class="string" id="494131">&#34;Connection&#34;</span><span class="op" id="494143">,</span>&nbsp;<span class="string" id="494145">&#34;close&#34;</span><span class="op" id="494152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="494155">}</span><span class="op" id="494156">)</span><span class="op" id="494157">)</span><br>
<span class="lineno">730</span><span class="op" id="494159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="494162">func</span>&nbsp;<span class="ident" id="494167">TestSetsRemoteAddr</span><span class="op" id="494185">(</span><span class="ident" id="494186">t</span>&nbsp;<span class="op" id="494188">*</span><span class="ident" id="494189">testing</span><span class="op" id="494196">.</span><span class="ident" id="494197">T</span><span class="op" id="494198">)</span>&nbsp;<span class="op" id="494200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="494203">defer</span>&nbsp;<span class="ident" id="494209">afterTest</span><span class="op" id="494218">(</span><span class="ident" id="494219">t</span><span class="op" id="494220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="494223">ts</span>&nbsp;<span class="op" id="494226">:=</span>&nbsp;<span class="ident" id="494229">httptest</span><span class="op" id="494237">.</span><span class="ident" id="494238">NewServer</span><span class="op" id="494247">(</span><span class="ident" id="494248">HandlerFunc</span><span class="op" id="494259">(</span><span class="keyword" id="494260">func</span><span class="op" id="494264">(</span><span class="ident" id="494265">w</span>&nbsp;<span class="ident" id="494267">ResponseWriter</span><span class="op" id="494281">,</span>&nbsp;<span class="ident" id="494283">r</span>&nbsp;<span class="op" id="494285">*</span><span class="ident" id="494286">Request</span><span class="op" id="494293">)</span>&nbsp;<span class="op" id="494295">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="494299">fmt</span><span class="op" id="494302">.</span><span class="ident" id="494303">Fprintf</span><span class="op" id="494310">(</span><span class="ident" id="494311">w</span><span class="op" id="494312">,</span>&nbsp;<span class="string" id="494314">&#34;%s&#34;</span><span class="op" id="494318">,</span>&nbsp;<span class="ident" id="494320">r</span><span class="op" id="494321">.</span><span class="ident" id="494322">RemoteAddr</span><span class="op" id="494332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="494335">}</span><span class="op" id="494336">)</span><span class="op" id="494337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="494340">defer</span>&nbsp;<span class="ident" id="494346">ts</span><span class="op" id="494348">.</span><span class="ident" id="494349">Close</span><span class="op" id="494354">(</span><span class="op" id="494355">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="494359">res</span><span class="op" id="494362">,</span>&nbsp;<span class="ident" id="494364">err</span>&nbsp;<span class="op" id="494368">:=</span>&nbsp;<span class="ident" id="494371">Get</span><span class="op" id="494374">(</span><span class="ident" id="494375">ts</span><span class="op" id="494377">.</span><span class="ident" id="494378">URL</span><span class="op" id="494381">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="494384">if</span>&nbsp;<span class="ident" id="494387">err</span>&nbsp;<span class="op" id="494391">!=</span>&nbsp;<span class="builtintype" id="494394">nil</span>&nbsp;<span class="op" id="494398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="494402">t</span><span class="op" id="494403">.</span><span class="ident" id="494404">Fatalf</span><span class="op" id="494410">(</span><span class="string" id="494411">&#34;Get&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="494426">,</span>&nbsp;<span class="ident" id="494428">err</span><span class="op" id="494431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="494434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="494437">body</span><span class="op" id="494441">,</span>&nbsp;<span class="ident" id="494443">err</span>&nbsp;<span class="op" id="494447">:=</span>&nbsp;<span class="ident" id="494450">ioutil</span><span class="op" id="494456">.</span><span class="ident" id="494457">ReadAll</span><span class="op" id="494464">(</span><span class="ident" id="494465">res</span><span class="op" id="494468">.</span><span class="ident" id="494469">Body</span><span class="op" id="494473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="494476">if</span>&nbsp;<span class="ident" id="494479">err</span>&nbsp;<span class="op" id="494483">!=</span>&nbsp;<span class="builtintype" id="494486">nil</span>&nbsp;<span class="op" id="494490">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="494494">t</span><span class="op" id="494495">.</span><span class="ident" id="494496">Fatalf</span><span class="op" id="494502">(</span><span class="string" id="494503">&#34;ReadAll&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="494522">,</span>&nbsp;<span class="ident" id="494524">err</span><span class="op" id="494527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="494530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="494533">ip</span>&nbsp;<span class="op" id="494536">:=</span>&nbsp;<span class="builtintype" id="494539">string</span><span class="op" id="494545">(</span><span class="ident" id="494546">body</span><span class="op" id="494550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="494553">if</span>&nbsp;<span class="op" id="494556">!</span><span class="ident" id="494557">strings</span><span class="op" id="494564">.</span><span class="ident" id="494565">HasPrefix</span><span class="op" id="494574">(</span><span class="ident" id="494575">ip</span><span class="op" id="494577">,</span>&nbsp;<span class="string" id="494579">&#34;127.0.0.1:&#34;</span><span class="op" id="494591">)</span>&nbsp;<span class="op" id="494593">&amp;&amp;</span>&nbsp;<span class="op" id="494596">!</span><span class="ident" id="494597">strings</span><span class="op" id="494604">.</span><span class="ident" id="494605">HasPrefix</span><span class="op" id="494614">(</span><span class="ident" id="494615">ip</span><span class="op" id="494617">,</span>&nbsp;<span class="string" id="494619">&#34;[::1]:&#34;</span><span class="op" id="494627">)</span>&nbsp;<span class="op" id="494629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="494633">t</span><span class="op" id="494634">.</span><span class="ident" id="494635">Fatalf</span><span class="op" id="494641">(</span><span class="string" id="494642">&#34;Expected&nbsp;local&nbsp;addr;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="494671">,</span>&nbsp;<span class="ident" id="494673">ip</span><span class="op" id="494675">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="494678">}</span><br>
<span class="lineno"></span><span class="op" id="494680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="494683">func</span>&nbsp;<span class="ident" id="494688">TestChunkedResponseHeaders</span><span class="op" id="494714">(</span><span class="ident" id="494715">t</span>&nbsp;<span class="op" id="494717">*</span><span class="ident" id="494718">testing</span><span class="op" id="494725">.</span><span class="ident" id="494726">T</span><span class="op" id="494727">)</span>&nbsp;<span class="op" id="494729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="494732">defer</span>&nbsp;<span class="ident" id="494738">afterTest</span><span class="op" id="494747">(</span><span class="ident" id="494748">t</span><span class="op" id="494749">)</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="494752">log</span><span class="op" id="494755">.</span><span class="ident" id="494756">SetOutput</span><span class="op" id="494765">(</span><span class="ident" id="494766">ioutil</span><span class="op" id="494772">.</span><span class="ident" id="494773">Discard</span><span class="op" id="494780">)</span>&nbsp;<span class="comment" id="494782">//&nbsp;is&nbsp;noisy&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="494805">defer</span>&nbsp;<span class="ident" id="494811">log</span><span class="op" id="494814">.</span><span class="ident" id="494815">SetOutput</span><span class="op" id="494824">(</span><span class="ident" id="494825">os</span><span class="op" id="494827">.</span><span class="ident" id="494828">Stderr</span><span class="op" id="494834">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="494838">ts</span>&nbsp;<span class="op" id="494841">:=</span>&nbsp;<span class="ident" id="494844">httptest</span><span class="op" id="494852">.</span><span class="ident" id="494853">NewServer</span><span class="op" id="494862">(</span><span class="ident" id="494863">HandlerFunc</span><span class="op" id="494874">(</span><span class="keyword" id="494875">func</span><span class="op" id="494879">(</span><span class="ident" id="494880">w</span>&nbsp;<span class="ident" id="494882">ResponseWriter</span><span class="op" id="494896">,</span>&nbsp;<span class="ident" id="494898">r</span>&nbsp;<span class="op" id="494900">*</span><span class="ident" id="494901">Request</span><span class="op" id="494908">)</span>&nbsp;<span class="op" id="494910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="494914">w</span><span class="op" id="494915">.</span><span class="ident" id="494916">Header</span><span class="op" id="494922">(</span><span class="op" id="494923">)</span><span class="op" id="494924">.</span><span class="ident" id="494925">Set</span><span class="op" id="494928">(</span><span class="string" id="494929">&#34;Content-Length&#34;</span><span class="op" id="494945">,</span>&nbsp;<span class="string" id="494947">&#34;intentional&nbsp;gibberish&#34;</span><span class="op" id="494970">)</span>&nbsp;<span class="comment" id="494972">//&nbsp;we&nbsp;check&nbsp;that&nbsp;this&nbsp;is&nbsp;deleted</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="495007">w</span><span class="op" id="495008">.</span><span class="op" id="495009">(</span><span class="ident" id="495010">Flusher</span><span class="op" id="495017">)</span><span class="op" id="495018">.</span><span class="ident" id="495019">Flush</span><span class="op" id="495024">(</span><span class="op" id="495025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="495029">fmt</span><span class="op" id="495032">.</span><span class="ident" id="495033">Fprintf</span><span class="op" id="495040">(</span><span class="ident" id="495041">w</span><span class="op" id="495042">,</span>&nbsp;<span class="string" id="495044">&#34;I&nbsp;am&nbsp;a&nbsp;chunked&nbsp;response.&#34;</span><span class="op" id="495070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="495073">}</span><span class="op" id="495074">)</span><span class="op" id="495075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="495078">defer</span>&nbsp;<span class="ident" id="495084">ts</span><span class="op" id="495086">.</span><span class="ident" id="495087">Close</span><span class="op" id="495092">(</span><span class="op" id="495093">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="495097">res</span><span class="op" id="495100">,</span>&nbsp;<span class="ident" id="495102">err</span>&nbsp;<span class="op" id="495106">:=</span>&nbsp;<span class="ident" id="495109">Get</span><span class="op" id="495112">(</span><span class="ident" id="495113">ts</span><span class="op" id="495115">.</span><span class="ident" id="495116">URL</span><span class="op" id="495119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="495122">if</span>&nbsp;<span class="ident" id="495125">err</span>&nbsp;<span class="op" id="495129">!=</span>&nbsp;<span class="builtintype" id="495132">nil</span>&nbsp;<span class="op" id="495136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="495140">t</span><span class="op" id="495141">.</span><span class="ident" id="495142">Fatalf</span><span class="op" id="495148">(</span><span class="string" id="495149">&#34;Get&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="495164">,</span>&nbsp;<span class="ident" id="495166">err</span><span class="op" id="495169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="495172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="495175">defer</span>&nbsp;<span class="ident" id="495181">res</span><span class="op" id="495184">.</span><span class="ident" id="495185">Body</span><span class="op" id="495189">.</span><span class="ident" id="495190">Close</span><span class="op" id="495195">(</span><span class="op" id="495196">)</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="495199">if</span>&nbsp;<span class="ident" id="495202">g</span><span class="op" id="495203">,</span>&nbsp;<span class="ident" id="495205">e</span>&nbsp;<span class="op" id="495207">:=</span>&nbsp;<span class="ident" id="495210">res</span><span class="op" id="495213">.</span><span class="ident" id="495214">ContentLength</span><span class="op" id="495227">,</span>&nbsp;<span class="ident" id="495229">int64</span><span class="op" id="495234">(</span><span class="op" id="495235">-</span><span class="num" id="495236">1</span><span class="op" id="495237">)</span><span class="op" id="495238">;</span>&nbsp;<span class="ident" id="495240">g</span>&nbsp;<span class="op" id="495242">!=</span>&nbsp;<span class="ident" id="495245">e</span>&nbsp;<span class="op" id="495247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="495251">t</span><span class="op" id="495252">.</span><span class="ident" id="495253">Errorf</span><span class="op" id="495259">(</span><span class="string" id="495260">&#34;expected&nbsp;ContentLength&nbsp;of&nbsp;%d;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="495298">,</span>&nbsp;<span class="ident" id="495300">e</span><span class="op" id="495301">,</span>&nbsp;<span class="ident" id="495303">g</span><span class="op" id="495304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="495307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="495310">if</span>&nbsp;<span class="ident" id="495313">g</span><span class="op" id="495314">,</span>&nbsp;<span class="ident" id="495316">e</span>&nbsp;<span class="op" id="495318">:=</span>&nbsp;<span class="ident" id="495321">res</span><span class="op" id="495324">.</span><span class="ident" id="495325">TransferEncoding</span><span class="op" id="495341">,</span>&nbsp;<span class="op" id="495343">[</span><span class="op" id="495344">]</span><span class="builtintype" id="495345">string</span><span class="op" id="495351">{</span><span class="string" id="495352">&#34;chunked&#34;</span><span class="op" id="495361">}</span><span class="op" id="495362">;</span>&nbsp;<span class="op" id="495364">!</span><span class="ident" id="495365">reflect</span><span class="op" id="495372">.</span><span class="ident" id="495373">DeepEqual</span><span class="op" id="495382">(</span><span class="ident" id="495383">g</span><span class="op" id="495384">,</span>&nbsp;<span class="ident" id="495386">e</span><span class="op" id="495387">)</span>&nbsp;<span class="op" id="495389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="495393">t</span><span class="op" id="495394">.</span><span class="ident" id="495395">Errorf</span><span class="op" id="495401">(</span><span class="string" id="495402">&#34;expected&nbsp;TransferEncoding&nbsp;of&nbsp;%v;&nbsp;got&nbsp;%v&#34;</span><span class="op" id="495443">,</span>&nbsp;<span class="ident" id="495445">e</span><span class="op" id="495446">,</span>&nbsp;<span class="ident" id="495448">g</span><span class="op" id="495449">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="495452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="495455">if</span>&nbsp;<span class="ident" id="495458">_</span><span class="op" id="495459">,</span>&nbsp;<span class="ident" id="495461">haveCL</span>&nbsp;<span class="op" id="495468">:=</span>&nbsp;<span class="ident" id="495471">res</span><span class="op" id="495474">.</span><span class="ident" id="495475">Header</span><span class="op" id="495481">[</span><span class="string" id="495482">&#34;Content-Length&#34;</span><span class="op" id="495498">]</span><span class="op" id="495499">;</span>&nbsp;<span class="ident" id="495501">haveCL</span>&nbsp;<span class="op" id="495508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="495512">t</span><span class="op" id="495513">.</span><span class="ident" id="495514">Errorf</span><span class="op" id="495520">(</span><span class="string" id="495521">&#34;Unexpected&nbsp;Content-Length&#34;</span><span class="op" id="495548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="495551">}</span><br>
<span class="lineno"></span><span class="op" id="495553">}</span><br>
<span class="lineno">780</span><br>
<span class="lineno"></span><span class="keyword" id="495556">func</span>&nbsp;<span class="ident" id="495561">TestIdentityResponseHeaders</span><span class="op" id="495588">(</span><span class="ident" id="495589">t</span>&nbsp;<span class="op" id="495591">*</span><span class="ident" id="495592">testing</span><span class="op" id="495599">.</span><span class="ident" id="495600">T</span><span class="op" id="495601">)</span>&nbsp;<span class="op" id="495603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="495606">defer</span>&nbsp;<span class="ident" id="495612">afterTest</span><span class="op" id="495621">(</span><span class="ident" id="495622">t</span><span class="op" id="495623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="495626">log</span><span class="op" id="495629">.</span><span class="ident" id="495630">SetOutput</span><span class="op" id="495639">(</span><span class="ident" id="495640">ioutil</span><span class="op" id="495646">.</span><span class="ident" id="495647">Discard</span><span class="op" id="495654">)</span>&nbsp;<span class="comment" id="495656">//&nbsp;is&nbsp;noisy&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="495679">defer</span>&nbsp;<span class="ident" id="495685">log</span><span class="op" id="495688">.</span><span class="ident" id="495689">SetOutput</span><span class="op" id="495698">(</span><span class="ident" id="495699">os</span><span class="op" id="495701">.</span><span class="ident" id="495702">Stderr</span><span class="op" id="495708">)</span><br>
<span class="lineno">785</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="495712">ts</span>&nbsp;<span class="op" id="495715">:=</span>&nbsp;<span class="ident" id="495718">httptest</span><span class="op" id="495726">.</span><span class="ident" id="495727">NewServer</span><span class="op" id="495736">(</span><span class="ident" id="495737">HandlerFunc</span><span class="op" id="495748">(</span><span class="keyword" id="495749">func</span><span class="op" id="495753">(</span><span class="ident" id="495754">w</span>&nbsp;<span class="ident" id="495756">ResponseWriter</span><span class="op" id="495770">,</span>&nbsp;<span class="ident" id="495772">r</span>&nbsp;<span class="op" id="495774">*</span><span class="ident" id="495775">Request</span><span class="op" id="495782">)</span>&nbsp;<span class="op" id="495784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="495788">w</span><span class="op" id="495789">.</span><span class="ident" id="495790">Header</span><span class="op" id="495796">(</span><span class="op" id="495797">)</span><span class="op" id="495798">.</span><span class="ident" id="495799">Set</span><span class="op" id="495802">(</span><span class="string" id="495803">&#34;Transfer-Encoding&#34;</span><span class="op" id="495822">,</span>&nbsp;<span class="string" id="495824">&#34;identity&#34;</span><span class="op" id="495834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="495838">w</span><span class="op" id="495839">.</span><span class="op" id="495840">(</span><span class="ident" id="495841">Flusher</span><span class="op" id="495848">)</span><span class="op" id="495849">.</span><span class="ident" id="495850">Flush</span><span class="op" id="495855">(</span><span class="op" id="495856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="495860">fmt</span><span class="op" id="495863">.</span><span class="ident" id="495864">Fprintf</span><span class="op" id="495871">(</span><span class="ident" id="495872">w</span><span class="op" id="495873">,</span>&nbsp;<span class="string" id="495875">&#34;I&nbsp;am&nbsp;an&nbsp;identity&nbsp;response.&#34;</span><span class="op" id="495903">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="495906">}</span><span class="op" id="495907">)</span><span class="op" id="495908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="495911">defer</span>&nbsp;<span class="ident" id="495917">ts</span><span class="op" id="495919">.</span><span class="ident" id="495920">Close</span><span class="op" id="495925">(</span><span class="op" id="495926">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="495930">res</span><span class="op" id="495933">,</span>&nbsp;<span class="ident" id="495935">err</span>&nbsp;<span class="op" id="495939">:=</span>&nbsp;<span class="ident" id="495942">Get</span><span class="op" id="495945">(</span><span class="ident" id="495946">ts</span><span class="op" id="495948">.</span><span class="ident" id="495949">URL</span><span class="op" id="495952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="495955">if</span>&nbsp;<span class="ident" id="495958">err</span>&nbsp;<span class="op" id="495962">!=</span>&nbsp;<span class="builtintype" id="495965">nil</span>&nbsp;<span class="op" id="495969">{</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="495973">t</span><span class="op" id="495974">.</span><span class="ident" id="495975">Fatalf</span><span class="op" id="495981">(</span><span class="string" id="495982">&#34;Get&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="495997">,</span>&nbsp;<span class="ident" id="495999">err</span><span class="op" id="496002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="496005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="496008">defer</span>&nbsp;<span class="ident" id="496014">res</span><span class="op" id="496017">.</span><span class="ident" id="496018">Body</span><span class="op" id="496022">.</span><span class="ident" id="496023">Close</span><span class="op" id="496028">(</span><span class="op" id="496029">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="496033">if</span>&nbsp;<span class="ident" id="496036">g</span><span class="op" id="496037">,</span>&nbsp;<span class="ident" id="496039">e</span>&nbsp;<span class="op" id="496041">:=</span>&nbsp;<span class="ident" id="496044">res</span><span class="op" id="496047">.</span><span class="ident" id="496048">TransferEncoding</span><span class="op" id="496064">,</span>&nbsp;<span class="op" id="496066">[</span><span class="op" id="496067">]</span><span class="builtintype" id="496068">string</span><span class="op" id="496074">(</span><span class="builtintype" id="496075">nil</span><span class="op" id="496078">)</span><span class="op" id="496079">;</span>&nbsp;<span class="op" id="496081">!</span><span class="ident" id="496082">reflect</span><span class="op" id="496089">.</span><span class="ident" id="496090">DeepEqual</span><span class="op" id="496099">(</span><span class="ident" id="496100">g</span><span class="op" id="496101">,</span>&nbsp;<span class="ident" id="496103">e</span><span class="op" id="496104">)</span>&nbsp;<span class="op" id="496106">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="496110">t</span><span class="op" id="496111">.</span><span class="ident" id="496112">Errorf</span><span class="op" id="496118">(</span><span class="string" id="496119">&#34;expected&nbsp;TransferEncoding&nbsp;of&nbsp;%v;&nbsp;got&nbsp;%v&#34;</span><span class="op" id="496160">,</span>&nbsp;<span class="ident" id="496162">e</span><span class="op" id="496163">,</span>&nbsp;<span class="ident" id="496165">g</span><span class="op" id="496166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="496169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="496172">if</span>&nbsp;<span class="ident" id="496175">_</span><span class="op" id="496176">,</span>&nbsp;<span class="ident" id="496178">haveCL</span>&nbsp;<span class="op" id="496185">:=</span>&nbsp;<span class="ident" id="496188">res</span><span class="op" id="496191">.</span><span class="ident" id="496192">Header</span><span class="op" id="496198">[</span><span class="string" id="496199">&#34;Content-Length&#34;</span><span class="op" id="496215">]</span><span class="op" id="496216">;</span>&nbsp;<span class="ident" id="496218">haveCL</span>&nbsp;<span class="op" id="496225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="496229">t</span><span class="op" id="496230">.</span><span class="ident" id="496231">Errorf</span><span class="op" id="496237">(</span><span class="string" id="496238">&#34;Unexpected&nbsp;Content-Length&#34;</span><span class="op" id="496265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="496268">}</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="496271">if</span>&nbsp;<span class="op" id="496274">!</span><span class="ident" id="496275">res</span><span class="op" id="496278">.</span><span class="ident" id="496279">Close</span>&nbsp;<span class="op" id="496285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="496289">t</span><span class="op" id="496290">.</span><span class="ident" id="496291">Errorf</span><span class="op" id="496297">(</span><span class="string" id="496298">&#34;expected&nbsp;Connection:&nbsp;close;&nbsp;got&nbsp;%v&#34;</span><span class="op" id="496334">,</span>&nbsp;<span class="ident" id="496336">res</span><span class="op" id="496339">.</span><span class="ident" id="496340">Close</span><span class="op" id="496345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="496348">}</span><br>
<span class="lineno"></span><span class="op" id="496350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span><span class="comment" id="496353">//&nbsp;Test304Responses&nbsp;verifies&nbsp;that&nbsp;304s&nbsp;don&#39;t&nbsp;declare&nbsp;that&nbsp;they&#39;re</span><br>
<span class="lineno"></span><span class="comment" id="496419">//&nbsp;chunking&nbsp;in&nbsp;their&nbsp;response&nbsp;headers&nbsp;and&nbsp;aren&#39;t&nbsp;allowed&nbsp;to&nbsp;produce</span><br>
<span class="lineno"></span><span class="comment" id="496487">//&nbsp;output.</span><br>
<span class="lineno"></span><span class="keyword" id="496498">func</span>&nbsp;<span class="ident" id="496503">Test304Responses</span><span class="op" id="496519">(</span><span class="ident" id="496520">t</span>&nbsp;<span class="op" id="496522">*</span><span class="ident" id="496523">testing</span><span class="op" id="496530">.</span><span class="ident" id="496531">T</span><span class="op" id="496532">)</span>&nbsp;<span class="op" id="496534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="496537">defer</span>&nbsp;<span class="ident" id="496543">afterTest</span><span class="op" id="496552">(</span><span class="ident" id="496553">t</span><span class="op" id="496554">)</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="496557">ts</span>&nbsp;<span class="op" id="496560">:=</span>&nbsp;<span class="ident" id="496563">httptest</span><span class="op" id="496571">.</span><span class="ident" id="496572">NewServer</span><span class="op" id="496581">(</span><span class="ident" id="496582">HandlerFunc</span><span class="op" id="496593">(</span><span class="keyword" id="496594">func</span><span class="op" id="496598">(</span><span class="ident" id="496599">w</span>&nbsp;<span class="ident" id="496601">ResponseWriter</span><span class="op" id="496615">,</span>&nbsp;<span class="ident" id="496617">r</span>&nbsp;<span class="op" id="496619">*</span><span class="ident" id="496620">Request</span><span class="op" id="496627">)</span>&nbsp;<span class="op" id="496629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="496633">w</span><span class="op" id="496634">.</span><span class="ident" id="496635">WriteHeader</span><span class="op" id="496646">(</span><span class="ident" id="496647">StatusNotModified</span><span class="op" id="496664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="496668">_</span><span class="op" id="496669">,</span>&nbsp;<span class="ident" id="496671">err</span>&nbsp;<span class="op" id="496675">:=</span>&nbsp;<span class="ident" id="496678">w</span><span class="op" id="496679">.</span><span class="ident" id="496680">Write</span><span class="op" id="496685">(</span><span class="op" id="496686">[</span><span class="op" id="496687">]</span><span class="builtintype" id="496688">byte</span><span class="op" id="496692">(</span><span class="string" id="496693">&#34;illegal&nbsp;body&#34;</span><span class="op" id="496707">)</span><span class="op" id="496708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="496712">if</span>&nbsp;<span class="ident" id="496715">err</span>&nbsp;<span class="op" id="496719">!=</span>&nbsp;<span class="ident" id="496722">ErrBodyNotAllowed</span>&nbsp;<span class="op" id="496740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="496745">t</span><span class="op" id="496746">.</span><span class="ident" id="496747">Errorf</span><span class="op" id="496753">(</span><span class="string" id="496754">&#34;on&nbsp;Write,&nbsp;expected&nbsp;ErrBodyNotAllowed,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="496800">,</span>&nbsp;<span class="ident" id="496802">err</span><span class="op" id="496805">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="496809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="496812">}</span><span class="op" id="496813">)</span><span class="op" id="496814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="496817">defer</span>&nbsp;<span class="ident" id="496823">ts</span><span class="op" id="496825">.</span><span class="ident" id="496826">Close</span><span class="op" id="496831">(</span><span class="op" id="496832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="496835">res</span><span class="op" id="496838">,</span>&nbsp;<span class="ident" id="496840">err</span>&nbsp;<span class="op" id="496844">:=</span>&nbsp;<span class="ident" id="496847">Get</span><span class="op" id="496850">(</span><span class="ident" id="496851">ts</span><span class="op" id="496853">.</span><span class="ident" id="496854">URL</span><span class="op" id="496857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="496860">if</span>&nbsp;<span class="ident" id="496863">err</span>&nbsp;<span class="op" id="496867">!=</span>&nbsp;<span class="builtintype" id="496870">nil</span>&nbsp;<span class="op" id="496874">{</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="496878">t</span><span class="op" id="496879">.</span><span class="ident" id="496880">Error</span><span class="op" id="496885">(</span><span class="ident" id="496886">err</span><span class="op" id="496889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="496892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="496895">if</span>&nbsp;<span class="builtinfunc" id="496898">len</span><span class="op" id="496901">(</span><span class="ident" id="496902">res</span><span class="op" id="496905">.</span><span class="ident" id="496906">TransferEncoding</span><span class="op" id="496922">)</span>&nbsp;<span class="op" id="496924">&gt;</span>&nbsp;<span class="num" id="496926">0</span>&nbsp;<span class="op" id="496928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="496932">t</span><span class="op" id="496933">.</span><span class="ident" id="496934">Errorf</span><span class="op" id="496940">(</span><span class="string" id="496941">&#34;expected&nbsp;no&nbsp;TransferEncoding;&nbsp;got&nbsp;%v&#34;</span><span class="op" id="496979">,</span>&nbsp;<span class="ident" id="496981">res</span><span class="op" id="496984">.</span><span class="ident" id="496985">TransferEncoding</span><span class="op" id="497001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="497004">}</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="497007">body</span><span class="op" id="497011">,</span>&nbsp;<span class="ident" id="497013">err</span>&nbsp;<span class="op" id="497017">:=</span>&nbsp;<span class="ident" id="497020">ioutil</span><span class="op" id="497026">.</span><span class="ident" id="497027">ReadAll</span><span class="op" id="497034">(</span><span class="ident" id="497035">res</span><span class="op" id="497038">.</span><span class="ident" id="497039">Body</span><span class="op" id="497043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="497046">if</span>&nbsp;<span class="ident" id="497049">err</span>&nbsp;<span class="op" id="497053">!=</span>&nbsp;<span class="builtintype" id="497056">nil</span>&nbsp;<span class="op" id="497060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="497064">t</span><span class="op" id="497065">.</span><span class="ident" id="497066">Error</span><span class="op" id="497071">(</span><span class="ident" id="497072">err</span><span class="op" id="497075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="497078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="497081">if</span>&nbsp;<span class="builtinfunc" id="497084">len</span><span class="op" id="497087">(</span><span class="ident" id="497088">body</span><span class="op" id="497092">)</span>&nbsp;<span class="op" id="497094">&gt;</span>&nbsp;<span class="num" id="497096">0</span>&nbsp;<span class="op" id="497098">{</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="497102">t</span><span class="op" id="497103">.</span><span class="ident" id="497104">Errorf</span><span class="op" id="497110">(</span><span class="string" id="497111">&#34;got&nbsp;unexpected&nbsp;body&nbsp;%q&#34;</span><span class="op" id="497135">,</span>&nbsp;<span class="builtintype" id="497137">string</span><span class="op" id="497143">(</span><span class="ident" id="497144">body</span><span class="op" id="497148">)</span><span class="op" id="497149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="497152">}</span><br>
<span class="lineno"></span><span class="op" id="497154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="497157">//&nbsp;TestHeadResponses&nbsp;verifies&nbsp;that&nbsp;all&nbsp;MIME&nbsp;type&nbsp;sniffing&nbsp;and&nbsp;Content-Length</span><br>
<span class="lineno">840</span><span class="comment" id="497234">//&nbsp;counting&nbsp;of&nbsp;GET&nbsp;requests&nbsp;also&nbsp;happens&nbsp;on&nbsp;HEAD&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="497293">func</span>&nbsp;<span class="ident" id="497298">TestHeadResponses</span><span class="op" id="497315">(</span><span class="ident" id="497316">t</span>&nbsp;<span class="op" id="497318">*</span><span class="ident" id="497319">testing</span><span class="op" id="497326">.</span><span class="ident" id="497327">T</span><span class="op" id="497328">)</span>&nbsp;<span class="op" id="497330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="497333">defer</span>&nbsp;<span class="ident" id="497339">afterTest</span><span class="op" id="497348">(</span><span class="ident" id="497349">t</span><span class="op" id="497350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="497353">ts</span>&nbsp;<span class="op" id="497356">:=</span>&nbsp;<span class="ident" id="497359">httptest</span><span class="op" id="497367">.</span><span class="ident" id="497368">NewServer</span><span class="op" id="497377">(</span><span class="ident" id="497378">HandlerFunc</span><span class="op" id="497389">(</span><span class="keyword" id="497390">func</span><span class="op" id="497394">(</span><span class="ident" id="497395">w</span>&nbsp;<span class="ident" id="497397">ResponseWriter</span><span class="op" id="497411">,</span>&nbsp;<span class="ident" id="497413">r</span>&nbsp;<span class="op" id="497415">*</span><span class="ident" id="497416">Request</span><span class="op" id="497423">)</span>&nbsp;<span class="op" id="497425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="497429">_</span><span class="op" id="497430">,</span>&nbsp;<span class="ident" id="497432">err</span>&nbsp;<span class="op" id="497436">:=</span>&nbsp;<span class="ident" id="497439">w</span><span class="op" id="497440">.</span><span class="ident" id="497441">Write</span><span class="op" id="497446">(</span><span class="op" id="497447">[</span><span class="op" id="497448">]</span><span class="builtintype" id="497449">byte</span><span class="op" id="497453">(</span><span class="string" id="497454">&#34;&lt;html&gt;&#34;</span><span class="op" id="497462">)</span><span class="op" id="497463">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="497467">if</span>&nbsp;<span class="ident" id="497470">err</span>&nbsp;<span class="op" id="497474">!=</span>&nbsp;<span class="builtintype" id="497477">nil</span>&nbsp;<span class="op" id="497481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="497486">t</span><span class="op" id="497487">.</span><span class="ident" id="497488">Errorf</span><span class="op" id="497494">(</span><span class="string" id="497495">&#34;ResponseWriter.Write:&nbsp;%v&#34;</span><span class="op" id="497521">,</span>&nbsp;<span class="ident" id="497523">err</span><span class="op" id="497526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="497530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="497535">//&nbsp;Also&nbsp;exercise&nbsp;the&nbsp;ReaderFrom&nbsp;path</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="497574">_</span><span class="op" id="497575">,</span>&nbsp;<span class="ident" id="497577">err</span>&nbsp;<span class="op" id="497581">=</span>&nbsp;<span class="ident" id="497583">io</span><span class="op" id="497585">.</span><span class="ident" id="497586">Copy</span><span class="op" id="497590">(</span><span class="ident" id="497591">w</span><span class="op" id="497592">,</span>&nbsp;<span class="ident" id="497594">strings</span><span class="op" id="497601">.</span><span class="ident" id="497602">NewReader</span><span class="op" id="497611">(</span><span class="string" id="497612">&#34;789a&#34;</span><span class="op" id="497618">)</span><span class="op" id="497619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="497623">if</span>&nbsp;<span class="ident" id="497626">err</span>&nbsp;<span class="op" id="497630">!=</span>&nbsp;<span class="builtintype" id="497633">nil</span>&nbsp;<span class="op" id="497637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="497642">t</span><span class="op" id="497643">.</span><span class="ident" id="497644">Errorf</span><span class="op" id="497650">(</span><span class="string" id="497651">&#34;Copy(ResponseWriter,&nbsp;...):&nbsp;%v&#34;</span><span class="op" id="497682">,</span>&nbsp;<span class="ident" id="497684">err</span><span class="op" id="497687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="497691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="497694">}</span><span class="op" id="497695">)</span><span class="op" id="497696">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="497699">defer</span>&nbsp;<span class="ident" id="497705">ts</span><span class="op" id="497707">.</span><span class="ident" id="497708">Close</span><span class="op" id="497713">(</span><span class="op" id="497714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="497717">res</span><span class="op" id="497720">,</span>&nbsp;<span class="ident" id="497722">err</span>&nbsp;<span class="op" id="497726">:=</span>&nbsp;<span class="ident" id="497729">Head</span><span class="op" id="497733">(</span><span class="ident" id="497734">ts</span><span class="op" id="497736">.</span><span class="ident" id="497737">URL</span><span class="op" id="497740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="497743">if</span>&nbsp;<span class="ident" id="497746">err</span>&nbsp;<span class="op" id="497750">!=</span>&nbsp;<span class="builtintype" id="497753">nil</span>&nbsp;<span class="op" id="497757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="497761">t</span><span class="op" id="497762">.</span><span class="ident" id="497763">Error</span><span class="op" id="497768">(</span><span class="ident" id="497769">err</span><span class="op" id="497772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="497775">}</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="497778">if</span>&nbsp;<span class="builtinfunc" id="497781">len</span><span class="op" id="497784">(</span><span class="ident" id="497785">res</span><span class="op" id="497788">.</span><span class="ident" id="497789">TransferEncoding</span><span class="op" id="497805">)</span>&nbsp;<span class="op" id="497807">&gt;</span>&nbsp;<span class="num" id="497809">0</span>&nbsp;<span class="op" id="497811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="497815">t</span><span class="op" id="497816">.</span><span class="ident" id="497817">Errorf</span><span class="op" id="497823">(</span><span class="string" id="497824">&#34;expected&nbsp;no&nbsp;TransferEncoding;&nbsp;got&nbsp;%v&#34;</span><span class="op" id="497862">,</span>&nbsp;<span class="ident" id="497864">res</span><span class="op" id="497867">.</span><span class="ident" id="497868">TransferEncoding</span><span class="op" id="497884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="497887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="497890">if</span>&nbsp;<span class="ident" id="497893">ct</span>&nbsp;<span class="op" id="497896">:=</span>&nbsp;<span class="ident" id="497899">res</span><span class="op" id="497902">.</span><span class="ident" id="497903">Header</span><span class="op" id="497909">.</span><span class="ident" id="497910">Get</span><span class="op" id="497913">(</span><span class="string" id="497914">&#34;Content-Type&#34;</span><span class="op" id="497928">)</span><span class="op" id="497929">;</span>&nbsp;<span class="ident" id="497931">ct</span>&nbsp;<span class="op" id="497934">!=</span>&nbsp;<span class="string" id="497937">&#34;text/html;&nbsp;charset=utf-8&#34;</span>&nbsp;<span class="op" id="497964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="497968">t</span><span class="op" id="497969">.</span><span class="ident" id="497970">Errorf</span><span class="op" id="497976">(</span><span class="string" id="497977">&#34;Content-Type:&nbsp;%q;&nbsp;want&nbsp;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="498026">,</span>&nbsp;<span class="ident" id="498028">ct</span><span class="op" id="498030">)</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="498033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="498036">if</span>&nbsp;<span class="ident" id="498039">v</span>&nbsp;<span class="op" id="498041">:=</span>&nbsp;<span class="ident" id="498044">res</span><span class="op" id="498047">.</span><span class="ident" id="498048">ContentLength</span><span class="op" id="498061">;</span>&nbsp;<span class="ident" id="498063">v</span>&nbsp;<span class="op" id="498065">!=</span>&nbsp;<span class="num" id="498068">10</span>&nbsp;<span class="op" id="498071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="498075">t</span><span class="op" id="498076">.</span><span class="ident" id="498077">Errorf</span><span class="op" id="498083">(</span><span class="string" id="498084">&#34;Content-Length:&nbsp;%d;&nbsp;want&nbsp;10&#34;</span><span class="op" id="498113">,</span>&nbsp;<span class="ident" id="498115">v</span><span class="op" id="498116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="498119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="498122">body</span><span class="op" id="498126">,</span>&nbsp;<span class="ident" id="498128">err</span>&nbsp;<span class="op" id="498132">:=</span>&nbsp;<span class="ident" id="498135">ioutil</span><span class="op" id="498141">.</span><span class="ident" id="498142">ReadAll</span><span class="op" id="498149">(</span><span class="ident" id="498150">res</span><span class="op" id="498153">.</span><span class="ident" id="498154">Body</span><span class="op" id="498158">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="498161">if</span>&nbsp;<span class="ident" id="498164">err</span>&nbsp;<span class="op" id="498168">!=</span>&nbsp;<span class="builtintype" id="498171">nil</span>&nbsp;<span class="op" id="498175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="498179">t</span><span class="op" id="498180">.</span><span class="ident" id="498181">Error</span><span class="op" id="498186">(</span><span class="ident" id="498187">err</span><span class="op" id="498190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="498193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="498196">if</span>&nbsp;<span class="builtinfunc" id="498199">len</span><span class="op" id="498202">(</span><span class="ident" id="498203">body</span><span class="op" id="498207">)</span>&nbsp;<span class="op" id="498209">&gt;</span>&nbsp;<span class="num" id="498211">0</span>&nbsp;<span class="op" id="498213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="498217">t</span><span class="op" id="498218">.</span><span class="ident" id="498219">Errorf</span><span class="op" id="498225">(</span><span class="string" id="498226">&#34;got&nbsp;unexpected&nbsp;body&nbsp;%q&#34;</span><span class="op" id="498250">,</span>&nbsp;<span class="builtintype" id="498252">string</span><span class="op" id="498258">(</span><span class="ident" id="498259">body</span><span class="op" id="498263">)</span><span class="op" id="498264">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="498267">}</span><br>
<span class="lineno"></span><span class="op" id="498269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="498272">func</span>&nbsp;<span class="ident" id="498277">TestTLSHandshakeTimeout</span><span class="op" id="498300">(</span><span class="ident" id="498301">t</span>&nbsp;<span class="op" id="498303">*</span><span class="ident" id="498304">testing</span><span class="op" id="498311">.</span><span class="ident" id="498312">T</span><span class="op" id="498313">)</span>&nbsp;<span class="op" id="498315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="498318">if</span>&nbsp;<span class="ident" id="498321">runtime</span><span class="op" id="498328">.</span><span class="ident" id="498329">GOOS</span>&nbsp;<span class="op" id="498334">==</span>&nbsp;<span class="string" id="498337">&#34;plan9&#34;</span>&nbsp;<span class="op" id="498345">{</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="498349">t</span><span class="op" id="498350">.</span><span class="ident" id="498351">Skip</span><span class="op" id="498355">(</span><span class="string" id="498356">&#34;skipping&nbsp;test;&nbsp;see&nbsp;http://golang.org/issue/7237&#34;</span><span class="op" id="498405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="498408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="498411">defer</span>&nbsp;<span class="ident" id="498417">afterTest</span><span class="op" id="498426">(</span><span class="ident" id="498427">t</span><span class="op" id="498428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="498431">ts</span>&nbsp;<span class="op" id="498434">:=</span>&nbsp;<span class="ident" id="498437">httptest</span><span class="op" id="498445">.</span><span class="ident" id="498446">NewUnstartedServer</span><span class="op" id="498464">(</span><span class="ident" id="498465">HandlerFunc</span><span class="op" id="498476">(</span><span class="keyword" id="498477">func</span><span class="op" id="498481">(</span><span class="ident" id="498482">w</span>&nbsp;<span class="ident" id="498484">ResponseWriter</span><span class="op" id="498498">,</span>&nbsp;<span class="ident" id="498500">r</span>&nbsp;<span class="op" id="498502">*</span><span class="ident" id="498503">Request</span><span class="op" id="498510">)</span>&nbsp;<span class="op" id="498512">{</span><span class="op" id="498513">}</span><span class="op" id="498514">)</span><span class="op" id="498515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="498518">errc</span>&nbsp;<span class="op" id="498523">:=</span>&nbsp;<span class="builtinfunc" id="498526">make</span><span class="op" id="498530">(</span><span class="ident" id="498531">chanWriter</span><span class="op" id="498541">,</span>&nbsp;<span class="num" id="498543">10</span><span class="op" id="498545">)</span>&nbsp;<span class="comment" id="498547">//&nbsp;but&nbsp;only&nbsp;expecting&nbsp;1</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="498572">ts</span><span class="op" id="498574">.</span><span class="ident" id="498575">Config</span><span class="op" id="498581">.</span><span class="ident" id="498582">ReadTimeout</span>&nbsp;<span class="op" id="498594">=</span>&nbsp;<span class="num" id="498596">250</span>&nbsp;<span class="op" id="498600">*</span>&nbsp;<span class="ident" id="498602">time</span><span class="op" id="498606">.</span><span class="ident" id="498607">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="498620">ts</span><span class="op" id="498622">.</span><span class="ident" id="498623">Config</span><span class="op" id="498629">.</span><span class="ident" id="498630">ErrorLog</span>&nbsp;<span class="op" id="498639">=</span>&nbsp;<span class="ident" id="498641">log</span><span class="op" id="498644">.</span><span class="ident" id="498645">New</span><span class="op" id="498648">(</span><span class="ident" id="498649">errc</span><span class="op" id="498653">,</span>&nbsp;<span class="string" id="498655">&#34;&#34;</span><span class="op" id="498657">,</span>&nbsp;<span class="num" id="498659">0</span><span class="op" id="498660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="498663">ts</span><span class="op" id="498665">.</span><span class="ident" id="498666">StartTLS</span><span class="op" id="498674">(</span><span class="op" id="498675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="498678">defer</span>&nbsp;<span class="ident" id="498684">ts</span><span class="op" id="498686">.</span><span class="ident" id="498687">Close</span><span class="op" id="498692">(</span><span class="op" id="498693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="498696">conn</span><span class="op" id="498700">,</span>&nbsp;<span class="ident" id="498702">err</span>&nbsp;<span class="op" id="498706">:=</span>&nbsp;<span class="ident" id="498709">net</span><span class="op" id="498712">.</span><span class="ident" id="498713">Dial</span><span class="op" id="498717">(</span><span class="string" id="498718">&#34;tcp&#34;</span><span class="op" id="498723">,</span>&nbsp;<span class="ident" id="498725">ts</span><span class="op" id="498727">.</span><span class="ident" id="498728">Listener</span><span class="op" id="498736">.</span><span class="ident" id="498737">Addr</span><span class="op" id="498741">(</span><span class="op" id="498742">)</span><span class="op" id="498743">.</span><span class="ident" id="498744">String</span><span class="op" id="498750">(</span><span class="op" id="498751">)</span><span class="op" id="498752">)</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="498755">if</span>&nbsp;<span class="ident" id="498758">err</span>&nbsp;<span class="op" id="498762">!=</span>&nbsp;<span class="builtintype" id="498765">nil</span>&nbsp;<span class="op" id="498769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="498773">t</span><span class="op" id="498774">.</span><span class="ident" id="498775">Fatalf</span><span class="op" id="498781">(</span><span class="string" id="498782">&#34;Dial:&nbsp;%v&#34;</span><span class="op" id="498792">,</span>&nbsp;<span class="ident" id="498794">err</span><span class="op" id="498797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="498800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="498803">defer</span>&nbsp;<span class="ident" id="498809">conn</span><span class="op" id="498813">.</span><span class="ident" id="498814">Close</span><span class="op" id="498819">(</span><span class="op" id="498820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="498823">goTimeout</span><span class="op" id="498832">(</span><span class="ident" id="498833">t</span><span class="op" id="498834">,</span>&nbsp;<span class="num" id="498836">10</span><span class="op" id="498838">*</span><span class="ident" id="498839">time</span><span class="op" id="498843">.</span><span class="ident" id="498844">Second</span><span class="op" id="498850">,</span>&nbsp;<span class="keyword" id="498852">func</span><span class="op" id="498856">(</span><span class="op" id="498857">)</span>&nbsp;<span class="op" id="498859">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="498863">var</span>&nbsp;<span class="ident" id="498867">buf</span>&nbsp;<span class="op" id="498871">[</span><span class="num" id="498872">1</span><span class="op" id="498873">]</span><span class="builtintype" id="498874">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="498881">n</span><span class="op" id="498882">,</span>&nbsp;<span class="ident" id="498884">err</span>&nbsp;<span class="op" id="498888">:=</span>&nbsp;<span class="ident" id="498891">conn</span><span class="op" id="498895">.</span><span class="ident" id="498896">Read</span><span class="op" id="498900">(</span><span class="ident" id="498901">buf</span><span class="op" id="498904">[</span><span class="op" id="498905">:</span><span class="op" id="498906">]</span><span class="op" id="498907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="498911">if</span>&nbsp;<span class="ident" id="498914">err</span>&nbsp;<span class="op" id="498918">==</span>&nbsp;<span class="builtintype" id="498921">nil</span>&nbsp;<span class="op" id="498925">||</span>&nbsp;<span class="ident" id="498928">n</span>&nbsp;<span class="op" id="498930">!=</span>&nbsp;<span class="num" id="498933">0</span>&nbsp;<span class="op" id="498935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="498940">t</span><span class="op" id="498941">.</span><span class="ident" id="498942">Errorf</span><span class="op" id="498948">(</span><span class="string" id="498949">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;an&nbsp;error&nbsp;and&nbsp;no&nbsp;bytes&#34;</span><span class="op" id="498992">,</span>&nbsp;<span class="ident" id="498994">n</span><span class="op" id="498995">,</span>&nbsp;<span class="ident" id="498997">err</span><span class="op" id="499000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="499004">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="499007">}</span><span class="op" id="499008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="499011">select</span>&nbsp;<span class="op" id="499018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="499021">case</span>&nbsp;<span class="ident" id="499026">v</span>&nbsp;<span class="op" id="499028">:=</span>&nbsp;<span class="op" id="499031">&lt;-</span><span class="ident" id="499033">errc</span><span class="op" id="499037">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="499041">if</span>&nbsp;<span class="op" id="499044">!</span><span class="ident" id="499045">strings</span><span class="op" id="499052">.</span><span class="ident" id="499053">Contains</span><span class="op" id="499061">(</span><span class="ident" id="499062">v</span><span class="op" id="499063">,</span>&nbsp;<span class="string" id="499065">&#34;timeout&#34;</span><span class="op" id="499074">)</span>&nbsp;<span class="op" id="499076">&amp;&amp;</span>&nbsp;<span class="op" id="499079">!</span><span class="ident" id="499080">strings</span><span class="op" id="499087">.</span><span class="ident" id="499088">Contains</span><span class="op" id="499096">(</span><span class="ident" id="499097">v</span><span class="op" id="499098">,</span>&nbsp;<span class="string" id="499100">&#34;TLS&nbsp;handshake&#34;</span><span class="op" id="499115">)</span>&nbsp;<span class="op" id="499117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="499122">t</span><span class="op" id="499123">.</span><span class="ident" id="499124">Errorf</span><span class="op" id="499130">(</span><span class="string" id="499131">&#34;expected&nbsp;a&nbsp;TLS&nbsp;handshake&nbsp;timeout&nbsp;error;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="499179">,</span>&nbsp;<span class="ident" id="499181">v</span><span class="op" id="499182">)</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="499186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="499189">case</span>&nbsp;<span class="op" id="499194">&lt;-</span><span class="ident" id="499196">time</span><span class="op" id="499200">.</span><span class="ident" id="499201">After</span><span class="op" id="499206">(</span><span class="num" id="499207">5</span>&nbsp;<span class="op" id="499209">*</span>&nbsp;<span class="ident" id="499211">time</span><span class="op" id="499215">.</span><span class="ident" id="499216">Second</span><span class="op" id="499222">)</span><span class="op" id="499223">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="499227">t</span><span class="op" id="499228">.</span><span class="ident" id="499229">Errorf</span><span class="op" id="499235">(</span><span class="string" id="499236">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;logged&nbsp;error&#34;</span><span class="op" id="499270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="499273">}</span><br>
<span class="lineno"></span><span class="op" id="499275">}</span><br>
<span class="lineno">910</span><br>
<span class="lineno"></span><span class="keyword" id="499278">func</span>&nbsp;<span class="ident" id="499283">TestTLSServer</span><span class="op" id="499296">(</span><span class="ident" id="499297">t</span>&nbsp;<span class="op" id="499299">*</span><span class="ident" id="499300">testing</span><span class="op" id="499307">.</span><span class="ident" id="499308">T</span><span class="op" id="499309">)</span>&nbsp;<span class="op" id="499311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="499314">defer</span>&nbsp;<span class="ident" id="499320">afterTest</span><span class="op" id="499329">(</span><span class="ident" id="499330">t</span><span class="op" id="499331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="499334">ts</span>&nbsp;<span class="op" id="499337">:=</span>&nbsp;<span class="ident" id="499340">httptest</span><span class="op" id="499348">.</span><span class="ident" id="499349">NewTLSServer</span><span class="op" id="499361">(</span><span class="ident" id="499362">HandlerFunc</span><span class="op" id="499373">(</span><span class="keyword" id="499374">func</span><span class="op" id="499378">(</span><span class="ident" id="499379">w</span>&nbsp;<span class="ident" id="499381">ResponseWriter</span><span class="op" id="499395">,</span>&nbsp;<span class="ident" id="499397">r</span>&nbsp;<span class="op" id="499399">*</span><span class="ident" id="499400">Request</span><span class="op" id="499407">)</span>&nbsp;<span class="op" id="499409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="499413">if</span>&nbsp;<span class="ident" id="499416">r</span><span class="op" id="499417">.</span><span class="ident" id="499418">TLS</span>&nbsp;<span class="op" id="499422">!=</span>&nbsp;<span class="builtintype" id="499425">nil</span>&nbsp;<span class="op" id="499429">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="499434">w</span><span class="op" id="499435">.</span><span class="ident" id="499436">Header</span><span class="op" id="499442">(</span><span class="op" id="499443">)</span><span class="op" id="499444">.</span><span class="ident" id="499445">Set</span><span class="op" id="499448">(</span><span class="string" id="499449">&#34;X-TLS-Set&#34;</span><span class="op" id="499460">,</span>&nbsp;<span class="string" id="499462">&#34;true&#34;</span><span class="op" id="499468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="499473">if</span>&nbsp;<span class="ident" id="499476">r</span><span class="op" id="499477">.</span><span class="ident" id="499478">TLS</span><span class="op" id="499481">.</span><span class="ident" id="499482">HandshakeComplete</span>&nbsp;<span class="op" id="499500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="499506">w</span><span class="op" id="499507">.</span><span class="ident" id="499508">Header</span><span class="op" id="499514">(</span><span class="op" id="499515">)</span><span class="op" id="499516">.</span><span class="ident" id="499517">Set</span><span class="op" id="499520">(</span><span class="string" id="499521">&#34;X-TLS-HandshakeComplete&#34;</span><span class="op" id="499546">,</span>&nbsp;<span class="string" id="499548">&#34;true&#34;</span><span class="op" id="499554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="499559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="499563">}</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="499566">}</span><span class="op" id="499567">)</span><span class="op" id="499568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="499571">ts</span><span class="op" id="499573">.</span><span class="ident" id="499574">Config</span><span class="op" id="499580">.</span><span class="ident" id="499581">ErrorLog</span>&nbsp;<span class="op" id="499590">=</span>&nbsp;<span class="ident" id="499592">log</span><span class="op" id="499595">.</span><span class="ident" id="499596">New</span><span class="op" id="499599">(</span><span class="ident" id="499600">ioutil</span><span class="op" id="499606">.</span><span class="ident" id="499607">Discard</span><span class="op" id="499614">,</span>&nbsp;<span class="string" id="499616">&#34;&#34;</span><span class="op" id="499618">,</span>&nbsp;<span class="num" id="499620">0</span><span class="op" id="499621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="499624">defer</span>&nbsp;<span class="ident" id="499630">ts</span><span class="op" id="499632">.</span><span class="ident" id="499633">Close</span><span class="op" id="499638">(</span><span class="op" id="499639">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="499643">//&nbsp;Connect&nbsp;an&nbsp;idle&nbsp;TCP&nbsp;connection&nbsp;to&nbsp;this&nbsp;server&nbsp;before&nbsp;we&nbsp;run</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="499707">//&nbsp;our&nbsp;real&nbsp;tests.&nbsp;&nbsp;This&nbsp;idle&nbsp;connection&nbsp;used&nbsp;to&nbsp;block&nbsp;forever</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="499771">//&nbsp;in&nbsp;the&nbsp;TLS&nbsp;handshake,&nbsp;preventing&nbsp;future&nbsp;connections&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="499832">//&nbsp;being&nbsp;accepted.&nbsp;It&nbsp;may&nbsp;prevent&nbsp;future&nbsp;accidental&nbsp;blocking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="499894">//&nbsp;in&nbsp;newConn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="499910">idleConn</span><span class="op" id="499918">,</span>&nbsp;<span class="ident" id="499920">err</span>&nbsp;<span class="op" id="499924">:=</span>&nbsp;<span class="ident" id="499927">net</span><span class="op" id="499930">.</span><span class="ident" id="499931">Dial</span><span class="op" id="499935">(</span><span class="string" id="499936">&#34;tcp&#34;</span><span class="op" id="499941">,</span>&nbsp;<span class="ident" id="499943">ts</span><span class="op" id="499945">.</span><span class="ident" id="499946">Listener</span><span class="op" id="499954">.</span><span class="ident" id="499955">Addr</span><span class="op" id="499959">(</span><span class="op" id="499960">)</span><span class="op" id="499961">.</span><span class="ident" id="499962">String</span><span class="op" id="499968">(</span><span class="op" id="499969">)</span><span class="op" id="499970">)</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="499973">if</span>&nbsp;<span class="ident" id="499976">err</span>&nbsp;<span class="op" id="499980">!=</span>&nbsp;<span class="builtintype" id="499983">nil</span>&nbsp;<span class="op" id="499987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="499991">t</span><span class="op" id="499992">.</span><span class="ident" id="499993">Fatalf</span><span class="op" id="499999">(</span><span class="string" id="500000">&#34;Dial:&nbsp;%v&#34;</span><span class="op" id="500010">,</span>&nbsp;<span class="ident" id="500012">err</span><span class="op" id="500015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="500018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="500021">defer</span>&nbsp;<span class="ident" id="500027">idleConn</span><span class="op" id="500035">.</span><span class="ident" id="500036">Close</span><span class="op" id="500041">(</span><span class="op" id="500042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="500045">goTimeout</span><span class="op" id="500054">(</span><span class="ident" id="500055">t</span><span class="op" id="500056">,</span>&nbsp;<span class="num" id="500058">10</span><span class="op" id="500060">*</span><span class="ident" id="500061">time</span><span class="op" id="500065">.</span><span class="ident" id="500066">Second</span><span class="op" id="500072">,</span>&nbsp;<span class="keyword" id="500074">func</span><span class="op" id="500078">(</span><span class="op" id="500079">)</span>&nbsp;<span class="op" id="500081">{</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="500085">if</span>&nbsp;<span class="op" id="500088">!</span><span class="ident" id="500089">strings</span><span class="op" id="500096">.</span><span class="ident" id="500097">HasPrefix</span><span class="op" id="500106">(</span><span class="ident" id="500107">ts</span><span class="op" id="500109">.</span><span class="ident" id="500110">URL</span><span class="op" id="500113">,</span>&nbsp;<span class="string" id="500115">&#34;https://&#34;</span><span class="op" id="500125">)</span>&nbsp;<span class="op" id="500127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="500132">t</span><span class="op" id="500133">.</span><span class="ident" id="500134">Errorf</span><span class="op" id="500140">(</span><span class="string" id="500141">&#34;expected&nbsp;test&nbsp;TLS&nbsp;server&nbsp;to&nbsp;start&nbsp;with&nbsp;https://,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="500198">,</span>&nbsp;<span class="ident" id="500200">ts</span><span class="op" id="500202">.</span><span class="ident" id="500203">URL</span><span class="op" id="500206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="500211">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="500220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="500224">noVerifyTransport</span>&nbsp;<span class="op" id="500242">:=</span>&nbsp;<span class="op" id="500245">&amp;</span><span class="ident" id="500246">Transport</span><span class="op" id="500255">{</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="500260">TLSClientConfig</span><span class="op" id="500275">:</span>&nbsp;<span class="op" id="500277">&amp;</span><span class="ident" id="500278">tls</span><span class="op" id="500281">.</span><span class="ident" id="500282">Config</span><span class="op" id="500288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="500294">InsecureSkipVerify</span><span class="op" id="500312">:</span>&nbsp;<span class="builtintype" id="500314">true</span><span class="op" id="500318">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="500323">}</span><span class="op" id="500324">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="500328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="500332">client</span>&nbsp;<span class="op" id="500339">:=</span>&nbsp;<span class="op" id="500342">&amp;</span><span class="ident" id="500343">Client</span><span class="op" id="500349">{</span><span class="ident" id="500350">Transport</span><span class="op" id="500359">:</span>&nbsp;<span class="ident" id="500361">noVerifyTransport</span><span class="op" id="500378">}</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="500382">res</span><span class="op" id="500385">,</span>&nbsp;<span class="ident" id="500387">err</span>&nbsp;<span class="op" id="500391">:=</span>&nbsp;<span class="ident" id="500394">client</span><span class="op" id="500400">.</span><span class="ident" id="500401">Get</span><span class="op" id="500404">(</span><span class="ident" id="500405">ts</span><span class="op" id="500407">.</span><span class="ident" id="500408">URL</span><span class="op" id="500411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="500415">if</span>&nbsp;<span class="ident" id="500418">err</span>&nbsp;<span class="op" id="500422">!=</span>&nbsp;<span class="builtintype" id="500425">nil</span>&nbsp;<span class="op" id="500429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="500434">t</span><span class="op" id="500435">.</span><span class="ident" id="500436">Error</span><span class="op" id="500441">(</span><span class="ident" id="500442">err</span><span class="op" id="500445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="500450">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="500459">}</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="500463">if</span>&nbsp;<span class="ident" id="500466">res</span>&nbsp;<span class="op" id="500470">==</span>&nbsp;<span class="builtintype" id="500473">nil</span>&nbsp;<span class="op" id="500477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="500482">t</span><span class="op" id="500483">.</span><span class="ident" id="500484">Errorf</span><span class="op" id="500490">(</span><span class="string" id="500491">&#34;got&nbsp;nil&nbsp;Response&#34;</span><span class="op" id="500509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="500514">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="500523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="500527">defer</span>&nbsp;<span class="ident" id="500533">res</span><span class="op" id="500536">.</span><span class="ident" id="500537">Body</span><span class="op" id="500541">.</span><span class="ident" id="500542">Close</span><span class="op" id="500547">(</span><span class="op" id="500548">)</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="500552">if</span>&nbsp;<span class="ident" id="500555">res</span><span class="op" id="500558">.</span><span class="ident" id="500559">Header</span><span class="op" id="500565">.</span><span class="ident" id="500566">Get</span><span class="op" id="500569">(</span><span class="string" id="500570">&#34;X-TLS-Set&#34;</span><span class="op" id="500581">)</span>&nbsp;<span class="op" id="500583">!=</span>&nbsp;<span class="string" id="500586">&#34;true&#34;</span>&nbsp;<span class="op" id="500593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="500598">t</span><span class="op" id="500599">.</span><span class="ident" id="500600">Errorf</span><span class="op" id="500606">(</span><span class="string" id="500607">&#34;expected&nbsp;X-TLS-Set&nbsp;response&nbsp;header&#34;</span><span class="op" id="500643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="500648">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="500657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="500661">if</span>&nbsp;<span class="ident" id="500664">res</span><span class="op" id="500667">.</span><span class="ident" id="500668">Header</span><span class="op" id="500674">.</span><span class="ident" id="500675">Get</span><span class="op" id="500678">(</span><span class="string" id="500679">&#34;X-TLS-HandshakeComplete&#34;</span><span class="op" id="500704">)</span>&nbsp;<span class="op" id="500706">!=</span>&nbsp;<span class="string" id="500709">&#34;true&#34;</span>&nbsp;<span class="op" id="500716">{</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="500721">t</span><span class="op" id="500722">.</span><span class="ident" id="500723">Errorf</span><span class="op" id="500729">(</span><span class="string" id="500730">&#34;expected&nbsp;X-TLS-HandshakeComplete&nbsp;header&#34;</span><span class="op" id="500771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="500775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="500778">}</span><span class="op" id="500779">)</span><br>
<span class="lineno"></span><span class="op" id="500781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">965</span><span class="keyword" id="500784">type</span>&nbsp;<span class="ident" id="500789">serverExpectTest</span>&nbsp;<span class="keyword" id="500806">struct</span>&nbsp;<span class="op" id="500813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="500816">contentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="500833">int</span>&nbsp;<span class="comment" id="500837">//&nbsp;of&nbsp;request&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="500857">chunked</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="500874">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="500880">expectation</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="500897">string</span>&nbsp;<span class="comment" id="500904">//&nbsp;e.g.&nbsp;&#34;100-continue&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="500928">readBody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="500945">bool</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="500952">//&nbsp;whether&nbsp;handler&nbsp;should&nbsp;read&nbsp;the&nbsp;body&nbsp;(if&nbsp;false,&nbsp;sends&nbsp;StatusUnauthorized)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="501030">expectedResponse</span>&nbsp;<span class="builtintype" id="501047">string</span>&nbsp;<span class="comment" id="501054">//&nbsp;expected&nbsp;substring&nbsp;in&nbsp;first&nbsp;line&nbsp;of&nbsp;http&nbsp;response</span><br>
<span class="lineno"></span><span class="op" id="501107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="501110">func</span>&nbsp;<span class="ident" id="501115">expectTest</span><span class="op" id="501125">(</span><span class="ident" id="501126">contentLength</span>&nbsp;<span class="builtintype" id="501140">int</span><span class="op" id="501143">,</span>&nbsp;<span class="ident" id="501145">expectation</span>&nbsp;<span class="builtintype" id="501157">string</span><span class="op" id="501163">,</span>&nbsp;<span class="ident" id="501165">readBody</span>&nbsp;<span class="builtintype" id="501174">bool</span><span class="op" id="501178">,</span>&nbsp;<span class="ident" id="501180">expectedResponse</span>&nbsp;<span class="builtintype" id="501197">string</span><span class="op" id="501203">)</span>&nbsp;<span class="ident" id="501205">serverExpectTest</span>&nbsp;<span class="op" id="501222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="501225">return</span>&nbsp;<span class="ident" id="501232">serverExpectTest</span><span class="op" id="501248">{</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="501252">contentLength</span><span class="op" id="501265">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="501270">contentLength</span><span class="op" id="501283">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="501287">expectation</span><span class="op" id="501298">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="501305">expectation</span><span class="op" id="501316">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="501320">readBody</span><span class="op" id="501328">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="501338">readBody</span><span class="op" id="501346">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="501350">expectedResponse</span><span class="op" id="501366">:</span>&nbsp;<span class="ident" id="501368">expectedResponse</span><span class="op" id="501384">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="501387">}</span><br>
<span class="lineno">980</span><span class="op" id="501389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="501392">var</span>&nbsp;<span class="ident" id="501396">serverExpectTests</span>&nbsp;<span class="op" id="501414">=</span>&nbsp;<span class="op" id="501416">[</span><span class="op" id="501417">]</span><span class="ident" id="501418">serverExpectTest</span><span class="op" id="501434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="501437">//&nbsp;Normal&nbsp;100-continues,&nbsp;case-insensitive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="501481">expectTest</span><span class="op" id="501491">(</span><span class="num" id="501492">100</span><span class="op" id="501495">,</span>&nbsp;<span class="string" id="501497">&#34;100-continue&#34;</span><span class="op" id="501511">,</span>&nbsp;<span class="builtintype" id="501513">true</span><span class="op" id="501517">,</span>&nbsp;<span class="string" id="501519">&#34;100&nbsp;Continue&#34;</span><span class="op" id="501533">)</span><span class="op" id="501534">,</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="501537">expectTest</span><span class="op" id="501547">(</span><span class="num" id="501548">100</span><span class="op" id="501551">,</span>&nbsp;<span class="string" id="501553">&#34;100-cOntInUE&#34;</span><span class="op" id="501567">,</span>&nbsp;<span class="builtintype" id="501569">true</span><span class="op" id="501573">,</span>&nbsp;<span class="string" id="501575">&#34;100&nbsp;Continue&#34;</span><span class="op" id="501589">)</span><span class="op" id="501590">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="501594">//&nbsp;No&nbsp;100-continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="501615">expectTest</span><span class="op" id="501625">(</span><span class="num" id="501626">100</span><span class="op" id="501629">,</span>&nbsp;<span class="string" id="501631">&#34;&#34;</span><span class="op" id="501633">,</span>&nbsp;<span class="builtintype" id="501635">true</span><span class="op" id="501639">,</span>&nbsp;<span class="string" id="501641">&#34;200&nbsp;OK&#34;</span><span class="op" id="501649">)</span><span class="op" id="501650">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="501654">//&nbsp;100-continue&nbsp;but&nbsp;requesting&nbsp;client&nbsp;to&nbsp;deny&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="501705">//&nbsp;so&nbsp;it&nbsp;never&nbsp;reads&nbsp;the&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="501737">expectTest</span><span class="op" id="501747">(</span><span class="num" id="501748">100</span><span class="op" id="501751">,</span>&nbsp;<span class="string" id="501753">&#34;100-continue&#34;</span><span class="op" id="501767">,</span>&nbsp;<span class="builtintype" id="501769">false</span><span class="op" id="501774">,</span>&nbsp;<span class="string" id="501776">&#34;401&nbsp;Unauthorized&#34;</span><span class="op" id="501794">)</span><span class="op" id="501795">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="501798">//&nbsp;Likewise&nbsp;without&nbsp;100-continue:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="501833">expectTest</span><span class="op" id="501843">(</span><span class="num" id="501844">100</span><span class="op" id="501847">,</span>&nbsp;<span class="string" id="501849">&#34;&#34;</span><span class="op" id="501851">,</span>&nbsp;<span class="builtintype" id="501853">false</span><span class="op" id="501858">,</span>&nbsp;<span class="string" id="501860">&#34;401&nbsp;Unauthorized&#34;</span><span class="op" id="501878">)</span><span class="op" id="501879">,</span><br>
<span class="lineno">995</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="501883">//&nbsp;Non-standard&nbsp;expectations&nbsp;are&nbsp;failures</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="501926">expectTest</span><span class="op" id="501936">(</span><span class="num" id="501937">0</span><span class="op" id="501938">,</span>&nbsp;<span class="string" id="501940">&#34;a-pony&#34;</span><span class="op" id="501948">,</span>&nbsp;<span class="builtintype" id="501950">false</span><span class="op" id="501955">,</span>&nbsp;<span class="string" id="501957">&#34;417&nbsp;Expectation&nbsp;Failed&#34;</span><span class="op" id="501981">)</span><span class="op" id="501982">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="501986">//&nbsp;Expect-100&nbsp;requested&nbsp;but&nbsp;no&nbsp;body&nbsp;(is&nbsp;apparently&nbsp;okay:&nbsp;Issue&nbsp;7625)</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="502056">expectTest</span><span class="op" id="502066">(</span><span class="num" id="502067">0</span><span class="op" id="502068">,</span>&nbsp;<span class="string" id="502070">&#34;100-continue&#34;</span><span class="op" id="502084">,</span>&nbsp;<span class="builtintype" id="502086">true</span><span class="op" id="502090">,</span>&nbsp;<span class="string" id="502092">&#34;200&nbsp;OK&#34;</span><span class="op" id="502100">)</span><span class="op" id="502101">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="502104">//&nbsp;Expect-100&nbsp;requested&nbsp;but&nbsp;handler&nbsp;doesn&#39;t&nbsp;read&nbsp;the&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="502163">expectTest</span><span class="op" id="502173">(</span><span class="num" id="502174">0</span><span class="op" id="502175">,</span>&nbsp;<span class="string" id="502177">&#34;100-continue&#34;</span><span class="op" id="502191">,</span>&nbsp;<span class="builtintype" id="502193">false</span><span class="op" id="502198">,</span>&nbsp;<span class="string" id="502200">&#34;401&nbsp;Unauthorized&#34;</span><span class="op" id="502218">)</span><span class="op" id="502219">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="502222">//&nbsp;Expect-100&nbsp;continue&nbsp;with&nbsp;no&nbsp;body,&nbsp;but&nbsp;a&nbsp;chunked&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="502280">{</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="502284">expectation</span><span class="op" id="502295">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="502302">&#34;100-continue&#34;</span><span class="op" id="502316">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="502320">readBody</span><span class="op" id="502328">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="502338">true</span><span class="op" id="502342">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="502346">chunked</span><span class="op" id="502353">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="502364">true</span><span class="op" id="502368">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="502372">expectedResponse</span><span class="op" id="502388">:</span>&nbsp;<span class="string" id="502390">&#34;100&nbsp;Continue&#34;</span><span class="op" id="502404">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="502407">}</span><span class="op" id="502408">,</span><br>
<span class="lineno">1010</span><span class="op" id="502410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="502413">//&nbsp;Tests&nbsp;that&nbsp;the&nbsp;server&nbsp;responds&nbsp;to&nbsp;the&nbsp;&#34;Expect&#34;&nbsp;request&nbsp;header</span><br>
<span class="lineno"></span><span class="comment" id="502478">//&nbsp;correctly.</span><br>
<span class="lineno"></span><span class="keyword" id="502492">func</span>&nbsp;<span class="ident" id="502497">TestServerExpect</span><span class="op" id="502513">(</span><span class="ident" id="502514">t</span>&nbsp;<span class="op" id="502516">*</span><span class="ident" id="502517">testing</span><span class="op" id="502524">.</span><span class="ident" id="502525">T</span><span class="op" id="502526">)</span>&nbsp;<span class="op" id="502528">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="502531">defer</span>&nbsp;<span class="ident" id="502537">afterTest</span><span class="op" id="502546">(</span><span class="ident" id="502547">t</span><span class="op" id="502548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="502551">ts</span>&nbsp;<span class="op" id="502554">:=</span>&nbsp;<span class="ident" id="502557">httptest</span><span class="op" id="502565">.</span><span class="ident" id="502566">NewServer</span><span class="op" id="502575">(</span><span class="ident" id="502576">HandlerFunc</span><span class="op" id="502587">(</span><span class="keyword" id="502588">func</span><span class="op" id="502592">(</span><span class="ident" id="502593">w</span>&nbsp;<span class="ident" id="502595">ResponseWriter</span><span class="op" id="502609">,</span>&nbsp;<span class="ident" id="502611">r</span>&nbsp;<span class="op" id="502613">*</span><span class="ident" id="502614">Request</span><span class="op" id="502621">)</span>&nbsp;<span class="op" id="502623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="502627">//&nbsp;Note&nbsp;using&nbsp;r.FormValue(&#34;readbody&#34;)&nbsp;because&nbsp;for&nbsp;POST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="502684">//&nbsp;requests&nbsp;that&nbsp;would&nbsp;read&nbsp;from&nbsp;r.Body,&nbsp;which&nbsp;we&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="502741">//&nbsp;conditionally&nbsp;want&nbsp;to&nbsp;do.</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="502772">if</span>&nbsp;<span class="ident" id="502775">strings</span><span class="op" id="502782">.</span><span class="ident" id="502783">Contains</span><span class="op" id="502791">(</span><span class="ident" id="502792">r</span><span class="op" id="502793">.</span><span class="ident" id="502794">URL</span><span class="op" id="502797">.</span><span class="ident" id="502798">RawQuery</span><span class="op" id="502806">,</span>&nbsp;<span class="string" id="502808">&#34;readbody=true&#34;</span><span class="op" id="502823">)</span>&nbsp;<span class="op" id="502825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="502830">ioutil</span><span class="op" id="502836">.</span><span class="ident" id="502837">ReadAll</span><span class="op" id="502844">(</span><span class="ident" id="502845">r</span><span class="op" id="502846">.</span><span class="ident" id="502847">Body</span><span class="op" id="502851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="502856">w</span><span class="op" id="502857">.</span><span class="ident" id="502858">Write</span><span class="op" id="502863">(</span><span class="op" id="502864">[</span><span class="op" id="502865">]</span><span class="builtintype" id="502866">byte</span><span class="op" id="502870">(</span><span class="string" id="502871">&#34;Hi&#34;</span><span class="op" id="502875">)</span><span class="op" id="502876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="502880">}</span>&nbsp;<span class="keyword" id="502882">else</span>&nbsp;<span class="op" id="502887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="502892">w</span><span class="op" id="502893">.</span><span class="ident" id="502894">WriteHeader</span><span class="op" id="502905">(</span><span class="ident" id="502906">StatusUnauthorized</span><span class="op" id="502924">)</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="502928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="502931">}</span><span class="op" id="502932">)</span><span class="op" id="502933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="502936">defer</span>&nbsp;<span class="ident" id="502942">ts</span><span class="op" id="502944">.</span><span class="ident" id="502945">Close</span><span class="op" id="502950">(</span><span class="op" id="502951">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="502955">runTest</span>&nbsp;<span class="op" id="502963">:=</span>&nbsp;<span class="keyword" id="502966">func</span><span class="op" id="502970">(</span><span class="ident" id="502971">test</span>&nbsp;<span class="ident" id="502976">serverExpectTest</span><span class="op" id="502992">)</span>&nbsp;<span class="op" id="502994">{</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="502998">conn</span><span class="op" id="503002">,</span>&nbsp;<span class="ident" id="503004">err</span>&nbsp;<span class="op" id="503008">:=</span>&nbsp;<span class="ident" id="503011">net</span><span class="op" id="503014">.</span><span class="ident" id="503015">Dial</span><span class="op" id="503019">(</span><span class="string" id="503020">&#34;tcp&#34;</span><span class="op" id="503025">,</span>&nbsp;<span class="ident" id="503027">ts</span><span class="op" id="503029">.</span><span class="ident" id="503030">Listener</span><span class="op" id="503038">.</span><span class="ident" id="503039">Addr</span><span class="op" id="503043">(</span><span class="op" id="503044">)</span><span class="op" id="503045">.</span><span class="ident" id="503046">String</span><span class="op" id="503052">(</span><span class="op" id="503053">)</span><span class="op" id="503054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="503058">if</span>&nbsp;<span class="ident" id="503061">err</span>&nbsp;<span class="op" id="503065">!=</span>&nbsp;<span class="builtintype" id="503068">nil</span>&nbsp;<span class="op" id="503072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="503077">t</span><span class="op" id="503078">.</span><span class="ident" id="503079">Fatalf</span><span class="op" id="503085">(</span><span class="string" id="503086">&#34;Dial:&nbsp;%v&#34;</span><span class="op" id="503096">,</span>&nbsp;<span class="ident" id="503098">err</span><span class="op" id="503101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="503105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="503109">defer</span>&nbsp;<span class="ident" id="503115">conn</span><span class="op" id="503119">.</span><span class="ident" id="503120">Close</span><span class="op" id="503125">(</span><span class="op" id="503126">)</span><br>
<span class="lineno">1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="503131">//&nbsp;Only&nbsp;send&nbsp;the&nbsp;body&nbsp;immediately&nbsp;if&nbsp;we&#39;re&nbsp;acting&nbsp;like&nbsp;an&nbsp;HTTP&nbsp;client</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="503203">//&nbsp;that&nbsp;doesn&#39;t&nbsp;send&nbsp;100-continue&nbsp;expectations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="503253">writeBody</span>&nbsp;<span class="op" id="503263">:=</span>&nbsp;<span class="ident" id="503266">test</span><span class="op" id="503270">.</span><span class="ident" id="503271">contentLength</span>&nbsp;<span class="op" id="503285">!=</span>&nbsp;<span class="num" id="503288">0</span>&nbsp;<span class="op" id="503290">&amp;&amp;</span>&nbsp;<span class="ident" id="503293">strings</span><span class="op" id="503300">.</span><span class="ident" id="503301">ToLower</span><span class="op" id="503308">(</span><span class="ident" id="503309">test</span><span class="op" id="503313">.</span><span class="ident" id="503314">expectation</span><span class="op" id="503325">)</span>&nbsp;<span class="op" id="503327">!=</span>&nbsp;<span class="string" id="503330">&#34;100-continue&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="503348">go</span>&nbsp;<span class="keyword" id="503351">func</span><span class="op" id="503355">(</span><span class="op" id="503356">)</span>&nbsp;<span class="op" id="503358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="503363">contentLen</span>&nbsp;<span class="op" id="503374">:=</span>&nbsp;<span class="ident" id="503377">fmt</span><span class="op" id="503380">.</span><span class="ident" id="503381">Sprintf</span><span class="op" id="503388">(</span><span class="string" id="503389">&#34;Content-Length:&nbsp;%d&#34;</span><span class="op" id="503409">,</span>&nbsp;<span class="ident" id="503411">test</span><span class="op" id="503415">.</span><span class="ident" id="503416">contentLength</span><span class="op" id="503429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="503434">if</span>&nbsp;<span class="ident" id="503437">test</span><span class="op" id="503441">.</span><span class="ident" id="503442">chunked</span>&nbsp;<span class="op" id="503450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="503456">contentLen</span>&nbsp;<span class="op" id="503467">=</span>&nbsp;<span class="string" id="503469">&#34;Transfer-Encoding:&nbsp;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="503501">}</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="503506">_</span><span class="op" id="503507">,</span>&nbsp;<span class="ident" id="503509">err</span>&nbsp;<span class="op" id="503513">:=</span>&nbsp;<span class="ident" id="503516">fmt</span><span class="op" id="503519">.</span><span class="ident" id="503520">Fprintf</span><span class="op" id="503527">(</span><span class="ident" id="503528">conn</span><span class="op" id="503532">,</span>&nbsp;<span class="string" id="503534">&#34;POST&nbsp;/?readbody=%v&nbsp;HTTP/1.1\r\n&#34;</span><span class="op" id="503567">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="503573">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="503596">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="503602">&#34;%s\r\n&#34;</span><span class="op" id="503610">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="503616">&#34;Expect:&nbsp;%s\r\nHost:&nbsp;foo\r\n\r\n&#34;</span><span class="op" id="503649">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="503655">test</span><span class="op" id="503659">.</span><span class="ident" id="503660">readBody</span><span class="op" id="503668">,</span>&nbsp;<span class="ident" id="503670">contentLen</span><span class="op" id="503680">,</span>&nbsp;<span class="ident" id="503682">test</span><span class="op" id="503686">.</span><span class="ident" id="503687">expectation</span><span class="op" id="503698">)</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="503703">if</span>&nbsp;<span class="ident" id="503706">err</span>&nbsp;<span class="op" id="503710">!=</span>&nbsp;<span class="builtintype" id="503713">nil</span>&nbsp;<span class="op" id="503717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="503723">t</span><span class="op" id="503724">.</span><span class="ident" id="503725">Errorf</span><span class="op" id="503731">(</span><span class="string" id="503732">&#34;On&nbsp;test&nbsp;%#v,&nbsp;error&nbsp;writing&nbsp;request&nbsp;headers:&nbsp;%v&#34;</span><span class="op" id="503780">,</span>&nbsp;<span class="ident" id="503782">test</span><span class="op" id="503786">,</span>&nbsp;<span class="ident" id="503788">err</span><span class="op" id="503791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="503797">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="503807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="503812">if</span>&nbsp;<span class="ident" id="503815">writeBody</span>&nbsp;<span class="op" id="503825">{</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="503831">var</span>&nbsp;<span class="ident" id="503835">targ</span>&nbsp;<span class="ident" id="503840">io</span><span class="op" id="503842">.</span><span class="ident" id="503843">WriteCloser</span>&nbsp;<span class="op" id="503855">=</span>&nbsp;<span class="keyword" id="503857">struct</span>&nbsp;<span class="op" id="503864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="503871">io</span><span class="op" id="503873">.</span><span class="ident" id="503874">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="503886">io</span><span class="op" id="503888">.</span><span class="ident" id="503889">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="503900">}</span><span class="op" id="503901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="503908">conn</span><span class="op" id="503912">,</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="503919">ioutil</span><span class="op" id="503925">.</span><span class="ident" id="503926">NopCloser</span><span class="op" id="503935">(</span><span class="builtintype" id="503936">nil</span><span class="op" id="503939">)</span><span class="op" id="503940">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="503946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="503952">if</span>&nbsp;<span class="ident" id="503955">test</span><span class="op" id="503959">.</span><span class="ident" id="503960">chunked</span>&nbsp;<span class="op" id="503968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="503975">targ</span>&nbsp;<span class="op" id="503980">=</span>&nbsp;<span class="ident" id="503982">httputil</span><span class="op" id="503990">.</span><span class="ident" id="503991">NewChunkedWriter</span><span class="op" id="504007">(</span><span class="ident" id="504008">conn</span><span class="op" id="504012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="504018">}</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="504024">body</span>&nbsp;<span class="op" id="504029">:=</span>&nbsp;<span class="ident" id="504032">strings</span><span class="op" id="504039">.</span><span class="ident" id="504040">Repeat</span><span class="op" id="504046">(</span><span class="string" id="504047">&#34;A&#34;</span><span class="op" id="504050">,</span>&nbsp;<span class="ident" id="504052">test</span><span class="op" id="504056">.</span><span class="ident" id="504057">contentLength</span><span class="op" id="504070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="504076">_</span><span class="op" id="504077">,</span>&nbsp;<span class="ident" id="504079">err</span>&nbsp;<span class="op" id="504083">=</span>&nbsp;<span class="ident" id="504085">fmt</span><span class="op" id="504088">.</span><span class="ident" id="504089">Fprint</span><span class="op" id="504095">(</span><span class="ident" id="504096">targ</span><span class="op" id="504100">,</span>&nbsp;<span class="ident" id="504102">body</span><span class="op" id="504106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="504112">if</span>&nbsp;<span class="ident" id="504115">err</span>&nbsp;<span class="op" id="504119">==</span>&nbsp;<span class="builtintype" id="504122">nil</span>&nbsp;<span class="op" id="504126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="504133">err</span>&nbsp;<span class="op" id="504137">=</span>&nbsp;<span class="ident" id="504139">targ</span><span class="op" id="504143">.</span><span class="ident" id="504144">Close</span><span class="op" id="504149">(</span><span class="op" id="504150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="504156">}</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="504162">if</span>&nbsp;<span class="ident" id="504165">err</span>&nbsp;<span class="op" id="504169">!=</span>&nbsp;<span class="builtintype" id="504172">nil</span>&nbsp;<span class="op" id="504176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="504183">if</span>&nbsp;<span class="op" id="504186">!</span><span class="ident" id="504187">test</span><span class="op" id="504191">.</span><span class="ident" id="504192">readBody</span>&nbsp;<span class="op" id="504201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="504209">//&nbsp;Server&nbsp;likely&nbsp;already&nbsp;hung&nbsp;up&nbsp;on&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="504255">//&nbsp;See&nbsp;larger&nbsp;comment&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="504290">t</span><span class="op" id="504291">.</span><span class="ident" id="504292">Logf</span><span class="op" id="504296">(</span><span class="string" id="504297">&#34;On&nbsp;test&nbsp;%#v,&nbsp;acceptable&nbsp;error&nbsp;writing&nbsp;request&nbsp;body:&nbsp;%v&#34;</span><span class="op" id="504353">,</span>&nbsp;<span class="ident" id="504355">test</span><span class="op" id="504359">,</span>&nbsp;<span class="ident" id="504361">err</span><span class="op" id="504364">)</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="504372">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="504384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="504391">t</span><span class="op" id="504392">.</span><span class="ident" id="504393">Errorf</span><span class="op" id="504399">(</span><span class="string" id="504400">&#34;On&nbsp;test&nbsp;%#v,&nbsp;error&nbsp;writing&nbsp;request&nbsp;body:&nbsp;%v&#34;</span><span class="op" id="504445">,</span>&nbsp;<span class="ident" id="504447">test</span><span class="op" id="504451">,</span>&nbsp;<span class="ident" id="504453">err</span><span class="op" id="504456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="504462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="504467">}</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="504471">}</span><span class="op" id="504472">(</span><span class="op" id="504473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="504477">bufr</span>&nbsp;<span class="op" id="504482">:=</span>&nbsp;<span class="ident" id="504485">bufio</span><span class="op" id="504490">.</span><span class="ident" id="504491">NewReader</span><span class="op" id="504500">(</span><span class="ident" id="504501">conn</span><span class="op" id="504505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="504509">line</span><span class="op" id="504513">,</span>&nbsp;<span class="ident" id="504515">err</span>&nbsp;<span class="op" id="504519">:=</span>&nbsp;<span class="ident" id="504522">bufr</span><span class="op" id="504526">.</span><span class="ident" id="504527">ReadString</span><span class="op" id="504537">(</span><span class="string" id="504538">&#39;\n&#39;</span><span class="op" id="504542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="504546">if</span>&nbsp;<span class="ident" id="504549">err</span>&nbsp;<span class="op" id="504553">!=</span>&nbsp;<span class="builtintype" id="504556">nil</span>&nbsp;<span class="op" id="504560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="504565">if</span>&nbsp;<span class="ident" id="504568">writeBody</span>&nbsp;<span class="op" id="504578">&amp;&amp;</span>&nbsp;<span class="op" id="504581">!</span><span class="ident" id="504582">test</span><span class="op" id="504586">.</span><span class="ident" id="504587">readBody</span>&nbsp;<span class="op" id="504596">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="504602">//&nbsp;This&nbsp;is&nbsp;an&nbsp;acceptable&nbsp;failure&nbsp;due&nbsp;to&nbsp;a&nbsp;possible&nbsp;TCP&nbsp;race:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="504667">//&nbsp;We&nbsp;were&nbsp;still&nbsp;writing&nbsp;data&nbsp;and&nbsp;the&nbsp;server&nbsp;hung&nbsp;up&nbsp;on&nbsp;us.&nbsp;A&nbsp;TCP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="504737">//&nbsp;implementation&nbsp;may&nbsp;send&nbsp;a&nbsp;RST&nbsp;if&nbsp;our&nbsp;request&nbsp;body&nbsp;data&nbsp;was&nbsp;known</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="504809">//&nbsp;to&nbsp;be&nbsp;lost,&nbsp;which&nbsp;may&nbsp;trigger&nbsp;our&nbsp;reads&nbsp;to&nbsp;fail.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="504865">//&nbsp;See&nbsp;RFC&nbsp;1122&nbsp;page&nbsp;88.</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="504894">t</span><span class="op" id="504895">.</span><span class="ident" id="504896">Logf</span><span class="op" id="504900">(</span><span class="string" id="504901">&#34;On&nbsp;test&nbsp;%#v,&nbsp;acceptable&nbsp;error&nbsp;from&nbsp;ReadString:&nbsp;%v&#34;</span><span class="op" id="504952">,</span>&nbsp;<span class="ident" id="504954">test</span><span class="op" id="504958">,</span>&nbsp;<span class="ident" id="504960">err</span><span class="op" id="504963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="504969">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="504979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="504984">t</span><span class="op" id="504985">.</span><span class="ident" id="504986">Fatalf</span><span class="op" id="504992">(</span><span class="string" id="504993">&#34;On&nbsp;test&nbsp;%#v,&nbsp;ReadString:&nbsp;%v&#34;</span><span class="op" id="505022">,</span>&nbsp;<span class="ident" id="505024">test</span><span class="op" id="505028">,</span>&nbsp;<span class="ident" id="505030">err</span><span class="op" id="505033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="505037">}</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="505041">if</span>&nbsp;<span class="op" id="505044">!</span><span class="ident" id="505045">strings</span><span class="op" id="505052">.</span><span class="ident" id="505053">Contains</span><span class="op" id="505061">(</span><span class="ident" id="505062">line</span><span class="op" id="505066">,</span>&nbsp;<span class="ident" id="505068">test</span><span class="op" id="505072">.</span><span class="ident" id="505073">expectedResponse</span><span class="op" id="505089">)</span>&nbsp;<span class="op" id="505091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="505096">t</span><span class="op" id="505097">.</span><span class="ident" id="505098">Errorf</span><span class="op" id="505104">(</span><span class="string" id="505105">&#34;On&nbsp;test&nbsp;%#v,&nbsp;got&nbsp;first&nbsp;line&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="505148">,</span>&nbsp;<span class="ident" id="505150">test</span><span class="op" id="505154">,</span>&nbsp;<span class="ident" id="505156">line</span><span class="op" id="505160">,</span>&nbsp;<span class="ident" id="505162">test</span><span class="op" id="505166">.</span><span class="ident" id="505167">expectedResponse</span><span class="op" id="505183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="505187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="505190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="505194">for</span>&nbsp;<span class="ident" id="505198">_</span><span class="op" id="505199">,</span>&nbsp;<span class="ident" id="505201">test</span>&nbsp;<span class="op" id="505206">:=</span>&nbsp;<span class="keyword" id="505209">range</span>&nbsp;<span class="ident" id="505215">serverExpectTests</span>&nbsp;<span class="op" id="505233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="505237">runTest</span><span class="op" id="505244">(</span><span class="ident" id="505245">test</span><span class="op" id="505249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="505252">}</span><br>
<span class="lineno"></span><span class="op" id="505254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1105</span><span class="comment" id="505257">//&nbsp;Under&nbsp;a&nbsp;~256KB&nbsp;(maxPostHandlerReadBytes)&nbsp;threshold,&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="505323">//&nbsp;should&nbsp;consume&nbsp;client&nbsp;request&nbsp;bodies&nbsp;that&nbsp;a&nbsp;handler&nbsp;didn&#39;t&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="505391">func</span>&nbsp;<span class="ident" id="505396">TestServerUnreadRequestBodyLittle</span><span class="op" id="505429">(</span><span class="ident" id="505430">t</span>&nbsp;<span class="op" id="505432">*</span><span class="ident" id="505433">testing</span><span class="op" id="505440">.</span><span class="ident" id="505441">T</span><span class="op" id="505442">)</span>&nbsp;<span class="op" id="505444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="505447">conn</span>&nbsp;<span class="op" id="505452">:=</span>&nbsp;<span class="builtinfunc" id="505455">new</span><span class="op" id="505458">(</span><span class="ident" id="505459">testConn</span><span class="op" id="505467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="505470">body</span>&nbsp;<span class="op" id="505475">:=</span>&nbsp;<span class="ident" id="505478">strings</span><span class="op" id="505485">.</span><span class="ident" id="505486">Repeat</span><span class="op" id="505492">(</span><span class="string" id="505493">&#34;x&#34;</span><span class="op" id="505496">,</span>&nbsp;<span class="num" id="505498">100</span><span class="op" id="505501">&lt;&lt;</span><span class="num" id="505503">10</span><span class="op" id="505505">)</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="505508">conn</span><span class="op" id="505512">.</span><span class="ident" id="505513">readBuf</span><span class="op" id="505520">.</span><span class="ident" id="505521">Write</span><span class="op" id="505526">(</span><span class="op" id="505527">[</span><span class="op" id="505528">]</span><span class="builtintype" id="505529">byte</span><span class="op" id="505533">(</span><span class="ident" id="505534">fmt</span><span class="op" id="505537">.</span><span class="ident" id="505538">Sprintf</span><span class="op" id="505545">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="505549">&#34;POST&nbsp;/&nbsp;HTTP/1.1\r\n&#34;</span><span class="op" id="505570">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="505575">&#34;Host:&nbsp;test\r\n&#34;</span><span class="op" id="505591">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="505596">&#34;Content-Length:&nbsp;%d\r\n&#34;</span><span class="op" id="505620">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="505625">&#34;\r\n&#34;</span><span class="op" id="505631">,</span>&nbsp;<span class="builtinfunc" id="505633">len</span><span class="op" id="505636">(</span><span class="ident" id="505637">body</span><span class="op" id="505641">)</span><span class="op" id="505642">)</span><span class="op" id="505643">)</span><span class="op" id="505644">)</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="505647">conn</span><span class="op" id="505651">.</span><span class="ident" id="505652">readBuf</span><span class="op" id="505659">.</span><span class="ident" id="505660">Write</span><span class="op" id="505665">(</span><span class="op" id="505666">[</span><span class="op" id="505667">]</span><span class="builtintype" id="505668">byte</span><span class="op" id="505672">(</span><span class="ident" id="505673">body</span><span class="op" id="505677">)</span><span class="op" id="505678">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="505682">done</span>&nbsp;<span class="op" id="505687">:=</span>&nbsp;<span class="builtinfunc" id="505690">make</span><span class="op" id="505694">(</span><span class="keyword" id="505695">chan</span>&nbsp;<span class="builtintype" id="505700">bool</span><span class="op" id="505704">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="505708">ls</span>&nbsp;<span class="op" id="505711">:=</span>&nbsp;<span class="op" id="505714">&amp;</span><span class="ident" id="505715">oneConnListener</span><span class="op" id="505730">{</span><span class="ident" id="505731">conn</span><span class="op" id="505735">}</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="505738">go</span>&nbsp;<span class="ident" id="505741">Serve</span><span class="op" id="505746">(</span><span class="ident" id="505747">ls</span><span class="op" id="505749">,</span>&nbsp;<span class="ident" id="505751">HandlerFunc</span><span class="op" id="505762">(</span><span class="keyword" id="505763">func</span><span class="op" id="505767">(</span><span class="ident" id="505768">rw</span>&nbsp;<span class="ident" id="505771">ResponseWriter</span><span class="op" id="505785">,</span>&nbsp;<span class="ident" id="505787">req</span>&nbsp;<span class="op" id="505791">*</span><span class="ident" id="505792">Request</span><span class="op" id="505799">)</span>&nbsp;<span class="op" id="505801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="505805">defer</span>&nbsp;<span class="builtinfunc" id="505811">close</span><span class="op" id="505816">(</span><span class="ident" id="505817">done</span><span class="op" id="505821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="505825">if</span>&nbsp;<span class="ident" id="505828">conn</span><span class="op" id="505832">.</span><span class="ident" id="505833">readBuf</span><span class="op" id="505840">.</span><span class="ident" id="505841">Len</span><span class="op" id="505844">(</span><span class="op" id="505845">)</span>&nbsp;<span class="op" id="505847">&lt;</span>&nbsp;<span class="builtinfunc" id="505849">len</span><span class="op" id="505852">(</span><span class="ident" id="505853">body</span><span class="op" id="505857">)</span><span class="op" id="505858">/</span><span class="num" id="505859">2</span>&nbsp;<span class="op" id="505861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="505866">t</span><span class="op" id="505867">.</span><span class="ident" id="505868">Errorf</span><span class="op" id="505874">(</span><span class="string" id="505875">&#34;on&nbsp;request,&nbsp;read&nbsp;buffer&nbsp;length&nbsp;is&nbsp;%d;&nbsp;expected&nbsp;about&nbsp;100&nbsp;KB&#34;</span><span class="op" id="505936">,</span>&nbsp;<span class="ident" id="505938">conn</span><span class="op" id="505942">.</span><span class="ident" id="505943">readBuf</span><span class="op" id="505950">.</span><span class="ident" id="505951">Len</span><span class="op" id="505954">(</span><span class="op" id="505955">)</span><span class="op" id="505956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="505960">}</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="505964">rw</span><span class="op" id="505966">.</span><span class="ident" id="505967">WriteHeader</span><span class="op" id="505978">(</span><span class="num" id="505979">200</span><span class="op" id="505982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="505986">rw</span><span class="op" id="505988">.</span><span class="op" id="505989">(</span><span class="ident" id="505990">Flusher</span><span class="op" id="505997">)</span><span class="op" id="505998">.</span><span class="ident" id="505999">Flush</span><span class="op" id="506004">(</span><span class="op" id="506005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="506009">if</span>&nbsp;<span class="ident" id="506012">g</span><span class="op" id="506013">,</span>&nbsp;<span class="ident" id="506015">e</span>&nbsp;<span class="op" id="506017">:=</span>&nbsp;<span class="ident" id="506020">conn</span><span class="op" id="506024">.</span><span class="ident" id="506025">readBuf</span><span class="op" id="506032">.</span><span class="ident" id="506033">Len</span><span class="op" id="506036">(</span><span class="op" id="506037">)</span><span class="op" id="506038">,</span>&nbsp;<span class="num" id="506040">0</span><span class="op" id="506041">;</span>&nbsp;<span class="ident" id="506043">g</span>&nbsp;<span class="op" id="506045">!=</span>&nbsp;<span class="ident" id="506048">e</span>&nbsp;<span class="op" id="506050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="506055">t</span><span class="op" id="506056">.</span><span class="ident" id="506057">Errorf</span><span class="op" id="506063">(</span><span class="string" id="506064">&#34;after&nbsp;WriteHeader,&nbsp;read&nbsp;buffer&nbsp;length&nbsp;is&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="506118">,</span>&nbsp;<span class="ident" id="506120">g</span><span class="op" id="506121">,</span>&nbsp;<span class="ident" id="506123">e</span><span class="op" id="506124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="506128">}</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="506132">if</span>&nbsp;<span class="ident" id="506135">c</span>&nbsp;<span class="op" id="506137">:=</span>&nbsp;<span class="ident" id="506140">rw</span><span class="op" id="506142">.</span><span class="ident" id="506143">Header</span><span class="op" id="506149">(</span><span class="op" id="506150">)</span><span class="op" id="506151">.</span><span class="ident" id="506152">Get</span><span class="op" id="506155">(</span><span class="string" id="506156">&#34;Connection&#34;</span><span class="op" id="506168">)</span><span class="op" id="506169">;</span>&nbsp;<span class="ident" id="506171">c</span>&nbsp;<span class="op" id="506173">!=</span>&nbsp;<span class="string" id="506176">&#34;&#34;</span>&nbsp;<span class="op" id="506179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="506184">t</span><span class="op" id="506185">.</span><span class="ident" id="506186">Errorf</span><span class="op" id="506192">(</span><span class="string" id="506193">`Connection&nbsp;header&nbsp;=&nbsp;%q;&nbsp;want&nbsp;&#34;&#34;`</span><span class="op" id="506226">,</span>&nbsp;<span class="ident" id="506228">c</span><span class="op" id="506229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="506233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="506236">}</span><span class="op" id="506237">)</span><span class="op" id="506238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="506241">&lt;-</span><span class="ident" id="506243">done</span><br>
<span class="lineno">1135</span><span class="op" id="506248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="506251">//&nbsp;Over&nbsp;a&nbsp;~256KB&nbsp;(maxPostHandlerReadBytes)&nbsp;threshold,&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="506316">//&nbsp;should&nbsp;ignore&nbsp;client&nbsp;request&nbsp;bodies&nbsp;that&nbsp;a&nbsp;handler&nbsp;didn&#39;t&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="506382">//&nbsp;and&nbsp;close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">1140</span><span class="keyword" id="506411">func</span>&nbsp;<span class="ident" id="506416">TestServerUnreadRequestBodyLarge</span><span class="op" id="506448">(</span><span class="ident" id="506449">t</span>&nbsp;<span class="op" id="506451">*</span><span class="ident" id="506452">testing</span><span class="op" id="506459">.</span><span class="ident" id="506460">T</span><span class="op" id="506461">)</span>&nbsp;<span class="op" id="506463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="506466">conn</span>&nbsp;<span class="op" id="506471">:=</span>&nbsp;<span class="builtinfunc" id="506474">new</span><span class="op" id="506477">(</span><span class="ident" id="506478">testConn</span><span class="op" id="506486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="506489">body</span>&nbsp;<span class="op" id="506494">:=</span>&nbsp;<span class="ident" id="506497">strings</span><span class="op" id="506504">.</span><span class="ident" id="506505">Repeat</span><span class="op" id="506511">(</span><span class="string" id="506512">&#34;x&#34;</span><span class="op" id="506515">,</span>&nbsp;<span class="num" id="506517">1</span><span class="op" id="506518">&lt;&lt;</span><span class="num" id="506520">20</span><span class="op" id="506522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="506525">conn</span><span class="op" id="506529">.</span><span class="ident" id="506530">readBuf</span><span class="op" id="506537">.</span><span class="ident" id="506538">Write</span><span class="op" id="506543">(</span><span class="op" id="506544">[</span><span class="op" id="506545">]</span><span class="builtintype" id="506546">byte</span><span class="op" id="506550">(</span><span class="ident" id="506551">fmt</span><span class="op" id="506554">.</span><span class="ident" id="506555">Sprintf</span><span class="op" id="506562">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="506566">&#34;POST&nbsp;/&nbsp;HTTP/1.1\r\n&#34;</span><span class="op" id="506587">+</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="506592">&#34;Host:&nbsp;test\r\n&#34;</span><span class="op" id="506608">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="506613">&#34;Content-Length:&nbsp;%d\r\n&#34;</span><span class="op" id="506637">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="506642">&#34;\r\n&#34;</span><span class="op" id="506648">,</span>&nbsp;<span class="builtinfunc" id="506650">len</span><span class="op" id="506653">(</span><span class="ident" id="506654">body</span><span class="op" id="506658">)</span><span class="op" id="506659">)</span><span class="op" id="506660">)</span><span class="op" id="506661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="506664">conn</span><span class="op" id="506668">.</span><span class="ident" id="506669">readBuf</span><span class="op" id="506676">.</span><span class="ident" id="506677">Write</span><span class="op" id="506682">(</span><span class="op" id="506683">[</span><span class="op" id="506684">]</span><span class="builtintype" id="506685">byte</span><span class="op" id="506689">(</span><span class="ident" id="506690">body</span><span class="op" id="506694">)</span><span class="op" id="506695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="506698">conn</span><span class="op" id="506702">.</span><span class="ident" id="506703">closec</span>&nbsp;<span class="op" id="506710">=</span>&nbsp;<span class="builtinfunc" id="506712">make</span><span class="op" id="506716">(</span><span class="keyword" id="506717">chan</span>&nbsp;<span class="builtintype" id="506722">bool</span><span class="op" id="506726">,</span>&nbsp;<span class="num" id="506728">1</span><span class="op" id="506729">)</span><br>
<span class="lineno">1150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="506733">ls</span>&nbsp;<span class="op" id="506736">:=</span>&nbsp;<span class="op" id="506739">&amp;</span><span class="ident" id="506740">oneConnListener</span><span class="op" id="506755">{</span><span class="ident" id="506756">conn</span><span class="op" id="506760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="506763">go</span>&nbsp;<span class="ident" id="506766">Serve</span><span class="op" id="506771">(</span><span class="ident" id="506772">ls</span><span class="op" id="506774">,</span>&nbsp;<span class="ident" id="506776">HandlerFunc</span><span class="op" id="506787">(</span><span class="keyword" id="506788">func</span><span class="op" id="506792">(</span><span class="ident" id="506793">rw</span>&nbsp;<span class="ident" id="506796">ResponseWriter</span><span class="op" id="506810">,</span>&nbsp;<span class="ident" id="506812">req</span>&nbsp;<span class="op" id="506816">*</span><span class="ident" id="506817">Request</span><span class="op" id="506824">)</span>&nbsp;<span class="op" id="506826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="506830">if</span>&nbsp;<span class="ident" id="506833">conn</span><span class="op" id="506837">.</span><span class="ident" id="506838">readBuf</span><span class="op" id="506845">.</span><span class="ident" id="506846">Len</span><span class="op" id="506849">(</span><span class="op" id="506850">)</span>&nbsp;<span class="op" id="506852">&lt;</span>&nbsp;<span class="builtinfunc" id="506854">len</span><span class="op" id="506857">(</span><span class="ident" id="506858">body</span><span class="op" id="506862">)</span><span class="op" id="506863">/</span><span class="num" id="506864">2</span>&nbsp;<span class="op" id="506866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="506871">t</span><span class="op" id="506872">.</span><span class="ident" id="506873">Errorf</span><span class="op" id="506879">(</span><span class="string" id="506880">&#34;on&nbsp;request,&nbsp;read&nbsp;buffer&nbsp;length&nbsp;is&nbsp;%d;&nbsp;expected&nbsp;about&nbsp;1MB&#34;</span><span class="op" id="506938">,</span>&nbsp;<span class="ident" id="506940">conn</span><span class="op" id="506944">.</span><span class="ident" id="506945">readBuf</span><span class="op" id="506952">.</span><span class="ident" id="506953">Len</span><span class="op" id="506956">(</span><span class="op" id="506957">)</span><span class="op" id="506958">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="506962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="506966">rw</span><span class="op" id="506968">.</span><span class="ident" id="506969">WriteHeader</span><span class="op" id="506980">(</span><span class="num" id="506981">200</span><span class="op" id="506984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="506988">rw</span><span class="op" id="506990">.</span><span class="op" id="506991">(</span><span class="ident" id="506992">Flusher</span><span class="op" id="506999">)</span><span class="op" id="507000">.</span><span class="ident" id="507001">Flush</span><span class="op" id="507006">(</span><span class="op" id="507007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="507011">if</span>&nbsp;<span class="ident" id="507014">conn</span><span class="op" id="507018">.</span><span class="ident" id="507019">readBuf</span><span class="op" id="507026">.</span><span class="ident" id="507027">Len</span><span class="op" id="507030">(</span><span class="op" id="507031">)</span>&nbsp;<span class="op" id="507033">&lt;</span>&nbsp;<span class="builtinfunc" id="507035">len</span><span class="op" id="507038">(</span><span class="ident" id="507039">body</span><span class="op" id="507043">)</span><span class="op" id="507044">/</span><span class="num" id="507045">2</span>&nbsp;<span class="op" id="507047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="507052">t</span><span class="op" id="507053">.</span><span class="ident" id="507054">Errorf</span><span class="op" id="507060">(</span><span class="string" id="507061">&#34;post-WriteHeader,&nbsp;read&nbsp;buffer&nbsp;length&nbsp;is&nbsp;%d;&nbsp;expected&nbsp;about&nbsp;1MB&#34;</span><span class="op" id="507125">,</span>&nbsp;<span class="ident" id="507127">conn</span><span class="op" id="507131">.</span><span class="ident" id="507132">readBuf</span><span class="op" id="507139">.</span><span class="ident" id="507140">Len</span><span class="op" id="507143">(</span><span class="op" id="507144">)</span><span class="op" id="507145">)</span><br>
<span class="lineno">1160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="507149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="507152">}</span><span class="op" id="507153">)</span><span class="op" id="507154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="507157">&lt;-</span><span class="ident" id="507159">conn</span><span class="op" id="507163">.</span><span class="ident" id="507164">closec</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="507173">if</span>&nbsp;<span class="ident" id="507176">res</span>&nbsp;<span class="op" id="507180">:=</span>&nbsp;<span class="ident" id="507183">conn</span><span class="op" id="507187">.</span><span class="ident" id="507188">writeBuf</span><span class="op" id="507196">.</span><span class="ident" id="507197">String</span><span class="op" id="507203">(</span><span class="op" id="507204">)</span><span class="op" id="507205">;</span>&nbsp;<span class="op" id="507207">!</span><span class="ident" id="507208">strings</span><span class="op" id="507215">.</span><span class="ident" id="507216">Contains</span><span class="op" id="507224">(</span><span class="ident" id="507225">res</span><span class="op" id="507228">,</span>&nbsp;<span class="string" id="507230">&#34;Connection:&nbsp;close&#34;</span><span class="op" id="507249">)</span>&nbsp;<span class="op" id="507251">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="507255">t</span><span class="op" id="507256">.</span><span class="ident" id="507257">Errorf</span><span class="op" id="507263">(</span><span class="string" id="507264">&#34;Expected&nbsp;a&nbsp;Connection:&nbsp;close&nbsp;header;&nbsp;got&nbsp;response:&nbsp;%s&#34;</span><span class="op" id="507319">,</span>&nbsp;<span class="ident" id="507321">res</span><span class="op" id="507324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="507327">}</span><br>
<span class="lineno"></span><span class="op" id="507329">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="507332">func</span>&nbsp;<span class="ident" id="507337">TestTimeoutHandler</span><span class="op" id="507355">(</span><span class="ident" id="507356">t</span>&nbsp;<span class="op" id="507358">*</span><span class="ident" id="507359">testing</span><span class="op" id="507366">.</span><span class="ident" id="507367">T</span><span class="op" id="507368">)</span>&nbsp;<span class="op" id="507370">{</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="507373">defer</span>&nbsp;<span class="ident" id="507379">afterTest</span><span class="op" id="507388">(</span><span class="ident" id="507389">t</span><span class="op" id="507390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="507393">sendHi</span>&nbsp;<span class="op" id="507400">:=</span>&nbsp;<span class="builtinfunc" id="507403">make</span><span class="op" id="507407">(</span><span class="keyword" id="507408">chan</span>&nbsp;<span class="builtintype" id="507413">bool</span><span class="op" id="507417">,</span>&nbsp;<span class="num" id="507419">1</span><span class="op" id="507420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="507423">writeErrors</span>&nbsp;<span class="op" id="507435">:=</span>&nbsp;<span class="builtinfunc" id="507438">make</span><span class="op" id="507442">(</span><span class="keyword" id="507443">chan</span>&nbsp;<span class="builtintype" id="507448">error</span><span class="op" id="507453">,</span>&nbsp;<span class="num" id="507455">1</span><span class="op" id="507456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="507459">sayHi</span>&nbsp;<span class="op" id="507465">:=</span>&nbsp;<span class="ident" id="507468">HandlerFunc</span><span class="op" id="507479">(</span><span class="keyword" id="507480">func</span><span class="op" id="507484">(</span><span class="ident" id="507485">w</span>&nbsp;<span class="ident" id="507487">ResponseWriter</span><span class="op" id="507501">,</span>&nbsp;<span class="ident" id="507503">r</span>&nbsp;<span class="op" id="507505">*</span><span class="ident" id="507506">Request</span><span class="op" id="507513">)</span>&nbsp;<span class="op" id="507515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="507519">&lt;-</span><span class="ident" id="507521">sendHi</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="507530">_</span><span class="op" id="507531">,</span>&nbsp;<span class="ident" id="507533">werr</span>&nbsp;<span class="op" id="507538">:=</span>&nbsp;<span class="ident" id="507541">w</span><span class="op" id="507542">.</span><span class="ident" id="507543">Write</span><span class="op" id="507548">(</span><span class="op" id="507549">[</span><span class="op" id="507550">]</span><span class="builtintype" id="507551">byte</span><span class="op" id="507555">(</span><span class="string" id="507556">&#34;hi&#34;</span><span class="op" id="507560">)</span><span class="op" id="507561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="507565">writeErrors</span>&nbsp;<span class="op" id="507577">&lt;-</span>&nbsp;<span class="ident" id="507580">werr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="507586">}</span><span class="op" id="507587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="507590">timeout</span>&nbsp;<span class="op" id="507598">:=</span>&nbsp;<span class="builtinfunc" id="507601">make</span><span class="op" id="507605">(</span><span class="keyword" id="507606">chan</span>&nbsp;<span class="ident" id="507611">time</span><span class="op" id="507615">.</span><span class="ident" id="507616">Time</span><span class="op" id="507620">,</span>&nbsp;<span class="num" id="507622">1</span><span class="op" id="507623">)</span>&nbsp;<span class="comment" id="507625">//&nbsp;write&nbsp;to&nbsp;this&nbsp;to&nbsp;force&nbsp;timeouts</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="507661">ts</span>&nbsp;<span class="op" id="507664">:=</span>&nbsp;<span class="ident" id="507667">httptest</span><span class="op" id="507675">.</span><span class="ident" id="507676">NewServer</span><span class="op" id="507685">(</span><span class="ident" id="507686">NewTestTimeoutHandler</span><span class="op" id="507707">(</span><span class="ident" id="507708">sayHi</span><span class="op" id="507713">,</span>&nbsp;<span class="ident" id="507715">timeout</span><span class="op" id="507722">)</span><span class="op" id="507723">)</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="507726">defer</span>&nbsp;<span class="ident" id="507732">ts</span><span class="op" id="507734">.</span><span class="ident" id="507735">Close</span><span class="op" id="507740">(</span><span class="op" id="507741">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="507745">//&nbsp;Succeed&nbsp;without&nbsp;timing&nbsp;out:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="507777">sendHi</span>&nbsp;<span class="op" id="507784">&lt;-</span>&nbsp;<span class="builtintype" id="507787">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="507793">res</span><span class="op" id="507796">,</span>&nbsp;<span class="ident" id="507798">err</span>&nbsp;<span class="op" id="507802">:=</span>&nbsp;<span class="ident" id="507805">Get</span><span class="op" id="507808">(</span><span class="ident" id="507809">ts</span><span class="op" id="507811">.</span><span class="ident" id="507812">URL</span><span class="op" id="507815">)</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="507818">if</span>&nbsp;<span class="ident" id="507821">err</span>&nbsp;<span class="op" id="507825">!=</span>&nbsp;<span class="builtintype" id="507828">nil</span>&nbsp;<span class="op" id="507832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="507836">t</span><span class="op" id="507837">.</span><span class="ident" id="507838">Error</span><span class="op" id="507843">(</span><span class="ident" id="507844">err</span><span class="op" id="507847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="507850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="507853">if</span>&nbsp;<span class="ident" id="507856">g</span><span class="op" id="507857">,</span>&nbsp;<span class="ident" id="507859">e</span>&nbsp;<span class="op" id="507861">:=</span>&nbsp;<span class="ident" id="507864">res</span><span class="op" id="507867">.</span><span class="ident" id="507868">StatusCode</span><span class="op" id="507878">,</span>&nbsp;<span class="ident" id="507880">StatusOK</span><span class="op" id="507888">;</span>&nbsp;<span class="ident" id="507890">g</span>&nbsp;<span class="op" id="507892">!=</span>&nbsp;<span class="ident" id="507895">e</span>&nbsp;<span class="op" id="507897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="507901">t</span><span class="op" id="507902">.</span><span class="ident" id="507903">Errorf</span><span class="op" id="507909">(</span><span class="string" id="507910">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="507946">,</span>&nbsp;<span class="ident" id="507948">g</span><span class="op" id="507949">,</span>&nbsp;<span class="ident" id="507951">e</span><span class="op" id="507952">)</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="507955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="507958">body</span><span class="op" id="507962">,</span>&nbsp;<span class="ident" id="507964">_</span>&nbsp;<span class="op" id="507966">:=</span>&nbsp;<span class="ident" id="507969">ioutil</span><span class="op" id="507975">.</span><span class="ident" id="507976">ReadAll</span><span class="op" id="507983">(</span><span class="ident" id="507984">res</span><span class="op" id="507987">.</span><span class="ident" id="507988">Body</span><span class="op" id="507992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="507995">if</span>&nbsp;<span class="ident" id="507998">g</span><span class="op" id="507999">,</span>&nbsp;<span class="ident" id="508001">e</span>&nbsp;<span class="op" id="508003">:=</span>&nbsp;<span class="builtintype" id="508006">string</span><span class="op" id="508012">(</span><span class="ident" id="508013">body</span><span class="op" id="508017">)</span><span class="op" id="508018">,</span>&nbsp;<span class="string" id="508020">&#34;hi&#34;</span><span class="op" id="508024">;</span>&nbsp;<span class="ident" id="508026">g</span>&nbsp;<span class="op" id="508028">!=</span>&nbsp;<span class="ident" id="508031">e</span>&nbsp;<span class="op" id="508033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="508037">t</span><span class="op" id="508038">.</span><span class="ident" id="508039">Errorf</span><span class="op" id="508045">(</span><span class="string" id="508046">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="508072">,</span>&nbsp;<span class="ident" id="508074">g</span><span class="op" id="508075">,</span>&nbsp;<span class="ident" id="508077">e</span><span class="op" id="508078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="508081">}</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="508084">if</span>&nbsp;<span class="ident" id="508087">g</span>&nbsp;<span class="op" id="508089">:=</span>&nbsp;<span class="op" id="508092">&lt;-</span><span class="ident" id="508094">writeErrors</span><span class="op" id="508105">;</span>&nbsp;<span class="ident" id="508107">g</span>&nbsp;<span class="op" id="508109">!=</span>&nbsp;<span class="builtintype" id="508112">nil</span>&nbsp;<span class="op" id="508116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="508120">t</span><span class="op" id="508121">.</span><span class="ident" id="508122">Errorf</span><span class="op" id="508128">(</span><span class="string" id="508129">&#34;got&nbsp;unexpected&nbsp;Write&nbsp;error&nbsp;on&nbsp;first&nbsp;request:&nbsp;%v&#34;</span><span class="op" id="508178">,</span>&nbsp;<span class="ident" id="508180">g</span><span class="op" id="508181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="508184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="508188">//&nbsp;Times&nbsp;out:</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="508203">timeout</span>&nbsp;<span class="op" id="508211">&lt;-</span>&nbsp;<span class="ident" id="508214">time</span><span class="op" id="508218">.</span><span class="ident" id="508219">Time</span><span class="op" id="508223">{</span><span class="op" id="508224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="508227">res</span><span class="op" id="508230">,</span>&nbsp;<span class="ident" id="508232">err</span>&nbsp;<span class="op" id="508236">=</span>&nbsp;<span class="ident" id="508238">Get</span><span class="op" id="508241">(</span><span class="ident" id="508242">ts</span><span class="op" id="508244">.</span><span class="ident" id="508245">URL</span><span class="op" id="508248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="508251">if</span>&nbsp;<span class="ident" id="508254">err</span>&nbsp;<span class="op" id="508258">!=</span>&nbsp;<span class="builtintype" id="508261">nil</span>&nbsp;<span class="op" id="508265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="508269">t</span><span class="op" id="508270">.</span><span class="ident" id="508271">Error</span><span class="op" id="508276">(</span><span class="ident" id="508277">err</span><span class="op" id="508280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="508283">}</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="508286">if</span>&nbsp;<span class="ident" id="508289">g</span><span class="op" id="508290">,</span>&nbsp;<span class="ident" id="508292">e</span>&nbsp;<span class="op" id="508294">:=</span>&nbsp;<span class="ident" id="508297">res</span><span class="op" id="508300">.</span><span class="ident" id="508301">StatusCode</span><span class="op" id="508311">,</span>&nbsp;<span class="ident" id="508313">StatusServiceUnavailable</span><span class="op" id="508337">;</span>&nbsp;<span class="ident" id="508339">g</span>&nbsp;<span class="op" id="508341">!=</span>&nbsp;<span class="ident" id="508344">e</span>&nbsp;<span class="op" id="508346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="508350">t</span><span class="op" id="508351">.</span><span class="ident" id="508352">Errorf</span><span class="op" id="508358">(</span><span class="string" id="508359">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="508395">,</span>&nbsp;<span class="ident" id="508397">g</span><span class="op" id="508398">,</span>&nbsp;<span class="ident" id="508400">e</span><span class="op" id="508401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="508404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="508407">body</span><span class="op" id="508411">,</span>&nbsp;<span class="ident" id="508413">_</span>&nbsp;<span class="op" id="508415">=</span>&nbsp;<span class="ident" id="508417">ioutil</span><span class="op" id="508423">.</span><span class="ident" id="508424">ReadAll</span><span class="op" id="508431">(</span><span class="ident" id="508432">res</span><span class="op" id="508435">.</span><span class="ident" id="508436">Body</span><span class="op" id="508440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="508443">if</span>&nbsp;<span class="op" id="508446">!</span><span class="ident" id="508447">strings</span><span class="op" id="508454">.</span><span class="ident" id="508455">Contains</span><span class="op" id="508463">(</span><span class="builtintype" id="508464">string</span><span class="op" id="508470">(</span><span class="ident" id="508471">body</span><span class="op" id="508475">)</span><span class="op" id="508476">,</span>&nbsp;<span class="string" id="508478">&#34;&lt;title&gt;Timeout&lt;/title&gt;&#34;</span><span class="op" id="508502">)</span>&nbsp;<span class="op" id="508504">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="508508">t</span><span class="op" id="508509">.</span><span class="ident" id="508510">Errorf</span><span class="op" id="508516">(</span><span class="string" id="508517">&#34;expected&nbsp;timeout&nbsp;body;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="508548">,</span>&nbsp;<span class="builtintype" id="508550">string</span><span class="op" id="508556">(</span><span class="ident" id="508557">body</span><span class="op" id="508561">)</span><span class="op" id="508562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="508565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="508569">//&nbsp;Now&nbsp;make&nbsp;the&nbsp;previously-timed&nbsp;out&nbsp;handler&nbsp;speak&nbsp;again,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="508628">//&nbsp;which&nbsp;verifies&nbsp;the&nbsp;panic&nbsp;is&nbsp;handled:</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="508669">sendHi</span>&nbsp;<span class="op" id="508676">&lt;-</span>&nbsp;<span class="builtintype" id="508679">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="508685">if</span>&nbsp;<span class="ident" id="508688">g</span><span class="op" id="508689">,</span>&nbsp;<span class="ident" id="508691">e</span>&nbsp;<span class="op" id="508693">:=</span>&nbsp;<span class="op" id="508696">&lt;-</span><span class="ident" id="508698">writeErrors</span><span class="op" id="508709">,</span>&nbsp;<span class="ident" id="508711">ErrHandlerTimeout</span><span class="op" id="508728">;</span>&nbsp;<span class="ident" id="508730">g</span>&nbsp;<span class="op" id="508732">!=</span>&nbsp;<span class="ident" id="508735">e</span>&nbsp;<span class="op" id="508737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="508741">t</span><span class="op" id="508742">.</span><span class="ident" id="508743">Errorf</span><span class="op" id="508749">(</span><span class="string" id="508750">&#34;expected&nbsp;Write&nbsp;error&nbsp;of&nbsp;%v;&nbsp;got&nbsp;%v&#34;</span><span class="op" id="508786">,</span>&nbsp;<span class="ident" id="508788">e</span><span class="op" id="508789">,</span>&nbsp;<span class="ident" id="508791">g</span><span class="op" id="508792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="508795">}</span><br>
<span class="lineno"></span><span class="op" id="508797">}</span><br>
<span class="lineno">1220</span><br>
<span class="lineno"></span><span class="comment" id="508800">//&nbsp;See&nbsp;issues&nbsp;8209&nbsp;and&nbsp;8414.</span><br>
<span class="lineno"></span><span class="keyword" id="508829">func</span>&nbsp;<span class="ident" id="508834">TestTimeoutHandlerRace</span><span class="op" id="508856">(</span><span class="ident" id="508857">t</span>&nbsp;<span class="op" id="508859">*</span><span class="ident" id="508860">testing</span><span class="op" id="508867">.</span><span class="ident" id="508868">T</span><span class="op" id="508869">)</span>&nbsp;<span class="op" id="508871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="508874">defer</span>&nbsp;<span class="ident" id="508880">afterTest</span><span class="op" id="508889">(</span><span class="ident" id="508890">t</span><span class="op" id="508891">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="508895">delayHi</span>&nbsp;<span class="op" id="508903">:=</span>&nbsp;<span class="ident" id="508906">HandlerFunc</span><span class="op" id="508917">(</span><span class="keyword" id="508918">func</span><span class="op" id="508922">(</span><span class="ident" id="508923">w</span>&nbsp;<span class="ident" id="508925">ResponseWriter</span><span class="op" id="508939">,</span>&nbsp;<span class="ident" id="508941">r</span>&nbsp;<span class="op" id="508943">*</span><span class="ident" id="508944">Request</span><span class="op" id="508951">)</span>&nbsp;<span class="op" id="508953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="508957">ms</span><span class="op" id="508959">,</span>&nbsp;<span class="ident" id="508961">_</span>&nbsp;<span class="op" id="508963">:=</span>&nbsp;<span class="ident" id="508966">strconv</span><span class="op" id="508973">.</span><span class="ident" id="508974">Atoi</span><span class="op" id="508978">(</span><span class="ident" id="508979">r</span><span class="op" id="508980">.</span><span class="ident" id="508981">URL</span><span class="op" id="508984">.</span><span class="ident" id="508985">Path</span><span class="op" id="508989">[</span><span class="num" id="508990">1</span><span class="op" id="508991">:</span><span class="op" id="508992">]</span><span class="op" id="508993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="508997">if</span>&nbsp;<span class="ident" id="509000">ms</span>&nbsp;<span class="op" id="509003">==</span>&nbsp;<span class="num" id="509006">0</span>&nbsp;<span class="op" id="509008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509013">ms</span>&nbsp;<span class="op" id="509016">=</span>&nbsp;<span class="num" id="509018">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="509022">}</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="509026">for</span>&nbsp;<span class="ident" id="509030">i</span>&nbsp;<span class="op" id="509032">:=</span>&nbsp;<span class="num" id="509035">0</span><span class="op" id="509036">;</span>&nbsp;<span class="ident" id="509038">i</span>&nbsp;<span class="op" id="509040">&lt;</span>&nbsp;<span class="ident" id="509042">ms</span><span class="op" id="509044">;</span>&nbsp;<span class="ident" id="509046">i</span><span class="op" id="509047">++</span>&nbsp;<span class="op" id="509050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509055">w</span><span class="op" id="509056">.</span><span class="ident" id="509057">Write</span><span class="op" id="509062">(</span><span class="op" id="509063">[</span><span class="op" id="509064">]</span><span class="builtintype" id="509065">byte</span><span class="op" id="509069">(</span><span class="string" id="509070">&#34;hi&#34;</span><span class="op" id="509074">)</span><span class="op" id="509075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509080">time</span><span class="op" id="509084">.</span><span class="ident" id="509085">Sleep</span><span class="op" id="509090">(</span><span class="ident" id="509091">time</span><span class="op" id="509095">.</span><span class="ident" id="509096">Millisecond</span><span class="op" id="509107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="509111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="509114">}</span><span class="op" id="509115">)</span><br>
<span class="lineno">1235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509119">ts</span>&nbsp;<span class="op" id="509122">:=</span>&nbsp;<span class="ident" id="509125">httptest</span><span class="op" id="509133">.</span><span class="ident" id="509134">NewServer</span><span class="op" id="509143">(</span><span class="ident" id="509144">TimeoutHandler</span><span class="op" id="509158">(</span><span class="ident" id="509159">delayHi</span><span class="op" id="509166">,</span>&nbsp;<span class="num" id="509168">20</span><span class="op" id="509170">*</span><span class="ident" id="509171">time</span><span class="op" id="509175">.</span><span class="ident" id="509176">Millisecond</span><span class="op" id="509187">,</span>&nbsp;<span class="string" id="509189">&#34;&#34;</span><span class="op" id="509191">)</span><span class="op" id="509192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="509195">defer</span>&nbsp;<span class="ident" id="509201">ts</span><span class="op" id="509203">.</span><span class="ident" id="509204">Close</span><span class="op" id="509209">(</span><span class="op" id="509210">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="509214">var</span>&nbsp;<span class="ident" id="509218">wg</span>&nbsp;<span class="ident" id="509221">sync</span><span class="op" id="509225">.</span><span class="ident" id="509226">WaitGroup</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509237">gate</span>&nbsp;<span class="op" id="509242">:=</span>&nbsp;<span class="builtinfunc" id="509245">make</span><span class="op" id="509249">(</span><span class="keyword" id="509250">chan</span>&nbsp;<span class="builtintype" id="509255">bool</span><span class="op" id="509259">,</span>&nbsp;<span class="num" id="509261">10</span><span class="op" id="509263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509266">n</span>&nbsp;<span class="op" id="509268">:=</span>&nbsp;<span class="num" id="509271">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="509275">if</span>&nbsp;<span class="ident" id="509278">testing</span><span class="op" id="509285">.</span><span class="ident" id="509286">Short</span><span class="op" id="509291">(</span><span class="op" id="509292">)</span>&nbsp;<span class="op" id="509294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509298">n</span>&nbsp;<span class="op" id="509300">=</span>&nbsp;<span class="num" id="509302">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509307">gate</span>&nbsp;<span class="op" id="509312">=</span>&nbsp;<span class="builtinfunc" id="509314">make</span><span class="op" id="509318">(</span><span class="keyword" id="509319">chan</span>&nbsp;<span class="builtintype" id="509324">bool</span><span class="op" id="509328">,</span>&nbsp;<span class="num" id="509330">3</span><span class="op" id="509331">)</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="509334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="509337">for</span>&nbsp;<span class="ident" id="509341">i</span>&nbsp;<span class="op" id="509343">:=</span>&nbsp;<span class="num" id="509346">0</span><span class="op" id="509347">;</span>&nbsp;<span class="ident" id="509349">i</span>&nbsp;<span class="op" id="509351">&lt;</span>&nbsp;<span class="ident" id="509353">n</span><span class="op" id="509354">;</span>&nbsp;<span class="ident" id="509356">i</span><span class="op" id="509357">++</span>&nbsp;<span class="op" id="509360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509364">gate</span>&nbsp;<span class="op" id="509369">&lt;-</span>&nbsp;<span class="builtintype" id="509372">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509379">wg</span><span class="op" id="509381">.</span><span class="ident" id="509382">Add</span><span class="op" id="509385">(</span><span class="num" id="509386">1</span><span class="op" id="509387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="509391">go</span>&nbsp;<span class="keyword" id="509394">func</span><span class="op" id="509398">(</span><span class="op" id="509399">)</span>&nbsp;<span class="op" id="509401">{</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="509406">defer</span>&nbsp;<span class="ident" id="509412">wg</span><span class="op" id="509414">.</span><span class="ident" id="509415">Done</span><span class="op" id="509419">(</span><span class="op" id="509420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="509425">defer</span>&nbsp;<span class="keyword" id="509431">func</span><span class="op" id="509435">(</span><span class="op" id="509436">)</span>&nbsp;<span class="op" id="509438">{</span>&nbsp;<span class="op" id="509440">&lt;-</span><span class="ident" id="509442">gate</span>&nbsp;<span class="op" id="509447">}</span><span class="op" id="509448">(</span><span class="op" id="509449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509454">res</span><span class="op" id="509457">,</span>&nbsp;<span class="ident" id="509459">err</span>&nbsp;<span class="op" id="509463">:=</span>&nbsp;<span class="ident" id="509466">Get</span><span class="op" id="509469">(</span><span class="ident" id="509470">fmt</span><span class="op" id="509473">.</span><span class="ident" id="509474">Sprintf</span><span class="op" id="509481">(</span><span class="string" id="509482">&#34;%s/%d&#34;</span><span class="op" id="509489">,</span>&nbsp;<span class="ident" id="509491">ts</span><span class="op" id="509493">.</span><span class="ident" id="509494">URL</span><span class="op" id="509497">,</span>&nbsp;<span class="ident" id="509499">rand</span><span class="op" id="509503">.</span><span class="ident" id="509504">Intn</span><span class="op" id="509508">(</span><span class="num" id="509509">50</span><span class="op" id="509511">)</span><span class="op" id="509512">)</span><span class="op" id="509513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="509518">if</span>&nbsp;<span class="ident" id="509521">err</span>&nbsp;<span class="op" id="509525">==</span>&nbsp;<span class="builtintype" id="509528">nil</span>&nbsp;<span class="op" id="509532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509538">io</span><span class="op" id="509540">.</span><span class="ident" id="509541">Copy</span><span class="op" id="509545">(</span><span class="ident" id="509546">ioutil</span><span class="op" id="509552">.</span><span class="ident" id="509553">Discard</span><span class="op" id="509560">,</span>&nbsp;<span class="ident" id="509562">res</span><span class="op" id="509565">.</span><span class="ident" id="509566">Body</span><span class="op" id="509570">)</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509576">res</span><span class="op" id="509579">.</span><span class="ident" id="509580">Body</span><span class="op" id="509584">.</span><span class="ident" id="509585">Close</span><span class="op" id="509590">(</span><span class="op" id="509591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="509596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="509600">}</span><span class="op" id="509601">(</span><span class="op" id="509602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="509605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509608">wg</span><span class="op" id="509610">.</span><span class="ident" id="509611">Wait</span><span class="op" id="509615">(</span><span class="op" id="509616">)</span><br>
<span class="lineno">1260</span><span class="op" id="509618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="509621">//&nbsp;See&nbsp;issues&nbsp;8209&nbsp;and&nbsp;8414.</span><br>
<span class="lineno"></span><span class="keyword" id="509650">func</span>&nbsp;<span class="ident" id="509655">TestTimeoutHandlerRaceHeader</span><span class="op" id="509683">(</span><span class="ident" id="509684">t</span>&nbsp;<span class="op" id="509686">*</span><span class="ident" id="509687">testing</span><span class="op" id="509694">.</span><span class="ident" id="509695">T</span><span class="op" id="509696">)</span>&nbsp;<span class="op" id="509698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="509701">defer</span>&nbsp;<span class="ident" id="509707">afterTest</span><span class="op" id="509716">(</span><span class="ident" id="509717">t</span><span class="op" id="509718">)</span><br>
<span class="lineno">1265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509722">delay204</span>&nbsp;<span class="op" id="509731">:=</span>&nbsp;<span class="ident" id="509734">HandlerFunc</span><span class="op" id="509745">(</span><span class="keyword" id="509746">func</span><span class="op" id="509750">(</span><span class="ident" id="509751">w</span>&nbsp;<span class="ident" id="509753">ResponseWriter</span><span class="op" id="509767">,</span>&nbsp;<span class="ident" id="509769">r</span>&nbsp;<span class="op" id="509771">*</span><span class="ident" id="509772">Request</span><span class="op" id="509779">)</span>&nbsp;<span class="op" id="509781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509785">w</span><span class="op" id="509786">.</span><span class="ident" id="509787">WriteHeader</span><span class="op" id="509798">(</span><span class="num" id="509799">204</span><span class="op" id="509802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="509805">}</span><span class="op" id="509806">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509810">ts</span>&nbsp;<span class="op" id="509813">:=</span>&nbsp;<span class="ident" id="509816">httptest</span><span class="op" id="509824">.</span><span class="ident" id="509825">NewServer</span><span class="op" id="509834">(</span><span class="ident" id="509835">TimeoutHandler</span><span class="op" id="509849">(</span><span class="ident" id="509850">delay204</span><span class="op" id="509858">,</span>&nbsp;<span class="ident" id="509860">time</span><span class="op" id="509864">.</span><span class="ident" id="509865">Nanosecond</span><span class="op" id="509875">,</span>&nbsp;<span class="string" id="509877">&#34;&#34;</span><span class="op" id="509879">)</span><span class="op" id="509880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="509883">defer</span>&nbsp;<span class="ident" id="509889">ts</span><span class="op" id="509891">.</span><span class="ident" id="509892">Close</span><span class="op" id="509897">(</span><span class="op" id="509898">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="509902">var</span>&nbsp;<span class="ident" id="509906">wg</span>&nbsp;<span class="ident" id="509909">sync</span><span class="op" id="509913">.</span><span class="ident" id="509914">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509925">gate</span>&nbsp;<span class="op" id="509930">:=</span>&nbsp;<span class="builtinfunc" id="509933">make</span><span class="op" id="509937">(</span><span class="keyword" id="509938">chan</span>&nbsp;<span class="builtintype" id="509943">bool</span><span class="op" id="509947">,</span>&nbsp;<span class="num" id="509949">50</span><span class="op" id="509951">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509954">n</span>&nbsp;<span class="op" id="509956">:=</span>&nbsp;<span class="num" id="509959">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="509964">if</span>&nbsp;<span class="ident" id="509967">testing</span><span class="op" id="509974">.</span><span class="ident" id="509975">Short</span><span class="op" id="509980">(</span><span class="op" id="509981">)</span>&nbsp;<span class="op" id="509983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="509987">n</span>&nbsp;<span class="op" id="509989">=</span>&nbsp;<span class="num" id="509991">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="509995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="509998">for</span>&nbsp;<span class="ident" id="510002">i</span>&nbsp;<span class="op" id="510004">:=</span>&nbsp;<span class="num" id="510007">0</span><span class="op" id="510008">;</span>&nbsp;<span class="ident" id="510010">i</span>&nbsp;<span class="op" id="510012">&lt;</span>&nbsp;<span class="ident" id="510014">n</span><span class="op" id="510015">;</span>&nbsp;<span class="ident" id="510017">i</span><span class="op" id="510018">++</span>&nbsp;<span class="op" id="510021">{</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="510025">gate</span>&nbsp;<span class="op" id="510030">&lt;-</span>&nbsp;<span class="builtintype" id="510033">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="510040">wg</span><span class="op" id="510042">.</span><span class="ident" id="510043">Add</span><span class="op" id="510046">(</span><span class="num" id="510047">1</span><span class="op" id="510048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="510052">go</span>&nbsp;<span class="keyword" id="510055">func</span><span class="op" id="510059">(</span><span class="op" id="510060">)</span>&nbsp;<span class="op" id="510062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="510067">defer</span>&nbsp;<span class="ident" id="510073">wg</span><span class="op" id="510075">.</span><span class="ident" id="510076">Done</span><span class="op" id="510080">(</span><span class="op" id="510081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="510086">defer</span>&nbsp;<span class="keyword" id="510092">func</span><span class="op" id="510096">(</span><span class="op" id="510097">)</span>&nbsp;<span class="op" id="510099">{</span>&nbsp;<span class="op" id="510101">&lt;-</span><span class="ident" id="510103">gate</span>&nbsp;<span class="op" id="510108">}</span><span class="op" id="510109">(</span><span class="op" id="510110">)</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="510115">res</span><span class="op" id="510118">,</span>&nbsp;<span class="ident" id="510120">err</span>&nbsp;<span class="op" id="510124">:=</span>&nbsp;<span class="ident" id="510127">Get</span><span class="op" id="510130">(</span><span class="ident" id="510131">ts</span><span class="op" id="510133">.</span><span class="ident" id="510134">URL</span><span class="op" id="510137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="510142">if</span>&nbsp;<span class="ident" id="510145">err</span>&nbsp;<span class="op" id="510149">!=</span>&nbsp;<span class="builtintype" id="510152">nil</span>&nbsp;<span class="op" id="510156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="510162">t</span><span class="op" id="510163">.</span><span class="ident" id="510164">Error</span><span class="op" id="510169">(</span><span class="ident" id="510170">err</span><span class="op" id="510173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="510179">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="510189">}</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="510194">defer</span>&nbsp;<span class="ident" id="510200">res</span><span class="op" id="510203">.</span><span class="ident" id="510204">Body</span><span class="op" id="510208">.</span><span class="ident" id="510209">Close</span><span class="op" id="510214">(</span><span class="op" id="510215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="510220">io</span><span class="op" id="510222">.</span><span class="ident" id="510223">Copy</span><span class="op" id="510227">(</span><span class="ident" id="510228">ioutil</span><span class="op" id="510234">.</span><span class="ident" id="510235">Discard</span><span class="op" id="510242">,</span>&nbsp;<span class="ident" id="510244">res</span><span class="op" id="510247">.</span><span class="ident" id="510248">Body</span><span class="op" id="510252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="510256">}</span><span class="op" id="510257">(</span><span class="op" id="510258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="510261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="510264">wg</span><span class="op" id="510266">.</span><span class="ident" id="510267">Wait</span><span class="op" id="510271">(</span><span class="op" id="510272">)</span><br>
<span class="lineno">1295</span><span class="op" id="510274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="510277">//&nbsp;Verifies&nbsp;we&nbsp;don&#39;t&nbsp;path.Clean()&nbsp;on&nbsp;the&nbsp;wrong&nbsp;parts&nbsp;in&nbsp;redirects.</span><br>
<span class="lineno"></span><span class="keyword" id="510344">func</span>&nbsp;<span class="ident" id="510349">TestRedirectMunging</span><span class="op" id="510368">(</span><span class="ident" id="510369">t</span>&nbsp;<span class="op" id="510371">*</span><span class="ident" id="510372">testing</span><span class="op" id="510379">.</span><span class="ident" id="510380">T</span><span class="op" id="510381">)</span>&nbsp;<span class="op" id="510383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="510386">req</span><span class="op" id="510389">,</span>&nbsp;<span class="ident" id="510391">_</span>&nbsp;<span class="op" id="510393">:=</span>&nbsp;<span class="ident" id="510396">NewRequest</span><span class="op" id="510406">(</span><span class="string" id="510407">&#34;GET&#34;</span><span class="op" id="510412">,</span>&nbsp;<span class="string" id="510414">&#34;http://example.com/&#34;</span><span class="op" id="510435">,</span>&nbsp;<span class="builtintype" id="510437">nil</span><span class="op" id="510440">)</span><br>
<span class="lineno">1300</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="510444">resp</span>&nbsp;<span class="op" id="510449">:=</span>&nbsp;<span class="ident" id="510452">httptest</span><span class="op" id="510460">.</span><span class="ident" id="510461">NewRecorder</span><span class="op" id="510472">(</span><span class="op" id="510473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="510476">Redirect</span><span class="op" id="510484">(</span><span class="ident" id="510485">resp</span><span class="op" id="510489">,</span>&nbsp;<span class="ident" id="510491">req</span><span class="op" id="510494">,</span>&nbsp;<span class="string" id="510496">&#34;/foo?next=http://bar.com/&#34;</span><span class="op" id="510523">,</span>&nbsp;<span class="num" id="510525">302</span><span class="op" id="510528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="510531">if</span>&nbsp;<span class="ident" id="510534">g</span><span class="op" id="510535">,</span>&nbsp;<span class="ident" id="510537">e</span>&nbsp;<span class="op" id="510539">:=</span>&nbsp;<span class="ident" id="510542">resp</span><span class="op" id="510546">.</span><span class="ident" id="510547">Header</span><span class="op" id="510553">(</span><span class="op" id="510554">)</span><span class="op" id="510555">.</span><span class="ident" id="510556">Get</span><span class="op" id="510559">(</span><span class="string" id="510560">&#34;Location&#34;</span><span class="op" id="510570">)</span><span class="op" id="510571">,</span>&nbsp;<span class="string" id="510573">&#34;/foo?next=http://bar.com/&#34;</span><span class="op" id="510600">;</span>&nbsp;<span class="ident" id="510602">g</span>&nbsp;<span class="op" id="510604">!=</span>&nbsp;<span class="ident" id="510607">e</span>&nbsp;<span class="op" id="510609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="510613">t</span><span class="op" id="510614">.</span><span class="ident" id="510615">Errorf</span><span class="op" id="510621">(</span><span class="string" id="510622">&#34;Location&nbsp;header&nbsp;was&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="510655">,</span>&nbsp;<span class="ident" id="510657">g</span><span class="op" id="510658">,</span>&nbsp;<span class="ident" id="510660">e</span><span class="op" id="510661">)</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="510664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="510668">resp</span>&nbsp;<span class="op" id="510673">=</span>&nbsp;<span class="ident" id="510675">httptest</span><span class="op" id="510683">.</span><span class="ident" id="510684">NewRecorder</span><span class="op" id="510695">(</span><span class="op" id="510696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="510699">Redirect</span><span class="op" id="510707">(</span><span class="ident" id="510708">resp</span><span class="op" id="510712">,</span>&nbsp;<span class="ident" id="510714">req</span><span class="op" id="510717">,</span>&nbsp;<span class="string" id="510719">&#34;http://localhost:8080/_ah/login?continue=http://localhost:8080/&#34;</span><span class="op" id="510784">,</span>&nbsp;<span class="num" id="510786">302</span><span class="op" id="510789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="510792">if</span>&nbsp;<span class="ident" id="510795">g</span><span class="op" id="510796">,</span>&nbsp;<span class="ident" id="510798">e</span>&nbsp;<span class="op" id="510800">:=</span>&nbsp;<span class="ident" id="510803">resp</span><span class="op" id="510807">.</span><span class="ident" id="510808">Header</span><span class="op" id="510814">(</span><span class="op" id="510815">)</span><span class="op" id="510816">.</span><span class="ident" id="510817">Get</span><span class="op" id="510820">(</span><span class="string" id="510821">&#34;Location&#34;</span><span class="op" id="510831">)</span><span class="op" id="510832">,</span>&nbsp;<span class="string" id="510834">&#34;http://localhost:8080/_ah/login?continue=http://localhost:8080/&#34;</span><span class="op" id="510899">;</span>&nbsp;<span class="ident" id="510901">g</span>&nbsp;<span class="op" id="510903">!=</span>&nbsp;<span class="ident" id="510906">e</span>&nbsp;<span class="op" id="510908">{</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="510912">t</span><span class="op" id="510913">.</span><span class="ident" id="510914">Errorf</span><span class="op" id="510920">(</span><span class="string" id="510921">&#34;Location&nbsp;header&nbsp;was&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="510954">,</span>&nbsp;<span class="ident" id="510956">g</span><span class="op" id="510957">,</span>&nbsp;<span class="ident" id="510959">e</span><span class="op" id="510960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="510963">}</span><br>
<span class="lineno"></span><span class="op" id="510965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="510968">func</span>&nbsp;<span class="ident" id="510973">TestRedirectBadPath</span><span class="op" id="510992">(</span><span class="ident" id="510993">t</span>&nbsp;<span class="op" id="510995">*</span><span class="ident" id="510996">testing</span><span class="op" id="511003">.</span><span class="ident" id="511004">T</span><span class="op" id="511005">)</span>&nbsp;<span class="op" id="511007">{</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="511010">//&nbsp;This&nbsp;used&nbsp;to&nbsp;crash.&nbsp;It&#39;s&nbsp;not&nbsp;valid&nbsp;input&nbsp;(bad&nbsp;path),&nbsp;but&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="511074">//&nbsp;shouldn&#39;t&nbsp;crash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="511095">rr</span>&nbsp;<span class="op" id="511098">:=</span>&nbsp;<span class="ident" id="511101">httptest</span><span class="op" id="511109">.</span><span class="ident" id="511110">NewRecorder</span><span class="op" id="511121">(</span><span class="op" id="511122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="511125">req</span>&nbsp;<span class="op" id="511129">:=</span>&nbsp;<span class="op" id="511132">&amp;</span><span class="ident" id="511133">Request</span><span class="op" id="511140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="511144">Method</span><span class="op" id="511150">:</span>&nbsp;<span class="string" id="511152">&#34;GET&#34;</span><span class="op" id="511157">,</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="511161">URL</span><span class="op" id="511164">:</span>&nbsp;<span class="op" id="511166">&amp;</span><span class="ident" id="511167">url</span><span class="op" id="511170">.</span><span class="ident" id="511171">URL</span><span class="op" id="511174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="511179">Scheme</span><span class="op" id="511185">:</span>&nbsp;<span class="string" id="511187">&#34;http&#34;</span><span class="op" id="511193">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="511198">Path</span><span class="op" id="511202">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="511206">&#34;not-empty-but-no-leading-slash&#34;</span><span class="op" id="511238">,</span>&nbsp;<span class="comment" id="511240">//&nbsp;bogus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="511251">}</span><span class="op" id="511252">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="511255">}</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="511258">Redirect</span><span class="op" id="511266">(</span><span class="ident" id="511267">rr</span><span class="op" id="511269">,</span>&nbsp;<span class="ident" id="511271">req</span><span class="op" id="511274">,</span>&nbsp;<span class="string" id="511276">&#34;&#34;</span><span class="op" id="511278">,</span>&nbsp;<span class="num" id="511280">304</span><span class="op" id="511283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="511286">if</span>&nbsp;<span class="ident" id="511289">rr</span><span class="op" id="511291">.</span><span class="ident" id="511292">Code</span>&nbsp;<span class="op" id="511297">!=</span>&nbsp;<span class="num" id="511300">304</span>&nbsp;<span class="op" id="511304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="511308">t</span><span class="op" id="511309">.</span><span class="ident" id="511310">Errorf</span><span class="op" id="511316">(</span><span class="string" id="511317">&#34;Code&nbsp;=&nbsp;%d;&nbsp;want&nbsp;304&#34;</span><span class="op" id="511338">,</span>&nbsp;<span class="ident" id="511340">rr</span><span class="op" id="511342">.</span><span class="ident" id="511343">Code</span><span class="op" id="511347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="511350">}</span><br>
<span class="lineno"></span><span class="op" id="511352">}</span><br>
<span class="lineno">1330</span><br>
<span class="lineno"></span><span class="comment" id="511355">//&nbsp;TestZeroLengthPostAndResponse&nbsp;exercises&nbsp;an&nbsp;optimization&nbsp;done&nbsp;by&nbsp;the&nbsp;Transport:</span><br>
<span class="lineno"></span><span class="comment" id="511437">//&nbsp;when&nbsp;there&nbsp;is&nbsp;no&nbsp;body&nbsp;(either&nbsp;because&nbsp;the&nbsp;method&nbsp;doesn&#39;t&nbsp;permit&nbsp;a&nbsp;body,&nbsp;or&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="511518">//&nbsp;explicit&nbsp;Content-Length&nbsp;of&nbsp;zero&nbsp;is&nbsp;present),&nbsp;then&nbsp;the&nbsp;transport&nbsp;can&nbsp;re-use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="511600">//&nbsp;connection&nbsp;immediately.&nbsp;But&nbsp;when&nbsp;it&nbsp;re-uses&nbsp;the&nbsp;connection,&nbsp;it&nbsp;typically&nbsp;closes</span><br>
<span class="lineno">1335</span><span class="comment" id="511683">//&nbsp;the&nbsp;previous&nbsp;request&#39;s&nbsp;body,&nbsp;which&nbsp;is&nbsp;not&nbsp;optimal&nbsp;for&nbsp;zero-lengthed&nbsp;bodies,</span><br>
<span class="lineno"></span><span class="comment" id="511762">//&nbsp;as&nbsp;the&nbsp;client&nbsp;would&nbsp;then&nbsp;see&nbsp;http.ErrBodyReadAfterClose&nbsp;and&nbsp;not&nbsp;0,&nbsp;io.EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="511840">func</span>&nbsp;<span class="ident" id="511845">TestZeroLengthPostAndResponse</span><span class="op" id="511874">(</span><span class="ident" id="511875">t</span>&nbsp;<span class="op" id="511877">*</span><span class="ident" id="511878">testing</span><span class="op" id="511885">.</span><span class="ident" id="511886">T</span><span class="op" id="511887">)</span>&nbsp;<span class="op" id="511889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="511892">defer</span>&nbsp;<span class="ident" id="511898">afterTest</span><span class="op" id="511907">(</span><span class="ident" id="511908">t</span><span class="op" id="511909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="511912">ts</span>&nbsp;<span class="op" id="511915">:=</span>&nbsp;<span class="ident" id="511918">httptest</span><span class="op" id="511926">.</span><span class="ident" id="511927">NewServer</span><span class="op" id="511936">(</span><span class="ident" id="511937">HandlerFunc</span><span class="op" id="511948">(</span><span class="keyword" id="511949">func</span><span class="op" id="511953">(</span><span class="ident" id="511954">rw</span>&nbsp;<span class="ident" id="511957">ResponseWriter</span><span class="op" id="511971">,</span>&nbsp;<span class="ident" id="511973">r</span>&nbsp;<span class="op" id="511975">*</span><span class="ident" id="511976">Request</span><span class="op" id="511983">)</span>&nbsp;<span class="op" id="511985">{</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="511989">all</span><span class="op" id="511992">,</span>&nbsp;<span class="ident" id="511994">err</span>&nbsp;<span class="op" id="511998">:=</span>&nbsp;<span class="ident" id="512001">ioutil</span><span class="op" id="512007">.</span><span class="ident" id="512008">ReadAll</span><span class="op" id="512015">(</span><span class="ident" id="512016">r</span><span class="op" id="512017">.</span><span class="ident" id="512018">Body</span><span class="op" id="512022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="512026">if</span>&nbsp;<span class="ident" id="512029">err</span>&nbsp;<span class="op" id="512033">!=</span>&nbsp;<span class="builtintype" id="512036">nil</span>&nbsp;<span class="op" id="512040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="512045">t</span><span class="op" id="512046">.</span><span class="ident" id="512047">Fatalf</span><span class="op" id="512053">(</span><span class="string" id="512054">&#34;handler&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="512075">,</span>&nbsp;<span class="ident" id="512077">err</span><span class="op" id="512080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="512084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="512088">if</span>&nbsp;<span class="builtinfunc" id="512091">len</span><span class="op" id="512094">(</span><span class="ident" id="512095">all</span><span class="op" id="512098">)</span>&nbsp;<span class="op" id="512100">!=</span>&nbsp;<span class="num" id="512103">0</span>&nbsp;<span class="op" id="512105">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="512110">t</span><span class="op" id="512111">.</span><span class="ident" id="512112">Errorf</span><span class="op" id="512118">(</span><span class="string" id="512119">&#34;handler&nbsp;got&nbsp;%d&nbsp;bytes;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="512153">,</span>&nbsp;<span class="builtinfunc" id="512155">len</span><span class="op" id="512158">(</span><span class="ident" id="512159">all</span><span class="op" id="512162">)</span><span class="op" id="512163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="512167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="512171">rw</span><span class="op" id="512173">.</span><span class="ident" id="512174">Header</span><span class="op" id="512180">(</span><span class="op" id="512181">)</span><span class="op" id="512182">.</span><span class="ident" id="512183">Set</span><span class="op" id="512186">(</span><span class="string" id="512187">&#34;Content-Length&#34;</span><span class="op" id="512203">,</span>&nbsp;<span class="string" id="512205">&#34;0&#34;</span><span class="op" id="512208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="512211">}</span><span class="op" id="512212">)</span><span class="op" id="512213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="512216">defer</span>&nbsp;<span class="ident" id="512222">ts</span><span class="op" id="512224">.</span><span class="ident" id="512225">Close</span><span class="op" id="512230">(</span><span class="op" id="512231">)</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="512235">req</span><span class="op" id="512238">,</span>&nbsp;<span class="ident" id="512240">err</span>&nbsp;<span class="op" id="512244">:=</span>&nbsp;<span class="ident" id="512247">NewRequest</span><span class="op" id="512257">(</span><span class="string" id="512258">&#34;POST&#34;</span><span class="op" id="512264">,</span>&nbsp;<span class="ident" id="512266">ts</span><span class="op" id="512268">.</span><span class="ident" id="512269">URL</span><span class="op" id="512272">,</span>&nbsp;<span class="ident" id="512274">strings</span><span class="op" id="512281">.</span><span class="ident" id="512282">NewReader</span><span class="op" id="512291">(</span><span class="string" id="512292">&#34;&#34;</span><span class="op" id="512294">)</span><span class="op" id="512295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="512298">if</span>&nbsp;<span class="ident" id="512301">err</span>&nbsp;<span class="op" id="512305">!=</span>&nbsp;<span class="builtintype" id="512308">nil</span>&nbsp;<span class="op" id="512312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="512316">t</span><span class="op" id="512317">.</span><span class="ident" id="512318">Fatal</span><span class="op" id="512323">(</span><span class="ident" id="512324">err</span><span class="op" id="512327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="512330">}</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="512333">req</span><span class="op" id="512336">.</span><span class="ident" id="512337">ContentLength</span>&nbsp;<span class="op" id="512351">=</span>&nbsp;<span class="num" id="512353">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="512357">var</span>&nbsp;<span class="ident" id="512361">resp</span>&nbsp;<span class="op" id="512366">[</span><span class="num" id="512367">5</span><span class="op" id="512368">]</span><span class="op" id="512369">*</span><span class="ident" id="512370">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="512380">for</span>&nbsp;<span class="ident" id="512384">i</span>&nbsp;<span class="op" id="512386">:=</span>&nbsp;<span class="keyword" id="512389">range</span>&nbsp;<span class="ident" id="512395">resp</span>&nbsp;<span class="op" id="512400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="512404">resp</span><span class="op" id="512408">[</span><span class="ident" id="512409">i</span><span class="op" id="512410">]</span><span class="op" id="512411">,</span>&nbsp;<span class="ident" id="512413">err</span>&nbsp;<span class="op" id="512417">=</span>&nbsp;<span class="ident" id="512419">DefaultClient</span><span class="op" id="512432">.</span><span class="ident" id="512433">Do</span><span class="op" id="512435">(</span><span class="ident" id="512436">req</span><span class="op" id="512439">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="512443">if</span>&nbsp;<span class="ident" id="512446">err</span>&nbsp;<span class="op" id="512450">!=</span>&nbsp;<span class="builtintype" id="512453">nil</span>&nbsp;<span class="op" id="512457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="512462">t</span><span class="op" id="512463">.</span><span class="ident" id="512464">Fatalf</span><span class="op" id="512470">(</span><span class="string" id="512471">&#34;client&nbsp;post&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="512492">,</span>&nbsp;<span class="ident" id="512494">i</span><span class="op" id="512495">,</span>&nbsp;<span class="ident" id="512497">err</span><span class="op" id="512500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="512504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="512507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="512511">for</span>&nbsp;<span class="ident" id="512515">i</span>&nbsp;<span class="op" id="512517">:=</span>&nbsp;<span class="keyword" id="512520">range</span>&nbsp;<span class="ident" id="512526">resp</span>&nbsp;<span class="op" id="512531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="512535">all</span><span class="op" id="512538">,</span>&nbsp;<span class="ident" id="512540">err</span>&nbsp;<span class="op" id="512544">:=</span>&nbsp;<span class="ident" id="512547">ioutil</span><span class="op" id="512553">.</span><span class="ident" id="512554">ReadAll</span><span class="op" id="512561">(</span><span class="ident" id="512562">resp</span><span class="op" id="512566">[</span><span class="ident" id="512567">i</span><span class="op" id="512568">]</span><span class="op" id="512569">.</span><span class="ident" id="512570">Body</span><span class="op" id="512574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="512578">if</span>&nbsp;<span class="ident" id="512581">err</span>&nbsp;<span class="op" id="512585">!=</span>&nbsp;<span class="builtintype" id="512588">nil</span>&nbsp;<span class="op" id="512592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="512597">t</span><span class="op" id="512598">.</span><span class="ident" id="512599">Fatalf</span><span class="op" id="512605">(</span><span class="string" id="512606">&#34;req&nbsp;#%d:&nbsp;client&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="512635">,</span>&nbsp;<span class="ident" id="512637">i</span><span class="op" id="512638">,</span>&nbsp;<span class="ident" id="512640">err</span><span class="op" id="512643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="512647">}</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="512651">if</span>&nbsp;<span class="builtinfunc" id="512654">len</span><span class="op" id="512657">(</span><span class="ident" id="512658">all</span><span class="op" id="512661">)</span>&nbsp;<span class="op" id="512663">!=</span>&nbsp;<span class="num" id="512666">0</span>&nbsp;<span class="op" id="512668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="512673">t</span><span class="op" id="512674">.</span><span class="ident" id="512675">Errorf</span><span class="op" id="512681">(</span><span class="string" id="512682">&#34;req&nbsp;#%d:&nbsp;client&nbsp;got&nbsp;%d&nbsp;bytes;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="512724">,</span>&nbsp;<span class="ident" id="512726">i</span><span class="op" id="512727">,</span>&nbsp;<span class="builtinfunc" id="512729">len</span><span class="op" id="512732">(</span><span class="ident" id="512733">all</span><span class="op" id="512736">)</span><span class="op" id="512737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="512741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="512744">}</span><br>
<span class="lineno"></span><span class="op" id="512746">}</span><br>
<span class="lineno">1375</span><br>
<span class="lineno"></span><span class="keyword" id="512749">func</span>&nbsp;<span class="ident" id="512754">TestHandlerPanicNil</span><span class="op" id="512773">(</span><span class="ident" id="512774">t</span>&nbsp;<span class="op" id="512776">*</span><span class="ident" id="512777">testing</span><span class="op" id="512784">.</span><span class="ident" id="512785">T</span><span class="op" id="512786">)</span>&nbsp;<span class="op" id="512788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="512791">testHandlerPanic</span><span class="op" id="512807">(</span><span class="ident" id="512808">t</span><span class="op" id="512809">,</span>&nbsp;<span class="builtintype" id="512811">false</span><span class="op" id="512816">,</span>&nbsp;<span class="builtintype" id="512818">nil</span><span class="op" id="512821">)</span><br>
<span class="lineno"></span><span class="op" id="512823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1380</span><span class="keyword" id="512826">func</span>&nbsp;<span class="ident" id="512831">TestHandlerPanic</span><span class="op" id="512847">(</span><span class="ident" id="512848">t</span>&nbsp;<span class="op" id="512850">*</span><span class="ident" id="512851">testing</span><span class="op" id="512858">.</span><span class="ident" id="512859">T</span><span class="op" id="512860">)</span>&nbsp;<span class="op" id="512862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="512865">testHandlerPanic</span><span class="op" id="512881">(</span><span class="ident" id="512882">t</span><span class="op" id="512883">,</span>&nbsp;<span class="builtintype" id="512885">false</span><span class="op" id="512890">,</span>&nbsp;<span class="string" id="512892">&#34;intentional&nbsp;death&nbsp;for&nbsp;testing&#34;</span><span class="op" id="512923">)</span><br>
<span class="lineno"></span><span class="op" id="512925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="512928">func</span>&nbsp;<span class="ident" id="512933">TestHandlerPanicWithHijack</span><span class="op" id="512959">(</span><span class="ident" id="512960">t</span>&nbsp;<span class="op" id="512962">*</span><span class="ident" id="512963">testing</span><span class="op" id="512970">.</span><span class="ident" id="512971">T</span><span class="op" id="512972">)</span>&nbsp;<span class="op" id="512974">{</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="512977">testHandlerPanic</span><span class="op" id="512993">(</span><span class="ident" id="512994">t</span><span class="op" id="512995">,</span>&nbsp;<span class="builtintype" id="512997">true</span><span class="op" id="513001">,</span>&nbsp;<span class="string" id="513003">&#34;intentional&nbsp;death&nbsp;for&nbsp;testing&#34;</span><span class="op" id="513034">)</span><br>
<span class="lineno"></span><span class="op" id="513036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="513039">func</span>&nbsp;<span class="ident" id="513044">testHandlerPanic</span><span class="op" id="513060">(</span><span class="ident" id="513061">t</span>&nbsp;<span class="op" id="513063">*</span><span class="ident" id="513064">testing</span><span class="op" id="513071">.</span><span class="ident" id="513072">T</span><span class="op" id="513073">,</span>&nbsp;<span class="ident" id="513075">withHijack</span>&nbsp;<span class="builtintype" id="513086">bool</span><span class="op" id="513090">,</span>&nbsp;<span class="ident" id="513092">panicValue</span>&nbsp;<span class="keyword" id="513103">interface</span><span class="op" id="513112">{</span><span class="op" id="513113">}</span><span class="op" id="513114">)</span>&nbsp;<span class="op" id="513116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="513119">defer</span>&nbsp;<span class="ident" id="513125">afterTest</span><span class="op" id="513134">(</span><span class="ident" id="513135">t</span><span class="op" id="513136">)</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="513139">//&nbsp;Unlike&nbsp;the&nbsp;other&nbsp;tests&nbsp;that&nbsp;set&nbsp;the&nbsp;log&nbsp;output&nbsp;to&nbsp;ioutil.Discard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="513208">//&nbsp;to&nbsp;quiet&nbsp;the&nbsp;output,&nbsp;this&nbsp;test&nbsp;uses&nbsp;a&nbsp;pipe.&nbsp;&nbsp;The&nbsp;pipe&nbsp;serves&nbsp;three</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="513279">//&nbsp;purposes:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="513293">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="513297">//&nbsp;&nbsp;&nbsp;1)&nbsp;The&nbsp;log.Print&nbsp;from&nbsp;the&nbsp;http&nbsp;server&nbsp;(generated&nbsp;by&nbsp;the&nbsp;caught</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="513366">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panic)&nbsp;will&nbsp;go&nbsp;to&nbsp;the&nbsp;pipe&nbsp;instead&nbsp;of&nbsp;stderr,&nbsp;making&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="513432">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output&nbsp;quiet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="513455">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="513459">//&nbsp;&nbsp;&nbsp;2)&nbsp;We&nbsp;read&nbsp;from&nbsp;the&nbsp;pipe&nbsp;to&nbsp;verify&nbsp;that&nbsp;the&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="513517">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;actually&nbsp;caught&nbsp;the&nbsp;panic&nbsp;and&nbsp;logged&nbsp;something.</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="513574">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="513578">//&nbsp;&nbsp;&nbsp;3)&nbsp;The&nbsp;blocking&nbsp;Read&nbsp;call&nbsp;prevents&nbsp;this&nbsp;TestHandlerPanic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="513641">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;from&nbsp;exiting&nbsp;before&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="513703">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finishes&nbsp;crashing.&nbsp;If&nbsp;this&nbsp;text&nbsp;function&nbsp;exited&nbsp;too</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="513764">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;early&nbsp;(and&nbsp;its&nbsp;defer&nbsp;log.SetOutput(os.Stderr)&nbsp;ran),</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="513825">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;the&nbsp;crash&nbsp;output&nbsp;could&nbsp;spill&nbsp;into&nbsp;the&nbsp;next&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="513888">pr</span><span class="op" id="513890">,</span>&nbsp;<span class="ident" id="513892">pw</span>&nbsp;<span class="op" id="513895">:=</span>&nbsp;<span class="ident" id="513898">io</span><span class="op" id="513900">.</span><span class="ident" id="513901">Pipe</span><span class="op" id="513905">(</span><span class="op" id="513906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="513909">log</span><span class="op" id="513912">.</span><span class="ident" id="513913">SetOutput</span><span class="op" id="513922">(</span><span class="ident" id="513923">pw</span><span class="op" id="513925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="513928">defer</span>&nbsp;<span class="ident" id="513934">log</span><span class="op" id="513937">.</span><span class="ident" id="513938">SetOutput</span><span class="op" id="513947">(</span><span class="ident" id="513948">os</span><span class="op" id="513950">.</span><span class="ident" id="513951">Stderr</span><span class="op" id="513957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="513960">defer</span>&nbsp;<span class="ident" id="513966">pw</span><span class="op" id="513968">.</span><span class="ident" id="513969">Close</span><span class="op" id="513974">(</span><span class="op" id="513975">)</span><br>
<span class="lineno">1410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="513979">ts</span>&nbsp;<span class="op" id="513982">:=</span>&nbsp;<span class="ident" id="513985">httptest</span><span class="op" id="513993">.</span><span class="ident" id="513994">NewServer</span><span class="op" id="514003">(</span><span class="ident" id="514004">HandlerFunc</span><span class="op" id="514015">(</span><span class="keyword" id="514016">func</span><span class="op" id="514020">(</span><span class="ident" id="514021">w</span>&nbsp;<span class="ident" id="514023">ResponseWriter</span><span class="op" id="514037">,</span>&nbsp;<span class="ident" id="514039">r</span>&nbsp;<span class="op" id="514041">*</span><span class="ident" id="514042">Request</span><span class="op" id="514049">)</span>&nbsp;<span class="op" id="514051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="514055">if</span>&nbsp;<span class="ident" id="514058">withHijack</span>&nbsp;<span class="op" id="514069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="514074">rwc</span><span class="op" id="514077">,</span>&nbsp;<span class="ident" id="514079">_</span><span class="op" id="514080">,</span>&nbsp;<span class="ident" id="514082">err</span>&nbsp;<span class="op" id="514086">:=</span>&nbsp;<span class="ident" id="514089">w</span><span class="op" id="514090">.</span><span class="op" id="514091">(</span><span class="ident" id="514092">Hijacker</span><span class="op" id="514100">)</span><span class="op" id="514101">.</span><span class="ident" id="514102">Hijack</span><span class="op" id="514108">(</span><span class="op" id="514109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="514114">if</span>&nbsp;<span class="ident" id="514117">err</span>&nbsp;<span class="op" id="514121">!=</span>&nbsp;<span class="builtintype" id="514124">nil</span>&nbsp;<span class="op" id="514128">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="514134">t</span><span class="op" id="514135">.</span><span class="ident" id="514136">Logf</span><span class="op" id="514140">(</span><span class="string" id="514141">&#34;unexpected&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="514163">,</span>&nbsp;<span class="ident" id="514165">err</span><span class="op" id="514168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="514173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="514178">defer</span>&nbsp;<span class="ident" id="514184">rwc</span><span class="op" id="514187">.</span><span class="ident" id="514188">Close</span><span class="op" id="514193">(</span><span class="op" id="514194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="514198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="514202">panic</span><span class="op" id="514207">(</span><span class="ident" id="514208">panicValue</span><span class="op" id="514218">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="514221">}</span><span class="op" id="514222">)</span><span class="op" id="514223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="514226">defer</span>&nbsp;<span class="ident" id="514232">ts</span><span class="op" id="514234">.</span><span class="ident" id="514235">Close</span><span class="op" id="514240">(</span><span class="op" id="514241">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="514245">//&nbsp;Do&nbsp;a&nbsp;blocking&nbsp;read&nbsp;on&nbsp;the&nbsp;log&nbsp;output&nbsp;pipe&nbsp;so&nbsp;its&nbsp;logging</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="514306">//&nbsp;doesn&#39;t&nbsp;bleed&nbsp;into&nbsp;the&nbsp;next&nbsp;test.&nbsp;&nbsp;But&nbsp;wait&nbsp;only&nbsp;5&nbsp;seconds</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="514369">//&nbsp;for&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="514381">done</span>&nbsp;<span class="op" id="514386">:=</span>&nbsp;<span class="builtinfunc" id="514389">make</span><span class="op" id="514393">(</span><span class="keyword" id="514394">chan</span>&nbsp;<span class="builtintype" id="514399">bool</span><span class="op" id="514403">,</span>&nbsp;<span class="num" id="514405">1</span><span class="op" id="514406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="514409">go</span>&nbsp;<span class="keyword" id="514412">func</span><span class="op" id="514416">(</span><span class="op" id="514417">)</span>&nbsp;<span class="op" id="514419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="514423">buf</span>&nbsp;<span class="op" id="514427">:=</span>&nbsp;<span class="builtinfunc" id="514430">make</span><span class="op" id="514434">(</span><span class="op" id="514435">[</span><span class="op" id="514436">]</span><span class="builtintype" id="514437">byte</span><span class="op" id="514441">,</span>&nbsp;<span class="num" id="514443">4</span><span class="op" id="514444">&lt;&lt;</span><span class="num" id="514446">10</span><span class="op" id="514448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="514452">_</span><span class="op" id="514453">,</span>&nbsp;<span class="ident" id="514455">err</span>&nbsp;<span class="op" id="514459">:=</span>&nbsp;<span class="ident" id="514462">pr</span><span class="op" id="514464">.</span><span class="ident" id="514465">Read</span><span class="op" id="514469">(</span><span class="ident" id="514470">buf</span><span class="op" id="514473">)</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="514477">pr</span><span class="op" id="514479">.</span><span class="ident" id="514480">Close</span><span class="op" id="514485">(</span><span class="op" id="514486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="514490">if</span>&nbsp;<span class="ident" id="514493">err</span>&nbsp;<span class="op" id="514497">!=</span>&nbsp;<span class="builtintype" id="514500">nil</span>&nbsp;<span class="op" id="514504">&amp;&amp;</span>&nbsp;<span class="ident" id="514507">err</span>&nbsp;<span class="op" id="514511">!=</span>&nbsp;<span class="ident" id="514514">io</span><span class="op" id="514516">.</span><span class="ident" id="514517">EOF</span>&nbsp;<span class="op" id="514521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="514526">t</span><span class="op" id="514527">.</span><span class="ident" id="514528">Error</span><span class="op" id="514533">(</span><span class="ident" id="514534">err</span><span class="op" id="514537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="514541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="514545">done</span>&nbsp;<span class="op" id="514550">&lt;-</span>&nbsp;<span class="builtintype" id="514553">true</span><br>
<span class="lineno">1435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="514559">}</span><span class="op" id="514560">(</span><span class="op" id="514561">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="514565">_</span><span class="op" id="514566">,</span>&nbsp;<span class="ident" id="514568">err</span>&nbsp;<span class="op" id="514572">:=</span>&nbsp;<span class="ident" id="514575">Get</span><span class="op" id="514578">(</span><span class="ident" id="514579">ts</span><span class="op" id="514581">.</span><span class="ident" id="514582">URL</span><span class="op" id="514585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="514588">if</span>&nbsp;<span class="ident" id="514591">err</span>&nbsp;<span class="op" id="514595">==</span>&nbsp;<span class="builtintype" id="514598">nil</span>&nbsp;<span class="op" id="514602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="514606">t</span><span class="op" id="514607">.</span><span class="ident" id="514608">Logf</span><span class="op" id="514612">(</span><span class="string" id="514613">&#34;expected&nbsp;an&nbsp;error&#34;</span><span class="op" id="514632">)</span><br>
<span class="lineno">1440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="514635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="514639">if</span>&nbsp;<span class="ident" id="514642">panicValue</span>&nbsp;<span class="op" id="514653">==</span>&nbsp;<span class="builtintype" id="514656">nil</span>&nbsp;<span class="op" id="514660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="514664">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="514672">}</span><br>
<span class="lineno">1445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="514676">select</span>&nbsp;<span class="op" id="514683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="514686">case</span>&nbsp;<span class="op" id="514691">&lt;-</span><span class="ident" id="514693">done</span><span class="op" id="514697">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="514701">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="514709">case</span>&nbsp;<span class="op" id="514714">&lt;-</span><span class="ident" id="514716">time</span><span class="op" id="514720">.</span><span class="ident" id="514721">After</span><span class="op" id="514726">(</span><span class="num" id="514727">5</span>&nbsp;<span class="op" id="514729">*</span>&nbsp;<span class="ident" id="514731">time</span><span class="op" id="514735">.</span><span class="ident" id="514736">Second</span><span class="op" id="514742">)</span><span class="op" id="514743">:</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="514747">t</span><span class="op" id="514748">.</span><span class="ident" id="514749">Fatal</span><span class="op" id="514754">(</span><span class="string" id="514755">&#34;expected&nbsp;server&nbsp;handler&nbsp;to&nbsp;log&nbsp;an&nbsp;error&#34;</span><span class="op" id="514796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="514799">}</span><br>
<span class="lineno"></span><span class="op" id="514801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="514804">func</span>&nbsp;<span class="ident" id="514809">TestNoDate</span><span class="op" id="514819">(</span><span class="ident" id="514820">t</span>&nbsp;<span class="op" id="514822">*</span><span class="ident" id="514823">testing</span><span class="op" id="514830">.</span><span class="ident" id="514831">T</span><span class="op" id="514832">)</span>&nbsp;<span class="op" id="514834">{</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="514837">defer</span>&nbsp;<span class="ident" id="514843">afterTest</span><span class="op" id="514852">(</span><span class="ident" id="514853">t</span><span class="op" id="514854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="514857">ts</span>&nbsp;<span class="op" id="514860">:=</span>&nbsp;<span class="ident" id="514863">httptest</span><span class="op" id="514871">.</span><span class="ident" id="514872">NewServer</span><span class="op" id="514881">(</span><span class="ident" id="514882">HandlerFunc</span><span class="op" id="514893">(</span><span class="keyword" id="514894">func</span><span class="op" id="514898">(</span><span class="ident" id="514899">w</span>&nbsp;<span class="ident" id="514901">ResponseWriter</span><span class="op" id="514915">,</span>&nbsp;<span class="ident" id="514917">r</span>&nbsp;<span class="op" id="514919">*</span><span class="ident" id="514920">Request</span><span class="op" id="514927">)</span>&nbsp;<span class="op" id="514929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="514933">w</span><span class="op" id="514934">.</span><span class="ident" id="514935">Header</span><span class="op" id="514941">(</span><span class="op" id="514942">)</span><span class="op" id="514943">[</span><span class="string" id="514944">&#34;Date&#34;</span><span class="op" id="514950">]</span>&nbsp;<span class="op" id="514952">=</span>&nbsp;<span class="builtintype" id="514954">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="514959">}</span><span class="op" id="514960">)</span><span class="op" id="514961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="514964">defer</span>&nbsp;<span class="ident" id="514970">ts</span><span class="op" id="514972">.</span><span class="ident" id="514973">Close</span><span class="op" id="514978">(</span><span class="op" id="514979">)</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="514982">res</span><span class="op" id="514985">,</span>&nbsp;<span class="ident" id="514987">err</span>&nbsp;<span class="op" id="514991">:=</span>&nbsp;<span class="ident" id="514994">Get</span><span class="op" id="514997">(</span><span class="ident" id="514998">ts</span><span class="op" id="515000">.</span><span class="ident" id="515001">URL</span><span class="op" id="515004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="515007">if</span>&nbsp;<span class="ident" id="515010">err</span>&nbsp;<span class="op" id="515014">!=</span>&nbsp;<span class="builtintype" id="515017">nil</span>&nbsp;<span class="op" id="515021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515025">t</span><span class="op" id="515026">.</span><span class="ident" id="515027">Fatal</span><span class="op" id="515032">(</span><span class="ident" id="515033">err</span><span class="op" id="515036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="515039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515042">_</span><span class="op" id="515043">,</span>&nbsp;<span class="ident" id="515045">present</span>&nbsp;<span class="op" id="515053">:=</span>&nbsp;<span class="ident" id="515056">res</span><span class="op" id="515059">.</span><span class="ident" id="515060">Header</span><span class="op" id="515066">[</span><span class="string" id="515067">&#34;Date&#34;</span><span class="op" id="515073">]</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="515076">if</span>&nbsp;<span class="ident" id="515079">present</span>&nbsp;<span class="op" id="515087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515091">t</span><span class="op" id="515092">.</span><span class="ident" id="515093">Fatalf</span><span class="op" id="515099">(</span><span class="string" id="515100">&#34;Expected&nbsp;no&nbsp;Date&nbsp;header;&nbsp;got&nbsp;%v&#34;</span><span class="op" id="515133">,</span>&nbsp;<span class="ident" id="515135">res</span><span class="op" id="515138">.</span><span class="ident" id="515139">Header</span><span class="op" id="515145">[</span><span class="string" id="515146">&#34;Date&#34;</span><span class="op" id="515152">]</span><span class="op" id="515153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="515156">}</span><br>
<span class="lineno"></span><span class="op" id="515158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1470</span><span class="keyword" id="515161">func</span>&nbsp;<span class="ident" id="515166">TestStripPrefix</span><span class="op" id="515181">(</span><span class="ident" id="515182">t</span>&nbsp;<span class="op" id="515184">*</span><span class="ident" id="515185">testing</span><span class="op" id="515192">.</span><span class="ident" id="515193">T</span><span class="op" id="515194">)</span>&nbsp;<span class="op" id="515196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="515199">defer</span>&nbsp;<span class="ident" id="515205">afterTest</span><span class="op" id="515214">(</span><span class="ident" id="515215">t</span><span class="op" id="515216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515219">h</span>&nbsp;<span class="op" id="515221">:=</span>&nbsp;<span class="ident" id="515224">HandlerFunc</span><span class="op" id="515235">(</span><span class="keyword" id="515236">func</span><span class="op" id="515240">(</span><span class="ident" id="515241">w</span>&nbsp;<span class="ident" id="515243">ResponseWriter</span><span class="op" id="515257">,</span>&nbsp;<span class="ident" id="515259">r</span>&nbsp;<span class="op" id="515261">*</span><span class="ident" id="515262">Request</span><span class="op" id="515269">)</span>&nbsp;<span class="op" id="515271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515275">w</span><span class="op" id="515276">.</span><span class="ident" id="515277">Header</span><span class="op" id="515283">(</span><span class="op" id="515284">)</span><span class="op" id="515285">.</span><span class="ident" id="515286">Set</span><span class="op" id="515289">(</span><span class="string" id="515290">&#34;X-Path&#34;</span><span class="op" id="515298">,</span>&nbsp;<span class="ident" id="515300">r</span><span class="op" id="515301">.</span><span class="ident" id="515302">URL</span><span class="op" id="515305">.</span><span class="ident" id="515306">Path</span><span class="op" id="515310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="515313">}</span><span class="op" id="515314">)</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515317">ts</span>&nbsp;<span class="op" id="515320">:=</span>&nbsp;<span class="ident" id="515323">httptest</span><span class="op" id="515331">.</span><span class="ident" id="515332">NewServer</span><span class="op" id="515341">(</span><span class="ident" id="515342">StripPrefix</span><span class="op" id="515353">(</span><span class="string" id="515354">&#34;/foo&#34;</span><span class="op" id="515360">,</span>&nbsp;<span class="ident" id="515362">h</span><span class="op" id="515363">)</span><span class="op" id="515364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="515367">defer</span>&nbsp;<span class="ident" id="515373">ts</span><span class="op" id="515375">.</span><span class="ident" id="515376">Close</span><span class="op" id="515381">(</span><span class="op" id="515382">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515386">res</span><span class="op" id="515389">,</span>&nbsp;<span class="ident" id="515391">err</span>&nbsp;<span class="op" id="515395">:=</span>&nbsp;<span class="ident" id="515398">Get</span><span class="op" id="515401">(</span><span class="ident" id="515402">ts</span><span class="op" id="515404">.</span><span class="ident" id="515405">URL</span>&nbsp;<span class="op" id="515409">+</span>&nbsp;<span class="string" id="515411">&#34;/foo/bar&#34;</span><span class="op" id="515421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="515424">if</span>&nbsp;<span class="ident" id="515427">err</span>&nbsp;<span class="op" id="515431">!=</span>&nbsp;<span class="builtintype" id="515434">nil</span>&nbsp;<span class="op" id="515438">{</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515442">t</span><span class="op" id="515443">.</span><span class="ident" id="515444">Fatal</span><span class="op" id="515449">(</span><span class="ident" id="515450">err</span><span class="op" id="515453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="515456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="515459">if</span>&nbsp;<span class="ident" id="515462">g</span><span class="op" id="515463">,</span>&nbsp;<span class="ident" id="515465">e</span>&nbsp;<span class="op" id="515467">:=</span>&nbsp;<span class="ident" id="515470">res</span><span class="op" id="515473">.</span><span class="ident" id="515474">Header</span><span class="op" id="515480">.</span><span class="ident" id="515481">Get</span><span class="op" id="515484">(</span><span class="string" id="515485">&#34;X-Path&#34;</span><span class="op" id="515493">)</span><span class="op" id="515494">,</span>&nbsp;<span class="string" id="515496">&#34;/bar&#34;</span><span class="op" id="515502">;</span>&nbsp;<span class="ident" id="515504">g</span>&nbsp;<span class="op" id="515506">!=</span>&nbsp;<span class="ident" id="515509">e</span>&nbsp;<span class="op" id="515511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515515">t</span><span class="op" id="515516">.</span><span class="ident" id="515517">Errorf</span><span class="op" id="515523">(</span><span class="string" id="515524">&#34;test&nbsp;1:&nbsp;got&nbsp;%s,&nbsp;want&nbsp;%s&#34;</span><span class="op" id="515549">,</span>&nbsp;<span class="ident" id="515551">g</span><span class="op" id="515552">,</span>&nbsp;<span class="ident" id="515554">e</span><span class="op" id="515555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="515558">}</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515561">res</span><span class="op" id="515564">.</span><span class="ident" id="515565">Body</span><span class="op" id="515569">.</span><span class="ident" id="515570">Close</span><span class="op" id="515575">(</span><span class="op" id="515576">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515580">res</span><span class="op" id="515583">,</span>&nbsp;<span class="ident" id="515585">err</span>&nbsp;<span class="op" id="515589">=</span>&nbsp;<span class="ident" id="515591">Get</span><span class="op" id="515594">(</span><span class="ident" id="515595">ts</span><span class="op" id="515597">.</span><span class="ident" id="515598">URL</span>&nbsp;<span class="op" id="515602">+</span>&nbsp;<span class="string" id="515604">&#34;/bar&#34;</span><span class="op" id="515610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="515613">if</span>&nbsp;<span class="ident" id="515616">err</span>&nbsp;<span class="op" id="515620">!=</span>&nbsp;<span class="builtintype" id="515623">nil</span>&nbsp;<span class="op" id="515627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515631">t</span><span class="op" id="515632">.</span><span class="ident" id="515633">Fatal</span><span class="op" id="515638">(</span><span class="ident" id="515639">err</span><span class="op" id="515642">)</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="515645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="515648">if</span>&nbsp;<span class="ident" id="515651">g</span><span class="op" id="515652">,</span>&nbsp;<span class="ident" id="515654">e</span>&nbsp;<span class="op" id="515656">:=</span>&nbsp;<span class="ident" id="515659">res</span><span class="op" id="515662">.</span><span class="ident" id="515663">StatusCode</span><span class="op" id="515673">,</span>&nbsp;<span class="num" id="515675">404</span><span class="op" id="515678">;</span>&nbsp;<span class="ident" id="515680">g</span>&nbsp;<span class="op" id="515682">!=</span>&nbsp;<span class="ident" id="515685">e</span>&nbsp;<span class="op" id="515687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515691">t</span><span class="op" id="515692">.</span><span class="ident" id="515693">Errorf</span><span class="op" id="515699">(</span><span class="string" id="515700">&#34;test&nbsp;2:&nbsp;got&nbsp;status&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="515732">,</span>&nbsp;<span class="ident" id="515734">g</span><span class="op" id="515735">,</span>&nbsp;<span class="ident" id="515737">e</span><span class="op" id="515738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="515741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515744">res</span><span class="op" id="515747">.</span><span class="ident" id="515748">Body</span><span class="op" id="515752">.</span><span class="ident" id="515753">Close</span><span class="op" id="515758">(</span><span class="op" id="515759">)</span><br>
<span class="lineno">1495</span><span class="op" id="515761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="515764">func</span>&nbsp;<span class="ident" id="515769">TestRequestLimit</span><span class="op" id="515785">(</span><span class="ident" id="515786">t</span>&nbsp;<span class="op" id="515788">*</span><span class="ident" id="515789">testing</span><span class="op" id="515796">.</span><span class="ident" id="515797">T</span><span class="op" id="515798">)</span>&nbsp;<span class="op" id="515800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="515803">defer</span>&nbsp;<span class="ident" id="515809">afterTest</span><span class="op" id="515818">(</span><span class="ident" id="515819">t</span><span class="op" id="515820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515823">ts</span>&nbsp;<span class="op" id="515826">:=</span>&nbsp;<span class="ident" id="515829">httptest</span><span class="op" id="515837">.</span><span class="ident" id="515838">NewServer</span><span class="op" id="515847">(</span><span class="ident" id="515848">HandlerFunc</span><span class="op" id="515859">(</span><span class="keyword" id="515860">func</span><span class="op" id="515864">(</span><span class="ident" id="515865">w</span>&nbsp;<span class="ident" id="515867">ResponseWriter</span><span class="op" id="515881">,</span>&nbsp;<span class="ident" id="515883">r</span>&nbsp;<span class="op" id="515885">*</span><span class="ident" id="515886">Request</span><span class="op" id="515893">)</span>&nbsp;<span class="op" id="515895">{</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515899">t</span><span class="op" id="515900">.</span><span class="ident" id="515901">Fatalf</span><span class="op" id="515907">(</span><span class="string" id="515908">&#34;didn&#39;t&nbsp;expect&nbsp;to&nbsp;get&nbsp;request&nbsp;in&nbsp;Handler&#34;</span><span class="op" id="515949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="515952">}</span><span class="op" id="515953">)</span><span class="op" id="515954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="515957">defer</span>&nbsp;<span class="ident" id="515963">ts</span><span class="op" id="515965">.</span><span class="ident" id="515966">Close</span><span class="op" id="515971">(</span><span class="op" id="515972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="515975">req</span><span class="op" id="515978">,</span>&nbsp;<span class="ident" id="515980">_</span>&nbsp;<span class="op" id="515982">:=</span>&nbsp;<span class="ident" id="515985">NewRequest</span><span class="op" id="515995">(</span><span class="string" id="515996">&#34;GET&#34;</span><span class="op" id="516001">,</span>&nbsp;<span class="ident" id="516003">ts</span><span class="op" id="516005">.</span><span class="ident" id="516006">URL</span><span class="op" id="516009">,</span>&nbsp;<span class="builtintype" id="516011">nil</span><span class="op" id="516014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="516017">var</span>&nbsp;<span class="ident" id="516021">bytesPerHeader</span>&nbsp;<span class="op" id="516036">=</span>&nbsp;<span class="builtinfunc" id="516038">len</span><span class="op" id="516041">(</span><span class="string" id="516042">&#34;header12345:&nbsp;val12345\r\n&#34;</span><span class="op" id="516069">)</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="516072">for</span>&nbsp;<span class="ident" id="516076">i</span>&nbsp;<span class="op" id="516078">:=</span>&nbsp;<span class="num" id="516081">0</span><span class="op" id="516082">;</span>&nbsp;<span class="ident" id="516084">i</span>&nbsp;<span class="op" id="516086">&lt;</span>&nbsp;<span class="op" id="516088">(</span><span class="op" id="516089">(</span><span class="ident" id="516090">DefaultMaxHeaderBytes</span><span class="op" id="516111">+</span><span class="num" id="516112">4096</span><span class="op" id="516116">)</span><span class="op" id="516117">/</span><span class="ident" id="516118">bytesPerHeader</span><span class="op" id="516132">)</span><span class="op" id="516133">+</span><span class="num" id="516134">1</span><span class="op" id="516135">;</span>&nbsp;<span class="ident" id="516137">i</span><span class="op" id="516138">++</span>&nbsp;<span class="op" id="516141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="516145">req</span><span class="op" id="516148">.</span><span class="ident" id="516149">Header</span><span class="op" id="516155">.</span><span class="ident" id="516156">Set</span><span class="op" id="516159">(</span><span class="ident" id="516160">fmt</span><span class="op" id="516163">.</span><span class="ident" id="516164">Sprintf</span><span class="op" id="516171">(</span><span class="string" id="516172">&#34;header%05d&#34;</span><span class="op" id="516184">,</span>&nbsp;<span class="ident" id="516186">i</span><span class="op" id="516187">)</span><span class="op" id="516188">,</span>&nbsp;<span class="ident" id="516190">fmt</span><span class="op" id="516193">.</span><span class="ident" id="516194">Sprintf</span><span class="op" id="516201">(</span><span class="string" id="516202">&#34;val%05d&#34;</span><span class="op" id="516211">,</span>&nbsp;<span class="ident" id="516213">i</span><span class="op" id="516214">)</span><span class="op" id="516215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="516218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="516221">res</span><span class="op" id="516224">,</span>&nbsp;<span class="ident" id="516226">err</span>&nbsp;<span class="op" id="516230">:=</span>&nbsp;<span class="ident" id="516233">DefaultClient</span><span class="op" id="516246">.</span><span class="ident" id="516247">Do</span><span class="op" id="516249">(</span><span class="ident" id="516250">req</span><span class="op" id="516253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="516256">if</span>&nbsp;<span class="ident" id="516259">err</span>&nbsp;<span class="op" id="516263">!=</span>&nbsp;<span class="builtintype" id="516266">nil</span>&nbsp;<span class="op" id="516270">{</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="516274">//&nbsp;Some&nbsp;HTTP&nbsp;clients&nbsp;may&nbsp;fail&nbsp;on&nbsp;this&nbsp;undefined&nbsp;behavior&nbsp;(server&nbsp;replying&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="516354">//&nbsp;closing&nbsp;the&nbsp;connection&nbsp;while&nbsp;the&nbsp;request&nbsp;is&nbsp;still&nbsp;being&nbsp;written),&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="516429">//&nbsp;we&nbsp;do&nbsp;support&nbsp;it&nbsp;(at&nbsp;least&nbsp;currently),&nbsp;so&nbsp;we&nbsp;expect&nbsp;a&nbsp;response&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="516504">t</span><span class="op" id="516505">.</span><span class="ident" id="516506">Fatalf</span><span class="op" id="516512">(</span><span class="string" id="516513">&#34;Do:&nbsp;%v&#34;</span><span class="op" id="516521">,</span>&nbsp;<span class="ident" id="516523">err</span><span class="op" id="516526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="516529">}</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="516532">defer</span>&nbsp;<span class="ident" id="516538">res</span><span class="op" id="516541">.</span><span class="ident" id="516542">Body</span><span class="op" id="516546">.</span><span class="ident" id="516547">Close</span><span class="op" id="516552">(</span><span class="op" id="516553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="516556">if</span>&nbsp;<span class="ident" id="516559">res</span><span class="op" id="516562">.</span><span class="ident" id="516563">StatusCode</span>&nbsp;<span class="op" id="516574">!=</span>&nbsp;<span class="num" id="516577">413</span>&nbsp;<span class="op" id="516581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="516585">t</span><span class="op" id="516586">.</span><span class="ident" id="516587">Fatalf</span><span class="op" id="516593">(</span><span class="string" id="516594">&#34;expected&nbsp;413&nbsp;response&nbsp;status;&nbsp;got:&nbsp;%d&nbsp;%s&#34;</span><span class="op" id="516636">,</span>&nbsp;<span class="ident" id="516638">res</span><span class="op" id="516641">.</span><span class="ident" id="516642">StatusCode</span><span class="op" id="516652">,</span>&nbsp;<span class="ident" id="516654">res</span><span class="op" id="516657">.</span><span class="ident" id="516658">Status</span><span class="op" id="516664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="516667">}</span><br>
<span class="lineno"></span><span class="op" id="516669">}</span><br>
<span class="lineno">1520</span><br>
<span class="lineno"></span><span class="keyword" id="516672">type</span>&nbsp;<span class="ident" id="516677">neverEnding</span>&nbsp;<span class="builtintype" id="516689">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="516695">func</span>&nbsp;<span class="op" id="516700">(</span><span class="ident" id="516701">b</span>&nbsp;<span class="ident" id="516703">neverEnding</span><span class="op" id="516714">)</span>&nbsp;<span class="ident" id="516716">Read</span><span class="op" id="516720">(</span><span class="ident" id="516721">p</span>&nbsp;<span class="op" id="516723">[</span><span class="op" id="516724">]</span><span class="builtintype" id="516725">byte</span><span class="op" id="516729">)</span>&nbsp;<span class="op" id="516731">(</span><span class="ident" id="516732">n</span>&nbsp;<span class="builtintype" id="516734">int</span><span class="op" id="516737">,</span>&nbsp;<span class="ident" id="516739">err</span>&nbsp;<span class="builtintype" id="516743">error</span><span class="op" id="516748">)</span>&nbsp;<span class="op" id="516750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="516753">for</span>&nbsp;<span class="ident" id="516757">i</span>&nbsp;<span class="op" id="516759">:=</span>&nbsp;<span class="keyword" id="516762">range</span>&nbsp;<span class="ident" id="516768">p</span>&nbsp;<span class="op" id="516770">{</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="516774">p</span><span class="op" id="516775">[</span><span class="ident" id="516776">i</span><span class="op" id="516777">]</span>&nbsp;<span class="op" id="516779">=</span>&nbsp;<span class="builtintype" id="516781">byte</span><span class="op" id="516785">(</span><span class="ident" id="516786">b</span><span class="op" id="516787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="516790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="516793">return</span>&nbsp;<span class="builtinfunc" id="516800">len</span><span class="op" id="516803">(</span><span class="ident" id="516804">p</span><span class="op" id="516805">)</span><span class="op" id="516806">,</span>&nbsp;<span class="builtintype" id="516808">nil</span><br>
<span class="lineno"></span><span class="op" id="516812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1530</span><span class="keyword" id="516815">type</span>&nbsp;<span class="ident" id="516820">countReader</span>&nbsp;<span class="keyword" id="516832">struct</span>&nbsp;<span class="op" id="516839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="516842">r</span>&nbsp;<span class="ident" id="516844">io</span><span class="op" id="516846">.</span><span class="ident" id="516847">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="516855">n</span>&nbsp;<span class="op" id="516857">*</span><span class="ident" id="516858">int64</span><br>
<span class="lineno"></span><span class="op" id="516864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1535</span><span class="keyword" id="516867">func</span>&nbsp;<span class="op" id="516872">(</span><span class="ident" id="516873">cr</span>&nbsp;<span class="ident" id="516876">countReader</span><span class="op" id="516887">)</span>&nbsp;<span class="ident" id="516889">Read</span><span class="op" id="516893">(</span><span class="ident" id="516894">p</span>&nbsp;<span class="op" id="516896">[</span><span class="op" id="516897">]</span><span class="builtintype" id="516898">byte</span><span class="op" id="516902">)</span>&nbsp;<span class="op" id="516904">(</span><span class="ident" id="516905">n</span>&nbsp;<span class="builtintype" id="516907">int</span><span class="op" id="516910">,</span>&nbsp;<span class="ident" id="516912">err</span>&nbsp;<span class="builtintype" id="516916">error</span><span class="op" id="516921">)</span>&nbsp;<span class="op" id="516923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="516926">n</span><span class="op" id="516927">,</span>&nbsp;<span class="ident" id="516929">err</span>&nbsp;<span class="op" id="516933">=</span>&nbsp;<span class="ident" id="516935">cr</span><span class="op" id="516937">.</span><span class="ident" id="516938">r</span><span class="op" id="516939">.</span><span class="ident" id="516940">Read</span><span class="op" id="516944">(</span><span class="ident" id="516945">p</span><span class="op" id="516946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="516949">atomic</span><span class="op" id="516955">.</span><span class="ident" id="516956">AddInt64</span><span class="op" id="516964">(</span><span class="ident" id="516965">cr</span><span class="op" id="516967">.</span><span class="ident" id="516968">n</span><span class="op" id="516969">,</span>&nbsp;<span class="ident" id="516971">int64</span><span class="op" id="516976">(</span><span class="ident" id="516977">n</span><span class="op" id="516978">)</span><span class="op" id="516979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="516982">return</span><br>
<span class="lineno"></span><span class="op" id="516989">}</span><br>
<span class="lineno">1540</span><br>
<span class="lineno"></span><span class="keyword" id="516992">func</span>&nbsp;<span class="ident" id="516997">TestRequestBodyLimit</span><span class="op" id="517017">(</span><span class="ident" id="517018">t</span>&nbsp;<span class="op" id="517020">*</span><span class="ident" id="517021">testing</span><span class="op" id="517028">.</span><span class="ident" id="517029">T</span><span class="op" id="517030">)</span>&nbsp;<span class="op" id="517032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="517035">defer</span>&nbsp;<span class="ident" id="517041">afterTest</span><span class="op" id="517050">(</span><span class="ident" id="517051">t</span><span class="op" id="517052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="517055">const</span>&nbsp;<span class="ident" id="517061">limit</span>&nbsp;<span class="op" id="517067">=</span>&nbsp;<span class="num" id="517069">1</span>&nbsp;<span class="op" id="517071">&lt;&lt;</span>&nbsp;<span class="num" id="517074">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="517078">ts</span>&nbsp;<span class="op" id="517081">:=</span>&nbsp;<span class="ident" id="517084">httptest</span><span class="op" id="517092">.</span><span class="ident" id="517093">NewServer</span><span class="op" id="517102">(</span><span class="ident" id="517103">HandlerFunc</span><span class="op" id="517114">(</span><span class="keyword" id="517115">func</span><span class="op" id="517119">(</span><span class="ident" id="517120">w</span>&nbsp;<span class="ident" id="517122">ResponseWriter</span><span class="op" id="517136">,</span>&nbsp;<span class="ident" id="517138">r</span>&nbsp;<span class="op" id="517140">*</span><span class="ident" id="517141">Request</span><span class="op" id="517148">)</span>&nbsp;<span class="op" id="517150">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="517154">r</span><span class="op" id="517155">.</span><span class="ident" id="517156">Body</span>&nbsp;<span class="op" id="517161">=</span>&nbsp;<span class="ident" id="517163">MaxBytesReader</span><span class="op" id="517177">(</span><span class="ident" id="517178">w</span><span class="op" id="517179">,</span>&nbsp;<span class="ident" id="517181">r</span><span class="op" id="517182">.</span><span class="ident" id="517183">Body</span><span class="op" id="517187">,</span>&nbsp;<span class="ident" id="517189">limit</span><span class="op" id="517194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="517198">n</span><span class="op" id="517199">,</span>&nbsp;<span class="ident" id="517201">err</span>&nbsp;<span class="op" id="517205">:=</span>&nbsp;<span class="ident" id="517208">io</span><span class="op" id="517210">.</span><span class="ident" id="517211">Copy</span><span class="op" id="517215">(</span><span class="ident" id="517216">ioutil</span><span class="op" id="517222">.</span><span class="ident" id="517223">Discard</span><span class="op" id="517230">,</span>&nbsp;<span class="ident" id="517232">r</span><span class="op" id="517233">.</span><span class="ident" id="517234">Body</span><span class="op" id="517238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="517242">if</span>&nbsp;<span class="ident" id="517245">err</span>&nbsp;<span class="op" id="517249">==</span>&nbsp;<span class="builtintype" id="517252">nil</span>&nbsp;<span class="op" id="517256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="517261">t</span><span class="op" id="517262">.</span><span class="ident" id="517263">Errorf</span><span class="op" id="517269">(</span><span class="string" id="517270">&#34;expected&nbsp;error&nbsp;from&nbsp;io.Copy&#34;</span><span class="op" id="517299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="517303">}</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="517307">if</span>&nbsp;<span class="ident" id="517310">n</span>&nbsp;<span class="op" id="517312">!=</span>&nbsp;<span class="ident" id="517315">limit</span>&nbsp;<span class="op" id="517321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="517326">t</span><span class="op" id="517327">.</span><span class="ident" id="517328">Errorf</span><span class="op" id="517334">(</span><span class="string" id="517335">&#34;io.Copy&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="517358">,</span>&nbsp;<span class="ident" id="517360">n</span><span class="op" id="517361">,</span>&nbsp;<span class="ident" id="517363">limit</span><span class="op" id="517368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="517372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="517375">}</span><span class="op" id="517376">)</span><span class="op" id="517377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="517380">defer</span>&nbsp;<span class="ident" id="517386">ts</span><span class="op" id="517388">.</span><span class="ident" id="517389">Close</span><span class="op" id="517394">(</span><span class="op" id="517395">)</span><br>
<span class="lineno">1555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="517399">nWritten</span>&nbsp;<span class="op" id="517408">:=</span>&nbsp;<span class="builtinfunc" id="517411">new</span><span class="op" id="517414">(</span><span class="ident" id="517415">int64</span><span class="op" id="517420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="517423">req</span><span class="op" id="517426">,</span>&nbsp;<span class="ident" id="517428">_</span>&nbsp;<span class="op" id="517430">:=</span>&nbsp;<span class="ident" id="517433">NewRequest</span><span class="op" id="517443">(</span><span class="string" id="517444">&#34;POST&#34;</span><span class="op" id="517450">,</span>&nbsp;<span class="ident" id="517452">ts</span><span class="op" id="517454">.</span><span class="ident" id="517455">URL</span><span class="op" id="517458">,</span>&nbsp;<span class="ident" id="517460">io</span><span class="op" id="517462">.</span><span class="ident" id="517463">LimitReader</span><span class="op" id="517474">(</span><span class="ident" id="517475">countReader</span><span class="op" id="517486">{</span><span class="ident" id="517487">neverEnding</span><span class="op" id="517498">(</span><span class="string" id="517499">&#39;a&#39;</span><span class="op" id="517502">)</span><span class="op" id="517503">,</span>&nbsp;<span class="ident" id="517505">nWritten</span><span class="op" id="517513">}</span><span class="op" id="517514">,</span>&nbsp;<span class="ident" id="517516">limit</span><span class="op" id="517521">*</span><span class="num" id="517522">200</span><span class="op" id="517525">)</span><span class="op" id="517526">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="517530">//&nbsp;Send&nbsp;the&nbsp;POST,&nbsp;but&nbsp;don&#39;t&nbsp;care&nbsp;it&nbsp;succeeds&nbsp;or&nbsp;not.&nbsp;&nbsp;The</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="517589">//&nbsp;remote&nbsp;side&nbsp;is&nbsp;going&nbsp;to&nbsp;reply&nbsp;and&nbsp;then&nbsp;close&nbsp;the&nbsp;TCP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="517646">//&nbsp;connection,&nbsp;and&nbsp;HTTP&nbsp;doesn&#39;t&nbsp;really&nbsp;define&nbsp;if&nbsp;that&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="517703">//&nbsp;allowed&nbsp;or&nbsp;not.&nbsp;&nbsp;Some&nbsp;HTTP&nbsp;clients&nbsp;will&nbsp;get&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="517764">//&nbsp;and&nbsp;some&nbsp;(like&nbsp;ours,&nbsp;currently)&nbsp;will&nbsp;complain&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="517823">//&nbsp;request&nbsp;write&nbsp;failed,&nbsp;without&nbsp;reading&nbsp;the&nbsp;response.</span><br>
<span class="lineno">1565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="517879">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="517883">//&nbsp;But&nbsp;that&#39;s&nbsp;okay,&nbsp;since&nbsp;what&nbsp;we&#39;re&nbsp;really&nbsp;testing&nbsp;is&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="517944">//&nbsp;the&nbsp;remote&nbsp;side&nbsp;hung&nbsp;up&nbsp;on&nbsp;us&nbsp;before&nbsp;we&nbsp;wrote&nbsp;too&nbsp;much.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="518004">_</span><span class="op" id="518005">,</span>&nbsp;<span class="ident" id="518007">_</span>&nbsp;<span class="op" id="518009">=</span>&nbsp;<span class="ident" id="518011">DefaultClient</span><span class="op" id="518024">.</span><span class="ident" id="518025">Do</span><span class="op" id="518027">(</span><span class="ident" id="518028">req</span><span class="op" id="518031">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="518035">if</span>&nbsp;<span class="ident" id="518038">atomic</span><span class="op" id="518044">.</span><span class="ident" id="518045">LoadInt64</span><span class="op" id="518054">(</span><span class="ident" id="518055">nWritten</span><span class="op" id="518063">)</span>&nbsp;<span class="op" id="518065">&gt;</span>&nbsp;<span class="ident" id="518067">limit</span><span class="op" id="518072">*</span><span class="num" id="518073">100</span>&nbsp;<span class="op" id="518077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="518081">t</span><span class="op" id="518082">.</span><span class="ident" id="518083">Errorf</span><span class="op" id="518089">(</span><span class="string" id="518090">&#34;handler&nbsp;restricted&nbsp;the&nbsp;request&nbsp;body&nbsp;to&nbsp;%d&nbsp;bytes,&nbsp;but&nbsp;client&nbsp;managed&nbsp;to&nbsp;write&nbsp;%d&#34;</span><span class="op" id="518171">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="518176">limit</span><span class="op" id="518181">,</span>&nbsp;<span class="ident" id="518183">nWritten</span><span class="op" id="518191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="518194">}</span><br>
<span class="lineno"></span><span class="op" id="518196">}</span><br>
<span class="lineno">1575</span><br>
<span class="lineno"></span><span class="comment" id="518199">//&nbsp;TestClientWriteShutdown&nbsp;tests&nbsp;that&nbsp;if&nbsp;the&nbsp;client&nbsp;shuts&nbsp;down&nbsp;the&nbsp;write</span><br>
<span class="lineno"></span><span class="comment" id="518272">//&nbsp;side&nbsp;of&nbsp;their&nbsp;TCP&nbsp;connection,&nbsp;the&nbsp;server&nbsp;doesn&#39;t&nbsp;send&nbsp;a&nbsp;400&nbsp;Bad&nbsp;Request.</span><br>
<span class="lineno"></span><span class="keyword" id="518348">func</span>&nbsp;<span class="ident" id="518353">TestClientWriteShutdown</span><span class="op" id="518376">(</span><span class="ident" id="518377">t</span>&nbsp;<span class="op" id="518379">*</span><span class="ident" id="518380">testing</span><span class="op" id="518387">.</span><span class="ident" id="518388">T</span><span class="op" id="518389">)</span>&nbsp;<span class="op" id="518391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="518394">if</span>&nbsp;<span class="ident" id="518397">runtime</span><span class="op" id="518404">.</span><span class="ident" id="518405">GOOS</span>&nbsp;<span class="op" id="518410">==</span>&nbsp;<span class="string" id="518413">&#34;plan9&#34;</span>&nbsp;<span class="op" id="518421">{</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="518425">t</span><span class="op" id="518426">.</span><span class="ident" id="518427">Skip</span><span class="op" id="518431">(</span><span class="string" id="518432">&#34;skipping&nbsp;test;&nbsp;see&nbsp;http://golang.org/issue/7237&#34;</span><span class="op" id="518481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="518484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="518487">defer</span>&nbsp;<span class="ident" id="518493">afterTest</span><span class="op" id="518502">(</span><span class="ident" id="518503">t</span><span class="op" id="518504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="518507">ts</span>&nbsp;<span class="op" id="518510">:=</span>&nbsp;<span class="ident" id="518513">httptest</span><span class="op" id="518521">.</span><span class="ident" id="518522">NewServer</span><span class="op" id="518531">(</span><span class="ident" id="518532">HandlerFunc</span><span class="op" id="518543">(</span><span class="keyword" id="518544">func</span><span class="op" id="518548">(</span><span class="ident" id="518549">w</span>&nbsp;<span class="ident" id="518551">ResponseWriter</span><span class="op" id="518565">,</span>&nbsp;<span class="ident" id="518567">r</span>&nbsp;<span class="op" id="518569">*</span><span class="ident" id="518570">Request</span><span class="op" id="518577">)</span>&nbsp;<span class="op" id="518579">{</span><span class="op" id="518580">}</span><span class="op" id="518581">)</span><span class="op" id="518582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="518585">defer</span>&nbsp;<span class="ident" id="518591">ts</span><span class="op" id="518593">.</span><span class="ident" id="518594">Close</span><span class="op" id="518599">(</span><span class="op" id="518600">)</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="518603">conn</span><span class="op" id="518607">,</span>&nbsp;<span class="ident" id="518609">err</span>&nbsp;<span class="op" id="518613">:=</span>&nbsp;<span class="ident" id="518616">net</span><span class="op" id="518619">.</span><span class="ident" id="518620">Dial</span><span class="op" id="518624">(</span><span class="string" id="518625">&#34;tcp&#34;</span><span class="op" id="518630">,</span>&nbsp;<span class="ident" id="518632">ts</span><span class="op" id="518634">.</span><span class="ident" id="518635">Listener</span><span class="op" id="518643">.</span><span class="ident" id="518644">Addr</span><span class="op" id="518648">(</span><span class="op" id="518649">)</span><span class="op" id="518650">.</span><span class="ident" id="518651">String</span><span class="op" id="518657">(</span><span class="op" id="518658">)</span><span class="op" id="518659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="518662">if</span>&nbsp;<span class="ident" id="518665">err</span>&nbsp;<span class="op" id="518669">!=</span>&nbsp;<span class="builtintype" id="518672">nil</span>&nbsp;<span class="op" id="518676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="518680">t</span><span class="op" id="518681">.</span><span class="ident" id="518682">Fatalf</span><span class="op" id="518688">(</span><span class="string" id="518689">&#34;Dial:&nbsp;%v&#34;</span><span class="op" id="518699">,</span>&nbsp;<span class="ident" id="518701">err</span><span class="op" id="518704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="518707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="518710">err</span>&nbsp;<span class="op" id="518714">=</span>&nbsp;<span class="ident" id="518716">conn</span><span class="op" id="518720">.</span><span class="op" id="518721">(</span><span class="op" id="518722">*</span><span class="ident" id="518723">net</span><span class="op" id="518726">.</span><span class="ident" id="518727">TCPConn</span><span class="op" id="518734">)</span><span class="op" id="518735">.</span><span class="ident" id="518736">CloseWrite</span><span class="op" id="518746">(</span><span class="op" id="518747">)</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="518750">if</span>&nbsp;<span class="ident" id="518753">err</span>&nbsp;<span class="op" id="518757">!=</span>&nbsp;<span class="builtintype" id="518760">nil</span>&nbsp;<span class="op" id="518764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="518768">t</span><span class="op" id="518769">.</span><span class="ident" id="518770">Fatalf</span><span class="op" id="518776">(</span><span class="string" id="518777">&#34;Dial:&nbsp;%v&#34;</span><span class="op" id="518787">,</span>&nbsp;<span class="ident" id="518789">err</span><span class="op" id="518792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="518795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="518798">donec</span>&nbsp;<span class="op" id="518804">:=</span>&nbsp;<span class="builtinfunc" id="518807">make</span><span class="op" id="518811">(</span><span class="keyword" id="518812">chan</span>&nbsp;<span class="builtintype" id="518817">bool</span><span class="op" id="518821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="518824">go</span>&nbsp;<span class="keyword" id="518827">func</span><span class="op" id="518831">(</span><span class="op" id="518832">)</span>&nbsp;<span class="op" id="518834">{</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="518838">defer</span>&nbsp;<span class="builtinfunc" id="518844">close</span><span class="op" id="518849">(</span><span class="ident" id="518850">donec</span><span class="op" id="518855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="518859">bs</span><span class="op" id="518861">,</span>&nbsp;<span class="ident" id="518863">err</span>&nbsp;<span class="op" id="518867">:=</span>&nbsp;<span class="ident" id="518870">ioutil</span><span class="op" id="518876">.</span><span class="ident" id="518877">ReadAll</span><span class="op" id="518884">(</span><span class="ident" id="518885">conn</span><span class="op" id="518889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="518893">if</span>&nbsp;<span class="ident" id="518896">err</span>&nbsp;<span class="op" id="518900">!=</span>&nbsp;<span class="builtintype" id="518903">nil</span>&nbsp;<span class="op" id="518907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="518912">t</span><span class="op" id="518913">.</span><span class="ident" id="518914">Fatalf</span><span class="op" id="518920">(</span><span class="string" id="518921">&#34;ReadAll:&nbsp;%v&#34;</span><span class="op" id="518934">,</span>&nbsp;<span class="ident" id="518936">err</span><span class="op" id="518939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="518943">}</span><br>
<span class="lineno">1600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="518947">got</span>&nbsp;<span class="op" id="518951">:=</span>&nbsp;<span class="builtintype" id="518954">string</span><span class="op" id="518960">(</span><span class="ident" id="518961">bs</span><span class="op" id="518963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="518967">if</span>&nbsp;<span class="ident" id="518970">got</span>&nbsp;<span class="op" id="518974">!=</span>&nbsp;<span class="string" id="518977">&#34;&#34;</span>&nbsp;<span class="op" id="518980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="518985">t</span><span class="op" id="518986">.</span><span class="ident" id="518987">Errorf</span><span class="op" id="518993">(</span><span class="string" id="518994">&#34;read&nbsp;%q&nbsp;from&nbsp;server;&nbsp;want&nbsp;nothing&#34;</span><span class="op" id="519029">,</span>&nbsp;<span class="ident" id="519031">got</span><span class="op" id="519034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="519038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="519041">}</span><span class="op" id="519042">(</span><span class="op" id="519043">)</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="519046">select</span>&nbsp;<span class="op" id="519053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="519056">case</span>&nbsp;<span class="op" id="519061">&lt;-</span><span class="ident" id="519063">donec</span><span class="op" id="519068">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="519071">case</span>&nbsp;<span class="op" id="519076">&lt;-</span><span class="ident" id="519078">time</span><span class="op" id="519082">.</span><span class="ident" id="519083">After</span><span class="op" id="519088">(</span><span class="num" id="519089">10</span>&nbsp;<span class="op" id="519092">*</span>&nbsp;<span class="ident" id="519094">time</span><span class="op" id="519098">.</span><span class="ident" id="519099">Second</span><span class="op" id="519105">)</span><span class="op" id="519106">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="519110">t</span><span class="op" id="519111">.</span><span class="ident" id="519112">Fatalf</span><span class="op" id="519118">(</span><span class="string" id="519119">&#34;timeout&#34;</span><span class="op" id="519128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="519131">}</span><br>
<span class="lineno">1610</span><span class="op" id="519133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="519136">//&nbsp;Tests&nbsp;that&nbsp;chunked&nbsp;server&nbsp;responses&nbsp;that&nbsp;write&nbsp;1&nbsp;byte&nbsp;at&nbsp;a&nbsp;time&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="519207">//&nbsp;buffered&nbsp;before&nbsp;chunk&nbsp;headers&nbsp;are&nbsp;added,&nbsp;not&nbsp;after&nbsp;chunk&nbsp;headers.</span><br>
<span class="lineno"></span><span class="keyword" id="519276">func</span>&nbsp;<span class="ident" id="519281">TestServerBufferedChunking</span><span class="op" id="519307">(</span><span class="ident" id="519308">t</span>&nbsp;<span class="op" id="519310">*</span><span class="ident" id="519311">testing</span><span class="op" id="519318">.</span><span class="ident" id="519319">T</span><span class="op" id="519320">)</span>&nbsp;<span class="op" id="519322">{</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="519325">conn</span>&nbsp;<span class="op" id="519330">:=</span>&nbsp;<span class="builtinfunc" id="519333">new</span><span class="op" id="519336">(</span><span class="ident" id="519337">testConn</span><span class="op" id="519345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="519348">conn</span><span class="op" id="519352">.</span><span class="ident" id="519353">readBuf</span><span class="op" id="519360">.</span><span class="ident" id="519361">Write</span><span class="op" id="519366">(</span><span class="op" id="519367">[</span><span class="op" id="519368">]</span><span class="builtintype" id="519369">byte</span><span class="op" id="519373">(</span><span class="string" id="519374">&#34;GET&nbsp;/&nbsp;HTTP/1.1\r\n\r\n&#34;</span><span class="op" id="519398">)</span><span class="op" id="519399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="519402">conn</span><span class="op" id="519406">.</span><span class="ident" id="519407">closec</span>&nbsp;<span class="op" id="519414">=</span>&nbsp;<span class="builtinfunc" id="519416">make</span><span class="op" id="519420">(</span><span class="keyword" id="519421">chan</span>&nbsp;<span class="builtintype" id="519426">bool</span><span class="op" id="519430">,</span>&nbsp;<span class="num" id="519432">1</span><span class="op" id="519433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="519436">ls</span>&nbsp;<span class="op" id="519439">:=</span>&nbsp;<span class="op" id="519442">&amp;</span><span class="ident" id="519443">oneConnListener</span><span class="op" id="519458">{</span><span class="ident" id="519459">conn</span><span class="op" id="519463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="519466">go</span>&nbsp;<span class="ident" id="519469">Serve</span><span class="op" id="519474">(</span><span class="ident" id="519475">ls</span><span class="op" id="519477">,</span>&nbsp;<span class="ident" id="519479">HandlerFunc</span><span class="op" id="519490">(</span><span class="keyword" id="519491">func</span><span class="op" id="519495">(</span><span class="ident" id="519496">rw</span>&nbsp;<span class="ident" id="519499">ResponseWriter</span><span class="op" id="519513">,</span>&nbsp;<span class="ident" id="519515">req</span>&nbsp;<span class="op" id="519519">*</span><span class="ident" id="519520">Request</span><span class="op" id="519527">)</span>&nbsp;<span class="op" id="519529">{</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="519533">rw</span><span class="op" id="519535">.</span><span class="op" id="519536">(</span><span class="ident" id="519537">Flusher</span><span class="op" id="519544">)</span><span class="op" id="519545">.</span><span class="ident" id="519546">Flush</span><span class="op" id="519551">(</span><span class="op" id="519552">)</span>&nbsp;<span class="comment" id="519554">//&nbsp;force&nbsp;the&nbsp;Header&nbsp;to&nbsp;be&nbsp;sent,&nbsp;in&nbsp;chunking&nbsp;mode,&nbsp;not&nbsp;counting&nbsp;the&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="519630">rw</span><span class="op" id="519632">.</span><span class="ident" id="519633">Write</span><span class="op" id="519638">(</span><span class="op" id="519639">[</span><span class="op" id="519640">]</span><span class="builtintype" id="519641">byte</span><span class="op" id="519645">{</span><span class="string" id="519646">&#39;x&#39;</span><span class="op" id="519649">}</span><span class="op" id="519650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="519654">rw</span><span class="op" id="519656">.</span><span class="ident" id="519657">Write</span><span class="op" id="519662">(</span><span class="op" id="519663">[</span><span class="op" id="519664">]</span><span class="builtintype" id="519665">byte</span><span class="op" id="519669">{</span><span class="string" id="519670">&#39;y&#39;</span><span class="op" id="519673">}</span><span class="op" id="519674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="519678">rw</span><span class="op" id="519680">.</span><span class="ident" id="519681">Write</span><span class="op" id="519686">(</span><span class="op" id="519687">[</span><span class="op" id="519688">]</span><span class="builtintype" id="519689">byte</span><span class="op" id="519693">{</span><span class="string" id="519694">&#39;z&#39;</span><span class="op" id="519697">}</span><span class="op" id="519698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="519701">}</span><span class="op" id="519702">)</span><span class="op" id="519703">)</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="519706">&lt;-</span><span class="ident" id="519708">conn</span><span class="op" id="519712">.</span><span class="ident" id="519713">closec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="519721">if</span>&nbsp;<span class="op" id="519724">!</span><span class="ident" id="519725">bytes</span><span class="op" id="519730">.</span><span class="ident" id="519731">HasSuffix</span><span class="op" id="519740">(</span><span class="ident" id="519741">conn</span><span class="op" id="519745">.</span><span class="ident" id="519746">writeBuf</span><span class="op" id="519754">.</span><span class="ident" id="519755">Bytes</span><span class="op" id="519760">(</span><span class="op" id="519761">)</span><span class="op" id="519762">,</span>&nbsp;<span class="op" id="519764">[</span><span class="op" id="519765">]</span><span class="builtintype" id="519766">byte</span><span class="op" id="519770">(</span><span class="string" id="519771">&#34;\r\n\r\n3\r\nxyz\r\n0\r\n\r\n&#34;</span><span class="op" id="519802">)</span><span class="op" id="519803">)</span>&nbsp;<span class="op" id="519805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="519809">t</span><span class="op" id="519810">.</span><span class="ident" id="519811">Errorf</span><span class="op" id="519817">(</span><span class="string" id="519818">&#34;response&nbsp;didn&#39;t&nbsp;end&nbsp;with&nbsp;a&nbsp;single&nbsp;3&nbsp;byte&nbsp;&#39;xyz&#39;&nbsp;chunk;&nbsp;got:\n%q&#34;</span><span class="op" id="519882">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="519887">conn</span><span class="op" id="519891">.</span><span class="ident" id="519892">writeBuf</span><span class="op" id="519900">.</span><span class="ident" id="519901">Bytes</span><span class="op" id="519906">(</span><span class="op" id="519907">)</span><span class="op" id="519908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="519911">}</span><br>
<span class="lineno">1630</span><span class="op" id="519913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="519916">//&nbsp;Tests&nbsp;that&nbsp;the&nbsp;server&nbsp;flushes&nbsp;its&nbsp;response&nbsp;headers&nbsp;out&nbsp;when&nbsp;it&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="519984">//&nbsp;ignoring&nbsp;the&nbsp;response&nbsp;body&nbsp;and&nbsp;waits&nbsp;a&nbsp;bit&nbsp;before&nbsp;forcefully</span><br>
<span class="lineno"></span><span class="comment" id="520048">//&nbsp;closing&nbsp;the&nbsp;TCP&nbsp;connection,&nbsp;causing&nbsp;the&nbsp;client&nbsp;to&nbsp;get&nbsp;a&nbsp;RST.</span><br>
<span class="lineno">1635</span><span class="comment" id="520112">//&nbsp;See&nbsp;http://golang.org/issue/3595</span><br>
<span class="lineno"></span><span class="keyword" id="520148">func</span>&nbsp;<span class="ident" id="520153">TestServerGracefulClose</span><span class="op" id="520176">(</span><span class="ident" id="520177">t</span>&nbsp;<span class="op" id="520179">*</span><span class="ident" id="520180">testing</span><span class="op" id="520187">.</span><span class="ident" id="520188">T</span><span class="op" id="520189">)</span>&nbsp;<span class="op" id="520191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="520194">defer</span>&nbsp;<span class="ident" id="520200">afterTest</span><span class="op" id="520209">(</span><span class="ident" id="520210">t</span><span class="op" id="520211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="520214">ts</span>&nbsp;<span class="op" id="520217">:=</span>&nbsp;<span class="ident" id="520220">httptest</span><span class="op" id="520228">.</span><span class="ident" id="520229">NewServer</span><span class="op" id="520238">(</span><span class="ident" id="520239">HandlerFunc</span><span class="op" id="520250">(</span><span class="keyword" id="520251">func</span><span class="op" id="520255">(</span><span class="ident" id="520256">w</span>&nbsp;<span class="ident" id="520258">ResponseWriter</span><span class="op" id="520272">,</span>&nbsp;<span class="ident" id="520274">r</span>&nbsp;<span class="op" id="520276">*</span><span class="ident" id="520277">Request</span><span class="op" id="520284">)</span>&nbsp;<span class="op" id="520286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="520290">Error</span><span class="op" id="520295">(</span><span class="ident" id="520296">w</span><span class="op" id="520297">,</span>&nbsp;<span class="string" id="520299">&#34;bye&#34;</span><span class="op" id="520304">,</span>&nbsp;<span class="ident" id="520306">StatusUnauthorized</span><span class="op" id="520324">)</span><br>
<span class="lineno">1640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="520327">}</span><span class="op" id="520328">)</span><span class="op" id="520329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="520332">defer</span>&nbsp;<span class="ident" id="520338">ts</span><span class="op" id="520340">.</span><span class="ident" id="520341">Close</span><span class="op" id="520346">(</span><span class="op" id="520347">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="520351">conn</span><span class="op" id="520355">,</span>&nbsp;<span class="ident" id="520357">err</span>&nbsp;<span class="op" id="520361">:=</span>&nbsp;<span class="ident" id="520364">net</span><span class="op" id="520367">.</span><span class="ident" id="520368">Dial</span><span class="op" id="520372">(</span><span class="string" id="520373">&#34;tcp&#34;</span><span class="op" id="520378">,</span>&nbsp;<span class="ident" id="520380">ts</span><span class="op" id="520382">.</span><span class="ident" id="520383">Listener</span><span class="op" id="520391">.</span><span class="ident" id="520392">Addr</span><span class="op" id="520396">(</span><span class="op" id="520397">)</span><span class="op" id="520398">.</span><span class="ident" id="520399">String</span><span class="op" id="520405">(</span><span class="op" id="520406">)</span><span class="op" id="520407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="520410">if</span>&nbsp;<span class="ident" id="520413">err</span>&nbsp;<span class="op" id="520417">!=</span>&nbsp;<span class="builtintype" id="520420">nil</span>&nbsp;<span class="op" id="520424">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="520428">t</span><span class="op" id="520429">.</span><span class="ident" id="520430">Fatal</span><span class="op" id="520435">(</span><span class="ident" id="520436">err</span><span class="op" id="520439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="520442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="520445">defer</span>&nbsp;<span class="ident" id="520451">conn</span><span class="op" id="520455">.</span><span class="ident" id="520456">Close</span><span class="op" id="520461">(</span><span class="op" id="520462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="520465">const</span>&nbsp;<span class="ident" id="520471">bodySize</span>&nbsp;<span class="op" id="520480">=</span>&nbsp;<span class="num" id="520482">5</span>&nbsp;<span class="op" id="520484">&lt;&lt;</span>&nbsp;<span class="num" id="520487">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="520491">req</span>&nbsp;<span class="op" id="520495">:=</span>&nbsp;<span class="op" id="520498">[</span><span class="op" id="520499">]</span><span class="builtintype" id="520500">byte</span><span class="op" id="520504">(</span><span class="ident" id="520505">fmt</span><span class="op" id="520508">.</span><span class="ident" id="520509">Sprintf</span><span class="op" id="520516">(</span><span class="string" id="520517">&#34;POST&nbsp;/&nbsp;HTTP/1.1\r\nHost:&nbsp;foo.com\r\nContent-Length:&nbsp;%d\r\n\r\n&#34;</span><span class="op" id="520581">,</span>&nbsp;<span class="ident" id="520583">bodySize</span><span class="op" id="520591">)</span><span class="op" id="520592">)</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="520595">for</span>&nbsp;<span class="ident" id="520599">i</span>&nbsp;<span class="op" id="520601">:=</span>&nbsp;<span class="num" id="520604">0</span><span class="op" id="520605">;</span>&nbsp;<span class="ident" id="520607">i</span>&nbsp;<span class="op" id="520609">&lt;</span>&nbsp;<span class="ident" id="520611">bodySize</span><span class="op" id="520619">;</span>&nbsp;<span class="ident" id="520621">i</span><span class="op" id="520622">++</span>&nbsp;<span class="op" id="520625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="520629">req</span>&nbsp;<span class="op" id="520633">=</span>&nbsp;<span class="builtinfunc" id="520635">append</span><span class="op" id="520641">(</span><span class="ident" id="520642">req</span><span class="op" id="520645">,</span>&nbsp;<span class="string" id="520647">&#39;x&#39;</span><span class="op" id="520650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="520653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="520656">writeErr</span>&nbsp;<span class="op" id="520665">:=</span>&nbsp;<span class="builtinfunc" id="520668">make</span><span class="op" id="520672">(</span><span class="keyword" id="520673">chan</span>&nbsp;<span class="builtintype" id="520678">error</span><span class="op" id="520683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="520686">go</span>&nbsp;<span class="keyword" id="520689">func</span><span class="op" id="520693">(</span><span class="op" id="520694">)</span>&nbsp;<span class="op" id="520696">{</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="520700">_</span><span class="op" id="520701">,</span>&nbsp;<span class="ident" id="520703">err</span>&nbsp;<span class="op" id="520707">:=</span>&nbsp;<span class="ident" id="520710">conn</span><span class="op" id="520714">.</span><span class="ident" id="520715">Write</span><span class="op" id="520720">(</span><span class="ident" id="520721">req</span><span class="op" id="520724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="520728">writeErr</span>&nbsp;<span class="op" id="520737">&lt;-</span>&nbsp;<span class="ident" id="520740">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="520745">}</span><span class="op" id="520746">(</span><span class="op" id="520747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="520750">br</span>&nbsp;<span class="op" id="520753">:=</span>&nbsp;<span class="ident" id="520756">bufio</span><span class="op" id="520761">.</span><span class="ident" id="520762">NewReader</span><span class="op" id="520771">(</span><span class="ident" id="520772">conn</span><span class="op" id="520776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="520779">lineNum</span>&nbsp;<span class="op" id="520787">:=</span>&nbsp;<span class="num" id="520790">0</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="520793">for</span>&nbsp;<span class="op" id="520797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="520801">line</span><span class="op" id="520805">,</span>&nbsp;<span class="ident" id="520807">err</span>&nbsp;<span class="op" id="520811">:=</span>&nbsp;<span class="ident" id="520814">br</span><span class="op" id="520816">.</span><span class="ident" id="520817">ReadString</span><span class="op" id="520827">(</span><span class="string" id="520828">&#39;\n&#39;</span><span class="op" id="520832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="520836">if</span>&nbsp;<span class="ident" id="520839">err</span>&nbsp;<span class="op" id="520843">==</span>&nbsp;<span class="ident" id="520846">io</span><span class="op" id="520848">.</span><span class="ident" id="520849">EOF</span>&nbsp;<span class="op" id="520853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="520858">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="520866">}</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="520870">if</span>&nbsp;<span class="ident" id="520873">err</span>&nbsp;<span class="op" id="520877">!=</span>&nbsp;<span class="builtintype" id="520880">nil</span>&nbsp;<span class="op" id="520884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="520889">t</span><span class="op" id="520890">.</span><span class="ident" id="520891">Fatalf</span><span class="op" id="520897">(</span><span class="string" id="520898">&#34;ReadLine:&nbsp;%v&#34;</span><span class="op" id="520912">,</span>&nbsp;<span class="ident" id="520914">err</span><span class="op" id="520917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="520921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="520925">lineNum</span><span class="op" id="520932">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="520937">if</span>&nbsp;<span class="ident" id="520940">lineNum</span>&nbsp;<span class="op" id="520948">==</span>&nbsp;<span class="num" id="520951">1</span>&nbsp;<span class="op" id="520953">&amp;&amp;</span>&nbsp;<span class="op" id="520956">!</span><span class="ident" id="520957">strings</span><span class="op" id="520964">.</span><span class="ident" id="520965">Contains</span><span class="op" id="520973">(</span><span class="ident" id="520974">line</span><span class="op" id="520978">,</span>&nbsp;<span class="string" id="520980">&#34;401&nbsp;Unauthorized&#34;</span><span class="op" id="520998">)</span>&nbsp;<span class="op" id="521000">{</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="521005">t</span><span class="op" id="521006">.</span><span class="ident" id="521007">Errorf</span><span class="op" id="521013">(</span><span class="string" id="521014">&#34;Response&nbsp;line&nbsp;=&nbsp;%q;&nbsp;want&nbsp;a&nbsp;401&#34;</span><span class="op" id="521046">,</span>&nbsp;<span class="ident" id="521048">line</span><span class="op" id="521052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="521056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="521059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="521062">//&nbsp;Wait&nbsp;for&nbsp;write&nbsp;to&nbsp;finish.&nbsp;This&nbsp;is&nbsp;a&nbsp;broken&nbsp;pipe&nbsp;on&nbsp;both</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="521122">//&nbsp;Darwin&nbsp;and&nbsp;Linux,&nbsp;but&nbsp;checking&nbsp;this&nbsp;isn&#39;t&nbsp;the&nbsp;point&nbsp;of</span><br>
<span class="lineno">1675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="521181">//&nbsp;the&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="521195">&lt;-</span><span class="ident" id="521197">writeErr</span><br>
<span class="lineno"></span><span class="op" id="521206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="521209">func</span>&nbsp;<span class="ident" id="521214">TestCaseSensitiveMethod</span><span class="op" id="521237">(</span><span class="ident" id="521238">t</span>&nbsp;<span class="op" id="521240">*</span><span class="ident" id="521241">testing</span><span class="op" id="521248">.</span><span class="ident" id="521249">T</span><span class="op" id="521250">)</span>&nbsp;<span class="op" id="521252">{</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="521255">defer</span>&nbsp;<span class="ident" id="521261">afterTest</span><span class="op" id="521270">(</span><span class="ident" id="521271">t</span><span class="op" id="521272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="521275">ts</span>&nbsp;<span class="op" id="521278">:=</span>&nbsp;<span class="ident" id="521281">httptest</span><span class="op" id="521289">.</span><span class="ident" id="521290">NewServer</span><span class="op" id="521299">(</span><span class="ident" id="521300">HandlerFunc</span><span class="op" id="521311">(</span><span class="keyword" id="521312">func</span><span class="op" id="521316">(</span><span class="ident" id="521317">w</span>&nbsp;<span class="ident" id="521319">ResponseWriter</span><span class="op" id="521333">,</span>&nbsp;<span class="ident" id="521335">r</span>&nbsp;<span class="op" id="521337">*</span><span class="ident" id="521338">Request</span><span class="op" id="521345">)</span>&nbsp;<span class="op" id="521347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="521351">if</span>&nbsp;<span class="ident" id="521354">r</span><span class="op" id="521355">.</span><span class="ident" id="521356">Method</span>&nbsp;<span class="op" id="521363">!=</span>&nbsp;<span class="string" id="521366">&#34;get&#34;</span>&nbsp;<span class="op" id="521372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="521377">t</span><span class="op" id="521378">.</span><span class="ident" id="521379">Errorf</span><span class="op" id="521385">(</span><span class="string" id="521386">`Got&nbsp;method&nbsp;%q;&nbsp;want&nbsp;&#34;get&#34;`</span><span class="op" id="521413">,</span>&nbsp;<span class="ident" id="521415">r</span><span class="op" id="521416">.</span><span class="ident" id="521417">Method</span><span class="op" id="521423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="521427">}</span><br>
<span class="lineno">1685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="521430">}</span><span class="op" id="521431">)</span><span class="op" id="521432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="521435">defer</span>&nbsp;<span class="ident" id="521441">ts</span><span class="op" id="521443">.</span><span class="ident" id="521444">Close</span><span class="op" id="521449">(</span><span class="op" id="521450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="521453">req</span><span class="op" id="521456">,</span>&nbsp;<span class="ident" id="521458">_</span>&nbsp;<span class="op" id="521460">:=</span>&nbsp;<span class="ident" id="521463">NewRequest</span><span class="op" id="521473">(</span><span class="string" id="521474">&#34;get&#34;</span><span class="op" id="521479">,</span>&nbsp;<span class="ident" id="521481">ts</span><span class="op" id="521483">.</span><span class="ident" id="521484">URL</span><span class="op" id="521487">,</span>&nbsp;<span class="builtintype" id="521489">nil</span><span class="op" id="521492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="521495">res</span><span class="op" id="521498">,</span>&nbsp;<span class="ident" id="521500">err</span>&nbsp;<span class="op" id="521504">:=</span>&nbsp;<span class="ident" id="521507">DefaultClient</span><span class="op" id="521520">.</span><span class="ident" id="521521">Do</span><span class="op" id="521523">(</span><span class="ident" id="521524">req</span><span class="op" id="521527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="521530">if</span>&nbsp;<span class="ident" id="521533">err</span>&nbsp;<span class="op" id="521537">!=</span>&nbsp;<span class="builtintype" id="521540">nil</span>&nbsp;<span class="op" id="521544">{</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="521548">t</span><span class="op" id="521549">.</span><span class="ident" id="521550">Error</span><span class="op" id="521555">(</span><span class="ident" id="521556">err</span><span class="op" id="521559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="521563">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="521571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="521574">res</span><span class="op" id="521577">.</span><span class="ident" id="521578">Body</span><span class="op" id="521582">.</span><span class="ident" id="521583">Close</span><span class="op" id="521588">(</span><span class="op" id="521589">)</span><br>
<span class="lineno"></span><span class="op" id="521591">}</span><br>
<span class="lineno">1695</span><br>
<span class="lineno"></span><span class="comment" id="521594">//&nbsp;TestContentLengthZero&nbsp;tests&nbsp;that&nbsp;for&nbsp;both&nbsp;an&nbsp;HTTP/1.0&nbsp;and&nbsp;HTTP/1.1</span><br>
<span class="lineno"></span><span class="comment" id="521664">//&nbsp;request&nbsp;(both&nbsp;keep-alive),&nbsp;when&nbsp;a&nbsp;Handler&nbsp;never&nbsp;writes&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="521726">//&nbsp;response,&nbsp;the&nbsp;net/http&nbsp;package&nbsp;adds&nbsp;a&nbsp;&#34;Content-Length:&nbsp;0&#34;&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="521796">//&nbsp;header.</span><br>
<span class="lineno">1700</span><span class="keyword" id="521807">func</span>&nbsp;<span class="ident" id="521812">TestContentLengthZero</span><span class="op" id="521833">(</span><span class="ident" id="521834">t</span>&nbsp;<span class="op" id="521836">*</span><span class="ident" id="521837">testing</span><span class="op" id="521844">.</span><span class="ident" id="521845">T</span><span class="op" id="521846">)</span>&nbsp;<span class="op" id="521848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="521851">ts</span>&nbsp;<span class="op" id="521854">:=</span>&nbsp;<span class="ident" id="521857">httptest</span><span class="op" id="521865">.</span><span class="ident" id="521866">NewServer</span><span class="op" id="521875">(</span><span class="ident" id="521876">HandlerFunc</span><span class="op" id="521887">(</span><span class="keyword" id="521888">func</span><span class="op" id="521892">(</span><span class="ident" id="521893">rw</span>&nbsp;<span class="ident" id="521896">ResponseWriter</span><span class="op" id="521910">,</span>&nbsp;<span class="ident" id="521912">req</span>&nbsp;<span class="op" id="521916">*</span><span class="ident" id="521917">Request</span><span class="op" id="521924">)</span>&nbsp;<span class="op" id="521926">{</span><span class="op" id="521927">}</span><span class="op" id="521928">)</span><span class="op" id="521929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="521932">defer</span>&nbsp;<span class="ident" id="521938">ts</span><span class="op" id="521940">.</span><span class="ident" id="521941">Close</span><span class="op" id="521946">(</span><span class="op" id="521947">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="521951">for</span>&nbsp;<span class="ident" id="521955">_</span><span class="op" id="521956">,</span>&nbsp;<span class="ident" id="521958">version</span>&nbsp;<span class="op" id="521966">:=</span>&nbsp;<span class="keyword" id="521969">range</span>&nbsp;<span class="op" id="521975">[</span><span class="op" id="521976">]</span><span class="builtintype" id="521977">string</span><span class="op" id="521983">{</span><span class="string" id="521984">&#34;HTTP/1.0&#34;</span><span class="op" id="521994">,</span>&nbsp;<span class="string" id="521996">&#34;HTTP/1.1&#34;</span><span class="op" id="522006">}</span>&nbsp;<span class="op" id="522008">{</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="522012">conn</span><span class="op" id="522016">,</span>&nbsp;<span class="ident" id="522018">err</span>&nbsp;<span class="op" id="522022">:=</span>&nbsp;<span class="ident" id="522025">net</span><span class="op" id="522028">.</span><span class="ident" id="522029">Dial</span><span class="op" id="522033">(</span><span class="string" id="522034">&#34;tcp&#34;</span><span class="op" id="522039">,</span>&nbsp;<span class="ident" id="522041">ts</span><span class="op" id="522043">.</span><span class="ident" id="522044">Listener</span><span class="op" id="522052">.</span><span class="ident" id="522053">Addr</span><span class="op" id="522057">(</span><span class="op" id="522058">)</span><span class="op" id="522059">.</span><span class="ident" id="522060">String</span><span class="op" id="522066">(</span><span class="op" id="522067">)</span><span class="op" id="522068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="522072">if</span>&nbsp;<span class="ident" id="522075">err</span>&nbsp;<span class="op" id="522079">!=</span>&nbsp;<span class="builtintype" id="522082">nil</span>&nbsp;<span class="op" id="522086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="522091">t</span><span class="op" id="522092">.</span><span class="ident" id="522093">Fatalf</span><span class="op" id="522099">(</span><span class="string" id="522100">&#34;error&nbsp;dialing:&nbsp;%v&#34;</span><span class="op" id="522119">,</span>&nbsp;<span class="ident" id="522121">err</span><span class="op" id="522124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="522128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="522132">_</span><span class="op" id="522133">,</span>&nbsp;<span class="ident" id="522135">err</span>&nbsp;<span class="op" id="522139">=</span>&nbsp;<span class="ident" id="522141">fmt</span><span class="op" id="522144">.</span><span class="ident" id="522145">Fprintf</span><span class="op" id="522152">(</span><span class="ident" id="522153">conn</span><span class="op" id="522157">,</span>&nbsp;<span class="string" id="522159">&#34;GET&nbsp;/&nbsp;%v\r\nConnection:&nbsp;keep-alive\r\nHost:&nbsp;foo\r\n\r\n&#34;</span><span class="op" id="522216">,</span>&nbsp;<span class="ident" id="522218">version</span><span class="op" id="522225">)</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="522229">if</span>&nbsp;<span class="ident" id="522232">err</span>&nbsp;<span class="op" id="522236">!=</span>&nbsp;<span class="builtintype" id="522239">nil</span>&nbsp;<span class="op" id="522243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="522248">t</span><span class="op" id="522249">.</span><span class="ident" id="522250">Fatalf</span><span class="op" id="522256">(</span><span class="string" id="522257">&#34;error&nbsp;writing:&nbsp;%v&#34;</span><span class="op" id="522276">,</span>&nbsp;<span class="ident" id="522278">err</span><span class="op" id="522281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="522285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="522289">req</span><span class="op" id="522292">,</span>&nbsp;<span class="ident" id="522294">_</span>&nbsp;<span class="op" id="522296">:=</span>&nbsp;<span class="ident" id="522299">NewRequest</span><span class="op" id="522309">(</span><span class="string" id="522310">&#34;GET&#34;</span><span class="op" id="522315">,</span>&nbsp;<span class="string" id="522317">&#34;/&#34;</span><span class="op" id="522320">,</span>&nbsp;<span class="builtintype" id="522322">nil</span><span class="op" id="522325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="522329">res</span><span class="op" id="522332">,</span>&nbsp;<span class="ident" id="522334">err</span>&nbsp;<span class="op" id="522338">:=</span>&nbsp;<span class="ident" id="522341">ReadResponse</span><span class="op" id="522353">(</span><span class="ident" id="522354">bufio</span><span class="op" id="522359">.</span><span class="ident" id="522360">NewReader</span><span class="op" id="522369">(</span><span class="ident" id="522370">conn</span><span class="op" id="522374">)</span><span class="op" id="522375">,</span>&nbsp;<span class="ident" id="522377">req</span><span class="op" id="522380">)</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="522384">if</span>&nbsp;<span class="ident" id="522387">err</span>&nbsp;<span class="op" id="522391">!=</span>&nbsp;<span class="builtintype" id="522394">nil</span>&nbsp;<span class="op" id="522398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="522403">t</span><span class="op" id="522404">.</span><span class="ident" id="522405">Fatalf</span><span class="op" id="522411">(</span><span class="string" id="522412">&#34;error&nbsp;reading&nbsp;response:&nbsp;%v&#34;</span><span class="op" id="522440">,</span>&nbsp;<span class="ident" id="522442">err</span><span class="op" id="522445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="522449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="522453">if</span>&nbsp;<span class="ident" id="522456">te</span>&nbsp;<span class="op" id="522459">:=</span>&nbsp;<span class="ident" id="522462">res</span><span class="op" id="522465">.</span><span class="ident" id="522466">TransferEncoding</span><span class="op" id="522482">;</span>&nbsp;<span class="builtinfunc" id="522484">len</span><span class="op" id="522487">(</span><span class="ident" id="522488">te</span><span class="op" id="522490">)</span>&nbsp;<span class="op" id="522492">&gt;</span>&nbsp;<span class="num" id="522494">0</span>&nbsp;<span class="op" id="522496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="522501">t</span><span class="op" id="522502">.</span><span class="ident" id="522503">Errorf</span><span class="op" id="522509">(</span><span class="string" id="522510">&#34;For&nbsp;version&nbsp;%q,&nbsp;Transfer-Encoding&nbsp;=&nbsp;%q;&nbsp;want&nbsp;none&#34;</span><span class="op" id="522561">,</span>&nbsp;<span class="ident" id="522563">version</span><span class="op" id="522570">,</span>&nbsp;<span class="ident" id="522572">te</span><span class="op" id="522574">)</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="522578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="522582">if</span>&nbsp;<span class="ident" id="522585">cl</span>&nbsp;<span class="op" id="522588">:=</span>&nbsp;<span class="ident" id="522591">res</span><span class="op" id="522594">.</span><span class="ident" id="522595">ContentLength</span><span class="op" id="522608">;</span>&nbsp;<span class="ident" id="522610">cl</span>&nbsp;<span class="op" id="522613">!=</span>&nbsp;<span class="num" id="522616">0</span>&nbsp;<span class="op" id="522618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="522623">t</span><span class="op" id="522624">.</span><span class="ident" id="522625">Errorf</span><span class="op" id="522631">(</span><span class="string" id="522632">&#34;For&nbsp;version&nbsp;%q,&nbsp;Content-Length&nbsp;=&nbsp;%v;&nbsp;want&nbsp;0&#34;</span><span class="op" id="522677">,</span>&nbsp;<span class="ident" id="522679">version</span><span class="op" id="522686">,</span>&nbsp;<span class="ident" id="522688">cl</span><span class="op" id="522690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="522694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="522698">conn</span><span class="op" id="522702">.</span><span class="ident" id="522703">Close</span><span class="op" id="522708">(</span><span class="op" id="522709">)</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="522712">}</span><br>
<span class="lineno"></span><span class="op" id="522714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="522717">func</span>&nbsp;<span class="ident" id="522722">TestCloseNotifier</span><span class="op" id="522739">(</span><span class="ident" id="522740">t</span>&nbsp;<span class="op" id="522742">*</span><span class="ident" id="522743">testing</span><span class="op" id="522750">.</span><span class="ident" id="522751">T</span><span class="op" id="522752">)</span>&nbsp;<span class="op" id="522754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="522757">defer</span>&nbsp;<span class="ident" id="522763">afterTest</span><span class="op" id="522772">(</span><span class="ident" id="522773">t</span><span class="op" id="522774">)</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="522777">gotReq</span>&nbsp;<span class="op" id="522784">:=</span>&nbsp;<span class="builtinfunc" id="522787">make</span><span class="op" id="522791">(</span><span class="keyword" id="522792">chan</span>&nbsp;<span class="builtintype" id="522797">bool</span><span class="op" id="522801">,</span>&nbsp;<span class="num" id="522803">1</span><span class="op" id="522804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="522807">sawClose</span>&nbsp;<span class="op" id="522816">:=</span>&nbsp;<span class="builtinfunc" id="522819">make</span><span class="op" id="522823">(</span><span class="keyword" id="522824">chan</span>&nbsp;<span class="builtintype" id="522829">bool</span><span class="op" id="522833">,</span>&nbsp;<span class="num" id="522835">1</span><span class="op" id="522836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="522839">ts</span>&nbsp;<span class="op" id="522842">:=</span>&nbsp;<span class="ident" id="522845">httptest</span><span class="op" id="522853">.</span><span class="ident" id="522854">NewServer</span><span class="op" id="522863">(</span><span class="ident" id="522864">HandlerFunc</span><span class="op" id="522875">(</span><span class="keyword" id="522876">func</span><span class="op" id="522880">(</span><span class="ident" id="522881">rw</span>&nbsp;<span class="ident" id="522884">ResponseWriter</span><span class="op" id="522898">,</span>&nbsp;<span class="ident" id="522900">req</span>&nbsp;<span class="op" id="522904">*</span><span class="ident" id="522905">Request</span><span class="op" id="522912">)</span>&nbsp;<span class="op" id="522914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="522918">gotReq</span>&nbsp;<span class="op" id="522925">&lt;-</span>&nbsp;<span class="builtintype" id="522928">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="522935">cc</span>&nbsp;<span class="op" id="522938">:=</span>&nbsp;<span class="ident" id="522941">rw</span><span class="op" id="522943">.</span><span class="op" id="522944">(</span><span class="ident" id="522945">CloseNotifier</span><span class="op" id="522958">)</span><span class="op" id="522959">.</span><span class="ident" id="522960">CloseNotify</span><span class="op" id="522971">(</span><span class="op" id="522972">)</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="522976">&lt;-</span><span class="ident" id="522978">cc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="522983">sawClose</span>&nbsp;<span class="op" id="522992">&lt;-</span>&nbsp;<span class="builtintype" id="522995">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="523001">}</span><span class="op" id="523002">)</span><span class="op" id="523003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="523006">conn</span><span class="op" id="523010">,</span>&nbsp;<span class="ident" id="523012">err</span>&nbsp;<span class="op" id="523016">:=</span>&nbsp;<span class="ident" id="523019">net</span><span class="op" id="523022">.</span><span class="ident" id="523023">Dial</span><span class="op" id="523027">(</span><span class="string" id="523028">&#34;tcp&#34;</span><span class="op" id="523033">,</span>&nbsp;<span class="ident" id="523035">ts</span><span class="op" id="523037">.</span><span class="ident" id="523038">Listener</span><span class="op" id="523046">.</span><span class="ident" id="523047">Addr</span><span class="op" id="523051">(</span><span class="op" id="523052">)</span><span class="op" id="523053">.</span><span class="ident" id="523054">String</span><span class="op" id="523060">(</span><span class="op" id="523061">)</span><span class="op" id="523062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="523065">if</span>&nbsp;<span class="ident" id="523068">err</span>&nbsp;<span class="op" id="523072">!=</span>&nbsp;<span class="builtintype" id="523075">nil</span>&nbsp;<span class="op" id="523079">{</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="523083">t</span><span class="op" id="523084">.</span><span class="ident" id="523085">Fatalf</span><span class="op" id="523091">(</span><span class="string" id="523092">&#34;error&nbsp;dialing:&nbsp;%v&#34;</span><span class="op" id="523111">,</span>&nbsp;<span class="ident" id="523113">err</span><span class="op" id="523116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="523119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="523122">diec</span>&nbsp;<span class="op" id="523127">:=</span>&nbsp;<span class="builtinfunc" id="523130">make</span><span class="op" id="523134">(</span><span class="keyword" id="523135">chan</span>&nbsp;<span class="builtintype" id="523140">bool</span><span class="op" id="523144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="523147">go</span>&nbsp;<span class="keyword" id="523150">func</span><span class="op" id="523154">(</span><span class="op" id="523155">)</span>&nbsp;<span class="op" id="523157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="523161">_</span><span class="op" id="523162">,</span>&nbsp;<span class="ident" id="523164">err</span>&nbsp;<span class="op" id="523168">=</span>&nbsp;<span class="ident" id="523170">fmt</span><span class="op" id="523173">.</span><span class="ident" id="523174">Fprintf</span><span class="op" id="523181">(</span><span class="ident" id="523182">conn</span><span class="op" id="523186">,</span>&nbsp;<span class="string" id="523188">&#34;GET&nbsp;/&nbsp;HTTP/1.1\r\nConnection:&nbsp;keep-alive\r\nHost:&nbsp;foo\r\n\r\n&#34;</span><span class="op" id="523251">)</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="523255">if</span>&nbsp;<span class="ident" id="523258">err</span>&nbsp;<span class="op" id="523262">!=</span>&nbsp;<span class="builtintype" id="523265">nil</span>&nbsp;<span class="op" id="523269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="523274">t</span><span class="op" id="523275">.</span><span class="ident" id="523276">Fatal</span><span class="op" id="523281">(</span><span class="ident" id="523282">err</span><span class="op" id="523285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="523289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="523293">&lt;-</span><span class="ident" id="523295">diec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="523302">conn</span><span class="op" id="523306">.</span><span class="ident" id="523307">Close</span><span class="op" id="523312">(</span><span class="op" id="523313">)</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="523316">}</span><span class="op" id="523317">(</span><span class="op" id="523318">)</span><br>
<span class="lineno"></span><span class="ident" id="523320">For</span><span class="op" id="523323">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="523326">for</span>&nbsp;<span class="op" id="523330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="523334">select</span>&nbsp;<span class="op" id="523341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="523345">case</span>&nbsp;<span class="op" id="523350">&lt;-</span><span class="ident" id="523352">gotReq</span><span class="op" id="523358">:</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="523363">diec</span>&nbsp;<span class="op" id="523368">&lt;-</span>&nbsp;<span class="builtintype" id="523371">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="523378">case</span>&nbsp;<span class="op" id="523383">&lt;-</span><span class="ident" id="523385">sawClose</span><span class="op" id="523393">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="523398">break</span>&nbsp;<span class="ident" id="523404">For</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="523410">case</span>&nbsp;<span class="op" id="523415">&lt;-</span><span class="ident" id="523417">time</span><span class="op" id="523421">.</span><span class="ident" id="523422">After</span><span class="op" id="523427">(</span><span class="num" id="523428">5</span>&nbsp;<span class="op" id="523430">*</span>&nbsp;<span class="ident" id="523432">time</span><span class="op" id="523436">.</span><span class="ident" id="523437">Second</span><span class="op" id="523443">)</span><span class="op" id="523444">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="523449">t</span><span class="op" id="523450">.</span><span class="ident" id="523451">Fatal</span><span class="op" id="523456">(</span><span class="string" id="523457">&#34;timeout&#34;</span><span class="op" id="523466">)</span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="523470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="523473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="523476">ts</span><span class="op" id="523478">.</span><span class="ident" id="523479">Close</span><span class="op" id="523484">(</span><span class="op" id="523485">)</span><br>
<span class="lineno"></span><span class="op" id="523487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1765</span><span class="keyword" id="523490">func</span>&nbsp;<span class="ident" id="523495">TestCloseNotifierChanLeak</span><span class="op" id="523520">(</span><span class="ident" id="523521">t</span>&nbsp;<span class="op" id="523523">*</span><span class="ident" id="523524">testing</span><span class="op" id="523531">.</span><span class="ident" id="523532">T</span><span class="op" id="523533">)</span>&nbsp;<span class="op" id="523535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="523538">defer</span>&nbsp;<span class="ident" id="523544">afterTest</span><span class="op" id="523553">(</span><span class="ident" id="523554">t</span><span class="op" id="523555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="523558">req</span>&nbsp;<span class="op" id="523562">:=</span>&nbsp;<span class="ident" id="523565">reqBytes</span><span class="op" id="523573">(</span><span class="string" id="523574">&#34;GET&nbsp;/&nbsp;HTTP/1.0\nHost:&nbsp;golang.org&#34;</span><span class="op" id="523608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="523611">for</span>&nbsp;<span class="ident" id="523615">i</span>&nbsp;<span class="op" id="523617">:=</span>&nbsp;<span class="num" id="523620">0</span><span class="op" id="523621">;</span>&nbsp;<span class="ident" id="523623">i</span>&nbsp;<span class="op" id="523625">&lt;</span>&nbsp;<span class="num" id="523627">20</span><span class="op" id="523629">;</span>&nbsp;<span class="ident" id="523631">i</span><span class="op" id="523632">++</span>&nbsp;<span class="op" id="523635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="523639">var</span>&nbsp;<span class="ident" id="523643">output</span>&nbsp;<span class="ident" id="523650">bytes</span><span class="op" id="523655">.</span><span class="ident" id="523656">Buffer</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="523665">conn</span>&nbsp;<span class="op" id="523670">:=</span>&nbsp;<span class="op" id="523673">&amp;</span><span class="ident" id="523674">rwTestConn</span><span class="op" id="523684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="523689">Reader</span><span class="op" id="523695">:</span>&nbsp;<span class="ident" id="523697">bytes</span><span class="op" id="523702">.</span><span class="ident" id="523703">NewReader</span><span class="op" id="523712">(</span><span class="ident" id="523713">req</span><span class="op" id="523716">)</span><span class="op" id="523717">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="523722">Writer</span><span class="op" id="523728">:</span>&nbsp;<span class="op" id="523730">&amp;</span><span class="ident" id="523731">output</span><span class="op" id="523737">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="523742">closec</span><span class="op" id="523748">:</span>&nbsp;<span class="builtinfunc" id="523750">make</span><span class="op" id="523754">(</span><span class="keyword" id="523755">chan</span>&nbsp;<span class="builtintype" id="523760">bool</span><span class="op" id="523764">,</span>&nbsp;<span class="num" id="523766">1</span><span class="op" id="523767">)</span><span class="op" id="523768">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="523772">}</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="523776">ln</span>&nbsp;<span class="op" id="523779">:=</span>&nbsp;<span class="op" id="523782">&amp;</span><span class="ident" id="523783">oneConnListener</span><span class="op" id="523798">{</span><span class="ident" id="523799">conn</span><span class="op" id="523803">:</span>&nbsp;<span class="ident" id="523805">conn</span><span class="op" id="523809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="523813">handler</span>&nbsp;<span class="op" id="523821">:=</span>&nbsp;<span class="ident" id="523824">HandlerFunc</span><span class="op" id="523835">(</span><span class="keyword" id="523836">func</span><span class="op" id="523840">(</span><span class="ident" id="523841">rw</span>&nbsp;<span class="ident" id="523844">ResponseWriter</span><span class="op" id="523858">,</span>&nbsp;<span class="ident" id="523860">r</span>&nbsp;<span class="op" id="523862">*</span><span class="ident" id="523863">Request</span><span class="op" id="523870">)</span>&nbsp;<span class="op" id="523872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="523877">//&nbsp;Ignore&nbsp;the&nbsp;return&nbsp;value&nbsp;and&nbsp;never&nbsp;read&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="523927">//&nbsp;it,&nbsp;testing&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;leak&nbsp;goroutines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="523975">//&nbsp;on&nbsp;the&nbsp;sending&nbsp;side:</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524002">_</span>&nbsp;<span class="op" id="524004">=</span>&nbsp;<span class="ident" id="524006">rw</span><span class="op" id="524008">.</span><span class="op" id="524009">(</span><span class="ident" id="524010">CloseNotifier</span><span class="op" id="524023">)</span><span class="op" id="524024">.</span><span class="ident" id="524025">CloseNotify</span><span class="op" id="524036">(</span><span class="op" id="524037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="524041">}</span><span class="op" id="524042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="524046">go</span>&nbsp;<span class="ident" id="524049">Serve</span><span class="op" id="524054">(</span><span class="ident" id="524055">ln</span><span class="op" id="524057">,</span>&nbsp;<span class="ident" id="524059">handler</span><span class="op" id="524066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="524070">&lt;-</span><span class="ident" id="524072">conn</span><span class="op" id="524076">.</span><span class="ident" id="524077">closec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="524085">}</span><br>
<span class="lineno">1785</span><span class="op" id="524087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="524090">func</span>&nbsp;<span class="ident" id="524095">TestOptions</span><span class="op" id="524106">(</span><span class="ident" id="524107">t</span>&nbsp;<span class="op" id="524109">*</span><span class="ident" id="524110">testing</span><span class="op" id="524117">.</span><span class="ident" id="524118">T</span><span class="op" id="524119">)</span>&nbsp;<span class="op" id="524121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524124">uric</span>&nbsp;<span class="op" id="524129">:=</span>&nbsp;<span class="builtinfunc" id="524132">make</span><span class="op" id="524136">(</span><span class="keyword" id="524137">chan</span>&nbsp;<span class="builtintype" id="524142">string</span><span class="op" id="524148">,</span>&nbsp;<span class="num" id="524150">2</span><span class="op" id="524151">)</span>&nbsp;<span class="comment" id="524153">//&nbsp;only&nbsp;expect&nbsp;1,&nbsp;but&nbsp;leave&nbsp;space&nbsp;for&nbsp;2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524194">mux</span>&nbsp;<span class="op" id="524198">:=</span>&nbsp;<span class="ident" id="524201">NewServeMux</span><span class="op" id="524212">(</span><span class="op" id="524213">)</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524216">mux</span><span class="op" id="524219">.</span><span class="ident" id="524220">HandleFunc</span><span class="op" id="524230">(</span><span class="string" id="524231">&#34;/&#34;</span><span class="op" id="524234">,</span>&nbsp;<span class="keyword" id="524236">func</span><span class="op" id="524240">(</span><span class="ident" id="524241">w</span>&nbsp;<span class="ident" id="524243">ResponseWriter</span><span class="op" id="524257">,</span>&nbsp;<span class="ident" id="524259">r</span>&nbsp;<span class="op" id="524261">*</span><span class="ident" id="524262">Request</span><span class="op" id="524269">)</span>&nbsp;<span class="op" id="524271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524275">uric</span>&nbsp;<span class="op" id="524280">&lt;-</span>&nbsp;<span class="ident" id="524283">r</span><span class="op" id="524284">.</span><span class="ident" id="524285">RequestURI</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="524297">}</span><span class="op" id="524298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524301">ts</span>&nbsp;<span class="op" id="524304">:=</span>&nbsp;<span class="ident" id="524307">httptest</span><span class="op" id="524315">.</span><span class="ident" id="524316">NewServer</span><span class="op" id="524325">(</span><span class="ident" id="524326">mux</span><span class="op" id="524329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="524332">defer</span>&nbsp;<span class="ident" id="524338">ts</span><span class="op" id="524340">.</span><span class="ident" id="524341">Close</span><span class="op" id="524346">(</span><span class="op" id="524347">)</span><br>
<span class="lineno">1795</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524351">conn</span><span class="op" id="524355">,</span>&nbsp;<span class="ident" id="524357">err</span>&nbsp;<span class="op" id="524361">:=</span>&nbsp;<span class="ident" id="524364">net</span><span class="op" id="524367">.</span><span class="ident" id="524368">Dial</span><span class="op" id="524372">(</span><span class="string" id="524373">&#34;tcp&#34;</span><span class="op" id="524378">,</span>&nbsp;<span class="ident" id="524380">ts</span><span class="op" id="524382">.</span><span class="ident" id="524383">Listener</span><span class="op" id="524391">.</span><span class="ident" id="524392">Addr</span><span class="op" id="524396">(</span><span class="op" id="524397">)</span><span class="op" id="524398">.</span><span class="ident" id="524399">String</span><span class="op" id="524405">(</span><span class="op" id="524406">)</span><span class="op" id="524407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="524410">if</span>&nbsp;<span class="ident" id="524413">err</span>&nbsp;<span class="op" id="524417">!=</span>&nbsp;<span class="builtintype" id="524420">nil</span>&nbsp;<span class="op" id="524424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524428">t</span><span class="op" id="524429">.</span><span class="ident" id="524430">Fatal</span><span class="op" id="524435">(</span><span class="ident" id="524436">err</span><span class="op" id="524439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="524442">}</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="524445">defer</span>&nbsp;<span class="ident" id="524451">conn</span><span class="op" id="524455">.</span><span class="ident" id="524456">Close</span><span class="op" id="524461">(</span><span class="op" id="524462">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="524466">//&nbsp;An&nbsp;OPTIONS&nbsp;*&nbsp;request&nbsp;should&nbsp;succeed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524507">_</span><span class="op" id="524508">,</span>&nbsp;<span class="ident" id="524510">err</span>&nbsp;<span class="op" id="524514">=</span>&nbsp;<span class="ident" id="524516">conn</span><span class="op" id="524520">.</span><span class="ident" id="524521">Write</span><span class="op" id="524526">(</span><span class="op" id="524527">[</span><span class="op" id="524528">]</span><span class="builtintype" id="524529">byte</span><span class="op" id="524533">(</span><span class="string" id="524534">&#34;OPTIONS&nbsp;*&nbsp;HTTP/1.1\r\nHost:&nbsp;foo.com\r\n\r\n&#34;</span><span class="op" id="524579">)</span><span class="op" id="524580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="524583">if</span>&nbsp;<span class="ident" id="524586">err</span>&nbsp;<span class="op" id="524590">!=</span>&nbsp;<span class="builtintype" id="524593">nil</span>&nbsp;<span class="op" id="524597">{</span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524601">t</span><span class="op" id="524602">.</span><span class="ident" id="524603">Fatal</span><span class="op" id="524608">(</span><span class="ident" id="524609">err</span><span class="op" id="524612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="524615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524618">br</span>&nbsp;<span class="op" id="524621">:=</span>&nbsp;<span class="ident" id="524624">bufio</span><span class="op" id="524629">.</span><span class="ident" id="524630">NewReader</span><span class="op" id="524639">(</span><span class="ident" id="524640">conn</span><span class="op" id="524644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524647">res</span><span class="op" id="524650">,</span>&nbsp;<span class="ident" id="524652">err</span>&nbsp;<span class="op" id="524656">:=</span>&nbsp;<span class="ident" id="524659">ReadResponse</span><span class="op" id="524671">(</span><span class="ident" id="524672">br</span><span class="op" id="524674">,</span>&nbsp;<span class="op" id="524676">&amp;</span><span class="ident" id="524677">Request</span><span class="op" id="524684">{</span><span class="ident" id="524685">Method</span><span class="op" id="524691">:</span>&nbsp;<span class="string" id="524693">&#34;OPTIONS&#34;</span><span class="op" id="524702">}</span><span class="op" id="524703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="524706">if</span>&nbsp;<span class="ident" id="524709">err</span>&nbsp;<span class="op" id="524713">!=</span>&nbsp;<span class="builtintype" id="524716">nil</span>&nbsp;<span class="op" id="524720">{</span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524724">t</span><span class="op" id="524725">.</span><span class="ident" id="524726">Fatal</span><span class="op" id="524731">(</span><span class="ident" id="524732">err</span><span class="op" id="524735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="524738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="524741">if</span>&nbsp;<span class="ident" id="524744">res</span><span class="op" id="524747">.</span><span class="ident" id="524748">StatusCode</span>&nbsp;<span class="op" id="524759">!=</span>&nbsp;<span class="num" id="524762">200</span>&nbsp;<span class="op" id="524766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524770">t</span><span class="op" id="524771">.</span><span class="ident" id="524772">Errorf</span><span class="op" id="524778">(</span><span class="string" id="524779">&#34;Got&nbsp;non-200&nbsp;response&nbsp;to&nbsp;OPTIONS&nbsp;*:&nbsp;%#v&#34;</span><span class="op" id="524819">,</span>&nbsp;<span class="ident" id="524821">res</span><span class="op" id="524824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="524827">}</span><br>
<span class="lineno">1815</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="524831">//&nbsp;A&nbsp;GET&nbsp;*&nbsp;request&nbsp;on&nbsp;a&nbsp;ServeMux&nbsp;should&nbsp;fail.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524878">_</span><span class="op" id="524879">,</span>&nbsp;<span class="ident" id="524881">err</span>&nbsp;<span class="op" id="524885">=</span>&nbsp;<span class="ident" id="524887">conn</span><span class="op" id="524891">.</span><span class="ident" id="524892">Write</span><span class="op" id="524897">(</span><span class="op" id="524898">[</span><span class="op" id="524899">]</span><span class="builtintype" id="524900">byte</span><span class="op" id="524904">(</span><span class="string" id="524905">&#34;GET&nbsp;*&nbsp;HTTP/1.1\r\nHost:&nbsp;foo.com\r\n\r\n&#34;</span><span class="op" id="524946">)</span><span class="op" id="524947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="524950">if</span>&nbsp;<span class="ident" id="524953">err</span>&nbsp;<span class="op" id="524957">!=</span>&nbsp;<span class="builtintype" id="524960">nil</span>&nbsp;<span class="op" id="524964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524968">t</span><span class="op" id="524969">.</span><span class="ident" id="524970">Fatal</span><span class="op" id="524975">(</span><span class="ident" id="524976">err</span><span class="op" id="524979">)</span><br>
<span class="lineno">1820</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="524982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="524985">res</span><span class="op" id="524988">,</span>&nbsp;<span class="ident" id="524990">err</span>&nbsp;<span class="op" id="524994">=</span>&nbsp;<span class="ident" id="524996">ReadResponse</span><span class="op" id="525008">(</span><span class="ident" id="525009">br</span><span class="op" id="525011">,</span>&nbsp;<span class="op" id="525013">&amp;</span><span class="ident" id="525014">Request</span><span class="op" id="525021">{</span><span class="ident" id="525022">Method</span><span class="op" id="525028">:</span>&nbsp;<span class="string" id="525030">&#34;GET&#34;</span><span class="op" id="525035">}</span><span class="op" id="525036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="525039">if</span>&nbsp;<span class="ident" id="525042">err</span>&nbsp;<span class="op" id="525046">!=</span>&nbsp;<span class="builtintype" id="525049">nil</span>&nbsp;<span class="op" id="525053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="525057">t</span><span class="op" id="525058">.</span><span class="ident" id="525059">Fatal</span><span class="op" id="525064">(</span><span class="ident" id="525065">err</span><span class="op" id="525068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="525071">}</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="525074">if</span>&nbsp;<span class="ident" id="525077">res</span><span class="op" id="525080">.</span><span class="ident" id="525081">StatusCode</span>&nbsp;<span class="op" id="525092">!=</span>&nbsp;<span class="num" id="525095">400</span>&nbsp;<span class="op" id="525099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="525103">t</span><span class="op" id="525104">.</span><span class="ident" id="525105">Errorf</span><span class="op" id="525111">(</span><span class="string" id="525112">&#34;Got&nbsp;non-400&nbsp;response&nbsp;to&nbsp;GET&nbsp;*:&nbsp;%#v&#34;</span><span class="op" id="525148">,</span>&nbsp;<span class="ident" id="525150">res</span><span class="op" id="525153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="525156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="525160">res</span><span class="op" id="525163">,</span>&nbsp;<span class="ident" id="525165">err</span>&nbsp;<span class="op" id="525169">=</span>&nbsp;<span class="ident" id="525171">Get</span><span class="op" id="525174">(</span><span class="ident" id="525175">ts</span><span class="op" id="525177">.</span><span class="ident" id="525178">URL</span>&nbsp;<span class="op" id="525182">+</span>&nbsp;<span class="string" id="525184">&#34;/second&#34;</span><span class="op" id="525193">)</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="525196">if</span>&nbsp;<span class="ident" id="525199">err</span>&nbsp;<span class="op" id="525203">!=</span>&nbsp;<span class="builtintype" id="525206">nil</span>&nbsp;<span class="op" id="525210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="525214">t</span><span class="op" id="525215">.</span><span class="ident" id="525216">Fatal</span><span class="op" id="525221">(</span><span class="ident" id="525222">err</span><span class="op" id="525225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="525228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="525231">res</span><span class="op" id="525234">.</span><span class="ident" id="525235">Body</span><span class="op" id="525239">.</span><span class="ident" id="525240">Close</span><span class="op" id="525245">(</span><span class="op" id="525246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="525249">if</span>&nbsp;<span class="ident" id="525252">got</span>&nbsp;<span class="op" id="525256">:=</span>&nbsp;<span class="op" id="525259">&lt;-</span><span class="ident" id="525261">uric</span><span class="op" id="525265">;</span>&nbsp;<span class="ident" id="525267">got</span>&nbsp;<span class="op" id="525271">!=</span>&nbsp;<span class="string" id="525274">&#34;/second&#34;</span>&nbsp;<span class="op" id="525284">{</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="525288">t</span><span class="op" id="525289">.</span><span class="ident" id="525290">Errorf</span><span class="op" id="525296">(</span><span class="string" id="525297">&#34;Handler&nbsp;saw&nbsp;request&nbsp;for&nbsp;%q;&nbsp;want&nbsp;/second&#34;</span><span class="op" id="525339">,</span>&nbsp;<span class="ident" id="525341">got</span><span class="op" id="525344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="525347">}</span><br>
<span class="lineno"></span><span class="op" id="525349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="525352">//&nbsp;Tests&nbsp;regarding&nbsp;the&nbsp;ordering&nbsp;of&nbsp;Write,&nbsp;WriteHeader,&nbsp;Header,&nbsp;and</span><br>
<span class="lineno">1840</span><span class="comment" id="525419">//&nbsp;Flush&nbsp;calls.&nbsp;&nbsp;In&nbsp;Go&nbsp;1.0,&nbsp;rw.WriteHeader&nbsp;immediately&nbsp;flushed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="525486">//&nbsp;(*response).header&nbsp;to&nbsp;the&nbsp;wire.&nbsp;In&nbsp;Go&nbsp;1.1,&nbsp;the&nbsp;actual&nbsp;wire&nbsp;flush&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="525557">//&nbsp;delayed,&nbsp;so&nbsp;we&nbsp;could&nbsp;maybe&nbsp;tack&nbsp;on&nbsp;a&nbsp;Content-Length&nbsp;and&nbsp;better</span><br>
<span class="lineno"></span><span class="comment" id="525623">//&nbsp;Content-Type&nbsp;after&nbsp;we&nbsp;see&nbsp;more&nbsp;(or&nbsp;all)&nbsp;of&nbsp;the&nbsp;output.&nbsp;To&nbsp;preserve</span><br>
<span class="lineno"></span><span class="comment" id="525693">//&nbsp;compatibility&nbsp;with&nbsp;Go&nbsp;1,&nbsp;we&nbsp;need&nbsp;to&nbsp;be&nbsp;careful&nbsp;to&nbsp;track&nbsp;which</span><br>
<span class="lineno">1845</span><span class="comment" id="525758">//&nbsp;headers&nbsp;were&nbsp;live&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;WriteHeader,&nbsp;so&nbsp;we&nbsp;write&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="525828">//&nbsp;ones,&nbsp;even&nbsp;if&nbsp;the&nbsp;handler&nbsp;modifies&nbsp;them&nbsp;(~erroneously)&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="525896">//&nbsp;first&nbsp;Write.</span><br>
<span class="lineno"></span><span class="keyword" id="525912">func</span>&nbsp;<span class="ident" id="525917">TestHeaderToWire</span><span class="op" id="525933">(</span><span class="ident" id="525934">t</span>&nbsp;<span class="op" id="525936">*</span><span class="ident" id="525937">testing</span><span class="op" id="525944">.</span><span class="ident" id="525945">T</span><span class="op" id="525946">)</span>&nbsp;<span class="op" id="525948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="525951">tests</span>&nbsp;<span class="op" id="525957">:=</span>&nbsp;<span class="op" id="525960">[</span><span class="op" id="525961">]</span><span class="keyword" id="525962">struct</span>&nbsp;<span class="op" id="525969">{</span><br>
<span class="lineno">1850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="525973">name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="525981">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="525990">handler</span>&nbsp;<span class="keyword" id="525998">func</span><span class="op" id="526002">(</span><span class="ident" id="526003">ResponseWriter</span><span class="op" id="526017">,</span>&nbsp;<span class="op" id="526019">*</span><span class="ident" id="526020">Request</span><span class="op" id="526027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="526031">check</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="526039">func</span><span class="op" id="526043">(</span><span class="ident" id="526044">output</span>&nbsp;<span class="builtintype" id="526051">string</span><span class="op" id="526057">)</span>&nbsp;<span class="builtintype" id="526059">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="526066">}</span><span class="op" id="526067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="526071">{</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="526076">name</span><span class="op" id="526080">:</span>&nbsp;<span class="string" id="526082">&#34;write&nbsp;without&nbsp;Header&#34;</span><span class="op" id="526104">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="526109">handler</span><span class="op" id="526116">:</span>&nbsp;<span class="keyword" id="526118">func</span><span class="op" id="526122">(</span><span class="ident" id="526123">rw</span>&nbsp;<span class="ident" id="526126">ResponseWriter</span><span class="op" id="526140">,</span>&nbsp;<span class="ident" id="526142">r</span>&nbsp;<span class="op" id="526144">*</span><span class="ident" id="526145">Request</span><span class="op" id="526152">)</span>&nbsp;<span class="op" id="526154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="526160">rw</span><span class="op" id="526162">.</span><span class="ident" id="526163">Write</span><span class="op" id="526168">(</span><span class="op" id="526169">[</span><span class="op" id="526170">]</span><span class="builtintype" id="526171">byte</span><span class="op" id="526175">(</span><span class="string" id="526176">&#34;hello&nbsp;world&#34;</span><span class="op" id="526189">)</span><span class="op" id="526190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="526195">}</span><span class="op" id="526196">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="526201">check</span><span class="op" id="526206">:</span>&nbsp;<span class="keyword" id="526208">func</span><span class="op" id="526212">(</span><span class="ident" id="526213">got</span>&nbsp;<span class="builtintype" id="526217">string</span><span class="op" id="526223">)</span>&nbsp;<span class="builtintype" id="526225">error</span>&nbsp;<span class="op" id="526231">{</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="526237">if</span>&nbsp;<span class="op" id="526240">!</span><span class="ident" id="526241">strings</span><span class="op" id="526248">.</span><span class="ident" id="526249">Contains</span><span class="op" id="526257">(</span><span class="ident" id="526258">got</span><span class="op" id="526261">,</span>&nbsp;<span class="string" id="526263">&#34;Content-Length:&#34;</span><span class="op" id="526280">)</span>&nbsp;<span class="op" id="526282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="526289">return</span>&nbsp;<span class="ident" id="526296">errors</span><span class="op" id="526302">.</span><span class="ident" id="526303">New</span><span class="op" id="526306">(</span><span class="string" id="526307">&#34;no&nbsp;content-length&#34;</span><span class="op" id="526326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="526332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="526338">if</span>&nbsp;<span class="op" id="526341">!</span><span class="ident" id="526342">strings</span><span class="op" id="526349">.</span><span class="ident" id="526350">Contains</span><span class="op" id="526358">(</span><span class="ident" id="526359">got</span><span class="op" id="526362">,</span>&nbsp;<span class="string" id="526364">&#34;Content-Type:&nbsp;text/plain&#34;</span><span class="op" id="526390">)</span>&nbsp;<span class="op" id="526392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="526399">return</span>&nbsp;<span class="ident" id="526406">errors</span><span class="op" id="526412">.</span><span class="ident" id="526413">New</span><span class="op" id="526416">(</span><span class="string" id="526417">&#34;no&nbsp;content-length&#34;</span><span class="op" id="526436">)</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="526442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="526448">return</span>&nbsp;<span class="builtintype" id="526455">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="526462">}</span><span class="op" id="526463">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="526467">}</span><span class="op" id="526468">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="526472">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="526477">name</span><span class="op" id="526481">:</span>&nbsp;<span class="string" id="526483">&#34;Header&nbsp;mutation&nbsp;before&nbsp;write&#34;</span><span class="op" id="526513">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="526518">handler</span><span class="op" id="526525">:</span>&nbsp;<span class="keyword" id="526527">func</span><span class="op" id="526531">(</span><span class="ident" id="526532">rw</span>&nbsp;<span class="ident" id="526535">ResponseWriter</span><span class="op" id="526549">,</span>&nbsp;<span class="ident" id="526551">r</span>&nbsp;<span class="op" id="526553">*</span><span class="ident" id="526554">Request</span><span class="op" id="526561">)</span>&nbsp;<span class="op" id="526563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="526569">h</span>&nbsp;<span class="op" id="526571">:=</span>&nbsp;<span class="ident" id="526574">rw</span><span class="op" id="526576">.</span><span class="ident" id="526577">Header</span><span class="op" id="526583">(</span><span class="op" id="526584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="526590">h</span><span class="op" id="526591">.</span><span class="ident" id="526592">Set</span><span class="op" id="526595">(</span><span class="string" id="526596">&#34;Content-Type&#34;</span><span class="op" id="526610">,</span>&nbsp;<span class="string" id="526612">&#34;some/type&#34;</span><span class="op" id="526623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="526629">rw</span><span class="op" id="526631">.</span><span class="ident" id="526632">Write</span><span class="op" id="526637">(</span><span class="op" id="526638">[</span><span class="op" id="526639">]</span><span class="builtintype" id="526640">byte</span><span class="op" id="526644">(</span><span class="string" id="526645">&#34;hello&nbsp;world&#34;</span><span class="op" id="526658">)</span><span class="op" id="526659">)</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="526665">h</span><span class="op" id="526666">.</span><span class="ident" id="526667">Set</span><span class="op" id="526670">(</span><span class="string" id="526671">&#34;Too-Late&#34;</span><span class="op" id="526681">,</span>&nbsp;<span class="string" id="526683">&#34;bogus&#34;</span><span class="op" id="526690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="526695">}</span><span class="op" id="526696">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="526701">check</span><span class="op" id="526706">:</span>&nbsp;<span class="keyword" id="526708">func</span><span class="op" id="526712">(</span><span class="ident" id="526713">got</span>&nbsp;<span class="builtintype" id="526717">string</span><span class="op" id="526723">)</span>&nbsp;<span class="builtintype" id="526725">error</span>&nbsp;<span class="op" id="526731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="526737">if</span>&nbsp;<span class="op" id="526740">!</span><span class="ident" id="526741">strings</span><span class="op" id="526748">.</span><span class="ident" id="526749">Contains</span><span class="op" id="526757">(</span><span class="ident" id="526758">got</span><span class="op" id="526761">,</span>&nbsp;<span class="string" id="526763">&#34;Content-Length:&#34;</span><span class="op" id="526780">)</span>&nbsp;<span class="op" id="526782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="526789">return</span>&nbsp;<span class="ident" id="526796">errors</span><span class="op" id="526802">.</span><span class="ident" id="526803">New</span><span class="op" id="526806">(</span><span class="string" id="526807">&#34;no&nbsp;content-length&#34;</span><span class="op" id="526826">)</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="526832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="526838">if</span>&nbsp;<span class="op" id="526841">!</span><span class="ident" id="526842">strings</span><span class="op" id="526849">.</span><span class="ident" id="526850">Contains</span><span class="op" id="526858">(</span><span class="ident" id="526859">got</span><span class="op" id="526862">,</span>&nbsp;<span class="string" id="526864">&#34;Content-Type:&nbsp;some/type&#34;</span><span class="op" id="526889">)</span>&nbsp;<span class="op" id="526891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="526898">return</span>&nbsp;<span class="ident" id="526905">errors</span><span class="op" id="526911">.</span><span class="ident" id="526912">New</span><span class="op" id="526915">(</span><span class="string" id="526916">&#34;wrong&nbsp;content-type&#34;</span><span class="op" id="526936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="526942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="526948">if</span>&nbsp;<span class="ident" id="526951">strings</span><span class="op" id="526958">.</span><span class="ident" id="526959">Contains</span><span class="op" id="526967">(</span><span class="ident" id="526968">got</span><span class="op" id="526971">,</span>&nbsp;<span class="string" id="526973">&#34;Too-Late&#34;</span><span class="op" id="526983">)</span>&nbsp;<span class="op" id="526985">{</span><br>
<span class="lineno">1885</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="526992">return</span>&nbsp;<span class="ident" id="526999">errors</span><span class="op" id="527005">.</span><span class="ident" id="527006">New</span><span class="op" id="527009">(</span><span class="string" id="527010">&#34;don&#39;t&nbsp;want&nbsp;too-late&nbsp;header&#34;</span><span class="op" id="527038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="527044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="527050">return</span>&nbsp;<span class="builtintype" id="527057">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="527064">}</span><span class="op" id="527065">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="527069">}</span><span class="op" id="527070">,</span><br>
<span class="lineno">1890</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="527074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="527079">name</span><span class="op" id="527083">:</span>&nbsp;<span class="string" id="527085">&#34;write&nbsp;then&nbsp;useless&nbsp;Header&nbsp;mutation&#34;</span><span class="op" id="527121">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="527126">handler</span><span class="op" id="527133">:</span>&nbsp;<span class="keyword" id="527135">func</span><span class="op" id="527139">(</span><span class="ident" id="527140">rw</span>&nbsp;<span class="ident" id="527143">ResponseWriter</span><span class="op" id="527157">,</span>&nbsp;<span class="ident" id="527159">r</span>&nbsp;<span class="op" id="527161">*</span><span class="ident" id="527162">Request</span><span class="op" id="527169">)</span>&nbsp;<span class="op" id="527171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="527177">rw</span><span class="op" id="527179">.</span><span class="ident" id="527180">Write</span><span class="op" id="527185">(</span><span class="op" id="527186">[</span><span class="op" id="527187">]</span><span class="builtintype" id="527188">byte</span><span class="op" id="527192">(</span><span class="string" id="527193">&#34;hello&nbsp;world&#34;</span><span class="op" id="527206">)</span><span class="op" id="527207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="527213">rw</span><span class="op" id="527215">.</span><span class="ident" id="527216">Header</span><span class="op" id="527222">(</span><span class="op" id="527223">)</span><span class="op" id="527224">.</span><span class="ident" id="527225">Set</span><span class="op" id="527228">(</span><span class="string" id="527229">&#34;Too-Late&#34;</span><span class="op" id="527239">,</span>&nbsp;<span class="string" id="527241">&#34;Write&nbsp;already&nbsp;wrote&nbsp;headers&#34;</span><span class="op" id="527270">)</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="527275">}</span><span class="op" id="527276">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="527281">check</span><span class="op" id="527286">:</span>&nbsp;<span class="keyword" id="527288">func</span><span class="op" id="527292">(</span><span class="ident" id="527293">got</span>&nbsp;<span class="builtintype" id="527297">string</span><span class="op" id="527303">)</span>&nbsp;<span class="builtintype" id="527305">error</span>&nbsp;<span class="op" id="527311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="527317">if</span>&nbsp;<span class="ident" id="527320">strings</span><span class="op" id="527327">.</span><span class="ident" id="527328">Contains</span><span class="op" id="527336">(</span><span class="ident" id="527337">got</span><span class="op" id="527340">,</span>&nbsp;<span class="string" id="527342">&#34;Too-Late&#34;</span><span class="op" id="527352">)</span>&nbsp;<span class="op" id="527354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="527361">return</span>&nbsp;<span class="ident" id="527368">errors</span><span class="op" id="527374">.</span><span class="ident" id="527375">New</span><span class="op" id="527378">(</span><span class="string" id="527379">&#34;header&nbsp;appeared&nbsp;from&nbsp;after&nbsp;WriteHeader&#34;</span><span class="op" id="527419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="527425">}</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="527431">return</span>&nbsp;<span class="builtintype" id="527438">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="527445">}</span><span class="op" id="527446">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="527450">}</span><span class="op" id="527451">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="527455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="527460">name</span><span class="op" id="527464">:</span>&nbsp;<span class="string" id="527466">&#34;flush&nbsp;then&nbsp;write&#34;</span><span class="op" id="527484">,</span><br>
<span class="lineno">1905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="527489">handler</span><span class="op" id="527496">:</span>&nbsp;<span class="keyword" id="527498">func</span><span class="op" id="527502">(</span><span class="ident" id="527503">rw</span>&nbsp;<span class="ident" id="527506">ResponseWriter</span><span class="op" id="527520">,</span>&nbsp;<span class="ident" id="527522">r</span>&nbsp;<span class="op" id="527524">*</span><span class="ident" id="527525">Request</span><span class="op" id="527532">)</span>&nbsp;<span class="op" id="527534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="527540">rw</span><span class="op" id="527542">.</span><span class="op" id="527543">(</span><span class="ident" id="527544">Flusher</span><span class="op" id="527551">)</span><span class="op" id="527552">.</span><span class="ident" id="527553">Flush</span><span class="op" id="527558">(</span><span class="op" id="527559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="527565">rw</span><span class="op" id="527567">.</span><span class="ident" id="527568">Write</span><span class="op" id="527573">(</span><span class="op" id="527574">[</span><span class="op" id="527575">]</span><span class="builtintype" id="527576">byte</span><span class="op" id="527580">(</span><span class="string" id="527581">&#34;post-flush&#34;</span><span class="op" id="527593">)</span><span class="op" id="527594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="527600">rw</span><span class="op" id="527602">.</span><span class="ident" id="527603">Header</span><span class="op" id="527609">(</span><span class="op" id="527610">)</span><span class="op" id="527611">.</span><span class="ident" id="527612">Set</span><span class="op" id="527615">(</span><span class="string" id="527616">&#34;Too-Late&#34;</span><span class="op" id="527626">,</span>&nbsp;<span class="string" id="527628">&#34;Write&nbsp;already&nbsp;wrote&nbsp;headers&#34;</span><span class="op" id="527657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="527662">}</span><span class="op" id="527663">,</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="527668">check</span><span class="op" id="527673">:</span>&nbsp;<span class="keyword" id="527675">func</span><span class="op" id="527679">(</span><span class="ident" id="527680">got</span>&nbsp;<span class="builtintype" id="527684">string</span><span class="op" id="527690">)</span>&nbsp;<span class="builtintype" id="527692">error</span>&nbsp;<span class="op" id="527698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="527704">if</span>&nbsp;<span class="op" id="527707">!</span><span class="ident" id="527708">strings</span><span class="op" id="527715">.</span><span class="ident" id="527716">Contains</span><span class="op" id="527724">(</span><span class="ident" id="527725">got</span><span class="op" id="527728">,</span>&nbsp;<span class="string" id="527730">&#34;Transfer-Encoding:&nbsp;chunked&#34;</span><span class="op" id="527758">)</span>&nbsp;<span class="op" id="527760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="527767">return</span>&nbsp;<span class="ident" id="527774">errors</span><span class="op" id="527780">.</span><span class="ident" id="527781">New</span><span class="op" id="527784">(</span><span class="string" id="527785">&#34;not&nbsp;chunked&#34;</span><span class="op" id="527798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="527804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="527810">if</span>&nbsp;<span class="ident" id="527813">strings</span><span class="op" id="527820">.</span><span class="ident" id="527821">Contains</span><span class="op" id="527829">(</span><span class="ident" id="527830">got</span><span class="op" id="527833">,</span>&nbsp;<span class="string" id="527835">&#34;Too-Late&#34;</span><span class="op" id="527845">)</span>&nbsp;<span class="op" id="527847">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="527854">return</span>&nbsp;<span class="ident" id="527861">errors</span><span class="op" id="527867">.</span><span class="ident" id="527868">New</span><span class="op" id="527871">(</span><span class="string" id="527872">&#34;header&nbsp;appeared&nbsp;from&nbsp;after&nbsp;WriteHeader&#34;</span><span class="op" id="527912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="527918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="527924">return</span>&nbsp;<span class="builtintype" id="527931">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="527938">}</span><span class="op" id="527939">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="527943">}</span><span class="op" id="527944">,</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="527948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="527953">name</span><span class="op" id="527957">:</span>&nbsp;<span class="string" id="527959">&#34;header&nbsp;then&nbsp;flush&#34;</span><span class="op" id="527978">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="527983">handler</span><span class="op" id="527990">:</span>&nbsp;<span class="keyword" id="527992">func</span><span class="op" id="527996">(</span><span class="ident" id="527997">rw</span>&nbsp;<span class="ident" id="528000">ResponseWriter</span><span class="op" id="528014">,</span>&nbsp;<span class="ident" id="528016">r</span>&nbsp;<span class="op" id="528018">*</span><span class="ident" id="528019">Request</span><span class="op" id="528026">)</span>&nbsp;<span class="op" id="528028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="528034">rw</span><span class="op" id="528036">.</span><span class="ident" id="528037">Header</span><span class="op" id="528043">(</span><span class="op" id="528044">)</span><span class="op" id="528045">.</span><span class="ident" id="528046">Set</span><span class="op" id="528049">(</span><span class="string" id="528050">&#34;Content-Type&#34;</span><span class="op" id="528064">,</span>&nbsp;<span class="string" id="528066">&#34;some/type&#34;</span><span class="op" id="528077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="528083">rw</span><span class="op" id="528085">.</span><span class="op" id="528086">(</span><span class="ident" id="528087">Flusher</span><span class="op" id="528094">)</span><span class="op" id="528095">.</span><span class="ident" id="528096">Flush</span><span class="op" id="528101">(</span><span class="op" id="528102">)</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="528108">rw</span><span class="op" id="528110">.</span><span class="ident" id="528111">Write</span><span class="op" id="528116">(</span><span class="op" id="528117">[</span><span class="op" id="528118">]</span><span class="builtintype" id="528119">byte</span><span class="op" id="528123">(</span><span class="string" id="528124">&#34;post-flush&#34;</span><span class="op" id="528136">)</span><span class="op" id="528137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="528143">rw</span><span class="op" id="528145">.</span><span class="ident" id="528146">Header</span><span class="op" id="528152">(</span><span class="op" id="528153">)</span><span class="op" id="528154">.</span><span class="ident" id="528155">Set</span><span class="op" id="528158">(</span><span class="string" id="528159">&#34;Too-Late&#34;</span><span class="op" id="528169">,</span>&nbsp;<span class="string" id="528171">&#34;Write&nbsp;already&nbsp;wrote&nbsp;headers&#34;</span><span class="op" id="528200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="528205">}</span><span class="op" id="528206">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="528211">check</span><span class="op" id="528216">:</span>&nbsp;<span class="keyword" id="528218">func</span><span class="op" id="528222">(</span><span class="ident" id="528223">got</span>&nbsp;<span class="builtintype" id="528227">string</span><span class="op" id="528233">)</span>&nbsp;<span class="builtintype" id="528235">error</span>&nbsp;<span class="op" id="528241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="528247">if</span>&nbsp;<span class="op" id="528250">!</span><span class="ident" id="528251">strings</span><span class="op" id="528258">.</span><span class="ident" id="528259">Contains</span><span class="op" id="528267">(</span><span class="ident" id="528268">got</span><span class="op" id="528271">,</span>&nbsp;<span class="string" id="528273">&#34;Transfer-Encoding:&nbsp;chunked&#34;</span><span class="op" id="528301">)</span>&nbsp;<span class="op" id="528303">{</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="528310">return</span>&nbsp;<span class="ident" id="528317">errors</span><span class="op" id="528323">.</span><span class="ident" id="528324">New</span><span class="op" id="528327">(</span><span class="string" id="528328">&#34;not&nbsp;chunked&#34;</span><span class="op" id="528341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="528347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="528353">if</span>&nbsp;<span class="ident" id="528356">strings</span><span class="op" id="528363">.</span><span class="ident" id="528364">Contains</span><span class="op" id="528372">(</span><span class="ident" id="528373">got</span><span class="op" id="528376">,</span>&nbsp;<span class="string" id="528378">&#34;Too-Late&#34;</span><span class="op" id="528388">)</span>&nbsp;<span class="op" id="528390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="528397">return</span>&nbsp;<span class="ident" id="528404">errors</span><span class="op" id="528410">.</span><span class="ident" id="528411">New</span><span class="op" id="528414">(</span><span class="string" id="528415">&#34;header&nbsp;appeared&nbsp;from&nbsp;after&nbsp;WriteHeader&#34;</span><span class="op" id="528455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="528461">}</span><br>
<span class="lineno">1935</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="528467">if</span>&nbsp;<span class="op" id="528470">!</span><span class="ident" id="528471">strings</span><span class="op" id="528478">.</span><span class="ident" id="528479">Contains</span><span class="op" id="528487">(</span><span class="ident" id="528488">got</span><span class="op" id="528491">,</span>&nbsp;<span class="string" id="528493">&#34;Content-Type:&nbsp;some/type&#34;</span><span class="op" id="528518">)</span>&nbsp;<span class="op" id="528520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="528527">return</span>&nbsp;<span class="ident" id="528534">errors</span><span class="op" id="528540">.</span><span class="ident" id="528541">New</span><span class="op" id="528544">(</span><span class="string" id="528545">&#34;wrong&nbsp;content-length&#34;</span><span class="op" id="528567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="528573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="528579">return</span>&nbsp;<span class="builtintype" id="528586">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="528593">}</span><span class="op" id="528594">,</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="528598">}</span><span class="op" id="528599">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="528603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="528608">name</span><span class="op" id="528612">:</span>&nbsp;<span class="string" id="528614">&#34;sniff-on-first-write&nbsp;content-type&#34;</span><span class="op" id="528649">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="528654">handler</span><span class="op" id="528661">:</span>&nbsp;<span class="keyword" id="528663">func</span><span class="op" id="528667">(</span><span class="ident" id="528668">rw</span>&nbsp;<span class="ident" id="528671">ResponseWriter</span><span class="op" id="528685">,</span>&nbsp;<span class="ident" id="528687">r</span>&nbsp;<span class="op" id="528689">*</span><span class="ident" id="528690">Request</span><span class="op" id="528697">)</span>&nbsp;<span class="op" id="528699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="528705">rw</span><span class="op" id="528707">.</span><span class="ident" id="528708">Write</span><span class="op" id="528713">(</span><span class="op" id="528714">[</span><span class="op" id="528715">]</span><span class="builtintype" id="528716">byte</span><span class="op" id="528720">(</span><span class="string" id="528721">&#34;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;some&nbsp;html&lt;/body&gt;&lt;/html&gt;&#34;</span><span class="op" id="528771">)</span><span class="op" id="528772">)</span><br>
<span class="lineno">1945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="528778">rw</span><span class="op" id="528780">.</span><span class="ident" id="528781">Header</span><span class="op" id="528787">(</span><span class="op" id="528788">)</span><span class="op" id="528789">.</span><span class="ident" id="528790">Set</span><span class="op" id="528793">(</span><span class="string" id="528794">&#34;Content-Type&#34;</span><span class="op" id="528808">,</span>&nbsp;<span class="string" id="528810">&#34;x/wrong&#34;</span><span class="op" id="528819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="528824">}</span><span class="op" id="528825">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="528830">check</span><span class="op" id="528835">:</span>&nbsp;<span class="keyword" id="528837">func</span><span class="op" id="528841">(</span><span class="ident" id="528842">got</span>&nbsp;<span class="builtintype" id="528846">string</span><span class="op" id="528852">)</span>&nbsp;<span class="builtintype" id="528854">error</span>&nbsp;<span class="op" id="528860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="528866">if</span>&nbsp;<span class="op" id="528869">!</span><span class="ident" id="528870">strings</span><span class="op" id="528877">.</span><span class="ident" id="528878">Contains</span><span class="op" id="528886">(</span><span class="ident" id="528887">got</span><span class="op" id="528890">,</span>&nbsp;<span class="string" id="528892">&#34;Content-Type:&nbsp;text/html&#34;</span><span class="op" id="528917">)</span>&nbsp;<span class="op" id="528919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="528926">return</span>&nbsp;<span class="ident" id="528933">errors</span><span class="op" id="528939">.</span><span class="ident" id="528940">New</span><span class="op" id="528943">(</span><span class="string" id="528944">&#34;wrong&nbsp;content-length;&nbsp;want&nbsp;html&#34;</span><span class="op" id="528977">)</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="528983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="528989">return</span>&nbsp;<span class="builtintype" id="528996">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="529003">}</span><span class="op" id="529004">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="529008">}</span><span class="op" id="529009">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="529013">{</span><br>
<span class="lineno">1955</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="529018">name</span><span class="op" id="529022">:</span>&nbsp;<span class="string" id="529024">&#34;explicit&nbsp;content-type&nbsp;wins&#34;</span><span class="op" id="529052">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="529057">handler</span><span class="op" id="529064">:</span>&nbsp;<span class="keyword" id="529066">func</span><span class="op" id="529070">(</span><span class="ident" id="529071">rw</span>&nbsp;<span class="ident" id="529074">ResponseWriter</span><span class="op" id="529088">,</span>&nbsp;<span class="ident" id="529090">r</span>&nbsp;<span class="op" id="529092">*</span><span class="ident" id="529093">Request</span><span class="op" id="529100">)</span>&nbsp;<span class="op" id="529102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="529108">rw</span><span class="op" id="529110">.</span><span class="ident" id="529111">Header</span><span class="op" id="529117">(</span><span class="op" id="529118">)</span><span class="op" id="529119">.</span><span class="ident" id="529120">Set</span><span class="op" id="529123">(</span><span class="string" id="529124">&#34;Content-Type&#34;</span><span class="op" id="529138">,</span>&nbsp;<span class="string" id="529140">&#34;some/type&#34;</span><span class="op" id="529151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="529157">rw</span><span class="op" id="529159">.</span><span class="ident" id="529160">Write</span><span class="op" id="529165">(</span><span class="op" id="529166">[</span><span class="op" id="529167">]</span><span class="builtintype" id="529168">byte</span><span class="op" id="529172">(</span><span class="string" id="529173">&#34;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;some&nbsp;html&lt;/body&gt;&lt;/html&gt;&#34;</span><span class="op" id="529223">)</span><span class="op" id="529224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="529229">}</span><span class="op" id="529230">,</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="529235">check</span><span class="op" id="529240">:</span>&nbsp;<span class="keyword" id="529242">func</span><span class="op" id="529246">(</span><span class="ident" id="529247">got</span>&nbsp;<span class="builtintype" id="529251">string</span><span class="op" id="529257">)</span>&nbsp;<span class="builtintype" id="529259">error</span>&nbsp;<span class="op" id="529265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="529271">if</span>&nbsp;<span class="op" id="529274">!</span><span class="ident" id="529275">strings</span><span class="op" id="529282">.</span><span class="ident" id="529283">Contains</span><span class="op" id="529291">(</span><span class="ident" id="529292">got</span><span class="op" id="529295">,</span>&nbsp;<span class="string" id="529297">&#34;Content-Type:&nbsp;some/type&#34;</span><span class="op" id="529322">)</span>&nbsp;<span class="op" id="529324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="529331">return</span>&nbsp;<span class="ident" id="529338">errors</span><span class="op" id="529344">.</span><span class="ident" id="529345">New</span><span class="op" id="529348">(</span><span class="string" id="529349">&#34;wrong&nbsp;content-length;&nbsp;want&nbsp;html&#34;</span><span class="op" id="529382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="529388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="529394">return</span>&nbsp;<span class="builtintype" id="529401">nil</span><br>
<span class="lineno">1965</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="529408">}</span><span class="op" id="529409">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="529413">}</span><span class="op" id="529414">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="529418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="529423">name</span><span class="op" id="529427">:</span>&nbsp;<span class="string" id="529429">&#34;empty&nbsp;handler&#34;</span><span class="op" id="529444">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="529449">handler</span><span class="op" id="529456">:</span>&nbsp;<span class="keyword" id="529458">func</span><span class="op" id="529462">(</span><span class="ident" id="529463">rw</span>&nbsp;<span class="ident" id="529466">ResponseWriter</span><span class="op" id="529480">,</span>&nbsp;<span class="ident" id="529482">r</span>&nbsp;<span class="op" id="529484">*</span><span class="ident" id="529485">Request</span><span class="op" id="529492">)</span>&nbsp;<span class="op" id="529494">{</span><br>
<span class="lineno">1970</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="529499">}</span><span class="op" id="529500">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="529505">check</span><span class="op" id="529510">:</span>&nbsp;<span class="keyword" id="529512">func</span><span class="op" id="529516">(</span><span class="ident" id="529517">got</span>&nbsp;<span class="builtintype" id="529521">string</span><span class="op" id="529527">)</span>&nbsp;<span class="builtintype" id="529529">error</span>&nbsp;<span class="op" id="529535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="529541">if</span>&nbsp;<span class="op" id="529544">!</span><span class="ident" id="529545">strings</span><span class="op" id="529552">.</span><span class="ident" id="529553">Contains</span><span class="op" id="529561">(</span><span class="ident" id="529562">got</span><span class="op" id="529565">,</span>&nbsp;<span class="string" id="529567">&#34;Content-Type:&nbsp;text/plain&#34;</span><span class="op" id="529593">)</span>&nbsp;<span class="op" id="529595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="529602">return</span>&nbsp;<span class="ident" id="529609">errors</span><span class="op" id="529615">.</span><span class="ident" id="529616">New</span><span class="op" id="529619">(</span><span class="string" id="529620">&#34;wrong&nbsp;content-length;&nbsp;want&nbsp;text/plain&#34;</span><span class="op" id="529659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="529665">}</span><br>
<span class="lineno">1975</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="529671">if</span>&nbsp;<span class="op" id="529674">!</span><span class="ident" id="529675">strings</span><span class="op" id="529682">.</span><span class="ident" id="529683">Contains</span><span class="op" id="529691">(</span><span class="ident" id="529692">got</span><span class="op" id="529695">,</span>&nbsp;<span class="string" id="529697">&#34;Content-Length:&nbsp;0&#34;</span><span class="op" id="529716">)</span>&nbsp;<span class="op" id="529718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="529725">return</span>&nbsp;<span class="ident" id="529732">errors</span><span class="op" id="529738">.</span><span class="ident" id="529739">New</span><span class="op" id="529742">(</span><span class="string" id="529743">&#34;want&nbsp;0&nbsp;content-length&#34;</span><span class="op" id="529766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="529772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="529778">return</span>&nbsp;<span class="builtintype" id="529785">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="529792">}</span><span class="op" id="529793">,</span><br>
<span class="lineno">1980</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="529797">}</span><span class="op" id="529798">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="529802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="529807">name</span><span class="op" id="529811">:</span>&nbsp;<span class="string" id="529813">&#34;only&nbsp;Header,&nbsp;no&nbsp;write&#34;</span><span class="op" id="529836">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="529841">handler</span><span class="op" id="529848">:</span>&nbsp;<span class="keyword" id="529850">func</span><span class="op" id="529854">(</span><span class="ident" id="529855">rw</span>&nbsp;<span class="ident" id="529858">ResponseWriter</span><span class="op" id="529872">,</span>&nbsp;<span class="ident" id="529874">r</span>&nbsp;<span class="op" id="529876">*</span><span class="ident" id="529877">Request</span><span class="op" id="529884">)</span>&nbsp;<span class="op" id="529886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="529892">rw</span><span class="op" id="529894">.</span><span class="ident" id="529895">Header</span><span class="op" id="529901">(</span><span class="op" id="529902">)</span><span class="op" id="529903">.</span><span class="ident" id="529904">Set</span><span class="op" id="529907">(</span><span class="string" id="529908">&#34;Some-Header&#34;</span><span class="op" id="529921">,</span>&nbsp;<span class="string" id="529923">&#34;some-value&#34;</span><span class="op" id="529935">)</span><br>
<span class="lineno">1985</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="529940">}</span><span class="op" id="529941">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="529946">check</span><span class="op" id="529951">:</span>&nbsp;<span class="keyword" id="529953">func</span><span class="op" id="529957">(</span><span class="ident" id="529958">got</span>&nbsp;<span class="builtintype" id="529962">string</span><span class="op" id="529968">)</span>&nbsp;<span class="builtintype" id="529970">error</span>&nbsp;<span class="op" id="529976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="529982">if</span>&nbsp;<span class="op" id="529985">!</span><span class="ident" id="529986">strings</span><span class="op" id="529993">.</span><span class="ident" id="529994">Contains</span><span class="op" id="530002">(</span><span class="ident" id="530003">got</span><span class="op" id="530006">,</span>&nbsp;<span class="string" id="530008">&#34;Some-Header&#34;</span><span class="op" id="530021">)</span>&nbsp;<span class="op" id="530023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="530030">return</span>&nbsp;<span class="ident" id="530037">errors</span><span class="op" id="530043">.</span><span class="ident" id="530044">New</span><span class="op" id="530047">(</span><span class="string" id="530048">&#34;didn&#39;t&nbsp;get&nbsp;header&#34;</span><span class="op" id="530067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="530073">}</span><br>
<span class="lineno">1990</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="530079">return</span>&nbsp;<span class="builtintype" id="530086">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="530093">}</span><span class="op" id="530094">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="530098">}</span><span class="op" id="530099">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="530103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="530108">name</span><span class="op" id="530112">:</span>&nbsp;<span class="string" id="530114">&#34;WriteHeader&nbsp;call&#34;</span><span class="op" id="530132">,</span><br>
<span class="lineno">1995</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="530137">handler</span><span class="op" id="530144">:</span>&nbsp;<span class="keyword" id="530146">func</span><span class="op" id="530150">(</span><span class="ident" id="530151">rw</span>&nbsp;<span class="ident" id="530154">ResponseWriter</span><span class="op" id="530168">,</span>&nbsp;<span class="ident" id="530170">r</span>&nbsp;<span class="op" id="530172">*</span><span class="ident" id="530173">Request</span><span class="op" id="530180">)</span>&nbsp;<span class="op" id="530182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="530188">rw</span><span class="op" id="530190">.</span><span class="ident" id="530191">WriteHeader</span><span class="op" id="530202">(</span><span class="num" id="530203">404</span><span class="op" id="530206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="530212">rw</span><span class="op" id="530214">.</span><span class="ident" id="530215">Header</span><span class="op" id="530221">(</span><span class="op" id="530222">)</span><span class="op" id="530223">.</span><span class="ident" id="530224">Set</span><span class="op" id="530227">(</span><span class="string" id="530228">&#34;Too-Late&#34;</span><span class="op" id="530238">,</span>&nbsp;<span class="string" id="530240">&#34;some-value&#34;</span><span class="op" id="530252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="530257">}</span><span class="op" id="530258">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="530263">check</span><span class="op" id="530268">:</span>&nbsp;<span class="keyword" id="530270">func</span><span class="op" id="530274">(</span><span class="ident" id="530275">got</span>&nbsp;<span class="builtintype" id="530279">string</span><span class="op" id="530285">)</span>&nbsp;<span class="builtintype" id="530287">error</span>&nbsp;<span class="op" id="530293">{</span><br>
<span class="lineno">2000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="530299">if</span>&nbsp;<span class="op" id="530302">!</span><span class="ident" id="530303">strings</span><span class="op" id="530310">.</span><span class="ident" id="530311">Contains</span><span class="op" id="530319">(</span><span class="ident" id="530320">got</span><span class="op" id="530323">,</span>&nbsp;<span class="string" id="530325">&#34;404&#34;</span><span class="op" id="530330">)</span>&nbsp;<span class="op" id="530332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="530339">return</span>&nbsp;<span class="ident" id="530346">errors</span><span class="op" id="530352">.</span><span class="ident" id="530353">New</span><span class="op" id="530356">(</span><span class="string" id="530357">&#34;wrong&nbsp;status&#34;</span><span class="op" id="530371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="530377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="530383">if</span>&nbsp;<span class="ident" id="530386">strings</span><span class="op" id="530393">.</span><span class="ident" id="530394">Contains</span><span class="op" id="530402">(</span><span class="ident" id="530403">got</span><span class="op" id="530406">,</span>&nbsp;<span class="string" id="530408">&#34;Some-Header&#34;</span><span class="op" id="530421">)</span>&nbsp;<span class="op" id="530423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="530430">return</span>&nbsp;<span class="ident" id="530437">errors</span><span class="op" id="530443">.</span><span class="ident" id="530444">New</span><span class="op" id="530447">(</span><span class="string" id="530448">&#34;shouldn&#39;t&nbsp;have&nbsp;seen&nbsp;Too-Late&#34;</span><span class="op" id="530478">)</span><br>
<span class="lineno">2005</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="530484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="530490">return</span>&nbsp;<span class="builtintype" id="530497">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="530504">}</span><span class="op" id="530505">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="530509">}</span><span class="op" id="530510">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="530513">}</span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="530516">for</span>&nbsp;<span class="ident" id="530520">_</span><span class="op" id="530521">,</span>&nbsp;<span class="ident" id="530523">tc</span>&nbsp;<span class="op" id="530526">:=</span>&nbsp;<span class="keyword" id="530529">range</span>&nbsp;<span class="ident" id="530535">tests</span>&nbsp;<span class="op" id="530541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="530545">ht</span>&nbsp;<span class="op" id="530548">:=</span>&nbsp;<span class="ident" id="530551">newHandlerTest</span><span class="op" id="530565">(</span><span class="ident" id="530566">HandlerFunc</span><span class="op" id="530577">(</span><span class="ident" id="530578">tc</span><span class="op" id="530580">.</span><span class="ident" id="530581">handler</span><span class="op" id="530588">)</span><span class="op" id="530589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="530593">got</span>&nbsp;<span class="op" id="530597">:=</span>&nbsp;<span class="ident" id="530600">ht</span><span class="op" id="530602">.</span><span class="ident" id="530603">rawResponse</span><span class="op" id="530614">(</span><span class="string" id="530615">&#34;GET&nbsp;/&nbsp;HTTP/1.1\nHost:&nbsp;golang.org&#34;</span><span class="op" id="530649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="530653">if</span>&nbsp;<span class="ident" id="530656">err</span>&nbsp;<span class="op" id="530660">:=</span>&nbsp;<span class="ident" id="530663">tc</span><span class="op" id="530665">.</span><span class="ident" id="530666">check</span><span class="op" id="530671">(</span><span class="ident" id="530672">got</span><span class="op" id="530675">)</span><span class="op" id="530676">;</span>&nbsp;<span class="ident" id="530678">err</span>&nbsp;<span class="op" id="530682">!=</span>&nbsp;<span class="builtintype" id="530685">nil</span>&nbsp;<span class="op" id="530689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="530694">t</span><span class="op" id="530695">.</span><span class="ident" id="530696">Errorf</span><span class="op" id="530702">(</span><span class="string" id="530703">&#34;%s:&nbsp;%v\nGot&nbsp;response:\n%s&#34;</span><span class="op" id="530730">,</span>&nbsp;<span class="ident" id="530732">tc</span><span class="op" id="530734">.</span><span class="ident" id="530735">name</span><span class="op" id="530739">,</span>&nbsp;<span class="ident" id="530741">err</span><span class="op" id="530744">,</span>&nbsp;<span class="ident" id="530746">got</span><span class="op" id="530749">)</span><br>
<span class="lineno">2015</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="530753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="530756">}</span><br>
<span class="lineno"></span><span class="op" id="530758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="530761">//&nbsp;goTimeout&nbsp;runs&nbsp;f,&nbsp;failing&nbsp;t&nbsp;if&nbsp;f&nbsp;takes&nbsp;more&nbsp;than&nbsp;ns&nbsp;to&nbsp;complete.</span><br>
<span class="lineno">2020</span><span class="keyword" id="530829">func</span>&nbsp;<span class="ident" id="530834">goTimeout</span><span class="op" id="530843">(</span><span class="ident" id="530844">t</span>&nbsp;<span class="op" id="530846">*</span><span class="ident" id="530847">testing</span><span class="op" id="530854">.</span><span class="ident" id="530855">T</span><span class="op" id="530856">,</span>&nbsp;<span class="ident" id="530858">d</span>&nbsp;<span class="ident" id="530860">time</span><span class="op" id="530864">.</span><span class="ident" id="530865">Duration</span><span class="op" id="530873">,</span>&nbsp;<span class="ident" id="530875">f</span>&nbsp;<span class="keyword" id="530877">func</span><span class="op" id="530881">(</span><span class="op" id="530882">)</span><span class="op" id="530883">)</span>&nbsp;<span class="op" id="530885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="530888">ch</span>&nbsp;<span class="op" id="530891">:=</span>&nbsp;<span class="builtinfunc" id="530894">make</span><span class="op" id="530898">(</span><span class="keyword" id="530899">chan</span>&nbsp;<span class="builtintype" id="530904">bool</span><span class="op" id="530908">,</span>&nbsp;<span class="num" id="530910">2</span><span class="op" id="530911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="530914">timer</span>&nbsp;<span class="op" id="530920">:=</span>&nbsp;<span class="ident" id="530923">time</span><span class="op" id="530927">.</span><span class="ident" id="530928">AfterFunc</span><span class="op" id="530937">(</span><span class="ident" id="530938">d</span><span class="op" id="530939">,</span>&nbsp;<span class="keyword" id="530941">func</span><span class="op" id="530945">(</span><span class="op" id="530946">)</span>&nbsp;<span class="op" id="530948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="530952">t</span><span class="op" id="530953">.</span><span class="ident" id="530954">Errorf</span><span class="op" id="530960">(</span><span class="string" id="530961">&#34;Timeout&nbsp;expired&nbsp;after&nbsp;%v&#34;</span><span class="op" id="530987">,</span>&nbsp;<span class="ident" id="530989">d</span><span class="op" id="530990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="530994">ch</span>&nbsp;<span class="op" id="530997">&lt;-</span>&nbsp;<span class="builtintype" id="531000">true</span><br>
<span class="lineno">2025</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="531006">}</span><span class="op" id="531007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="531010">defer</span>&nbsp;<span class="ident" id="531016">timer</span><span class="op" id="531021">.</span><span class="ident" id="531022">Stop</span><span class="op" id="531026">(</span><span class="op" id="531027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="531030">go</span>&nbsp;<span class="keyword" id="531033">func</span><span class="op" id="531037">(</span><span class="op" id="531038">)</span>&nbsp;<span class="op" id="531040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="531044">defer</span>&nbsp;<span class="keyword" id="531050">func</span><span class="op" id="531054">(</span><span class="op" id="531055">)</span>&nbsp;<span class="op" id="531057">{</span>&nbsp;<span class="ident" id="531059">ch</span>&nbsp;<span class="op" id="531062">&lt;-</span>&nbsp;<span class="builtintype" id="531065">true</span>&nbsp;<span class="op" id="531070">}</span><span class="op" id="531071">(</span><span class="op" id="531072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="531076">f</span><span class="op" id="531077">(</span><span class="op" id="531078">)</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="531081">}</span><span class="op" id="531082">(</span><span class="op" id="531083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="531086">&lt;-</span><span class="ident" id="531088">ch</span><br>
<span class="lineno"></span><span class="op" id="531091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="531094">type</span>&nbsp;<span class="ident" id="531099">errorListener</span>&nbsp;<span class="keyword" id="531113">struct</span>&nbsp;<span class="op" id="531120">{</span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="531123">errs</span>&nbsp;<span class="op" id="531128">[</span><span class="op" id="531129">]</span><span class="builtintype" id="531130">error</span><br>
<span class="lineno"></span><span class="op" id="531136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="531139">func</span>&nbsp;<span class="op" id="531144">(</span><span class="ident" id="531145">l</span>&nbsp;<span class="op" id="531147">*</span><span class="ident" id="531148">errorListener</span><span class="op" id="531161">)</span>&nbsp;<span class="ident" id="531163">Accept</span><span class="op" id="531169">(</span><span class="op" id="531170">)</span>&nbsp;<span class="op" id="531172">(</span><span class="ident" id="531173">c</span>&nbsp;<span class="ident" id="531175">net</span><span class="op" id="531178">.</span><span class="ident" id="531179">Conn</span><span class="op" id="531183">,</span>&nbsp;<span class="ident" id="531185">err</span>&nbsp;<span class="builtintype" id="531189">error</span><span class="op" id="531194">)</span>&nbsp;<span class="op" id="531196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="531199">if</span>&nbsp;<span class="builtinfunc" id="531202">len</span><span class="op" id="531205">(</span><span class="ident" id="531206">l</span><span class="op" id="531207">.</span><span class="ident" id="531208">errs</span><span class="op" id="531212">)</span>&nbsp;<span class="op" id="531214">==</span>&nbsp;<span class="num" id="531217">0</span>&nbsp;<span class="op" id="531219">{</span><br>
<span class="lineno">2040</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="531223">return</span>&nbsp;<span class="builtintype" id="531230">nil</span><span class="op" id="531233">,</span>&nbsp;<span class="ident" id="531235">io</span><span class="op" id="531237">.</span><span class="ident" id="531238">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="531243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="531246">err</span>&nbsp;<span class="op" id="531250">=</span>&nbsp;<span class="ident" id="531252">l</span><span class="op" id="531253">.</span><span class="ident" id="531254">errs</span><span class="op" id="531258">[</span><span class="num" id="531259">0</span><span class="op" id="531260">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="531263">l</span><span class="op" id="531264">.</span><span class="ident" id="531265">errs</span>&nbsp;<span class="op" id="531270">=</span>&nbsp;<span class="ident" id="531272">l</span><span class="op" id="531273">.</span><span class="ident" id="531274">errs</span><span class="op" id="531278">[</span><span class="num" id="531279">1</span><span class="op" id="531280">:</span><span class="op" id="531281">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="531284">return</span><br>
<span class="lineno">2045</span><span class="op" id="531291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="531294">func</span>&nbsp;<span class="op" id="531299">(</span><span class="ident" id="531300">l</span>&nbsp;<span class="op" id="531302">*</span><span class="ident" id="531303">errorListener</span><span class="op" id="531316">)</span>&nbsp;<span class="ident" id="531318">Close</span><span class="op" id="531323">(</span><span class="op" id="531324">)</span>&nbsp;<span class="builtintype" id="531326">error</span>&nbsp;<span class="op" id="531332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="531335">return</span>&nbsp;<span class="builtintype" id="531342">nil</span><br>
<span class="lineno"></span><span class="op" id="531346">}</span><br>
<span class="lineno">2050</span><br>
<span class="lineno"></span><span class="keyword" id="531349">func</span>&nbsp;<span class="op" id="531354">(</span><span class="ident" id="531355">l</span>&nbsp;<span class="op" id="531357">*</span><span class="ident" id="531358">errorListener</span><span class="op" id="531371">)</span>&nbsp;<span class="ident" id="531373">Addr</span><span class="op" id="531377">(</span><span class="op" id="531378">)</span>&nbsp;<span class="ident" id="531380">net</span><span class="op" id="531383">.</span><span class="ident" id="531384">Addr</span>&nbsp;<span class="op" id="531389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="531392">return</span>&nbsp;<span class="ident" id="531399">dummyAddr</span><span class="op" id="531408">(</span><span class="string" id="531409">&#34;test-address&#34;</span><span class="op" id="531423">)</span><br>
<span class="lineno"></span><span class="op" id="531425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2055</span><span class="keyword" id="531428">func</span>&nbsp;<span class="ident" id="531433">TestAcceptMaxFds</span><span class="op" id="531449">(</span><span class="ident" id="531450">t</span>&nbsp;<span class="op" id="531452">*</span><span class="ident" id="531453">testing</span><span class="op" id="531460">.</span><span class="ident" id="531461">T</span><span class="op" id="531462">)</span>&nbsp;<span class="op" id="531464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="531467">log</span><span class="op" id="531470">.</span><span class="ident" id="531471">SetOutput</span><span class="op" id="531480">(</span><span class="ident" id="531481">ioutil</span><span class="op" id="531487">.</span><span class="ident" id="531488">Discard</span><span class="op" id="531495">)</span>&nbsp;<span class="comment" id="531497">//&nbsp;is&nbsp;noisy&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="531520">defer</span>&nbsp;<span class="ident" id="531526">log</span><span class="op" id="531529">.</span><span class="ident" id="531530">SetOutput</span><span class="op" id="531539">(</span><span class="ident" id="531540">os</span><span class="op" id="531542">.</span><span class="ident" id="531543">Stderr</span><span class="op" id="531549">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="531553">ln</span>&nbsp;<span class="op" id="531556">:=</span>&nbsp;<span class="op" id="531559">&amp;</span><span class="ident" id="531560">errorListener</span><span class="op" id="531573">{</span><span class="op" id="531574">[</span><span class="op" id="531575">]</span><span class="builtintype" id="531576">error</span><span class="op" id="531581">{</span><br>
<span class="lineno">2060</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="531585">&amp;</span><span class="ident" id="531586">net</span><span class="op" id="531589">.</span><span class="ident" id="531590">OpError</span><span class="op" id="531597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="531602">Op</span><span class="op" id="531604">:</span>&nbsp;&nbsp;<span class="string" id="531607">&#34;accept&#34;</span><span class="op" id="531615">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="531620">Err</span><span class="op" id="531623">:</span>&nbsp;<span class="ident" id="531625">syscall</span><span class="op" id="531632">.</span><span class="ident" id="531633">EMFILE</span><span class="op" id="531639">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="531643">}</span><span class="op" id="531644">}</span><span class="op" id="531645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="531648">err</span>&nbsp;<span class="op" id="531652">:=</span>&nbsp;<span class="ident" id="531655">Serve</span><span class="op" id="531660">(</span><span class="ident" id="531661">ln</span><span class="op" id="531663">,</span>&nbsp;<span class="ident" id="531665">HandlerFunc</span><span class="op" id="531676">(</span><span class="ident" id="531677">HandlerFunc</span><span class="op" id="531688">(</span><span class="keyword" id="531689">func</span><span class="op" id="531693">(</span><span class="ident" id="531694">ResponseWriter</span><span class="op" id="531708">,</span>&nbsp;<span class="op" id="531710">*</span><span class="ident" id="531711">Request</span><span class="op" id="531718">)</span>&nbsp;<span class="op" id="531720">{</span><span class="op" id="531721">}</span><span class="op" id="531722">)</span><span class="op" id="531723">)</span><span class="op" id="531724">)</span><br>
<span class="lineno">2065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="531727">if</span>&nbsp;<span class="ident" id="531730">err</span>&nbsp;<span class="op" id="531734">!=</span>&nbsp;<span class="ident" id="531737">io</span><span class="op" id="531739">.</span><span class="ident" id="531740">EOF</span>&nbsp;<span class="op" id="531744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="531748">t</span><span class="op" id="531749">.</span><span class="ident" id="531750">Errorf</span><span class="op" id="531756">(</span><span class="string" id="531757">&#34;got&nbsp;error&nbsp;%v,&nbsp;want&nbsp;EOF&#34;</span><span class="op" id="531781">,</span>&nbsp;<span class="ident" id="531783">err</span><span class="op" id="531786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="531789">}</span><br>
<span class="lineno"></span><span class="op" id="531791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2070</span><span class="keyword" id="531794">func</span>&nbsp;<span class="ident" id="531799">TestWriteAfterHijack</span><span class="op" id="531819">(</span><span class="ident" id="531820">t</span>&nbsp;<span class="op" id="531822">*</span><span class="ident" id="531823">testing</span><span class="op" id="531830">.</span><span class="ident" id="531831">T</span><span class="op" id="531832">)</span>&nbsp;<span class="op" id="531834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="531837">req</span>&nbsp;<span class="op" id="531841">:=</span>&nbsp;<span class="ident" id="531844">reqBytes</span><span class="op" id="531852">(</span><span class="string" id="531853">&#34;GET&nbsp;/&nbsp;HTTP/1.1\nHost:&nbsp;golang.org&#34;</span><span class="op" id="531887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="531890">var</span>&nbsp;<span class="ident" id="531894">buf</span>&nbsp;<span class="ident" id="531898">bytes</span><span class="op" id="531903">.</span><span class="ident" id="531904">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="531912">wrotec</span>&nbsp;<span class="op" id="531919">:=</span>&nbsp;<span class="builtinfunc" id="531922">make</span><span class="op" id="531926">(</span><span class="keyword" id="531927">chan</span>&nbsp;<span class="builtintype" id="531932">bool</span><span class="op" id="531936">,</span>&nbsp;<span class="num" id="531938">1</span><span class="op" id="531939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="531942">conn</span>&nbsp;<span class="op" id="531947">:=</span>&nbsp;<span class="op" id="531950">&amp;</span><span class="ident" id="531951">rwTestConn</span><span class="op" id="531961">{</span><br>
<span class="lineno">2075</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="531965">Reader</span><span class="op" id="531971">:</span>&nbsp;<span class="ident" id="531973">bytes</span><span class="op" id="531978">.</span><span class="ident" id="531979">NewReader</span><span class="op" id="531988">(</span><span class="ident" id="531989">req</span><span class="op" id="531992">)</span><span class="op" id="531993">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="531997">Writer</span><span class="op" id="532003">:</span>&nbsp;<span class="op" id="532005">&amp;</span><span class="ident" id="532006">buf</span><span class="op" id="532009">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532013">closec</span><span class="op" id="532019">:</span>&nbsp;<span class="builtinfunc" id="532021">make</span><span class="op" id="532025">(</span><span class="keyword" id="532026">chan</span>&nbsp;<span class="builtintype" id="532031">bool</span><span class="op" id="532035">,</span>&nbsp;<span class="num" id="532037">1</span><span class="op" id="532038">)</span><span class="op" id="532039">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="532042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532045">handler</span>&nbsp;<span class="op" id="532053">:=</span>&nbsp;<span class="ident" id="532056">HandlerFunc</span><span class="op" id="532067">(</span><span class="keyword" id="532068">func</span><span class="op" id="532072">(</span><span class="ident" id="532073">rw</span>&nbsp;<span class="ident" id="532076">ResponseWriter</span><span class="op" id="532090">,</span>&nbsp;<span class="ident" id="532092">r</span>&nbsp;<span class="op" id="532094">*</span><span class="ident" id="532095">Request</span><span class="op" id="532102">)</span>&nbsp;<span class="op" id="532104">{</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532108">conn</span><span class="op" id="532112">,</span>&nbsp;<span class="ident" id="532114">bufrw</span><span class="op" id="532119">,</span>&nbsp;<span class="ident" id="532121">err</span>&nbsp;<span class="op" id="532125">:=</span>&nbsp;<span class="ident" id="532128">rw</span><span class="op" id="532130">.</span><span class="op" id="532131">(</span><span class="ident" id="532132">Hijacker</span><span class="op" id="532140">)</span><span class="op" id="532141">.</span><span class="ident" id="532142">Hijack</span><span class="op" id="532148">(</span><span class="op" id="532149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="532153">if</span>&nbsp;<span class="ident" id="532156">err</span>&nbsp;<span class="op" id="532160">!=</span>&nbsp;<span class="builtintype" id="532163">nil</span>&nbsp;<span class="op" id="532167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532172">t</span><span class="op" id="532173">.</span><span class="ident" id="532174">Error</span><span class="op" id="532179">(</span><span class="ident" id="532180">err</span><span class="op" id="532183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="532188">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="532197">}</span><br>
<span class="lineno">2085</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="532201">go</span>&nbsp;<span class="keyword" id="532204">func</span><span class="op" id="532208">(</span><span class="op" id="532209">)</span>&nbsp;<span class="op" id="532211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532216">bufrw</span><span class="op" id="532221">.</span><span class="ident" id="532222">Write</span><span class="op" id="532227">(</span><span class="op" id="532228">[</span><span class="op" id="532229">]</span><span class="builtintype" id="532230">byte</span><span class="op" id="532234">(</span><span class="string" id="532235">&#34;[hijack-to-bufw]&#34;</span><span class="op" id="532253">)</span><span class="op" id="532254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532259">bufrw</span><span class="op" id="532264">.</span><span class="ident" id="532265">Flush</span><span class="op" id="532270">(</span><span class="op" id="532271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532276">conn</span><span class="op" id="532280">.</span><span class="ident" id="532281">Write</span><span class="op" id="532286">(</span><span class="op" id="532287">[</span><span class="op" id="532288">]</span><span class="builtintype" id="532289">byte</span><span class="op" id="532293">(</span><span class="string" id="532294">&#34;[hijack-to-conn]&#34;</span><span class="op" id="532312">)</span><span class="op" id="532313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532318">conn</span><span class="op" id="532322">.</span><span class="ident" id="532323">Close</span><span class="op" id="532328">(</span><span class="op" id="532329">)</span><br>
<span class="lineno">2090</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532334">wrotec</span>&nbsp;<span class="op" id="532341">&lt;-</span>&nbsp;<span class="builtintype" id="532344">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="532351">}</span><span class="op" id="532352">(</span><span class="op" id="532353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="532356">}</span><span class="op" id="532357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532360">ln</span>&nbsp;<span class="op" id="532363">:=</span>&nbsp;<span class="op" id="532366">&amp;</span><span class="ident" id="532367">oneConnListener</span><span class="op" id="532382">{</span><span class="ident" id="532383">conn</span><span class="op" id="532387">:</span>&nbsp;<span class="ident" id="532389">conn</span><span class="op" id="532393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="532396">go</span>&nbsp;<span class="ident" id="532399">Serve</span><span class="op" id="532404">(</span><span class="ident" id="532405">ln</span><span class="op" id="532407">,</span>&nbsp;<span class="ident" id="532409">handler</span><span class="op" id="532416">)</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="532419">&lt;-</span><span class="ident" id="532421">conn</span><span class="op" id="532425">.</span><span class="ident" id="532426">closec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="532434">&lt;-</span><span class="ident" id="532436">wrotec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="532444">if</span>&nbsp;<span class="ident" id="532447">g</span><span class="op" id="532448">,</span>&nbsp;<span class="ident" id="532450">w</span>&nbsp;<span class="op" id="532452">:=</span>&nbsp;<span class="ident" id="532455">buf</span><span class="op" id="532458">.</span><span class="ident" id="532459">String</span><span class="op" id="532465">(</span><span class="op" id="532466">)</span><span class="op" id="532467">,</span>&nbsp;<span class="string" id="532469">&#34;[hijack-to-bufw][hijack-to-conn]&#34;</span><span class="op" id="532503">;</span>&nbsp;<span class="ident" id="532505">g</span>&nbsp;<span class="op" id="532507">!=</span>&nbsp;<span class="ident" id="532510">w</span>&nbsp;<span class="op" id="532512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532516">t</span><span class="op" id="532517">.</span><span class="ident" id="532518">Errorf</span><span class="op" id="532524">(</span><span class="string" id="532525">&#34;wrote&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="532544">,</span>&nbsp;<span class="ident" id="532546">g</span><span class="op" id="532547">,</span>&nbsp;<span class="ident" id="532549">w</span><span class="op" id="532550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="532553">}</span><br>
<span class="lineno">2100</span><span class="op" id="532555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="532558">func</span>&nbsp;<span class="ident" id="532563">TestDoubleHijack</span><span class="op" id="532579">(</span><span class="ident" id="532580">t</span>&nbsp;<span class="op" id="532582">*</span><span class="ident" id="532583">testing</span><span class="op" id="532590">.</span><span class="ident" id="532591">T</span><span class="op" id="532592">)</span>&nbsp;<span class="op" id="532594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532597">req</span>&nbsp;<span class="op" id="532601">:=</span>&nbsp;<span class="ident" id="532604">reqBytes</span><span class="op" id="532612">(</span><span class="string" id="532613">&#34;GET&nbsp;/&nbsp;HTTP/1.1\nHost:&nbsp;golang.org&#34;</span><span class="op" id="532647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="532650">var</span>&nbsp;<span class="ident" id="532654">buf</span>&nbsp;<span class="ident" id="532658">bytes</span><span class="op" id="532663">.</span><span class="ident" id="532664">Buffer</span><br>
<span class="lineno">2105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532672">conn</span>&nbsp;<span class="op" id="532677">:=</span>&nbsp;<span class="op" id="532680">&amp;</span><span class="ident" id="532681">rwTestConn</span><span class="op" id="532691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532695">Reader</span><span class="op" id="532701">:</span>&nbsp;<span class="ident" id="532703">bytes</span><span class="op" id="532708">.</span><span class="ident" id="532709">NewReader</span><span class="op" id="532718">(</span><span class="ident" id="532719">req</span><span class="op" id="532722">)</span><span class="op" id="532723">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532727">Writer</span><span class="op" id="532733">:</span>&nbsp;<span class="op" id="532735">&amp;</span><span class="ident" id="532736">buf</span><span class="op" id="532739">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532743">closec</span><span class="op" id="532749">:</span>&nbsp;<span class="builtinfunc" id="532751">make</span><span class="op" id="532755">(</span><span class="keyword" id="532756">chan</span>&nbsp;<span class="builtintype" id="532761">bool</span><span class="op" id="532765">,</span>&nbsp;<span class="num" id="532767">1</span><span class="op" id="532768">)</span><span class="op" id="532769">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="532772">}</span><br>
<span class="lineno">2110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532775">handler</span>&nbsp;<span class="op" id="532783">:=</span>&nbsp;<span class="ident" id="532786">HandlerFunc</span><span class="op" id="532797">(</span><span class="keyword" id="532798">func</span><span class="op" id="532802">(</span><span class="ident" id="532803">rw</span>&nbsp;<span class="ident" id="532806">ResponseWriter</span><span class="op" id="532820">,</span>&nbsp;<span class="ident" id="532822">r</span>&nbsp;<span class="op" id="532824">*</span><span class="ident" id="532825">Request</span><span class="op" id="532832">)</span>&nbsp;<span class="op" id="532834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532838">conn</span><span class="op" id="532842">,</span>&nbsp;<span class="ident" id="532844">_</span><span class="op" id="532845">,</span>&nbsp;<span class="ident" id="532847">err</span>&nbsp;<span class="op" id="532851">:=</span>&nbsp;<span class="ident" id="532854">rw</span><span class="op" id="532856">.</span><span class="op" id="532857">(</span><span class="ident" id="532858">Hijacker</span><span class="op" id="532866">)</span><span class="op" id="532867">.</span><span class="ident" id="532868">Hijack</span><span class="op" id="532874">(</span><span class="op" id="532875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="532879">if</span>&nbsp;<span class="ident" id="532882">err</span>&nbsp;<span class="op" id="532886">!=</span>&nbsp;<span class="builtintype" id="532889">nil</span>&nbsp;<span class="op" id="532893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532898">t</span><span class="op" id="532899">.</span><span class="ident" id="532900">Error</span><span class="op" id="532905">(</span><span class="ident" id="532906">err</span><span class="op" id="532909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="532914">return</span><br>
<span class="lineno">2115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="532923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532927">_</span><span class="op" id="532928">,</span>&nbsp;<span class="ident" id="532930">_</span><span class="op" id="532931">,</span>&nbsp;<span class="ident" id="532933">err</span>&nbsp;<span class="op" id="532937">=</span>&nbsp;<span class="ident" id="532939">rw</span><span class="op" id="532941">.</span><span class="op" id="532942">(</span><span class="ident" id="532943">Hijacker</span><span class="op" id="532951">)</span><span class="op" id="532952">.</span><span class="ident" id="532953">Hijack</span><span class="op" id="532959">(</span><span class="op" id="532960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="532964">if</span>&nbsp;<span class="ident" id="532967">err</span>&nbsp;<span class="op" id="532971">==</span>&nbsp;<span class="builtintype" id="532974">nil</span>&nbsp;<span class="op" id="532978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="532983">t</span><span class="op" id="532984">.</span><span class="ident" id="532985">Errorf</span><span class="op" id="532991">(</span><span class="string" id="532992">&#34;got&nbsp;err&nbsp;=&nbsp;nil;&nbsp;&nbsp;want&nbsp;err&nbsp;!=&nbsp;nil&#34;</span><span class="op" id="533025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="533029">}</span><br>
<span class="lineno">2120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="533033">conn</span><span class="op" id="533037">.</span><span class="ident" id="533038">Close</span><span class="op" id="533043">(</span><span class="op" id="533044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="533047">}</span><span class="op" id="533048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="533051">ln</span>&nbsp;<span class="op" id="533054">:=</span>&nbsp;<span class="op" id="533057">&amp;</span><span class="ident" id="533058">oneConnListener</span><span class="op" id="533073">{</span><span class="ident" id="533074">conn</span><span class="op" id="533078">:</span>&nbsp;<span class="ident" id="533080">conn</span><span class="op" id="533084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="533087">go</span>&nbsp;<span class="ident" id="533090">Serve</span><span class="op" id="533095">(</span><span class="ident" id="533096">ln</span><span class="op" id="533098">,</span>&nbsp;<span class="ident" id="533100">handler</span><span class="op" id="533107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="533110">&lt;-</span><span class="ident" id="533112">conn</span><span class="op" id="533116">.</span><span class="ident" id="533117">closec</span><br>
<span class="lineno">2125</span><span class="op" id="533124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="533127">//&nbsp;http://code.google.com/p/go/issues/detail?id=5955</span><br>
<span class="lineno"></span><span class="comment" id="533180">//&nbsp;Note&nbsp;that&nbsp;this&nbsp;does&nbsp;not&nbsp;test&nbsp;the&nbsp;&#34;request&nbsp;too&nbsp;large&#34;</span><br>
<span class="lineno"></span><span class="comment" id="533236">//&nbsp;exit&nbsp;path&nbsp;from&nbsp;the&nbsp;http&nbsp;server.&nbsp;This&nbsp;is&nbsp;intentional;</span><br>
<span class="lineno">2130</span><span class="comment" id="533292">//&nbsp;not&nbsp;sending&nbsp;Connection:&nbsp;close&nbsp;is&nbsp;just&nbsp;a&nbsp;minor&nbsp;wire</span><br>
<span class="lineno"></span><span class="comment" id="533346">//&nbsp;optimization&nbsp;and&nbsp;is&nbsp;pointless&nbsp;if&nbsp;dealing&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="533397">//&nbsp;badly&nbsp;behaved&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="533422">func</span>&nbsp;<span class="ident" id="533427">TestHTTP10ConnectionHeader</span><span class="op" id="533453">(</span><span class="ident" id="533454">t</span>&nbsp;<span class="op" id="533456">*</span><span class="ident" id="533457">testing</span><span class="op" id="533464">.</span><span class="ident" id="533465">T</span><span class="op" id="533466">)</span>&nbsp;<span class="op" id="533468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="533471">defer</span>&nbsp;<span class="ident" id="533477">afterTest</span><span class="op" id="533486">(</span><span class="ident" id="533487">t</span><span class="op" id="533488">)</span><br>
<span class="lineno">2135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="533492">mux</span>&nbsp;<span class="op" id="533496">:=</span>&nbsp;<span class="ident" id="533499">NewServeMux</span><span class="op" id="533510">(</span><span class="op" id="533511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="533514">mux</span><span class="op" id="533517">.</span><span class="ident" id="533518">Handle</span><span class="op" id="533524">(</span><span class="string" id="533525">&#34;/&#34;</span><span class="op" id="533528">,</span>&nbsp;<span class="ident" id="533530">HandlerFunc</span><span class="op" id="533541">(</span><span class="keyword" id="533542">func</span><span class="op" id="533546">(</span><span class="ident" id="533547">resp</span>&nbsp;<span class="ident" id="533552">ResponseWriter</span><span class="op" id="533566">,</span>&nbsp;<span class="ident" id="533568">req</span>&nbsp;<span class="op" id="533572">*</span><span class="ident" id="533573">Request</span><span class="op" id="533580">)</span>&nbsp;<span class="op" id="533582">{</span><span class="op" id="533583">}</span><span class="op" id="533584">)</span><span class="op" id="533585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="533588">ts</span>&nbsp;<span class="op" id="533591">:=</span>&nbsp;<span class="ident" id="533594">httptest</span><span class="op" id="533602">.</span><span class="ident" id="533603">NewServer</span><span class="op" id="533612">(</span><span class="ident" id="533613">mux</span><span class="op" id="533616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="533619">defer</span>&nbsp;<span class="ident" id="533625">ts</span><span class="op" id="533627">.</span><span class="ident" id="533628">Close</span><span class="op" id="533633">(</span><span class="op" id="533634">)</span><br>
<span class="lineno">2140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="533638">//&nbsp;net/http&nbsp;uses&nbsp;HTTP/1.1&nbsp;for&nbsp;requests,&nbsp;so&nbsp;write&nbsp;requests&nbsp;manually</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="533706">tests</span>&nbsp;<span class="op" id="533712">:=</span>&nbsp;<span class="op" id="533715">[</span><span class="op" id="533716">]</span><span class="keyword" id="533717">struct</span>&nbsp;<span class="op" id="533724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="533728">req</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="533735">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="533744">//&nbsp;raw&nbsp;http&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="533766">expect</span>&nbsp;<span class="op" id="533773">[</span><span class="op" id="533774">]</span><span class="builtintype" id="533775">string</span>&nbsp;<span class="comment" id="533782">//&nbsp;expected&nbsp;Connection&nbsp;header(s)</span><br>
<span class="lineno">2145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="533816">}</span><span class="op" id="533817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="533821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="533826">req</span><span class="op" id="533829">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="533834">&#34;GET&nbsp;/&nbsp;HTTP/1.0\r\n\r\n&#34;</span><span class="op" id="533858">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="533863">expect</span><span class="op" id="533869">:</span>&nbsp;<span class="builtintype" id="533871">nil</span><span class="op" id="533874">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="533878">}</span><span class="op" id="533879">,</span><br>
<span class="lineno">2150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="533883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="533888">req</span><span class="op" id="533891">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="533896">&#34;OPTIONS&nbsp;*&nbsp;HTTP/1.0\r\n\r\n&#34;</span><span class="op" id="533924">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="533929">expect</span><span class="op" id="533935">:</span>&nbsp;<span class="builtintype" id="533937">nil</span><span class="op" id="533940">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="533944">}</span><span class="op" id="533945">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="533949">{</span><br>
<span class="lineno">2155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="533954">req</span><span class="op" id="533957">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="533962">&#34;GET&nbsp;/&nbsp;HTTP/1.0\r\nConnection:&nbsp;keep-alive\r\n\r\n&#34;</span><span class="op" id="534012">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="534017">expect</span><span class="op" id="534023">:</span>&nbsp;<span class="op" id="534025">[</span><span class="op" id="534026">]</span><span class="builtintype" id="534027">string</span><span class="op" id="534033">{</span><span class="string" id="534034">&#34;keep-alive&#34;</span><span class="op" id="534046">}</span><span class="op" id="534047">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="534051">}</span><span class="op" id="534052">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="534055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="534059">for</span>&nbsp;<span class="ident" id="534063">_</span><span class="op" id="534064">,</span>&nbsp;<span class="ident" id="534066">tt</span>&nbsp;<span class="op" id="534069">:=</span>&nbsp;<span class="keyword" id="534072">range</span>&nbsp;<span class="ident" id="534078">tests</span>&nbsp;<span class="op" id="534084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="534088">conn</span><span class="op" id="534092">,</span>&nbsp;<span class="ident" id="534094">err</span>&nbsp;<span class="op" id="534098">:=</span>&nbsp;<span class="ident" id="534101">net</span><span class="op" id="534104">.</span><span class="ident" id="534105">Dial</span><span class="op" id="534109">(</span><span class="string" id="534110">&#34;tcp&#34;</span><span class="op" id="534115">,</span>&nbsp;<span class="ident" id="534117">ts</span><span class="op" id="534119">.</span><span class="ident" id="534120">Listener</span><span class="op" id="534128">.</span><span class="ident" id="534129">Addr</span><span class="op" id="534133">(</span><span class="op" id="534134">)</span><span class="op" id="534135">.</span><span class="ident" id="534136">String</span><span class="op" id="534142">(</span><span class="op" id="534143">)</span><span class="op" id="534144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="534148">if</span>&nbsp;<span class="ident" id="534151">err</span>&nbsp;<span class="op" id="534155">!=</span>&nbsp;<span class="builtintype" id="534158">nil</span>&nbsp;<span class="op" id="534162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="534167">t</span><span class="op" id="534168">.</span><span class="ident" id="534169">Fatal</span><span class="op" id="534174">(</span><span class="string" id="534175">&#34;dial&nbsp;err:&#34;</span><span class="op" id="534186">,</span>&nbsp;<span class="ident" id="534188">err</span><span class="op" id="534191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="534195">}</span><br>
<span class="lineno">2165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="534200">_</span><span class="op" id="534201">,</span>&nbsp;<span class="ident" id="534203">err</span>&nbsp;<span class="op" id="534207">=</span>&nbsp;<span class="ident" id="534209">fmt</span><span class="op" id="534212">.</span><span class="ident" id="534213">Fprint</span><span class="op" id="534219">(</span><span class="ident" id="534220">conn</span><span class="op" id="534224">,</span>&nbsp;<span class="ident" id="534226">tt</span><span class="op" id="534228">.</span><span class="ident" id="534229">req</span><span class="op" id="534232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="534236">if</span>&nbsp;<span class="ident" id="534239">err</span>&nbsp;<span class="op" id="534243">!=</span>&nbsp;<span class="builtintype" id="534246">nil</span>&nbsp;<span class="op" id="534250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="534255">t</span><span class="op" id="534256">.</span><span class="ident" id="534257">Fatal</span><span class="op" id="534262">(</span><span class="string" id="534263">&#34;conn&nbsp;write&nbsp;err:&#34;</span><span class="op" id="534280">,</span>&nbsp;<span class="ident" id="534282">err</span><span class="op" id="534285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="534289">}</span><br>
<span class="lineno">2170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="534294">resp</span><span class="op" id="534298">,</span>&nbsp;<span class="ident" id="534300">err</span>&nbsp;<span class="op" id="534304">:=</span>&nbsp;<span class="ident" id="534307">ReadResponse</span><span class="op" id="534319">(</span><span class="ident" id="534320">bufio</span><span class="op" id="534325">.</span><span class="ident" id="534326">NewReader</span><span class="op" id="534335">(</span><span class="ident" id="534336">conn</span><span class="op" id="534340">)</span><span class="op" id="534341">,</span>&nbsp;<span class="op" id="534343">&amp;</span><span class="ident" id="534344">Request</span><span class="op" id="534351">{</span><span class="ident" id="534352">Method</span><span class="op" id="534358">:</span>&nbsp;<span class="string" id="534360">&#34;GET&#34;</span><span class="op" id="534365">}</span><span class="op" id="534366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="534370">if</span>&nbsp;<span class="ident" id="534373">err</span>&nbsp;<span class="op" id="534377">!=</span>&nbsp;<span class="builtintype" id="534380">nil</span>&nbsp;<span class="op" id="534384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="534389">t</span><span class="op" id="534390">.</span><span class="ident" id="534391">Fatal</span><span class="op" id="534396">(</span><span class="string" id="534397">&#34;ReadResponse&nbsp;err:&#34;</span><span class="op" id="534416">,</span>&nbsp;<span class="ident" id="534418">err</span><span class="op" id="534421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="534425">}</span><br>
<span class="lineno">2175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="534429">conn</span><span class="op" id="534433">.</span><span class="ident" id="534434">Close</span><span class="op" id="534439">(</span><span class="op" id="534440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="534444">resp</span><span class="op" id="534448">.</span><span class="ident" id="534449">Body</span><span class="op" id="534453">.</span><span class="ident" id="534454">Close</span><span class="op" id="534459">(</span><span class="op" id="534460">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="534465">got</span>&nbsp;<span class="op" id="534469">:=</span>&nbsp;<span class="ident" id="534472">resp</span><span class="op" id="534476">.</span><span class="ident" id="534477">Header</span><span class="op" id="534483">[</span><span class="string" id="534484">&#34;Connection&#34;</span><span class="op" id="534496">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="534500">if</span>&nbsp;<span class="op" id="534503">!</span><span class="ident" id="534504">reflect</span><span class="op" id="534511">.</span><span class="ident" id="534512">DeepEqual</span><span class="op" id="534521">(</span><span class="ident" id="534522">got</span><span class="op" id="534525">,</span>&nbsp;<span class="ident" id="534527">tt</span><span class="op" id="534529">.</span><span class="ident" id="534530">expect</span><span class="op" id="534536">)</span>&nbsp;<span class="op" id="534538">{</span><br>
<span class="lineno">2180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="534543">t</span><span class="op" id="534544">.</span><span class="ident" id="534545">Errorf</span><span class="op" id="534551">(</span><span class="string" id="534552">&#34;wrong&nbsp;Connection&nbsp;headers&nbsp;for&nbsp;request&nbsp;%q.&nbsp;Got&nbsp;%q&nbsp;expect&nbsp;%q&#34;</span><span class="op" id="534611">,</span>&nbsp;<span class="ident" id="534613">tt</span><span class="op" id="534615">.</span><span class="ident" id="534616">req</span><span class="op" id="534619">,</span>&nbsp;<span class="ident" id="534621">got</span><span class="op" id="534624">,</span>&nbsp;<span class="ident" id="534626">tt</span><span class="op" id="534628">.</span><span class="ident" id="534629">expect</span><span class="op" id="534635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="534639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="534642">}</span><br>
<span class="lineno"></span><span class="op" id="534644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2185</span><span class="comment" id="534647">//&nbsp;See&nbsp;golang.org/issue/5660</span><br>
<span class="lineno"></span><span class="keyword" id="534676">func</span>&nbsp;<span class="ident" id="534681">TestServerReaderFromOrder</span><span class="op" id="534706">(</span><span class="ident" id="534707">t</span>&nbsp;<span class="op" id="534709">*</span><span class="ident" id="534710">testing</span><span class="op" id="534717">.</span><span class="ident" id="534718">T</span><span class="op" id="534719">)</span>&nbsp;<span class="op" id="534721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="534724">defer</span>&nbsp;<span class="ident" id="534730">afterTest</span><span class="op" id="534739">(</span><span class="ident" id="534740">t</span><span class="op" id="534741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="534744">pr</span><span class="op" id="534746">,</span>&nbsp;<span class="ident" id="534748">pw</span>&nbsp;<span class="op" id="534751">:=</span>&nbsp;<span class="ident" id="534754">io</span><span class="op" id="534756">.</span><span class="ident" id="534757">Pipe</span><span class="op" id="534761">(</span><span class="op" id="534762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="534765">const</span>&nbsp;<span class="ident" id="534771">size</span>&nbsp;<span class="op" id="534776">=</span>&nbsp;<span class="num" id="534778">3</span>&nbsp;<span class="op" id="534780">&lt;&lt;</span>&nbsp;<span class="num" id="534783">20</span><br>
<span class="lineno">2190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="534787">ts</span>&nbsp;<span class="op" id="534790">:=</span>&nbsp;<span class="ident" id="534793">httptest</span><span class="op" id="534801">.</span><span class="ident" id="534802">NewServer</span><span class="op" id="534811">(</span><span class="ident" id="534812">HandlerFunc</span><span class="op" id="534823">(</span><span class="keyword" id="534824">func</span><span class="op" id="534828">(</span><span class="ident" id="534829">rw</span>&nbsp;<span class="ident" id="534832">ResponseWriter</span><span class="op" id="534846">,</span>&nbsp;<span class="ident" id="534848">req</span>&nbsp;<span class="op" id="534852">*</span><span class="ident" id="534853">Request</span><span class="op" id="534860">)</span>&nbsp;<span class="op" id="534862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="534866">rw</span><span class="op" id="534868">.</span><span class="ident" id="534869">Header</span><span class="op" id="534875">(</span><span class="op" id="534876">)</span><span class="op" id="534877">.</span><span class="ident" id="534878">Set</span><span class="op" id="534881">(</span><span class="string" id="534882">&#34;Content-Type&#34;</span><span class="op" id="534896">,</span>&nbsp;<span class="string" id="534898">&#34;text/plain&#34;</span><span class="op" id="534910">)</span>&nbsp;<span class="comment" id="534912">//&nbsp;prevent&nbsp;sniffing&nbsp;path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="534939">done</span>&nbsp;<span class="op" id="534944">:=</span>&nbsp;<span class="builtinfunc" id="534947">make</span><span class="op" id="534951">(</span><span class="keyword" id="534952">chan</span>&nbsp;<span class="builtintype" id="534957">bool</span><span class="op" id="534961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="534965">go</span>&nbsp;<span class="keyword" id="534968">func</span><span class="op" id="534972">(</span><span class="op" id="534973">)</span>&nbsp;<span class="op" id="534975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="534980">io</span><span class="op" id="534982">.</span><span class="ident" id="534983">Copy</span><span class="op" id="534987">(</span><span class="ident" id="534988">rw</span><span class="op" id="534990">,</span>&nbsp;<span class="ident" id="534992">pr</span><span class="op" id="534994">)</span><br>
<span class="lineno">2195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="534999">close</span><span class="op" id="535004">(</span><span class="ident" id="535005">done</span><span class="op" id="535009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="535013">}</span><span class="op" id="535014">(</span><span class="op" id="535015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="535019">time</span><span class="op" id="535023">.</span><span class="ident" id="535024">Sleep</span><span class="op" id="535029">(</span><span class="num" id="535030">25</span>&nbsp;<span class="op" id="535033">*</span>&nbsp;<span class="ident" id="535035">time</span><span class="op" id="535039">.</span><span class="ident" id="535040">Millisecond</span><span class="op" id="535051">)</span>&nbsp;<span class="comment" id="535053">//&nbsp;give&nbsp;Copy&nbsp;a&nbsp;chance&nbsp;to&nbsp;break&nbsp;things</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="535093">n</span><span class="op" id="535094">,</span>&nbsp;<span class="ident" id="535096">err</span>&nbsp;<span class="op" id="535100">:=</span>&nbsp;<span class="ident" id="535103">io</span><span class="op" id="535105">.</span><span class="ident" id="535106">Copy</span><span class="op" id="535110">(</span><span class="ident" id="535111">ioutil</span><span class="op" id="535117">.</span><span class="ident" id="535118">Discard</span><span class="op" id="535125">,</span>&nbsp;<span class="ident" id="535127">req</span><span class="op" id="535130">.</span><span class="ident" id="535131">Body</span><span class="op" id="535135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="535139">if</span>&nbsp;<span class="ident" id="535142">err</span>&nbsp;<span class="op" id="535146">!=</span>&nbsp;<span class="builtintype" id="535149">nil</span>&nbsp;<span class="op" id="535153">{</span><br>
<span class="lineno">2200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="535158">t</span><span class="op" id="535159">.</span><span class="ident" id="535160">Errorf</span><span class="op" id="535166">(</span><span class="string" id="535167">&#34;handler&nbsp;Copy:&nbsp;%v&#34;</span><span class="op" id="535185">,</span>&nbsp;<span class="ident" id="535187">err</span><span class="op" id="535190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="535195">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="535204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="535208">if</span>&nbsp;<span class="ident" id="535211">n</span>&nbsp;<span class="op" id="535213">!=</span>&nbsp;<span class="ident" id="535216">size</span>&nbsp;<span class="op" id="535221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="535226">t</span><span class="op" id="535227">.</span><span class="ident" id="535228">Errorf</span><span class="op" id="535234">(</span><span class="string" id="535235">&#34;handler&nbsp;Copy&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="535263">,</span>&nbsp;<span class="ident" id="535265">n</span><span class="op" id="535266">,</span>&nbsp;<span class="ident" id="535268">size</span><span class="op" id="535272">)</span><br>
<span class="lineno">2205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="535276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="535280">pw</span><span class="op" id="535282">.</span><span class="ident" id="535283">Write</span><span class="op" id="535288">(</span><span class="op" id="535289">[</span><span class="op" id="535290">]</span><span class="builtintype" id="535291">byte</span><span class="op" id="535295">(</span><span class="string" id="535296">&#34;hi&#34;</span><span class="op" id="535300">)</span><span class="op" id="535301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="535305">pw</span><span class="op" id="535307">.</span><span class="ident" id="535308">Close</span><span class="op" id="535313">(</span><span class="op" id="535314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="535318">&lt;-</span><span class="ident" id="535320">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="535326">}</span><span class="op" id="535327">)</span><span class="op" id="535328">)</span><br>
<span class="lineno">2210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="535331">defer</span>&nbsp;<span class="ident" id="535337">ts</span><span class="op" id="535339">.</span><span class="ident" id="535340">Close</span><span class="op" id="535345">(</span><span class="op" id="535346">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="535350">req</span><span class="op" id="535353">,</span>&nbsp;<span class="ident" id="535355">err</span>&nbsp;<span class="op" id="535359">:=</span>&nbsp;<span class="ident" id="535362">NewRequest</span><span class="op" id="535372">(</span><span class="string" id="535373">&#34;POST&#34;</span><span class="op" id="535379">,</span>&nbsp;<span class="ident" id="535381">ts</span><span class="op" id="535383">.</span><span class="ident" id="535384">URL</span><span class="op" id="535387">,</span>&nbsp;<span class="ident" id="535389">io</span><span class="op" id="535391">.</span><span class="ident" id="535392">LimitReader</span><span class="op" id="535403">(</span><span class="ident" id="535404">neverEnding</span><span class="op" id="535415">(</span><span class="string" id="535416">&#39;a&#39;</span><span class="op" id="535419">)</span><span class="op" id="535420">,</span>&nbsp;<span class="ident" id="535422">size</span><span class="op" id="535426">)</span><span class="op" id="535427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="535430">if</span>&nbsp;<span class="ident" id="535433">err</span>&nbsp;<span class="op" id="535437">!=</span>&nbsp;<span class="builtintype" id="535440">nil</span>&nbsp;<span class="op" id="535444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="535448">t</span><span class="op" id="535449">.</span><span class="ident" id="535450">Fatal</span><span class="op" id="535455">(</span><span class="ident" id="535456">err</span><span class="op" id="535459">)</span><br>
<span class="lineno">2215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="535462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="535465">res</span><span class="op" id="535468">,</span>&nbsp;<span class="ident" id="535470">err</span>&nbsp;<span class="op" id="535474">:=</span>&nbsp;<span class="ident" id="535477">DefaultClient</span><span class="op" id="535490">.</span><span class="ident" id="535491">Do</span><span class="op" id="535493">(</span><span class="ident" id="535494">req</span><span class="op" id="535497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="535500">if</span>&nbsp;<span class="ident" id="535503">err</span>&nbsp;<span class="op" id="535507">!=</span>&nbsp;<span class="builtintype" id="535510">nil</span>&nbsp;<span class="op" id="535514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="535518">t</span><span class="op" id="535519">.</span><span class="ident" id="535520">Fatal</span><span class="op" id="535525">(</span><span class="ident" id="535526">err</span><span class="op" id="535529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="535532">}</span><br>
<span class="lineno">2220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="535535">all</span><span class="op" id="535538">,</span>&nbsp;<span class="ident" id="535540">err</span>&nbsp;<span class="op" id="535544">:=</span>&nbsp;<span class="ident" id="535547">ioutil</span><span class="op" id="535553">.</span><span class="ident" id="535554">ReadAll</span><span class="op" id="535561">(</span><span class="ident" id="535562">res</span><span class="op" id="535565">.</span><span class="ident" id="535566">Body</span><span class="op" id="535570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="535573">if</span>&nbsp;<span class="ident" id="535576">err</span>&nbsp;<span class="op" id="535580">!=</span>&nbsp;<span class="builtintype" id="535583">nil</span>&nbsp;<span class="op" id="535587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="535591">t</span><span class="op" id="535592">.</span><span class="ident" id="535593">Fatal</span><span class="op" id="535598">(</span><span class="ident" id="535599">err</span><span class="op" id="535602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="535605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="535608">res</span><span class="op" id="535611">.</span><span class="ident" id="535612">Body</span><span class="op" id="535616">.</span><span class="ident" id="535617">Close</span><span class="op" id="535622">(</span><span class="op" id="535623">)</span><br>
<span class="lineno">2225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="535626">if</span>&nbsp;<span class="builtintype" id="535629">string</span><span class="op" id="535635">(</span><span class="ident" id="535636">all</span><span class="op" id="535639">)</span>&nbsp;<span class="op" id="535641">!=</span>&nbsp;<span class="string" id="535644">&#34;hi&#34;</span>&nbsp;<span class="op" id="535649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="535653">t</span><span class="op" id="535654">.</span><span class="ident" id="535655">Errorf</span><span class="op" id="535661">(</span><span class="string" id="535662">&#34;Body&nbsp;=&nbsp;%q;&nbsp;want&nbsp;hi&#34;</span><span class="op" id="535682">,</span>&nbsp;<span class="ident" id="535684">all</span><span class="op" id="535687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="535690">}</span><br>
<span class="lineno"></span><span class="op" id="535692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2230</span><span class="comment" id="535695">//&nbsp;Issue&nbsp;6157,&nbsp;Issue&nbsp;6685</span><br>
<span class="lineno"></span><span class="keyword" id="535721">func</span>&nbsp;<span class="ident" id="535726">TestCodesPreventingContentTypeAndBody</span><span class="op" id="535763">(</span><span class="ident" id="535764">t</span>&nbsp;<span class="op" id="535766">*</span><span class="ident" id="535767">testing</span><span class="op" id="535774">.</span><span class="ident" id="535775">T</span><span class="op" id="535776">)</span>&nbsp;<span class="op" id="535778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="535781">for</span>&nbsp;<span class="ident" id="535785">_</span><span class="op" id="535786">,</span>&nbsp;<span class="ident" id="535788">code</span>&nbsp;<span class="op" id="535793">:=</span>&nbsp;<span class="keyword" id="535796">range</span>&nbsp;<span class="op" id="535802">[</span><span class="op" id="535803">]</span><span class="builtintype" id="535804">int</span><span class="op" id="535807">{</span><span class="ident" id="535808">StatusNotModified</span><span class="op" id="535825">,</span>&nbsp;<span class="ident" id="535827">StatusNoContent</span><span class="op" id="535842">,</span>&nbsp;<span class="ident" id="535844">StatusContinue</span><span class="op" id="535858">}</span>&nbsp;<span class="op" id="535860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="535864">ht</span>&nbsp;<span class="op" id="535867">:=</span>&nbsp;<span class="ident" id="535870">newHandlerTest</span><span class="op" id="535884">(</span><span class="ident" id="535885">HandlerFunc</span><span class="op" id="535896">(</span><span class="keyword" id="535897">func</span><span class="op" id="535901">(</span><span class="ident" id="535902">w</span>&nbsp;<span class="ident" id="535904">ResponseWriter</span><span class="op" id="535918">,</span>&nbsp;<span class="ident" id="535920">r</span>&nbsp;<span class="op" id="535922">*</span><span class="ident" id="535923">Request</span><span class="op" id="535930">)</span>&nbsp;<span class="op" id="535932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="535937">if</span>&nbsp;<span class="ident" id="535940">r</span><span class="op" id="535941">.</span><span class="ident" id="535942">URL</span><span class="op" id="535945">.</span><span class="ident" id="535946">Path</span>&nbsp;<span class="op" id="535951">==</span>&nbsp;<span class="string" id="535954">&#34;/header&#34;</span>&nbsp;<span class="op" id="535964">{</span><br>
<span class="lineno">2235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="535970">w</span><span class="op" id="535971">.</span><span class="ident" id="535972">Header</span><span class="op" id="535978">(</span><span class="op" id="535979">)</span><span class="op" id="535980">.</span><span class="ident" id="535981">Set</span><span class="op" id="535984">(</span><span class="string" id="535985">&#34;Content-Length&#34;</span><span class="op" id="536001">,</span>&nbsp;<span class="string" id="536003">&#34;123&#34;</span><span class="op" id="536008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="536013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="536018">w</span><span class="op" id="536019">.</span><span class="ident" id="536020">WriteHeader</span><span class="op" id="536031">(</span><span class="ident" id="536032">code</span><span class="op" id="536036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="536041">if</span>&nbsp;<span class="ident" id="536044">r</span><span class="op" id="536045">.</span><span class="ident" id="536046">URL</span><span class="op" id="536049">.</span><span class="ident" id="536050">Path</span>&nbsp;<span class="op" id="536055">==</span>&nbsp;<span class="string" id="536058">&#34;/more&#34;</span>&nbsp;<span class="op" id="536066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="536072">w</span><span class="op" id="536073">.</span><span class="ident" id="536074">Write</span><span class="op" id="536079">(</span><span class="op" id="536080">[</span><span class="op" id="536081">]</span><span class="builtintype" id="536082">byte</span><span class="op" id="536086">(</span><span class="string" id="536087">&#34;stuff&#34;</span><span class="op" id="536094">)</span><span class="op" id="536095">)</span><br>
<span class="lineno">2240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="536100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="536104">}</span><span class="op" id="536105">)</span><span class="op" id="536106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="536110">for</span>&nbsp;<span class="ident" id="536114">_</span><span class="op" id="536115">,</span>&nbsp;<span class="ident" id="536117">req</span>&nbsp;<span class="op" id="536121">:=</span>&nbsp;<span class="keyword" id="536124">range</span>&nbsp;<span class="op" id="536130">[</span><span class="op" id="536131">]</span><span class="builtintype" id="536132">string</span><span class="op" id="536138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="536143">&#34;GET&nbsp;/&nbsp;HTTP/1.0&#34;</span><span class="op" id="536159">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="536164">&#34;GET&nbsp;/header&nbsp;HTTP/1.0&#34;</span><span class="op" id="536186">,</span><br>
<span class="lineno">2245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="536191">&#34;GET&nbsp;/more&nbsp;HTTP/1.0&#34;</span><span class="op" id="536211">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="536216">&#34;GET&nbsp;/&nbsp;HTTP/1.1&#34;</span><span class="op" id="536232">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="536237">&#34;GET&nbsp;/header&nbsp;HTTP/1.1&#34;</span><span class="op" id="536259">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="536264">&#34;GET&nbsp;/more&nbsp;HTTP/1.1&#34;</span><span class="op" id="536284">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="536288">}</span>&nbsp;<span class="op" id="536290">{</span><br>
<span class="lineno">2250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="536295">got</span>&nbsp;<span class="op" id="536299">:=</span>&nbsp;<span class="ident" id="536302">ht</span><span class="op" id="536304">.</span><span class="ident" id="536305">rawResponse</span><span class="op" id="536316">(</span><span class="ident" id="536317">req</span><span class="op" id="536320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="536325">wantStatus</span>&nbsp;<span class="op" id="536336">:=</span>&nbsp;<span class="ident" id="536339">fmt</span><span class="op" id="536342">.</span><span class="ident" id="536343">Sprintf</span><span class="op" id="536350">(</span><span class="string" id="536351">&#34;%d&nbsp;%s&#34;</span><span class="op" id="536358">,</span>&nbsp;<span class="ident" id="536360">code</span><span class="op" id="536364">,</span>&nbsp;<span class="ident" id="536366">StatusText</span><span class="op" id="536376">(</span><span class="ident" id="536377">code</span><span class="op" id="536381">)</span><span class="op" id="536382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="536387">if</span>&nbsp;<span class="op" id="536390">!</span><span class="ident" id="536391">strings</span><span class="op" id="536398">.</span><span class="ident" id="536399">Contains</span><span class="op" id="536407">(</span><span class="ident" id="536408">got</span><span class="op" id="536411">,</span>&nbsp;<span class="ident" id="536413">wantStatus</span><span class="op" id="536423">)</span>&nbsp;<span class="op" id="536425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="536431">t</span><span class="op" id="536432">.</span><span class="ident" id="536433">Errorf</span><span class="op" id="536439">(</span><span class="string" id="536440">&#34;Code&nbsp;%d:&nbsp;Wanted&nbsp;%q&nbsp;Modified&nbsp;for&nbsp;%q:&nbsp;%s&#34;</span><span class="op" id="536480">,</span>&nbsp;<span class="ident" id="536482">code</span><span class="op" id="536486">,</span>&nbsp;<span class="ident" id="536488">wantStatus</span><span class="op" id="536498">,</span>&nbsp;<span class="ident" id="536500">req</span><span class="op" id="536503">,</span>&nbsp;<span class="ident" id="536505">got</span><span class="op" id="536508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="536513">}</span>&nbsp;<span class="keyword" id="536515">else</span>&nbsp;<span class="keyword" id="536520">if</span>&nbsp;<span class="ident" id="536523">strings</span><span class="op" id="536530">.</span><span class="ident" id="536531">Contains</span><span class="op" id="536539">(</span><span class="ident" id="536540">got</span><span class="op" id="536543">,</span>&nbsp;<span class="string" id="536545">&#34;Content-Length&#34;</span><span class="op" id="536561">)</span>&nbsp;<span class="op" id="536563">{</span><br>
<span class="lineno">2255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="536569">t</span><span class="op" id="536570">.</span><span class="ident" id="536571">Errorf</span><span class="op" id="536577">(</span><span class="string" id="536578">&#34;Code&nbsp;%d:&nbsp;Got&nbsp;a&nbsp;Content-Length&nbsp;from&nbsp;%q:&nbsp;%s&#34;</span><span class="op" id="536621">,</span>&nbsp;<span class="ident" id="536623">code</span><span class="op" id="536627">,</span>&nbsp;<span class="ident" id="536629">req</span><span class="op" id="536632">,</span>&nbsp;<span class="ident" id="536634">got</span><span class="op" id="536637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="536642">}</span>&nbsp;<span class="keyword" id="536644">else</span>&nbsp;<span class="keyword" id="536649">if</span>&nbsp;<span class="ident" id="536652">strings</span><span class="op" id="536659">.</span><span class="ident" id="536660">Contains</span><span class="op" id="536668">(</span><span class="ident" id="536669">got</span><span class="op" id="536672">,</span>&nbsp;<span class="string" id="536674">&#34;stuff&#34;</span><span class="op" id="536681">)</span>&nbsp;<span class="op" id="536683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="536689">t</span><span class="op" id="536690">.</span><span class="ident" id="536691">Errorf</span><span class="op" id="536697">(</span><span class="string" id="536698">&#34;Code&nbsp;%d:&nbsp;Response&nbsp;contains&nbsp;a&nbsp;body&nbsp;from&nbsp;%q:&nbsp;%s&#34;</span><span class="op" id="536745">,</span>&nbsp;<span class="ident" id="536747">code</span><span class="op" id="536751">,</span>&nbsp;<span class="ident" id="536753">req</span><span class="op" id="536756">,</span>&nbsp;<span class="ident" id="536758">got</span><span class="op" id="536761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="536766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="536770">}</span><br>
<span class="lineno">2260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="536773">}</span><br>
<span class="lineno"></span><span class="op" id="536775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="536778">func</span>&nbsp;<span class="ident" id="536783">TestContentTypeOkayOn204</span><span class="op" id="536807">(</span><span class="ident" id="536808">t</span>&nbsp;<span class="op" id="536810">*</span><span class="ident" id="536811">testing</span><span class="op" id="536818">.</span><span class="ident" id="536819">T</span><span class="op" id="536820">)</span>&nbsp;<span class="op" id="536822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="536825">ht</span>&nbsp;<span class="op" id="536828">:=</span>&nbsp;<span class="ident" id="536831">newHandlerTest</span><span class="op" id="536845">(</span><span class="ident" id="536846">HandlerFunc</span><span class="op" id="536857">(</span><span class="keyword" id="536858">func</span><span class="op" id="536862">(</span><span class="ident" id="536863">w</span>&nbsp;<span class="ident" id="536865">ResponseWriter</span><span class="op" id="536879">,</span>&nbsp;<span class="ident" id="536881">r</span>&nbsp;<span class="op" id="536883">*</span><span class="ident" id="536884">Request</span><span class="op" id="536891">)</span>&nbsp;<span class="op" id="536893">{</span><br>
<span class="lineno">2265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="536897">w</span><span class="op" id="536898">.</span><span class="ident" id="536899">Header</span><span class="op" id="536905">(</span><span class="op" id="536906">)</span><span class="op" id="536907">.</span><span class="ident" id="536908">Set</span><span class="op" id="536911">(</span><span class="string" id="536912">&#34;Content-Length&#34;</span><span class="op" id="536928">,</span>&nbsp;<span class="string" id="536930">&#34;123&#34;</span><span class="op" id="536935">)</span>&nbsp;<span class="comment" id="536937">//&nbsp;suppressed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="536953">w</span><span class="op" id="536954">.</span><span class="ident" id="536955">Header</span><span class="op" id="536961">(</span><span class="op" id="536962">)</span><span class="op" id="536963">.</span><span class="ident" id="536964">Set</span><span class="op" id="536967">(</span><span class="string" id="536968">&#34;Content-Type&#34;</span><span class="op" id="536982">,</span>&nbsp;<span class="string" id="536984">&#34;foo/bar&#34;</span><span class="op" id="536993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="536997">w</span><span class="op" id="536998">.</span><span class="ident" id="536999">WriteHeader</span><span class="op" id="537010">(</span><span class="num" id="537011">204</span><span class="op" id="537014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="537017">}</span><span class="op" id="537018">)</span><span class="op" id="537019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="537022">got</span>&nbsp;<span class="op" id="537026">:=</span>&nbsp;<span class="ident" id="537029">ht</span><span class="op" id="537031">.</span><span class="ident" id="537032">rawResponse</span><span class="op" id="537043">(</span><span class="string" id="537044">&#34;GET&nbsp;/&nbsp;HTTP/1.1&#34;</span><span class="op" id="537060">)</span><br>
<span class="lineno">2270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="537063">if</span>&nbsp;<span class="op" id="537066">!</span><span class="ident" id="537067">strings</span><span class="op" id="537074">.</span><span class="ident" id="537075">Contains</span><span class="op" id="537083">(</span><span class="ident" id="537084">got</span><span class="op" id="537087">,</span>&nbsp;<span class="string" id="537089">&#34;Content-Type:&nbsp;foo/bar&#34;</span><span class="op" id="537112">)</span>&nbsp;<span class="op" id="537114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="537118">t</span><span class="op" id="537119">.</span><span class="ident" id="537120">Errorf</span><span class="op" id="537126">(</span><span class="string" id="537127">&#34;Response&nbsp;=&nbsp;%q;&nbsp;want&nbsp;Content-Type:&nbsp;foo/bar&#34;</span><span class="op" id="537170">,</span>&nbsp;<span class="ident" id="537172">got</span><span class="op" id="537175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="537178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="537181">if</span>&nbsp;<span class="ident" id="537184">strings</span><span class="op" id="537191">.</span><span class="ident" id="537192">Contains</span><span class="op" id="537200">(</span><span class="ident" id="537201">got</span><span class="op" id="537204">,</span>&nbsp;<span class="string" id="537206">&#34;Content-Length:&nbsp;123&#34;</span><span class="op" id="537227">)</span>&nbsp;<span class="op" id="537229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="537233">t</span><span class="op" id="537234">.</span><span class="ident" id="537235">Errorf</span><span class="op" id="537241">(</span><span class="string" id="537242">&#34;Response&nbsp;=&nbsp;%q;&nbsp;don&#39;t&nbsp;want&nbsp;a&nbsp;Content-Length&#34;</span><span class="op" id="537286">,</span>&nbsp;<span class="ident" id="537288">got</span><span class="op" id="537291">)</span><br>
<span class="lineno">2275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="537294">}</span><br>
<span class="lineno"></span><span class="op" id="537296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="537299">//&nbsp;Issue&nbsp;6995</span><br>
<span class="lineno"></span><span class="comment" id="537313">//&nbsp;A&nbsp;server&nbsp;Handler&nbsp;can&nbsp;receive&nbsp;a&nbsp;Request,&nbsp;and&nbsp;then&nbsp;turn&nbsp;around&nbsp;and</span><br>
<span class="lineno">2280</span><span class="comment" id="537381">//&nbsp;give&nbsp;a&nbsp;copy&nbsp;of&nbsp;that&nbsp;Request.Body&nbsp;out&nbsp;to&nbsp;the&nbsp;Transport&nbsp;(e.g.&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="537448">//&nbsp;proxy).&nbsp;&nbsp;So&nbsp;then&nbsp;two&nbsp;people&nbsp;own&nbsp;that&nbsp;Request.Body&nbsp;(both&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="537518">//&nbsp;and&nbsp;the&nbsp;http&nbsp;client),&nbsp;and&nbsp;both&nbsp;think&nbsp;they&nbsp;can&nbsp;close&nbsp;it&nbsp;on&nbsp;failure.</span><br>
<span class="lineno"></span><span class="comment" id="537588">//&nbsp;Therefore,&nbsp;all&nbsp;incoming&nbsp;server&nbsp;requests&nbsp;Bodies&nbsp;need&nbsp;to&nbsp;be&nbsp;thread-safe.</span><br>
<span class="lineno"></span><span class="keyword" id="537662">func</span>&nbsp;<span class="ident" id="537667">TestTransportAndServerSharedBodyRace</span><span class="op" id="537703">(</span><span class="ident" id="537704">t</span>&nbsp;<span class="op" id="537706">*</span><span class="ident" id="537707">testing</span><span class="op" id="537714">.</span><span class="ident" id="537715">T</span><span class="op" id="537716">)</span>&nbsp;<span class="op" id="537718">{</span><br>
<span class="lineno">2285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="537721">defer</span>&nbsp;<span class="ident" id="537727">afterTest</span><span class="op" id="537736">(</span><span class="ident" id="537737">t</span><span class="op" id="537738">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="537742">const</span>&nbsp;<span class="ident" id="537748">bodySize</span>&nbsp;<span class="op" id="537757">=</span>&nbsp;<span class="num" id="537759">1</span>&nbsp;<span class="op" id="537761">&lt;&lt;</span>&nbsp;<span class="num" id="537764">20</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="537769">unblockBackend</span>&nbsp;<span class="op" id="537784">:=</span>&nbsp;<span class="builtinfunc" id="537787">make</span><span class="op" id="537791">(</span><span class="keyword" id="537792">chan</span>&nbsp;<span class="builtintype" id="537797">bool</span><span class="op" id="537801">)</span><br>
<span class="lineno">2290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="537804">backend</span>&nbsp;<span class="op" id="537812">:=</span>&nbsp;<span class="ident" id="537815">httptest</span><span class="op" id="537823">.</span><span class="ident" id="537824">NewServer</span><span class="op" id="537833">(</span><span class="ident" id="537834">HandlerFunc</span><span class="op" id="537845">(</span><span class="keyword" id="537846">func</span><span class="op" id="537850">(</span><span class="ident" id="537851">rw</span>&nbsp;<span class="ident" id="537854">ResponseWriter</span><span class="op" id="537868">,</span>&nbsp;<span class="ident" id="537870">req</span>&nbsp;<span class="op" id="537874">*</span><span class="ident" id="537875">Request</span><span class="op" id="537882">)</span>&nbsp;<span class="op" id="537884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="537888">io</span><span class="op" id="537890">.</span><span class="ident" id="537891">CopyN</span><span class="op" id="537896">(</span><span class="ident" id="537897">rw</span><span class="op" id="537899">,</span>&nbsp;<span class="ident" id="537901">req</span><span class="op" id="537904">.</span><span class="ident" id="537905">Body</span><span class="op" id="537909">,</span>&nbsp;<span class="ident" id="537911">bodySize</span><span class="op" id="537919">/</span><span class="num" id="537920">2</span><span class="op" id="537921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="537925">&lt;-</span><span class="ident" id="537927">unblockBackend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="537943">}</span><span class="op" id="537944">)</span><span class="op" id="537945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="537948">defer</span>&nbsp;<span class="ident" id="537954">backend</span><span class="op" id="537961">.</span><span class="ident" id="537962">Close</span><span class="op" id="537967">(</span><span class="op" id="537968">)</span><br>
<span class="lineno">2295</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="537972">backendRespc</span>&nbsp;<span class="op" id="537985">:=</span>&nbsp;<span class="builtinfunc" id="537988">make</span><span class="op" id="537992">(</span><span class="keyword" id="537993">chan</span>&nbsp;<span class="op" id="537998">*</span><span class="ident" id="537999">Response</span><span class="op" id="538007">,</span>&nbsp;<span class="num" id="538009">1</span><span class="op" id="538010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="538013">proxy</span>&nbsp;<span class="op" id="538019">:=</span>&nbsp;<span class="ident" id="538022">httptest</span><span class="op" id="538030">.</span><span class="ident" id="538031">NewServer</span><span class="op" id="538040">(</span><span class="ident" id="538041">HandlerFunc</span><span class="op" id="538052">(</span><span class="keyword" id="538053">func</span><span class="op" id="538057">(</span><span class="ident" id="538058">rw</span>&nbsp;<span class="ident" id="538061">ResponseWriter</span><span class="op" id="538075">,</span>&nbsp;<span class="ident" id="538077">req</span>&nbsp;<span class="op" id="538081">*</span><span class="ident" id="538082">Request</span><span class="op" id="538089">)</span>&nbsp;<span class="op" id="538091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="538095">if</span>&nbsp;<span class="ident" id="538098">req</span><span class="op" id="538101">.</span><span class="ident" id="538102">RequestURI</span>&nbsp;<span class="op" id="538113">==</span>&nbsp;<span class="string" id="538116">&#34;/foo&#34;</span>&nbsp;<span class="op" id="538123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="538128">rw</span><span class="op" id="538130">.</span><span class="ident" id="538131">Write</span><span class="op" id="538136">(</span><span class="op" id="538137">[</span><span class="op" id="538138">]</span><span class="builtintype" id="538139">byte</span><span class="op" id="538143">(</span><span class="string" id="538144">&#34;bar&#34;</span><span class="op" id="538149">)</span><span class="op" id="538150">)</span><br>
<span class="lineno">2300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="538155">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="538164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="538168">req2</span><span class="op" id="538172">,</span>&nbsp;<span class="ident" id="538174">_</span>&nbsp;<span class="op" id="538176">:=</span>&nbsp;<span class="ident" id="538179">NewRequest</span><span class="op" id="538189">(</span><span class="string" id="538190">&#34;POST&#34;</span><span class="op" id="538196">,</span>&nbsp;<span class="ident" id="538198">backend</span><span class="op" id="538205">.</span><span class="ident" id="538206">URL</span><span class="op" id="538209">,</span>&nbsp;<span class="ident" id="538211">req</span><span class="op" id="538214">.</span><span class="ident" id="538215">Body</span><span class="op" id="538219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="538223">req2</span><span class="op" id="538227">.</span><span class="ident" id="538228">ContentLength</span>&nbsp;<span class="op" id="538242">=</span>&nbsp;<span class="ident" id="538244">bodySize</span><br>
<span class="lineno"></span><br>
<span class="lineno">2305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="538256">bresp</span><span class="op" id="538261">,</span>&nbsp;<span class="ident" id="538263">err</span>&nbsp;<span class="op" id="538267">:=</span>&nbsp;<span class="ident" id="538270">DefaultClient</span><span class="op" id="538283">.</span><span class="ident" id="538284">Do</span><span class="op" id="538286">(</span><span class="ident" id="538287">req2</span><span class="op" id="538291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="538295">if</span>&nbsp;<span class="ident" id="538298">err</span>&nbsp;<span class="op" id="538302">!=</span>&nbsp;<span class="builtintype" id="538305">nil</span>&nbsp;<span class="op" id="538309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="538314">t</span><span class="op" id="538315">.</span><span class="ident" id="538316">Errorf</span><span class="op" id="538322">(</span><span class="string" id="538323">&#34;Proxy&nbsp;outbound&nbsp;request:&nbsp;%v&#34;</span><span class="op" id="538351">,</span>&nbsp;<span class="ident" id="538353">err</span><span class="op" id="538356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="538361">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="538370">}</span><br>
<span class="lineno">2310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="538374">_</span><span class="op" id="538375">,</span>&nbsp;<span class="ident" id="538377">err</span>&nbsp;<span class="op" id="538381">=</span>&nbsp;<span class="ident" id="538383">io</span><span class="op" id="538385">.</span><span class="ident" id="538386">CopyN</span><span class="op" id="538391">(</span><span class="ident" id="538392">ioutil</span><span class="op" id="538398">.</span><span class="ident" id="538399">Discard</span><span class="op" id="538406">,</span>&nbsp;<span class="ident" id="538408">bresp</span><span class="op" id="538413">.</span><span class="ident" id="538414">Body</span><span class="op" id="538418">,</span>&nbsp;<span class="ident" id="538420">bodySize</span><span class="op" id="538428">/</span><span class="num" id="538429">4</span><span class="op" id="538430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="538434">if</span>&nbsp;<span class="ident" id="538437">err</span>&nbsp;<span class="op" id="538441">!=</span>&nbsp;<span class="builtintype" id="538444">nil</span>&nbsp;<span class="op" id="538448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="538453">t</span><span class="op" id="538454">.</span><span class="ident" id="538455">Errorf</span><span class="op" id="538461">(</span><span class="string" id="538462">&#34;Proxy&nbsp;copy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="538484">,</span>&nbsp;<span class="ident" id="538486">err</span><span class="op" id="538489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="538494">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="538503">}</span><br>
<span class="lineno">2315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="538507">backendRespc</span>&nbsp;<span class="op" id="538520">&lt;-</span>&nbsp;<span class="ident" id="538523">bresp</span>&nbsp;<span class="comment" id="538529">//&nbsp;to&nbsp;close&nbsp;later</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="538550">//&nbsp;Try&nbsp;to&nbsp;cause&nbsp;a&nbsp;race:&nbsp;Both&nbsp;the&nbsp;DefaultTransport&nbsp;and&nbsp;the&nbsp;proxy&nbsp;handler&#39;s&nbsp;Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="538633">//&nbsp;will&nbsp;try&nbsp;to&nbsp;read/close&nbsp;req.Body&nbsp;(aka&nbsp;req2.Body)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="538686">DefaultTransport</span><span class="op" id="538702">.</span><span class="op" id="538703">(</span><span class="op" id="538704">*</span><span class="ident" id="538705">Transport</span><span class="op" id="538714">)</span><span class="op" id="538715">.</span><span class="ident" id="538716">CancelRequest</span><span class="op" id="538729">(</span><span class="ident" id="538730">req2</span><span class="op" id="538734">)</span><br>
<span class="lineno">2320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="538738">rw</span><span class="op" id="538740">.</span><span class="ident" id="538741">Write</span><span class="op" id="538746">(</span><span class="op" id="538747">[</span><span class="op" id="538748">]</span><span class="builtintype" id="538749">byte</span><span class="op" id="538753">(</span><span class="string" id="538754">&#34;OK&#34;</span><span class="op" id="538758">)</span><span class="op" id="538759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="538762">}</span><span class="op" id="538763">)</span><span class="op" id="538764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="538767">defer</span>&nbsp;<span class="ident" id="538773">proxy</span><span class="op" id="538778">.</span><span class="ident" id="538779">Close</span><span class="op" id="538784">(</span><span class="op" id="538785">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="538789">req</span><span class="op" id="538792">,</span>&nbsp;<span class="ident" id="538794">_</span>&nbsp;<span class="op" id="538796">:=</span>&nbsp;<span class="ident" id="538799">NewRequest</span><span class="op" id="538809">(</span><span class="string" id="538810">&#34;POST&#34;</span><span class="op" id="538816">,</span>&nbsp;<span class="ident" id="538818">proxy</span><span class="op" id="538823">.</span><span class="ident" id="538824">URL</span><span class="op" id="538827">,</span>&nbsp;<span class="ident" id="538829">io</span><span class="op" id="538831">.</span><span class="ident" id="538832">LimitReader</span><span class="op" id="538843">(</span><span class="ident" id="538844">neverEnding</span><span class="op" id="538855">(</span><span class="string" id="538856">&#39;a&#39;</span><span class="op" id="538859">)</span><span class="op" id="538860">,</span>&nbsp;<span class="ident" id="538862">bodySize</span><span class="op" id="538870">)</span><span class="op" id="538871">)</span><br>
<span class="lineno">2325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="538874">res</span><span class="op" id="538877">,</span>&nbsp;<span class="ident" id="538879">err</span>&nbsp;<span class="op" id="538883">:=</span>&nbsp;<span class="ident" id="538886">DefaultClient</span><span class="op" id="538899">.</span><span class="ident" id="538900">Do</span><span class="op" id="538902">(</span><span class="ident" id="538903">req</span><span class="op" id="538906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="538909">if</span>&nbsp;<span class="ident" id="538912">err</span>&nbsp;<span class="op" id="538916">!=</span>&nbsp;<span class="builtintype" id="538919">nil</span>&nbsp;<span class="op" id="538923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="538927">t</span><span class="op" id="538928">.</span><span class="ident" id="538929">Fatalf</span><span class="op" id="538935">(</span><span class="string" id="538936">&#34;Original&nbsp;request:&nbsp;%v&#34;</span><span class="op" id="538958">,</span>&nbsp;<span class="ident" id="538960">err</span><span class="op" id="538963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="538966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="538970">//&nbsp;Cleanup,&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;leak&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="539012">res</span><span class="op" id="539015">.</span><span class="ident" id="539016">Body</span><span class="op" id="539020">.</span><span class="ident" id="539021">Close</span><span class="op" id="539026">(</span><span class="op" id="539027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="539030">close</span><span class="op" id="539035">(</span><span class="ident" id="539036">unblockBackend</span><span class="op" id="539050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="539053">(</span><span class="op" id="539054">&lt;-</span><span class="ident" id="539056">backendRespc</span><span class="op" id="539068">)</span><span class="op" id="539069">.</span><span class="ident" id="539070">Body</span><span class="op" id="539074">.</span><span class="ident" id="539075">Close</span><span class="op" id="539080">(</span><span class="op" id="539081">)</span><br>
<span class="lineno"></span><span class="op" id="539083">}</span><br>
<span class="lineno">2335</span><br>
<span class="lineno"></span><span class="comment" id="539086">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;hanging&nbsp;Request.Body.Read&nbsp;from&nbsp;another&nbsp;goroutine&nbsp;can&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="539156">//&nbsp;cause&nbsp;the&nbsp;Handler&nbsp;goroutine&#39;s&nbsp;Request.Body.Close&nbsp;to&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="539218">func</span>&nbsp;<span class="ident" id="539223">TestRequestBodyCloseDoesntBlock</span><span class="op" id="539254">(</span><span class="ident" id="539255">t</span>&nbsp;<span class="op" id="539257">*</span><span class="ident" id="539258">testing</span><span class="op" id="539265">.</span><span class="ident" id="539266">T</span><span class="op" id="539267">)</span>&nbsp;<span class="op" id="539269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="539272">t</span><span class="op" id="539273">.</span><span class="ident" id="539274">Skipf</span><span class="op" id="539279">(</span><span class="string" id="539280">&#34;Skipping&nbsp;known&nbsp;issue;&nbsp;see&nbsp;golang.org/issue/7121&#34;</span><span class="op" id="539329">)</span><br>
<span class="lineno">2340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="539332">if</span>&nbsp;<span class="ident" id="539335">testing</span><span class="op" id="539342">.</span><span class="ident" id="539343">Short</span><span class="op" id="539348">(</span><span class="op" id="539349">)</span>&nbsp;<span class="op" id="539351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="539355">t</span><span class="op" id="539356">.</span><span class="ident" id="539357">Skip</span><span class="op" id="539361">(</span><span class="string" id="539362">&#34;skipping&nbsp;in&nbsp;-short&nbsp;mode&#34;</span><span class="op" id="539387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="539390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="539393">defer</span>&nbsp;<span class="ident" id="539399">afterTest</span><span class="op" id="539408">(</span><span class="ident" id="539409">t</span><span class="op" id="539410">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">2345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="539414">readErrCh</span>&nbsp;<span class="op" id="539424">:=</span>&nbsp;<span class="builtinfunc" id="539427">make</span><span class="op" id="539431">(</span><span class="keyword" id="539432">chan</span>&nbsp;<span class="builtintype" id="539437">error</span><span class="op" id="539442">,</span>&nbsp;<span class="num" id="539444">1</span><span class="op" id="539445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="539448">errCh</span>&nbsp;<span class="op" id="539454">:=</span>&nbsp;<span class="builtinfunc" id="539457">make</span><span class="op" id="539461">(</span><span class="keyword" id="539462">chan</span>&nbsp;<span class="builtintype" id="539467">error</span><span class="op" id="539472">,</span>&nbsp;<span class="num" id="539474">2</span><span class="op" id="539475">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="539479">server</span>&nbsp;<span class="op" id="539486">:=</span>&nbsp;<span class="ident" id="539489">httptest</span><span class="op" id="539497">.</span><span class="ident" id="539498">NewServer</span><span class="op" id="539507">(</span><span class="ident" id="539508">HandlerFunc</span><span class="op" id="539519">(</span><span class="keyword" id="539520">func</span><span class="op" id="539524">(</span><span class="ident" id="539525">rw</span>&nbsp;<span class="ident" id="539528">ResponseWriter</span><span class="op" id="539542">,</span>&nbsp;<span class="ident" id="539544">req</span>&nbsp;<span class="op" id="539548">*</span><span class="ident" id="539549">Request</span><span class="op" id="539556">)</span>&nbsp;<span class="op" id="539558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="539562">go</span>&nbsp;<span class="keyword" id="539565">func</span><span class="op" id="539569">(</span><span class="ident" id="539570">body</span>&nbsp;<span class="ident" id="539575">io</span><span class="op" id="539577">.</span><span class="ident" id="539578">Reader</span><span class="op" id="539584">)</span>&nbsp;<span class="op" id="539586">{</span><br>
<span class="lineno">2350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="539591">_</span><span class="op" id="539592">,</span>&nbsp;<span class="ident" id="539594">err</span>&nbsp;<span class="op" id="539598">:=</span>&nbsp;<span class="ident" id="539601">body</span><span class="op" id="539605">.</span><span class="ident" id="539606">Read</span><span class="op" id="539610">(</span><span class="builtinfunc" id="539611">make</span><span class="op" id="539615">(</span><span class="op" id="539616">[</span><span class="op" id="539617">]</span><span class="builtintype" id="539618">byte</span><span class="op" id="539622">,</span>&nbsp;<span class="num" id="539624">100</span><span class="op" id="539627">)</span><span class="op" id="539628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="539633">readErrCh</span>&nbsp;<span class="op" id="539643">&lt;-</span>&nbsp;<span class="ident" id="539646">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="539652">}</span><span class="op" id="539653">(</span><span class="ident" id="539654">req</span><span class="op" id="539657">.</span><span class="ident" id="539658">Body</span><span class="op" id="539662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="539666">time</span><span class="op" id="539670">.</span><span class="ident" id="539671">Sleep</span><span class="op" id="539676">(</span><span class="num" id="539677">500</span>&nbsp;<span class="op" id="539681">*</span>&nbsp;<span class="ident" id="539683">time</span><span class="op" id="539687">.</span><span class="ident" id="539688">Millisecond</span><span class="op" id="539699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="539702">}</span><span class="op" id="539703">)</span><span class="op" id="539704">)</span><br>
<span class="lineno">2355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="539707">defer</span>&nbsp;<span class="ident" id="539713">server</span><span class="op" id="539719">.</span><span class="ident" id="539720">Close</span><span class="op" id="539725">(</span><span class="op" id="539726">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="539730">closeConn</span>&nbsp;<span class="op" id="539740">:=</span>&nbsp;<span class="builtinfunc" id="539743">make</span><span class="op" id="539747">(</span><span class="keyword" id="539748">chan</span>&nbsp;<span class="builtintype" id="539753">bool</span><span class="op" id="539757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="539760">defer</span>&nbsp;<span class="builtinfunc" id="539766">close</span><span class="op" id="539771">(</span><span class="ident" id="539772">closeConn</span><span class="op" id="539781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="539784">go</span>&nbsp;<span class="keyword" id="539787">func</span><span class="op" id="539791">(</span><span class="op" id="539792">)</span>&nbsp;<span class="op" id="539794">{</span><br>
<span class="lineno">2360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="539798">conn</span><span class="op" id="539802">,</span>&nbsp;<span class="ident" id="539804">err</span>&nbsp;<span class="op" id="539808">:=</span>&nbsp;<span class="ident" id="539811">net</span><span class="op" id="539814">.</span><span class="ident" id="539815">Dial</span><span class="op" id="539819">(</span><span class="string" id="539820">&#34;tcp&#34;</span><span class="op" id="539825">,</span>&nbsp;<span class="ident" id="539827">server</span><span class="op" id="539833">.</span><span class="ident" id="539834">Listener</span><span class="op" id="539842">.</span><span class="ident" id="539843">Addr</span><span class="op" id="539847">(</span><span class="op" id="539848">)</span><span class="op" id="539849">.</span><span class="ident" id="539850">String</span><span class="op" id="539856">(</span><span class="op" id="539857">)</span><span class="op" id="539858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="539862">if</span>&nbsp;<span class="ident" id="539865">err</span>&nbsp;<span class="op" id="539869">!=</span>&nbsp;<span class="builtintype" id="539872">nil</span>&nbsp;<span class="op" id="539876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="539881">errCh</span>&nbsp;<span class="op" id="539887">&lt;-</span>&nbsp;<span class="ident" id="539890">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="539897">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="539906">}</span><br>
<span class="lineno">2365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="539910">defer</span>&nbsp;<span class="ident" id="539916">conn</span><span class="op" id="539920">.</span><span class="ident" id="539921">Close</span><span class="op" id="539926">(</span><span class="op" id="539927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="539931">_</span><span class="op" id="539932">,</span>&nbsp;<span class="ident" id="539934">err</span>&nbsp;<span class="op" id="539938">=</span>&nbsp;<span class="ident" id="539940">conn</span><span class="op" id="539944">.</span><span class="ident" id="539945">Write</span><span class="op" id="539950">(</span><span class="op" id="539951">[</span><span class="op" id="539952">]</span><span class="builtintype" id="539953">byte</span><span class="op" id="539957">(</span><span class="string" id="539958">&#34;POST&nbsp;/&nbsp;HTTP/1.1\r\nConnection:&nbsp;close\r\nHost:&nbsp;foo\r\nContent-Length:&nbsp;100000\r\n\r\n&#34;</span><span class="op" id="540043">)</span><span class="op" id="540044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="540048">if</span>&nbsp;<span class="ident" id="540051">err</span>&nbsp;<span class="op" id="540055">!=</span>&nbsp;<span class="builtintype" id="540058">nil</span>&nbsp;<span class="op" id="540062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="540067">errCh</span>&nbsp;<span class="op" id="540073">&lt;-</span>&nbsp;<span class="ident" id="540076">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="540083">return</span><br>
<span class="lineno">2370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="540092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="540096">//&nbsp;And&nbsp;now&nbsp;just&nbsp;block,&nbsp;making&nbsp;the&nbsp;server&nbsp;block&nbsp;on&nbsp;our</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="540152">//&nbsp;100000&nbsp;bytes&nbsp;of&nbsp;body&nbsp;that&nbsp;will&nbsp;never&nbsp;arrive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="540202">&lt;-</span><span class="ident" id="540204">closeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="540215">}</span><span class="op" id="540216">(</span><span class="op" id="540217">)</span><br>
<span class="lineno">2375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="540220">select</span>&nbsp;<span class="op" id="540227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="540230">case</span>&nbsp;<span class="ident" id="540235">err</span>&nbsp;<span class="op" id="540239">:=</span>&nbsp;<span class="op" id="540242">&lt;-</span><span class="ident" id="540244">readErrCh</span><span class="op" id="540253">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="540257">if</span>&nbsp;<span class="ident" id="540260">err</span>&nbsp;<span class="op" id="540264">==</span>&nbsp;<span class="builtintype" id="540267">nil</span>&nbsp;<span class="op" id="540271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="540276">t</span><span class="op" id="540277">.</span><span class="ident" id="540278">Error</span><span class="op" id="540283">(</span><span class="string" id="540284">&#34;Read&nbsp;was&nbsp;nil.&nbsp;Expected&nbsp;error.&#34;</span><span class="op" id="540315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="540319">}</span><br>
<span class="lineno">2380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="540322">case</span>&nbsp;<span class="ident" id="540327">err</span>&nbsp;<span class="op" id="540331">:=</span>&nbsp;<span class="op" id="540334">&lt;-</span><span class="ident" id="540336">errCh</span><span class="op" id="540341">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="540345">t</span><span class="op" id="540346">.</span><span class="ident" id="540347">Error</span><span class="op" id="540352">(</span><span class="ident" id="540353">err</span><span class="op" id="540356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="540359">case</span>&nbsp;<span class="op" id="540364">&lt;-</span><span class="ident" id="540366">time</span><span class="op" id="540370">.</span><span class="ident" id="540371">After</span><span class="op" id="540376">(</span><span class="num" id="540377">5</span>&nbsp;<span class="op" id="540379">*</span>&nbsp;<span class="ident" id="540381">time</span><span class="op" id="540385">.</span><span class="ident" id="540386">Second</span><span class="op" id="540392">)</span><span class="op" id="540393">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="540397">t</span><span class="op" id="540398">.</span><span class="ident" id="540399">Error</span><span class="op" id="540404">(</span><span class="string" id="540405">&#34;timeout&#34;</span><span class="op" id="540414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="540417">}</span><br>
<span class="lineno">2385</span><span class="op" id="540419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="540422">func</span>&nbsp;<span class="ident" id="540427">TestResponseWriterWriteStringAllocs</span><span class="op" id="540462">(</span><span class="ident" id="540463">t</span>&nbsp;<span class="op" id="540465">*</span><span class="ident" id="540466">testing</span><span class="op" id="540473">.</span><span class="ident" id="540474">T</span><span class="op" id="540475">)</span>&nbsp;<span class="op" id="540477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="540480">ht</span>&nbsp;<span class="op" id="540483">:=</span>&nbsp;<span class="ident" id="540486">newHandlerTest</span><span class="op" id="540500">(</span><span class="ident" id="540501">HandlerFunc</span><span class="op" id="540512">(</span><span class="keyword" id="540513">func</span><span class="op" id="540517">(</span><span class="ident" id="540518">w</span>&nbsp;<span class="ident" id="540520">ResponseWriter</span><span class="op" id="540534">,</span>&nbsp;<span class="ident" id="540536">r</span>&nbsp;<span class="op" id="540538">*</span><span class="ident" id="540539">Request</span><span class="op" id="540546">)</span>&nbsp;<span class="op" id="540548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="540552">if</span>&nbsp;<span class="ident" id="540555">r</span><span class="op" id="540556">.</span><span class="ident" id="540557">URL</span><span class="op" id="540560">.</span><span class="ident" id="540561">Path</span>&nbsp;<span class="op" id="540566">==</span>&nbsp;<span class="string" id="540569">&#34;/s&#34;</span>&nbsp;<span class="op" id="540574">{</span><br>
<span class="lineno">2390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="540579">io</span><span class="op" id="540581">.</span><span class="ident" id="540582">WriteString</span><span class="op" id="540593">(</span><span class="ident" id="540594">w</span><span class="op" id="540595">,</span>&nbsp;<span class="string" id="540597">&#34;Hello&nbsp;world&#34;</span><span class="op" id="540610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="540614">}</span>&nbsp;<span class="keyword" id="540616">else</span>&nbsp;<span class="op" id="540621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="540626">w</span><span class="op" id="540627">.</span><span class="ident" id="540628">Write</span><span class="op" id="540633">(</span><span class="op" id="540634">[</span><span class="op" id="540635">]</span><span class="builtintype" id="540636">byte</span><span class="op" id="540640">(</span><span class="string" id="540641">&#34;Hello&nbsp;world&#34;</span><span class="op" id="540654">)</span><span class="op" id="540655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="540659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="540662">}</span><span class="op" id="540663">)</span><span class="op" id="540664">)</span><br>
<span class="lineno">2395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="540667">before</span>&nbsp;<span class="op" id="540674">:=</span>&nbsp;<span class="ident" id="540677">testing</span><span class="op" id="540684">.</span><span class="ident" id="540685">AllocsPerRun</span><span class="op" id="540697">(</span><span class="num" id="540698">50</span><span class="op" id="540700">,</span>&nbsp;<span class="keyword" id="540702">func</span><span class="op" id="540706">(</span><span class="op" id="540707">)</span>&nbsp;<span class="op" id="540709">{</span>&nbsp;<span class="ident" id="540711">ht</span><span class="op" id="540713">.</span><span class="ident" id="540714">rawResponse</span><span class="op" id="540725">(</span><span class="string" id="540726">&#34;GET&nbsp;/&nbsp;HTTP/1.0&#34;</span><span class="op" id="540742">)</span>&nbsp;<span class="op" id="540744">}</span><span class="op" id="540745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="540748">after</span>&nbsp;<span class="op" id="540754">:=</span>&nbsp;<span class="ident" id="540757">testing</span><span class="op" id="540764">.</span><span class="ident" id="540765">AllocsPerRun</span><span class="op" id="540777">(</span><span class="num" id="540778">50</span><span class="op" id="540780">,</span>&nbsp;<span class="keyword" id="540782">func</span><span class="op" id="540786">(</span><span class="op" id="540787">)</span>&nbsp;<span class="op" id="540789">{</span>&nbsp;<span class="ident" id="540791">ht</span><span class="op" id="540793">.</span><span class="ident" id="540794">rawResponse</span><span class="op" id="540805">(</span><span class="string" id="540806">&#34;GET&nbsp;/s&nbsp;HTTP/1.0&#34;</span><span class="op" id="540823">)</span>&nbsp;<span class="op" id="540825">}</span><span class="op" id="540826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="540829">if</span>&nbsp;<span class="builtintype" id="540832">int</span><span class="op" id="540835">(</span><span class="ident" id="540836">after</span><span class="op" id="540841">)</span>&nbsp;<span class="op" id="540843">&gt;=</span>&nbsp;<span class="builtintype" id="540846">int</span><span class="op" id="540849">(</span><span class="ident" id="540850">before</span><span class="op" id="540856">)</span>&nbsp;<span class="op" id="540858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="540862">t</span><span class="op" id="540863">.</span><span class="ident" id="540864">Errorf</span><span class="op" id="540870">(</span><span class="string" id="540871">&#34;WriteString&nbsp;allocs&nbsp;of&nbsp;%v&nbsp;&gt;=&nbsp;Write&nbsp;allocs&nbsp;of&nbsp;%v&#34;</span><span class="op" id="540919">,</span>&nbsp;<span class="ident" id="540921">after</span><span class="op" id="540926">,</span>&nbsp;<span class="ident" id="540928">before</span><span class="op" id="540934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="540937">}</span><br>
<span class="lineno">2400</span><span class="op" id="540939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="540942">func</span>&nbsp;<span class="ident" id="540947">TestAppendTime</span><span class="op" id="540961">(</span><span class="ident" id="540962">t</span>&nbsp;<span class="op" id="540964">*</span><span class="ident" id="540965">testing</span><span class="op" id="540972">.</span><span class="ident" id="540973">T</span><span class="op" id="540974">)</span>&nbsp;<span class="op" id="540976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="540979">var</span>&nbsp;<span class="ident" id="540983">b</span>&nbsp;<span class="op" id="540985">[</span><span class="builtinfunc" id="540986">len</span><span class="op" id="540989">(</span><span class="ident" id="540990">TimeFormat</span><span class="op" id="541000">)</span><span class="op" id="541001">]</span><span class="builtintype" id="541002">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="541008">t1</span>&nbsp;<span class="op" id="541011">:=</span>&nbsp;<span class="ident" id="541014">time</span><span class="op" id="541018">.</span><span class="ident" id="541019">Date</span><span class="op" id="541023">(</span><span class="num" id="541024">2013</span><span class="op" id="541028">,</span>&nbsp;<span class="num" id="541030">9</span><span class="op" id="541031">,</span>&nbsp;<span class="num" id="541033">21</span><span class="op" id="541035">,</span>&nbsp;<span class="num" id="541037">15</span><span class="op" id="541039">,</span>&nbsp;<span class="num" id="541041">41</span><span class="op" id="541043">,</span>&nbsp;<span class="num" id="541045">0</span><span class="op" id="541046">,</span>&nbsp;<span class="num" id="541048">0</span><span class="op" id="541049">,</span>&nbsp;<span class="ident" id="541051">time</span><span class="op" id="541055">.</span><span class="ident" id="541056">FixedZone</span><span class="op" id="541065">(</span><span class="string" id="541066">&#34;CEST&#34;</span><span class="op" id="541072">,</span>&nbsp;<span class="num" id="541074">2</span><span class="op" id="541075">*</span><span class="num" id="541076">60</span><span class="op" id="541078">*</span><span class="num" id="541079">60</span><span class="op" id="541081">)</span><span class="op" id="541082">)</span><br>
<span class="lineno">2405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="541085">res</span>&nbsp;<span class="op" id="541089">:=</span>&nbsp;<span class="ident" id="541092">ExportAppendTime</span><span class="op" id="541108">(</span><span class="ident" id="541109">b</span><span class="op" id="541110">[</span><span class="op" id="541111">:</span><span class="num" id="541112">0</span><span class="op" id="541113">]</span><span class="op" id="541114">,</span>&nbsp;<span class="ident" id="541116">t1</span><span class="op" id="541118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="541121">t2</span><span class="op" id="541123">,</span>&nbsp;<span class="ident" id="541125">err</span>&nbsp;<span class="op" id="541129">:=</span>&nbsp;<span class="ident" id="541132">ParseTime</span><span class="op" id="541141">(</span><span class="builtintype" id="541142">string</span><span class="op" id="541148">(</span><span class="ident" id="541149">res</span><span class="op" id="541152">)</span><span class="op" id="541153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="541156">if</span>&nbsp;<span class="ident" id="541159">err</span>&nbsp;<span class="op" id="541163">!=</span>&nbsp;<span class="builtintype" id="541166">nil</span>&nbsp;<span class="op" id="541170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="541174">t</span><span class="op" id="541175">.</span><span class="ident" id="541176">Fatalf</span><span class="op" id="541182">(</span><span class="string" id="541183">&#34;Error&nbsp;parsing&nbsp;time:&nbsp;%s&#34;</span><span class="op" id="541207">,</span>&nbsp;<span class="ident" id="541209">err</span><span class="op" id="541212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="541215">}</span><br>
<span class="lineno">2410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="541218">if</span>&nbsp;<span class="op" id="541221">!</span><span class="ident" id="541222">t1</span><span class="op" id="541224">.</span><span class="ident" id="541225">Equal</span><span class="op" id="541230">(</span><span class="ident" id="541231">t2</span><span class="op" id="541233">)</span>&nbsp;<span class="op" id="541235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="541239">t</span><span class="op" id="541240">.</span><span class="ident" id="541241">Fatalf</span><span class="op" id="541247">(</span><span class="string" id="541248">&#34;Times&nbsp;differ;&nbsp;expected:&nbsp;%v,&nbsp;got&nbsp;%v&nbsp;(%s)&#34;</span><span class="op" id="541289">,</span>&nbsp;<span class="ident" id="541291">t1</span><span class="op" id="541293">,</span>&nbsp;<span class="ident" id="541295">t2</span><span class="op" id="541297">,</span>&nbsp;<span class="builtintype" id="541299">string</span><span class="op" id="541305">(</span><span class="ident" id="541306">res</span><span class="op" id="541309">)</span><span class="op" id="541310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="541313">}</span><br>
<span class="lineno"></span><span class="op" id="541315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2415</span><span class="keyword" id="541318">func</span>&nbsp;<span class="ident" id="541323">TestServerConnState</span><span class="op" id="541342">(</span><span class="ident" id="541343">t</span>&nbsp;<span class="op" id="541345">*</span><span class="ident" id="541346">testing</span><span class="op" id="541353">.</span><span class="ident" id="541354">T</span><span class="op" id="541355">)</span>&nbsp;<span class="op" id="541357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="541360">defer</span>&nbsp;<span class="ident" id="541366">afterTest</span><span class="op" id="541375">(</span><span class="ident" id="541376">t</span><span class="op" id="541377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="541380">handler</span>&nbsp;<span class="op" id="541388">:=</span>&nbsp;<span class="keyword" id="541391">map</span><span class="op" id="541394">[</span><span class="builtintype" id="541395">string</span><span class="op" id="541401">]</span><span class="keyword" id="541402">func</span><span class="op" id="541406">(</span><span class="ident" id="541407">w</span>&nbsp;<span class="ident" id="541409">ResponseWriter</span><span class="op" id="541423">,</span>&nbsp;<span class="ident" id="541425">r</span>&nbsp;<span class="op" id="541427">*</span><span class="ident" id="541428">Request</span><span class="op" id="541435">)</span><span class="op" id="541436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="541440">&#34;/&#34;</span><span class="op" id="541443">:</span>&nbsp;<span class="keyword" id="541445">func</span><span class="op" id="541449">(</span><span class="ident" id="541450">w</span>&nbsp;<span class="ident" id="541452">ResponseWriter</span><span class="op" id="541466">,</span>&nbsp;<span class="ident" id="541468">r</span>&nbsp;<span class="op" id="541470">*</span><span class="ident" id="541471">Request</span><span class="op" id="541478">)</span>&nbsp;<span class="op" id="541480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="541485">fmt</span><span class="op" id="541488">.</span><span class="ident" id="541489">Fprintf</span><span class="op" id="541496">(</span><span class="ident" id="541497">w</span><span class="op" id="541498">,</span>&nbsp;<span class="string" id="541500">&#34;Hello.&#34;</span><span class="op" id="541508">)</span><br>
<span class="lineno">2420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="541512">}</span><span class="op" id="541513">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="541517">&#34;/close&#34;</span><span class="op" id="541525">:</span>&nbsp;<span class="keyword" id="541527">func</span><span class="op" id="541531">(</span><span class="ident" id="541532">w</span>&nbsp;<span class="ident" id="541534">ResponseWriter</span><span class="op" id="541548">,</span>&nbsp;<span class="ident" id="541550">r</span>&nbsp;<span class="op" id="541552">*</span><span class="ident" id="541553">Request</span><span class="op" id="541560">)</span>&nbsp;<span class="op" id="541562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="541567">w</span><span class="op" id="541568">.</span><span class="ident" id="541569">Header</span><span class="op" id="541575">(</span><span class="op" id="541576">)</span><span class="op" id="541577">.</span><span class="ident" id="541578">Set</span><span class="op" id="541581">(</span><span class="string" id="541582">&#34;Connection&#34;</span><span class="op" id="541594">,</span>&nbsp;<span class="string" id="541596">&#34;close&#34;</span><span class="op" id="541603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="541608">fmt</span><span class="op" id="541611">.</span><span class="ident" id="541612">Fprintf</span><span class="op" id="541619">(</span><span class="ident" id="541620">w</span><span class="op" id="541621">,</span>&nbsp;<span class="string" id="541623">&#34;Hello.&#34;</span><span class="op" id="541631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="541635">}</span><span class="op" id="541636">,</span><br>
<span class="lineno">2425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="541640">&#34;/hijack&#34;</span><span class="op" id="541649">:</span>&nbsp;<span class="keyword" id="541651">func</span><span class="op" id="541655">(</span><span class="ident" id="541656">w</span>&nbsp;<span class="ident" id="541658">ResponseWriter</span><span class="op" id="541672">,</span>&nbsp;<span class="ident" id="541674">r</span>&nbsp;<span class="op" id="541676">*</span><span class="ident" id="541677">Request</span><span class="op" id="541684">)</span>&nbsp;<span class="op" id="541686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="541691">c</span><span class="op" id="541692">,</span>&nbsp;<span class="ident" id="541694">_</span><span class="op" id="541695">,</span>&nbsp;<span class="ident" id="541697">_</span>&nbsp;<span class="op" id="541699">:=</span>&nbsp;<span class="ident" id="541702">w</span><span class="op" id="541703">.</span><span class="op" id="541704">(</span><span class="ident" id="541705">Hijacker</span><span class="op" id="541713">)</span><span class="op" id="541714">.</span><span class="ident" id="541715">Hijack</span><span class="op" id="541721">(</span><span class="op" id="541722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="541727">c</span><span class="op" id="541728">.</span><span class="ident" id="541729">Write</span><span class="op" id="541734">(</span><span class="op" id="541735">[</span><span class="op" id="541736">]</span><span class="builtintype" id="541737">byte</span><span class="op" id="541741">(</span><span class="string" id="541742">&#34;HTTP/1.0&nbsp;200&nbsp;OK\r\nConnection:&nbsp;close\r\n\r\nHello.&#34;</span><span class="op" id="541794">)</span><span class="op" id="541795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="541800">c</span><span class="op" id="541801">.</span><span class="ident" id="541802">Close</span><span class="op" id="541807">(</span><span class="op" id="541808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="541812">}</span><span class="op" id="541813">,</span><br>
<span class="lineno">2430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="541817">&#34;/hijack-panic&#34;</span><span class="op" id="541832">:</span>&nbsp;<span class="keyword" id="541834">func</span><span class="op" id="541838">(</span><span class="ident" id="541839">w</span>&nbsp;<span class="ident" id="541841">ResponseWriter</span><span class="op" id="541855">,</span>&nbsp;<span class="ident" id="541857">r</span>&nbsp;<span class="op" id="541859">*</span><span class="ident" id="541860">Request</span><span class="op" id="541867">)</span>&nbsp;<span class="op" id="541869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="541874">c</span><span class="op" id="541875">,</span>&nbsp;<span class="ident" id="541877">_</span><span class="op" id="541878">,</span>&nbsp;<span class="ident" id="541880">_</span>&nbsp;<span class="op" id="541882">:=</span>&nbsp;<span class="ident" id="541885">w</span><span class="op" id="541886">.</span><span class="op" id="541887">(</span><span class="ident" id="541888">Hijacker</span><span class="op" id="541896">)</span><span class="op" id="541897">.</span><span class="ident" id="541898">Hijack</span><span class="op" id="541904">(</span><span class="op" id="541905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="541910">c</span><span class="op" id="541911">.</span><span class="ident" id="541912">Write</span><span class="op" id="541917">(</span><span class="op" id="541918">[</span><span class="op" id="541919">]</span><span class="builtintype" id="541920">byte</span><span class="op" id="541924">(</span><span class="string" id="541925">&#34;HTTP/1.0&nbsp;200&nbsp;OK\r\nConnection:&nbsp;close\r\n\r\nHello.&#34;</span><span class="op" id="541977">)</span><span class="op" id="541978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="541983">c</span><span class="op" id="541984">.</span><span class="ident" id="541985">Close</span><span class="op" id="541990">(</span><span class="op" id="541991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="541996">panic</span><span class="op" id="542001">(</span><span class="string" id="542002">&#34;intentional&nbsp;panic&#34;</span><span class="op" id="542021">)</span><br>
<span class="lineno">2435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="542025">}</span><span class="op" id="542026">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="542029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542032">ts</span>&nbsp;<span class="op" id="542035">:=</span>&nbsp;<span class="ident" id="542038">httptest</span><span class="op" id="542046">.</span><span class="ident" id="542047">NewUnstartedServer</span><span class="op" id="542065">(</span><span class="ident" id="542066">HandlerFunc</span><span class="op" id="542077">(</span><span class="keyword" id="542078">func</span><span class="op" id="542082">(</span><span class="ident" id="542083">w</span>&nbsp;<span class="ident" id="542085">ResponseWriter</span><span class="op" id="542099">,</span>&nbsp;<span class="ident" id="542101">r</span>&nbsp;<span class="op" id="542103">*</span><span class="ident" id="542104">Request</span><span class="op" id="542111">)</span>&nbsp;<span class="op" id="542113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542117">handler</span><span class="op" id="542124">[</span><span class="ident" id="542125">r</span><span class="op" id="542126">.</span><span class="ident" id="542127">URL</span><span class="op" id="542130">.</span><span class="ident" id="542131">Path</span><span class="op" id="542135">]</span><span class="op" id="542136">(</span><span class="ident" id="542137">w</span><span class="op" id="542138">,</span>&nbsp;<span class="ident" id="542140">r</span><span class="op" id="542141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="542144">}</span><span class="op" id="542145">)</span><span class="op" id="542146">)</span><br>
<span class="lineno">2440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="542149">defer</span>&nbsp;<span class="ident" id="542155">ts</span><span class="op" id="542157">.</span><span class="ident" id="542158">Close</span><span class="op" id="542163">(</span><span class="op" id="542164">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="542168">var</span>&nbsp;<span class="ident" id="542172">mu</span>&nbsp;<span class="ident" id="542175">sync</span><span class="op" id="542179">.</span><span class="ident" id="542180">Mutex</span>&nbsp;<span class="comment" id="542186">//&nbsp;guard&nbsp;stateLog&nbsp;and&nbsp;connID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="542216">var</span>&nbsp;<span class="ident" id="542220">stateLog</span>&nbsp;<span class="op" id="542229">=</span>&nbsp;<span class="keyword" id="542231">map</span><span class="op" id="542234">[</span><span class="builtintype" id="542235">int</span><span class="op" id="542238">]</span><span class="op" id="542239">[</span><span class="op" id="542240">]</span><span class="ident" id="542241">ConnState</span><span class="op" id="542250">{</span><span class="op" id="542251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="542254">var</span>&nbsp;<span class="ident" id="542258">connID</span>&nbsp;<span class="op" id="542265">=</span>&nbsp;<span class="keyword" id="542267">map</span><span class="op" id="542270">[</span><span class="ident" id="542271">net</span><span class="op" id="542274">.</span><span class="ident" id="542275">Conn</span><span class="op" id="542279">]</span><span class="builtintype" id="542280">int</span><span class="op" id="542283">{</span><span class="op" id="542284">}</span><br>
<span class="lineno">2445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542288">ts</span><span class="op" id="542290">.</span><span class="ident" id="542291">Config</span><span class="op" id="542297">.</span><span class="ident" id="542298">ErrorLog</span>&nbsp;<span class="op" id="542307">=</span>&nbsp;<span class="ident" id="542309">log</span><span class="op" id="542312">.</span><span class="ident" id="542313">New</span><span class="op" id="542316">(</span><span class="ident" id="542317">ioutil</span><span class="op" id="542323">.</span><span class="ident" id="542324">Discard</span><span class="op" id="542331">,</span>&nbsp;<span class="string" id="542333">&#34;&#34;</span><span class="op" id="542335">,</span>&nbsp;<span class="num" id="542337">0</span><span class="op" id="542338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542341">ts</span><span class="op" id="542343">.</span><span class="ident" id="542344">Config</span><span class="op" id="542350">.</span><span class="ident" id="542351">ConnState</span>&nbsp;<span class="op" id="542361">=</span>&nbsp;<span class="keyword" id="542363">func</span><span class="op" id="542367">(</span><span class="ident" id="542368">c</span>&nbsp;<span class="ident" id="542370">net</span><span class="op" id="542373">.</span><span class="ident" id="542374">Conn</span><span class="op" id="542378">,</span>&nbsp;<span class="ident" id="542380">state</span>&nbsp;<span class="ident" id="542386">ConnState</span><span class="op" id="542395">)</span>&nbsp;<span class="op" id="542397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="542401">if</span>&nbsp;<span class="ident" id="542404">c</span>&nbsp;<span class="op" id="542406">==</span>&nbsp;<span class="builtintype" id="542409">nil</span>&nbsp;<span class="op" id="542413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542418">t</span><span class="op" id="542419">.</span><span class="ident" id="542420">Errorf</span><span class="op" id="542426">(</span><span class="string" id="542427">&#34;nil&nbsp;conn&nbsp;seen&nbsp;in&nbsp;state&nbsp;%s&#34;</span><span class="op" id="542454">,</span>&nbsp;<span class="ident" id="542456">state</span><span class="op" id="542461">)</span><br>
<span class="lineno">2450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="542466">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="542475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542479">mu</span><span class="op" id="542481">.</span><span class="ident" id="542482">Lock</span><span class="op" id="542486">(</span><span class="op" id="542487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="542491">defer</span>&nbsp;<span class="ident" id="542497">mu</span><span class="op" id="542499">.</span><span class="ident" id="542500">Unlock</span><span class="op" id="542506">(</span><span class="op" id="542507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542511">id</span><span class="op" id="542513">,</span>&nbsp;<span class="ident" id="542515">ok</span>&nbsp;<span class="op" id="542518">:=</span>&nbsp;<span class="ident" id="542521">connID</span><span class="op" id="542527">[</span><span class="ident" id="542528">c</span><span class="op" id="542529">]</span><br>
<span class="lineno">2455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="542533">if</span>&nbsp;<span class="op" id="542536">!</span><span class="ident" id="542537">ok</span>&nbsp;<span class="op" id="542540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542545">id</span>&nbsp;<span class="op" id="542548">=</span>&nbsp;<span class="builtinfunc" id="542550">len</span><span class="op" id="542553">(</span><span class="ident" id="542554">connID</span><span class="op" id="542560">)</span>&nbsp;<span class="op" id="542562">+</span>&nbsp;<span class="num" id="542564">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542569">connID</span><span class="op" id="542575">[</span><span class="ident" id="542576">c</span><span class="op" id="542577">]</span>&nbsp;<span class="op" id="542579">=</span>&nbsp;<span class="ident" id="542581">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="542586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542590">stateLog</span><span class="op" id="542598">[</span><span class="ident" id="542599">id</span><span class="op" id="542601">]</span>&nbsp;<span class="op" id="542603">=</span>&nbsp;<span class="builtinfunc" id="542605">append</span><span class="op" id="542611">(</span><span class="ident" id="542612">stateLog</span><span class="op" id="542620">[</span><span class="ident" id="542621">id</span><span class="op" id="542623">]</span><span class="op" id="542624">,</span>&nbsp;<span class="ident" id="542626">state</span><span class="op" id="542631">)</span><br>
<span class="lineno">2460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="542634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542637">ts</span><span class="op" id="542639">.</span><span class="ident" id="542640">Start</span><span class="op" id="542645">(</span><span class="op" id="542646">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542650">mustGet</span><span class="op" id="542657">(</span><span class="ident" id="542658">t</span><span class="op" id="542659">,</span>&nbsp;<span class="ident" id="542661">ts</span><span class="op" id="542663">.</span><span class="ident" id="542664">URL</span><span class="op" id="542667">+</span><span class="string" id="542668">&#34;/&#34;</span><span class="op" id="542671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542674">mustGet</span><span class="op" id="542681">(</span><span class="ident" id="542682">t</span><span class="op" id="542683">,</span>&nbsp;<span class="ident" id="542685">ts</span><span class="op" id="542687">.</span><span class="ident" id="542688">URL</span><span class="op" id="542691">+</span><span class="string" id="542692">&#34;/close&#34;</span><span class="op" id="542700">)</span><br>
<span class="lineno">2465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542704">mustGet</span><span class="op" id="542711">(</span><span class="ident" id="542712">t</span><span class="op" id="542713">,</span>&nbsp;<span class="ident" id="542715">ts</span><span class="op" id="542717">.</span><span class="ident" id="542718">URL</span><span class="op" id="542721">+</span><span class="string" id="542722">&#34;/&#34;</span><span class="op" id="542725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542728">mustGet</span><span class="op" id="542735">(</span><span class="ident" id="542736">t</span><span class="op" id="542737">,</span>&nbsp;<span class="ident" id="542739">ts</span><span class="op" id="542741">.</span><span class="ident" id="542742">URL</span><span class="op" id="542745">+</span><span class="string" id="542746">&#34;/&#34;</span><span class="op" id="542749">,</span>&nbsp;<span class="string" id="542751">&#34;Connection&#34;</span><span class="op" id="542763">,</span>&nbsp;<span class="string" id="542765">&#34;close&#34;</span><span class="op" id="542772">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542776">mustGet</span><span class="op" id="542783">(</span><span class="ident" id="542784">t</span><span class="op" id="542785">,</span>&nbsp;<span class="ident" id="542787">ts</span><span class="op" id="542789">.</span><span class="ident" id="542790">URL</span><span class="op" id="542793">+</span><span class="string" id="542794">&#34;/hijack&#34;</span><span class="op" id="542803">)</span><br>
<span class="lineno">2470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542806">mustGet</span><span class="op" id="542813">(</span><span class="ident" id="542814">t</span><span class="op" id="542815">,</span>&nbsp;<span class="ident" id="542817">ts</span><span class="op" id="542819">.</span><span class="ident" id="542820">URL</span><span class="op" id="542823">+</span><span class="string" id="542824">&#34;/hijack-panic&#34;</span><span class="op" id="542839">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="542843">//&nbsp;New-&gt;Closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="542859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542863">c</span><span class="op" id="542864">,</span>&nbsp;<span class="ident" id="542866">err</span>&nbsp;<span class="op" id="542870">:=</span>&nbsp;<span class="ident" id="542873">net</span><span class="op" id="542876">.</span><span class="ident" id="542877">Dial</span><span class="op" id="542881">(</span><span class="string" id="542882">&#34;tcp&#34;</span><span class="op" id="542887">,</span>&nbsp;<span class="ident" id="542889">ts</span><span class="op" id="542891">.</span><span class="ident" id="542892">Listener</span><span class="op" id="542900">.</span><span class="ident" id="542901">Addr</span><span class="op" id="542905">(</span><span class="op" id="542906">)</span><span class="op" id="542907">.</span><span class="ident" id="542908">String</span><span class="op" id="542914">(</span><span class="op" id="542915">)</span><span class="op" id="542916">)</span><br>
<span class="lineno">2475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="542920">if</span>&nbsp;<span class="ident" id="542923">err</span>&nbsp;<span class="op" id="542927">!=</span>&nbsp;<span class="builtintype" id="542930">nil</span>&nbsp;<span class="op" id="542934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542939">t</span><span class="op" id="542940">.</span><span class="ident" id="542941">Fatal</span><span class="op" id="542946">(</span><span class="ident" id="542947">err</span><span class="op" id="542950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="542954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="542958">c</span><span class="op" id="542959">.</span><span class="ident" id="542960">Close</span><span class="op" id="542965">(</span><span class="op" id="542966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="542969">}</span><br>
<span class="lineno">2480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="542973">//&nbsp;New-&gt;Active-&gt;Closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="542997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="543001">c</span><span class="op" id="543002">,</span>&nbsp;<span class="ident" id="543004">err</span>&nbsp;<span class="op" id="543008">:=</span>&nbsp;<span class="ident" id="543011">net</span><span class="op" id="543014">.</span><span class="ident" id="543015">Dial</span><span class="op" id="543019">(</span><span class="string" id="543020">&#34;tcp&#34;</span><span class="op" id="543025">,</span>&nbsp;<span class="ident" id="543027">ts</span><span class="op" id="543029">.</span><span class="ident" id="543030">Listener</span><span class="op" id="543038">.</span><span class="ident" id="543039">Addr</span><span class="op" id="543043">(</span><span class="op" id="543044">)</span><span class="op" id="543045">.</span><span class="ident" id="543046">String</span><span class="op" id="543052">(</span><span class="op" id="543053">)</span><span class="op" id="543054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="543058">if</span>&nbsp;<span class="ident" id="543061">err</span>&nbsp;<span class="op" id="543065">!=</span>&nbsp;<span class="builtintype" id="543068">nil</span>&nbsp;<span class="op" id="543072">{</span><br>
<span class="lineno">2485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="543077">t</span><span class="op" id="543078">.</span><span class="ident" id="543079">Fatal</span><span class="op" id="543084">(</span><span class="ident" id="543085">err</span><span class="op" id="543088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="543092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="543096">if</span>&nbsp;<span class="ident" id="543099">_</span><span class="op" id="543100">,</span>&nbsp;<span class="ident" id="543102">err</span>&nbsp;<span class="op" id="543106">:=</span>&nbsp;<span class="ident" id="543109">io</span><span class="op" id="543111">.</span><span class="ident" id="543112">WriteString</span><span class="op" id="543123">(</span><span class="ident" id="543124">c</span><span class="op" id="543125">,</span>&nbsp;<span class="string" id="543127">&#34;BOGUS&nbsp;REQUEST\r\n\r\n&#34;</span><span class="op" id="543150">)</span><span class="op" id="543151">;</span>&nbsp;<span class="ident" id="543153">err</span>&nbsp;<span class="op" id="543157">!=</span>&nbsp;<span class="builtintype" id="543160">nil</span>&nbsp;<span class="op" id="543164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="543169">t</span><span class="op" id="543170">.</span><span class="ident" id="543171">Fatal</span><span class="op" id="543176">(</span><span class="ident" id="543177">err</span><span class="op" id="543180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="543184">}</span><br>
<span class="lineno">2490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="543188">c</span><span class="op" id="543189">.</span><span class="ident" id="543190">Close</span><span class="op" id="543195">(</span><span class="op" id="543196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="543199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="543203">//&nbsp;New-&gt;Idle-&gt;Closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="543225">{</span><br>
<span class="lineno">2495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="543229">c</span><span class="op" id="543230">,</span>&nbsp;<span class="ident" id="543232">err</span>&nbsp;<span class="op" id="543236">:=</span>&nbsp;<span class="ident" id="543239">net</span><span class="op" id="543242">.</span><span class="ident" id="543243">Dial</span><span class="op" id="543247">(</span><span class="string" id="543248">&#34;tcp&#34;</span><span class="op" id="543253">,</span>&nbsp;<span class="ident" id="543255">ts</span><span class="op" id="543257">.</span><span class="ident" id="543258">Listener</span><span class="op" id="543266">.</span><span class="ident" id="543267">Addr</span><span class="op" id="543271">(</span><span class="op" id="543272">)</span><span class="op" id="543273">.</span><span class="ident" id="543274">String</span><span class="op" id="543280">(</span><span class="op" id="543281">)</span><span class="op" id="543282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="543286">if</span>&nbsp;<span class="ident" id="543289">err</span>&nbsp;<span class="op" id="543293">!=</span>&nbsp;<span class="builtintype" id="543296">nil</span>&nbsp;<span class="op" id="543300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="543305">t</span><span class="op" id="543306">.</span><span class="ident" id="543307">Fatal</span><span class="op" id="543312">(</span><span class="ident" id="543313">err</span><span class="op" id="543316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="543320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="543324">if</span>&nbsp;<span class="ident" id="543327">_</span><span class="op" id="543328">,</span>&nbsp;<span class="ident" id="543330">err</span>&nbsp;<span class="op" id="543334">:=</span>&nbsp;<span class="ident" id="543337">io</span><span class="op" id="543339">.</span><span class="ident" id="543340">WriteString</span><span class="op" id="543351">(</span><span class="ident" id="543352">c</span><span class="op" id="543353">,</span>&nbsp;<span class="string" id="543355">&#34;GET&nbsp;/&nbsp;HTTP/1.1\r\nHost:&nbsp;foo\r\n\r\n&#34;</span><span class="op" id="543392">)</span><span class="op" id="543393">;</span>&nbsp;<span class="ident" id="543395">err</span>&nbsp;<span class="op" id="543399">!=</span>&nbsp;<span class="builtintype" id="543402">nil</span>&nbsp;<span class="op" id="543406">{</span><br>
<span class="lineno">2500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="543411">t</span><span class="op" id="543412">.</span><span class="ident" id="543413">Fatal</span><span class="op" id="543418">(</span><span class="ident" id="543419">err</span><span class="op" id="543422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="543426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="543430">res</span><span class="op" id="543433">,</span>&nbsp;<span class="ident" id="543435">err</span>&nbsp;<span class="op" id="543439">:=</span>&nbsp;<span class="ident" id="543442">ReadResponse</span><span class="op" id="543454">(</span><span class="ident" id="543455">bufio</span><span class="op" id="543460">.</span><span class="ident" id="543461">NewReader</span><span class="op" id="543470">(</span><span class="ident" id="543471">c</span><span class="op" id="543472">)</span><span class="op" id="543473">,</span>&nbsp;<span class="builtintype" id="543475">nil</span><span class="op" id="543478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="543482">if</span>&nbsp;<span class="ident" id="543485">err</span>&nbsp;<span class="op" id="543489">!=</span>&nbsp;<span class="builtintype" id="543492">nil</span>&nbsp;<span class="op" id="543496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="543501">t</span><span class="op" id="543502">.</span><span class="ident" id="543503">Fatal</span><span class="op" id="543508">(</span><span class="ident" id="543509">err</span><span class="op" id="543512">)</span><br>
<span class="lineno">2505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="543516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="543520">if</span>&nbsp;<span class="ident" id="543523">_</span><span class="op" id="543524">,</span>&nbsp;<span class="ident" id="543526">err</span>&nbsp;<span class="op" id="543530">:=</span>&nbsp;<span class="ident" id="543533">io</span><span class="op" id="543535">.</span><span class="ident" id="543536">Copy</span><span class="op" id="543540">(</span><span class="ident" id="543541">ioutil</span><span class="op" id="543547">.</span><span class="ident" id="543548">Discard</span><span class="op" id="543555">,</span>&nbsp;<span class="ident" id="543557">res</span><span class="op" id="543560">.</span><span class="ident" id="543561">Body</span><span class="op" id="543565">)</span><span class="op" id="543566">;</span>&nbsp;<span class="ident" id="543568">err</span>&nbsp;<span class="op" id="543572">!=</span>&nbsp;<span class="builtintype" id="543575">nil</span>&nbsp;<span class="op" id="543579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="543584">t</span><span class="op" id="543585">.</span><span class="ident" id="543586">Fatal</span><span class="op" id="543591">(</span><span class="ident" id="543592">err</span><span class="op" id="543595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="543599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="543603">c</span><span class="op" id="543604">.</span><span class="ident" id="543605">Close</span><span class="op" id="543610">(</span><span class="op" id="543611">)</span><br>
<span class="lineno">2510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="543614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="543618">want</span>&nbsp;<span class="op" id="543623">:=</span>&nbsp;<span class="keyword" id="543626">map</span><span class="op" id="543629">[</span><span class="builtintype" id="543630">int</span><span class="op" id="543633">]</span><span class="op" id="543634">[</span><span class="op" id="543635">]</span><span class="ident" id="543636">ConnState</span><span class="op" id="543645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="543649">1</span><span class="op" id="543650">:</span>&nbsp;<span class="op" id="543652">{</span><span class="ident" id="543653">StateNew</span><span class="op" id="543661">,</span>&nbsp;<span class="ident" id="543663">StateActive</span><span class="op" id="543674">,</span>&nbsp;<span class="ident" id="543676">StateIdle</span><span class="op" id="543685">,</span>&nbsp;<span class="ident" id="543687">StateActive</span><span class="op" id="543698">,</span>&nbsp;<span class="ident" id="543700">StateClosed</span><span class="op" id="543711">}</span><span class="op" id="543712">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="543716">2</span><span class="op" id="543717">:</span>&nbsp;<span class="op" id="543719">{</span><span class="ident" id="543720">StateNew</span><span class="op" id="543728">,</span>&nbsp;<span class="ident" id="543730">StateActive</span><span class="op" id="543741">,</span>&nbsp;<span class="ident" id="543743">StateIdle</span><span class="op" id="543752">,</span>&nbsp;<span class="ident" id="543754">StateActive</span><span class="op" id="543765">,</span>&nbsp;<span class="ident" id="543767">StateClosed</span><span class="op" id="543778">}</span><span class="op" id="543779">,</span><br>
<span class="lineno">2515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="543783">3</span><span class="op" id="543784">:</span>&nbsp;<span class="op" id="543786">{</span><span class="ident" id="543787">StateNew</span><span class="op" id="543795">,</span>&nbsp;<span class="ident" id="543797">StateActive</span><span class="op" id="543808">,</span>&nbsp;<span class="ident" id="543810">StateHijacked</span><span class="op" id="543823">}</span><span class="op" id="543824">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="543828">4</span><span class="op" id="543829">:</span>&nbsp;<span class="op" id="543831">{</span><span class="ident" id="543832">StateNew</span><span class="op" id="543840">,</span>&nbsp;<span class="ident" id="543842">StateActive</span><span class="op" id="543853">,</span>&nbsp;<span class="ident" id="543855">StateHijacked</span><span class="op" id="543868">}</span><span class="op" id="543869">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="543873">5</span><span class="op" id="543874">:</span>&nbsp;<span class="op" id="543876">{</span><span class="ident" id="543877">StateNew</span><span class="op" id="543885">,</span>&nbsp;<span class="ident" id="543887">StateClosed</span><span class="op" id="543898">}</span><span class="op" id="543899">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="543903">6</span><span class="op" id="543904">:</span>&nbsp;<span class="op" id="543906">{</span><span class="ident" id="543907">StateNew</span><span class="op" id="543915">,</span>&nbsp;<span class="ident" id="543917">StateActive</span><span class="op" id="543928">,</span>&nbsp;<span class="ident" id="543930">StateClosed</span><span class="op" id="543941">}</span><span class="op" id="543942">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="543946">7</span><span class="op" id="543947">:</span>&nbsp;<span class="op" id="543949">{</span><span class="ident" id="543950">StateNew</span><span class="op" id="543958">,</span>&nbsp;<span class="ident" id="543960">StateActive</span><span class="op" id="543971">,</span>&nbsp;<span class="ident" id="543973">StateIdle</span><span class="op" id="543982">,</span>&nbsp;<span class="ident" id="543984">StateClosed</span><span class="op" id="543995">}</span><span class="op" id="543996">,</span><br>
<span class="lineno">2520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="543999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544002">logString</span>&nbsp;<span class="op" id="544012">:=</span>&nbsp;<span class="keyword" id="544015">func</span><span class="op" id="544019">(</span><span class="ident" id="544020">m</span>&nbsp;<span class="keyword" id="544022">map</span><span class="op" id="544025">[</span><span class="builtintype" id="544026">int</span><span class="op" id="544029">]</span><span class="op" id="544030">[</span><span class="op" id="544031">]</span><span class="ident" id="544032">ConnState</span><span class="op" id="544041">)</span>&nbsp;<span class="builtintype" id="544043">string</span>&nbsp;<span class="op" id="544050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="544054">var</span>&nbsp;<span class="ident" id="544058">b</span>&nbsp;<span class="ident" id="544060">bytes</span><span class="op" id="544065">.</span><span class="ident" id="544066">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="544075">for</span>&nbsp;<span class="ident" id="544079">id</span><span class="op" id="544081">,</span>&nbsp;<span class="ident" id="544083">l</span>&nbsp;<span class="op" id="544085">:=</span>&nbsp;<span class="keyword" id="544088">range</span>&nbsp;<span class="ident" id="544094">m</span>&nbsp;<span class="op" id="544096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544101">fmt</span><span class="op" id="544104">.</span><span class="ident" id="544105">Fprintf</span><span class="op" id="544112">(</span><span class="op" id="544113">&amp;</span><span class="ident" id="544114">b</span><span class="op" id="544115">,</span>&nbsp;<span class="string" id="544117">&#34;Conn&nbsp;%d:&nbsp;&#34;</span><span class="op" id="544128">,</span>&nbsp;<span class="ident" id="544130">id</span><span class="op" id="544132">)</span><br>
<span class="lineno">2525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="544137">for</span>&nbsp;<span class="ident" id="544141">_</span><span class="op" id="544142">,</span>&nbsp;<span class="ident" id="544144">s</span>&nbsp;<span class="op" id="544146">:=</span>&nbsp;<span class="keyword" id="544149">range</span>&nbsp;<span class="ident" id="544155">l</span>&nbsp;<span class="op" id="544157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544163">fmt</span><span class="op" id="544166">.</span><span class="ident" id="544167">Fprintf</span><span class="op" id="544174">(</span><span class="op" id="544175">&amp;</span><span class="ident" id="544176">b</span><span class="op" id="544177">,</span>&nbsp;<span class="string" id="544179">&#34;%s&nbsp;&#34;</span><span class="op" id="544184">,</span>&nbsp;<span class="ident" id="544186">s</span><span class="op" id="544187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="544192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544197">b</span><span class="op" id="544198">.</span><span class="ident" id="544199">WriteString</span><span class="op" id="544210">(</span><span class="string" id="544211">&#34;\n&#34;</span><span class="op" id="544215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="544219">}</span><br>
<span class="lineno">2530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="544223">return</span>&nbsp;<span class="ident" id="544230">b</span><span class="op" id="544231">.</span><span class="ident" id="544232">String</span><span class="op" id="544238">(</span><span class="op" id="544239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="544242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="544246">for</span>&nbsp;<span class="ident" id="544250">i</span>&nbsp;<span class="op" id="544252">:=</span>&nbsp;<span class="num" id="544255">0</span><span class="op" id="544256">;</span>&nbsp;<span class="ident" id="544258">i</span>&nbsp;<span class="op" id="544260">&lt;</span>&nbsp;<span class="num" id="544262">5</span><span class="op" id="544263">;</span>&nbsp;<span class="ident" id="544265">i</span><span class="op" id="544266">++</span>&nbsp;<span class="op" id="544269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544273">time</span><span class="op" id="544277">.</span><span class="ident" id="544278">Sleep</span><span class="op" id="544283">(</span><span class="ident" id="544284">time</span><span class="op" id="544288">.</span><span class="ident" id="544289">Duration</span><span class="op" id="544297">(</span><span class="ident" id="544298">i</span><span class="op" id="544299">)</span>&nbsp;<span class="op" id="544301">*</span>&nbsp;<span class="num" id="544303">50</span>&nbsp;<span class="op" id="544306">*</span>&nbsp;<span class="ident" id="544308">time</span><span class="op" id="544312">.</span><span class="ident" id="544313">Millisecond</span><span class="op" id="544324">)</span><br>
<span class="lineno">2535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544328">mu</span><span class="op" id="544330">.</span><span class="ident" id="544331">Lock</span><span class="op" id="544335">(</span><span class="op" id="544336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544340">match</span>&nbsp;<span class="op" id="544346">:=</span>&nbsp;<span class="ident" id="544349">reflect</span><span class="op" id="544356">.</span><span class="ident" id="544357">DeepEqual</span><span class="op" id="544366">(</span><span class="ident" id="544367">stateLog</span><span class="op" id="544375">,</span>&nbsp;<span class="ident" id="544377">want</span><span class="op" id="544381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544385">mu</span><span class="op" id="544387">.</span><span class="ident" id="544388">Unlock</span><span class="op" id="544394">(</span><span class="op" id="544395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="544399">if</span>&nbsp;<span class="ident" id="544402">match</span>&nbsp;<span class="op" id="544408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="544413">return</span><br>
<span class="lineno">2540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="544422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="544425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544429">mu</span><span class="op" id="544431">.</span><span class="ident" id="544432">Lock</span><span class="op" id="544436">(</span><span class="op" id="544437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544440">t</span><span class="op" id="544441">.</span><span class="ident" id="544442">Errorf</span><span class="op" id="544448">(</span><span class="string" id="544449">&#34;Unexpected&nbsp;events.\nGot&nbsp;log:&nbsp;%s\n&nbsp;&nbsp;&nbsp;Want:&nbsp;%s\n&#34;</span><span class="op" id="544497">,</span>&nbsp;<span class="ident" id="544499">logString</span><span class="op" id="544508">(</span><span class="ident" id="544509">stateLog</span><span class="op" id="544517">)</span><span class="op" id="544518">,</span>&nbsp;<span class="ident" id="544520">logString</span><span class="op" id="544529">(</span><span class="ident" id="544530">want</span><span class="op" id="544534">)</span><span class="op" id="544535">)</span><br>
<span class="lineno">2545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544538">mu</span><span class="op" id="544540">.</span><span class="ident" id="544541">Unlock</span><span class="op" id="544547">(</span><span class="op" id="544548">)</span><br>
<span class="lineno"></span><span class="op" id="544550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="544553">func</span>&nbsp;<span class="ident" id="544558">mustGet</span><span class="op" id="544565">(</span><span class="ident" id="544566">t</span>&nbsp;<span class="op" id="544568">*</span><span class="ident" id="544569">testing</span><span class="op" id="544576">.</span><span class="ident" id="544577">T</span><span class="op" id="544578">,</span>&nbsp;<span class="ident" id="544580">url</span>&nbsp;<span class="builtintype" id="544584">string</span><span class="op" id="544590">,</span>&nbsp;<span class="ident" id="544592">headers</span>&nbsp;<span class="op" id="544600">...</span><span class="builtintype" id="544603">string</span><span class="op" id="544609">)</span>&nbsp;<span class="op" id="544611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544614">req</span><span class="op" id="544617">,</span>&nbsp;<span class="ident" id="544619">err</span>&nbsp;<span class="op" id="544623">:=</span>&nbsp;<span class="ident" id="544626">NewRequest</span><span class="op" id="544636">(</span><span class="string" id="544637">&#34;GET&#34;</span><span class="op" id="544642">,</span>&nbsp;<span class="ident" id="544644">url</span><span class="op" id="544647">,</span>&nbsp;<span class="builtintype" id="544649">nil</span><span class="op" id="544652">)</span><br>
<span class="lineno">2550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="544655">if</span>&nbsp;<span class="ident" id="544658">err</span>&nbsp;<span class="op" id="544662">!=</span>&nbsp;<span class="builtintype" id="544665">nil</span>&nbsp;<span class="op" id="544669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544673">t</span><span class="op" id="544674">.</span><span class="ident" id="544675">Fatal</span><span class="op" id="544680">(</span><span class="ident" id="544681">err</span><span class="op" id="544684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="544687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="544690">for</span>&nbsp;<span class="builtinfunc" id="544694">len</span><span class="op" id="544697">(</span><span class="ident" id="544698">headers</span><span class="op" id="544705">)</span>&nbsp;<span class="op" id="544707">&gt;</span>&nbsp;<span class="num" id="544709">0</span>&nbsp;<span class="op" id="544711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544715">req</span><span class="op" id="544718">.</span><span class="ident" id="544719">Header</span><span class="op" id="544725">.</span><span class="ident" id="544726">Add</span><span class="op" id="544729">(</span><span class="ident" id="544730">headers</span><span class="op" id="544737">[</span><span class="num" id="544738">0</span><span class="op" id="544739">]</span><span class="op" id="544740">,</span>&nbsp;<span class="ident" id="544742">headers</span><span class="op" id="544749">[</span><span class="num" id="544750">1</span><span class="op" id="544751">]</span><span class="op" id="544752">)</span><br>
<span class="lineno">2555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544756">headers</span>&nbsp;<span class="op" id="544764">=</span>&nbsp;<span class="ident" id="544766">headers</span><span class="op" id="544773">[</span><span class="num" id="544774">2</span><span class="op" id="544775">:</span><span class="op" id="544776">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="544779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544782">res</span><span class="op" id="544785">,</span>&nbsp;<span class="ident" id="544787">err</span>&nbsp;<span class="op" id="544791">:=</span>&nbsp;<span class="ident" id="544794">DefaultClient</span><span class="op" id="544807">.</span><span class="ident" id="544808">Do</span><span class="op" id="544810">(</span><span class="ident" id="544811">req</span><span class="op" id="544814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="544817">if</span>&nbsp;<span class="ident" id="544820">err</span>&nbsp;<span class="op" id="544824">!=</span>&nbsp;<span class="builtintype" id="544827">nil</span>&nbsp;<span class="op" id="544831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544835">t</span><span class="op" id="544836">.</span><span class="ident" id="544837">Errorf</span><span class="op" id="544843">(</span><span class="string" id="544844">&#34;Error&nbsp;fetching&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="544867">,</span>&nbsp;<span class="ident" id="544869">url</span><span class="op" id="544872">,</span>&nbsp;<span class="ident" id="544874">err</span><span class="op" id="544877">)</span><br>
<span class="lineno">2560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="544881">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="544889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544892">_</span><span class="op" id="544893">,</span>&nbsp;<span class="ident" id="544895">err</span>&nbsp;<span class="op" id="544899">=</span>&nbsp;<span class="ident" id="544901">ioutil</span><span class="op" id="544907">.</span><span class="ident" id="544908">ReadAll</span><span class="op" id="544915">(</span><span class="ident" id="544916">res</span><span class="op" id="544919">.</span><span class="ident" id="544920">Body</span><span class="op" id="544924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="544927">defer</span>&nbsp;<span class="ident" id="544933">res</span><span class="op" id="544936">.</span><span class="ident" id="544937">Body</span><span class="op" id="544941">.</span><span class="ident" id="544942">Close</span><span class="op" id="544947">(</span><span class="op" id="544948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="544951">if</span>&nbsp;<span class="ident" id="544954">err</span>&nbsp;<span class="op" id="544958">!=</span>&nbsp;<span class="builtintype" id="544961">nil</span>&nbsp;<span class="op" id="544965">{</span><br>
<span class="lineno">2565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="544969">t</span><span class="op" id="544970">.</span><span class="ident" id="544971">Errorf</span><span class="op" id="544977">(</span><span class="string" id="544978">&#34;Error&nbsp;reading&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="545000">,</span>&nbsp;<span class="ident" id="545002">url</span><span class="op" id="545005">,</span>&nbsp;<span class="ident" id="545007">err</span><span class="op" id="545010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="545013">}</span><br>
<span class="lineno"></span><span class="op" id="545015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="545018">func</span>&nbsp;<span class="ident" id="545023">TestServerKeepAlivesEnabled</span><span class="op" id="545050">(</span><span class="ident" id="545051">t</span>&nbsp;<span class="op" id="545053">*</span><span class="ident" id="545054">testing</span><span class="op" id="545061">.</span><span class="ident" id="545062">T</span><span class="op" id="545063">)</span>&nbsp;<span class="op" id="545065">{</span><br>
<span class="lineno">2570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545068">defer</span>&nbsp;<span class="ident" id="545074">afterTest</span><span class="op" id="545083">(</span><span class="ident" id="545084">t</span><span class="op" id="545085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="545088">ts</span>&nbsp;<span class="op" id="545091">:=</span>&nbsp;<span class="ident" id="545094">httptest</span><span class="op" id="545102">.</span><span class="ident" id="545103">NewUnstartedServer</span><span class="op" id="545121">(</span><span class="ident" id="545122">HandlerFunc</span><span class="op" id="545133">(</span><span class="keyword" id="545134">func</span><span class="op" id="545138">(</span><span class="ident" id="545139">w</span>&nbsp;<span class="ident" id="545141">ResponseWriter</span><span class="op" id="545155">,</span>&nbsp;<span class="ident" id="545157">r</span>&nbsp;<span class="op" id="545159">*</span><span class="ident" id="545160">Request</span><span class="op" id="545167">)</span>&nbsp;<span class="op" id="545169">{</span><span class="op" id="545170">}</span><span class="op" id="545171">)</span><span class="op" id="545172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="545175">ts</span><span class="op" id="545177">.</span><span class="ident" id="545178">Config</span><span class="op" id="545184">.</span><span class="ident" id="545185">SetKeepAlivesEnabled</span><span class="op" id="545205">(</span><span class="builtintype" id="545206">false</span><span class="op" id="545211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="545214">ts</span><span class="op" id="545216">.</span><span class="ident" id="545217">Start</span><span class="op" id="545222">(</span><span class="op" id="545223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545226">defer</span>&nbsp;<span class="ident" id="545232">ts</span><span class="op" id="545234">.</span><span class="ident" id="545235">Close</span><span class="op" id="545240">(</span><span class="op" id="545241">)</span><br>
<span class="lineno">2575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="545244">res</span><span class="op" id="545247">,</span>&nbsp;<span class="ident" id="545249">err</span>&nbsp;<span class="op" id="545253">:=</span>&nbsp;<span class="ident" id="545256">Get</span><span class="op" id="545259">(</span><span class="ident" id="545260">ts</span><span class="op" id="545262">.</span><span class="ident" id="545263">URL</span><span class="op" id="545266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545269">if</span>&nbsp;<span class="ident" id="545272">err</span>&nbsp;<span class="op" id="545276">!=</span>&nbsp;<span class="builtintype" id="545279">nil</span>&nbsp;<span class="op" id="545283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="545287">t</span><span class="op" id="545288">.</span><span class="ident" id="545289">Fatal</span><span class="op" id="545294">(</span><span class="ident" id="545295">err</span><span class="op" id="545298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="545301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545304">defer</span>&nbsp;<span class="ident" id="545310">res</span><span class="op" id="545313">.</span><span class="ident" id="545314">Body</span><span class="op" id="545318">.</span><span class="ident" id="545319">Close</span><span class="op" id="545324">(</span><span class="op" id="545325">)</span><br>
<span class="lineno">2580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545328">if</span>&nbsp;<span class="op" id="545331">!</span><span class="ident" id="545332">res</span><span class="op" id="545335">.</span><span class="ident" id="545336">Close</span>&nbsp;<span class="op" id="545342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="545346">t</span><span class="op" id="545347">.</span><span class="ident" id="545348">Errorf</span><span class="op" id="545354">(</span><span class="string" id="545355">&#34;Body.Close&nbsp;==&nbsp;false;&nbsp;want&nbsp;true&#34;</span><span class="op" id="545387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="545390">}</span><br>
<span class="lineno"></span><span class="op" id="545392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2585</span><span class="comment" id="545395">//&nbsp;golang.org/issue/7856</span><br>
<span class="lineno"></span><span class="keyword" id="545420">func</span>&nbsp;<span class="ident" id="545425">TestServerEmptyBodyRace</span><span class="op" id="545448">(</span><span class="ident" id="545449">t</span>&nbsp;<span class="op" id="545451">*</span><span class="ident" id="545452">testing</span><span class="op" id="545459">.</span><span class="ident" id="545460">T</span><span class="op" id="545461">)</span>&nbsp;<span class="op" id="545463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545466">defer</span>&nbsp;<span class="ident" id="545472">afterTest</span><span class="op" id="545481">(</span><span class="ident" id="545482">t</span><span class="op" id="545483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545486">var</span>&nbsp;<span class="ident" id="545490">n</span>&nbsp;<span class="builtintype" id="545492">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="545499">ts</span>&nbsp;<span class="op" id="545502">:=</span>&nbsp;<span class="ident" id="545505">httptest</span><span class="op" id="545513">.</span><span class="ident" id="545514">NewServer</span><span class="op" id="545523">(</span><span class="ident" id="545524">HandlerFunc</span><span class="op" id="545535">(</span><span class="keyword" id="545536">func</span><span class="op" id="545540">(</span><span class="ident" id="545541">rw</span>&nbsp;<span class="ident" id="545544">ResponseWriter</span><span class="op" id="545558">,</span>&nbsp;<span class="ident" id="545560">req</span>&nbsp;<span class="op" id="545564">*</span><span class="ident" id="545565">Request</span><span class="op" id="545572">)</span>&nbsp;<span class="op" id="545574">{</span><br>
<span class="lineno">2590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="545578">atomic</span><span class="op" id="545584">.</span><span class="ident" id="545585">AddInt32</span><span class="op" id="545593">(</span><span class="op" id="545594">&amp;</span><span class="ident" id="545595">n</span><span class="op" id="545596">,</span>&nbsp;<span class="num" id="545598">1</span><span class="op" id="545599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="545602">}</span><span class="op" id="545603">)</span><span class="op" id="545604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545607">defer</span>&nbsp;<span class="ident" id="545613">ts</span><span class="op" id="545615">.</span><span class="ident" id="545616">Close</span><span class="op" id="545621">(</span><span class="op" id="545622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545625">var</span>&nbsp;<span class="ident" id="545629">wg</span>&nbsp;<span class="ident" id="545632">sync</span><span class="op" id="545636">.</span><span class="ident" id="545637">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545648">const</span>&nbsp;<span class="ident" id="545654">reqs</span>&nbsp;<span class="op" id="545659">=</span>&nbsp;<span class="num" id="545661">20</span><br>
<span class="lineno">2595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545665">for</span>&nbsp;<span class="ident" id="545669">i</span>&nbsp;<span class="op" id="545671">:=</span>&nbsp;<span class="num" id="545674">0</span><span class="op" id="545675">;</span>&nbsp;<span class="ident" id="545677">i</span>&nbsp;<span class="op" id="545679">&lt;</span>&nbsp;<span class="ident" id="545681">reqs</span><span class="op" id="545685">;</span>&nbsp;<span class="ident" id="545687">i</span><span class="op" id="545688">++</span>&nbsp;<span class="op" id="545691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="545695">wg</span><span class="op" id="545697">.</span><span class="ident" id="545698">Add</span><span class="op" id="545701">(</span><span class="num" id="545702">1</span><span class="op" id="545703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545707">go</span>&nbsp;<span class="keyword" id="545710">func</span><span class="op" id="545714">(</span><span class="op" id="545715">)</span>&nbsp;<span class="op" id="545717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545722">defer</span>&nbsp;<span class="ident" id="545728">wg</span><span class="op" id="545730">.</span><span class="ident" id="545731">Done</span><span class="op" id="545735">(</span><span class="op" id="545736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="545741">res</span><span class="op" id="545744">,</span>&nbsp;<span class="ident" id="545746">err</span>&nbsp;<span class="op" id="545750">:=</span>&nbsp;<span class="ident" id="545753">Get</span><span class="op" id="545756">(</span><span class="ident" id="545757">ts</span><span class="op" id="545759">.</span><span class="ident" id="545760">URL</span><span class="op" id="545763">)</span><br>
<span class="lineno">2600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545768">if</span>&nbsp;<span class="ident" id="545771">err</span>&nbsp;<span class="op" id="545775">!=</span>&nbsp;<span class="builtintype" id="545778">nil</span>&nbsp;<span class="op" id="545782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="545788">t</span><span class="op" id="545789">.</span><span class="ident" id="545790">Error</span><span class="op" id="545795">(</span><span class="ident" id="545796">err</span><span class="op" id="545799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545805">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="545815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545820">defer</span>&nbsp;<span class="ident" id="545826">res</span><span class="op" id="545829">.</span><span class="ident" id="545830">Body</span><span class="op" id="545834">.</span><span class="ident" id="545835">Close</span><span class="op" id="545840">(</span><span class="op" id="545841">)</span><br>
<span class="lineno">2605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="545846">_</span><span class="op" id="545847">,</span>&nbsp;<span class="ident" id="545849">err</span>&nbsp;<span class="op" id="545853">=</span>&nbsp;<span class="ident" id="545855">io</span><span class="op" id="545857">.</span><span class="ident" id="545858">Copy</span><span class="op" id="545862">(</span><span class="ident" id="545863">ioutil</span><span class="op" id="545869">.</span><span class="ident" id="545870">Discard</span><span class="op" id="545877">,</span>&nbsp;<span class="ident" id="545879">res</span><span class="op" id="545882">.</span><span class="ident" id="545883">Body</span><span class="op" id="545887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545892">if</span>&nbsp;<span class="ident" id="545895">err</span>&nbsp;<span class="op" id="545899">!=</span>&nbsp;<span class="builtintype" id="545902">nil</span>&nbsp;<span class="op" id="545906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="545912">t</span><span class="op" id="545913">.</span><span class="ident" id="545914">Error</span><span class="op" id="545919">(</span><span class="ident" id="545920">err</span><span class="op" id="545923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545929">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="545939">}</span><br>
<span class="lineno">2610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="545943">}</span><span class="op" id="545944">(</span><span class="op" id="545945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="545948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="545951">wg</span><span class="op" id="545953">.</span><span class="ident" id="545954">Wait</span><span class="op" id="545958">(</span><span class="op" id="545959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="545962">if</span>&nbsp;<span class="ident" id="545965">got</span>&nbsp;<span class="op" id="545969">:=</span>&nbsp;<span class="ident" id="545972">atomic</span><span class="op" id="545978">.</span><span class="ident" id="545979">LoadInt32</span><span class="op" id="545988">(</span><span class="op" id="545989">&amp;</span><span class="ident" id="545990">n</span><span class="op" id="545991">)</span><span class="op" id="545992">;</span>&nbsp;<span class="ident" id="545994">got</span>&nbsp;<span class="op" id="545998">!=</span>&nbsp;<span class="ident" id="546001">reqs</span>&nbsp;<span class="op" id="546006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546010">t</span><span class="op" id="546011">.</span><span class="ident" id="546012">Errorf</span><span class="op" id="546018">(</span><span class="string" id="546019">&#34;handler&nbsp;ran&nbsp;%d&nbsp;times;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="546050">,</span>&nbsp;<span class="ident" id="546052">got</span><span class="op" id="546055">,</span>&nbsp;<span class="ident" id="546057">reqs</span><span class="op" id="546061">)</span><br>
<span class="lineno">2615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="546064">}</span><br>
<span class="lineno"></span><span class="op" id="546066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="546069">func</span>&nbsp;<span class="ident" id="546074">TestServerConnStateNew</span><span class="op" id="546096">(</span><span class="ident" id="546097">t</span>&nbsp;<span class="op" id="546099">*</span><span class="ident" id="546100">testing</span><span class="op" id="546107">.</span><span class="ident" id="546108">T</span><span class="op" id="546109">)</span>&nbsp;<span class="op" id="546111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546114">sawNew</span>&nbsp;<span class="op" id="546121">:=</span>&nbsp;<span class="builtintype" id="546124">false</span>&nbsp;<span class="comment" id="546130">//&nbsp;if&nbsp;the&nbsp;test&nbsp;is&nbsp;buggy,&nbsp;we&#39;ll&nbsp;race&nbsp;on&nbsp;this&nbsp;variable.</span><br>
<span class="lineno">2620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546185">srv</span>&nbsp;<span class="op" id="546189">:=</span>&nbsp;<span class="op" id="546192">&amp;</span><span class="ident" id="546193">Server</span><span class="op" id="546199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546203">ConnState</span><span class="op" id="546212">:</span>&nbsp;<span class="keyword" id="546214">func</span><span class="op" id="546218">(</span><span class="ident" id="546219">c</span>&nbsp;<span class="ident" id="546221">net</span><span class="op" id="546224">.</span><span class="ident" id="546225">Conn</span><span class="op" id="546229">,</span>&nbsp;<span class="ident" id="546231">state</span>&nbsp;<span class="ident" id="546237">ConnState</span><span class="op" id="546246">)</span>&nbsp;<span class="op" id="546248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="546253">if</span>&nbsp;<span class="ident" id="546256">state</span>&nbsp;<span class="op" id="546262">==</span>&nbsp;<span class="ident" id="546265">StateNew</span>&nbsp;<span class="op" id="546274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546280">sawNew</span>&nbsp;<span class="op" id="546287">=</span>&nbsp;<span class="builtintype" id="546289">true</span>&nbsp;<span class="comment" id="546294">//&nbsp;testing&nbsp;that&nbsp;this&nbsp;write&nbsp;isn&#39;t&nbsp;racy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="546335">}</span><br>
<span class="lineno">2625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="546339">}</span><span class="op" id="546340">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546344">Handler</span><span class="op" id="546351">:</span>&nbsp;<span class="ident" id="546353">HandlerFunc</span><span class="op" id="546364">(</span><span class="keyword" id="546365">func</span><span class="op" id="546369">(</span><span class="ident" id="546370">w</span>&nbsp;<span class="ident" id="546372">ResponseWriter</span><span class="op" id="546386">,</span>&nbsp;<span class="ident" id="546388">r</span>&nbsp;<span class="op" id="546390">*</span><span class="ident" id="546391">Request</span><span class="op" id="546398">)</span>&nbsp;<span class="op" id="546400">{</span><span class="op" id="546401">}</span><span class="op" id="546402">)</span><span class="op" id="546403">,</span>&nbsp;<span class="comment" id="546405">//&nbsp;irrelevant</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="546420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546423">srv</span><span class="op" id="546426">.</span><span class="ident" id="546427">Serve</span><span class="op" id="546432">(</span><span class="op" id="546433">&amp;</span><span class="ident" id="546434">oneConnListener</span><span class="op" id="546449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546453">conn</span><span class="op" id="546457">:</span>&nbsp;<span class="op" id="546459">&amp;</span><span class="ident" id="546460">rwTestConn</span><span class="op" id="546470">{</span><br>
<span class="lineno">2630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546475">Reader</span><span class="op" id="546481">:</span>&nbsp;<span class="ident" id="546483">strings</span><span class="op" id="546490">.</span><span class="ident" id="546491">NewReader</span><span class="op" id="546500">(</span><span class="string" id="546501">&#34;GET&nbsp;/&nbsp;HTTP/1.1\r\nHost:&nbsp;foo\r\n\r\n&#34;</span><span class="op" id="546538">)</span><span class="op" id="546539">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546544">Writer</span><span class="op" id="546550">:</span>&nbsp;<span class="ident" id="546552">ioutil</span><span class="op" id="546558">.</span><span class="ident" id="546559">Discard</span><span class="op" id="546566">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="546570">}</span><span class="op" id="546571">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="546574">}</span><span class="op" id="546575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="546578">if</span>&nbsp;<span class="op" id="546581">!</span><span class="ident" id="546582">sawNew</span>&nbsp;<span class="op" id="546589">{</span>&nbsp;<span class="comment" id="546591">//&nbsp;testing&nbsp;that&nbsp;this&nbsp;read&nbsp;isn&#39;t&nbsp;racy</span><br>
<span class="lineno">2635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546630">t</span><span class="op" id="546631">.</span><span class="ident" id="546632">Error</span><span class="op" id="546637">(</span><span class="string" id="546638">&#34;StateNew&nbsp;not&nbsp;seen&#34;</span><span class="op" id="546657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="546660">}</span><br>
<span class="lineno"></span><span class="op" id="546662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="546665">type</span>&nbsp;<span class="ident" id="546670">closeWriteTestConn</span>&nbsp;<span class="keyword" id="546689">struct</span>&nbsp;<span class="op" id="546696">{</span><br>
<span class="lineno">2640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546699">rwTestConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546711">didCloseWrite</span>&nbsp;<span class="builtintype" id="546725">bool</span><br>
<span class="lineno"></span><span class="op" id="546730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="546733">func</span>&nbsp;<span class="op" id="546738">(</span><span class="ident" id="546739">c</span>&nbsp;<span class="op" id="546741">*</span><span class="ident" id="546742">closeWriteTestConn</span><span class="op" id="546760">)</span>&nbsp;<span class="ident" id="546762">CloseWrite</span><span class="op" id="546772">(</span><span class="op" id="546773">)</span>&nbsp;<span class="builtintype" id="546775">error</span>&nbsp;<span class="op" id="546781">{</span><br>
<span class="lineno">2645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546784">c</span><span class="op" id="546785">.</span><span class="ident" id="546786">didCloseWrite</span>&nbsp;<span class="op" id="546800">=</span>&nbsp;<span class="builtintype" id="546802">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="546808">return</span>&nbsp;<span class="builtintype" id="546815">nil</span><br>
<span class="lineno"></span><span class="op" id="546819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="546822">func</span>&nbsp;<span class="ident" id="546827">TestCloseWrite</span><span class="op" id="546841">(</span><span class="ident" id="546842">t</span>&nbsp;<span class="op" id="546844">*</span><span class="ident" id="546845">testing</span><span class="op" id="546852">.</span><span class="ident" id="546853">T</span><span class="op" id="546854">)</span>&nbsp;<span class="op" id="546856">{</span><br>
<span class="lineno">2650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="546859">var</span>&nbsp;<span class="ident" id="546863">srv</span>&nbsp;<span class="ident" id="546867">Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="546875">var</span>&nbsp;<span class="ident" id="546879">testConn</span>&nbsp;<span class="ident" id="546888">closeWriteTestConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546908">c</span><span class="op" id="546909">,</span>&nbsp;<span class="ident" id="546911">err</span>&nbsp;<span class="op" id="546915">:=</span>&nbsp;<span class="ident" id="546918">ExportServerNewConn</span><span class="op" id="546937">(</span><span class="op" id="546938">&amp;</span><span class="ident" id="546939">srv</span><span class="op" id="546942">,</span>&nbsp;<span class="op" id="546944">&amp;</span><span class="ident" id="546945">testConn</span><span class="op" id="546953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="546956">if</span>&nbsp;<span class="ident" id="546959">err</span>&nbsp;<span class="op" id="546963">!=</span>&nbsp;<span class="builtintype" id="546966">nil</span>&nbsp;<span class="op" id="546970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546974">t</span><span class="op" id="546975">.</span><span class="ident" id="546976">Fatal</span><span class="op" id="546981">(</span><span class="ident" id="546982">err</span><span class="op" id="546985">)</span><br>
<span class="lineno">2655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="546988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="546991">ExportCloseWriteAndWait</span><span class="op" id="547014">(</span><span class="ident" id="547015">c</span><span class="op" id="547016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="547019">if</span>&nbsp;<span class="op" id="547022">!</span><span class="ident" id="547023">testConn</span><span class="op" id="547031">.</span><span class="ident" id="547032">didCloseWrite</span>&nbsp;<span class="op" id="547046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="547050">t</span><span class="op" id="547051">.</span><span class="ident" id="547052">Error</span><span class="op" id="547057">(</span><span class="string" id="547058">&#34;didn&#39;t&nbsp;see&nbsp;CloseWrite&nbsp;call&#34;</span><span class="op" id="547086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="547089">}</span><br>
<span class="lineno">2660</span><span class="op" id="547091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="547094">//&nbsp;This&nbsp;verifies&nbsp;that&nbsp;a&nbsp;handler&nbsp;can&nbsp;Flush&nbsp;and&nbsp;then&nbsp;Hijack.</span><br>
<span class="lineno"></span><span class="comment" id="547153">//</span><br>
<span class="lineno"></span><span class="comment" id="547156">//&nbsp;An&nbsp;similar&nbsp;test&nbsp;crashed&nbsp;once&nbsp;during&nbsp;development,&nbsp;but&nbsp;it&nbsp;was&nbsp;only</span><br>
<span class="lineno">2665</span><span class="comment" id="547224">//&nbsp;testing&nbsp;this&nbsp;tangentially&nbsp;and&nbsp;temporarily&nbsp;until&nbsp;another&nbsp;TODO&nbsp;was</span><br>
<span class="lineno"></span><span class="comment" id="547292">//&nbsp;fixed.</span><br>
<span class="lineno"></span><span class="comment" id="547302">//</span><br>
<span class="lineno"></span><span class="comment" id="547305">//&nbsp;So&nbsp;add&nbsp;an&nbsp;explicit&nbsp;test&nbsp;for&nbsp;this.</span><br>
<span class="lineno"></span><span class="keyword" id="547342">func</span>&nbsp;<span class="ident" id="547347">TestServerFlushAndHijack</span><span class="op" id="547371">(</span><span class="ident" id="547372">t</span>&nbsp;<span class="op" id="547374">*</span><span class="ident" id="547375">testing</span><span class="op" id="547382">.</span><span class="ident" id="547383">T</span><span class="op" id="547384">)</span>&nbsp;<span class="op" id="547386">{</span><br>
<span class="lineno">2670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="547389">defer</span>&nbsp;<span class="ident" id="547395">afterTest</span><span class="op" id="547404">(</span><span class="ident" id="547405">t</span><span class="op" id="547406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="547409">ts</span>&nbsp;<span class="op" id="547412">:=</span>&nbsp;<span class="ident" id="547415">httptest</span><span class="op" id="547423">.</span><span class="ident" id="547424">NewServer</span><span class="op" id="547433">(</span><span class="ident" id="547434">HandlerFunc</span><span class="op" id="547445">(</span><span class="keyword" id="547446">func</span><span class="op" id="547450">(</span><span class="ident" id="547451">w</span>&nbsp;<span class="ident" id="547453">ResponseWriter</span><span class="op" id="547467">,</span>&nbsp;<span class="ident" id="547469">r</span>&nbsp;<span class="op" id="547471">*</span><span class="ident" id="547472">Request</span><span class="op" id="547479">)</span>&nbsp;<span class="op" id="547481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="547485">io</span><span class="op" id="547487">.</span><span class="ident" id="547488">WriteString</span><span class="op" id="547499">(</span><span class="ident" id="547500">w</span><span class="op" id="547501">,</span>&nbsp;<span class="string" id="547503">&#34;Hello,&nbsp;&#34;</span><span class="op" id="547512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="547516">w</span><span class="op" id="547517">.</span><span class="op" id="547518">(</span><span class="ident" id="547519">Flusher</span><span class="op" id="547526">)</span><span class="op" id="547527">.</span><span class="ident" id="547528">Flush</span><span class="op" id="547533">(</span><span class="op" id="547534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="547538">conn</span><span class="op" id="547542">,</span>&nbsp;<span class="ident" id="547544">buf</span><span class="op" id="547547">,</span>&nbsp;<span class="ident" id="547549">_</span>&nbsp;<span class="op" id="547551">:=</span>&nbsp;<span class="ident" id="547554">w</span><span class="op" id="547555">.</span><span class="op" id="547556">(</span><span class="ident" id="547557">Hijacker</span><span class="op" id="547565">)</span><span class="op" id="547566">.</span><span class="ident" id="547567">Hijack</span><span class="op" id="547573">(</span><span class="op" id="547574">)</span><br>
<span class="lineno">2675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="547578">buf</span><span class="op" id="547581">.</span><span class="ident" id="547582">WriteString</span><span class="op" id="547593">(</span><span class="string" id="547594">&#34;6\r\nworld!\r\n0\r\n\r\n&#34;</span><span class="op" id="547620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="547624">if</span>&nbsp;<span class="ident" id="547627">err</span>&nbsp;<span class="op" id="547631">:=</span>&nbsp;<span class="ident" id="547634">buf</span><span class="op" id="547637">.</span><span class="ident" id="547638">Flush</span><span class="op" id="547643">(</span><span class="op" id="547644">)</span><span class="op" id="547645">;</span>&nbsp;<span class="ident" id="547647">err</span>&nbsp;<span class="op" id="547651">!=</span>&nbsp;<span class="builtintype" id="547654">nil</span>&nbsp;<span class="op" id="547658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="547663">t</span><span class="op" id="547664">.</span><span class="ident" id="547665">Error</span><span class="op" id="547670">(</span><span class="ident" id="547671">err</span><span class="op" id="547674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="547678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="547682">if</span>&nbsp;<span class="ident" id="547685">err</span>&nbsp;<span class="op" id="547689">:=</span>&nbsp;<span class="ident" id="547692">conn</span><span class="op" id="547696">.</span><span class="ident" id="547697">Close</span><span class="op" id="547702">(</span><span class="op" id="547703">)</span><span class="op" id="547704">;</span>&nbsp;<span class="ident" id="547706">err</span>&nbsp;<span class="op" id="547710">!=</span>&nbsp;<span class="builtintype" id="547713">nil</span>&nbsp;<span class="op" id="547717">{</span><br>
<span class="lineno">2680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="547722">t</span><span class="op" id="547723">.</span><span class="ident" id="547724">Error</span><span class="op" id="547729">(</span><span class="ident" id="547730">err</span><span class="op" id="547733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="547737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="547740">}</span><span class="op" id="547741">)</span><span class="op" id="547742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="547745">defer</span>&nbsp;<span class="ident" id="547751">ts</span><span class="op" id="547753">.</span><span class="ident" id="547754">Close</span><span class="op" id="547759">(</span><span class="op" id="547760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="547763">res</span><span class="op" id="547766">,</span>&nbsp;<span class="ident" id="547768">err</span>&nbsp;<span class="op" id="547772">:=</span>&nbsp;<span class="ident" id="547775">Get</span><span class="op" id="547778">(</span><span class="ident" id="547779">ts</span><span class="op" id="547781">.</span><span class="ident" id="547782">URL</span><span class="op" id="547785">)</span><br>
<span class="lineno">2685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="547788">if</span>&nbsp;<span class="ident" id="547791">err</span>&nbsp;<span class="op" id="547795">!=</span>&nbsp;<span class="builtintype" id="547798">nil</span>&nbsp;<span class="op" id="547802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="547806">t</span><span class="op" id="547807">.</span><span class="ident" id="547808">Fatal</span><span class="op" id="547813">(</span><span class="ident" id="547814">err</span><span class="op" id="547817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="547820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="547823">defer</span>&nbsp;<span class="ident" id="547829">res</span><span class="op" id="547832">.</span><span class="ident" id="547833">Body</span><span class="op" id="547837">.</span><span class="ident" id="547838">Close</span><span class="op" id="547843">(</span><span class="op" id="547844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="547847">all</span><span class="op" id="547850">,</span>&nbsp;<span class="ident" id="547852">err</span>&nbsp;<span class="op" id="547856">:=</span>&nbsp;<span class="ident" id="547859">ioutil</span><span class="op" id="547865">.</span><span class="ident" id="547866">ReadAll</span><span class="op" id="547873">(</span><span class="ident" id="547874">res</span><span class="op" id="547877">.</span><span class="ident" id="547878">Body</span><span class="op" id="547882">)</span><br>
<span class="lineno">2690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="547885">if</span>&nbsp;<span class="ident" id="547888">err</span>&nbsp;<span class="op" id="547892">!=</span>&nbsp;<span class="builtintype" id="547895">nil</span>&nbsp;<span class="op" id="547899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="547903">t</span><span class="op" id="547904">.</span><span class="ident" id="547905">Fatal</span><span class="op" id="547910">(</span><span class="ident" id="547911">err</span><span class="op" id="547914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="547917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="547920">if</span>&nbsp;<span class="ident" id="547923">want</span>&nbsp;<span class="op" id="547928">:=</span>&nbsp;<span class="string" id="547931">&#34;Hello,&nbsp;world!&#34;</span><span class="op" id="547946">;</span>&nbsp;<span class="builtintype" id="547948">string</span><span class="op" id="547954">(</span><span class="ident" id="547955">all</span><span class="op" id="547958">)</span>&nbsp;<span class="op" id="547960">!=</span>&nbsp;<span class="ident" id="547963">want</span>&nbsp;<span class="op" id="547968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="547972">t</span><span class="op" id="547973">.</span><span class="ident" id="547974">Errorf</span><span class="op" id="547980">(</span><span class="string" id="547981">&#34;Got&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="547998">,</span>&nbsp;<span class="ident" id="548000">all</span><span class="op" id="548003">,</span>&nbsp;<span class="ident" id="548005">want</span><span class="op" id="548009">)</span><br>
<span class="lineno">2695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="548012">}</span><br>
<span class="lineno"></span><span class="op" id="548014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="548017">//&nbsp;golang.org/issue/8534&nbsp;--&nbsp;the&nbsp;Server&nbsp;shouldn&#39;t&nbsp;reuse&nbsp;a&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="548085">//&nbsp;for&nbsp;keep-alive&nbsp;after&nbsp;it&#39;s&nbsp;seen&nbsp;any&nbsp;Write&nbsp;error&nbsp;(e.g.&nbsp;a&nbsp;timeout)&nbsp;on</span><br>
<span class="lineno">2700</span><span class="comment" id="548155">//&nbsp;that&nbsp;net.Conn.</span><br>
<span class="lineno"></span><span class="comment" id="548173">//</span><br>
<span class="lineno"></span><span class="comment" id="548176">//&nbsp;To&nbsp;test,&nbsp;verify&nbsp;we&nbsp;don&#39;t&nbsp;timeout&nbsp;or&nbsp;see&nbsp;fewer&nbsp;unique&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="548239">//&nbsp;addresses&nbsp;(==&nbsp;unique&nbsp;connections)&nbsp;than&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="548291">func</span>&nbsp;<span class="ident" id="548296">TestServerKeepAliveAfterWriteError</span><span class="op" id="548330">(</span><span class="ident" id="548331">t</span>&nbsp;<span class="op" id="548333">*</span><span class="ident" id="548334">testing</span><span class="op" id="548341">.</span><span class="ident" id="548342">T</span><span class="op" id="548343">)</span>&nbsp;<span class="op" id="548345">{</span><br>
<span class="lineno">2705</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="548348">if</span>&nbsp;<span class="ident" id="548351">testing</span><span class="op" id="548358">.</span><span class="ident" id="548359">Short</span><span class="op" id="548364">(</span><span class="op" id="548365">)</span>&nbsp;<span class="op" id="548367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="548371">t</span><span class="op" id="548372">.</span><span class="ident" id="548373">Skip</span><span class="op" id="548377">(</span><span class="string" id="548378">&#34;skipping&nbsp;in&nbsp;-short&nbsp;mode&#34;</span><span class="op" id="548403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="548406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="548409">defer</span>&nbsp;<span class="ident" id="548415">afterTest</span><span class="op" id="548424">(</span><span class="ident" id="548425">t</span><span class="op" id="548426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="548429">const</span>&nbsp;<span class="ident" id="548435">numReq</span>&nbsp;<span class="op" id="548442">=</span>&nbsp;<span class="num" id="548444">3</span><br>
<span class="lineno">2710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="548447">addrc</span>&nbsp;<span class="op" id="548453">:=</span>&nbsp;<span class="builtinfunc" id="548456">make</span><span class="op" id="548460">(</span><span class="keyword" id="548461">chan</span>&nbsp;<span class="builtintype" id="548466">string</span><span class="op" id="548472">,</span>&nbsp;<span class="ident" id="548474">numReq</span><span class="op" id="548480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="548483">ts</span>&nbsp;<span class="op" id="548486">:=</span>&nbsp;<span class="ident" id="548489">httptest</span><span class="op" id="548497">.</span><span class="ident" id="548498">NewUnstartedServer</span><span class="op" id="548516">(</span><span class="ident" id="548517">HandlerFunc</span><span class="op" id="548528">(</span><span class="keyword" id="548529">func</span><span class="op" id="548533">(</span><span class="ident" id="548534">w</span>&nbsp;<span class="ident" id="548536">ResponseWriter</span><span class="op" id="548550">,</span>&nbsp;<span class="ident" id="548552">r</span>&nbsp;<span class="op" id="548554">*</span><span class="ident" id="548555">Request</span><span class="op" id="548562">)</span>&nbsp;<span class="op" id="548564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="548568">addrc</span>&nbsp;<span class="op" id="548574">&lt;-</span>&nbsp;<span class="ident" id="548577">r</span><span class="op" id="548578">.</span><span class="ident" id="548579">RemoteAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="548592">time</span><span class="op" id="548596">.</span><span class="ident" id="548597">Sleep</span><span class="op" id="548602">(</span><span class="num" id="548603">500</span>&nbsp;<span class="op" id="548607">*</span>&nbsp;<span class="ident" id="548609">time</span><span class="op" id="548613">.</span><span class="ident" id="548614">Millisecond</span><span class="op" id="548625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="548629">w</span><span class="op" id="548630">.</span><span class="op" id="548631">(</span><span class="ident" id="548632">Flusher</span><span class="op" id="548639">)</span><span class="op" id="548640">.</span><span class="ident" id="548641">Flush</span><span class="op" id="548646">(</span><span class="op" id="548647">)</span><br>
<span class="lineno">2715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="548650">}</span><span class="op" id="548651">)</span><span class="op" id="548652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="548655">ts</span><span class="op" id="548657">.</span><span class="ident" id="548658">Config</span><span class="op" id="548664">.</span><span class="ident" id="548665">WriteTimeout</span>&nbsp;<span class="op" id="548678">=</span>&nbsp;<span class="num" id="548680">250</span>&nbsp;<span class="op" id="548684">*</span>&nbsp;<span class="ident" id="548686">time</span><span class="op" id="548690">.</span><span class="ident" id="548691">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="548704">ts</span><span class="op" id="548706">.</span><span class="ident" id="548707">Start</span><span class="op" id="548712">(</span><span class="op" id="548713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="548716">defer</span>&nbsp;<span class="ident" id="548722">ts</span><span class="op" id="548724">.</span><span class="ident" id="548725">Close</span><span class="op" id="548730">(</span><span class="op" id="548731">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">2720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="548735">errc</span>&nbsp;<span class="op" id="548740">:=</span>&nbsp;<span class="builtinfunc" id="548743">make</span><span class="op" id="548747">(</span><span class="keyword" id="548748">chan</span>&nbsp;<span class="builtintype" id="548753">error</span><span class="op" id="548758">,</span>&nbsp;<span class="ident" id="548760">numReq</span><span class="op" id="548766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="548769">go</span>&nbsp;<span class="keyword" id="548772">func</span><span class="op" id="548776">(</span><span class="op" id="548777">)</span>&nbsp;<span class="op" id="548779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="548783">defer</span>&nbsp;<span class="builtinfunc" id="548789">close</span><span class="op" id="548794">(</span><span class="ident" id="548795">errc</span><span class="op" id="548799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="548803">for</span>&nbsp;<span class="ident" id="548807">i</span>&nbsp;<span class="op" id="548809">:=</span>&nbsp;<span class="num" id="548812">0</span><span class="op" id="548813">;</span>&nbsp;<span class="ident" id="548815">i</span>&nbsp;<span class="op" id="548817">&lt;</span>&nbsp;<span class="ident" id="548819">numReq</span><span class="op" id="548825">;</span>&nbsp;<span class="ident" id="548827">i</span><span class="op" id="548828">++</span>&nbsp;<span class="op" id="548831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="548836">res</span><span class="op" id="548839">,</span>&nbsp;<span class="ident" id="548841">err</span>&nbsp;<span class="op" id="548845">:=</span>&nbsp;<span class="ident" id="548848">Get</span><span class="op" id="548851">(</span><span class="ident" id="548852">ts</span><span class="op" id="548854">.</span><span class="ident" id="548855">URL</span><span class="op" id="548858">)</span><br>
<span class="lineno">2725</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="548863">if</span>&nbsp;<span class="ident" id="548866">res</span>&nbsp;<span class="op" id="548870">!=</span>&nbsp;<span class="builtintype" id="548873">nil</span>&nbsp;<span class="op" id="548877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="548883">res</span><span class="op" id="548886">.</span><span class="ident" id="548887">Body</span><span class="op" id="548891">.</span><span class="ident" id="548892">Close</span><span class="op" id="548897">(</span><span class="op" id="548898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="548903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="548908">errc</span>&nbsp;<span class="op" id="548913">&lt;-</span>&nbsp;<span class="ident" id="548916">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="548922">}</span><br>
<span class="lineno">2730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="548925">}</span><span class="op" id="548926">(</span><span class="op" id="548927">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="548931">timeout</span>&nbsp;<span class="op" id="548939">:=</span>&nbsp;<span class="ident" id="548942">time</span><span class="op" id="548946">.</span><span class="ident" id="548947">NewTimer</span><span class="op" id="548955">(</span><span class="ident" id="548956">numReq</span>&nbsp;<span class="op" id="548963">*</span>&nbsp;<span class="num" id="548965">2</span>&nbsp;<span class="op" id="548967">*</span>&nbsp;<span class="ident" id="548969">time</span><span class="op" id="548973">.</span><span class="ident" id="548974">Second</span><span class="op" id="548980">)</span>&nbsp;<span class="comment" id="548982">//&nbsp;4x&nbsp;overkill</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="548998">defer</span>&nbsp;<span class="ident" id="549004">timeout</span><span class="op" id="549011">.</span><span class="ident" id="549012">Stop</span><span class="op" id="549016">(</span><span class="op" id="549017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549020">addrSeen</span>&nbsp;<span class="op" id="549029">:=</span>&nbsp;<span class="keyword" id="549032">map</span><span class="op" id="549035">[</span><span class="builtintype" id="549036">string</span><span class="op" id="549042">]</span><span class="builtintype" id="549043">bool</span><span class="op" id="549047">{</span><span class="op" id="549048">}</span><br>
<span class="lineno">2735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549051">numOkay</span>&nbsp;<span class="op" id="549059">:=</span>&nbsp;<span class="num" id="549062">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="549065">for</span>&nbsp;<span class="op" id="549069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="549073">select</span>&nbsp;<span class="op" id="549080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="549084">case</span>&nbsp;<span class="ident" id="549089">v</span>&nbsp;<span class="op" id="549091">:=</span>&nbsp;<span class="op" id="549094">&lt;-</span><span class="ident" id="549096">addrc</span><span class="op" id="549101">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549106">addrSeen</span><span class="op" id="549114">[</span><span class="ident" id="549115">v</span><span class="op" id="549116">]</span>&nbsp;<span class="op" id="549118">=</span>&nbsp;<span class="builtintype" id="549120">true</span><br>
<span class="lineno">2740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="549127">case</span>&nbsp;<span class="ident" id="549132">err</span><span class="op" id="549135">,</span>&nbsp;<span class="ident" id="549137">ok</span>&nbsp;<span class="op" id="549140">:=</span>&nbsp;<span class="op" id="549143">&lt;-</span><span class="ident" id="549145">errc</span><span class="op" id="549149">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="549154">if</span>&nbsp;<span class="op" id="549157">!</span><span class="ident" id="549158">ok</span>&nbsp;<span class="op" id="549161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="549167">if</span>&nbsp;<span class="builtinfunc" id="549170">len</span><span class="op" id="549173">(</span><span class="ident" id="549174">addrSeen</span><span class="op" id="549182">)</span>&nbsp;<span class="op" id="549184">!=</span>&nbsp;<span class="ident" id="549187">numReq</span>&nbsp;<span class="op" id="549194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549201">t</span><span class="op" id="549202">.</span><span class="ident" id="549203">Errorf</span><span class="op" id="549209">(</span><span class="string" id="549210">&#34;saw&nbsp;%d&nbsp;unique&nbsp;client&nbsp;addresses;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="549251">,</span>&nbsp;<span class="builtinfunc" id="549253">len</span><span class="op" id="549256">(</span><span class="ident" id="549257">addrSeen</span><span class="op" id="549265">)</span><span class="op" id="549266">,</span>&nbsp;<span class="ident" id="549268">numReq</span><span class="op" id="549274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="549280">}</span><br>
<span class="lineno">2745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="549286">if</span>&nbsp;<span class="ident" id="549289">numOkay</span>&nbsp;<span class="op" id="549297">!=</span>&nbsp;<span class="num" id="549300">0</span>&nbsp;<span class="op" id="549302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549309">t</span><span class="op" id="549310">.</span><span class="ident" id="549311">Errorf</span><span class="op" id="549317">(</span><span class="string" id="549318">&#34;got&nbsp;%d&nbsp;successful&nbsp;client&nbsp;requests;&nbsp;want&nbsp;0&#34;</span><span class="op" id="549361">,</span>&nbsp;<span class="ident" id="549363">numOkay</span><span class="op" id="549370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="549376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="549382">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="549392">}</span><br>
<span class="lineno">2750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="549397">if</span>&nbsp;<span class="ident" id="549400">err</span>&nbsp;<span class="op" id="549404">==</span>&nbsp;<span class="builtintype" id="549407">nil</span>&nbsp;<span class="op" id="549411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549417">numOkay</span><span class="op" id="549424">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="549430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="549434">case</span>&nbsp;<span class="op" id="549439">&lt;-</span><span class="ident" id="549441">timeout</span><span class="op" id="549448">.</span><span class="ident" id="549449">C</span><span class="op" id="549450">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549455">t</span><span class="op" id="549456">.</span><span class="ident" id="549457">Fatal</span><span class="op" id="549462">(</span><span class="string" id="549463">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;requests&nbsp;to&nbsp;complete&#34;</span><span class="op" id="549505">)</span><br>
<span class="lineno">2755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="549509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="549512">}</span><br>
<span class="lineno"></span><span class="op" id="549514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="549517">func</span>&nbsp;<span class="ident" id="549522">BenchmarkClientServer</span><span class="op" id="549543">(</span><span class="ident" id="549544">b</span>&nbsp;<span class="op" id="549546">*</span><span class="ident" id="549547">testing</span><span class="op" id="549554">.</span><span class="ident" id="549555">B</span><span class="op" id="549556">)</span>&nbsp;<span class="op" id="549558">{</span><br>
<span class="lineno">2760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549561">b</span><span class="op" id="549562">.</span><span class="ident" id="549563">ReportAllocs</span><span class="op" id="549575">(</span><span class="op" id="549576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549579">b</span><span class="op" id="549580">.</span><span class="ident" id="549581">StopTimer</span><span class="op" id="549590">(</span><span class="op" id="549591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549594">ts</span>&nbsp;<span class="op" id="549597">:=</span>&nbsp;<span class="ident" id="549600">httptest</span><span class="op" id="549608">.</span><span class="ident" id="549609">NewServer</span><span class="op" id="549618">(</span><span class="ident" id="549619">HandlerFunc</span><span class="op" id="549630">(</span><span class="keyword" id="549631">func</span><span class="op" id="549635">(</span><span class="ident" id="549636">rw</span>&nbsp;<span class="ident" id="549639">ResponseWriter</span><span class="op" id="549653">,</span>&nbsp;<span class="ident" id="549655">r</span>&nbsp;<span class="op" id="549657">*</span><span class="ident" id="549658">Request</span><span class="op" id="549665">)</span>&nbsp;<span class="op" id="549667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549671">fmt</span><span class="op" id="549674">.</span><span class="ident" id="549675">Fprintf</span><span class="op" id="549682">(</span><span class="ident" id="549683">rw</span><span class="op" id="549685">,</span>&nbsp;<span class="string" id="549687">&#34;Hello&nbsp;world.\n&#34;</span><span class="op" id="549703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="549706">}</span><span class="op" id="549707">)</span><span class="op" id="549708">)</span><br>
<span class="lineno">2765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="549711">defer</span>&nbsp;<span class="ident" id="549717">ts</span><span class="op" id="549719">.</span><span class="ident" id="549720">Close</span><span class="op" id="549725">(</span><span class="op" id="549726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549729">b</span><span class="op" id="549730">.</span><span class="ident" id="549731">StartTimer</span><span class="op" id="549741">(</span><span class="op" id="549742">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="549746">for</span>&nbsp;<span class="ident" id="549750">i</span>&nbsp;<span class="op" id="549752">:=</span>&nbsp;<span class="num" id="549755">0</span><span class="op" id="549756">;</span>&nbsp;<span class="ident" id="549758">i</span>&nbsp;<span class="op" id="549760">&lt;</span>&nbsp;<span class="ident" id="549762">b</span><span class="op" id="549763">.</span><span class="ident" id="549764">N</span><span class="op" id="549765">;</span>&nbsp;<span class="ident" id="549767">i</span><span class="op" id="549768">++</span>&nbsp;<span class="op" id="549771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549775">res</span><span class="op" id="549778">,</span>&nbsp;<span class="ident" id="549780">err</span>&nbsp;<span class="op" id="549784">:=</span>&nbsp;<span class="ident" id="549787">Get</span><span class="op" id="549790">(</span><span class="ident" id="549791">ts</span><span class="op" id="549793">.</span><span class="ident" id="549794">URL</span><span class="op" id="549797">)</span><br>
<span class="lineno">2770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="549801">if</span>&nbsp;<span class="ident" id="549804">err</span>&nbsp;<span class="op" id="549808">!=</span>&nbsp;<span class="builtintype" id="549811">nil</span>&nbsp;<span class="op" id="549815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549820">b</span><span class="op" id="549821">.</span><span class="ident" id="549822">Fatal</span><span class="op" id="549827">(</span><span class="string" id="549828">&#34;Get:&#34;</span><span class="op" id="549834">,</span>&nbsp;<span class="ident" id="549836">err</span><span class="op" id="549839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="549843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549847">all</span><span class="op" id="549850">,</span>&nbsp;<span class="ident" id="549852">err</span>&nbsp;<span class="op" id="549856">:=</span>&nbsp;<span class="ident" id="549859">ioutil</span><span class="op" id="549865">.</span><span class="ident" id="549866">ReadAll</span><span class="op" id="549873">(</span><span class="ident" id="549874">res</span><span class="op" id="549877">.</span><span class="ident" id="549878">Body</span><span class="op" id="549882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549886">res</span><span class="op" id="549889">.</span><span class="ident" id="549890">Body</span><span class="op" id="549894">.</span><span class="ident" id="549895">Close</span><span class="op" id="549900">(</span><span class="op" id="549901">)</span><br>
<span class="lineno">2775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="549905">if</span>&nbsp;<span class="ident" id="549908">err</span>&nbsp;<span class="op" id="549912">!=</span>&nbsp;<span class="builtintype" id="549915">nil</span>&nbsp;<span class="op" id="549919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549924">b</span><span class="op" id="549925">.</span><span class="ident" id="549926">Fatal</span><span class="op" id="549931">(</span><span class="string" id="549932">&#34;ReadAll:&#34;</span><span class="op" id="549942">,</span>&nbsp;<span class="ident" id="549944">err</span><span class="op" id="549947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="549951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="549955">body</span>&nbsp;<span class="op" id="549960">:=</span>&nbsp;<span class="builtintype" id="549963">string</span><span class="op" id="549969">(</span><span class="ident" id="549970">all</span><span class="op" id="549973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="549977">if</span>&nbsp;<span class="ident" id="549980">body</span>&nbsp;<span class="op" id="549985">!=</span>&nbsp;<span class="string" id="549988">&#34;Hello&nbsp;world.\n&#34;</span>&nbsp;<span class="op" id="550005">{</span><br>
<span class="lineno">2780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550010">b</span><span class="op" id="550011">.</span><span class="ident" id="550012">Fatal</span><span class="op" id="550017">(</span><span class="string" id="550018">&#34;Got&nbsp;body:&#34;</span><span class="op" id="550029">,</span>&nbsp;<span class="ident" id="550031">body</span><span class="op" id="550035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="550039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="550042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550046">b</span><span class="op" id="550047">.</span><span class="ident" id="550048">StopTimer</span><span class="op" id="550057">(</span><span class="op" id="550058">)</span><br>
<span class="lineno">2785</span><span class="op" id="550060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="550063">func</span>&nbsp;<span class="ident" id="550068">BenchmarkClientServerParallel4</span><span class="op" id="550098">(</span><span class="ident" id="550099">b</span>&nbsp;<span class="op" id="550101">*</span><span class="ident" id="550102">testing</span><span class="op" id="550109">.</span><span class="ident" id="550110">B</span><span class="op" id="550111">)</span>&nbsp;<span class="op" id="550113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550116">benchmarkClientServerParallel</span><span class="op" id="550145">(</span><span class="ident" id="550146">b</span><span class="op" id="550147">,</span>&nbsp;<span class="num" id="550149">4</span><span class="op" id="550150">,</span>&nbsp;<span class="builtintype" id="550152">false</span><span class="op" id="550157">)</span><br>
<span class="lineno"></span><span class="op" id="550159">}</span><br>
<span class="lineno">2790</span><br>
<span class="lineno"></span><span class="keyword" id="550162">func</span>&nbsp;<span class="ident" id="550167">BenchmarkClientServerParallel64</span><span class="op" id="550198">(</span><span class="ident" id="550199">b</span>&nbsp;<span class="op" id="550201">*</span><span class="ident" id="550202">testing</span><span class="op" id="550209">.</span><span class="ident" id="550210">B</span><span class="op" id="550211">)</span>&nbsp;<span class="op" id="550213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550216">benchmarkClientServerParallel</span><span class="op" id="550245">(</span><span class="ident" id="550246">b</span><span class="op" id="550247">,</span>&nbsp;<span class="num" id="550249">64</span><span class="op" id="550251">,</span>&nbsp;<span class="builtintype" id="550253">false</span><span class="op" id="550258">)</span><br>
<span class="lineno"></span><span class="op" id="550260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2795</span><span class="keyword" id="550263">func</span>&nbsp;<span class="ident" id="550268">BenchmarkClientServerParallelTLS4</span><span class="op" id="550301">(</span><span class="ident" id="550302">b</span>&nbsp;<span class="op" id="550304">*</span><span class="ident" id="550305">testing</span><span class="op" id="550312">.</span><span class="ident" id="550313">B</span><span class="op" id="550314">)</span>&nbsp;<span class="op" id="550316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550319">benchmarkClientServerParallel</span><span class="op" id="550348">(</span><span class="ident" id="550349">b</span><span class="op" id="550350">,</span>&nbsp;<span class="num" id="550352">4</span><span class="op" id="550353">,</span>&nbsp;<span class="builtintype" id="550355">true</span><span class="op" id="550359">)</span><br>
<span class="lineno"></span><span class="op" id="550361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="550364">func</span>&nbsp;<span class="ident" id="550369">BenchmarkClientServerParallelTLS64</span><span class="op" id="550403">(</span><span class="ident" id="550404">b</span>&nbsp;<span class="op" id="550406">*</span><span class="ident" id="550407">testing</span><span class="op" id="550414">.</span><span class="ident" id="550415">B</span><span class="op" id="550416">)</span>&nbsp;<span class="op" id="550418">{</span><br>
<span class="lineno">2800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550421">benchmarkClientServerParallel</span><span class="op" id="550450">(</span><span class="ident" id="550451">b</span><span class="op" id="550452">,</span>&nbsp;<span class="num" id="550454">64</span><span class="op" id="550456">,</span>&nbsp;<span class="builtintype" id="550458">true</span><span class="op" id="550462">)</span><br>
<span class="lineno"></span><span class="op" id="550464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="550467">func</span>&nbsp;<span class="ident" id="550472">benchmarkClientServerParallel</span><span class="op" id="550501">(</span><span class="ident" id="550502">b</span>&nbsp;<span class="op" id="550504">*</span><span class="ident" id="550505">testing</span><span class="op" id="550512">.</span><span class="ident" id="550513">B</span><span class="op" id="550514">,</span>&nbsp;<span class="ident" id="550516">parallelism</span>&nbsp;<span class="builtintype" id="550528">int</span><span class="op" id="550531">,</span>&nbsp;<span class="ident" id="550533">useTLS</span>&nbsp;<span class="builtintype" id="550540">bool</span><span class="op" id="550544">)</span>&nbsp;<span class="op" id="550546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550549">b</span><span class="op" id="550550">.</span><span class="ident" id="550551">ReportAllocs</span><span class="op" id="550563">(</span><span class="op" id="550564">)</span><br>
<span class="lineno">2805</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550567">ts</span>&nbsp;<span class="op" id="550570">:=</span>&nbsp;<span class="ident" id="550573">httptest</span><span class="op" id="550581">.</span><span class="ident" id="550582">NewUnstartedServer</span><span class="op" id="550600">(</span><span class="ident" id="550601">HandlerFunc</span><span class="op" id="550612">(</span><span class="keyword" id="550613">func</span><span class="op" id="550617">(</span><span class="ident" id="550618">rw</span>&nbsp;<span class="ident" id="550621">ResponseWriter</span><span class="op" id="550635">,</span>&nbsp;<span class="ident" id="550637">r</span>&nbsp;<span class="op" id="550639">*</span><span class="ident" id="550640">Request</span><span class="op" id="550647">)</span>&nbsp;<span class="op" id="550649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550653">fmt</span><span class="op" id="550656">.</span><span class="ident" id="550657">Fprintf</span><span class="op" id="550664">(</span><span class="ident" id="550665">rw</span><span class="op" id="550667">,</span>&nbsp;<span class="string" id="550669">&#34;Hello&nbsp;world.\n&#34;</span><span class="op" id="550685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="550688">}</span><span class="op" id="550689">)</span><span class="op" id="550690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="550693">if</span>&nbsp;<span class="ident" id="550696">useTLS</span>&nbsp;<span class="op" id="550703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550707">ts</span><span class="op" id="550709">.</span><span class="ident" id="550710">StartTLS</span><span class="op" id="550718">(</span><span class="op" id="550719">)</span><br>
<span class="lineno">2810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="550722">}</span>&nbsp;<span class="keyword" id="550724">else</span>&nbsp;<span class="op" id="550729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550733">ts</span><span class="op" id="550735">.</span><span class="ident" id="550736">Start</span><span class="op" id="550741">(</span><span class="op" id="550742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="550745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="550748">defer</span>&nbsp;<span class="ident" id="550754">ts</span><span class="op" id="550756">.</span><span class="ident" id="550757">Close</span><span class="op" id="550762">(</span><span class="op" id="550763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550766">b</span><span class="op" id="550767">.</span><span class="ident" id="550768">ResetTimer</span><span class="op" id="550778">(</span><span class="op" id="550779">)</span><br>
<span class="lineno">2815</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550782">b</span><span class="op" id="550783">.</span><span class="ident" id="550784">SetParallelism</span><span class="op" id="550798">(</span><span class="ident" id="550799">parallelism</span><span class="op" id="550810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550813">b</span><span class="op" id="550814">.</span><span class="ident" id="550815">RunParallel</span><span class="op" id="550826">(</span><span class="keyword" id="550827">func</span><span class="op" id="550831">(</span><span class="ident" id="550832">pb</span>&nbsp;<span class="op" id="550835">*</span><span class="ident" id="550836">testing</span><span class="op" id="550843">.</span><span class="ident" id="550844">PB</span><span class="op" id="550846">)</span>&nbsp;<span class="op" id="550848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550852">noVerifyTransport</span>&nbsp;<span class="op" id="550870">:=</span>&nbsp;<span class="op" id="550873">&amp;</span><span class="ident" id="550874">Transport</span><span class="op" id="550883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550888">TLSClientConfig</span><span class="op" id="550903">:</span>&nbsp;<span class="op" id="550905">&amp;</span><span class="ident" id="550906">tls</span><span class="op" id="550909">.</span><span class="ident" id="550910">Config</span><span class="op" id="550916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="550922">InsecureSkipVerify</span><span class="op" id="550940">:</span>&nbsp;<span class="builtintype" id="550942">true</span><span class="op" id="550946">,</span><br>
<span class="lineno">2820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="550951">}</span><span class="op" id="550952">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="550956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="550960">defer</span>&nbsp;<span class="ident" id="550966">noVerifyTransport</span><span class="op" id="550983">.</span><span class="ident" id="550984">CloseIdleConnections</span><span class="op" id="551004">(</span><span class="op" id="551005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="551009">client</span>&nbsp;<span class="op" id="551016">:=</span>&nbsp;<span class="op" id="551019">&amp;</span><span class="ident" id="551020">Client</span><span class="op" id="551026">{</span><span class="ident" id="551027">Transport</span><span class="op" id="551036">:</span>&nbsp;<span class="ident" id="551038">noVerifyTransport</span><span class="op" id="551055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="551059">for</span>&nbsp;<span class="ident" id="551063">pb</span><span class="op" id="551065">.</span><span class="ident" id="551066">Next</span><span class="op" id="551070">(</span><span class="op" id="551071">)</span>&nbsp;<span class="op" id="551073">{</span><br>
<span class="lineno">2825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="551078">res</span><span class="op" id="551081">,</span>&nbsp;<span class="ident" id="551083">err</span>&nbsp;<span class="op" id="551087">:=</span>&nbsp;<span class="ident" id="551090">client</span><span class="op" id="551096">.</span><span class="ident" id="551097">Get</span><span class="op" id="551100">(</span><span class="ident" id="551101">ts</span><span class="op" id="551103">.</span><span class="ident" id="551104">URL</span><span class="op" id="551107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="551112">if</span>&nbsp;<span class="ident" id="551115">err</span>&nbsp;<span class="op" id="551119">!=</span>&nbsp;<span class="builtintype" id="551122">nil</span>&nbsp;<span class="op" id="551126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="551132">b</span><span class="op" id="551133">.</span><span class="ident" id="551134">Logf</span><span class="op" id="551138">(</span><span class="string" id="551139">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="551148">,</span>&nbsp;<span class="ident" id="551150">err</span><span class="op" id="551153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="551159">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="551171">}</span><br>
<span class="lineno">2830</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="551176">all</span><span class="op" id="551179">,</span>&nbsp;<span class="ident" id="551181">err</span>&nbsp;<span class="op" id="551185">:=</span>&nbsp;<span class="ident" id="551188">ioutil</span><span class="op" id="551194">.</span><span class="ident" id="551195">ReadAll</span><span class="op" id="551202">(</span><span class="ident" id="551203">res</span><span class="op" id="551206">.</span><span class="ident" id="551207">Body</span><span class="op" id="551211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="551216">res</span><span class="op" id="551219">.</span><span class="ident" id="551220">Body</span><span class="op" id="551224">.</span><span class="ident" id="551225">Close</span><span class="op" id="551230">(</span><span class="op" id="551231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="551236">if</span>&nbsp;<span class="ident" id="551239">err</span>&nbsp;<span class="op" id="551243">!=</span>&nbsp;<span class="builtintype" id="551246">nil</span>&nbsp;<span class="op" id="551250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="551256">b</span><span class="op" id="551257">.</span><span class="ident" id="551258">Logf</span><span class="op" id="551262">(</span><span class="string" id="551263">&#34;ReadAll:&nbsp;%v&#34;</span><span class="op" id="551276">,</span>&nbsp;<span class="ident" id="551278">err</span><span class="op" id="551281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="551287">continue</span><br>
<span class="lineno">2835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="551299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="551304">body</span>&nbsp;<span class="op" id="551309">:=</span>&nbsp;<span class="builtintype" id="551312">string</span><span class="op" id="551318">(</span><span class="ident" id="551319">all</span><span class="op" id="551322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="551327">if</span>&nbsp;<span class="ident" id="551330">body</span>&nbsp;<span class="op" id="551335">!=</span>&nbsp;<span class="string" id="551338">&#34;Hello&nbsp;world.\n&#34;</span>&nbsp;<span class="op" id="551355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="551361">panic</span><span class="op" id="551366">(</span><span class="string" id="551367">&#34;Got&nbsp;body:&nbsp;&#34;</span>&nbsp;<span class="op" id="551380">+</span>&nbsp;<span class="ident" id="551382">body</span><span class="op" id="551386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="551391">}</span><br>
<span class="lineno">2840</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="551395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="551398">}</span><span class="op" id="551399">)</span><br>
<span class="lineno"></span><span class="op" id="551401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="551404">//&nbsp;A&nbsp;benchmark&nbsp;for&nbsp;profiling&nbsp;the&nbsp;server&nbsp;without&nbsp;the&nbsp;HTTP&nbsp;client&nbsp;code.</span><br>
<span class="lineno">2845</span><span class="comment" id="551474">//&nbsp;The&nbsp;client&nbsp;code&nbsp;runs&nbsp;in&nbsp;a&nbsp;subprocess.</span><br>
<span class="lineno"></span><span class="comment" id="551515">//</span><br>
<span class="lineno"></span><span class="comment" id="551518">//&nbsp;For&nbsp;use&nbsp;like:</span><br>
<span class="lineno"></span><span class="comment" id="551535">//&nbsp;&nbsp;&nbsp;$&nbsp;go&nbsp;test&nbsp;-c</span><br>
<span class="lineno"></span><span class="comment" id="551553">//&nbsp;&nbsp;&nbsp;$&nbsp;./http.test&nbsp;-test.run=XX&nbsp;-test.bench=BenchmarkServer&nbsp;-test.benchtime=15s&nbsp;-test.cpuprofile=http.prof</span><br>
<span class="lineno">2850</span><span class="comment" id="551660">//&nbsp;&nbsp;&nbsp;$&nbsp;go&nbsp;tool&nbsp;pprof&nbsp;http.test&nbsp;http.prof</span><br>
<span class="lineno"></span><span class="comment" id="551701">//&nbsp;&nbsp;&nbsp;(pprof)&nbsp;web</span><br>
<span class="lineno"></span><span class="keyword" id="551718">func</span>&nbsp;<span class="ident" id="551723">BenchmarkServer</span><span class="op" id="551738">(</span><span class="ident" id="551739">b</span>&nbsp;<span class="op" id="551741">*</span><span class="ident" id="551742">testing</span><span class="op" id="551749">.</span><span class="ident" id="551750">B</span><span class="op" id="551751">)</span>&nbsp;<span class="op" id="551753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="551756">b</span><span class="op" id="551757">.</span><span class="ident" id="551758">ReportAllocs</span><span class="op" id="551770">(</span><span class="op" id="551771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="551774">//&nbsp;Child&nbsp;process&nbsp;mode;</span><br>
<span class="lineno">2855</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="551798">if</span>&nbsp;<span class="ident" id="551801">url</span>&nbsp;<span class="op" id="551805">:=</span>&nbsp;<span class="ident" id="551808">os</span><span class="op" id="551810">.</span><span class="ident" id="551811">Getenv</span><span class="op" id="551817">(</span><span class="string" id="551818">&#34;TEST_BENCH_SERVER_URL&#34;</span><span class="op" id="551841">)</span><span class="op" id="551842">;</span>&nbsp;<span class="ident" id="551844">url</span>&nbsp;<span class="op" id="551848">!=</span>&nbsp;<span class="string" id="551851">&#34;&#34;</span>&nbsp;<span class="op" id="551854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="551858">n</span><span class="op" id="551859">,</span>&nbsp;<span class="ident" id="551861">err</span>&nbsp;<span class="op" id="551865">:=</span>&nbsp;<span class="ident" id="551868">strconv</span><span class="op" id="551875">.</span><span class="ident" id="551876">Atoi</span><span class="op" id="551880">(</span><span class="ident" id="551881">os</span><span class="op" id="551883">.</span><span class="ident" id="551884">Getenv</span><span class="op" id="551890">(</span><span class="string" id="551891">&#34;TEST_BENCH_CLIENT_N&#34;</span><span class="op" id="551912">)</span><span class="op" id="551913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="551917">if</span>&nbsp;<span class="ident" id="551920">err</span>&nbsp;<span class="op" id="551924">!=</span>&nbsp;<span class="builtintype" id="551927">nil</span>&nbsp;<span class="op" id="551931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="551936">panic</span><span class="op" id="551941">(</span><span class="ident" id="551942">err</span><span class="op" id="551945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="551949">}</span><br>
<span class="lineno">2860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="551953">for</span>&nbsp;<span class="ident" id="551957">i</span>&nbsp;<span class="op" id="551959">:=</span>&nbsp;<span class="num" id="551962">0</span><span class="op" id="551963">;</span>&nbsp;<span class="ident" id="551965">i</span>&nbsp;<span class="op" id="551967">&lt;</span>&nbsp;<span class="ident" id="551969">n</span><span class="op" id="551970">;</span>&nbsp;<span class="ident" id="551972">i</span><span class="op" id="551973">++</span>&nbsp;<span class="op" id="551976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="551981">res</span><span class="op" id="551984">,</span>&nbsp;<span class="ident" id="551986">err</span>&nbsp;<span class="op" id="551990">:=</span>&nbsp;<span class="ident" id="551993">Get</span><span class="op" id="551996">(</span><span class="ident" id="551997">url</span><span class="op" id="552000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="552005">if</span>&nbsp;<span class="ident" id="552008">err</span>&nbsp;<span class="op" id="552012">!=</span>&nbsp;<span class="builtintype" id="552015">nil</span>&nbsp;<span class="op" id="552019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552025">log</span><span class="op" id="552028">.</span><span class="ident" id="552029">Panicf</span><span class="op" id="552035">(</span><span class="string" id="552036">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="552045">,</span>&nbsp;<span class="ident" id="552047">err</span><span class="op" id="552050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="552055">}</span><br>
<span class="lineno">2865</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552060">all</span><span class="op" id="552063">,</span>&nbsp;<span class="ident" id="552065">err</span>&nbsp;<span class="op" id="552069">:=</span>&nbsp;<span class="ident" id="552072">ioutil</span><span class="op" id="552078">.</span><span class="ident" id="552079">ReadAll</span><span class="op" id="552086">(</span><span class="ident" id="552087">res</span><span class="op" id="552090">.</span><span class="ident" id="552091">Body</span><span class="op" id="552095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552100">res</span><span class="op" id="552103">.</span><span class="ident" id="552104">Body</span><span class="op" id="552108">.</span><span class="ident" id="552109">Close</span><span class="op" id="552114">(</span><span class="op" id="552115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="552120">if</span>&nbsp;<span class="ident" id="552123">err</span>&nbsp;<span class="op" id="552127">!=</span>&nbsp;<span class="builtintype" id="552130">nil</span>&nbsp;<span class="op" id="552134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552140">log</span><span class="op" id="552143">.</span><span class="ident" id="552144">Panicf</span><span class="op" id="552150">(</span><span class="string" id="552151">&#34;ReadAll:&nbsp;%v&#34;</span><span class="op" id="552164">,</span>&nbsp;<span class="ident" id="552166">err</span><span class="op" id="552169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="552174">}</span><br>
<span class="lineno">2870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552179">body</span>&nbsp;<span class="op" id="552184">:=</span>&nbsp;<span class="builtintype" id="552187">string</span><span class="op" id="552193">(</span><span class="ident" id="552194">all</span><span class="op" id="552197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="552202">if</span>&nbsp;<span class="ident" id="552205">body</span>&nbsp;<span class="op" id="552210">!=</span>&nbsp;<span class="string" id="552213">&#34;Hello&nbsp;world.\n&#34;</span>&nbsp;<span class="op" id="552230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552236">log</span><span class="op" id="552239">.</span><span class="ident" id="552240">Panicf</span><span class="op" id="552246">(</span><span class="string" id="552247">&#34;Got&nbsp;body:&nbsp;%q&#34;</span><span class="op" id="552261">,</span>&nbsp;<span class="ident" id="552263">body</span><span class="op" id="552267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="552272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="552276">}</span><br>
<span class="lineno">2875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552280">os</span><span class="op" id="552282">.</span><span class="ident" id="552283">Exit</span><span class="op" id="552287">(</span><span class="num" id="552288">0</span><span class="op" id="552289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="552293">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="552301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="552305">var</span>&nbsp;<span class="ident" id="552309">res</span>&nbsp;<span class="op" id="552313">=</span>&nbsp;<span class="op" id="552315">[</span><span class="op" id="552316">]</span><span class="builtintype" id="552317">byte</span><span class="op" id="552321">(</span><span class="string" id="552322">&#34;Hello&nbsp;world.\n&#34;</span><span class="op" id="552338">)</span><br>
<span class="lineno">2880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552341">b</span><span class="op" id="552342">.</span><span class="ident" id="552343">StopTimer</span><span class="op" id="552352">(</span><span class="op" id="552353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552356">ts</span>&nbsp;<span class="op" id="552359">:=</span>&nbsp;<span class="ident" id="552362">httptest</span><span class="op" id="552370">.</span><span class="ident" id="552371">NewServer</span><span class="op" id="552380">(</span><span class="ident" id="552381">HandlerFunc</span><span class="op" id="552392">(</span><span class="keyword" id="552393">func</span><span class="op" id="552397">(</span><span class="ident" id="552398">rw</span>&nbsp;<span class="ident" id="552401">ResponseWriter</span><span class="op" id="552415">,</span>&nbsp;<span class="ident" id="552417">r</span>&nbsp;<span class="op" id="552419">*</span><span class="ident" id="552420">Request</span><span class="op" id="552427">)</span>&nbsp;<span class="op" id="552429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552433">rw</span><span class="op" id="552435">.</span><span class="ident" id="552436">Header</span><span class="op" id="552442">(</span><span class="op" id="552443">)</span><span class="op" id="552444">.</span><span class="ident" id="552445">Set</span><span class="op" id="552448">(</span><span class="string" id="552449">&#34;Content-Type&#34;</span><span class="op" id="552463">,</span>&nbsp;<span class="string" id="552465">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="552491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552495">rw</span><span class="op" id="552497">.</span><span class="ident" id="552498">Write</span><span class="op" id="552503">(</span><span class="ident" id="552504">res</span><span class="op" id="552507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="552510">}</span><span class="op" id="552511">)</span><span class="op" id="552512">)</span><br>
<span class="lineno">2885</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="552515">defer</span>&nbsp;<span class="ident" id="552521">ts</span><span class="op" id="552523">.</span><span class="ident" id="552524">Close</span><span class="op" id="552529">(</span><span class="op" id="552530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552533">b</span><span class="op" id="552534">.</span><span class="ident" id="552535">StartTimer</span><span class="op" id="552545">(</span><span class="op" id="552546">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552550">cmd</span>&nbsp;<span class="op" id="552554">:=</span>&nbsp;<span class="ident" id="552557">exec</span><span class="op" id="552561">.</span><span class="ident" id="552562">Command</span><span class="op" id="552569">(</span><span class="ident" id="552570">os</span><span class="op" id="552572">.</span><span class="ident" id="552573">Args</span><span class="op" id="552577">[</span><span class="num" id="552578">0</span><span class="op" id="552579">]</span><span class="op" id="552580">,</span>&nbsp;<span class="string" id="552582">&#34;-test.run=XXXX&#34;</span><span class="op" id="552598">,</span>&nbsp;<span class="string" id="552600">&#34;-test.bench=BenchmarkServer&#34;</span><span class="op" id="552629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552632">cmd</span><span class="op" id="552635">.</span><span class="ident" id="552636">Env</span>&nbsp;<span class="op" id="552640">=</span>&nbsp;<span class="builtinfunc" id="552642">append</span><span class="op" id="552648">(</span><span class="op" id="552649">[</span><span class="op" id="552650">]</span><span class="builtintype" id="552651">string</span><span class="op" id="552657">{</span><br>
<span class="lineno">2890</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552661">fmt</span><span class="op" id="552664">.</span><span class="ident" id="552665">Sprintf</span><span class="op" id="552672">(</span><span class="string" id="552673">&#34;TEST_BENCH_CLIENT_N=%d&#34;</span><span class="op" id="552697">,</span>&nbsp;<span class="ident" id="552699">b</span><span class="op" id="552700">.</span><span class="ident" id="552701">N</span><span class="op" id="552702">)</span><span class="op" id="552703">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552707">fmt</span><span class="op" id="552710">.</span><span class="ident" id="552711">Sprintf</span><span class="op" id="552718">(</span><span class="string" id="552719">&#34;TEST_BENCH_SERVER_URL=%s&#34;</span><span class="op" id="552745">,</span>&nbsp;<span class="ident" id="552747">ts</span><span class="op" id="552749">.</span><span class="ident" id="552750">URL</span><span class="op" id="552753">)</span><span class="op" id="552754">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="552757">}</span><span class="op" id="552758">,</span>&nbsp;<span class="ident" id="552760">os</span><span class="op" id="552762">.</span><span class="ident" id="552763">Environ</span><span class="op" id="552770">(</span><span class="op" id="552771">)</span><span class="op" id="552772">...</span><span class="op" id="552775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552778">out</span><span class="op" id="552781">,</span>&nbsp;<span class="ident" id="552783">err</span>&nbsp;<span class="op" id="552787">:=</span>&nbsp;<span class="ident" id="552790">cmd</span><span class="op" id="552793">.</span><span class="ident" id="552794">CombinedOutput</span><span class="op" id="552808">(</span><span class="op" id="552809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="552812">if</span>&nbsp;<span class="ident" id="552815">err</span>&nbsp;<span class="op" id="552819">!=</span>&nbsp;<span class="builtintype" id="552822">nil</span>&nbsp;<span class="op" id="552826">{</span><br>
<span class="lineno">2895</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552830">b</span><span class="op" id="552831">.</span><span class="ident" id="552832">Errorf</span><span class="op" id="552838">(</span><span class="string" id="552839">&#34;Test&nbsp;failure:&nbsp;%v,&nbsp;with&nbsp;output:&nbsp;%s&#34;</span><span class="op" id="552874">,</span>&nbsp;<span class="ident" id="552876">err</span><span class="op" id="552879">,</span>&nbsp;<span class="ident" id="552881">out</span><span class="op" id="552884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="552887">}</span><br>
<span class="lineno"></span><span class="op" id="552889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="552892">func</span>&nbsp;<span class="ident" id="552897">BenchmarkServerFakeConnNoKeepAlive</span><span class="op" id="552931">(</span><span class="ident" id="552932">b</span>&nbsp;<span class="op" id="552934">*</span><span class="ident" id="552935">testing</span><span class="op" id="552942">.</span><span class="ident" id="552943">B</span><span class="op" id="552944">)</span>&nbsp;<span class="op" id="552946">{</span><br>
<span class="lineno">2900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552949">b</span><span class="op" id="552950">.</span><span class="ident" id="552951">ReportAllocs</span><span class="op" id="552963">(</span><span class="op" id="552964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="552967">req</span>&nbsp;<span class="op" id="552971">:=</span>&nbsp;<span class="ident" id="552974">reqBytes</span><span class="op" id="552982">(</span><span class="string" id="552983">`GET&nbsp;/&nbsp;HTTP/1.0<br>
<span class="lineno"></span>Host:&nbsp;golang.org<br>
<span class="lineno"></span>Accept:&nbsp;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br>
<span class="lineno"></span>User-Agent:&nbsp;Mozilla/5.0&nbsp;(Macintosh;&nbsp;Intel&nbsp;Mac&nbsp;OS&nbsp;X&nbsp;10_8_2)&nbsp;AppleWebKit/537.17&nbsp;(KHTML,&nbsp;like&nbsp;Gecko)&nbsp;Chrome/24.0.1312.52&nbsp;Safari/537.17<br>
<span class="lineno">2905</span>Accept-Encoding:&nbsp;gzip,deflate,sdch<br>
<span class="lineno"></span>Accept-Language:&nbsp;en-US,en;q=0.8<br>
<span class="lineno"></span>Accept-Charset:&nbsp;ISO-8859-1,utf-8;q=0.7,*;q=0.3<br>
<span class="lineno"></span>`</span><span class="op" id="553335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="553338">res</span>&nbsp;<span class="op" id="553342">:=</span>&nbsp;<span class="op" id="553345">[</span><span class="op" id="553346">]</span><span class="builtintype" id="553347">byte</span><span class="op" id="553351">(</span><span class="string" id="553352">&#34;Hello&nbsp;world!\n&#34;</span><span class="op" id="553368">)</span><br>
<span class="lineno">2910</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="553372">conn</span>&nbsp;<span class="op" id="553377">:=</span>&nbsp;<span class="op" id="553380">&amp;</span><span class="ident" id="553381">testConn</span><span class="op" id="553389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="553393">//&nbsp;testConn.Close&nbsp;will&nbsp;not&nbsp;push&nbsp;into&nbsp;the&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="553444">//&nbsp;if&nbsp;it&#39;s&nbsp;full.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="553463">closec</span><span class="op" id="553469">:</span>&nbsp;<span class="builtinfunc" id="553471">make</span><span class="op" id="553475">(</span><span class="keyword" id="553476">chan</span>&nbsp;<span class="builtintype" id="553481">bool</span><span class="op" id="553485">,</span>&nbsp;<span class="num" id="553487">1</span><span class="op" id="553488">)</span><span class="op" id="553489">,</span><br>
<span class="lineno">2915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="553492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="553495">handler</span>&nbsp;<span class="op" id="553503">:=</span>&nbsp;<span class="ident" id="553506">HandlerFunc</span><span class="op" id="553517">(</span><span class="keyword" id="553518">func</span><span class="op" id="553522">(</span><span class="ident" id="553523">rw</span>&nbsp;<span class="ident" id="553526">ResponseWriter</span><span class="op" id="553540">,</span>&nbsp;<span class="ident" id="553542">r</span>&nbsp;<span class="op" id="553544">*</span><span class="ident" id="553545">Request</span><span class="op" id="553552">)</span>&nbsp;<span class="op" id="553554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="553558">rw</span><span class="op" id="553560">.</span><span class="ident" id="553561">Header</span><span class="op" id="553567">(</span><span class="op" id="553568">)</span><span class="op" id="553569">.</span><span class="ident" id="553570">Set</span><span class="op" id="553573">(</span><span class="string" id="553574">&#34;Content-Type&#34;</span><span class="op" id="553588">,</span>&nbsp;<span class="string" id="553590">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="553616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="553620">rw</span><span class="op" id="553622">.</span><span class="ident" id="553623">Write</span><span class="op" id="553628">(</span><span class="ident" id="553629">res</span><span class="op" id="553632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="553635">}</span><span class="op" id="553636">)</span><br>
<span class="lineno">2920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="553639">ln</span>&nbsp;<span class="op" id="553642">:=</span>&nbsp;<span class="builtinfunc" id="553645">new</span><span class="op" id="553648">(</span><span class="ident" id="553649">oneConnListener</span><span class="op" id="553664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="553667">for</span>&nbsp;<span class="ident" id="553671">i</span>&nbsp;<span class="op" id="553673">:=</span>&nbsp;<span class="num" id="553676">0</span><span class="op" id="553677">;</span>&nbsp;<span class="ident" id="553679">i</span>&nbsp;<span class="op" id="553681">&lt;</span>&nbsp;<span class="ident" id="553683">b</span><span class="op" id="553684">.</span><span class="ident" id="553685">N</span><span class="op" id="553686">;</span>&nbsp;<span class="ident" id="553688">i</span><span class="op" id="553689">++</span>&nbsp;<span class="op" id="553692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="553696">conn</span><span class="op" id="553700">.</span><span class="ident" id="553701">readBuf</span><span class="op" id="553708">.</span><span class="ident" id="553709">Reset</span><span class="op" id="553714">(</span><span class="op" id="553715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="553719">conn</span><span class="op" id="553723">.</span><span class="ident" id="553724">writeBuf</span><span class="op" id="553732">.</span><span class="ident" id="553733">Reset</span><span class="op" id="553738">(</span><span class="op" id="553739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="553743">conn</span><span class="op" id="553747">.</span><span class="ident" id="553748">readBuf</span><span class="op" id="553755">.</span><span class="ident" id="553756">Write</span><span class="op" id="553761">(</span><span class="ident" id="553762">req</span><span class="op" id="553765">)</span><br>
<span class="lineno">2925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="553769">ln</span><span class="op" id="553771">.</span><span class="ident" id="553772">conn</span>&nbsp;<span class="op" id="553777">=</span>&nbsp;<span class="ident" id="553779">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="553786">Serve</span><span class="op" id="553791">(</span><span class="ident" id="553792">ln</span><span class="op" id="553794">,</span>&nbsp;<span class="ident" id="553796">handler</span><span class="op" id="553803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="553807">&lt;-</span><span class="ident" id="553809">conn</span><span class="op" id="553813">.</span><span class="ident" id="553814">closec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="553822">}</span><br>
<span class="lineno"></span><span class="op" id="553824">}</span><br>
<span class="lineno">2930</span><br>
<span class="lineno"></span><span class="comment" id="553827">//&nbsp;repeatReader&nbsp;reads&nbsp;content&nbsp;count&nbsp;times,&nbsp;then&nbsp;EOFs.</span><br>
<span class="lineno"></span><span class="keyword" id="553881">type</span>&nbsp;<span class="ident" id="553886">repeatReader</span>&nbsp;<span class="keyword" id="553899">struct</span>&nbsp;<span class="op" id="553906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="553909">content</span>&nbsp;<span class="op" id="553917">[</span><span class="op" id="553918">]</span><span class="builtintype" id="553919">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="553925">count</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="553933">int</span><br>
<span class="lineno">2935</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="553938">off</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="553946">int</span><br>
<span class="lineno"></span><span class="op" id="553950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="553953">func</span>&nbsp;<span class="op" id="553958">(</span><span class="ident" id="553959">r</span>&nbsp;<span class="op" id="553961">*</span><span class="ident" id="553962">repeatReader</span><span class="op" id="553974">)</span>&nbsp;<span class="ident" id="553976">Read</span><span class="op" id="553980">(</span><span class="ident" id="553981">p</span>&nbsp;<span class="op" id="553983">[</span><span class="op" id="553984">]</span><span class="builtintype" id="553985">byte</span><span class="op" id="553989">)</span>&nbsp;<span class="op" id="553991">(</span><span class="ident" id="553992">n</span>&nbsp;<span class="builtintype" id="553994">int</span><span class="op" id="553997">,</span>&nbsp;<span class="ident" id="553999">err</span>&nbsp;<span class="builtintype" id="554003">error</span><span class="op" id="554008">)</span>&nbsp;<span class="op" id="554010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="554013">if</span>&nbsp;<span class="ident" id="554016">r</span><span class="op" id="554017">.</span><span class="ident" id="554018">count</span>&nbsp;<span class="op" id="554024">&lt;=</span>&nbsp;<span class="num" id="554027">0</span>&nbsp;<span class="op" id="554029">{</span><br>
<span class="lineno">2940</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="554033">return</span>&nbsp;<span class="num" id="554040">0</span><span class="op" id="554041">,</span>&nbsp;<span class="ident" id="554043">io</span><span class="op" id="554045">.</span><span class="ident" id="554046">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="554051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554054">n</span>&nbsp;<span class="op" id="554056">=</span>&nbsp;<span class="builtinfunc" id="554058">copy</span><span class="op" id="554062">(</span><span class="ident" id="554063">p</span><span class="op" id="554064">,</span>&nbsp;<span class="ident" id="554066">r</span><span class="op" id="554067">.</span><span class="ident" id="554068">content</span><span class="op" id="554075">[</span><span class="ident" id="554076">r</span><span class="op" id="554077">.</span><span class="ident" id="554078">off</span><span class="op" id="554081">:</span><span class="op" id="554082">]</span><span class="op" id="554083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554086">r</span><span class="op" id="554087">.</span><span class="ident" id="554088">off</span>&nbsp;<span class="op" id="554092">+=</span>&nbsp;<span class="ident" id="554095">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="554098">if</span>&nbsp;<span class="ident" id="554101">r</span><span class="op" id="554102">.</span><span class="ident" id="554103">off</span>&nbsp;<span class="op" id="554107">==</span>&nbsp;<span class="builtinfunc" id="554110">len</span><span class="op" id="554113">(</span><span class="ident" id="554114">r</span><span class="op" id="554115">.</span><span class="ident" id="554116">content</span><span class="op" id="554123">)</span>&nbsp;<span class="op" id="554125">{</span><br>
<span class="lineno">2945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554129">r</span><span class="op" id="554130">.</span><span class="ident" id="554131">count</span><span class="op" id="554136">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554141">r</span><span class="op" id="554142">.</span><span class="ident" id="554143">off</span>&nbsp;<span class="op" id="554147">=</span>&nbsp;<span class="num" id="554149">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="554152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="554155">return</span><br>
<span class="lineno"></span><span class="op" id="554162">}</span><br>
<span class="lineno">2950</span><br>
<span class="lineno"></span><span class="keyword" id="554165">func</span>&nbsp;<span class="ident" id="554170">BenchmarkServerFakeConnWithKeepAlive</span><span class="op" id="554206">(</span><span class="ident" id="554207">b</span>&nbsp;<span class="op" id="554209">*</span><span class="ident" id="554210">testing</span><span class="op" id="554217">.</span><span class="ident" id="554218">B</span><span class="op" id="554219">)</span>&nbsp;<span class="op" id="554221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554224">b</span><span class="op" id="554225">.</span><span class="ident" id="554226">ReportAllocs</span><span class="op" id="554238">(</span><span class="op" id="554239">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554243">req</span>&nbsp;<span class="op" id="554247">:=</span>&nbsp;<span class="ident" id="554250">reqBytes</span><span class="op" id="554258">(</span><span class="string" id="554259">`GET&nbsp;/&nbsp;HTTP/1.1<br>
<span class="lineno">2955</span>Host:&nbsp;golang.org<br>
<span class="lineno"></span>Accept:&nbsp;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br>
<span class="lineno"></span>User-Agent:&nbsp;Mozilla/5.0&nbsp;(Macintosh;&nbsp;Intel&nbsp;Mac&nbsp;OS&nbsp;X&nbsp;10_8_2)&nbsp;AppleWebKit/537.17&nbsp;(KHTML,&nbsp;like&nbsp;Gecko)&nbsp;Chrome/24.0.1312.52&nbsp;Safari/537.17<br>
<span class="lineno"></span>Accept-Encoding:&nbsp;gzip,deflate,sdch<br>
<span class="lineno"></span>Accept-Language:&nbsp;en-US,en;q=0.8<br>
<span class="lineno">2960</span>Accept-Charset:&nbsp;ISO-8859-1,utf-8;q=0.7,*;q=0.3<br>
<span class="lineno"></span>`</span><span class="op" id="554611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554614">res</span>&nbsp;<span class="op" id="554618">:=</span>&nbsp;<span class="op" id="554621">[</span><span class="op" id="554622">]</span><span class="builtintype" id="554623">byte</span><span class="op" id="554627">(</span><span class="string" id="554628">&#34;Hello&nbsp;world!\n&#34;</span><span class="op" id="554644">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554648">conn</span>&nbsp;<span class="op" id="554653">:=</span>&nbsp;<span class="op" id="554656">&amp;</span><span class="ident" id="554657">rwTestConn</span><span class="op" id="554667">{</span><br>
<span class="lineno">2965</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554671">Reader</span><span class="op" id="554677">:</span>&nbsp;<span class="op" id="554679">&amp;</span><span class="ident" id="554680">repeatReader</span><span class="op" id="554692">{</span><span class="ident" id="554693">content</span><span class="op" id="554700">:</span>&nbsp;<span class="ident" id="554702">req</span><span class="op" id="554705">,</span>&nbsp;<span class="ident" id="554707">count</span><span class="op" id="554712">:</span>&nbsp;<span class="ident" id="554714">b</span><span class="op" id="554715">.</span><span class="ident" id="554716">N</span><span class="op" id="554717">}</span><span class="op" id="554718">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554722">Writer</span><span class="op" id="554728">:</span>&nbsp;<span class="ident" id="554730">ioutil</span><span class="op" id="554736">.</span><span class="ident" id="554737">Discard</span><span class="op" id="554744">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554748">closec</span><span class="op" id="554754">:</span>&nbsp;<span class="builtinfunc" id="554756">make</span><span class="op" id="554760">(</span><span class="keyword" id="554761">chan</span>&nbsp;<span class="builtintype" id="554766">bool</span><span class="op" id="554770">,</span>&nbsp;<span class="num" id="554772">1</span><span class="op" id="554773">)</span><span class="op" id="554774">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="554777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554780">handled</span>&nbsp;<span class="op" id="554788">:=</span>&nbsp;<span class="num" id="554791">0</span><br>
<span class="lineno">2970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554794">handler</span>&nbsp;<span class="op" id="554802">:=</span>&nbsp;<span class="ident" id="554805">HandlerFunc</span><span class="op" id="554816">(</span><span class="keyword" id="554817">func</span><span class="op" id="554821">(</span><span class="ident" id="554822">rw</span>&nbsp;<span class="ident" id="554825">ResponseWriter</span><span class="op" id="554839">,</span>&nbsp;<span class="ident" id="554841">r</span>&nbsp;<span class="op" id="554843">*</span><span class="ident" id="554844">Request</span><span class="op" id="554851">)</span>&nbsp;<span class="op" id="554853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554857">handled</span><span class="op" id="554864">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554869">rw</span><span class="op" id="554871">.</span><span class="ident" id="554872">Header</span><span class="op" id="554878">(</span><span class="op" id="554879">)</span><span class="op" id="554880">.</span><span class="ident" id="554881">Set</span><span class="op" id="554884">(</span><span class="string" id="554885">&#34;Content-Type&#34;</span><span class="op" id="554899">,</span>&nbsp;<span class="string" id="554901">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="554927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554931">rw</span><span class="op" id="554933">.</span><span class="ident" id="554934">Write</span><span class="op" id="554939">(</span><span class="ident" id="554940">res</span><span class="op" id="554943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="554946">}</span><span class="op" id="554947">)</span><br>
<span class="lineno">2975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="554950">ln</span>&nbsp;<span class="op" id="554953">:=</span>&nbsp;<span class="op" id="554956">&amp;</span><span class="ident" id="554957">oneConnListener</span><span class="op" id="554972">{</span><span class="ident" id="554973">conn</span><span class="op" id="554977">:</span>&nbsp;<span class="ident" id="554979">conn</span><span class="op" id="554983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="554986">go</span>&nbsp;<span class="ident" id="554989">Serve</span><span class="op" id="554994">(</span><span class="ident" id="554995">ln</span><span class="op" id="554997">,</span>&nbsp;<span class="ident" id="554999">handler</span><span class="op" id="555006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="555009">&lt;-</span><span class="ident" id="555011">conn</span><span class="op" id="555015">.</span><span class="ident" id="555016">closec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="555024">if</span>&nbsp;<span class="ident" id="555027">b</span><span class="op" id="555028">.</span><span class="ident" id="555029">N</span>&nbsp;<span class="op" id="555031">!=</span>&nbsp;<span class="ident" id="555034">handled</span>&nbsp;<span class="op" id="555042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="555046">b</span><span class="op" id="555047">.</span><span class="ident" id="555048">Errorf</span><span class="op" id="555054">(</span><span class="string" id="555055">&#34;b.N=%d&nbsp;but&nbsp;handled&nbsp;%d&#34;</span><span class="op" id="555078">,</span>&nbsp;<span class="ident" id="555080">b</span><span class="op" id="555081">.</span><span class="ident" id="555082">N</span><span class="op" id="555083">,</span>&nbsp;<span class="ident" id="555085">handled</span><span class="op" id="555092">)</span><br>
<span class="lineno">2980</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="555095">}</span><br>
<span class="lineno"></span><span class="op" id="555097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="555100">//&nbsp;same&nbsp;as&nbsp;above,&nbsp;but&nbsp;representing&nbsp;the&nbsp;most&nbsp;simple&nbsp;possible&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="555168">//&nbsp;and&nbsp;handler.&nbsp;Notably:&nbsp;the&nbsp;handler&nbsp;does&nbsp;not&nbsp;call&nbsp;rw.Header().</span><br>
<span class="lineno">2985</span><span class="keyword" id="555232">func</span>&nbsp;<span class="ident" id="555237">BenchmarkServerFakeConnWithKeepAliveLite</span><span class="op" id="555277">(</span><span class="ident" id="555278">b</span>&nbsp;<span class="op" id="555280">*</span><span class="ident" id="555281">testing</span><span class="op" id="555288">.</span><span class="ident" id="555289">B</span><span class="op" id="555290">)</span>&nbsp;<span class="op" id="555292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="555295">b</span><span class="op" id="555296">.</span><span class="ident" id="555297">ReportAllocs</span><span class="op" id="555309">(</span><span class="op" id="555310">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="555314">req</span>&nbsp;<span class="op" id="555318">:=</span>&nbsp;<span class="ident" id="555321">reqBytes</span><span class="op" id="555329">(</span><span class="string" id="555330">`GET&nbsp;/&nbsp;HTTP/1.1<br>
<span class="lineno"></span>Host:&nbsp;golang.org<br>
<span class="lineno">2990</span>`</span><span class="op" id="555364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="555367">res</span>&nbsp;<span class="op" id="555371">:=</span>&nbsp;<span class="op" id="555374">[</span><span class="op" id="555375">]</span><span class="builtintype" id="555376">byte</span><span class="op" id="555380">(</span><span class="string" id="555381">&#34;Hello&nbsp;world!\n&#34;</span><span class="op" id="555397">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="555401">conn</span>&nbsp;<span class="op" id="555406">:=</span>&nbsp;<span class="op" id="555409">&amp;</span><span class="ident" id="555410">rwTestConn</span><span class="op" id="555420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="555424">Reader</span><span class="op" id="555430">:</span>&nbsp;<span class="op" id="555432">&amp;</span><span class="ident" id="555433">repeatReader</span><span class="op" id="555445">{</span><span class="ident" id="555446">content</span><span class="op" id="555453">:</span>&nbsp;<span class="ident" id="555455">req</span><span class="op" id="555458">,</span>&nbsp;<span class="ident" id="555460">count</span><span class="op" id="555465">:</span>&nbsp;<span class="ident" id="555467">b</span><span class="op" id="555468">.</span><span class="ident" id="555469">N</span><span class="op" id="555470">}</span><span class="op" id="555471">,</span><br>
<span class="lineno">2995</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="555475">Writer</span><span class="op" id="555481">:</span>&nbsp;<span class="ident" id="555483">ioutil</span><span class="op" id="555489">.</span><span class="ident" id="555490">Discard</span><span class="op" id="555497">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="555501">closec</span><span class="op" id="555507">:</span>&nbsp;<span class="builtinfunc" id="555509">make</span><span class="op" id="555513">(</span><span class="keyword" id="555514">chan</span>&nbsp;<span class="builtintype" id="555519">bool</span><span class="op" id="555523">,</span>&nbsp;<span class="num" id="555525">1</span><span class="op" id="555526">)</span><span class="op" id="555527">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="555530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="555533">handled</span>&nbsp;<span class="op" id="555541">:=</span>&nbsp;<span class="num" id="555544">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="555547">handler</span>&nbsp;<span class="op" id="555555">:=</span>&nbsp;<span class="ident" id="555558">HandlerFunc</span><span class="op" id="555569">(</span><span class="keyword" id="555570">func</span><span class="op" id="555574">(</span><span class="ident" id="555575">rw</span>&nbsp;<span class="ident" id="555578">ResponseWriter</span><span class="op" id="555592">,</span>&nbsp;<span class="ident" id="555594">r</span>&nbsp;<span class="op" id="555596">*</span><span class="ident" id="555597">Request</span><span class="op" id="555604">)</span>&nbsp;<span class="op" id="555606">{</span><br>
<span class="lineno">3000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="555610">handled</span><span class="op" id="555617">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="555622">rw</span><span class="op" id="555624">.</span><span class="ident" id="555625">Write</span><span class="op" id="555630">(</span><span class="ident" id="555631">res</span><span class="op" id="555634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="555637">}</span><span class="op" id="555638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="555641">ln</span>&nbsp;<span class="op" id="555644">:=</span>&nbsp;<span class="op" id="555647">&amp;</span><span class="ident" id="555648">oneConnListener</span><span class="op" id="555663">{</span><span class="ident" id="555664">conn</span><span class="op" id="555668">:</span>&nbsp;<span class="ident" id="555670">conn</span><span class="op" id="555674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="555677">go</span>&nbsp;<span class="ident" id="555680">Serve</span><span class="op" id="555685">(</span><span class="ident" id="555686">ln</span><span class="op" id="555688">,</span>&nbsp;<span class="ident" id="555690">handler</span><span class="op" id="555697">)</span><br>
<span class="lineno">3005</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="555700">&lt;-</span><span class="ident" id="555702">conn</span><span class="op" id="555706">.</span><span class="ident" id="555707">closec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="555715">if</span>&nbsp;<span class="ident" id="555718">b</span><span class="op" id="555719">.</span><span class="ident" id="555720">N</span>&nbsp;<span class="op" id="555722">!=</span>&nbsp;<span class="ident" id="555725">handled</span>&nbsp;<span class="op" id="555733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="555737">b</span><span class="op" id="555738">.</span><span class="ident" id="555739">Errorf</span><span class="op" id="555745">(</span><span class="string" id="555746">&#34;b.N=%d&nbsp;but&nbsp;handled&nbsp;%d&#34;</span><span class="op" id="555769">,</span>&nbsp;<span class="ident" id="555771">b</span><span class="op" id="555772">.</span><span class="ident" id="555773">N</span><span class="op" id="555774">,</span>&nbsp;<span class="ident" id="555776">handled</span><span class="op" id="555783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="555786">}</span><br>
<span class="lineno"></span><span class="op" id="555788">}</span><br>
<span class="lineno">3010</span><br>
<span class="lineno"></span><span class="keyword" id="555791">const</span>&nbsp;<span class="ident" id="555797">someResponse</span>&nbsp;<span class="op" id="555810">=</span>&nbsp;<span class="string" id="555812">&#34;&lt;html&gt;some&nbsp;response&lt;/html&gt;&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="555842">//&nbsp;A&nbsp;Response&nbsp;that&#39;s&nbsp;just&nbsp;no&nbsp;bigger&nbsp;than&nbsp;2KB,&nbsp;the&nbsp;buffer-before-chunking&nbsp;threshold.</span><br>
<span class="lineno"></span><span class="keyword" id="555926">var</span>&nbsp;<span class="ident" id="555930">response</span>&nbsp;<span class="op" id="555939">=</span>&nbsp;<span class="ident" id="555941">bytes</span><span class="op" id="555946">.</span><span class="ident" id="555947">Repeat</span><span class="op" id="555953">(</span><span class="op" id="555954">[</span><span class="op" id="555955">]</span><span class="builtintype" id="555956">byte</span><span class="op" id="555960">(</span><span class="ident" id="555961">someResponse</span><span class="op" id="555973">)</span><span class="op" id="555974">,</span>&nbsp;<span class="num" id="555976">2</span><span class="op" id="555977">&lt;&lt;</span><span class="num" id="555979">10</span><span class="op" id="555981">/</span><span class="builtinfunc" id="555982">len</span><span class="op" id="555985">(</span><span class="ident" id="555986">someResponse</span><span class="op" id="555998">)</span><span class="op" id="555999">)</span><br>
<span class="lineno">3015</span><br>
<span class="lineno"></span><span class="comment" id="556002">//&nbsp;Both&nbsp;Content-Type&nbsp;and&nbsp;Content-Length&nbsp;set.&nbsp;Should&nbsp;be&nbsp;no&nbsp;buffering.</span><br>
<span class="lineno"></span><span class="keyword" id="556071">func</span>&nbsp;<span class="ident" id="556076">BenchmarkServerHandlerTypeLen</span><span class="op" id="556105">(</span><span class="ident" id="556106">b</span>&nbsp;<span class="op" id="556108">*</span><span class="ident" id="556109">testing</span><span class="op" id="556116">.</span><span class="ident" id="556117">B</span><span class="op" id="556118">)</span>&nbsp;<span class="op" id="556120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="556123">benchmarkHandler</span><span class="op" id="556139">(</span><span class="ident" id="556140">b</span><span class="op" id="556141">,</span>&nbsp;<span class="ident" id="556143">HandlerFunc</span><span class="op" id="556154">(</span><span class="keyword" id="556155">func</span><span class="op" id="556159">(</span><span class="ident" id="556160">w</span>&nbsp;<span class="ident" id="556162">ResponseWriter</span><span class="op" id="556176">,</span>&nbsp;<span class="ident" id="556178">r</span>&nbsp;<span class="op" id="556180">*</span><span class="ident" id="556181">Request</span><span class="op" id="556188">)</span>&nbsp;<span class="op" id="556190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="556194">w</span><span class="op" id="556195">.</span><span class="ident" id="556196">Header</span><span class="op" id="556202">(</span><span class="op" id="556203">)</span><span class="op" id="556204">.</span><span class="ident" id="556205">Set</span><span class="op" id="556208">(</span><span class="string" id="556209">&#34;Content-Type&#34;</span><span class="op" id="556223">,</span>&nbsp;<span class="string" id="556225">&#34;text/html&#34;</span><span class="op" id="556236">)</span><br>
<span class="lineno">3020</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="556240">w</span><span class="op" id="556241">.</span><span class="ident" id="556242">Header</span><span class="op" id="556248">(</span><span class="op" id="556249">)</span><span class="op" id="556250">.</span><span class="ident" id="556251">Set</span><span class="op" id="556254">(</span><span class="string" id="556255">&#34;Content-Length&#34;</span><span class="op" id="556271">,</span>&nbsp;<span class="ident" id="556273">strconv</span><span class="op" id="556280">.</span><span class="ident" id="556281">Itoa</span><span class="op" id="556285">(</span><span class="builtinfunc" id="556286">len</span><span class="op" id="556289">(</span><span class="ident" id="556290">response</span><span class="op" id="556298">)</span><span class="op" id="556299">)</span><span class="op" id="556300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="556304">w</span><span class="op" id="556305">.</span><span class="ident" id="556306">Write</span><span class="op" id="556311">(</span><span class="ident" id="556312">response</span><span class="op" id="556320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="556323">}</span><span class="op" id="556324">)</span><span class="op" id="556325">)</span><br>
<span class="lineno"></span><span class="op" id="556327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">3025</span><span class="comment" id="556330">//&nbsp;A&nbsp;Content-Type&nbsp;is&nbsp;set,&nbsp;but&nbsp;no&nbsp;length.&nbsp;No&nbsp;sniffing,&nbsp;but&nbsp;will&nbsp;count&nbsp;the&nbsp;Content-Length.</span><br>
<span class="lineno"></span><span class="keyword" id="556419">func</span>&nbsp;<span class="ident" id="556424">BenchmarkServerHandlerNoLen</span><span class="op" id="556451">(</span><span class="ident" id="556452">b</span>&nbsp;<span class="op" id="556454">*</span><span class="ident" id="556455">testing</span><span class="op" id="556462">.</span><span class="ident" id="556463">B</span><span class="op" id="556464">)</span>&nbsp;<span class="op" id="556466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="556469">benchmarkHandler</span><span class="op" id="556485">(</span><span class="ident" id="556486">b</span><span class="op" id="556487">,</span>&nbsp;<span class="ident" id="556489">HandlerFunc</span><span class="op" id="556500">(</span><span class="keyword" id="556501">func</span><span class="op" id="556505">(</span><span class="ident" id="556506">w</span>&nbsp;<span class="ident" id="556508">ResponseWriter</span><span class="op" id="556522">,</span>&nbsp;<span class="ident" id="556524">r</span>&nbsp;<span class="op" id="556526">*</span><span class="ident" id="556527">Request</span><span class="op" id="556534">)</span>&nbsp;<span class="op" id="556536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="556540">w</span><span class="op" id="556541">.</span><span class="ident" id="556542">Header</span><span class="op" id="556548">(</span><span class="op" id="556549">)</span><span class="op" id="556550">.</span><span class="ident" id="556551">Set</span><span class="op" id="556554">(</span><span class="string" id="556555">&#34;Content-Type&#34;</span><span class="op" id="556569">,</span>&nbsp;<span class="string" id="556571">&#34;text/html&#34;</span><span class="op" id="556582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="556586">w</span><span class="op" id="556587">.</span><span class="ident" id="556588">Write</span><span class="op" id="556593">(</span><span class="ident" id="556594">response</span><span class="op" id="556602">)</span><br>
<span class="lineno">3030</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="556605">}</span><span class="op" id="556606">)</span><span class="op" id="556607">)</span><br>
<span class="lineno"></span><span class="op" id="556609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="556612">//&nbsp;A&nbsp;Content-Length&nbsp;is&nbsp;set,&nbsp;but&nbsp;the&nbsp;Content-Type&nbsp;will&nbsp;be&nbsp;sniffed.</span><br>
<span class="lineno"></span><span class="keyword" id="556678">func</span>&nbsp;<span class="ident" id="556683">BenchmarkServerHandlerNoType</span><span class="op" id="556711">(</span><span class="ident" id="556712">b</span>&nbsp;<span class="op" id="556714">*</span><span class="ident" id="556715">testing</span><span class="op" id="556722">.</span><span class="ident" id="556723">B</span><span class="op" id="556724">)</span>&nbsp;<span class="op" id="556726">{</span><br>
<span class="lineno">3035</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="556729">benchmarkHandler</span><span class="op" id="556745">(</span><span class="ident" id="556746">b</span><span class="op" id="556747">,</span>&nbsp;<span class="ident" id="556749">HandlerFunc</span><span class="op" id="556760">(</span><span class="keyword" id="556761">func</span><span class="op" id="556765">(</span><span class="ident" id="556766">w</span>&nbsp;<span class="ident" id="556768">ResponseWriter</span><span class="op" id="556782">,</span>&nbsp;<span class="ident" id="556784">r</span>&nbsp;<span class="op" id="556786">*</span><span class="ident" id="556787">Request</span><span class="op" id="556794">)</span>&nbsp;<span class="op" id="556796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="556800">w</span><span class="op" id="556801">.</span><span class="ident" id="556802">Header</span><span class="op" id="556808">(</span><span class="op" id="556809">)</span><span class="op" id="556810">.</span><span class="ident" id="556811">Set</span><span class="op" id="556814">(</span><span class="string" id="556815">&#34;Content-Length&#34;</span><span class="op" id="556831">,</span>&nbsp;<span class="ident" id="556833">strconv</span><span class="op" id="556840">.</span><span class="ident" id="556841">Itoa</span><span class="op" id="556845">(</span><span class="builtinfunc" id="556846">len</span><span class="op" id="556849">(</span><span class="ident" id="556850">response</span><span class="op" id="556858">)</span><span class="op" id="556859">)</span><span class="op" id="556860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="556864">w</span><span class="op" id="556865">.</span><span class="ident" id="556866">Write</span><span class="op" id="556871">(</span><span class="ident" id="556872">response</span><span class="op" id="556880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="556883">}</span><span class="op" id="556884">)</span><span class="op" id="556885">)</span><br>
<span class="lineno"></span><span class="op" id="556887">}</span><br>
<span class="lineno">3040</span><br>
<span class="lineno"></span><span class="comment" id="556890">//&nbsp;Neither&nbsp;a&nbsp;Content-Type&nbsp;or&nbsp;Content-Length,&nbsp;so&nbsp;sniffed&nbsp;and&nbsp;counted.</span><br>
<span class="lineno"></span><span class="keyword" id="556959">func</span>&nbsp;<span class="ident" id="556964">BenchmarkServerHandlerNoHeader</span><span class="op" id="556994">(</span><span class="ident" id="556995">b</span>&nbsp;<span class="op" id="556997">*</span><span class="ident" id="556998">testing</span><span class="op" id="557005">.</span><span class="ident" id="557006">B</span><span class="op" id="557007">)</span>&nbsp;<span class="op" id="557009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557012">benchmarkHandler</span><span class="op" id="557028">(</span><span class="ident" id="557029">b</span><span class="op" id="557030">,</span>&nbsp;<span class="ident" id="557032">HandlerFunc</span><span class="op" id="557043">(</span><span class="keyword" id="557044">func</span><span class="op" id="557048">(</span><span class="ident" id="557049">w</span>&nbsp;<span class="ident" id="557051">ResponseWriter</span><span class="op" id="557065">,</span>&nbsp;<span class="ident" id="557067">r</span>&nbsp;<span class="op" id="557069">*</span><span class="ident" id="557070">Request</span><span class="op" id="557077">)</span>&nbsp;<span class="op" id="557079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557083">w</span><span class="op" id="557084">.</span><span class="ident" id="557085">Write</span><span class="op" id="557090">(</span><span class="ident" id="557091">response</span><span class="op" id="557099">)</span><br>
<span class="lineno">3045</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="557102">}</span><span class="op" id="557103">)</span><span class="op" id="557104">)</span><br>
<span class="lineno"></span><span class="op" id="557106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="557109">func</span>&nbsp;<span class="ident" id="557114">benchmarkHandler</span><span class="op" id="557130">(</span><span class="ident" id="557131">b</span>&nbsp;<span class="op" id="557133">*</span><span class="ident" id="557134">testing</span><span class="op" id="557141">.</span><span class="ident" id="557142">B</span><span class="op" id="557143">,</span>&nbsp;<span class="ident" id="557145">h</span>&nbsp;<span class="ident" id="557147">Handler</span><span class="op" id="557154">)</span>&nbsp;<span class="op" id="557156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557159">b</span><span class="op" id="557160">.</span><span class="ident" id="557161">ReportAllocs</span><span class="op" id="557173">(</span><span class="op" id="557174">)</span><br>
<span class="lineno">3050</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557177">req</span>&nbsp;<span class="op" id="557181">:=</span>&nbsp;<span class="ident" id="557184">reqBytes</span><span class="op" id="557192">(</span><span class="string" id="557193">`GET&nbsp;/&nbsp;HTTP/1.1<br>
<span class="lineno"></span>Host:&nbsp;golang.org<br>
<span class="lineno"></span>`</span><span class="op" id="557227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557230">conn</span>&nbsp;<span class="op" id="557235">:=</span>&nbsp;<span class="op" id="557238">&amp;</span><span class="ident" id="557239">rwTestConn</span><span class="op" id="557249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557253">Reader</span><span class="op" id="557259">:</span>&nbsp;<span class="op" id="557261">&amp;</span><span class="ident" id="557262">repeatReader</span><span class="op" id="557274">{</span><span class="ident" id="557275">content</span><span class="op" id="557282">:</span>&nbsp;<span class="ident" id="557284">req</span><span class="op" id="557287">,</span>&nbsp;<span class="ident" id="557289">count</span><span class="op" id="557294">:</span>&nbsp;<span class="ident" id="557296">b</span><span class="op" id="557297">.</span><span class="ident" id="557298">N</span><span class="op" id="557299">}</span><span class="op" id="557300">,</span><br>
<span class="lineno">3055</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557304">Writer</span><span class="op" id="557310">:</span>&nbsp;<span class="ident" id="557312">ioutil</span><span class="op" id="557318">.</span><span class="ident" id="557319">Discard</span><span class="op" id="557326">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557330">closec</span><span class="op" id="557336">:</span>&nbsp;<span class="builtinfunc" id="557338">make</span><span class="op" id="557342">(</span><span class="keyword" id="557343">chan</span>&nbsp;<span class="builtintype" id="557348">bool</span><span class="op" id="557352">,</span>&nbsp;<span class="num" id="557354">1</span><span class="op" id="557355">)</span><span class="op" id="557356">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="557359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557362">handled</span>&nbsp;<span class="op" id="557370">:=</span>&nbsp;<span class="num" id="557373">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557376">handler</span>&nbsp;<span class="op" id="557384">:=</span>&nbsp;<span class="ident" id="557387">HandlerFunc</span><span class="op" id="557398">(</span><span class="keyword" id="557399">func</span><span class="op" id="557403">(</span><span class="ident" id="557404">rw</span>&nbsp;<span class="ident" id="557407">ResponseWriter</span><span class="op" id="557421">,</span>&nbsp;<span class="ident" id="557423">r</span>&nbsp;<span class="op" id="557425">*</span><span class="ident" id="557426">Request</span><span class="op" id="557433">)</span>&nbsp;<span class="op" id="557435">{</span><br>
<span class="lineno">3060</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557439">handled</span><span class="op" id="557446">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557451">h</span><span class="op" id="557452">.</span><span class="ident" id="557453">ServeHTTP</span><span class="op" id="557462">(</span><span class="ident" id="557463">rw</span><span class="op" id="557465">,</span>&nbsp;<span class="ident" id="557467">r</span><span class="op" id="557468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="557471">}</span><span class="op" id="557472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557475">ln</span>&nbsp;<span class="op" id="557478">:=</span>&nbsp;<span class="op" id="557481">&amp;</span><span class="ident" id="557482">oneConnListener</span><span class="op" id="557497">{</span><span class="ident" id="557498">conn</span><span class="op" id="557502">:</span>&nbsp;<span class="ident" id="557504">conn</span><span class="op" id="557508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="557511">go</span>&nbsp;<span class="ident" id="557514">Serve</span><span class="op" id="557519">(</span><span class="ident" id="557520">ln</span><span class="op" id="557522">,</span>&nbsp;<span class="ident" id="557524">handler</span><span class="op" id="557531">)</span><br>
<span class="lineno">3065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="557534">&lt;-</span><span class="ident" id="557536">conn</span><span class="op" id="557540">.</span><span class="ident" id="557541">closec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="557549">if</span>&nbsp;<span class="ident" id="557552">b</span><span class="op" id="557553">.</span><span class="ident" id="557554">N</span>&nbsp;<span class="op" id="557556">!=</span>&nbsp;<span class="ident" id="557559">handled</span>&nbsp;<span class="op" id="557567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557571">b</span><span class="op" id="557572">.</span><span class="ident" id="557573">Errorf</span><span class="op" id="557579">(</span><span class="string" id="557580">&#34;b.N=%d&nbsp;but&nbsp;handled&nbsp;%d&#34;</span><span class="op" id="557603">,</span>&nbsp;<span class="ident" id="557605">b</span><span class="op" id="557606">.</span><span class="ident" id="557607">N</span><span class="op" id="557608">,</span>&nbsp;<span class="ident" id="557610">handled</span><span class="op" id="557617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="557620">}</span><br>
<span class="lineno"></span><span class="op" id="557622">}</span><br>
<span class="lineno">3070</span><br>
<span class="lineno"></span><span class="keyword" id="557625">func</span>&nbsp;<span class="ident" id="557630">BenchmarkServerHijack</span><span class="op" id="557651">(</span><span class="ident" id="557652">b</span>&nbsp;<span class="op" id="557654">*</span><span class="ident" id="557655">testing</span><span class="op" id="557662">.</span><span class="ident" id="557663">B</span><span class="op" id="557664">)</span>&nbsp;<span class="op" id="557666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557669">b</span><span class="op" id="557670">.</span><span class="ident" id="557671">ReportAllocs</span><span class="op" id="557683">(</span><span class="op" id="557684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557687">req</span>&nbsp;<span class="op" id="557691">:=</span>&nbsp;<span class="ident" id="557694">reqBytes</span><span class="op" id="557702">(</span><span class="string" id="557703">`GET&nbsp;/&nbsp;HTTP/1.1<br>
<span class="lineno"></span>Host:&nbsp;golang.org<br>
<span class="lineno">3075</span>`</span><span class="op" id="557737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557740">h</span>&nbsp;<span class="op" id="557742">:=</span>&nbsp;<span class="ident" id="557745">HandlerFunc</span><span class="op" id="557756">(</span><span class="keyword" id="557757">func</span><span class="op" id="557761">(</span><span class="ident" id="557762">w</span>&nbsp;<span class="ident" id="557764">ResponseWriter</span><span class="op" id="557778">,</span>&nbsp;<span class="ident" id="557780">r</span>&nbsp;<span class="op" id="557782">*</span><span class="ident" id="557783">Request</span><span class="op" id="557790">)</span>&nbsp;<span class="op" id="557792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557796">conn</span><span class="op" id="557800">,</span>&nbsp;<span class="ident" id="557802">_</span><span class="op" id="557803">,</span>&nbsp;<span class="ident" id="557805">err</span>&nbsp;<span class="op" id="557809">:=</span>&nbsp;<span class="ident" id="557812">w</span><span class="op" id="557813">.</span><span class="op" id="557814">(</span><span class="ident" id="557815">Hijacker</span><span class="op" id="557823">)</span><span class="op" id="557824">.</span><span class="ident" id="557825">Hijack</span><span class="op" id="557831">(</span><span class="op" id="557832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="557836">if</span>&nbsp;<span class="ident" id="557839">err</span>&nbsp;<span class="op" id="557843">!=</span>&nbsp;<span class="builtintype" id="557846">nil</span>&nbsp;<span class="op" id="557850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="557855">panic</span><span class="op" id="557860">(</span><span class="ident" id="557861">err</span><span class="op" id="557864">)</span><br>
<span class="lineno">3080</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="557868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557872">conn</span><span class="op" id="557876">.</span><span class="ident" id="557877">Close</span><span class="op" id="557882">(</span><span class="op" id="557883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="557886">}</span><span class="op" id="557887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557890">conn</span>&nbsp;<span class="op" id="557895">:=</span>&nbsp;<span class="op" id="557898">&amp;</span><span class="ident" id="557899">rwTestConn</span><span class="op" id="557909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557913">Writer</span><span class="op" id="557919">:</span>&nbsp;<span class="ident" id="557921">ioutil</span><span class="op" id="557927">.</span><span class="ident" id="557928">Discard</span><span class="op" id="557935">,</span><br>
<span class="lineno">3085</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557939">closec</span><span class="op" id="557945">:</span>&nbsp;<span class="builtinfunc" id="557947">make</span><span class="op" id="557951">(</span><span class="keyword" id="557952">chan</span>&nbsp;<span class="builtintype" id="557957">bool</span><span class="op" id="557961">,</span>&nbsp;<span class="num" id="557963">1</span><span class="op" id="557964">)</span><span class="op" id="557965">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="557968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="557971">ln</span>&nbsp;<span class="op" id="557974">:=</span>&nbsp;<span class="op" id="557977">&amp;</span><span class="ident" id="557978">oneConnListener</span><span class="op" id="557993">{</span><span class="ident" id="557994">conn</span><span class="op" id="557998">:</span>&nbsp;<span class="ident" id="558000">conn</span><span class="op" id="558004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="558007">for</span>&nbsp;<span class="ident" id="558011">i</span>&nbsp;<span class="op" id="558013">:=</span>&nbsp;<span class="num" id="558016">0</span><span class="op" id="558017">;</span>&nbsp;<span class="ident" id="558019">i</span>&nbsp;<span class="op" id="558021">&lt;</span>&nbsp;<span class="ident" id="558023">b</span><span class="op" id="558024">.</span><span class="ident" id="558025">N</span><span class="op" id="558026">;</span>&nbsp;<span class="ident" id="558028">i</span><span class="op" id="558029">++</span>&nbsp;<span class="op" id="558032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="558036">conn</span><span class="op" id="558040">.</span><span class="ident" id="558041">Reader</span>&nbsp;<span class="op" id="558048">=</span>&nbsp;<span class="ident" id="558050">bytes</span><span class="op" id="558055">.</span><span class="ident" id="558056">NewReader</span><span class="op" id="558065">(</span><span class="ident" id="558066">req</span><span class="op" id="558069">)</span><br>
<span class="lineno">3090</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="558073">ln</span><span class="op" id="558075">.</span><span class="ident" id="558076">conn</span>&nbsp;<span class="op" id="558081">=</span>&nbsp;<span class="ident" id="558083">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="558090">Serve</span><span class="op" id="558095">(</span><span class="ident" id="558096">ln</span><span class="op" id="558098">,</span>&nbsp;<span class="ident" id="558100">h</span><span class="op" id="558101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="558105">&lt;-</span><span class="ident" id="558107">conn</span><span class="op" id="558111">.</span><span class="ident" id="558112">closec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="558120">}</span><br>
<span class="lineno"></span><span class="op" id="558122">}</span>
</div>
</body>
</html>
