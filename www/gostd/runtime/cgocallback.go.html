<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1823329">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1823385">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1823439">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1823490">package</span>&nbsp;<span class="ident" id="1823498">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1823507">import</span>&nbsp;<span class="string" id="1823514">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1823524">//&nbsp;These&nbsp;functions&nbsp;are&nbsp;called&nbsp;from&nbsp;C&nbsp;code&nbsp;via&nbsp;cgo/callbacks.c.</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1823588">//&nbsp;Allocate&nbsp;memory.&nbsp;&nbsp;This&nbsp;allocates&nbsp;the&nbsp;requested&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1823657">//&nbsp;memory&nbsp;controlled&nbsp;by&nbsp;the&nbsp;Go&nbsp;runtime.&nbsp;&nbsp;The&nbsp;allocated&nbsp;memory&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1823727">//&nbsp;zeroed.&nbsp;&nbsp;You&nbsp;are&nbsp;responsible&nbsp;for&nbsp;ensuring&nbsp;that&nbsp;the&nbsp;Go&nbsp;garbage</span><br>
<span class="lineno"></span><span class="comment" id="1823792">//&nbsp;collector&nbsp;can&nbsp;see&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;allocated&nbsp;memory&nbsp;for&nbsp;as&nbsp;long&nbsp;as</span><br>
<span class="lineno">15</span><span class="comment" id="1823862">//&nbsp;it&nbsp;is&nbsp;valid,&nbsp;e.g.,&nbsp;by&nbsp;storing&nbsp;a&nbsp;pointer&nbsp;in&nbsp;a&nbsp;local&nbsp;variable&nbsp;in&nbsp;your</span><br>
<span class="lineno"></span><span class="comment" id="1823933">//&nbsp;C&nbsp;function,&nbsp;or&nbsp;in&nbsp;memory&nbsp;allocated&nbsp;by&nbsp;the&nbsp;Go&nbsp;runtime.&nbsp;&nbsp;If&nbsp;the&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="1824003">//&nbsp;pointers&nbsp;are&nbsp;in&nbsp;a&nbsp;C&nbsp;global&nbsp;variable&nbsp;or&nbsp;in&nbsp;memory&nbsp;allocated&nbsp;via</span><br>
<span class="lineno"></span><span class="comment" id="1824069">//&nbsp;malloc,&nbsp;then&nbsp;the&nbsp;Go&nbsp;garbage&nbsp;collector&nbsp;may&nbsp;collect&nbsp;the&nbsp;memory.</span><br>
<span class="lineno"></span><span class="comment" id="1824134">//</span><br>
<span class="lineno">20</span><span class="comment" id="1824137">//&nbsp;TODO(rsc,iant):&nbsp;This&nbsp;memory&nbsp;is&nbsp;untyped.</span><br>
<span class="lineno"></span><span class="comment" id="1824180">//&nbsp;Either&nbsp;we&nbsp;need&nbsp;to&nbsp;add&nbsp;types&nbsp;or&nbsp;we&nbsp;need&nbsp;to&nbsp;stop&nbsp;using&nbsp;it.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1824241">func</span>&nbsp;<span class="ident" id="1824246">_cgo_allocate_internal</span><span class="op" id="1824268">(</span><span class="builtinfunc" id="1824269">len</span>&nbsp;<span class="builtintype" id="1824273">uintptr</span><span class="op" id="1824280">)</span>&nbsp;<span class="ident" id="1824282">unsafe</span><span class="op" id="1824288">.</span><span class="ident" id="1824289">Pointer</span>&nbsp;<span class="op" id="1824297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1824300">if</span>&nbsp;<span class="builtinfunc" id="1824303">len</span>&nbsp;<span class="op" id="1824307">==</span>&nbsp;<span class="num" id="1824310">0</span>&nbsp;<span class="op" id="1824312">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1824316">len</span>&nbsp;<span class="op" id="1824320">=</span>&nbsp;<span class="num" id="1824322">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1824325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1824328">ret</span>&nbsp;<span class="op" id="1824332">:=</span>&nbsp;<span class="ident" id="1824335">unsafe</span><span class="op" id="1824341">.</span><span class="ident" id="1824342">Pointer</span><span class="op" id="1824349">(</span><span class="op" id="1824350">&amp;</span><span class="builtinfunc" id="1824351">make</span><span class="op" id="1824355">(</span><span class="op" id="1824356">[</span><span class="op" id="1824357">]</span><span class="ident" id="1824358">unsafe</span><span class="op" id="1824364">.</span><span class="ident" id="1824365">Pointer</span><span class="op" id="1824372">,</span>&nbsp;<span class="op" id="1824374">(</span><span class="builtinfunc" id="1824375">len</span><span class="op" id="1824378">+</span><span class="ident" id="1824379">ptrSize</span><span class="op" id="1824386">-</span><span class="num" id="1824387">1</span><span class="op" id="1824388">)</span><span class="op" id="1824389">/</span><span class="ident" id="1824390">ptrSize</span><span class="op" id="1824397">)</span><span class="op" id="1824398">[</span><span class="num" id="1824399">0</span><span class="op" id="1824400">]</span><span class="op" id="1824401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1824404">c</span>&nbsp;<span class="op" id="1824406">:=</span>&nbsp;<span class="builtinfunc" id="1824409">new</span><span class="op" id="1824412">(</span><span class="ident" id="1824413">cgomal</span><span class="op" id="1824419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1824422">c</span><span class="op" id="1824423">.</span><span class="ident" id="1824424">alloc</span>&nbsp;<span class="op" id="1824430">=</span>&nbsp;<span class="ident" id="1824432">ret</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1824437">gp</span>&nbsp;<span class="op" id="1824440">:=</span>&nbsp;<span class="ident" id="1824443">getg</span><span class="op" id="1824447">(</span><span class="op" id="1824448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1824451">c</span><span class="op" id="1824452">.</span><span class="ident" id="1824453">next</span>&nbsp;<span class="op" id="1824458">=</span>&nbsp;<span class="ident" id="1824460">gp</span><span class="op" id="1824462">.</span><span class="ident" id="1824463">m</span><span class="op" id="1824464">.</span><span class="ident" id="1824465">cgomal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1824473">gp</span><span class="op" id="1824475">.</span><span class="ident" id="1824476">m</span><span class="op" id="1824477">.</span><span class="ident" id="1824478">cgomal</span>&nbsp;<span class="op" id="1824485">=</span>&nbsp;<span class="ident" id="1824487">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1824490">return</span>&nbsp;<span class="ident" id="1824497">ret</span><br>
<span class="lineno"></span><span class="op" id="1824501">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1824504">//&nbsp;Panic.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1824515">func</span>&nbsp;<span class="ident" id="1824520">_cgo_panic_internal</span><span class="op" id="1824539">(</span><span class="ident" id="1824540">p</span>&nbsp;<span class="op" id="1824542">*</span><span class="builtintype" id="1824543">byte</span><span class="op" id="1824547">)</span>&nbsp;<span class="op" id="1824549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1824552">panic</span><span class="op" id="1824557">(</span><span class="ident" id="1824558">gostringnocopy</span><span class="op" id="1824572">(</span><span class="ident" id="1824573">p</span><span class="op" id="1824574">)</span><span class="op" id="1824575">)</span><br>
<span class="lineno">40</span><span class="op" id="1824577">}</span>
</div>
</body>
</html>
