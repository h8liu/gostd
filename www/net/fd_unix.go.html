<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3332932">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3332987">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3333041">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3333092">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3333162">package</span>&nbsp;<span class="ident" id="3333170">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3333175">import</span>&nbsp;<span class="op" id="3333182">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3333185">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3333191">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3333197">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3333208">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3333223">&#34;syscall&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3333234">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3333241">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3333244">//&nbsp;Network&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="3333272">type</span>&nbsp;<span class="ident" id="3333277">netFD</span>&nbsp;<span class="keyword" id="3333283">struct</span>&nbsp;<span class="op" id="3333290">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3333293">//&nbsp;locking/lifetime&nbsp;of&nbsp;sysfd&nbsp;+&nbsp;serialize&nbsp;access&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3333368">fdmu</span>&nbsp;<span class="ident" id="3333373">fdMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3333383">//&nbsp;immutable&nbsp;until&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3333409">sysfd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3333421">int</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3333426">family</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3333438">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3333443">sotype</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3333455">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3333460">isConnected</span>&nbsp;<span class="builtintype" id="3333472">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3333478">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3333490">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3333498">laddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3333510">Addr</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3333516">raddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3333528">Addr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3333535">//&nbsp;wait&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3333551">pd</span>&nbsp;<span class="ident" id="3333554">pollDesc</span><br>
<span class="lineno"></span><span class="op" id="3333563">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="3333566">func</span>&nbsp;<span class="ident" id="3333571">sysInit</span><span class="op" id="3333578">(</span><span class="op" id="3333579">)</span>&nbsp;<span class="op" id="3333581">{</span><br>
<span class="lineno"></span><span class="op" id="3333583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3333586">func</span>&nbsp;<span class="ident" id="3333591">dial</span><span class="op" id="3333595">(</span><span class="ident" id="3333596">network</span>&nbsp;<span class="builtintype" id="3333604">string</span><span class="op" id="3333610">,</span>&nbsp;<span class="ident" id="3333612">ra</span>&nbsp;<span class="ident" id="3333615">Addr</span><span class="op" id="3333619">,</span>&nbsp;<span class="ident" id="3333621">dialer</span>&nbsp;<span class="keyword" id="3333628">func</span><span class="op" id="3333632">(</span><span class="ident" id="3333633">time</span><span class="op" id="3333637">.</span><span class="ident" id="3333638">Time</span><span class="op" id="3333642">)</span>&nbsp;<span class="op" id="3333644">(</span><span class="ident" id="3333645">Conn</span><span class="op" id="3333649">,</span>&nbsp;<span class="builtintype" id="3333651">error</span><span class="op" id="3333656">)</span><span class="op" id="3333657">,</span>&nbsp;<span class="ident" id="3333659">deadline</span>&nbsp;<span class="ident" id="3333668">time</span><span class="op" id="3333672">.</span><span class="ident" id="3333673">Time</span><span class="op" id="3333677">)</span>&nbsp;<span class="op" id="3333679">(</span><span class="ident" id="3333680">Conn</span><span class="op" id="3333684">,</span>&nbsp;<span class="builtintype" id="3333686">error</span><span class="op" id="3333691">)</span>&nbsp;<span class="op" id="3333693">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333696">return</span>&nbsp;<span class="ident" id="3333703">dialer</span><span class="op" id="3333709">(</span><span class="ident" id="3333710">deadline</span><span class="op" id="3333718">)</span><br>
<span class="lineno"></span><span class="op" id="3333720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3333723">func</span>&nbsp;<span class="ident" id="3333728">newFD</span><span class="op" id="3333733">(</span><span class="ident" id="3333734">sysfd</span><span class="op" id="3333739">,</span>&nbsp;<span class="ident" id="3333741">family</span><span class="op" id="3333747">,</span>&nbsp;<span class="ident" id="3333749">sotype</span>&nbsp;<span class="builtintype" id="3333756">int</span><span class="op" id="3333759">,</span>&nbsp;<span class="ident" id="3333761">net</span>&nbsp;<span class="builtintype" id="3333765">string</span><span class="op" id="3333771">)</span>&nbsp;<span class="op" id="3333773">(</span><span class="op" id="3333774">*</span><span class="ident" id="3333775">netFD</span><span class="op" id="3333780">,</span>&nbsp;<span class="builtintype" id="3333782">error</span><span class="op" id="3333787">)</span>&nbsp;<span class="op" id="3333789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333792">return</span>&nbsp;<span class="op" id="3333799">&amp;</span><span class="ident" id="3333800">netFD</span><span class="op" id="3333805">{</span><span class="ident" id="3333806">sysfd</span><span class="op" id="3333811">:</span>&nbsp;<span class="ident" id="3333813">sysfd</span><span class="op" id="3333818">,</span>&nbsp;<span class="ident" id="3333820">family</span><span class="op" id="3333826">:</span>&nbsp;<span class="ident" id="3333828">family</span><span class="op" id="3333834">,</span>&nbsp;<span class="ident" id="3333836">sotype</span><span class="op" id="3333842">:</span>&nbsp;<span class="ident" id="3333844">sotype</span><span class="op" id="3333850">,</span>&nbsp;<span class="ident" id="3333852">net</span><span class="op" id="3333855">:</span>&nbsp;<span class="ident" id="3333857">net</span><span class="op" id="3333860">}</span><span class="op" id="3333861">,</span>&nbsp;<span class="ident" id="3333863">nil</span><br>
<span class="lineno">45</span><span class="op" id="3333867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3333870">func</span>&nbsp;<span class="op" id="3333875">(</span><span class="ident" id="3333876">fd</span>&nbsp;<span class="op" id="3333879">*</span><span class="ident" id="3333880">netFD</span><span class="op" id="3333885">)</span>&nbsp;<span class="ident" id="3333887">init</span><span class="op" id="3333891">(</span><span class="op" id="3333892">)</span>&nbsp;<span class="builtintype" id="3333894">error</span>&nbsp;<span class="op" id="3333900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333903">if</span>&nbsp;<span class="ident" id="3333906">err</span>&nbsp;<span class="op" id="3333910">:=</span>&nbsp;<span class="ident" id="3333913">fd</span><span class="op" id="3333915">.</span><span class="ident" id="3333916">pd</span><span class="op" id="3333918">.</span><span class="ident" id="3333919">Init</span><span class="op" id="3333923">(</span><span class="ident" id="3333924">fd</span><span class="op" id="3333926">)</span><span class="op" id="3333927">;</span>&nbsp;<span class="ident" id="3333929">err</span>&nbsp;<span class="op" id="3333933">!=</span>&nbsp;<span class="ident" id="3333936">nil</span>&nbsp;<span class="op" id="3333940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333944">return</span>&nbsp;<span class="ident" id="3333951">err</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3333956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333959">return</span>&nbsp;<span class="ident" id="3333966">nil</span><br>
<span class="lineno"></span><span class="op" id="3333970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3333973">func</span>&nbsp;<span class="op" id="3333978">(</span><span class="ident" id="3333979">fd</span>&nbsp;<span class="op" id="3333982">*</span><span class="ident" id="3333983">netFD</span><span class="op" id="3333988">)</span>&nbsp;<span class="ident" id="3333990">setAddr</span><span class="op" id="3333997">(</span><span class="ident" id="3333998">laddr</span><span class="op" id="3334003">,</span>&nbsp;<span class="ident" id="3334005">raddr</span>&nbsp;<span class="ident" id="3334011">Addr</span><span class="op" id="3334015">)</span>&nbsp;<span class="op" id="3334017">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3334020">fd</span><span class="op" id="3334022">.</span><span class="ident" id="3334023">laddr</span>&nbsp;<span class="op" id="3334029">=</span>&nbsp;<span class="ident" id="3334031">laddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3334038">fd</span><span class="op" id="3334040">.</span><span class="ident" id="3334041">raddr</span>&nbsp;<span class="op" id="3334047">=</span>&nbsp;<span class="ident" id="3334049">raddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3334056">runtime</span><span class="op" id="3334063">.</span><span class="ident" id="3334064">SetFinalizer</span><span class="op" id="3334076">(</span><span class="ident" id="3334077">fd</span><span class="op" id="3334079">,</span>&nbsp;<span class="op" id="3334081">(</span><span class="op" id="3334082">*</span><span class="ident" id="3334083">netFD</span><span class="op" id="3334088">)</span><span class="op" id="3334089">.</span><span class="ident" id="3334090">Close</span><span class="op" id="3334095">)</span><br>
<span class="lineno"></span><span class="op" id="3334097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3334100">func</span>&nbsp;<span class="op" id="3334105">(</span><span class="ident" id="3334106">fd</span>&nbsp;<span class="op" id="3334109">*</span><span class="ident" id="3334110">netFD</span><span class="op" id="3334115">)</span>&nbsp;<span class="ident" id="3334117">name</span><span class="op" id="3334121">(</span><span class="op" id="3334122">)</span>&nbsp;<span class="builtintype" id="3334124">string</span>&nbsp;<span class="op" id="3334131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3334134">var</span>&nbsp;<span class="ident" id="3334138">ls</span><span class="op" id="3334140">,</span>&nbsp;<span class="ident" id="3334142">rs</span>&nbsp;<span class="builtintype" id="3334145">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3334153">if</span>&nbsp;<span class="ident" id="3334156">fd</span><span class="op" id="3334158">.</span><span class="ident" id="3334159">laddr</span>&nbsp;<span class="op" id="3334165">!=</span>&nbsp;<span class="ident" id="3334168">nil</span>&nbsp;<span class="op" id="3334172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3334176">ls</span>&nbsp;<span class="op" id="3334179">=</span>&nbsp;<span class="ident" id="3334181">fd</span><span class="op" id="3334183">.</span><span class="ident" id="3334184">laddr</span><span class="op" id="3334189">.</span><span class="ident" id="3334190">String</span><span class="op" id="3334196">(</span><span class="op" id="3334197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3334200">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3334203">if</span>&nbsp;<span class="ident" id="3334206">fd</span><span class="op" id="3334208">.</span><span class="ident" id="3334209">raddr</span>&nbsp;<span class="op" id="3334215">!=</span>&nbsp;<span class="ident" id="3334218">nil</span>&nbsp;<span class="op" id="3334222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3334226">rs</span>&nbsp;<span class="op" id="3334229">=</span>&nbsp;<span class="ident" id="3334231">fd</span><span class="op" id="3334233">.</span><span class="ident" id="3334234">raddr</span><span class="op" id="3334239">.</span><span class="ident" id="3334240">String</span><span class="op" id="3334246">(</span><span class="op" id="3334247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3334250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3334253">return</span>&nbsp;<span class="ident" id="3334260">fd</span><span class="op" id="3334262">.</span><span class="ident" id="3334263">net</span>&nbsp;<span class="op" id="3334267">+</span>&nbsp;<span class="string" id="3334269">&#34;:&#34;</span>&nbsp;<span class="op" id="3334273">+</span>&nbsp;<span class="ident" id="3334275">ls</span>&nbsp;<span class="op" id="3334278">+</span>&nbsp;<span class="string" id="3334280">&#34;-&gt;&#34;</span>&nbsp;<span class="op" id="3334285">+</span>&nbsp;<span class="ident" id="3334287">rs</span><br>
<span class="lineno"></span><span class="op" id="3334290">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="3334293">func</span>&nbsp;<span class="op" id="3334298">(</span><span class="ident" id="3334299">fd</span>&nbsp;<span class="op" id="3334302">*</span><span class="ident" id="3334303">netFD</span><span class="op" id="3334308">)</span>&nbsp;<span class="ident" id="3334310">connect</span><span class="op" id="3334317">(</span><span class="ident" id="3334318">la</span><span class="op" id="3334320">,</span>&nbsp;<span class="ident" id="3334322">ra</span>&nbsp;<span class="ident" id="3334325">syscall</span><span class="op" id="3334332">.</span><span class="ident" id="3334333">Sockaddr</span><span class="op" id="3334341">,</span>&nbsp;<span class="ident" id="3334343">deadline</span>&nbsp;<span class="ident" id="3334352">time</span><span class="op" id="3334356">.</span><span class="ident" id="3334357">Time</span><span class="op" id="3334361">)</span>&nbsp;<span class="builtintype" id="3334363">error</span>&nbsp;<span class="op" id="3334369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3334372">//&nbsp;Do&nbsp;not&nbsp;need&nbsp;to&nbsp;call&nbsp;fd.writeLock&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3334415">//&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;yet&nbsp;accessible&nbsp;to&nbsp;user,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3334461">//&nbsp;so&nbsp;no&nbsp;concurrent&nbsp;operations&nbsp;are&nbsp;possible.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3334507">switch</span>&nbsp;<span class="ident" id="3334514">err</span>&nbsp;<span class="op" id="3334518">:=</span>&nbsp;<span class="ident" id="3334521">syscall</span><span class="op" id="3334528">.</span><span class="ident" id="3334529">Connect</span><span class="op" id="3334536">(</span><span class="ident" id="3334537">fd</span><span class="op" id="3334539">.</span><span class="ident" id="3334540">sysfd</span><span class="op" id="3334545">,</span>&nbsp;<span class="ident" id="3334547">ra</span><span class="op" id="3334549">)</span><span class="op" id="3334550">;</span>&nbsp;<span class="ident" id="3334552">err</span>&nbsp;<span class="op" id="3334556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3334559">case</span>&nbsp;<span class="ident" id="3334564">syscall</span><span class="op" id="3334571">.</span><span class="ident" id="3334572">EINPROGRESS</span><span class="op" id="3334583">,</span>&nbsp;<span class="ident" id="3334585">syscall</span><span class="op" id="3334592">.</span><span class="ident" id="3334593">EALREADY</span><span class="op" id="3334601">,</span>&nbsp;<span class="ident" id="3334603">syscall</span><span class="op" id="3334610">.</span><span class="ident" id="3334611">EINTR</span><span class="op" id="3334616">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3334619">case</span>&nbsp;<span class="ident" id="3334624">nil</span><span class="op" id="3334627">,</span>&nbsp;<span class="ident" id="3334629">syscall</span><span class="op" id="3334636">.</span><span class="ident" id="3334637">EISCONN</span><span class="op" id="3334644">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3334648">if</span>&nbsp;<span class="op" id="3334651">!</span><span class="ident" id="3334652">deadline</span><span class="op" id="3334660">.</span><span class="ident" id="3334661">IsZero</span><span class="op" id="3334667">(</span><span class="op" id="3334668">)</span>&nbsp;<span class="op" id="3334670">&amp;&amp;</span>&nbsp;<span class="ident" id="3334673">deadline</span><span class="op" id="3334681">.</span><span class="ident" id="3334682">Before</span><span class="op" id="3334688">(</span><span class="ident" id="3334689">time</span><span class="op" id="3334693">.</span><span class="ident" id="3334694">Now</span><span class="op" id="3334697">(</span><span class="op" id="3334698">)</span><span class="op" id="3334699">)</span>&nbsp;<span class="op" id="3334701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3334706">return</span>&nbsp;<span class="ident" id="3334713">errTimeout</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3334726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3334730">if</span>&nbsp;<span class="ident" id="3334733">err</span>&nbsp;<span class="op" id="3334737">:=</span>&nbsp;<span class="ident" id="3334740">fd</span><span class="op" id="3334742">.</span><span class="ident" id="3334743">init</span><span class="op" id="3334747">(</span><span class="op" id="3334748">)</span><span class="op" id="3334749">;</span>&nbsp;<span class="ident" id="3334751">err</span>&nbsp;<span class="op" id="3334755">!=</span>&nbsp;<span class="ident" id="3334758">nil</span>&nbsp;<span class="op" id="3334762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3334767">return</span>&nbsp;<span class="ident" id="3334774">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3334780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3334784">return</span>&nbsp;<span class="ident" id="3334791">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3334796">case</span>&nbsp;<span class="ident" id="3334801">syscall</span><span class="op" id="3334808">.</span><span class="ident" id="3334809">EINVAL</span><span class="op" id="3334815">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3334819">//&nbsp;On&nbsp;Solaris&nbsp;we&nbsp;can&nbsp;see&nbsp;EINVAL&nbsp;if&nbsp;the&nbsp;socket&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3334871">//&nbsp;already&nbsp;been&nbsp;accepted&nbsp;and&nbsp;closed&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3334924">//&nbsp;Treat&nbsp;this&nbsp;as&nbsp;a&nbsp;successful&nbsp;connection--writes&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3334978">//&nbsp;the&nbsp;socket&nbsp;will&nbsp;see&nbsp;EOF.&nbsp;&nbsp;For&nbsp;details&nbsp;and&nbsp;a&nbsp;test</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3335032">//&nbsp;case&nbsp;in&nbsp;C&nbsp;see&nbsp;http://golang.org/issue/6828.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3335081">if</span>&nbsp;<span class="ident" id="3335084">runtime</span><span class="op" id="3335091">.</span><span class="ident" id="3335092">GOOS</span>&nbsp;<span class="op" id="3335097">==</span>&nbsp;<span class="string" id="3335100">&#34;solaris&#34;</span>&nbsp;<span class="op" id="3335110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3335115">return</span>&nbsp;<span class="ident" id="3335122">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3335128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3335132">fallthrough</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3335145">default</span><span class="op" id="3335152">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3335156">return</span>&nbsp;<span class="ident" id="3335163">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3335168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3335171">if</span>&nbsp;<span class="ident" id="3335174">err</span>&nbsp;<span class="op" id="3335178">:=</span>&nbsp;<span class="ident" id="3335181">fd</span><span class="op" id="3335183">.</span><span class="ident" id="3335184">init</span><span class="op" id="3335188">(</span><span class="op" id="3335189">)</span><span class="op" id="3335190">;</span>&nbsp;<span class="ident" id="3335192">err</span>&nbsp;<span class="op" id="3335196">!=</span>&nbsp;<span class="ident" id="3335199">nil</span>&nbsp;<span class="op" id="3335203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3335207">return</span>&nbsp;<span class="ident" id="3335214">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3335219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3335222">if</span>&nbsp;<span class="op" id="3335225">!</span><span class="ident" id="3335226">deadline</span><span class="op" id="3335234">.</span><span class="ident" id="3335235">IsZero</span><span class="op" id="3335241">(</span><span class="op" id="3335242">)</span>&nbsp;<span class="op" id="3335244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3335248">fd</span><span class="op" id="3335250">.</span><span class="ident" id="3335251">setWriteDeadline</span><span class="op" id="3335267">(</span><span class="ident" id="3335268">deadline</span><span class="op" id="3335276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3335280">defer</span>&nbsp;<span class="ident" id="3335286">fd</span><span class="op" id="3335288">.</span><span class="ident" id="3335289">setWriteDeadline</span><span class="op" id="3335305">(</span><span class="ident" id="3335306">noDeadline</span><span class="op" id="3335316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3335319">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3335322">for</span>&nbsp;<span class="op" id="3335326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3335330">//&nbsp;Performing&nbsp;multiple&nbsp;connect&nbsp;system&nbsp;calls&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3335381">//&nbsp;non-blocking&nbsp;socket&nbsp;under&nbsp;Unix&nbsp;variants&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3335435">//&nbsp;necessarily&nbsp;result&nbsp;in&nbsp;earlier&nbsp;errors&nbsp;being</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3335483">//&nbsp;returned.&nbsp;Instead,&nbsp;once&nbsp;runtime-integrated&nbsp;network</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3335539">//&nbsp;poller&nbsp;tells&nbsp;us&nbsp;that&nbsp;the&nbsp;socket&nbsp;is&nbsp;ready,&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3335594">//&nbsp;SO_ERROR&nbsp;socket&nbsp;option&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3335647">//&nbsp;succeeded&nbsp;or&nbsp;failed.&nbsp;See&nbsp;issue&nbsp;7474&nbsp;for&nbsp;further</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3335700">//&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3335714">if</span>&nbsp;<span class="ident" id="3335717">err</span>&nbsp;<span class="op" id="3335721">:=</span>&nbsp;<span class="ident" id="3335724">fd</span><span class="op" id="3335726">.</span><span class="ident" id="3335727">pd</span><span class="op" id="3335729">.</span><span class="ident" id="3335730">WaitWrite</span><span class="op" id="3335739">(</span><span class="op" id="3335740">)</span><span class="op" id="3335741">;</span>&nbsp;<span class="ident" id="3335743">err</span>&nbsp;<span class="op" id="3335747">!=</span>&nbsp;<span class="ident" id="3335750">nil</span>&nbsp;<span class="op" id="3335754">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3335759">return</span>&nbsp;<span class="ident" id="3335766">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3335772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3335776">nerr</span><span class="op" id="3335780">,</span>&nbsp;<span class="ident" id="3335782">err</span>&nbsp;<span class="op" id="3335786">:=</span>&nbsp;<span class="ident" id="3335789">syscall</span><span class="op" id="3335796">.</span><span class="ident" id="3335797">GetsockoptInt</span><span class="op" id="3335810">(</span><span class="ident" id="3335811">fd</span><span class="op" id="3335813">.</span><span class="ident" id="3335814">sysfd</span><span class="op" id="3335819">,</span>&nbsp;<span class="ident" id="3335821">syscall</span><span class="op" id="3335828">.</span><span class="ident" id="3335829">SOL_SOCKET</span><span class="op" id="3335839">,</span>&nbsp;<span class="ident" id="3335841">syscall</span><span class="op" id="3335848">.</span><span class="ident" id="3335849">SO_ERROR</span><span class="op" id="3335857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3335861">if</span>&nbsp;<span class="ident" id="3335864">err</span>&nbsp;<span class="op" id="3335868">!=</span>&nbsp;<span class="ident" id="3335871">nil</span>&nbsp;<span class="op" id="3335875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3335880">return</span>&nbsp;<span class="ident" id="3335887">err</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3335893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3335897">switch</span>&nbsp;<span class="ident" id="3335904">err</span>&nbsp;<span class="op" id="3335908">:=</span>&nbsp;<span class="ident" id="3335911">syscall</span><span class="op" id="3335918">.</span><span class="ident" id="3335919">Errno</span><span class="op" id="3335924">(</span><span class="ident" id="3335925">nerr</span><span class="op" id="3335929">)</span><span class="op" id="3335930">;</span>&nbsp;<span class="ident" id="3335932">err</span>&nbsp;<span class="op" id="3335936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3335940">case</span>&nbsp;<span class="ident" id="3335945">syscall</span><span class="op" id="3335952">.</span><span class="ident" id="3335953">EINPROGRESS</span><span class="op" id="3335964">,</span>&nbsp;<span class="ident" id="3335966">syscall</span><span class="op" id="3335973">.</span><span class="ident" id="3335974">EALREADY</span><span class="op" id="3335982">,</span>&nbsp;<span class="ident" id="3335984">syscall</span><span class="op" id="3335991">.</span><span class="ident" id="3335992">EINTR</span><span class="op" id="3335997">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3336001">case</span>&nbsp;<span class="ident" id="3336006">syscall</span><span class="op" id="3336013">.</span><span class="ident" id="3336014">Errno</span><span class="op" id="3336019">(</span><span class="num" id="3336020">0</span><span class="op" id="3336021">)</span><span class="op" id="3336022">,</span>&nbsp;<span class="ident" id="3336024">syscall</span><span class="op" id="3336031">.</span><span class="ident" id="3336032">EISCONN</span><span class="op" id="3336039">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3336044">return</span>&nbsp;<span class="ident" id="3336051">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3336057">default</span><span class="op" id="3336064">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3336069">return</span>&nbsp;<span class="ident" id="3336076">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3336082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3336085">}</span><br>
<span class="lineno"></span><span class="op" id="3336087">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="keyword" id="3336090">func</span>&nbsp;<span class="op" id="3336095">(</span><span class="ident" id="3336096">fd</span>&nbsp;<span class="op" id="3336099">*</span><span class="ident" id="3336100">netFD</span><span class="op" id="3336105">)</span>&nbsp;<span class="ident" id="3336107">destroy</span><span class="op" id="3336114">(</span><span class="op" id="3336115">)</span>&nbsp;<span class="op" id="3336117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3336120">//&nbsp;Poller&nbsp;may&nbsp;want&nbsp;to&nbsp;unregister&nbsp;fd&nbsp;in&nbsp;readiness&nbsp;notification&nbsp;mechanism,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3336194">//&nbsp;so&nbsp;this&nbsp;must&nbsp;be&nbsp;executed&nbsp;before&nbsp;closesocket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3336243">fd</span><span class="op" id="3336245">.</span><span class="ident" id="3336246">pd</span><span class="op" id="3336248">.</span><span class="ident" id="3336249">Close</span><span class="op" id="3336254">(</span><span class="op" id="3336255">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3336258">closesocket</span><span class="op" id="3336269">(</span><span class="ident" id="3336270">fd</span><span class="op" id="3336272">.</span><span class="ident" id="3336273">sysfd</span><span class="op" id="3336278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3336281">fd</span><span class="op" id="3336283">.</span><span class="ident" id="3336284">sysfd</span>&nbsp;<span class="op" id="3336290">=</span>&nbsp;<span class="op" id="3336292">-</span><span class="num" id="3336293">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3336296">runtime</span><span class="op" id="3336303">.</span><span class="ident" id="3336304">SetFinalizer</span><span class="op" id="3336316">(</span><span class="ident" id="3336317">fd</span><span class="op" id="3336319">,</span>&nbsp;<span class="ident" id="3336321">nil</span><span class="op" id="3336324">)</span><br>
<span class="lineno"></span><span class="op" id="3336326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3336329">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd.</span><br>
<span class="lineno"></span><span class="comment" id="3336360">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3336406">func</span>&nbsp;<span class="op" id="3336411">(</span><span class="ident" id="3336412">fd</span>&nbsp;<span class="op" id="3336415">*</span><span class="ident" id="3336416">netFD</span><span class="op" id="3336421">)</span>&nbsp;<span class="ident" id="3336423">incref</span><span class="op" id="3336429">(</span><span class="op" id="3336430">)</span>&nbsp;<span class="builtintype" id="3336432">error</span>&nbsp;<span class="op" id="3336438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3336441">if</span>&nbsp;<span class="op" id="3336444">!</span><span class="ident" id="3336445">fd</span><span class="op" id="3336447">.</span><span class="ident" id="3336448">fdmu</span><span class="op" id="3336452">.</span><span class="ident" id="3336453">Incref</span><span class="op" id="3336459">(</span><span class="op" id="3336460">)</span>&nbsp;<span class="op" id="3336462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3336466">return</span>&nbsp;<span class="ident" id="3336473">errClosing</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3336485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3336488">return</span>&nbsp;<span class="ident" id="3336495">nil</span><br>
<span class="lineno"></span><span class="op" id="3336499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3336502">//&nbsp;Remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD&nbsp;and&nbsp;close&nbsp;if&nbsp;we&#39;ve&nbsp;been&nbsp;asked&nbsp;to&nbsp;do&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="3336574">//&nbsp;(and&nbsp;there&nbsp;are&nbsp;no&nbsp;references&nbsp;left).</span><br>
<span class="lineno"></span><span class="keyword" id="3336613">func</span>&nbsp;<span class="op" id="3336618">(</span><span class="ident" id="3336619">fd</span>&nbsp;<span class="op" id="3336622">*</span><span class="ident" id="3336623">netFD</span><span class="op" id="3336628">)</span>&nbsp;<span class="ident" id="3336630">decref</span><span class="op" id="3336636">(</span><span class="op" id="3336637">)</span>&nbsp;<span class="op" id="3336639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3336642">if</span>&nbsp;<span class="ident" id="3336645">fd</span><span class="op" id="3336647">.</span><span class="ident" id="3336648">fdmu</span><span class="op" id="3336652">.</span><span class="ident" id="3336653">Decref</span><span class="op" id="3336659">(</span><span class="op" id="3336660">)</span>&nbsp;<span class="op" id="3336662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3336666">fd</span><span class="op" id="3336668">.</span><span class="ident" id="3336669">destroy</span><span class="op" id="3336676">(</span><span class="op" id="3336677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3336680">}</span><br>
<span class="lineno">155</span><span class="op" id="3336682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3336685">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="3336737">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3336783">func</span>&nbsp;<span class="op" id="3336788">(</span><span class="ident" id="3336789">fd</span>&nbsp;<span class="op" id="3336792">*</span><span class="ident" id="3336793">netFD</span><span class="op" id="3336798">)</span>&nbsp;<span class="ident" id="3336800">readLock</span><span class="op" id="3336808">(</span><span class="op" id="3336809">)</span>&nbsp;<span class="builtintype" id="3336811">error</span>&nbsp;<span class="op" id="3336817">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3336820">if</span>&nbsp;<span class="op" id="3336823">!</span><span class="ident" id="3336824">fd</span><span class="op" id="3336826">.</span><span class="ident" id="3336827">fdmu</span><span class="op" id="3336831">.</span><span class="ident" id="3336832">RWLock</span><span class="op" id="3336838">(</span><span class="ident" id="3336839">true</span><span class="op" id="3336843">)</span>&nbsp;<span class="op" id="3336845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3336849">return</span>&nbsp;<span class="ident" id="3336856">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3336868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3336871">return</span>&nbsp;<span class="ident" id="3336878">nil</span><br>
<span class="lineno"></span><span class="op" id="3336882">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="3336885">//&nbsp;Unlock&nbsp;for&nbsp;reading&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3336942">func</span>&nbsp;<span class="op" id="3336947">(</span><span class="ident" id="3336948">fd</span>&nbsp;<span class="op" id="3336951">*</span><span class="ident" id="3336952">netFD</span><span class="op" id="3336957">)</span>&nbsp;<span class="ident" id="3336959">readUnlock</span><span class="op" id="3336969">(</span><span class="op" id="3336970">)</span>&nbsp;<span class="op" id="3336972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3336975">if</span>&nbsp;<span class="ident" id="3336978">fd</span><span class="op" id="3336980">.</span><span class="ident" id="3336981">fdmu</span><span class="op" id="3336985">.</span><span class="ident" id="3336986">RWUnlock</span><span class="op" id="3336994">(</span><span class="ident" id="3336995">true</span><span class="op" id="3336999">)</span>&nbsp;<span class="op" id="3337001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3337005">fd</span><span class="op" id="3337007">.</span><span class="ident" id="3337008">destroy</span><span class="op" id="3337015">(</span><span class="op" id="3337016">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3337019">}</span><br>
<span class="lineno"></span><span class="op" id="3337021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3337024">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="3337076">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno">175</span><span class="keyword" id="3337122">func</span>&nbsp;<span class="op" id="3337127">(</span><span class="ident" id="3337128">fd</span>&nbsp;<span class="op" id="3337131">*</span><span class="ident" id="3337132">netFD</span><span class="op" id="3337137">)</span>&nbsp;<span class="ident" id="3337139">writeLock</span><span class="op" id="3337148">(</span><span class="op" id="3337149">)</span>&nbsp;<span class="builtintype" id="3337151">error</span>&nbsp;<span class="op" id="3337157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3337160">if</span>&nbsp;<span class="op" id="3337163">!</span><span class="ident" id="3337164">fd</span><span class="op" id="3337166">.</span><span class="ident" id="3337167">fdmu</span><span class="op" id="3337171">.</span><span class="ident" id="3337172">RWLock</span><span class="op" id="3337178">(</span><span class="ident" id="3337179">false</span><span class="op" id="3337184">)</span>&nbsp;<span class="op" id="3337186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3337190">return</span>&nbsp;<span class="ident" id="3337197">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3337209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3337212">return</span>&nbsp;<span class="ident" id="3337219">nil</span><br>
<span class="lineno">180</span><span class="op" id="3337223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3337226">//&nbsp;Unlock&nbsp;for&nbsp;writing&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3337283">func</span>&nbsp;<span class="op" id="3337288">(</span><span class="ident" id="3337289">fd</span>&nbsp;<span class="op" id="3337292">*</span><span class="ident" id="3337293">netFD</span><span class="op" id="3337298">)</span>&nbsp;<span class="ident" id="3337300">writeUnlock</span><span class="op" id="3337311">(</span><span class="op" id="3337312">)</span>&nbsp;<span class="op" id="3337314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3337317">if</span>&nbsp;<span class="ident" id="3337320">fd</span><span class="op" id="3337322">.</span><span class="ident" id="3337323">fdmu</span><span class="op" id="3337327">.</span><span class="ident" id="3337328">RWUnlock</span><span class="op" id="3337336">(</span><span class="ident" id="3337337">false</span><span class="op" id="3337342">)</span>&nbsp;<span class="op" id="3337344">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3337348">fd</span><span class="op" id="3337350">.</span><span class="ident" id="3337351">destroy</span><span class="op" id="3337358">(</span><span class="op" id="3337359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3337362">}</span><br>
<span class="lineno"></span><span class="op" id="3337364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3337367">func</span>&nbsp;<span class="op" id="3337372">(</span><span class="ident" id="3337373">fd</span>&nbsp;<span class="op" id="3337376">*</span><span class="ident" id="3337377">netFD</span><span class="op" id="3337382">)</span>&nbsp;<span class="ident" id="3337384">Close</span><span class="op" id="3337389">(</span><span class="op" id="3337390">)</span>&nbsp;<span class="builtintype" id="3337392">error</span>&nbsp;<span class="op" id="3337398">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3337401">fd</span><span class="op" id="3337403">.</span><span class="ident" id="3337404">pd</span><span class="op" id="3337406">.</span><span class="ident" id="3337407">Lock</span><span class="op" id="3337411">(</span><span class="op" id="3337412">)</span>&nbsp;<span class="comment" id="3337414">//&nbsp;needed&nbsp;for&nbsp;both&nbsp;fd.incref(true)&nbsp;and&nbsp;pollDesc.Evict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3337469">if</span>&nbsp;<span class="op" id="3337472">!</span><span class="ident" id="3337473">fd</span><span class="op" id="3337475">.</span><span class="ident" id="3337476">fdmu</span><span class="op" id="3337480">.</span><span class="ident" id="3337481">IncrefAndClose</span><span class="op" id="3337495">(</span><span class="op" id="3337496">)</span>&nbsp;<span class="op" id="3337498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3337502">fd</span><span class="op" id="3337504">.</span><span class="ident" id="3337505">pd</span><span class="op" id="3337507">.</span><span class="ident" id="3337508">Unlock</span><span class="op" id="3337514">(</span><span class="op" id="3337515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3337519">return</span>&nbsp;<span class="ident" id="3337526">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3337538">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3337541">//&nbsp;Unblock&nbsp;any&nbsp;I/O.&nbsp;&nbsp;Once&nbsp;it&nbsp;all&nbsp;unblocks&nbsp;and&nbsp;returns,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3337597">//&nbsp;so&nbsp;that&nbsp;it&nbsp;cannot&nbsp;be&nbsp;referring&nbsp;to&nbsp;fd.sysfd&nbsp;anymore,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3337653">//&nbsp;the&nbsp;final&nbsp;decref&nbsp;will&nbsp;close&nbsp;fd.sysfd.&nbsp;&nbsp;This&nbsp;should&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3337715">//&nbsp;fairly&nbsp;quickly,&nbsp;since&nbsp;all&nbsp;the&nbsp;I/O&nbsp;is&nbsp;non-blocking,&nbsp;and&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3337778">//&nbsp;attempts&nbsp;to&nbsp;block&nbsp;in&nbsp;the&nbsp;pollDesc&nbsp;will&nbsp;return&nbsp;errClosing.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3337840">doWakeup</span>&nbsp;<span class="op" id="3337849">:=</span>&nbsp;<span class="ident" id="3337852">fd</span><span class="op" id="3337854">.</span><span class="ident" id="3337855">pd</span><span class="op" id="3337857">.</span><span class="ident" id="3337858">Evict</span><span class="op" id="3337863">(</span><span class="op" id="3337864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3337867">fd</span><span class="op" id="3337869">.</span><span class="ident" id="3337870">pd</span><span class="op" id="3337872">.</span><span class="ident" id="3337873">Unlock</span><span class="op" id="3337879">(</span><span class="op" id="3337880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3337883">fd</span><span class="op" id="3337885">.</span><span class="ident" id="3337886">decref</span><span class="op" id="3337892">(</span><span class="op" id="3337893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3337896">if</span>&nbsp;<span class="ident" id="3337899">doWakeup</span>&nbsp;<span class="op" id="3337908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3337912">fd</span><span class="op" id="3337914">.</span><span class="ident" id="3337915">pd</span><span class="op" id="3337917">.</span><span class="ident" id="3337918">Wakeup</span><span class="op" id="3337924">(</span><span class="op" id="3337925">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3337928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3337931">return</span>&nbsp;<span class="ident" id="3337938">nil</span><br>
<span class="lineno"></span><span class="op" id="3337942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3337945">func</span>&nbsp;<span class="op" id="3337950">(</span><span class="ident" id="3337951">fd</span>&nbsp;<span class="op" id="3337954">*</span><span class="ident" id="3337955">netFD</span><span class="op" id="3337960">)</span>&nbsp;<span class="ident" id="3337962">shutdown</span><span class="op" id="3337970">(</span><span class="ident" id="3337971">how</span>&nbsp;<span class="builtintype" id="3337975">int</span><span class="op" id="3337978">)</span>&nbsp;<span class="builtintype" id="3337980">error</span>&nbsp;<span class="op" id="3337986">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3337989">if</span>&nbsp;<span class="ident" id="3337992">err</span>&nbsp;<span class="op" id="3337996">:=</span>&nbsp;<span class="ident" id="3337999">fd</span><span class="op" id="3338001">.</span><span class="ident" id="3338002">incref</span><span class="op" id="3338008">(</span><span class="op" id="3338009">)</span><span class="op" id="3338010">;</span>&nbsp;<span class="ident" id="3338012">err</span>&nbsp;<span class="op" id="3338016">!=</span>&nbsp;<span class="ident" id="3338019">nil</span>&nbsp;<span class="op" id="3338023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338027">return</span>&nbsp;<span class="ident" id="3338034">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3338039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338042">defer</span>&nbsp;<span class="ident" id="3338048">fd</span><span class="op" id="3338050">.</span><span class="ident" id="3338051">decref</span><span class="op" id="3338057">(</span><span class="op" id="3338058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3338061">err</span>&nbsp;<span class="op" id="3338065">:=</span>&nbsp;<span class="ident" id="3338068">syscall</span><span class="op" id="3338075">.</span><span class="ident" id="3338076">Shutdown</span><span class="op" id="3338084">(</span><span class="ident" id="3338085">fd</span><span class="op" id="3338087">.</span><span class="ident" id="3338088">sysfd</span><span class="op" id="3338093">,</span>&nbsp;<span class="ident" id="3338095">how</span><span class="op" id="3338098">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338101">if</span>&nbsp;<span class="ident" id="3338104">err</span>&nbsp;<span class="op" id="3338108">!=</span>&nbsp;<span class="ident" id="3338111">nil</span>&nbsp;<span class="op" id="3338115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338119">return</span>&nbsp;<span class="op" id="3338126">&amp;</span><span class="ident" id="3338127">OpError</span><span class="op" id="3338134">{</span><span class="string" id="3338135">&#34;shutdown&#34;</span><span class="op" id="3338145">,</span>&nbsp;<span class="ident" id="3338147">fd</span><span class="op" id="3338149">.</span><span class="ident" id="3338150">net</span><span class="op" id="3338153">,</span>&nbsp;<span class="ident" id="3338155">fd</span><span class="op" id="3338157">.</span><span class="ident" id="3338158">laddr</span><span class="op" id="3338163">,</span>&nbsp;<span class="ident" id="3338165">err</span><span class="op" id="3338168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3338171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338174">return</span>&nbsp;<span class="ident" id="3338181">nil</span><br>
<span class="lineno"></span><span class="op" id="3338185">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="3338188">func</span>&nbsp;<span class="op" id="3338193">(</span><span class="ident" id="3338194">fd</span>&nbsp;<span class="op" id="3338197">*</span><span class="ident" id="3338198">netFD</span><span class="op" id="3338203">)</span>&nbsp;<span class="ident" id="3338205">closeRead</span><span class="op" id="3338214">(</span><span class="op" id="3338215">)</span>&nbsp;<span class="builtintype" id="3338217">error</span>&nbsp;<span class="op" id="3338223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338226">return</span>&nbsp;<span class="ident" id="3338233">fd</span><span class="op" id="3338235">.</span><span class="ident" id="3338236">shutdown</span><span class="op" id="3338244">(</span><span class="ident" id="3338245">syscall</span><span class="op" id="3338252">.</span><span class="ident" id="3338253">SHUT_RD</span><span class="op" id="3338260">)</span><br>
<span class="lineno"></span><span class="op" id="3338262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="3338265">func</span>&nbsp;<span class="op" id="3338270">(</span><span class="ident" id="3338271">fd</span>&nbsp;<span class="op" id="3338274">*</span><span class="ident" id="3338275">netFD</span><span class="op" id="3338280">)</span>&nbsp;<span class="ident" id="3338282">closeWrite</span><span class="op" id="3338292">(</span><span class="op" id="3338293">)</span>&nbsp;<span class="builtintype" id="3338295">error</span>&nbsp;<span class="op" id="3338301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338304">return</span>&nbsp;<span class="ident" id="3338311">fd</span><span class="op" id="3338313">.</span><span class="ident" id="3338314">shutdown</span><span class="op" id="3338322">(</span><span class="ident" id="3338323">syscall</span><span class="op" id="3338330">.</span><span class="ident" id="3338331">SHUT_WR</span><span class="op" id="3338338">)</span><br>
<span class="lineno"></span><span class="op" id="3338340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3338343">func</span>&nbsp;<span class="op" id="3338348">(</span><span class="ident" id="3338349">fd</span>&nbsp;<span class="op" id="3338352">*</span><span class="ident" id="3338353">netFD</span><span class="op" id="3338358">)</span>&nbsp;<span class="ident" id="3338360">Read</span><span class="op" id="3338364">(</span><span class="ident" id="3338365">p</span>&nbsp;<span class="op" id="3338367">[</span><span class="op" id="3338368">]</span><span class="builtintype" id="3338369">byte</span><span class="op" id="3338373">)</span>&nbsp;<span class="op" id="3338375">(</span><span class="ident" id="3338376">n</span>&nbsp;<span class="builtintype" id="3338378">int</span><span class="op" id="3338381">,</span>&nbsp;<span class="ident" id="3338383">err</span>&nbsp;<span class="builtintype" id="3338387">error</span><span class="op" id="3338392">)</span>&nbsp;<span class="op" id="3338394">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338397">if</span>&nbsp;<span class="ident" id="3338400">err</span>&nbsp;<span class="op" id="3338404">:=</span>&nbsp;<span class="ident" id="3338407">fd</span><span class="op" id="3338409">.</span><span class="ident" id="3338410">readLock</span><span class="op" id="3338418">(</span><span class="op" id="3338419">)</span><span class="op" id="3338420">;</span>&nbsp;<span class="ident" id="3338422">err</span>&nbsp;<span class="op" id="3338426">!=</span>&nbsp;<span class="ident" id="3338429">nil</span>&nbsp;<span class="op" id="3338433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338437">return</span>&nbsp;<span class="num" id="3338444">0</span><span class="op" id="3338445">,</span>&nbsp;<span class="ident" id="3338447">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3338452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338455">defer</span>&nbsp;<span class="ident" id="3338461">fd</span><span class="op" id="3338463">.</span><span class="ident" id="3338464">readUnlock</span><span class="op" id="3338474">(</span><span class="op" id="3338475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338478">if</span>&nbsp;<span class="ident" id="3338481">err</span>&nbsp;<span class="op" id="3338485">:=</span>&nbsp;<span class="ident" id="3338488">fd</span><span class="op" id="3338490">.</span><span class="ident" id="3338491">pd</span><span class="op" id="3338493">.</span><span class="ident" id="3338494">PrepareRead</span><span class="op" id="3338505">(</span><span class="op" id="3338506">)</span><span class="op" id="3338507">;</span>&nbsp;<span class="ident" id="3338509">err</span>&nbsp;<span class="op" id="3338513">!=</span>&nbsp;<span class="ident" id="3338516">nil</span>&nbsp;<span class="op" id="3338520">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338524">return</span>&nbsp;<span class="num" id="3338531">0</span><span class="op" id="3338532">,</span>&nbsp;<span class="op" id="3338534">&amp;</span><span class="ident" id="3338535">OpError</span><span class="op" id="3338542">{</span><span class="string" id="3338543">&#34;read&#34;</span><span class="op" id="3338549">,</span>&nbsp;<span class="ident" id="3338551">fd</span><span class="op" id="3338553">.</span><span class="ident" id="3338554">net</span><span class="op" id="3338557">,</span>&nbsp;<span class="ident" id="3338559">fd</span><span class="op" id="3338561">.</span><span class="ident" id="3338562">raddr</span><span class="op" id="3338567">,</span>&nbsp;<span class="ident" id="3338569">err</span><span class="op" id="3338572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3338575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338578">for</span>&nbsp;<span class="op" id="3338582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3338586">n</span><span class="op" id="3338587">,</span>&nbsp;<span class="ident" id="3338589">err</span>&nbsp;<span class="op" id="3338593">=</span>&nbsp;<span class="ident" id="3338595">syscall</span><span class="op" id="3338602">.</span><span class="ident" id="3338603">Read</span><span class="op" id="3338607">(</span><span class="builtintype" id="3338608">int</span><span class="op" id="3338611">(</span><span class="ident" id="3338612">fd</span><span class="op" id="3338614">.</span><span class="ident" id="3338615">sysfd</span><span class="op" id="3338620">)</span><span class="op" id="3338621">,</span>&nbsp;<span class="ident" id="3338623">p</span><span class="op" id="3338624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338628">if</span>&nbsp;<span class="ident" id="3338631">err</span>&nbsp;<span class="op" id="3338635">!=</span>&nbsp;<span class="ident" id="3338638">nil</span>&nbsp;<span class="op" id="3338642">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3338647">n</span>&nbsp;<span class="op" id="3338649">=</span>&nbsp;<span class="num" id="3338651">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338656">if</span>&nbsp;<span class="ident" id="3338659">err</span>&nbsp;<span class="op" id="3338663">==</span>&nbsp;<span class="ident" id="3338666">syscall</span><span class="op" id="3338673">.</span><span class="ident" id="3338674">EAGAIN</span>&nbsp;<span class="op" id="3338681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338687">if</span>&nbsp;<span class="ident" id="3338690">err</span>&nbsp;<span class="op" id="3338694">=</span>&nbsp;<span class="ident" id="3338696">fd</span><span class="op" id="3338698">.</span><span class="ident" id="3338699">pd</span><span class="op" id="3338701">.</span><span class="ident" id="3338702">WaitRead</span><span class="op" id="3338710">(</span><span class="op" id="3338711">)</span><span class="op" id="3338712">;</span>&nbsp;<span class="ident" id="3338714">err</span>&nbsp;<span class="op" id="3338718">==</span>&nbsp;<span class="ident" id="3338721">nil</span>&nbsp;<span class="op" id="3338725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338732">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3338745">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3338750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3338754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3338758">err</span>&nbsp;<span class="op" id="3338762">=</span>&nbsp;<span class="ident" id="3338764">chkReadErr</span><span class="op" id="3338774">(</span><span class="ident" id="3338775">n</span><span class="op" id="3338776">,</span>&nbsp;<span class="ident" id="3338778">err</span><span class="op" id="3338781">,</span>&nbsp;<span class="ident" id="3338783">fd</span><span class="op" id="3338785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338789">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3338796">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338799">if</span>&nbsp;<span class="ident" id="3338802">err</span>&nbsp;<span class="op" id="3338806">!=</span>&nbsp;<span class="ident" id="3338809">nil</span>&nbsp;<span class="op" id="3338813">&amp;&amp;</span>&nbsp;<span class="ident" id="3338816">err</span>&nbsp;<span class="op" id="3338820">!=</span>&nbsp;<span class="ident" id="3338823">io</span><span class="op" id="3338825">.</span><span class="ident" id="3338826">EOF</span>&nbsp;<span class="op" id="3338830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3338834">err</span>&nbsp;<span class="op" id="3338838">=</span>&nbsp;<span class="op" id="3338840">&amp;</span><span class="ident" id="3338841">OpError</span><span class="op" id="3338848">{</span><span class="string" id="3338849">&#34;read&#34;</span><span class="op" id="3338855">,</span>&nbsp;<span class="ident" id="3338857">fd</span><span class="op" id="3338859">.</span><span class="ident" id="3338860">net</span><span class="op" id="3338863">,</span>&nbsp;<span class="ident" id="3338865">fd</span><span class="op" id="3338867">.</span><span class="ident" id="3338868">raddr</span><span class="op" id="3338873">,</span>&nbsp;<span class="ident" id="3338875">err</span><span class="op" id="3338878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3338881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338884">return</span><br>
<span class="lineno"></span><span class="op" id="3338891">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="3338894">func</span>&nbsp;<span class="op" id="3338899">(</span><span class="ident" id="3338900">fd</span>&nbsp;<span class="op" id="3338903">*</span><span class="ident" id="3338904">netFD</span><span class="op" id="3338909">)</span>&nbsp;<span class="ident" id="3338911">readFrom</span><span class="op" id="3338919">(</span><span class="ident" id="3338920">p</span>&nbsp;<span class="op" id="3338922">[</span><span class="op" id="3338923">]</span><span class="builtintype" id="3338924">byte</span><span class="op" id="3338928">)</span>&nbsp;<span class="op" id="3338930">(</span><span class="ident" id="3338931">n</span>&nbsp;<span class="builtintype" id="3338933">int</span><span class="op" id="3338936">,</span>&nbsp;<span class="ident" id="3338938">sa</span>&nbsp;<span class="ident" id="3338941">syscall</span><span class="op" id="3338948">.</span><span class="ident" id="3338949">Sockaddr</span><span class="op" id="3338957">,</span>&nbsp;<span class="ident" id="3338959">err</span>&nbsp;<span class="builtintype" id="3338963">error</span><span class="op" id="3338968">)</span>&nbsp;<span class="op" id="3338970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3338973">if</span>&nbsp;<span class="ident" id="3338976">err</span>&nbsp;<span class="op" id="3338980">:=</span>&nbsp;<span class="ident" id="3338983">fd</span><span class="op" id="3338985">.</span><span class="ident" id="3338986">readLock</span><span class="op" id="3338994">(</span><span class="op" id="3338995">)</span><span class="op" id="3338996">;</span>&nbsp;<span class="ident" id="3338998">err</span>&nbsp;<span class="op" id="3339002">!=</span>&nbsp;<span class="ident" id="3339005">nil</span>&nbsp;<span class="op" id="3339009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339013">return</span>&nbsp;<span class="num" id="3339020">0</span><span class="op" id="3339021">,</span>&nbsp;<span class="ident" id="3339023">nil</span><span class="op" id="3339026">,</span>&nbsp;<span class="ident" id="3339028">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3339033">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339036">defer</span>&nbsp;<span class="ident" id="3339042">fd</span><span class="op" id="3339044">.</span><span class="ident" id="3339045">readUnlock</span><span class="op" id="3339055">(</span><span class="op" id="3339056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339059">if</span>&nbsp;<span class="ident" id="3339062">err</span>&nbsp;<span class="op" id="3339066">:=</span>&nbsp;<span class="ident" id="3339069">fd</span><span class="op" id="3339071">.</span><span class="ident" id="3339072">pd</span><span class="op" id="3339074">.</span><span class="ident" id="3339075">PrepareRead</span><span class="op" id="3339086">(</span><span class="op" id="3339087">)</span><span class="op" id="3339088">;</span>&nbsp;<span class="ident" id="3339090">err</span>&nbsp;<span class="op" id="3339094">!=</span>&nbsp;<span class="ident" id="3339097">nil</span>&nbsp;<span class="op" id="3339101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339105">return</span>&nbsp;<span class="num" id="3339112">0</span><span class="op" id="3339113">,</span>&nbsp;<span class="ident" id="3339115">nil</span><span class="op" id="3339118">,</span>&nbsp;<span class="op" id="3339120">&amp;</span><span class="ident" id="3339121">OpError</span><span class="op" id="3339128">{</span><span class="string" id="3339129">&#34;read&#34;</span><span class="op" id="3339135">,</span>&nbsp;<span class="ident" id="3339137">fd</span><span class="op" id="3339139">.</span><span class="ident" id="3339140">net</span><span class="op" id="3339143">,</span>&nbsp;<span class="ident" id="3339145">fd</span><span class="op" id="3339147">.</span><span class="ident" id="3339148">laddr</span><span class="op" id="3339153">,</span>&nbsp;<span class="ident" id="3339155">err</span><span class="op" id="3339158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3339161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339164">for</span>&nbsp;<span class="op" id="3339168">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3339172">n</span><span class="op" id="3339173">,</span>&nbsp;<span class="ident" id="3339175">sa</span><span class="op" id="3339177">,</span>&nbsp;<span class="ident" id="3339179">err</span>&nbsp;<span class="op" id="3339183">=</span>&nbsp;<span class="ident" id="3339185">syscall</span><span class="op" id="3339192">.</span><span class="ident" id="3339193">Recvfrom</span><span class="op" id="3339201">(</span><span class="ident" id="3339202">fd</span><span class="op" id="3339204">.</span><span class="ident" id="3339205">sysfd</span><span class="op" id="3339210">,</span>&nbsp;<span class="ident" id="3339212">p</span><span class="op" id="3339213">,</span>&nbsp;<span class="num" id="3339215">0</span><span class="op" id="3339216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339220">if</span>&nbsp;<span class="ident" id="3339223">err</span>&nbsp;<span class="op" id="3339227">!=</span>&nbsp;<span class="ident" id="3339230">nil</span>&nbsp;<span class="op" id="3339234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3339239">n</span>&nbsp;<span class="op" id="3339241">=</span>&nbsp;<span class="num" id="3339243">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339248">if</span>&nbsp;<span class="ident" id="3339251">err</span>&nbsp;<span class="op" id="3339255">==</span>&nbsp;<span class="ident" id="3339258">syscall</span><span class="op" id="3339265">.</span><span class="ident" id="3339266">EAGAIN</span>&nbsp;<span class="op" id="3339273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339279">if</span>&nbsp;<span class="ident" id="3339282">err</span>&nbsp;<span class="op" id="3339286">=</span>&nbsp;<span class="ident" id="3339288">fd</span><span class="op" id="3339290">.</span><span class="ident" id="3339291">pd</span><span class="op" id="3339293">.</span><span class="ident" id="3339294">WaitRead</span><span class="op" id="3339302">(</span><span class="op" id="3339303">)</span><span class="op" id="3339304">;</span>&nbsp;<span class="ident" id="3339306">err</span>&nbsp;<span class="op" id="3339310">==</span>&nbsp;<span class="ident" id="3339313">nil</span>&nbsp;<span class="op" id="3339317">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339324">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3339337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3339342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3339346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3339350">err</span>&nbsp;<span class="op" id="3339354">=</span>&nbsp;<span class="ident" id="3339356">chkReadErr</span><span class="op" id="3339366">(</span><span class="ident" id="3339367">n</span><span class="op" id="3339368">,</span>&nbsp;<span class="ident" id="3339370">err</span><span class="op" id="3339373">,</span>&nbsp;<span class="ident" id="3339375">fd</span><span class="op" id="3339377">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339381">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3339388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339391">if</span>&nbsp;<span class="ident" id="3339394">err</span>&nbsp;<span class="op" id="3339398">!=</span>&nbsp;<span class="ident" id="3339401">nil</span>&nbsp;<span class="op" id="3339405">&amp;&amp;</span>&nbsp;<span class="ident" id="3339408">err</span>&nbsp;<span class="op" id="3339412">!=</span>&nbsp;<span class="ident" id="3339415">io</span><span class="op" id="3339417">.</span><span class="ident" id="3339418">EOF</span>&nbsp;<span class="op" id="3339422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3339426">err</span>&nbsp;<span class="op" id="3339430">=</span>&nbsp;<span class="op" id="3339432">&amp;</span><span class="ident" id="3339433">OpError</span><span class="op" id="3339440">{</span><span class="string" id="3339441">&#34;read&#34;</span><span class="op" id="3339447">,</span>&nbsp;<span class="ident" id="3339449">fd</span><span class="op" id="3339451">.</span><span class="ident" id="3339452">net</span><span class="op" id="3339455">,</span>&nbsp;<span class="ident" id="3339457">fd</span><span class="op" id="3339459">.</span><span class="ident" id="3339460">laddr</span><span class="op" id="3339465">,</span>&nbsp;<span class="ident" id="3339467">err</span><span class="op" id="3339470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3339473">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339476">return</span><br>
<span class="lineno"></span><span class="op" id="3339483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3339486">func</span>&nbsp;<span class="op" id="3339491">(</span><span class="ident" id="3339492">fd</span>&nbsp;<span class="op" id="3339495">*</span><span class="ident" id="3339496">netFD</span><span class="op" id="3339501">)</span>&nbsp;<span class="ident" id="3339503">readMsg</span><span class="op" id="3339510">(</span><span class="ident" id="3339511">p</span>&nbsp;<span class="op" id="3339513">[</span><span class="op" id="3339514">]</span><span class="builtintype" id="3339515">byte</span><span class="op" id="3339519">,</span>&nbsp;<span class="ident" id="3339521">oob</span>&nbsp;<span class="op" id="3339525">[</span><span class="op" id="3339526">]</span><span class="builtintype" id="3339527">byte</span><span class="op" id="3339531">)</span>&nbsp;<span class="op" id="3339533">(</span><span class="ident" id="3339534">n</span><span class="op" id="3339535">,</span>&nbsp;<span class="ident" id="3339537">oobn</span><span class="op" id="3339541">,</span>&nbsp;<span class="ident" id="3339543">flags</span>&nbsp;<span class="builtintype" id="3339549">int</span><span class="op" id="3339552">,</span>&nbsp;<span class="ident" id="3339554">sa</span>&nbsp;<span class="ident" id="3339557">syscall</span><span class="op" id="3339564">.</span><span class="ident" id="3339565">Sockaddr</span><span class="op" id="3339573">,</span>&nbsp;<span class="ident" id="3339575">err</span>&nbsp;<span class="builtintype" id="3339579">error</span><span class="op" id="3339584">)</span>&nbsp;<span class="op" id="3339586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339589">if</span>&nbsp;<span class="ident" id="3339592">err</span>&nbsp;<span class="op" id="3339596">:=</span>&nbsp;<span class="ident" id="3339599">fd</span><span class="op" id="3339601">.</span><span class="ident" id="3339602">readLock</span><span class="op" id="3339610">(</span><span class="op" id="3339611">)</span><span class="op" id="3339612">;</span>&nbsp;<span class="ident" id="3339614">err</span>&nbsp;<span class="op" id="3339618">!=</span>&nbsp;<span class="ident" id="3339621">nil</span>&nbsp;<span class="op" id="3339625">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339629">return</span>&nbsp;<span class="num" id="3339636">0</span><span class="op" id="3339637">,</span>&nbsp;<span class="num" id="3339639">0</span><span class="op" id="3339640">,</span>&nbsp;<span class="num" id="3339642">0</span><span class="op" id="3339643">,</span>&nbsp;<span class="ident" id="3339645">nil</span><span class="op" id="3339648">,</span>&nbsp;<span class="ident" id="3339650">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3339655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339658">defer</span>&nbsp;<span class="ident" id="3339664">fd</span><span class="op" id="3339666">.</span><span class="ident" id="3339667">readUnlock</span><span class="op" id="3339677">(</span><span class="op" id="3339678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339681">if</span>&nbsp;<span class="ident" id="3339684">err</span>&nbsp;<span class="op" id="3339688">:=</span>&nbsp;<span class="ident" id="3339691">fd</span><span class="op" id="3339693">.</span><span class="ident" id="3339694">pd</span><span class="op" id="3339696">.</span><span class="ident" id="3339697">PrepareRead</span><span class="op" id="3339708">(</span><span class="op" id="3339709">)</span><span class="op" id="3339710">;</span>&nbsp;<span class="ident" id="3339712">err</span>&nbsp;<span class="op" id="3339716">!=</span>&nbsp;<span class="ident" id="3339719">nil</span>&nbsp;<span class="op" id="3339723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339727">return</span>&nbsp;<span class="num" id="3339734">0</span><span class="op" id="3339735">,</span>&nbsp;<span class="num" id="3339737">0</span><span class="op" id="3339738">,</span>&nbsp;<span class="num" id="3339740">0</span><span class="op" id="3339741">,</span>&nbsp;<span class="ident" id="3339743">nil</span><span class="op" id="3339746">,</span>&nbsp;<span class="op" id="3339748">&amp;</span><span class="ident" id="3339749">OpError</span><span class="op" id="3339756">{</span><span class="string" id="3339757">&#34;read&#34;</span><span class="op" id="3339763">,</span>&nbsp;<span class="ident" id="3339765">fd</span><span class="op" id="3339767">.</span><span class="ident" id="3339768">net</span><span class="op" id="3339771">,</span>&nbsp;<span class="ident" id="3339773">fd</span><span class="op" id="3339775">.</span><span class="ident" id="3339776">laddr</span><span class="op" id="3339781">,</span>&nbsp;<span class="ident" id="3339783">err</span><span class="op" id="3339786">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3339789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339792">for</span>&nbsp;<span class="op" id="3339796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3339800">n</span><span class="op" id="3339801">,</span>&nbsp;<span class="ident" id="3339803">oobn</span><span class="op" id="3339807">,</span>&nbsp;<span class="ident" id="3339809">flags</span><span class="op" id="3339814">,</span>&nbsp;<span class="ident" id="3339816">sa</span><span class="op" id="3339818">,</span>&nbsp;<span class="ident" id="3339820">err</span>&nbsp;<span class="op" id="3339824">=</span>&nbsp;<span class="ident" id="3339826">syscall</span><span class="op" id="3339833">.</span><span class="ident" id="3339834">Recvmsg</span><span class="op" id="3339841">(</span><span class="ident" id="3339842">fd</span><span class="op" id="3339844">.</span><span class="ident" id="3339845">sysfd</span><span class="op" id="3339850">,</span>&nbsp;<span class="ident" id="3339852">p</span><span class="op" id="3339853">,</span>&nbsp;<span class="ident" id="3339855">oob</span><span class="op" id="3339858">,</span>&nbsp;<span class="num" id="3339860">0</span><span class="op" id="3339861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339865">if</span>&nbsp;<span class="ident" id="3339868">err</span>&nbsp;<span class="op" id="3339872">!=</span>&nbsp;<span class="ident" id="3339875">nil</span>&nbsp;<span class="op" id="3339879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3339884">//&nbsp;TODO(dfc)&nbsp;should&nbsp;n&nbsp;and&nbsp;oobn&nbsp;be&nbsp;set&nbsp;to&nbsp;0</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339930">if</span>&nbsp;<span class="ident" id="3339933">err</span>&nbsp;<span class="op" id="3339937">==</span>&nbsp;<span class="ident" id="3339940">syscall</span><span class="op" id="3339947">.</span><span class="ident" id="3339948">EAGAIN</span>&nbsp;<span class="op" id="3339955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3339961">if</span>&nbsp;<span class="ident" id="3339964">err</span>&nbsp;<span class="op" id="3339968">=</span>&nbsp;<span class="ident" id="3339970">fd</span><span class="op" id="3339972">.</span><span class="ident" id="3339973">pd</span><span class="op" id="3339975">.</span><span class="ident" id="3339976">WaitRead</span><span class="op" id="3339984">(</span><span class="op" id="3339985">)</span><span class="op" id="3339986">;</span>&nbsp;<span class="ident" id="3339988">err</span>&nbsp;<span class="op" id="3339992">==</span>&nbsp;<span class="ident" id="3339995">nil</span>&nbsp;<span class="op" id="3339999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340006">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3340019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3340024">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3340028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3340032">err</span>&nbsp;<span class="op" id="3340036">=</span>&nbsp;<span class="ident" id="3340038">chkReadErr</span><span class="op" id="3340048">(</span><span class="ident" id="3340049">n</span><span class="op" id="3340050">,</span>&nbsp;<span class="ident" id="3340052">err</span><span class="op" id="3340055">,</span>&nbsp;<span class="ident" id="3340057">fd</span><span class="op" id="3340059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340063">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3340070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340073">if</span>&nbsp;<span class="ident" id="3340076">err</span>&nbsp;<span class="op" id="3340080">!=</span>&nbsp;<span class="ident" id="3340083">nil</span>&nbsp;<span class="op" id="3340087">&amp;&amp;</span>&nbsp;<span class="ident" id="3340090">err</span>&nbsp;<span class="op" id="3340094">!=</span>&nbsp;<span class="ident" id="3340097">io</span><span class="op" id="3340099">.</span><span class="ident" id="3340100">EOF</span>&nbsp;<span class="op" id="3340104">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3340108">err</span>&nbsp;<span class="op" id="3340112">=</span>&nbsp;<span class="op" id="3340114">&amp;</span><span class="ident" id="3340115">OpError</span><span class="op" id="3340122">{</span><span class="string" id="3340123">&#34;read&#34;</span><span class="op" id="3340129">,</span>&nbsp;<span class="ident" id="3340131">fd</span><span class="op" id="3340133">.</span><span class="ident" id="3340134">net</span><span class="op" id="3340137">,</span>&nbsp;<span class="ident" id="3340139">fd</span><span class="op" id="3340141">.</span><span class="ident" id="3340142">laddr</span><span class="op" id="3340147">,</span>&nbsp;<span class="ident" id="3340149">err</span><span class="op" id="3340152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3340155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340158">return</span><br>
<span class="lineno"></span><span class="op" id="3340165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span><span class="keyword" id="3340168">func</span>&nbsp;<span class="ident" id="3340173">chkReadErr</span><span class="op" id="3340183">(</span><span class="ident" id="3340184">n</span>&nbsp;<span class="builtintype" id="3340186">int</span><span class="op" id="3340189">,</span>&nbsp;<span class="ident" id="3340191">err</span>&nbsp;<span class="builtintype" id="3340195">error</span><span class="op" id="3340200">,</span>&nbsp;<span class="ident" id="3340202">fd</span>&nbsp;<span class="op" id="3340205">*</span><span class="ident" id="3340206">netFD</span><span class="op" id="3340211">)</span>&nbsp;<span class="builtintype" id="3340213">error</span>&nbsp;<span class="op" id="3340219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340222">if</span>&nbsp;<span class="ident" id="3340225">n</span>&nbsp;<span class="op" id="3340227">==</span>&nbsp;<span class="num" id="3340230">0</span>&nbsp;<span class="op" id="3340232">&amp;&amp;</span>&nbsp;<span class="ident" id="3340235">err</span>&nbsp;<span class="op" id="3340239">==</span>&nbsp;<span class="ident" id="3340242">nil</span>&nbsp;<span class="op" id="3340246">&amp;&amp;</span>&nbsp;<span class="ident" id="3340249">fd</span><span class="op" id="3340251">.</span><span class="ident" id="3340252">sotype</span>&nbsp;<span class="op" id="3340259">!=</span>&nbsp;<span class="ident" id="3340262">syscall</span><span class="op" id="3340269">.</span><span class="ident" id="3340270">SOCK_DGRAM</span>&nbsp;<span class="op" id="3340281">&amp;&amp;</span>&nbsp;<span class="ident" id="3340284">fd</span><span class="op" id="3340286">.</span><span class="ident" id="3340287">sotype</span>&nbsp;<span class="op" id="3340294">!=</span>&nbsp;<span class="ident" id="3340297">syscall</span><span class="op" id="3340304">.</span><span class="ident" id="3340305">SOCK_RAW</span>&nbsp;<span class="op" id="3340314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340318">return</span>&nbsp;<span class="ident" id="3340325">io</span><span class="op" id="3340327">.</span><span class="ident" id="3340328">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3340333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340336">return</span>&nbsp;<span class="ident" id="3340343">err</span><br>
<span class="lineno">315</span><span class="op" id="3340347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3340350">func</span>&nbsp;<span class="op" id="3340355">(</span><span class="ident" id="3340356">fd</span>&nbsp;<span class="op" id="3340359">*</span><span class="ident" id="3340360">netFD</span><span class="op" id="3340365">)</span>&nbsp;<span class="ident" id="3340367">Write</span><span class="op" id="3340372">(</span><span class="ident" id="3340373">p</span>&nbsp;<span class="op" id="3340375">[</span><span class="op" id="3340376">]</span><span class="builtintype" id="3340377">byte</span><span class="op" id="3340381">)</span>&nbsp;<span class="op" id="3340383">(</span><span class="ident" id="3340384">nn</span>&nbsp;<span class="builtintype" id="3340387">int</span><span class="op" id="3340390">,</span>&nbsp;<span class="ident" id="3340392">err</span>&nbsp;<span class="builtintype" id="3340396">error</span><span class="op" id="3340401">)</span>&nbsp;<span class="op" id="3340403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340406">if</span>&nbsp;<span class="ident" id="3340409">err</span>&nbsp;<span class="op" id="3340413">:=</span>&nbsp;<span class="ident" id="3340416">fd</span><span class="op" id="3340418">.</span><span class="ident" id="3340419">writeLock</span><span class="op" id="3340428">(</span><span class="op" id="3340429">)</span><span class="op" id="3340430">;</span>&nbsp;<span class="ident" id="3340432">err</span>&nbsp;<span class="op" id="3340436">!=</span>&nbsp;<span class="ident" id="3340439">nil</span>&nbsp;<span class="op" id="3340443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340447">return</span>&nbsp;<span class="num" id="3340454">0</span><span class="op" id="3340455">,</span>&nbsp;<span class="ident" id="3340457">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3340462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340465">defer</span>&nbsp;<span class="ident" id="3340471">fd</span><span class="op" id="3340473">.</span><span class="ident" id="3340474">writeUnlock</span><span class="op" id="3340485">(</span><span class="op" id="3340486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340489">if</span>&nbsp;<span class="ident" id="3340492">err</span>&nbsp;<span class="op" id="3340496">:=</span>&nbsp;<span class="ident" id="3340499">fd</span><span class="op" id="3340501">.</span><span class="ident" id="3340502">pd</span><span class="op" id="3340504">.</span><span class="ident" id="3340505">PrepareWrite</span><span class="op" id="3340517">(</span><span class="op" id="3340518">)</span><span class="op" id="3340519">;</span>&nbsp;<span class="ident" id="3340521">err</span>&nbsp;<span class="op" id="3340525">!=</span>&nbsp;<span class="ident" id="3340528">nil</span>&nbsp;<span class="op" id="3340532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340536">return</span>&nbsp;<span class="num" id="3340543">0</span><span class="op" id="3340544">,</span>&nbsp;<span class="op" id="3340546">&amp;</span><span class="ident" id="3340547">OpError</span><span class="op" id="3340554">{</span><span class="string" id="3340555">&#34;write&#34;</span><span class="op" id="3340562">,</span>&nbsp;<span class="ident" id="3340564">fd</span><span class="op" id="3340566">.</span><span class="ident" id="3340567">net</span><span class="op" id="3340570">,</span>&nbsp;<span class="ident" id="3340572">fd</span><span class="op" id="3340574">.</span><span class="ident" id="3340575">raddr</span><span class="op" id="3340580">,</span>&nbsp;<span class="ident" id="3340582">err</span><span class="op" id="3340585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3340588">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340591">for</span>&nbsp;<span class="op" id="3340595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340599">var</span>&nbsp;<span class="ident" id="3340603">n</span>&nbsp;<span class="builtintype" id="3340605">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3340611">n</span><span class="op" id="3340612">,</span>&nbsp;<span class="ident" id="3340614">err</span>&nbsp;<span class="op" id="3340618">=</span>&nbsp;<span class="ident" id="3340620">syscall</span><span class="op" id="3340627">.</span><span class="ident" id="3340628">Write</span><span class="op" id="3340633">(</span><span class="builtintype" id="3340634">int</span><span class="op" id="3340637">(</span><span class="ident" id="3340638">fd</span><span class="op" id="3340640">.</span><span class="ident" id="3340641">sysfd</span><span class="op" id="3340646">)</span><span class="op" id="3340647">,</span>&nbsp;<span class="ident" id="3340649">p</span><span class="op" id="3340650">[</span><span class="ident" id="3340651">nn</span><span class="op" id="3340653">:</span><span class="op" id="3340654">]</span><span class="op" id="3340655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340659">if</span>&nbsp;<span class="ident" id="3340662">n</span>&nbsp;<span class="op" id="3340664">&gt;</span>&nbsp;<span class="num" id="3340666">0</span>&nbsp;<span class="op" id="3340668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3340673">nn</span>&nbsp;<span class="op" id="3340676">+=</span>&nbsp;<span class="ident" id="3340679">n</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3340683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340687">if</span>&nbsp;<span class="ident" id="3340690">nn</span>&nbsp;<span class="op" id="3340693">==</span>&nbsp;<span class="builtinfunc" id="3340696">len</span><span class="op" id="3340699">(</span><span class="ident" id="3340700">p</span><span class="op" id="3340701">)</span>&nbsp;<span class="op" id="3340703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340708">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3340716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340720">if</span>&nbsp;<span class="ident" id="3340723">err</span>&nbsp;<span class="op" id="3340727">==</span>&nbsp;<span class="ident" id="3340730">syscall</span><span class="op" id="3340737">.</span><span class="ident" id="3340738">EAGAIN</span>&nbsp;<span class="op" id="3340745">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340750">if</span>&nbsp;<span class="ident" id="3340753">err</span>&nbsp;<span class="op" id="3340757">=</span>&nbsp;<span class="ident" id="3340759">fd</span><span class="op" id="3340761">.</span><span class="ident" id="3340762">pd</span><span class="op" id="3340764">.</span><span class="ident" id="3340765">WaitWrite</span><span class="op" id="3340774">(</span><span class="op" id="3340775">)</span><span class="op" id="3340776">;</span>&nbsp;<span class="ident" id="3340778">err</span>&nbsp;<span class="op" id="3340782">==</span>&nbsp;<span class="ident" id="3340785">nil</span>&nbsp;<span class="op" id="3340789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340795">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3340807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3340811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340815">if</span>&nbsp;<span class="ident" id="3340818">err</span>&nbsp;<span class="op" id="3340822">!=</span>&nbsp;<span class="ident" id="3340825">nil</span>&nbsp;<span class="op" id="3340829">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3340834">n</span>&nbsp;<span class="op" id="3340836">=</span>&nbsp;<span class="num" id="3340838">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340843">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3340851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340855">if</span>&nbsp;<span class="ident" id="3340858">n</span>&nbsp;<span class="op" id="3340860">==</span>&nbsp;<span class="num" id="3340863">0</span>&nbsp;<span class="op" id="3340865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3340870">err</span>&nbsp;<span class="op" id="3340874">=</span>&nbsp;<span class="ident" id="3340876">io</span><span class="op" id="3340878">.</span><span class="ident" id="3340879">ErrUnexpectedEOF</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340899">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3340907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3340910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340913">if</span>&nbsp;<span class="ident" id="3340916">err</span>&nbsp;<span class="op" id="3340920">!=</span>&nbsp;<span class="ident" id="3340923">nil</span>&nbsp;<span class="op" id="3340927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3340931">err</span>&nbsp;<span class="op" id="3340935">=</span>&nbsp;<span class="op" id="3340937">&amp;</span><span class="ident" id="3340938">OpError</span><span class="op" id="3340945">{</span><span class="string" id="3340946">&#34;write&#34;</span><span class="op" id="3340953">,</span>&nbsp;<span class="ident" id="3340955">fd</span><span class="op" id="3340957">.</span><span class="ident" id="3340958">net</span><span class="op" id="3340961">,</span>&nbsp;<span class="ident" id="3340963">fd</span><span class="op" id="3340965">.</span><span class="ident" id="3340966">raddr</span><span class="op" id="3340971">,</span>&nbsp;<span class="ident" id="3340973">err</span><span class="op" id="3340976">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3340979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3340982">return</span>&nbsp;<span class="ident" id="3340989">nn</span><span class="op" id="3340991">,</span>&nbsp;<span class="ident" id="3340993">err</span><br>
<span class="lineno"></span><span class="op" id="3340997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3341000">func</span>&nbsp;<span class="op" id="3341005">(</span><span class="ident" id="3341006">fd</span>&nbsp;<span class="op" id="3341009">*</span><span class="ident" id="3341010">netFD</span><span class="op" id="3341015">)</span>&nbsp;<span class="ident" id="3341017">writeTo</span><span class="op" id="3341024">(</span><span class="ident" id="3341025">p</span>&nbsp;<span class="op" id="3341027">[</span><span class="op" id="3341028">]</span><span class="builtintype" id="3341029">byte</span><span class="op" id="3341033">,</span>&nbsp;<span class="ident" id="3341035">sa</span>&nbsp;<span class="ident" id="3341038">syscall</span><span class="op" id="3341045">.</span><span class="ident" id="3341046">Sockaddr</span><span class="op" id="3341054">)</span>&nbsp;<span class="op" id="3341056">(</span><span class="ident" id="3341057">n</span>&nbsp;<span class="builtintype" id="3341059">int</span><span class="op" id="3341062">,</span>&nbsp;<span class="ident" id="3341064">err</span>&nbsp;<span class="builtintype" id="3341068">error</span><span class="op" id="3341073">)</span>&nbsp;<span class="op" id="3341075">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341078">if</span>&nbsp;<span class="ident" id="3341081">err</span>&nbsp;<span class="op" id="3341085">:=</span>&nbsp;<span class="ident" id="3341088">fd</span><span class="op" id="3341090">.</span><span class="ident" id="3341091">writeLock</span><span class="op" id="3341100">(</span><span class="op" id="3341101">)</span><span class="op" id="3341102">;</span>&nbsp;<span class="ident" id="3341104">err</span>&nbsp;<span class="op" id="3341108">!=</span>&nbsp;<span class="ident" id="3341111">nil</span>&nbsp;<span class="op" id="3341115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341119">return</span>&nbsp;<span class="num" id="3341126">0</span><span class="op" id="3341127">,</span>&nbsp;<span class="ident" id="3341129">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3341134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341137">defer</span>&nbsp;<span class="ident" id="3341143">fd</span><span class="op" id="3341145">.</span><span class="ident" id="3341146">writeUnlock</span><span class="op" id="3341157">(</span><span class="op" id="3341158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341161">if</span>&nbsp;<span class="ident" id="3341164">err</span>&nbsp;<span class="op" id="3341168">:=</span>&nbsp;<span class="ident" id="3341171">fd</span><span class="op" id="3341173">.</span><span class="ident" id="3341174">pd</span><span class="op" id="3341176">.</span><span class="ident" id="3341177">PrepareWrite</span><span class="op" id="3341189">(</span><span class="op" id="3341190">)</span><span class="op" id="3341191">;</span>&nbsp;<span class="ident" id="3341193">err</span>&nbsp;<span class="op" id="3341197">!=</span>&nbsp;<span class="ident" id="3341200">nil</span>&nbsp;<span class="op" id="3341204">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341208">return</span>&nbsp;<span class="num" id="3341215">0</span><span class="op" id="3341216">,</span>&nbsp;<span class="op" id="3341218">&amp;</span><span class="ident" id="3341219">OpError</span><span class="op" id="3341226">{</span><span class="string" id="3341227">&#34;write&#34;</span><span class="op" id="3341234">,</span>&nbsp;<span class="ident" id="3341236">fd</span><span class="op" id="3341238">.</span><span class="ident" id="3341239">net</span><span class="op" id="3341242">,</span>&nbsp;<span class="ident" id="3341244">fd</span><span class="op" id="3341246">.</span><span class="ident" id="3341247">raddr</span><span class="op" id="3341252">,</span>&nbsp;<span class="ident" id="3341254">err</span><span class="op" id="3341257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3341260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341263">for</span>&nbsp;<span class="op" id="3341267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3341271">err</span>&nbsp;<span class="op" id="3341275">=</span>&nbsp;<span class="ident" id="3341277">syscall</span><span class="op" id="3341284">.</span><span class="ident" id="3341285">Sendto</span><span class="op" id="3341291">(</span><span class="ident" id="3341292">fd</span><span class="op" id="3341294">.</span><span class="ident" id="3341295">sysfd</span><span class="op" id="3341300">,</span>&nbsp;<span class="ident" id="3341302">p</span><span class="op" id="3341303">,</span>&nbsp;<span class="num" id="3341305">0</span><span class="op" id="3341306">,</span>&nbsp;<span class="ident" id="3341308">sa</span><span class="op" id="3341310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341314">if</span>&nbsp;<span class="ident" id="3341317">err</span>&nbsp;<span class="op" id="3341321">==</span>&nbsp;<span class="ident" id="3341324">syscall</span><span class="op" id="3341331">.</span><span class="ident" id="3341332">EAGAIN</span>&nbsp;<span class="op" id="3341339">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341344">if</span>&nbsp;<span class="ident" id="3341347">err</span>&nbsp;<span class="op" id="3341351">=</span>&nbsp;<span class="ident" id="3341353">fd</span><span class="op" id="3341355">.</span><span class="ident" id="3341356">pd</span><span class="op" id="3341358">.</span><span class="ident" id="3341359">WaitWrite</span><span class="op" id="3341368">(</span><span class="op" id="3341369">)</span><span class="op" id="3341370">;</span>&nbsp;<span class="ident" id="3341372">err</span>&nbsp;<span class="op" id="3341376">==</span>&nbsp;<span class="ident" id="3341379">nil</span>&nbsp;<span class="op" id="3341383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341389">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3341401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3341405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341409">break</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3341416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341419">if</span>&nbsp;<span class="ident" id="3341422">err</span>&nbsp;<span class="op" id="3341426">==</span>&nbsp;<span class="ident" id="3341429">nil</span>&nbsp;<span class="op" id="3341433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3341437">n</span>&nbsp;<span class="op" id="3341439">=</span>&nbsp;<span class="builtinfunc" id="3341441">len</span><span class="op" id="3341444">(</span><span class="ident" id="3341445">p</span><span class="op" id="3341446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3341449">}</span>&nbsp;<span class="keyword" id="3341451">else</span>&nbsp;<span class="op" id="3341456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3341460">err</span>&nbsp;<span class="op" id="3341464">=</span>&nbsp;<span class="op" id="3341466">&amp;</span><span class="ident" id="3341467">OpError</span><span class="op" id="3341474">{</span><span class="string" id="3341475">&#34;write&#34;</span><span class="op" id="3341482">,</span>&nbsp;<span class="ident" id="3341484">fd</span><span class="op" id="3341486">.</span><span class="ident" id="3341487">net</span><span class="op" id="3341490">,</span>&nbsp;<span class="ident" id="3341492">fd</span><span class="op" id="3341494">.</span><span class="ident" id="3341495">raddr</span><span class="op" id="3341500">,</span>&nbsp;<span class="ident" id="3341502">err</span><span class="op" id="3341505">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3341508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341511">return</span><br>
<span class="lineno"></span><span class="op" id="3341518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3341521">func</span>&nbsp;<span class="op" id="3341526">(</span><span class="ident" id="3341527">fd</span>&nbsp;<span class="op" id="3341530">*</span><span class="ident" id="3341531">netFD</span><span class="op" id="3341536">)</span>&nbsp;<span class="ident" id="3341538">writeMsg</span><span class="op" id="3341546">(</span><span class="ident" id="3341547">p</span>&nbsp;<span class="op" id="3341549">[</span><span class="op" id="3341550">]</span><span class="builtintype" id="3341551">byte</span><span class="op" id="3341555">,</span>&nbsp;<span class="ident" id="3341557">oob</span>&nbsp;<span class="op" id="3341561">[</span><span class="op" id="3341562">]</span><span class="builtintype" id="3341563">byte</span><span class="op" id="3341567">,</span>&nbsp;<span class="ident" id="3341569">sa</span>&nbsp;<span class="ident" id="3341572">syscall</span><span class="op" id="3341579">.</span><span class="ident" id="3341580">Sockaddr</span><span class="op" id="3341588">)</span>&nbsp;<span class="op" id="3341590">(</span><span class="ident" id="3341591">n</span>&nbsp;<span class="builtintype" id="3341593">int</span><span class="op" id="3341596">,</span>&nbsp;<span class="ident" id="3341598">oobn</span>&nbsp;<span class="builtintype" id="3341603">int</span><span class="op" id="3341606">,</span>&nbsp;<span class="ident" id="3341608">err</span>&nbsp;<span class="builtintype" id="3341612">error</span><span class="op" id="3341617">)</span>&nbsp;<span class="op" id="3341619">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341622">if</span>&nbsp;<span class="ident" id="3341625">err</span>&nbsp;<span class="op" id="3341629">:=</span>&nbsp;<span class="ident" id="3341632">fd</span><span class="op" id="3341634">.</span><span class="ident" id="3341635">writeLock</span><span class="op" id="3341644">(</span><span class="op" id="3341645">)</span><span class="op" id="3341646">;</span>&nbsp;<span class="ident" id="3341648">err</span>&nbsp;<span class="op" id="3341652">!=</span>&nbsp;<span class="ident" id="3341655">nil</span>&nbsp;<span class="op" id="3341659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341663">return</span>&nbsp;<span class="num" id="3341670">0</span><span class="op" id="3341671">,</span>&nbsp;<span class="num" id="3341673">0</span><span class="op" id="3341674">,</span>&nbsp;<span class="ident" id="3341676">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3341681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341684">defer</span>&nbsp;<span class="ident" id="3341690">fd</span><span class="op" id="3341692">.</span><span class="ident" id="3341693">writeUnlock</span><span class="op" id="3341704">(</span><span class="op" id="3341705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341708">if</span>&nbsp;<span class="ident" id="3341711">err</span>&nbsp;<span class="op" id="3341715">:=</span>&nbsp;<span class="ident" id="3341718">fd</span><span class="op" id="3341720">.</span><span class="ident" id="3341721">pd</span><span class="op" id="3341723">.</span><span class="ident" id="3341724">PrepareWrite</span><span class="op" id="3341736">(</span><span class="op" id="3341737">)</span><span class="op" id="3341738">;</span>&nbsp;<span class="ident" id="3341740">err</span>&nbsp;<span class="op" id="3341744">!=</span>&nbsp;<span class="ident" id="3341747">nil</span>&nbsp;<span class="op" id="3341751">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341755">return</span>&nbsp;<span class="num" id="3341762">0</span><span class="op" id="3341763">,</span>&nbsp;<span class="num" id="3341765">0</span><span class="op" id="3341766">,</span>&nbsp;<span class="op" id="3341768">&amp;</span><span class="ident" id="3341769">OpError</span><span class="op" id="3341776">{</span><span class="string" id="3341777">&#34;write&#34;</span><span class="op" id="3341784">,</span>&nbsp;<span class="ident" id="3341786">fd</span><span class="op" id="3341788">.</span><span class="ident" id="3341789">net</span><span class="op" id="3341792">,</span>&nbsp;<span class="ident" id="3341794">fd</span><span class="op" id="3341796">.</span><span class="ident" id="3341797">raddr</span><span class="op" id="3341802">,</span>&nbsp;<span class="ident" id="3341804">err</span><span class="op" id="3341807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3341810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341813">for</span>&nbsp;<span class="op" id="3341817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3341821">n</span><span class="op" id="3341822">,</span>&nbsp;<span class="ident" id="3341824">err</span>&nbsp;<span class="op" id="3341828">=</span>&nbsp;<span class="ident" id="3341830">syscall</span><span class="op" id="3341837">.</span><span class="ident" id="3341838">SendmsgN</span><span class="op" id="3341846">(</span><span class="ident" id="3341847">fd</span><span class="op" id="3341849">.</span><span class="ident" id="3341850">sysfd</span><span class="op" id="3341855">,</span>&nbsp;<span class="ident" id="3341857">p</span><span class="op" id="3341858">,</span>&nbsp;<span class="ident" id="3341860">oob</span><span class="op" id="3341863">,</span>&nbsp;<span class="ident" id="3341865">sa</span><span class="op" id="3341867">,</span>&nbsp;<span class="num" id="3341869">0</span><span class="op" id="3341870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341874">if</span>&nbsp;<span class="ident" id="3341877">err</span>&nbsp;<span class="op" id="3341881">==</span>&nbsp;<span class="ident" id="3341884">syscall</span><span class="op" id="3341891">.</span><span class="ident" id="3341892">EAGAIN</span>&nbsp;<span class="op" id="3341899">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341904">if</span>&nbsp;<span class="ident" id="3341907">err</span>&nbsp;<span class="op" id="3341911">=</span>&nbsp;<span class="ident" id="3341913">fd</span><span class="op" id="3341915">.</span><span class="ident" id="3341916">pd</span><span class="op" id="3341918">.</span><span class="ident" id="3341919">WaitWrite</span><span class="op" id="3341928">(</span><span class="op" id="3341929">)</span><span class="op" id="3341930">;</span>&nbsp;<span class="ident" id="3341932">err</span>&nbsp;<span class="op" id="3341936">==</span>&nbsp;<span class="ident" id="3341939">nil</span>&nbsp;<span class="op" id="3341943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341949">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3341961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3341965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341969">break</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3341976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3341979">if</span>&nbsp;<span class="ident" id="3341982">err</span>&nbsp;<span class="op" id="3341986">==</span>&nbsp;<span class="ident" id="3341989">nil</span>&nbsp;<span class="op" id="3341993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3341997">oobn</span>&nbsp;<span class="op" id="3342002">=</span>&nbsp;<span class="builtinfunc" id="3342004">len</span><span class="op" id="3342007">(</span><span class="ident" id="3342008">oob</span><span class="op" id="3342011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3342014">}</span>&nbsp;<span class="keyword" id="3342016">else</span>&nbsp;<span class="op" id="3342021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3342025">err</span>&nbsp;<span class="op" id="3342029">=</span>&nbsp;<span class="op" id="3342031">&amp;</span><span class="ident" id="3342032">OpError</span><span class="op" id="3342039">{</span><span class="string" id="3342040">&#34;write&#34;</span><span class="op" id="3342047">,</span>&nbsp;<span class="ident" id="3342049">fd</span><span class="op" id="3342051">.</span><span class="ident" id="3342052">net</span><span class="op" id="3342055">,</span>&nbsp;<span class="ident" id="3342057">fd</span><span class="op" id="3342059">.</span><span class="ident" id="3342060">raddr</span><span class="op" id="3342065">,</span>&nbsp;<span class="ident" id="3342067">err</span><span class="op" id="3342070">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3342073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342076">return</span><br>
<span class="lineno"></span><span class="op" id="3342083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3342086">func</span>&nbsp;<span class="op" id="3342091">(</span><span class="ident" id="3342092">fd</span>&nbsp;<span class="op" id="3342095">*</span><span class="ident" id="3342096">netFD</span><span class="op" id="3342101">)</span>&nbsp;<span class="ident" id="3342103">accept</span><span class="op" id="3342109">(</span><span class="op" id="3342110">)</span>&nbsp;<span class="op" id="3342112">(</span><span class="ident" id="3342113">netfd</span>&nbsp;<span class="op" id="3342119">*</span><span class="ident" id="3342120">netFD</span><span class="op" id="3342125">,</span>&nbsp;<span class="ident" id="3342127">err</span>&nbsp;<span class="builtintype" id="3342131">error</span><span class="op" id="3342136">)</span>&nbsp;<span class="op" id="3342138">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342141">if</span>&nbsp;<span class="ident" id="3342144">err</span>&nbsp;<span class="op" id="3342148">:=</span>&nbsp;<span class="ident" id="3342151">fd</span><span class="op" id="3342153">.</span><span class="ident" id="3342154">readLock</span><span class="op" id="3342162">(</span><span class="op" id="3342163">)</span><span class="op" id="3342164">;</span>&nbsp;<span class="ident" id="3342166">err</span>&nbsp;<span class="op" id="3342170">!=</span>&nbsp;<span class="ident" id="3342173">nil</span>&nbsp;<span class="op" id="3342177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342181">return</span>&nbsp;<span class="ident" id="3342188">nil</span><span class="op" id="3342191">,</span>&nbsp;<span class="ident" id="3342193">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3342198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342201">defer</span>&nbsp;<span class="ident" id="3342207">fd</span><span class="op" id="3342209">.</span><span class="ident" id="3342210">readUnlock</span><span class="op" id="3342220">(</span><span class="op" id="3342221">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342225">var</span>&nbsp;<span class="ident" id="3342229">s</span>&nbsp;<span class="builtintype" id="3342231">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342236">var</span>&nbsp;<span class="ident" id="3342240">rsa</span>&nbsp;<span class="ident" id="3342244">syscall</span><span class="op" id="3342251">.</span><span class="ident" id="3342252">Sockaddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342262">if</span>&nbsp;<span class="ident" id="3342265">err</span>&nbsp;<span class="op" id="3342269">=</span>&nbsp;<span class="ident" id="3342271">fd</span><span class="op" id="3342273">.</span><span class="ident" id="3342274">pd</span><span class="op" id="3342276">.</span><span class="ident" id="3342277">PrepareRead</span><span class="op" id="3342288">(</span><span class="op" id="3342289">)</span><span class="op" id="3342290">;</span>&nbsp;<span class="ident" id="3342292">err</span>&nbsp;<span class="op" id="3342296">!=</span>&nbsp;<span class="ident" id="3342299">nil</span>&nbsp;<span class="op" id="3342303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342307">return</span>&nbsp;<span class="ident" id="3342314">nil</span><span class="op" id="3342317">,</span>&nbsp;<span class="op" id="3342319">&amp;</span><span class="ident" id="3342320">OpError</span><span class="op" id="3342327">{</span><span class="string" id="3342328">&#34;accept&#34;</span><span class="op" id="3342336">,</span>&nbsp;<span class="ident" id="3342338">fd</span><span class="op" id="3342340">.</span><span class="ident" id="3342341">net</span><span class="op" id="3342344">,</span>&nbsp;<span class="ident" id="3342346">fd</span><span class="op" id="3342348">.</span><span class="ident" id="3342349">laddr</span><span class="op" id="3342354">,</span>&nbsp;<span class="ident" id="3342356">err</span><span class="op" id="3342359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3342362">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342365">for</span>&nbsp;<span class="op" id="3342369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3342373">s</span><span class="op" id="3342374">,</span>&nbsp;<span class="ident" id="3342376">rsa</span><span class="op" id="3342379">,</span>&nbsp;<span class="ident" id="3342381">err</span>&nbsp;<span class="op" id="3342385">=</span>&nbsp;<span class="ident" id="3342387">accept</span><span class="op" id="3342393">(</span><span class="ident" id="3342394">fd</span><span class="op" id="3342396">.</span><span class="ident" id="3342397">sysfd</span><span class="op" id="3342402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342406">if</span>&nbsp;<span class="ident" id="3342409">err</span>&nbsp;<span class="op" id="3342413">!=</span>&nbsp;<span class="ident" id="3342416">nil</span>&nbsp;<span class="op" id="3342420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342425">if</span>&nbsp;<span class="ident" id="3342428">err</span>&nbsp;<span class="op" id="3342432">==</span>&nbsp;<span class="ident" id="3342435">syscall</span><span class="op" id="3342442">.</span><span class="ident" id="3342443">EAGAIN</span>&nbsp;<span class="op" id="3342450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342456">if</span>&nbsp;<span class="ident" id="3342459">err</span>&nbsp;<span class="op" id="3342463">=</span>&nbsp;<span class="ident" id="3342465">fd</span><span class="op" id="3342467">.</span><span class="ident" id="3342468">pd</span><span class="op" id="3342470">.</span><span class="ident" id="3342471">WaitRead</span><span class="op" id="3342479">(</span><span class="op" id="3342480">)</span><span class="op" id="3342481">;</span>&nbsp;<span class="ident" id="3342483">err</span>&nbsp;<span class="op" id="3342487">==</span>&nbsp;<span class="ident" id="3342490">nil</span>&nbsp;<span class="op" id="3342494">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342501">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3342514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3342519">}</span>&nbsp;<span class="keyword" id="3342521">else</span>&nbsp;<span class="keyword" id="3342526">if</span>&nbsp;<span class="ident" id="3342529">err</span>&nbsp;<span class="op" id="3342533">==</span>&nbsp;<span class="ident" id="3342536">syscall</span><span class="op" id="3342543">.</span><span class="ident" id="3342544">ECONNABORTED</span>&nbsp;<span class="op" id="3342557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3342563">//&nbsp;This&nbsp;means&nbsp;that&nbsp;a&nbsp;socket&nbsp;on&nbsp;the&nbsp;listen&nbsp;queue&nbsp;was&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3342626">//&nbsp;before&nbsp;we&nbsp;Accept()ed&nbsp;it;&nbsp;it&#39;s&nbsp;a&nbsp;silly&nbsp;error,&nbsp;so&nbsp;try&nbsp;again.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342692">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3342704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342709">return</span>&nbsp;<span class="ident" id="3342716">nil</span><span class="op" id="3342719">,</span>&nbsp;<span class="op" id="3342721">&amp;</span><span class="ident" id="3342722">OpError</span><span class="op" id="3342729">{</span><span class="string" id="3342730">&#34;accept&#34;</span><span class="op" id="3342738">,</span>&nbsp;<span class="ident" id="3342740">fd</span><span class="op" id="3342742">.</span><span class="ident" id="3342743">net</span><span class="op" id="3342746">,</span>&nbsp;<span class="ident" id="3342748">fd</span><span class="op" id="3342750">.</span><span class="ident" id="3342751">laddr</span><span class="op" id="3342756">,</span>&nbsp;<span class="ident" id="3342758">err</span><span class="op" id="3342761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3342765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342769">break</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3342776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342780">if</span>&nbsp;<span class="ident" id="3342783">netfd</span><span class="op" id="3342788">,</span>&nbsp;<span class="ident" id="3342790">err</span>&nbsp;<span class="op" id="3342794">=</span>&nbsp;<span class="ident" id="3342796">newFD</span><span class="op" id="3342801">(</span><span class="ident" id="3342802">s</span><span class="op" id="3342803">,</span>&nbsp;<span class="ident" id="3342805">fd</span><span class="op" id="3342807">.</span><span class="ident" id="3342808">family</span><span class="op" id="3342814">,</span>&nbsp;<span class="ident" id="3342816">fd</span><span class="op" id="3342818">.</span><span class="ident" id="3342819">sotype</span><span class="op" id="3342825">,</span>&nbsp;<span class="ident" id="3342827">fd</span><span class="op" id="3342829">.</span><span class="ident" id="3342830">net</span><span class="op" id="3342833">)</span><span class="op" id="3342834">;</span>&nbsp;<span class="ident" id="3342836">err</span>&nbsp;<span class="op" id="3342840">!=</span>&nbsp;<span class="ident" id="3342843">nil</span>&nbsp;<span class="op" id="3342847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3342851">closesocket</span><span class="op" id="3342862">(</span><span class="ident" id="3342863">s</span><span class="op" id="3342864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342868">return</span>&nbsp;<span class="ident" id="3342875">nil</span><span class="op" id="3342878">,</span>&nbsp;<span class="ident" id="3342880">err</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3342885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342888">if</span>&nbsp;<span class="ident" id="3342891">err</span>&nbsp;<span class="op" id="3342895">=</span>&nbsp;<span class="ident" id="3342897">netfd</span><span class="op" id="3342902">.</span><span class="ident" id="3342903">init</span><span class="op" id="3342907">(</span><span class="op" id="3342908">)</span><span class="op" id="3342909">;</span>&nbsp;<span class="ident" id="3342911">err</span>&nbsp;<span class="op" id="3342915">!=</span>&nbsp;<span class="ident" id="3342918">nil</span>&nbsp;<span class="op" id="3342922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3342926">fd</span><span class="op" id="3342928">.</span><span class="ident" id="3342929">Close</span><span class="op" id="3342934">(</span><span class="op" id="3342935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3342939">return</span>&nbsp;<span class="ident" id="3342946">nil</span><span class="op" id="3342949">,</span>&nbsp;<span class="ident" id="3342951">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3342956">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3342959">lsa</span><span class="op" id="3342962">,</span>&nbsp;<span class="ident" id="3342964">_</span>&nbsp;<span class="op" id="3342966">:=</span>&nbsp;<span class="ident" id="3342969">syscall</span><span class="op" id="3342976">.</span><span class="ident" id="3342977">Getsockname</span><span class="op" id="3342988">(</span><span class="ident" id="3342989">netfd</span><span class="op" id="3342994">.</span><span class="ident" id="3342995">sysfd</span><span class="op" id="3343000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3343003">netfd</span><span class="op" id="3343008">.</span><span class="ident" id="3343009">setAddr</span><span class="op" id="3343016">(</span><span class="ident" id="3343017">netfd</span><span class="op" id="3343022">.</span><span class="ident" id="3343023">addrFunc</span><span class="op" id="3343031">(</span><span class="op" id="3343032">)</span><span class="op" id="3343033">(</span><span class="ident" id="3343034">lsa</span><span class="op" id="3343037">)</span><span class="op" id="3343038">,</span>&nbsp;<span class="ident" id="3343040">netfd</span><span class="op" id="3343045">.</span><span class="ident" id="3343046">addrFunc</span><span class="op" id="3343054">(</span><span class="op" id="3343055">)</span><span class="op" id="3343056">(</span><span class="ident" id="3343057">rsa</span><span class="op" id="3343060">)</span><span class="op" id="3343061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343064">return</span>&nbsp;<span class="ident" id="3343071">netfd</span><span class="op" id="3343076">,</span>&nbsp;<span class="ident" id="3343078">nil</span><br>
<span class="lineno"></span><span class="op" id="3343082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="3343085">//&nbsp;tryDupCloexec&nbsp;indicates&nbsp;whether&nbsp;F_DUPFD_CLOEXEC&nbsp;should&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3343152">//&nbsp;If&nbsp;the&nbsp;kernel&nbsp;doesn&#39;t&nbsp;support&nbsp;it,&nbsp;this&nbsp;is&nbsp;set&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3343207">var</span>&nbsp;<span class="ident" id="3343211">tryDupCloexec</span>&nbsp;<span class="op" id="3343225">=</span>&nbsp;<span class="builtintype" id="3343227">int32</span><span class="op" id="3343232">(</span><span class="num" id="3343233">1</span><span class="op" id="3343234">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3343237">func</span>&nbsp;<span class="ident" id="3343242">dupCloseOnExec</span><span class="op" id="3343256">(</span><span class="ident" id="3343257">fd</span>&nbsp;<span class="builtintype" id="3343260">int</span><span class="op" id="3343263">)</span>&nbsp;<span class="op" id="3343265">(</span><span class="ident" id="3343266">newfd</span>&nbsp;<span class="builtintype" id="3343272">int</span><span class="op" id="3343275">,</span>&nbsp;<span class="ident" id="3343277">err</span>&nbsp;<span class="builtintype" id="3343281">error</span><span class="op" id="3343286">)</span>&nbsp;<span class="op" id="3343288">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343291">if</span>&nbsp;<span class="ident" id="3343294">atomic</span><span class="op" id="3343300">.</span><span class="ident" id="3343301">LoadInt32</span><span class="op" id="3343310">(</span><span class="op" id="3343311">&amp;</span><span class="ident" id="3343312">tryDupCloexec</span><span class="op" id="3343325">)</span>&nbsp;<span class="op" id="3343327">==</span>&nbsp;<span class="num" id="3343330">1</span>&nbsp;<span class="op" id="3343332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3343336">r0</span><span class="op" id="3343338">,</span>&nbsp;<span class="ident" id="3343340">_</span><span class="op" id="3343341">,</span>&nbsp;<span class="ident" id="3343343">e1</span>&nbsp;<span class="op" id="3343346">:=</span>&nbsp;<span class="ident" id="3343349">syscall</span><span class="op" id="3343356">.</span><span class="ident" id="3343357">Syscall</span><span class="op" id="3343364">(</span><span class="ident" id="3343365">syscall</span><span class="op" id="3343372">.</span><span class="ident" id="3343373">SYS_FCNTL</span><span class="op" id="3343382">,</span>&nbsp;<span class="builtintype" id="3343384">uintptr</span><span class="op" id="3343391">(</span><span class="ident" id="3343392">fd</span><span class="op" id="3343394">)</span><span class="op" id="3343395">,</span>&nbsp;<span class="ident" id="3343397">syscall</span><span class="op" id="3343404">.</span><span class="ident" id="3343405">F_DUPFD_CLOEXEC</span><span class="op" id="3343420">,</span>&nbsp;<span class="num" id="3343422">0</span><span class="op" id="3343423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343427">if</span>&nbsp;<span class="ident" id="3343430">runtime</span><span class="op" id="3343437">.</span><span class="ident" id="3343438">GOOS</span>&nbsp;<span class="op" id="3343443">==</span>&nbsp;<span class="string" id="3343446">&#34;darwin&#34;</span>&nbsp;<span class="op" id="3343455">&amp;&amp;</span>&nbsp;<span class="ident" id="3343458">e1</span>&nbsp;<span class="op" id="3343461">==</span>&nbsp;<span class="ident" id="3343464">syscall</span><span class="op" id="3343471">.</span><span class="ident" id="3343472">EBADF</span>&nbsp;<span class="op" id="3343478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3343483">//&nbsp;On&nbsp;OS&nbsp;X&nbsp;10.6&nbsp;and&nbsp;below&nbsp;(but&nbsp;we&nbsp;only&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3343533">//&nbsp;&gt;=&nbsp;10.6),&nbsp;F_DUPFD_CLOEXEC&nbsp;is&nbsp;unsupported</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3343580">//&nbsp;and&nbsp;fcntl&nbsp;there&nbsp;falls&nbsp;back&nbsp;(undocumented)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3343628">//&nbsp;to&nbsp;doing&nbsp;an&nbsp;ioctl&nbsp;instead,&nbsp;returning&nbsp;EBADF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3343677">//&nbsp;in&nbsp;this&nbsp;case&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3343721">//&nbsp;expected&nbsp;device&nbsp;fd&nbsp;type.&nbsp;&nbsp;Treat&nbsp;it&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3343765">//&nbsp;EINVAL&nbsp;instead,&nbsp;so&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3343810">//&nbsp;normal&nbsp;dup&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3343833">//&nbsp;TODO:&nbsp;only&nbsp;do&nbsp;this&nbsp;on&nbsp;10.6&nbsp;if&nbsp;we&nbsp;can&nbsp;detect&nbsp;10.6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3343888">//&nbsp;cheaply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3343903">e1</span>&nbsp;<span class="op" id="3343906">=</span>&nbsp;<span class="ident" id="3343908">syscall</span><span class="op" id="3343915">.</span><span class="ident" id="3343916">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3343925">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343929">switch</span>&nbsp;<span class="ident" id="3343936">e1</span>&nbsp;<span class="op" id="3343939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343943">case</span>&nbsp;<span class="num" id="3343948">0</span><span class="op" id="3343949">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343954">return</span>&nbsp;<span class="builtintype" id="3343961">int</span><span class="op" id="3343964">(</span><span class="ident" id="3343965">r0</span><span class="op" id="3343967">)</span><span class="op" id="3343968">,</span>&nbsp;<span class="ident" id="3343970">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343976">case</span>&nbsp;<span class="ident" id="3343981">syscall</span><span class="op" id="3343988">.</span><span class="ident" id="3343989">EINVAL</span><span class="op" id="3343995">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3344000">//&nbsp;Old&nbsp;kernel.&nbsp;Fall&nbsp;back&nbsp;to&nbsp;the&nbsp;portable&nbsp;way</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3344048">//&nbsp;from&nbsp;now&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3344067">atomic</span><span class="op" id="3344073">.</span><span class="ident" id="3344074">StoreInt32</span><span class="op" id="3344084">(</span><span class="op" id="3344085">&amp;</span><span class="ident" id="3344086">tryDupCloexec</span><span class="op" id="3344099">,</span>&nbsp;<span class="num" id="3344101">0</span><span class="op" id="3344102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344106">default</span><span class="op" id="3344113">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344118">return</span>&nbsp;<span class="op" id="3344125">-</span><span class="num" id="3344126">1</span><span class="op" id="3344127">,</span>&nbsp;<span class="ident" id="3344129">e1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3344134">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3344137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344140">return</span>&nbsp;<span class="ident" id="3344147">dupCloseOnExecOld</span><span class="op" id="3344164">(</span><span class="ident" id="3344165">fd</span><span class="op" id="3344167">)</span><br>
<span class="lineno"></span><span class="op" id="3344169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3344172">//&nbsp;dupCloseOnExecUnixOld&nbsp;is&nbsp;the&nbsp;traditional&nbsp;way&nbsp;to&nbsp;dup&nbsp;an&nbsp;fd&nbsp;and</span><br>
<span class="lineno">480</span><span class="comment" id="3344237">//&nbsp;set&nbsp;its&nbsp;O_CLOEXEC&nbsp;bit,&nbsp;using&nbsp;two&nbsp;system&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="3344287">func</span>&nbsp;<span class="ident" id="3344292">dupCloseOnExecOld</span><span class="op" id="3344309">(</span><span class="ident" id="3344310">fd</span>&nbsp;<span class="builtintype" id="3344313">int</span><span class="op" id="3344316">)</span>&nbsp;<span class="op" id="3344318">(</span><span class="ident" id="3344319">newfd</span>&nbsp;<span class="builtintype" id="3344325">int</span><span class="op" id="3344328">,</span>&nbsp;<span class="ident" id="3344330">err</span>&nbsp;<span class="builtintype" id="3344334">error</span><span class="op" id="3344339">)</span>&nbsp;<span class="op" id="3344341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3344344">syscall</span><span class="op" id="3344351">.</span><span class="ident" id="3344352">ForkLock</span><span class="op" id="3344360">.</span><span class="ident" id="3344361">RLock</span><span class="op" id="3344366">(</span><span class="op" id="3344367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344370">defer</span>&nbsp;<span class="ident" id="3344376">syscall</span><span class="op" id="3344383">.</span><span class="ident" id="3344384">ForkLock</span><span class="op" id="3344392">.</span><span class="ident" id="3344393">RUnlock</span><span class="op" id="3344400">(</span><span class="op" id="3344401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3344404">newfd</span><span class="op" id="3344409">,</span>&nbsp;<span class="ident" id="3344411">err</span>&nbsp;<span class="op" id="3344415">=</span>&nbsp;<span class="ident" id="3344417">syscall</span><span class="op" id="3344424">.</span><span class="ident" id="3344425">Dup</span><span class="op" id="3344428">(</span><span class="ident" id="3344429">fd</span><span class="op" id="3344431">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344434">if</span>&nbsp;<span class="ident" id="3344437">err</span>&nbsp;<span class="op" id="3344441">!=</span>&nbsp;<span class="ident" id="3344444">nil</span>&nbsp;<span class="op" id="3344448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344452">return</span>&nbsp;<span class="op" id="3344459">-</span><span class="num" id="3344460">1</span><span class="op" id="3344461">,</span>&nbsp;<span class="ident" id="3344463">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3344468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3344471">syscall</span><span class="op" id="3344478">.</span><span class="ident" id="3344479">CloseOnExec</span><span class="op" id="3344490">(</span><span class="ident" id="3344491">newfd</span><span class="op" id="3344496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344499">return</span><br>
<span class="lineno">490</span><span class="op" id="3344506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3344509">func</span>&nbsp;<span class="op" id="3344514">(</span><span class="ident" id="3344515">fd</span>&nbsp;<span class="op" id="3344518">*</span><span class="ident" id="3344519">netFD</span><span class="op" id="3344524">)</span>&nbsp;<span class="ident" id="3344526">dup</span><span class="op" id="3344529">(</span><span class="op" id="3344530">)</span>&nbsp;<span class="op" id="3344532">(</span><span class="ident" id="3344533">f</span>&nbsp;<span class="op" id="3344535">*</span><span class="ident" id="3344536">os</span><span class="op" id="3344538">.</span><span class="ident" id="3344539">File</span><span class="op" id="3344543">,</span>&nbsp;<span class="ident" id="3344545">err</span>&nbsp;<span class="builtintype" id="3344549">error</span><span class="op" id="3344554">)</span>&nbsp;<span class="op" id="3344556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3344559">ns</span><span class="op" id="3344561">,</span>&nbsp;<span class="ident" id="3344563">err</span>&nbsp;<span class="op" id="3344567">:=</span>&nbsp;<span class="ident" id="3344570">dupCloseOnExec</span><span class="op" id="3344584">(</span><span class="ident" id="3344585">fd</span><span class="op" id="3344587">.</span><span class="ident" id="3344588">sysfd</span><span class="op" id="3344593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344596">if</span>&nbsp;<span class="ident" id="3344599">err</span>&nbsp;<span class="op" id="3344603">!=</span>&nbsp;<span class="ident" id="3344606">nil</span>&nbsp;<span class="op" id="3344610">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344614">return</span>&nbsp;<span class="ident" id="3344621">nil</span><span class="op" id="3344624">,</span>&nbsp;<span class="op" id="3344626">&amp;</span><span class="ident" id="3344627">OpError</span><span class="op" id="3344634">{</span><span class="string" id="3344635">&#34;dup&#34;</span><span class="op" id="3344640">,</span>&nbsp;<span class="ident" id="3344642">fd</span><span class="op" id="3344644">.</span><span class="ident" id="3344645">net</span><span class="op" id="3344648">,</span>&nbsp;<span class="ident" id="3344650">fd</span><span class="op" id="3344652">.</span><span class="ident" id="3344653">laddr</span><span class="op" id="3344658">,</span>&nbsp;<span class="ident" id="3344660">err</span><span class="op" id="3344663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3344666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3344670">//&nbsp;We&nbsp;want&nbsp;blocking&nbsp;mode&nbsp;for&nbsp;the&nbsp;new&nbsp;fd,&nbsp;hence&nbsp;the&nbsp;double&nbsp;negative.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3344739">//&nbsp;This&nbsp;also&nbsp;puts&nbsp;the&nbsp;old&nbsp;fd&nbsp;into&nbsp;blocking&nbsp;mode,&nbsp;meaning&nbsp;that</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3344802">//&nbsp;I/O&nbsp;will&nbsp;block&nbsp;the&nbsp;thread&nbsp;instead&nbsp;of&nbsp;letting&nbsp;us&nbsp;use&nbsp;the&nbsp;epoll&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3344876">//&nbsp;Everything&nbsp;will&nbsp;still&nbsp;work,&nbsp;just&nbsp;with&nbsp;more&nbsp;threads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344932">if</span>&nbsp;<span class="ident" id="3344935">err</span>&nbsp;<span class="op" id="3344939">=</span>&nbsp;<span class="ident" id="3344941">syscall</span><span class="op" id="3344948">.</span><span class="ident" id="3344949">SetNonblock</span><span class="op" id="3344960">(</span><span class="ident" id="3344961">ns</span><span class="op" id="3344963">,</span>&nbsp;<span class="ident" id="3344965">false</span><span class="op" id="3344970">)</span><span class="op" id="3344971">;</span>&nbsp;<span class="ident" id="3344973">err</span>&nbsp;<span class="op" id="3344977">!=</span>&nbsp;<span class="ident" id="3344980">nil</span>&nbsp;<span class="op" id="3344984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344988">return</span>&nbsp;<span class="ident" id="3344995">nil</span><span class="op" id="3344998">,</span>&nbsp;<span class="op" id="3345000">&amp;</span><span class="ident" id="3345001">OpError</span><span class="op" id="3345008">{</span><span class="string" id="3345009">&#34;setnonblock&#34;</span><span class="op" id="3345022">,</span>&nbsp;<span class="ident" id="3345024">fd</span><span class="op" id="3345026">.</span><span class="ident" id="3345027">net</span><span class="op" id="3345030">,</span>&nbsp;<span class="ident" id="3345032">fd</span><span class="op" id="3345034">.</span><span class="ident" id="3345035">laddr</span><span class="op" id="3345040">,</span>&nbsp;<span class="ident" id="3345042">err</span><span class="op" id="3345045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3345048">}</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3345052">return</span>&nbsp;<span class="ident" id="3345059">os</span><span class="op" id="3345061">.</span><span class="ident" id="3345062">NewFile</span><span class="op" id="3345069">(</span><span class="builtintype" id="3345070">uintptr</span><span class="op" id="3345077">(</span><span class="ident" id="3345078">ns</span><span class="op" id="3345080">)</span><span class="op" id="3345081">,</span>&nbsp;<span class="ident" id="3345083">fd</span><span class="op" id="3345085">.</span><span class="ident" id="3345086">name</span><span class="op" id="3345090">(</span><span class="op" id="3345091">)</span><span class="op" id="3345092">)</span><span class="op" id="3345093">,</span>&nbsp;<span class="ident" id="3345095">nil</span><br>
<span class="lineno"></span><span class="op" id="3345099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3345102">func</span>&nbsp;<span class="ident" id="3345107">closesocket</span><span class="op" id="3345118">(</span><span class="ident" id="3345119">s</span>&nbsp;<span class="builtintype" id="3345121">int</span><span class="op" id="3345124">)</span>&nbsp;<span class="builtintype" id="3345126">error</span>&nbsp;<span class="op" id="3345132">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3345135">return</span>&nbsp;<span class="ident" id="3345142">syscall</span><span class="op" id="3345149">.</span><span class="ident" id="3345150">Close</span><span class="op" id="3345155">(</span><span class="ident" id="3345156">s</span><span class="op" id="3345157">)</span><br>
<span class="lineno"></span><span class="op" id="3345159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3345162">func</span>&nbsp;<span class="ident" id="3345167">skipRawSocketTests</span><span class="op" id="3345185">(</span><span class="op" id="3345186">)</span>&nbsp;<span class="op" id="3345188">(</span><span class="ident" id="3345189">skip</span>&nbsp;<span class="builtintype" id="3345194">bool</span><span class="op" id="3345198">,</span>&nbsp;<span class="ident" id="3345200">skipmsg</span>&nbsp;<span class="builtintype" id="3345208">string</span><span class="op" id="3345214">,</span>&nbsp;<span class="ident" id="3345216">err</span>&nbsp;<span class="builtintype" id="3345220">error</span><span class="op" id="3345225">)</span>&nbsp;<span class="op" id="3345227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3345230">if</span>&nbsp;<span class="ident" id="3345233">os</span><span class="op" id="3345235">.</span><span class="ident" id="3345236">Getuid</span><span class="op" id="3345242">(</span><span class="op" id="3345243">)</span>&nbsp;<span class="op" id="3345245">!=</span>&nbsp;<span class="num" id="3345248">0</span>&nbsp;<span class="op" id="3345250">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3345254">return</span>&nbsp;<span class="ident" id="3345261">true</span><span class="op" id="3345265">,</span>&nbsp;<span class="string" id="3345267">&#34;skipping&nbsp;test;&nbsp;must&nbsp;be&nbsp;root&#34;</span><span class="op" id="3345296">,</span>&nbsp;<span class="ident" id="3345298">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3345303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3345306">return</span>&nbsp;<span class="ident" id="3345313">false</span><span class="op" id="3345318">,</span>&nbsp;<span class="string" id="3345320">&#34;&#34;</span><span class="op" id="3345322">,</span>&nbsp;<span class="ident" id="3345324">nil</span><br>
<span class="lineno"></span><span class="op" id="3345328">}</span>
</div>
</body>
</html>
