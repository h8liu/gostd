<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/parser</h2>
<ul>
<li><a href="/gostd/go/parser/error_test.go.html">error_test.go</a></li>
<li><a href="/gostd/go/parser/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/go/parser/interface.go.html">interface.go</a></li>
<li><a href="/gostd/go/parser/parser.go.html">parser.go</a></li>
<li><a href="/gostd/go/parser/parser_test.go.html">parser_test.go</a></li>
<li><a href="/gostd/go/parser/performance_test.go.html">performance_test.go</a></li>
<li><a href="/gostd/go/parser/short_test.go.html">short_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4347898">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4347953">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4348007">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4348058">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;exported&nbsp;entry&nbsp;points&nbsp;for&nbsp;invoking&nbsp;the&nbsp;parser.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4348132">package</span>&nbsp;<span class="ident" id="4348140">parser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4348148">import</span>&nbsp;<span class="op" id="4348155">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4348158">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4348167">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4348177">&#34;go/ast&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4348187">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4348199">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4348205">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4348218">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4348224">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4348241">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="4348251">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="4348254">//&nbsp;If&nbsp;src&nbsp;!=&nbsp;nil,&nbsp;readSource&nbsp;converts&nbsp;src&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;possible;</span><br>
<span class="lineno"></span><span class="comment" id="4348321">//&nbsp;otherwise&nbsp;it&nbsp;returns&nbsp;an&nbsp;error.&nbsp;If&nbsp;src&nbsp;==&nbsp;nil,&nbsp;readSource&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="4348389">//&nbsp;the&nbsp;result&nbsp;of&nbsp;reading&nbsp;the&nbsp;file&nbsp;specified&nbsp;by&nbsp;filename.</span><br>
<span class="lineno"></span><span class="comment" id="4348446">//</span><br>
<span class="lineno">25</span><span class="keyword" id="4348449">func</span>&nbsp;<span class="ident" id="4348454">readSource</span><span class="op" id="4348464">(</span><span class="ident" id="4348465">filename</span>&nbsp;<span class="builtintype" id="4348474">string</span><span class="op" id="4348480">,</span>&nbsp;<span class="ident" id="4348482">src</span>&nbsp;<span class="keyword" id="4348486">interface</span><span class="op" id="4348495">{</span><span class="op" id="4348496">}</span><span class="op" id="4348497">)</span>&nbsp;<span class="op" id="4348499">(</span><span class="op" id="4348500">[</span><span class="op" id="4348501">]</span><span class="builtintype" id="4348502">byte</span><span class="op" id="4348506">,</span>&nbsp;<span class="builtintype" id="4348508">error</span><span class="op" id="4348513">)</span>&nbsp;<span class="op" id="4348515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348518">if</span>&nbsp;<span class="ident" id="4348521">src</span>&nbsp;<span class="op" id="4348525">!=</span>&nbsp;<span class="ident" id="4348528">nil</span>&nbsp;<span class="op" id="4348532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348536">switch</span>&nbsp;<span class="ident" id="4348543">s</span>&nbsp;<span class="op" id="4348545">:=</span>&nbsp;<span class="ident" id="4348548">src</span><span class="op" id="4348551">.</span><span class="op" id="4348552">(</span><span class="keyword" id="4348553">type</span><span class="op" id="4348557">)</span>&nbsp;<span class="op" id="4348559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348563">case</span>&nbsp;<span class="builtintype" id="4348568">string</span><span class="op" id="4348574">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348579">return</span>&nbsp;<span class="op" id="4348586">[</span><span class="op" id="4348587">]</span><span class="builtintype" id="4348588">byte</span><span class="op" id="4348592">(</span><span class="ident" id="4348593">s</span><span class="op" id="4348594">)</span><span class="op" id="4348595">,</span>&nbsp;<span class="ident" id="4348597">nil</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348603">case</span>&nbsp;<span class="op" id="4348608">[</span><span class="op" id="4348609">]</span><span class="builtintype" id="4348610">byte</span><span class="op" id="4348614">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348619">return</span>&nbsp;<span class="ident" id="4348626">s</span><span class="op" id="4348627">,</span>&nbsp;<span class="ident" id="4348629">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348635">case</span>&nbsp;<span class="op" id="4348640">*</span><span class="ident" id="4348641">bytes</span><span class="op" id="4348646">.</span><span class="ident" id="4348647">Buffer</span><span class="op" id="4348653">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4348658">//&nbsp;is&nbsp;io.Reader,&nbsp;but&nbsp;src&nbsp;is&nbsp;already&nbsp;available&nbsp;in&nbsp;[]byte&nbsp;form</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348722">if</span>&nbsp;<span class="ident" id="4348725">s</span>&nbsp;<span class="op" id="4348727">!=</span>&nbsp;<span class="ident" id="4348730">nil</span>&nbsp;<span class="op" id="4348734">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348740">return</span>&nbsp;<span class="ident" id="4348747">s</span><span class="op" id="4348748">.</span><span class="ident" id="4348749">Bytes</span><span class="op" id="4348754">(</span><span class="op" id="4348755">)</span><span class="op" id="4348756">,</span>&nbsp;<span class="ident" id="4348758">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4348765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348769">case</span>&nbsp;<span class="ident" id="4348774">io</span><span class="op" id="4348776">.</span><span class="ident" id="4348777">Reader</span><span class="op" id="4348783">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348788">var</span>&nbsp;<span class="ident" id="4348792">buf</span>&nbsp;<span class="ident" id="4348796">bytes</span><span class="op" id="4348801">.</span><span class="ident" id="4348802">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348812">if</span>&nbsp;<span class="ident" id="4348815">_</span><span class="op" id="4348816">,</span>&nbsp;<span class="ident" id="4348818">err</span>&nbsp;<span class="op" id="4348822">:=</span>&nbsp;<span class="ident" id="4348825">io</span><span class="op" id="4348827">.</span><span class="ident" id="4348828">Copy</span><span class="op" id="4348832">(</span><span class="op" id="4348833">&amp;</span><span class="ident" id="4348834">buf</span><span class="op" id="4348837">,</span>&nbsp;<span class="ident" id="4348839">s</span><span class="op" id="4348840">)</span><span class="op" id="4348841">;</span>&nbsp;<span class="ident" id="4348843">err</span>&nbsp;<span class="op" id="4348847">!=</span>&nbsp;<span class="ident" id="4348850">nil</span>&nbsp;<span class="op" id="4348854">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348860">return</span>&nbsp;<span class="ident" id="4348867">nil</span><span class="op" id="4348870">,</span>&nbsp;<span class="ident" id="4348872">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4348879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348884">return</span>&nbsp;<span class="ident" id="4348891">buf</span><span class="op" id="4348894">.</span><span class="ident" id="4348895">Bytes</span><span class="op" id="4348900">(</span><span class="op" id="4348901">)</span><span class="op" id="4348902">,</span>&nbsp;<span class="ident" id="4348904">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4348910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348914">return</span>&nbsp;<span class="ident" id="4348921">nil</span><span class="op" id="4348924">,</span>&nbsp;<span class="ident" id="4348926">errors</span><span class="op" id="4348932">.</span><span class="ident" id="4348933">New</span><span class="op" id="4348936">(</span><span class="string" id="4348937">&#34;invalid&nbsp;source&#34;</span><span class="op" id="4348953">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4348956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4348959">return</span>&nbsp;<span class="ident" id="4348966">ioutil</span><span class="op" id="4348972">.</span><span class="ident" id="4348973">ReadFile</span><span class="op" id="4348981">(</span><span class="ident" id="4348982">filename</span><span class="op" id="4348990">)</span><br>
<span class="lineno"></span><span class="op" id="4348992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4348995">//&nbsp;A&nbsp;Mode&nbsp;value&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;flags&nbsp;(or&nbsp;0).</span><br>
<span class="lineno">50</span><span class="comment" id="4349037">//&nbsp;They&nbsp;control&nbsp;the&nbsp;amount&nbsp;of&nbsp;source&nbsp;code&nbsp;parsed&nbsp;and&nbsp;other&nbsp;optional</span><br>
<span class="lineno"></span><span class="comment" id="4349105">//&nbsp;parser&nbsp;functionality.</span><br>
<span class="lineno"></span><span class="comment" id="4349130">//</span><br>
<span class="lineno"></span><span class="keyword" id="4349133">type</span>&nbsp;<span class="ident" id="4349138">Mode</span>&nbsp;<span class="builtintype" id="4349143">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="4349149">const</span>&nbsp;<span class="op" id="4349155">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4349158">PackageClauseOnly</span>&nbsp;<span class="ident" id="4349176">Mode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4349193">=</span>&nbsp;<span class="num" id="4349195">1</span>&nbsp;<span class="op" id="4349197">&lt;&lt;</span>&nbsp;<span class="ident" id="4349200">iota</span>&nbsp;<span class="comment" id="4349205">//&nbsp;stop&nbsp;parsing&nbsp;after&nbsp;package&nbsp;clause</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4349243">ImportsOnly</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4349290">//&nbsp;stop&nbsp;parsing&nbsp;after&nbsp;import&nbsp;declarations</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4349333">ParseComments</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4349380">//&nbsp;parse&nbsp;comments&nbsp;and&nbsp;add&nbsp;them&nbsp;to&nbsp;AST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4349419">Trace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4349466">//&nbsp;print&nbsp;a&nbsp;trace&nbsp;of&nbsp;parsed&nbsp;productions</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4349506">DeclarationErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4349553">//&nbsp;report&nbsp;declaration&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4349583">SpuriousErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4349630">//&nbsp;same&nbsp;as&nbsp;AllErrors,&nbsp;for&nbsp;backward-compatibility</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4349680">AllErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4349698">=</span>&nbsp;<span class="ident" id="4349700">SpuriousErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4349727">//&nbsp;report&nbsp;all&nbsp;errors&nbsp;(not&nbsp;just&nbsp;the&nbsp;first&nbsp;10&nbsp;on&nbsp;different&nbsp;lines)</span><br>
<span class="lineno"></span><span class="op" id="4349791">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4349794">//&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;source&nbsp;code&nbsp;of&nbsp;a&nbsp;single&nbsp;Go&nbsp;source&nbsp;file&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="4349869">//&nbsp;the&nbsp;corresponding&nbsp;ast.File&nbsp;node.&nbsp;The&nbsp;source&nbsp;code&nbsp;may&nbsp;be&nbsp;provided&nbsp;via</span><br>
<span class="lineno"></span><span class="comment" id="4349941">//&nbsp;the&nbsp;filename&nbsp;of&nbsp;the&nbsp;source&nbsp;file,&nbsp;or&nbsp;via&nbsp;the&nbsp;src&nbsp;parameter.</span><br>
<span class="lineno"></span><span class="comment" id="4350003">//</span><br>
<span class="lineno"></span><span class="comment" id="4350006">//&nbsp;If&nbsp;src&nbsp;!=&nbsp;nil,&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;source&nbsp;from&nbsp;src&nbsp;and&nbsp;the&nbsp;filename&nbsp;is</span><br>
<span class="lineno">70</span><span class="comment" id="4350081">//&nbsp;only&nbsp;used&nbsp;when&nbsp;recording&nbsp;position&nbsp;information.&nbsp;The&nbsp;type&nbsp;of&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="4350156">//&nbsp;for&nbsp;the&nbsp;src&nbsp;parameter&nbsp;must&nbsp;be&nbsp;string,&nbsp;[]byte,&nbsp;or&nbsp;io.Reader.</span><br>
<span class="lineno"></span><span class="comment" id="4350219">//&nbsp;If&nbsp;src&nbsp;==&nbsp;nil,&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;file&nbsp;specified&nbsp;by&nbsp;filename.</span><br>
<span class="lineno"></span><span class="comment" id="4350286">//</span><br>
<span class="lineno"></span><span class="comment" id="4350289">//&nbsp;The&nbsp;mode&nbsp;parameter&nbsp;controls&nbsp;the&nbsp;amount&nbsp;of&nbsp;source&nbsp;text&nbsp;parsed&nbsp;and&nbsp;other</span><br>
<span class="lineno">75</span><span class="comment" id="4350363">//&nbsp;optional&nbsp;parser&nbsp;functionality.&nbsp;Position&nbsp;information&nbsp;is&nbsp;recorded&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4350437">//&nbsp;file&nbsp;set&nbsp;fset.</span><br>
<span class="lineno"></span><span class="comment" id="4350455">//</span><br>
<span class="lineno"></span><span class="comment" id="4350458">//&nbsp;If&nbsp;the&nbsp;source&nbsp;couldn&#39;t&nbsp;be&nbsp;read,&nbsp;the&nbsp;returned&nbsp;AST&nbsp;is&nbsp;nil&nbsp;and&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4350531">//&nbsp;indicates&nbsp;the&nbsp;specific&nbsp;failure.&nbsp;If&nbsp;the&nbsp;source&nbsp;was&nbsp;read&nbsp;but&nbsp;syntax</span><br>
<span class="lineno">80</span><span class="comment" id="4350600">//&nbsp;errors&nbsp;were&nbsp;found,&nbsp;the&nbsp;result&nbsp;is&nbsp;a&nbsp;partial&nbsp;AST&nbsp;(with&nbsp;ast.Bad*&nbsp;nodes</span><br>
<span class="lineno"></span><span class="comment" id="4350671">//&nbsp;representing&nbsp;the&nbsp;fragments&nbsp;of&nbsp;erroneous&nbsp;source&nbsp;code).&nbsp;Multiple&nbsp;errors</span><br>
<span class="lineno"></span><span class="comment" id="4350744">//&nbsp;are&nbsp;returned&nbsp;via&nbsp;a&nbsp;scanner.ErrorList&nbsp;which&nbsp;is&nbsp;sorted&nbsp;by&nbsp;file&nbsp;position.</span><br>
<span class="lineno"></span><span class="comment" id="4350818">//</span><br>
<span class="lineno"></span><span class="keyword" id="4350821">func</span>&nbsp;<span class="ident" id="4350826">ParseFile</span><span class="op" id="4350835">(</span><span class="ident" id="4350836">fset</span>&nbsp;<span class="op" id="4350841">*</span><span class="ident" id="4350842">token</span><span class="op" id="4350847">.</span><span class="ident" id="4350848">FileSet</span><span class="op" id="4350855">,</span>&nbsp;<span class="ident" id="4350857">filename</span>&nbsp;<span class="builtintype" id="4350866">string</span><span class="op" id="4350872">,</span>&nbsp;<span class="ident" id="4350874">src</span>&nbsp;<span class="keyword" id="4350878">interface</span><span class="op" id="4350887">{</span><span class="op" id="4350888">}</span><span class="op" id="4350889">,</span>&nbsp;<span class="ident" id="4350891">mode</span>&nbsp;<span class="ident" id="4350896">Mode</span><span class="op" id="4350900">)</span>&nbsp;<span class="op" id="4350902">(</span><span class="ident" id="4350903">f</span>&nbsp;<span class="op" id="4350905">*</span><span class="ident" id="4350906">ast</span><span class="op" id="4350909">.</span><span class="ident" id="4350910">File</span><span class="op" id="4350914">,</span>&nbsp;<span class="ident" id="4350916">err</span>&nbsp;<span class="builtintype" id="4350920">error</span><span class="op" id="4350925">)</span>&nbsp;<span class="op" id="4350927">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4350930">//&nbsp;get&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4350945">text</span><span class="op" id="4350949">,</span>&nbsp;<span class="ident" id="4350951">err</span>&nbsp;<span class="op" id="4350955">:=</span>&nbsp;<span class="ident" id="4350958">readSource</span><span class="op" id="4350968">(</span><span class="ident" id="4350969">filename</span><span class="op" id="4350977">,</span>&nbsp;<span class="ident" id="4350979">src</span><span class="op" id="4350982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4350985">if</span>&nbsp;<span class="ident" id="4350988">err</span>&nbsp;<span class="op" id="4350992">!=</span>&nbsp;<span class="ident" id="4350995">nil</span>&nbsp;<span class="op" id="4350999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4351003">return</span>&nbsp;<span class="ident" id="4351010">nil</span><span class="op" id="4351013">,</span>&nbsp;<span class="ident" id="4351015">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4351020">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4351024">var</span>&nbsp;<span class="ident" id="4351028">p</span>&nbsp;<span class="ident" id="4351030">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4351038">defer</span>&nbsp;<span class="keyword" id="4351044">func</span><span class="op" id="4351048">(</span><span class="op" id="4351049">)</span>&nbsp;<span class="op" id="4351051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4351055">if</span>&nbsp;<span class="ident" id="4351058">e</span>&nbsp;<span class="op" id="4351060">:=</span>&nbsp;<span class="builtinfunc" id="4351063">recover</span><span class="op" id="4351070">(</span><span class="op" id="4351071">)</span><span class="op" id="4351072">;</span>&nbsp;<span class="ident" id="4351074">e</span>&nbsp;<span class="op" id="4351076">!=</span>&nbsp;<span class="ident" id="4351079">nil</span>&nbsp;<span class="op" id="4351083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4351088">_</span>&nbsp;<span class="op" id="4351090">=</span>&nbsp;<span class="ident" id="4351092">e</span><span class="op" id="4351093">.</span><span class="op" id="4351094">(</span><span class="ident" id="4351095">bailout</span><span class="op" id="4351102">)</span>&nbsp;<span class="comment" id="4351104">//&nbsp;re-panics&nbsp;if&nbsp;it&#39;s&nbsp;not&nbsp;a&nbsp;bailout</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4351141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4351146">//&nbsp;set&nbsp;result&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4351169">if</span>&nbsp;<span class="ident" id="4351172">f</span>&nbsp;<span class="op" id="4351174">==</span>&nbsp;<span class="ident" id="4351177">nil</span>&nbsp;<span class="op" id="4351181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4351186">//&nbsp;source&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;Go&nbsp;source&nbsp;file&nbsp;-&nbsp;satisfy</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4351239">//&nbsp;ParseFile&nbsp;API&nbsp;and&nbsp;return&nbsp;a&nbsp;valid&nbsp;(but)&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4351290">//&nbsp;*ast.File</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4351306">f</span>&nbsp;<span class="op" id="4351308">=</span>&nbsp;<span class="op" id="4351310">&amp;</span><span class="ident" id="4351311">ast</span><span class="op" id="4351314">.</span><span class="ident" id="4351315">File</span><span class="op" id="4351319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4351325">Name</span><span class="op" id="4351329">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="4351332">new</span><span class="op" id="4351335">(</span><span class="ident" id="4351336">ast</span><span class="op" id="4351339">.</span><span class="ident" id="4351340">Ident</span><span class="op" id="4351345">)</span><span class="op" id="4351346">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4351352">Scope</span><span class="op" id="4351357">:</span>&nbsp;<span class="ident" id="4351359">ast</span><span class="op" id="4351362">.</span><span class="ident" id="4351363">NewScope</span><span class="op" id="4351371">(</span><span class="ident" id="4351372">nil</span><span class="op" id="4351375">)</span><span class="op" id="4351376">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4351381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4351385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4351390">p</span><span class="op" id="4351391">.</span><span class="ident" id="4351392">errors</span><span class="op" id="4351398">.</span><span class="ident" id="4351399">Sort</span><span class="op" id="4351403">(</span><span class="op" id="4351404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4351408">err</span>&nbsp;<span class="op" id="4351412">=</span>&nbsp;<span class="ident" id="4351414">p</span><span class="op" id="4351415">.</span><span class="ident" id="4351416">errors</span><span class="op" id="4351422">.</span><span class="ident" id="4351423">Err</span><span class="op" id="4351426">(</span><span class="op" id="4351427">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4351430">}</span><span class="op" id="4351431">(</span><span class="op" id="4351432">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4351436">//&nbsp;parse&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4351453">p</span><span class="op" id="4351454">.</span><span class="ident" id="4351455">init</span><span class="op" id="4351459">(</span><span class="ident" id="4351460">fset</span><span class="op" id="4351464">,</span>&nbsp;<span class="ident" id="4351466">filename</span><span class="op" id="4351474">,</span>&nbsp;<span class="ident" id="4351476">text</span><span class="op" id="4351480">,</span>&nbsp;<span class="ident" id="4351482">mode</span><span class="op" id="4351486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4351489">f</span>&nbsp;<span class="op" id="4351491">=</span>&nbsp;<span class="ident" id="4351493">p</span><span class="op" id="4351494">.</span><span class="ident" id="4351495">parseFile</span><span class="op" id="4351504">(</span><span class="op" id="4351505">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4351509">return</span><br>
<span class="lineno"></span><span class="op" id="4351516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4351519">//&nbsp;ParseDir&nbsp;calls&nbsp;ParseFile&nbsp;for&nbsp;all&nbsp;files&nbsp;with&nbsp;names&nbsp;ending&nbsp;in&nbsp;&#34;.go&#34;&nbsp;in&nbsp;the</span><br>
<span class="lineno">120</span><span class="comment" id="4351595">//&nbsp;directory&nbsp;specified&nbsp;by&nbsp;path&nbsp;and&nbsp;returns&nbsp;a&nbsp;map&nbsp;of&nbsp;package&nbsp;name&nbsp;-&gt;&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="4351671">//&nbsp;AST&nbsp;with&nbsp;all&nbsp;the&nbsp;packages&nbsp;found.</span><br>
<span class="lineno"></span><span class="comment" id="4351707">//</span><br>
<span class="lineno"></span><span class="comment" id="4351710">//&nbsp;If&nbsp;filter&nbsp;!=&nbsp;nil,&nbsp;only&nbsp;the&nbsp;files&nbsp;with&nbsp;os.FileInfo&nbsp;entries&nbsp;passing&nbsp;through</span><br>
<span class="lineno"></span><span class="comment" id="4351787">//&nbsp;the&nbsp;filter&nbsp;(and&nbsp;ending&nbsp;in&nbsp;&#34;.go&#34;)&nbsp;are&nbsp;considered.&nbsp;The&nbsp;mode&nbsp;bits&nbsp;are&nbsp;passed</span><br>
<span class="lineno">125</span><span class="comment" id="4351864">//&nbsp;to&nbsp;ParseFile&nbsp;unchanged.&nbsp;Position&nbsp;information&nbsp;is&nbsp;recorded&nbsp;in&nbsp;fset.</span><br>
<span class="lineno"></span><span class="comment" id="4351933">//</span><br>
<span class="lineno"></span><span class="comment" id="4351936">//&nbsp;If&nbsp;the&nbsp;directory&nbsp;couldn&#39;t&nbsp;be&nbsp;read,&nbsp;a&nbsp;nil&nbsp;map&nbsp;and&nbsp;the&nbsp;respective&nbsp;error&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="4352013">//&nbsp;returned.&nbsp;If&nbsp;a&nbsp;parse&nbsp;error&nbsp;occurred,&nbsp;a&nbsp;non-nil&nbsp;but&nbsp;incomplete&nbsp;map&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4352090">//&nbsp;first&nbsp;error&nbsp;encountered&nbsp;are&nbsp;returned.</span><br>
<span class="lineno">130</span><span class="comment" id="4352131">//</span><br>
<span class="lineno"></span><span class="keyword" id="4352134">func</span>&nbsp;<span class="ident" id="4352139">ParseDir</span><span class="op" id="4352147">(</span><span class="ident" id="4352148">fset</span>&nbsp;<span class="op" id="4352153">*</span><span class="ident" id="4352154">token</span><span class="op" id="4352159">.</span><span class="ident" id="4352160">FileSet</span><span class="op" id="4352167">,</span>&nbsp;<span class="ident" id="4352169">path</span>&nbsp;<span class="builtintype" id="4352174">string</span><span class="op" id="4352180">,</span>&nbsp;<span class="ident" id="4352182">filter</span>&nbsp;<span class="keyword" id="4352189">func</span><span class="op" id="4352193">(</span><span class="ident" id="4352194">os</span><span class="op" id="4352196">.</span><span class="ident" id="4352197">FileInfo</span><span class="op" id="4352205">)</span>&nbsp;<span class="builtintype" id="4352207">bool</span><span class="op" id="4352211">,</span>&nbsp;<span class="ident" id="4352213">mode</span>&nbsp;<span class="ident" id="4352218">Mode</span><span class="op" id="4352222">)</span>&nbsp;<span class="op" id="4352224">(</span><span class="ident" id="4352225">pkgs</span>&nbsp;<span class="keyword" id="4352230">map</span><span class="op" id="4352233">[</span><span class="builtintype" id="4352234">string</span><span class="op" id="4352240">]</span><span class="op" id="4352241">*</span><span class="ident" id="4352242">ast</span><span class="op" id="4352245">.</span><span class="ident" id="4352246">Package</span><span class="op" id="4352253">,</span>&nbsp;<span class="ident" id="4352255">first</span>&nbsp;<span class="builtintype" id="4352261">error</span><span class="op" id="4352266">)</span>&nbsp;<span class="op" id="4352268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352271">fd</span><span class="op" id="4352273">,</span>&nbsp;<span class="ident" id="4352275">err</span>&nbsp;<span class="op" id="4352279">:=</span>&nbsp;<span class="ident" id="4352282">os</span><span class="op" id="4352284">.</span><span class="ident" id="4352285">Open</span><span class="op" id="4352289">(</span><span class="ident" id="4352290">path</span><span class="op" id="4352294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4352297">if</span>&nbsp;<span class="ident" id="4352300">err</span>&nbsp;<span class="op" id="4352304">!=</span>&nbsp;<span class="ident" id="4352307">nil</span>&nbsp;<span class="op" id="4352311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4352315">return</span>&nbsp;<span class="ident" id="4352322">nil</span><span class="op" id="4352325">,</span>&nbsp;<span class="ident" id="4352327">err</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4352332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4352335">defer</span>&nbsp;<span class="ident" id="4352341">fd</span><span class="op" id="4352343">.</span><span class="ident" id="4352344">Close</span><span class="op" id="4352349">(</span><span class="op" id="4352350">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352354">list</span><span class="op" id="4352358">,</span>&nbsp;<span class="ident" id="4352360">err</span>&nbsp;<span class="op" id="4352364">:=</span>&nbsp;<span class="ident" id="4352367">fd</span><span class="op" id="4352369">.</span><span class="ident" id="4352370">Readdir</span><span class="op" id="4352377">(</span><span class="op" id="4352378">-</span><span class="num" id="4352379">1</span><span class="op" id="4352380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4352383">if</span>&nbsp;<span class="ident" id="4352386">err</span>&nbsp;<span class="op" id="4352390">!=</span>&nbsp;<span class="ident" id="4352393">nil</span>&nbsp;<span class="op" id="4352397">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4352401">return</span>&nbsp;<span class="ident" id="4352408">nil</span><span class="op" id="4352411">,</span>&nbsp;<span class="ident" id="4352413">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4352418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352422">pkgs</span>&nbsp;<span class="op" id="4352427">=</span>&nbsp;<span class="builtinfunc" id="4352429">make</span><span class="op" id="4352433">(</span><span class="keyword" id="4352434">map</span><span class="op" id="4352437">[</span><span class="builtintype" id="4352438">string</span><span class="op" id="4352444">]</span><span class="op" id="4352445">*</span><span class="ident" id="4352446">ast</span><span class="op" id="4352449">.</span><span class="ident" id="4352450">Package</span><span class="op" id="4352457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4352460">for</span>&nbsp;<span class="ident" id="4352464">_</span><span class="op" id="4352465">,</span>&nbsp;<span class="ident" id="4352467">d</span>&nbsp;<span class="op" id="4352469">:=</span>&nbsp;<span class="keyword" id="4352472">range</span>&nbsp;<span class="ident" id="4352478">list</span>&nbsp;<span class="op" id="4352483">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4352487">if</span>&nbsp;<span class="ident" id="4352490">strings</span><span class="op" id="4352497">.</span><span class="ident" id="4352498">HasSuffix</span><span class="op" id="4352507">(</span><span class="ident" id="4352508">d</span><span class="op" id="4352509">.</span><span class="ident" id="4352510">Name</span><span class="op" id="4352514">(</span><span class="op" id="4352515">)</span><span class="op" id="4352516">,</span>&nbsp;<span class="string" id="4352518">&#34;.go&#34;</span><span class="op" id="4352523">)</span>&nbsp;<span class="op" id="4352525">&amp;&amp;</span>&nbsp;<span class="op" id="4352528">(</span><span class="ident" id="4352529">filter</span>&nbsp;<span class="op" id="4352536">==</span>&nbsp;<span class="ident" id="4352539">nil</span>&nbsp;<span class="op" id="4352543">||</span>&nbsp;<span class="ident" id="4352546">filter</span><span class="op" id="4352552">(</span><span class="ident" id="4352553">d</span><span class="op" id="4352554">)</span><span class="op" id="4352555">)</span>&nbsp;<span class="op" id="4352557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352562">filename</span>&nbsp;<span class="op" id="4352571">:=</span>&nbsp;<span class="ident" id="4352574">filepath</span><span class="op" id="4352582">.</span><span class="ident" id="4352583">Join</span><span class="op" id="4352587">(</span><span class="ident" id="4352588">path</span><span class="op" id="4352592">,</span>&nbsp;<span class="ident" id="4352594">d</span><span class="op" id="4352595">.</span><span class="ident" id="4352596">Name</span><span class="op" id="4352600">(</span><span class="op" id="4352601">)</span><span class="op" id="4352602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4352607">if</span>&nbsp;<span class="ident" id="4352610">src</span><span class="op" id="4352613">,</span>&nbsp;<span class="ident" id="4352615">err</span>&nbsp;<span class="op" id="4352619">:=</span>&nbsp;<span class="ident" id="4352622">ParseFile</span><span class="op" id="4352631">(</span><span class="ident" id="4352632">fset</span><span class="op" id="4352636">,</span>&nbsp;<span class="ident" id="4352638">filename</span><span class="op" id="4352646">,</span>&nbsp;<span class="ident" id="4352648">nil</span><span class="op" id="4352651">,</span>&nbsp;<span class="ident" id="4352653">mode</span><span class="op" id="4352657">)</span><span class="op" id="4352658">;</span>&nbsp;<span class="ident" id="4352660">err</span>&nbsp;<span class="op" id="4352664">==</span>&nbsp;<span class="ident" id="4352667">nil</span>&nbsp;<span class="op" id="4352671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352677">name</span>&nbsp;<span class="op" id="4352682">:=</span>&nbsp;<span class="ident" id="4352685">src</span><span class="op" id="4352688">.</span><span class="ident" id="4352689">Name</span><span class="op" id="4352693">.</span><span class="ident" id="4352694">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352703">pkg</span><span class="op" id="4352706">,</span>&nbsp;<span class="ident" id="4352708">found</span>&nbsp;<span class="op" id="4352714">:=</span>&nbsp;<span class="ident" id="4352717">pkgs</span><span class="op" id="4352721">[</span><span class="ident" id="4352722">name</span><span class="op" id="4352726">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4352732">if</span>&nbsp;<span class="op" id="4352735">!</span><span class="ident" id="4352736">found</span>&nbsp;<span class="op" id="4352742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352749">pkg</span>&nbsp;<span class="op" id="4352753">=</span>&nbsp;<span class="op" id="4352755">&amp;</span><span class="ident" id="4352756">ast</span><span class="op" id="4352759">.</span><span class="ident" id="4352760">Package</span><span class="op" id="4352767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352775">Name</span><span class="op" id="4352779">:</span>&nbsp;&nbsp;<span class="ident" id="4352782">name</span><span class="op" id="4352786">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352794">Files</span><span class="op" id="4352799">:</span>&nbsp;<span class="builtinfunc" id="4352801">make</span><span class="op" id="4352805">(</span><span class="keyword" id="4352806">map</span><span class="op" id="4352809">[</span><span class="builtintype" id="4352810">string</span><span class="op" id="4352816">]</span><span class="op" id="4352817">*</span><span class="ident" id="4352818">ast</span><span class="op" id="4352821">.</span><span class="ident" id="4352822">File</span><span class="op" id="4352826">)</span><span class="op" id="4352827">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4352834">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352841">pkgs</span><span class="op" id="4352845">[</span><span class="ident" id="4352846">name</span><span class="op" id="4352850">]</span>&nbsp;<span class="op" id="4352852">=</span>&nbsp;<span class="ident" id="4352854">pkg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4352862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352868">pkg</span><span class="op" id="4352871">.</span><span class="ident" id="4352872">Files</span><span class="op" id="4352877">[</span><span class="ident" id="4352878">filename</span><span class="op" id="4352886">]</span>&nbsp;<span class="op" id="4352888">=</span>&nbsp;<span class="ident" id="4352890">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4352897">}</span>&nbsp;<span class="keyword" id="4352899">else</span>&nbsp;<span class="keyword" id="4352904">if</span>&nbsp;<span class="ident" id="4352907">first</span>&nbsp;<span class="op" id="4352913">==</span>&nbsp;<span class="ident" id="4352916">nil</span>&nbsp;<span class="op" id="4352920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4352926">first</span>&nbsp;<span class="op" id="4352932">=</span>&nbsp;<span class="ident" id="4352934">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4352941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4352945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4352948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4352952">return</span><br>
<span class="lineno">165</span><span class="op" id="4352959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4352962">//&nbsp;ParseExpr&nbsp;is&nbsp;a&nbsp;convenience&nbsp;function&nbsp;for&nbsp;obtaining&nbsp;the&nbsp;AST&nbsp;of&nbsp;an&nbsp;expression&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="4353043">//&nbsp;The&nbsp;position&nbsp;information&nbsp;recorded&nbsp;in&nbsp;the&nbsp;AST&nbsp;is&nbsp;undefined.&nbsp;The&nbsp;filename&nbsp;used</span><br>
<span class="lineno"></span><span class="comment" id="4353123">//&nbsp;in&nbsp;error&nbsp;messages&nbsp;is&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno">170</span><span class="comment" id="4353165">//</span><br>
<span class="lineno"></span><span class="keyword" id="4353168">func</span>&nbsp;<span class="ident" id="4353173">ParseExpr</span><span class="op" id="4353182">(</span><span class="ident" id="4353183">x</span>&nbsp;<span class="builtintype" id="4353185">string</span><span class="op" id="4353191">)</span>&nbsp;<span class="op" id="4353193">(</span><span class="ident" id="4353194">ast</span><span class="op" id="4353197">.</span><span class="ident" id="4353198">Expr</span><span class="op" id="4353202">,</span>&nbsp;<span class="builtintype" id="4353204">error</span><span class="op" id="4353209">)</span>&nbsp;<span class="op" id="4353211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4353214">var</span>&nbsp;<span class="ident" id="4353218">p</span>&nbsp;<span class="ident" id="4353220">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4353228">p</span><span class="op" id="4353229">.</span><span class="ident" id="4353230">init</span><span class="op" id="4353234">(</span><span class="ident" id="4353235">token</span><span class="op" id="4353240">.</span><span class="ident" id="4353241">NewFileSet</span><span class="op" id="4353251">(</span><span class="op" id="4353252">)</span><span class="op" id="4353253">,</span>&nbsp;<span class="string" id="4353255">&#34;&#34;</span><span class="op" id="4353257">,</span>&nbsp;<span class="op" id="4353259">[</span><span class="op" id="4353260">]</span><span class="builtintype" id="4353261">byte</span><span class="op" id="4353265">(</span><span class="ident" id="4353266">x</span><span class="op" id="4353267">)</span><span class="op" id="4353268">,</span>&nbsp;<span class="num" id="4353270">0</span><span class="op" id="4353271">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4353275">//&nbsp;Set&nbsp;up&nbsp;pkg-level&nbsp;scopes&nbsp;to&nbsp;avoid&nbsp;nil-pointer&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4353332">//&nbsp;This&nbsp;is&nbsp;not&nbsp;needed&nbsp;for&nbsp;a&nbsp;correct&nbsp;expression&nbsp;x&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4353389">//&nbsp;parser&nbsp;will&nbsp;be&nbsp;ok&nbsp;with&nbsp;a&nbsp;nil&nbsp;topScope,&nbsp;but&nbsp;be&nbsp;cautious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4353448">//&nbsp;in&nbsp;case&nbsp;of&nbsp;an&nbsp;erroneous&nbsp;x.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4353479">p</span><span class="op" id="4353480">.</span><span class="ident" id="4353481">openScope</span><span class="op" id="4353490">(</span><span class="op" id="4353491">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4353494">p</span><span class="op" id="4353495">.</span><span class="ident" id="4353496">pkgScope</span>&nbsp;<span class="op" id="4353505">=</span>&nbsp;<span class="ident" id="4353507">p</span><span class="op" id="4353508">.</span><span class="ident" id="4353509">topScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4353519">e</span>&nbsp;<span class="op" id="4353521">:=</span>&nbsp;<span class="ident" id="4353524">p</span><span class="op" id="4353525">.</span><span class="ident" id="4353526">parseRhsOrType</span><span class="op" id="4353540">(</span><span class="op" id="4353541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4353544">p</span><span class="op" id="4353545">.</span><span class="ident" id="4353546">closeScope</span><span class="op" id="4353556">(</span><span class="op" id="4353557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4353560">assert</span><span class="op" id="4353566">(</span><span class="ident" id="4353567">p</span><span class="op" id="4353568">.</span><span class="ident" id="4353569">topScope</span>&nbsp;<span class="op" id="4353578">==</span>&nbsp;<span class="ident" id="4353581">nil</span><span class="op" id="4353584">,</span>&nbsp;<span class="string" id="4353586">&#34;unbalanced&nbsp;scopes&#34;</span><span class="op" id="4353605">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4353609">//&nbsp;If&nbsp;a&nbsp;semicolon&nbsp;was&nbsp;inserted,&nbsp;consume&nbsp;it;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4353654">//&nbsp;report&nbsp;an&nbsp;error&nbsp;if&nbsp;there&#39;s&nbsp;more&nbsp;tokens.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4353698">if</span>&nbsp;<span class="ident" id="4353701">p</span><span class="op" id="4353702">.</span><span class="ident" id="4353703">tok</span>&nbsp;<span class="op" id="4353707">==</span>&nbsp;<span class="ident" id="4353710">token</span><span class="op" id="4353715">.</span><span class="ident" id="4353716">SEMICOLON</span>&nbsp;<span class="op" id="4353726">&amp;&amp;</span>&nbsp;<span class="ident" id="4353729">p</span><span class="op" id="4353730">.</span><span class="ident" id="4353731">lit</span>&nbsp;<span class="op" id="4353735">==</span>&nbsp;<span class="string" id="4353738">&#34;\n&#34;</span>&nbsp;<span class="op" id="4353743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4353747">p</span><span class="op" id="4353748">.</span><span class="ident" id="4353749">next</span><span class="op" id="4353753">(</span><span class="op" id="4353754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4353757">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4353760">p</span><span class="op" id="4353761">.</span><span class="ident" id="4353762">expect</span><span class="op" id="4353768">(</span><span class="ident" id="4353769">token</span><span class="op" id="4353774">.</span><span class="ident" id="4353775">EOF</span><span class="op" id="4353778">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4353782">if</span>&nbsp;<span class="ident" id="4353785">p</span><span class="op" id="4353786">.</span><span class="ident" id="4353787">errors</span><span class="op" id="4353793">.</span><span class="ident" id="4353794">Len</span><span class="op" id="4353797">(</span><span class="op" id="4353798">)</span>&nbsp;<span class="op" id="4353800">&gt;</span>&nbsp;<span class="num" id="4353802">0</span>&nbsp;<span class="op" id="4353804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4353808">p</span><span class="op" id="4353809">.</span><span class="ident" id="4353810">errors</span><span class="op" id="4353816">.</span><span class="ident" id="4353817">Sort</span><span class="op" id="4353821">(</span><span class="op" id="4353822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4353826">return</span>&nbsp;<span class="ident" id="4353833">nil</span><span class="op" id="4353836">,</span>&nbsp;<span class="ident" id="4353838">p</span><span class="op" id="4353839">.</span><span class="ident" id="4353840">errors</span><span class="op" id="4353846">.</span><span class="ident" id="4353847">Err</span><span class="op" id="4353850">(</span><span class="op" id="4353851">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4353854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4353858">return</span>&nbsp;<span class="ident" id="4353865">e</span><span class="op" id="4353866">,</span>&nbsp;<span class="ident" id="4353868">nil</span><br>
<span class="lineno"></span><span class="op" id="4353872">}</span>
</div>
</body>
</html>
