<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html" class="current">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5996844">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5996899">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5996953">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5997004">//&nbsp;Package&nbsp;sql&nbsp;provides&nbsp;a&nbsp;generic&nbsp;interface&nbsp;around&nbsp;SQL&nbsp;(or&nbsp;SQL-like)</span><br>
<span class="lineno"></span><span class="comment" id="5997073">//&nbsp;databases.</span><br>
<span class="lineno"></span><span class="comment" id="5997087">//</span><br>
<span class="lineno"></span><span class="comment" id="5997090">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;must&nbsp;be&nbsp;used&nbsp;in&nbsp;conjunction&nbsp;with&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="5997161">//&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for&nbsp;a&nbsp;list&nbsp;of&nbsp;drivers.</span><br>
<span class="lineno">10</span><span class="comment" id="5997222">//</span><br>
<span class="lineno"></span><span class="comment" id="5997225">//&nbsp;For&nbsp;more&nbsp;usage&nbsp;examples,&nbsp;see&nbsp;the&nbsp;wiki&nbsp;page&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5997274">//&nbsp;http://golang.org/s/sqlwiki.</span><br>
<span class="lineno"></span><span class="keyword" id="5997306">package</span>&nbsp;<span class="ident" id="5997314">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5997319">import</span>&nbsp;<span class="op" id="5997326">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5997329">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5997352">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5997362">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5997369">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5997375">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5997386">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5997394">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5997401">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5997404">var</span>&nbsp;<span class="ident" id="5997408">drivers</span>&nbsp;<span class="op" id="5997416">=</span>&nbsp;<span class="builtinfunc" id="5997418">make</span><span class="op" id="5997422">(</span><span class="keyword" id="5997423">map</span><span class="op" id="5997426">[</span><span class="builtintype" id="5997427">string</span><span class="op" id="5997433">]</span><span class="ident" id="5997434">driver</span><span class="op" id="5997440">.</span><span class="ident" id="5997441">Driver</span><span class="op" id="5997447">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5997450">//&nbsp;Register&nbsp;makes&nbsp;a&nbsp;database&nbsp;driver&nbsp;available&nbsp;by&nbsp;the&nbsp;provided&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="5997518">//&nbsp;If&nbsp;Register&nbsp;is&nbsp;called&nbsp;twice&nbsp;with&nbsp;the&nbsp;same&nbsp;name&nbsp;or&nbsp;if&nbsp;driver&nbsp;is&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="5997589">//&nbsp;it&nbsp;panics.</span><br>
<span class="lineno">30</span><span class="keyword" id="5997603">func</span>&nbsp;<span class="ident" id="5997608">Register</span><span class="op" id="5997616">(</span><span class="ident" id="5997617">name</span>&nbsp;<span class="builtintype" id="5997622">string</span><span class="op" id="5997628">,</span>&nbsp;<span class="ident" id="5997630">driver</span>&nbsp;<span class="ident" id="5997637">driver</span><span class="op" id="5997643">.</span><span class="ident" id="5997644">Driver</span><span class="op" id="5997650">)</span>&nbsp;<span class="op" id="5997652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997655">if</span>&nbsp;<span class="ident" id="5997658">driver</span>&nbsp;<span class="op" id="5997665">==</span>&nbsp;<span class="builtintype" id="5997668">nil</span>&nbsp;<span class="op" id="5997672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5997676">panic</span><span class="op" id="5997681">(</span><span class="string" id="5997682">&#34;sql:&nbsp;Register&nbsp;driver&nbsp;is&nbsp;nil&#34;</span><span class="op" id="5997711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5997714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5997717">if</span>&nbsp;<span class="ident" id="5997720">_</span><span class="op" id="5997721">,</span>&nbsp;<span class="ident" id="5997723">dup</span>&nbsp;<span class="op" id="5997727">:=</span>&nbsp;<span class="ident" id="5997730">drivers</span><span class="op" id="5997737">[</span><span class="ident" id="5997738">name</span><span class="op" id="5997742">]</span><span class="op" id="5997743">;</span>&nbsp;<span class="ident" id="5997745">dup</span>&nbsp;<span class="op" id="5997749">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5997753">panic</span><span class="op" id="5997758">(</span><span class="string" id="5997759">&#34;sql:&nbsp;Register&nbsp;called&nbsp;twice&nbsp;for&nbsp;driver&nbsp;&#34;</span>&nbsp;<span class="op" id="5997800">+</span>&nbsp;<span class="ident" id="5997802">name</span><span class="op" id="5997806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5997809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5997812">drivers</span><span class="op" id="5997819">[</span><span class="ident" id="5997820">name</span><span class="op" id="5997824">]</span>&nbsp;<span class="op" id="5997826">=</span>&nbsp;<span class="ident" id="5997828">driver</span><br>
<span class="lineno"></span><span class="op" id="5997835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="5997838">func</span>&nbsp;<span class="ident" id="5997843">unregisterAllDrivers</span><span class="op" id="5997863">(</span><span class="op" id="5997864">)</span>&nbsp;<span class="op" id="5997866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5997869">//&nbsp;For&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5997884">drivers</span>&nbsp;<span class="op" id="5997892">=</span>&nbsp;<span class="builtinfunc" id="5997894">make</span><span class="op" id="5997898">(</span><span class="keyword" id="5997899">map</span><span class="op" id="5997902">[</span><span class="builtintype" id="5997903">string</span><span class="op" id="5997909">]</span><span class="ident" id="5997910">driver</span><span class="op" id="5997916">.</span><span class="ident" id="5997917">Driver</span><span class="op" id="5997923">)</span><br>
<span class="lineno"></span><span class="op" id="5997925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5997928">//&nbsp;Drivers&nbsp;returns&nbsp;a&nbsp;sorted&nbsp;list&nbsp;of&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;registered&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="keyword" id="5998001">func</span>&nbsp;<span class="ident" id="5998006">Drivers</span><span class="op" id="5998013">(</span><span class="op" id="5998014">)</span>&nbsp;<span class="op" id="5998016">[</span><span class="op" id="5998017">]</span><span class="builtintype" id="5998018">string</span>&nbsp;<span class="op" id="5998025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5998028">var</span>&nbsp;<span class="ident" id="5998032">list</span>&nbsp;<span class="op" id="5998037">[</span><span class="op" id="5998038">]</span><span class="builtintype" id="5998039">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5998047">for</span>&nbsp;<span class="ident" id="5998051">name</span>&nbsp;<span class="op" id="5998056">:=</span>&nbsp;<span class="keyword" id="5998059">range</span>&nbsp;<span class="ident" id="5998065">drivers</span>&nbsp;<span class="op" id="5998073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5998077">list</span>&nbsp;<span class="op" id="5998082">=</span>&nbsp;<span class="builtinfunc" id="5998084">append</span><span class="op" id="5998090">(</span><span class="ident" id="5998091">list</span><span class="op" id="5998095">,</span>&nbsp;<span class="ident" id="5998097">name</span><span class="op" id="5998101">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5998104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5998107">sort</span><span class="op" id="5998111">.</span><span class="ident" id="5998112">Strings</span><span class="op" id="5998119">(</span><span class="ident" id="5998120">list</span><span class="op" id="5998124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5998127">return</span>&nbsp;<span class="ident" id="5998134">list</span><br>
<span class="lineno"></span><span class="op" id="5998139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5998142">//&nbsp;RawBytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;slice&nbsp;that&nbsp;holds&nbsp;a&nbsp;reference&nbsp;to&nbsp;memory&nbsp;owned&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5998212">//&nbsp;the&nbsp;database&nbsp;itself.&nbsp;After&nbsp;a&nbsp;Scan&nbsp;into&nbsp;a&nbsp;RawBytes,&nbsp;the&nbsp;slice&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="5998284">//&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;Next,&nbsp;Scan,&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="5998338">type</span>&nbsp;<span class="ident" id="5998343">RawBytes</span>&nbsp;<span class="op" id="5998352">[</span><span class="op" id="5998353">]</span><span class="builtintype" id="5998354">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="5998360">//&nbsp;NullString&nbsp;represents&nbsp;a&nbsp;string&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5998412">//&nbsp;NullString&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5998462">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination:</span><br>
<span class="lineno"></span><span class="comment" id="5998503">//</span><br>
<span class="lineno"></span><span class="comment" id="5998506">//&nbsp;&nbsp;var&nbsp;s&nbsp;NullString</span><br>
<span class="lineno">65</span><span class="comment" id="5998527">//&nbsp;&nbsp;err&nbsp;:=&nbsp;db.QueryRow(&#34;SELECT&nbsp;name&nbsp;FROM&nbsp;foo&nbsp;WHERE&nbsp;id=?&#34;,&nbsp;id).Scan(&amp;s)</span><br>
<span class="lineno"></span><span class="comment" id="5998598">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="5998606">//&nbsp;&nbsp;if&nbsp;s.Valid&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="5998623">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;use&nbsp;s.String</span><br>
<span class="lineno"></span><span class="comment" id="5998646">//&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno">70</span><span class="comment" id="5998659">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;NULL&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5998680">//&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="5998686">//</span><br>
<span class="lineno"></span><span class="keyword" id="5998689">type</span>&nbsp;<span class="ident" id="5998694">NullString</span>&nbsp;<span class="keyword" id="5998705">struct</span>&nbsp;<span class="op" id="5998712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5998715">String</span>&nbsp;<span class="builtintype" id="5998722">string</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5998730">Valid</span>&nbsp;&nbsp;<span class="builtintype" id="5998737">bool</span>&nbsp;<span class="comment" id="5998742">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;String&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5998781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5998784">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5998826">func</span>&nbsp;<span class="op" id="5998831">(</span><span class="ident" id="5998832">ns</span>&nbsp;<span class="op" id="5998835">*</span><span class="ident" id="5998836">NullString</span><span class="op" id="5998846">)</span>&nbsp;<span class="ident" id="5998848">Scan</span><span class="op" id="5998852">(</span><span class="ident" id="5998853">value</span>&nbsp;<span class="keyword" id="5998859">interface</span><span class="op" id="5998868">{</span><span class="op" id="5998869">}</span><span class="op" id="5998870">)</span>&nbsp;<span class="builtintype" id="5998872">error</span>&nbsp;<span class="op" id="5998878">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5998881">if</span>&nbsp;<span class="ident" id="5998884">value</span>&nbsp;<span class="op" id="5998890">==</span>&nbsp;<span class="builtintype" id="5998893">nil</span>&nbsp;<span class="op" id="5998897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5998901">ns</span><span class="op" id="5998903">.</span><span class="ident" id="5998904">String</span><span class="op" id="5998910">,</span>&nbsp;<span class="ident" id="5998912">ns</span><span class="op" id="5998914">.</span><span class="ident" id="5998915">Valid</span>&nbsp;<span class="op" id="5998921">=</span>&nbsp;<span class="string" id="5998923">&#34;&#34;</span><span class="op" id="5998925">,</span>&nbsp;<span class="builtintype" id="5998927">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5998935">return</span>&nbsp;<span class="builtintype" id="5998942">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5998947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5998950">ns</span><span class="op" id="5998952">.</span><span class="ident" id="5998953">Valid</span>&nbsp;<span class="op" id="5998959">=</span>&nbsp;<span class="builtintype" id="5998961">true</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5998967">return</span>&nbsp;<span class="ident" id="5998974">convertAssign</span><span class="op" id="5998987">(</span><span class="op" id="5998988">&amp;</span><span class="ident" id="5998989">ns</span><span class="op" id="5998991">.</span><span class="ident" id="5998992">String</span><span class="op" id="5998998">,</span>&nbsp;<span class="ident" id="5999000">value</span><span class="op" id="5999005">)</span><br>
<span class="lineno"></span><span class="op" id="5999007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5999010">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5999059">func</span>&nbsp;<span class="op" id="5999064">(</span><span class="ident" id="5999065">ns</span>&nbsp;<span class="ident" id="5999068">NullString</span><span class="op" id="5999078">)</span>&nbsp;<span class="ident" id="5999080">Value</span><span class="op" id="5999085">(</span><span class="op" id="5999086">)</span>&nbsp;<span class="op" id="5999088">(</span><span class="ident" id="5999089">driver</span><span class="op" id="5999095">.</span><span class="ident" id="5999096">Value</span><span class="op" id="5999101">,</span>&nbsp;<span class="builtintype" id="5999103">error</span><span class="op" id="5999108">)</span>&nbsp;<span class="op" id="5999110">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999113">if</span>&nbsp;<span class="op" id="5999116">!</span><span class="ident" id="5999117">ns</span><span class="op" id="5999119">.</span><span class="ident" id="5999120">Valid</span>&nbsp;<span class="op" id="5999126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999130">return</span>&nbsp;<span class="builtintype" id="5999137">nil</span><span class="op" id="5999140">,</span>&nbsp;<span class="builtintype" id="5999142">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5999147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999150">return</span>&nbsp;<span class="ident" id="5999157">ns</span><span class="op" id="5999159">.</span><span class="ident" id="5999160">String</span><span class="op" id="5999166">,</span>&nbsp;<span class="builtintype" id="5999168">nil</span><br>
<span class="lineno"></span><span class="op" id="5999172">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="5999175">//&nbsp;NullInt64&nbsp;represents&nbsp;an&nbsp;int64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5999226">//&nbsp;NullInt64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5999275">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="5999339">type</span>&nbsp;<span class="ident" id="5999344">NullInt64</span>&nbsp;<span class="keyword" id="5999354">struct</span>&nbsp;<span class="op" id="5999361">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5999364">Int64</span>&nbsp;<span class="ident" id="5999370">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5999377">Valid</span>&nbsp;<span class="builtintype" id="5999383">bool</span>&nbsp;<span class="comment" id="5999388">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Int64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="5999426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5999429">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno">105</span><span class="keyword" id="5999471">func</span>&nbsp;<span class="op" id="5999476">(</span><span class="ident" id="5999477">n</span>&nbsp;<span class="op" id="5999479">*</span><span class="ident" id="5999480">NullInt64</span><span class="op" id="5999489">)</span>&nbsp;<span class="ident" id="5999491">Scan</span><span class="op" id="5999495">(</span><span class="ident" id="5999496">value</span>&nbsp;<span class="keyword" id="5999502">interface</span><span class="op" id="5999511">{</span><span class="op" id="5999512">}</span><span class="op" id="5999513">)</span>&nbsp;<span class="builtintype" id="5999515">error</span>&nbsp;<span class="op" id="5999521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999524">if</span>&nbsp;<span class="ident" id="5999527">value</span>&nbsp;<span class="op" id="5999533">==</span>&nbsp;<span class="builtintype" id="5999536">nil</span>&nbsp;<span class="op" id="5999540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5999544">n</span><span class="op" id="5999545">.</span><span class="ident" id="5999546">Int64</span><span class="op" id="5999551">,</span>&nbsp;<span class="ident" id="5999553">n</span><span class="op" id="5999554">.</span><span class="ident" id="5999555">Valid</span>&nbsp;<span class="op" id="5999561">=</span>&nbsp;<span class="num" id="5999563">0</span><span class="op" id="5999564">,</span>&nbsp;<span class="builtintype" id="5999566">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999574">return</span>&nbsp;<span class="builtintype" id="5999581">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5999586">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5999589">n</span><span class="op" id="5999590">.</span><span class="ident" id="5999591">Valid</span>&nbsp;<span class="op" id="5999597">=</span>&nbsp;<span class="builtintype" id="5999599">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999605">return</span>&nbsp;<span class="ident" id="5999612">convertAssign</span><span class="op" id="5999625">(</span><span class="op" id="5999626">&amp;</span><span class="ident" id="5999627">n</span><span class="op" id="5999628">.</span><span class="ident" id="5999629">Int64</span><span class="op" id="5999634">,</span>&nbsp;<span class="ident" id="5999636">value</span><span class="op" id="5999641">)</span><br>
<span class="lineno"></span><span class="op" id="5999643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5999646">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno">115</span><span class="keyword" id="5999695">func</span>&nbsp;<span class="op" id="5999700">(</span><span class="ident" id="5999701">n</span>&nbsp;<span class="ident" id="5999703">NullInt64</span><span class="op" id="5999712">)</span>&nbsp;<span class="ident" id="5999714">Value</span><span class="op" id="5999719">(</span><span class="op" id="5999720">)</span>&nbsp;<span class="op" id="5999722">(</span><span class="ident" id="5999723">driver</span><span class="op" id="5999729">.</span><span class="ident" id="5999730">Value</span><span class="op" id="5999735">,</span>&nbsp;<span class="builtintype" id="5999737">error</span><span class="op" id="5999742">)</span>&nbsp;<span class="op" id="5999744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999747">if</span>&nbsp;<span class="op" id="5999750">!</span><span class="ident" id="5999751">n</span><span class="op" id="5999752">.</span><span class="ident" id="5999753">Valid</span>&nbsp;<span class="op" id="5999759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999763">return</span>&nbsp;<span class="builtintype" id="5999770">nil</span><span class="op" id="5999773">,</span>&nbsp;<span class="builtintype" id="5999775">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5999780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5999783">return</span>&nbsp;<span class="ident" id="5999790">n</span><span class="op" id="5999791">.</span><span class="ident" id="5999792">Int64</span><span class="op" id="5999797">,</span>&nbsp;<span class="builtintype" id="5999799">nil</span><br>
<span class="lineno">120</span><span class="op" id="5999803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5999806">//&nbsp;NullFloat64&nbsp;represents&nbsp;a&nbsp;float64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="5999860">//&nbsp;NullFloat64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5999911">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno">125</span><span class="keyword" id="5999975">type</span>&nbsp;<span class="ident" id="5999980">NullFloat64</span>&nbsp;<span class="keyword" id="5999992">struct</span>&nbsp;<span class="op" id="5999999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6000002">Float64</span>&nbsp;<span class="builtintype" id="6000010">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6000019">Valid</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6000027">bool</span>&nbsp;<span class="comment" id="6000032">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Float64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6000072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="6000075">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6000117">func</span>&nbsp;<span class="op" id="6000122">(</span><span class="ident" id="6000123">n</span>&nbsp;<span class="op" id="6000125">*</span><span class="ident" id="6000126">NullFloat64</span><span class="op" id="6000137">)</span>&nbsp;<span class="ident" id="6000139">Scan</span><span class="op" id="6000143">(</span><span class="ident" id="6000144">value</span>&nbsp;<span class="keyword" id="6000150">interface</span><span class="op" id="6000159">{</span><span class="op" id="6000160">}</span><span class="op" id="6000161">)</span>&nbsp;<span class="builtintype" id="6000163">error</span>&nbsp;<span class="op" id="6000169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000172">if</span>&nbsp;<span class="ident" id="6000175">value</span>&nbsp;<span class="op" id="6000181">==</span>&nbsp;<span class="builtintype" id="6000184">nil</span>&nbsp;<span class="op" id="6000188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6000192">n</span><span class="op" id="6000193">.</span><span class="ident" id="6000194">Float64</span><span class="op" id="6000201">,</span>&nbsp;<span class="ident" id="6000203">n</span><span class="op" id="6000204">.</span><span class="ident" id="6000205">Valid</span>&nbsp;<span class="op" id="6000211">=</span>&nbsp;<span class="num" id="6000213">0</span><span class="op" id="6000214">,</span>&nbsp;<span class="builtintype" id="6000216">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000224">return</span>&nbsp;<span class="builtintype" id="6000231">nil</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6000236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6000239">n</span><span class="op" id="6000240">.</span><span class="ident" id="6000241">Valid</span>&nbsp;<span class="op" id="6000247">=</span>&nbsp;<span class="builtintype" id="6000249">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000255">return</span>&nbsp;<span class="ident" id="6000262">convertAssign</span><span class="op" id="6000275">(</span><span class="op" id="6000276">&amp;</span><span class="ident" id="6000277">n</span><span class="op" id="6000278">.</span><span class="ident" id="6000279">Float64</span><span class="op" id="6000286">,</span>&nbsp;<span class="ident" id="6000288">value</span><span class="op" id="6000293">)</span><br>
<span class="lineno"></span><span class="op" id="6000295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="6000298">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6000347">func</span>&nbsp;<span class="op" id="6000352">(</span><span class="ident" id="6000353">n</span>&nbsp;<span class="ident" id="6000355">NullFloat64</span><span class="op" id="6000366">)</span>&nbsp;<span class="ident" id="6000368">Value</span><span class="op" id="6000373">(</span><span class="op" id="6000374">)</span>&nbsp;<span class="op" id="6000376">(</span><span class="ident" id="6000377">driver</span><span class="op" id="6000383">.</span><span class="ident" id="6000384">Value</span><span class="op" id="6000389">,</span>&nbsp;<span class="builtintype" id="6000391">error</span><span class="op" id="6000396">)</span>&nbsp;<span class="op" id="6000398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000401">if</span>&nbsp;<span class="op" id="6000404">!</span><span class="ident" id="6000405">n</span><span class="op" id="6000406">.</span><span class="ident" id="6000407">Valid</span>&nbsp;<span class="op" id="6000413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000417">return</span>&nbsp;<span class="builtintype" id="6000424">nil</span><span class="op" id="6000427">,</span>&nbsp;<span class="builtintype" id="6000429">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6000434">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000437">return</span>&nbsp;<span class="ident" id="6000444">n</span><span class="op" id="6000445">.</span><span class="ident" id="6000446">Float64</span><span class="op" id="6000453">,</span>&nbsp;<span class="builtintype" id="6000455">nil</span><br>
<span class="lineno"></span><span class="op" id="6000459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6000462">//&nbsp;NullBool&nbsp;represents&nbsp;a&nbsp;bool&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6000510">//&nbsp;NullBool&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="6000558">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="6000622">type</span>&nbsp;<span class="ident" id="6000627">NullBool</span>&nbsp;<span class="keyword" id="6000636">struct</span>&nbsp;<span class="op" id="6000643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6000646">Bool</span>&nbsp;&nbsp;<span class="builtintype" id="6000652">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6000658">Valid</span>&nbsp;<span class="builtintype" id="6000664">bool</span>&nbsp;<span class="comment" id="6000669">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Bool&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6000706">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="6000709">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6000751">func</span>&nbsp;<span class="op" id="6000756">(</span><span class="ident" id="6000757">n</span>&nbsp;<span class="op" id="6000759">*</span><span class="ident" id="6000760">NullBool</span><span class="op" id="6000768">)</span>&nbsp;<span class="ident" id="6000770">Scan</span><span class="op" id="6000774">(</span><span class="ident" id="6000775">value</span>&nbsp;<span class="keyword" id="6000781">interface</span><span class="op" id="6000790">{</span><span class="op" id="6000791">}</span><span class="op" id="6000792">)</span>&nbsp;<span class="builtintype" id="6000794">error</span>&nbsp;<span class="op" id="6000800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000803">if</span>&nbsp;<span class="ident" id="6000806">value</span>&nbsp;<span class="op" id="6000812">==</span>&nbsp;<span class="builtintype" id="6000815">nil</span>&nbsp;<span class="op" id="6000819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6000823">n</span><span class="op" id="6000824">.</span><span class="ident" id="6000825">Bool</span><span class="op" id="6000829">,</span>&nbsp;<span class="ident" id="6000831">n</span><span class="op" id="6000832">.</span><span class="ident" id="6000833">Valid</span>&nbsp;<span class="op" id="6000839">=</span>&nbsp;<span class="builtintype" id="6000841">false</span><span class="op" id="6000846">,</span>&nbsp;<span class="builtintype" id="6000848">false</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000856">return</span>&nbsp;<span class="builtintype" id="6000863">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6000868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6000871">n</span><span class="op" id="6000872">.</span><span class="ident" id="6000873">Valid</span>&nbsp;<span class="op" id="6000879">=</span>&nbsp;<span class="builtintype" id="6000881">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6000887">return</span>&nbsp;<span class="ident" id="6000894">convertAssign</span><span class="op" id="6000907">(</span><span class="op" id="6000908">&amp;</span><span class="ident" id="6000909">n</span><span class="op" id="6000910">.</span><span class="ident" id="6000911">Bool</span><span class="op" id="6000915">,</span>&nbsp;<span class="ident" id="6000917">value</span><span class="op" id="6000922">)</span><br>
<span class="lineno"></span><span class="op" id="6000924">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="6000927">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6000976">func</span>&nbsp;<span class="op" id="6000981">(</span><span class="ident" id="6000982">n</span>&nbsp;<span class="ident" id="6000984">NullBool</span><span class="op" id="6000992">)</span>&nbsp;<span class="ident" id="6000994">Value</span><span class="op" id="6000999">(</span><span class="op" id="6001000">)</span>&nbsp;<span class="op" id="6001002">(</span><span class="ident" id="6001003">driver</span><span class="op" id="6001009">.</span><span class="ident" id="6001010">Value</span><span class="op" id="6001015">,</span>&nbsp;<span class="builtintype" id="6001017">error</span><span class="op" id="6001022">)</span>&nbsp;<span class="op" id="6001024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001027">if</span>&nbsp;<span class="op" id="6001030">!</span><span class="ident" id="6001031">n</span><span class="op" id="6001032">.</span><span class="ident" id="6001033">Valid</span>&nbsp;<span class="op" id="6001039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001043">return</span>&nbsp;<span class="builtintype" id="6001050">nil</span><span class="op" id="6001053">,</span>&nbsp;<span class="builtintype" id="6001055">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6001060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6001063">return</span>&nbsp;<span class="ident" id="6001070">n</span><span class="op" id="6001071">.</span><span class="ident" id="6001072">Bool</span><span class="op" id="6001076">,</span>&nbsp;<span class="builtintype" id="6001078">nil</span><br>
<span class="lineno"></span><span class="op" id="6001082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6001085">//&nbsp;Scanner&nbsp;is&nbsp;an&nbsp;interface&nbsp;used&nbsp;by&nbsp;Scan.</span><br>
<span class="lineno">175</span><span class="keyword" id="6001126">type</span>&nbsp;<span class="ident" id="6001131">Scanner</span>&nbsp;<span class="keyword" id="6001139">interface</span>&nbsp;<span class="op" id="6001149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6001152">//&nbsp;Scan&nbsp;assigns&nbsp;a&nbsp;value&nbsp;from&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6001201">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6001205">//&nbsp;The&nbsp;src&nbsp;value&nbsp;will&nbsp;be&nbsp;of&nbsp;one&nbsp;of&nbsp;the&nbsp;following&nbsp;restricted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6001266">//&nbsp;set&nbsp;of&nbsp;types:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6001284">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6001288">//&nbsp;&nbsp;&nbsp;&nbsp;int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6001301">//&nbsp;&nbsp;&nbsp;&nbsp;float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6001316">//&nbsp;&nbsp;&nbsp;&nbsp;bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6001328">//&nbsp;&nbsp;&nbsp;&nbsp;[]byte</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6001342">//&nbsp;&nbsp;&nbsp;&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6001356">//&nbsp;&nbsp;&nbsp;&nbsp;time.Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6001373">//&nbsp;&nbsp;&nbsp;&nbsp;nil&nbsp;-&nbsp;for&nbsp;NULL&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6001402">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6001406">//&nbsp;An&nbsp;error&nbsp;should&nbsp;be&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;can&nbsp;not&nbsp;be&nbsp;stored</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6001469">//&nbsp;without&nbsp;loss&nbsp;of&nbsp;information.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6001502">Scan</span><span class="op" id="6001506">(</span><span class="ident" id="6001507">src</span>&nbsp;<span class="keyword" id="6001511">interface</span><span class="op" id="6001520">{</span><span class="op" id="6001521">}</span><span class="op" id="6001522">)</span>&nbsp;<span class="builtintype" id="6001524">error</span><br>
<span class="lineno"></span><span class="op" id="6001530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6001533">//&nbsp;ErrNoRows&nbsp;is&nbsp;returned&nbsp;by&nbsp;Scan&nbsp;when&nbsp;QueryRow&nbsp;doesn&#39;t&nbsp;return&nbsp;a</span><br>
<span class="lineno">195</span><span class="comment" id="6001597">//&nbsp;row.&nbsp;In&nbsp;such&nbsp;a&nbsp;case,&nbsp;QueryRow&nbsp;returns&nbsp;a&nbsp;placeholder&nbsp;*Row&nbsp;value&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="6001668">//&nbsp;defers&nbsp;this&nbsp;error&nbsp;until&nbsp;a&nbsp;Scan.</span><br>
<span class="lineno"></span><span class="keyword" id="6001703">var</span>&nbsp;<span class="ident" id="6001707">ErrNoRows</span>&nbsp;<span class="op" id="6001717">=</span>&nbsp;<span class="ident" id="6001719">errors</span><span class="op" id="6001725">.</span><span class="ident" id="6001726">New</span><span class="op" id="6001729">(</span><span class="string" id="6001730">&#34;sql:&nbsp;no&nbsp;rows&nbsp;in&nbsp;result&nbsp;set&#34;</span><span class="op" id="6001758">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6001761">//&nbsp;DB&nbsp;is&nbsp;a&nbsp;database&nbsp;handle&nbsp;representing&nbsp;a&nbsp;pool&nbsp;of&nbsp;zero&nbsp;or&nbsp;more</span><br>
<span class="lineno">200</span><span class="comment" id="6001824">//&nbsp;underlying&nbsp;connections.&nbsp;It&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple</span><br>
<span class="lineno"></span><span class="comment" id="6001892">//&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="6001907">//</span><br>
<span class="lineno"></span><span class="comment" id="6001910">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;creates&nbsp;and&nbsp;frees&nbsp;connections&nbsp;automatically;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="6001977">//&nbsp;also&nbsp;maintains&nbsp;a&nbsp;free&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;If&nbsp;the&nbsp;database&nbsp;has</span><br>
<span class="lineno">205</span><span class="comment" id="6002048">//&nbsp;a&nbsp;concept&nbsp;of&nbsp;per-connection&nbsp;state,&nbsp;such&nbsp;state&nbsp;can&nbsp;only&nbsp;be&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="6002118">//&nbsp;observed&nbsp;within&nbsp;a&nbsp;transaction.&nbsp;Once&nbsp;DB.Begin&nbsp;is&nbsp;called,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6002181">//&nbsp;returned&nbsp;Tx&nbsp;is&nbsp;bound&nbsp;to&nbsp;a&nbsp;single&nbsp;connection.&nbsp;Once&nbsp;Commit&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6002244">//&nbsp;Rollback&nbsp;is&nbsp;called&nbsp;on&nbsp;the&nbsp;transaction,&nbsp;that&nbsp;transaction&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="6002305">//&nbsp;connection&nbsp;is&nbsp;returned&nbsp;to&nbsp;DB&#39;s&nbsp;idle&nbsp;connection&nbsp;pool.&nbsp;The&nbsp;pool&nbsp;size</span><br>
<span class="lineno">210</span><span class="comment" id="6002375">//&nbsp;can&nbsp;be&nbsp;controlled&nbsp;with&nbsp;SetMaxIdleConns.</span><br>
<span class="lineno"></span><span class="keyword" id="6002418">type</span>&nbsp;<span class="ident" id="6002423">DB</span>&nbsp;<span class="keyword" id="6002426">struct</span>&nbsp;<span class="op" id="6002433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6002436">driver</span>&nbsp;<span class="ident" id="6002443">driver</span><span class="op" id="6002449">.</span><span class="ident" id="6002450">Driver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6002458">dsn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6002465">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6002474">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6002487">sync</span><span class="op" id="6002491">.</span><span class="ident" id="6002492">Mutex</span>&nbsp;<span class="comment" id="6002498">//&nbsp;protects&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6002528">freeConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6002541">[</span><span class="op" id="6002542">]</span><span class="op" id="6002543">*</span><span class="ident" id="6002544">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6002556">connRequests</span>&nbsp;<span class="op" id="6002569">[</span><span class="op" id="6002570">]</span><span class="keyword" id="6002571">chan</span>&nbsp;<span class="ident" id="6002576">connRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6002589">numOpen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6002602">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6002607">pendingOpens</span>&nbsp;<span class="builtintype" id="6002620">int</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6002625">//&nbsp;Used&nbsp;to&nbsp;signal&nbsp;the&nbsp;need&nbsp;for&nbsp;new&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6002673">//&nbsp;a&nbsp;goroutine&nbsp;running&nbsp;connectionOpener()&nbsp;reads&nbsp;on&nbsp;this&nbsp;chan&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6002739">//&nbsp;maybeOpenNewConnections&nbsp;sends&nbsp;on&nbsp;the&nbsp;chan&nbsp;(one&nbsp;send&nbsp;per&nbsp;needed&nbsp;connection)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6002818">//&nbsp;It&nbsp;is&nbsp;closed&nbsp;during&nbsp;db.Close().&nbsp;The&nbsp;close&nbsp;tells&nbsp;the&nbsp;connectionOpener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6002891">//&nbsp;goroutine&nbsp;to&nbsp;exit.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6002914">openerCh</span>&nbsp;<span class="keyword" id="6002923">chan</span>&nbsp;<span class="keyword" id="6002928">struct</span><span class="op" id="6002934">{</span><span class="op" id="6002935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6002938">closed</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6002947">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6002953">dep</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6002962">map</span><span class="op" id="6002965">[</span><span class="ident" id="6002966">finalCloser</span><span class="op" id="6002977">]</span><span class="ident" id="6002978">depSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6002986">lastPut</span>&nbsp;&nbsp;<span class="keyword" id="6002995">map</span><span class="op" id="6002998">[</span><span class="op" id="6002999">*</span><span class="ident" id="6003000">driverConn</span><span class="op" id="6003010">]</span><span class="builtintype" id="6003011">string</span>&nbsp;<span class="comment" id="6003018">//&nbsp;stacktrace&nbsp;of&nbsp;last&nbsp;conn&#39;s&nbsp;put;&nbsp;debug&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6003064">maxIdle</span>&nbsp;&nbsp;<span class="builtintype" id="6003073">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6003096">//&nbsp;zero&nbsp;means&nbsp;defaultMaxIdleConns;&nbsp;negative&nbsp;means&nbsp;0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6003149">maxOpen</span>&nbsp;&nbsp;<span class="builtintype" id="6003158">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6003181">//&nbsp;&lt;=&nbsp;0&nbsp;means&nbsp;unlimited</span><br>
<span class="lineno"></span><span class="op" id="6003205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6003208">//&nbsp;driverConn&nbsp;wraps&nbsp;a&nbsp;driver.Conn&nbsp;with&nbsp;a&nbsp;mutex,&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6003259">//&nbsp;be&nbsp;held&nbsp;during&nbsp;all&nbsp;calls&nbsp;into&nbsp;the&nbsp;Conn.&nbsp;(including&nbsp;any&nbsp;calls&nbsp;onto</span><br>
<span class="lineno">235</span><span class="comment" id="6003328">//&nbsp;interfaces&nbsp;returned&nbsp;via&nbsp;that&nbsp;Conn,&nbsp;such&nbsp;as&nbsp;calls&nbsp;on&nbsp;Tx,&nbsp;Stmt,</span><br>
<span class="lineno"></span><span class="comment" id="6003393">//&nbsp;Result,&nbsp;Rows)</span><br>
<span class="lineno"></span><span class="keyword" id="6003410">type</span>&nbsp;<span class="ident" id="6003415">driverConn</span>&nbsp;<span class="keyword" id="6003426">struct</span>&nbsp;<span class="op" id="6003433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6003436">db</span>&nbsp;<span class="op" id="6003439">*</span><span class="ident" id="6003440">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6003445">sync</span><span class="op" id="6003449">.</span><span class="ident" id="6003450">Mutex</span>&nbsp;&nbsp;<span class="comment" id="6003457">//&nbsp;guards&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6003478">ci</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6003490">driver</span><span class="op" id="6003496">.</span><span class="ident" id="6003497">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6003503">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6003515">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6003521">finalClosed</span>&nbsp;<span class="builtintype" id="6003533">bool</span>&nbsp;<span class="comment" id="6003538">//&nbsp;ci.Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6003567">openStmt</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6003579">map</span><span class="op" id="6003582">[</span><span class="ident" id="6003583">driver</span><span class="op" id="6003589">.</span><span class="ident" id="6003590">Stmt</span><span class="op" id="6003594">]</span><span class="builtintype" id="6003595">bool</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6003602">//&nbsp;guarded&nbsp;by&nbsp;db.mu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6003623">inUse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6003634">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6003640">onPut</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6003651">[</span><span class="op" id="6003652">]</span><span class="keyword" id="6003653">func</span><span class="op" id="6003657">(</span><span class="op" id="6003658">)</span>&nbsp;<span class="comment" id="6003660">//&nbsp;code&nbsp;(with&nbsp;db.mu&nbsp;held)&nbsp;run&nbsp;when&nbsp;conn&nbsp;is&nbsp;next&nbsp;returned</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6003718">dbmuClosed</span>&nbsp;<span class="builtintype" id="6003729">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6003738">//&nbsp;same&nbsp;as&nbsp;closed,&nbsp;but&nbsp;guarded&nbsp;by&nbsp;db.mu,&nbsp;for&nbsp;connIfFree</span><br>
<span class="lineno">250</span><span class="op" id="6003794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6003797">func</span>&nbsp;<span class="op" id="6003802">(</span><span class="ident" id="6003803">dc</span>&nbsp;<span class="op" id="6003806">*</span><span class="ident" id="6003807">driverConn</span><span class="op" id="6003817">)</span>&nbsp;<span class="ident" id="6003819">releaseConn</span><span class="op" id="6003830">(</span><span class="ident" id="6003831">err</span>&nbsp;<span class="builtintype" id="6003835">error</span><span class="op" id="6003840">)</span>&nbsp;<span class="op" id="6003842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6003845">dc</span><span class="op" id="6003847">.</span><span class="ident" id="6003848">db</span><span class="op" id="6003850">.</span><span class="ident" id="6003851">putConn</span><span class="op" id="6003858">(</span><span class="ident" id="6003859">dc</span><span class="op" id="6003861">,</span>&nbsp;<span class="ident" id="6003863">err</span><span class="op" id="6003866">)</span><br>
<span class="lineno"></span><span class="op" id="6003868">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="6003871">func</span>&nbsp;<span class="op" id="6003876">(</span><span class="ident" id="6003877">dc</span>&nbsp;<span class="op" id="6003880">*</span><span class="ident" id="6003881">driverConn</span><span class="op" id="6003891">)</span>&nbsp;<span class="ident" id="6003893">removeOpenStmt</span><span class="op" id="6003907">(</span><span class="ident" id="6003908">si</span>&nbsp;<span class="ident" id="6003911">driver</span><span class="op" id="6003917">.</span><span class="ident" id="6003918">Stmt</span><span class="op" id="6003922">)</span>&nbsp;<span class="op" id="6003924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6003927">dc</span><span class="op" id="6003929">.</span><span class="ident" id="6003930">Lock</span><span class="op" id="6003934">(</span><span class="op" id="6003935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6003938">defer</span>&nbsp;<span class="ident" id="6003944">dc</span><span class="op" id="6003946">.</span><span class="ident" id="6003947">Unlock</span><span class="op" id="6003953">(</span><span class="op" id="6003954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6003957">delete</span><span class="op" id="6003963">(</span><span class="ident" id="6003964">dc</span><span class="op" id="6003966">.</span><span class="ident" id="6003967">openStmt</span><span class="op" id="6003975">,</span>&nbsp;<span class="ident" id="6003977">si</span><span class="op" id="6003979">)</span><br>
<span class="lineno">260</span><span class="op" id="6003981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6003984">func</span>&nbsp;<span class="op" id="6003989">(</span><span class="ident" id="6003990">dc</span>&nbsp;<span class="op" id="6003993">*</span><span class="ident" id="6003994">driverConn</span><span class="op" id="6004004">)</span>&nbsp;<span class="ident" id="6004006">prepareLocked</span><span class="op" id="6004019">(</span><span class="ident" id="6004020">query</span>&nbsp;<span class="builtintype" id="6004026">string</span><span class="op" id="6004032">)</span>&nbsp;<span class="op" id="6004034">(</span><span class="ident" id="6004035">driver</span><span class="op" id="6004041">.</span><span class="ident" id="6004042">Stmt</span><span class="op" id="6004046">,</span>&nbsp;<span class="builtintype" id="6004048">error</span><span class="op" id="6004053">)</span>&nbsp;<span class="op" id="6004055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6004058">si</span><span class="op" id="6004060">,</span>&nbsp;<span class="ident" id="6004062">err</span>&nbsp;<span class="op" id="6004066">:=</span>&nbsp;<span class="ident" id="6004069">dc</span><span class="op" id="6004071">.</span><span class="ident" id="6004072">ci</span><span class="op" id="6004074">.</span><span class="ident" id="6004075">Prepare</span><span class="op" id="6004082">(</span><span class="ident" id="6004083">query</span><span class="op" id="6004088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6004091">if</span>&nbsp;<span class="ident" id="6004094">err</span>&nbsp;<span class="op" id="6004098">==</span>&nbsp;<span class="builtintype" id="6004101">nil</span>&nbsp;<span class="op" id="6004105">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6004109">//&nbsp;Track&nbsp;each&nbsp;driverConn&#39;s&nbsp;open&nbsp;statements,&nbsp;so&nbsp;we&nbsp;can&nbsp;close&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6004176">//&nbsp;before&nbsp;closing&nbsp;the&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6004206">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6004211">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;drivers&nbsp;opt&nbsp;out&nbsp;of&nbsp;caring&nbsp;about</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6004268">//&nbsp;stmt&nbsp;closes&nbsp;if&nbsp;the&nbsp;conn&nbsp;is&nbsp;about&nbsp;to&nbsp;close&nbsp;anyway?&nbsp;For&nbsp;now</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6004331">//&nbsp;do&nbsp;the&nbsp;safe&nbsp;thing,&nbsp;in&nbsp;case&nbsp;stmts&nbsp;need&nbsp;to&nbsp;be&nbsp;closed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6004388">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6004393">//&nbsp;TODO(bradfitz):&nbsp;after&nbsp;Go&nbsp;1.2,&nbsp;closing&nbsp;driver.Stmts</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6004449">//&nbsp;should&nbsp;be&nbsp;moved&nbsp;to&nbsp;driverStmt,&nbsp;using&nbsp;unique</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6004498">//&nbsp;*driverStmts&nbsp;everywhere&nbsp;(including&nbsp;from</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6004543">//&nbsp;*Stmt.connStmt,&nbsp;instead&nbsp;of&nbsp;returning&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6004587">//&nbsp;driver.Stmt),&nbsp;using&nbsp;driverStmt&nbsp;as&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6004636">//&nbsp;everywhere,&nbsp;and&nbsp;making&nbsp;it&nbsp;a&nbsp;finalCloser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6004682">if</span>&nbsp;<span class="ident" id="6004685">dc</span><span class="op" id="6004687">.</span><span class="ident" id="6004688">openStmt</span>&nbsp;<span class="op" id="6004697">==</span>&nbsp;<span class="builtintype" id="6004700">nil</span>&nbsp;<span class="op" id="6004704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6004709">dc</span><span class="op" id="6004711">.</span><span class="ident" id="6004712">openStmt</span>&nbsp;<span class="op" id="6004721">=</span>&nbsp;<span class="builtinfunc" id="6004723">make</span><span class="op" id="6004727">(</span><span class="keyword" id="6004728">map</span><span class="op" id="6004731">[</span><span class="ident" id="6004732">driver</span><span class="op" id="6004738">.</span><span class="ident" id="6004739">Stmt</span><span class="op" id="6004743">]</span><span class="builtintype" id="6004744">bool</span><span class="op" id="6004748">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6004752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6004756">dc</span><span class="op" id="6004758">.</span><span class="ident" id="6004759">openStmt</span><span class="op" id="6004767">[</span><span class="ident" id="6004768">si</span><span class="op" id="6004770">]</span>&nbsp;<span class="op" id="6004772">=</span>&nbsp;<span class="builtintype" id="6004774">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6004780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6004783">return</span>&nbsp;<span class="ident" id="6004790">si</span><span class="op" id="6004792">,</span>&nbsp;<span class="ident" id="6004794">err</span><br>
<span class="lineno"></span><span class="op" id="6004798">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="6004801">//&nbsp;the&nbsp;dc.db&#39;s&nbsp;Mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="6004831">func</span>&nbsp;<span class="op" id="6004836">(</span><span class="ident" id="6004837">dc</span>&nbsp;<span class="op" id="6004840">*</span><span class="ident" id="6004841">driverConn</span><span class="op" id="6004851">)</span>&nbsp;<span class="ident" id="6004853">closeDBLocked</span><span class="op" id="6004866">(</span><span class="op" id="6004867">)</span>&nbsp;<span class="keyword" id="6004869">func</span><span class="op" id="6004873">(</span><span class="op" id="6004874">)</span>&nbsp;<span class="builtintype" id="6004876">error</span>&nbsp;<span class="op" id="6004882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6004885">dc</span><span class="op" id="6004887">.</span><span class="ident" id="6004888">Lock</span><span class="op" id="6004892">(</span><span class="op" id="6004893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6004896">defer</span>&nbsp;<span class="ident" id="6004902">dc</span><span class="op" id="6004904">.</span><span class="ident" id="6004905">Unlock</span><span class="op" id="6004911">(</span><span class="op" id="6004912">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6004915">if</span>&nbsp;<span class="ident" id="6004918">dc</span><span class="op" id="6004920">.</span><span class="ident" id="6004921">closed</span>&nbsp;<span class="op" id="6004928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6004932">return</span>&nbsp;<span class="keyword" id="6004939">func</span><span class="op" id="6004943">(</span><span class="op" id="6004944">)</span>&nbsp;<span class="builtintype" id="6004946">error</span>&nbsp;<span class="op" id="6004952">{</span>&nbsp;<span class="keyword" id="6004954">return</span>&nbsp;<span class="ident" id="6004961">errors</span><span class="op" id="6004967">.</span><span class="ident" id="6004968">New</span><span class="op" id="6004971">(</span><span class="string" id="6004972">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="6005005">)</span>&nbsp;<span class="op" id="6005007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6005010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005013">dc</span><span class="op" id="6005015">.</span><span class="ident" id="6005016">closed</span>&nbsp;<span class="op" id="6005023">=</span>&nbsp;<span class="builtintype" id="6005025">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6005031">return</span>&nbsp;<span class="ident" id="6005038">dc</span><span class="op" id="6005040">.</span><span class="ident" id="6005041">db</span><span class="op" id="6005043">.</span><span class="ident" id="6005044">removeDepLocked</span><span class="op" id="6005059">(</span><span class="ident" id="6005060">dc</span><span class="op" id="6005062">,</span>&nbsp;<span class="ident" id="6005064">dc</span><span class="op" id="6005066">)</span><br>
<span class="lineno">295</span><span class="op" id="6005068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6005071">func</span>&nbsp;<span class="op" id="6005076">(</span><span class="ident" id="6005077">dc</span>&nbsp;<span class="op" id="6005080">*</span><span class="ident" id="6005081">driverConn</span><span class="op" id="6005091">)</span>&nbsp;<span class="ident" id="6005093">Close</span><span class="op" id="6005098">(</span><span class="op" id="6005099">)</span>&nbsp;<span class="builtintype" id="6005101">error</span>&nbsp;<span class="op" id="6005107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005110">dc</span><span class="op" id="6005112">.</span><span class="ident" id="6005113">Lock</span><span class="op" id="6005117">(</span><span class="op" id="6005118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6005121">if</span>&nbsp;<span class="ident" id="6005124">dc</span><span class="op" id="6005126">.</span><span class="ident" id="6005127">closed</span>&nbsp;<span class="op" id="6005134">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005138">dc</span><span class="op" id="6005140">.</span><span class="ident" id="6005141">Unlock</span><span class="op" id="6005147">(</span><span class="op" id="6005148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6005152">return</span>&nbsp;<span class="ident" id="6005159">errors</span><span class="op" id="6005165">.</span><span class="ident" id="6005166">New</span><span class="op" id="6005169">(</span><span class="string" id="6005170">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="6005203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6005206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005209">dc</span><span class="op" id="6005211">.</span><span class="ident" id="6005212">closed</span>&nbsp;<span class="op" id="6005219">=</span>&nbsp;<span class="builtintype" id="6005221">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005227">dc</span><span class="op" id="6005229">.</span><span class="ident" id="6005230">Unlock</span><span class="op" id="6005236">(</span><span class="op" id="6005237">)</span>&nbsp;<span class="comment" id="6005239">//&nbsp;not&nbsp;defer;&nbsp;removeDep&nbsp;finalClose&nbsp;calls&nbsp;may&nbsp;need&nbsp;to&nbsp;lock</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6005299">//&nbsp;And&nbsp;now&nbsp;updates&nbsp;that&nbsp;require&nbsp;holding&nbsp;dc.mu.Lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005352">dc</span><span class="op" id="6005354">.</span><span class="ident" id="6005355">db</span><span class="op" id="6005357">.</span><span class="ident" id="6005358">mu</span><span class="op" id="6005360">.</span><span class="ident" id="6005361">Lock</span><span class="op" id="6005365">(</span><span class="op" id="6005366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005369">dc</span><span class="op" id="6005371">.</span><span class="ident" id="6005372">dbmuClosed</span>&nbsp;<span class="op" id="6005383">=</span>&nbsp;<span class="builtintype" id="6005385">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005391">fn</span>&nbsp;<span class="op" id="6005394">:=</span>&nbsp;<span class="ident" id="6005397">dc</span><span class="op" id="6005399">.</span><span class="ident" id="6005400">db</span><span class="op" id="6005402">.</span><span class="ident" id="6005403">removeDepLocked</span><span class="op" id="6005418">(</span><span class="ident" id="6005419">dc</span><span class="op" id="6005421">,</span>&nbsp;<span class="ident" id="6005423">dc</span><span class="op" id="6005425">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005428">dc</span><span class="op" id="6005430">.</span><span class="ident" id="6005431">db</span><span class="op" id="6005433">.</span><span class="ident" id="6005434">mu</span><span class="op" id="6005436">.</span><span class="ident" id="6005437">Unlock</span><span class="op" id="6005443">(</span><span class="op" id="6005444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6005447">return</span>&nbsp;<span class="ident" id="6005454">fn</span><span class="op" id="6005456">(</span><span class="op" id="6005457">)</span><br>
<span class="lineno"></span><span class="op" id="6005459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6005462">func</span>&nbsp;<span class="op" id="6005467">(</span><span class="ident" id="6005468">dc</span>&nbsp;<span class="op" id="6005471">*</span><span class="ident" id="6005472">driverConn</span><span class="op" id="6005482">)</span>&nbsp;<span class="ident" id="6005484">finalClose</span><span class="op" id="6005494">(</span><span class="op" id="6005495">)</span>&nbsp;<span class="builtintype" id="6005497">error</span>&nbsp;<span class="op" id="6005503">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005506">dc</span><span class="op" id="6005508">.</span><span class="ident" id="6005509">Lock</span><span class="op" id="6005513">(</span><span class="op" id="6005514">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6005518">for</span>&nbsp;<span class="ident" id="6005522">si</span>&nbsp;<span class="op" id="6005525">:=</span>&nbsp;<span class="keyword" id="6005528">range</span>&nbsp;<span class="ident" id="6005534">dc</span><span class="op" id="6005536">.</span><span class="ident" id="6005537">openStmt</span>&nbsp;<span class="op" id="6005546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005550">si</span><span class="op" id="6005552">.</span><span class="ident" id="6005553">Close</span><span class="op" id="6005558">(</span><span class="op" id="6005559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6005562">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005565">dc</span><span class="op" id="6005567">.</span><span class="ident" id="6005568">openStmt</span>&nbsp;<span class="op" id="6005577">=</span>&nbsp;<span class="builtintype" id="6005579">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005585">err</span>&nbsp;<span class="op" id="6005589">:=</span>&nbsp;<span class="ident" id="6005592">dc</span><span class="op" id="6005594">.</span><span class="ident" id="6005595">ci</span><span class="op" id="6005597">.</span><span class="ident" id="6005598">Close</span><span class="op" id="6005603">(</span><span class="op" id="6005604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005607">dc</span><span class="op" id="6005609">.</span><span class="ident" id="6005610">ci</span>&nbsp;<span class="op" id="6005613">=</span>&nbsp;<span class="builtintype" id="6005615">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005620">dc</span><span class="op" id="6005622">.</span><span class="ident" id="6005623">finalClosed</span>&nbsp;<span class="op" id="6005635">=</span>&nbsp;<span class="builtintype" id="6005637">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005643">dc</span><span class="op" id="6005645">.</span><span class="ident" id="6005646">Unlock</span><span class="op" id="6005652">(</span><span class="op" id="6005653">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005657">dc</span><span class="op" id="6005659">.</span><span class="ident" id="6005660">db</span><span class="op" id="6005662">.</span><span class="ident" id="6005663">mu</span><span class="op" id="6005665">.</span><span class="ident" id="6005666">Lock</span><span class="op" id="6005670">(</span><span class="op" id="6005671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005674">dc</span><span class="op" id="6005676">.</span><span class="ident" id="6005677">db</span><span class="op" id="6005679">.</span><span class="ident" id="6005680">numOpen</span><span class="op" id="6005687">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005691">dc</span><span class="op" id="6005693">.</span><span class="ident" id="6005694">db</span><span class="op" id="6005696">.</span><span class="ident" id="6005697">maybeOpenNewConnections</span><span class="op" id="6005720">(</span><span class="op" id="6005721">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005724">dc</span><span class="op" id="6005726">.</span><span class="ident" id="6005727">db</span><span class="op" id="6005729">.</span><span class="ident" id="6005730">mu</span><span class="op" id="6005732">.</span><span class="ident" id="6005733">Unlock</span><span class="op" id="6005739">(</span><span class="op" id="6005740">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6005744">return</span>&nbsp;<span class="ident" id="6005751">err</span><br>
<span class="lineno"></span><span class="op" id="6005755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="6005758">//&nbsp;driverStmt&nbsp;associates&nbsp;a&nbsp;driver.Stmt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6005806">//&nbsp;*driverConn&nbsp;from&nbsp;which&nbsp;it&nbsp;came,&nbsp;so&nbsp;the&nbsp;driverConn&#39;s&nbsp;lock&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6005873">//&nbsp;held&nbsp;during&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="6005895">type</span>&nbsp;<span class="ident" id="6005900">driverStmt</span>&nbsp;<span class="keyword" id="6005911">struct</span>&nbsp;<span class="op" id="6005918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005921">sync</span><span class="op" id="6005925">.</span><span class="ident" id="6005926">Locker</span>&nbsp;<span class="comment" id="6005933">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005953">si</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6005965">driver</span><span class="op" id="6005971">.</span><span class="ident" id="6005972">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6005977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6005980">func</span>&nbsp;<span class="op" id="6005985">(</span><span class="ident" id="6005986">ds</span>&nbsp;<span class="op" id="6005989">*</span><span class="ident" id="6005990">driverStmt</span><span class="op" id="6006000">)</span>&nbsp;<span class="ident" id="6006002">Close</span><span class="op" id="6006007">(</span><span class="op" id="6006008">)</span>&nbsp;<span class="builtintype" id="6006010">error</span>&nbsp;<span class="op" id="6006016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6006019">ds</span><span class="op" id="6006021">.</span><span class="ident" id="6006022">Lock</span><span class="op" id="6006026">(</span><span class="op" id="6006027">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6006030">defer</span>&nbsp;<span class="ident" id="6006036">ds</span><span class="op" id="6006038">.</span><span class="ident" id="6006039">Unlock</span><span class="op" id="6006045">(</span><span class="op" id="6006046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6006049">return</span>&nbsp;<span class="ident" id="6006056">ds</span><span class="op" id="6006058">.</span><span class="ident" id="6006059">si</span><span class="op" id="6006061">.</span><span class="ident" id="6006062">Close</span><span class="op" id="6006067">(</span><span class="op" id="6006068">)</span><br>
<span class="lineno"></span><span class="op" id="6006070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6006073">//&nbsp;depSet&nbsp;is&nbsp;a&nbsp;finalCloser&#39;s&nbsp;outstanding&nbsp;dependencies</span><br>
<span class="lineno">350</span><span class="keyword" id="6006127">type</span>&nbsp;<span class="ident" id="6006132">depSet</span>&nbsp;<span class="keyword" id="6006139">map</span><span class="op" id="6006142">[</span><span class="keyword" id="6006143">interface</span><span class="op" id="6006152">{</span><span class="op" id="6006153">}</span><span class="op" id="6006154">]</span><span class="builtintype" id="6006155">bool</span>&nbsp;<span class="comment" id="6006160">//&nbsp;set&nbsp;of&nbsp;true&nbsp;bools</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6006182">//&nbsp;The&nbsp;finalCloser&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;(*DB).addDep&nbsp;and&nbsp;related</span><br>
<span class="lineno"></span><span class="comment" id="6006247">//&nbsp;dependency&nbsp;reference&nbsp;counting.</span><br>
<span class="lineno"></span><span class="keyword" id="6006281">type</span>&nbsp;<span class="ident" id="6006286">finalCloser</span>&nbsp;<span class="keyword" id="6006298">interface</span>&nbsp;<span class="op" id="6006308">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6006311">//&nbsp;finalClose&nbsp;is&nbsp;called&nbsp;when&nbsp;the&nbsp;reference&nbsp;count&nbsp;of&nbsp;an&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6006374">//&nbsp;goes&nbsp;to&nbsp;zero.&nbsp;(*DB).mu&nbsp;is&nbsp;not&nbsp;held&nbsp;while&nbsp;calling&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6006431">finalClose</span><span class="op" id="6006441">(</span><span class="op" id="6006442">)</span>&nbsp;<span class="builtintype" id="6006444">error</span><br>
<span class="lineno"></span><span class="op" id="6006450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="comment" id="6006453">//&nbsp;addDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;now&nbsp;depends&nbsp;on&nbsp;dep,&nbsp;and&nbsp;x&#39;s&nbsp;finalClose&nbsp;won&#39;t&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6006524">//&nbsp;called&nbsp;until&nbsp;all&nbsp;of&nbsp;x&#39;s&nbsp;dependencies&nbsp;are&nbsp;removed&nbsp;with&nbsp;removeDep.</span><br>
<span class="lineno"></span><span class="keyword" id="6006592">func</span>&nbsp;<span class="op" id="6006597">(</span><span class="ident" id="6006598">db</span>&nbsp;<span class="op" id="6006601">*</span><span class="ident" id="6006602">DB</span><span class="op" id="6006604">)</span>&nbsp;<span class="ident" id="6006606">addDep</span><span class="op" id="6006612">(</span><span class="ident" id="6006613">x</span>&nbsp;<span class="ident" id="6006615">finalCloser</span><span class="op" id="6006626">,</span>&nbsp;<span class="ident" id="6006628">dep</span>&nbsp;<span class="keyword" id="6006632">interface</span><span class="op" id="6006641">{</span><span class="op" id="6006642">}</span><span class="op" id="6006643">)</span>&nbsp;<span class="op" id="6006645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6006648">//println(fmt.Sprintf(&#34;addDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6006712">db</span><span class="op" id="6006714">.</span><span class="ident" id="6006715">mu</span><span class="op" id="6006717">.</span><span class="ident" id="6006718">Lock</span><span class="op" id="6006722">(</span><span class="op" id="6006723">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6006726">defer</span>&nbsp;<span class="ident" id="6006732">db</span><span class="op" id="6006734">.</span><span class="ident" id="6006735">mu</span><span class="op" id="6006737">.</span><span class="ident" id="6006738">Unlock</span><span class="op" id="6006744">(</span><span class="op" id="6006745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6006748">db</span><span class="op" id="6006750">.</span><span class="ident" id="6006751">addDepLocked</span><span class="op" id="6006763">(</span><span class="ident" id="6006764">x</span><span class="op" id="6006765">,</span>&nbsp;<span class="ident" id="6006767">dep</span><span class="op" id="6006770">)</span><br>
<span class="lineno"></span><span class="op" id="6006772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6006775">func</span>&nbsp;<span class="op" id="6006780">(</span><span class="ident" id="6006781">db</span>&nbsp;<span class="op" id="6006784">*</span><span class="ident" id="6006785">DB</span><span class="op" id="6006787">)</span>&nbsp;<span class="ident" id="6006789">addDepLocked</span><span class="op" id="6006801">(</span><span class="ident" id="6006802">x</span>&nbsp;<span class="ident" id="6006804">finalCloser</span><span class="op" id="6006815">,</span>&nbsp;<span class="ident" id="6006817">dep</span>&nbsp;<span class="keyword" id="6006821">interface</span><span class="op" id="6006830">{</span><span class="op" id="6006831">}</span><span class="op" id="6006832">)</span>&nbsp;<span class="op" id="6006834">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6006837">if</span>&nbsp;<span class="ident" id="6006840">db</span><span class="op" id="6006842">.</span><span class="ident" id="6006843">dep</span>&nbsp;<span class="op" id="6006847">==</span>&nbsp;<span class="builtintype" id="6006850">nil</span>&nbsp;<span class="op" id="6006854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6006858">db</span><span class="op" id="6006860">.</span><span class="ident" id="6006861">dep</span>&nbsp;<span class="op" id="6006865">=</span>&nbsp;<span class="builtinfunc" id="6006867">make</span><span class="op" id="6006871">(</span><span class="keyword" id="6006872">map</span><span class="op" id="6006875">[</span><span class="ident" id="6006876">finalCloser</span><span class="op" id="6006887">]</span><span class="ident" id="6006888">depSet</span><span class="op" id="6006894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6006897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6006900">xdep</span>&nbsp;<span class="op" id="6006905">:=</span>&nbsp;<span class="ident" id="6006908">db</span><span class="op" id="6006910">.</span><span class="ident" id="6006911">dep</span><span class="op" id="6006914">[</span><span class="ident" id="6006915">x</span><span class="op" id="6006916">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6006919">if</span>&nbsp;<span class="ident" id="6006922">xdep</span>&nbsp;<span class="op" id="6006927">==</span>&nbsp;<span class="builtintype" id="6006930">nil</span>&nbsp;<span class="op" id="6006934">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6006938">xdep</span>&nbsp;<span class="op" id="6006943">=</span>&nbsp;<span class="builtinfunc" id="6006945">make</span><span class="op" id="6006949">(</span><span class="ident" id="6006950">depSet</span><span class="op" id="6006956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6006960">db</span><span class="op" id="6006962">.</span><span class="ident" id="6006963">dep</span><span class="op" id="6006966">[</span><span class="ident" id="6006967">x</span><span class="op" id="6006968">]</span>&nbsp;<span class="op" id="6006970">=</span>&nbsp;<span class="ident" id="6006972">xdep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6006978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6006981">xdep</span><span class="op" id="6006985">[</span><span class="ident" id="6006986">dep</span><span class="op" id="6006989">]</span>&nbsp;<span class="op" id="6006991">=</span>&nbsp;<span class="builtintype" id="6006993">true</span><br>
<span class="lineno"></span><span class="op" id="6006998">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="6007001">//&nbsp;removeDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;no&nbsp;longer&nbsp;depends&nbsp;on&nbsp;dep.</span><br>
<span class="lineno"></span><span class="comment" id="6007053">//&nbsp;If&nbsp;x&nbsp;still&nbsp;has&nbsp;dependencies,&nbsp;nil&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="6007102">//&nbsp;If&nbsp;x&nbsp;no&nbsp;longer&nbsp;has&nbsp;any&nbsp;dependencies,&nbsp;its&nbsp;finalClose&nbsp;method&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6007172">//&nbsp;called&nbsp;and&nbsp;its&nbsp;error&nbsp;value&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno">385</span><span class="keyword" id="6007220">func</span>&nbsp;<span class="op" id="6007225">(</span><span class="ident" id="6007226">db</span>&nbsp;<span class="op" id="6007229">*</span><span class="ident" id="6007230">DB</span><span class="op" id="6007232">)</span>&nbsp;<span class="ident" id="6007234">removeDep</span><span class="op" id="6007243">(</span><span class="ident" id="6007244">x</span>&nbsp;<span class="ident" id="6007246">finalCloser</span><span class="op" id="6007257">,</span>&nbsp;<span class="ident" id="6007259">dep</span>&nbsp;<span class="keyword" id="6007263">interface</span><span class="op" id="6007272">{</span><span class="op" id="6007273">}</span><span class="op" id="6007274">)</span>&nbsp;<span class="builtintype" id="6007276">error</span>&nbsp;<span class="op" id="6007282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6007285">db</span><span class="op" id="6007287">.</span><span class="ident" id="6007288">mu</span><span class="op" id="6007290">.</span><span class="ident" id="6007291">Lock</span><span class="op" id="6007295">(</span><span class="op" id="6007296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6007299">fn</span>&nbsp;<span class="op" id="6007302">:=</span>&nbsp;<span class="ident" id="6007305">db</span><span class="op" id="6007307">.</span><span class="ident" id="6007308">removeDepLocked</span><span class="op" id="6007323">(</span><span class="ident" id="6007324">x</span><span class="op" id="6007325">,</span>&nbsp;<span class="ident" id="6007327">dep</span><span class="op" id="6007330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6007333">db</span><span class="op" id="6007335">.</span><span class="ident" id="6007336">mu</span><span class="op" id="6007338">.</span><span class="ident" id="6007339">Unlock</span><span class="op" id="6007345">(</span><span class="op" id="6007346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6007349">return</span>&nbsp;<span class="ident" id="6007356">fn</span><span class="op" id="6007358">(</span><span class="op" id="6007359">)</span><br>
<span class="lineno">390</span><span class="op" id="6007361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6007364">func</span>&nbsp;<span class="op" id="6007369">(</span><span class="ident" id="6007370">db</span>&nbsp;<span class="op" id="6007373">*</span><span class="ident" id="6007374">DB</span><span class="op" id="6007376">)</span>&nbsp;<span class="ident" id="6007378">removeDepLocked</span><span class="op" id="6007393">(</span><span class="ident" id="6007394">x</span>&nbsp;<span class="ident" id="6007396">finalCloser</span><span class="op" id="6007407">,</span>&nbsp;<span class="ident" id="6007409">dep</span>&nbsp;<span class="keyword" id="6007413">interface</span><span class="op" id="6007422">{</span><span class="op" id="6007423">}</span><span class="op" id="6007424">)</span>&nbsp;<span class="keyword" id="6007426">func</span><span class="op" id="6007430">(</span><span class="op" id="6007431">)</span>&nbsp;<span class="builtintype" id="6007433">error</span>&nbsp;<span class="op" id="6007439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6007442">//println(fmt.Sprintf(&#34;removeDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6007510">xdep</span><span class="op" id="6007514">,</span>&nbsp;<span class="ident" id="6007516">ok</span>&nbsp;<span class="op" id="6007519">:=</span>&nbsp;<span class="ident" id="6007522">db</span><span class="op" id="6007524">.</span><span class="ident" id="6007525">dep</span><span class="op" id="6007528">[</span><span class="ident" id="6007529">x</span><span class="op" id="6007530">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6007533">if</span>&nbsp;<span class="op" id="6007536">!</span><span class="ident" id="6007537">ok</span>&nbsp;<span class="op" id="6007540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6007544">panic</span><span class="op" id="6007549">(</span><span class="ident" id="6007550">fmt</span><span class="op" id="6007553">.</span><span class="ident" id="6007554">Sprintf</span><span class="op" id="6007561">(</span><span class="string" id="6007562">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;deps&nbsp;for&nbsp;%T&#34;</span><span class="op" id="6007598">,</span>&nbsp;<span class="ident" id="6007600">x</span><span class="op" id="6007601">)</span><span class="op" id="6007602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6007605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6007609">l0</span>&nbsp;<span class="op" id="6007612">:=</span>&nbsp;<span class="builtinfunc" id="6007615">len</span><span class="op" id="6007618">(</span><span class="ident" id="6007619">xdep</span><span class="op" id="6007623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6007626">delete</span><span class="op" id="6007632">(</span><span class="ident" id="6007633">xdep</span><span class="op" id="6007637">,</span>&nbsp;<span class="ident" id="6007639">dep</span><span class="op" id="6007642">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6007646">switch</span>&nbsp;<span class="builtinfunc" id="6007653">len</span><span class="op" id="6007656">(</span><span class="ident" id="6007657">xdep</span><span class="op" id="6007661">)</span>&nbsp;<span class="op" id="6007663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6007666">case</span>&nbsp;<span class="ident" id="6007671">l0</span><span class="op" id="6007673">:</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6007677">//&nbsp;Nothing&nbsp;removed.&nbsp;Shouldn&#39;t&nbsp;happen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6007717">panic</span><span class="op" id="6007722">(</span><span class="ident" id="6007723">fmt</span><span class="op" id="6007726">.</span><span class="ident" id="6007727">Sprintf</span><span class="op" id="6007734">(</span><span class="string" id="6007735">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;%T&nbsp;dep&nbsp;on&nbsp;%T&#34;</span><span class="op" id="6007772">,</span>&nbsp;<span class="ident" id="6007774">dep</span><span class="op" id="6007777">,</span>&nbsp;<span class="ident" id="6007779">x</span><span class="op" id="6007780">)</span><span class="op" id="6007781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6007784">case</span>&nbsp;<span class="num" id="6007789">0</span><span class="op" id="6007790">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6007794">//&nbsp;No&nbsp;more&nbsp;dependencies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6007821">delete</span><span class="op" id="6007827">(</span><span class="ident" id="6007828">db</span><span class="op" id="6007830">.</span><span class="ident" id="6007831">dep</span><span class="op" id="6007834">,</span>&nbsp;<span class="ident" id="6007836">x</span><span class="op" id="6007837">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6007841">return</span>&nbsp;<span class="ident" id="6007848">x</span><span class="op" id="6007849">.</span><span class="ident" id="6007850">finalClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6007862">default</span><span class="op" id="6007869">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6007873">//&nbsp;Dependencies&nbsp;remain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6007899">return</span>&nbsp;<span class="keyword" id="6007906">func</span><span class="op" id="6007910">(</span><span class="op" id="6007911">)</span>&nbsp;<span class="builtintype" id="6007913">error</span>&nbsp;<span class="op" id="6007919">{</span>&nbsp;<span class="keyword" id="6007921">return</span>&nbsp;<span class="builtintype" id="6007928">nil</span>&nbsp;<span class="op" id="6007932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6007935">}</span><br>
<span class="lineno">415</span><span class="op" id="6007937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6007940">//&nbsp;This&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;connectionOpener&nbsp;request&nbsp;chan&nbsp;(dn.openerCh).</span><br>
<span class="lineno"></span><span class="comment" id="6008012">//&nbsp;This&nbsp;value&nbsp;should&nbsp;be&nbsp;larger&nbsp;than&nbsp;the&nbsp;maximum&nbsp;typical&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6008074">//&nbsp;used&nbsp;for&nbsp;db.maxOpen.&nbsp;If&nbsp;maxOpen&nbsp;is&nbsp;significantly&nbsp;larger&nbsp;than</span><br>
<span class="lineno">420</span><span class="comment" id="6008138">//&nbsp;connectionRequestQueueSize&nbsp;then&nbsp;it&nbsp;is&nbsp;possible&nbsp;for&nbsp;ALL&nbsp;calls&nbsp;into&nbsp;the&nbsp;*DB</span><br>
<span class="lineno"></span><span class="comment" id="6008215">//&nbsp;to&nbsp;block&nbsp;until&nbsp;the&nbsp;connectionOpener&nbsp;can&nbsp;satisfy&nbsp;the&nbsp;backlog&nbsp;of&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="6008291">var</span>&nbsp;<span class="ident" id="6008295">connectionRequestQueueSize</span>&nbsp;<span class="op" id="6008322">=</span>&nbsp;<span class="num" id="6008324">1000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6008333">//&nbsp;Open&nbsp;opens&nbsp;a&nbsp;database&nbsp;specified&nbsp;by&nbsp;its&nbsp;database&nbsp;driver&nbsp;name&nbsp;and&nbsp;a</span><br>
<span class="lineno">425</span><span class="comment" id="6008402">//&nbsp;driver-specific&nbsp;data&nbsp;source&nbsp;name,&nbsp;usually&nbsp;consisting&nbsp;of&nbsp;at&nbsp;least&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6008472">//&nbsp;database&nbsp;name&nbsp;and&nbsp;connection&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="6008517">//</span><br>
<span class="lineno"></span><span class="comment" id="6008520">//&nbsp;Most&nbsp;users&nbsp;will&nbsp;open&nbsp;a&nbsp;database&nbsp;via&nbsp;a&nbsp;driver-specific&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6008588">//&nbsp;helper&nbsp;function&nbsp;that&nbsp;returns&nbsp;a&nbsp;*DB.&nbsp;No&nbsp;database&nbsp;drivers&nbsp;are&nbsp;included</span><br>
<span class="lineno">430</span><span class="comment" id="6008660">//&nbsp;in&nbsp;the&nbsp;Go&nbsp;standard&nbsp;library.&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6008730">//&nbsp;a&nbsp;list&nbsp;of&nbsp;third-party&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="comment" id="6008764">//</span><br>
<span class="lineno"></span><span class="comment" id="6008767">//&nbsp;Open&nbsp;may&nbsp;just&nbsp;validate&nbsp;its&nbsp;arguments&nbsp;without&nbsp;creating&nbsp;a&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6008837">//&nbsp;to&nbsp;the&nbsp;database.&nbsp;To&nbsp;verify&nbsp;that&nbsp;the&nbsp;data&nbsp;source&nbsp;name&nbsp;is&nbsp;valid,&nbsp;call</span><br>
<span class="lineno">435</span><span class="comment" id="6008908">//&nbsp;Ping.</span><br>
<span class="lineno"></span><span class="comment" id="6008917">//</span><br>
<span class="lineno"></span><span class="comment" id="6008920">//&nbsp;The&nbsp;returned&nbsp;DB&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="6008989">//&nbsp;and&nbsp;maintains&nbsp;its&nbsp;own&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;Thus,&nbsp;the&nbsp;Open</span><br>
<span class="lineno"></span><span class="comment" id="6009055">//&nbsp;function&nbsp;should&nbsp;be&nbsp;called&nbsp;just&nbsp;once.&nbsp;It&nbsp;is&nbsp;rarely&nbsp;necessary&nbsp;to</span><br>
<span class="lineno">440</span><span class="comment" id="6009121">//&nbsp;close&nbsp;a&nbsp;DB.</span><br>
<span class="lineno"></span><span class="keyword" id="6009136">func</span>&nbsp;<span class="ident" id="6009141">Open</span><span class="op" id="6009145">(</span><span class="ident" id="6009146">driverName</span><span class="op" id="6009156">,</span>&nbsp;<span class="ident" id="6009158">dataSourceName</span>&nbsp;<span class="builtintype" id="6009173">string</span><span class="op" id="6009179">)</span>&nbsp;<span class="op" id="6009181">(</span><span class="op" id="6009182">*</span><span class="ident" id="6009183">DB</span><span class="op" id="6009185">,</span>&nbsp;<span class="builtintype" id="6009187">error</span><span class="op" id="6009192">)</span>&nbsp;<span class="op" id="6009194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6009197">driveri</span><span class="op" id="6009204">,</span>&nbsp;<span class="ident" id="6009206">ok</span>&nbsp;<span class="op" id="6009209">:=</span>&nbsp;<span class="ident" id="6009212">drivers</span><span class="op" id="6009219">[</span><span class="ident" id="6009220">driverName</span><span class="op" id="6009230">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6009233">if</span>&nbsp;<span class="op" id="6009236">!</span><span class="ident" id="6009237">ok</span>&nbsp;<span class="op" id="6009240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6009244">return</span>&nbsp;<span class="builtintype" id="6009251">nil</span><span class="op" id="6009254">,</span>&nbsp;<span class="ident" id="6009256">fmt</span><span class="op" id="6009259">.</span><span class="ident" id="6009260">Errorf</span><span class="op" id="6009266">(</span><span class="string" id="6009267">&#34;sql:&nbsp;unknown&nbsp;driver&nbsp;%q&nbsp;(forgotten&nbsp;import?)&#34;</span><span class="op" id="6009311">,</span>&nbsp;<span class="ident" id="6009313">driverName</span><span class="op" id="6009323">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6009326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6009329">db</span>&nbsp;<span class="op" id="6009332">:=</span>&nbsp;<span class="op" id="6009335">&amp;</span><span class="ident" id="6009336">DB</span><span class="op" id="6009338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6009342">driver</span><span class="op" id="6009348">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6009352">driveri</span><span class="op" id="6009359">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6009363">dsn</span><span class="op" id="6009366">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6009373">dataSourceName</span><span class="op" id="6009387">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6009391">openerCh</span><span class="op" id="6009399">:</span>&nbsp;<span class="builtinfunc" id="6009401">make</span><span class="op" id="6009405">(</span><span class="keyword" id="6009406">chan</span>&nbsp;<span class="keyword" id="6009411">struct</span><span class="op" id="6009417">{</span><span class="op" id="6009418">}</span><span class="op" id="6009419">,</span>&nbsp;<span class="ident" id="6009421">connectionRequestQueueSize</span><span class="op" id="6009447">)</span><span class="op" id="6009448">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6009452">lastPut</span><span class="op" id="6009459">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="6009462">make</span><span class="op" id="6009466">(</span><span class="keyword" id="6009467">map</span><span class="op" id="6009470">[</span><span class="op" id="6009471">*</span><span class="ident" id="6009472">driverConn</span><span class="op" id="6009482">]</span><span class="builtintype" id="6009483">string</span><span class="op" id="6009489">)</span><span class="op" id="6009490">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6009493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6009496">go</span>&nbsp;<span class="ident" id="6009499">db</span><span class="op" id="6009501">.</span><span class="ident" id="6009502">connectionOpener</span><span class="op" id="6009518">(</span><span class="op" id="6009519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6009522">return</span>&nbsp;<span class="ident" id="6009529">db</span><span class="op" id="6009531">,</span>&nbsp;<span class="builtintype" id="6009533">nil</span><br>
<span class="lineno"></span><span class="op" id="6009537">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="6009540">//&nbsp;Ping&nbsp;verifies&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;database&nbsp;is&nbsp;still&nbsp;alive,</span><br>
<span class="lineno"></span><span class="comment" id="6009602">//&nbsp;establishing&nbsp;a&nbsp;connection&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="6009645">func</span>&nbsp;<span class="op" id="6009650">(</span><span class="ident" id="6009651">db</span>&nbsp;<span class="op" id="6009654">*</span><span class="ident" id="6009655">DB</span><span class="op" id="6009657">)</span>&nbsp;<span class="ident" id="6009659">Ping</span><span class="op" id="6009663">(</span><span class="op" id="6009664">)</span>&nbsp;<span class="builtintype" id="6009666">error</span>&nbsp;<span class="op" id="6009672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6009675">//&nbsp;TODO(bradfitz):&nbsp;give&nbsp;drivers&nbsp;an&nbsp;optional&nbsp;hook&nbsp;to&nbsp;implement</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6009738">//&nbsp;this&nbsp;in&nbsp;a&nbsp;more&nbsp;efficient&nbsp;or&nbsp;more&nbsp;reliable&nbsp;way,&nbsp;if&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6009797">//&nbsp;have&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6009811">dc</span><span class="op" id="6009813">,</span>&nbsp;<span class="ident" id="6009815">err</span>&nbsp;<span class="op" id="6009819">:=</span>&nbsp;<span class="ident" id="6009822">db</span><span class="op" id="6009824">.</span><span class="ident" id="6009825">conn</span><span class="op" id="6009829">(</span><span class="op" id="6009830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6009833">if</span>&nbsp;<span class="ident" id="6009836">err</span>&nbsp;<span class="op" id="6009840">!=</span>&nbsp;<span class="builtintype" id="6009843">nil</span>&nbsp;<span class="op" id="6009847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6009851">return</span>&nbsp;<span class="ident" id="6009858">err</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6009863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6009866">db</span><span class="op" id="6009868">.</span><span class="ident" id="6009869">putConn</span><span class="op" id="6009876">(</span><span class="ident" id="6009877">dc</span><span class="op" id="6009879">,</span>&nbsp;<span class="builtintype" id="6009881">nil</span><span class="op" id="6009884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6009887">return</span>&nbsp;<span class="builtintype" id="6009894">nil</span><br>
<span class="lineno"></span><span class="op" id="6009898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="comment" id="6009901">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;database,&nbsp;releasing&nbsp;any&nbsp;open&nbsp;resources.</span><br>
<span class="lineno"></span><span class="comment" id="6009961">//</span><br>
<span class="lineno"></span><span class="comment" id="6009964">//&nbsp;It&nbsp;is&nbsp;rare&nbsp;to&nbsp;Close&nbsp;a&nbsp;DB,&nbsp;as&nbsp;the&nbsp;DB&nbsp;handle&nbsp;is&nbsp;meant&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6010025">//&nbsp;long-lived&nbsp;and&nbsp;shared&nbsp;between&nbsp;many&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="6010075">func</span>&nbsp;<span class="op" id="6010080">(</span><span class="ident" id="6010081">db</span>&nbsp;<span class="op" id="6010084">*</span><span class="ident" id="6010085">DB</span><span class="op" id="6010087">)</span>&nbsp;<span class="ident" id="6010089">Close</span><span class="op" id="6010094">(</span><span class="op" id="6010095">)</span>&nbsp;<span class="builtintype" id="6010097">error</span>&nbsp;<span class="op" id="6010103">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6010106">db</span><span class="op" id="6010108">.</span><span class="ident" id="6010109">mu</span><span class="op" id="6010111">.</span><span class="ident" id="6010112">Lock</span><span class="op" id="6010116">(</span><span class="op" id="6010117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6010120">if</span>&nbsp;<span class="ident" id="6010123">db</span><span class="op" id="6010125">.</span><span class="ident" id="6010126">closed</span>&nbsp;<span class="op" id="6010133">{</span>&nbsp;<span class="comment" id="6010135">//&nbsp;Make&nbsp;DB.Close&nbsp;idempotent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6010165">db</span><span class="op" id="6010167">.</span><span class="ident" id="6010168">mu</span><span class="op" id="6010170">.</span><span class="ident" id="6010171">Unlock</span><span class="op" id="6010177">(</span><span class="op" id="6010178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6010182">return</span>&nbsp;<span class="builtintype" id="6010189">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6010194">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6010197">close</span><span class="op" id="6010202">(</span><span class="ident" id="6010203">db</span><span class="op" id="6010205">.</span><span class="ident" id="6010206">openerCh</span><span class="op" id="6010214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6010217">var</span>&nbsp;<span class="ident" id="6010221">err</span>&nbsp;<span class="builtintype" id="6010225">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6010232">fns</span>&nbsp;<span class="op" id="6010236">:=</span>&nbsp;<span class="builtinfunc" id="6010239">make</span><span class="op" id="6010243">(</span><span class="op" id="6010244">[</span><span class="op" id="6010245">]</span><span class="keyword" id="6010246">func</span><span class="op" id="6010250">(</span><span class="op" id="6010251">)</span>&nbsp;<span class="builtintype" id="6010253">error</span><span class="op" id="6010258">,</span>&nbsp;<span class="num" id="6010260">0</span><span class="op" id="6010261">,</span>&nbsp;<span class="builtinfunc" id="6010263">len</span><span class="op" id="6010266">(</span><span class="ident" id="6010267">db</span><span class="op" id="6010269">.</span><span class="ident" id="6010270">freeConn</span><span class="op" id="6010278">)</span><span class="op" id="6010279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6010282">for</span>&nbsp;<span class="ident" id="6010286">_</span><span class="op" id="6010287">,</span>&nbsp;<span class="ident" id="6010289">dc</span>&nbsp;<span class="op" id="6010292">:=</span>&nbsp;<span class="keyword" id="6010295">range</span>&nbsp;<span class="ident" id="6010301">db</span><span class="op" id="6010303">.</span><span class="ident" id="6010304">freeConn</span>&nbsp;<span class="op" id="6010313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6010317">fns</span>&nbsp;<span class="op" id="6010321">=</span>&nbsp;<span class="builtinfunc" id="6010323">append</span><span class="op" id="6010329">(</span><span class="ident" id="6010330">fns</span><span class="op" id="6010333">,</span>&nbsp;<span class="ident" id="6010335">dc</span><span class="op" id="6010337">.</span><span class="ident" id="6010338">closeDBLocked</span><span class="op" id="6010351">(</span><span class="op" id="6010352">)</span><span class="op" id="6010353">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6010356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6010359">db</span><span class="op" id="6010361">.</span><span class="ident" id="6010362">freeConn</span>&nbsp;<span class="op" id="6010371">=</span>&nbsp;<span class="builtintype" id="6010373">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6010378">db</span><span class="op" id="6010380">.</span><span class="ident" id="6010381">closed</span>&nbsp;<span class="op" id="6010388">=</span>&nbsp;<span class="builtintype" id="6010390">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6010396">for</span>&nbsp;<span class="ident" id="6010400">_</span><span class="op" id="6010401">,</span>&nbsp;<span class="ident" id="6010403">req</span>&nbsp;<span class="op" id="6010407">:=</span>&nbsp;<span class="keyword" id="6010410">range</span>&nbsp;<span class="ident" id="6010416">db</span><span class="op" id="6010418">.</span><span class="ident" id="6010419">connRequests</span>&nbsp;<span class="op" id="6010432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6010436">close</span><span class="op" id="6010441">(</span><span class="ident" id="6010442">req</span><span class="op" id="6010445">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6010448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6010451">db</span><span class="op" id="6010453">.</span><span class="ident" id="6010454">mu</span><span class="op" id="6010456">.</span><span class="ident" id="6010457">Unlock</span><span class="op" id="6010463">(</span><span class="op" id="6010464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6010467">for</span>&nbsp;<span class="ident" id="6010471">_</span><span class="op" id="6010472">,</span>&nbsp;<span class="ident" id="6010474">fn</span>&nbsp;<span class="op" id="6010477">:=</span>&nbsp;<span class="keyword" id="6010480">range</span>&nbsp;<span class="ident" id="6010486">fns</span>&nbsp;<span class="op" id="6010490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6010494">err1</span>&nbsp;<span class="op" id="6010499">:=</span>&nbsp;<span class="ident" id="6010502">fn</span><span class="op" id="6010504">(</span><span class="op" id="6010505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6010509">if</span>&nbsp;<span class="ident" id="6010512">err1</span>&nbsp;<span class="op" id="6010517">!=</span>&nbsp;<span class="builtintype" id="6010520">nil</span>&nbsp;<span class="op" id="6010524">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6010529">err</span>&nbsp;<span class="op" id="6010533">=</span>&nbsp;<span class="ident" id="6010535">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6010542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6010545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6010548">return</span>&nbsp;<span class="ident" id="6010555">err</span><br>
<span class="lineno"></span><span class="op" id="6010559">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="6010562">const</span>&nbsp;<span class="ident" id="6010568">defaultMaxIdleConns</span>&nbsp;<span class="op" id="6010588">=</span>&nbsp;<span class="num" id="6010590">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6010593">func</span>&nbsp;<span class="op" id="6010598">(</span><span class="ident" id="6010599">db</span>&nbsp;<span class="op" id="6010602">*</span><span class="ident" id="6010603">DB</span><span class="op" id="6010605">)</span>&nbsp;<span class="ident" id="6010607">maxIdleConnsLocked</span><span class="op" id="6010625">(</span><span class="op" id="6010626">)</span>&nbsp;<span class="builtintype" id="6010628">int</span>&nbsp;<span class="op" id="6010632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6010635">n</span>&nbsp;<span class="op" id="6010637">:=</span>&nbsp;<span class="ident" id="6010640">db</span><span class="op" id="6010642">.</span><span class="ident" id="6010643">maxIdle</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6010652">switch</span>&nbsp;<span class="op" id="6010659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6010662">case</span>&nbsp;<span class="ident" id="6010667">n</span>&nbsp;<span class="op" id="6010669">==</span>&nbsp;<span class="num" id="6010672">0</span><span class="op" id="6010673">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6010677">//&nbsp;TODO(bradfitz):&nbsp;ask&nbsp;driver,&nbsp;if&nbsp;supported,&nbsp;for&nbsp;its&nbsp;default&nbsp;preference</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6010751">return</span>&nbsp;<span class="ident" id="6010758">defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6010779">case</span>&nbsp;<span class="ident" id="6010784">n</span>&nbsp;<span class="op" id="6010786">&lt;</span>&nbsp;<span class="num" id="6010788">0</span><span class="op" id="6010789">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6010793">return</span>&nbsp;<span class="num" id="6010800">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6010803">default</span><span class="op" id="6010810">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6010814">return</span>&nbsp;<span class="ident" id="6010821">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6010824">}</span><br>
<span class="lineno"></span><span class="op" id="6010826">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span><span class="comment" id="6010829">//&nbsp;SetMaxIdleConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;connections&nbsp;in&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="6010899">//&nbsp;connection&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="6010919">//</span><br>
<span class="lineno"></span><span class="comment" id="6010922">//&nbsp;If&nbsp;MaxOpenConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;but&nbsp;less&nbsp;than&nbsp;the&nbsp;new&nbsp;MaxIdleConns</span><br>
<span class="lineno">520</span><span class="comment" id="6010994">//&nbsp;then&nbsp;the&nbsp;new&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="6011071">//</span><br>
<span class="lineno"></span><span class="comment" id="6011074">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;no&nbsp;idle&nbsp;connections&nbsp;are&nbsp;retained.</span><br>
<span class="lineno"></span><span class="keyword" id="6011122">func</span>&nbsp;<span class="op" id="6011127">(</span><span class="ident" id="6011128">db</span>&nbsp;<span class="op" id="6011131">*</span><span class="ident" id="6011132">DB</span><span class="op" id="6011134">)</span>&nbsp;<span class="ident" id="6011136">SetMaxIdleConns</span><span class="op" id="6011151">(</span><span class="ident" id="6011152">n</span>&nbsp;<span class="builtintype" id="6011154">int</span><span class="op" id="6011157">)</span>&nbsp;<span class="op" id="6011159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6011162">db</span><span class="op" id="6011164">.</span><span class="ident" id="6011165">mu</span><span class="op" id="6011167">.</span><span class="ident" id="6011168">Lock</span><span class="op" id="6011172">(</span><span class="op" id="6011173">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6011176">if</span>&nbsp;<span class="ident" id="6011179">n</span>&nbsp;<span class="op" id="6011181">&gt;</span>&nbsp;<span class="num" id="6011183">0</span>&nbsp;<span class="op" id="6011185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6011189">db</span><span class="op" id="6011191">.</span><span class="ident" id="6011192">maxIdle</span>&nbsp;<span class="op" id="6011200">=</span>&nbsp;<span class="ident" id="6011202">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6011205">}</span>&nbsp;<span class="keyword" id="6011207">else</span>&nbsp;<span class="op" id="6011212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6011216">//&nbsp;No&nbsp;idle&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6011242">db</span><span class="op" id="6011244">.</span><span class="ident" id="6011245">maxIdle</span>&nbsp;<span class="op" id="6011253">=</span>&nbsp;<span class="op" id="6011255">-</span><span class="num" id="6011256">1</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6011259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6011262">//&nbsp;Make&nbsp;sure&nbsp;maxIdle&nbsp;doesn&#39;t&nbsp;exceed&nbsp;maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6011307">if</span>&nbsp;<span class="ident" id="6011310">db</span><span class="op" id="6011312">.</span><span class="ident" id="6011313">maxOpen</span>&nbsp;<span class="op" id="6011321">&gt;</span>&nbsp;<span class="num" id="6011323">0</span>&nbsp;<span class="op" id="6011325">&amp;&amp;</span>&nbsp;<span class="ident" id="6011328">db</span><span class="op" id="6011330">.</span><span class="ident" id="6011331">maxIdleConnsLocked</span><span class="op" id="6011349">(</span><span class="op" id="6011350">)</span>&nbsp;<span class="op" id="6011352">&gt;</span>&nbsp;<span class="ident" id="6011354">db</span><span class="op" id="6011356">.</span><span class="ident" id="6011357">maxOpen</span>&nbsp;<span class="op" id="6011365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6011369">db</span><span class="op" id="6011371">.</span><span class="ident" id="6011372">maxIdle</span>&nbsp;<span class="op" id="6011380">=</span>&nbsp;<span class="ident" id="6011382">db</span><span class="op" id="6011384">.</span><span class="ident" id="6011385">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6011394">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6011397">var</span>&nbsp;<span class="ident" id="6011401">closing</span>&nbsp;<span class="op" id="6011409">[</span><span class="op" id="6011410">]</span><span class="op" id="6011411">*</span><span class="ident" id="6011412">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6011424">idleCount</span>&nbsp;<span class="op" id="6011434">:=</span>&nbsp;<span class="builtinfunc" id="6011437">len</span><span class="op" id="6011440">(</span><span class="ident" id="6011441">db</span><span class="op" id="6011443">.</span><span class="ident" id="6011444">freeConn</span><span class="op" id="6011452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6011455">maxIdle</span>&nbsp;<span class="op" id="6011463">:=</span>&nbsp;<span class="ident" id="6011466">db</span><span class="op" id="6011468">.</span><span class="ident" id="6011469">maxIdleConnsLocked</span><span class="op" id="6011487">(</span><span class="op" id="6011488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6011491">if</span>&nbsp;<span class="ident" id="6011494">idleCount</span>&nbsp;<span class="op" id="6011504">&gt;</span>&nbsp;<span class="ident" id="6011506">maxIdle</span>&nbsp;<span class="op" id="6011514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6011518">closing</span>&nbsp;<span class="op" id="6011526">=</span>&nbsp;<span class="ident" id="6011528">db</span><span class="op" id="6011530">.</span><span class="ident" id="6011531">freeConn</span><span class="op" id="6011539">[</span><span class="ident" id="6011540">maxIdle</span><span class="op" id="6011547">:</span><span class="op" id="6011548">]</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6011552">db</span><span class="op" id="6011554">.</span><span class="ident" id="6011555">freeConn</span>&nbsp;<span class="op" id="6011564">=</span>&nbsp;<span class="ident" id="6011566">db</span><span class="op" id="6011568">.</span><span class="ident" id="6011569">freeConn</span><span class="op" id="6011577">[</span><span class="op" id="6011578">:</span><span class="ident" id="6011579">maxIdle</span><span class="op" id="6011586">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6011589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6011592">db</span><span class="op" id="6011594">.</span><span class="ident" id="6011595">mu</span><span class="op" id="6011597">.</span><span class="ident" id="6011598">Unlock</span><span class="op" id="6011604">(</span><span class="op" id="6011605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6011608">for</span>&nbsp;<span class="ident" id="6011612">_</span><span class="op" id="6011613">,</span>&nbsp;<span class="ident" id="6011615">c</span>&nbsp;<span class="op" id="6011617">:=</span>&nbsp;<span class="keyword" id="6011620">range</span>&nbsp;<span class="ident" id="6011626">closing</span>&nbsp;<span class="op" id="6011634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6011638">c</span><span class="op" id="6011639">.</span><span class="ident" id="6011640">Close</span><span class="op" id="6011645">(</span><span class="op" id="6011646">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6011649">}</span><br>
<span class="lineno"></span><span class="op" id="6011651">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6011654">//&nbsp;SetMaxOpenConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;the&nbsp;database.</span><br>
<span class="lineno"></span><span class="comment" id="6011734">//</span><br>
<span class="lineno">550</span><span class="comment" id="6011737">//&nbsp;If&nbsp;MaxIdleConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;and&nbsp;the&nbsp;new&nbsp;MaxOpenConns&nbsp;is&nbsp;less&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="6011812">//&nbsp;MaxIdleConns,&nbsp;then&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="6011880">//&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="6011902">//</span><br>
<span class="lineno"></span><span class="comment" id="6011905">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;then&nbsp;there&nbsp;is&nbsp;no&nbsp;limit&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections.</span><br>
<span class="lineno">555</span><span class="comment" id="6011977">//&nbsp;The&nbsp;default&nbsp;is&nbsp;0&nbsp;(unlimited).</span><br>
<span class="lineno"></span><span class="keyword" id="6012010">func</span>&nbsp;<span class="op" id="6012015">(</span><span class="ident" id="6012016">db</span>&nbsp;<span class="op" id="6012019">*</span><span class="ident" id="6012020">DB</span><span class="op" id="6012022">)</span>&nbsp;<span class="ident" id="6012024">SetMaxOpenConns</span><span class="op" id="6012039">(</span><span class="ident" id="6012040">n</span>&nbsp;<span class="builtintype" id="6012042">int</span><span class="op" id="6012045">)</span>&nbsp;<span class="op" id="6012047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6012050">db</span><span class="op" id="6012052">.</span><span class="ident" id="6012053">mu</span><span class="op" id="6012055">.</span><span class="ident" id="6012056">Lock</span><span class="op" id="6012060">(</span><span class="op" id="6012061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6012064">db</span><span class="op" id="6012066">.</span><span class="ident" id="6012067">maxOpen</span>&nbsp;<span class="op" id="6012075">=</span>&nbsp;<span class="ident" id="6012077">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6012080">if</span>&nbsp;<span class="ident" id="6012083">n</span>&nbsp;<span class="op" id="6012085">&lt;</span>&nbsp;<span class="num" id="6012087">0</span>&nbsp;<span class="op" id="6012089">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6012093">db</span><span class="op" id="6012095">.</span><span class="ident" id="6012096">maxOpen</span>&nbsp;<span class="op" id="6012104">=</span>&nbsp;<span class="num" id="6012106">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6012109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6012112">syncMaxIdle</span>&nbsp;<span class="op" id="6012124">:=</span>&nbsp;<span class="ident" id="6012127">db</span><span class="op" id="6012129">.</span><span class="ident" id="6012130">maxOpen</span>&nbsp;<span class="op" id="6012138">&gt;</span>&nbsp;<span class="num" id="6012140">0</span>&nbsp;<span class="op" id="6012142">&amp;&amp;</span>&nbsp;<span class="ident" id="6012145">db</span><span class="op" id="6012147">.</span><span class="ident" id="6012148">maxIdleConnsLocked</span><span class="op" id="6012166">(</span><span class="op" id="6012167">)</span>&nbsp;<span class="op" id="6012169">&gt;</span>&nbsp;<span class="ident" id="6012171">db</span><span class="op" id="6012173">.</span><span class="ident" id="6012174">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6012183">db</span><span class="op" id="6012185">.</span><span class="ident" id="6012186">mu</span><span class="op" id="6012188">.</span><span class="ident" id="6012189">Unlock</span><span class="op" id="6012195">(</span><span class="op" id="6012196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6012199">if</span>&nbsp;<span class="ident" id="6012202">syncMaxIdle</span>&nbsp;<span class="op" id="6012214">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6012218">db</span><span class="op" id="6012220">.</span><span class="ident" id="6012221">SetMaxIdleConns</span><span class="op" id="6012236">(</span><span class="ident" id="6012237">n</span><span class="op" id="6012238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6012241">}</span><br>
<span class="lineno"></span><span class="op" id="6012243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6012246">//&nbsp;Assumes&nbsp;db.mu&nbsp;is&nbsp;locked.</span><br>
<span class="lineno">570</span><span class="comment" id="6012274">//&nbsp;If&nbsp;there&nbsp;are&nbsp;connRequests&nbsp;and&nbsp;the&nbsp;connection&nbsp;limit&nbsp;hasn&#39;t&nbsp;been&nbsp;reached,</span><br>
<span class="lineno"></span><span class="comment" id="6012349">//&nbsp;then&nbsp;tell&nbsp;the&nbsp;connectionOpener&nbsp;to&nbsp;open&nbsp;new&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="6012408">func</span>&nbsp;<span class="op" id="6012413">(</span><span class="ident" id="6012414">db</span>&nbsp;<span class="op" id="6012417">*</span><span class="ident" id="6012418">DB</span><span class="op" id="6012420">)</span>&nbsp;<span class="ident" id="6012422">maybeOpenNewConnections</span><span class="op" id="6012445">(</span><span class="op" id="6012446">)</span>&nbsp;<span class="op" id="6012448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6012451">numRequests</span>&nbsp;<span class="op" id="6012463">:=</span>&nbsp;<span class="builtinfunc" id="6012466">len</span><span class="op" id="6012469">(</span><span class="ident" id="6012470">db</span><span class="op" id="6012472">.</span><span class="ident" id="6012473">connRequests</span><span class="op" id="6012485">)</span>&nbsp;<span class="op" id="6012487">-</span>&nbsp;<span class="ident" id="6012489">db</span><span class="op" id="6012491">.</span><span class="ident" id="6012492">pendingOpens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6012506">if</span>&nbsp;<span class="ident" id="6012509">db</span><span class="op" id="6012511">.</span><span class="ident" id="6012512">maxOpen</span>&nbsp;<span class="op" id="6012520">&gt;</span>&nbsp;<span class="num" id="6012522">0</span>&nbsp;<span class="op" id="6012524">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6012528">numCanOpen</span>&nbsp;<span class="op" id="6012539">:=</span>&nbsp;<span class="ident" id="6012542">db</span><span class="op" id="6012544">.</span><span class="ident" id="6012545">maxOpen</span>&nbsp;<span class="op" id="6012553">-</span>&nbsp;<span class="op" id="6012555">(</span><span class="ident" id="6012556">db</span><span class="op" id="6012558">.</span><span class="ident" id="6012559">numOpen</span>&nbsp;<span class="op" id="6012567">+</span>&nbsp;<span class="ident" id="6012569">db</span><span class="op" id="6012571">.</span><span class="ident" id="6012572">pendingOpens</span><span class="op" id="6012584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6012588">if</span>&nbsp;<span class="ident" id="6012591">numRequests</span>&nbsp;<span class="op" id="6012603">&gt;</span>&nbsp;<span class="ident" id="6012605">numCanOpen</span>&nbsp;<span class="op" id="6012616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6012621">numRequests</span>&nbsp;<span class="op" id="6012633">=</span>&nbsp;<span class="ident" id="6012635">numCanOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6012648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6012651">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6012654">for</span>&nbsp;<span class="ident" id="6012658">numRequests</span>&nbsp;<span class="op" id="6012670">&gt;</span>&nbsp;<span class="num" id="6012672">0</span>&nbsp;<span class="op" id="6012674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6012678">db</span><span class="op" id="6012680">.</span><span class="ident" id="6012681">pendingOpens</span><span class="op" id="6012693">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6012698">numRequests</span><span class="op" id="6012709">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6012714">db</span><span class="op" id="6012716">.</span><span class="ident" id="6012717">openerCh</span>&nbsp;<span class="op" id="6012726">&lt;-</span>&nbsp;<span class="keyword" id="6012729">struct</span><span class="op" id="6012735">{</span><span class="op" id="6012736">}</span><span class="op" id="6012737">{</span><span class="op" id="6012738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6012741">}</span><br>
<span class="lineno">585</span><span class="op" id="6012743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6012746">//&nbsp;Runs&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine,&nbsp;opens&nbsp;new&nbsp;connections&nbsp;when&nbsp;requested.</span><br>
<span class="lineno"></span><span class="keyword" id="6012817">func</span>&nbsp;<span class="op" id="6012822">(</span><span class="ident" id="6012823">db</span>&nbsp;<span class="op" id="6012826">*</span><span class="ident" id="6012827">DB</span><span class="op" id="6012829">)</span>&nbsp;<span class="ident" id="6012831">connectionOpener</span><span class="op" id="6012847">(</span><span class="op" id="6012848">)</span>&nbsp;<span class="op" id="6012850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6012853">for</span>&nbsp;<span class="keyword" id="6012857">range</span>&nbsp;<span class="ident" id="6012863">db</span><span class="op" id="6012865">.</span><span class="ident" id="6012866">openerCh</span>&nbsp;<span class="op" id="6012875">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6012879">db</span><span class="op" id="6012881">.</span><span class="ident" id="6012882">openNewConnection</span><span class="op" id="6012899">(</span><span class="op" id="6012900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6012903">}</span><br>
<span class="lineno"></span><span class="op" id="6012905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6012908">//&nbsp;Open&nbsp;one&nbsp;new&nbsp;connection</span><br>
<span class="lineno">595</span><span class="keyword" id="6012935">func</span>&nbsp;<span class="op" id="6012940">(</span><span class="ident" id="6012941">db</span>&nbsp;<span class="op" id="6012944">*</span><span class="ident" id="6012945">DB</span><span class="op" id="6012947">)</span>&nbsp;<span class="ident" id="6012949">openNewConnection</span><span class="op" id="6012966">(</span><span class="op" id="6012967">)</span>&nbsp;<span class="op" id="6012969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6012972">ci</span><span class="op" id="6012974">,</span>&nbsp;<span class="ident" id="6012976">err</span>&nbsp;<span class="op" id="6012980">:=</span>&nbsp;<span class="ident" id="6012983">db</span><span class="op" id="6012985">.</span><span class="ident" id="6012986">driver</span><span class="op" id="6012992">.</span><span class="ident" id="6012993">Open</span><span class="op" id="6012997">(</span><span class="ident" id="6012998">db</span><span class="op" id="6013000">.</span><span class="ident" id="6013001">dsn</span><span class="op" id="6013004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6013007">db</span><span class="op" id="6013009">.</span><span class="ident" id="6013010">mu</span><span class="op" id="6013012">.</span><span class="ident" id="6013013">Lock</span><span class="op" id="6013017">(</span><span class="op" id="6013018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6013021">defer</span>&nbsp;<span class="ident" id="6013027">db</span><span class="op" id="6013029">.</span><span class="ident" id="6013030">mu</span><span class="op" id="6013032">.</span><span class="ident" id="6013033">Unlock</span><span class="op" id="6013039">(</span><span class="op" id="6013040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6013043">if</span>&nbsp;<span class="ident" id="6013046">db</span><span class="op" id="6013048">.</span><span class="ident" id="6013049">closed</span>&nbsp;<span class="op" id="6013056">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6013060">if</span>&nbsp;<span class="ident" id="6013063">err</span>&nbsp;<span class="op" id="6013067">==</span>&nbsp;<span class="builtintype" id="6013070">nil</span>&nbsp;<span class="op" id="6013074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6013079">ci</span><span class="op" id="6013081">.</span><span class="ident" id="6013082">Close</span><span class="op" id="6013087">(</span><span class="op" id="6013088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6013092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6013096">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6013104">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6013107">db</span><span class="op" id="6013109">.</span><span class="ident" id="6013110">pendingOpens</span><span class="op" id="6013122">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6013126">if</span>&nbsp;<span class="ident" id="6013129">err</span>&nbsp;<span class="op" id="6013133">!=</span>&nbsp;<span class="builtintype" id="6013136">nil</span>&nbsp;<span class="op" id="6013140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6013144">db</span><span class="op" id="6013146">.</span><span class="ident" id="6013147">putConnDBLocked</span><span class="op" id="6013162">(</span><span class="builtintype" id="6013163">nil</span><span class="op" id="6013166">,</span>&nbsp;<span class="ident" id="6013168">err</span><span class="op" id="6013171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6013175">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6013183">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6013186">dc</span>&nbsp;<span class="op" id="6013189">:=</span>&nbsp;<span class="op" id="6013192">&amp;</span><span class="ident" id="6013193">driverConn</span><span class="op" id="6013203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6013207">db</span><span class="op" id="6013209">:</span>&nbsp;<span class="ident" id="6013211">db</span><span class="op" id="6013213">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6013217">ci</span><span class="op" id="6013219">:</span>&nbsp;<span class="ident" id="6013221">ci</span><span class="op" id="6013223">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6013226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6013229">if</span>&nbsp;<span class="ident" id="6013232">db</span><span class="op" id="6013234">.</span><span class="ident" id="6013235">putConnDBLocked</span><span class="op" id="6013250">(</span><span class="ident" id="6013251">dc</span><span class="op" id="6013253">,</span>&nbsp;<span class="ident" id="6013255">err</span><span class="op" id="6013258">)</span>&nbsp;<span class="op" id="6013260">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6013264">db</span><span class="op" id="6013266">.</span><span class="ident" id="6013267">addDepLocked</span><span class="op" id="6013279">(</span><span class="ident" id="6013280">dc</span><span class="op" id="6013282">,</span>&nbsp;<span class="ident" id="6013284">dc</span><span class="op" id="6013286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6013290">db</span><span class="op" id="6013292">.</span><span class="ident" id="6013293">numOpen</span><span class="op" id="6013300">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6013304">}</span>&nbsp;<span class="keyword" id="6013306">else</span>&nbsp;<span class="op" id="6013311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6013315">ci</span><span class="op" id="6013317">.</span><span class="ident" id="6013318">Close</span><span class="op" id="6013323">(</span><span class="op" id="6013324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6013327">}</span><br>
<span class="lineno">620</span><span class="op" id="6013329">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6013332">//&nbsp;connRequest&nbsp;represents&nbsp;one&nbsp;request&nbsp;for&nbsp;a&nbsp;new&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6013391">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;idle&nbsp;connections&nbsp;available,&nbsp;DB.conn&nbsp;will&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="6013460">//&nbsp;a&nbsp;new&nbsp;connRequest&nbsp;and&nbsp;put&nbsp;it&nbsp;on&nbsp;the&nbsp;db.connRequests&nbsp;list.</span><br>
<span class="lineno">625</span><span class="keyword" id="6013521">type</span>&nbsp;<span class="ident" id="6013526">connRequest</span>&nbsp;<span class="keyword" id="6013538">struct</span>&nbsp;<span class="op" id="6013545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6013548">conn</span>&nbsp;<span class="op" id="6013553">*</span><span class="ident" id="6013554">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6013566">err</span>&nbsp;&nbsp;<span class="builtintype" id="6013571">error</span><br>
<span class="lineno"></span><span class="op" id="6013577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="6013580">var</span>&nbsp;<span class="ident" id="6013584">errDBClosed</span>&nbsp;<span class="op" id="6013596">=</span>&nbsp;<span class="ident" id="6013598">errors</span><span class="op" id="6013604">.</span><span class="ident" id="6013605">New</span><span class="op" id="6013608">(</span><span class="string" id="6013609">&#34;sql:&nbsp;database&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6013634">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6013637">//&nbsp;conn&nbsp;returns&nbsp;a&nbsp;newly-opened&nbsp;or&nbsp;cached&nbsp;*driverConn</span><br>
<span class="lineno"></span><span class="keyword" id="6013690">func</span>&nbsp;<span class="op" id="6013695">(</span><span class="ident" id="6013696">db</span>&nbsp;<span class="op" id="6013699">*</span><span class="ident" id="6013700">DB</span><span class="op" id="6013702">)</span>&nbsp;<span class="ident" id="6013704">conn</span><span class="op" id="6013708">(</span><span class="op" id="6013709">)</span>&nbsp;<span class="op" id="6013711">(</span><span class="op" id="6013712">*</span><span class="ident" id="6013713">driverConn</span><span class="op" id="6013723">,</span>&nbsp;<span class="builtintype" id="6013725">error</span><span class="op" id="6013730">)</span>&nbsp;<span class="op" id="6013732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6013735">db</span><span class="op" id="6013737">.</span><span class="ident" id="6013738">mu</span><span class="op" id="6013740">.</span><span class="ident" id="6013741">Lock</span><span class="op" id="6013745">(</span><span class="op" id="6013746">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6013749">if</span>&nbsp;<span class="ident" id="6013752">db</span><span class="op" id="6013754">.</span><span class="ident" id="6013755">closed</span>&nbsp;<span class="op" id="6013762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6013766">db</span><span class="op" id="6013768">.</span><span class="ident" id="6013769">mu</span><span class="op" id="6013771">.</span><span class="ident" id="6013772">Unlock</span><span class="op" id="6013778">(</span><span class="op" id="6013779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6013783">return</span>&nbsp;<span class="builtintype" id="6013790">nil</span><span class="op" id="6013793">,</span>&nbsp;<span class="ident" id="6013795">errDBClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6013808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6013812">//&nbsp;If&nbsp;db.maxOpen&nbsp;&gt;&nbsp;0&nbsp;and&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;is&nbsp;over&nbsp;the&nbsp;limit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6013887">//&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;free&nbsp;connection,&nbsp;make&nbsp;a&nbsp;request&nbsp;and&nbsp;wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6013950">if</span>&nbsp;<span class="ident" id="6013953">db</span><span class="op" id="6013955">.</span><span class="ident" id="6013956">maxOpen</span>&nbsp;<span class="op" id="6013964">&gt;</span>&nbsp;<span class="num" id="6013966">0</span>&nbsp;<span class="op" id="6013968">&amp;&amp;</span>&nbsp;<span class="ident" id="6013971">db</span><span class="op" id="6013973">.</span><span class="ident" id="6013974">numOpen</span>&nbsp;<span class="op" id="6013982">&gt;=</span>&nbsp;<span class="ident" id="6013985">db</span><span class="op" id="6013987">.</span><span class="ident" id="6013988">maxOpen</span>&nbsp;<span class="op" id="6013996">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6013999">len</span><span class="op" id="6014002">(</span><span class="ident" id="6014003">db</span><span class="op" id="6014005">.</span><span class="ident" id="6014006">freeConn</span><span class="op" id="6014014">)</span>&nbsp;<span class="op" id="6014016">==</span>&nbsp;<span class="num" id="6014019">0</span>&nbsp;<span class="op" id="6014021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6014025">//&nbsp;Make&nbsp;the&nbsp;connRequest&nbsp;channel.&nbsp;It&#39;s&nbsp;buffered&nbsp;so&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6014086">//&nbsp;connectionOpener&nbsp;doesn&#39;t&nbsp;block&nbsp;while&nbsp;waiting&nbsp;for&nbsp;the&nbsp;req&nbsp;to&nbsp;be&nbsp;read.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014160">req</span>&nbsp;<span class="op" id="6014164">:=</span>&nbsp;<span class="builtinfunc" id="6014167">make</span><span class="op" id="6014171">(</span><span class="keyword" id="6014172">chan</span>&nbsp;<span class="ident" id="6014177">connRequest</span><span class="op" id="6014188">,</span>&nbsp;<span class="num" id="6014190">1</span><span class="op" id="6014191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014195">db</span><span class="op" id="6014197">.</span><span class="ident" id="6014198">connRequests</span>&nbsp;<span class="op" id="6014211">=</span>&nbsp;<span class="builtinfunc" id="6014213">append</span><span class="op" id="6014219">(</span><span class="ident" id="6014220">db</span><span class="op" id="6014222">.</span><span class="ident" id="6014223">connRequests</span><span class="op" id="6014235">,</span>&nbsp;<span class="ident" id="6014237">req</span><span class="op" id="6014240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014244">db</span><span class="op" id="6014246">.</span><span class="ident" id="6014247">maybeOpenNewConnections</span><span class="op" id="6014270">(</span><span class="op" id="6014271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014275">db</span><span class="op" id="6014277">.</span><span class="ident" id="6014278">mu</span><span class="op" id="6014280">.</span><span class="ident" id="6014281">Unlock</span><span class="op" id="6014287">(</span><span class="op" id="6014288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014292">ret</span>&nbsp;<span class="op" id="6014296">:=</span>&nbsp;<span class="op" id="6014299">&lt;-</span><span class="ident" id="6014301">req</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6014307">return</span>&nbsp;<span class="ident" id="6014314">ret</span><span class="op" id="6014317">.</span><span class="ident" id="6014318">conn</span><span class="op" id="6014322">,</span>&nbsp;<span class="ident" id="6014324">ret</span><span class="op" id="6014327">.</span><span class="ident" id="6014328">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6014333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6014337">if</span>&nbsp;<span class="ident" id="6014340">c</span>&nbsp;<span class="op" id="6014342">:=</span>&nbsp;<span class="builtinfunc" id="6014345">len</span><span class="op" id="6014348">(</span><span class="ident" id="6014349">db</span><span class="op" id="6014351">.</span><span class="ident" id="6014352">freeConn</span><span class="op" id="6014360">)</span><span class="op" id="6014361">;</span>&nbsp;<span class="ident" id="6014363">c</span>&nbsp;<span class="op" id="6014365">&gt;</span>&nbsp;<span class="num" id="6014367">0</span>&nbsp;<span class="op" id="6014369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014373">conn</span>&nbsp;<span class="op" id="6014378">:=</span>&nbsp;<span class="ident" id="6014381">db</span><span class="op" id="6014383">.</span><span class="ident" id="6014384">freeConn</span><span class="op" id="6014392">[</span><span class="num" id="6014393">0</span><span class="op" id="6014394">]</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6014398">copy</span><span class="op" id="6014402">(</span><span class="ident" id="6014403">db</span><span class="op" id="6014405">.</span><span class="ident" id="6014406">freeConn</span><span class="op" id="6014414">,</span>&nbsp;<span class="ident" id="6014416">db</span><span class="op" id="6014418">.</span><span class="ident" id="6014419">freeConn</span><span class="op" id="6014427">[</span><span class="num" id="6014428">1</span><span class="op" id="6014429">:</span><span class="op" id="6014430">]</span><span class="op" id="6014431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014435">db</span><span class="op" id="6014437">.</span><span class="ident" id="6014438">freeConn</span>&nbsp;<span class="op" id="6014447">=</span>&nbsp;<span class="ident" id="6014449">db</span><span class="op" id="6014451">.</span><span class="ident" id="6014452">freeConn</span><span class="op" id="6014460">[</span><span class="op" id="6014461">:</span><span class="ident" id="6014462">c</span><span class="op" id="6014463">-</span><span class="num" id="6014464">1</span><span class="op" id="6014465">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014469">conn</span><span class="op" id="6014473">.</span><span class="ident" id="6014474">inUse</span>&nbsp;<span class="op" id="6014480">=</span>&nbsp;<span class="builtintype" id="6014482">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014489">db</span><span class="op" id="6014491">.</span><span class="ident" id="6014492">mu</span><span class="op" id="6014494">.</span><span class="ident" id="6014495">Unlock</span><span class="op" id="6014501">(</span><span class="op" id="6014502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6014506">return</span>&nbsp;<span class="ident" id="6014513">conn</span><span class="op" id="6014517">,</span>&nbsp;<span class="builtintype" id="6014519">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6014524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014528">db</span><span class="op" id="6014530">.</span><span class="ident" id="6014531">numOpen</span><span class="op" id="6014538">++</span>&nbsp;<span class="comment" id="6014541">//&nbsp;optimistically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014560">db</span><span class="op" id="6014562">.</span><span class="ident" id="6014563">mu</span><span class="op" id="6014565">.</span><span class="ident" id="6014566">Unlock</span><span class="op" id="6014572">(</span><span class="op" id="6014573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014576">ci</span><span class="op" id="6014578">,</span>&nbsp;<span class="ident" id="6014580">err</span>&nbsp;<span class="op" id="6014584">:=</span>&nbsp;<span class="ident" id="6014587">db</span><span class="op" id="6014589">.</span><span class="ident" id="6014590">driver</span><span class="op" id="6014596">.</span><span class="ident" id="6014597">Open</span><span class="op" id="6014601">(</span><span class="ident" id="6014602">db</span><span class="op" id="6014604">.</span><span class="ident" id="6014605">dsn</span><span class="op" id="6014608">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6014611">if</span>&nbsp;<span class="ident" id="6014614">err</span>&nbsp;<span class="op" id="6014618">!=</span>&nbsp;<span class="builtintype" id="6014621">nil</span>&nbsp;<span class="op" id="6014625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014629">db</span><span class="op" id="6014631">.</span><span class="ident" id="6014632">mu</span><span class="op" id="6014634">.</span><span class="ident" id="6014635">Lock</span><span class="op" id="6014639">(</span><span class="op" id="6014640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014644">db</span><span class="op" id="6014646">.</span><span class="ident" id="6014647">numOpen</span><span class="op" id="6014654">--</span>&nbsp;<span class="comment" id="6014657">//&nbsp;correct&nbsp;for&nbsp;earlier&nbsp;optimism</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014691">db</span><span class="op" id="6014693">.</span><span class="ident" id="6014694">mu</span><span class="op" id="6014696">.</span><span class="ident" id="6014697">Unlock</span><span class="op" id="6014703">(</span><span class="op" id="6014704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6014708">return</span>&nbsp;<span class="builtintype" id="6014715">nil</span><span class="op" id="6014718">,</span>&nbsp;<span class="ident" id="6014720">err</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6014725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014728">db</span><span class="op" id="6014730">.</span><span class="ident" id="6014731">mu</span><span class="op" id="6014733">.</span><span class="ident" id="6014734">Lock</span><span class="op" id="6014738">(</span><span class="op" id="6014739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014742">dc</span>&nbsp;<span class="op" id="6014745">:=</span>&nbsp;<span class="op" id="6014748">&amp;</span><span class="ident" id="6014749">driverConn</span><span class="op" id="6014759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014763">db</span><span class="op" id="6014765">:</span>&nbsp;<span class="ident" id="6014767">db</span><span class="op" id="6014769">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014773">ci</span><span class="op" id="6014775">:</span>&nbsp;<span class="ident" id="6014777">ci</span><span class="op" id="6014779">,</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6014782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014785">db</span><span class="op" id="6014787">.</span><span class="ident" id="6014788">addDepLocked</span><span class="op" id="6014800">(</span><span class="ident" id="6014801">dc</span><span class="op" id="6014803">,</span>&nbsp;<span class="ident" id="6014805">dc</span><span class="op" id="6014807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014810">dc</span><span class="op" id="6014812">.</span><span class="ident" id="6014813">inUse</span>&nbsp;<span class="op" id="6014819">=</span>&nbsp;<span class="builtintype" id="6014821">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014827">db</span><span class="op" id="6014829">.</span><span class="ident" id="6014830">mu</span><span class="op" id="6014832">.</span><span class="ident" id="6014833">Unlock</span><span class="op" id="6014839">(</span><span class="op" id="6014840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6014843">return</span>&nbsp;<span class="ident" id="6014850">dc</span><span class="op" id="6014852">,</span>&nbsp;<span class="builtintype" id="6014854">nil</span><br>
<span class="lineno">680</span><span class="op" id="6014858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6014861">var</span>&nbsp;<span class="op" id="6014865">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014868">errConnClosed</span>&nbsp;<span class="op" id="6014882">=</span>&nbsp;<span class="ident" id="6014884">errors</span><span class="op" id="6014890">.</span><span class="ident" id="6014891">New</span><span class="op" id="6014894">(</span><span class="string" id="6014895">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6014950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6014953">errConnBusy</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6014967">=</span>&nbsp;<span class="ident" id="6014969">errors</span><span class="op" id="6014975">.</span><span class="ident" id="6014976">New</span><span class="op" id="6014979">(</span><span class="string" id="6014980">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;busy&#34;</span><span class="op" id="6015033">)</span><br>
<span class="lineno">685</span><span class="op" id="6015035">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6015038">//&nbsp;connIfFree&nbsp;returns&nbsp;(wanted,&nbsp;nil)&nbsp;if&nbsp;wanted&nbsp;is&nbsp;still&nbsp;a&nbsp;valid&nbsp;conn&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6015110">//&nbsp;isn&#39;t&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="comment" id="6015127">//</span><br>
<span class="lineno">690</span><span class="comment" id="6015130">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnClosed&nbsp;if&nbsp;the&nbsp;connection&nbsp;if&nbsp;the&nbsp;requested&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6015206">//&nbsp;is&nbsp;invalid&nbsp;because&nbsp;it&#39;s&nbsp;been&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="6015246">//</span><br>
<span class="lineno"></span><span class="comment" id="6015249">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnBusy&nbsp;if&nbsp;the&nbsp;connection&nbsp;is&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="6015306">func</span>&nbsp;<span class="op" id="6015311">(</span><span class="ident" id="6015312">db</span>&nbsp;<span class="op" id="6015315">*</span><span class="ident" id="6015316">DB</span><span class="op" id="6015318">)</span>&nbsp;<span class="ident" id="6015320">connIfFree</span><span class="op" id="6015330">(</span><span class="ident" id="6015331">wanted</span>&nbsp;<span class="op" id="6015338">*</span><span class="ident" id="6015339">driverConn</span><span class="op" id="6015349">)</span>&nbsp;<span class="op" id="6015351">(</span><span class="op" id="6015352">*</span><span class="ident" id="6015353">driverConn</span><span class="op" id="6015363">,</span>&nbsp;<span class="builtintype" id="6015365">error</span><span class="op" id="6015370">)</span>&nbsp;<span class="op" id="6015372">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6015375">db</span><span class="op" id="6015377">.</span><span class="ident" id="6015378">mu</span><span class="op" id="6015380">.</span><span class="ident" id="6015381">Lock</span><span class="op" id="6015385">(</span><span class="op" id="6015386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6015389">defer</span>&nbsp;<span class="ident" id="6015395">db</span><span class="op" id="6015397">.</span><span class="ident" id="6015398">mu</span><span class="op" id="6015400">.</span><span class="ident" id="6015401">Unlock</span><span class="op" id="6015407">(</span><span class="op" id="6015408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6015411">if</span>&nbsp;<span class="ident" id="6015414">wanted</span><span class="op" id="6015420">.</span><span class="ident" id="6015421">dbmuClosed</span>&nbsp;<span class="op" id="6015432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6015436">return</span>&nbsp;<span class="builtintype" id="6015443">nil</span><span class="op" id="6015446">,</span>&nbsp;<span class="ident" id="6015448">errConnClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6015463">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6015466">if</span>&nbsp;<span class="ident" id="6015469">wanted</span><span class="op" id="6015475">.</span><span class="ident" id="6015476">inUse</span>&nbsp;<span class="op" id="6015482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6015486">return</span>&nbsp;<span class="builtintype" id="6015493">nil</span><span class="op" id="6015496">,</span>&nbsp;<span class="ident" id="6015498">errConnBusy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6015511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6015514">idx</span>&nbsp;<span class="op" id="6015518">:=</span>&nbsp;<span class="op" id="6015521">-</span><span class="num" id="6015522">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6015525">for</span>&nbsp;<span class="ident" id="6015529">ii</span><span class="op" id="6015531">,</span>&nbsp;<span class="ident" id="6015533">v</span>&nbsp;<span class="op" id="6015535">:=</span>&nbsp;<span class="keyword" id="6015538">range</span>&nbsp;<span class="ident" id="6015544">db</span><span class="op" id="6015546">.</span><span class="ident" id="6015547">freeConn</span>&nbsp;<span class="op" id="6015556">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6015560">if</span>&nbsp;<span class="ident" id="6015563">v</span>&nbsp;<span class="op" id="6015565">==</span>&nbsp;<span class="ident" id="6015568">wanted</span>&nbsp;<span class="op" id="6015575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6015580">idx</span>&nbsp;<span class="op" id="6015584">=</span>&nbsp;<span class="ident" id="6015586">ii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6015592">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6015600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6015603">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6015606">if</span>&nbsp;<span class="ident" id="6015609">idx</span>&nbsp;<span class="op" id="6015613">&gt;=</span>&nbsp;<span class="num" id="6015616">0</span>&nbsp;<span class="op" id="6015618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6015622">db</span><span class="op" id="6015624">.</span><span class="ident" id="6015625">freeConn</span>&nbsp;<span class="op" id="6015634">=</span>&nbsp;<span class="builtinfunc" id="6015636">append</span><span class="op" id="6015642">(</span><span class="ident" id="6015643">db</span><span class="op" id="6015645">.</span><span class="ident" id="6015646">freeConn</span><span class="op" id="6015654">[</span><span class="op" id="6015655">:</span><span class="ident" id="6015656">idx</span><span class="op" id="6015659">]</span><span class="op" id="6015660">,</span>&nbsp;<span class="ident" id="6015662">db</span><span class="op" id="6015664">.</span><span class="ident" id="6015665">freeConn</span><span class="op" id="6015673">[</span><span class="ident" id="6015674">idx</span><span class="op" id="6015677">+</span><span class="num" id="6015678">1</span><span class="op" id="6015679">:</span><span class="op" id="6015680">]</span><span class="op" id="6015681">...</span><span class="op" id="6015684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6015688">wanted</span><span class="op" id="6015694">.</span><span class="ident" id="6015695">inUse</span>&nbsp;<span class="op" id="6015701">=</span>&nbsp;<span class="builtintype" id="6015703">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6015710">return</span>&nbsp;<span class="ident" id="6015717">wanted</span><span class="op" id="6015723">,</span>&nbsp;<span class="builtintype" id="6015725">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6015730">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6015733">//&nbsp;TODO(bradfitz):&nbsp;shouldn&#39;t&nbsp;get&nbsp;here.&nbsp;After&nbsp;Go&nbsp;1.1,&nbsp;change&nbsp;this&nbsp;to:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6015803">//&nbsp;panic(&#34;connIfFree&nbsp;call&nbsp;requested&nbsp;a&nbsp;non-closed,&nbsp;non-busy,&nbsp;non-free&nbsp;conn&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6015880">//&nbsp;Which&nbsp;passes&nbsp;all&nbsp;the&nbsp;tests,&nbsp;but&nbsp;I&#39;m&nbsp;too&nbsp;paranoid&nbsp;to&nbsp;include&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6015949">//&nbsp;late&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6015969">//&nbsp;Instead,&nbsp;treat&nbsp;it&nbsp;like&nbsp;a&nbsp;busy&nbsp;connection:</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6016015">return</span>&nbsp;<span class="builtintype" id="6016022">nil</span><span class="op" id="6016025">,</span>&nbsp;<span class="ident" id="6016027">errConnBusy</span><br>
<span class="lineno"></span><span class="op" id="6016039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6016042">//&nbsp;putConnHook&nbsp;is&nbsp;a&nbsp;hook&nbsp;for&nbsp;testing.</span><br>
<span class="lineno"></span><span class="keyword" id="6016080">var</span>&nbsp;<span class="ident" id="6016084">putConnHook</span>&nbsp;<span class="keyword" id="6016096">func</span><span class="op" id="6016100">(</span><span class="op" id="6016101">*</span><span class="ident" id="6016102">DB</span><span class="op" id="6016104">,</span>&nbsp;<span class="op" id="6016106">*</span><span class="ident" id="6016107">driverConn</span><span class="op" id="6016117">)</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="6016120">//&nbsp;noteUnusedDriverStatement&nbsp;notes&nbsp;that&nbsp;si&nbsp;is&nbsp;no&nbsp;longer&nbsp;used&nbsp;and&nbsp;should</span><br>
<span class="lineno"></span><span class="comment" id="6016192">//&nbsp;be&nbsp;closed&nbsp;whenever&nbsp;possible&nbsp;(when&nbsp;c&nbsp;is&nbsp;next&nbsp;not&nbsp;in&nbsp;use),&nbsp;unless&nbsp;c&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="6016264">//&nbsp;already&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="6016283">func</span>&nbsp;<span class="op" id="6016288">(</span><span class="ident" id="6016289">db</span>&nbsp;<span class="op" id="6016292">*</span><span class="ident" id="6016293">DB</span><span class="op" id="6016295">)</span>&nbsp;<span class="ident" id="6016297">noteUnusedDriverStatement</span><span class="op" id="6016322">(</span><span class="ident" id="6016323">c</span>&nbsp;<span class="op" id="6016325">*</span><span class="ident" id="6016326">driverConn</span><span class="op" id="6016336">,</span>&nbsp;<span class="ident" id="6016338">si</span>&nbsp;<span class="ident" id="6016341">driver</span><span class="op" id="6016347">.</span><span class="ident" id="6016348">Stmt</span><span class="op" id="6016352">)</span>&nbsp;<span class="op" id="6016354">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6016357">db</span><span class="op" id="6016359">.</span><span class="ident" id="6016360">mu</span><span class="op" id="6016362">.</span><span class="ident" id="6016363">Lock</span><span class="op" id="6016367">(</span><span class="op" id="6016368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6016371">defer</span>&nbsp;<span class="ident" id="6016377">db</span><span class="op" id="6016379">.</span><span class="ident" id="6016380">mu</span><span class="op" id="6016382">.</span><span class="ident" id="6016383">Unlock</span><span class="op" id="6016389">(</span><span class="op" id="6016390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6016393">if</span>&nbsp;<span class="ident" id="6016396">c</span><span class="op" id="6016397">.</span><span class="ident" id="6016398">inUse</span>&nbsp;<span class="op" id="6016404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6016408">c</span><span class="op" id="6016409">.</span><span class="ident" id="6016410">onPut</span>&nbsp;<span class="op" id="6016416">=</span>&nbsp;<span class="builtinfunc" id="6016418">append</span><span class="op" id="6016424">(</span><span class="ident" id="6016425">c</span><span class="op" id="6016426">.</span><span class="ident" id="6016427">onPut</span><span class="op" id="6016432">,</span>&nbsp;<span class="keyword" id="6016434">func</span><span class="op" id="6016438">(</span><span class="op" id="6016439">)</span>&nbsp;<span class="op" id="6016441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6016446">si</span><span class="op" id="6016448">.</span><span class="ident" id="6016449">Close</span><span class="op" id="6016454">(</span><span class="op" id="6016455">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6016459">}</span><span class="op" id="6016460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6016463">}</span>&nbsp;<span class="keyword" id="6016465">else</span>&nbsp;<span class="op" id="6016470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6016474">c</span><span class="op" id="6016475">.</span><span class="ident" id="6016476">Lock</span><span class="op" id="6016480">(</span><span class="op" id="6016481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6016485">defer</span>&nbsp;<span class="ident" id="6016491">c</span><span class="op" id="6016492">.</span><span class="ident" id="6016493">Unlock</span><span class="op" id="6016499">(</span><span class="op" id="6016500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6016504">if</span>&nbsp;<span class="op" id="6016507">!</span><span class="ident" id="6016508">c</span><span class="op" id="6016509">.</span><span class="ident" id="6016510">finalClosed</span>&nbsp;<span class="op" id="6016522">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6016527">si</span><span class="op" id="6016529">.</span><span class="ident" id="6016530">Close</span><span class="op" id="6016535">(</span><span class="op" id="6016536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6016540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6016543">}</span><br>
<span class="lineno"></span><span class="op" id="6016545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">745</span><span class="comment" id="6016548">//&nbsp;debugGetPut&nbsp;determines&nbsp;whether&nbsp;getConn&nbsp;&amp;&nbsp;putConn&nbsp;calls&#39;&nbsp;stack&nbsp;traces</span><br>
<span class="lineno"></span><span class="comment" id="6016620">//&nbsp;are&nbsp;returned&nbsp;for&nbsp;more&nbsp;verbose&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="6016662">const</span>&nbsp;<span class="ident" id="6016668">debugGetPut</span>&nbsp;<span class="op" id="6016680">=</span>&nbsp;<span class="builtintype" id="6016682">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6016689">//&nbsp;putConn&nbsp;adds&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;db&#39;s&nbsp;free&nbsp;pool.</span><br>
<span class="lineno">750</span><span class="comment" id="6016741">//&nbsp;err&nbsp;is&nbsp;optionally&nbsp;the&nbsp;last&nbsp;error&nbsp;that&nbsp;occurred&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6016811">func</span>&nbsp;<span class="op" id="6016816">(</span><span class="ident" id="6016817">db</span>&nbsp;<span class="op" id="6016820">*</span><span class="ident" id="6016821">DB</span><span class="op" id="6016823">)</span>&nbsp;<span class="ident" id="6016825">putConn</span><span class="op" id="6016832">(</span><span class="ident" id="6016833">dc</span>&nbsp;<span class="op" id="6016836">*</span><span class="ident" id="6016837">driverConn</span><span class="op" id="6016847">,</span>&nbsp;<span class="ident" id="6016849">err</span>&nbsp;<span class="builtintype" id="6016853">error</span><span class="op" id="6016858">)</span>&nbsp;<span class="op" id="6016860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6016863">db</span><span class="op" id="6016865">.</span><span class="ident" id="6016866">mu</span><span class="op" id="6016868">.</span><span class="ident" id="6016869">Lock</span><span class="op" id="6016873">(</span><span class="op" id="6016874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6016877">if</span>&nbsp;<span class="op" id="6016880">!</span><span class="ident" id="6016881">dc</span><span class="op" id="6016883">.</span><span class="ident" id="6016884">inUse</span>&nbsp;<span class="op" id="6016890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6016894">if</span>&nbsp;<span class="ident" id="6016897">debugGetPut</span>&nbsp;<span class="op" id="6016909">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6016914">fmt</span><span class="op" id="6016917">.</span><span class="ident" id="6016918">Printf</span><span class="op" id="6016924">(</span><span class="string" id="6016925">&#34;putConn(%v)&nbsp;DUPLICATE&nbsp;was:&nbsp;%s\n\nPREVIOUS&nbsp;was:&nbsp;%s&#34;</span><span class="op" id="6016976">,</span>&nbsp;<span class="ident" id="6016978">dc</span><span class="op" id="6016980">,</span>&nbsp;<span class="ident" id="6016982">stack</span><span class="op" id="6016987">(</span><span class="op" id="6016988">)</span><span class="op" id="6016989">,</span>&nbsp;<span class="ident" id="6016991">db</span><span class="op" id="6016993">.</span><span class="ident" id="6016994">lastPut</span><span class="op" id="6017001">[</span><span class="ident" id="6017002">dc</span><span class="op" id="6017004">]</span><span class="op" id="6017005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6017009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6017013">panic</span><span class="op" id="6017018">(</span><span class="string" id="6017019">&#34;sql:&nbsp;connection&nbsp;returned&nbsp;that&nbsp;was&nbsp;never&nbsp;out&#34;</span><span class="op" id="6017064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6017067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6017070">if</span>&nbsp;<span class="ident" id="6017073">debugGetPut</span>&nbsp;<span class="op" id="6017085">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6017089">db</span><span class="op" id="6017091">.</span><span class="ident" id="6017092">lastPut</span><span class="op" id="6017099">[</span><span class="ident" id="6017100">dc</span><span class="op" id="6017102">]</span>&nbsp;<span class="op" id="6017104">=</span>&nbsp;<span class="ident" id="6017106">stack</span><span class="op" id="6017111">(</span><span class="op" id="6017112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6017115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6017118">dc</span><span class="op" id="6017120">.</span><span class="ident" id="6017121">inUse</span>&nbsp;<span class="op" id="6017127">=</span>&nbsp;<span class="builtintype" id="6017129">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6017137">for</span>&nbsp;<span class="ident" id="6017141">_</span><span class="op" id="6017142">,</span>&nbsp;<span class="ident" id="6017144">fn</span>&nbsp;<span class="op" id="6017147">:=</span>&nbsp;<span class="keyword" id="6017150">range</span>&nbsp;<span class="ident" id="6017156">dc</span><span class="op" id="6017158">.</span><span class="ident" id="6017159">onPut</span>&nbsp;<span class="op" id="6017165">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6017169">fn</span><span class="op" id="6017171">(</span><span class="op" id="6017172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6017175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6017178">dc</span><span class="op" id="6017180">.</span><span class="ident" id="6017181">onPut</span>&nbsp;<span class="op" id="6017187">=</span>&nbsp;<span class="builtintype" id="6017189">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6017195">if</span>&nbsp;<span class="ident" id="6017198">err</span>&nbsp;<span class="op" id="6017202">==</span>&nbsp;<span class="ident" id="6017205">driver</span><span class="op" id="6017211">.</span><span class="ident" id="6017212">ErrBadConn</span>&nbsp;<span class="op" id="6017223">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6017227">//&nbsp;Don&#39;t&nbsp;reuse&nbsp;bad&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6017261">//&nbsp;Since&nbsp;the&nbsp;conn&nbsp;is&nbsp;considered&nbsp;bad&nbsp;and&nbsp;is&nbsp;being&nbsp;discarded,&nbsp;treat&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6017332">//&nbsp;as&nbsp;closed.&nbsp;Don&#39;t&nbsp;decrement&nbsp;the&nbsp;open&nbsp;count&nbsp;here,&nbsp;finalClose&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6017401">//&nbsp;take&nbsp;care&nbsp;of&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6017425">db</span><span class="op" id="6017427">.</span><span class="ident" id="6017428">maybeOpenNewConnections</span><span class="op" id="6017451">(</span><span class="op" id="6017452">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6017456">db</span><span class="op" id="6017458">.</span><span class="ident" id="6017459">mu</span><span class="op" id="6017461">.</span><span class="ident" id="6017462">Unlock</span><span class="op" id="6017468">(</span><span class="op" id="6017469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6017473">dc</span><span class="op" id="6017475">.</span><span class="ident" id="6017476">Close</span><span class="op" id="6017481">(</span><span class="op" id="6017482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6017486">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6017494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6017497">if</span>&nbsp;<span class="ident" id="6017500">putConnHook</span>&nbsp;<span class="op" id="6017512">!=</span>&nbsp;<span class="builtintype" id="6017515">nil</span>&nbsp;<span class="op" id="6017519">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6017523">putConnHook</span><span class="op" id="6017534">(</span><span class="ident" id="6017535">db</span><span class="op" id="6017537">,</span>&nbsp;<span class="ident" id="6017539">dc</span><span class="op" id="6017541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6017544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6017547">added</span>&nbsp;<span class="op" id="6017553">:=</span>&nbsp;<span class="ident" id="6017556">db</span><span class="op" id="6017558">.</span><span class="ident" id="6017559">putConnDBLocked</span><span class="op" id="6017574">(</span><span class="ident" id="6017575">dc</span><span class="op" id="6017577">,</span>&nbsp;<span class="builtintype" id="6017579">nil</span><span class="op" id="6017582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6017585">db</span><span class="op" id="6017587">.</span><span class="ident" id="6017588">mu</span><span class="op" id="6017590">.</span><span class="ident" id="6017591">Unlock</span><span class="op" id="6017597">(</span><span class="op" id="6017598">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6017602">if</span>&nbsp;<span class="op" id="6017605">!</span><span class="ident" id="6017606">added</span>&nbsp;<span class="op" id="6017612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6017616">dc</span><span class="op" id="6017618">.</span><span class="ident" id="6017619">Close</span><span class="op" id="6017624">(</span><span class="op" id="6017625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6017628">}</span><br>
<span class="lineno"></span><span class="op" id="6017630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">790</span><span class="comment" id="6017633">//&nbsp;Satisfy&nbsp;a&nbsp;connRequest&nbsp;or&nbsp;put&nbsp;the&nbsp;driverConn&nbsp;in&nbsp;the&nbsp;idle&nbsp;pool&nbsp;and&nbsp;return&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="6017713">//&nbsp;or&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="6017733">//&nbsp;putConnDBLocked&nbsp;will&nbsp;satisfy&nbsp;a&nbsp;connRequest&nbsp;if&nbsp;there&nbsp;is&nbsp;one,&nbsp;or&nbsp;it&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="6017807">//&nbsp;return&nbsp;the&nbsp;*driverConn&nbsp;to&nbsp;the&nbsp;freeConn&nbsp;list&nbsp;if&nbsp;err&nbsp;==&nbsp;nil&nbsp;and&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="6017881">//&nbsp;connection&nbsp;limit&nbsp;will&nbsp;not&nbsp;be&nbsp;exceeded.</span><br>
<span class="lineno">795</span><span class="comment" id="6017923">//&nbsp;If&nbsp;err&nbsp;!=&nbsp;nil,&nbsp;the&nbsp;value&nbsp;of&nbsp;dc&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="6017969">//&nbsp;If&nbsp;err&nbsp;==&nbsp;nil,&nbsp;then&nbsp;dc&nbsp;must&nbsp;not&nbsp;equal&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="6018015">//&nbsp;If&nbsp;a&nbsp;connRequest&nbsp;was&nbsp;fulfilled&nbsp;or&nbsp;the&nbsp;*driverConn&nbsp;was&nbsp;placed&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6018086">//&nbsp;freeConn&nbsp;list,&nbsp;then&nbsp;true&nbsp;is&nbsp;returned,&nbsp;otherwise&nbsp;false&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="6018156">func</span>&nbsp;<span class="op" id="6018161">(</span><span class="ident" id="6018162">db</span>&nbsp;<span class="op" id="6018165">*</span><span class="ident" id="6018166">DB</span><span class="op" id="6018168">)</span>&nbsp;<span class="ident" id="6018170">putConnDBLocked</span><span class="op" id="6018185">(</span><span class="ident" id="6018186">dc</span>&nbsp;<span class="op" id="6018189">*</span><span class="ident" id="6018190">driverConn</span><span class="op" id="6018200">,</span>&nbsp;<span class="ident" id="6018202">err</span>&nbsp;<span class="builtintype" id="6018206">error</span><span class="op" id="6018211">)</span>&nbsp;<span class="builtintype" id="6018213">bool</span>&nbsp;<span class="op" id="6018218">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6018221">if</span>&nbsp;<span class="ident" id="6018224">c</span>&nbsp;<span class="op" id="6018226">:=</span>&nbsp;<span class="builtinfunc" id="6018229">len</span><span class="op" id="6018232">(</span><span class="ident" id="6018233">db</span><span class="op" id="6018235">.</span><span class="ident" id="6018236">connRequests</span><span class="op" id="6018248">)</span><span class="op" id="6018249">;</span>&nbsp;<span class="ident" id="6018251">c</span>&nbsp;<span class="op" id="6018253">&gt;</span>&nbsp;<span class="num" id="6018255">0</span>&nbsp;<span class="op" id="6018257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6018261">req</span>&nbsp;<span class="op" id="6018265">:=</span>&nbsp;<span class="ident" id="6018268">db</span><span class="op" id="6018270">.</span><span class="ident" id="6018271">connRequests</span><span class="op" id="6018283">[</span><span class="num" id="6018284">0</span><span class="op" id="6018285">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6018289">//&nbsp;This&nbsp;copy&nbsp;is&nbsp;O(n)&nbsp;but&nbsp;in&nbsp;practice&nbsp;faster&nbsp;than&nbsp;a&nbsp;linked&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6018355">//&nbsp;TODO:&nbsp;consider&nbsp;compacting&nbsp;it&nbsp;down&nbsp;less&nbsp;often&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6018409">//&nbsp;moving&nbsp;the&nbsp;base&nbsp;instead?</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6018439">copy</span><span class="op" id="6018443">(</span><span class="ident" id="6018444">db</span><span class="op" id="6018446">.</span><span class="ident" id="6018447">connRequests</span><span class="op" id="6018459">,</span>&nbsp;<span class="ident" id="6018461">db</span><span class="op" id="6018463">.</span><span class="ident" id="6018464">connRequests</span><span class="op" id="6018476">[</span><span class="num" id="6018477">1</span><span class="op" id="6018478">:</span><span class="op" id="6018479">]</span><span class="op" id="6018480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6018484">db</span><span class="op" id="6018486">.</span><span class="ident" id="6018487">connRequests</span>&nbsp;<span class="op" id="6018500">=</span>&nbsp;<span class="ident" id="6018502">db</span><span class="op" id="6018504">.</span><span class="ident" id="6018505">connRequests</span><span class="op" id="6018517">[</span><span class="op" id="6018518">:</span><span class="ident" id="6018519">c</span><span class="op" id="6018520">-</span><span class="num" id="6018521">1</span><span class="op" id="6018522">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6018526">if</span>&nbsp;<span class="ident" id="6018529">err</span>&nbsp;<span class="op" id="6018533">==</span>&nbsp;<span class="builtintype" id="6018536">nil</span>&nbsp;<span class="op" id="6018540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6018545">dc</span><span class="op" id="6018547">.</span><span class="ident" id="6018548">inUse</span>&nbsp;<span class="op" id="6018554">=</span>&nbsp;<span class="builtintype" id="6018556">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6018563">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6018567">req</span>&nbsp;<span class="op" id="6018571">&lt;-</span>&nbsp;<span class="ident" id="6018574">connRequest</span><span class="op" id="6018585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6018590">conn</span><span class="op" id="6018594">:</span>&nbsp;<span class="ident" id="6018596">dc</span><span class="op" id="6018598">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6018603">err</span><span class="op" id="6018606">:</span>&nbsp;&nbsp;<span class="ident" id="6018609">err</span><span class="op" id="6018612">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6018616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6018620">return</span>&nbsp;<span class="builtintype" id="6018627">true</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6018633">}</span>&nbsp;<span class="keyword" id="6018635">else</span>&nbsp;<span class="keyword" id="6018640">if</span>&nbsp;<span class="ident" id="6018643">err</span>&nbsp;<span class="op" id="6018647">==</span>&nbsp;<span class="builtintype" id="6018650">nil</span>&nbsp;<span class="op" id="6018654">&amp;&amp;</span>&nbsp;<span class="op" id="6018657">!</span><span class="ident" id="6018658">db</span><span class="op" id="6018660">.</span><span class="ident" id="6018661">closed</span>&nbsp;<span class="op" id="6018668">&amp;&amp;</span>&nbsp;<span class="ident" id="6018671">db</span><span class="op" id="6018673">.</span><span class="ident" id="6018674">maxIdleConnsLocked</span><span class="op" id="6018692">(</span><span class="op" id="6018693">)</span>&nbsp;<span class="op" id="6018695">&gt;</span>&nbsp;<span class="builtinfunc" id="6018697">len</span><span class="op" id="6018700">(</span><span class="ident" id="6018701">db</span><span class="op" id="6018703">.</span><span class="ident" id="6018704">freeConn</span><span class="op" id="6018712">)</span>&nbsp;<span class="op" id="6018714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6018718">db</span><span class="op" id="6018720">.</span><span class="ident" id="6018721">freeConn</span>&nbsp;<span class="op" id="6018730">=</span>&nbsp;<span class="builtinfunc" id="6018732">append</span><span class="op" id="6018738">(</span><span class="ident" id="6018739">db</span><span class="op" id="6018741">.</span><span class="ident" id="6018742">freeConn</span><span class="op" id="6018750">,</span>&nbsp;<span class="ident" id="6018752">dc</span><span class="op" id="6018754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6018758">return</span>&nbsp;<span class="builtintype" id="6018765">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6018771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6018774">return</span>&nbsp;<span class="builtintype" id="6018781">false</span><br>
<span class="lineno">820</span><span class="op" id="6018787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6018790">//&nbsp;maxBadConnRetries&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;maximum&nbsp;retries&nbsp;if&nbsp;the&nbsp;driver&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="6018866">//&nbsp;driver.ErrBadConn&nbsp;to&nbsp;signal&nbsp;a&nbsp;broken&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6018918">const</span>&nbsp;<span class="ident" id="6018924">maxBadConnRetries</span>&nbsp;<span class="op" id="6018942">=</span>&nbsp;<span class="num" id="6018944">10</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="comment" id="6018948">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;later&nbsp;queries&nbsp;or&nbsp;executions.</span><br>
<span class="lineno"></span><span class="comment" id="6019021">//&nbsp;Multiple&nbsp;queries&nbsp;or&nbsp;executions&nbsp;may&nbsp;be&nbsp;run&nbsp;concurrently&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6019088">//&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6019111">func</span>&nbsp;<span class="op" id="6019116">(</span><span class="ident" id="6019117">db</span>&nbsp;<span class="op" id="6019120">*</span><span class="ident" id="6019121">DB</span><span class="op" id="6019123">)</span>&nbsp;<span class="ident" id="6019125">Prepare</span><span class="op" id="6019132">(</span><span class="ident" id="6019133">query</span>&nbsp;<span class="builtintype" id="6019139">string</span><span class="op" id="6019145">)</span>&nbsp;<span class="op" id="6019147">(</span><span class="op" id="6019148">*</span><span class="ident" id="6019149">Stmt</span><span class="op" id="6019153">,</span>&nbsp;<span class="builtintype" id="6019155">error</span><span class="op" id="6019160">)</span>&nbsp;<span class="op" id="6019162">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6019165">var</span>&nbsp;<span class="ident" id="6019169">stmt</span>&nbsp;<span class="op" id="6019174">*</span><span class="ident" id="6019175">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6019181">var</span>&nbsp;<span class="ident" id="6019185">err</span>&nbsp;<span class="builtintype" id="6019189">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6019196">for</span>&nbsp;<span class="ident" id="6019200">i</span>&nbsp;<span class="op" id="6019202">:=</span>&nbsp;<span class="num" id="6019205">0</span><span class="op" id="6019206">;</span>&nbsp;<span class="ident" id="6019208">i</span>&nbsp;<span class="op" id="6019210">&lt;</span>&nbsp;<span class="ident" id="6019212">maxBadConnRetries</span><span class="op" id="6019229">;</span>&nbsp;<span class="ident" id="6019231">i</span><span class="op" id="6019232">++</span>&nbsp;<span class="op" id="6019235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6019239">stmt</span><span class="op" id="6019243">,</span>&nbsp;<span class="ident" id="6019245">err</span>&nbsp;<span class="op" id="6019249">=</span>&nbsp;<span class="ident" id="6019251">db</span><span class="op" id="6019253">.</span><span class="ident" id="6019254">prepare</span><span class="op" id="6019261">(</span><span class="ident" id="6019262">query</span><span class="op" id="6019267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6019271">if</span>&nbsp;<span class="ident" id="6019274">err</span>&nbsp;<span class="op" id="6019278">!=</span>&nbsp;<span class="ident" id="6019281">driver</span><span class="op" id="6019287">.</span><span class="ident" id="6019288">ErrBadConn</span>&nbsp;<span class="op" id="6019299">{</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6019304">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6019312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6019315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6019318">return</span>&nbsp;<span class="ident" id="6019325">stmt</span><span class="op" id="6019329">,</span>&nbsp;<span class="ident" id="6019331">err</span><br>
<span class="lineno"></span><span class="op" id="6019335">}</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span><span class="keyword" id="6019338">func</span>&nbsp;<span class="op" id="6019343">(</span><span class="ident" id="6019344">db</span>&nbsp;<span class="op" id="6019347">*</span><span class="ident" id="6019348">DB</span><span class="op" id="6019350">)</span>&nbsp;<span class="ident" id="6019352">prepare</span><span class="op" id="6019359">(</span><span class="ident" id="6019360">query</span>&nbsp;<span class="builtintype" id="6019366">string</span><span class="op" id="6019372">)</span>&nbsp;<span class="op" id="6019374">(</span><span class="op" id="6019375">*</span><span class="ident" id="6019376">Stmt</span><span class="op" id="6019380">,</span>&nbsp;<span class="builtintype" id="6019382">error</span><span class="op" id="6019387">)</span>&nbsp;<span class="op" id="6019389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6019392">//&nbsp;TODO:&nbsp;check&nbsp;if&nbsp;db.driver&nbsp;supports&nbsp;an&nbsp;optional</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6019442">//&nbsp;driver.Preparer&nbsp;interface&nbsp;and&nbsp;call&nbsp;that&nbsp;instead,&nbsp;if&nbsp;so,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6019502">//&nbsp;otherwise&nbsp;we&nbsp;make&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;that&#39;s&nbsp;bound</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6019558">//&nbsp;to&nbsp;a&nbsp;connection,&nbsp;and&nbsp;to&nbsp;execute&nbsp;this&nbsp;prepared&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6019618">//&nbsp;we&nbsp;either&nbsp;need&nbsp;to&nbsp;use&nbsp;this&nbsp;connection&nbsp;(if&nbsp;it&#39;s&nbsp;free),&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6019681">//&nbsp;get&nbsp;a&nbsp;new&nbsp;connection&nbsp;+&nbsp;re-prepare&nbsp;+&nbsp;execute&nbsp;on&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6019742">dc</span><span class="op" id="6019744">,</span>&nbsp;<span class="ident" id="6019746">err</span>&nbsp;<span class="op" id="6019750">:=</span>&nbsp;<span class="ident" id="6019753">db</span><span class="op" id="6019755">.</span><span class="ident" id="6019756">conn</span><span class="op" id="6019760">(</span><span class="op" id="6019761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6019764">if</span>&nbsp;<span class="ident" id="6019767">err</span>&nbsp;<span class="op" id="6019771">!=</span>&nbsp;<span class="builtintype" id="6019774">nil</span>&nbsp;<span class="op" id="6019778">{</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6019782">return</span>&nbsp;<span class="builtintype" id="6019789">nil</span><span class="op" id="6019792">,</span>&nbsp;<span class="ident" id="6019794">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6019799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6019802">dc</span><span class="op" id="6019804">.</span><span class="ident" id="6019805">Lock</span><span class="op" id="6019809">(</span><span class="op" id="6019810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6019813">si</span><span class="op" id="6019815">,</span>&nbsp;<span class="ident" id="6019817">err</span>&nbsp;<span class="op" id="6019821">:=</span>&nbsp;<span class="ident" id="6019824">dc</span><span class="op" id="6019826">.</span><span class="ident" id="6019827">prepareLocked</span><span class="op" id="6019840">(</span><span class="ident" id="6019841">query</span><span class="op" id="6019846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6019849">dc</span><span class="op" id="6019851">.</span><span class="ident" id="6019852">Unlock</span><span class="op" id="6019858">(</span><span class="op" id="6019859">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6019862">if</span>&nbsp;<span class="ident" id="6019865">err</span>&nbsp;<span class="op" id="6019869">!=</span>&nbsp;<span class="builtintype" id="6019872">nil</span>&nbsp;<span class="op" id="6019876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6019880">db</span><span class="op" id="6019882">.</span><span class="ident" id="6019883">putConn</span><span class="op" id="6019890">(</span><span class="ident" id="6019891">dc</span><span class="op" id="6019893">,</span>&nbsp;<span class="ident" id="6019895">err</span><span class="op" id="6019898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6019902">return</span>&nbsp;<span class="builtintype" id="6019909">nil</span><span class="op" id="6019912">,</span>&nbsp;<span class="ident" id="6019914">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6019919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6019922">stmt</span>&nbsp;<span class="op" id="6019927">:=</span>&nbsp;<span class="op" id="6019930">&amp;</span><span class="ident" id="6019931">Stmt</span><span class="op" id="6019935">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6019939">db</span><span class="op" id="6019941">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6019946">db</span><span class="op" id="6019948">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6019952">query</span><span class="op" id="6019957">:</span>&nbsp;<span class="ident" id="6019959">query</span><span class="op" id="6019964">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6019968">css</span><span class="op" id="6019971">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6019975">[</span><span class="op" id="6019976">]</span><span class="ident" id="6019977">connStmt</span><span class="op" id="6019985">{</span><span class="op" id="6019986">{</span><span class="ident" id="6019987">dc</span><span class="op" id="6019989">,</span>&nbsp;<span class="ident" id="6019991">si</span><span class="op" id="6019993">}</span><span class="op" id="6019994">}</span><span class="op" id="6019995">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6019998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6020001">db</span><span class="op" id="6020003">.</span><span class="ident" id="6020004">addDep</span><span class="op" id="6020010">(</span><span class="ident" id="6020011">stmt</span><span class="op" id="6020015">,</span>&nbsp;<span class="ident" id="6020017">stmt</span><span class="op" id="6020021">)</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6020024">db</span><span class="op" id="6020026">.</span><span class="ident" id="6020027">putConn</span><span class="op" id="6020034">(</span><span class="ident" id="6020035">dc</span><span class="op" id="6020037">,</span>&nbsp;<span class="builtintype" id="6020039">nil</span><span class="op" id="6020042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020045">return</span>&nbsp;<span class="ident" id="6020052">stmt</span><span class="op" id="6020056">,</span>&nbsp;<span class="builtintype" id="6020058">nil</span><br>
<span class="lineno"></span><span class="op" id="6020062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6020065">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;without&nbsp;returning&nbsp;any&nbsp;rows.</span><br>
<span class="lineno">870</span><span class="comment" id="6020118">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno"></span><span class="keyword" id="6020179">func</span>&nbsp;<span class="op" id="6020184">(</span><span class="ident" id="6020185">db</span>&nbsp;<span class="op" id="6020188">*</span><span class="ident" id="6020189">DB</span><span class="op" id="6020191">)</span>&nbsp;<span class="ident" id="6020193">Exec</span><span class="op" id="6020197">(</span><span class="ident" id="6020198">query</span>&nbsp;<span class="builtintype" id="6020204">string</span><span class="op" id="6020210">,</span>&nbsp;<span class="ident" id="6020212">args</span>&nbsp;<span class="op" id="6020217">...</span><span class="keyword" id="6020220">interface</span><span class="op" id="6020229">{</span><span class="op" id="6020230">}</span><span class="op" id="6020231">)</span>&nbsp;<span class="op" id="6020233">(</span><span class="ident" id="6020234">Result</span><span class="op" id="6020240">,</span>&nbsp;<span class="builtintype" id="6020242">error</span><span class="op" id="6020247">)</span>&nbsp;<span class="op" id="6020249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020252">var</span>&nbsp;<span class="ident" id="6020256">res</span>&nbsp;<span class="ident" id="6020260">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020268">var</span>&nbsp;<span class="ident" id="6020272">err</span>&nbsp;<span class="builtintype" id="6020276">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020283">for</span>&nbsp;<span class="ident" id="6020287">i</span>&nbsp;<span class="op" id="6020289">:=</span>&nbsp;<span class="num" id="6020292">0</span><span class="op" id="6020293">;</span>&nbsp;<span class="ident" id="6020295">i</span>&nbsp;<span class="op" id="6020297">&lt;</span>&nbsp;<span class="ident" id="6020299">maxBadConnRetries</span><span class="op" id="6020316">;</span>&nbsp;<span class="ident" id="6020318">i</span><span class="op" id="6020319">++</span>&nbsp;<span class="op" id="6020322">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6020326">res</span><span class="op" id="6020329">,</span>&nbsp;<span class="ident" id="6020331">err</span>&nbsp;<span class="op" id="6020335">=</span>&nbsp;<span class="ident" id="6020337">db</span><span class="op" id="6020339">.</span><span class="ident" id="6020340">exec</span><span class="op" id="6020344">(</span><span class="ident" id="6020345">query</span><span class="op" id="6020350">,</span>&nbsp;<span class="ident" id="6020352">args</span><span class="op" id="6020356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020360">if</span>&nbsp;<span class="ident" id="6020363">err</span>&nbsp;<span class="op" id="6020367">!=</span>&nbsp;<span class="ident" id="6020370">driver</span><span class="op" id="6020376">.</span><span class="ident" id="6020377">ErrBadConn</span>&nbsp;<span class="op" id="6020388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020393">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6020401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6020404">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020407">return</span>&nbsp;<span class="ident" id="6020414">res</span><span class="op" id="6020417">,</span>&nbsp;<span class="ident" id="6020419">err</span><br>
<span class="lineno"></span><span class="op" id="6020423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6020426">func</span>&nbsp;<span class="op" id="6020431">(</span><span class="ident" id="6020432">db</span>&nbsp;<span class="op" id="6020435">*</span><span class="ident" id="6020436">DB</span><span class="op" id="6020438">)</span>&nbsp;<span class="ident" id="6020440">exec</span><span class="op" id="6020444">(</span><span class="ident" id="6020445">query</span>&nbsp;<span class="builtintype" id="6020451">string</span><span class="op" id="6020457">,</span>&nbsp;<span class="ident" id="6020459">args</span>&nbsp;<span class="op" id="6020464">[</span><span class="op" id="6020465">]</span><span class="keyword" id="6020466">interface</span><span class="op" id="6020475">{</span><span class="op" id="6020476">}</span><span class="op" id="6020477">)</span>&nbsp;<span class="op" id="6020479">(</span><span class="ident" id="6020480">res</span>&nbsp;<span class="ident" id="6020484">Result</span><span class="op" id="6020490">,</span>&nbsp;<span class="ident" id="6020492">err</span>&nbsp;<span class="builtintype" id="6020496">error</span><span class="op" id="6020501">)</span>&nbsp;<span class="op" id="6020503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6020506">dc</span><span class="op" id="6020508">,</span>&nbsp;<span class="ident" id="6020510">err</span>&nbsp;<span class="op" id="6020514">:=</span>&nbsp;<span class="ident" id="6020517">db</span><span class="op" id="6020519">.</span><span class="ident" id="6020520">conn</span><span class="op" id="6020524">(</span><span class="op" id="6020525">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020528">if</span>&nbsp;<span class="ident" id="6020531">err</span>&nbsp;<span class="op" id="6020535">!=</span>&nbsp;<span class="builtintype" id="6020538">nil</span>&nbsp;<span class="op" id="6020542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020546">return</span>&nbsp;<span class="builtintype" id="6020553">nil</span><span class="op" id="6020556">,</span>&nbsp;<span class="ident" id="6020558">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6020563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020566">defer</span>&nbsp;<span class="keyword" id="6020572">func</span><span class="op" id="6020576">(</span><span class="op" id="6020577">)</span>&nbsp;<span class="op" id="6020579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6020583">db</span><span class="op" id="6020585">.</span><span class="ident" id="6020586">putConn</span><span class="op" id="6020593">(</span><span class="ident" id="6020594">dc</span><span class="op" id="6020596">,</span>&nbsp;<span class="ident" id="6020598">err</span><span class="op" id="6020601">)</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6020604">}</span><span class="op" id="6020605">(</span><span class="op" id="6020606">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020610">if</span>&nbsp;<span class="ident" id="6020613">execer</span><span class="op" id="6020619">,</span>&nbsp;<span class="ident" id="6020621">ok</span>&nbsp;<span class="op" id="6020624">:=</span>&nbsp;<span class="ident" id="6020627">dc</span><span class="op" id="6020629">.</span><span class="ident" id="6020630">ci</span><span class="op" id="6020632">.</span><span class="op" id="6020633">(</span><span class="ident" id="6020634">driver</span><span class="op" id="6020640">.</span><span class="ident" id="6020641">Execer</span><span class="op" id="6020647">)</span><span class="op" id="6020648">;</span>&nbsp;<span class="ident" id="6020650">ok</span>&nbsp;<span class="op" id="6020653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6020657">dargs</span><span class="op" id="6020662">,</span>&nbsp;<span class="ident" id="6020664">err</span>&nbsp;<span class="op" id="6020668">:=</span>&nbsp;<span class="ident" id="6020671">driverArgs</span><span class="op" id="6020681">(</span><span class="builtintype" id="6020682">nil</span><span class="op" id="6020685">,</span>&nbsp;<span class="ident" id="6020687">args</span><span class="op" id="6020691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020695">if</span>&nbsp;<span class="ident" id="6020698">err</span>&nbsp;<span class="op" id="6020702">!=</span>&nbsp;<span class="builtintype" id="6020705">nil</span>&nbsp;<span class="op" id="6020709">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020714">return</span>&nbsp;<span class="builtintype" id="6020721">nil</span><span class="op" id="6020724">,</span>&nbsp;<span class="ident" id="6020726">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6020732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6020736">dc</span><span class="op" id="6020738">.</span><span class="ident" id="6020739">Lock</span><span class="op" id="6020743">(</span><span class="op" id="6020744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6020748">resi</span><span class="op" id="6020752">,</span>&nbsp;<span class="ident" id="6020754">err</span>&nbsp;<span class="op" id="6020758">:=</span>&nbsp;<span class="ident" id="6020761">execer</span><span class="op" id="6020767">.</span><span class="ident" id="6020768">Exec</span><span class="op" id="6020772">(</span><span class="ident" id="6020773">query</span><span class="op" id="6020778">,</span>&nbsp;<span class="ident" id="6020780">dargs</span><span class="op" id="6020785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6020789">dc</span><span class="op" id="6020791">.</span><span class="ident" id="6020792">Unlock</span><span class="op" id="6020798">(</span><span class="op" id="6020799">)</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020803">if</span>&nbsp;<span class="ident" id="6020806">err</span>&nbsp;<span class="op" id="6020810">!=</span>&nbsp;<span class="ident" id="6020813">driver</span><span class="op" id="6020819">.</span><span class="ident" id="6020820">ErrSkip</span>&nbsp;<span class="op" id="6020828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020833">if</span>&nbsp;<span class="ident" id="6020836">err</span>&nbsp;<span class="op" id="6020840">!=</span>&nbsp;<span class="builtintype" id="6020843">nil</span>&nbsp;<span class="op" id="6020847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020853">return</span>&nbsp;<span class="builtintype" id="6020860">nil</span><span class="op" id="6020863">,</span>&nbsp;<span class="ident" id="6020865">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6020872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020877">return</span>&nbsp;<span class="ident" id="6020884">driverResult</span><span class="op" id="6020896">{</span><span class="ident" id="6020897">dc</span><span class="op" id="6020899">,</span>&nbsp;<span class="ident" id="6020901">resi</span><span class="op" id="6020905">}</span><span class="op" id="6020906">,</span>&nbsp;<span class="builtintype" id="6020908">nil</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6020914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6020917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6020921">dc</span><span class="op" id="6020923">.</span><span class="ident" id="6020924">Lock</span><span class="op" id="6020928">(</span><span class="op" id="6020929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6020932">si</span><span class="op" id="6020934">,</span>&nbsp;<span class="ident" id="6020936">err</span>&nbsp;<span class="op" id="6020940">:=</span>&nbsp;<span class="ident" id="6020943">dc</span><span class="op" id="6020945">.</span><span class="ident" id="6020946">ci</span><span class="op" id="6020948">.</span><span class="ident" id="6020949">Prepare</span><span class="op" id="6020956">(</span><span class="ident" id="6020957">query</span><span class="op" id="6020962">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6020965">dc</span><span class="op" id="6020967">.</span><span class="ident" id="6020968">Unlock</span><span class="op" id="6020974">(</span><span class="op" id="6020975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020978">if</span>&nbsp;<span class="ident" id="6020981">err</span>&nbsp;<span class="op" id="6020985">!=</span>&nbsp;<span class="builtintype" id="6020988">nil</span>&nbsp;<span class="op" id="6020992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6020996">return</span>&nbsp;<span class="builtintype" id="6021003">nil</span><span class="op" id="6021006">,</span>&nbsp;<span class="ident" id="6021008">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6021013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6021016">defer</span>&nbsp;<span class="ident" id="6021022">withLock</span><span class="op" id="6021030">(</span><span class="ident" id="6021031">dc</span><span class="op" id="6021033">,</span>&nbsp;<span class="keyword" id="6021035">func</span><span class="op" id="6021039">(</span><span class="op" id="6021040">)</span>&nbsp;<span class="op" id="6021042">{</span>&nbsp;<span class="ident" id="6021044">si</span><span class="op" id="6021046">.</span><span class="ident" id="6021047">Close</span><span class="op" id="6021052">(</span><span class="op" id="6021053">)</span>&nbsp;<span class="op" id="6021055">}</span><span class="op" id="6021056">)</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6021059">return</span>&nbsp;<span class="ident" id="6021066">resultFromStatement</span><span class="op" id="6021085">(</span><span class="ident" id="6021086">driverStmt</span><span class="op" id="6021096">{</span><span class="ident" id="6021097">dc</span><span class="op" id="6021099">,</span>&nbsp;<span class="ident" id="6021101">si</span><span class="op" id="6021103">}</span><span class="op" id="6021104">,</span>&nbsp;<span class="ident" id="6021106">args</span><span class="op" id="6021110">...</span><span class="op" id="6021113">)</span><br>
<span class="lineno"></span><span class="op" id="6021115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6021118">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="comment" id="6021183">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno">920</span><span class="keyword" id="6021244">func</span>&nbsp;<span class="op" id="6021249">(</span><span class="ident" id="6021250">db</span>&nbsp;<span class="op" id="6021253">*</span><span class="ident" id="6021254">DB</span><span class="op" id="6021256">)</span>&nbsp;<span class="ident" id="6021258">Query</span><span class="op" id="6021263">(</span><span class="ident" id="6021264">query</span>&nbsp;<span class="builtintype" id="6021270">string</span><span class="op" id="6021276">,</span>&nbsp;<span class="ident" id="6021278">args</span>&nbsp;<span class="op" id="6021283">...</span><span class="keyword" id="6021286">interface</span><span class="op" id="6021295">{</span><span class="op" id="6021296">}</span><span class="op" id="6021297">)</span>&nbsp;<span class="op" id="6021299">(</span><span class="op" id="6021300">*</span><span class="ident" id="6021301">Rows</span><span class="op" id="6021305">,</span>&nbsp;<span class="builtintype" id="6021307">error</span><span class="op" id="6021312">)</span>&nbsp;<span class="op" id="6021314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6021317">var</span>&nbsp;<span class="ident" id="6021321">rows</span>&nbsp;<span class="op" id="6021326">*</span><span class="ident" id="6021327">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6021333">var</span>&nbsp;<span class="ident" id="6021337">err</span>&nbsp;<span class="builtintype" id="6021341">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6021348">for</span>&nbsp;<span class="ident" id="6021352">i</span>&nbsp;<span class="op" id="6021354">:=</span>&nbsp;<span class="num" id="6021357">0</span><span class="op" id="6021358">;</span>&nbsp;<span class="ident" id="6021360">i</span>&nbsp;<span class="op" id="6021362">&lt;</span>&nbsp;<span class="ident" id="6021364">maxBadConnRetries</span><span class="op" id="6021381">;</span>&nbsp;<span class="ident" id="6021383">i</span><span class="op" id="6021384">++</span>&nbsp;<span class="op" id="6021387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6021391">rows</span><span class="op" id="6021395">,</span>&nbsp;<span class="ident" id="6021397">err</span>&nbsp;<span class="op" id="6021401">=</span>&nbsp;<span class="ident" id="6021403">db</span><span class="op" id="6021405">.</span><span class="ident" id="6021406">query</span><span class="op" id="6021411">(</span><span class="ident" id="6021412">query</span><span class="op" id="6021417">,</span>&nbsp;<span class="ident" id="6021419">args</span><span class="op" id="6021423">)</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6021427">if</span>&nbsp;<span class="ident" id="6021430">err</span>&nbsp;<span class="op" id="6021434">!=</span>&nbsp;<span class="ident" id="6021437">driver</span><span class="op" id="6021443">.</span><span class="ident" id="6021444">ErrBadConn</span>&nbsp;<span class="op" id="6021455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6021460">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6021468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6021471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6021474">return</span>&nbsp;<span class="ident" id="6021481">rows</span><span class="op" id="6021485">,</span>&nbsp;<span class="ident" id="6021487">err</span><br>
<span class="lineno">930</span><span class="op" id="6021491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6021494">func</span>&nbsp;<span class="op" id="6021499">(</span><span class="ident" id="6021500">db</span>&nbsp;<span class="op" id="6021503">*</span><span class="ident" id="6021504">DB</span><span class="op" id="6021506">)</span>&nbsp;<span class="ident" id="6021508">query</span><span class="op" id="6021513">(</span><span class="ident" id="6021514">query</span>&nbsp;<span class="builtintype" id="6021520">string</span><span class="op" id="6021526">,</span>&nbsp;<span class="ident" id="6021528">args</span>&nbsp;<span class="op" id="6021533">[</span><span class="op" id="6021534">]</span><span class="keyword" id="6021535">interface</span><span class="op" id="6021544">{</span><span class="op" id="6021545">}</span><span class="op" id="6021546">)</span>&nbsp;<span class="op" id="6021548">(</span><span class="op" id="6021549">*</span><span class="ident" id="6021550">Rows</span><span class="op" id="6021554">,</span>&nbsp;<span class="builtintype" id="6021556">error</span><span class="op" id="6021561">)</span>&nbsp;<span class="op" id="6021563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6021566">ci</span><span class="op" id="6021568">,</span>&nbsp;<span class="ident" id="6021570">err</span>&nbsp;<span class="op" id="6021574">:=</span>&nbsp;<span class="ident" id="6021577">db</span><span class="op" id="6021579">.</span><span class="ident" id="6021580">conn</span><span class="op" id="6021584">(</span><span class="op" id="6021585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6021588">if</span>&nbsp;<span class="ident" id="6021591">err</span>&nbsp;<span class="op" id="6021595">!=</span>&nbsp;<span class="builtintype" id="6021598">nil</span>&nbsp;<span class="op" id="6021602">{</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6021606">return</span>&nbsp;<span class="builtintype" id="6021613">nil</span><span class="op" id="6021616">,</span>&nbsp;<span class="ident" id="6021618">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6021623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6021627">return</span>&nbsp;<span class="ident" id="6021634">db</span><span class="op" id="6021636">.</span><span class="ident" id="6021637">queryConn</span><span class="op" id="6021646">(</span><span class="ident" id="6021647">ci</span><span class="op" id="6021649">,</span>&nbsp;<span class="ident" id="6021651">ci</span><span class="op" id="6021653">.</span><span class="ident" id="6021654">releaseConn</span><span class="op" id="6021665">,</span>&nbsp;<span class="ident" id="6021667">query</span><span class="op" id="6021672">,</span>&nbsp;<span class="ident" id="6021674">args</span><span class="op" id="6021678">)</span><br>
<span class="lineno"></span><span class="op" id="6021680">}</span><br>
<span class="lineno">940</span><br>
<span class="lineno"></span><span class="comment" id="6021683">//&nbsp;queryConn&nbsp;executes&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;given&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="6021738">//&nbsp;The&nbsp;connection&nbsp;gets&nbsp;released&nbsp;by&nbsp;the&nbsp;releaseConn&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="6021799">func</span>&nbsp;<span class="op" id="6021804">(</span><span class="ident" id="6021805">db</span>&nbsp;<span class="op" id="6021808">*</span><span class="ident" id="6021809">DB</span><span class="op" id="6021811">)</span>&nbsp;<span class="ident" id="6021813">queryConn</span><span class="op" id="6021822">(</span><span class="ident" id="6021823">dc</span>&nbsp;<span class="op" id="6021826">*</span><span class="ident" id="6021827">driverConn</span><span class="op" id="6021837">,</span>&nbsp;<span class="ident" id="6021839">releaseConn</span>&nbsp;<span class="keyword" id="6021851">func</span><span class="op" id="6021855">(</span><span class="builtintype" id="6021856">error</span><span class="op" id="6021861">)</span><span class="op" id="6021862">,</span>&nbsp;<span class="ident" id="6021864">query</span>&nbsp;<span class="builtintype" id="6021870">string</span><span class="op" id="6021876">,</span>&nbsp;<span class="ident" id="6021878">args</span>&nbsp;<span class="op" id="6021883">[</span><span class="op" id="6021884">]</span><span class="keyword" id="6021885">interface</span><span class="op" id="6021894">{</span><span class="op" id="6021895">}</span><span class="op" id="6021896">)</span>&nbsp;<span class="op" id="6021898">(</span><span class="op" id="6021899">*</span><span class="ident" id="6021900">Rows</span><span class="op" id="6021904">,</span>&nbsp;<span class="builtintype" id="6021906">error</span><span class="op" id="6021911">)</span>&nbsp;<span class="op" id="6021913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6021916">if</span>&nbsp;<span class="ident" id="6021919">queryer</span><span class="op" id="6021926">,</span>&nbsp;<span class="ident" id="6021928">ok</span>&nbsp;<span class="op" id="6021931">:=</span>&nbsp;<span class="ident" id="6021934">dc</span><span class="op" id="6021936">.</span><span class="ident" id="6021937">ci</span><span class="op" id="6021939">.</span><span class="op" id="6021940">(</span><span class="ident" id="6021941">driver</span><span class="op" id="6021947">.</span><span class="ident" id="6021948">Queryer</span><span class="op" id="6021955">)</span><span class="op" id="6021956">;</span>&nbsp;<span class="ident" id="6021958">ok</span>&nbsp;<span class="op" id="6021961">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6021965">dargs</span><span class="op" id="6021970">,</span>&nbsp;<span class="ident" id="6021972">err</span>&nbsp;<span class="op" id="6021976">:=</span>&nbsp;<span class="ident" id="6021979">driverArgs</span><span class="op" id="6021989">(</span><span class="builtintype" id="6021990">nil</span><span class="op" id="6021993">,</span>&nbsp;<span class="ident" id="6021995">args</span><span class="op" id="6021999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6022003">if</span>&nbsp;<span class="ident" id="6022006">err</span>&nbsp;<span class="op" id="6022010">!=</span>&nbsp;<span class="builtintype" id="6022013">nil</span>&nbsp;<span class="op" id="6022017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022022">releaseConn</span><span class="op" id="6022033">(</span><span class="ident" id="6022034">err</span><span class="op" id="6022037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6022042">return</span>&nbsp;<span class="builtintype" id="6022049">nil</span><span class="op" id="6022052">,</span>&nbsp;<span class="ident" id="6022054">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6022060">}</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022064">dc</span><span class="op" id="6022066">.</span><span class="ident" id="6022067">Lock</span><span class="op" id="6022071">(</span><span class="op" id="6022072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022076">rowsi</span><span class="op" id="6022081">,</span>&nbsp;<span class="ident" id="6022083">err</span>&nbsp;<span class="op" id="6022087">:=</span>&nbsp;<span class="ident" id="6022090">queryer</span><span class="op" id="6022097">.</span><span class="ident" id="6022098">Query</span><span class="op" id="6022103">(</span><span class="ident" id="6022104">query</span><span class="op" id="6022109">,</span>&nbsp;<span class="ident" id="6022111">dargs</span><span class="op" id="6022116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022120">dc</span><span class="op" id="6022122">.</span><span class="ident" id="6022123">Unlock</span><span class="op" id="6022129">(</span><span class="op" id="6022130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6022134">if</span>&nbsp;<span class="ident" id="6022137">err</span>&nbsp;<span class="op" id="6022141">!=</span>&nbsp;<span class="ident" id="6022144">driver</span><span class="op" id="6022150">.</span><span class="ident" id="6022151">ErrSkip</span>&nbsp;<span class="op" id="6022159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6022164">if</span>&nbsp;<span class="ident" id="6022167">err</span>&nbsp;<span class="op" id="6022171">!=</span>&nbsp;<span class="builtintype" id="6022174">nil</span>&nbsp;<span class="op" id="6022178">{</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022184">releaseConn</span><span class="op" id="6022195">(</span><span class="ident" id="6022196">err</span><span class="op" id="6022199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6022205">return</span>&nbsp;<span class="builtintype" id="6022212">nil</span><span class="op" id="6022215">,</span>&nbsp;<span class="ident" id="6022217">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6022224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6022229">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;dc&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6022290">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022314">rows</span>&nbsp;<span class="op" id="6022319">:=</span>&nbsp;<span class="op" id="6022322">&amp;</span><span class="ident" id="6022323">Rows</span><span class="op" id="6022327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022333">dc</span><span class="op" id="6022335">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022346">dc</span><span class="op" id="6022348">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022354">releaseConn</span><span class="op" id="6022365">:</span>&nbsp;<span class="ident" id="6022367">releaseConn</span><span class="op" id="6022378">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022384">rowsi</span><span class="op" id="6022389">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022397">rowsi</span><span class="op" id="6022402">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6022407">}</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6022412">return</span>&nbsp;<span class="ident" id="6022419">rows</span><span class="op" id="6022423">,</span>&nbsp;<span class="builtintype" id="6022425">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6022431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6022434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022438">dc</span><span class="op" id="6022440">.</span><span class="ident" id="6022441">Lock</span><span class="op" id="6022445">(</span><span class="op" id="6022446">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022449">si</span><span class="op" id="6022451">,</span>&nbsp;<span class="ident" id="6022453">err</span>&nbsp;<span class="op" id="6022457">:=</span>&nbsp;<span class="ident" id="6022460">dc</span><span class="op" id="6022462">.</span><span class="ident" id="6022463">ci</span><span class="op" id="6022465">.</span><span class="ident" id="6022466">Prepare</span><span class="op" id="6022473">(</span><span class="ident" id="6022474">query</span><span class="op" id="6022479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022482">dc</span><span class="op" id="6022484">.</span><span class="ident" id="6022485">Unlock</span><span class="op" id="6022491">(</span><span class="op" id="6022492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6022495">if</span>&nbsp;<span class="ident" id="6022498">err</span>&nbsp;<span class="op" id="6022502">!=</span>&nbsp;<span class="builtintype" id="6022505">nil</span>&nbsp;<span class="op" id="6022509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022513">releaseConn</span><span class="op" id="6022524">(</span><span class="ident" id="6022525">err</span><span class="op" id="6022528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6022532">return</span>&nbsp;<span class="builtintype" id="6022539">nil</span><span class="op" id="6022542">,</span>&nbsp;<span class="ident" id="6022544">err</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6022549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022553">ds</span>&nbsp;<span class="op" id="6022556">:=</span>&nbsp;<span class="ident" id="6022559">driverStmt</span><span class="op" id="6022569">{</span><span class="ident" id="6022570">dc</span><span class="op" id="6022572">,</span>&nbsp;<span class="ident" id="6022574">si</span><span class="op" id="6022576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022579">rowsi</span><span class="op" id="6022584">,</span>&nbsp;<span class="ident" id="6022586">err</span>&nbsp;<span class="op" id="6022590">:=</span>&nbsp;<span class="ident" id="6022593">rowsiFromStatement</span><span class="op" id="6022611">(</span><span class="ident" id="6022612">ds</span><span class="op" id="6022614">,</span>&nbsp;<span class="ident" id="6022616">args</span><span class="op" id="6022620">...</span><span class="op" id="6022623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6022626">if</span>&nbsp;<span class="ident" id="6022629">err</span>&nbsp;<span class="op" id="6022633">!=</span>&nbsp;<span class="builtintype" id="6022636">nil</span>&nbsp;<span class="op" id="6022640">{</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022644">dc</span><span class="op" id="6022646">.</span><span class="ident" id="6022647">Lock</span><span class="op" id="6022651">(</span><span class="op" id="6022652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022656">si</span><span class="op" id="6022658">.</span><span class="ident" id="6022659">Close</span><span class="op" id="6022664">(</span><span class="op" id="6022665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022669">dc</span><span class="op" id="6022671">.</span><span class="ident" id="6022672">Unlock</span><span class="op" id="6022678">(</span><span class="op" id="6022679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022683">releaseConn</span><span class="op" id="6022694">(</span><span class="ident" id="6022695">err</span><span class="op" id="6022698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6022702">return</span>&nbsp;<span class="builtintype" id="6022709">nil</span><span class="op" id="6022712">,</span>&nbsp;<span class="ident" id="6022714">err</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6022719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6022723">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6022782">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022804">rows</span>&nbsp;<span class="op" id="6022809">:=</span>&nbsp;<span class="op" id="6022812">&amp;</span><span class="ident" id="6022813">Rows</span><span class="op" id="6022817">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022821">dc</span><span class="op" id="6022823">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022834">dc</span><span class="op" id="6022836">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022840">releaseConn</span><span class="op" id="6022851">:</span>&nbsp;<span class="ident" id="6022853">releaseConn</span><span class="op" id="6022864">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022868">rowsi</span><span class="op" id="6022873">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022881">rowsi</span><span class="op" id="6022886">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6022890">closeStmt</span><span class="op" id="6022899">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6022903">si</span><span class="op" id="6022905">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6022908">}</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6022911">return</span>&nbsp;<span class="ident" id="6022918">rows</span><span class="op" id="6022922">,</span>&nbsp;<span class="builtintype" id="6022924">nil</span><br>
<span class="lineno"></span><span class="op" id="6022928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6022931">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="6023004">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno">1000</span><span class="comment" id="6023073">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="6023105">func</span>&nbsp;<span class="op" id="6023110">(</span><span class="ident" id="6023111">db</span>&nbsp;<span class="op" id="6023114">*</span><span class="ident" id="6023115">DB</span><span class="op" id="6023117">)</span>&nbsp;<span class="ident" id="6023119">QueryRow</span><span class="op" id="6023127">(</span><span class="ident" id="6023128">query</span>&nbsp;<span class="builtintype" id="6023134">string</span><span class="op" id="6023140">,</span>&nbsp;<span class="ident" id="6023142">args</span>&nbsp;<span class="op" id="6023147">...</span><span class="keyword" id="6023150">interface</span><span class="op" id="6023159">{</span><span class="op" id="6023160">}</span><span class="op" id="6023161">)</span>&nbsp;<span class="op" id="6023163">*</span><span class="ident" id="6023164">Row</span>&nbsp;<span class="op" id="6023168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6023171">rows</span><span class="op" id="6023175">,</span>&nbsp;<span class="ident" id="6023177">err</span>&nbsp;<span class="op" id="6023181">:=</span>&nbsp;<span class="ident" id="6023184">db</span><span class="op" id="6023186">.</span><span class="ident" id="6023187">Query</span><span class="op" id="6023192">(</span><span class="ident" id="6023193">query</span><span class="op" id="6023198">,</span>&nbsp;<span class="ident" id="6023200">args</span><span class="op" id="6023204">...</span><span class="op" id="6023207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6023210">return</span>&nbsp;<span class="op" id="6023217">&amp;</span><span class="ident" id="6023218">Row</span><span class="op" id="6023221">{</span><span class="ident" id="6023222">rows</span><span class="op" id="6023226">:</span>&nbsp;<span class="ident" id="6023228">rows</span><span class="op" id="6023232">,</span>&nbsp;<span class="ident" id="6023234">err</span><span class="op" id="6023237">:</span>&nbsp;<span class="ident" id="6023239">err</span><span class="op" id="6023242">}</span><br>
<span class="lineno"></span><span class="op" id="6023244">}</span><br>
<span class="lineno">1005</span><br>
<span class="lineno"></span><span class="comment" id="6023247">//&nbsp;Begin&nbsp;starts&nbsp;a&nbsp;transaction.&nbsp;The&nbsp;isolation&nbsp;level&nbsp;is&nbsp;dependent&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="6023314">//&nbsp;the&nbsp;driver.</span><br>
<span class="lineno"></span><span class="keyword" id="6023329">func</span>&nbsp;<span class="op" id="6023334">(</span><span class="ident" id="6023335">db</span>&nbsp;<span class="op" id="6023338">*</span><span class="ident" id="6023339">DB</span><span class="op" id="6023341">)</span>&nbsp;<span class="ident" id="6023343">Begin</span><span class="op" id="6023348">(</span><span class="op" id="6023349">)</span>&nbsp;<span class="op" id="6023351">(</span><span class="op" id="6023352">*</span><span class="ident" id="6023353">Tx</span><span class="op" id="6023355">,</span>&nbsp;<span class="builtintype" id="6023357">error</span><span class="op" id="6023362">)</span>&nbsp;<span class="op" id="6023364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6023367">var</span>&nbsp;<span class="ident" id="6023371">tx</span>&nbsp;<span class="op" id="6023374">*</span><span class="ident" id="6023375">Tx</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6023379">var</span>&nbsp;<span class="ident" id="6023383">err</span>&nbsp;<span class="builtintype" id="6023387">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6023394">for</span>&nbsp;<span class="ident" id="6023398">i</span>&nbsp;<span class="op" id="6023400">:=</span>&nbsp;<span class="num" id="6023403">0</span><span class="op" id="6023404">;</span>&nbsp;<span class="ident" id="6023406">i</span>&nbsp;<span class="op" id="6023408">&lt;</span>&nbsp;<span class="ident" id="6023410">maxBadConnRetries</span><span class="op" id="6023427">;</span>&nbsp;<span class="ident" id="6023429">i</span><span class="op" id="6023430">++</span>&nbsp;<span class="op" id="6023433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6023437">tx</span><span class="op" id="6023439">,</span>&nbsp;<span class="ident" id="6023441">err</span>&nbsp;<span class="op" id="6023445">=</span>&nbsp;<span class="ident" id="6023447">db</span><span class="op" id="6023449">.</span><span class="ident" id="6023450">begin</span><span class="op" id="6023455">(</span><span class="op" id="6023456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6023460">if</span>&nbsp;<span class="ident" id="6023463">err</span>&nbsp;<span class="op" id="6023467">!=</span>&nbsp;<span class="ident" id="6023470">driver</span><span class="op" id="6023476">.</span><span class="ident" id="6023477">ErrBadConn</span>&nbsp;<span class="op" id="6023488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6023493">break</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6023501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6023504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6023507">return</span>&nbsp;<span class="ident" id="6023514">tx</span><span class="op" id="6023516">,</span>&nbsp;<span class="ident" id="6023518">err</span><br>
<span class="lineno"></span><span class="op" id="6023522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1020</span><span class="keyword" id="6023525">func</span>&nbsp;<span class="op" id="6023530">(</span><span class="ident" id="6023531">db</span>&nbsp;<span class="op" id="6023534">*</span><span class="ident" id="6023535">DB</span><span class="op" id="6023537">)</span>&nbsp;<span class="ident" id="6023539">begin</span><span class="op" id="6023544">(</span><span class="op" id="6023545">)</span>&nbsp;<span class="op" id="6023547">(</span><span class="ident" id="6023548">tx</span>&nbsp;<span class="op" id="6023551">*</span><span class="ident" id="6023552">Tx</span><span class="op" id="6023554">,</span>&nbsp;<span class="ident" id="6023556">err</span>&nbsp;<span class="builtintype" id="6023560">error</span><span class="op" id="6023565">)</span>&nbsp;<span class="op" id="6023567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6023570">dc</span><span class="op" id="6023572">,</span>&nbsp;<span class="ident" id="6023574">err</span>&nbsp;<span class="op" id="6023578">:=</span>&nbsp;<span class="ident" id="6023581">db</span><span class="op" id="6023583">.</span><span class="ident" id="6023584">conn</span><span class="op" id="6023588">(</span><span class="op" id="6023589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6023592">if</span>&nbsp;<span class="ident" id="6023595">err</span>&nbsp;<span class="op" id="6023599">!=</span>&nbsp;<span class="builtintype" id="6023602">nil</span>&nbsp;<span class="op" id="6023606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6023610">return</span>&nbsp;<span class="builtintype" id="6023617">nil</span><span class="op" id="6023620">,</span>&nbsp;<span class="ident" id="6023622">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6023627">}</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6023630">dc</span><span class="op" id="6023632">.</span><span class="ident" id="6023633">Lock</span><span class="op" id="6023637">(</span><span class="op" id="6023638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6023641">txi</span><span class="op" id="6023644">,</span>&nbsp;<span class="ident" id="6023646">err</span>&nbsp;<span class="op" id="6023650">:=</span>&nbsp;<span class="ident" id="6023653">dc</span><span class="op" id="6023655">.</span><span class="ident" id="6023656">ci</span><span class="op" id="6023658">.</span><span class="ident" id="6023659">Begin</span><span class="op" id="6023664">(</span><span class="op" id="6023665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6023668">dc</span><span class="op" id="6023670">.</span><span class="ident" id="6023671">Unlock</span><span class="op" id="6023677">(</span><span class="op" id="6023678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6023681">if</span>&nbsp;<span class="ident" id="6023684">err</span>&nbsp;<span class="op" id="6023688">!=</span>&nbsp;<span class="builtintype" id="6023691">nil</span>&nbsp;<span class="op" id="6023695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6023699">db</span><span class="op" id="6023701">.</span><span class="ident" id="6023702">putConn</span><span class="op" id="6023709">(</span><span class="ident" id="6023710">dc</span><span class="op" id="6023712">,</span>&nbsp;<span class="ident" id="6023714">err</span><span class="op" id="6023717">)</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6023721">return</span>&nbsp;<span class="builtintype" id="6023728">nil</span><span class="op" id="6023731">,</span>&nbsp;<span class="ident" id="6023733">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6023738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6023741">return</span>&nbsp;<span class="op" id="6023748">&amp;</span><span class="ident" id="6023749">Tx</span><span class="op" id="6023751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6023755">db</span><span class="op" id="6023757">:</span>&nbsp;&nbsp;<span class="ident" id="6023760">db</span><span class="op" id="6023762">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6023766">dc</span><span class="op" id="6023768">:</span>&nbsp;&nbsp;<span class="ident" id="6023771">dc</span><span class="op" id="6023773">,</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6023777">txi</span><span class="op" id="6023780">:</span>&nbsp;<span class="ident" id="6023782">txi</span><span class="op" id="6023785">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6023788">}</span><span class="op" id="6023789">,</span>&nbsp;<span class="builtintype" id="6023791">nil</span><br>
<span class="lineno"></span><span class="op" id="6023795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6023798">//&nbsp;Driver&nbsp;returns&nbsp;the&nbsp;database&#39;s&nbsp;underlying&nbsp;driver.</span><br>
<span class="lineno">1040</span><span class="keyword" id="6023850">func</span>&nbsp;<span class="op" id="6023855">(</span><span class="ident" id="6023856">db</span>&nbsp;<span class="op" id="6023859">*</span><span class="ident" id="6023860">DB</span><span class="op" id="6023862">)</span>&nbsp;<span class="ident" id="6023864">Driver</span><span class="op" id="6023870">(</span><span class="op" id="6023871">)</span>&nbsp;<span class="ident" id="6023873">driver</span><span class="op" id="6023879">.</span><span class="ident" id="6023880">Driver</span>&nbsp;<span class="op" id="6023887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6023890">return</span>&nbsp;<span class="ident" id="6023897">db</span><span class="op" id="6023899">.</span><span class="ident" id="6023900">driver</span><br>
<span class="lineno"></span><span class="op" id="6023907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6023910">//&nbsp;Tx&nbsp;is&nbsp;an&nbsp;in-progress&nbsp;database&nbsp;transaction.</span><br>
<span class="lineno">1045</span><span class="comment" id="6023956">//</span><br>
<span class="lineno"></span><span class="comment" id="6023959">//&nbsp;A&nbsp;transaction&nbsp;must&nbsp;end&nbsp;with&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback.</span><br>
<span class="lineno"></span><span class="comment" id="6024020">//</span><br>
<span class="lineno"></span><span class="comment" id="6024023">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;all&nbsp;operations&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6024084">//&nbsp;transaction&nbsp;fail&nbsp;with&nbsp;ErrTxDone.</span><br>
<span class="lineno">1050</span><span class="keyword" id="6024120">type</span>&nbsp;<span class="ident" id="6024125">Tx</span>&nbsp;<span class="keyword" id="6024128">struct</span>&nbsp;<span class="op" id="6024135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024138">db</span>&nbsp;<span class="op" id="6024141">*</span><span class="ident" id="6024142">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6024147">//&nbsp;dc&nbsp;is&nbsp;owned&nbsp;exclusively&nbsp;until&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;at&nbsp;which&nbsp;point</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6024216">//&nbsp;it&#39;s&nbsp;returned&nbsp;with&nbsp;putConn.</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024248">dc</span>&nbsp;&nbsp;<span class="op" id="6024252">*</span><span class="ident" id="6024253">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024265">txi</span>&nbsp;<span class="ident" id="6024269">driver</span><span class="op" id="6024275">.</span><span class="ident" id="6024276">Tx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6024281">//&nbsp;done&nbsp;transitions&nbsp;from&nbsp;false&nbsp;to&nbsp;true&nbsp;exactly&nbsp;once,&nbsp;on&nbsp;Commit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6024345">//&nbsp;or&nbsp;Rollback.&nbsp;once&nbsp;done,&nbsp;all&nbsp;operations&nbsp;fail&nbsp;with</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6024398">//&nbsp;ErrTxDone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024413">done</span>&nbsp;<span class="builtintype" id="6024418">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6024425">//&nbsp;All&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.&nbsp;&nbsp;These&nbsp;will&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6024502">//&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024553">stmts</span>&nbsp;<span class="keyword" id="6024559">struct</span>&nbsp;<span class="op" id="6024566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024570">sync</span><span class="op" id="6024574">.</span><span class="ident" id="6024575">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024583">v</span>&nbsp;<span class="op" id="6024585">[</span><span class="op" id="6024586">]</span><span class="op" id="6024587">*</span><span class="ident" id="6024588">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6024594">}</span><br>
<span class="lineno"></span><span class="op" id="6024596">}</span><br>
<span class="lineno">1070</span><br>
<span class="lineno"></span><span class="keyword" id="6024599">var</span>&nbsp;<span class="ident" id="6024603">ErrTxDone</span>&nbsp;<span class="op" id="6024613">=</span>&nbsp;<span class="ident" id="6024615">errors</span><span class="op" id="6024621">.</span><span class="ident" id="6024622">New</span><span class="op" id="6024625">(</span><span class="string" id="6024626">&#34;sql:&nbsp;Transaction&nbsp;has&nbsp;already&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back&#34;</span><span class="op" id="6024686">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6024689">func</span>&nbsp;<span class="op" id="6024694">(</span><span class="ident" id="6024695">tx</span>&nbsp;<span class="op" id="6024698">*</span><span class="ident" id="6024699">Tx</span><span class="op" id="6024701">)</span>&nbsp;<span class="builtinfunc" id="6024703">close</span><span class="op" id="6024708">(</span><span class="op" id="6024709">)</span>&nbsp;<span class="op" id="6024711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6024714">if</span>&nbsp;<span class="ident" id="6024717">tx</span><span class="op" id="6024719">.</span><span class="ident" id="6024720">done</span>&nbsp;<span class="op" id="6024725">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6024729">panic</span><span class="op" id="6024734">(</span><span class="string" id="6024735">&#34;double&nbsp;close&#34;</span><span class="op" id="6024749">)</span>&nbsp;<span class="comment" id="6024751">//&nbsp;internal&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6024770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024773">tx</span><span class="op" id="6024775">.</span><span class="ident" id="6024776">done</span>&nbsp;<span class="op" id="6024781">=</span>&nbsp;<span class="builtintype" id="6024783">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024789">tx</span><span class="op" id="6024791">.</span><span class="ident" id="6024792">db</span><span class="op" id="6024794">.</span><span class="ident" id="6024795">putConn</span><span class="op" id="6024802">(</span><span class="ident" id="6024803">tx</span><span class="op" id="6024805">.</span><span class="ident" id="6024806">dc</span><span class="op" id="6024808">,</span>&nbsp;<span class="builtintype" id="6024810">nil</span><span class="op" id="6024813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024816">tx</span><span class="op" id="6024818">.</span><span class="ident" id="6024819">dc</span>&nbsp;<span class="op" id="6024822">=</span>&nbsp;<span class="builtintype" id="6024824">nil</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6024829">tx</span><span class="op" id="6024831">.</span><span class="ident" id="6024832">txi</span>&nbsp;<span class="op" id="6024836">=</span>&nbsp;<span class="builtintype" id="6024838">nil</span><br>
<span class="lineno"></span><span class="op" id="6024842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6024845">func</span>&nbsp;<span class="op" id="6024850">(</span><span class="ident" id="6024851">tx</span>&nbsp;<span class="op" id="6024854">*</span><span class="ident" id="6024855">Tx</span><span class="op" id="6024857">)</span>&nbsp;<span class="ident" id="6024859">grabConn</span><span class="op" id="6024867">(</span><span class="op" id="6024868">)</span>&nbsp;<span class="op" id="6024870">(</span><span class="op" id="6024871">*</span><span class="ident" id="6024872">driverConn</span><span class="op" id="6024882">,</span>&nbsp;<span class="builtintype" id="6024884">error</span><span class="op" id="6024889">)</span>&nbsp;<span class="op" id="6024891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6024894">if</span>&nbsp;<span class="ident" id="6024897">tx</span><span class="op" id="6024899">.</span><span class="ident" id="6024900">done</span>&nbsp;<span class="op" id="6024905">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6024909">return</span>&nbsp;<span class="builtintype" id="6024916">nil</span><span class="op" id="6024919">,</span>&nbsp;<span class="ident" id="6024921">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6024932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6024935">return</span>&nbsp;<span class="ident" id="6024942">tx</span><span class="op" id="6024944">.</span><span class="ident" id="6024945">dc</span><span class="op" id="6024947">,</span>&nbsp;<span class="builtintype" id="6024949">nil</span><br>
<span class="lineno"></span><span class="op" id="6024953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1090</span><span class="comment" id="6024956">//&nbsp;Closes&nbsp;all&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.</span><br>
<span class="lineno"></span><span class="keyword" id="6025007">func</span>&nbsp;<span class="op" id="6025012">(</span><span class="ident" id="6025013">tx</span>&nbsp;<span class="op" id="6025016">*</span><span class="ident" id="6025017">Tx</span><span class="op" id="6025019">)</span>&nbsp;<span class="ident" id="6025021">closePrepared</span><span class="op" id="6025034">(</span><span class="op" id="6025035">)</span>&nbsp;<span class="op" id="6025037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025040">tx</span><span class="op" id="6025042">.</span><span class="ident" id="6025043">stmts</span><span class="op" id="6025048">.</span><span class="ident" id="6025049">Lock</span><span class="op" id="6025053">(</span><span class="op" id="6025054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025057">for</span>&nbsp;<span class="ident" id="6025061">_</span><span class="op" id="6025062">,</span>&nbsp;<span class="ident" id="6025064">stmt</span>&nbsp;<span class="op" id="6025069">:=</span>&nbsp;<span class="keyword" id="6025072">range</span>&nbsp;<span class="ident" id="6025078">tx</span><span class="op" id="6025080">.</span><span class="ident" id="6025081">stmts</span><span class="op" id="6025086">.</span><span class="ident" id="6025087">v</span>&nbsp;<span class="op" id="6025089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025093">stmt</span><span class="op" id="6025097">.</span><span class="ident" id="6025098">Close</span><span class="op" id="6025103">(</span><span class="op" id="6025104">)</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6025107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025110">tx</span><span class="op" id="6025112">.</span><span class="ident" id="6025113">stmts</span><span class="op" id="6025118">.</span><span class="ident" id="6025119">Unlock</span><span class="op" id="6025125">(</span><span class="op" id="6025126">)</span><br>
<span class="lineno"></span><span class="op" id="6025128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6025131">//&nbsp;Commit&nbsp;commits&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1100</span><span class="keyword" id="6025166">func</span>&nbsp;<span class="op" id="6025171">(</span><span class="ident" id="6025172">tx</span>&nbsp;<span class="op" id="6025175">*</span><span class="ident" id="6025176">Tx</span><span class="op" id="6025178">)</span>&nbsp;<span class="ident" id="6025180">Commit</span><span class="op" id="6025186">(</span><span class="op" id="6025187">)</span>&nbsp;<span class="builtintype" id="6025189">error</span>&nbsp;<span class="op" id="6025195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025198">if</span>&nbsp;<span class="ident" id="6025201">tx</span><span class="op" id="6025203">.</span><span class="ident" id="6025204">done</span>&nbsp;<span class="op" id="6025209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025213">return</span>&nbsp;<span class="ident" id="6025220">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6025231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025234">defer</span>&nbsp;<span class="ident" id="6025240">tx</span><span class="op" id="6025242">.</span><span class="builtinfunc" id="6025243">close</span><span class="op" id="6025248">(</span><span class="op" id="6025249">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025252">tx</span><span class="op" id="6025254">.</span><span class="ident" id="6025255">dc</span><span class="op" id="6025257">.</span><span class="ident" id="6025258">Lock</span><span class="op" id="6025262">(</span><span class="op" id="6025263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025266">err</span>&nbsp;<span class="op" id="6025270">:=</span>&nbsp;<span class="ident" id="6025273">tx</span><span class="op" id="6025275">.</span><span class="ident" id="6025276">txi</span><span class="op" id="6025279">.</span><span class="ident" id="6025280">Commit</span><span class="op" id="6025286">(</span><span class="op" id="6025287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025290">tx</span><span class="op" id="6025292">.</span><span class="ident" id="6025293">dc</span><span class="op" id="6025295">.</span><span class="ident" id="6025296">Unlock</span><span class="op" id="6025302">(</span><span class="op" id="6025303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025306">if</span>&nbsp;<span class="ident" id="6025309">err</span>&nbsp;<span class="op" id="6025313">!=</span>&nbsp;<span class="ident" id="6025316">driver</span><span class="op" id="6025322">.</span><span class="ident" id="6025323">ErrBadConn</span>&nbsp;<span class="op" id="6025334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025338">tx</span><span class="op" id="6025340">.</span><span class="ident" id="6025341">closePrepared</span><span class="op" id="6025354">(</span><span class="op" id="6025355">)</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6025358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025361">return</span>&nbsp;<span class="ident" id="6025368">err</span><br>
<span class="lineno"></span><span class="op" id="6025372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6025375">//&nbsp;Rollback&nbsp;aborts&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1115</span><span class="keyword" id="6025411">func</span>&nbsp;<span class="op" id="6025416">(</span><span class="ident" id="6025417">tx</span>&nbsp;<span class="op" id="6025420">*</span><span class="ident" id="6025421">Tx</span><span class="op" id="6025423">)</span>&nbsp;<span class="ident" id="6025425">Rollback</span><span class="op" id="6025433">(</span><span class="op" id="6025434">)</span>&nbsp;<span class="builtintype" id="6025436">error</span>&nbsp;<span class="op" id="6025442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025445">if</span>&nbsp;<span class="ident" id="6025448">tx</span><span class="op" id="6025450">.</span><span class="ident" id="6025451">done</span>&nbsp;<span class="op" id="6025456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025460">return</span>&nbsp;<span class="ident" id="6025467">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6025478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025481">defer</span>&nbsp;<span class="ident" id="6025487">tx</span><span class="op" id="6025489">.</span><span class="builtinfunc" id="6025490">close</span><span class="op" id="6025495">(</span><span class="op" id="6025496">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025499">tx</span><span class="op" id="6025501">.</span><span class="ident" id="6025502">dc</span><span class="op" id="6025504">.</span><span class="ident" id="6025505">Lock</span><span class="op" id="6025509">(</span><span class="op" id="6025510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025513">err</span>&nbsp;<span class="op" id="6025517">:=</span>&nbsp;<span class="ident" id="6025520">tx</span><span class="op" id="6025522">.</span><span class="ident" id="6025523">txi</span><span class="op" id="6025526">.</span><span class="ident" id="6025527">Rollback</span><span class="op" id="6025535">(</span><span class="op" id="6025536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025539">tx</span><span class="op" id="6025541">.</span><span class="ident" id="6025542">dc</span><span class="op" id="6025544">.</span><span class="ident" id="6025545">Unlock</span><span class="op" id="6025551">(</span><span class="op" id="6025552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025555">if</span>&nbsp;<span class="ident" id="6025558">err</span>&nbsp;<span class="op" id="6025562">!=</span>&nbsp;<span class="ident" id="6025565">driver</span><span class="op" id="6025571">.</span><span class="ident" id="6025572">ErrBadConn</span>&nbsp;<span class="op" id="6025583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6025587">tx</span><span class="op" id="6025589">.</span><span class="ident" id="6025590">closePrepared</span><span class="op" id="6025603">(</span><span class="op" id="6025604">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6025607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6025610">return</span>&nbsp;<span class="ident" id="6025617">err</span><br>
<span class="lineno"></span><span class="op" id="6025621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6025624">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;use&nbsp;within&nbsp;a&nbsp;transaction.</span><br>
<span class="lineno">1130</span><span class="comment" id="6025694">//</span><br>
<span class="lineno"></span><span class="comment" id="6025697">//&nbsp;The&nbsp;returned&nbsp;statement&nbsp;operates&nbsp;within&nbsp;the&nbsp;transaction&nbsp;and&nbsp;can&nbsp;no&nbsp;longer</span><br>
<span class="lineno"></span><span class="comment" id="6025773">//&nbsp;be&nbsp;used&nbsp;once&nbsp;the&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno"></span><span class="comment" id="6025840">//</span><br>
<span class="lineno"></span><span class="comment" id="6025843">//&nbsp;To&nbsp;use&nbsp;an&nbsp;existing&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;this&nbsp;transaction,&nbsp;see&nbsp;Tx.Stmt.</span><br>
<span class="lineno">1135</span><span class="keyword" id="6025918">func</span>&nbsp;<span class="op" id="6025923">(</span><span class="ident" id="6025924">tx</span>&nbsp;<span class="op" id="6025927">*</span><span class="ident" id="6025928">Tx</span><span class="op" id="6025930">)</span>&nbsp;<span class="ident" id="6025932">Prepare</span><span class="op" id="6025939">(</span><span class="ident" id="6025940">query</span>&nbsp;<span class="builtintype" id="6025946">string</span><span class="op" id="6025952">)</span>&nbsp;<span class="op" id="6025954">(</span><span class="op" id="6025955">*</span><span class="ident" id="6025956">Stmt</span><span class="op" id="6025960">,</span>&nbsp;<span class="builtintype" id="6025962">error</span><span class="op" id="6025967">)</span>&nbsp;<span class="op" id="6025969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6025972">//&nbsp;TODO(bradfitz):&nbsp;We&nbsp;could&nbsp;be&nbsp;more&nbsp;efficient&nbsp;here&nbsp;and&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6026035">//&nbsp;provide&nbsp;a&nbsp;method&nbsp;to&nbsp;take&nbsp;an&nbsp;existing&nbsp;Stmt&nbsp;(created&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6026093">//&nbsp;perhaps&nbsp;a&nbsp;different&nbsp;Conn),&nbsp;and&nbsp;re-create&nbsp;it&nbsp;on&nbsp;this&nbsp;Conn&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6026157">//&nbsp;necessary.&nbsp;Or,&nbsp;better:&nbsp;keep&nbsp;a&nbsp;map&nbsp;in&nbsp;DB&nbsp;of&nbsp;query&nbsp;string&nbsp;to</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6026220">//&nbsp;Stmts,&nbsp;and&nbsp;have&nbsp;Stmt.Execute&nbsp;do&nbsp;the&nbsp;right&nbsp;thing&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6026276">//&nbsp;re-prepare&nbsp;if&nbsp;the&nbsp;Conn&nbsp;in&nbsp;use&nbsp;doesn&#39;t&nbsp;have&nbsp;that&nbsp;prepared</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6026337">//&nbsp;statement.&nbsp;&nbsp;But&nbsp;we&#39;ll&nbsp;want&nbsp;to&nbsp;avoid&nbsp;caching&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6026399">//&nbsp;in&nbsp;the&nbsp;case&nbsp;where&nbsp;we&nbsp;only&nbsp;call&nbsp;conn.Prepare&nbsp;implicitly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6026458">//&nbsp;(such&nbsp;as&nbsp;in&nbsp;db.Exec&nbsp;or&nbsp;tx.Exec),&nbsp;but&nbsp;the&nbsp;caller&nbsp;package</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6026518">//&nbsp;can&#39;t&nbsp;be&nbsp;holding&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6026578">//&nbsp;Perhaps&nbsp;just&nbsp;looking&nbsp;at&nbsp;the&nbsp;reference&nbsp;count&nbsp;(by&nbsp;noting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6026637">//&nbsp;Stmt.Close)&nbsp;would&nbsp;be&nbsp;enough.&nbsp;We&nbsp;might&nbsp;also&nbsp;want&nbsp;a&nbsp;finalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6026701">//&nbsp;on&nbsp;Stmt&nbsp;to&nbsp;drop&nbsp;the&nbsp;reference&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026742">dc</span><span class="op" id="6026744">,</span>&nbsp;<span class="ident" id="6026746">err</span>&nbsp;<span class="op" id="6026750">:=</span>&nbsp;<span class="ident" id="6026753">tx</span><span class="op" id="6026755">.</span><span class="ident" id="6026756">grabConn</span><span class="op" id="6026764">(</span><span class="op" id="6026765">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6026768">if</span>&nbsp;<span class="ident" id="6026771">err</span>&nbsp;<span class="op" id="6026775">!=</span>&nbsp;<span class="builtintype" id="6026778">nil</span>&nbsp;<span class="op" id="6026782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6026786">return</span>&nbsp;<span class="builtintype" id="6026793">nil</span><span class="op" id="6026796">,</span>&nbsp;<span class="ident" id="6026798">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6026803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026807">dc</span><span class="op" id="6026809">.</span><span class="ident" id="6026810">Lock</span><span class="op" id="6026814">(</span><span class="op" id="6026815">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026818">si</span><span class="op" id="6026820">,</span>&nbsp;<span class="ident" id="6026822">err</span>&nbsp;<span class="op" id="6026826">:=</span>&nbsp;<span class="ident" id="6026829">dc</span><span class="op" id="6026831">.</span><span class="ident" id="6026832">ci</span><span class="op" id="6026834">.</span><span class="ident" id="6026835">Prepare</span><span class="op" id="6026842">(</span><span class="ident" id="6026843">query</span><span class="op" id="6026848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026851">dc</span><span class="op" id="6026853">.</span><span class="ident" id="6026854">Unlock</span><span class="op" id="6026860">(</span><span class="op" id="6026861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6026864">if</span>&nbsp;<span class="ident" id="6026867">err</span>&nbsp;<span class="op" id="6026871">!=</span>&nbsp;<span class="builtintype" id="6026874">nil</span>&nbsp;<span class="op" id="6026878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6026882">return</span>&nbsp;<span class="builtintype" id="6026889">nil</span><span class="op" id="6026892">,</span>&nbsp;<span class="ident" id="6026894">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6026899">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026903">stmt</span>&nbsp;<span class="op" id="6026908">:=</span>&nbsp;<span class="op" id="6026911">&amp;</span><span class="ident" id="6026912">Stmt</span><span class="op" id="6026916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026920">db</span><span class="op" id="6026922">:</span>&nbsp;<span class="ident" id="6026924">tx</span><span class="op" id="6026926">.</span><span class="ident" id="6026927">db</span><span class="op" id="6026929">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026933">tx</span><span class="op" id="6026935">:</span>&nbsp;<span class="ident" id="6026937">tx</span><span class="op" id="6026939">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026943">txsi</span><span class="op" id="6026947">:</span>&nbsp;<span class="op" id="6026949">&amp;</span><span class="ident" id="6026950">driverStmt</span><span class="op" id="6026960">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026965">Locker</span><span class="op" id="6026971">:</span>&nbsp;<span class="ident" id="6026973">dc</span><span class="op" id="6026975">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026980">si</span><span class="op" id="6026982">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026988">si</span><span class="op" id="6026990">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6026994">}</span><span class="op" id="6026995">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6026999">query</span><span class="op" id="6027004">:</span>&nbsp;<span class="ident" id="6027006">query</span><span class="op" id="6027011">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6027014">}</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027017">tx</span><span class="op" id="6027019">.</span><span class="ident" id="6027020">stmts</span><span class="op" id="6027025">.</span><span class="ident" id="6027026">Lock</span><span class="op" id="6027030">(</span><span class="op" id="6027031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027034">tx</span><span class="op" id="6027036">.</span><span class="ident" id="6027037">stmts</span><span class="op" id="6027042">.</span><span class="ident" id="6027043">v</span>&nbsp;<span class="op" id="6027045">=</span>&nbsp;<span class="builtinfunc" id="6027047">append</span><span class="op" id="6027053">(</span><span class="ident" id="6027054">tx</span><span class="op" id="6027056">.</span><span class="ident" id="6027057">stmts</span><span class="op" id="6027062">.</span><span class="ident" id="6027063">v</span><span class="op" id="6027064">,</span>&nbsp;<span class="ident" id="6027066">stmt</span><span class="op" id="6027070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027073">tx</span><span class="op" id="6027075">.</span><span class="ident" id="6027076">stmts</span><span class="op" id="6027081">.</span><span class="ident" id="6027082">Unlock</span><span class="op" id="6027088">(</span><span class="op" id="6027089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6027092">return</span>&nbsp;<span class="ident" id="6027099">stmt</span><span class="op" id="6027103">,</span>&nbsp;<span class="builtintype" id="6027105">nil</span><br>
<span class="lineno"></span><span class="op" id="6027109">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span><span class="comment" id="6027112">//&nbsp;Stmt&nbsp;returns&nbsp;a&nbsp;transaction-specific&nbsp;prepared&nbsp;statement&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="6027175">//&nbsp;an&nbsp;existing&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="6027201">//</span><br>
<span class="lineno"></span><span class="comment" id="6027204">//&nbsp;Example:</span><br>
<span class="lineno">1180</span><span class="comment" id="6027216">//&nbsp;&nbsp;updateMoney,&nbsp;err&nbsp;:=&nbsp;db.Prepare(&#34;UPDATE&nbsp;balance&nbsp;SET&nbsp;money=money+?&nbsp;WHERE&nbsp;id=?&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="6027298">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6027306">//&nbsp;&nbsp;tx,&nbsp;err&nbsp;:=&nbsp;db.Begin()</span><br>
<span class="lineno"></span><span class="comment" id="6027332">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6027340">//&nbsp;&nbsp;res,&nbsp;err&nbsp;:=&nbsp;tx.Stmt(updateMoney).Exec(123.45,&nbsp;98293203)</span><br>
<span class="lineno">1185</span><span class="keyword" id="6027400">func</span>&nbsp;<span class="op" id="6027405">(</span><span class="ident" id="6027406">tx</span>&nbsp;<span class="op" id="6027409">*</span><span class="ident" id="6027410">Tx</span><span class="op" id="6027412">)</span>&nbsp;<span class="ident" id="6027414">Stmt</span><span class="op" id="6027418">(</span><span class="ident" id="6027419">stmt</span>&nbsp;<span class="op" id="6027424">*</span><span class="ident" id="6027425">Stmt</span><span class="op" id="6027429">)</span>&nbsp;<span class="op" id="6027431">*</span><span class="ident" id="6027432">Stmt</span>&nbsp;<span class="op" id="6027437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6027440">//&nbsp;TODO(bradfitz):&nbsp;optimize&nbsp;this.&nbsp;Currently&nbsp;this&nbsp;re-prepares</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6027502">//&nbsp;each&nbsp;time.&nbsp;&nbsp;This&nbsp;is&nbsp;fine&nbsp;for&nbsp;now&nbsp;to&nbsp;illustrate&nbsp;the&nbsp;API&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6027565">//&nbsp;we&nbsp;should&nbsp;really&nbsp;cache&nbsp;already-prepared&nbsp;statements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6027620">//&nbsp;per-Conn.&nbsp;See&nbsp;also&nbsp;the&nbsp;big&nbsp;comment&nbsp;in&nbsp;Tx.Prepare.</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6027675">if</span>&nbsp;<span class="ident" id="6027678">tx</span><span class="op" id="6027680">.</span><span class="ident" id="6027681">db</span>&nbsp;<span class="op" id="6027684">!=</span>&nbsp;<span class="ident" id="6027687">stmt</span><span class="op" id="6027691">.</span><span class="ident" id="6027692">db</span>&nbsp;<span class="op" id="6027695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6027699">return</span>&nbsp;<span class="op" id="6027706">&amp;</span><span class="ident" id="6027707">Stmt</span><span class="op" id="6027711">{</span><span class="ident" id="6027712">stickyErr</span><span class="op" id="6027721">:</span>&nbsp;<span class="ident" id="6027723">errors</span><span class="op" id="6027729">.</span><span class="ident" id="6027730">New</span><span class="op" id="6027733">(</span><span class="string" id="6027734">&#34;sql:&nbsp;Tx.Stmt:&nbsp;statement&nbsp;from&nbsp;different&nbsp;database&nbsp;used&#34;</span><span class="op" id="6027788">)</span><span class="op" id="6027789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6027792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027795">dc</span><span class="op" id="6027797">,</span>&nbsp;<span class="ident" id="6027799">err</span>&nbsp;<span class="op" id="6027803">:=</span>&nbsp;<span class="ident" id="6027806">tx</span><span class="op" id="6027808">.</span><span class="ident" id="6027809">grabConn</span><span class="op" id="6027817">(</span><span class="op" id="6027818">)</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6027821">if</span>&nbsp;<span class="ident" id="6027824">err</span>&nbsp;<span class="op" id="6027828">!=</span>&nbsp;<span class="builtintype" id="6027831">nil</span>&nbsp;<span class="op" id="6027835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6027839">return</span>&nbsp;<span class="op" id="6027846">&amp;</span><span class="ident" id="6027847">Stmt</span><span class="op" id="6027851">{</span><span class="ident" id="6027852">stickyErr</span><span class="op" id="6027861">:</span>&nbsp;<span class="ident" id="6027863">err</span><span class="op" id="6027866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6027869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027872">dc</span><span class="op" id="6027874">.</span><span class="ident" id="6027875">Lock</span><span class="op" id="6027879">(</span><span class="op" id="6027880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027883">si</span><span class="op" id="6027885">,</span>&nbsp;<span class="ident" id="6027887">err</span>&nbsp;<span class="op" id="6027891">:=</span>&nbsp;<span class="ident" id="6027894">dc</span><span class="op" id="6027896">.</span><span class="ident" id="6027897">ci</span><span class="op" id="6027899">.</span><span class="ident" id="6027900">Prepare</span><span class="op" id="6027907">(</span><span class="ident" id="6027908">stmt</span><span class="op" id="6027912">.</span><span class="ident" id="6027913">query</span><span class="op" id="6027918">)</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027921">dc</span><span class="op" id="6027923">.</span><span class="ident" id="6027924">Unlock</span><span class="op" id="6027930">(</span><span class="op" id="6027931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027934">txs</span>&nbsp;<span class="op" id="6027938">:=</span>&nbsp;<span class="op" id="6027941">&amp;</span><span class="ident" id="6027942">Stmt</span><span class="op" id="6027946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027950">db</span><span class="op" id="6027952">:</span>&nbsp;<span class="ident" id="6027954">tx</span><span class="op" id="6027956">.</span><span class="ident" id="6027957">db</span><span class="op" id="6027959">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027963">tx</span><span class="op" id="6027965">:</span>&nbsp;<span class="ident" id="6027967">tx</span><span class="op" id="6027969">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027973">txsi</span><span class="op" id="6027977">:</span>&nbsp;<span class="op" id="6027979">&amp;</span><span class="ident" id="6027980">driverStmt</span><span class="op" id="6027990">{</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6027995">Locker</span><span class="op" id="6028001">:</span>&nbsp;<span class="ident" id="6028003">dc</span><span class="op" id="6028005">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028010">si</span><span class="op" id="6028012">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028018">si</span><span class="op" id="6028020">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6028024">}</span><span class="op" id="6028025">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028029">query</span><span class="op" id="6028034">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028040">stmt</span><span class="op" id="6028044">.</span><span class="ident" id="6028045">query</span><span class="op" id="6028050">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028054">stickyErr</span><span class="op" id="6028063">:</span>&nbsp;<span class="ident" id="6028065">err</span><span class="op" id="6028068">,</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6028071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028074">tx</span><span class="op" id="6028076">.</span><span class="ident" id="6028077">stmts</span><span class="op" id="6028082">.</span><span class="ident" id="6028083">Lock</span><span class="op" id="6028087">(</span><span class="op" id="6028088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028091">tx</span><span class="op" id="6028093">.</span><span class="ident" id="6028094">stmts</span><span class="op" id="6028099">.</span><span class="ident" id="6028100">v</span>&nbsp;<span class="op" id="6028102">=</span>&nbsp;<span class="builtinfunc" id="6028104">append</span><span class="op" id="6028110">(</span><span class="ident" id="6028111">tx</span><span class="op" id="6028113">.</span><span class="ident" id="6028114">stmts</span><span class="op" id="6028119">.</span><span class="ident" id="6028120">v</span><span class="op" id="6028121">,</span>&nbsp;<span class="ident" id="6028123">txs</span><span class="op" id="6028126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028129">tx</span><span class="op" id="6028131">.</span><span class="ident" id="6028132">stmts</span><span class="op" id="6028137">.</span><span class="ident" id="6028138">Unlock</span><span class="op" id="6028144">(</span><span class="op" id="6028145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028148">return</span>&nbsp;<span class="ident" id="6028155">txs</span><br>
<span class="lineno">1215</span><span class="op" id="6028159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6028162">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;doesn&#39;t&nbsp;return&nbsp;rows.</span><br>
<span class="lineno"></span><span class="comment" id="6028213">//&nbsp;For&nbsp;example:&nbsp;an&nbsp;INSERT&nbsp;and&nbsp;UPDATE.</span><br>
<span class="lineno"></span><span class="keyword" id="6028251">func</span>&nbsp;<span class="op" id="6028256">(</span><span class="ident" id="6028257">tx</span>&nbsp;<span class="op" id="6028260">*</span><span class="ident" id="6028261">Tx</span><span class="op" id="6028263">)</span>&nbsp;<span class="ident" id="6028265">Exec</span><span class="op" id="6028269">(</span><span class="ident" id="6028270">query</span>&nbsp;<span class="builtintype" id="6028276">string</span><span class="op" id="6028282">,</span>&nbsp;<span class="ident" id="6028284">args</span>&nbsp;<span class="op" id="6028289">...</span><span class="keyword" id="6028292">interface</span><span class="op" id="6028301">{</span><span class="op" id="6028302">}</span><span class="op" id="6028303">)</span>&nbsp;<span class="op" id="6028305">(</span><span class="ident" id="6028306">Result</span><span class="op" id="6028312">,</span>&nbsp;<span class="builtintype" id="6028314">error</span><span class="op" id="6028319">)</span>&nbsp;<span class="op" id="6028321">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028324">dc</span><span class="op" id="6028326">,</span>&nbsp;<span class="ident" id="6028328">err</span>&nbsp;<span class="op" id="6028332">:=</span>&nbsp;<span class="ident" id="6028335">tx</span><span class="op" id="6028337">.</span><span class="ident" id="6028338">grabConn</span><span class="op" id="6028346">(</span><span class="op" id="6028347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028350">if</span>&nbsp;<span class="ident" id="6028353">err</span>&nbsp;<span class="op" id="6028357">!=</span>&nbsp;<span class="builtintype" id="6028360">nil</span>&nbsp;<span class="op" id="6028364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028368">return</span>&nbsp;<span class="builtintype" id="6028375">nil</span><span class="op" id="6028378">,</span>&nbsp;<span class="ident" id="6028380">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6028385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028389">if</span>&nbsp;<span class="ident" id="6028392">execer</span><span class="op" id="6028398">,</span>&nbsp;<span class="ident" id="6028400">ok</span>&nbsp;<span class="op" id="6028403">:=</span>&nbsp;<span class="ident" id="6028406">dc</span><span class="op" id="6028408">.</span><span class="ident" id="6028409">ci</span><span class="op" id="6028411">.</span><span class="op" id="6028412">(</span><span class="ident" id="6028413">driver</span><span class="op" id="6028419">.</span><span class="ident" id="6028420">Execer</span><span class="op" id="6028426">)</span><span class="op" id="6028427">;</span>&nbsp;<span class="ident" id="6028429">ok</span>&nbsp;<span class="op" id="6028432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028436">dargs</span><span class="op" id="6028441">,</span>&nbsp;<span class="ident" id="6028443">err</span>&nbsp;<span class="op" id="6028447">:=</span>&nbsp;<span class="ident" id="6028450">driverArgs</span><span class="op" id="6028460">(</span><span class="builtintype" id="6028461">nil</span><span class="op" id="6028464">,</span>&nbsp;<span class="ident" id="6028466">args</span><span class="op" id="6028470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028474">if</span>&nbsp;<span class="ident" id="6028477">err</span>&nbsp;<span class="op" id="6028481">!=</span>&nbsp;<span class="builtintype" id="6028484">nil</span>&nbsp;<span class="op" id="6028488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028493">return</span>&nbsp;<span class="builtintype" id="6028500">nil</span><span class="op" id="6028503">,</span>&nbsp;<span class="ident" id="6028505">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6028511">}</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028515">dc</span><span class="op" id="6028517">.</span><span class="ident" id="6028518">Lock</span><span class="op" id="6028522">(</span><span class="op" id="6028523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028527">resi</span><span class="op" id="6028531">,</span>&nbsp;<span class="ident" id="6028533">err</span>&nbsp;<span class="op" id="6028537">:=</span>&nbsp;<span class="ident" id="6028540">execer</span><span class="op" id="6028546">.</span><span class="ident" id="6028547">Exec</span><span class="op" id="6028551">(</span><span class="ident" id="6028552">query</span><span class="op" id="6028557">,</span>&nbsp;<span class="ident" id="6028559">dargs</span><span class="op" id="6028564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028568">dc</span><span class="op" id="6028570">.</span><span class="ident" id="6028571">Unlock</span><span class="op" id="6028577">(</span><span class="op" id="6028578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028582">if</span>&nbsp;<span class="ident" id="6028585">err</span>&nbsp;<span class="op" id="6028589">==</span>&nbsp;<span class="builtintype" id="6028592">nil</span>&nbsp;<span class="op" id="6028596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028601">return</span>&nbsp;<span class="ident" id="6028608">driverResult</span><span class="op" id="6028620">{</span><span class="ident" id="6028621">dc</span><span class="op" id="6028623">,</span>&nbsp;<span class="ident" id="6028625">resi</span><span class="op" id="6028629">}</span><span class="op" id="6028630">,</span>&nbsp;<span class="builtintype" id="6028632">nil</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6028638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028642">if</span>&nbsp;<span class="ident" id="6028645">err</span>&nbsp;<span class="op" id="6028649">!=</span>&nbsp;<span class="ident" id="6028652">driver</span><span class="op" id="6028658">.</span><span class="ident" id="6028659">ErrSkip</span>&nbsp;<span class="op" id="6028667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028672">return</span>&nbsp;<span class="builtintype" id="6028679">nil</span><span class="op" id="6028682">,</span>&nbsp;<span class="ident" id="6028684">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6028690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6028693">}</span><br>
<span class="lineno">1240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028697">dc</span><span class="op" id="6028699">.</span><span class="ident" id="6028700">Lock</span><span class="op" id="6028704">(</span><span class="op" id="6028705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028708">si</span><span class="op" id="6028710">,</span>&nbsp;<span class="ident" id="6028712">err</span>&nbsp;<span class="op" id="6028716">:=</span>&nbsp;<span class="ident" id="6028719">dc</span><span class="op" id="6028721">.</span><span class="ident" id="6028722">ci</span><span class="op" id="6028724">.</span><span class="ident" id="6028725">Prepare</span><span class="op" id="6028732">(</span><span class="ident" id="6028733">query</span><span class="op" id="6028738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6028741">dc</span><span class="op" id="6028743">.</span><span class="ident" id="6028744">Unlock</span><span class="op" id="6028750">(</span><span class="op" id="6028751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028754">if</span>&nbsp;<span class="ident" id="6028757">err</span>&nbsp;<span class="op" id="6028761">!=</span>&nbsp;<span class="builtintype" id="6028764">nil</span>&nbsp;<span class="op" id="6028768">{</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028772">return</span>&nbsp;<span class="builtintype" id="6028779">nil</span><span class="op" id="6028782">,</span>&nbsp;<span class="ident" id="6028784">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6028789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028792">defer</span>&nbsp;<span class="ident" id="6028798">withLock</span><span class="op" id="6028806">(</span><span class="ident" id="6028807">dc</span><span class="op" id="6028809">,</span>&nbsp;<span class="keyword" id="6028811">func</span><span class="op" id="6028815">(</span><span class="op" id="6028816">)</span>&nbsp;<span class="op" id="6028818">{</span>&nbsp;<span class="ident" id="6028820">si</span><span class="op" id="6028822">.</span><span class="ident" id="6028823">Close</span><span class="op" id="6028828">(</span><span class="op" id="6028829">)</span>&nbsp;<span class="op" id="6028831">}</span><span class="op" id="6028832">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6028836">return</span>&nbsp;<span class="ident" id="6028843">resultFromStatement</span><span class="op" id="6028862">(</span><span class="ident" id="6028863">driverStmt</span><span class="op" id="6028873">{</span><span class="ident" id="6028874">dc</span><span class="op" id="6028876">,</span>&nbsp;<span class="ident" id="6028878">si</span><span class="op" id="6028880">}</span><span class="op" id="6028881">,</span>&nbsp;<span class="ident" id="6028883">args</span><span class="op" id="6028887">...</span><span class="op" id="6028890">)</span><br>
<span class="lineno">1250</span><span class="op" id="6028892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6028895">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="keyword" id="6028960">func</span>&nbsp;<span class="op" id="6028965">(</span><span class="ident" id="6028966">tx</span>&nbsp;<span class="op" id="6028969">*</span><span class="ident" id="6028970">Tx</span><span class="op" id="6028972">)</span>&nbsp;<span class="ident" id="6028974">Query</span><span class="op" id="6028979">(</span><span class="ident" id="6028980">query</span>&nbsp;<span class="builtintype" id="6028986">string</span><span class="op" id="6028992">,</span>&nbsp;<span class="ident" id="6028994">args</span>&nbsp;<span class="op" id="6028999">...</span><span class="keyword" id="6029002">interface</span><span class="op" id="6029011">{</span><span class="op" id="6029012">}</span><span class="op" id="6029013">)</span>&nbsp;<span class="op" id="6029015">(</span><span class="op" id="6029016">*</span><span class="ident" id="6029017">Rows</span><span class="op" id="6029021">,</span>&nbsp;<span class="builtintype" id="6029023">error</span><span class="op" id="6029028">)</span>&nbsp;<span class="op" id="6029030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6029033">dc</span><span class="op" id="6029035">,</span>&nbsp;<span class="ident" id="6029037">err</span>&nbsp;<span class="op" id="6029041">:=</span>&nbsp;<span class="ident" id="6029044">tx</span><span class="op" id="6029046">.</span><span class="ident" id="6029047">grabConn</span><span class="op" id="6029055">(</span><span class="op" id="6029056">)</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6029059">if</span>&nbsp;<span class="ident" id="6029062">err</span>&nbsp;<span class="op" id="6029066">!=</span>&nbsp;<span class="builtintype" id="6029069">nil</span>&nbsp;<span class="op" id="6029073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6029077">return</span>&nbsp;<span class="builtintype" id="6029084">nil</span><span class="op" id="6029087">,</span>&nbsp;<span class="ident" id="6029089">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6029094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6029097">releaseConn</span>&nbsp;<span class="op" id="6029109">:=</span>&nbsp;<span class="keyword" id="6029112">func</span><span class="op" id="6029116">(</span><span class="builtintype" id="6029117">error</span><span class="op" id="6029122">)</span>&nbsp;<span class="op" id="6029124">{</span><span class="op" id="6029125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6029128">return</span>&nbsp;<span class="ident" id="6029135">tx</span><span class="op" id="6029137">.</span><span class="ident" id="6029138">db</span><span class="op" id="6029140">.</span><span class="ident" id="6029141">queryConn</span><span class="op" id="6029150">(</span><span class="ident" id="6029151">dc</span><span class="op" id="6029153">,</span>&nbsp;<span class="ident" id="6029155">releaseConn</span><span class="op" id="6029166">,</span>&nbsp;<span class="ident" id="6029168">query</span><span class="op" id="6029173">,</span>&nbsp;<span class="ident" id="6029175">args</span><span class="op" id="6029179">)</span><br>
<span class="lineno">1260</span><span class="op" id="6029181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6029184">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="6029257">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="6029326">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno">1265</span><span class="keyword" id="6029358">func</span>&nbsp;<span class="op" id="6029363">(</span><span class="ident" id="6029364">tx</span>&nbsp;<span class="op" id="6029367">*</span><span class="ident" id="6029368">Tx</span><span class="op" id="6029370">)</span>&nbsp;<span class="ident" id="6029372">QueryRow</span><span class="op" id="6029380">(</span><span class="ident" id="6029381">query</span>&nbsp;<span class="builtintype" id="6029387">string</span><span class="op" id="6029393">,</span>&nbsp;<span class="ident" id="6029395">args</span>&nbsp;<span class="op" id="6029400">...</span><span class="keyword" id="6029403">interface</span><span class="op" id="6029412">{</span><span class="op" id="6029413">}</span><span class="op" id="6029414">)</span>&nbsp;<span class="op" id="6029416">*</span><span class="ident" id="6029417">Row</span>&nbsp;<span class="op" id="6029421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6029424">rows</span><span class="op" id="6029428">,</span>&nbsp;<span class="ident" id="6029430">err</span>&nbsp;<span class="op" id="6029434">:=</span>&nbsp;<span class="ident" id="6029437">tx</span><span class="op" id="6029439">.</span><span class="ident" id="6029440">Query</span><span class="op" id="6029445">(</span><span class="ident" id="6029446">query</span><span class="op" id="6029451">,</span>&nbsp;<span class="ident" id="6029453">args</span><span class="op" id="6029457">...</span><span class="op" id="6029460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6029463">return</span>&nbsp;<span class="op" id="6029470">&amp;</span><span class="ident" id="6029471">Row</span><span class="op" id="6029474">{</span><span class="ident" id="6029475">rows</span><span class="op" id="6029479">:</span>&nbsp;<span class="ident" id="6029481">rows</span><span class="op" id="6029485">,</span>&nbsp;<span class="ident" id="6029487">err</span><span class="op" id="6029490">:</span>&nbsp;<span class="ident" id="6029492">err</span><span class="op" id="6029495">}</span><br>
<span class="lineno"></span><span class="op" id="6029497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="6029500">//&nbsp;connStmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;a&nbsp;particular&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6029564">type</span>&nbsp;<span class="ident" id="6029569">connStmt</span>&nbsp;<span class="keyword" id="6029578">struct</span>&nbsp;<span class="op" id="6029585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6029588">dc</span>&nbsp;<span class="op" id="6029591">*</span><span class="ident" id="6029592">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6029604">si</span>&nbsp;<span class="ident" id="6029607">driver</span><span class="op" id="6029613">.</span><span class="ident" id="6029614">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6029619">}</span><br>
<span class="lineno">1275</span><br>
<span class="lineno"></span><span class="comment" id="6029622">//&nbsp;Stmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement.&nbsp;Stmt&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="6029711">type</span>&nbsp;<span class="ident" id="6029716">Stmt</span>&nbsp;<span class="keyword" id="6029721">struct</span>&nbsp;<span class="op" id="6029728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6029731">//&nbsp;Immutable:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6029746">db</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6029756">*</span><span class="ident" id="6029757">DB</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6029763">//&nbsp;where&nbsp;we&nbsp;came&nbsp;from</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6029786">query</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6029796">string</span>&nbsp;<span class="comment" id="6029803">//&nbsp;that&nbsp;created&nbsp;the&nbsp;Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6029829">stickyErr</span>&nbsp;<span class="builtintype" id="6029839">error</span>&nbsp;&nbsp;<span class="comment" id="6029846">//&nbsp;if&nbsp;non-nil,&nbsp;this&nbsp;error&nbsp;is&nbsp;returned&nbsp;for&nbsp;all&nbsp;operations</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6029905">closemu</span>&nbsp;<span class="ident" id="6029913">sync</span><span class="op" id="6029917">.</span><span class="ident" id="6029918">RWMutex</span>&nbsp;<span class="comment" id="6029926">//&nbsp;held&nbsp;exclusively&nbsp;during&nbsp;close,&nbsp;for&nbsp;read&nbsp;otherwise.</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6029982">//&nbsp;If&nbsp;in&nbsp;a&nbsp;transaction,&nbsp;else&nbsp;both&nbsp;nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6030022">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6030027">*</span><span class="ident" id="6030028">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6030032">txsi</span>&nbsp;<span class="op" id="6030037">*</span><span class="ident" id="6030038">driverStmt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6030051">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6030058">sync</span><span class="op" id="6030062">.</span><span class="ident" id="6030063">Mutex</span>&nbsp;<span class="comment" id="6030069">//&nbsp;protects&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;fields</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6030105">closed</span>&nbsp;<span class="builtintype" id="6030112">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6030119">//&nbsp;css&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;underlying&nbsp;driver&nbsp;statement&nbsp;interfaces</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6030179">//&nbsp;that&nbsp;are&nbsp;valid&nbsp;on&nbsp;particular&nbsp;connections.&nbsp;&nbsp;This&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6030239">//&nbsp;used&nbsp;if&nbsp;tx&nbsp;==&nbsp;nil&nbsp;and&nbsp;one&nbsp;is&nbsp;found&nbsp;that&nbsp;has&nbsp;idle</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6030292">//&nbsp;connections.&nbsp;&nbsp;If&nbsp;tx&nbsp;!=&nbsp;nil,&nbsp;txsi&nbsp;is&nbsp;always&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6030345">css</span>&nbsp;<span class="op" id="6030349">[</span><span class="op" id="6030350">]</span><span class="ident" id="6030351">connStmt</span><br>
<span class="lineno"></span><span class="op" id="6030360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6030363">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments&nbsp;and</span><br>
<span class="lineno">1300</span><span class="comment" id="6030430">//&nbsp;returns&nbsp;a&nbsp;Result&nbsp;summarizing&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6030491">func</span>&nbsp;<span class="op" id="6030496">(</span><span class="ident" id="6030497">s</span>&nbsp;<span class="op" id="6030499">*</span><span class="ident" id="6030500">Stmt</span><span class="op" id="6030504">)</span>&nbsp;<span class="ident" id="6030506">Exec</span><span class="op" id="6030510">(</span><span class="ident" id="6030511">args</span>&nbsp;<span class="op" id="6030516">...</span><span class="keyword" id="6030519">interface</span><span class="op" id="6030528">{</span><span class="op" id="6030529">}</span><span class="op" id="6030530">)</span>&nbsp;<span class="op" id="6030532">(</span><span class="ident" id="6030533">Result</span><span class="op" id="6030539">,</span>&nbsp;<span class="builtintype" id="6030541">error</span><span class="op" id="6030546">)</span>&nbsp;<span class="op" id="6030548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6030551">s</span><span class="op" id="6030552">.</span><span class="ident" id="6030553">closemu</span><span class="op" id="6030560">.</span><span class="ident" id="6030561">RLock</span><span class="op" id="6030566">(</span><span class="op" id="6030567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6030570">defer</span>&nbsp;<span class="ident" id="6030576">s</span><span class="op" id="6030577">.</span><span class="ident" id="6030578">closemu</span><span class="op" id="6030585">.</span><span class="ident" id="6030586">RUnlock</span><span class="op" id="6030593">(</span><span class="op" id="6030594">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6030598">var</span>&nbsp;<span class="ident" id="6030602">res</span>&nbsp;<span class="ident" id="6030606">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6030614">for</span>&nbsp;<span class="ident" id="6030618">i</span>&nbsp;<span class="op" id="6030620">:=</span>&nbsp;<span class="num" id="6030623">0</span><span class="op" id="6030624">;</span>&nbsp;<span class="ident" id="6030626">i</span>&nbsp;<span class="op" id="6030628">&lt;</span>&nbsp;<span class="ident" id="6030630">maxBadConnRetries</span><span class="op" id="6030647">;</span>&nbsp;<span class="ident" id="6030649">i</span><span class="op" id="6030650">++</span>&nbsp;<span class="op" id="6030653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6030657">dc</span><span class="op" id="6030659">,</span>&nbsp;<span class="ident" id="6030661">releaseConn</span><span class="op" id="6030672">,</span>&nbsp;<span class="ident" id="6030674">si</span><span class="op" id="6030676">,</span>&nbsp;<span class="ident" id="6030678">err</span>&nbsp;<span class="op" id="6030682">:=</span>&nbsp;<span class="ident" id="6030685">s</span><span class="op" id="6030686">.</span><span class="ident" id="6030687">connStmt</span><span class="op" id="6030695">(</span><span class="op" id="6030696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6030700">if</span>&nbsp;<span class="ident" id="6030703">err</span>&nbsp;<span class="op" id="6030707">!=</span>&nbsp;<span class="builtintype" id="6030710">nil</span>&nbsp;<span class="op" id="6030714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6030719">if</span>&nbsp;<span class="ident" id="6030722">err</span>&nbsp;<span class="op" id="6030726">==</span>&nbsp;<span class="ident" id="6030729">driver</span><span class="op" id="6030735">.</span><span class="ident" id="6030736">ErrBadConn</span>&nbsp;<span class="op" id="6030747">{</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6030753">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6030765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6030770">return</span>&nbsp;<span class="builtintype" id="6030777">nil</span><span class="op" id="6030780">,</span>&nbsp;<span class="ident" id="6030782">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6030788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6030793">res</span><span class="op" id="6030796">,</span>&nbsp;<span class="ident" id="6030798">err</span>&nbsp;<span class="op" id="6030802">=</span>&nbsp;<span class="ident" id="6030804">resultFromStatement</span><span class="op" id="6030823">(</span><span class="ident" id="6030824">driverStmt</span><span class="op" id="6030834">{</span><span class="ident" id="6030835">dc</span><span class="op" id="6030837">,</span>&nbsp;<span class="ident" id="6030839">si</span><span class="op" id="6030841">}</span><span class="op" id="6030842">,</span>&nbsp;<span class="ident" id="6030844">args</span><span class="op" id="6030848">...</span><span class="op" id="6030851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6030855">releaseConn</span><span class="op" id="6030866">(</span><span class="ident" id="6030867">err</span><span class="op" id="6030870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6030874">if</span>&nbsp;<span class="ident" id="6030877">err</span>&nbsp;<span class="op" id="6030881">!=</span>&nbsp;<span class="ident" id="6030884">driver</span><span class="op" id="6030890">.</span><span class="ident" id="6030891">ErrBadConn</span>&nbsp;<span class="op" id="6030902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6030907">return</span>&nbsp;<span class="ident" id="6030914">res</span><span class="op" id="6030917">,</span>&nbsp;<span class="ident" id="6030919">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6030925">}</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6030928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6030931">return</span>&nbsp;<span class="builtintype" id="6030938">nil</span><span class="op" id="6030941">,</span>&nbsp;<span class="ident" id="6030943">driver</span><span class="op" id="6030949">.</span><span class="ident" id="6030950">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="6030961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6030964">func</span>&nbsp;<span class="ident" id="6030969">resultFromStatement</span><span class="op" id="6030988">(</span><span class="ident" id="6030989">ds</span>&nbsp;<span class="ident" id="6030992">driverStmt</span><span class="op" id="6031002">,</span>&nbsp;<span class="ident" id="6031004">args</span>&nbsp;<span class="op" id="6031009">...</span><span class="keyword" id="6031012">interface</span><span class="op" id="6031021">{</span><span class="op" id="6031022">}</span><span class="op" id="6031023">)</span>&nbsp;<span class="op" id="6031025">(</span><span class="ident" id="6031026">Result</span><span class="op" id="6031032">,</span>&nbsp;<span class="builtintype" id="6031034">error</span><span class="op" id="6031039">)</span>&nbsp;<span class="op" id="6031041">{</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6031044">ds</span><span class="op" id="6031046">.</span><span class="ident" id="6031047">Lock</span><span class="op" id="6031051">(</span><span class="op" id="6031052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6031055">want</span>&nbsp;<span class="op" id="6031060">:=</span>&nbsp;<span class="ident" id="6031063">ds</span><span class="op" id="6031065">.</span><span class="ident" id="6031066">si</span><span class="op" id="6031068">.</span><span class="ident" id="6031069">NumInput</span><span class="op" id="6031077">(</span><span class="op" id="6031078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6031081">ds</span><span class="op" id="6031083">.</span><span class="ident" id="6031084">Unlock</span><span class="op" id="6031090">(</span><span class="op" id="6031091">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6031095">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6031159">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6031233">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6031262">if</span>&nbsp;<span class="ident" id="6031265">want</span>&nbsp;<span class="op" id="6031270">!=</span>&nbsp;<span class="op" id="6031273">-</span><span class="num" id="6031274">1</span>&nbsp;<span class="op" id="6031276">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6031279">len</span><span class="op" id="6031282">(</span><span class="ident" id="6031283">args</span><span class="op" id="6031287">)</span>&nbsp;<span class="op" id="6031289">!=</span>&nbsp;<span class="ident" id="6031292">want</span>&nbsp;<span class="op" id="6031297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6031301">return</span>&nbsp;<span class="builtintype" id="6031308">nil</span><span class="op" id="6031311">,</span>&nbsp;<span class="ident" id="6031313">fmt</span><span class="op" id="6031316">.</span><span class="ident" id="6031317">Errorf</span><span class="op" id="6031323">(</span><span class="string" id="6031324">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;arguments,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6031360">,</span>&nbsp;<span class="ident" id="6031362">want</span><span class="op" id="6031366">,</span>&nbsp;<span class="builtinfunc" id="6031368">len</span><span class="op" id="6031371">(</span><span class="ident" id="6031372">args</span><span class="op" id="6031376">)</span><span class="op" id="6031377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6031380">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6031384">dargs</span><span class="op" id="6031389">,</span>&nbsp;<span class="ident" id="6031391">err</span>&nbsp;<span class="op" id="6031395">:=</span>&nbsp;<span class="ident" id="6031398">driverArgs</span><span class="op" id="6031408">(</span><span class="op" id="6031409">&amp;</span><span class="ident" id="6031410">ds</span><span class="op" id="6031412">,</span>&nbsp;<span class="ident" id="6031414">args</span><span class="op" id="6031418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6031421">if</span>&nbsp;<span class="ident" id="6031424">err</span>&nbsp;<span class="op" id="6031428">!=</span>&nbsp;<span class="builtintype" id="6031431">nil</span>&nbsp;<span class="op" id="6031435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6031439">return</span>&nbsp;<span class="builtintype" id="6031446">nil</span><span class="op" id="6031449">,</span>&nbsp;<span class="ident" id="6031451">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6031456">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6031460">ds</span><span class="op" id="6031462">.</span><span class="ident" id="6031463">Lock</span><span class="op" id="6031467">(</span><span class="op" id="6031468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6031471">resi</span><span class="op" id="6031475">,</span>&nbsp;<span class="ident" id="6031477">err</span>&nbsp;<span class="op" id="6031481">:=</span>&nbsp;<span class="ident" id="6031484">ds</span><span class="op" id="6031486">.</span><span class="ident" id="6031487">si</span><span class="op" id="6031489">.</span><span class="ident" id="6031490">Exec</span><span class="op" id="6031494">(</span><span class="ident" id="6031495">dargs</span><span class="op" id="6031500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6031503">ds</span><span class="op" id="6031505">.</span><span class="ident" id="6031506">Unlock</span><span class="op" id="6031512">(</span><span class="op" id="6031513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6031516">if</span>&nbsp;<span class="ident" id="6031519">err</span>&nbsp;<span class="op" id="6031523">!=</span>&nbsp;<span class="builtintype" id="6031526">nil</span>&nbsp;<span class="op" id="6031530">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6031534">return</span>&nbsp;<span class="builtintype" id="6031541">nil</span><span class="op" id="6031544">,</span>&nbsp;<span class="ident" id="6031546">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6031551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6031554">return</span>&nbsp;<span class="ident" id="6031561">driverResult</span><span class="op" id="6031573">{</span><span class="ident" id="6031574">ds</span><span class="op" id="6031576">.</span><span class="ident" id="6031577">Locker</span><span class="op" id="6031583">,</span>&nbsp;<span class="ident" id="6031585">resi</span><span class="op" id="6031589">}</span><span class="op" id="6031590">,</span>&nbsp;<span class="builtintype" id="6031592">nil</span><br>
<span class="lineno"></span><span class="op" id="6031596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1350</span><span class="comment" id="6031599">//&nbsp;connStmt&nbsp;returns&nbsp;a&nbsp;free&nbsp;driver&nbsp;connection&nbsp;on&nbsp;which&nbsp;to&nbsp;execute&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6031668">//&nbsp;statement,&nbsp;a&nbsp;function&nbsp;to&nbsp;call&nbsp;to&nbsp;release&nbsp;the&nbsp;connection,&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6031734">//&nbsp;statement&nbsp;bound&nbsp;to&nbsp;that&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6031773">func</span>&nbsp;<span class="op" id="6031778">(</span><span class="ident" id="6031779">s</span>&nbsp;<span class="op" id="6031781">*</span><span class="ident" id="6031782">Stmt</span><span class="op" id="6031786">)</span>&nbsp;<span class="ident" id="6031788">connStmt</span><span class="op" id="6031796">(</span><span class="op" id="6031797">)</span>&nbsp;<span class="op" id="6031799">(</span><span class="ident" id="6031800">ci</span>&nbsp;<span class="op" id="6031803">*</span><span class="ident" id="6031804">driverConn</span><span class="op" id="6031814">,</span>&nbsp;<span class="ident" id="6031816">releaseConn</span>&nbsp;<span class="keyword" id="6031828">func</span><span class="op" id="6031832">(</span><span class="builtintype" id="6031833">error</span><span class="op" id="6031838">)</span><span class="op" id="6031839">,</span>&nbsp;<span class="ident" id="6031841">si</span>&nbsp;<span class="ident" id="6031844">driver</span><span class="op" id="6031850">.</span><span class="ident" id="6031851">Stmt</span><span class="op" id="6031855">,</span>&nbsp;<span class="ident" id="6031857">err</span>&nbsp;<span class="builtintype" id="6031861">error</span><span class="op" id="6031866">)</span>&nbsp;<span class="op" id="6031868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6031871">if</span>&nbsp;<span class="ident" id="6031874">err</span>&nbsp;<span class="op" id="6031878">=</span>&nbsp;<span class="ident" id="6031880">s</span><span class="op" id="6031881">.</span><span class="ident" id="6031882">stickyErr</span><span class="op" id="6031891">;</span>&nbsp;<span class="ident" id="6031893">err</span>&nbsp;<span class="op" id="6031897">!=</span>&nbsp;<span class="builtintype" id="6031900">nil</span>&nbsp;<span class="op" id="6031904">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6031908">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6031916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6031919">s</span><span class="op" id="6031920">.</span><span class="ident" id="6031921">mu</span><span class="op" id="6031923">.</span><span class="ident" id="6031924">Lock</span><span class="op" id="6031928">(</span><span class="op" id="6031929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6031932">if</span>&nbsp;<span class="ident" id="6031935">s</span><span class="op" id="6031936">.</span><span class="ident" id="6031937">closed</span>&nbsp;<span class="op" id="6031944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6031948">s</span><span class="op" id="6031949">.</span><span class="ident" id="6031950">mu</span><span class="op" id="6031952">.</span><span class="ident" id="6031953">Unlock</span><span class="op" id="6031959">(</span><span class="op" id="6031960">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6031964">err</span>&nbsp;<span class="op" id="6031968">=</span>&nbsp;<span class="ident" id="6031970">errors</span><span class="op" id="6031976">.</span><span class="ident" id="6031977">New</span><span class="op" id="6031980">(</span><span class="string" id="6031981">&#34;sql:&nbsp;statement&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6032007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6032011">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6032019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6032023">//&nbsp;In&nbsp;a&nbsp;transaction,&nbsp;we&nbsp;always&nbsp;use&nbsp;the&nbsp;connection&nbsp;that&nbsp;the</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6032083">//&nbsp;transaction&nbsp;was&nbsp;created&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6032115">if</span>&nbsp;<span class="ident" id="6032118">s</span><span class="op" id="6032119">.</span><span class="ident" id="6032120">tx</span>&nbsp;<span class="op" id="6032123">!=</span>&nbsp;<span class="builtintype" id="6032126">nil</span>&nbsp;<span class="op" id="6032130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6032134">s</span><span class="op" id="6032135">.</span><span class="ident" id="6032136">mu</span><span class="op" id="6032138">.</span><span class="ident" id="6032139">Unlock</span><span class="op" id="6032145">(</span><span class="op" id="6032146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6032150">ci</span><span class="op" id="6032152">,</span>&nbsp;<span class="ident" id="6032154">err</span>&nbsp;<span class="op" id="6032158">=</span>&nbsp;<span class="ident" id="6032160">s</span><span class="op" id="6032161">.</span><span class="ident" id="6032162">tx</span><span class="op" id="6032164">.</span><span class="ident" id="6032165">grabConn</span><span class="op" id="6032173">(</span><span class="op" id="6032174">)</span>&nbsp;<span class="comment" id="6032176">//&nbsp;blocks,&nbsp;waiting&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6032217">if</span>&nbsp;<span class="ident" id="6032220">err</span>&nbsp;<span class="op" id="6032224">!=</span>&nbsp;<span class="builtintype" id="6032227">nil</span>&nbsp;<span class="op" id="6032231">{</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6032236">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6032245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6032249">releaseConn</span>&nbsp;<span class="op" id="6032261">=</span>&nbsp;<span class="keyword" id="6032263">func</span><span class="op" id="6032267">(</span><span class="builtintype" id="6032268">error</span><span class="op" id="6032273">)</span>&nbsp;<span class="op" id="6032275">{</span><span class="op" id="6032276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6032280">return</span>&nbsp;<span class="ident" id="6032287">ci</span><span class="op" id="6032289">,</span>&nbsp;<span class="ident" id="6032291">releaseConn</span><span class="op" id="6032302">,</span>&nbsp;<span class="ident" id="6032304">s</span><span class="op" id="6032305">.</span><span class="ident" id="6032306">txsi</span><span class="op" id="6032310">.</span><span class="ident" id="6032311">si</span><span class="op" id="6032313">,</span>&nbsp;<span class="builtintype" id="6032315">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6032320">}</span><br>
<span class="lineno">1375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6032324">for</span>&nbsp;<span class="ident" id="6032328">i</span>&nbsp;<span class="op" id="6032330">:=</span>&nbsp;<span class="num" id="6032333">0</span><span class="op" id="6032334">;</span>&nbsp;<span class="ident" id="6032336">i</span>&nbsp;<span class="op" id="6032338">&lt;</span>&nbsp;<span class="builtinfunc" id="6032340">len</span><span class="op" id="6032343">(</span><span class="ident" id="6032344">s</span><span class="op" id="6032345">.</span><span class="ident" id="6032346">css</span><span class="op" id="6032349">)</span><span class="op" id="6032350">;</span>&nbsp;<span class="ident" id="6032352">i</span><span class="op" id="6032353">++</span>&nbsp;<span class="op" id="6032356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6032360">v</span>&nbsp;<span class="op" id="6032362">:=</span>&nbsp;<span class="ident" id="6032365">s</span><span class="op" id="6032366">.</span><span class="ident" id="6032367">css</span><span class="op" id="6032370">[</span><span class="ident" id="6032371">i</span><span class="op" id="6032372">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6032376">_</span><span class="op" id="6032377">,</span>&nbsp;<span class="ident" id="6032379">err</span>&nbsp;<span class="op" id="6032383">:=</span>&nbsp;<span class="ident" id="6032386">s</span><span class="op" id="6032387">.</span><span class="ident" id="6032388">db</span><span class="op" id="6032390">.</span><span class="ident" id="6032391">connIfFree</span><span class="op" id="6032401">(</span><span class="ident" id="6032402">v</span><span class="op" id="6032403">.</span><span class="ident" id="6032404">dc</span><span class="op" id="6032406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6032410">if</span>&nbsp;<span class="ident" id="6032413">err</span>&nbsp;<span class="op" id="6032417">==</span>&nbsp;<span class="builtintype" id="6032420">nil</span>&nbsp;<span class="op" id="6032424">{</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6032429">s</span><span class="op" id="6032430">.</span><span class="ident" id="6032431">mu</span><span class="op" id="6032433">.</span><span class="ident" id="6032434">Unlock</span><span class="op" id="6032440">(</span><span class="op" id="6032441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6032446">return</span>&nbsp;<span class="ident" id="6032453">v</span><span class="op" id="6032454">.</span><span class="ident" id="6032455">dc</span><span class="op" id="6032457">,</span>&nbsp;<span class="ident" id="6032459">v</span><span class="op" id="6032460">.</span><span class="ident" id="6032461">dc</span><span class="op" id="6032463">.</span><span class="ident" id="6032464">releaseConn</span><span class="op" id="6032475">,</span>&nbsp;<span class="ident" id="6032477">v</span><span class="op" id="6032478">.</span><span class="ident" id="6032479">si</span><span class="op" id="6032481">,</span>&nbsp;<span class="builtintype" id="6032483">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6032489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6032493">if</span>&nbsp;<span class="ident" id="6032496">err</span>&nbsp;<span class="op" id="6032500">==</span>&nbsp;<span class="ident" id="6032503">errConnClosed</span>&nbsp;<span class="op" id="6032517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6032522">//&nbsp;Lazily&nbsp;remove&nbsp;dead&nbsp;conn&nbsp;from&nbsp;our&nbsp;freelist.</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6032571">s</span><span class="op" id="6032572">.</span><span class="ident" id="6032573">css</span><span class="op" id="6032576">[</span><span class="ident" id="6032577">i</span><span class="op" id="6032578">]</span>&nbsp;<span class="op" id="6032580">=</span>&nbsp;<span class="ident" id="6032582">s</span><span class="op" id="6032583">.</span><span class="ident" id="6032584">css</span><span class="op" id="6032587">[</span><span class="builtinfunc" id="6032588">len</span><span class="op" id="6032591">(</span><span class="ident" id="6032592">s</span><span class="op" id="6032593">.</span><span class="ident" id="6032594">css</span><span class="op" id="6032597">)</span><span class="op" id="6032598">-</span><span class="num" id="6032599">1</span><span class="op" id="6032600">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6032605">s</span><span class="op" id="6032606">.</span><span class="ident" id="6032607">css</span>&nbsp;<span class="op" id="6032611">=</span>&nbsp;<span class="ident" id="6032613">s</span><span class="op" id="6032614">.</span><span class="ident" id="6032615">css</span><span class="op" id="6032618">[</span><span class="op" id="6032619">:</span><span class="builtinfunc" id="6032620">len</span><span class="op" id="6032623">(</span><span class="ident" id="6032624">s</span><span class="op" id="6032625">.</span><span class="ident" id="6032626">css</span><span class="op" id="6032629">)</span><span class="op" id="6032630">-</span><span class="num" id="6032631">1</span><span class="op" id="6032632">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6032637">i</span><span class="op" id="6032638">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6032643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6032647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6032650">s</span><span class="op" id="6032651">.</span><span class="ident" id="6032652">mu</span><span class="op" id="6032654">.</span><span class="ident" id="6032655">Unlock</span><span class="op" id="6032661">(</span><span class="op" id="6032662">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6032666">//&nbsp;If&nbsp;all&nbsp;connections&nbsp;are&nbsp;busy,&nbsp;either&nbsp;wait&nbsp;for&nbsp;one&nbsp;to&nbsp;become&nbsp;available&nbsp;(if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6032743">//&nbsp;we&#39;ve&nbsp;already&nbsp;hit&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections)&nbsp;or&nbsp;create&nbsp;a</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6032817">//&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6032830">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6032834">//&nbsp;TODO(bradfitz):&nbsp;or&nbsp;always&nbsp;wait&nbsp;for&nbsp;one?&nbsp;make&nbsp;configurable&nbsp;later?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6032903">dc</span><span class="op" id="6032905">,</span>&nbsp;<span class="ident" id="6032907">err</span>&nbsp;<span class="op" id="6032911">:=</span>&nbsp;<span class="ident" id="6032914">s</span><span class="op" id="6032915">.</span><span class="ident" id="6032916">db</span><span class="op" id="6032918">.</span><span class="ident" id="6032919">conn</span><span class="op" id="6032923">(</span><span class="op" id="6032924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6032927">if</span>&nbsp;<span class="ident" id="6032930">err</span>&nbsp;<span class="op" id="6032934">!=</span>&nbsp;<span class="builtintype" id="6032937">nil</span>&nbsp;<span class="op" id="6032941">{</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6032945">return</span>&nbsp;<span class="builtintype" id="6032952">nil</span><span class="op" id="6032955">,</span>&nbsp;<span class="builtintype" id="6032957">nil</span><span class="op" id="6032960">,</span>&nbsp;<span class="builtintype" id="6032962">nil</span><span class="op" id="6032965">,</span>&nbsp;<span class="ident" id="6032967">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6032972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6032976">//&nbsp;Do&nbsp;another&nbsp;pass&nbsp;over&nbsp;the&nbsp;list&nbsp;to&nbsp;see&nbsp;whether&nbsp;this&nbsp;statement&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6033044">//&nbsp;already&nbsp;been&nbsp;prepared&nbsp;on&nbsp;the&nbsp;connection&nbsp;assigned&nbsp;to&nbsp;us.</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6033104">s</span><span class="op" id="6033105">.</span><span class="ident" id="6033106">mu</span><span class="op" id="6033108">.</span><span class="ident" id="6033109">Lock</span><span class="op" id="6033113">(</span><span class="op" id="6033114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6033117">for</span>&nbsp;<span class="ident" id="6033121">_</span><span class="op" id="6033122">,</span>&nbsp;<span class="ident" id="6033124">v</span>&nbsp;<span class="op" id="6033126">:=</span>&nbsp;<span class="keyword" id="6033129">range</span>&nbsp;<span class="ident" id="6033135">s</span><span class="op" id="6033136">.</span><span class="ident" id="6033137">css</span>&nbsp;<span class="op" id="6033141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6033145">if</span>&nbsp;<span class="ident" id="6033148">v</span><span class="op" id="6033149">.</span><span class="ident" id="6033150">dc</span>&nbsp;<span class="op" id="6033153">==</span>&nbsp;<span class="ident" id="6033156">dc</span>&nbsp;<span class="op" id="6033159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6033164">s</span><span class="op" id="6033165">.</span><span class="ident" id="6033166">mu</span><span class="op" id="6033168">.</span><span class="ident" id="6033169">Unlock</span><span class="op" id="6033175">(</span><span class="op" id="6033176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6033181">return</span>&nbsp;<span class="ident" id="6033188">dc</span><span class="op" id="6033190">,</span>&nbsp;<span class="ident" id="6033192">dc</span><span class="op" id="6033194">.</span><span class="ident" id="6033195">releaseConn</span><span class="op" id="6033206">,</span>&nbsp;<span class="ident" id="6033208">v</span><span class="op" id="6033209">.</span><span class="ident" id="6033210">si</span><span class="op" id="6033212">,</span>&nbsp;<span class="builtintype" id="6033214">nil</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6033220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6033223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6033226">s</span><span class="op" id="6033227">.</span><span class="ident" id="6033228">mu</span><span class="op" id="6033230">.</span><span class="ident" id="6033231">Unlock</span><span class="op" id="6033237">(</span><span class="op" id="6033238">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6033242">//&nbsp;No&nbsp;luck;&nbsp;we&nbsp;need&nbsp;to&nbsp;prepare&nbsp;the&nbsp;statement&nbsp;on&nbsp;this&nbsp;connection</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6033307">dc</span><span class="op" id="6033309">.</span><span class="ident" id="6033310">Lock</span><span class="op" id="6033314">(</span><span class="op" id="6033315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6033318">si</span><span class="op" id="6033320">,</span>&nbsp;<span class="ident" id="6033322">err</span>&nbsp;<span class="op" id="6033326">=</span>&nbsp;<span class="ident" id="6033328">dc</span><span class="op" id="6033330">.</span><span class="ident" id="6033331">prepareLocked</span><span class="op" id="6033344">(</span><span class="ident" id="6033345">s</span><span class="op" id="6033346">.</span><span class="ident" id="6033347">query</span><span class="op" id="6033352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6033355">dc</span><span class="op" id="6033357">.</span><span class="ident" id="6033358">Unlock</span><span class="op" id="6033364">(</span><span class="op" id="6033365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6033368">if</span>&nbsp;<span class="ident" id="6033371">err</span>&nbsp;<span class="op" id="6033375">!=</span>&nbsp;<span class="builtintype" id="6033378">nil</span>&nbsp;<span class="op" id="6033382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6033386">s</span><span class="op" id="6033387">.</span><span class="ident" id="6033388">db</span><span class="op" id="6033390">.</span><span class="ident" id="6033391">putConn</span><span class="op" id="6033398">(</span><span class="ident" id="6033399">dc</span><span class="op" id="6033401">,</span>&nbsp;<span class="ident" id="6033403">err</span><span class="op" id="6033406">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6033410">return</span>&nbsp;<span class="builtintype" id="6033417">nil</span><span class="op" id="6033420">,</span>&nbsp;<span class="builtintype" id="6033422">nil</span><span class="op" id="6033425">,</span>&nbsp;<span class="builtintype" id="6033427">nil</span><span class="op" id="6033430">,</span>&nbsp;<span class="ident" id="6033432">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6033437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6033440">s</span><span class="op" id="6033441">.</span><span class="ident" id="6033442">mu</span><span class="op" id="6033444">.</span><span class="ident" id="6033445">Lock</span><span class="op" id="6033449">(</span><span class="op" id="6033450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6033453">cs</span>&nbsp;<span class="op" id="6033456">:=</span>&nbsp;<span class="ident" id="6033459">connStmt</span><span class="op" id="6033467">{</span><span class="ident" id="6033468">dc</span><span class="op" id="6033470">,</span>&nbsp;<span class="ident" id="6033472">si</span><span class="op" id="6033474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6033477">s</span><span class="op" id="6033478">.</span><span class="ident" id="6033479">css</span>&nbsp;<span class="op" id="6033483">=</span>&nbsp;<span class="builtinfunc" id="6033485">append</span><span class="op" id="6033491">(</span><span class="ident" id="6033492">s</span><span class="op" id="6033493">.</span><span class="ident" id="6033494">css</span><span class="op" id="6033497">,</span>&nbsp;<span class="ident" id="6033499">cs</span><span class="op" id="6033501">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6033504">s</span><span class="op" id="6033505">.</span><span class="ident" id="6033506">mu</span><span class="op" id="6033508">.</span><span class="ident" id="6033509">Unlock</span><span class="op" id="6033515">(</span><span class="op" id="6033516">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6033520">return</span>&nbsp;<span class="ident" id="6033527">dc</span><span class="op" id="6033529">,</span>&nbsp;<span class="ident" id="6033531">dc</span><span class="op" id="6033533">.</span><span class="ident" id="6033534">releaseConn</span><span class="op" id="6033545">,</span>&nbsp;<span class="ident" id="6033547">si</span><span class="op" id="6033549">,</span>&nbsp;<span class="builtintype" id="6033551">nil</span><br>
<span class="lineno"></span><span class="op" id="6033555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1430</span><span class="comment" id="6033558">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments</span><br>
<span class="lineno"></span><span class="comment" id="6033628">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;query&nbsp;results&nbsp;as&nbsp;a&nbsp;*Rows.</span><br>
<span class="lineno"></span><span class="keyword" id="6033673">func</span>&nbsp;<span class="op" id="6033678">(</span><span class="ident" id="6033679">s</span>&nbsp;<span class="op" id="6033681">*</span><span class="ident" id="6033682">Stmt</span><span class="op" id="6033686">)</span>&nbsp;<span class="ident" id="6033688">Query</span><span class="op" id="6033693">(</span><span class="ident" id="6033694">args</span>&nbsp;<span class="op" id="6033699">...</span><span class="keyword" id="6033702">interface</span><span class="op" id="6033711">{</span><span class="op" id="6033712">}</span><span class="op" id="6033713">)</span>&nbsp;<span class="op" id="6033715">(</span><span class="op" id="6033716">*</span><span class="ident" id="6033717">Rows</span><span class="op" id="6033721">,</span>&nbsp;<span class="builtintype" id="6033723">error</span><span class="op" id="6033728">)</span>&nbsp;<span class="op" id="6033730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6033733">s</span><span class="op" id="6033734">.</span><span class="ident" id="6033735">closemu</span><span class="op" id="6033742">.</span><span class="ident" id="6033743">RLock</span><span class="op" id="6033748">(</span><span class="op" id="6033749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6033752">defer</span>&nbsp;<span class="ident" id="6033758">s</span><span class="op" id="6033759">.</span><span class="ident" id="6033760">closemu</span><span class="op" id="6033767">.</span><span class="ident" id="6033768">RUnlock</span><span class="op" id="6033775">(</span><span class="op" id="6033776">)</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6033780">var</span>&nbsp;<span class="ident" id="6033784">rowsi</span>&nbsp;<span class="ident" id="6033790">driver</span><span class="op" id="6033796">.</span><span class="ident" id="6033797">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6033803">for</span>&nbsp;<span class="ident" id="6033807">i</span>&nbsp;<span class="op" id="6033809">:=</span>&nbsp;<span class="num" id="6033812">0</span><span class="op" id="6033813">;</span>&nbsp;<span class="ident" id="6033815">i</span>&nbsp;<span class="op" id="6033817">&lt;</span>&nbsp;<span class="ident" id="6033819">maxBadConnRetries</span><span class="op" id="6033836">;</span>&nbsp;<span class="ident" id="6033838">i</span><span class="op" id="6033839">++</span>&nbsp;<span class="op" id="6033842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6033846">dc</span><span class="op" id="6033848">,</span>&nbsp;<span class="ident" id="6033850">releaseConn</span><span class="op" id="6033861">,</span>&nbsp;<span class="ident" id="6033863">si</span><span class="op" id="6033865">,</span>&nbsp;<span class="ident" id="6033867">err</span>&nbsp;<span class="op" id="6033871">:=</span>&nbsp;<span class="ident" id="6033874">s</span><span class="op" id="6033875">.</span><span class="ident" id="6033876">connStmt</span><span class="op" id="6033884">(</span><span class="op" id="6033885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6033889">if</span>&nbsp;<span class="ident" id="6033892">err</span>&nbsp;<span class="op" id="6033896">!=</span>&nbsp;<span class="builtintype" id="6033899">nil</span>&nbsp;<span class="op" id="6033903">{</span><br>
<span class="lineno">1440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6033908">if</span>&nbsp;<span class="ident" id="6033911">err</span>&nbsp;<span class="op" id="6033915">==</span>&nbsp;<span class="ident" id="6033918">driver</span><span class="op" id="6033924">.</span><span class="ident" id="6033925">ErrBadConn</span>&nbsp;<span class="op" id="6033936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6033942">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6033954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6033959">return</span>&nbsp;<span class="builtintype" id="6033966">nil</span><span class="op" id="6033969">,</span>&nbsp;<span class="ident" id="6033971">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6033977">}</span><br>
<span class="lineno">1445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6033982">rowsi</span><span class="op" id="6033987">,</span>&nbsp;<span class="ident" id="6033989">err</span>&nbsp;<span class="op" id="6033993">=</span>&nbsp;<span class="ident" id="6033995">rowsiFromStatement</span><span class="op" id="6034013">(</span><span class="ident" id="6034014">driverStmt</span><span class="op" id="6034024">{</span><span class="ident" id="6034025">dc</span><span class="op" id="6034027">,</span>&nbsp;<span class="ident" id="6034029">si</span><span class="op" id="6034031">}</span><span class="op" id="6034032">,</span>&nbsp;<span class="ident" id="6034034">args</span><span class="op" id="6034038">...</span><span class="op" id="6034041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6034045">if</span>&nbsp;<span class="ident" id="6034048">err</span>&nbsp;<span class="op" id="6034052">==</span>&nbsp;<span class="builtintype" id="6034055">nil</span>&nbsp;<span class="op" id="6034059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6034064">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6034125">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6034149">rows</span>&nbsp;<span class="op" id="6034154">:=</span>&nbsp;<span class="op" id="6034157">&amp;</span><span class="ident" id="6034158">Rows</span><span class="op" id="6034162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6034168">dc</span><span class="op" id="6034170">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6034175">dc</span><span class="op" id="6034177">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6034183">rowsi</span><span class="op" id="6034188">:</span>&nbsp;<span class="ident" id="6034190">rowsi</span><span class="op" id="6034195">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6034201">//&nbsp;releaseConn&nbsp;set&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6034229">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6034234">s</span><span class="op" id="6034235">.</span><span class="ident" id="6034236">db</span><span class="op" id="6034238">.</span><span class="ident" id="6034239">addDep</span><span class="op" id="6034245">(</span><span class="ident" id="6034246">s</span><span class="op" id="6034247">,</span>&nbsp;<span class="ident" id="6034249">rows</span><span class="op" id="6034253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6034258">rows</span><span class="op" id="6034262">.</span><span class="ident" id="6034263">releaseConn</span>&nbsp;<span class="op" id="6034275">=</span>&nbsp;<span class="keyword" id="6034277">func</span><span class="op" id="6034281">(</span><span class="ident" id="6034282">err</span>&nbsp;<span class="builtintype" id="6034286">error</span><span class="op" id="6034291">)</span>&nbsp;<span class="op" id="6034293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6034299">releaseConn</span><span class="op" id="6034310">(</span><span class="ident" id="6034311">err</span><span class="op" id="6034314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6034320">s</span><span class="op" id="6034321">.</span><span class="ident" id="6034322">db</span><span class="op" id="6034324">.</span><span class="ident" id="6034325">removeDep</span><span class="op" id="6034334">(</span><span class="ident" id="6034335">s</span><span class="op" id="6034336">,</span>&nbsp;<span class="ident" id="6034338">rows</span><span class="op" id="6034342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6034347">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6034352">return</span>&nbsp;<span class="ident" id="6034359">rows</span><span class="op" id="6034363">,</span>&nbsp;<span class="builtintype" id="6034365">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6034371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6034376">releaseConn</span><span class="op" id="6034387">(</span><span class="ident" id="6034388">err</span><span class="op" id="6034391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6034395">if</span>&nbsp;<span class="ident" id="6034398">err</span>&nbsp;<span class="op" id="6034402">!=</span>&nbsp;<span class="ident" id="6034405">driver</span><span class="op" id="6034411">.</span><span class="ident" id="6034412">ErrBadConn</span>&nbsp;<span class="op" id="6034423">{</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6034428">return</span>&nbsp;<span class="builtintype" id="6034435">nil</span><span class="op" id="6034438">,</span>&nbsp;<span class="ident" id="6034440">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6034446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6034449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6034452">return</span>&nbsp;<span class="builtintype" id="6034459">nil</span><span class="op" id="6034462">,</span>&nbsp;<span class="ident" id="6034464">driver</span><span class="op" id="6034470">.</span><span class="ident" id="6034471">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="6034482">}</span><br>
<span class="lineno">1470</span><br>
<span class="lineno"></span><span class="keyword" id="6034485">func</span>&nbsp;<span class="ident" id="6034490">rowsiFromStatement</span><span class="op" id="6034508">(</span><span class="ident" id="6034509">ds</span>&nbsp;<span class="ident" id="6034512">driverStmt</span><span class="op" id="6034522">,</span>&nbsp;<span class="ident" id="6034524">args</span>&nbsp;<span class="op" id="6034529">...</span><span class="keyword" id="6034532">interface</span><span class="op" id="6034541">{</span><span class="op" id="6034542">}</span><span class="op" id="6034543">)</span>&nbsp;<span class="op" id="6034545">(</span><span class="ident" id="6034546">driver</span><span class="op" id="6034552">.</span><span class="ident" id="6034553">Rows</span><span class="op" id="6034557">,</span>&nbsp;<span class="builtintype" id="6034559">error</span><span class="op" id="6034564">)</span>&nbsp;<span class="op" id="6034566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6034569">ds</span><span class="op" id="6034571">.</span><span class="ident" id="6034572">Lock</span><span class="op" id="6034576">(</span><span class="op" id="6034577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6034580">want</span>&nbsp;<span class="op" id="6034585">:=</span>&nbsp;<span class="ident" id="6034588">ds</span><span class="op" id="6034590">.</span><span class="ident" id="6034591">si</span><span class="op" id="6034593">.</span><span class="ident" id="6034594">NumInput</span><span class="op" id="6034602">(</span><span class="op" id="6034603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6034606">ds</span><span class="op" id="6034608">.</span><span class="ident" id="6034609">Unlock</span><span class="op" id="6034615">(</span><span class="op" id="6034616">)</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6034620">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6034684">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6034758">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6034787">if</span>&nbsp;<span class="ident" id="6034790">want</span>&nbsp;<span class="op" id="6034795">!=</span>&nbsp;<span class="op" id="6034798">-</span><span class="num" id="6034799">1</span>&nbsp;<span class="op" id="6034801">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6034804">len</span><span class="op" id="6034807">(</span><span class="ident" id="6034808">args</span><span class="op" id="6034812">)</span>&nbsp;<span class="op" id="6034814">!=</span>&nbsp;<span class="ident" id="6034817">want</span>&nbsp;<span class="op" id="6034822">{</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6034826">return</span>&nbsp;<span class="builtintype" id="6034833">nil</span><span class="op" id="6034836">,</span>&nbsp;<span class="ident" id="6034838">fmt</span><span class="op" id="6034841">.</span><span class="ident" id="6034842">Errorf</span><span class="op" id="6034848">(</span><span class="string" id="6034849">&#34;sql:&nbsp;statement&nbsp;expects&nbsp;%d&nbsp;inputs;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6034891">,</span>&nbsp;<span class="ident" id="6034893">want</span><span class="op" id="6034897">,</span>&nbsp;<span class="builtinfunc" id="6034899">len</span><span class="op" id="6034902">(</span><span class="ident" id="6034903">args</span><span class="op" id="6034907">)</span><span class="op" id="6034908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6034911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6034915">dargs</span><span class="op" id="6034920">,</span>&nbsp;<span class="ident" id="6034922">err</span>&nbsp;<span class="op" id="6034926">:=</span>&nbsp;<span class="ident" id="6034929">driverArgs</span><span class="op" id="6034939">(</span><span class="op" id="6034940">&amp;</span><span class="ident" id="6034941">ds</span><span class="op" id="6034943">,</span>&nbsp;<span class="ident" id="6034945">args</span><span class="op" id="6034949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6034952">if</span>&nbsp;<span class="ident" id="6034955">err</span>&nbsp;<span class="op" id="6034959">!=</span>&nbsp;<span class="builtintype" id="6034962">nil</span>&nbsp;<span class="op" id="6034966">{</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6034970">return</span>&nbsp;<span class="builtintype" id="6034977">nil</span><span class="op" id="6034980">,</span>&nbsp;<span class="ident" id="6034982">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6034987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6034991">ds</span><span class="op" id="6034993">.</span><span class="ident" id="6034994">Lock</span><span class="op" id="6034998">(</span><span class="op" id="6034999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6035002">rowsi</span><span class="op" id="6035007">,</span>&nbsp;<span class="ident" id="6035009">err</span>&nbsp;<span class="op" id="6035013">:=</span>&nbsp;<span class="ident" id="6035016">ds</span><span class="op" id="6035018">.</span><span class="ident" id="6035019">si</span><span class="op" id="6035021">.</span><span class="ident" id="6035022">Query</span><span class="op" id="6035027">(</span><span class="ident" id="6035028">dargs</span><span class="op" id="6035033">)</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6035036">ds</span><span class="op" id="6035038">.</span><span class="ident" id="6035039">Unlock</span><span class="op" id="6035045">(</span><span class="op" id="6035046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6035049">if</span>&nbsp;<span class="ident" id="6035052">err</span>&nbsp;<span class="op" id="6035056">!=</span>&nbsp;<span class="builtintype" id="6035059">nil</span>&nbsp;<span class="op" id="6035063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6035067">return</span>&nbsp;<span class="builtintype" id="6035074">nil</span><span class="op" id="6035077">,</span>&nbsp;<span class="ident" id="6035079">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6035084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6035087">return</span>&nbsp;<span class="ident" id="6035094">rowsi</span><span class="op" id="6035099">,</span>&nbsp;<span class="builtintype" id="6035101">nil</span><br>
<span class="lineno">1495</span><span class="op" id="6035105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6035108">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="6035182">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;during&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;statement,&nbsp;that&nbsp;error&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="6035259">//&nbsp;be&nbsp;returned&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Scan&nbsp;on&nbsp;the&nbsp;returned&nbsp;*Row,&nbsp;which&nbsp;is&nbsp;always&nbsp;non-nil.</span><br>
<span class="lineno">1500</span><span class="comment" id="6035339">//&nbsp;If&nbsp;the&nbsp;query&nbsp;selects&nbsp;no&nbsp;rows,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;will&nbsp;return&nbsp;ErrNoRows.</span><br>
<span class="lineno"></span><span class="comment" id="6035411">//&nbsp;Otherwise,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;scans&nbsp;the&nbsp;first&nbsp;selected&nbsp;row&nbsp;and&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="6035483">//&nbsp;the&nbsp;rest.</span><br>
<span class="lineno"></span><span class="comment" id="6035496">//</span><br>
<span class="lineno"></span><span class="comment" id="6035499">//&nbsp;Example&nbsp;usage:</span><br>
<span class="lineno">1505</span><span class="comment" id="6035517">//</span><br>
<span class="lineno"></span><span class="comment" id="6035520">//&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="6035540">//&nbsp;&nbsp;err&nbsp;:=&nbsp;nameByUseridStmt.QueryRow(id).Scan(&amp;name)</span><br>
<span class="lineno"></span><span class="keyword" id="6035593">func</span>&nbsp;<span class="op" id="6035598">(</span><span class="ident" id="6035599">s</span>&nbsp;<span class="op" id="6035601">*</span><span class="ident" id="6035602">Stmt</span><span class="op" id="6035606">)</span>&nbsp;<span class="ident" id="6035608">QueryRow</span><span class="op" id="6035616">(</span><span class="ident" id="6035617">args</span>&nbsp;<span class="op" id="6035622">...</span><span class="keyword" id="6035625">interface</span><span class="op" id="6035634">{</span><span class="op" id="6035635">}</span><span class="op" id="6035636">)</span>&nbsp;<span class="op" id="6035638">*</span><span class="ident" id="6035639">Row</span>&nbsp;<span class="op" id="6035643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6035646">rows</span><span class="op" id="6035650">,</span>&nbsp;<span class="ident" id="6035652">err</span>&nbsp;<span class="op" id="6035656">:=</span>&nbsp;<span class="ident" id="6035659">s</span><span class="op" id="6035660">.</span><span class="ident" id="6035661">Query</span><span class="op" id="6035666">(</span><span class="ident" id="6035667">args</span><span class="op" id="6035671">...</span><span class="op" id="6035674">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6035677">if</span>&nbsp;<span class="ident" id="6035680">err</span>&nbsp;<span class="op" id="6035684">!=</span>&nbsp;<span class="builtintype" id="6035687">nil</span>&nbsp;<span class="op" id="6035691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6035695">return</span>&nbsp;<span class="op" id="6035702">&amp;</span><span class="ident" id="6035703">Row</span><span class="op" id="6035706">{</span><span class="ident" id="6035707">err</span><span class="op" id="6035710">:</span>&nbsp;<span class="ident" id="6035712">err</span><span class="op" id="6035715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6035718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6035721">return</span>&nbsp;<span class="op" id="6035728">&amp;</span><span class="ident" id="6035729">Row</span><span class="op" id="6035732">{</span><span class="ident" id="6035733">rows</span><span class="op" id="6035737">:</span>&nbsp;<span class="ident" id="6035739">rows</span><span class="op" id="6035743">}</span><br>
<span class="lineno"></span><span class="op" id="6035745">}</span><br>
<span class="lineno">1515</span><br>
<span class="lineno"></span><span class="comment" id="6035748">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6035779">func</span>&nbsp;<span class="op" id="6035784">(</span><span class="ident" id="6035785">s</span>&nbsp;<span class="op" id="6035787">*</span><span class="ident" id="6035788">Stmt</span><span class="op" id="6035792">)</span>&nbsp;<span class="ident" id="6035794">Close</span><span class="op" id="6035799">(</span><span class="op" id="6035800">)</span>&nbsp;<span class="builtintype" id="6035802">error</span>&nbsp;<span class="op" id="6035808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6035811">s</span><span class="op" id="6035812">.</span><span class="ident" id="6035813">closemu</span><span class="op" id="6035820">.</span><span class="ident" id="6035821">Lock</span><span class="op" id="6035825">(</span><span class="op" id="6035826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6035829">defer</span>&nbsp;<span class="ident" id="6035835">s</span><span class="op" id="6035836">.</span><span class="ident" id="6035837">closemu</span><span class="op" id="6035844">.</span><span class="ident" id="6035845">Unlock</span><span class="op" id="6035851">(</span><span class="op" id="6035852">)</span><br>
<span class="lineno">1520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6035856">if</span>&nbsp;<span class="ident" id="6035859">s</span><span class="op" id="6035860">.</span><span class="ident" id="6035861">stickyErr</span>&nbsp;<span class="op" id="6035871">!=</span>&nbsp;<span class="builtintype" id="6035874">nil</span>&nbsp;<span class="op" id="6035878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6035882">return</span>&nbsp;<span class="ident" id="6035889">s</span><span class="op" id="6035890">.</span><span class="ident" id="6035891">stickyErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6035902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6035905">s</span><span class="op" id="6035906">.</span><span class="ident" id="6035907">mu</span><span class="op" id="6035909">.</span><span class="ident" id="6035910">Lock</span><span class="op" id="6035914">(</span><span class="op" id="6035915">)</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6035918">if</span>&nbsp;<span class="ident" id="6035921">s</span><span class="op" id="6035922">.</span><span class="ident" id="6035923">closed</span>&nbsp;<span class="op" id="6035930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6035934">s</span><span class="op" id="6035935">.</span><span class="ident" id="6035936">mu</span><span class="op" id="6035938">.</span><span class="ident" id="6035939">Unlock</span><span class="op" id="6035945">(</span><span class="op" id="6035946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6035950">return</span>&nbsp;<span class="builtintype" id="6035957">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6035962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6035965">s</span><span class="op" id="6035966">.</span><span class="ident" id="6035967">closed</span>&nbsp;<span class="op" id="6035974">=</span>&nbsp;<span class="builtintype" id="6035976">true</span><br>
<span class="lineno">1530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6035983">if</span>&nbsp;<span class="ident" id="6035986">s</span><span class="op" id="6035987">.</span><span class="ident" id="6035988">tx</span>&nbsp;<span class="op" id="6035991">!=</span>&nbsp;<span class="builtintype" id="6035994">nil</span>&nbsp;<span class="op" id="6035998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6036002">s</span><span class="op" id="6036003">.</span><span class="ident" id="6036004">txsi</span><span class="op" id="6036008">.</span><span class="ident" id="6036009">Close</span><span class="op" id="6036014">(</span><span class="op" id="6036015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6036019">s</span><span class="op" id="6036020">.</span><span class="ident" id="6036021">mu</span><span class="op" id="6036023">.</span><span class="ident" id="6036024">Unlock</span><span class="op" id="6036030">(</span><span class="op" id="6036031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6036035">return</span>&nbsp;<span class="builtintype" id="6036042">nil</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6036047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6036050">s</span><span class="op" id="6036051">.</span><span class="ident" id="6036052">mu</span><span class="op" id="6036054">.</span><span class="ident" id="6036055">Unlock</span><span class="op" id="6036061">(</span><span class="op" id="6036062">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6036066">return</span>&nbsp;<span class="ident" id="6036073">s</span><span class="op" id="6036074">.</span><span class="ident" id="6036075">db</span><span class="op" id="6036077">.</span><span class="ident" id="6036078">removeDep</span><span class="op" id="6036087">(</span><span class="ident" id="6036088">s</span><span class="op" id="6036089">,</span>&nbsp;<span class="ident" id="6036091">s</span><span class="op" id="6036092">)</span><br>
<span class="lineno"></span><span class="op" id="6036094">}</span><br>
<span class="lineno">1540</span><br>
<span class="lineno"></span><span class="keyword" id="6036097">func</span>&nbsp;<span class="op" id="6036102">(</span><span class="ident" id="6036103">s</span>&nbsp;<span class="op" id="6036105">*</span><span class="ident" id="6036106">Stmt</span><span class="op" id="6036110">)</span>&nbsp;<span class="ident" id="6036112">finalClose</span><span class="op" id="6036122">(</span><span class="op" id="6036123">)</span>&nbsp;<span class="builtintype" id="6036125">error</span>&nbsp;<span class="op" id="6036131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6036134">s</span><span class="op" id="6036135">.</span><span class="ident" id="6036136">mu</span><span class="op" id="6036138">.</span><span class="ident" id="6036139">Lock</span><span class="op" id="6036143">(</span><span class="op" id="6036144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6036147">defer</span>&nbsp;<span class="ident" id="6036153">s</span><span class="op" id="6036154">.</span><span class="ident" id="6036155">mu</span><span class="op" id="6036157">.</span><span class="ident" id="6036158">Unlock</span><span class="op" id="6036164">(</span><span class="op" id="6036165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6036168">if</span>&nbsp;<span class="ident" id="6036171">s</span><span class="op" id="6036172">.</span><span class="ident" id="6036173">css</span>&nbsp;<span class="op" id="6036177">!=</span>&nbsp;<span class="builtintype" id="6036180">nil</span>&nbsp;<span class="op" id="6036184">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6036188">for</span>&nbsp;<span class="ident" id="6036192">_</span><span class="op" id="6036193">,</span>&nbsp;<span class="ident" id="6036195">v</span>&nbsp;<span class="op" id="6036197">:=</span>&nbsp;<span class="keyword" id="6036200">range</span>&nbsp;<span class="ident" id="6036206">s</span><span class="op" id="6036207">.</span><span class="ident" id="6036208">css</span>&nbsp;<span class="op" id="6036212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6036217">s</span><span class="op" id="6036218">.</span><span class="ident" id="6036219">db</span><span class="op" id="6036221">.</span><span class="ident" id="6036222">noteUnusedDriverStatement</span><span class="op" id="6036247">(</span><span class="ident" id="6036248">v</span><span class="op" id="6036249">.</span><span class="ident" id="6036250">dc</span><span class="op" id="6036252">,</span>&nbsp;<span class="ident" id="6036254">v</span><span class="op" id="6036255">.</span><span class="ident" id="6036256">si</span><span class="op" id="6036258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6036263">v</span><span class="op" id="6036264">.</span><span class="ident" id="6036265">dc</span><span class="op" id="6036267">.</span><span class="ident" id="6036268">removeOpenStmt</span><span class="op" id="6036282">(</span><span class="ident" id="6036283">v</span><span class="op" id="6036284">.</span><span class="ident" id="6036285">si</span><span class="op" id="6036287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6036291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6036295">s</span><span class="op" id="6036296">.</span><span class="ident" id="6036297">css</span>&nbsp;<span class="op" id="6036301">=</span>&nbsp;<span class="builtintype" id="6036303">nil</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6036308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6036311">return</span>&nbsp;<span class="builtintype" id="6036318">nil</span><br>
<span class="lineno"></span><span class="op" id="6036322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6036325">//&nbsp;Rows&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;query.&nbsp;Its&nbsp;cursor&nbsp;starts&nbsp;before&nbsp;the&nbsp;first&nbsp;row</span><br>
<span class="lineno">1555</span><span class="comment" id="6036398">//&nbsp;of&nbsp;the&nbsp;result&nbsp;set.&nbsp;Use&nbsp;Next&nbsp;to&nbsp;advance&nbsp;through&nbsp;the&nbsp;rows:</span><br>
<span class="lineno"></span><span class="comment" id="6036458">//</span><br>
<span class="lineno"></span><span class="comment" id="6036461">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rows,&nbsp;err&nbsp;:=&nbsp;db.Query(&#34;SELECT&nbsp;...&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="6036504">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6036515">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defer&nbsp;rows.Close()</span><br>
<span class="lineno">1560</span><span class="comment" id="6036541">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;rows.Next()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="6036566">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;id&nbsp;int</span><br>
<span class="lineno"></span><span class="comment" id="6036588">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="6036615">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Scan(&amp;id,&nbsp;&amp;name)</span><br>
<span class="lineno"></span><span class="comment" id="6036654">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno">1565</span><span class="comment" id="6036669">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="6036678">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Err()&nbsp;//&nbsp;get&nbsp;any&nbsp;error&nbsp;encountered&nbsp;during&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="6036748">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="keyword" id="6036759">type</span>&nbsp;<span class="ident" id="6036764">Rows</span>&nbsp;<span class="keyword" id="6036769">struct</span>&nbsp;<span class="op" id="6036776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6036779">dc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6036791">*</span><span class="ident" id="6036792">driverConn</span>&nbsp;<span class="comment" id="6036803">//&nbsp;owned;&nbsp;must&nbsp;call&nbsp;releaseConn&nbsp;when&nbsp;closed&nbsp;to&nbsp;release</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6036859">releaseConn</span>&nbsp;<span class="keyword" id="6036871">func</span><span class="op" id="6036875">(</span><span class="builtintype" id="6036876">error</span><span class="op" id="6036881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6036884">rowsi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6036896">driver</span><span class="op" id="6036902">.</span><span class="ident" id="6036903">Rows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6036910">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6036920">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6036926">lastcols</span>&nbsp;&nbsp;<span class="op" id="6036936">[</span><span class="op" id="6036937">]</span><span class="ident" id="6036938">driver</span><span class="op" id="6036944">.</span><span class="ident" id="6036945">Value</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6036952">lasterr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6036962">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6036974">//&nbsp;non-nil&nbsp;only&nbsp;if&nbsp;closed&nbsp;is&nbsp;true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6037009">closeStmt</span>&nbsp;<span class="ident" id="6037019">driver</span><span class="op" id="6037025">.</span><span class="ident" id="6037026">Stmt</span>&nbsp;<span class="comment" id="6037031">//&nbsp;if&nbsp;non-nil,&nbsp;statement&nbsp;to&nbsp;Close&nbsp;on&nbsp;close</span><br>
<span class="lineno"></span><span class="op" id="6037074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6037077">//&nbsp;Next&nbsp;prepares&nbsp;the&nbsp;next&nbsp;result&nbsp;row&nbsp;for&nbsp;reading&nbsp;with&nbsp;the&nbsp;Scan&nbsp;method.&nbsp;&nbsp;It</span><br>
<span class="lineno">1580</span><span class="comment" id="6037152">//&nbsp;returns&nbsp;true&nbsp;on&nbsp;success,&nbsp;or&nbsp;false&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;next&nbsp;result&nbsp;row&nbsp;or&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="6037232">//&nbsp;happened&nbsp;while&nbsp;preparing&nbsp;it.&nbsp;&nbsp;Err&nbsp;should&nbsp;be&nbsp;consulted&nbsp;to&nbsp;distinguish&nbsp;between</span><br>
<span class="lineno"></span><span class="comment" id="6037312">//&nbsp;the&nbsp;two&nbsp;cases.</span><br>
<span class="lineno"></span><span class="comment" id="6037330">//</span><br>
<span class="lineno"></span><span class="comment" id="6037333">//&nbsp;Every&nbsp;call&nbsp;to&nbsp;Scan,&nbsp;even&nbsp;the&nbsp;first&nbsp;one,&nbsp;must&nbsp;be&nbsp;preceded&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Next.</span><br>
<span class="lineno">1585</span><span class="keyword" id="6037412">func</span>&nbsp;<span class="op" id="6037417">(</span><span class="ident" id="6037418">rs</span>&nbsp;<span class="op" id="6037421">*</span><span class="ident" id="6037422">Rows</span><span class="op" id="6037426">)</span>&nbsp;<span class="ident" id="6037428">Next</span><span class="op" id="6037432">(</span><span class="op" id="6037433">)</span>&nbsp;<span class="builtintype" id="6037435">bool</span>&nbsp;<span class="op" id="6037440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6037443">if</span>&nbsp;<span class="ident" id="6037446">rs</span><span class="op" id="6037448">.</span><span class="ident" id="6037449">closed</span>&nbsp;<span class="op" id="6037456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6037460">return</span>&nbsp;<span class="builtintype" id="6037467">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6037474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6037477">if</span>&nbsp;<span class="ident" id="6037480">rs</span><span class="op" id="6037482">.</span><span class="ident" id="6037483">lastcols</span>&nbsp;<span class="op" id="6037492">==</span>&nbsp;<span class="builtintype" id="6037495">nil</span>&nbsp;<span class="op" id="6037499">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6037503">rs</span><span class="op" id="6037505">.</span><span class="ident" id="6037506">lastcols</span>&nbsp;<span class="op" id="6037515">=</span>&nbsp;<span class="builtinfunc" id="6037517">make</span><span class="op" id="6037521">(</span><span class="op" id="6037522">[</span><span class="op" id="6037523">]</span><span class="ident" id="6037524">driver</span><span class="op" id="6037530">.</span><span class="ident" id="6037531">Value</span><span class="op" id="6037536">,</span>&nbsp;<span class="builtinfunc" id="6037538">len</span><span class="op" id="6037541">(</span><span class="ident" id="6037542">rs</span><span class="op" id="6037544">.</span><span class="ident" id="6037545">rowsi</span><span class="op" id="6037550">.</span><span class="ident" id="6037551">Columns</span><span class="op" id="6037558">(</span><span class="op" id="6037559">)</span><span class="op" id="6037560">)</span><span class="op" id="6037561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6037564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6037567">rs</span><span class="op" id="6037569">.</span><span class="ident" id="6037570">lasterr</span>&nbsp;<span class="op" id="6037578">=</span>&nbsp;<span class="ident" id="6037580">rs</span><span class="op" id="6037582">.</span><span class="ident" id="6037583">rowsi</span><span class="op" id="6037588">.</span><span class="ident" id="6037589">Next</span><span class="op" id="6037593">(</span><span class="ident" id="6037594">rs</span><span class="op" id="6037596">.</span><span class="ident" id="6037597">lastcols</span><span class="op" id="6037605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6037608">if</span>&nbsp;<span class="ident" id="6037611">rs</span><span class="op" id="6037613">.</span><span class="ident" id="6037614">lasterr</span>&nbsp;<span class="op" id="6037622">!=</span>&nbsp;<span class="builtintype" id="6037625">nil</span>&nbsp;<span class="op" id="6037629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6037633">rs</span><span class="op" id="6037635">.</span><span class="ident" id="6037636">Close</span><span class="op" id="6037641">(</span><span class="op" id="6037642">)</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6037646">return</span>&nbsp;<span class="builtintype" id="6037653">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6037660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6037663">return</span>&nbsp;<span class="builtintype" id="6037670">true</span><br>
<span class="lineno"></span><span class="op" id="6037675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="6037678">//&nbsp;Err&nbsp;returns&nbsp;the&nbsp;error,&nbsp;if&nbsp;any,&nbsp;that&nbsp;was&nbsp;encountered&nbsp;during&nbsp;iteration.</span><br>
<span class="lineno"></span><span class="comment" id="6037751">//&nbsp;Err&nbsp;may&nbsp;be&nbsp;called&nbsp;after&nbsp;an&nbsp;explicit&nbsp;or&nbsp;implicit&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="6037809">func</span>&nbsp;<span class="op" id="6037814">(</span><span class="ident" id="6037815">rs</span>&nbsp;<span class="op" id="6037818">*</span><span class="ident" id="6037819">Rows</span><span class="op" id="6037823">)</span>&nbsp;<span class="ident" id="6037825">Err</span><span class="op" id="6037828">(</span><span class="op" id="6037829">)</span>&nbsp;<span class="builtintype" id="6037831">error</span>&nbsp;<span class="op" id="6037837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6037840">if</span>&nbsp;<span class="ident" id="6037843">rs</span><span class="op" id="6037845">.</span><span class="ident" id="6037846">lasterr</span>&nbsp;<span class="op" id="6037854">==</span>&nbsp;<span class="ident" id="6037857">io</span><span class="op" id="6037859">.</span><span class="ident" id="6037860">EOF</span>&nbsp;<span class="op" id="6037864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6037868">return</span>&nbsp;<span class="builtintype" id="6037875">nil</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6037880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6037883">return</span>&nbsp;<span class="ident" id="6037890">rs</span><span class="op" id="6037892">.</span><span class="ident" id="6037893">lasterr</span><br>
<span class="lineno"></span><span class="op" id="6037901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6037904">//&nbsp;Columns&nbsp;returns&nbsp;the&nbsp;column&nbsp;names.</span><br>
<span class="lineno">1610</span><span class="comment" id="6037941">//&nbsp;Columns&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;rows&nbsp;are&nbsp;closed,&nbsp;or&nbsp;if&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span><span class="comment" id="6038008">//&nbsp;are&nbsp;from&nbsp;QueryRow&nbsp;and&nbsp;there&nbsp;was&nbsp;a&nbsp;deferred&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="6038061">func</span>&nbsp;<span class="op" id="6038066">(</span><span class="ident" id="6038067">rs</span>&nbsp;<span class="op" id="6038070">*</span><span class="ident" id="6038071">Rows</span><span class="op" id="6038075">)</span>&nbsp;<span class="ident" id="6038077">Columns</span><span class="op" id="6038084">(</span><span class="op" id="6038085">)</span>&nbsp;<span class="op" id="6038087">(</span><span class="op" id="6038088">[</span><span class="op" id="6038089">]</span><span class="builtintype" id="6038090">string</span><span class="op" id="6038096">,</span>&nbsp;<span class="builtintype" id="6038098">error</span><span class="op" id="6038103">)</span>&nbsp;<span class="op" id="6038105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6038108">if</span>&nbsp;<span class="ident" id="6038111">rs</span><span class="op" id="6038113">.</span><span class="ident" id="6038114">closed</span>&nbsp;<span class="op" id="6038121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6038125">return</span>&nbsp;<span class="builtintype" id="6038132">nil</span><span class="op" id="6038135">,</span>&nbsp;<span class="ident" id="6038137">errors</span><span class="op" id="6038143">.</span><span class="ident" id="6038144">New</span><span class="op" id="6038147">(</span><span class="string" id="6038148">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="6038170">)</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6038173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6038176">if</span>&nbsp;<span class="ident" id="6038179">rs</span><span class="op" id="6038181">.</span><span class="ident" id="6038182">rowsi</span>&nbsp;<span class="op" id="6038188">==</span>&nbsp;<span class="builtintype" id="6038191">nil</span>&nbsp;<span class="op" id="6038195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6038199">return</span>&nbsp;<span class="builtintype" id="6038206">nil</span><span class="op" id="6038209">,</span>&nbsp;<span class="ident" id="6038211">errors</span><span class="op" id="6038217">.</span><span class="ident" id="6038218">New</span><span class="op" id="6038221">(</span><span class="string" id="6038222">&#34;sql:&nbsp;no&nbsp;Rows&nbsp;available&#34;</span><span class="op" id="6038246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6038249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6038252">return</span>&nbsp;<span class="ident" id="6038259">rs</span><span class="op" id="6038261">.</span><span class="ident" id="6038262">rowsi</span><span class="op" id="6038267">.</span><span class="ident" id="6038268">Columns</span><span class="op" id="6038275">(</span><span class="op" id="6038276">)</span><span class="op" id="6038277">,</span>&nbsp;<span class="builtintype" id="6038279">nil</span><br>
<span class="lineno">1620</span><span class="op" id="6038283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6038286">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;in&nbsp;the&nbsp;current&nbsp;row&nbsp;into&nbsp;the&nbsp;values&nbsp;pointed</span><br>
<span class="lineno"></span><span class="comment" id="6038356">//&nbsp;at&nbsp;by&nbsp;dest.</span><br>
<span class="lineno"></span><span class="comment" id="6038371">//</span><br>
<span class="lineno">1625</span><span class="comment" id="6038374">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*[]byte,&nbsp;Scan&nbsp;saves&nbsp;in&nbsp;that&nbsp;argument&nbsp;a&nbsp;copy</span><br>
<span class="lineno"></span><span class="comment" id="6038445">//&nbsp;of&nbsp;the&nbsp;corresponding&nbsp;data.&nbsp;The&nbsp;copy&nbsp;is&nbsp;owned&nbsp;by&nbsp;the&nbsp;caller&nbsp;and&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="6038515">//&nbsp;be&nbsp;modified&nbsp;and&nbsp;held&nbsp;indefinitely.&nbsp;The&nbsp;copy&nbsp;can&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using</span><br>
<span class="lineno"></span><span class="comment" id="6038586">//&nbsp;an&nbsp;argument&nbsp;of&nbsp;type&nbsp;*RawBytes&nbsp;instead;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6038654">//&nbsp;RawBytes&nbsp;for&nbsp;restrictions&nbsp;on&nbsp;its&nbsp;use.</span><br>
<span class="lineno">1630</span><span class="comment" id="6038695">//</span><br>
<span class="lineno"></span><span class="comment" id="6038698">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*interface{},&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6038761">//&nbsp;provided&nbsp;by&nbsp;the&nbsp;underlying&nbsp;driver&nbsp;without&nbsp;conversion.&nbsp;If&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6038831">//&nbsp;is&nbsp;of&nbsp;type&nbsp;[]byte,&nbsp;a&nbsp;copy&nbsp;is&nbsp;made&nbsp;and&nbsp;the&nbsp;caller&nbsp;owns&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span><span class="keyword" id="6038900">func</span>&nbsp;<span class="op" id="6038905">(</span><span class="ident" id="6038906">rs</span>&nbsp;<span class="op" id="6038909">*</span><span class="ident" id="6038910">Rows</span><span class="op" id="6038914">)</span>&nbsp;<span class="ident" id="6038916">Scan</span><span class="op" id="6038920">(</span><span class="ident" id="6038921">dest</span>&nbsp;<span class="op" id="6038926">...</span><span class="keyword" id="6038929">interface</span><span class="op" id="6038938">{</span><span class="op" id="6038939">}</span><span class="op" id="6038940">)</span>&nbsp;<span class="builtintype" id="6038942">error</span>&nbsp;<span class="op" id="6038948">{</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6038951">if</span>&nbsp;<span class="ident" id="6038954">rs</span><span class="op" id="6038956">.</span><span class="ident" id="6038957">closed</span>&nbsp;<span class="op" id="6038964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6038968">return</span>&nbsp;<span class="ident" id="6038975">errors</span><span class="op" id="6038981">.</span><span class="ident" id="6038982">New</span><span class="op" id="6038985">(</span><span class="string" id="6038986">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="6039008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6039011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6039014">if</span>&nbsp;<span class="ident" id="6039017">rs</span><span class="op" id="6039019">.</span><span class="ident" id="6039020">lastcols</span>&nbsp;<span class="op" id="6039029">==</span>&nbsp;<span class="builtintype" id="6039032">nil</span>&nbsp;<span class="op" id="6039036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6039040">return</span>&nbsp;<span class="ident" id="6039047">errors</span><span class="op" id="6039053">.</span><span class="ident" id="6039054">New</span><span class="op" id="6039057">(</span><span class="string" id="6039058">&#34;sql:&nbsp;Scan&nbsp;called&nbsp;without&nbsp;calling&nbsp;Next&#34;</span><span class="op" id="6039097">)</span><br>
<span class="lineno">1640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6039100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6039103">if</span>&nbsp;<span class="builtinfunc" id="6039106">len</span><span class="op" id="6039109">(</span><span class="ident" id="6039110">dest</span><span class="op" id="6039114">)</span>&nbsp;<span class="op" id="6039116">!=</span>&nbsp;<span class="builtinfunc" id="6039119">len</span><span class="op" id="6039122">(</span><span class="ident" id="6039123">rs</span><span class="op" id="6039125">.</span><span class="ident" id="6039126">lastcols</span><span class="op" id="6039134">)</span>&nbsp;<span class="op" id="6039136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6039140">return</span>&nbsp;<span class="ident" id="6039147">fmt</span><span class="op" id="6039150">.</span><span class="ident" id="6039151">Errorf</span><span class="op" id="6039157">(</span><span class="string" id="6039158">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;destination&nbsp;arguments&nbsp;in&nbsp;Scan,&nbsp;not&nbsp;%d&#34;</span><span class="op" id="6039214">,</span>&nbsp;<span class="builtinfunc" id="6039216">len</span><span class="op" id="6039219">(</span><span class="ident" id="6039220">rs</span><span class="op" id="6039222">.</span><span class="ident" id="6039223">lastcols</span><span class="op" id="6039231">)</span><span class="op" id="6039232">,</span>&nbsp;<span class="builtinfunc" id="6039234">len</span><span class="op" id="6039237">(</span><span class="ident" id="6039238">dest</span><span class="op" id="6039242">)</span><span class="op" id="6039243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6039246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6039249">for</span>&nbsp;<span class="ident" id="6039253">i</span><span class="op" id="6039254">,</span>&nbsp;<span class="ident" id="6039256">sv</span>&nbsp;<span class="op" id="6039259">:=</span>&nbsp;<span class="keyword" id="6039262">range</span>&nbsp;<span class="ident" id="6039268">rs</span><span class="op" id="6039270">.</span><span class="ident" id="6039271">lastcols</span>&nbsp;<span class="op" id="6039280">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6039284">err</span>&nbsp;<span class="op" id="6039288">:=</span>&nbsp;<span class="ident" id="6039291">convertAssign</span><span class="op" id="6039304">(</span><span class="ident" id="6039305">dest</span><span class="op" id="6039309">[</span><span class="ident" id="6039310">i</span><span class="op" id="6039311">]</span><span class="op" id="6039312">,</span>&nbsp;<span class="ident" id="6039314">sv</span><span class="op" id="6039316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6039320">if</span>&nbsp;<span class="ident" id="6039323">err</span>&nbsp;<span class="op" id="6039327">!=</span>&nbsp;<span class="builtintype" id="6039330">nil</span>&nbsp;<span class="op" id="6039334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6039339">return</span>&nbsp;<span class="ident" id="6039346">fmt</span><span class="op" id="6039349">.</span><span class="ident" id="6039350">Errorf</span><span class="op" id="6039356">(</span><span class="string" id="6039357">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="6039397">,</span>&nbsp;<span class="ident" id="6039399">i</span><span class="op" id="6039400">,</span>&nbsp;<span class="ident" id="6039402">err</span><span class="op" id="6039405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6039409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6039412">}</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6039415">return</span>&nbsp;<span class="builtintype" id="6039422">nil</span><br>
<span class="lineno"></span><span class="op" id="6039426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6039429">var</span>&nbsp;<span class="ident" id="6039433">rowsCloseHook</span>&nbsp;<span class="keyword" id="6039447">func</span><span class="op" id="6039451">(</span><span class="op" id="6039452">*</span><span class="ident" id="6039453">Rows</span><span class="op" id="6039457">,</span>&nbsp;<span class="op" id="6039459">*</span><span class="builtintype" id="6039460">error</span><span class="op" id="6039465">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1655</span><span class="comment" id="6039468">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;Rows,&nbsp;preventing&nbsp;further&nbsp;enumeration.&nbsp;If&nbsp;Next&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="6039542">//&nbsp;false,&nbsp;the&nbsp;Rows&nbsp;are&nbsp;closed&nbsp;automatically&nbsp;and&nbsp;it&nbsp;will&nbsp;suffice&nbsp;to&nbsp;check&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6039619">//&nbsp;result&nbsp;of&nbsp;Err.&nbsp;Close&nbsp;is&nbsp;idempotent&nbsp;and&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;result&nbsp;of&nbsp;Err.</span><br>
<span class="lineno"></span><span class="keyword" id="6039696">func</span>&nbsp;<span class="op" id="6039701">(</span><span class="ident" id="6039702">rs</span>&nbsp;<span class="op" id="6039705">*</span><span class="ident" id="6039706">Rows</span><span class="op" id="6039710">)</span>&nbsp;<span class="ident" id="6039712">Close</span><span class="op" id="6039717">(</span><span class="op" id="6039718">)</span>&nbsp;<span class="builtintype" id="6039720">error</span>&nbsp;<span class="op" id="6039726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6039729">if</span>&nbsp;<span class="ident" id="6039732">rs</span><span class="op" id="6039734">.</span><span class="ident" id="6039735">closed</span>&nbsp;<span class="op" id="6039742">{</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6039746">return</span>&nbsp;<span class="builtintype" id="6039753">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6039758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6039761">rs</span><span class="op" id="6039763">.</span><span class="ident" id="6039764">closed</span>&nbsp;<span class="op" id="6039771">=</span>&nbsp;<span class="builtintype" id="6039773">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6039779">err</span>&nbsp;<span class="op" id="6039783">:=</span>&nbsp;<span class="ident" id="6039786">rs</span><span class="op" id="6039788">.</span><span class="ident" id="6039789">rowsi</span><span class="op" id="6039794">.</span><span class="ident" id="6039795">Close</span><span class="op" id="6039800">(</span><span class="op" id="6039801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6039804">if</span>&nbsp;<span class="ident" id="6039807">fn</span>&nbsp;<span class="op" id="6039810">:=</span>&nbsp;<span class="ident" id="6039813">rowsCloseHook</span><span class="op" id="6039826">;</span>&nbsp;<span class="ident" id="6039828">fn</span>&nbsp;<span class="op" id="6039831">!=</span>&nbsp;<span class="builtintype" id="6039834">nil</span>&nbsp;<span class="op" id="6039838">{</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6039842">fn</span><span class="op" id="6039844">(</span><span class="ident" id="6039845">rs</span><span class="op" id="6039847">,</span>&nbsp;<span class="op" id="6039849">&amp;</span><span class="ident" id="6039850">err</span><span class="op" id="6039853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6039856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6039859">if</span>&nbsp;<span class="ident" id="6039862">rs</span><span class="op" id="6039864">.</span><span class="ident" id="6039865">closeStmt</span>&nbsp;<span class="op" id="6039875">!=</span>&nbsp;<span class="builtintype" id="6039878">nil</span>&nbsp;<span class="op" id="6039882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6039886">rs</span><span class="op" id="6039888">.</span><span class="ident" id="6039889">closeStmt</span><span class="op" id="6039898">.</span><span class="ident" id="6039899">Close</span><span class="op" id="6039904">(</span><span class="op" id="6039905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6039908">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6039911">rs</span><span class="op" id="6039913">.</span><span class="ident" id="6039914">releaseConn</span><span class="op" id="6039925">(</span><span class="ident" id="6039926">err</span><span class="op" id="6039929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6039932">return</span>&nbsp;<span class="ident" id="6039939">err</span><br>
<span class="lineno"></span><span class="op" id="6039943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6039946">//&nbsp;Row&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;QueryRow&nbsp;to&nbsp;select&nbsp;a&nbsp;single&nbsp;row.</span><br>
<span class="lineno">1675</span><span class="keyword" id="6040011">type</span>&nbsp;<span class="ident" id="6040016">Row</span>&nbsp;<span class="keyword" id="6040020">struct</span>&nbsp;<span class="op" id="6040027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6040030">//&nbsp;One&nbsp;of&nbsp;these&nbsp;two&nbsp;will&nbsp;be&nbsp;non-nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6040068">err</span>&nbsp;&nbsp;<span class="builtintype" id="6040073">error</span>&nbsp;<span class="comment" id="6040079">//&nbsp;deferred&nbsp;error&nbsp;for&nbsp;easy&nbsp;chaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6040116">rows</span>&nbsp;<span class="op" id="6040121">*</span><span class="ident" id="6040122">Rows</span><br>
<span class="lineno"></span><span class="op" id="6040127">}</span><br>
<span class="lineno">1680</span><br>
<span class="lineno"></span><span class="comment" id="6040130">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;from&nbsp;the&nbsp;matched&nbsp;row&nbsp;into&nbsp;the&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="6040194">//&nbsp;pointed&nbsp;at&nbsp;by&nbsp;dest.&nbsp;&nbsp;If&nbsp;more&nbsp;than&nbsp;one&nbsp;row&nbsp;matches&nbsp;the&nbsp;query,</span><br>
<span class="lineno"></span><span class="comment" id="6040258">//&nbsp;Scan&nbsp;uses&nbsp;the&nbsp;first&nbsp;row&nbsp;and&nbsp;discards&nbsp;the&nbsp;rest.&nbsp;&nbsp;If&nbsp;no&nbsp;row&nbsp;matches</span><br>
<span class="lineno"></span><span class="comment" id="6040327">//&nbsp;the&nbsp;query,&nbsp;Scan&nbsp;returns&nbsp;ErrNoRows.</span><br>
<span class="lineno">1685</span><span class="keyword" id="6040365">func</span>&nbsp;<span class="op" id="6040370">(</span><span class="ident" id="6040371">r</span>&nbsp;<span class="op" id="6040373">*</span><span class="ident" id="6040374">Row</span><span class="op" id="6040377">)</span>&nbsp;<span class="ident" id="6040379">Scan</span><span class="op" id="6040383">(</span><span class="ident" id="6040384">dest</span>&nbsp;<span class="op" id="6040389">...</span><span class="keyword" id="6040392">interface</span><span class="op" id="6040401">{</span><span class="op" id="6040402">}</span><span class="op" id="6040403">)</span>&nbsp;<span class="builtintype" id="6040405">error</span>&nbsp;<span class="op" id="6040411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6040414">if</span>&nbsp;<span class="ident" id="6040417">r</span><span class="op" id="6040418">.</span><span class="ident" id="6040419">err</span>&nbsp;<span class="op" id="6040423">!=</span>&nbsp;<span class="builtintype" id="6040426">nil</span>&nbsp;<span class="op" id="6040430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6040434">return</span>&nbsp;<span class="ident" id="6040441">r</span><span class="op" id="6040442">.</span><span class="ident" id="6040443">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6040448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6040452">//&nbsp;TODO(bradfitz):&nbsp;for&nbsp;now&nbsp;we&nbsp;need&nbsp;to&nbsp;defensively&nbsp;clone&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6040513">//&nbsp;[]byte&nbsp;that&nbsp;the&nbsp;driver&nbsp;returned&nbsp;(not&nbsp;permitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6040565">//&nbsp;*RawBytes&nbsp;in&nbsp;Rows.Scan),&nbsp;since&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6040621">//&nbsp;the&nbsp;Rows&nbsp;in&nbsp;our&nbsp;defer,&nbsp;when&nbsp;we&nbsp;return&nbsp;from&nbsp;this&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6040683">//&nbsp;the&nbsp;contract&nbsp;with&nbsp;the&nbsp;driver.Next(...)&nbsp;interface&nbsp;is&nbsp;that&nbsp;it</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6040747">//&nbsp;can&nbsp;return&nbsp;slices&nbsp;into&nbsp;read-only&nbsp;temporary&nbsp;memory&nbsp;that&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6040808">//&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;Scan/Close.&nbsp;&nbsp;But&nbsp;the&nbsp;TODO&nbsp;is&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6040872">//&nbsp;for&nbsp;a&nbsp;lot&nbsp;of&nbsp;drivers,&nbsp;this&nbsp;copy&nbsp;will&nbsp;be&nbsp;unnecessary.&nbsp;&nbsp;We</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6040933">//&nbsp;should&nbsp;provide&nbsp;an&nbsp;optional&nbsp;interface&nbsp;for&nbsp;drivers&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6040989">//&nbsp;implement&nbsp;to&nbsp;say,&nbsp;&#34;don&#39;t&nbsp;worry,&nbsp;the&nbsp;[]bytes&nbsp;that&nbsp;I&nbsp;return</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6041051">//&nbsp;from&nbsp;Next&nbsp;will&nbsp;not&nbsp;be&nbsp;modified&nbsp;again.&#34;&nbsp;(for&nbsp;instance,&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6041112">//&nbsp;they&nbsp;were&nbsp;obtained&nbsp;from&nbsp;the&nbsp;network&nbsp;anyway)&nbsp;But&nbsp;for&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6041175">//&nbsp;don&#39;t&nbsp;care.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6041191">defer</span>&nbsp;<span class="ident" id="6041197">r</span><span class="op" id="6041198">.</span><span class="ident" id="6041199">rows</span><span class="op" id="6041203">.</span><span class="ident" id="6041204">Close</span><span class="op" id="6041209">(</span><span class="op" id="6041210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6041213">for</span>&nbsp;<span class="ident" id="6041217">_</span><span class="op" id="6041218">,</span>&nbsp;<span class="ident" id="6041220">dp</span>&nbsp;<span class="op" id="6041223">:=</span>&nbsp;<span class="keyword" id="6041226">range</span>&nbsp;<span class="ident" id="6041232">dest</span>&nbsp;<span class="op" id="6041237">{</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6041241">if</span>&nbsp;<span class="ident" id="6041244">_</span><span class="op" id="6041245">,</span>&nbsp;<span class="ident" id="6041247">ok</span>&nbsp;<span class="op" id="6041250">:=</span>&nbsp;<span class="ident" id="6041253">dp</span><span class="op" id="6041255">.</span><span class="op" id="6041256">(</span><span class="op" id="6041257">*</span><span class="ident" id="6041258">RawBytes</span><span class="op" id="6041266">)</span><span class="op" id="6041267">;</span>&nbsp;<span class="ident" id="6041269">ok</span>&nbsp;<span class="op" id="6041272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6041277">return</span>&nbsp;<span class="ident" id="6041284">errors</span><span class="op" id="6041290">.</span><span class="ident" id="6041291">New</span><span class="op" id="6041294">(</span><span class="string" id="6041295">&#34;sql:&nbsp;RawBytes&nbsp;isn&#39;t&nbsp;allowed&nbsp;on&nbsp;Row.Scan&#34;</span><span class="op" id="6041336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6041340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6041343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6041347">if</span>&nbsp;<span class="op" id="6041350">!</span><span class="ident" id="6041351">r</span><span class="op" id="6041352">.</span><span class="ident" id="6041353">rows</span><span class="op" id="6041357">.</span><span class="ident" id="6041358">Next</span><span class="op" id="6041362">(</span><span class="op" id="6041363">)</span>&nbsp;<span class="op" id="6041365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6041369">if</span>&nbsp;<span class="ident" id="6041372">err</span>&nbsp;<span class="op" id="6041376">:=</span>&nbsp;<span class="ident" id="6041379">r</span><span class="op" id="6041380">.</span><span class="ident" id="6041381">rows</span><span class="op" id="6041385">.</span><span class="ident" id="6041386">Err</span><span class="op" id="6041389">(</span><span class="op" id="6041390">)</span><span class="op" id="6041391">;</span>&nbsp;<span class="ident" id="6041393">err</span>&nbsp;<span class="op" id="6041397">!=</span>&nbsp;<span class="builtintype" id="6041400">nil</span>&nbsp;<span class="op" id="6041404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6041409">return</span>&nbsp;<span class="ident" id="6041416">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6041422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6041426">return</span>&nbsp;<span class="ident" id="6041433">ErrNoRows</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6041444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6041447">err</span>&nbsp;<span class="op" id="6041451">:=</span>&nbsp;<span class="ident" id="6041454">r</span><span class="op" id="6041455">.</span><span class="ident" id="6041456">rows</span><span class="op" id="6041460">.</span><span class="ident" id="6041461">Scan</span><span class="op" id="6041465">(</span><span class="ident" id="6041466">dest</span><span class="op" id="6041470">...</span><span class="op" id="6041473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6041476">if</span>&nbsp;<span class="ident" id="6041479">err</span>&nbsp;<span class="op" id="6041483">!=</span>&nbsp;<span class="builtintype" id="6041486">nil</span>&nbsp;<span class="op" id="6041490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6041494">return</span>&nbsp;<span class="ident" id="6041501">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6041506">}</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6041509">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;query&nbsp;can&nbsp;be&nbsp;processed&nbsp;to&nbsp;completion&nbsp;with&nbsp;no&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6041580">if</span>&nbsp;<span class="ident" id="6041583">err</span>&nbsp;<span class="op" id="6041587">:=</span>&nbsp;<span class="ident" id="6041590">r</span><span class="op" id="6041591">.</span><span class="ident" id="6041592">rows</span><span class="op" id="6041596">.</span><span class="ident" id="6041597">Close</span><span class="op" id="6041602">(</span><span class="op" id="6041603">)</span><span class="op" id="6041604">;</span>&nbsp;<span class="ident" id="6041606">err</span>&nbsp;<span class="op" id="6041610">!=</span>&nbsp;<span class="builtintype" id="6041613">nil</span>&nbsp;<span class="op" id="6041617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6041621">return</span>&nbsp;<span class="ident" id="6041628">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6041633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6041637">return</span>&nbsp;<span class="builtintype" id="6041644">nil</span><br>
<span class="lineno"></span><span class="op" id="6041648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6041651">//&nbsp;A&nbsp;Result&nbsp;summarizes&nbsp;an&nbsp;executed&nbsp;SQL&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="6041699">type</span>&nbsp;<span class="ident" id="6041704">Result</span>&nbsp;<span class="keyword" id="6041711">interface</span>&nbsp;<span class="op" id="6041721">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6041724">//&nbsp;LastInsertId&nbsp;returns&nbsp;the&nbsp;integer&nbsp;generated&nbsp;by&nbsp;the&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6041787">//&nbsp;in&nbsp;response&nbsp;to&nbsp;a&nbsp;command.&nbsp;Typically&nbsp;this&nbsp;will&nbsp;be&nbsp;from&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6041848">//&nbsp;&#34;auto&nbsp;increment&#34;&nbsp;column&nbsp;when&nbsp;inserting&nbsp;a&nbsp;new&nbsp;row.&nbsp;Not&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6041910">//&nbsp;databases&nbsp;support&nbsp;this&nbsp;feature,&nbsp;and&nbsp;the&nbsp;syntax&nbsp;of&nbsp;such</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6041969">//&nbsp;statements&nbsp;varies.</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6041992">LastInsertId</span><span class="op" id="6042004">(</span><span class="op" id="6042005">)</span>&nbsp;<span class="op" id="6042007">(</span><span class="ident" id="6042008">int64</span><span class="op" id="6042013">,</span>&nbsp;<span class="builtintype" id="6042015">error</span><span class="op" id="6042020">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6042024">//&nbsp;RowsAffected&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;rows&nbsp;affected&nbsp;by&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6042083">//&nbsp;update,&nbsp;insert,&nbsp;or&nbsp;delete.&nbsp;Not&nbsp;every&nbsp;database&nbsp;or&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6042145">//&nbsp;driver&nbsp;may&nbsp;support&nbsp;this.</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6042174">RowsAffected</span><span class="op" id="6042186">(</span><span class="op" id="6042187">)</span>&nbsp;<span class="op" id="6042189">(</span><span class="ident" id="6042190">int64</span><span class="op" id="6042195">,</span>&nbsp;<span class="builtintype" id="6042197">error</span><span class="op" id="6042202">)</span><br>
<span class="lineno"></span><span class="op" id="6042204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6042207">type</span>&nbsp;<span class="ident" id="6042212">driverResult</span>&nbsp;<span class="keyword" id="6042225">struct</span>&nbsp;<span class="op" id="6042232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6042235">sync</span><span class="op" id="6042239">.</span><span class="ident" id="6042240">Locker</span>&nbsp;<span class="comment" id="6042247">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6042267">resi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6042279">driver</span><span class="op" id="6042285">.</span><span class="ident" id="6042286">Result</span><br>
<span class="lineno"></span><span class="op" id="6042293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6042296">func</span>&nbsp;<span class="op" id="6042301">(</span><span class="ident" id="6042302">dr</span>&nbsp;<span class="ident" id="6042305">driverResult</span><span class="op" id="6042317">)</span>&nbsp;<span class="ident" id="6042319">LastInsertId</span><span class="op" id="6042331">(</span><span class="op" id="6042332">)</span>&nbsp;<span class="op" id="6042334">(</span><span class="ident" id="6042335">int64</span><span class="op" id="6042340">,</span>&nbsp;<span class="builtintype" id="6042342">error</span><span class="op" id="6042347">)</span>&nbsp;<span class="op" id="6042349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6042352">dr</span><span class="op" id="6042354">.</span><span class="ident" id="6042355">Lock</span><span class="op" id="6042359">(</span><span class="op" id="6042360">)</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6042363">defer</span>&nbsp;<span class="ident" id="6042369">dr</span><span class="op" id="6042371">.</span><span class="ident" id="6042372">Unlock</span><span class="op" id="6042378">(</span><span class="op" id="6042379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6042382">return</span>&nbsp;<span class="ident" id="6042389">dr</span><span class="op" id="6042391">.</span><span class="ident" id="6042392">resi</span><span class="op" id="6042396">.</span><span class="ident" id="6042397">LastInsertId</span><span class="op" id="6042409">(</span><span class="op" id="6042410">)</span><br>
<span class="lineno"></span><span class="op" id="6042412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6042415">func</span>&nbsp;<span class="op" id="6042420">(</span><span class="ident" id="6042421">dr</span>&nbsp;<span class="ident" id="6042424">driverResult</span><span class="op" id="6042436">)</span>&nbsp;<span class="ident" id="6042438">RowsAffected</span><span class="op" id="6042450">(</span><span class="op" id="6042451">)</span>&nbsp;<span class="op" id="6042453">(</span><span class="ident" id="6042454">int64</span><span class="op" id="6042459">,</span>&nbsp;<span class="builtintype" id="6042461">error</span><span class="op" id="6042466">)</span>&nbsp;<span class="op" id="6042468">{</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6042471">dr</span><span class="op" id="6042473">.</span><span class="ident" id="6042474">Lock</span><span class="op" id="6042478">(</span><span class="op" id="6042479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6042482">defer</span>&nbsp;<span class="ident" id="6042488">dr</span><span class="op" id="6042490">.</span><span class="ident" id="6042491">Unlock</span><span class="op" id="6042497">(</span><span class="op" id="6042498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6042501">return</span>&nbsp;<span class="ident" id="6042508">dr</span><span class="op" id="6042510">.</span><span class="ident" id="6042511">resi</span><span class="op" id="6042515">.</span><span class="ident" id="6042516">RowsAffected</span><span class="op" id="6042528">(</span><span class="op" id="6042529">)</span><br>
<span class="lineno"></span><span class="op" id="6042531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span><span class="keyword" id="6042534">func</span>&nbsp;<span class="ident" id="6042539">stack</span><span class="op" id="6042544">(</span><span class="op" id="6042545">)</span>&nbsp;<span class="builtintype" id="6042547">string</span>&nbsp;<span class="op" id="6042554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6042557">var</span>&nbsp;<span class="ident" id="6042561">buf</span>&nbsp;<span class="op" id="6042565">[</span><span class="num" id="6042566">2</span>&nbsp;<span class="op" id="6042568">&lt;&lt;</span>&nbsp;<span class="num" id="6042571">10</span><span class="op" id="6042573">]</span><span class="builtintype" id="6042574">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6042580">return</span>&nbsp;<span class="builtintype" id="6042587">string</span><span class="op" id="6042593">(</span><span class="ident" id="6042594">buf</span><span class="op" id="6042597">[</span><span class="op" id="6042598">:</span><span class="ident" id="6042599">runtime</span><span class="op" id="6042606">.</span><span class="ident" id="6042607">Stack</span><span class="op" id="6042612">(</span><span class="ident" id="6042613">buf</span><span class="op" id="6042616">[</span><span class="op" id="6042617">:</span><span class="op" id="6042618">]</span><span class="op" id="6042619">,</span>&nbsp;<span class="builtintype" id="6042621">false</span><span class="op" id="6042626">)</span><span class="op" id="6042627">]</span><span class="op" id="6042628">)</span><br>
<span class="lineno"></span><span class="op" id="6042630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1765</span><span class="comment" id="6042633">//&nbsp;withLock&nbsp;runs&nbsp;while&nbsp;holding&nbsp;lk.</span><br>
<span class="lineno"></span><span class="keyword" id="6042668">func</span>&nbsp;<span class="ident" id="6042673">withLock</span><span class="op" id="6042681">(</span><span class="ident" id="6042682">lk</span>&nbsp;<span class="ident" id="6042685">sync</span><span class="op" id="6042689">.</span><span class="ident" id="6042690">Locker</span><span class="op" id="6042696">,</span>&nbsp;<span class="ident" id="6042698">fn</span>&nbsp;<span class="keyword" id="6042701">func</span><span class="op" id="6042705">(</span><span class="op" id="6042706">)</span><span class="op" id="6042707">)</span>&nbsp;<span class="op" id="6042709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6042712">lk</span><span class="op" id="6042714">.</span><span class="ident" id="6042715">Lock</span><span class="op" id="6042719">(</span><span class="op" id="6042720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6042723">fn</span><span class="op" id="6042725">(</span><span class="op" id="6042726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6042729">lk</span><span class="op" id="6042731">.</span><span class="ident" id="6042732">Unlock</span><span class="op" id="6042738">(</span><span class="op" id="6042739">)</span><br>
<span class="lineno">1770</span><span class="op" id="6042741">}</span>
</div>
</body>
</html>
