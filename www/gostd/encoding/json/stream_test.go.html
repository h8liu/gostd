<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="8638594">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8638650">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8638704">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8638755">package</span>&nbsp;<span class="ident" id="8638763">json</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8638769">import</span>&nbsp;<span class="op" id="8638776">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638779">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638788">&#34;io/ioutil&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638801">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638808">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638819">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638830">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="8638840">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="8638843">//&nbsp;Test&nbsp;values&nbsp;for&nbsp;the&nbsp;stream&nbsp;test.</span><br>
<span class="lineno"></span><span class="comment" id="8638879">//&nbsp;One&nbsp;of&nbsp;each&nbsp;JSON&nbsp;kind.</span><br>
<span class="lineno"></span><span class="keyword" id="8638905">var</span>&nbsp;<span class="ident" id="8638909">streamTest</span>&nbsp;<span class="op" id="8638920">=</span>&nbsp;<span class="op" id="8638922">[</span><span class="op" id="8638923">]</span><span class="keyword" id="8638924">interface</span><span class="op" id="8638933">{</span><span class="op" id="8638934">}</span><span class="op" id="8638935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="8638938">0.1</span><span class="op" id="8638941">,</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8638944">&#34;hello&#34;</span><span class="op" id="8638951">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8638954">nil</span><span class="op" id="8638957">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="8638960">true</span><span class="op" id="8638964">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="8638967">false</span><span class="op" id="8638972">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8638975">[</span><span class="op" id="8638976">]</span><span class="keyword" id="8638977">interface</span><span class="op" id="8638986">{</span><span class="op" id="8638987">}</span><span class="op" id="8638988">{</span><span class="string" id="8638989">&#34;a&#34;</span><span class="op" id="8638992">,</span>&nbsp;<span class="string" id="8638994">&#34;b&#34;</span><span class="op" id="8638997">,</span>&nbsp;<span class="string" id="8638999">&#34;c&#34;</span><span class="op" id="8639002">}</span><span class="op" id="8639003">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639006">map</span><span class="op" id="8639009">[</span><span class="builtintype" id="8639010">string</span><span class="op" id="8639016">]</span><span class="keyword" id="8639017">interface</span><span class="op" id="8639026">{</span><span class="op" id="8639027">}</span><span class="op" id="8639028">{</span><span class="string" id="8639029">&#34;K&#34;</span><span class="op" id="8639034">:</span>&nbsp;<span class="string" id="8639036">&#34;Kelvin&#34;</span><span class="op" id="8639044">,</span>&nbsp;<span class="string" id="8639046">&#34;ß&#34;</span><span class="op" id="8639050">:</span>&nbsp;<span class="string" id="8639052">&#34;long&nbsp;s&#34;</span><span class="op" id="8639060">}</span><span class="op" id="8639061">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="8639064">3.14</span><span class="op" id="8639068">,</span>&nbsp;<span class="comment" id="8639070">//&nbsp;another&nbsp;value&nbsp;to&nbsp;make&nbsp;sure&nbsp;something&nbsp;can&nbsp;follow&nbsp;map</span><br>
<span class="lineno"></span><span class="op" id="8639125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8639128">var</span>&nbsp;<span class="ident" id="8639132">streamEncoded</span>&nbsp;<span class="op" id="8639146">=</span>&nbsp;<span class="string" id="8639148">`0.1<br>
<span class="lineno">30</span>&#34;hello&#34;<br>
<span class="lineno"></span>null<br>
<span class="lineno"></span>true<br>
<span class="lineno"></span>false<br>
<span class="lineno"></span>[&#34;a&#34;,&#34;b&#34;,&#34;c&#34;]<br>
<span class="lineno">35</span>{&#34;ß&#34;:&#34;long&nbsp;s&#34;,&#34;K&#34;:&#34;Kelvin&#34;}<br>
<span class="lineno"></span>3.14<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8639230">func</span>&nbsp;<span class="ident" id="8639235">TestEncoder</span><span class="op" id="8639246">(</span><span class="ident" id="8639247">t</span>&nbsp;<span class="op" id="8639249">*</span><span class="ident" id="8639250">testing</span><span class="op" id="8639257">.</span><span class="ident" id="8639258">T</span><span class="op" id="8639259">)</span>&nbsp;<span class="op" id="8639261">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639264">for</span>&nbsp;<span class="ident" id="8639268">i</span>&nbsp;<span class="op" id="8639270">:=</span>&nbsp;<span class="num" id="8639273">0</span><span class="op" id="8639274">;</span>&nbsp;<span class="ident" id="8639276">i</span>&nbsp;<span class="op" id="8639278">&lt;=</span>&nbsp;<span class="builtinfunc" id="8639281">len</span><span class="op" id="8639284">(</span><span class="ident" id="8639285">streamTest</span><span class="op" id="8639295">)</span><span class="op" id="8639296">;</span>&nbsp;<span class="ident" id="8639298">i</span><span class="op" id="8639299">++</span>&nbsp;<span class="op" id="8639302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639306">var</span>&nbsp;<span class="ident" id="8639310">buf</span>&nbsp;<span class="ident" id="8639314">bytes</span><span class="op" id="8639319">.</span><span class="ident" id="8639320">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8639329">enc</span>&nbsp;<span class="op" id="8639333">:=</span>&nbsp;<span class="ident" id="8639336">NewEncoder</span><span class="op" id="8639346">(</span><span class="op" id="8639347">&amp;</span><span class="ident" id="8639348">buf</span><span class="op" id="8639351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639355">for</span>&nbsp;<span class="ident" id="8639359">j</span><span class="op" id="8639360">,</span>&nbsp;<span class="ident" id="8639362">v</span>&nbsp;<span class="op" id="8639364">:=</span>&nbsp;<span class="keyword" id="8639367">range</span>&nbsp;<span class="ident" id="8639373">streamTest</span><span class="op" id="8639383">[</span><span class="num" id="8639384">0</span><span class="op" id="8639385">:</span><span class="ident" id="8639386">i</span><span class="op" id="8639387">]</span>&nbsp;<span class="op" id="8639389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639394">if</span>&nbsp;<span class="ident" id="8639397">err</span>&nbsp;<span class="op" id="8639401">:=</span>&nbsp;<span class="ident" id="8639404">enc</span><span class="op" id="8639407">.</span><span class="ident" id="8639408">Encode</span><span class="op" id="8639414">(</span><span class="ident" id="8639415">v</span><span class="op" id="8639416">)</span><span class="op" id="8639417">;</span>&nbsp;<span class="ident" id="8639419">err</span>&nbsp;<span class="op" id="8639423">!=</span>&nbsp;<span class="ident" id="8639426">nil</span>&nbsp;<span class="op" id="8639430">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8639436">t</span><span class="op" id="8639437">.</span><span class="ident" id="8639438">Fatalf</span><span class="op" id="8639444">(</span><span class="string" id="8639445">&#34;encode&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="8639461">,</span>&nbsp;<span class="ident" id="8639463">j</span><span class="op" id="8639464">,</span>&nbsp;<span class="ident" id="8639466">err</span><span class="op" id="8639469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8639474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8639478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639482">if</span>&nbsp;<span class="ident" id="8639485">have</span><span class="op" id="8639489">,</span>&nbsp;<span class="ident" id="8639491">want</span>&nbsp;<span class="op" id="8639496">:=</span>&nbsp;<span class="ident" id="8639499">buf</span><span class="op" id="8639502">.</span><span class="ident" id="8639503">String</span><span class="op" id="8639509">(</span><span class="op" id="8639510">)</span><span class="op" id="8639511">,</span>&nbsp;<span class="ident" id="8639513">nlines</span><span class="op" id="8639519">(</span><span class="ident" id="8639520">streamEncoded</span><span class="op" id="8639533">,</span>&nbsp;<span class="ident" id="8639535">i</span><span class="op" id="8639536">)</span><span class="op" id="8639537">;</span>&nbsp;<span class="ident" id="8639539">have</span>&nbsp;<span class="op" id="8639544">!=</span>&nbsp;<span class="ident" id="8639547">want</span>&nbsp;<span class="op" id="8639552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8639557">t</span><span class="op" id="8639558">.</span><span class="ident" id="8639559">Errorf</span><span class="op" id="8639565">(</span><span class="string" id="8639566">&#34;encoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="8639595">,</span>&nbsp;<span class="ident" id="8639597">i</span><span class="op" id="8639598">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8639603">diff</span><span class="op" id="8639607">(</span><span class="ident" id="8639608">t</span><span class="op" id="8639609">,</span>&nbsp;<span class="op" id="8639611">[</span><span class="op" id="8639612">]</span><span class="builtintype" id="8639613">byte</span><span class="op" id="8639617">(</span><span class="ident" id="8639618">have</span><span class="op" id="8639622">)</span><span class="op" id="8639623">,</span>&nbsp;<span class="op" id="8639625">[</span><span class="op" id="8639626">]</span><span class="builtintype" id="8639627">byte</span><span class="op" id="8639631">(</span><span class="ident" id="8639632">want</span><span class="op" id="8639636">)</span><span class="op" id="8639637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639642">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8639650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8639653">}</span><br>
<span class="lineno"></span><span class="op" id="8639655">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="8639658">func</span>&nbsp;<span class="ident" id="8639663">TestDecoder</span><span class="op" id="8639674">(</span><span class="ident" id="8639675">t</span>&nbsp;<span class="op" id="8639677">*</span><span class="ident" id="8639678">testing</span><span class="op" id="8639685">.</span><span class="ident" id="8639686">T</span><span class="op" id="8639687">)</span>&nbsp;<span class="op" id="8639689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639692">for</span>&nbsp;<span class="ident" id="8639696">i</span>&nbsp;<span class="op" id="8639698">:=</span>&nbsp;<span class="num" id="8639701">0</span><span class="op" id="8639702">;</span>&nbsp;<span class="ident" id="8639704">i</span>&nbsp;<span class="op" id="8639706">&lt;=</span>&nbsp;<span class="builtinfunc" id="8639709">len</span><span class="op" id="8639712">(</span><span class="ident" id="8639713">streamTest</span><span class="op" id="8639723">)</span><span class="op" id="8639724">;</span>&nbsp;<span class="ident" id="8639726">i</span><span class="op" id="8639727">++</span>&nbsp;<span class="op" id="8639730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8639734">//&nbsp;Use&nbsp;stream&nbsp;without&nbsp;newlines&nbsp;as&nbsp;input,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8639777">//&nbsp;just&nbsp;to&nbsp;stress&nbsp;the&nbsp;decoder&nbsp;even&nbsp;more.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8639820">//&nbsp;Our&nbsp;test&nbsp;input&nbsp;does&nbsp;not&nbsp;include&nbsp;back-to-back&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8639879">//&nbsp;Otherwise&nbsp;stripping&nbsp;the&nbsp;newlines&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8639923">//&nbsp;merge&nbsp;two&nbsp;adjacent&nbsp;JSON&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639960">var</span>&nbsp;<span class="ident" id="8639964">buf</span>&nbsp;<span class="ident" id="8639968">bytes</span><span class="op" id="8639973">.</span><span class="ident" id="8639974">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8639983">for</span>&nbsp;<span class="ident" id="8639987">_</span><span class="op" id="8639988">,</span>&nbsp;<span class="ident" id="8639990">c</span>&nbsp;<span class="op" id="8639992">:=</span>&nbsp;<span class="keyword" id="8639995">range</span>&nbsp;<span class="ident" id="8640001">nlines</span><span class="op" id="8640007">(</span><span class="ident" id="8640008">streamEncoded</span><span class="op" id="8640021">,</span>&nbsp;<span class="ident" id="8640023">i</span><span class="op" id="8640024">)</span>&nbsp;<span class="op" id="8640026">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8640031">if</span>&nbsp;<span class="ident" id="8640034">c</span>&nbsp;<span class="op" id="8640036">!=</span>&nbsp;<span class="string" id="8640039">&#39;\n&#39;</span>&nbsp;<span class="op" id="8640044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640050">buf</span><span class="op" id="8640053">.</span><span class="ident" id="8640054">WriteRune</span><span class="op" id="8640063">(</span><span class="ident" id="8640064">c</span><span class="op" id="8640065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640078">out</span>&nbsp;<span class="op" id="8640082">:=</span>&nbsp;<span class="builtinfunc" id="8640085">make</span><span class="op" id="8640089">(</span><span class="op" id="8640090">[</span><span class="op" id="8640091">]</span><span class="keyword" id="8640092">interface</span><span class="op" id="8640101">{</span><span class="op" id="8640102">}</span><span class="op" id="8640103">,</span>&nbsp;<span class="ident" id="8640105">i</span><span class="op" id="8640106">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640110">dec</span>&nbsp;<span class="op" id="8640114">:=</span>&nbsp;<span class="ident" id="8640117">NewDecoder</span><span class="op" id="8640127">(</span><span class="op" id="8640128">&amp;</span><span class="ident" id="8640129">buf</span><span class="op" id="8640132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8640136">for</span>&nbsp;<span class="ident" id="8640140">j</span>&nbsp;<span class="op" id="8640142">:=</span>&nbsp;<span class="keyword" id="8640145">range</span>&nbsp;<span class="ident" id="8640151">out</span>&nbsp;<span class="op" id="8640155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8640160">if</span>&nbsp;<span class="ident" id="8640163">err</span>&nbsp;<span class="op" id="8640167">:=</span>&nbsp;<span class="ident" id="8640170">dec</span><span class="op" id="8640173">.</span><span class="ident" id="8640174">Decode</span><span class="op" id="8640180">(</span><span class="op" id="8640181">&amp;</span><span class="ident" id="8640182">out</span><span class="op" id="8640185">[</span><span class="ident" id="8640186">j</span><span class="op" id="8640187">]</span><span class="op" id="8640188">)</span><span class="op" id="8640189">;</span>&nbsp;<span class="ident" id="8640191">err</span>&nbsp;<span class="op" id="8640195">!=</span>&nbsp;<span class="ident" id="8640198">nil</span>&nbsp;<span class="op" id="8640202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640208">t</span><span class="op" id="8640209">.</span><span class="ident" id="8640210">Fatalf</span><span class="op" id="8640216">(</span><span class="string" id="8640217">&#34;decode&nbsp;#%d/%d:&nbsp;%v&#34;</span><span class="op" id="8640236">,</span>&nbsp;<span class="ident" id="8640238">j</span><span class="op" id="8640239">,</span>&nbsp;<span class="ident" id="8640241">i</span><span class="op" id="8640242">,</span>&nbsp;<span class="ident" id="8640244">err</span><span class="op" id="8640247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640252">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8640260">if</span>&nbsp;<span class="op" id="8640263">!</span><span class="ident" id="8640264">reflect</span><span class="op" id="8640271">.</span><span class="ident" id="8640272">DeepEqual</span><span class="op" id="8640281">(</span><span class="ident" id="8640282">out</span><span class="op" id="8640285">,</span>&nbsp;<span class="ident" id="8640287">streamTest</span><span class="op" id="8640297">[</span><span class="num" id="8640298">0</span><span class="op" id="8640299">:</span><span class="ident" id="8640300">i</span><span class="op" id="8640301">]</span><span class="op" id="8640302">)</span>&nbsp;<span class="op" id="8640304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640309">t</span><span class="op" id="8640310">.</span><span class="ident" id="8640311">Errorf</span><span class="op" id="8640317">(</span><span class="string" id="8640318">&#34;decoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="8640347">,</span>&nbsp;<span class="ident" id="8640349">i</span><span class="op" id="8640350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8640355">for</span>&nbsp;<span class="ident" id="8640359">j</span>&nbsp;<span class="op" id="8640361">:=</span>&nbsp;<span class="keyword" id="8640364">range</span>&nbsp;<span class="ident" id="8640370">out</span>&nbsp;<span class="op" id="8640374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8640380">if</span>&nbsp;<span class="op" id="8640383">!</span><span class="ident" id="8640384">reflect</span><span class="op" id="8640391">.</span><span class="ident" id="8640392">DeepEqual</span><span class="op" id="8640401">(</span><span class="ident" id="8640402">out</span><span class="op" id="8640405">[</span><span class="ident" id="8640406">j</span><span class="op" id="8640407">]</span><span class="op" id="8640408">,</span>&nbsp;<span class="ident" id="8640410">streamTest</span><span class="op" id="8640420">[</span><span class="ident" id="8640421">j</span><span class="op" id="8640422">]</span><span class="op" id="8640423">)</span>&nbsp;<span class="op" id="8640425">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640432">t</span><span class="op" id="8640433">.</span><span class="ident" id="8640434">Errorf</span><span class="op" id="8640440">(</span><span class="string" id="8640441">&#34;#%d:&nbsp;have&nbsp;%v&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8640463">,</span>&nbsp;<span class="ident" id="8640465">j</span><span class="op" id="8640466">,</span>&nbsp;<span class="ident" id="8640468">out</span><span class="op" id="8640471">[</span><span class="ident" id="8640472">j</span><span class="op" id="8640473">]</span><span class="op" id="8640474">,</span>&nbsp;<span class="ident" id="8640476">streamTest</span><span class="op" id="8640486">[</span><span class="ident" id="8640487">j</span><span class="op" id="8640488">]</span><span class="op" id="8640489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8640505">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640513">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640516">}</span><br>
<span class="lineno"></span><span class="op" id="8640518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8640521">func</span>&nbsp;<span class="ident" id="8640526">TestDecoderBuffered</span><span class="op" id="8640545">(</span><span class="ident" id="8640546">t</span>&nbsp;<span class="op" id="8640548">*</span><span class="ident" id="8640549">testing</span><span class="op" id="8640556">.</span><span class="ident" id="8640557">T</span><span class="op" id="8640558">)</span>&nbsp;<span class="op" id="8640560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640563">r</span>&nbsp;<span class="op" id="8640565">:=</span>&nbsp;<span class="ident" id="8640568">strings</span><span class="op" id="8640575">.</span><span class="ident" id="8640576">NewReader</span><span class="op" id="8640585">(</span><span class="string" id="8640586">`{&#34;Name&#34;:&nbsp;&#34;Gopher&#34;}&nbsp;extra&nbsp;`</span><span class="op" id="8640613">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8640616">var</span>&nbsp;<span class="ident" id="8640620">m</span>&nbsp;<span class="keyword" id="8640622">struct</span>&nbsp;<span class="op" id="8640629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640633">Name</span>&nbsp;<span class="builtintype" id="8640638">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640649">d</span>&nbsp;<span class="op" id="8640651">:=</span>&nbsp;<span class="ident" id="8640654">NewDecoder</span><span class="op" id="8640664">(</span><span class="ident" id="8640665">r</span><span class="op" id="8640666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640669">err</span>&nbsp;<span class="op" id="8640673">:=</span>&nbsp;<span class="ident" id="8640676">d</span><span class="op" id="8640677">.</span><span class="ident" id="8640678">Decode</span><span class="op" id="8640684">(</span><span class="op" id="8640685">&amp;</span><span class="ident" id="8640686">m</span><span class="op" id="8640687">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8640690">if</span>&nbsp;<span class="ident" id="8640693">err</span>&nbsp;<span class="op" id="8640697">!=</span>&nbsp;<span class="ident" id="8640700">nil</span>&nbsp;<span class="op" id="8640704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640708">t</span><span class="op" id="8640709">.</span><span class="ident" id="8640710">Fatal</span><span class="op" id="8640715">(</span><span class="ident" id="8640716">err</span><span class="op" id="8640719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8640725">if</span>&nbsp;<span class="ident" id="8640728">m</span><span class="op" id="8640729">.</span><span class="ident" id="8640730">Name</span>&nbsp;<span class="op" id="8640735">!=</span>&nbsp;<span class="string" id="8640738">&#34;Gopher&#34;</span>&nbsp;<span class="op" id="8640747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640751">t</span><span class="op" id="8640752">.</span><span class="ident" id="8640753">Errorf</span><span class="op" id="8640759">(</span><span class="string" id="8640760">&#34;Name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;Gopher&#34;</span><span class="op" id="8640784">,</span>&nbsp;<span class="ident" id="8640786">m</span><span class="op" id="8640787">.</span><span class="ident" id="8640788">Name</span><span class="op" id="8640792">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640798">rest</span><span class="op" id="8640802">,</span>&nbsp;<span class="ident" id="8640804">err</span>&nbsp;<span class="op" id="8640808">:=</span>&nbsp;<span class="ident" id="8640811">ioutil</span><span class="op" id="8640817">.</span><span class="ident" id="8640818">ReadAll</span><span class="op" id="8640825">(</span><span class="ident" id="8640826">d</span><span class="op" id="8640827">.</span><span class="ident" id="8640828">Buffered</span><span class="op" id="8640836">(</span><span class="op" id="8640837">)</span><span class="op" id="8640838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8640841">if</span>&nbsp;<span class="ident" id="8640844">err</span>&nbsp;<span class="op" id="8640848">!=</span>&nbsp;<span class="ident" id="8640851">nil</span>&nbsp;<span class="op" id="8640855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640859">t</span><span class="op" id="8640860">.</span><span class="ident" id="8640861">Fatal</span><span class="op" id="8640866">(</span><span class="ident" id="8640867">err</span><span class="op" id="8640870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640873">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8640876">if</span>&nbsp;<span class="ident" id="8640879">g</span><span class="op" id="8640880">,</span>&nbsp;<span class="ident" id="8640882">w</span>&nbsp;<span class="op" id="8640884">:=</span>&nbsp;<span class="builtintype" id="8640887">string</span><span class="op" id="8640893">(</span><span class="ident" id="8640894">rest</span><span class="op" id="8640898">)</span><span class="op" id="8640899">,</span>&nbsp;<span class="string" id="8640901">&#34;&nbsp;extra&nbsp;&#34;</span><span class="op" id="8640910">;</span>&nbsp;<span class="ident" id="8640912">g</span>&nbsp;<span class="op" id="8640914">!=</span>&nbsp;<span class="ident" id="8640917">w</span>&nbsp;<span class="op" id="8640919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8640923">t</span><span class="op" id="8640924">.</span><span class="ident" id="8640925">Errorf</span><span class="op" id="8640931">(</span><span class="string" id="8640932">&#34;Remaining&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8640957">,</span>&nbsp;<span class="ident" id="8640959">g</span><span class="op" id="8640960">,</span>&nbsp;<span class="ident" id="8640962">w</span><span class="op" id="8640963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8640966">}</span><br>
<span class="lineno"></span><span class="op" id="8640968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="8640971">func</span>&nbsp;<span class="ident" id="8640976">nlines</span><span class="op" id="8640982">(</span><span class="ident" id="8640983">s</span>&nbsp;<span class="builtintype" id="8640985">string</span><span class="op" id="8640991">,</span>&nbsp;<span class="ident" id="8640993">n</span>&nbsp;<span class="builtintype" id="8640995">int</span><span class="op" id="8640998">)</span>&nbsp;<span class="builtintype" id="8641000">string</span>&nbsp;<span class="op" id="8641007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641010">if</span>&nbsp;<span class="ident" id="8641013">n</span>&nbsp;<span class="op" id="8641015">&lt;=</span>&nbsp;<span class="num" id="8641018">0</span>&nbsp;<span class="op" id="8641020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641024">return</span>&nbsp;<span class="string" id="8641031">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8641035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641038">for</span>&nbsp;<span class="ident" id="8641042">i</span><span class="op" id="8641043">,</span>&nbsp;<span class="ident" id="8641045">c</span>&nbsp;<span class="op" id="8641047">:=</span>&nbsp;<span class="keyword" id="8641050">range</span>&nbsp;<span class="ident" id="8641056">s</span>&nbsp;<span class="op" id="8641058">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641062">if</span>&nbsp;<span class="ident" id="8641065">c</span>&nbsp;<span class="op" id="8641067">==</span>&nbsp;<span class="string" id="8641070">&#39;\n&#39;</span>&nbsp;<span class="op" id="8641075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641080">if</span>&nbsp;<span class="ident" id="8641083">n</span><span class="op" id="8641084">--</span><span class="op" id="8641086">;</span>&nbsp;<span class="ident" id="8641088">n</span>&nbsp;<span class="op" id="8641090">==</span>&nbsp;<span class="num" id="8641093">0</span>&nbsp;<span class="op" id="8641095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641101">return</span>&nbsp;<span class="ident" id="8641108">s</span><span class="op" id="8641109">[</span><span class="num" id="8641110">0</span>&nbsp;<span class="op" id="8641112">:</span>&nbsp;<span class="ident" id="8641114">i</span><span class="op" id="8641115">+</span><span class="num" id="8641116">1</span><span class="op" id="8641117">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8641122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8641126">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8641129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641132">return</span>&nbsp;<span class="ident" id="8641139">s</span><br>
<span class="lineno"></span><span class="op" id="8641141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8641144">func</span>&nbsp;<span class="ident" id="8641149">TestRawMessage</span><span class="op" id="8641163">(</span><span class="ident" id="8641164">t</span>&nbsp;<span class="op" id="8641166">*</span><span class="ident" id="8641167">testing</span><span class="op" id="8641174">.</span><span class="ident" id="8641175">T</span><span class="op" id="8641176">)</span>&nbsp;<span class="op" id="8641178">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8641181">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641233">var</span>&nbsp;<span class="ident" id="8641237">data</span>&nbsp;<span class="keyword" id="8641242">struct</span>&nbsp;<span class="op" id="8641249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641253">X</span>&nbsp;&nbsp;<span class="builtintype" id="8641256">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641266">Id</span>&nbsp;<span class="op" id="8641269">*</span><span class="ident" id="8641270">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641283">Y</span>&nbsp;&nbsp;<span class="builtintype" id="8641286">float32</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8641295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641298">const</span>&nbsp;<span class="ident" id="8641304">raw</span>&nbsp;<span class="op" id="8641308">=</span>&nbsp;<span class="string" id="8641310">`[&#34;\u0056&#34;,null]`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641329">const</span>&nbsp;<span class="ident" id="8641335">msg</span>&nbsp;<span class="op" id="8641339">=</span>&nbsp;<span class="string" id="8641341">`{&#34;X&#34;:0.1,&#34;Id&#34;:[&#34;\u0056&#34;,null],&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641383">err</span>&nbsp;<span class="op" id="8641387">:=</span>&nbsp;<span class="ident" id="8641390">Unmarshal</span><span class="op" id="8641399">(</span><span class="op" id="8641400">[</span><span class="op" id="8641401">]</span><span class="builtintype" id="8641402">byte</span><span class="op" id="8641406">(</span><span class="ident" id="8641407">msg</span><span class="op" id="8641410">)</span><span class="op" id="8641411">,</span>&nbsp;<span class="op" id="8641413">&amp;</span><span class="ident" id="8641414">data</span><span class="op" id="8641418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641421">if</span>&nbsp;<span class="ident" id="8641424">err</span>&nbsp;<span class="op" id="8641428">!=</span>&nbsp;<span class="ident" id="8641431">nil</span>&nbsp;<span class="op" id="8641435">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641439">t</span><span class="op" id="8641440">.</span><span class="ident" id="8641441">Fatalf</span><span class="op" id="8641447">(</span><span class="string" id="8641448">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="8641463">,</span>&nbsp;<span class="ident" id="8641465">err</span><span class="op" id="8641468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8641471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641474">if</span>&nbsp;<span class="builtintype" id="8641477">string</span><span class="op" id="8641483">(</span><span class="op" id="8641484">[</span><span class="op" id="8641485">]</span><span class="builtintype" id="8641486">byte</span><span class="op" id="8641490">(</span><span class="op" id="8641491">*</span><span class="ident" id="8641492">data</span><span class="op" id="8641496">.</span><span class="ident" id="8641497">Id</span><span class="op" id="8641499">)</span><span class="op" id="8641500">)</span>&nbsp;<span class="op" id="8641502">!=</span>&nbsp;<span class="ident" id="8641505">raw</span>&nbsp;<span class="op" id="8641509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641513">t</span><span class="op" id="8641514">.</span><span class="ident" id="8641515">Fatalf</span><span class="op" id="8641521">(</span><span class="string" id="8641522">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="8641555">,</span>&nbsp;<span class="op" id="8641557">[</span><span class="op" id="8641558">]</span><span class="builtintype" id="8641559">byte</span><span class="op" id="8641563">(</span><span class="op" id="8641564">*</span><span class="ident" id="8641565">data</span><span class="op" id="8641569">.</span><span class="ident" id="8641570">Id</span><span class="op" id="8641572">)</span><span class="op" id="8641573">,</span>&nbsp;<span class="ident" id="8641575">raw</span><span class="op" id="8641578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8641581">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641584">b</span><span class="op" id="8641585">,</span>&nbsp;<span class="ident" id="8641587">err</span>&nbsp;<span class="op" id="8641591">:=</span>&nbsp;<span class="ident" id="8641594">Marshal</span><span class="op" id="8641601">(</span><span class="op" id="8641602">&amp;</span><span class="ident" id="8641603">data</span><span class="op" id="8641607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641610">if</span>&nbsp;<span class="ident" id="8641613">err</span>&nbsp;<span class="op" id="8641617">!=</span>&nbsp;<span class="ident" id="8641620">nil</span>&nbsp;<span class="op" id="8641624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641628">t</span><span class="op" id="8641629">.</span><span class="ident" id="8641630">Fatalf</span><span class="op" id="8641636">(</span><span class="string" id="8641637">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="8641650">,</span>&nbsp;<span class="ident" id="8641652">err</span><span class="op" id="8641655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8641658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641661">if</span>&nbsp;<span class="builtintype" id="8641664">string</span><span class="op" id="8641670">(</span><span class="ident" id="8641671">b</span><span class="op" id="8641672">)</span>&nbsp;<span class="op" id="8641674">!=</span>&nbsp;<span class="ident" id="8641677">msg</span>&nbsp;<span class="op" id="8641681">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641685">t</span><span class="op" id="8641686">.</span><span class="ident" id="8641687">Fatalf</span><span class="op" id="8641693">(</span><span class="string" id="8641694">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="8641722">,</span>&nbsp;<span class="ident" id="8641724">b</span><span class="op" id="8641725">,</span>&nbsp;<span class="ident" id="8641727">msg</span><span class="op" id="8641730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8641733">}</span><br>
<span class="lineno"></span><span class="op" id="8641735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8641738">func</span>&nbsp;<span class="ident" id="8641743">TestNullRawMessage</span><span class="op" id="8641761">(</span><span class="ident" id="8641762">t</span>&nbsp;<span class="op" id="8641764">*</span><span class="ident" id="8641765">testing</span><span class="op" id="8641772">.</span><span class="ident" id="8641773">T</span><span class="op" id="8641774">)</span>&nbsp;<span class="op" id="8641776">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8641779">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641831">var</span>&nbsp;<span class="ident" id="8641835">data</span>&nbsp;<span class="keyword" id="8641840">struct</span>&nbsp;<span class="op" id="8641847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641851">X</span>&nbsp;&nbsp;<span class="builtintype" id="8641854">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641864">Id</span>&nbsp;<span class="op" id="8641867">*</span><span class="ident" id="8641868">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641881">Y</span>&nbsp;&nbsp;<span class="builtintype" id="8641884">float32</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8641893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641896">data</span><span class="op" id="8641900">.</span><span class="ident" id="8641901">Id</span>&nbsp;<span class="op" id="8641904">=</span>&nbsp;<span class="builtinfunc" id="8641906">new</span><span class="op" id="8641909">(</span><span class="ident" id="8641910">RawMessage</span><span class="op" id="8641920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8641923">const</span>&nbsp;<span class="ident" id="8641929">msg</span>&nbsp;<span class="op" id="8641933">=</span>&nbsp;<span class="string" id="8641935">`{&#34;X&#34;:0.1,&#34;Id&#34;:null,&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8641966">err</span>&nbsp;<span class="op" id="8641970">:=</span>&nbsp;<span class="ident" id="8641973">Unmarshal</span><span class="op" id="8641982">(</span><span class="op" id="8641983">[</span><span class="op" id="8641984">]</span><span class="builtintype" id="8641985">byte</span><span class="op" id="8641989">(</span><span class="ident" id="8641990">msg</span><span class="op" id="8641993">)</span><span class="op" id="8641994">,</span>&nbsp;<span class="op" id="8641996">&amp;</span><span class="ident" id="8641997">data</span><span class="op" id="8642001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642004">if</span>&nbsp;<span class="ident" id="8642007">err</span>&nbsp;<span class="op" id="8642011">!=</span>&nbsp;<span class="ident" id="8642014">nil</span>&nbsp;<span class="op" id="8642018">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642022">t</span><span class="op" id="8642023">.</span><span class="ident" id="8642024">Fatalf</span><span class="op" id="8642030">(</span><span class="string" id="8642031">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="8642046">,</span>&nbsp;<span class="ident" id="8642048">err</span><span class="op" id="8642051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642057">if</span>&nbsp;<span class="ident" id="8642060">data</span><span class="op" id="8642064">.</span><span class="ident" id="8642065">Id</span>&nbsp;<span class="op" id="8642068">!=</span>&nbsp;<span class="ident" id="8642071">nil</span>&nbsp;<span class="op" id="8642075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642079">t</span><span class="op" id="8642080">.</span><span class="ident" id="8642081">Fatalf</span><span class="op" id="8642087">(</span><span class="string" id="8642088">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;non-nil,&nbsp;want&nbsp;nil&#34;</span><span class="op" id="8642126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642129">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642132">b</span><span class="op" id="8642133">,</span>&nbsp;<span class="ident" id="8642135">err</span>&nbsp;<span class="op" id="8642139">:=</span>&nbsp;<span class="ident" id="8642142">Marshal</span><span class="op" id="8642149">(</span><span class="op" id="8642150">&amp;</span><span class="ident" id="8642151">data</span><span class="op" id="8642155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642158">if</span>&nbsp;<span class="ident" id="8642161">err</span>&nbsp;<span class="op" id="8642165">!=</span>&nbsp;<span class="ident" id="8642168">nil</span>&nbsp;<span class="op" id="8642172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642176">t</span><span class="op" id="8642177">.</span><span class="ident" id="8642178">Fatalf</span><span class="op" id="8642184">(</span><span class="string" id="8642185">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="8642198">,</span>&nbsp;<span class="ident" id="8642200">err</span><span class="op" id="8642203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642209">if</span>&nbsp;<span class="builtintype" id="8642212">string</span><span class="op" id="8642218">(</span><span class="ident" id="8642219">b</span><span class="op" id="8642220">)</span>&nbsp;<span class="op" id="8642222">!=</span>&nbsp;<span class="ident" id="8642225">msg</span>&nbsp;<span class="op" id="8642229">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642233">t</span><span class="op" id="8642234">.</span><span class="ident" id="8642235">Fatalf</span><span class="op" id="8642241">(</span><span class="string" id="8642242">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="8642270">,</span>&nbsp;<span class="ident" id="8642272">b</span><span class="op" id="8642273">,</span>&nbsp;<span class="ident" id="8642275">msg</span><span class="op" id="8642278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642281">}</span><br>
<span class="lineno"></span><span class="op" id="8642283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8642286">var</span>&nbsp;<span class="ident" id="8642290">blockingTests</span>&nbsp;<span class="op" id="8642304">=</span>&nbsp;<span class="op" id="8642306">[</span><span class="op" id="8642307">]</span><span class="builtintype" id="8642308">string</span><span class="op" id="8642314">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8642317">`{&#34;x&#34;:&nbsp;1}`</span><span class="op" id="8642327">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8642330">`[1,&nbsp;2,&nbsp;3]`</span><span class="op" id="8642341">,</span><br>
<span class="lineno"></span><span class="op" id="8642343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8642346">func</span>&nbsp;<span class="ident" id="8642351">TestBlocking</span><span class="op" id="8642363">(</span><span class="ident" id="8642364">t</span>&nbsp;<span class="op" id="8642366">*</span><span class="ident" id="8642367">testing</span><span class="op" id="8642374">.</span><span class="ident" id="8642375">T</span><span class="op" id="8642376">)</span>&nbsp;<span class="op" id="8642378">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642381">for</span>&nbsp;<span class="ident" id="8642385">_</span><span class="op" id="8642386">,</span>&nbsp;<span class="ident" id="8642388">enc</span>&nbsp;<span class="op" id="8642392">:=</span>&nbsp;<span class="keyword" id="8642395">range</span>&nbsp;<span class="ident" id="8642401">blockingTests</span>&nbsp;<span class="op" id="8642415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642419">r</span><span class="op" id="8642420">,</span>&nbsp;<span class="ident" id="8642422">w</span>&nbsp;<span class="op" id="8642424">:=</span>&nbsp;<span class="ident" id="8642427">net</span><span class="op" id="8642430">.</span><span class="ident" id="8642431">Pipe</span><span class="op" id="8642435">(</span><span class="op" id="8642436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642440">go</span>&nbsp;<span class="ident" id="8642443">w</span><span class="op" id="8642444">.</span><span class="ident" id="8642445">Write</span><span class="op" id="8642450">(</span><span class="op" id="8642451">[</span><span class="op" id="8642452">]</span><span class="builtintype" id="8642453">byte</span><span class="op" id="8642457">(</span><span class="ident" id="8642458">enc</span><span class="op" id="8642461">)</span><span class="op" id="8642462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642466">var</span>&nbsp;<span class="ident" id="8642470">val</span>&nbsp;<span class="keyword" id="8642474">interface</span><span class="op" id="8642483">{</span><span class="op" id="8642484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8642489">//&nbsp;If&nbsp;Decode&nbsp;reads&nbsp;beyond&nbsp;what&nbsp;w.Write&nbsp;writes&nbsp;above,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8642544">//&nbsp;it&nbsp;will&nbsp;block,&nbsp;and&nbsp;the&nbsp;test&nbsp;will&nbsp;deadlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642592">if</span>&nbsp;<span class="ident" id="8642595">err</span>&nbsp;<span class="op" id="8642599">:=</span>&nbsp;<span class="ident" id="8642602">NewDecoder</span><span class="op" id="8642612">(</span><span class="ident" id="8642613">r</span><span class="op" id="8642614">)</span><span class="op" id="8642615">.</span><span class="ident" id="8642616">Decode</span><span class="op" id="8642622">(</span><span class="op" id="8642623">&amp;</span><span class="ident" id="8642624">val</span><span class="op" id="8642627">)</span><span class="op" id="8642628">;</span>&nbsp;<span class="ident" id="8642630">err</span>&nbsp;<span class="op" id="8642634">!=</span>&nbsp;<span class="ident" id="8642637">nil</span>&nbsp;<span class="op" id="8642641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642646">t</span><span class="op" id="8642647">.</span><span class="ident" id="8642648">Errorf</span><span class="op" id="8642654">(</span><span class="string" id="8642655">&#34;decoding&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="8642672">,</span>&nbsp;<span class="ident" id="8642674">enc</span><span class="op" id="8642677">,</span>&nbsp;<span class="ident" id="8642679">err</span><span class="op" id="8642682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642686">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642690">r</span><span class="op" id="8642691">.</span><span class="ident" id="8642692">Close</span><span class="op" id="8642697">(</span><span class="op" id="8642698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642702">w</span><span class="op" id="8642703">.</span><span class="ident" id="8642704">Close</span><span class="op" id="8642709">(</span><span class="op" id="8642710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642713">}</span><br>
<span class="lineno"></span><span class="op" id="8642715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="8642718">func</span>&nbsp;<span class="ident" id="8642723">BenchmarkEncoderEncode</span><span class="op" id="8642745">(</span><span class="ident" id="8642746">b</span>&nbsp;<span class="op" id="8642748">*</span><span class="ident" id="8642749">testing</span><span class="op" id="8642756">.</span><span class="ident" id="8642757">B</span><span class="op" id="8642758">)</span>&nbsp;<span class="op" id="8642760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642763">b</span><span class="op" id="8642764">.</span><span class="ident" id="8642765">ReportAllocs</span><span class="op" id="8642777">(</span><span class="op" id="8642778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642781">type</span>&nbsp;<span class="ident" id="8642786">T</span>&nbsp;<span class="keyword" id="8642788">struct</span>&nbsp;<span class="op" id="8642795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642799">X</span><span class="op" id="8642800">,</span>&nbsp;<span class="ident" id="8642802">Y</span>&nbsp;<span class="builtintype" id="8642804">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642812">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642815">v</span>&nbsp;<span class="op" id="8642817">:=</span>&nbsp;<span class="op" id="8642820">&amp;</span><span class="ident" id="8642821">T</span><span class="op" id="8642822">{</span><span class="string" id="8642823">&#34;foo&#34;</span><span class="op" id="8642828">,</span>&nbsp;<span class="string" id="8642830">&#34;bar&#34;</span><span class="op" id="8642835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642838">for</span>&nbsp;<span class="ident" id="8642842">i</span>&nbsp;<span class="op" id="8642844">:=</span>&nbsp;<span class="num" id="8642847">0</span><span class="op" id="8642848">;</span>&nbsp;<span class="ident" id="8642850">i</span>&nbsp;<span class="op" id="8642852">&lt;</span>&nbsp;<span class="ident" id="8642854">b</span><span class="op" id="8642855">.</span><span class="ident" id="8642856">N</span><span class="op" id="8642857">;</span>&nbsp;<span class="ident" id="8642859">i</span><span class="op" id="8642860">++</span>&nbsp;<span class="op" id="8642863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8642867">if</span>&nbsp;<span class="ident" id="8642870">err</span>&nbsp;<span class="op" id="8642874">:=</span>&nbsp;<span class="ident" id="8642877">NewEncoder</span><span class="op" id="8642887">(</span><span class="ident" id="8642888">ioutil</span><span class="op" id="8642894">.</span><span class="ident" id="8642895">Discard</span><span class="op" id="8642902">)</span><span class="op" id="8642903">.</span><span class="ident" id="8642904">Encode</span><span class="op" id="8642910">(</span><span class="ident" id="8642911">v</span><span class="op" id="8642912">)</span><span class="op" id="8642913">;</span>&nbsp;<span class="ident" id="8642915">err</span>&nbsp;<span class="op" id="8642919">!=</span>&nbsp;<span class="ident" id="8642922">nil</span>&nbsp;<span class="op" id="8642926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8642931">b</span><span class="op" id="8642932">.</span><span class="ident" id="8642933">Fatal</span><span class="op" id="8642938">(</span><span class="ident" id="8642939">err</span><span class="op" id="8642942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642946">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8642949">}</span><br>
<span class="lineno"></span><span class="op" id="8642951">}</span>
</div>
</body>
</html>
