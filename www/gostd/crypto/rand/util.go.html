<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rand</h2>
<ul>
<li><a href="/gostd/crypto/rand/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand.go.html">rand.go</a></li>
<li><a href="/gostd/crypto/rand/rand_linux.go.html">rand_linux.go</a></li>
<li><a href="/gostd/crypto/rand/rand_test.go.html">rand_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand_unix.go.html">rand_unix.go</a></li>
<li><a href="/gostd/crypto/rand/util.go.html" class="current">util.go</a></li>
<li><a href="/gostd/crypto/rand/util_test.go.html">util_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3687244">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3687300">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3687354">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3687405">package</span>&nbsp;<span class="ident" id="3687413">rand</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3687419">import</span>&nbsp;<span class="op" id="3687426">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3687429">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3687439">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3687445">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="3687456">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3687459">//&nbsp;smallPrimes&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;small,&nbsp;prime&nbsp;numbers&nbsp;that&nbsp;allows&nbsp;us&nbsp;to&nbsp;rapidly</span><br>
<span class="lineno"></span><span class="comment" id="3687534">//&nbsp;exclude&nbsp;some&nbsp;fraction&nbsp;of&nbsp;composite&nbsp;candidates&nbsp;when&nbsp;searching&nbsp;for&nbsp;a&nbsp;random</span><br>
<span class="lineno">15</span><span class="comment" id="3687611">//&nbsp;prime.&nbsp;This&nbsp;list&nbsp;is&nbsp;truncated&nbsp;at&nbsp;the&nbsp;point&nbsp;where&nbsp;smallPrimesProduct&nbsp;exceeds</span><br>
<span class="lineno"></span><span class="comment" id="3687690">//&nbsp;a&nbsp;uint64.&nbsp;It&nbsp;does&nbsp;not&nbsp;include&nbsp;two&nbsp;because&nbsp;we&nbsp;ensure&nbsp;that&nbsp;the&nbsp;candidates&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="3687769">//&nbsp;odd&nbsp;by&nbsp;construction.</span><br>
<span class="lineno"></span><span class="keyword" id="3687793">var</span>&nbsp;<span class="ident" id="3687797">smallPrimes</span>&nbsp;<span class="op" id="3687809">=</span>&nbsp;<span class="op" id="3687811">[</span><span class="op" id="3687812">]</span><span class="builtintype" id="3687813">uint8</span><span class="op" id="3687818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="3687821">3</span><span class="op" id="3687822">,</span>&nbsp;<span class="num" id="3687824">5</span><span class="op" id="3687825">,</span>&nbsp;<span class="num" id="3687827">7</span><span class="op" id="3687828">,</span>&nbsp;<span class="num" id="3687830">11</span><span class="op" id="3687832">,</span>&nbsp;<span class="num" id="3687834">13</span><span class="op" id="3687836">,</span>&nbsp;<span class="num" id="3687838">17</span><span class="op" id="3687840">,</span>&nbsp;<span class="num" id="3687842">19</span><span class="op" id="3687844">,</span>&nbsp;<span class="num" id="3687846">23</span><span class="op" id="3687848">,</span>&nbsp;<span class="num" id="3687850">29</span><span class="op" id="3687852">,</span>&nbsp;<span class="num" id="3687854">31</span><span class="op" id="3687856">,</span>&nbsp;<span class="num" id="3687858">37</span><span class="op" id="3687860">,</span>&nbsp;<span class="num" id="3687862">41</span><span class="op" id="3687864">,</span>&nbsp;<span class="num" id="3687866">43</span><span class="op" id="3687868">,</span>&nbsp;<span class="num" id="3687870">47</span><span class="op" id="3687872">,</span>&nbsp;<span class="num" id="3687874">53</span><span class="op" id="3687876">,</span><br>
<span class="lineno">20</span><span class="op" id="3687878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3687881">//&nbsp;smallPrimesProduct&nbsp;is&nbsp;the&nbsp;product&nbsp;of&nbsp;the&nbsp;values&nbsp;in&nbsp;smallPrimes&nbsp;and&nbsp;allows&nbsp;us</span><br>
<span class="lineno"></span><span class="comment" id="3687961">//&nbsp;to&nbsp;reduce&nbsp;a&nbsp;candidate&nbsp;prime&nbsp;by&nbsp;this&nbsp;number&nbsp;and&nbsp;then&nbsp;determine&nbsp;whether&nbsp;it&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3688039">//&nbsp;coprime&nbsp;to&nbsp;all&nbsp;the&nbsp;elements&nbsp;of&nbsp;smallPrimes&nbsp;without&nbsp;further&nbsp;big.Int</span><br>
<span class="lineno">25</span><span class="comment" id="3688109">//&nbsp;operations.</span><br>
<span class="lineno"></span><span class="keyword" id="3688124">var</span>&nbsp;<span class="ident" id="3688128">smallPrimesProduct</span>&nbsp;<span class="op" id="3688147">=</span>&nbsp;<span class="builtinfunc" id="3688149">new</span><span class="op" id="3688152">(</span><span class="ident" id="3688153">big</span><span class="op" id="3688156">.</span><span class="ident" id="3688157">Int</span><span class="op" id="3688160">)</span><span class="op" id="3688161">.</span><span class="ident" id="3688162">SetUint64</span><span class="op" id="3688171">(</span><span class="num" id="3688172">16294579238595022365</span><span class="op" id="3688192">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3688195">//&nbsp;Prime&nbsp;returns&nbsp;a&nbsp;number,&nbsp;p,&nbsp;of&nbsp;the&nbsp;given&nbsp;size,&nbsp;such&nbsp;that&nbsp;p&nbsp;is&nbsp;prime</span><br>
<span class="lineno"></span><span class="comment" id="3688265">//&nbsp;with&nbsp;high&nbsp;probability.</span><br>
<span class="lineno">30</span><span class="comment" id="3688291">//&nbsp;Prime&nbsp;will&nbsp;return&nbsp;error&nbsp;for&nbsp;any&nbsp;error&nbsp;returned&nbsp;by&nbsp;rand.Read&nbsp;or&nbsp;if&nbsp;bits&nbsp;&lt;&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="3688370">func</span>&nbsp;<span class="ident" id="3688375">Prime</span><span class="op" id="3688380">(</span><span class="ident" id="3688381">rand</span>&nbsp;<span class="ident" id="3688386">io</span><span class="op" id="3688388">.</span><span class="ident" id="3688389">Reader</span><span class="op" id="3688395">,</span>&nbsp;<span class="ident" id="3688397">bits</span>&nbsp;<span class="builtintype" id="3688402">int</span><span class="op" id="3688405">)</span>&nbsp;<span class="op" id="3688407">(</span><span class="ident" id="3688408">p</span>&nbsp;<span class="op" id="3688410">*</span><span class="ident" id="3688411">big</span><span class="op" id="3688414">.</span><span class="ident" id="3688415">Int</span><span class="op" id="3688418">,</span>&nbsp;<span class="ident" id="3688420">err</span>&nbsp;<span class="builtintype" id="3688424">error</span><span class="op" id="3688429">)</span>&nbsp;<span class="op" id="3688431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3688434">if</span>&nbsp;<span class="ident" id="3688437">bits</span>&nbsp;<span class="op" id="3688442">&lt;</span>&nbsp;<span class="num" id="3688444">2</span>&nbsp;<span class="op" id="3688446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3688450">err</span>&nbsp;<span class="op" id="3688454">=</span>&nbsp;<span class="ident" id="3688456">errors</span><span class="op" id="3688462">.</span><span class="ident" id="3688463">New</span><span class="op" id="3688466">(</span><span class="string" id="3688467">&#34;crypto/rand:&nbsp;prime&nbsp;size&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;2-bit&#34;</span><span class="op" id="3688515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3688519">return</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3688527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3688531">b</span>&nbsp;<span class="op" id="3688533">:=</span>&nbsp;<span class="builtintype" id="3688536">uint</span><span class="op" id="3688540">(</span><span class="ident" id="3688541">bits</span>&nbsp;<span class="op" id="3688546">%</span>&nbsp;<span class="num" id="3688548">8</span><span class="op" id="3688549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3688552">if</span>&nbsp;<span class="ident" id="3688555">b</span>&nbsp;<span class="op" id="3688557">==</span>&nbsp;<span class="num" id="3688560">0</span>&nbsp;<span class="op" id="3688562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3688566">b</span>&nbsp;<span class="op" id="3688568">=</span>&nbsp;<span class="num" id="3688570">8</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3688573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3688577">bytes</span>&nbsp;<span class="op" id="3688583">:=</span>&nbsp;<span class="builtinfunc" id="3688586">make</span><span class="op" id="3688590">(</span><span class="op" id="3688591">[</span><span class="op" id="3688592">]</span><span class="builtintype" id="3688593">byte</span><span class="op" id="3688597">,</span>&nbsp;<span class="op" id="3688599">(</span><span class="ident" id="3688600">bits</span><span class="op" id="3688604">+</span><span class="num" id="3688605">7</span><span class="op" id="3688606">)</span><span class="op" id="3688607">/</span><span class="num" id="3688608">8</span><span class="op" id="3688609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3688612">p</span>&nbsp;<span class="op" id="3688614">=</span>&nbsp;<span class="builtinfunc" id="3688616">new</span><span class="op" id="3688619">(</span><span class="ident" id="3688620">big</span><span class="op" id="3688623">.</span><span class="ident" id="3688624">Int</span><span class="op" id="3688627">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3688631">bigMod</span>&nbsp;<span class="op" id="3688638">:=</span>&nbsp;<span class="builtinfunc" id="3688641">new</span><span class="op" id="3688644">(</span><span class="ident" id="3688645">big</span><span class="op" id="3688648">.</span><span class="ident" id="3688649">Int</span><span class="op" id="3688652">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3688656">for</span>&nbsp;<span class="op" id="3688660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3688664">_</span><span class="op" id="3688665">,</span>&nbsp;<span class="ident" id="3688667">err</span>&nbsp;<span class="op" id="3688671">=</span>&nbsp;<span class="ident" id="3688673">io</span><span class="op" id="3688675">.</span><span class="ident" id="3688676">ReadFull</span><span class="op" id="3688684">(</span><span class="ident" id="3688685">rand</span><span class="op" id="3688689">,</span>&nbsp;<span class="ident" id="3688691">bytes</span><span class="op" id="3688696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3688700">if</span>&nbsp;<span class="ident" id="3688703">err</span>&nbsp;<span class="op" id="3688707">!=</span>&nbsp;<span class="ident" id="3688710">nil</span>&nbsp;<span class="op" id="3688714">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3688719">return</span>&nbsp;<span class="ident" id="3688726">nil</span><span class="op" id="3688729">,</span>&nbsp;<span class="ident" id="3688731">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3688737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3688742">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;candidate&nbsp;has&nbsp;a&nbsp;size&nbsp;&lt;=&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3688823">bytes</span><span class="op" id="3688828">[</span><span class="num" id="3688829">0</span><span class="op" id="3688830">]</span>&nbsp;<span class="op" id="3688832">&amp;=</span>&nbsp;<span class="builtintype" id="3688835">uint8</span><span class="op" id="3688840">(</span><span class="builtintype" id="3688841">int</span><span class="op" id="3688844">(</span><span class="num" id="3688845">1</span><span class="op" id="3688846">&lt;&lt;</span><span class="ident" id="3688848">b</span><span class="op" id="3688849">)</span>&nbsp;<span class="op" id="3688851">-</span>&nbsp;<span class="num" id="3688853">1</span><span class="op" id="3688854">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3688858">//&nbsp;Don&#39;t&nbsp;let&nbsp;the&nbsp;value&nbsp;be&nbsp;too&nbsp;small,&nbsp;i.e,&nbsp;set&nbsp;the&nbsp;most&nbsp;significant&nbsp;two&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3688937">//&nbsp;Setting&nbsp;the&nbsp;top&nbsp;two&nbsp;bits,&nbsp;rather&nbsp;than&nbsp;just&nbsp;the&nbsp;top&nbsp;bit,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3688998">//&nbsp;means&nbsp;that&nbsp;when&nbsp;two&nbsp;of&nbsp;these&nbsp;values&nbsp;are&nbsp;multiplied&nbsp;together,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3689064">//&nbsp;the&nbsp;result&nbsp;isn&#39;t&nbsp;ever&nbsp;one&nbsp;bit&nbsp;short.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3689106">if</span>&nbsp;<span class="ident" id="3689109">b</span>&nbsp;<span class="op" id="3689111">&gt;=</span>&nbsp;<span class="num" id="3689114">2</span>&nbsp;<span class="op" id="3689116">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3689121">bytes</span><span class="op" id="3689126">[</span><span class="num" id="3689127">0</span><span class="op" id="3689128">]</span>&nbsp;<span class="op" id="3689130">|=</span>&nbsp;<span class="num" id="3689133">3</span>&nbsp;<span class="op" id="3689135">&lt;&lt;</span>&nbsp;<span class="op" id="3689138">(</span><span class="ident" id="3689139">b</span>&nbsp;<span class="op" id="3689141">-</span>&nbsp;<span class="num" id="3689143">2</span><span class="op" id="3689144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3689148">}</span>&nbsp;<span class="keyword" id="3689150">else</span>&nbsp;<span class="op" id="3689155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3689160">//&nbsp;Here&nbsp;b==1,&nbsp;because&nbsp;b&nbsp;cannot&nbsp;be&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3689203">bytes</span><span class="op" id="3689208">[</span><span class="num" id="3689209">0</span><span class="op" id="3689210">]</span>&nbsp;<span class="op" id="3689212">|=</span>&nbsp;<span class="num" id="3689215">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3689220">if</span>&nbsp;<span class="builtinfunc" id="3689223">len</span><span class="op" id="3689226">(</span><span class="ident" id="3689227">bytes</span><span class="op" id="3689232">)</span>&nbsp;<span class="op" id="3689234">&gt;</span>&nbsp;<span class="num" id="3689236">1</span>&nbsp;<span class="op" id="3689238">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3689244">bytes</span><span class="op" id="3689249">[</span><span class="num" id="3689250">1</span><span class="op" id="3689251">]</span>&nbsp;<span class="op" id="3689253">|=</span>&nbsp;<span class="num" id="3689256">0x80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3689264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3689268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3689272">//&nbsp;Make&nbsp;the&nbsp;value&nbsp;odd&nbsp;since&nbsp;an&nbsp;even&nbsp;number&nbsp;this&nbsp;large&nbsp;certainly&nbsp;isn&#39;t&nbsp;prime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3689351">bytes</span><span class="op" id="3689356">[</span><span class="builtinfunc" id="3689357">len</span><span class="op" id="3689360">(</span><span class="ident" id="3689361">bytes</span><span class="op" id="3689366">)</span><span class="op" id="3689367">-</span><span class="num" id="3689368">1</span><span class="op" id="3689369">]</span>&nbsp;<span class="op" id="3689371">|=</span>&nbsp;<span class="num" id="3689374">1</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3689379">p</span><span class="op" id="3689380">.</span><span class="ident" id="3689381">SetBytes</span><span class="op" id="3689389">(</span><span class="ident" id="3689390">bytes</span><span class="op" id="3689395">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3689400">//&nbsp;Calculate&nbsp;the&nbsp;value&nbsp;mod&nbsp;the&nbsp;product&nbsp;of&nbsp;smallPrimes.&nbsp;&nbsp;If&nbsp;it&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3689466">//&nbsp;a&nbsp;multiple&nbsp;of&nbsp;any&nbsp;of&nbsp;these&nbsp;primes&nbsp;we&nbsp;add&nbsp;two&nbsp;until&nbsp;it&nbsp;isn&#39;t.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3689532">//&nbsp;The&nbsp;probability&nbsp;of&nbsp;overflowing&nbsp;is&nbsp;minimal&nbsp;and&nbsp;can&nbsp;be&nbsp;ignored</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3689598">//&nbsp;because&nbsp;we&nbsp;still&nbsp;perform&nbsp;Miller-Rabin&nbsp;tests&nbsp;on&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3689662">bigMod</span><span class="op" id="3689668">.</span><span class="ident" id="3689669">Mod</span><span class="op" id="3689672">(</span><span class="ident" id="3689673">p</span><span class="op" id="3689674">,</span>&nbsp;<span class="ident" id="3689676">smallPrimesProduct</span><span class="op" id="3689694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3689698">mod</span>&nbsp;<span class="op" id="3689702">:=</span>&nbsp;<span class="ident" id="3689705">bigMod</span><span class="op" id="3689711">.</span><span class="ident" id="3689712">Uint64</span><span class="op" id="3689718">(</span><span class="op" id="3689719">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3689723">NextDelta</span><span class="op" id="3689732">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3689736">for</span>&nbsp;<span class="ident" id="3689740">delta</span>&nbsp;<span class="op" id="3689746">:=</span>&nbsp;<span class="ident" id="3689749">uint64</span><span class="op" id="3689755">(</span><span class="num" id="3689756">0</span><span class="op" id="3689757">)</span><span class="op" id="3689758">;</span>&nbsp;<span class="ident" id="3689760">delta</span>&nbsp;<span class="op" id="3689766">&lt;</span>&nbsp;<span class="num" id="3689768">1</span><span class="op" id="3689769">&lt;&lt;</span><span class="num" id="3689771">20</span><span class="op" id="3689773">;</span>&nbsp;<span class="ident" id="3689775">delta</span>&nbsp;<span class="op" id="3689781">+=</span>&nbsp;<span class="num" id="3689784">2</span>&nbsp;<span class="op" id="3689786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3689791">m</span>&nbsp;<span class="op" id="3689793">:=</span>&nbsp;<span class="ident" id="3689796">mod</span>&nbsp;<span class="op" id="3689800">+</span>&nbsp;<span class="ident" id="3689802">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3689811">for</span>&nbsp;<span class="ident" id="3689815">_</span><span class="op" id="3689816">,</span>&nbsp;<span class="ident" id="3689818">prime</span>&nbsp;<span class="op" id="3689824">:=</span>&nbsp;<span class="keyword" id="3689827">range</span>&nbsp;<span class="ident" id="3689833">smallPrimes</span>&nbsp;<span class="op" id="3689845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3689851">if</span>&nbsp;<span class="ident" id="3689854">m</span><span class="op" id="3689855">%</span><span class="ident" id="3689856">uint64</span><span class="op" id="3689862">(</span><span class="ident" id="3689863">prime</span><span class="op" id="3689868">)</span>&nbsp;<span class="op" id="3689870">==</span>&nbsp;<span class="num" id="3689873">0</span>&nbsp;<span class="op" id="3689875">&amp;&amp;</span>&nbsp;<span class="op" id="3689878">(</span><span class="ident" id="3689879">bits</span>&nbsp;<span class="op" id="3689884">&gt;</span>&nbsp;<span class="num" id="3689886">6</span>&nbsp;<span class="op" id="3689888">||</span>&nbsp;<span class="ident" id="3689891">m</span>&nbsp;<span class="op" id="3689893">!=</span>&nbsp;<span class="ident" id="3689896">uint64</span><span class="op" id="3689902">(</span><span class="ident" id="3689903">prime</span><span class="op" id="3689908">)</span><span class="op" id="3689909">)</span>&nbsp;<span class="op" id="3689911">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3689918">continue</span>&nbsp;<span class="ident" id="3689927">NextDelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3689941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3689946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3689952">if</span>&nbsp;<span class="ident" id="3689955">delta</span>&nbsp;<span class="op" id="3689961">&gt;</span>&nbsp;<span class="num" id="3689963">0</span>&nbsp;<span class="op" id="3689965">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3689971">bigMod</span><span class="op" id="3689977">.</span><span class="ident" id="3689978">SetUint64</span><span class="op" id="3689987">(</span><span class="ident" id="3689988">delta</span><span class="op" id="3689993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3689999">p</span><span class="op" id="3690000">.</span><span class="ident" id="3690001">Add</span><span class="op" id="3690004">(</span><span class="ident" id="3690005">p</span><span class="op" id="3690006">,</span>&nbsp;<span class="ident" id="3690008">bigMod</span><span class="op" id="3690014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3690019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3690024">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3690032">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3690037">//&nbsp;There&nbsp;is&nbsp;a&nbsp;tiny&nbsp;possibility&nbsp;that,&nbsp;by&nbsp;adding&nbsp;delta,&nbsp;we&nbsp;caused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3690103">//&nbsp;the&nbsp;number&nbsp;to&nbsp;be&nbsp;one&nbsp;bit&nbsp;too&nbsp;long.&nbsp;Thus&nbsp;we&nbsp;check&nbsp;BitLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3690164">//&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3690175">if</span>&nbsp;<span class="ident" id="3690178">p</span><span class="op" id="3690179">.</span><span class="ident" id="3690180">ProbablyPrime</span><span class="op" id="3690193">(</span><span class="num" id="3690194">20</span><span class="op" id="3690196">)</span>&nbsp;<span class="op" id="3690198">&amp;&amp;</span>&nbsp;<span class="ident" id="3690201">p</span><span class="op" id="3690202">.</span><span class="ident" id="3690203">BitLen</span><span class="op" id="3690209">(</span><span class="op" id="3690210">)</span>&nbsp;<span class="op" id="3690212">==</span>&nbsp;<span class="ident" id="3690215">bits</span>&nbsp;<span class="op" id="3690220">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3690225">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3690234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3690237">}</span><br>
<span class="lineno"></span><span class="op" id="3690239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="3690242">//&nbsp;Int&nbsp;returns&nbsp;a&nbsp;uniform&nbsp;random&nbsp;value&nbsp;in&nbsp;[0,&nbsp;max).&nbsp;It&nbsp;panics&nbsp;if&nbsp;max&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3690316">func</span>&nbsp;<span class="ident" id="3690321">Int</span><span class="op" id="3690324">(</span><span class="ident" id="3690325">rand</span>&nbsp;<span class="ident" id="3690330">io</span><span class="op" id="3690332">.</span><span class="ident" id="3690333">Reader</span><span class="op" id="3690339">,</span>&nbsp;<span class="ident" id="3690341">max</span>&nbsp;<span class="op" id="3690345">*</span><span class="ident" id="3690346">big</span><span class="op" id="3690349">.</span><span class="ident" id="3690350">Int</span><span class="op" id="3690353">)</span>&nbsp;<span class="op" id="3690355">(</span><span class="ident" id="3690356">n</span>&nbsp;<span class="op" id="3690358">*</span><span class="ident" id="3690359">big</span><span class="op" id="3690362">.</span><span class="ident" id="3690363">Int</span><span class="op" id="3690366">,</span>&nbsp;<span class="ident" id="3690368">err</span>&nbsp;<span class="builtintype" id="3690372">error</span><span class="op" id="3690377">)</span>&nbsp;<span class="op" id="3690379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3690382">if</span>&nbsp;<span class="ident" id="3690385">max</span><span class="op" id="3690388">.</span><span class="ident" id="3690389">Sign</span><span class="op" id="3690393">(</span><span class="op" id="3690394">)</span>&nbsp;<span class="op" id="3690396">&lt;=</span>&nbsp;<span class="num" id="3690399">0</span>&nbsp;<span class="op" id="3690401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3690405">panic</span><span class="op" id="3690410">(</span><span class="string" id="3690411">&#34;crypto/rand:&nbsp;argument&nbsp;to&nbsp;Int&nbsp;is&nbsp;&lt;=&nbsp;0&#34;</span><span class="op" id="3690449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3690452">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3690455">k</span>&nbsp;<span class="op" id="3690457">:=</span>&nbsp;<span class="op" id="3690460">(</span><span class="ident" id="3690461">max</span><span class="op" id="3690464">.</span><span class="ident" id="3690465">BitLen</span><span class="op" id="3690471">(</span><span class="op" id="3690472">)</span>&nbsp;<span class="op" id="3690474">+</span>&nbsp;<span class="num" id="3690476">7</span><span class="op" id="3690477">)</span>&nbsp;<span class="op" id="3690479">/</span>&nbsp;<span class="num" id="3690481">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3690485">//&nbsp;b&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;the&nbsp;most&nbsp;significant&nbsp;byte&nbsp;of&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3690550">b</span>&nbsp;<span class="op" id="3690552">:=</span>&nbsp;<span class="builtintype" id="3690555">uint</span><span class="op" id="3690559">(</span><span class="ident" id="3690560">max</span><span class="op" id="3690563">.</span><span class="ident" id="3690564">BitLen</span><span class="op" id="3690570">(</span><span class="op" id="3690571">)</span>&nbsp;<span class="op" id="3690573">%</span>&nbsp;<span class="num" id="3690575">8</span><span class="op" id="3690576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3690579">if</span>&nbsp;<span class="ident" id="3690582">b</span>&nbsp;<span class="op" id="3690584">==</span>&nbsp;<span class="num" id="3690587">0</span>&nbsp;<span class="op" id="3690589">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3690593">b</span>&nbsp;<span class="op" id="3690595">=</span>&nbsp;<span class="num" id="3690597">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3690600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3690604">bytes</span>&nbsp;<span class="op" id="3690610">:=</span>&nbsp;<span class="builtinfunc" id="3690613">make</span><span class="op" id="3690617">(</span><span class="op" id="3690618">[</span><span class="op" id="3690619">]</span><span class="builtintype" id="3690620">byte</span><span class="op" id="3690624">,</span>&nbsp;<span class="ident" id="3690626">k</span><span class="op" id="3690627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3690630">n</span>&nbsp;<span class="op" id="3690632">=</span>&nbsp;<span class="builtinfunc" id="3690634">new</span><span class="op" id="3690637">(</span><span class="ident" id="3690638">big</span><span class="op" id="3690641">.</span><span class="ident" id="3690642">Int</span><span class="op" id="3690645">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3690649">for</span>&nbsp;<span class="op" id="3690653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3690657">_</span><span class="op" id="3690658">,</span>&nbsp;<span class="ident" id="3690660">err</span>&nbsp;<span class="op" id="3690664">=</span>&nbsp;<span class="ident" id="3690666">io</span><span class="op" id="3690668">.</span><span class="ident" id="3690669">ReadFull</span><span class="op" id="3690677">(</span><span class="ident" id="3690678">rand</span><span class="op" id="3690682">,</span>&nbsp;<span class="ident" id="3690684">bytes</span><span class="op" id="3690689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3690693">if</span>&nbsp;<span class="ident" id="3690696">err</span>&nbsp;<span class="op" id="3690700">!=</span>&nbsp;<span class="ident" id="3690703">nil</span>&nbsp;<span class="op" id="3690707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3690712">return</span>&nbsp;<span class="ident" id="3690719">nil</span><span class="op" id="3690722">,</span>&nbsp;<span class="ident" id="3690724">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3690730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3690735">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;increase&nbsp;the&nbsp;probability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3690797">//&nbsp;that&nbsp;the&nbsp;candidate&nbsp;is&nbsp;&lt;&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3690831">bytes</span><span class="op" id="3690836">[</span><span class="num" id="3690837">0</span><span class="op" id="3690838">]</span>&nbsp;<span class="op" id="3690840">&amp;=</span>&nbsp;<span class="builtintype" id="3690843">uint8</span><span class="op" id="3690848">(</span><span class="builtintype" id="3690849">int</span><span class="op" id="3690852">(</span><span class="num" id="3690853">1</span><span class="op" id="3690854">&lt;&lt;</span><span class="ident" id="3690856">b</span><span class="op" id="3690857">)</span>&nbsp;<span class="op" id="3690859">-</span>&nbsp;<span class="num" id="3690861">1</span><span class="op" id="3690862">)</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3690867">n</span><span class="op" id="3690868">.</span><span class="ident" id="3690869">SetBytes</span><span class="op" id="3690877">(</span><span class="ident" id="3690878">bytes</span><span class="op" id="3690883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3690887">if</span>&nbsp;<span class="ident" id="3690890">n</span><span class="op" id="3690891">.</span><span class="ident" id="3690892">Cmp</span><span class="op" id="3690895">(</span><span class="ident" id="3690896">max</span><span class="op" id="3690899">)</span>&nbsp;<span class="op" id="3690901">&lt;</span>&nbsp;<span class="num" id="3690903">0</span>&nbsp;<span class="op" id="3690905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3690910">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3690919">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3690922">}</span><br>
<span class="lineno"></span><span class="op" id="3690924">}</span>
</div>
</body>
</html>
