<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="394494">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="394549">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="394603">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="394654">//&nbsp;Tests&nbsp;for&nbsp;client.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="394678">package</span>&nbsp;<span class="ident" id="394686">http_test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="394697">import</span>&nbsp;<span class="op" id="394704">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394707">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394716">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394730">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394745">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394764">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394774">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394781">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394787">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394800">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394807">&#34;net&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="394814">.</span>&nbsp;<span class="string" id="394816">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394828">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394849">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394860">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394871">&#34;sort&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394879">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394890">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394901">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394909">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="394920">&#34;time&#34;</span><br>
<span class="lineno">30</span><span class="op" id="394927">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="394930">var</span>&nbsp;<span class="ident" id="394934">robotsTxtHandler</span>&nbsp;<span class="op" id="394951">=</span>&nbsp;<span class="ident" id="394953">HandlerFunc</span><span class="op" id="394964">(</span><span class="keyword" id="394965">func</span><span class="op" id="394969">(</span><span class="ident" id="394970">w</span>&nbsp;<span class="ident" id="394972">ResponseWriter</span><span class="op" id="394986">,</span>&nbsp;<span class="ident" id="394988">r</span>&nbsp;<span class="op" id="394990">*</span><span class="ident" id="394991">Request</span><span class="op" id="394998">)</span>&nbsp;<span class="op" id="395000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="395003">w</span><span class="op" id="395004">.</span><span class="ident" id="395005">Header</span><span class="op" id="395011">(</span><span class="op" id="395012">)</span><span class="op" id="395013">.</span><span class="ident" id="395014">Set</span><span class="op" id="395017">(</span><span class="string" id="395018">&#34;Last-Modified&#34;</span><span class="op" id="395033">,</span>&nbsp;<span class="string" id="395035">&#34;sometime&#34;</span><span class="op" id="395045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="395048">fmt</span><span class="op" id="395051">.</span><span class="ident" id="395052">Fprintf</span><span class="op" id="395059">(</span><span class="ident" id="395060">w</span><span class="op" id="395061">,</span>&nbsp;<span class="string" id="395063">&#34;User-agent:&nbsp;go\nDisallow:&nbsp;/something/&#34;</span><span class="op" id="395102">)</span><br>
<span class="lineno">35</span><span class="op" id="395104">}</span><span class="op" id="395105">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="395108">//&nbsp;pedanticReadAll&nbsp;works&nbsp;like&nbsp;ioutil.ReadAll&nbsp;but&nbsp;additionally</span><br>
<span class="lineno"></span><span class="comment" id="395170">//&nbsp;verifies&nbsp;that&nbsp;r&nbsp;obeys&nbsp;the&nbsp;documented&nbsp;io.Reader&nbsp;contract.</span><br>
<span class="lineno"></span><span class="keyword" id="395230">func</span>&nbsp;<span class="ident" id="395235">pedanticReadAll</span><span class="op" id="395250">(</span><span class="ident" id="395251">r</span>&nbsp;<span class="ident" id="395253">io</span><span class="op" id="395255">.</span><span class="ident" id="395256">Reader</span><span class="op" id="395262">)</span>&nbsp;<span class="op" id="395264">(</span><span class="ident" id="395265">b</span>&nbsp;<span class="op" id="395267">[</span><span class="op" id="395268">]</span><span class="builtintype" id="395269">byte</span><span class="op" id="395273">,</span>&nbsp;<span class="ident" id="395275">err</span>&nbsp;<span class="builtintype" id="395279">error</span><span class="op" id="395284">)</span>&nbsp;<span class="op" id="395286">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="395289">var</span>&nbsp;<span class="ident" id="395293">bufa</span>&nbsp;<span class="op" id="395298">[</span><span class="num" id="395299">64</span><span class="op" id="395301">]</span><span class="builtintype" id="395302">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="395308">buf</span>&nbsp;<span class="op" id="395312">:=</span>&nbsp;<span class="ident" id="395315">bufa</span><span class="op" id="395319">[</span><span class="op" id="395320">:</span><span class="op" id="395321">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="395324">for</span>&nbsp;<span class="op" id="395328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="395332">n</span><span class="op" id="395333">,</span>&nbsp;<span class="ident" id="395335">err</span>&nbsp;<span class="op" id="395339">:=</span>&nbsp;<span class="ident" id="395342">r</span><span class="op" id="395343">.</span><span class="ident" id="395344">Read</span><span class="op" id="395348">(</span><span class="ident" id="395349">buf</span><span class="op" id="395352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="395356">if</span>&nbsp;<span class="ident" id="395359">n</span>&nbsp;<span class="op" id="395361">==</span>&nbsp;<span class="num" id="395364">0</span>&nbsp;<span class="op" id="395366">&amp;&amp;</span>&nbsp;<span class="ident" id="395369">err</span>&nbsp;<span class="op" id="395373">==</span>&nbsp;<span class="ident" id="395376">nil</span>&nbsp;<span class="op" id="395380">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="395385">return</span>&nbsp;<span class="ident" id="395392">nil</span><span class="op" id="395395">,</span>&nbsp;<span class="ident" id="395397">fmt</span><span class="op" id="395400">.</span><span class="ident" id="395401">Errorf</span><span class="op" id="395407">(</span><span class="string" id="395408">&#34;Read:&nbsp;n=0&nbsp;with&nbsp;err=nil&#34;</span><span class="op" id="395432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="395436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="395440">b</span>&nbsp;<span class="op" id="395442">=</span>&nbsp;<span class="builtinfunc" id="395444">append</span><span class="op" id="395450">(</span><span class="ident" id="395451">b</span><span class="op" id="395452">,</span>&nbsp;<span class="ident" id="395454">buf</span><span class="op" id="395457">[</span><span class="op" id="395458">:</span><span class="ident" id="395459">n</span><span class="op" id="395460">]</span><span class="op" id="395461">...</span><span class="op" id="395464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="395468">if</span>&nbsp;<span class="ident" id="395471">err</span>&nbsp;<span class="op" id="395475">==</span>&nbsp;<span class="ident" id="395478">io</span><span class="op" id="395480">.</span><span class="ident" id="395481">EOF</span>&nbsp;<span class="op" id="395485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="395490">n</span><span class="op" id="395491">,</span>&nbsp;<span class="ident" id="395493">err</span>&nbsp;<span class="op" id="395497">:=</span>&nbsp;<span class="ident" id="395500">r</span><span class="op" id="395501">.</span><span class="ident" id="395502">Read</span><span class="op" id="395506">(</span><span class="ident" id="395507">buf</span><span class="op" id="395510">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="395515">if</span>&nbsp;<span class="ident" id="395518">n</span>&nbsp;<span class="op" id="395520">!=</span>&nbsp;<span class="num" id="395523">0</span>&nbsp;<span class="op" id="395525">||</span>&nbsp;<span class="ident" id="395528">err</span>&nbsp;<span class="op" id="395532">!=</span>&nbsp;<span class="ident" id="395535">io</span><span class="op" id="395537">.</span><span class="ident" id="395538">EOF</span>&nbsp;<span class="op" id="395542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="395548">return</span>&nbsp;<span class="ident" id="395555">nil</span><span class="op" id="395558">,</span>&nbsp;<span class="ident" id="395560">fmt</span><span class="op" id="395563">.</span><span class="ident" id="395564">Errorf</span><span class="op" id="395570">(</span><span class="string" id="395571">&#34;Read:&nbsp;n=%d&nbsp;err=%#v&nbsp;after&nbsp;EOF&#34;</span><span class="op" id="395601">,</span>&nbsp;<span class="ident" id="395603">n</span><span class="op" id="395604">,</span>&nbsp;<span class="ident" id="395606">err</span><span class="op" id="395609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="395614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="395619">return</span>&nbsp;<span class="ident" id="395626">b</span><span class="op" id="395627">,</span>&nbsp;<span class="ident" id="395629">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="395635">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="395639">if</span>&nbsp;<span class="ident" id="395642">err</span>&nbsp;<span class="op" id="395646">!=</span>&nbsp;<span class="ident" id="395649">nil</span>&nbsp;<span class="op" id="395653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="395658">return</span>&nbsp;<span class="ident" id="395665">b</span><span class="op" id="395666">,</span>&nbsp;<span class="ident" id="395668">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="395674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="395677">}</span><br>
<span class="lineno"></span><span class="op" id="395679">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="395682">type</span>&nbsp;<span class="ident" id="395687">chanWriter</span>&nbsp;<span class="keyword" id="395698">chan</span>&nbsp;<span class="builtintype" id="395703">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="395711">func</span>&nbsp;<span class="op" id="395716">(</span><span class="ident" id="395717">w</span>&nbsp;<span class="ident" id="395719">chanWriter</span><span class="op" id="395729">)</span>&nbsp;<span class="ident" id="395731">Write</span><span class="op" id="395736">(</span><span class="ident" id="395737">p</span>&nbsp;<span class="op" id="395739">[</span><span class="op" id="395740">]</span><span class="builtintype" id="395741">byte</span><span class="op" id="395745">)</span>&nbsp;<span class="op" id="395747">(</span><span class="ident" id="395748">n</span>&nbsp;<span class="builtintype" id="395750">int</span><span class="op" id="395753">,</span>&nbsp;<span class="ident" id="395755">err</span>&nbsp;<span class="builtintype" id="395759">error</span><span class="op" id="395764">)</span>&nbsp;<span class="op" id="395766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="395769">w</span>&nbsp;<span class="op" id="395771">&lt;-</span>&nbsp;<span class="builtintype" id="395774">string</span><span class="op" id="395780">(</span><span class="ident" id="395781">p</span><span class="op" id="395782">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="395785">return</span>&nbsp;<span class="builtinfunc" id="395792">len</span><span class="op" id="395795">(</span><span class="ident" id="395796">p</span><span class="op" id="395797">)</span><span class="op" id="395798">,</span>&nbsp;<span class="ident" id="395800">nil</span><br>
<span class="lineno"></span><span class="op" id="395804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="395807">func</span>&nbsp;<span class="ident" id="395812">TestClient</span><span class="op" id="395822">(</span><span class="ident" id="395823">t</span>&nbsp;<span class="op" id="395825">*</span><span class="ident" id="395826">testing</span><span class="op" id="395833">.</span><span class="ident" id="395834">T</span><span class="op" id="395835">)</span>&nbsp;<span class="op" id="395837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="395840">defer</span>&nbsp;<span class="ident" id="395846">afterTest</span><span class="op" id="395855">(</span><span class="ident" id="395856">t</span><span class="op" id="395857">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="395860">ts</span>&nbsp;<span class="op" id="395863">:=</span>&nbsp;<span class="ident" id="395866">httptest</span><span class="op" id="395874">.</span><span class="ident" id="395875">NewServer</span><span class="op" id="395884">(</span><span class="ident" id="395885">robotsTxtHandler</span><span class="op" id="395901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="395904">defer</span>&nbsp;<span class="ident" id="395910">ts</span><span class="op" id="395912">.</span><span class="ident" id="395913">Close</span><span class="op" id="395918">(</span><span class="op" id="395919">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="395923">r</span><span class="op" id="395924">,</span>&nbsp;<span class="ident" id="395926">err</span>&nbsp;<span class="op" id="395930">:=</span>&nbsp;<span class="ident" id="395933">Get</span><span class="op" id="395936">(</span><span class="ident" id="395937">ts</span><span class="op" id="395939">.</span><span class="ident" id="395940">URL</span><span class="op" id="395943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="395946">var</span>&nbsp;<span class="ident" id="395950">b</span>&nbsp;<span class="op" id="395952">[</span><span class="op" id="395953">]</span><span class="builtintype" id="395954">byte</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="395960">if</span>&nbsp;<span class="ident" id="395963">err</span>&nbsp;<span class="op" id="395967">==</span>&nbsp;<span class="ident" id="395970">nil</span>&nbsp;<span class="op" id="395974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="395978">b</span><span class="op" id="395979">,</span>&nbsp;<span class="ident" id="395981">err</span>&nbsp;<span class="op" id="395985">=</span>&nbsp;<span class="ident" id="395987">pedanticReadAll</span><span class="op" id="396002">(</span><span class="ident" id="396003">r</span><span class="op" id="396004">.</span><span class="ident" id="396005">Body</span><span class="op" id="396009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="396013">r</span><span class="op" id="396014">.</span><span class="ident" id="396015">Body</span><span class="op" id="396019">.</span><span class="ident" id="396020">Close</span><span class="op" id="396025">(</span><span class="op" id="396026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="396029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="396032">if</span>&nbsp;<span class="ident" id="396035">err</span>&nbsp;<span class="op" id="396039">!=</span>&nbsp;<span class="ident" id="396042">nil</span>&nbsp;<span class="op" id="396046">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="396050">t</span><span class="op" id="396051">.</span><span class="ident" id="396052">Error</span><span class="op" id="396057">(</span><span class="ident" id="396058">err</span><span class="op" id="396061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="396064">}</span>&nbsp;<span class="keyword" id="396066">else</span>&nbsp;<span class="keyword" id="396071">if</span>&nbsp;<span class="ident" id="396074">s</span>&nbsp;<span class="op" id="396076">:=</span>&nbsp;<span class="builtintype" id="396079">string</span><span class="op" id="396085">(</span><span class="ident" id="396086">b</span><span class="op" id="396087">)</span><span class="op" id="396088">;</span>&nbsp;<span class="op" id="396090">!</span><span class="ident" id="396091">strings</span><span class="op" id="396098">.</span><span class="ident" id="396099">HasPrefix</span><span class="op" id="396108">(</span><span class="ident" id="396109">s</span><span class="op" id="396110">,</span>&nbsp;<span class="string" id="396112">&#34;User-agent:&#34;</span><span class="op" id="396125">)</span>&nbsp;<span class="op" id="396127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="396131">t</span><span class="op" id="396132">.</span><span class="ident" id="396133">Errorf</span><span class="op" id="396139">(</span><span class="string" id="396140">&#34;Incorrect&nbsp;page&nbsp;body&nbsp;(did&nbsp;not&nbsp;begin&nbsp;with&nbsp;User-agent):&nbsp;%q&#34;</span><span class="op" id="396197">,</span>&nbsp;<span class="ident" id="396199">s</span><span class="op" id="396200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="396203">}</span><br>
<span class="lineno"></span><span class="op" id="396205">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="396208">func</span>&nbsp;<span class="ident" id="396213">TestClientHead</span><span class="op" id="396227">(</span><span class="ident" id="396228">t</span>&nbsp;<span class="op" id="396230">*</span><span class="ident" id="396231">testing</span><span class="op" id="396238">.</span><span class="ident" id="396239">T</span><span class="op" id="396240">)</span>&nbsp;<span class="op" id="396242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="396245">defer</span>&nbsp;<span class="ident" id="396251">afterTest</span><span class="op" id="396260">(</span><span class="ident" id="396261">t</span><span class="op" id="396262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="396265">ts</span>&nbsp;<span class="op" id="396268">:=</span>&nbsp;<span class="ident" id="396271">httptest</span><span class="op" id="396279">.</span><span class="ident" id="396280">NewServer</span><span class="op" id="396289">(</span><span class="ident" id="396290">robotsTxtHandler</span><span class="op" id="396306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="396309">defer</span>&nbsp;<span class="ident" id="396315">ts</span><span class="op" id="396317">.</span><span class="ident" id="396318">Close</span><span class="op" id="396323">(</span><span class="op" id="396324">)</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="396328">r</span><span class="op" id="396329">,</span>&nbsp;<span class="ident" id="396331">err</span>&nbsp;<span class="op" id="396335">:=</span>&nbsp;<span class="ident" id="396338">Head</span><span class="op" id="396342">(</span><span class="ident" id="396343">ts</span><span class="op" id="396345">.</span><span class="ident" id="396346">URL</span><span class="op" id="396349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="396352">if</span>&nbsp;<span class="ident" id="396355">err</span>&nbsp;<span class="op" id="396359">!=</span>&nbsp;<span class="ident" id="396362">nil</span>&nbsp;<span class="op" id="396366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="396370">t</span><span class="op" id="396371">.</span><span class="ident" id="396372">Fatal</span><span class="op" id="396377">(</span><span class="ident" id="396378">err</span><span class="op" id="396381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="396384">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="396387">if</span>&nbsp;<span class="ident" id="396390">_</span><span class="op" id="396391">,</span>&nbsp;<span class="ident" id="396393">ok</span>&nbsp;<span class="op" id="396396">:=</span>&nbsp;<span class="ident" id="396399">r</span><span class="op" id="396400">.</span><span class="ident" id="396401">Header</span><span class="op" id="396407">[</span><span class="string" id="396408">&#34;Last-Modified&#34;</span><span class="op" id="396423">]</span><span class="op" id="396424">;</span>&nbsp;<span class="op" id="396426">!</span><span class="ident" id="396427">ok</span>&nbsp;<span class="op" id="396430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="396434">t</span><span class="op" id="396435">.</span><span class="ident" id="396436">Error</span><span class="op" id="396441">(</span><span class="string" id="396442">&#34;Last-Modified&nbsp;header&nbsp;not&nbsp;found.&#34;</span><span class="op" id="396475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="396478">}</span><br>
<span class="lineno"></span><span class="op" id="396480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="396483">type</span>&nbsp;<span class="ident" id="396488">recordingTransport</span>&nbsp;<span class="keyword" id="396507">struct</span>&nbsp;<span class="op" id="396514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="396517">req</span>&nbsp;<span class="op" id="396521">*</span><span class="ident" id="396522">Request</span><br>
<span class="lineno"></span><span class="op" id="396530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="396533">func</span>&nbsp;<span class="op" id="396538">(</span><span class="ident" id="396539">t</span>&nbsp;<span class="op" id="396541">*</span><span class="ident" id="396542">recordingTransport</span><span class="op" id="396560">)</span>&nbsp;<span class="ident" id="396562">RoundTrip</span><span class="op" id="396571">(</span><span class="ident" id="396572">req</span>&nbsp;<span class="op" id="396576">*</span><span class="ident" id="396577">Request</span><span class="op" id="396584">)</span>&nbsp;<span class="op" id="396586">(</span><span class="ident" id="396587">resp</span>&nbsp;<span class="op" id="396592">*</span><span class="ident" id="396593">Response</span><span class="op" id="396601">,</span>&nbsp;<span class="ident" id="396603">err</span>&nbsp;<span class="builtintype" id="396607">error</span><span class="op" id="396612">)</span>&nbsp;<span class="op" id="396614">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="396617">t</span><span class="op" id="396618">.</span><span class="ident" id="396619">req</span>&nbsp;<span class="op" id="396623">=</span>&nbsp;<span class="ident" id="396625">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="396630">return</span>&nbsp;<span class="ident" id="396637">nil</span><span class="op" id="396640">,</span>&nbsp;<span class="ident" id="396642">errors</span><span class="op" id="396648">.</span><span class="ident" id="396649">New</span><span class="op" id="396652">(</span><span class="string" id="396653">&#34;dummy&nbsp;impl&#34;</span><span class="op" id="396665">)</span><br>
<span class="lineno"></span><span class="op" id="396667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="396670">func</span>&nbsp;<span class="ident" id="396675">TestGetRequestFormat</span><span class="op" id="396695">(</span><span class="ident" id="396696">t</span>&nbsp;<span class="op" id="396698">*</span><span class="ident" id="396699">testing</span><span class="op" id="396706">.</span><span class="ident" id="396707">T</span><span class="op" id="396708">)</span>&nbsp;<span class="op" id="396710">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="396713">defer</span>&nbsp;<span class="ident" id="396719">afterTest</span><span class="op" id="396728">(</span><span class="ident" id="396729">t</span><span class="op" id="396730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="396733">tr</span>&nbsp;<span class="op" id="396736">:=</span>&nbsp;<span class="op" id="396739">&amp;</span><span class="ident" id="396740">recordingTransport</span><span class="op" id="396758">{</span><span class="op" id="396759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="396762">client</span>&nbsp;<span class="op" id="396769">:=</span>&nbsp;<span class="op" id="396772">&amp;</span><span class="ident" id="396773">Client</span><span class="op" id="396779">{</span><span class="ident" id="396780">Transport</span><span class="op" id="396789">:</span>&nbsp;<span class="ident" id="396791">tr</span><span class="op" id="396793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="396796">url</span>&nbsp;<span class="op" id="396800">:=</span>&nbsp;<span class="string" id="396803">&#34;http://dummy.faketld/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="396828">client</span><span class="op" id="396834">.</span><span class="ident" id="396835">Get</span><span class="op" id="396838">(</span><span class="ident" id="396839">url</span><span class="op" id="396842">)</span>&nbsp;<span class="comment" id="396844">//&nbsp;Note:&nbsp;doesn&#39;t&nbsp;hit&nbsp;network</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="396874">if</span>&nbsp;<span class="ident" id="396877">tr</span><span class="op" id="396879">.</span><span class="ident" id="396880">req</span><span class="op" id="396883">.</span><span class="ident" id="396884">Method</span>&nbsp;<span class="op" id="396891">!=</span>&nbsp;<span class="string" id="396894">&#34;GET&#34;</span>&nbsp;<span class="op" id="396900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="396904">t</span><span class="op" id="396905">.</span><span class="ident" id="396906">Errorf</span><span class="op" id="396912">(</span><span class="string" id="396913">&#34;expected&nbsp;method&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="396941">,</span>&nbsp;<span class="string" id="396943">&#34;GET&#34;</span><span class="op" id="396948">,</span>&nbsp;<span class="ident" id="396950">tr</span><span class="op" id="396952">.</span><span class="ident" id="396953">req</span><span class="op" id="396956">.</span><span class="ident" id="396957">Method</span><span class="op" id="396963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="396966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="396969">if</span>&nbsp;<span class="ident" id="396972">tr</span><span class="op" id="396974">.</span><span class="ident" id="396975">req</span><span class="op" id="396978">.</span><span class="ident" id="396979">URL</span><span class="op" id="396982">.</span><span class="ident" id="396983">String</span><span class="op" id="396989">(</span><span class="op" id="396990">)</span>&nbsp;<span class="op" id="396992">!=</span>&nbsp;<span class="ident" id="396995">url</span>&nbsp;<span class="op" id="396999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="397003">t</span><span class="op" id="397004">.</span><span class="ident" id="397005">Errorf</span><span class="op" id="397011">(</span><span class="string" id="397012">&#34;expected&nbsp;URL&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="397037">,</span>&nbsp;<span class="ident" id="397039">url</span><span class="op" id="397042">,</span>&nbsp;<span class="ident" id="397044">tr</span><span class="op" id="397046">.</span><span class="ident" id="397047">req</span><span class="op" id="397050">.</span><span class="ident" id="397051">URL</span><span class="op" id="397054">.</span><span class="ident" id="397055">String</span><span class="op" id="397061">(</span><span class="op" id="397062">)</span><span class="op" id="397063">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="397066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="397069">if</span>&nbsp;<span class="ident" id="397072">tr</span><span class="op" id="397074">.</span><span class="ident" id="397075">req</span><span class="op" id="397078">.</span><span class="ident" id="397079">Header</span>&nbsp;<span class="op" id="397086">==</span>&nbsp;<span class="ident" id="397089">nil</span>&nbsp;<span class="op" id="397093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="397097">t</span><span class="op" id="397098">.</span><span class="ident" id="397099">Errorf</span><span class="op" id="397105">(</span><span class="string" id="397106">&#34;expected&nbsp;non-nil&nbsp;request&nbsp;Header&#34;</span><span class="op" id="397139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="397142">}</span><br>
<span class="lineno"></span><span class="op" id="397144">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="397147">func</span>&nbsp;<span class="ident" id="397152">TestPostRequestFormat</span><span class="op" id="397173">(</span><span class="ident" id="397174">t</span>&nbsp;<span class="op" id="397176">*</span><span class="ident" id="397177">testing</span><span class="op" id="397184">.</span><span class="ident" id="397185">T</span><span class="op" id="397186">)</span>&nbsp;<span class="op" id="397188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="397191">defer</span>&nbsp;<span class="ident" id="397197">afterTest</span><span class="op" id="397206">(</span><span class="ident" id="397207">t</span><span class="op" id="397208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="397211">tr</span>&nbsp;<span class="op" id="397214">:=</span>&nbsp;<span class="op" id="397217">&amp;</span><span class="ident" id="397218">recordingTransport</span><span class="op" id="397236">{</span><span class="op" id="397237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="397240">client</span>&nbsp;<span class="op" id="397247">:=</span>&nbsp;<span class="op" id="397250">&amp;</span><span class="ident" id="397251">Client</span><span class="op" id="397257">{</span><span class="ident" id="397258">Transport</span><span class="op" id="397267">:</span>&nbsp;<span class="ident" id="397269">tr</span><span class="op" id="397271">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="397275">url</span>&nbsp;<span class="op" id="397279">:=</span>&nbsp;<span class="string" id="397282">&#34;http://dummy.faketld/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="397307">json</span>&nbsp;<span class="op" id="397312">:=</span>&nbsp;<span class="string" id="397315">`{&#34;key&#34;:&#34;value&#34;}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="397334">b</span>&nbsp;<span class="op" id="397336">:=</span>&nbsp;<span class="ident" id="397339">strings</span><span class="op" id="397346">.</span><span class="ident" id="397347">NewReader</span><span class="op" id="397356">(</span><span class="ident" id="397357">json</span><span class="op" id="397361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="397364">client</span><span class="op" id="397370">.</span><span class="ident" id="397371">Post</span><span class="op" id="397375">(</span><span class="ident" id="397376">url</span><span class="op" id="397379">,</span>&nbsp;<span class="string" id="397381">&#34;application/json&#34;</span><span class="op" id="397399">,</span>&nbsp;<span class="ident" id="397401">b</span><span class="op" id="397402">)</span>&nbsp;<span class="comment" id="397404">//&nbsp;Note:&nbsp;doesn&#39;t&nbsp;hit&nbsp;network</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="397435">if</span>&nbsp;<span class="ident" id="397438">tr</span><span class="op" id="397440">.</span><span class="ident" id="397441">req</span><span class="op" id="397444">.</span><span class="ident" id="397445">Method</span>&nbsp;<span class="op" id="397452">!=</span>&nbsp;<span class="string" id="397455">&#34;POST&#34;</span>&nbsp;<span class="op" id="397462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="397466">t</span><span class="op" id="397467">.</span><span class="ident" id="397468">Errorf</span><span class="op" id="397474">(</span><span class="string" id="397475">&#34;got&nbsp;method&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="397499">,</span>&nbsp;<span class="ident" id="397501">tr</span><span class="op" id="397503">.</span><span class="ident" id="397504">req</span><span class="op" id="397507">.</span><span class="ident" id="397508">Method</span><span class="op" id="397514">,</span>&nbsp;<span class="string" id="397516">&#34;POST&#34;</span><span class="op" id="397522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="397525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="397528">if</span>&nbsp;<span class="ident" id="397531">tr</span><span class="op" id="397533">.</span><span class="ident" id="397534">req</span><span class="op" id="397537">.</span><span class="ident" id="397538">URL</span><span class="op" id="397541">.</span><span class="ident" id="397542">String</span><span class="op" id="397548">(</span><span class="op" id="397549">)</span>&nbsp;<span class="op" id="397551">!=</span>&nbsp;<span class="ident" id="397554">url</span>&nbsp;<span class="op" id="397558">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="397562">t</span><span class="op" id="397563">.</span><span class="ident" id="397564">Errorf</span><span class="op" id="397570">(</span><span class="string" id="397571">&#34;got&nbsp;URL&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="397592">,</span>&nbsp;<span class="ident" id="397594">tr</span><span class="op" id="397596">.</span><span class="ident" id="397597">req</span><span class="op" id="397600">.</span><span class="ident" id="397601">URL</span><span class="op" id="397604">.</span><span class="ident" id="397605">String</span><span class="op" id="397611">(</span><span class="op" id="397612">)</span><span class="op" id="397613">,</span>&nbsp;<span class="ident" id="397615">url</span><span class="op" id="397618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="397621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="397624">if</span>&nbsp;<span class="ident" id="397627">tr</span><span class="op" id="397629">.</span><span class="ident" id="397630">req</span><span class="op" id="397633">.</span><span class="ident" id="397634">Header</span>&nbsp;<span class="op" id="397641">==</span>&nbsp;<span class="ident" id="397644">nil</span>&nbsp;<span class="op" id="397648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="397652">t</span><span class="op" id="397653">.</span><span class="ident" id="397654">Fatalf</span><span class="op" id="397660">(</span><span class="string" id="397661">&#34;expected&nbsp;non-nil&nbsp;request&nbsp;Header&#34;</span><span class="op" id="397694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="397697">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="397700">if</span>&nbsp;<span class="ident" id="397703">tr</span><span class="op" id="397705">.</span><span class="ident" id="397706">req</span><span class="op" id="397709">.</span><span class="ident" id="397710">Close</span>&nbsp;<span class="op" id="397716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="397720">t</span><span class="op" id="397721">.</span><span class="ident" id="397722">Error</span><span class="op" id="397727">(</span><span class="string" id="397728">&#34;got&nbsp;Close&nbsp;true,&nbsp;want&nbsp;false&#34;</span><span class="op" id="397756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="397759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="397762">if</span>&nbsp;<span class="ident" id="397765">g</span><span class="op" id="397766">,</span>&nbsp;<span class="ident" id="397768">e</span>&nbsp;<span class="op" id="397770">:=</span>&nbsp;<span class="ident" id="397773">tr</span><span class="op" id="397775">.</span><span class="ident" id="397776">req</span><span class="op" id="397779">.</span><span class="ident" id="397780">ContentLength</span><span class="op" id="397793">,</span>&nbsp;<span class="ident" id="397795">int64</span><span class="op" id="397800">(</span><span class="builtinfunc" id="397801">len</span><span class="op" id="397804">(</span><span class="ident" id="397805">json</span><span class="op" id="397809">)</span><span class="op" id="397810">)</span><span class="op" id="397811">;</span>&nbsp;<span class="ident" id="397813">g</span>&nbsp;<span class="op" id="397815">!=</span>&nbsp;<span class="ident" id="397818">e</span>&nbsp;<span class="op" id="397820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="397824">t</span><span class="op" id="397825">.</span><span class="ident" id="397826">Errorf</span><span class="op" id="397832">(</span><span class="string" id="397833">&#34;got&nbsp;ContentLength&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="397864">,</span>&nbsp;<span class="ident" id="397866">g</span><span class="op" id="397867">,</span>&nbsp;<span class="ident" id="397869">e</span><span class="op" id="397870">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="397873">}</span><br>
<span class="lineno"></span><span class="op" id="397875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="397878">func</span>&nbsp;<span class="ident" id="397883">TestPostFormRequestFormat</span><span class="op" id="397908">(</span><span class="ident" id="397909">t</span>&nbsp;<span class="op" id="397911">*</span><span class="ident" id="397912">testing</span><span class="op" id="397919">.</span><span class="ident" id="397920">T</span><span class="op" id="397921">)</span>&nbsp;<span class="op" id="397923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="397926">defer</span>&nbsp;<span class="ident" id="397932">afterTest</span><span class="op" id="397941">(</span><span class="ident" id="397942">t</span><span class="op" id="397943">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="397946">tr</span>&nbsp;<span class="op" id="397949">:=</span>&nbsp;<span class="op" id="397952">&amp;</span><span class="ident" id="397953">recordingTransport</span><span class="op" id="397971">{</span><span class="op" id="397972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="397975">client</span>&nbsp;<span class="op" id="397982">:=</span>&nbsp;<span class="op" id="397985">&amp;</span><span class="ident" id="397986">Client</span><span class="op" id="397992">{</span><span class="ident" id="397993">Transport</span><span class="op" id="398002">:</span>&nbsp;<span class="ident" id="398004">tr</span><span class="op" id="398006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="398010">urlStr</span>&nbsp;<span class="op" id="398017">:=</span>&nbsp;<span class="string" id="398020">&#34;http://dummy.faketld/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="398045">form</span>&nbsp;<span class="op" id="398050">:=</span>&nbsp;<span class="builtinfunc" id="398053">make</span><span class="op" id="398057">(</span><span class="ident" id="398058">url</span><span class="op" id="398061">.</span><span class="ident" id="398062">Values</span><span class="op" id="398068">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="398071">form</span><span class="op" id="398075">.</span><span class="ident" id="398076">Set</span><span class="op" id="398079">(</span><span class="string" id="398080">&#34;foo&#34;</span><span class="op" id="398085">,</span>&nbsp;<span class="string" id="398087">&#34;bar&#34;</span><span class="op" id="398092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="398095">form</span><span class="op" id="398099">.</span><span class="ident" id="398100">Add</span><span class="op" id="398103">(</span><span class="string" id="398104">&#34;foo&#34;</span><span class="op" id="398109">,</span>&nbsp;<span class="string" id="398111">&#34;bar2&#34;</span><span class="op" id="398117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="398120">form</span><span class="op" id="398124">.</span><span class="ident" id="398125">Set</span><span class="op" id="398128">(</span><span class="string" id="398129">&#34;bar&#34;</span><span class="op" id="398134">,</span>&nbsp;<span class="string" id="398136">&#34;baz&#34;</span><span class="op" id="398141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="398144">client</span><span class="op" id="398150">.</span><span class="ident" id="398151">PostForm</span><span class="op" id="398159">(</span><span class="ident" id="398160">urlStr</span><span class="op" id="398166">,</span>&nbsp;<span class="ident" id="398168">form</span><span class="op" id="398172">)</span>&nbsp;<span class="comment" id="398174">//&nbsp;Note:&nbsp;doesn&#39;t&nbsp;hit&nbsp;network</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="398205">if</span>&nbsp;<span class="ident" id="398208">tr</span><span class="op" id="398210">.</span><span class="ident" id="398211">req</span><span class="op" id="398214">.</span><span class="ident" id="398215">Method</span>&nbsp;<span class="op" id="398222">!=</span>&nbsp;<span class="string" id="398225">&#34;POST&#34;</span>&nbsp;<span class="op" id="398232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="398236">t</span><span class="op" id="398237">.</span><span class="ident" id="398238">Errorf</span><span class="op" id="398244">(</span><span class="string" id="398245">&#34;got&nbsp;method&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="398269">,</span>&nbsp;<span class="ident" id="398271">tr</span><span class="op" id="398273">.</span><span class="ident" id="398274">req</span><span class="op" id="398277">.</span><span class="ident" id="398278">Method</span><span class="op" id="398284">,</span>&nbsp;<span class="string" id="398286">&#34;POST&#34;</span><span class="op" id="398292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="398295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="398298">if</span>&nbsp;<span class="ident" id="398301">tr</span><span class="op" id="398303">.</span><span class="ident" id="398304">req</span><span class="op" id="398307">.</span><span class="ident" id="398308">URL</span><span class="op" id="398311">.</span><span class="ident" id="398312">String</span><span class="op" id="398318">(</span><span class="op" id="398319">)</span>&nbsp;<span class="op" id="398321">!=</span>&nbsp;<span class="ident" id="398324">urlStr</span>&nbsp;<span class="op" id="398331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="398335">t</span><span class="op" id="398336">.</span><span class="ident" id="398337">Errorf</span><span class="op" id="398343">(</span><span class="string" id="398344">&#34;got&nbsp;URL&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="398365">,</span>&nbsp;<span class="ident" id="398367">tr</span><span class="op" id="398369">.</span><span class="ident" id="398370">req</span><span class="op" id="398373">.</span><span class="ident" id="398374">URL</span><span class="op" id="398377">.</span><span class="ident" id="398378">String</span><span class="op" id="398384">(</span><span class="op" id="398385">)</span><span class="op" id="398386">,</span>&nbsp;<span class="ident" id="398388">urlStr</span><span class="op" id="398394">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="398397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="398400">if</span>&nbsp;<span class="ident" id="398403">tr</span><span class="op" id="398405">.</span><span class="ident" id="398406">req</span><span class="op" id="398409">.</span><span class="ident" id="398410">Header</span>&nbsp;<span class="op" id="398417">==</span>&nbsp;<span class="ident" id="398420">nil</span>&nbsp;<span class="op" id="398424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="398428">t</span><span class="op" id="398429">.</span><span class="ident" id="398430">Fatalf</span><span class="op" id="398436">(</span><span class="string" id="398437">&#34;expected&nbsp;non-nil&nbsp;request&nbsp;Header&#34;</span><span class="op" id="398470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="398473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="398476">if</span>&nbsp;<span class="ident" id="398479">g</span><span class="op" id="398480">,</span>&nbsp;<span class="ident" id="398482">e</span>&nbsp;<span class="op" id="398484">:=</span>&nbsp;<span class="ident" id="398487">tr</span><span class="op" id="398489">.</span><span class="ident" id="398490">req</span><span class="op" id="398493">.</span><span class="ident" id="398494">Header</span><span class="op" id="398500">.</span><span class="ident" id="398501">Get</span><span class="op" id="398504">(</span><span class="string" id="398505">&#34;Content-Type&#34;</span><span class="op" id="398519">)</span><span class="op" id="398520">,</span>&nbsp;<span class="string" id="398522">&#34;application/x-www-form-urlencoded&#34;</span><span class="op" id="398557">;</span>&nbsp;<span class="ident" id="398559">g</span>&nbsp;<span class="op" id="398561">!=</span>&nbsp;<span class="ident" id="398564">e</span>&nbsp;<span class="op" id="398566">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="398570">t</span><span class="op" id="398571">.</span><span class="ident" id="398572">Errorf</span><span class="op" id="398578">(</span><span class="string" id="398579">&#34;got&nbsp;Content-Type&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="398609">,</span>&nbsp;<span class="ident" id="398611">g</span><span class="op" id="398612">,</span>&nbsp;<span class="ident" id="398614">e</span><span class="op" id="398615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="398618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="398621">if</span>&nbsp;<span class="ident" id="398624">tr</span><span class="op" id="398626">.</span><span class="ident" id="398627">req</span><span class="op" id="398630">.</span><span class="ident" id="398631">Close</span>&nbsp;<span class="op" id="398637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="398641">t</span><span class="op" id="398642">.</span><span class="ident" id="398643">Error</span><span class="op" id="398648">(</span><span class="string" id="398649">&#34;got&nbsp;Close&nbsp;true,&nbsp;want&nbsp;false&#34;</span><span class="op" id="398677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="398680">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="398683">//&nbsp;Depending&nbsp;on&nbsp;map&nbsp;iteration,&nbsp;body&nbsp;can&nbsp;be&nbsp;either&nbsp;of&nbsp;these.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="398744">expectedBody</span>&nbsp;<span class="op" id="398757">:=</span>&nbsp;<span class="string" id="398760">&#34;foo=bar&amp;foo=bar2&amp;bar=baz&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="398788">expectedBody1</span>&nbsp;<span class="op" id="398802">:=</span>&nbsp;<span class="string" id="398805">&#34;bar=baz&amp;foo=bar&amp;foo=bar2&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="398833">if</span>&nbsp;<span class="ident" id="398836">g</span><span class="op" id="398837">,</span>&nbsp;<span class="ident" id="398839">e</span>&nbsp;<span class="op" id="398841">:=</span>&nbsp;<span class="ident" id="398844">tr</span><span class="op" id="398846">.</span><span class="ident" id="398847">req</span><span class="op" id="398850">.</span><span class="ident" id="398851">ContentLength</span><span class="op" id="398864">,</span>&nbsp;<span class="ident" id="398866">int64</span><span class="op" id="398871">(</span><span class="builtinfunc" id="398872">len</span><span class="op" id="398875">(</span><span class="ident" id="398876">expectedBody</span><span class="op" id="398888">)</span><span class="op" id="398889">)</span><span class="op" id="398890">;</span>&nbsp;<span class="ident" id="398892">g</span>&nbsp;<span class="op" id="398894">!=</span>&nbsp;<span class="ident" id="398897">e</span>&nbsp;<span class="op" id="398899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="398903">t</span><span class="op" id="398904">.</span><span class="ident" id="398905">Errorf</span><span class="op" id="398911">(</span><span class="string" id="398912">&#34;got&nbsp;ContentLength&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="398943">,</span>&nbsp;<span class="ident" id="398945">g</span><span class="op" id="398946">,</span>&nbsp;<span class="ident" id="398948">e</span><span class="op" id="398949">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="398952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="398955">bodyb</span><span class="op" id="398960">,</span>&nbsp;<span class="ident" id="398962">err</span>&nbsp;<span class="op" id="398966">:=</span>&nbsp;<span class="ident" id="398969">ioutil</span><span class="op" id="398975">.</span><span class="ident" id="398976">ReadAll</span><span class="op" id="398983">(</span><span class="ident" id="398984">tr</span><span class="op" id="398986">.</span><span class="ident" id="398987">req</span><span class="op" id="398990">.</span><span class="ident" id="398991">Body</span><span class="op" id="398995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="398998">if</span>&nbsp;<span class="ident" id="399001">err</span>&nbsp;<span class="op" id="399005">!=</span>&nbsp;<span class="ident" id="399008">nil</span>&nbsp;<span class="op" id="399012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="399016">t</span><span class="op" id="399017">.</span><span class="ident" id="399018">Fatalf</span><span class="op" id="399024">(</span><span class="string" id="399025">&#34;ReadAll&nbsp;on&nbsp;req.Body:&nbsp;%v&#34;</span><span class="op" id="399050">,</span>&nbsp;<span class="ident" id="399052">err</span><span class="op" id="399055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="399058">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="399061">if</span>&nbsp;<span class="ident" id="399064">g</span>&nbsp;<span class="op" id="399066">:=</span>&nbsp;<span class="builtintype" id="399069">string</span><span class="op" id="399075">(</span><span class="ident" id="399076">bodyb</span><span class="op" id="399081">)</span><span class="op" id="399082">;</span>&nbsp;<span class="ident" id="399084">g</span>&nbsp;<span class="op" id="399086">!=</span>&nbsp;<span class="ident" id="399089">expectedBody</span>&nbsp;<span class="op" id="399102">&amp;&amp;</span>&nbsp;<span class="ident" id="399105">g</span>&nbsp;<span class="op" id="399107">!=</span>&nbsp;<span class="ident" id="399110">expectedBody1</span>&nbsp;<span class="op" id="399124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="399128">t</span><span class="op" id="399129">.</span><span class="ident" id="399130">Errorf</span><span class="op" id="399136">(</span><span class="string" id="399137">&#34;got&nbsp;body&nbsp;%q,&nbsp;want&nbsp;%q&nbsp;or&nbsp;%q&#34;</span><span class="op" id="399165">,</span>&nbsp;<span class="ident" id="399167">g</span><span class="op" id="399168">,</span>&nbsp;<span class="ident" id="399170">expectedBody</span><span class="op" id="399182">,</span>&nbsp;<span class="ident" id="399184">expectedBody1</span><span class="op" id="399197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="399200">}</span><br>
<span class="lineno"></span><span class="op" id="399202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="399205">func</span>&nbsp;<span class="ident" id="399210">TestClientRedirects</span><span class="op" id="399229">(</span><span class="ident" id="399230">t</span>&nbsp;<span class="op" id="399232">*</span><span class="ident" id="399233">testing</span><span class="op" id="399240">.</span><span class="ident" id="399241">T</span><span class="op" id="399242">)</span>&nbsp;<span class="op" id="399244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="399247">defer</span>&nbsp;<span class="ident" id="399253">afterTest</span><span class="op" id="399262">(</span><span class="ident" id="399263">t</span><span class="op" id="399264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="399267">var</span>&nbsp;<span class="ident" id="399271">ts</span>&nbsp;<span class="op" id="399274">*</span><span class="ident" id="399275">httptest</span><span class="op" id="399283">.</span><span class="ident" id="399284">Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="399292">ts</span>&nbsp;<span class="op" id="399295">=</span>&nbsp;<span class="ident" id="399297">httptest</span><span class="op" id="399305">.</span><span class="ident" id="399306">NewServer</span><span class="op" id="399315">(</span><span class="ident" id="399316">HandlerFunc</span><span class="op" id="399327">(</span><span class="keyword" id="399328">func</span><span class="op" id="399332">(</span><span class="ident" id="399333">w</span>&nbsp;<span class="ident" id="399335">ResponseWriter</span><span class="op" id="399349">,</span>&nbsp;<span class="ident" id="399351">r</span>&nbsp;<span class="op" id="399353">*</span><span class="ident" id="399354">Request</span><span class="op" id="399361">)</span>&nbsp;<span class="op" id="399363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="399367">n</span><span class="op" id="399368">,</span>&nbsp;<span class="ident" id="399370">_</span>&nbsp;<span class="op" id="399372">:=</span>&nbsp;<span class="ident" id="399375">strconv</span><span class="op" id="399382">.</span><span class="ident" id="399383">Atoi</span><span class="op" id="399387">(</span><span class="ident" id="399388">r</span><span class="op" id="399389">.</span><span class="ident" id="399390">FormValue</span><span class="op" id="399399">(</span><span class="string" id="399400">&#34;n&#34;</span><span class="op" id="399403">)</span><span class="op" id="399404">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="399408">//&nbsp;Test&nbsp;Referer&nbsp;header.&nbsp;(7&nbsp;is&nbsp;arbitrary&nbsp;position&nbsp;to&nbsp;test&nbsp;at)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="399471">if</span>&nbsp;<span class="ident" id="399474">n</span>&nbsp;<span class="op" id="399476">==</span>&nbsp;<span class="num" id="399479">7</span>&nbsp;<span class="op" id="399481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="399486">if</span>&nbsp;<span class="ident" id="399489">g</span><span class="op" id="399490">,</span>&nbsp;<span class="ident" id="399492">e</span>&nbsp;<span class="op" id="399494">:=</span>&nbsp;<span class="ident" id="399497">r</span><span class="op" id="399498">.</span><span class="ident" id="399499">Referer</span><span class="op" id="399506">(</span><span class="op" id="399507">)</span><span class="op" id="399508">,</span>&nbsp;<span class="ident" id="399510">ts</span><span class="op" id="399512">.</span><span class="ident" id="399513">URL</span><span class="op" id="399516">+</span><span class="string" id="399517">&#34;/?n=6&#34;</span><span class="op" id="399524">;</span>&nbsp;<span class="ident" id="399526">e</span>&nbsp;<span class="op" id="399528">!=</span>&nbsp;<span class="ident" id="399531">g</span>&nbsp;<span class="op" id="399533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="399539">t</span><span class="op" id="399540">.</span><span class="ident" id="399541">Errorf</span><span class="op" id="399547">(</span><span class="string" id="399548">&#34;on&nbsp;request&nbsp;?n=7,&nbsp;expected&nbsp;referer&nbsp;of&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="399597">,</span>&nbsp;<span class="ident" id="399599">e</span><span class="op" id="399600">,</span>&nbsp;<span class="ident" id="399602">g</span><span class="op" id="399603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="399608">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="399612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="399616">if</span>&nbsp;<span class="ident" id="399619">n</span>&nbsp;<span class="op" id="399621">&lt;</span>&nbsp;<span class="num" id="399623">15</span>&nbsp;<span class="op" id="399626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="399631">Redirect</span><span class="op" id="399639">(</span><span class="ident" id="399640">w</span><span class="op" id="399641">,</span>&nbsp;<span class="ident" id="399643">r</span><span class="op" id="399644">,</span>&nbsp;<span class="ident" id="399646">fmt</span><span class="op" id="399649">.</span><span class="ident" id="399650">Sprintf</span><span class="op" id="399657">(</span><span class="string" id="399658">&#34;/?n=%d&#34;</span><span class="op" id="399666">,</span>&nbsp;<span class="ident" id="399668">n</span><span class="op" id="399669">+</span><span class="num" id="399670">1</span><span class="op" id="399671">)</span><span class="op" id="399672">,</span>&nbsp;<span class="ident" id="399674">StatusFound</span><span class="op" id="399685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="399690">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="399699">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="399703">fmt</span><span class="op" id="399706">.</span><span class="ident" id="399707">Fprintf</span><span class="op" id="399714">(</span><span class="ident" id="399715">w</span><span class="op" id="399716">,</span>&nbsp;<span class="string" id="399718">&#34;n=%d&#34;</span><span class="op" id="399724">,</span>&nbsp;<span class="ident" id="399726">n</span><span class="op" id="399727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="399730">}</span><span class="op" id="399731">)</span><span class="op" id="399732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="399735">defer</span>&nbsp;<span class="ident" id="399741">ts</span><span class="op" id="399743">.</span><span class="ident" id="399744">Close</span><span class="op" id="399749">(</span><span class="op" id="399750">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="399754">c</span>&nbsp;<span class="op" id="399756">:=</span>&nbsp;<span class="op" id="399759">&amp;</span><span class="ident" id="399760">Client</span><span class="op" id="399766">{</span><span class="op" id="399767">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="399770">_</span><span class="op" id="399771">,</span>&nbsp;<span class="ident" id="399773">err</span>&nbsp;<span class="op" id="399777">:=</span>&nbsp;<span class="ident" id="399780">c</span><span class="op" id="399781">.</span><span class="ident" id="399782">Get</span><span class="op" id="399785">(</span><span class="ident" id="399786">ts</span><span class="op" id="399788">.</span><span class="ident" id="399789">URL</span><span class="op" id="399792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="399795">if</span>&nbsp;<span class="ident" id="399798">e</span><span class="op" id="399799">,</span>&nbsp;<span class="ident" id="399801">g</span>&nbsp;<span class="op" id="399803">:=</span>&nbsp;<span class="string" id="399806">&#34;Get&nbsp;/?n=10:&nbsp;stopped&nbsp;after&nbsp;10&nbsp;redirects&#34;</span><span class="op" id="399846">,</span>&nbsp;<span class="ident" id="399848">fmt</span><span class="op" id="399851">.</span><span class="ident" id="399852">Sprintf</span><span class="op" id="399859">(</span><span class="string" id="399860">&#34;%v&#34;</span><span class="op" id="399864">,</span>&nbsp;<span class="ident" id="399866">err</span><span class="op" id="399869">)</span><span class="op" id="399870">;</span>&nbsp;<span class="ident" id="399872">e</span>&nbsp;<span class="op" id="399874">!=</span>&nbsp;<span class="ident" id="399877">g</span>&nbsp;<span class="op" id="399879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="399883">t</span><span class="op" id="399884">.</span><span class="ident" id="399885">Errorf</span><span class="op" id="399891">(</span><span class="string" id="399892">&#34;with&nbsp;default&nbsp;client&nbsp;Get,&nbsp;expected&nbsp;error&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="399944">,</span>&nbsp;<span class="ident" id="399946">e</span><span class="op" id="399947">,</span>&nbsp;<span class="ident" id="399949">g</span><span class="op" id="399950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="399953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="399957">//&nbsp;HEAD&nbsp;request&nbsp;should&nbsp;also&nbsp;have&nbsp;the&nbsp;ability&nbsp;to&nbsp;follow&nbsp;redirects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="400024">_</span><span class="op" id="400025">,</span>&nbsp;<span class="ident" id="400027">err</span>&nbsp;<span class="op" id="400031">=</span>&nbsp;<span class="ident" id="400033">c</span><span class="op" id="400034">.</span><span class="ident" id="400035">Head</span><span class="op" id="400039">(</span><span class="ident" id="400040">ts</span><span class="op" id="400042">.</span><span class="ident" id="400043">URL</span><span class="op" id="400046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="400049">if</span>&nbsp;<span class="ident" id="400052">e</span><span class="op" id="400053">,</span>&nbsp;<span class="ident" id="400055">g</span>&nbsp;<span class="op" id="400057">:=</span>&nbsp;<span class="string" id="400060">&#34;Head&nbsp;/?n=10:&nbsp;stopped&nbsp;after&nbsp;10&nbsp;redirects&#34;</span><span class="op" id="400101">,</span>&nbsp;<span class="ident" id="400103">fmt</span><span class="op" id="400106">.</span><span class="ident" id="400107">Sprintf</span><span class="op" id="400114">(</span><span class="string" id="400115">&#34;%v&#34;</span><span class="op" id="400119">,</span>&nbsp;<span class="ident" id="400121">err</span><span class="op" id="400124">)</span><span class="op" id="400125">;</span>&nbsp;<span class="ident" id="400127">e</span>&nbsp;<span class="op" id="400129">!=</span>&nbsp;<span class="ident" id="400132">g</span>&nbsp;<span class="op" id="400134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="400138">t</span><span class="op" id="400139">.</span><span class="ident" id="400140">Errorf</span><span class="op" id="400146">(</span><span class="string" id="400147">&#34;with&nbsp;default&nbsp;client&nbsp;Head,&nbsp;expected&nbsp;error&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="400200">,</span>&nbsp;<span class="ident" id="400202">e</span><span class="op" id="400203">,</span>&nbsp;<span class="ident" id="400205">g</span><span class="op" id="400206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="400209">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="400213">//&nbsp;Do&nbsp;should&nbsp;also&nbsp;follow&nbsp;redirects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="400250">greq</span><span class="op" id="400254">,</span>&nbsp;<span class="ident" id="400256">_</span>&nbsp;<span class="op" id="400258">:=</span>&nbsp;<span class="ident" id="400261">NewRequest</span><span class="op" id="400271">(</span><span class="string" id="400272">&#34;GET&#34;</span><span class="op" id="400277">,</span>&nbsp;<span class="ident" id="400279">ts</span><span class="op" id="400281">.</span><span class="ident" id="400282">URL</span><span class="op" id="400285">,</span>&nbsp;<span class="ident" id="400287">nil</span><span class="op" id="400290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="400293">_</span><span class="op" id="400294">,</span>&nbsp;<span class="ident" id="400296">err</span>&nbsp;<span class="op" id="400300">=</span>&nbsp;<span class="ident" id="400302">c</span><span class="op" id="400303">.</span><span class="ident" id="400304">Do</span><span class="op" id="400306">(</span><span class="ident" id="400307">greq</span><span class="op" id="400311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="400314">if</span>&nbsp;<span class="ident" id="400317">e</span><span class="op" id="400318">,</span>&nbsp;<span class="ident" id="400320">g</span>&nbsp;<span class="op" id="400322">:=</span>&nbsp;<span class="string" id="400325">&#34;Get&nbsp;/?n=10:&nbsp;stopped&nbsp;after&nbsp;10&nbsp;redirects&#34;</span><span class="op" id="400365">,</span>&nbsp;<span class="ident" id="400367">fmt</span><span class="op" id="400370">.</span><span class="ident" id="400371">Sprintf</span><span class="op" id="400378">(</span><span class="string" id="400379">&#34;%v&#34;</span><span class="op" id="400383">,</span>&nbsp;<span class="ident" id="400385">err</span><span class="op" id="400388">)</span><span class="op" id="400389">;</span>&nbsp;<span class="ident" id="400391">e</span>&nbsp;<span class="op" id="400393">!=</span>&nbsp;<span class="ident" id="400396">g</span>&nbsp;<span class="op" id="400398">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="400402">t</span><span class="op" id="400403">.</span><span class="ident" id="400404">Errorf</span><span class="op" id="400410">(</span><span class="string" id="400411">&#34;with&nbsp;default&nbsp;client&nbsp;Do,&nbsp;expected&nbsp;error&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="400462">,</span>&nbsp;<span class="ident" id="400464">e</span><span class="op" id="400465">,</span>&nbsp;<span class="ident" id="400467">g</span><span class="op" id="400468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="400471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="400475">var</span>&nbsp;<span class="ident" id="400479">checkErr</span>&nbsp;<span class="builtintype" id="400488">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="400495">var</span>&nbsp;<span class="ident" id="400499">lastVia</span>&nbsp;<span class="op" id="400507">[</span><span class="op" id="400508">]</span><span class="op" id="400509">*</span><span class="ident" id="400510">Request</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="400519">c</span>&nbsp;<span class="op" id="400521">=</span>&nbsp;<span class="op" id="400523">&amp;</span><span class="ident" id="400524">Client</span><span class="op" id="400530">{</span><span class="ident" id="400531">CheckRedirect</span><span class="op" id="400544">:</span>&nbsp;<span class="keyword" id="400546">func</span><span class="op" id="400550">(</span><span class="ident" id="400551">_</span>&nbsp;<span class="op" id="400553">*</span><span class="ident" id="400554">Request</span><span class="op" id="400561">,</span>&nbsp;<span class="ident" id="400563">via</span>&nbsp;<span class="op" id="400567">[</span><span class="op" id="400568">]</span><span class="op" id="400569">*</span><span class="ident" id="400570">Request</span><span class="op" id="400577">)</span>&nbsp;<span class="builtintype" id="400579">error</span>&nbsp;<span class="op" id="400585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="400589">lastVia</span>&nbsp;<span class="op" id="400597">=</span>&nbsp;<span class="ident" id="400599">via</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="400605">return</span>&nbsp;<span class="ident" id="400612">checkErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="400622">}</span><span class="op" id="400623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="400626">res</span><span class="op" id="400629">,</span>&nbsp;<span class="ident" id="400631">err</span>&nbsp;<span class="op" id="400635">:=</span>&nbsp;<span class="ident" id="400638">c</span><span class="op" id="400639">.</span><span class="ident" id="400640">Get</span><span class="op" id="400643">(</span><span class="ident" id="400644">ts</span><span class="op" id="400646">.</span><span class="ident" id="400647">URL</span><span class="op" id="400650">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="400653">if</span>&nbsp;<span class="ident" id="400656">err</span>&nbsp;<span class="op" id="400660">!=</span>&nbsp;<span class="ident" id="400663">nil</span>&nbsp;<span class="op" id="400667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="400671">t</span><span class="op" id="400672">.</span><span class="ident" id="400673">Fatalf</span><span class="op" id="400679">(</span><span class="string" id="400680">&#34;Get&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="400695">,</span>&nbsp;<span class="ident" id="400697">err</span><span class="op" id="400700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="400703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="400706">res</span><span class="op" id="400709">.</span><span class="ident" id="400710">Body</span><span class="op" id="400714">.</span><span class="ident" id="400715">Close</span><span class="op" id="400720">(</span><span class="op" id="400721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="400724">finalUrl</span>&nbsp;<span class="op" id="400733">:=</span>&nbsp;<span class="ident" id="400736">res</span><span class="op" id="400739">.</span><span class="ident" id="400740">Request</span><span class="op" id="400747">.</span><span class="ident" id="400748">URL</span><span class="op" id="400751">.</span><span class="ident" id="400752">String</span><span class="op" id="400758">(</span><span class="op" id="400759">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="400762">if</span>&nbsp;<span class="ident" id="400765">e</span><span class="op" id="400766">,</span>&nbsp;<span class="ident" id="400768">g</span>&nbsp;<span class="op" id="400770">:=</span>&nbsp;<span class="string" id="400773">&#34;&lt;nil&gt;&#34;</span><span class="op" id="400780">,</span>&nbsp;<span class="ident" id="400782">fmt</span><span class="op" id="400785">.</span><span class="ident" id="400786">Sprintf</span><span class="op" id="400793">(</span><span class="string" id="400794">&#34;%v&#34;</span><span class="op" id="400798">,</span>&nbsp;<span class="ident" id="400800">err</span><span class="op" id="400803">)</span><span class="op" id="400804">;</span>&nbsp;<span class="ident" id="400806">e</span>&nbsp;<span class="op" id="400808">!=</span>&nbsp;<span class="ident" id="400811">g</span>&nbsp;<span class="op" id="400813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="400817">t</span><span class="op" id="400818">.</span><span class="ident" id="400819">Errorf</span><span class="op" id="400825">(</span><span class="string" id="400826">&#34;with&nbsp;custom&nbsp;client,&nbsp;expected&nbsp;error&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="400873">,</span>&nbsp;<span class="ident" id="400875">e</span><span class="op" id="400876">,</span>&nbsp;<span class="ident" id="400878">g</span><span class="op" id="400879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="400882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="400885">if</span>&nbsp;<span class="op" id="400888">!</span><span class="ident" id="400889">strings</span><span class="op" id="400896">.</span><span class="ident" id="400897">HasSuffix</span><span class="op" id="400906">(</span><span class="ident" id="400907">finalUrl</span><span class="op" id="400915">,</span>&nbsp;<span class="string" id="400917">&#34;/?n=15&#34;</span><span class="op" id="400925">)</span>&nbsp;<span class="op" id="400927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="400931">t</span><span class="op" id="400932">.</span><span class="ident" id="400933">Errorf</span><span class="op" id="400939">(</span><span class="string" id="400940">&#34;expected&nbsp;final&nbsp;url&nbsp;to&nbsp;end&nbsp;in&nbsp;/?n=15;&nbsp;got&nbsp;url&nbsp;%q&#34;</span><span class="op" id="400989">,</span>&nbsp;<span class="ident" id="400991">finalUrl</span><span class="op" id="400999">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="401002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="401005">if</span>&nbsp;<span class="ident" id="401008">e</span><span class="op" id="401009">,</span>&nbsp;<span class="ident" id="401011">g</span>&nbsp;<span class="op" id="401013">:=</span>&nbsp;<span class="num" id="401016">15</span><span class="op" id="401018">,</span>&nbsp;<span class="builtinfunc" id="401020">len</span><span class="op" id="401023">(</span><span class="ident" id="401024">lastVia</span><span class="op" id="401031">)</span><span class="op" id="401032">;</span>&nbsp;<span class="ident" id="401034">e</span>&nbsp;<span class="op" id="401036">!=</span>&nbsp;<span class="ident" id="401039">g</span>&nbsp;<span class="op" id="401041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="401045">t</span><span class="op" id="401046">.</span><span class="ident" id="401047">Errorf</span><span class="op" id="401053">(</span><span class="string" id="401054">&#34;expected&nbsp;lastVia&nbsp;to&nbsp;have&nbsp;contained&nbsp;%d&nbsp;elements;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="401110">,</span>&nbsp;<span class="ident" id="401112">e</span><span class="op" id="401113">,</span>&nbsp;<span class="ident" id="401115">g</span><span class="op" id="401116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="401119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="401123">checkErr</span>&nbsp;<span class="op" id="401132">=</span>&nbsp;<span class="ident" id="401134">errors</span><span class="op" id="401140">.</span><span class="ident" id="401141">New</span><span class="op" id="401144">(</span><span class="string" id="401145">&#34;no&nbsp;redirects&nbsp;allowed&#34;</span><span class="op" id="401167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="401170">res</span><span class="op" id="401173">,</span>&nbsp;<span class="ident" id="401175">err</span>&nbsp;<span class="op" id="401179">=</span>&nbsp;<span class="ident" id="401181">c</span><span class="op" id="401182">.</span><span class="ident" id="401183">Get</span><span class="op" id="401186">(</span><span class="ident" id="401187">ts</span><span class="op" id="401189">.</span><span class="ident" id="401190">URL</span><span class="op" id="401193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="401196">if</span>&nbsp;<span class="ident" id="401199">urlError</span><span class="op" id="401207">,</span>&nbsp;<span class="ident" id="401209">ok</span>&nbsp;<span class="op" id="401212">:=</span>&nbsp;<span class="ident" id="401215">err</span><span class="op" id="401218">.</span><span class="op" id="401219">(</span><span class="op" id="401220">*</span><span class="ident" id="401221">url</span><span class="op" id="401224">.</span><span class="ident" id="401225">Error</span><span class="op" id="401230">)</span><span class="op" id="401231">;</span>&nbsp;<span class="op" id="401233">!</span><span class="ident" id="401234">ok</span>&nbsp;<span class="op" id="401237">||</span>&nbsp;<span class="ident" id="401240">urlError</span><span class="op" id="401248">.</span><span class="ident" id="401249">Err</span>&nbsp;<span class="op" id="401253">!=</span>&nbsp;<span class="ident" id="401256">checkErr</span>&nbsp;<span class="op" id="401265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="401269">t</span><span class="op" id="401270">.</span><span class="ident" id="401271">Errorf</span><span class="op" id="401277">(</span><span class="string" id="401278">&#34;with&nbsp;redirects&nbsp;forbidden,&nbsp;expected&nbsp;a&nbsp;*url.Error&nbsp;with&nbsp;our&nbsp;&#39;no&nbsp;redirects&nbsp;allowed&#39;&nbsp;error&nbsp;inside;&nbsp;got&nbsp;%#v&nbsp;(%q)&#34;</span><span class="op" id="401386">,</span>&nbsp;<span class="ident" id="401388">err</span><span class="op" id="401391">,</span>&nbsp;<span class="ident" id="401393">err</span><span class="op" id="401396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="401399">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="401402">if</span>&nbsp;<span class="ident" id="401405">res</span>&nbsp;<span class="op" id="401409">==</span>&nbsp;<span class="ident" id="401412">nil</span>&nbsp;<span class="op" id="401416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="401420">t</span><span class="op" id="401421">.</span><span class="ident" id="401422">Fatalf</span><span class="op" id="401428">(</span><span class="string" id="401429">&#34;Expected&nbsp;a&nbsp;non-nil&nbsp;Response&nbsp;on&nbsp;CheckRedirect&nbsp;failure&nbsp;(http://golang.org/issue/3795)&#34;</span><span class="op" id="401514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="401517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="401520">res</span><span class="op" id="401523">.</span><span class="ident" id="401524">Body</span><span class="op" id="401528">.</span><span class="ident" id="401529">Close</span><span class="op" id="401534">(</span><span class="op" id="401535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="401538">if</span>&nbsp;<span class="ident" id="401541">res</span><span class="op" id="401544">.</span><span class="ident" id="401545">Header</span><span class="op" id="401551">.</span><span class="ident" id="401552">Get</span><span class="op" id="401555">(</span><span class="string" id="401556">&#34;Location&#34;</span><span class="op" id="401566">)</span>&nbsp;<span class="op" id="401568">==</span>&nbsp;<span class="string" id="401571">&#34;&#34;</span>&nbsp;<span class="op" id="401574">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="401578">t</span><span class="op" id="401579">.</span><span class="ident" id="401580">Errorf</span><span class="op" id="401586">(</span><span class="string" id="401587">&#34;no&nbsp;Location&nbsp;header&nbsp;in&nbsp;Response&#34;</span><span class="op" id="401619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="401622">}</span><br>
<span class="lineno"></span><span class="op" id="401624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="401627">func</span>&nbsp;<span class="ident" id="401632">TestPostRedirects</span><span class="op" id="401649">(</span><span class="ident" id="401650">t</span>&nbsp;<span class="op" id="401652">*</span><span class="ident" id="401653">testing</span><span class="op" id="401660">.</span><span class="ident" id="401661">T</span><span class="op" id="401662">)</span>&nbsp;<span class="op" id="401664">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="401667">defer</span>&nbsp;<span class="ident" id="401673">afterTest</span><span class="op" id="401682">(</span><span class="ident" id="401683">t</span><span class="op" id="401684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="401687">var</span>&nbsp;<span class="ident" id="401691">log</span>&nbsp;<span class="keyword" id="401695">struct</span>&nbsp;<span class="op" id="401702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="401706">sync</span><span class="op" id="401710">.</span><span class="ident" id="401711">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="401719">bytes</span><span class="op" id="401724">.</span><span class="ident" id="401725">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="401733">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="401736">var</span>&nbsp;<span class="ident" id="401740">ts</span>&nbsp;<span class="op" id="401743">*</span><span class="ident" id="401744">httptest</span><span class="op" id="401752">.</span><span class="ident" id="401753">Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="401761">ts</span>&nbsp;<span class="op" id="401764">=</span>&nbsp;<span class="ident" id="401766">httptest</span><span class="op" id="401774">.</span><span class="ident" id="401775">NewServer</span><span class="op" id="401784">(</span><span class="ident" id="401785">HandlerFunc</span><span class="op" id="401796">(</span><span class="keyword" id="401797">func</span><span class="op" id="401801">(</span><span class="ident" id="401802">w</span>&nbsp;<span class="ident" id="401804">ResponseWriter</span><span class="op" id="401818">,</span>&nbsp;<span class="ident" id="401820">r</span>&nbsp;<span class="op" id="401822">*</span><span class="ident" id="401823">Request</span><span class="op" id="401830">)</span>&nbsp;<span class="op" id="401832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="401836">log</span><span class="op" id="401839">.</span><span class="ident" id="401840">Lock</span><span class="op" id="401844">(</span><span class="op" id="401845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="401849">fmt</span><span class="op" id="401852">.</span><span class="ident" id="401853">Fprintf</span><span class="op" id="401860">(</span><span class="op" id="401861">&amp;</span><span class="ident" id="401862">log</span><span class="op" id="401865">.</span><span class="ident" id="401866">Buffer</span><span class="op" id="401872">,</span>&nbsp;<span class="string" id="401874">&#34;%s&nbsp;%s&nbsp;&#34;</span><span class="op" id="401882">,</span>&nbsp;<span class="ident" id="401884">r</span><span class="op" id="401885">.</span><span class="ident" id="401886">Method</span><span class="op" id="401892">,</span>&nbsp;<span class="ident" id="401894">r</span><span class="op" id="401895">.</span><span class="ident" id="401896">RequestURI</span><span class="op" id="401906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="401910">log</span><span class="op" id="401913">.</span><span class="ident" id="401914">Unlock</span><span class="op" id="401920">(</span><span class="op" id="401921">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="401925">if</span>&nbsp;<span class="ident" id="401928">v</span>&nbsp;<span class="op" id="401930">:=</span>&nbsp;<span class="ident" id="401933">r</span><span class="op" id="401934">.</span><span class="ident" id="401935">URL</span><span class="op" id="401938">.</span><span class="ident" id="401939">Query</span><span class="op" id="401944">(</span><span class="op" id="401945">)</span><span class="op" id="401946">.</span><span class="ident" id="401947">Get</span><span class="op" id="401950">(</span><span class="string" id="401951">&#34;code&#34;</span><span class="op" id="401957">)</span><span class="op" id="401958">;</span>&nbsp;<span class="ident" id="401960">v</span>&nbsp;<span class="op" id="401962">!=</span>&nbsp;<span class="string" id="401965">&#34;&#34;</span>&nbsp;<span class="op" id="401968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="401973">code</span><span class="op" id="401977">,</span>&nbsp;<span class="ident" id="401979">_</span>&nbsp;<span class="op" id="401981">:=</span>&nbsp;<span class="ident" id="401984">strconv</span><span class="op" id="401991">.</span><span class="ident" id="401992">Atoi</span><span class="op" id="401996">(</span><span class="ident" id="401997">v</span><span class="op" id="401998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="402003">if</span>&nbsp;<span class="ident" id="402006">code</span><span class="op" id="402010">/</span><span class="num" id="402011">100</span>&nbsp;<span class="op" id="402015">==</span>&nbsp;<span class="num" id="402018">3</span>&nbsp;<span class="op" id="402020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="402026">w</span><span class="op" id="402027">.</span><span class="ident" id="402028">Header</span><span class="op" id="402034">(</span><span class="op" id="402035">)</span><span class="op" id="402036">.</span><span class="ident" id="402037">Set</span><span class="op" id="402040">(</span><span class="string" id="402041">&#34;Location&#34;</span><span class="op" id="402051">,</span>&nbsp;<span class="ident" id="402053">ts</span><span class="op" id="402055">.</span><span class="ident" id="402056">URL</span><span class="op" id="402059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402064">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="402069">w</span><span class="op" id="402070">.</span><span class="ident" id="402071">WriteHeader</span><span class="op" id="402082">(</span><span class="ident" id="402083">code</span><span class="op" id="402087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402094">}</span><span class="op" id="402095">)</span><span class="op" id="402096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="402099">defer</span>&nbsp;<span class="ident" id="402105">ts</span><span class="op" id="402107">.</span><span class="ident" id="402108">Close</span><span class="op" id="402113">(</span><span class="op" id="402114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="402117">tests</span>&nbsp;<span class="op" id="402123">:=</span>&nbsp;<span class="op" id="402126">[</span><span class="op" id="402127">]</span><span class="keyword" id="402128">struct</span>&nbsp;<span class="op" id="402135">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="402139">suffix</span>&nbsp;<span class="builtintype" id="402146">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="402155">want</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="402162">int</span>&nbsp;<span class="comment" id="402166">//&nbsp;response&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402184">}</span><span class="op" id="402185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402189">{</span><span class="string" id="402190">&#34;/&#34;</span><span class="op" id="402193">,</span>&nbsp;<span class="num" id="402195">200</span><span class="op" id="402198">}</span><span class="op" id="402199">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402203">{</span><span class="string" id="402204">&#34;/?code=301&#34;</span><span class="op" id="402216">,</span>&nbsp;<span class="num" id="402218">301</span><span class="op" id="402221">}</span><span class="op" id="402222">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402226">{</span><span class="string" id="402227">&#34;/?code=302&#34;</span><span class="op" id="402239">,</span>&nbsp;<span class="num" id="402241">200</span><span class="op" id="402244">}</span><span class="op" id="402245">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402249">{</span><span class="string" id="402250">&#34;/?code=303&#34;</span><span class="op" id="402262">,</span>&nbsp;<span class="num" id="402264">200</span><span class="op" id="402267">}</span><span class="op" id="402268">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402272">{</span><span class="string" id="402273">&#34;/?code=404&#34;</span><span class="op" id="402285">,</span>&nbsp;<span class="num" id="402287">404</span><span class="op" id="402290">}</span><span class="op" id="402291">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="402297">for</span>&nbsp;<span class="ident" id="402301">_</span><span class="op" id="402302">,</span>&nbsp;<span class="ident" id="402304">tt</span>&nbsp;<span class="op" id="402307">:=</span>&nbsp;<span class="keyword" id="402310">range</span>&nbsp;<span class="ident" id="402316">tests</span>&nbsp;<span class="op" id="402322">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="402326">res</span><span class="op" id="402329">,</span>&nbsp;<span class="ident" id="402331">err</span>&nbsp;<span class="op" id="402335">:=</span>&nbsp;<span class="ident" id="402338">Post</span><span class="op" id="402342">(</span><span class="ident" id="402343">ts</span><span class="op" id="402345">.</span><span class="ident" id="402346">URL</span><span class="op" id="402349">+</span><span class="ident" id="402350">tt</span><span class="op" id="402352">.</span><span class="ident" id="402353">suffix</span><span class="op" id="402359">,</span>&nbsp;<span class="string" id="402361">&#34;text/plain&#34;</span><span class="op" id="402373">,</span>&nbsp;<span class="ident" id="402375">strings</span><span class="op" id="402382">.</span><span class="ident" id="402383">NewReader</span><span class="op" id="402392">(</span><span class="string" id="402393">&#34;Some&nbsp;content&#34;</span><span class="op" id="402407">)</span><span class="op" id="402408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="402412">if</span>&nbsp;<span class="ident" id="402415">err</span>&nbsp;<span class="op" id="402419">!=</span>&nbsp;<span class="ident" id="402422">nil</span>&nbsp;<span class="op" id="402426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="402431">t</span><span class="op" id="402432">.</span><span class="ident" id="402433">Fatal</span><span class="op" id="402438">(</span><span class="ident" id="402439">err</span><span class="op" id="402442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="402450">if</span>&nbsp;<span class="ident" id="402453">res</span><span class="op" id="402456">.</span><span class="ident" id="402457">StatusCode</span>&nbsp;<span class="op" id="402468">!=</span>&nbsp;<span class="ident" id="402471">tt</span><span class="op" id="402473">.</span><span class="ident" id="402474">want</span>&nbsp;<span class="op" id="402479">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="402484">t</span><span class="op" id="402485">.</span><span class="ident" id="402486">Errorf</span><span class="op" id="402492">(</span><span class="string" id="402493">&#34;POST&nbsp;%s:&nbsp;status&nbsp;code&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="402529">,</span>&nbsp;<span class="ident" id="402531">tt</span><span class="op" id="402533">.</span><span class="ident" id="402534">suffix</span><span class="op" id="402540">,</span>&nbsp;<span class="ident" id="402542">res</span><span class="op" id="402545">.</span><span class="ident" id="402546">StatusCode</span><span class="op" id="402556">,</span>&nbsp;<span class="ident" id="402558">tt</span><span class="op" id="402560">.</span><span class="ident" id="402561">want</span><span class="op" id="402565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="402575">log</span><span class="op" id="402578">.</span><span class="ident" id="402579">Lock</span><span class="op" id="402583">(</span><span class="op" id="402584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="402587">got</span>&nbsp;<span class="op" id="402591">:=</span>&nbsp;<span class="ident" id="402594">log</span><span class="op" id="402597">.</span><span class="ident" id="402598">String</span><span class="op" id="402604">(</span><span class="op" id="402605">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="402608">log</span><span class="op" id="402611">.</span><span class="ident" id="402612">Unlock</span><span class="op" id="402618">(</span><span class="op" id="402619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="402622">want</span>&nbsp;<span class="op" id="402627">:=</span>&nbsp;<span class="string" id="402630">&#34;POST&nbsp;/&nbsp;POST&nbsp;/?code=301&nbsp;POST&nbsp;/?code=302&nbsp;GET&nbsp;/&nbsp;POST&nbsp;/?code=303&nbsp;GET&nbsp;/&nbsp;POST&nbsp;/?code=404&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="402717">if</span>&nbsp;<span class="ident" id="402720">got</span>&nbsp;<span class="op" id="402724">!=</span>&nbsp;<span class="ident" id="402727">want</span>&nbsp;<span class="op" id="402732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="402736">t</span><span class="op" id="402737">.</span><span class="ident" id="402738">Errorf</span><span class="op" id="402744">(</span><span class="string" id="402745">&#34;Log&nbsp;differs.\n&nbsp;Got:&nbsp;%q\nWant:&nbsp;%q&#34;</span><span class="op" id="402779">,</span>&nbsp;<span class="ident" id="402781">got</span><span class="op" id="402784">,</span>&nbsp;<span class="ident" id="402786">want</span><span class="op" id="402790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402793">}</span><br>
<span class="lineno">315</span><span class="op" id="402795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="402798">var</span>&nbsp;<span class="ident" id="402802">expectedCookies</span>&nbsp;<span class="op" id="402818">=</span>&nbsp;<span class="op" id="402820">[</span><span class="op" id="402821">]</span><span class="op" id="402822">*</span><span class="ident" id="402823">Cookie</span><span class="op" id="402829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402832">{</span><span class="ident" id="402833">Name</span><span class="op" id="402837">:</span>&nbsp;<span class="string" id="402839">&#34;ChocolateChip&#34;</span><span class="op" id="402854">,</span>&nbsp;<span class="ident" id="402856">Value</span><span class="op" id="402861">:</span>&nbsp;<span class="string" id="402863">&#34;tasty&#34;</span><span class="op" id="402870">}</span><span class="op" id="402871">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402874">{</span><span class="ident" id="402875">Name</span><span class="op" id="402879">:</span>&nbsp;<span class="string" id="402881">&#34;First&#34;</span><span class="op" id="402888">,</span>&nbsp;<span class="ident" id="402890">Value</span><span class="op" id="402895">:</span>&nbsp;<span class="string" id="402897">&#34;Hit&#34;</span><span class="op" id="402902">}</span><span class="op" id="402903">,</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="402906">{</span><span class="ident" id="402907">Name</span><span class="op" id="402911">:</span>&nbsp;<span class="string" id="402913">&#34;Second&#34;</span><span class="op" id="402921">,</span>&nbsp;<span class="ident" id="402923">Value</span><span class="op" id="402928">:</span>&nbsp;<span class="string" id="402930">&#34;Hit&#34;</span><span class="op" id="402935">}</span><span class="op" id="402936">,</span><br>
<span class="lineno"></span><span class="op" id="402938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="402941">var</span>&nbsp;<span class="ident" id="402945">echoCookiesRedirectHandler</span>&nbsp;<span class="op" id="402972">=</span>&nbsp;<span class="ident" id="402974">HandlerFunc</span><span class="op" id="402985">(</span><span class="keyword" id="402986">func</span><span class="op" id="402990">(</span><span class="ident" id="402991">w</span>&nbsp;<span class="ident" id="402993">ResponseWriter</span><span class="op" id="403007">,</span>&nbsp;<span class="ident" id="403009">r</span>&nbsp;<span class="op" id="403011">*</span><span class="ident" id="403012">Request</span><span class="op" id="403019">)</span>&nbsp;<span class="op" id="403021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="403024">for</span>&nbsp;<span class="ident" id="403028">_</span><span class="op" id="403029">,</span>&nbsp;<span class="ident" id="403031">cookie</span>&nbsp;<span class="op" id="403038">:=</span>&nbsp;<span class="keyword" id="403041">range</span>&nbsp;<span class="ident" id="403047">r</span><span class="op" id="403048">.</span><span class="ident" id="403049">Cookies</span><span class="op" id="403056">(</span><span class="op" id="403057">)</span>&nbsp;<span class="op" id="403059">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403063">SetCookie</span><span class="op" id="403072">(</span><span class="ident" id="403073">w</span><span class="op" id="403074">,</span>&nbsp;<span class="ident" id="403076">cookie</span><span class="op" id="403082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="403085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="403088">if</span>&nbsp;<span class="ident" id="403091">r</span><span class="op" id="403092">.</span><span class="ident" id="403093">URL</span><span class="op" id="403096">.</span><span class="ident" id="403097">Path</span>&nbsp;<span class="op" id="403102">==</span>&nbsp;<span class="string" id="403105">&#34;/&#34;</span>&nbsp;<span class="op" id="403109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403113">SetCookie</span><span class="op" id="403122">(</span><span class="ident" id="403123">w</span><span class="op" id="403124">,</span>&nbsp;<span class="ident" id="403126">expectedCookies</span><span class="op" id="403141">[</span><span class="num" id="403142">1</span><span class="op" id="403143">]</span><span class="op" id="403144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403148">Redirect</span><span class="op" id="403156">(</span><span class="ident" id="403157">w</span><span class="op" id="403158">,</span>&nbsp;<span class="ident" id="403160">r</span><span class="op" id="403161">,</span>&nbsp;<span class="string" id="403163">&#34;/second&#34;</span><span class="op" id="403172">,</span>&nbsp;<span class="ident" id="403174">StatusMovedPermanently</span><span class="op" id="403196">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="403199">}</span>&nbsp;<span class="keyword" id="403201">else</span>&nbsp;<span class="op" id="403206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403210">SetCookie</span><span class="op" id="403219">(</span><span class="ident" id="403220">w</span><span class="op" id="403221">,</span>&nbsp;<span class="ident" id="403223">expectedCookies</span><span class="op" id="403238">[</span><span class="num" id="403239">2</span><span class="op" id="403240">]</span><span class="op" id="403241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403245">w</span><span class="op" id="403246">.</span><span class="ident" id="403247">Write</span><span class="op" id="403252">(</span><span class="op" id="403253">[</span><span class="op" id="403254">]</span><span class="builtintype" id="403255">byte</span><span class="op" id="403259">(</span><span class="string" id="403260">&#34;hello&#34;</span><span class="op" id="403267">)</span><span class="op" id="403268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="403271">}</span><br>
<span class="lineno"></span><span class="op" id="403273">}</span><span class="op" id="403274">)</span><br>
<span class="lineno">335</span><br>
<span class="lineno"></span><span class="keyword" id="403277">func</span>&nbsp;<span class="ident" id="403282">TestClientSendsCookieFromJar</span><span class="op" id="403310">(</span><span class="ident" id="403311">t</span>&nbsp;<span class="op" id="403313">*</span><span class="ident" id="403314">testing</span><span class="op" id="403321">.</span><span class="ident" id="403322">T</span><span class="op" id="403323">)</span>&nbsp;<span class="op" id="403325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403328">tr</span>&nbsp;<span class="op" id="403331">:=</span>&nbsp;<span class="op" id="403334">&amp;</span><span class="ident" id="403335">recordingTransport</span><span class="op" id="403353">{</span><span class="op" id="403354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403357">client</span>&nbsp;<span class="op" id="403364">:=</span>&nbsp;<span class="op" id="403367">&amp;</span><span class="ident" id="403368">Client</span><span class="op" id="403374">{</span><span class="ident" id="403375">Transport</span><span class="op" id="403384">:</span>&nbsp;<span class="ident" id="403386">tr</span><span class="op" id="403388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403391">client</span><span class="op" id="403397">.</span><span class="ident" id="403398">Jar</span>&nbsp;<span class="op" id="403402">=</span>&nbsp;<span class="op" id="403404">&amp;</span><span class="ident" id="403405">TestJar</span><span class="op" id="403412">{</span><span class="ident" id="403413">perURL</span><span class="op" id="403419">:</span>&nbsp;<span class="builtinfunc" id="403421">make</span><span class="op" id="403425">(</span><span class="keyword" id="403426">map</span><span class="op" id="403429">[</span><span class="builtintype" id="403430">string</span><span class="op" id="403436">]</span><span class="op" id="403437">[</span><span class="op" id="403438">]</span><span class="op" id="403439">*</span><span class="ident" id="403440">Cookie</span><span class="op" id="403446">)</span><span class="op" id="403447">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403450">us</span>&nbsp;<span class="op" id="403453">:=</span>&nbsp;<span class="string" id="403456">&#34;http://dummy.faketld/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403481">u</span><span class="op" id="403482">,</span>&nbsp;<span class="ident" id="403484">_</span>&nbsp;<span class="op" id="403486">:=</span>&nbsp;<span class="ident" id="403489">url</span><span class="op" id="403492">.</span><span class="ident" id="403493">Parse</span><span class="op" id="403498">(</span><span class="ident" id="403499">us</span><span class="op" id="403501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403504">client</span><span class="op" id="403510">.</span><span class="ident" id="403511">Jar</span><span class="op" id="403514">.</span><span class="ident" id="403515">SetCookies</span><span class="op" id="403525">(</span><span class="ident" id="403526">u</span><span class="op" id="403527">,</span>&nbsp;<span class="ident" id="403529">expectedCookies</span><span class="op" id="403544">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403548">client</span><span class="op" id="403554">.</span><span class="ident" id="403555">Get</span><span class="op" id="403558">(</span><span class="ident" id="403559">us</span><span class="op" id="403561">)</span>&nbsp;<span class="comment" id="403563">//&nbsp;Note:&nbsp;doesn&#39;t&nbsp;hit&nbsp;network</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403593">matchReturnedCookies</span><span class="op" id="403613">(</span><span class="ident" id="403614">t</span><span class="op" id="403615">,</span>&nbsp;<span class="ident" id="403617">expectedCookies</span><span class="op" id="403632">,</span>&nbsp;<span class="ident" id="403634">tr</span><span class="op" id="403636">.</span><span class="ident" id="403637">req</span><span class="op" id="403640">.</span><span class="ident" id="403641">Cookies</span><span class="op" id="403648">(</span><span class="op" id="403649">)</span><span class="op" id="403650">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403654">client</span><span class="op" id="403660">.</span><span class="ident" id="403661">Head</span><span class="op" id="403665">(</span><span class="ident" id="403666">us</span><span class="op" id="403668">)</span>&nbsp;<span class="comment" id="403670">//&nbsp;Note:&nbsp;doesn&#39;t&nbsp;hit&nbsp;network</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403700">matchReturnedCookies</span><span class="op" id="403720">(</span><span class="ident" id="403721">t</span><span class="op" id="403722">,</span>&nbsp;<span class="ident" id="403724">expectedCookies</span><span class="op" id="403739">,</span>&nbsp;<span class="ident" id="403741">tr</span><span class="op" id="403743">.</span><span class="ident" id="403744">req</span><span class="op" id="403747">.</span><span class="ident" id="403748">Cookies</span><span class="op" id="403755">(</span><span class="op" id="403756">)</span><span class="op" id="403757">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403761">client</span><span class="op" id="403767">.</span><span class="ident" id="403768">Post</span><span class="op" id="403772">(</span><span class="ident" id="403773">us</span><span class="op" id="403775">,</span>&nbsp;<span class="string" id="403777">&#34;text/plain&#34;</span><span class="op" id="403789">,</span>&nbsp;<span class="ident" id="403791">strings</span><span class="op" id="403798">.</span><span class="ident" id="403799">NewReader</span><span class="op" id="403808">(</span><span class="string" id="403809">&#34;body&#34;</span><span class="op" id="403815">)</span><span class="op" id="403816">)</span>&nbsp;<span class="comment" id="403818">//&nbsp;Note:&nbsp;doesn&#39;t&nbsp;hit&nbsp;network</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403848">matchReturnedCookies</span><span class="op" id="403868">(</span><span class="ident" id="403869">t</span><span class="op" id="403870">,</span>&nbsp;<span class="ident" id="403872">expectedCookies</span><span class="op" id="403887">,</span>&nbsp;<span class="ident" id="403889">tr</span><span class="op" id="403891">.</span><span class="ident" id="403892">req</span><span class="op" id="403895">.</span><span class="ident" id="403896">Cookies</span><span class="op" id="403903">(</span><span class="op" id="403904">)</span><span class="op" id="403905">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403909">client</span><span class="op" id="403915">.</span><span class="ident" id="403916">PostForm</span><span class="op" id="403924">(</span><span class="ident" id="403925">us</span><span class="op" id="403927">,</span>&nbsp;<span class="ident" id="403929">url</span><span class="op" id="403932">.</span><span class="ident" id="403933">Values</span><span class="op" id="403939">{</span><span class="op" id="403940">}</span><span class="op" id="403941">)</span>&nbsp;<span class="comment" id="403943">//&nbsp;Note:&nbsp;doesn&#39;t&nbsp;hit&nbsp;network</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="403973">matchReturnedCookies</span><span class="op" id="403993">(</span><span class="ident" id="403994">t</span><span class="op" id="403995">,</span>&nbsp;<span class="ident" id="403997">expectedCookies</span><span class="op" id="404012">,</span>&nbsp;<span class="ident" id="404014">tr</span><span class="op" id="404016">.</span><span class="ident" id="404017">req</span><span class="op" id="404020">.</span><span class="ident" id="404021">Cookies</span><span class="op" id="404028">(</span><span class="op" id="404029">)</span><span class="op" id="404030">)</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="404034">req</span><span class="op" id="404037">,</span>&nbsp;<span class="ident" id="404039">_</span>&nbsp;<span class="op" id="404041">:=</span>&nbsp;<span class="ident" id="404044">NewRequest</span><span class="op" id="404054">(</span><span class="string" id="404055">&#34;GET&#34;</span><span class="op" id="404060">,</span>&nbsp;<span class="ident" id="404062">us</span><span class="op" id="404064">,</span>&nbsp;<span class="ident" id="404066">nil</span><span class="op" id="404069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="404072">client</span><span class="op" id="404078">.</span><span class="ident" id="404079">Do</span><span class="op" id="404081">(</span><span class="ident" id="404082">req</span><span class="op" id="404085">)</span>&nbsp;<span class="comment" id="404087">//&nbsp;Note:&nbsp;doesn&#39;t&nbsp;hit&nbsp;network</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="404117">matchReturnedCookies</span><span class="op" id="404137">(</span><span class="ident" id="404138">t</span><span class="op" id="404139">,</span>&nbsp;<span class="ident" id="404141">expectedCookies</span><span class="op" id="404156">,</span>&nbsp;<span class="ident" id="404158">tr</span><span class="op" id="404160">.</span><span class="ident" id="404161">req</span><span class="op" id="404164">.</span><span class="ident" id="404165">Cookies</span><span class="op" id="404172">(</span><span class="op" id="404173">)</span><span class="op" id="404174">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="404178">req</span><span class="op" id="404181">,</span>&nbsp;<span class="ident" id="404183">_</span>&nbsp;<span class="op" id="404185">=</span>&nbsp;<span class="ident" id="404187">NewRequest</span><span class="op" id="404197">(</span><span class="string" id="404198">&#34;POST&#34;</span><span class="op" id="404204">,</span>&nbsp;<span class="ident" id="404206">us</span><span class="op" id="404208">,</span>&nbsp;<span class="ident" id="404210">nil</span><span class="op" id="404213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="404216">client</span><span class="op" id="404222">.</span><span class="ident" id="404223">Do</span><span class="op" id="404225">(</span><span class="ident" id="404226">req</span><span class="op" id="404229">)</span>&nbsp;<span class="comment" id="404231">//&nbsp;Note:&nbsp;doesn&#39;t&nbsp;hit&nbsp;network</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="404261">matchReturnedCookies</span><span class="op" id="404281">(</span><span class="ident" id="404282">t</span><span class="op" id="404283">,</span>&nbsp;<span class="ident" id="404285">expectedCookies</span><span class="op" id="404300">,</span>&nbsp;<span class="ident" id="404302">tr</span><span class="op" id="404304">.</span><span class="ident" id="404305">req</span><span class="op" id="404308">.</span><span class="ident" id="404309">Cookies</span><span class="op" id="404316">(</span><span class="op" id="404317">)</span><span class="op" id="404318">)</span><br>
<span class="lineno"></span><span class="op" id="404320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="404323">//&nbsp;Just&nbsp;enough&nbsp;correctness&nbsp;for&nbsp;our&nbsp;redirect&nbsp;tests.&nbsp;Uses&nbsp;the&nbsp;URL.Host&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="404399">//&nbsp;scope&nbsp;of&nbsp;all&nbsp;cookies.</span><br>
<span class="lineno"></span><span class="keyword" id="404424">type</span>&nbsp;<span class="ident" id="404429">TestJar</span>&nbsp;<span class="keyword" id="404437">struct</span>&nbsp;<span class="op" id="404444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="404447">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="404454">sync</span><span class="op" id="404458">.</span><span class="ident" id="404459">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="404466">perURL</span>&nbsp;<span class="keyword" id="404473">map</span><span class="op" id="404476">[</span><span class="builtintype" id="404477">string</span><span class="op" id="404483">]</span><span class="op" id="404484">[</span><span class="op" id="404485">]</span><span class="op" id="404486">*</span><span class="ident" id="404487">Cookie</span><br>
<span class="lineno">370</span><span class="op" id="404494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="404497">func</span>&nbsp;<span class="op" id="404502">(</span><span class="ident" id="404503">j</span>&nbsp;<span class="op" id="404505">*</span><span class="ident" id="404506">TestJar</span><span class="op" id="404513">)</span>&nbsp;<span class="ident" id="404515">SetCookies</span><span class="op" id="404525">(</span><span class="ident" id="404526">u</span>&nbsp;<span class="op" id="404528">*</span><span class="ident" id="404529">url</span><span class="op" id="404532">.</span><span class="ident" id="404533">URL</span><span class="op" id="404536">,</span>&nbsp;<span class="ident" id="404538">cookies</span>&nbsp;<span class="op" id="404546">[</span><span class="op" id="404547">]</span><span class="op" id="404548">*</span><span class="ident" id="404549">Cookie</span><span class="op" id="404555">)</span>&nbsp;<span class="op" id="404557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="404560">j</span><span class="op" id="404561">.</span><span class="ident" id="404562">m</span><span class="op" id="404563">.</span><span class="ident" id="404564">Lock</span><span class="op" id="404568">(</span><span class="op" id="404569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="404572">defer</span>&nbsp;<span class="ident" id="404578">j</span><span class="op" id="404579">.</span><span class="ident" id="404580">m</span><span class="op" id="404581">.</span><span class="ident" id="404582">Unlock</span><span class="op" id="404588">(</span><span class="op" id="404589">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="404592">if</span>&nbsp;<span class="ident" id="404595">j</span><span class="op" id="404596">.</span><span class="ident" id="404597">perURL</span>&nbsp;<span class="op" id="404604">==</span>&nbsp;<span class="ident" id="404607">nil</span>&nbsp;<span class="op" id="404611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="404615">j</span><span class="op" id="404616">.</span><span class="ident" id="404617">perURL</span>&nbsp;<span class="op" id="404624">=</span>&nbsp;<span class="builtinfunc" id="404626">make</span><span class="op" id="404630">(</span><span class="keyword" id="404631">map</span><span class="op" id="404634">[</span><span class="builtintype" id="404635">string</span><span class="op" id="404641">]</span><span class="op" id="404642">[</span><span class="op" id="404643">]</span><span class="op" id="404644">*</span><span class="ident" id="404645">Cookie</span><span class="op" id="404651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="404654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="404657">j</span><span class="op" id="404658">.</span><span class="ident" id="404659">perURL</span><span class="op" id="404665">[</span><span class="ident" id="404666">u</span><span class="op" id="404667">.</span><span class="ident" id="404668">Host</span><span class="op" id="404672">]</span>&nbsp;<span class="op" id="404674">=</span>&nbsp;<span class="ident" id="404676">cookies</span><br>
<span class="lineno"></span><span class="op" id="404684">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="keyword" id="404687">func</span>&nbsp;<span class="op" id="404692">(</span><span class="ident" id="404693">j</span>&nbsp;<span class="op" id="404695">*</span><span class="ident" id="404696">TestJar</span><span class="op" id="404703">)</span>&nbsp;<span class="ident" id="404705">Cookies</span><span class="op" id="404712">(</span><span class="ident" id="404713">u</span>&nbsp;<span class="op" id="404715">*</span><span class="ident" id="404716">url</span><span class="op" id="404719">.</span><span class="ident" id="404720">URL</span><span class="op" id="404723">)</span>&nbsp;<span class="op" id="404725">[</span><span class="op" id="404726">]</span><span class="op" id="404727">*</span><span class="ident" id="404728">Cookie</span>&nbsp;<span class="op" id="404735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="404738">j</span><span class="op" id="404739">.</span><span class="ident" id="404740">m</span><span class="op" id="404741">.</span><span class="ident" id="404742">Lock</span><span class="op" id="404746">(</span><span class="op" id="404747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="404750">defer</span>&nbsp;<span class="ident" id="404756">j</span><span class="op" id="404757">.</span><span class="ident" id="404758">m</span><span class="op" id="404759">.</span><span class="ident" id="404760">Unlock</span><span class="op" id="404766">(</span><span class="op" id="404767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="404770">return</span>&nbsp;<span class="ident" id="404777">j</span><span class="op" id="404778">.</span><span class="ident" id="404779">perURL</span><span class="op" id="404785">[</span><span class="ident" id="404786">u</span><span class="op" id="404787">.</span><span class="ident" id="404788">Host</span><span class="op" id="404792">]</span><br>
<span class="lineno">385</span><span class="op" id="404794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="404797">func</span>&nbsp;<span class="ident" id="404802">TestRedirectCookiesJar</span><span class="op" id="404824">(</span><span class="ident" id="404825">t</span>&nbsp;<span class="op" id="404827">*</span><span class="ident" id="404828">testing</span><span class="op" id="404835">.</span><span class="ident" id="404836">T</span><span class="op" id="404837">)</span>&nbsp;<span class="op" id="404839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="404842">defer</span>&nbsp;<span class="ident" id="404848">afterTest</span><span class="op" id="404857">(</span><span class="ident" id="404858">t</span><span class="op" id="404859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="404862">var</span>&nbsp;<span class="ident" id="404866">ts</span>&nbsp;<span class="op" id="404869">*</span><span class="ident" id="404870">httptest</span><span class="op" id="404878">.</span><span class="ident" id="404879">Server</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="404887">ts</span>&nbsp;<span class="op" id="404890">=</span>&nbsp;<span class="ident" id="404892">httptest</span><span class="op" id="404900">.</span><span class="ident" id="404901">NewServer</span><span class="op" id="404910">(</span><span class="ident" id="404911">echoCookiesRedirectHandler</span><span class="op" id="404937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="404940">defer</span>&nbsp;<span class="ident" id="404946">ts</span><span class="op" id="404948">.</span><span class="ident" id="404949">Close</span><span class="op" id="404954">(</span><span class="op" id="404955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="404958">c</span>&nbsp;<span class="op" id="404960">:=</span>&nbsp;<span class="op" id="404963">&amp;</span><span class="ident" id="404964">Client</span><span class="op" id="404970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="404974">Jar</span><span class="op" id="404977">:</span>&nbsp;<span class="builtinfunc" id="404979">new</span><span class="op" id="404982">(</span><span class="ident" id="404983">TestJar</span><span class="op" id="404990">)</span><span class="op" id="404991">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="404994">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="404997">u</span><span class="op" id="404998">,</span>&nbsp;<span class="ident" id="405000">_</span>&nbsp;<span class="op" id="405002">:=</span>&nbsp;<span class="ident" id="405005">url</span><span class="op" id="405008">.</span><span class="ident" id="405009">Parse</span><span class="op" id="405014">(</span><span class="ident" id="405015">ts</span><span class="op" id="405017">.</span><span class="ident" id="405018">URL</span><span class="op" id="405021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="405024">c</span><span class="op" id="405025">.</span><span class="ident" id="405026">Jar</span><span class="op" id="405029">.</span><span class="ident" id="405030">SetCookies</span><span class="op" id="405040">(</span><span class="ident" id="405041">u</span><span class="op" id="405042">,</span>&nbsp;<span class="op" id="405044">[</span><span class="op" id="405045">]</span><span class="op" id="405046">*</span><span class="ident" id="405047">Cookie</span><span class="op" id="405053">{</span><span class="ident" id="405054">expectedCookies</span><span class="op" id="405069">[</span><span class="num" id="405070">0</span><span class="op" id="405071">]</span><span class="op" id="405072">}</span><span class="op" id="405073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="405076">resp</span><span class="op" id="405080">,</span>&nbsp;<span class="ident" id="405082">err</span>&nbsp;<span class="op" id="405086">:=</span>&nbsp;<span class="ident" id="405089">c</span><span class="op" id="405090">.</span><span class="ident" id="405091">Get</span><span class="op" id="405094">(</span><span class="ident" id="405095">ts</span><span class="op" id="405097">.</span><span class="ident" id="405098">URL</span><span class="op" id="405101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="405104">if</span>&nbsp;<span class="ident" id="405107">err</span>&nbsp;<span class="op" id="405111">!=</span>&nbsp;<span class="ident" id="405114">nil</span>&nbsp;<span class="op" id="405118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="405122">t</span><span class="op" id="405123">.</span><span class="ident" id="405124">Fatalf</span><span class="op" id="405130">(</span><span class="string" id="405131">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="405140">,</span>&nbsp;<span class="ident" id="405142">err</span><span class="op" id="405145">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="405148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="405151">resp</span><span class="op" id="405155">.</span><span class="ident" id="405156">Body</span><span class="op" id="405160">.</span><span class="ident" id="405161">Close</span><span class="op" id="405166">(</span><span class="op" id="405167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="405170">matchReturnedCookies</span><span class="op" id="405190">(</span><span class="ident" id="405191">t</span><span class="op" id="405192">,</span>&nbsp;<span class="ident" id="405194">expectedCookies</span><span class="op" id="405209">,</span>&nbsp;<span class="ident" id="405211">resp</span><span class="op" id="405215">.</span><span class="ident" id="405216">Cookies</span><span class="op" id="405223">(</span><span class="op" id="405224">)</span><span class="op" id="405225">)</span><br>
<span class="lineno"></span><span class="op" id="405227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="405230">func</span>&nbsp;<span class="ident" id="405235">matchReturnedCookies</span><span class="op" id="405255">(</span><span class="ident" id="405256">t</span>&nbsp;<span class="op" id="405258">*</span><span class="ident" id="405259">testing</span><span class="op" id="405266">.</span><span class="ident" id="405267">T</span><span class="op" id="405268">,</span>&nbsp;<span class="ident" id="405270">expected</span><span class="op" id="405278">,</span>&nbsp;<span class="ident" id="405280">given</span>&nbsp;<span class="op" id="405286">[</span><span class="op" id="405287">]</span><span class="op" id="405288">*</span><span class="ident" id="405289">Cookie</span><span class="op" id="405295">)</span>&nbsp;<span class="op" id="405297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="405300">if</span>&nbsp;<span class="builtinfunc" id="405303">len</span><span class="op" id="405306">(</span><span class="ident" id="405307">given</span><span class="op" id="405312">)</span>&nbsp;<span class="op" id="405314">!=</span>&nbsp;<span class="builtinfunc" id="405317">len</span><span class="op" id="405320">(</span><span class="ident" id="405321">expected</span><span class="op" id="405329">)</span>&nbsp;<span class="op" id="405331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="405335">t</span><span class="op" id="405336">.</span><span class="ident" id="405337">Logf</span><span class="op" id="405341">(</span><span class="string" id="405342">&#34;Received&nbsp;cookies:&nbsp;%v&#34;</span><span class="op" id="405364">,</span>&nbsp;<span class="ident" id="405366">given</span><span class="op" id="405371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="405375">t</span><span class="op" id="405376">.</span><span class="ident" id="405377">Errorf</span><span class="op" id="405383">(</span><span class="string" id="405384">&#34;Expected&nbsp;%d&nbsp;cookies,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="405413">,</span>&nbsp;<span class="builtinfunc" id="405415">len</span><span class="op" id="405418">(</span><span class="ident" id="405419">expected</span><span class="op" id="405427">)</span><span class="op" id="405428">,</span>&nbsp;<span class="builtinfunc" id="405430">len</span><span class="op" id="405433">(</span><span class="ident" id="405434">given</span><span class="op" id="405439">)</span><span class="op" id="405440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="405443">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="405446">for</span>&nbsp;<span class="ident" id="405450">_</span><span class="op" id="405451">,</span>&nbsp;<span class="ident" id="405453">ec</span>&nbsp;<span class="op" id="405456">:=</span>&nbsp;<span class="keyword" id="405459">range</span>&nbsp;<span class="ident" id="405465">expected</span>&nbsp;<span class="op" id="405474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="405478">foundC</span>&nbsp;<span class="op" id="405485">:=</span>&nbsp;<span class="builtintype" id="405488">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="405496">for</span>&nbsp;<span class="ident" id="405500">_</span><span class="op" id="405501">,</span>&nbsp;<span class="ident" id="405503">c</span>&nbsp;<span class="op" id="405505">:=</span>&nbsp;<span class="keyword" id="405508">range</span>&nbsp;<span class="ident" id="405514">given</span>&nbsp;<span class="op" id="405520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="405525">if</span>&nbsp;<span class="ident" id="405528">ec</span><span class="op" id="405530">.</span><span class="ident" id="405531">Name</span>&nbsp;<span class="op" id="405536">==</span>&nbsp;<span class="ident" id="405539">c</span><span class="op" id="405540">.</span><span class="ident" id="405541">Name</span>&nbsp;<span class="op" id="405546">&amp;&amp;</span>&nbsp;<span class="ident" id="405549">ec</span><span class="op" id="405551">.</span><span class="ident" id="405552">Value</span>&nbsp;<span class="op" id="405558">==</span>&nbsp;<span class="ident" id="405561">c</span><span class="op" id="405562">.</span><span class="ident" id="405563">Value</span>&nbsp;<span class="op" id="405569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="405575">foundC</span>&nbsp;<span class="op" id="405582">=</span>&nbsp;<span class="builtintype" id="405584">true</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="405593">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="405602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="405606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="405610">if</span>&nbsp;<span class="op" id="405613">!</span><span class="ident" id="405614">foundC</span>&nbsp;<span class="op" id="405621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="405626">t</span><span class="op" id="405627">.</span><span class="ident" id="405628">Errorf</span><span class="op" id="405634">(</span><span class="string" id="405635">&#34;Missing&nbsp;cookie&nbsp;%v&#34;</span><span class="op" id="405654">,</span>&nbsp;<span class="ident" id="405656">ec</span><span class="op" id="405658">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="405662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="405665">}</span><br>
<span class="lineno"></span><span class="op" id="405667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="405670">func</span>&nbsp;<span class="ident" id="405675">TestJarCalls</span><span class="op" id="405687">(</span><span class="ident" id="405688">t</span>&nbsp;<span class="op" id="405690">*</span><span class="ident" id="405691">testing</span><span class="op" id="405698">.</span><span class="ident" id="405699">T</span><span class="op" id="405700">)</span>&nbsp;<span class="op" id="405702">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="405705">defer</span>&nbsp;<span class="ident" id="405711">afterTest</span><span class="op" id="405720">(</span><span class="ident" id="405721">t</span><span class="op" id="405722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="405725">ts</span>&nbsp;<span class="op" id="405728">:=</span>&nbsp;<span class="ident" id="405731">httptest</span><span class="op" id="405739">.</span><span class="ident" id="405740">NewServer</span><span class="op" id="405749">(</span><span class="ident" id="405750">HandlerFunc</span><span class="op" id="405761">(</span><span class="keyword" id="405762">func</span><span class="op" id="405766">(</span><span class="ident" id="405767">w</span>&nbsp;<span class="ident" id="405769">ResponseWriter</span><span class="op" id="405783">,</span>&nbsp;<span class="ident" id="405785">r</span>&nbsp;<span class="op" id="405787">*</span><span class="ident" id="405788">Request</span><span class="op" id="405795">)</span>&nbsp;<span class="op" id="405797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="405801">pathSuffix</span>&nbsp;<span class="op" id="405812">:=</span>&nbsp;<span class="ident" id="405815">r</span><span class="op" id="405816">.</span><span class="ident" id="405817">RequestURI</span><span class="op" id="405827">[</span><span class="num" id="405828">1</span><span class="op" id="405829">:</span><span class="op" id="405830">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="405834">if</span>&nbsp;<span class="ident" id="405837">r</span><span class="op" id="405838">.</span><span class="ident" id="405839">RequestURI</span>&nbsp;<span class="op" id="405850">==</span>&nbsp;<span class="string" id="405853">&#34;/nosetcookie&#34;</span>&nbsp;<span class="op" id="405868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="405873">return</span>&nbsp;<span class="comment" id="405880">//&nbsp;dont&nbsp;set&nbsp;cookies&nbsp;for&nbsp;this&nbsp;path</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="405916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="405920">SetCookie</span><span class="op" id="405929">(</span><span class="ident" id="405930">w</span><span class="op" id="405931">,</span>&nbsp;<span class="op" id="405933">&amp;</span><span class="ident" id="405934">Cookie</span><span class="op" id="405940">{</span><span class="ident" id="405941">Name</span><span class="op" id="405945">:</span>&nbsp;<span class="string" id="405947">&#34;name&#34;</span>&nbsp;<span class="op" id="405954">+</span>&nbsp;<span class="ident" id="405956">pathSuffix</span><span class="op" id="405966">,</span>&nbsp;<span class="ident" id="405968">Value</span><span class="op" id="405973">:</span>&nbsp;<span class="string" id="405975">&#34;val&#34;</span>&nbsp;<span class="op" id="405981">+</span>&nbsp;<span class="ident" id="405983">pathSuffix</span><span class="op" id="405993">}</span><span class="op" id="405994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="405998">if</span>&nbsp;<span class="ident" id="406001">r</span><span class="op" id="406002">.</span><span class="ident" id="406003">RequestURI</span>&nbsp;<span class="op" id="406014">==</span>&nbsp;<span class="string" id="406017">&#34;/&#34;</span>&nbsp;<span class="op" id="406021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="406026">Redirect</span><span class="op" id="406034">(</span><span class="ident" id="406035">w</span><span class="op" id="406036">,</span>&nbsp;<span class="ident" id="406038">r</span><span class="op" id="406039">,</span>&nbsp;<span class="string" id="406041">&#34;http://secondhost.fake/secondpath&#34;</span><span class="op" id="406076">,</span>&nbsp;<span class="num" id="406078">302</span><span class="op" id="406081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="406085">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="406088">}</span><span class="op" id="406089">)</span><span class="op" id="406090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="406093">defer</span>&nbsp;<span class="ident" id="406099">ts</span><span class="op" id="406101">.</span><span class="ident" id="406102">Close</span><span class="op" id="406107">(</span><span class="op" id="406108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="406111">jar</span>&nbsp;<span class="op" id="406115">:=</span>&nbsp;<span class="builtinfunc" id="406118">new</span><span class="op" id="406121">(</span><span class="ident" id="406122">RecordingJar</span><span class="op" id="406134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="406137">c</span>&nbsp;<span class="op" id="406139">:=</span>&nbsp;<span class="op" id="406142">&amp;</span><span class="ident" id="406143">Client</span><span class="op" id="406149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="406153">Jar</span><span class="op" id="406156">:</span>&nbsp;<span class="ident" id="406158">jar</span><span class="op" id="406161">,</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="406165">Transport</span><span class="op" id="406174">:</span>&nbsp;<span class="op" id="406176">&amp;</span><span class="ident" id="406177">Transport</span><span class="op" id="406186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="406191">Dial</span><span class="op" id="406195">:</span>&nbsp;<span class="keyword" id="406197">func</span><span class="op" id="406201">(</span><span class="ident" id="406202">_</span>&nbsp;<span class="builtintype" id="406204">string</span><span class="op" id="406210">,</span>&nbsp;<span class="ident" id="406212">_</span>&nbsp;<span class="builtintype" id="406214">string</span><span class="op" id="406220">)</span>&nbsp;<span class="op" id="406222">(</span><span class="ident" id="406223">net</span><span class="op" id="406226">.</span><span class="ident" id="406227">Conn</span><span class="op" id="406231">,</span>&nbsp;<span class="builtintype" id="406233">error</span><span class="op" id="406238">)</span>&nbsp;<span class="op" id="406240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="406246">return</span>&nbsp;<span class="ident" id="406253">net</span><span class="op" id="406256">.</span><span class="ident" id="406257">Dial</span><span class="op" id="406261">(</span><span class="string" id="406262">&#34;tcp&#34;</span><span class="op" id="406267">,</span>&nbsp;<span class="ident" id="406269">ts</span><span class="op" id="406271">.</span><span class="ident" id="406272">Listener</span><span class="op" id="406280">.</span><span class="ident" id="406281">Addr</span><span class="op" id="406285">(</span><span class="op" id="406286">)</span><span class="op" id="406287">.</span><span class="ident" id="406288">String</span><span class="op" id="406294">(</span><span class="op" id="406295">)</span><span class="op" id="406296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="406301">}</span><span class="op" id="406302">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="406306">}</span><span class="op" id="406307">,</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="406310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="406313">_</span><span class="op" id="406314">,</span>&nbsp;<span class="ident" id="406316">err</span>&nbsp;<span class="op" id="406320">:=</span>&nbsp;<span class="ident" id="406323">c</span><span class="op" id="406324">.</span><span class="ident" id="406325">Get</span><span class="op" id="406328">(</span><span class="string" id="406329">&#34;http://firsthost.fake/&#34;</span><span class="op" id="406353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="406356">if</span>&nbsp;<span class="ident" id="406359">err</span>&nbsp;<span class="op" id="406363">!=</span>&nbsp;<span class="ident" id="406366">nil</span>&nbsp;<span class="op" id="406370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="406374">t</span><span class="op" id="406375">.</span><span class="ident" id="406376">Fatal</span><span class="op" id="406381">(</span><span class="ident" id="406382">err</span><span class="op" id="406385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="406388">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="406391">_</span><span class="op" id="406392">,</span>&nbsp;<span class="ident" id="406394">err</span>&nbsp;<span class="op" id="406398">=</span>&nbsp;<span class="ident" id="406400">c</span><span class="op" id="406401">.</span><span class="ident" id="406402">Get</span><span class="op" id="406405">(</span><span class="string" id="406406">&#34;http://firsthost.fake/nosetcookie&#34;</span><span class="op" id="406441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="406444">if</span>&nbsp;<span class="ident" id="406447">err</span>&nbsp;<span class="op" id="406451">!=</span>&nbsp;<span class="ident" id="406454">nil</span>&nbsp;<span class="op" id="406458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="406462">t</span><span class="op" id="406463">.</span><span class="ident" id="406464">Fatal</span><span class="op" id="406469">(</span><span class="ident" id="406470">err</span><span class="op" id="406473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="406476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="406479">got</span>&nbsp;<span class="op" id="406483">:=</span>&nbsp;<span class="ident" id="406486">jar</span><span class="op" id="406489">.</span><span class="ident" id="406490">log</span><span class="op" id="406493">.</span><span class="ident" id="406494">String</span><span class="op" id="406500">(</span><span class="op" id="406501">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="406504">want</span>&nbsp;<span class="op" id="406509">:=</span>&nbsp;<span class="string" id="406512">`Cookies(&#34;http://firsthost.fake/&#34;)<br>
<span class="lineno"></span>SetCookie(&#34;http://firsthost.fake/&#34;,&nbsp;[name=val])<br>
<span class="lineno"></span>Cookies(&#34;http://secondhost.fake/secondpath&#34;)<br>
<span class="lineno"></span>SetCookie(&#34;http://secondhost.fake/secondpath&#34;,&nbsp;[namesecondpath=valsecondpath])<br>
<span class="lineno"></span>Cookies(&#34;http://firsthost.fake/nosetcookie&#34;)<br>
<span class="lineno">460</span>`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="406767">if</span>&nbsp;<span class="ident" id="406770">got</span>&nbsp;<span class="op" id="406774">!=</span>&nbsp;<span class="ident" id="406777">want</span>&nbsp;<span class="op" id="406782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="406786">t</span><span class="op" id="406787">.</span><span class="ident" id="406788">Errorf</span><span class="op" id="406794">(</span><span class="string" id="406795">&#34;Got&nbsp;Jar&nbsp;calls:\n%s\nWant:\n%s&#34;</span><span class="op" id="406826">,</span>&nbsp;<span class="ident" id="406828">got</span><span class="op" id="406831">,</span>&nbsp;<span class="ident" id="406833">want</span><span class="op" id="406837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="406840">}</span><br>
<span class="lineno"></span><span class="op" id="406842">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span><span class="comment" id="406845">//&nbsp;RecordingJar&nbsp;keeps&nbsp;a&nbsp;log&nbsp;of&nbsp;calls&nbsp;made&nbsp;to&nbsp;it,&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="406902">//&nbsp;tracking&nbsp;any&nbsp;cookies.</span><br>
<span class="lineno"></span><span class="keyword" id="406927">type</span>&nbsp;<span class="ident" id="406932">RecordingJar</span>&nbsp;<span class="keyword" id="406945">struct</span>&nbsp;<span class="op" id="406952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="406955">mu</span>&nbsp;&nbsp;<span class="ident" id="406959">sync</span><span class="op" id="406963">.</span><span class="ident" id="406964">Mutex</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="406971">log</span>&nbsp;<span class="ident" id="406975">bytes</span><span class="op" id="406980">.</span><span class="ident" id="406981">Buffer</span><br>
<span class="lineno"></span><span class="op" id="406988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="406991">func</span>&nbsp;<span class="op" id="406996">(</span><span class="ident" id="406997">j</span>&nbsp;<span class="op" id="406999">*</span><span class="ident" id="407000">RecordingJar</span><span class="op" id="407012">)</span>&nbsp;<span class="ident" id="407014">SetCookies</span><span class="op" id="407024">(</span><span class="ident" id="407025">u</span>&nbsp;<span class="op" id="407027">*</span><span class="ident" id="407028">url</span><span class="op" id="407031">.</span><span class="ident" id="407032">URL</span><span class="op" id="407035">,</span>&nbsp;<span class="ident" id="407037">cookies</span>&nbsp;<span class="op" id="407045">[</span><span class="op" id="407046">]</span><span class="op" id="407047">*</span><span class="ident" id="407048">Cookie</span><span class="op" id="407054">)</span>&nbsp;<span class="op" id="407056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="407059">j</span><span class="op" id="407060">.</span><span class="ident" id="407061">logf</span><span class="op" id="407065">(</span><span class="string" id="407066">&#34;SetCookie(%q,&nbsp;%v)\n&#34;</span><span class="op" id="407087">,</span>&nbsp;<span class="ident" id="407089">u</span><span class="op" id="407090">,</span>&nbsp;<span class="ident" id="407092">cookies</span><span class="op" id="407099">)</span><br>
<span class="lineno">475</span><span class="op" id="407101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="407104">func</span>&nbsp;<span class="op" id="407109">(</span><span class="ident" id="407110">j</span>&nbsp;<span class="op" id="407112">*</span><span class="ident" id="407113">RecordingJar</span><span class="op" id="407125">)</span>&nbsp;<span class="ident" id="407127">Cookies</span><span class="op" id="407134">(</span><span class="ident" id="407135">u</span>&nbsp;<span class="op" id="407137">*</span><span class="ident" id="407138">url</span><span class="op" id="407141">.</span><span class="ident" id="407142">URL</span><span class="op" id="407145">)</span>&nbsp;<span class="op" id="407147">[</span><span class="op" id="407148">]</span><span class="op" id="407149">*</span><span class="ident" id="407150">Cookie</span>&nbsp;<span class="op" id="407157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="407160">j</span><span class="op" id="407161">.</span><span class="ident" id="407162">logf</span><span class="op" id="407166">(</span><span class="string" id="407167">&#34;Cookies(%q)\n&#34;</span><span class="op" id="407182">,</span>&nbsp;<span class="ident" id="407184">u</span><span class="op" id="407185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="407188">return</span>&nbsp;<span class="ident" id="407195">nil</span><br>
<span class="lineno">480</span><span class="op" id="407199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="407202">func</span>&nbsp;<span class="op" id="407207">(</span><span class="ident" id="407208">j</span>&nbsp;<span class="op" id="407210">*</span><span class="ident" id="407211">RecordingJar</span><span class="op" id="407223">)</span>&nbsp;<span class="ident" id="407225">logf</span><span class="op" id="407229">(</span><span class="ident" id="407230">format</span>&nbsp;<span class="builtintype" id="407237">string</span><span class="op" id="407243">,</span>&nbsp;<span class="ident" id="407245">args</span>&nbsp;<span class="op" id="407250">...</span><span class="keyword" id="407253">interface</span><span class="op" id="407262">{</span><span class="op" id="407263">}</span><span class="op" id="407264">)</span>&nbsp;<span class="op" id="407266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="407269">j</span><span class="op" id="407270">.</span><span class="ident" id="407271">mu</span><span class="op" id="407273">.</span><span class="ident" id="407274">Lock</span><span class="op" id="407278">(</span><span class="op" id="407279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="407282">defer</span>&nbsp;<span class="ident" id="407288">j</span><span class="op" id="407289">.</span><span class="ident" id="407290">mu</span><span class="op" id="407292">.</span><span class="ident" id="407293">Unlock</span><span class="op" id="407299">(</span><span class="op" id="407300">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="407303">fmt</span><span class="op" id="407306">.</span><span class="ident" id="407307">Fprintf</span><span class="op" id="407314">(</span><span class="op" id="407315">&amp;</span><span class="ident" id="407316">j</span><span class="op" id="407317">.</span><span class="ident" id="407318">log</span><span class="op" id="407321">,</span>&nbsp;<span class="ident" id="407323">format</span><span class="op" id="407329">,</span>&nbsp;<span class="ident" id="407331">args</span><span class="op" id="407335">...</span><span class="op" id="407338">)</span><br>
<span class="lineno"></span><span class="op" id="407340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="407343">func</span>&nbsp;<span class="ident" id="407348">TestStreamingGet</span><span class="op" id="407364">(</span><span class="ident" id="407365">t</span>&nbsp;<span class="op" id="407367">*</span><span class="ident" id="407368">testing</span><span class="op" id="407375">.</span><span class="ident" id="407376">T</span><span class="op" id="407377">)</span>&nbsp;<span class="op" id="407379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="407382">defer</span>&nbsp;<span class="ident" id="407388">afterTest</span><span class="op" id="407397">(</span><span class="ident" id="407398">t</span><span class="op" id="407399">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="407402">say</span>&nbsp;<span class="op" id="407406">:=</span>&nbsp;<span class="builtinfunc" id="407409">make</span><span class="op" id="407413">(</span><span class="keyword" id="407414">chan</span>&nbsp;<span class="builtintype" id="407419">string</span><span class="op" id="407425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="407428">ts</span>&nbsp;<span class="op" id="407431">:=</span>&nbsp;<span class="ident" id="407434">httptest</span><span class="op" id="407442">.</span><span class="ident" id="407443">NewServer</span><span class="op" id="407452">(</span><span class="ident" id="407453">HandlerFunc</span><span class="op" id="407464">(</span><span class="keyword" id="407465">func</span><span class="op" id="407469">(</span><span class="ident" id="407470">w</span>&nbsp;<span class="ident" id="407472">ResponseWriter</span><span class="op" id="407486">,</span>&nbsp;<span class="ident" id="407488">r</span>&nbsp;<span class="op" id="407490">*</span><span class="ident" id="407491">Request</span><span class="op" id="407498">)</span>&nbsp;<span class="op" id="407500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="407504">w</span><span class="op" id="407505">.</span><span class="op" id="407506">(</span><span class="ident" id="407507">Flusher</span><span class="op" id="407514">)</span><span class="op" id="407515">.</span><span class="ident" id="407516">Flush</span><span class="op" id="407521">(</span><span class="op" id="407522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="407526">for</span>&nbsp;<span class="ident" id="407530">str</span>&nbsp;<span class="op" id="407534">:=</span>&nbsp;<span class="keyword" id="407537">range</span>&nbsp;<span class="ident" id="407543">say</span>&nbsp;<span class="op" id="407547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="407552">w</span><span class="op" id="407553">.</span><span class="ident" id="407554">Write</span><span class="op" id="407559">(</span><span class="op" id="407560">[</span><span class="op" id="407561">]</span><span class="builtintype" id="407562">byte</span><span class="op" id="407566">(</span><span class="ident" id="407567">str</span><span class="op" id="407570">)</span><span class="op" id="407571">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="407576">w</span><span class="op" id="407577">.</span><span class="op" id="407578">(</span><span class="ident" id="407579">Flusher</span><span class="op" id="407586">)</span><span class="op" id="407587">.</span><span class="ident" id="407588">Flush</span><span class="op" id="407593">(</span><span class="op" id="407594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="407598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="407601">}</span><span class="op" id="407602">)</span><span class="op" id="407603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="407606">defer</span>&nbsp;<span class="ident" id="407612">ts</span><span class="op" id="407614">.</span><span class="ident" id="407615">Close</span><span class="op" id="407620">(</span><span class="op" id="407621">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="407625">c</span>&nbsp;<span class="op" id="407627">:=</span>&nbsp;<span class="op" id="407630">&amp;</span><span class="ident" id="407631">Client</span><span class="op" id="407637">{</span><span class="op" id="407638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="407641">res</span><span class="op" id="407644">,</span>&nbsp;<span class="ident" id="407646">err</span>&nbsp;<span class="op" id="407650">:=</span>&nbsp;<span class="ident" id="407653">c</span><span class="op" id="407654">.</span><span class="ident" id="407655">Get</span><span class="op" id="407658">(</span><span class="ident" id="407659">ts</span><span class="op" id="407661">.</span><span class="ident" id="407662">URL</span><span class="op" id="407665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="407668">if</span>&nbsp;<span class="ident" id="407671">err</span>&nbsp;<span class="op" id="407675">!=</span>&nbsp;<span class="ident" id="407678">nil</span>&nbsp;<span class="op" id="407682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="407686">t</span><span class="op" id="407687">.</span><span class="ident" id="407688">Fatal</span><span class="op" id="407693">(</span><span class="ident" id="407694">err</span><span class="op" id="407697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="407700">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="407703">var</span>&nbsp;<span class="ident" id="407707">buf</span>&nbsp;<span class="op" id="407711">[</span><span class="num" id="407712">10</span><span class="op" id="407714">]</span><span class="builtintype" id="407715">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="407721">for</span>&nbsp;<span class="ident" id="407725">_</span><span class="op" id="407726">,</span>&nbsp;<span class="ident" id="407728">str</span>&nbsp;<span class="op" id="407732">:=</span>&nbsp;<span class="keyword" id="407735">range</span>&nbsp;<span class="op" id="407741">[</span><span class="op" id="407742">]</span><span class="builtintype" id="407743">string</span><span class="op" id="407749">{</span><span class="string" id="407750">&#34;i&#34;</span><span class="op" id="407753">,</span>&nbsp;<span class="string" id="407755">&#34;am&#34;</span><span class="op" id="407759">,</span>&nbsp;<span class="string" id="407761">&#34;also&#34;</span><span class="op" id="407767">,</span>&nbsp;<span class="string" id="407769">&#34;known&#34;</span><span class="op" id="407776">,</span>&nbsp;<span class="string" id="407778">&#34;as&#34;</span><span class="op" id="407782">,</span>&nbsp;<span class="string" id="407784">&#34;comet&#34;</span><span class="op" id="407791">}</span>&nbsp;<span class="op" id="407793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="407797">say</span>&nbsp;<span class="op" id="407801">&lt;-</span>&nbsp;<span class="ident" id="407804">str</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="407810">n</span><span class="op" id="407811">,</span>&nbsp;<span class="ident" id="407813">err</span>&nbsp;<span class="op" id="407817">:=</span>&nbsp;<span class="ident" id="407820">io</span><span class="op" id="407822">.</span><span class="ident" id="407823">ReadFull</span><span class="op" id="407831">(</span><span class="ident" id="407832">res</span><span class="op" id="407835">.</span><span class="ident" id="407836">Body</span><span class="op" id="407840">,</span>&nbsp;<span class="ident" id="407842">buf</span><span class="op" id="407845">[</span><span class="num" id="407846">0</span><span class="op" id="407847">:</span><span class="builtinfunc" id="407848">len</span><span class="op" id="407851">(</span><span class="ident" id="407852">str</span><span class="op" id="407855">)</span><span class="op" id="407856">]</span><span class="op" id="407857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="407861">if</span>&nbsp;<span class="ident" id="407864">err</span>&nbsp;<span class="op" id="407868">!=</span>&nbsp;<span class="ident" id="407871">nil</span>&nbsp;<span class="op" id="407875">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="407880">t</span><span class="op" id="407881">.</span><span class="ident" id="407882">Fatalf</span><span class="op" id="407888">(</span><span class="string" id="407889">&#34;ReadFull&nbsp;on&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="407909">,</span>&nbsp;<span class="ident" id="407911">str</span><span class="op" id="407914">,</span>&nbsp;<span class="ident" id="407916">err</span><span class="op" id="407919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="407923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="407927">if</span>&nbsp;<span class="ident" id="407930">n</span>&nbsp;<span class="op" id="407932">!=</span>&nbsp;<span class="builtinfunc" id="407935">len</span><span class="op" id="407938">(</span><span class="ident" id="407939">str</span><span class="op" id="407942">)</span>&nbsp;<span class="op" id="407944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="407949">t</span><span class="op" id="407950">.</span><span class="ident" id="407951">Fatalf</span><span class="op" id="407957">(</span><span class="string" id="407958">&#34;Receiving&nbsp;%q,&nbsp;only&nbsp;read&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="407992">,</span>&nbsp;<span class="ident" id="407994">str</span><span class="op" id="407997">,</span>&nbsp;<span class="ident" id="407999">n</span><span class="op" id="408000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="408004">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="408008">got</span>&nbsp;<span class="op" id="408012">:=</span>&nbsp;<span class="builtintype" id="408015">string</span><span class="op" id="408021">(</span><span class="ident" id="408022">buf</span><span class="op" id="408025">[</span><span class="num" id="408026">0</span><span class="op" id="408027">:</span><span class="ident" id="408028">n</span><span class="op" id="408029">]</span><span class="op" id="408030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="408034">if</span>&nbsp;<span class="ident" id="408037">got</span>&nbsp;<span class="op" id="408041">!=</span>&nbsp;<span class="ident" id="408044">str</span>&nbsp;<span class="op" id="408048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="408053">t</span><span class="op" id="408054">.</span><span class="ident" id="408055">Fatalf</span><span class="op" id="408061">(</span><span class="string" id="408062">&#34;Expected&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="408083">,</span>&nbsp;<span class="ident" id="408085">str</span><span class="op" id="408088">,</span>&nbsp;<span class="ident" id="408090">got</span><span class="op" id="408093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="408097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="408100">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="408103">close</span><span class="op" id="408108">(</span><span class="ident" id="408109">say</span><span class="op" id="408112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="408115">_</span><span class="op" id="408116">,</span>&nbsp;<span class="ident" id="408118">err</span>&nbsp;<span class="op" id="408122">=</span>&nbsp;<span class="ident" id="408124">io</span><span class="op" id="408126">.</span><span class="ident" id="408127">ReadFull</span><span class="op" id="408135">(</span><span class="ident" id="408136">res</span><span class="op" id="408139">.</span><span class="ident" id="408140">Body</span><span class="op" id="408144">,</span>&nbsp;<span class="ident" id="408146">buf</span><span class="op" id="408149">[</span><span class="num" id="408150">0</span><span class="op" id="408151">:</span><span class="num" id="408152">1</span><span class="op" id="408153">]</span><span class="op" id="408154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="408157">if</span>&nbsp;<span class="ident" id="408160">err</span>&nbsp;<span class="op" id="408164">!=</span>&nbsp;<span class="ident" id="408167">io</span><span class="op" id="408169">.</span><span class="ident" id="408170">EOF</span>&nbsp;<span class="op" id="408174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="408178">t</span><span class="op" id="408179">.</span><span class="ident" id="408180">Fatalf</span><span class="op" id="408186">(</span><span class="string" id="408187">&#34;at&nbsp;end&nbsp;expected&nbsp;EOF,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="408216">,</span>&nbsp;<span class="ident" id="408218">err</span><span class="op" id="408221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="408224">}</span><br>
<span class="lineno">525</span><span class="op" id="408226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="408229">type</span>&nbsp;<span class="ident" id="408234">writeCountingConn</span>&nbsp;<span class="keyword" id="408252">struct</span>&nbsp;<span class="op" id="408259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="408262">net</span><span class="op" id="408265">.</span><span class="ident" id="408266">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="408272">count</span>&nbsp;<span class="op" id="408278">*</span><span class="builtintype" id="408279">int</span><br>
<span class="lineno">530</span><span class="op" id="408283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="408286">func</span>&nbsp;<span class="op" id="408291">(</span><span class="ident" id="408292">c</span>&nbsp;<span class="op" id="408294">*</span><span class="ident" id="408295">writeCountingConn</span><span class="op" id="408312">)</span>&nbsp;<span class="ident" id="408314">Write</span><span class="op" id="408319">(</span><span class="ident" id="408320">p</span>&nbsp;<span class="op" id="408322">[</span><span class="op" id="408323">]</span><span class="builtintype" id="408324">byte</span><span class="op" id="408328">)</span>&nbsp;<span class="op" id="408330">(</span><span class="builtintype" id="408331">int</span><span class="op" id="408334">,</span>&nbsp;<span class="builtintype" id="408336">error</span><span class="op" id="408341">)</span>&nbsp;<span class="op" id="408343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="408346">*</span><span class="ident" id="408347">c</span><span class="op" id="408348">.</span><span class="ident" id="408349">count</span><span class="op" id="408354">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="408358">return</span>&nbsp;<span class="ident" id="408365">c</span><span class="op" id="408366">.</span><span class="ident" id="408367">Conn</span><span class="op" id="408371">.</span><span class="ident" id="408372">Write</span><span class="op" id="408377">(</span><span class="ident" id="408378">p</span><span class="op" id="408379">)</span><br>
<span class="lineno">535</span><span class="op" id="408381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="408384">//&nbsp;TestClientWrites&nbsp;verifies&nbsp;that&nbsp;client&nbsp;requests&nbsp;are&nbsp;buffered&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="408454">//&nbsp;don&#39;t&nbsp;send&nbsp;a&nbsp;TCP&nbsp;packet&nbsp;per&nbsp;line&nbsp;of&nbsp;the&nbsp;http&nbsp;request&nbsp;+&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="408518">func</span>&nbsp;<span class="ident" id="408523">TestClientWrites</span><span class="op" id="408539">(</span><span class="ident" id="408540">t</span>&nbsp;<span class="op" id="408542">*</span><span class="ident" id="408543">testing</span><span class="op" id="408550">.</span><span class="ident" id="408551">T</span><span class="op" id="408552">)</span>&nbsp;<span class="op" id="408554">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="408557">defer</span>&nbsp;<span class="ident" id="408563">afterTest</span><span class="op" id="408572">(</span><span class="ident" id="408573">t</span><span class="op" id="408574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="408577">ts</span>&nbsp;<span class="op" id="408580">:=</span>&nbsp;<span class="ident" id="408583">httptest</span><span class="op" id="408591">.</span><span class="ident" id="408592">NewServer</span><span class="op" id="408601">(</span><span class="ident" id="408602">HandlerFunc</span><span class="op" id="408613">(</span><span class="keyword" id="408614">func</span><span class="op" id="408618">(</span><span class="ident" id="408619">w</span>&nbsp;<span class="ident" id="408621">ResponseWriter</span><span class="op" id="408635">,</span>&nbsp;<span class="ident" id="408637">r</span>&nbsp;<span class="op" id="408639">*</span><span class="ident" id="408640">Request</span><span class="op" id="408647">)</span>&nbsp;<span class="op" id="408649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="408652">}</span><span class="op" id="408653">)</span><span class="op" id="408654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="408657">defer</span>&nbsp;<span class="ident" id="408663">ts</span><span class="op" id="408665">.</span><span class="ident" id="408666">Close</span><span class="op" id="408671">(</span><span class="op" id="408672">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="408676">writes</span>&nbsp;<span class="op" id="408683">:=</span>&nbsp;<span class="num" id="408686">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="408689">dialer</span>&nbsp;<span class="op" id="408696">:=</span>&nbsp;<span class="keyword" id="408699">func</span><span class="op" id="408703">(</span><span class="ident" id="408704">netz</span>&nbsp;<span class="builtintype" id="408709">string</span><span class="op" id="408715">,</span>&nbsp;<span class="ident" id="408717">addr</span>&nbsp;<span class="builtintype" id="408722">string</span><span class="op" id="408728">)</span>&nbsp;<span class="op" id="408730">(</span><span class="ident" id="408731">net</span><span class="op" id="408734">.</span><span class="ident" id="408735">Conn</span><span class="op" id="408739">,</span>&nbsp;<span class="builtintype" id="408741">error</span><span class="op" id="408746">)</span>&nbsp;<span class="op" id="408748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="408752">c</span><span class="op" id="408753">,</span>&nbsp;<span class="ident" id="408755">err</span>&nbsp;<span class="op" id="408759">:=</span>&nbsp;<span class="ident" id="408762">net</span><span class="op" id="408765">.</span><span class="ident" id="408766">Dial</span><span class="op" id="408770">(</span><span class="ident" id="408771">netz</span><span class="op" id="408775">,</span>&nbsp;<span class="ident" id="408777">addr</span><span class="op" id="408781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="408785">if</span>&nbsp;<span class="ident" id="408788">err</span>&nbsp;<span class="op" id="408792">==</span>&nbsp;<span class="ident" id="408795">nil</span>&nbsp;<span class="op" id="408799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="408804">c</span>&nbsp;<span class="op" id="408806">=</span>&nbsp;<span class="op" id="408808">&amp;</span><span class="ident" id="408809">writeCountingConn</span><span class="op" id="408826">{</span><span class="ident" id="408827">c</span><span class="op" id="408828">,</span>&nbsp;<span class="op" id="408830">&amp;</span><span class="ident" id="408831">writes</span><span class="op" id="408837">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="408841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="408845">return</span>&nbsp;<span class="ident" id="408852">c</span><span class="op" id="408853">,</span>&nbsp;<span class="ident" id="408855">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="408860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="408863">c</span>&nbsp;<span class="op" id="408865">:=</span>&nbsp;<span class="op" id="408868">&amp;</span><span class="ident" id="408869">Client</span><span class="op" id="408875">{</span><span class="ident" id="408876">Transport</span><span class="op" id="408885">:</span>&nbsp;<span class="op" id="408887">&amp;</span><span class="ident" id="408888">Transport</span><span class="op" id="408897">{</span><span class="ident" id="408898">Dial</span><span class="op" id="408902">:</span>&nbsp;<span class="ident" id="408904">dialer</span><span class="op" id="408910">}</span><span class="op" id="408911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="408915">_</span><span class="op" id="408916">,</span>&nbsp;<span class="ident" id="408918">err</span>&nbsp;<span class="op" id="408922">:=</span>&nbsp;<span class="ident" id="408925">c</span><span class="op" id="408926">.</span><span class="ident" id="408927">Get</span><span class="op" id="408930">(</span><span class="ident" id="408931">ts</span><span class="op" id="408933">.</span><span class="ident" id="408934">URL</span><span class="op" id="408937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="408940">if</span>&nbsp;<span class="ident" id="408943">err</span>&nbsp;<span class="op" id="408947">!=</span>&nbsp;<span class="ident" id="408950">nil</span>&nbsp;<span class="op" id="408954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="408958">t</span><span class="op" id="408959">.</span><span class="ident" id="408960">Fatal</span><span class="op" id="408965">(</span><span class="ident" id="408966">err</span><span class="op" id="408969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="408972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="408975">if</span>&nbsp;<span class="ident" id="408978">writes</span>&nbsp;<span class="op" id="408985">!=</span>&nbsp;<span class="num" id="408988">1</span>&nbsp;<span class="op" id="408990">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="408994">t</span><span class="op" id="408995">.</span><span class="ident" id="408996">Errorf</span><span class="op" id="409002">(</span><span class="string" id="409003">&#34;Get&nbsp;request&nbsp;did&nbsp;%d&nbsp;Write&nbsp;calls,&nbsp;want&nbsp;1&#34;</span><span class="op" id="409043">,</span>&nbsp;<span class="ident" id="409045">writes</span><span class="op" id="409051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="409054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="409058">writes</span>&nbsp;<span class="op" id="409065">=</span>&nbsp;<span class="num" id="409067">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="409070">_</span><span class="op" id="409071">,</span>&nbsp;<span class="ident" id="409073">err</span>&nbsp;<span class="op" id="409077">=</span>&nbsp;<span class="ident" id="409079">c</span><span class="op" id="409080">.</span><span class="ident" id="409081">PostForm</span><span class="op" id="409089">(</span><span class="ident" id="409090">ts</span><span class="op" id="409092">.</span><span class="ident" id="409093">URL</span><span class="op" id="409096">,</span>&nbsp;<span class="ident" id="409098">url</span><span class="op" id="409101">.</span><span class="ident" id="409102">Values</span><span class="op" id="409108">{</span><span class="string" id="409109">&#34;foo&#34;</span><span class="op" id="409114">:</span>&nbsp;<span class="op" id="409116">{</span><span class="string" id="409117">&#34;bar&#34;</span><span class="op" id="409122">}</span><span class="op" id="409123">}</span><span class="op" id="409124">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="409127">if</span>&nbsp;<span class="ident" id="409130">err</span>&nbsp;<span class="op" id="409134">!=</span>&nbsp;<span class="ident" id="409137">nil</span>&nbsp;<span class="op" id="409141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="409145">t</span><span class="op" id="409146">.</span><span class="ident" id="409147">Fatal</span><span class="op" id="409152">(</span><span class="ident" id="409153">err</span><span class="op" id="409156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="409159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="409162">if</span>&nbsp;<span class="ident" id="409165">writes</span>&nbsp;<span class="op" id="409172">!=</span>&nbsp;<span class="num" id="409175">1</span>&nbsp;<span class="op" id="409177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="409181">t</span><span class="op" id="409182">.</span><span class="ident" id="409183">Errorf</span><span class="op" id="409189">(</span><span class="string" id="409190">&#34;Post&nbsp;request&nbsp;did&nbsp;%d&nbsp;Write&nbsp;calls,&nbsp;want&nbsp;1&#34;</span><span class="op" id="409231">,</span>&nbsp;<span class="ident" id="409233">writes</span><span class="op" id="409239">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="409242">}</span><br>
<span class="lineno"></span><span class="op" id="409244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="409247">func</span>&nbsp;<span class="ident" id="409252">TestClientInsecureTransport</span><span class="op" id="409279">(</span><span class="ident" id="409280">t</span>&nbsp;<span class="op" id="409282">*</span><span class="ident" id="409283">testing</span><span class="op" id="409290">.</span><span class="ident" id="409291">T</span><span class="op" id="409292">)</span>&nbsp;<span class="op" id="409294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="409297">defer</span>&nbsp;<span class="ident" id="409303">afterTest</span><span class="op" id="409312">(</span><span class="ident" id="409313">t</span><span class="op" id="409314">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="409317">ts</span>&nbsp;<span class="op" id="409320">:=</span>&nbsp;<span class="ident" id="409323">httptest</span><span class="op" id="409331">.</span><span class="ident" id="409332">NewTLSServer</span><span class="op" id="409344">(</span><span class="ident" id="409345">HandlerFunc</span><span class="op" id="409356">(</span><span class="keyword" id="409357">func</span><span class="op" id="409361">(</span><span class="ident" id="409362">w</span>&nbsp;<span class="ident" id="409364">ResponseWriter</span><span class="op" id="409378">,</span>&nbsp;<span class="ident" id="409380">r</span>&nbsp;<span class="op" id="409382">*</span><span class="ident" id="409383">Request</span><span class="op" id="409390">)</span>&nbsp;<span class="op" id="409392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="409396">w</span><span class="op" id="409397">.</span><span class="ident" id="409398">Write</span><span class="op" id="409403">(</span><span class="op" id="409404">[</span><span class="op" id="409405">]</span><span class="builtintype" id="409406">byte</span><span class="op" id="409410">(</span><span class="string" id="409411">&#34;Hello&#34;</span><span class="op" id="409418">)</span><span class="op" id="409419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="409422">}</span><span class="op" id="409423">)</span><span class="op" id="409424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="409427">errc</span>&nbsp;<span class="op" id="409432">:=</span>&nbsp;<span class="builtinfunc" id="409435">make</span><span class="op" id="409439">(</span><span class="ident" id="409440">chanWriter</span><span class="op" id="409450">,</span>&nbsp;<span class="num" id="409452">10</span><span class="op" id="409454">)</span>&nbsp;<span class="comment" id="409456">//&nbsp;but&nbsp;only&nbsp;expecting&nbsp;1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="409481">ts</span><span class="op" id="409483">.</span><span class="ident" id="409484">Config</span><span class="op" id="409490">.</span><span class="ident" id="409491">ErrorLog</span>&nbsp;<span class="op" id="409500">=</span>&nbsp;<span class="ident" id="409502">log</span><span class="op" id="409505">.</span><span class="ident" id="409506">New</span><span class="op" id="409509">(</span><span class="ident" id="409510">errc</span><span class="op" id="409514">,</span>&nbsp;<span class="string" id="409516">&#34;&#34;</span><span class="op" id="409518">,</span>&nbsp;<span class="num" id="409520">0</span><span class="op" id="409521">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="409524">defer</span>&nbsp;<span class="ident" id="409530">ts</span><span class="op" id="409532">.</span><span class="ident" id="409533">Close</span><span class="op" id="409538">(</span><span class="op" id="409539">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="409543">//&nbsp;TODO(bradfitz):&nbsp;add&nbsp;tests&nbsp;for&nbsp;skipping&nbsp;hostname&nbsp;checks&nbsp;too?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="409607">//&nbsp;would&nbsp;require&nbsp;a&nbsp;new&nbsp;cert&nbsp;for&nbsp;testing,&nbsp;and&nbsp;probably</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="409662">//&nbsp;redundant&nbsp;with&nbsp;these&nbsp;tests.</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="409694">for</span>&nbsp;<span class="ident" id="409698">_</span><span class="op" id="409699">,</span>&nbsp;<span class="ident" id="409701">insecure</span>&nbsp;<span class="op" id="409710">:=</span>&nbsp;<span class="keyword" id="409713">range</span>&nbsp;<span class="op" id="409719">[</span><span class="op" id="409720">]</span><span class="builtintype" id="409721">bool</span><span class="op" id="409725">{</span><span class="builtintype" id="409726">true</span><span class="op" id="409730">,</span>&nbsp;<span class="builtintype" id="409732">false</span><span class="op" id="409737">}</span>&nbsp;<span class="op" id="409739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="409743">tr</span>&nbsp;<span class="op" id="409746">:=</span>&nbsp;<span class="op" id="409749">&amp;</span><span class="ident" id="409750">Transport</span><span class="op" id="409759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="409764">TLSClientConfig</span><span class="op" id="409779">:</span>&nbsp;<span class="op" id="409781">&amp;</span><span class="ident" id="409782">tls</span><span class="op" id="409785">.</span><span class="ident" id="409786">Config</span><span class="op" id="409792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="409798">InsecureSkipVerify</span><span class="op" id="409816">:</span>&nbsp;<span class="ident" id="409818">insecure</span><span class="op" id="409826">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="409831">}</span><span class="op" id="409832">,</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="409836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="409840">defer</span>&nbsp;<span class="ident" id="409846">tr</span><span class="op" id="409848">.</span><span class="ident" id="409849">CloseIdleConnections</span><span class="op" id="409869">(</span><span class="op" id="409870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="409874">c</span>&nbsp;<span class="op" id="409876">:=</span>&nbsp;<span class="op" id="409879">&amp;</span><span class="ident" id="409880">Client</span><span class="op" id="409886">{</span><span class="ident" id="409887">Transport</span><span class="op" id="409896">:</span>&nbsp;<span class="ident" id="409898">tr</span><span class="op" id="409900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="409904">res</span><span class="op" id="409907">,</span>&nbsp;<span class="ident" id="409909">err</span>&nbsp;<span class="op" id="409913">:=</span>&nbsp;<span class="ident" id="409916">c</span><span class="op" id="409917">.</span><span class="ident" id="409918">Get</span><span class="op" id="409921">(</span><span class="ident" id="409922">ts</span><span class="op" id="409924">.</span><span class="ident" id="409925">URL</span><span class="op" id="409928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="409932">if</span>&nbsp;<span class="op" id="409935">(</span><span class="ident" id="409936">err</span>&nbsp;<span class="op" id="409940">==</span>&nbsp;<span class="ident" id="409943">nil</span><span class="op" id="409946">)</span>&nbsp;<span class="op" id="409948">!=</span>&nbsp;<span class="ident" id="409951">insecure</span>&nbsp;<span class="op" id="409960">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="409965">t</span><span class="op" id="409966">.</span><span class="ident" id="409967">Errorf</span><span class="op" id="409973">(</span><span class="string" id="409974">&#34;insecure=%v:&nbsp;got&nbsp;unexpected&nbsp;err=%v&#34;</span><span class="op" id="410010">,</span>&nbsp;<span class="ident" id="410012">insecure</span><span class="op" id="410020">,</span>&nbsp;<span class="ident" id="410022">err</span><span class="op" id="410025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="410029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="410033">if</span>&nbsp;<span class="ident" id="410036">res</span>&nbsp;<span class="op" id="410040">!=</span>&nbsp;<span class="ident" id="410043">nil</span>&nbsp;<span class="op" id="410047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="410052">res</span><span class="op" id="410055">.</span><span class="ident" id="410056">Body</span><span class="op" id="410060">.</span><span class="ident" id="410061">Close</span><span class="op" id="410066">(</span><span class="op" id="410067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="410071">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="410074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="410078">select</span>&nbsp;<span class="op" id="410085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="410088">case</span>&nbsp;<span class="ident" id="410093">v</span>&nbsp;<span class="op" id="410095">:=</span>&nbsp;<span class="op" id="410098">&lt;-</span><span class="ident" id="410100">errc</span><span class="op" id="410104">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="410108">if</span>&nbsp;<span class="op" id="410111">!</span><span class="ident" id="410112">strings</span><span class="op" id="410119">.</span><span class="ident" id="410120">Contains</span><span class="op" id="410128">(</span><span class="ident" id="410129">v</span><span class="op" id="410130">,</span>&nbsp;<span class="string" id="410132">&#34;TLS&nbsp;handshake&nbsp;error&#34;</span><span class="op" id="410153">)</span>&nbsp;<span class="op" id="410155">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="410160">t</span><span class="op" id="410161">.</span><span class="ident" id="410162">Errorf</span><span class="op" id="410168">(</span><span class="string" id="410169">&#34;expected&nbsp;an&nbsp;error&nbsp;log&nbsp;message&nbsp;containing&nbsp;&#39;TLS&nbsp;handshake&nbsp;error&#39;;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="410241">,</span>&nbsp;<span class="ident" id="410243">v</span><span class="op" id="410244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="410248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="410251">case</span>&nbsp;<span class="op" id="410256">&lt;-</span><span class="ident" id="410258">time</span><span class="op" id="410262">.</span><span class="ident" id="410263">After</span><span class="op" id="410268">(</span><span class="num" id="410269">5</span>&nbsp;<span class="op" id="410271">*</span>&nbsp;<span class="ident" id="410273">time</span><span class="op" id="410277">.</span><span class="ident" id="410278">Second</span><span class="op" id="410284">)</span><span class="op" id="410285">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="410289">t</span><span class="op" id="410290">.</span><span class="ident" id="410291">Errorf</span><span class="op" id="410297">(</span><span class="string" id="410298">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;logged&nbsp;error&#34;</span><span class="op" id="410332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="410335">}</span><br>
<span class="lineno">610</span><br>
<span class="lineno"></span><span class="op" id="410338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="410341">func</span>&nbsp;<span class="ident" id="410346">TestClientErrorWithRequestURI</span><span class="op" id="410375">(</span><span class="ident" id="410376">t</span>&nbsp;<span class="op" id="410378">*</span><span class="ident" id="410379">testing</span><span class="op" id="410386">.</span><span class="ident" id="410387">T</span><span class="op" id="410388">)</span>&nbsp;<span class="op" id="410390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="410393">defer</span>&nbsp;<span class="ident" id="410399">afterTest</span><span class="op" id="410408">(</span><span class="ident" id="410409">t</span><span class="op" id="410410">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="410413">req</span><span class="op" id="410416">,</span>&nbsp;<span class="ident" id="410418">_</span>&nbsp;<span class="op" id="410420">:=</span>&nbsp;<span class="ident" id="410423">NewRequest</span><span class="op" id="410433">(</span><span class="string" id="410434">&#34;GET&#34;</span><span class="op" id="410439">,</span>&nbsp;<span class="string" id="410441">&#34;http://localhost:1234/&#34;</span><span class="op" id="410465">,</span>&nbsp;<span class="ident" id="410467">nil</span><span class="op" id="410470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="410473">req</span><span class="op" id="410476">.</span><span class="ident" id="410477">RequestURI</span>&nbsp;<span class="op" id="410488">=</span>&nbsp;<span class="string" id="410490">&#34;/this/field/is/illegal/and/should/error/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="410534">_</span><span class="op" id="410535">,</span>&nbsp;<span class="ident" id="410537">err</span>&nbsp;<span class="op" id="410541">:=</span>&nbsp;<span class="ident" id="410544">DefaultClient</span><span class="op" id="410557">.</span><span class="ident" id="410558">Do</span><span class="op" id="410560">(</span><span class="ident" id="410561">req</span><span class="op" id="410564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="410567">if</span>&nbsp;<span class="ident" id="410570">err</span>&nbsp;<span class="op" id="410574">==</span>&nbsp;<span class="ident" id="410577">nil</span>&nbsp;<span class="op" id="410581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="410585">t</span><span class="op" id="410586">.</span><span class="ident" id="410587">Fatalf</span><span class="op" id="410593">(</span><span class="string" id="410594">&#34;expected&nbsp;an&nbsp;error&#34;</span><span class="op" id="410613">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="410616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="410619">if</span>&nbsp;<span class="op" id="410622">!</span><span class="ident" id="410623">strings</span><span class="op" id="410630">.</span><span class="ident" id="410631">Contains</span><span class="op" id="410639">(</span><span class="ident" id="410640">err</span><span class="op" id="410643">.</span><span class="ident" id="410644">Error</span><span class="op" id="410649">(</span><span class="op" id="410650">)</span><span class="op" id="410651">,</span>&nbsp;<span class="string" id="410653">&#34;RequestURI&#34;</span><span class="op" id="410665">)</span>&nbsp;<span class="op" id="410667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="410671">t</span><span class="op" id="410672">.</span><span class="ident" id="410673">Errorf</span><span class="op" id="410679">(</span><span class="string" id="410680">&#34;wanted&nbsp;error&nbsp;mentioning&nbsp;RequestURI;&nbsp;got&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="410731">,</span>&nbsp;<span class="ident" id="410733">err</span><span class="op" id="410736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="410739">}</span><br>
<span class="lineno"></span><span class="op" id="410741">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span><span class="keyword" id="410744">func</span>&nbsp;<span class="ident" id="410749">newTLSTransport</span><span class="op" id="410764">(</span><span class="ident" id="410765">t</span>&nbsp;<span class="op" id="410767">*</span><span class="ident" id="410768">testing</span><span class="op" id="410775">.</span><span class="ident" id="410776">T</span><span class="op" id="410777">,</span>&nbsp;<span class="ident" id="410779">ts</span>&nbsp;<span class="op" id="410782">*</span><span class="ident" id="410783">httptest</span><span class="op" id="410791">.</span><span class="ident" id="410792">Server</span><span class="op" id="410798">)</span>&nbsp;<span class="op" id="410800">*</span><span class="ident" id="410801">Transport</span>&nbsp;<span class="op" id="410811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="410814">certs</span>&nbsp;<span class="op" id="410820">:=</span>&nbsp;<span class="ident" id="410823">x509</span><span class="op" id="410827">.</span><span class="ident" id="410828">NewCertPool</span><span class="op" id="410839">(</span><span class="op" id="410840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="410843">for</span>&nbsp;<span class="ident" id="410847">_</span><span class="op" id="410848">,</span>&nbsp;<span class="ident" id="410850">c</span>&nbsp;<span class="op" id="410852">:=</span>&nbsp;<span class="keyword" id="410855">range</span>&nbsp;<span class="ident" id="410861">ts</span><span class="op" id="410863">.</span><span class="ident" id="410864">TLS</span><span class="op" id="410867">.</span><span class="ident" id="410868">Certificates</span>&nbsp;<span class="op" id="410881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="410885">roots</span><span class="op" id="410890">,</span>&nbsp;<span class="ident" id="410892">err</span>&nbsp;<span class="op" id="410896">:=</span>&nbsp;<span class="ident" id="410899">x509</span><span class="op" id="410903">.</span><span class="ident" id="410904">ParseCertificates</span><span class="op" id="410921">(</span><span class="ident" id="410922">c</span><span class="op" id="410923">.</span><span class="ident" id="410924">Certificate</span><span class="op" id="410935">[</span><span class="builtinfunc" id="410936">len</span><span class="op" id="410939">(</span><span class="ident" id="410940">c</span><span class="op" id="410941">.</span><span class="ident" id="410942">Certificate</span><span class="op" id="410953">)</span><span class="op" id="410954">-</span><span class="num" id="410955">1</span><span class="op" id="410956">]</span><span class="op" id="410957">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="410961">if</span>&nbsp;<span class="ident" id="410964">err</span>&nbsp;<span class="op" id="410968">!=</span>&nbsp;<span class="ident" id="410971">nil</span>&nbsp;<span class="op" id="410975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="410980">t</span><span class="op" id="410981">.</span><span class="ident" id="410982">Fatalf</span><span class="op" id="410988">(</span><span class="string" id="410989">&#34;error&nbsp;parsing&nbsp;server&#39;s&nbsp;root&nbsp;cert:&nbsp;%v&#34;</span><span class="op" id="411027">,</span>&nbsp;<span class="ident" id="411029">err</span><span class="op" id="411032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="411036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="411040">for</span>&nbsp;<span class="ident" id="411044">_</span><span class="op" id="411045">,</span>&nbsp;<span class="ident" id="411047">root</span>&nbsp;<span class="op" id="411052">:=</span>&nbsp;<span class="keyword" id="411055">range</span>&nbsp;<span class="ident" id="411061">roots</span>&nbsp;<span class="op" id="411067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="411072">certs</span><span class="op" id="411077">.</span><span class="ident" id="411078">AddCert</span><span class="op" id="411085">(</span><span class="ident" id="411086">root</span><span class="op" id="411090">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="411094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="411097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="411100">return</span>&nbsp;<span class="op" id="411107">&amp;</span><span class="ident" id="411108">Transport</span><span class="op" id="411117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="411121">TLSClientConfig</span><span class="op" id="411136">:</span>&nbsp;<span class="op" id="411138">&amp;</span><span class="ident" id="411139">tls</span><span class="op" id="411142">.</span><span class="ident" id="411143">Config</span><span class="op" id="411149">{</span><span class="ident" id="411150">RootCAs</span><span class="op" id="411157">:</span>&nbsp;<span class="ident" id="411159">certs</span><span class="op" id="411164">}</span><span class="op" id="411165">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="411168">}</span><br>
<span class="lineno">640</span><span class="op" id="411170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="411173">func</span>&nbsp;<span class="ident" id="411178">TestClientWithCorrectTLSServerName</span><span class="op" id="411212">(</span><span class="ident" id="411213">t</span>&nbsp;<span class="op" id="411215">*</span><span class="ident" id="411216">testing</span><span class="op" id="411223">.</span><span class="ident" id="411224">T</span><span class="op" id="411225">)</span>&nbsp;<span class="op" id="411227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="411230">defer</span>&nbsp;<span class="ident" id="411236">afterTest</span><span class="op" id="411245">(</span><span class="ident" id="411246">t</span><span class="op" id="411247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="411250">ts</span>&nbsp;<span class="op" id="411253">:=</span>&nbsp;<span class="ident" id="411256">httptest</span><span class="op" id="411264">.</span><span class="ident" id="411265">NewTLSServer</span><span class="op" id="411277">(</span><span class="ident" id="411278">HandlerFunc</span><span class="op" id="411289">(</span><span class="keyword" id="411290">func</span><span class="op" id="411294">(</span><span class="ident" id="411295">w</span>&nbsp;<span class="ident" id="411297">ResponseWriter</span><span class="op" id="411311">,</span>&nbsp;<span class="ident" id="411313">r</span>&nbsp;<span class="op" id="411315">*</span><span class="ident" id="411316">Request</span><span class="op" id="411323">)</span>&nbsp;<span class="op" id="411325">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="411329">if</span>&nbsp;<span class="ident" id="411332">r</span><span class="op" id="411333">.</span><span class="ident" id="411334">TLS</span><span class="op" id="411337">.</span><span class="ident" id="411338">ServerName</span>&nbsp;<span class="op" id="411349">!=</span>&nbsp;<span class="string" id="411352">&#34;127.0.0.1&#34;</span>&nbsp;<span class="op" id="411364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="411369">t</span><span class="op" id="411370">.</span><span class="ident" id="411371">Errorf</span><span class="op" id="411377">(</span><span class="string" id="411378">&#34;expected&nbsp;client&nbsp;to&nbsp;set&nbsp;ServerName&nbsp;127.0.0.1,&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="411432">,</span>&nbsp;<span class="ident" id="411434">r</span><span class="op" id="411435">.</span><span class="ident" id="411436">TLS</span><span class="op" id="411439">.</span><span class="ident" id="411440">ServerName</span><span class="op" id="411450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="411454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="411457">}</span><span class="op" id="411458">)</span><span class="op" id="411459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="411462">defer</span>&nbsp;<span class="ident" id="411468">ts</span><span class="op" id="411470">.</span><span class="ident" id="411471">Close</span><span class="op" id="411476">(</span><span class="op" id="411477">)</span><br>
<span class="lineno">650</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="411481">c</span>&nbsp;<span class="op" id="411483">:=</span>&nbsp;<span class="op" id="411486">&amp;</span><span class="ident" id="411487">Client</span><span class="op" id="411493">{</span><span class="ident" id="411494">Transport</span><span class="op" id="411503">:</span>&nbsp;<span class="ident" id="411505">newTLSTransport</span><span class="op" id="411520">(</span><span class="ident" id="411521">t</span><span class="op" id="411522">,</span>&nbsp;<span class="ident" id="411524">ts</span><span class="op" id="411526">)</span><span class="op" id="411527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="411530">if</span>&nbsp;<span class="ident" id="411533">_</span><span class="op" id="411534">,</span>&nbsp;<span class="ident" id="411536">err</span>&nbsp;<span class="op" id="411540">:=</span>&nbsp;<span class="ident" id="411543">c</span><span class="op" id="411544">.</span><span class="ident" id="411545">Get</span><span class="op" id="411548">(</span><span class="ident" id="411549">ts</span><span class="op" id="411551">.</span><span class="ident" id="411552">URL</span><span class="op" id="411555">)</span><span class="op" id="411556">;</span>&nbsp;<span class="ident" id="411558">err</span>&nbsp;<span class="op" id="411562">!=</span>&nbsp;<span class="ident" id="411565">nil</span>&nbsp;<span class="op" id="411569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="411573">t</span><span class="op" id="411574">.</span><span class="ident" id="411575">Fatalf</span><span class="op" id="411581">(</span><span class="string" id="411582">&#34;expected&nbsp;successful&nbsp;TLS&nbsp;connection,&nbsp;got&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="411633">,</span>&nbsp;<span class="ident" id="411635">err</span><span class="op" id="411638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="411641">}</span><br>
<span class="lineno">655</span><span class="op" id="411643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="411646">func</span>&nbsp;<span class="ident" id="411651">TestClientWithIncorrectTLSServerName</span><span class="op" id="411687">(</span><span class="ident" id="411688">t</span>&nbsp;<span class="op" id="411690">*</span><span class="ident" id="411691">testing</span><span class="op" id="411698">.</span><span class="ident" id="411699">T</span><span class="op" id="411700">)</span>&nbsp;<span class="op" id="411702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="411705">defer</span>&nbsp;<span class="ident" id="411711">afterTest</span><span class="op" id="411720">(</span><span class="ident" id="411721">t</span><span class="op" id="411722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="411725">ts</span>&nbsp;<span class="op" id="411728">:=</span>&nbsp;<span class="ident" id="411731">httptest</span><span class="op" id="411739">.</span><span class="ident" id="411740">NewTLSServer</span><span class="op" id="411752">(</span><span class="ident" id="411753">HandlerFunc</span><span class="op" id="411764">(</span><span class="keyword" id="411765">func</span><span class="op" id="411769">(</span><span class="ident" id="411770">w</span>&nbsp;<span class="ident" id="411772">ResponseWriter</span><span class="op" id="411786">,</span>&nbsp;<span class="ident" id="411788">r</span>&nbsp;<span class="op" id="411790">*</span><span class="ident" id="411791">Request</span><span class="op" id="411798">)</span>&nbsp;<span class="op" id="411800">{</span><span class="op" id="411801">}</span><span class="op" id="411802">)</span><span class="op" id="411803">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="411806">defer</span>&nbsp;<span class="ident" id="411812">ts</span><span class="op" id="411814">.</span><span class="ident" id="411815">Close</span><span class="op" id="411820">(</span><span class="op" id="411821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="411824">errc</span>&nbsp;<span class="op" id="411829">:=</span>&nbsp;<span class="builtinfunc" id="411832">make</span><span class="op" id="411836">(</span><span class="ident" id="411837">chanWriter</span><span class="op" id="411847">,</span>&nbsp;<span class="num" id="411849">10</span><span class="op" id="411851">)</span>&nbsp;<span class="comment" id="411853">//&nbsp;but&nbsp;only&nbsp;expecting&nbsp;1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="411878">ts</span><span class="op" id="411880">.</span><span class="ident" id="411881">Config</span><span class="op" id="411887">.</span><span class="ident" id="411888">ErrorLog</span>&nbsp;<span class="op" id="411897">=</span>&nbsp;<span class="ident" id="411899">log</span><span class="op" id="411902">.</span><span class="ident" id="411903">New</span><span class="op" id="411906">(</span><span class="ident" id="411907">errc</span><span class="op" id="411911">,</span>&nbsp;<span class="string" id="411913">&#34;&#34;</span><span class="op" id="411915">,</span>&nbsp;<span class="num" id="411917">0</span><span class="op" id="411918">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="411922">trans</span>&nbsp;<span class="op" id="411928">:=</span>&nbsp;<span class="ident" id="411931">newTLSTransport</span><span class="op" id="411946">(</span><span class="ident" id="411947">t</span><span class="op" id="411948">,</span>&nbsp;<span class="ident" id="411950">ts</span><span class="op" id="411952">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="411955">trans</span><span class="op" id="411960">.</span><span class="ident" id="411961">TLSClientConfig</span><span class="op" id="411976">.</span><span class="ident" id="411977">ServerName</span>&nbsp;<span class="op" id="411988">=</span>&nbsp;<span class="string" id="411990">&#34;badserver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="412003">c</span>&nbsp;<span class="op" id="412005">:=</span>&nbsp;<span class="op" id="412008">&amp;</span><span class="ident" id="412009">Client</span><span class="op" id="412015">{</span><span class="ident" id="412016">Transport</span><span class="op" id="412025">:</span>&nbsp;<span class="ident" id="412027">trans</span><span class="op" id="412032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="412035">_</span><span class="op" id="412036">,</span>&nbsp;<span class="ident" id="412038">err</span>&nbsp;<span class="op" id="412042">:=</span>&nbsp;<span class="ident" id="412045">c</span><span class="op" id="412046">.</span><span class="ident" id="412047">Get</span><span class="op" id="412050">(</span><span class="ident" id="412051">ts</span><span class="op" id="412053">.</span><span class="ident" id="412054">URL</span><span class="op" id="412057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="412060">if</span>&nbsp;<span class="ident" id="412063">err</span>&nbsp;<span class="op" id="412067">==</span>&nbsp;<span class="ident" id="412070">nil</span>&nbsp;<span class="op" id="412074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="412078">t</span><span class="op" id="412079">.</span><span class="ident" id="412080">Fatalf</span><span class="op" id="412086">(</span><span class="string" id="412087">&#34;expected&nbsp;an&nbsp;error&#34;</span><span class="op" id="412106">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="412109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="412112">if</span>&nbsp;<span class="op" id="412115">!</span><span class="ident" id="412116">strings</span><span class="op" id="412123">.</span><span class="ident" id="412124">Contains</span><span class="op" id="412132">(</span><span class="ident" id="412133">err</span><span class="op" id="412136">.</span><span class="ident" id="412137">Error</span><span class="op" id="412142">(</span><span class="op" id="412143">)</span><span class="op" id="412144">,</span>&nbsp;<span class="string" id="412146">&#34;127.0.0.1&#34;</span><span class="op" id="412157">)</span>&nbsp;<span class="op" id="412159">||</span>&nbsp;<span class="op" id="412162">!</span><span class="ident" id="412163">strings</span><span class="op" id="412170">.</span><span class="ident" id="412171">Contains</span><span class="op" id="412179">(</span><span class="ident" id="412180">err</span><span class="op" id="412183">.</span><span class="ident" id="412184">Error</span><span class="op" id="412189">(</span><span class="op" id="412190">)</span><span class="op" id="412191">,</span>&nbsp;<span class="string" id="412193">&#34;badserver&#34;</span><span class="op" id="412204">)</span>&nbsp;<span class="op" id="412206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="412210">t</span><span class="op" id="412211">.</span><span class="ident" id="412212">Errorf</span><span class="op" id="412218">(</span><span class="string" id="412219">&#34;wanted&nbsp;error&nbsp;mentioning&nbsp;127.0.0.1&nbsp;and&nbsp;badserver;&nbsp;got&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="412283">,</span>&nbsp;<span class="ident" id="412285">err</span><span class="op" id="412288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="412291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="412294">select</span>&nbsp;<span class="op" id="412301">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="412304">case</span>&nbsp;<span class="ident" id="412309">v</span>&nbsp;<span class="op" id="412311">:=</span>&nbsp;<span class="op" id="412314">&lt;-</span><span class="ident" id="412316">errc</span><span class="op" id="412320">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="412324">if</span>&nbsp;<span class="op" id="412327">!</span><span class="ident" id="412328">strings</span><span class="op" id="412335">.</span><span class="ident" id="412336">Contains</span><span class="op" id="412344">(</span><span class="ident" id="412345">v</span><span class="op" id="412346">,</span>&nbsp;<span class="string" id="412348">&#34;TLS&nbsp;handshake&nbsp;error&#34;</span><span class="op" id="412369">)</span>&nbsp;<span class="op" id="412371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="412376">t</span><span class="op" id="412377">.</span><span class="ident" id="412378">Errorf</span><span class="op" id="412384">(</span><span class="string" id="412385">&#34;expected&nbsp;an&nbsp;error&nbsp;log&nbsp;message&nbsp;containing&nbsp;&#39;TLS&nbsp;handshake&nbsp;error&#39;;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="412457">,</span>&nbsp;<span class="ident" id="412459">v</span><span class="op" id="412460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="412464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="412467">case</span>&nbsp;<span class="op" id="412472">&lt;-</span><span class="ident" id="412474">time</span><span class="op" id="412478">.</span><span class="ident" id="412479">After</span><span class="op" id="412484">(</span><span class="num" id="412485">5</span>&nbsp;<span class="op" id="412487">*</span>&nbsp;<span class="ident" id="412489">time</span><span class="op" id="412493">.</span><span class="ident" id="412494">Second</span><span class="op" id="412500">)</span><span class="op" id="412501">:</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="412505">t</span><span class="op" id="412506">.</span><span class="ident" id="412507">Errorf</span><span class="op" id="412513">(</span><span class="string" id="412514">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;logged&nbsp;error&#34;</span><span class="op" id="412548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="412551">}</span><br>
<span class="lineno"></span><span class="op" id="412553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="412556">//&nbsp;Test&nbsp;for&nbsp;golang.org/issue/5829;&nbsp;the&nbsp;Transport&nbsp;should&nbsp;respect&nbsp;TLSClientConfig.ServerName</span><br>
<span class="lineno">685</span><span class="comment" id="412647">//&nbsp;when&nbsp;not&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="412666">//</span><br>
<span class="lineno"></span><span class="comment" id="412669">//&nbsp;tls.Config.ServerName&nbsp;(non-empty,&nbsp;set&nbsp;to&nbsp;&#34;example.com&#34;)&nbsp;takes</span><br>
<span class="lineno"></span><span class="comment" id="412734">//&nbsp;precedence&nbsp;over&nbsp;&#34;some-other-host.tld&#34;&nbsp;which&nbsp;previously&nbsp;incorrectly</span><br>
<span class="lineno"></span><span class="comment" id="412804">//&nbsp;took&nbsp;precedence.&nbsp;We&nbsp;don&#39;t&nbsp;actually&nbsp;connect&nbsp;to&nbsp;(or&nbsp;even&nbsp;resolve)</span><br>
<span class="lineno">690</span><span class="comment" id="412871">//&nbsp;&#34;some-other-host.tld&#34;,&nbsp;though,&nbsp;because&nbsp;of&nbsp;the&nbsp;Transport.Dial&nbsp;hook.</span><br>
<span class="lineno"></span><span class="comment" id="412941">//</span><br>
<span class="lineno"></span><span class="comment" id="412944">//&nbsp;The&nbsp;httptest.Server&nbsp;has&nbsp;a&nbsp;cert&nbsp;with&nbsp;&#34;example.com&#34;&nbsp;as&nbsp;its&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="413010">func</span>&nbsp;<span class="ident" id="413015">TestTransportUsesTLSConfigServerName</span><span class="op" id="413051">(</span><span class="ident" id="413052">t</span>&nbsp;<span class="op" id="413054">*</span><span class="ident" id="413055">testing</span><span class="op" id="413062">.</span><span class="ident" id="413063">T</span><span class="op" id="413064">)</span>&nbsp;<span class="op" id="413066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="413069">defer</span>&nbsp;<span class="ident" id="413075">afterTest</span><span class="op" id="413084">(</span><span class="ident" id="413085">t</span><span class="op" id="413086">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="413089">ts</span>&nbsp;<span class="op" id="413092">:=</span>&nbsp;<span class="ident" id="413095">httptest</span><span class="op" id="413103">.</span><span class="ident" id="413104">NewTLSServer</span><span class="op" id="413116">(</span><span class="ident" id="413117">HandlerFunc</span><span class="op" id="413128">(</span><span class="keyword" id="413129">func</span><span class="op" id="413133">(</span><span class="ident" id="413134">w</span>&nbsp;<span class="ident" id="413136">ResponseWriter</span><span class="op" id="413150">,</span>&nbsp;<span class="ident" id="413152">r</span>&nbsp;<span class="op" id="413154">*</span><span class="ident" id="413155">Request</span><span class="op" id="413162">)</span>&nbsp;<span class="op" id="413164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="413168">w</span><span class="op" id="413169">.</span><span class="ident" id="413170">Write</span><span class="op" id="413175">(</span><span class="op" id="413176">[</span><span class="op" id="413177">]</span><span class="builtintype" id="413178">byte</span><span class="op" id="413182">(</span><span class="string" id="413183">&#34;Hello&#34;</span><span class="op" id="413190">)</span><span class="op" id="413191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="413194">}</span><span class="op" id="413195">)</span><span class="op" id="413196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="413199">defer</span>&nbsp;<span class="ident" id="413205">ts</span><span class="op" id="413207">.</span><span class="ident" id="413208">Close</span><span class="op" id="413213">(</span><span class="op" id="413214">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="413218">tr</span>&nbsp;<span class="op" id="413221">:=</span>&nbsp;<span class="ident" id="413224">newTLSTransport</span><span class="op" id="413239">(</span><span class="ident" id="413240">t</span><span class="op" id="413241">,</span>&nbsp;<span class="ident" id="413243">ts</span><span class="op" id="413245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="413248">tr</span><span class="op" id="413250">.</span><span class="ident" id="413251">TLSClientConfig</span><span class="op" id="413266">.</span><span class="ident" id="413267">ServerName</span>&nbsp;<span class="op" id="413278">=</span>&nbsp;<span class="string" id="413280">&#34;example.com&#34;</span>&nbsp;<span class="comment" id="413294">//&nbsp;one&nbsp;of&nbsp;httptest&#39;s&nbsp;Server&nbsp;cert&nbsp;names</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="413334">tr</span><span class="op" id="413336">.</span><span class="ident" id="413337">Dial</span>&nbsp;<span class="op" id="413342">=</span>&nbsp;<span class="keyword" id="413344">func</span><span class="op" id="413348">(</span><span class="ident" id="413349">netw</span><span class="op" id="413353">,</span>&nbsp;<span class="ident" id="413355">addr</span>&nbsp;<span class="builtintype" id="413360">string</span><span class="op" id="413366">)</span>&nbsp;<span class="op" id="413368">(</span><span class="ident" id="413369">net</span><span class="op" id="413372">.</span><span class="ident" id="413373">Conn</span><span class="op" id="413377">,</span>&nbsp;<span class="builtintype" id="413379">error</span><span class="op" id="413384">)</span>&nbsp;<span class="op" id="413386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="413390">return</span>&nbsp;<span class="ident" id="413397">net</span><span class="op" id="413400">.</span><span class="ident" id="413401">Dial</span><span class="op" id="413405">(</span><span class="ident" id="413406">netw</span><span class="op" id="413410">,</span>&nbsp;<span class="ident" id="413412">ts</span><span class="op" id="413414">.</span><span class="ident" id="413415">Listener</span><span class="op" id="413423">.</span><span class="ident" id="413424">Addr</span><span class="op" id="413428">(</span><span class="op" id="413429">)</span><span class="op" id="413430">.</span><span class="ident" id="413431">String</span><span class="op" id="413437">(</span><span class="op" id="413438">)</span><span class="op" id="413439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="413442">}</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="413445">defer</span>&nbsp;<span class="ident" id="413451">tr</span><span class="op" id="413453">.</span><span class="ident" id="413454">CloseIdleConnections</span><span class="op" id="413474">(</span><span class="op" id="413475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="413478">c</span>&nbsp;<span class="op" id="413480">:=</span>&nbsp;<span class="op" id="413483">&amp;</span><span class="ident" id="413484">Client</span><span class="op" id="413490">{</span><span class="ident" id="413491">Transport</span><span class="op" id="413500">:</span>&nbsp;<span class="ident" id="413502">tr</span><span class="op" id="413504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="413507">res</span><span class="op" id="413510">,</span>&nbsp;<span class="ident" id="413512">err</span>&nbsp;<span class="op" id="413516">:=</span>&nbsp;<span class="ident" id="413519">c</span><span class="op" id="413520">.</span><span class="ident" id="413521">Get</span><span class="op" id="413524">(</span><span class="string" id="413525">&#34;https://some-other-host.tld/&#34;</span><span class="op" id="413555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="413558">if</span>&nbsp;<span class="ident" id="413561">err</span>&nbsp;<span class="op" id="413565">!=</span>&nbsp;<span class="ident" id="413568">nil</span>&nbsp;<span class="op" id="413572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="413576">t</span><span class="op" id="413577">.</span><span class="ident" id="413578">Fatal</span><span class="op" id="413583">(</span><span class="ident" id="413584">err</span><span class="op" id="413587">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="413590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="413593">res</span><span class="op" id="413596">.</span><span class="ident" id="413597">Body</span><span class="op" id="413601">.</span><span class="ident" id="413602">Close</span><span class="op" id="413607">(</span><span class="op" id="413608">)</span><br>
<span class="lineno"></span><span class="op" id="413610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="413613">func</span>&nbsp;<span class="ident" id="413618">TestResponseSetsTLSConnectionState</span><span class="op" id="413652">(</span><span class="ident" id="413653">t</span>&nbsp;<span class="op" id="413655">*</span><span class="ident" id="413656">testing</span><span class="op" id="413663">.</span><span class="ident" id="413664">T</span><span class="op" id="413665">)</span>&nbsp;<span class="op" id="413667">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="413670">defer</span>&nbsp;<span class="ident" id="413676">afterTest</span><span class="op" id="413685">(</span><span class="ident" id="413686">t</span><span class="op" id="413687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="413690">ts</span>&nbsp;<span class="op" id="413693">:=</span>&nbsp;<span class="ident" id="413696">httptest</span><span class="op" id="413704">.</span><span class="ident" id="413705">NewTLSServer</span><span class="op" id="413717">(</span><span class="ident" id="413718">HandlerFunc</span><span class="op" id="413729">(</span><span class="keyword" id="413730">func</span><span class="op" id="413734">(</span><span class="ident" id="413735">w</span>&nbsp;<span class="ident" id="413737">ResponseWriter</span><span class="op" id="413751">,</span>&nbsp;<span class="ident" id="413753">r</span>&nbsp;<span class="op" id="413755">*</span><span class="ident" id="413756">Request</span><span class="op" id="413763">)</span>&nbsp;<span class="op" id="413765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="413769">w</span><span class="op" id="413770">.</span><span class="ident" id="413771">Write</span><span class="op" id="413776">(</span><span class="op" id="413777">[</span><span class="op" id="413778">]</span><span class="builtintype" id="413779">byte</span><span class="op" id="413783">(</span><span class="string" id="413784">&#34;Hello&#34;</span><span class="op" id="413791">)</span><span class="op" id="413792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="413795">}</span><span class="op" id="413796">)</span><span class="op" id="413797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="413800">defer</span>&nbsp;<span class="ident" id="413806">ts</span><span class="op" id="413808">.</span><span class="ident" id="413809">Close</span><span class="op" id="413814">(</span><span class="op" id="413815">)</span><br>
<span class="lineno">720</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="413819">tr</span>&nbsp;<span class="op" id="413822">:=</span>&nbsp;<span class="ident" id="413825">newTLSTransport</span><span class="op" id="413840">(</span><span class="ident" id="413841">t</span><span class="op" id="413842">,</span>&nbsp;<span class="ident" id="413844">ts</span><span class="op" id="413846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="413849">tr</span><span class="op" id="413851">.</span><span class="ident" id="413852">TLSClientConfig</span><span class="op" id="413867">.</span><span class="ident" id="413868">CipherSuites</span>&nbsp;<span class="op" id="413881">=</span>&nbsp;<span class="op" id="413883">[</span><span class="op" id="413884">]</span><span class="builtintype" id="413885">uint16</span><span class="op" id="413891">{</span><span class="ident" id="413892">tls</span><span class="op" id="413895">.</span><span class="ident" id="413896">TLS_RSA_WITH_3DES_EDE_CBC_SHA</span><span class="op" id="413925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="413928">tr</span><span class="op" id="413930">.</span><span class="ident" id="413931">Dial</span>&nbsp;<span class="op" id="413936">=</span>&nbsp;<span class="keyword" id="413938">func</span><span class="op" id="413942">(</span><span class="ident" id="413943">netw</span><span class="op" id="413947">,</span>&nbsp;<span class="ident" id="413949">addr</span>&nbsp;<span class="builtintype" id="413954">string</span><span class="op" id="413960">)</span>&nbsp;<span class="op" id="413962">(</span><span class="ident" id="413963">net</span><span class="op" id="413966">.</span><span class="ident" id="413967">Conn</span><span class="op" id="413971">,</span>&nbsp;<span class="builtintype" id="413973">error</span><span class="op" id="413978">)</span>&nbsp;<span class="op" id="413980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="413984">return</span>&nbsp;<span class="ident" id="413991">net</span><span class="op" id="413994">.</span><span class="ident" id="413995">Dial</span><span class="op" id="413999">(</span><span class="ident" id="414000">netw</span><span class="op" id="414004">,</span>&nbsp;<span class="ident" id="414006">ts</span><span class="op" id="414008">.</span><span class="ident" id="414009">Listener</span><span class="op" id="414017">.</span><span class="ident" id="414018">Addr</span><span class="op" id="414022">(</span><span class="op" id="414023">)</span><span class="op" id="414024">.</span><span class="ident" id="414025">String</span><span class="op" id="414031">(</span><span class="op" id="414032">)</span><span class="op" id="414033">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="414036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="414039">defer</span>&nbsp;<span class="ident" id="414045">tr</span><span class="op" id="414047">.</span><span class="ident" id="414048">CloseIdleConnections</span><span class="op" id="414068">(</span><span class="op" id="414069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="414072">c</span>&nbsp;<span class="op" id="414074">:=</span>&nbsp;<span class="op" id="414077">&amp;</span><span class="ident" id="414078">Client</span><span class="op" id="414084">{</span><span class="ident" id="414085">Transport</span><span class="op" id="414094">:</span>&nbsp;<span class="ident" id="414096">tr</span><span class="op" id="414098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="414101">res</span><span class="op" id="414104">,</span>&nbsp;<span class="ident" id="414106">err</span>&nbsp;<span class="op" id="414110">:=</span>&nbsp;<span class="ident" id="414113">c</span><span class="op" id="414114">.</span><span class="ident" id="414115">Get</span><span class="op" id="414118">(</span><span class="string" id="414119">&#34;https://example.com/&#34;</span><span class="op" id="414141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="414144">if</span>&nbsp;<span class="ident" id="414147">err</span>&nbsp;<span class="op" id="414151">!=</span>&nbsp;<span class="ident" id="414154">nil</span>&nbsp;<span class="op" id="414158">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="414162">t</span><span class="op" id="414163">.</span><span class="ident" id="414164">Fatal</span><span class="op" id="414169">(</span><span class="ident" id="414170">err</span><span class="op" id="414173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="414176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="414179">defer</span>&nbsp;<span class="ident" id="414185">res</span><span class="op" id="414188">.</span><span class="ident" id="414189">Body</span><span class="op" id="414193">.</span><span class="ident" id="414194">Close</span><span class="op" id="414199">(</span><span class="op" id="414200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="414203">if</span>&nbsp;<span class="ident" id="414206">res</span><span class="op" id="414209">.</span><span class="ident" id="414210">TLS</span>&nbsp;<span class="op" id="414214">==</span>&nbsp;<span class="ident" id="414217">nil</span>&nbsp;<span class="op" id="414221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="414225">t</span><span class="op" id="414226">.</span><span class="ident" id="414227">Fatal</span><span class="op" id="414232">(</span><span class="string" id="414233">&#34;Response&nbsp;didn&#39;t&nbsp;set&nbsp;TLS&nbsp;Connection&nbsp;State.&#34;</span><span class="op" id="414276">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="414279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="414282">if</span>&nbsp;<span class="ident" id="414285">got</span><span class="op" id="414288">,</span>&nbsp;<span class="ident" id="414290">want</span>&nbsp;<span class="op" id="414295">:=</span>&nbsp;<span class="ident" id="414298">res</span><span class="op" id="414301">.</span><span class="ident" id="414302">TLS</span><span class="op" id="414305">.</span><span class="ident" id="414306">CipherSuite</span><span class="op" id="414317">,</span>&nbsp;<span class="ident" id="414319">tls</span><span class="op" id="414322">.</span><span class="ident" id="414323">TLS_RSA_WITH_3DES_EDE_CBC_SHA</span><span class="op" id="414352">;</span>&nbsp;<span class="ident" id="414354">got</span>&nbsp;<span class="op" id="414358">!=</span>&nbsp;<span class="ident" id="414361">want</span>&nbsp;<span class="op" id="414366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="414370">t</span><span class="op" id="414371">.</span><span class="ident" id="414372">Errorf</span><span class="op" id="414378">(</span><span class="string" id="414379">&#34;TLS&nbsp;Cipher&nbsp;Suite&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="414411">,</span>&nbsp;<span class="ident" id="414413">got</span><span class="op" id="414416">,</span>&nbsp;<span class="ident" id="414418">want</span><span class="op" id="414422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="414425">}</span><br>
<span class="lineno"></span><span class="op" id="414427">}</span><br>
<span class="lineno">740</span><br>
<span class="lineno"></span><span class="comment" id="414430">//&nbsp;Verify&nbsp;Response.ContentLength&nbsp;is&nbsp;populated.&nbsp;http://golang.org/issue/4126</span><br>
<span class="lineno"></span><span class="keyword" id="414506">func</span>&nbsp;<span class="ident" id="414511">TestClientHeadContentLength</span><span class="op" id="414538">(</span><span class="ident" id="414539">t</span>&nbsp;<span class="op" id="414541">*</span><span class="ident" id="414542">testing</span><span class="op" id="414549">.</span><span class="ident" id="414550">T</span><span class="op" id="414551">)</span>&nbsp;<span class="op" id="414553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="414556">defer</span>&nbsp;<span class="ident" id="414562">afterTest</span><span class="op" id="414571">(</span><span class="ident" id="414572">t</span><span class="op" id="414573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="414576">ts</span>&nbsp;<span class="op" id="414579">:=</span>&nbsp;<span class="ident" id="414582">httptest</span><span class="op" id="414590">.</span><span class="ident" id="414591">NewServer</span><span class="op" id="414600">(</span><span class="ident" id="414601">HandlerFunc</span><span class="op" id="414612">(</span><span class="keyword" id="414613">func</span><span class="op" id="414617">(</span><span class="ident" id="414618">w</span>&nbsp;<span class="ident" id="414620">ResponseWriter</span><span class="op" id="414634">,</span>&nbsp;<span class="ident" id="414636">r</span>&nbsp;<span class="op" id="414638">*</span><span class="ident" id="414639">Request</span><span class="op" id="414646">)</span>&nbsp;<span class="op" id="414648">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="414652">if</span>&nbsp;<span class="ident" id="414655">v</span>&nbsp;<span class="op" id="414657">:=</span>&nbsp;<span class="ident" id="414660">r</span><span class="op" id="414661">.</span><span class="ident" id="414662">FormValue</span><span class="op" id="414671">(</span><span class="string" id="414672">&#34;cl&#34;</span><span class="op" id="414676">)</span><span class="op" id="414677">;</span>&nbsp;<span class="ident" id="414679">v</span>&nbsp;<span class="op" id="414681">!=</span>&nbsp;<span class="string" id="414684">&#34;&#34;</span>&nbsp;<span class="op" id="414687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="414692">w</span><span class="op" id="414693">.</span><span class="ident" id="414694">Header</span><span class="op" id="414700">(</span><span class="op" id="414701">)</span><span class="op" id="414702">.</span><span class="ident" id="414703">Set</span><span class="op" id="414706">(</span><span class="string" id="414707">&#34;Content-Length&#34;</span><span class="op" id="414723">,</span>&nbsp;<span class="ident" id="414725">v</span><span class="op" id="414726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="414730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="414733">}</span><span class="op" id="414734">)</span><span class="op" id="414735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="414738">defer</span>&nbsp;<span class="ident" id="414744">ts</span><span class="op" id="414746">.</span><span class="ident" id="414747">Close</span><span class="op" id="414752">(</span><span class="op" id="414753">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="414756">tests</span>&nbsp;<span class="op" id="414762">:=</span>&nbsp;<span class="op" id="414765">[</span><span class="op" id="414766">]</span><span class="keyword" id="414767">struct</span>&nbsp;<span class="op" id="414774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="414778">suffix</span>&nbsp;<span class="builtintype" id="414785">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="414794">want</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="414801">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="414808">}</span><span class="op" id="414809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="414813">{</span><span class="string" id="414814">&#34;/?cl=1234&#34;</span><span class="op" id="414825">,</span>&nbsp;<span class="num" id="414827">1234</span><span class="op" id="414831">}</span><span class="op" id="414832">,</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="414836">{</span><span class="string" id="414837">&#34;/?cl=0&#34;</span><span class="op" id="414845">,</span>&nbsp;<span class="num" id="414847">0</span><span class="op" id="414848">}</span><span class="op" id="414849">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="414853">{</span><span class="string" id="414854">&#34;&#34;</span><span class="op" id="414856">,</span>&nbsp;<span class="op" id="414858">-</span><span class="num" id="414859">1</span><span class="op" id="414860">}</span><span class="op" id="414861">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="414864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="414867">for</span>&nbsp;<span class="ident" id="414871">_</span><span class="op" id="414872">,</span>&nbsp;<span class="ident" id="414874">tt</span>&nbsp;<span class="op" id="414877">:=</span>&nbsp;<span class="keyword" id="414880">range</span>&nbsp;<span class="ident" id="414886">tests</span>&nbsp;<span class="op" id="414892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="414896">req</span><span class="op" id="414899">,</span>&nbsp;<span class="ident" id="414901">_</span>&nbsp;<span class="op" id="414903">:=</span>&nbsp;<span class="ident" id="414906">NewRequest</span><span class="op" id="414916">(</span><span class="string" id="414917">&#34;HEAD&#34;</span><span class="op" id="414923">,</span>&nbsp;<span class="ident" id="414925">ts</span><span class="op" id="414927">.</span><span class="ident" id="414928">URL</span><span class="op" id="414931">+</span><span class="ident" id="414932">tt</span><span class="op" id="414934">.</span><span class="ident" id="414935">suffix</span><span class="op" id="414941">,</span>&nbsp;<span class="ident" id="414943">nil</span><span class="op" id="414946">)</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="414950">res</span><span class="op" id="414953">,</span>&nbsp;<span class="ident" id="414955">err</span>&nbsp;<span class="op" id="414959">:=</span>&nbsp;<span class="ident" id="414962">DefaultClient</span><span class="op" id="414975">.</span><span class="ident" id="414976">Do</span><span class="op" id="414978">(</span><span class="ident" id="414979">req</span><span class="op" id="414982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="414986">if</span>&nbsp;<span class="ident" id="414989">err</span>&nbsp;<span class="op" id="414993">!=</span>&nbsp;<span class="ident" id="414996">nil</span>&nbsp;<span class="op" id="415000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415005">t</span><span class="op" id="415006">.</span><span class="ident" id="415007">Fatal</span><span class="op" id="415012">(</span><span class="ident" id="415013">err</span><span class="op" id="415016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="415020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="415024">if</span>&nbsp;<span class="ident" id="415027">res</span><span class="op" id="415030">.</span><span class="ident" id="415031">ContentLength</span>&nbsp;<span class="op" id="415045">!=</span>&nbsp;<span class="ident" id="415048">tt</span><span class="op" id="415050">.</span><span class="ident" id="415051">want</span>&nbsp;<span class="op" id="415056">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415061">t</span><span class="op" id="415062">.</span><span class="ident" id="415063">Errorf</span><span class="op" id="415069">(</span><span class="string" id="415070">&#34;Content-Length&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="415100">,</span>&nbsp;<span class="ident" id="415102">res</span><span class="op" id="415105">.</span><span class="ident" id="415106">ContentLength</span><span class="op" id="415119">,</span>&nbsp;<span class="ident" id="415121">tt</span><span class="op" id="415123">.</span><span class="ident" id="415124">want</span><span class="op" id="415128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="415132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415136">bs</span><span class="op" id="415138">,</span>&nbsp;<span class="ident" id="415140">err</span>&nbsp;<span class="op" id="415144">:=</span>&nbsp;<span class="ident" id="415147">ioutil</span><span class="op" id="415153">.</span><span class="ident" id="415154">ReadAll</span><span class="op" id="415161">(</span><span class="ident" id="415162">res</span><span class="op" id="415165">.</span><span class="ident" id="415166">Body</span><span class="op" id="415170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="415174">if</span>&nbsp;<span class="ident" id="415177">err</span>&nbsp;<span class="op" id="415181">!=</span>&nbsp;<span class="ident" id="415184">nil</span>&nbsp;<span class="op" id="415188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415193">t</span><span class="op" id="415194">.</span><span class="ident" id="415195">Fatal</span><span class="op" id="415200">(</span><span class="ident" id="415201">err</span><span class="op" id="415204">)</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="415208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="415212">if</span>&nbsp;<span class="builtinfunc" id="415215">len</span><span class="op" id="415218">(</span><span class="ident" id="415219">bs</span><span class="op" id="415221">)</span>&nbsp;<span class="op" id="415223">!=</span>&nbsp;<span class="num" id="415226">0</span>&nbsp;<span class="op" id="415228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415233">t</span><span class="op" id="415234">.</span><span class="ident" id="415235">Errorf</span><span class="op" id="415241">(</span><span class="string" id="415242">&#34;Unexpected&nbsp;content:&nbsp;%q&#34;</span><span class="op" id="415266">,</span>&nbsp;<span class="ident" id="415268">bs</span><span class="op" id="415270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="415274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="415277">}</span><br>
<span class="lineno">775</span><span class="op" id="415279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="415282">func</span>&nbsp;<span class="ident" id="415287">TestEmptyPasswordAuth</span><span class="op" id="415308">(</span><span class="ident" id="415309">t</span>&nbsp;<span class="op" id="415311">*</span><span class="ident" id="415312">testing</span><span class="op" id="415319">.</span><span class="ident" id="415320">T</span><span class="op" id="415321">)</span>&nbsp;<span class="op" id="415323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="415326">defer</span>&nbsp;<span class="ident" id="415332">afterTest</span><span class="op" id="415341">(</span><span class="ident" id="415342">t</span><span class="op" id="415343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415346">gopher</span>&nbsp;<span class="op" id="415353">:=</span>&nbsp;<span class="string" id="415356">&#34;gopher&#34;</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415366">ts</span>&nbsp;<span class="op" id="415369">:=</span>&nbsp;<span class="ident" id="415372">httptest</span><span class="op" id="415380">.</span><span class="ident" id="415381">NewServer</span><span class="op" id="415390">(</span><span class="ident" id="415391">HandlerFunc</span><span class="op" id="415402">(</span><span class="keyword" id="415403">func</span><span class="op" id="415407">(</span><span class="ident" id="415408">w</span>&nbsp;<span class="ident" id="415410">ResponseWriter</span><span class="op" id="415424">,</span>&nbsp;<span class="ident" id="415426">r</span>&nbsp;<span class="op" id="415428">*</span><span class="ident" id="415429">Request</span><span class="op" id="415436">)</span>&nbsp;<span class="op" id="415438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415442">auth</span>&nbsp;<span class="op" id="415447">:=</span>&nbsp;<span class="ident" id="415450">r</span><span class="op" id="415451">.</span><span class="ident" id="415452">Header</span><span class="op" id="415458">.</span><span class="ident" id="415459">Get</span><span class="op" id="415462">(</span><span class="string" id="415463">&#34;Authorization&#34;</span><span class="op" id="415478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="415482">if</span>&nbsp;<span class="ident" id="415485">strings</span><span class="op" id="415492">.</span><span class="ident" id="415493">HasPrefix</span><span class="op" id="415502">(</span><span class="ident" id="415503">auth</span><span class="op" id="415507">,</span>&nbsp;<span class="string" id="415509">&#34;Basic&nbsp;&#34;</span><span class="op" id="415517">)</span>&nbsp;<span class="op" id="415519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415524">encoded</span>&nbsp;<span class="op" id="415532">:=</span>&nbsp;<span class="ident" id="415535">auth</span><span class="op" id="415539">[</span><span class="num" id="415540">6</span><span class="op" id="415541">:</span><span class="op" id="415542">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415547">decoded</span><span class="op" id="415554">,</span>&nbsp;<span class="ident" id="415556">err</span>&nbsp;<span class="op" id="415560">:=</span>&nbsp;<span class="ident" id="415563">base64</span><span class="op" id="415569">.</span><span class="ident" id="415570">StdEncoding</span><span class="op" id="415581">.</span><span class="ident" id="415582">DecodeString</span><span class="op" id="415594">(</span><span class="ident" id="415595">encoded</span><span class="op" id="415602">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="415607">if</span>&nbsp;<span class="ident" id="415610">err</span>&nbsp;<span class="op" id="415614">!=</span>&nbsp;<span class="ident" id="415617">nil</span>&nbsp;<span class="op" id="415621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415627">t</span><span class="op" id="415628">.</span><span class="ident" id="415629">Fatal</span><span class="op" id="415634">(</span><span class="ident" id="415635">err</span><span class="op" id="415638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="415643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415648">expected</span>&nbsp;<span class="op" id="415657">:=</span>&nbsp;<span class="ident" id="415660">gopher</span>&nbsp;<span class="op" id="415667">+</span>&nbsp;<span class="string" id="415669">&#34;:&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415676">s</span>&nbsp;<span class="op" id="415678">:=</span>&nbsp;<span class="builtintype" id="415681">string</span><span class="op" id="415687">(</span><span class="ident" id="415688">decoded</span><span class="op" id="415695">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="415700">if</span>&nbsp;<span class="ident" id="415703">expected</span>&nbsp;<span class="op" id="415712">!=</span>&nbsp;<span class="ident" id="415715">s</span>&nbsp;<span class="op" id="415717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415723">t</span><span class="op" id="415724">.</span><span class="ident" id="415725">Errorf</span><span class="op" id="415731">(</span><span class="string" id="415732">&#34;Invalid&nbsp;Authorization&nbsp;header.&nbsp;Got&nbsp;%q,&nbsp;wanted&nbsp;%q&#34;</span><span class="op" id="415781">,</span>&nbsp;<span class="ident" id="415783">s</span><span class="op" id="415784">,</span>&nbsp;<span class="ident" id="415786">expected</span><span class="op" id="415794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="415799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="415803">}</span>&nbsp;<span class="keyword" id="415805">else</span>&nbsp;<span class="op" id="415810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415815">t</span><span class="op" id="415816">.</span><span class="ident" id="415817">Errorf</span><span class="op" id="415823">(</span><span class="string" id="415824">&#34;Invalid&nbsp;auth&nbsp;%q&#34;</span><span class="op" id="415841">,</span>&nbsp;<span class="ident" id="415843">auth</span><span class="op" id="415847">)</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="415851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="415854">}</span><span class="op" id="415855">)</span><span class="op" id="415856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="415859">defer</span>&nbsp;<span class="ident" id="415865">ts</span><span class="op" id="415867">.</span><span class="ident" id="415868">Close</span><span class="op" id="415873">(</span><span class="op" id="415874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415877">c</span>&nbsp;<span class="op" id="415879">:=</span>&nbsp;<span class="op" id="415882">&amp;</span><span class="ident" id="415883">Client</span><span class="op" id="415889">{</span><span class="op" id="415890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415893">req</span><span class="op" id="415896">,</span>&nbsp;<span class="ident" id="415898">err</span>&nbsp;<span class="op" id="415902">:=</span>&nbsp;<span class="ident" id="415905">NewRequest</span><span class="op" id="415915">(</span><span class="string" id="415916">&#34;GET&#34;</span><span class="op" id="415921">,</span>&nbsp;<span class="ident" id="415923">ts</span><span class="op" id="415925">.</span><span class="ident" id="415926">URL</span><span class="op" id="415929">,</span>&nbsp;<span class="ident" id="415931">nil</span><span class="op" id="415934">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="415937">if</span>&nbsp;<span class="ident" id="415940">err</span>&nbsp;<span class="op" id="415944">!=</span>&nbsp;<span class="ident" id="415947">nil</span>&nbsp;<span class="op" id="415951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415955">t</span><span class="op" id="415956">.</span><span class="ident" id="415957">Fatal</span><span class="op" id="415962">(</span><span class="ident" id="415963">err</span><span class="op" id="415966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="415969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="415972">req</span><span class="op" id="415975">.</span><span class="ident" id="415976">URL</span><span class="op" id="415979">.</span><span class="ident" id="415980">User</span>&nbsp;<span class="op" id="415985">=</span>&nbsp;<span class="ident" id="415987">url</span><span class="op" id="415990">.</span><span class="ident" id="415991">User</span><span class="op" id="415995">(</span><span class="ident" id="415996">gopher</span><span class="op" id="416002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416005">resp</span><span class="op" id="416009">,</span>&nbsp;<span class="ident" id="416011">err</span>&nbsp;<span class="op" id="416015">:=</span>&nbsp;<span class="ident" id="416018">c</span><span class="op" id="416019">.</span><span class="ident" id="416020">Do</span><span class="op" id="416022">(</span><span class="ident" id="416023">req</span><span class="op" id="416026">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="416029">if</span>&nbsp;<span class="ident" id="416032">err</span>&nbsp;<span class="op" id="416036">!=</span>&nbsp;<span class="ident" id="416039">nil</span>&nbsp;<span class="op" id="416043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416047">t</span><span class="op" id="416048">.</span><span class="ident" id="416049">Fatal</span><span class="op" id="416054">(</span><span class="ident" id="416055">err</span><span class="op" id="416058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="416061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="416064">defer</span>&nbsp;<span class="ident" id="416070">resp</span><span class="op" id="416074">.</span><span class="ident" id="416075">Body</span><span class="op" id="416079">.</span><span class="ident" id="416080">Close</span><span class="op" id="416085">(</span><span class="op" id="416086">)</span><br>
<span class="lineno"></span><span class="op" id="416088">}</span><br>
<span class="lineno">810</span><br>
<span class="lineno"></span><span class="keyword" id="416091">func</span>&nbsp;<span class="ident" id="416096">TestBasicAuth</span><span class="op" id="416109">(</span><span class="ident" id="416110">t</span>&nbsp;<span class="op" id="416112">*</span><span class="ident" id="416113">testing</span><span class="op" id="416120">.</span><span class="ident" id="416121">T</span><span class="op" id="416122">)</span>&nbsp;<span class="op" id="416124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="416127">defer</span>&nbsp;<span class="ident" id="416133">afterTest</span><span class="op" id="416142">(</span><span class="ident" id="416143">t</span><span class="op" id="416144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416147">tr</span>&nbsp;<span class="op" id="416150">:=</span>&nbsp;<span class="op" id="416153">&amp;</span><span class="ident" id="416154">recordingTransport</span><span class="op" id="416172">{</span><span class="op" id="416173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416176">client</span>&nbsp;<span class="op" id="416183">:=</span>&nbsp;<span class="op" id="416186">&amp;</span><span class="ident" id="416187">Client</span><span class="op" id="416193">{</span><span class="ident" id="416194">Transport</span><span class="op" id="416203">:</span>&nbsp;<span class="ident" id="416205">tr</span><span class="op" id="416207">}</span><br>
<span class="lineno">815</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416211">url</span>&nbsp;<span class="op" id="416215">:=</span>&nbsp;<span class="string" id="416218">&#34;http://My%20User:My%20Pass@dummy.faketld/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416263">expected</span>&nbsp;<span class="op" id="416272">:=</span>&nbsp;<span class="string" id="416275">&#34;My&nbsp;User:My&nbsp;Pass&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416294">client</span><span class="op" id="416300">.</span><span class="ident" id="416301">Get</span><span class="op" id="416304">(</span><span class="ident" id="416305">url</span><span class="op" id="416308">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="416312">if</span>&nbsp;<span class="ident" id="416315">tr</span><span class="op" id="416317">.</span><span class="ident" id="416318">req</span><span class="op" id="416321">.</span><span class="ident" id="416322">Method</span>&nbsp;<span class="op" id="416329">!=</span>&nbsp;<span class="string" id="416332">&#34;GET&#34;</span>&nbsp;<span class="op" id="416338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416342">t</span><span class="op" id="416343">.</span><span class="ident" id="416344">Errorf</span><span class="op" id="416350">(</span><span class="string" id="416351">&#34;got&nbsp;method&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="416375">,</span>&nbsp;<span class="ident" id="416377">tr</span><span class="op" id="416379">.</span><span class="ident" id="416380">req</span><span class="op" id="416383">.</span><span class="ident" id="416384">Method</span><span class="op" id="416390">,</span>&nbsp;<span class="string" id="416392">&#34;GET&#34;</span><span class="op" id="416397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="416400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="416403">if</span>&nbsp;<span class="ident" id="416406">tr</span><span class="op" id="416408">.</span><span class="ident" id="416409">req</span><span class="op" id="416412">.</span><span class="ident" id="416413">URL</span><span class="op" id="416416">.</span><span class="ident" id="416417">String</span><span class="op" id="416423">(</span><span class="op" id="416424">)</span>&nbsp;<span class="op" id="416426">!=</span>&nbsp;<span class="ident" id="416429">url</span>&nbsp;<span class="op" id="416433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416437">t</span><span class="op" id="416438">.</span><span class="ident" id="416439">Errorf</span><span class="op" id="416445">(</span><span class="string" id="416446">&#34;got&nbsp;URL&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="416467">,</span>&nbsp;<span class="ident" id="416469">tr</span><span class="op" id="416471">.</span><span class="ident" id="416472">req</span><span class="op" id="416475">.</span><span class="ident" id="416476">URL</span><span class="op" id="416479">.</span><span class="ident" id="416480">String</span><span class="op" id="416486">(</span><span class="op" id="416487">)</span><span class="op" id="416488">,</span>&nbsp;<span class="ident" id="416490">url</span><span class="op" id="416493">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="416496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="416499">if</span>&nbsp;<span class="ident" id="416502">tr</span><span class="op" id="416504">.</span><span class="ident" id="416505">req</span><span class="op" id="416508">.</span><span class="ident" id="416509">Header</span>&nbsp;<span class="op" id="416516">==</span>&nbsp;<span class="ident" id="416519">nil</span>&nbsp;<span class="op" id="416523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416527">t</span><span class="op" id="416528">.</span><span class="ident" id="416529">Fatalf</span><span class="op" id="416535">(</span><span class="string" id="416536">&#34;expected&nbsp;non-nil&nbsp;request&nbsp;Header&#34;</span><span class="op" id="416569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="416572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416575">auth</span>&nbsp;<span class="op" id="416580">:=</span>&nbsp;<span class="ident" id="416583">tr</span><span class="op" id="416585">.</span><span class="ident" id="416586">req</span><span class="op" id="416589">.</span><span class="ident" id="416590">Header</span><span class="op" id="416596">.</span><span class="ident" id="416597">Get</span><span class="op" id="416600">(</span><span class="string" id="416601">&#34;Authorization&#34;</span><span class="op" id="416616">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="416619">if</span>&nbsp;<span class="ident" id="416622">strings</span><span class="op" id="416629">.</span><span class="ident" id="416630">HasPrefix</span><span class="op" id="416639">(</span><span class="ident" id="416640">auth</span><span class="op" id="416644">,</span>&nbsp;<span class="string" id="416646">&#34;Basic&nbsp;&#34;</span><span class="op" id="416654">)</span>&nbsp;<span class="op" id="416656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416660">encoded</span>&nbsp;<span class="op" id="416668">:=</span>&nbsp;<span class="ident" id="416671">auth</span><span class="op" id="416675">[</span><span class="num" id="416676">6</span><span class="op" id="416677">:</span><span class="op" id="416678">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416682">decoded</span><span class="op" id="416689">,</span>&nbsp;<span class="ident" id="416691">err</span>&nbsp;<span class="op" id="416695">:=</span>&nbsp;<span class="ident" id="416698">base64</span><span class="op" id="416704">.</span><span class="ident" id="416705">StdEncoding</span><span class="op" id="416716">.</span><span class="ident" id="416717">DecodeString</span><span class="op" id="416729">(</span><span class="ident" id="416730">encoded</span><span class="op" id="416737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="416741">if</span>&nbsp;<span class="ident" id="416744">err</span>&nbsp;<span class="op" id="416748">!=</span>&nbsp;<span class="ident" id="416751">nil</span>&nbsp;<span class="op" id="416755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416760">t</span><span class="op" id="416761">.</span><span class="ident" id="416762">Fatal</span><span class="op" id="416767">(</span><span class="ident" id="416768">err</span><span class="op" id="416771">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="416775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416779">s</span>&nbsp;<span class="op" id="416781">:=</span>&nbsp;<span class="builtintype" id="416784">string</span><span class="op" id="416790">(</span><span class="ident" id="416791">decoded</span><span class="op" id="416798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="416802">if</span>&nbsp;<span class="ident" id="416805">expected</span>&nbsp;<span class="op" id="416814">!=</span>&nbsp;<span class="ident" id="416817">s</span>&nbsp;<span class="op" id="416819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416824">t</span><span class="op" id="416825">.</span><span class="ident" id="416826">Errorf</span><span class="op" id="416832">(</span><span class="string" id="416833">&#34;Invalid&nbsp;Authorization&nbsp;header.&nbsp;Got&nbsp;%q,&nbsp;wanted&nbsp;%q&#34;</span><span class="op" id="416882">,</span>&nbsp;<span class="ident" id="416884">s</span><span class="op" id="416885">,</span>&nbsp;<span class="ident" id="416887">expected</span><span class="op" id="416895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="416899">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="416902">}</span>&nbsp;<span class="keyword" id="416904">else</span>&nbsp;<span class="op" id="416909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="416913">t</span><span class="op" id="416914">.</span><span class="ident" id="416915">Errorf</span><span class="op" id="416921">(</span><span class="string" id="416922">&#34;Invalid&nbsp;auth&nbsp;%q&#34;</span><span class="op" id="416939">,</span>&nbsp;<span class="ident" id="416941">auth</span><span class="op" id="416945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="416948">}</span><br>
<span class="lineno"></span><span class="op" id="416950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">845</span><span class="keyword" id="416953">func</span>&nbsp;<span class="ident" id="416958">TestClientTimeout</span><span class="op" id="416975">(</span><span class="ident" id="416976">t</span>&nbsp;<span class="op" id="416978">*</span><span class="ident" id="416979">testing</span><span class="op" id="416986">.</span><span class="ident" id="416987">T</span><span class="op" id="416988">)</span>&nbsp;<span class="op" id="416990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="416993">if</span>&nbsp;<span class="ident" id="416996">testing</span><span class="op" id="417003">.</span><span class="ident" id="417004">Short</span><span class="op" id="417009">(</span><span class="op" id="417010">)</span>&nbsp;<span class="op" id="417012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417016">t</span><span class="op" id="417017">.</span><span class="ident" id="417018">Skip</span><span class="op" id="417022">(</span><span class="string" id="417023">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="417047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="417050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417053">defer</span>&nbsp;<span class="ident" id="417059">afterTest</span><span class="op" id="417068">(</span><span class="ident" id="417069">t</span><span class="op" id="417070">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417073">sawRoot</span>&nbsp;<span class="op" id="417081">:=</span>&nbsp;<span class="builtinfunc" id="417084">make</span><span class="op" id="417088">(</span><span class="keyword" id="417089">chan</span>&nbsp;<span class="builtintype" id="417094">bool</span><span class="op" id="417098">,</span>&nbsp;<span class="num" id="417100">1</span><span class="op" id="417101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417104">sawSlow</span>&nbsp;<span class="op" id="417112">:=</span>&nbsp;<span class="builtinfunc" id="417115">make</span><span class="op" id="417119">(</span><span class="keyword" id="417120">chan</span>&nbsp;<span class="builtintype" id="417125">bool</span><span class="op" id="417129">,</span>&nbsp;<span class="num" id="417131">1</span><span class="op" id="417132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417135">ts</span>&nbsp;<span class="op" id="417138">:=</span>&nbsp;<span class="ident" id="417141">httptest</span><span class="op" id="417149">.</span><span class="ident" id="417150">NewServer</span><span class="op" id="417159">(</span><span class="ident" id="417160">HandlerFunc</span><span class="op" id="417171">(</span><span class="keyword" id="417172">func</span><span class="op" id="417176">(</span><span class="ident" id="417177">w</span>&nbsp;<span class="ident" id="417179">ResponseWriter</span><span class="op" id="417193">,</span>&nbsp;<span class="ident" id="417195">r</span>&nbsp;<span class="op" id="417197">*</span><span class="ident" id="417198">Request</span><span class="op" id="417205">)</span>&nbsp;<span class="op" id="417207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417211">if</span>&nbsp;<span class="ident" id="417214">r</span><span class="op" id="417215">.</span><span class="ident" id="417216">URL</span><span class="op" id="417219">.</span><span class="ident" id="417220">Path</span>&nbsp;<span class="op" id="417225">==</span>&nbsp;<span class="string" id="417228">&#34;/&#34;</span>&nbsp;<span class="op" id="417232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417237">sawRoot</span>&nbsp;<span class="op" id="417245">&lt;-</span>&nbsp;<span class="builtintype" id="417248">true</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417256">Redirect</span><span class="op" id="417264">(</span><span class="ident" id="417265">w</span><span class="op" id="417266">,</span>&nbsp;<span class="ident" id="417268">r</span><span class="op" id="417269">,</span>&nbsp;<span class="string" id="417271">&#34;/slow&#34;</span><span class="op" id="417278">,</span>&nbsp;<span class="ident" id="417280">StatusFound</span><span class="op" id="417291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417296">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="417305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417309">if</span>&nbsp;<span class="ident" id="417312">r</span><span class="op" id="417313">.</span><span class="ident" id="417314">URL</span><span class="op" id="417317">.</span><span class="ident" id="417318">Path</span>&nbsp;<span class="op" id="417323">==</span>&nbsp;<span class="string" id="417326">&#34;/slow&#34;</span>&nbsp;<span class="op" id="417334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417339">w</span><span class="op" id="417340">.</span><span class="ident" id="417341">Write</span><span class="op" id="417346">(</span><span class="op" id="417347">[</span><span class="op" id="417348">]</span><span class="builtintype" id="417349">byte</span><span class="op" id="417353">(</span><span class="string" id="417354">&#34;Hello&#34;</span><span class="op" id="417361">)</span><span class="op" id="417362">)</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417367">w</span><span class="op" id="417368">.</span><span class="op" id="417369">(</span><span class="ident" id="417370">Flusher</span><span class="op" id="417377">)</span><span class="op" id="417378">.</span><span class="ident" id="417379">Flush</span><span class="op" id="417384">(</span><span class="op" id="417385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417390">sawSlow</span>&nbsp;<span class="op" id="417398">&lt;-</span>&nbsp;<span class="builtintype" id="417401">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417409">time</span><span class="op" id="417413">.</span><span class="ident" id="417414">Sleep</span><span class="op" id="417419">(</span><span class="num" id="417420">2</span>&nbsp;<span class="op" id="417422">*</span>&nbsp;<span class="ident" id="417424">time</span><span class="op" id="417428">.</span><span class="ident" id="417429">Second</span><span class="op" id="417435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417440">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="417449">}</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="417452">}</span><span class="op" id="417453">)</span><span class="op" id="417454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417457">defer</span>&nbsp;<span class="ident" id="417463">ts</span><span class="op" id="417465">.</span><span class="ident" id="417466">Close</span><span class="op" id="417471">(</span><span class="op" id="417472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417475">const</span>&nbsp;<span class="ident" id="417481">timeout</span>&nbsp;<span class="op" id="417489">=</span>&nbsp;<span class="num" id="417491">500</span>&nbsp;<span class="op" id="417495">*</span>&nbsp;<span class="ident" id="417497">time</span><span class="op" id="417501">.</span><span class="ident" id="417502">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417515">c</span>&nbsp;<span class="op" id="417517">:=</span>&nbsp;<span class="op" id="417520">&amp;</span><span class="ident" id="417521">Client</span><span class="op" id="417527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417531">Timeout</span><span class="op" id="417538">:</span>&nbsp;<span class="ident" id="417540">timeout</span><span class="op" id="417547">,</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="417550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417554">res</span><span class="op" id="417557">,</span>&nbsp;<span class="ident" id="417559">err</span>&nbsp;<span class="op" id="417563">:=</span>&nbsp;<span class="ident" id="417566">c</span><span class="op" id="417567">.</span><span class="ident" id="417568">Get</span><span class="op" id="417571">(</span><span class="ident" id="417572">ts</span><span class="op" id="417574">.</span><span class="ident" id="417575">URL</span><span class="op" id="417578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417581">if</span>&nbsp;<span class="ident" id="417584">err</span>&nbsp;<span class="op" id="417588">!=</span>&nbsp;<span class="ident" id="417591">nil</span>&nbsp;<span class="op" id="417595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417599">t</span><span class="op" id="417600">.</span><span class="ident" id="417601">Fatal</span><span class="op" id="417606">(</span><span class="ident" id="417607">err</span><span class="op" id="417610">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="417613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417617">select</span>&nbsp;<span class="op" id="417624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417627">case</span>&nbsp;<span class="op" id="417632">&lt;-</span><span class="ident" id="417634">sawRoot</span><span class="op" id="417641">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="417645">//&nbsp;good.</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417655">default</span><span class="op" id="417662">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417666">t</span><span class="op" id="417667">.</span><span class="ident" id="417668">Fatal</span><span class="op" id="417673">(</span><span class="string" id="417674">&#34;handler&nbsp;never&nbsp;got&nbsp;/&nbsp;request&#34;</span><span class="op" id="417703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="417706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417710">select</span>&nbsp;<span class="op" id="417717">{</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417720">case</span>&nbsp;<span class="op" id="417725">&lt;-</span><span class="ident" id="417727">sawSlow</span><span class="op" id="417734">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="417738">//&nbsp;good.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417748">default</span><span class="op" id="417755">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417759">t</span><span class="op" id="417760">.</span><span class="ident" id="417761">Fatal</span><span class="op" id="417766">(</span><span class="string" id="417767">&#34;handler&nbsp;never&nbsp;got&nbsp;/slow&nbsp;request&#34;</span><span class="op" id="417800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="417803">}</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417807">errc</span>&nbsp;<span class="op" id="417812">:=</span>&nbsp;<span class="builtinfunc" id="417815">make</span><span class="op" id="417819">(</span><span class="keyword" id="417820">chan</span>&nbsp;<span class="builtintype" id="417825">error</span><span class="op" id="417830">,</span>&nbsp;<span class="num" id="417832">1</span><span class="op" id="417833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417836">go</span>&nbsp;<span class="keyword" id="417839">func</span><span class="op" id="417843">(</span><span class="op" id="417844">)</span>&nbsp;<span class="op" id="417846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417850">_</span><span class="op" id="417851">,</span>&nbsp;<span class="ident" id="417853">err</span>&nbsp;<span class="op" id="417857">:=</span>&nbsp;<span class="ident" id="417860">ioutil</span><span class="op" id="417866">.</span><span class="ident" id="417867">ReadAll</span><span class="op" id="417874">(</span><span class="ident" id="417875">res</span><span class="op" id="417878">.</span><span class="ident" id="417879">Body</span><span class="op" id="417883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417887">errc</span>&nbsp;<span class="op" id="417892">&lt;-</span>&nbsp;<span class="ident" id="417895">err</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="417901">res</span><span class="op" id="417904">.</span><span class="ident" id="417905">Body</span><span class="op" id="417909">.</span><span class="ident" id="417910">Close</span><span class="op" id="417915">(</span><span class="op" id="417916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="417919">}</span><span class="op" id="417920">(</span><span class="op" id="417921">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417925">const</span>&nbsp;<span class="ident" id="417931">failTime</span>&nbsp;<span class="op" id="417940">=</span>&nbsp;<span class="ident" id="417942">timeout</span>&nbsp;<span class="op" id="417950">*</span>&nbsp;<span class="num" id="417952">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417955">select</span>&nbsp;<span class="op" id="417962">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417965">case</span>&nbsp;<span class="ident" id="417970">err</span>&nbsp;<span class="op" id="417974">:=</span>&nbsp;<span class="op" id="417977">&lt;-</span><span class="ident" id="417979">errc</span><span class="op" id="417983">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="417987">if</span>&nbsp;<span class="ident" id="417990">err</span>&nbsp;<span class="op" id="417994">==</span>&nbsp;<span class="ident" id="417997">nil</span>&nbsp;<span class="op" id="418001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="418006">t</span><span class="op" id="418007">.</span><span class="ident" id="418008">Error</span><span class="op" id="418013">(</span><span class="string" id="418014">&#34;expected&nbsp;error&nbsp;from&nbsp;ReadAll&#34;</span><span class="op" id="418043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="418047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="418051">//&nbsp;Expected&nbsp;error.</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="418071">case</span>&nbsp;<span class="op" id="418076">&lt;-</span><span class="ident" id="418078">time</span><span class="op" id="418082">.</span><span class="ident" id="418083">After</span><span class="op" id="418088">(</span><span class="ident" id="418089">failTime</span><span class="op" id="418097">)</span><span class="op" id="418098">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="418102">t</span><span class="op" id="418103">.</span><span class="ident" id="418104">Errorf</span><span class="op" id="418110">(</span><span class="string" id="418111">&#34;timeout&nbsp;after&nbsp;%v&nbsp;waiting&nbsp;for&nbsp;timeout&nbsp;of&nbsp;%v&#34;</span><span class="op" id="418155">,</span>&nbsp;<span class="ident" id="418157">failTime</span><span class="op" id="418165">,</span>&nbsp;<span class="ident" id="418167">timeout</span><span class="op" id="418174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="418177">}</span><br>
<span class="lineno"></span><span class="op" id="418179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">910</span><span class="keyword" id="418182">func</span>&nbsp;<span class="ident" id="418187">TestClientRedirectEatsBody</span><span class="op" id="418213">(</span><span class="ident" id="418214">t</span>&nbsp;<span class="op" id="418216">*</span><span class="ident" id="418217">testing</span><span class="op" id="418224">.</span><span class="ident" id="418225">T</span><span class="op" id="418226">)</span>&nbsp;<span class="op" id="418228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="418231">defer</span>&nbsp;<span class="ident" id="418237">afterTest</span><span class="op" id="418246">(</span><span class="ident" id="418247">t</span><span class="op" id="418248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="418251">saw</span>&nbsp;<span class="op" id="418255">:=</span>&nbsp;<span class="builtinfunc" id="418258">make</span><span class="op" id="418262">(</span><span class="keyword" id="418263">chan</span>&nbsp;<span class="builtintype" id="418268">string</span><span class="op" id="418274">,</span>&nbsp;<span class="num" id="418276">2</span><span class="op" id="418277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="418280">ts</span>&nbsp;<span class="op" id="418283">:=</span>&nbsp;<span class="ident" id="418286">httptest</span><span class="op" id="418294">.</span><span class="ident" id="418295">NewServer</span><span class="op" id="418304">(</span><span class="ident" id="418305">HandlerFunc</span><span class="op" id="418316">(</span><span class="keyword" id="418317">func</span><span class="op" id="418321">(</span><span class="ident" id="418322">w</span>&nbsp;<span class="ident" id="418324">ResponseWriter</span><span class="op" id="418338">,</span>&nbsp;<span class="ident" id="418340">r</span>&nbsp;<span class="op" id="418342">*</span><span class="ident" id="418343">Request</span><span class="op" id="418350">)</span>&nbsp;<span class="op" id="418352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="418356">saw</span>&nbsp;<span class="op" id="418360">&lt;-</span>&nbsp;<span class="ident" id="418363">r</span><span class="op" id="418364">.</span><span class="ident" id="418365">RemoteAddr</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="418378">if</span>&nbsp;<span class="ident" id="418381">r</span><span class="op" id="418382">.</span><span class="ident" id="418383">URL</span><span class="op" id="418386">.</span><span class="ident" id="418387">Path</span>&nbsp;<span class="op" id="418392">==</span>&nbsp;<span class="string" id="418395">&#34;/&#34;</span>&nbsp;<span class="op" id="418399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="418404">Redirect</span><span class="op" id="418412">(</span><span class="ident" id="418413">w</span><span class="op" id="418414">,</span>&nbsp;<span class="ident" id="418416">r</span><span class="op" id="418417">,</span>&nbsp;<span class="string" id="418419">&#34;/foo&#34;</span><span class="op" id="418425">,</span>&nbsp;<span class="ident" id="418427">StatusFound</span><span class="op" id="418438">)</span>&nbsp;<span class="comment" id="418440">//&nbsp;which&nbsp;includes&nbsp;a&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="418467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="418470">}</span><span class="op" id="418471">)</span><span class="op" id="418472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="418475">defer</span>&nbsp;<span class="ident" id="418481">ts</span><span class="op" id="418483">.</span><span class="ident" id="418484">Close</span><span class="op" id="418489">(</span><span class="op" id="418490">)</span><br>
<span class="lineno">920</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="418494">res</span><span class="op" id="418497">,</span>&nbsp;<span class="ident" id="418499">err</span>&nbsp;<span class="op" id="418503">:=</span>&nbsp;<span class="ident" id="418506">Get</span><span class="op" id="418509">(</span><span class="ident" id="418510">ts</span><span class="op" id="418512">.</span><span class="ident" id="418513">URL</span><span class="op" id="418516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="418519">if</span>&nbsp;<span class="ident" id="418522">err</span>&nbsp;<span class="op" id="418526">!=</span>&nbsp;<span class="ident" id="418529">nil</span>&nbsp;<span class="op" id="418533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="418537">t</span><span class="op" id="418538">.</span><span class="ident" id="418539">Fatal</span><span class="op" id="418544">(</span><span class="ident" id="418545">err</span><span class="op" id="418548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="418551">}</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="418554">_</span><span class="op" id="418555">,</span>&nbsp;<span class="ident" id="418557">err</span>&nbsp;<span class="op" id="418561">=</span>&nbsp;<span class="ident" id="418563">ioutil</span><span class="op" id="418569">.</span><span class="ident" id="418570">ReadAll</span><span class="op" id="418577">(</span><span class="ident" id="418578">res</span><span class="op" id="418581">.</span><span class="ident" id="418582">Body</span><span class="op" id="418586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="418589">if</span>&nbsp;<span class="ident" id="418592">err</span>&nbsp;<span class="op" id="418596">!=</span>&nbsp;<span class="ident" id="418599">nil</span>&nbsp;<span class="op" id="418603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="418607">t</span><span class="op" id="418608">.</span><span class="ident" id="418609">Fatal</span><span class="op" id="418614">(</span><span class="ident" id="418615">err</span><span class="op" id="418618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="418621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="418624">res</span><span class="op" id="418627">.</span><span class="ident" id="418628">Body</span><span class="op" id="418632">.</span><span class="ident" id="418633">Close</span><span class="op" id="418638">(</span><span class="op" id="418639">)</span><br>
<span class="lineno">930</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="418643">var</span>&nbsp;<span class="ident" id="418647">first</span>&nbsp;<span class="builtintype" id="418653">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="418661">select</span>&nbsp;<span class="op" id="418668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="418671">case</span>&nbsp;<span class="ident" id="418676">first</span>&nbsp;<span class="op" id="418682">=</span>&nbsp;<span class="op" id="418684">&lt;-</span><span class="ident" id="418686">saw</span><span class="op" id="418689">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="418692">default</span><span class="op" id="418699">:</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="418703">t</span><span class="op" id="418704">.</span><span class="ident" id="418705">Fatal</span><span class="op" id="418710">(</span><span class="string" id="418711">&#34;server&nbsp;didn&#39;t&nbsp;see&nbsp;a&nbsp;request&#34;</span><span class="op" id="418740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="418743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="418747">var</span>&nbsp;<span class="ident" id="418751">second</span>&nbsp;<span class="builtintype" id="418758">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="418766">select</span>&nbsp;<span class="op" id="418773">{</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="418776">case</span>&nbsp;<span class="ident" id="418781">second</span>&nbsp;<span class="op" id="418788">=</span>&nbsp;<span class="op" id="418790">&lt;-</span><span class="ident" id="418792">saw</span><span class="op" id="418795">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="418798">default</span><span class="op" id="418805">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="418809">t</span><span class="op" id="418810">.</span><span class="ident" id="418811">Fatal</span><span class="op" id="418816">(</span><span class="string" id="418817">&#34;server&nbsp;didn&#39;t&nbsp;see&nbsp;a&nbsp;second&nbsp;request&#34;</span><span class="op" id="418853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="418856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="418860">if</span>&nbsp;<span class="ident" id="418863">first</span>&nbsp;<span class="op" id="418869">!=</span>&nbsp;<span class="ident" id="418872">second</span>&nbsp;<span class="op" id="418879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="418883">t</span><span class="op" id="418884">.</span><span class="ident" id="418885">Fatal</span><span class="op" id="418890">(</span><span class="string" id="418891">&#34;server&nbsp;saw&nbsp;different&nbsp;client&nbsp;ports&nbsp;before&nbsp;&amp;&nbsp;after&nbsp;the&nbsp;redirect&#34;</span><span class="op" id="418954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="418957">}</span><br>
<span class="lineno"></span><span class="op" id="418959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span><span class="comment" id="418962">//&nbsp;eofReaderFunc&nbsp;is&nbsp;an&nbsp;io.Reader&nbsp;that&nbsp;runs&nbsp;itself,&nbsp;and&nbsp;then&nbsp;returns&nbsp;io.EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="419038">type</span>&nbsp;<span class="ident" id="419043">eofReaderFunc</span>&nbsp;<span class="keyword" id="419057">func</span><span class="op" id="419061">(</span><span class="op" id="419062">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="419065">func</span>&nbsp;<span class="op" id="419070">(</span><span class="ident" id="419071">f</span>&nbsp;<span class="ident" id="419073">eofReaderFunc</span><span class="op" id="419086">)</span>&nbsp;<span class="ident" id="419088">Read</span><span class="op" id="419092">(</span><span class="ident" id="419093">p</span>&nbsp;<span class="op" id="419095">[</span><span class="op" id="419096">]</span><span class="builtintype" id="419097">byte</span><span class="op" id="419101">)</span>&nbsp;<span class="op" id="419103">(</span><span class="ident" id="419104">n</span>&nbsp;<span class="builtintype" id="419106">int</span><span class="op" id="419109">,</span>&nbsp;<span class="ident" id="419111">err</span>&nbsp;<span class="builtintype" id="419115">error</span><span class="op" id="419120">)</span>&nbsp;<span class="op" id="419122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="419125">f</span><span class="op" id="419126">(</span><span class="op" id="419127">)</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="419130">return</span>&nbsp;<span class="num" id="419137">0</span><span class="op" id="419138">,</span>&nbsp;<span class="ident" id="419140">io</span><span class="op" id="419142">.</span><span class="ident" id="419143">EOF</span><br>
<span class="lineno"></span><span class="op" id="419147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="419150">func</span>&nbsp;<span class="ident" id="419155">TestClientTrailers</span><span class="op" id="419173">(</span><span class="ident" id="419174">t</span>&nbsp;<span class="op" id="419176">*</span><span class="ident" id="419177">testing</span><span class="op" id="419184">.</span><span class="ident" id="419185">T</span><span class="op" id="419186">)</span>&nbsp;<span class="op" id="419188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="419191">defer</span>&nbsp;<span class="ident" id="419197">afterTest</span><span class="op" id="419206">(</span><span class="ident" id="419207">t</span><span class="op" id="419208">)</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="419211">ts</span>&nbsp;<span class="op" id="419214">:=</span>&nbsp;<span class="ident" id="419217">httptest</span><span class="op" id="419225">.</span><span class="ident" id="419226">NewServer</span><span class="op" id="419235">(</span><span class="ident" id="419236">HandlerFunc</span><span class="op" id="419247">(</span><span class="keyword" id="419248">func</span><span class="op" id="419252">(</span><span class="ident" id="419253">w</span>&nbsp;<span class="ident" id="419255">ResponseWriter</span><span class="op" id="419269">,</span>&nbsp;<span class="ident" id="419271">r</span>&nbsp;<span class="op" id="419273">*</span><span class="ident" id="419274">Request</span><span class="op" id="419281">)</span>&nbsp;<span class="op" id="419283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="419287">w</span><span class="op" id="419288">.</span><span class="ident" id="419289">Header</span><span class="op" id="419295">(</span><span class="op" id="419296">)</span><span class="op" id="419297">.</span><span class="ident" id="419298">Set</span><span class="op" id="419301">(</span><span class="string" id="419302">&#34;Connection&#34;</span><span class="op" id="419314">,</span>&nbsp;<span class="string" id="419316">&#34;close&#34;</span><span class="op" id="419323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="419327">w</span><span class="op" id="419328">.</span><span class="ident" id="419329">Header</span><span class="op" id="419335">(</span><span class="op" id="419336">)</span><span class="op" id="419337">.</span><span class="ident" id="419338">Set</span><span class="op" id="419341">(</span><span class="string" id="419342">&#34;Trailer&#34;</span><span class="op" id="419351">,</span>&nbsp;<span class="string" id="419353">&#34;Server-Trailer-A,&nbsp;Server-Trailer-B&#34;</span><span class="op" id="419389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="419393">w</span><span class="op" id="419394">.</span><span class="ident" id="419395">Header</span><span class="op" id="419401">(</span><span class="op" id="419402">)</span><span class="op" id="419403">.</span><span class="ident" id="419404">Add</span><span class="op" id="419407">(</span><span class="string" id="419408">&#34;Trailer&#34;</span><span class="op" id="419417">,</span>&nbsp;<span class="string" id="419419">&#34;Server-Trailer-C&#34;</span><span class="op" id="419437">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="419442">var</span>&nbsp;<span class="ident" id="419446">decl</span>&nbsp;<span class="op" id="419451">[</span><span class="op" id="419452">]</span><span class="builtintype" id="419453">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="419462">for</span>&nbsp;<span class="ident" id="419466">k</span>&nbsp;<span class="op" id="419468">:=</span>&nbsp;<span class="keyword" id="419471">range</span>&nbsp;<span class="ident" id="419477">r</span><span class="op" id="419478">.</span><span class="ident" id="419479">Trailer</span>&nbsp;<span class="op" id="419487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="419492">decl</span>&nbsp;<span class="op" id="419497">=</span>&nbsp;<span class="builtinfunc" id="419499">append</span><span class="op" id="419505">(</span><span class="ident" id="419506">decl</span><span class="op" id="419510">,</span>&nbsp;<span class="ident" id="419512">k</span><span class="op" id="419513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="419517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="419521">sort</span><span class="op" id="419525">.</span><span class="ident" id="419526">Strings</span><span class="op" id="419533">(</span><span class="ident" id="419534">decl</span><span class="op" id="419538">)</span><br>
<span class="lineno">970</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="419543">slurp</span><span class="op" id="419548">,</span>&nbsp;<span class="ident" id="419550">err</span>&nbsp;<span class="op" id="419554">:=</span>&nbsp;<span class="ident" id="419557">ioutil</span><span class="op" id="419563">.</span><span class="ident" id="419564">ReadAll</span><span class="op" id="419571">(</span><span class="ident" id="419572">r</span><span class="op" id="419573">.</span><span class="ident" id="419574">Body</span><span class="op" id="419578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="419582">if</span>&nbsp;<span class="ident" id="419585">err</span>&nbsp;<span class="op" id="419589">!=</span>&nbsp;<span class="ident" id="419592">nil</span>&nbsp;<span class="op" id="419596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="419601">t</span><span class="op" id="419602">.</span><span class="ident" id="419603">Errorf</span><span class="op" id="419609">(</span><span class="string" id="419610">&#34;Server&nbsp;reading&nbsp;request&nbsp;body:&nbsp;%v&#34;</span><span class="op" id="419643">,</span>&nbsp;<span class="ident" id="419645">err</span><span class="op" id="419648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="419652">}</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="419656">if</span>&nbsp;<span class="builtintype" id="419659">string</span><span class="op" id="419665">(</span><span class="ident" id="419666">slurp</span><span class="op" id="419671">)</span>&nbsp;<span class="op" id="419673">!=</span>&nbsp;<span class="string" id="419676">&#34;foo&#34;</span>&nbsp;<span class="op" id="419682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="419687">t</span><span class="op" id="419688">.</span><span class="ident" id="419689">Errorf</span><span class="op" id="419695">(</span><span class="string" id="419696">&#34;Server&nbsp;read&nbsp;request&nbsp;body&nbsp;%q;&nbsp;want&nbsp;foo&#34;</span><span class="op" id="419735">,</span>&nbsp;<span class="ident" id="419737">slurp</span><span class="op" id="419742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="419746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="419750">if</span>&nbsp;<span class="ident" id="419753">r</span><span class="op" id="419754">.</span><span class="ident" id="419755">Trailer</span>&nbsp;<span class="op" id="419763">==</span>&nbsp;<span class="ident" id="419766">nil</span>&nbsp;<span class="op" id="419770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="419775">io</span><span class="op" id="419777">.</span><span class="ident" id="419778">WriteString</span><span class="op" id="419789">(</span><span class="ident" id="419790">w</span><span class="op" id="419791">,</span>&nbsp;<span class="string" id="419793">&#34;nil&nbsp;Trailer&#34;</span><span class="op" id="419806">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="419810">}</span>&nbsp;<span class="keyword" id="419812">else</span>&nbsp;<span class="op" id="419817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="419822">fmt</span><span class="op" id="419825">.</span><span class="ident" id="419826">Fprintf</span><span class="op" id="419833">(</span><span class="ident" id="419834">w</span><span class="op" id="419835">,</span>&nbsp;<span class="string" id="419837">&#34;decl:&nbsp;%v,&nbsp;vals:&nbsp;%s,&nbsp;%s&#34;</span><span class="op" id="419861">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="419867">decl</span><span class="op" id="419871">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="419877">r</span><span class="op" id="419878">.</span><span class="ident" id="419879">Trailer</span><span class="op" id="419886">.</span><span class="ident" id="419887">Get</span><span class="op" id="419890">(</span><span class="string" id="419891">&#34;Client-Trailer-A&#34;</span><span class="op" id="419909">)</span><span class="op" id="419910">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="419916">r</span><span class="op" id="419917">.</span><span class="ident" id="419918">Trailer</span><span class="op" id="419925">.</span><span class="ident" id="419926">Get</span><span class="op" id="419929">(</span><span class="string" id="419930">&#34;Client-Trailer-B&#34;</span><span class="op" id="419948">)</span><span class="op" id="419949">)</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="419953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="419958">//&nbsp;TODO:&nbsp;golang.org/issue/7759:&nbsp;there&#39;s&nbsp;no&nbsp;way&nbsp;yet&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="420015">//&nbsp;the&nbsp;server&nbsp;to&nbsp;set&nbsp;trailers&nbsp;without&nbsp;hijacking,&nbsp;so&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="420072">//&nbsp;that&nbsp;for&nbsp;now,&nbsp;just&nbsp;to&nbsp;test&nbsp;the&nbsp;client.&nbsp;&nbsp;Later,&nbsp;in</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="420127">//&nbsp;Go&nbsp;1.4,&nbsp;it&nbsp;should&nbsp;be&nbsp;implicit&nbsp;that&nbsp;any&nbsp;mutations</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="420181">//&nbsp;to&nbsp;w.Header()&nbsp;after&nbsp;the&nbsp;initial&nbsp;write&nbsp;are&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="420232">//&nbsp;trailers&nbsp;to&nbsp;be&nbsp;sent,&nbsp;if&nbsp;and&nbsp;only&nbsp;if&nbsp;they&nbsp;were</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="420283">//&nbsp;previously&nbsp;declared&nbsp;with&nbsp;w.Header().Set(&#34;Trailer&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="420339">//&nbsp;..keys..)</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420354">w</span><span class="op" id="420355">.</span><span class="op" id="420356">(</span><span class="ident" id="420357">Flusher</span><span class="op" id="420364">)</span><span class="op" id="420365">.</span><span class="ident" id="420366">Flush</span><span class="op" id="420371">(</span><span class="op" id="420372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420376">conn</span><span class="op" id="420380">,</span>&nbsp;<span class="ident" id="420382">buf</span><span class="op" id="420385">,</span>&nbsp;<span class="ident" id="420387">_</span>&nbsp;<span class="op" id="420389">:=</span>&nbsp;<span class="ident" id="420392">w</span><span class="op" id="420393">.</span><span class="op" id="420394">(</span><span class="ident" id="420395">Hijacker</span><span class="op" id="420403">)</span><span class="op" id="420404">.</span><span class="ident" id="420405">Hijack</span><span class="op" id="420411">(</span><span class="op" id="420412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420416">t</span>&nbsp;<span class="op" id="420418">:=</span>&nbsp;<span class="ident" id="420421">Header</span><span class="op" id="420427">{</span><span class="op" id="420428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420432">t</span><span class="op" id="420433">.</span><span class="ident" id="420434">Set</span><span class="op" id="420437">(</span><span class="string" id="420438">&#34;Server-Trailer-A&#34;</span><span class="op" id="420456">,</span>&nbsp;<span class="string" id="420458">&#34;valuea&#34;</span><span class="op" id="420466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420470">t</span><span class="op" id="420471">.</span><span class="ident" id="420472">Set</span><span class="op" id="420475">(</span><span class="string" id="420476">&#34;Server-Trailer-C&#34;</span><span class="op" id="420494">,</span>&nbsp;<span class="string" id="420496">&#34;valuec&#34;</span><span class="op" id="420504">)</span>&nbsp;<span class="comment" id="420506">//&nbsp;skipping&nbsp;B</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420522">buf</span><span class="op" id="420525">.</span><span class="ident" id="420526">WriteString</span><span class="op" id="420537">(</span><span class="string" id="420538">&#34;0\r\n&#34;</span><span class="op" id="420545">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="420558">//&nbsp;eof</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420567">t</span><span class="op" id="420568">.</span><span class="ident" id="420569">Write</span><span class="op" id="420574">(</span><span class="ident" id="420575">buf</span><span class="op" id="420578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420582">buf</span><span class="op" id="420585">.</span><span class="ident" id="420586">WriteString</span><span class="op" id="420597">(</span><span class="string" id="420598">&#34;\r\n&#34;</span><span class="op" id="420604">)</span>&nbsp;<span class="comment" id="420606">//&nbsp;end&nbsp;of&nbsp;trailers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420627">buf</span><span class="op" id="420630">.</span><span class="ident" id="420631">Flush</span><span class="op" id="420636">(</span><span class="op" id="420637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420641">conn</span><span class="op" id="420645">.</span><span class="ident" id="420646">Close</span><span class="op" id="420651">(</span><span class="op" id="420652">)</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="420655">}</span><span class="op" id="420656">)</span><span class="op" id="420657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="420660">defer</span>&nbsp;<span class="ident" id="420666">ts</span><span class="op" id="420668">.</span><span class="ident" id="420669">Close</span><span class="op" id="420674">(</span><span class="op" id="420675">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="420679">var</span>&nbsp;<span class="ident" id="420683">req</span>&nbsp;<span class="op" id="420687">*</span><span class="ident" id="420688">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420697">req</span><span class="op" id="420700">,</span>&nbsp;<span class="ident" id="420702">_</span>&nbsp;<span class="op" id="420704">=</span>&nbsp;<span class="ident" id="420706">NewRequest</span><span class="op" id="420716">(</span><span class="string" id="420717">&#34;POST&#34;</span><span class="op" id="420723">,</span>&nbsp;<span class="ident" id="420725">ts</span><span class="op" id="420727">.</span><span class="ident" id="420728">URL</span><span class="op" id="420731">,</span>&nbsp;<span class="ident" id="420733">io</span><span class="op" id="420735">.</span><span class="ident" id="420736">MultiReader</span><span class="op" id="420747">(</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420751">eofReaderFunc</span><span class="op" id="420764">(</span><span class="keyword" id="420765">func</span><span class="op" id="420769">(</span><span class="op" id="420770">)</span>&nbsp;<span class="op" id="420772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420777">req</span><span class="op" id="420780">.</span><span class="ident" id="420781">Trailer</span><span class="op" id="420788">[</span><span class="string" id="420789">&#34;Client-Trailer-A&#34;</span><span class="op" id="420807">]</span>&nbsp;<span class="op" id="420809">=</span>&nbsp;<span class="op" id="420811">[</span><span class="op" id="420812">]</span><span class="builtintype" id="420813">string</span><span class="op" id="420819">{</span><span class="string" id="420820">&#34;valuea&#34;</span><span class="op" id="420828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="420832">}</span><span class="op" id="420833">)</span><span class="op" id="420834">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420838">strings</span><span class="op" id="420845">.</span><span class="ident" id="420846">NewReader</span><span class="op" id="420855">(</span><span class="string" id="420856">&#34;foo&#34;</span><span class="op" id="420861">)</span><span class="op" id="420862">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420866">eofReaderFunc</span><span class="op" id="420879">(</span><span class="keyword" id="420880">func</span><span class="op" id="420884">(</span><span class="op" id="420885">)</span>&nbsp;<span class="op" id="420887">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420892">req</span><span class="op" id="420895">.</span><span class="ident" id="420896">Trailer</span><span class="op" id="420903">[</span><span class="string" id="420904">&#34;Client-Trailer-B&#34;</span><span class="op" id="420922">]</span>&nbsp;<span class="op" id="420924">=</span>&nbsp;<span class="op" id="420926">[</span><span class="op" id="420927">]</span><span class="builtintype" id="420928">string</span><span class="op" id="420934">{</span><span class="string" id="420935">&#34;valueb&#34;</span><span class="op" id="420943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="420947">}</span><span class="op" id="420948">)</span><span class="op" id="420949">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="420952">)</span><span class="op" id="420953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="420956">req</span><span class="op" id="420959">.</span><span class="ident" id="420960">Trailer</span>&nbsp;<span class="op" id="420968">=</span>&nbsp;<span class="ident" id="420970">Header</span><span class="op" id="420976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="420980">&#34;Client-Trailer-A&#34;</span><span class="op" id="420998">:</span>&nbsp;<span class="ident" id="421000">nil</span><span class="op" id="421003">,</span>&nbsp;<span class="comment" id="421005">//&nbsp;&nbsp;to&nbsp;be&nbsp;set&nbsp;later</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="421027">&#34;Client-Trailer-B&#34;</span><span class="op" id="421045">:</span>&nbsp;<span class="ident" id="421047">nil</span><span class="op" id="421050">,</span>&nbsp;<span class="comment" id="421052">//&nbsp;&nbsp;to&nbsp;be&nbsp;set&nbsp;later</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="421073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="421076">req</span><span class="op" id="421079">.</span><span class="ident" id="421080">ContentLength</span>&nbsp;<span class="op" id="421094">=</span>&nbsp;<span class="op" id="421096">-</span><span class="num" id="421097">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="421100">res</span><span class="op" id="421103">,</span>&nbsp;<span class="ident" id="421105">err</span>&nbsp;<span class="op" id="421109">:=</span>&nbsp;<span class="ident" id="421112">DefaultClient</span><span class="op" id="421125">.</span><span class="ident" id="421126">Do</span><span class="op" id="421128">(</span><span class="ident" id="421129">req</span><span class="op" id="421132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="421135">if</span>&nbsp;<span class="ident" id="421138">err</span>&nbsp;<span class="op" id="421142">!=</span>&nbsp;<span class="ident" id="421145">nil</span>&nbsp;<span class="op" id="421149">{</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="421153">t</span><span class="op" id="421154">.</span><span class="ident" id="421155">Fatal</span><span class="op" id="421160">(</span><span class="ident" id="421161">err</span><span class="op" id="421164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="421167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="421170">if</span>&nbsp;<span class="ident" id="421173">err</span>&nbsp;<span class="op" id="421177">:=</span>&nbsp;<span class="ident" id="421180">wantBody</span><span class="op" id="421188">(</span><span class="ident" id="421189">res</span><span class="op" id="421192">,</span>&nbsp;<span class="ident" id="421194">err</span><span class="op" id="421197">,</span>&nbsp;<span class="string" id="421199">&#34;decl:&nbsp;[Client-Trailer-A&nbsp;Client-Trailer-B],&nbsp;vals:&nbsp;valuea,&nbsp;valueb&#34;</span><span class="op" id="421264">)</span><span class="op" id="421265">;</span>&nbsp;<span class="ident" id="421267">err</span>&nbsp;<span class="op" id="421271">!=</span>&nbsp;<span class="ident" id="421274">nil</span>&nbsp;<span class="op" id="421278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="421282">t</span><span class="op" id="421283">.</span><span class="ident" id="421284">Error</span><span class="op" id="421289">(</span><span class="ident" id="421290">err</span><span class="op" id="421293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="421296">}</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="421299">want</span>&nbsp;<span class="op" id="421304">:=</span>&nbsp;<span class="ident" id="421307">Header</span><span class="op" id="421313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="421317">&#34;Server-Trailer-A&#34;</span><span class="op" id="421335">:</span>&nbsp;<span class="op" id="421337">[</span><span class="op" id="421338">]</span><span class="builtintype" id="421339">string</span><span class="op" id="421345">{</span><span class="string" id="421346">&#34;valuea&#34;</span><span class="op" id="421354">}</span><span class="op" id="421355">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="421359">&#34;Server-Trailer-B&#34;</span><span class="op" id="421377">:</span>&nbsp;<span class="ident" id="421379">nil</span><span class="op" id="421382">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="421386">&#34;Server-Trailer-C&#34;</span><span class="op" id="421404">:</span>&nbsp;<span class="op" id="421406">[</span><span class="op" id="421407">]</span><span class="builtintype" id="421408">string</span><span class="op" id="421414">{</span><span class="string" id="421415">&#34;valuec&#34;</span><span class="op" id="421423">}</span><span class="op" id="421424">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="421427">}</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="421430">if</span>&nbsp;<span class="op" id="421433">!</span><span class="ident" id="421434">reflect</span><span class="op" id="421441">.</span><span class="ident" id="421442">DeepEqual</span><span class="op" id="421451">(</span><span class="ident" id="421452">res</span><span class="op" id="421455">.</span><span class="ident" id="421456">Trailer</span><span class="op" id="421463">,</span>&nbsp;<span class="ident" id="421465">want</span><span class="op" id="421469">)</span>&nbsp;<span class="op" id="421471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="421475">t</span><span class="op" id="421476">.</span><span class="ident" id="421477">Errorf</span><span class="op" id="421483">(</span><span class="string" id="421484">&#34;Response&nbsp;trailers&nbsp;=&nbsp;%#v;&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="421519">,</span>&nbsp;<span class="ident" id="421521">res</span><span class="op" id="421524">.</span><span class="ident" id="421525">Trailer</span><span class="op" id="421532">,</span>&nbsp;<span class="ident" id="421534">want</span><span class="op" id="421538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="421541">}</span><br>
<span class="lineno"></span><span class="op" id="421543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1040</span><span class="keyword" id="421546">func</span>&nbsp;<span class="ident" id="421551">TestReferer</span><span class="op" id="421562">(</span><span class="ident" id="421563">t</span>&nbsp;<span class="op" id="421565">*</span><span class="ident" id="421566">testing</span><span class="op" id="421573">.</span><span class="ident" id="421574">T</span><span class="op" id="421575">)</span>&nbsp;<span class="op" id="421577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="421580">tests</span>&nbsp;<span class="op" id="421586">:=</span>&nbsp;<span class="op" id="421589">[</span><span class="op" id="421590">]</span><span class="keyword" id="421591">struct</span>&nbsp;<span class="op" id="421598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="421602">lastReq</span><span class="op" id="421609">,</span>&nbsp;<span class="ident" id="421611">newReq</span>&nbsp;<span class="builtintype" id="421618">string</span>&nbsp;<span class="comment" id="421625">//&nbsp;from&nbsp;-&gt;&nbsp;to&nbsp;URLs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="421646">want</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="421662">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="421670">}</span><span class="op" id="421671">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="421675">//&nbsp;don&#39;t&nbsp;send&nbsp;user:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="421697">{</span><span class="string" id="421698">&#34;http://gopher@test.com&#34;</span><span class="op" id="421722">,</span>&nbsp;<span class="string" id="421724">&#34;http://link.com&#34;</span><span class="op" id="421741">,</span>&nbsp;<span class="string" id="421743">&#34;http://test.com&#34;</span><span class="op" id="421760">}</span><span class="op" id="421761">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="421765">{</span><span class="string" id="421766">&#34;https://gopher@test.com&#34;</span><span class="op" id="421791">,</span>&nbsp;<span class="string" id="421793">&#34;https://link.com&#34;</span><span class="op" id="421811">,</span>&nbsp;<span class="string" id="421813">&#34;https://test.com&#34;</span><span class="op" id="421831">}</span><span class="op" id="421832">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="421837">//&nbsp;don&#39;t&nbsp;send&nbsp;a&nbsp;user&nbsp;and&nbsp;password:</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="421874">{</span><span class="string" id="421875">&#34;http://gopher:go@test.com&#34;</span><span class="op" id="421902">,</span>&nbsp;<span class="string" id="421904">&#34;http://link.com&#34;</span><span class="op" id="421921">,</span>&nbsp;<span class="string" id="421923">&#34;http://test.com&#34;</span><span class="op" id="421940">}</span><span class="op" id="421941">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="421945">{</span><span class="string" id="421946">&#34;https://gopher:go@test.com&#34;</span><span class="op" id="421974">,</span>&nbsp;<span class="string" id="421976">&#34;https://link.com&#34;</span><span class="op" id="421994">,</span>&nbsp;<span class="string" id="421996">&#34;https://test.com&#34;</span><span class="op" id="422014">}</span><span class="op" id="422015">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="422020">//&nbsp;nothing&nbsp;to&nbsp;do:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="422040">{</span><span class="string" id="422041">&#34;http://test.com&#34;</span><span class="op" id="422058">,</span>&nbsp;<span class="string" id="422060">&#34;http://link.com&#34;</span><span class="op" id="422077">,</span>&nbsp;<span class="string" id="422079">&#34;http://test.com&#34;</span><span class="op" id="422096">}</span><span class="op" id="422097">,</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="422101">{</span><span class="string" id="422102">&#34;https://test.com&#34;</span><span class="op" id="422120">,</span>&nbsp;<span class="string" id="422122">&#34;https://link.com&#34;</span><span class="op" id="422140">,</span>&nbsp;<span class="string" id="422142">&#34;https://test.com&#34;</span><span class="op" id="422160">}</span><span class="op" id="422161">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="422166">//&nbsp;https&nbsp;to&nbsp;http&nbsp;doesn&#39;t&nbsp;send&nbsp;a&nbsp;referer:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="422209">{</span><span class="string" id="422210">&#34;https://test.com&#34;</span><span class="op" id="422228">,</span>&nbsp;<span class="string" id="422230">&#34;http://link.com&#34;</span><span class="op" id="422247">,</span>&nbsp;<span class="string" id="422249">&#34;&#34;</span><span class="op" id="422251">}</span><span class="op" id="422252">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="422256">{</span><span class="string" id="422257">&#34;https://gopher:go@test.com&#34;</span><span class="op" id="422285">,</span>&nbsp;<span class="string" id="422287">&#34;http://link.com&#34;</span><span class="op" id="422304">,</span>&nbsp;<span class="string" id="422306">&#34;&#34;</span><span class="op" id="422308">}</span><span class="op" id="422309">,</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="422312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="422315">for</span>&nbsp;<span class="ident" id="422319">_</span><span class="op" id="422320">,</span>&nbsp;<span class="ident" id="422322">tt</span>&nbsp;<span class="op" id="422325">:=</span>&nbsp;<span class="keyword" id="422328">range</span>&nbsp;<span class="ident" id="422334">tests</span>&nbsp;<span class="op" id="422340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="422344">l</span><span class="op" id="422345">,</span>&nbsp;<span class="ident" id="422347">err</span>&nbsp;<span class="op" id="422351">:=</span>&nbsp;<span class="ident" id="422354">url</span><span class="op" id="422357">.</span><span class="ident" id="422358">Parse</span><span class="op" id="422363">(</span><span class="ident" id="422364">tt</span><span class="op" id="422366">.</span><span class="ident" id="422367">lastReq</span><span class="op" id="422374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="422378">if</span>&nbsp;<span class="ident" id="422381">err</span>&nbsp;<span class="op" id="422385">!=</span>&nbsp;<span class="ident" id="422388">nil</span>&nbsp;<span class="op" id="422392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="422397">t</span><span class="op" id="422398">.</span><span class="ident" id="422399">Fatal</span><span class="op" id="422404">(</span><span class="ident" id="422405">err</span><span class="op" id="422408">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="422412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="422416">n</span><span class="op" id="422417">,</span>&nbsp;<span class="ident" id="422419">err</span>&nbsp;<span class="op" id="422423">:=</span>&nbsp;<span class="ident" id="422426">url</span><span class="op" id="422429">.</span><span class="ident" id="422430">Parse</span><span class="op" id="422435">(</span><span class="ident" id="422436">tt</span><span class="op" id="422438">.</span><span class="ident" id="422439">newReq</span><span class="op" id="422445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="422449">if</span>&nbsp;<span class="ident" id="422452">err</span>&nbsp;<span class="op" id="422456">!=</span>&nbsp;<span class="ident" id="422459">nil</span>&nbsp;<span class="op" id="422463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="422468">t</span><span class="op" id="422469">.</span><span class="ident" id="422470">Fatal</span><span class="op" id="422475">(</span><span class="ident" id="422476">err</span><span class="op" id="422479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="422483">}</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="422487">r</span>&nbsp;<span class="op" id="422489">:=</span>&nbsp;<span class="ident" id="422492">ExportRefererForURL</span><span class="op" id="422511">(</span><span class="ident" id="422512">l</span><span class="op" id="422513">,</span>&nbsp;<span class="ident" id="422515">n</span><span class="op" id="422516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="422520">if</span>&nbsp;<span class="ident" id="422523">r</span>&nbsp;<span class="op" id="422525">!=</span>&nbsp;<span class="ident" id="422528">tt</span><span class="op" id="422530">.</span><span class="ident" id="422531">want</span>&nbsp;<span class="op" id="422536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="422541">t</span><span class="op" id="422542">.</span><span class="ident" id="422543">Errorf</span><span class="op" id="422549">(</span><span class="string" id="422550">&#34;refererForURL(%q,&nbsp;%q)&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="422587">,</span>&nbsp;<span class="ident" id="422589">tt</span><span class="op" id="422591">.</span><span class="ident" id="422592">lastReq</span><span class="op" id="422599">,</span>&nbsp;<span class="ident" id="422601">tt</span><span class="op" id="422603">.</span><span class="ident" id="422604">newReq</span><span class="op" id="422610">,</span>&nbsp;<span class="ident" id="422612">r</span><span class="op" id="422613">,</span>&nbsp;<span class="ident" id="422615">tt</span><span class="op" id="422617">.</span><span class="ident" id="422618">want</span><span class="op" id="422622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="422626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="422629">}</span><br>
<span class="lineno">1075</span><span class="op" id="422631">}</span>
</div>
</body>
</html>
