<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3928431">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3928486">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3928540">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3928591">package</span>&nbsp;<span class="ident" id="3928599">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3928607">import</span>&nbsp;<span class="op" id="3928614">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3928617">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3928634">&#34;errors&#34;</span><br>
<span class="lineno">10</span><span class="op" id="3928643">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3928646">//&nbsp;AEAD&nbsp;is&nbsp;a&nbsp;cipher&nbsp;mode&nbsp;providing&nbsp;authenticated&nbsp;encryption&nbsp;with&nbsp;associated</span><br>
<span class="lineno"></span><span class="comment" id="3928722">//&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3928731">type</span>&nbsp;<span class="ident" id="3928736">AEAD</span>&nbsp;<span class="keyword" id="3928741">interface</span>&nbsp;<span class="op" id="3928751">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3928754">//&nbsp;NonceSize&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;nonce&nbsp;that&nbsp;must&nbsp;be&nbsp;passed&nbsp;to&nbsp;Seal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3928826">//&nbsp;and&nbsp;Open.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928840">NonceSize</span><span class="op" id="3928849">(</span><span class="op" id="3928850">)</span>&nbsp;<span class="builtintype" id="3928852">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3928858">//&nbsp;Overhead&nbsp;returns&nbsp;the&nbsp;maximum&nbsp;difference&nbsp;between&nbsp;the&nbsp;lengths&nbsp;of&nbsp;a</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3928927">//&nbsp;plaintext&nbsp;and&nbsp;ciphertext.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928957">Overhead</span><span class="op" id="3928965">(</span><span class="op" id="3928966">)</span>&nbsp;<span class="builtintype" id="3928968">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3928974">//&nbsp;Seal&nbsp;encrypts&nbsp;and&nbsp;authenticates&nbsp;plaintext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3929039">//&nbsp;additional&nbsp;data&nbsp;and&nbsp;appends&nbsp;the&nbsp;result&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3929112">//&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()&nbsp;bytes&nbsp;long&nbsp;and&nbsp;unique&nbsp;for&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3929183">//&nbsp;time,&nbsp;for&nbsp;a&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3929210">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3929214">//&nbsp;The&nbsp;plaintext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929273">Seal</span><span class="op" id="3929277">(</span><span class="ident" id="3929278">dst</span><span class="op" id="3929281">,</span>&nbsp;<span class="ident" id="3929283">nonce</span><span class="op" id="3929288">,</span>&nbsp;<span class="ident" id="3929290">plaintext</span><span class="op" id="3929299">,</span>&nbsp;<span class="ident" id="3929301">data</span>&nbsp;<span class="op" id="3929306">[</span><span class="op" id="3929307">]</span><span class="builtintype" id="3929308">byte</span><span class="op" id="3929312">)</span>&nbsp;<span class="op" id="3929314">[</span><span class="op" id="3929315">]</span><span class="builtintype" id="3929316">byte</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3929323">//&nbsp;Open&nbsp;decrypts&nbsp;and&nbsp;authenticates&nbsp;ciphertext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3929389">//&nbsp;additional&nbsp;data&nbsp;and,&nbsp;if&nbsp;successful,&nbsp;appends&nbsp;the&nbsp;resulting&nbsp;plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3929461">//&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3929532">//&nbsp;bytes&nbsp;long&nbsp;and&nbsp;both&nbsp;it&nbsp;and&nbsp;the&nbsp;additional&nbsp;data&nbsp;must&nbsp;match&nbsp;the</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3929598">//&nbsp;value&nbsp;passed&nbsp;to&nbsp;Seal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3929624">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3929628">//&nbsp;The&nbsp;ciphertext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929688">Open</span><span class="op" id="3929692">(</span><span class="ident" id="3929693">dst</span><span class="op" id="3929696">,</span>&nbsp;<span class="ident" id="3929698">nonce</span><span class="op" id="3929703">,</span>&nbsp;<span class="ident" id="3929705">ciphertext</span><span class="op" id="3929715">,</span>&nbsp;<span class="ident" id="3929717">data</span>&nbsp;<span class="op" id="3929722">[</span><span class="op" id="3929723">]</span><span class="builtintype" id="3929724">byte</span><span class="op" id="3929728">)</span>&nbsp;<span class="op" id="3929730">(</span><span class="op" id="3929731">[</span><span class="op" id="3929732">]</span><span class="builtintype" id="3929733">byte</span><span class="op" id="3929737">,</span>&nbsp;<span class="builtintype" id="3929739">error</span><span class="op" id="3929744">)</span><br>
<span class="lineno"></span><span class="op" id="3929746">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="3929749">//&nbsp;gcmFieldElement&nbsp;represents&nbsp;a&nbsp;value&nbsp;in&nbsp;GF(2¹²⁸).&nbsp;In&nbsp;order&nbsp;to&nbsp;reflect&nbsp;the&nbsp;GCM</span><br>
<span class="lineno"></span><span class="comment" id="3929832">//&nbsp;standard&nbsp;and&nbsp;make&nbsp;getUint64&nbsp;suitable&nbsp;for&nbsp;marshaling&nbsp;these&nbsp;values,&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="3929910">//&nbsp;are&nbsp;stored&nbsp;backwards.&nbsp;For&nbsp;example:</span><br>
<span class="lineno"></span><span class="comment" id="3929948">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁰&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno">45</span><span class="comment" id="3930009">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶³&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="3930070">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶⁴&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno"></span><span class="comment" id="3930135">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x¹²⁷&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="3930199">type</span>&nbsp;<span class="ident" id="3930204">gcmFieldElement</span>&nbsp;<span class="keyword" id="3930220">struct</span>&nbsp;<span class="op" id="3930227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3930230">low</span><span class="op" id="3930233">,</span>&nbsp;<span class="ident" id="3930235">high</span>&nbsp;<span class="ident" id="3930240">uint64</span><br>
<span class="lineno">50</span><span class="op" id="3930247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3930250">//&nbsp;gcm&nbsp;represents&nbsp;a&nbsp;Galois&nbsp;Counter&nbsp;Mode&nbsp;with&nbsp;a&nbsp;specific&nbsp;key.&nbsp;See</span><br>
<span class="lineno"></span><span class="comment" id="3930315">//&nbsp;http://csrc.nist.gov/groups/ST/toolkit/BCM/documents/proposedmodes/gcm/gcm-revised-spec.pdf</span><br>
<span class="lineno"></span><span class="keyword" id="3930410">type</span>&nbsp;<span class="ident" id="3930415">gcm</span>&nbsp;<span class="keyword" id="3930419">struct</span>&nbsp;<span class="op" id="3930426">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3930429">cipher</span>&nbsp;<span class="ident" id="3930436">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3930443">//&nbsp;productTable&nbsp;contains&nbsp;the&nbsp;first&nbsp;sixteen&nbsp;powers&nbsp;of&nbsp;the&nbsp;key,&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3930509">//&nbsp;However,&nbsp;they&nbsp;are&nbsp;in&nbsp;bit&nbsp;reversed&nbsp;order.&nbsp;See&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3930566">productTable</span>&nbsp;<span class="op" id="3930579">[</span><span class="num" id="3930580">16</span><span class="op" id="3930582">]</span><span class="ident" id="3930583">gcmFieldElement</span><br>
<span class="lineno"></span><span class="op" id="3930599">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="3930602">//&nbsp;NewGCM&nbsp;returns&nbsp;the&nbsp;given&nbsp;128-bit,&nbsp;block&nbsp;cipher&nbsp;wrapped&nbsp;in&nbsp;Galois&nbsp;Counter&nbsp;Mode.</span><br>
<span class="lineno"></span><span class="keyword" id="3930684">func</span>&nbsp;<span class="ident" id="3930689">NewGCM</span><span class="op" id="3930695">(</span><span class="ident" id="3930696">cipher</span>&nbsp;<span class="ident" id="3930703">Block</span><span class="op" id="3930708">)</span>&nbsp;<span class="op" id="3930710">(</span><span class="ident" id="3930711">AEAD</span><span class="op" id="3930715">,</span>&nbsp;<span class="builtintype" id="3930717">error</span><span class="op" id="3930722">)</span>&nbsp;<span class="op" id="3930724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930727">if</span>&nbsp;<span class="ident" id="3930730">cipher</span><span class="op" id="3930736">.</span><span class="ident" id="3930737">BlockSize</span><span class="op" id="3930746">(</span><span class="op" id="3930747">)</span>&nbsp;<span class="op" id="3930749">!=</span>&nbsp;<span class="ident" id="3930752">gcmBlockSize</span>&nbsp;<span class="op" id="3930765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930769">return</span>&nbsp;<span class="ident" id="3930776">nil</span><span class="op" id="3930779">,</span>&nbsp;<span class="ident" id="3930781">errors</span><span class="op" id="3930787">.</span><span class="ident" id="3930788">New</span><span class="op" id="3930791">(</span><span class="string" id="3930792">&#34;cipher:&nbsp;NewGCM&nbsp;requires&nbsp;128-bit&nbsp;block&nbsp;cipher&#34;</span><span class="op" id="3930838">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3930841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930845">var</span>&nbsp;<span class="ident" id="3930849">key</span>&nbsp;<span class="op" id="3930853">[</span><span class="ident" id="3930854">gcmBlockSize</span><span class="op" id="3930866">]</span><span class="builtintype" id="3930867">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3930873">cipher</span><span class="op" id="3930879">.</span><span class="ident" id="3930880">Encrypt</span><span class="op" id="3930887">(</span><span class="ident" id="3930888">key</span><span class="op" id="3930891">[</span><span class="op" id="3930892">:</span><span class="op" id="3930893">]</span><span class="op" id="3930894">,</span>&nbsp;<span class="ident" id="3930896">key</span><span class="op" id="3930899">[</span><span class="op" id="3930900">:</span><span class="op" id="3930901">]</span><span class="op" id="3930902">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3930906">g</span>&nbsp;<span class="op" id="3930908">:=</span>&nbsp;<span class="op" id="3930911">&amp;</span><span class="ident" id="3930912">gcm</span><span class="op" id="3930915">{</span><span class="ident" id="3930916">cipher</span><span class="op" id="3930922">:</span>&nbsp;<span class="ident" id="3930924">cipher</span><span class="op" id="3930930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3930934">//&nbsp;We&nbsp;precompute&nbsp;16&nbsp;multiples&nbsp;of&nbsp;|key|.&nbsp;However,&nbsp;when&nbsp;we&nbsp;do&nbsp;lookups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3931003">//&nbsp;into&nbsp;this&nbsp;table&nbsp;we&#39;ll&nbsp;be&nbsp;using&nbsp;bits&nbsp;from&nbsp;a&nbsp;field&nbsp;element&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3931068">//&nbsp;therefore&nbsp;the&nbsp;bits&nbsp;will&nbsp;be&nbsp;in&nbsp;the&nbsp;reverse&nbsp;order.&nbsp;So&nbsp;normally&nbsp;one</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3931137">//&nbsp;would&nbsp;expect,&nbsp;say,&nbsp;4*key&nbsp;to&nbsp;be&nbsp;in&nbsp;index&nbsp;4&nbsp;of&nbsp;the&nbsp;table&nbsp;but&nbsp;due&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3931207">//&nbsp;this&nbsp;bit&nbsp;ordering&nbsp;it&nbsp;will&nbsp;actually&nbsp;be&nbsp;in&nbsp;index&nbsp;0010&nbsp;(base&nbsp;2)&nbsp;=&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931277">x</span>&nbsp;<span class="op" id="3931279">:=</span>&nbsp;<span class="ident" id="3931282">gcmFieldElement</span><span class="op" id="3931297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931301">getUint64</span><span class="op" id="3931310">(</span><span class="ident" id="3931311">key</span><span class="op" id="3931314">[</span><span class="op" id="3931315">:</span><span class="num" id="3931316">8</span><span class="op" id="3931317">]</span><span class="op" id="3931318">)</span><span class="op" id="3931319">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931323">getUint64</span><span class="op" id="3931332">(</span><span class="ident" id="3931333">key</span><span class="op" id="3931336">[</span><span class="num" id="3931337">8</span><span class="op" id="3931338">:</span><span class="op" id="3931339">]</span><span class="op" id="3931340">)</span><span class="op" id="3931341">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3931344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931347">g</span><span class="op" id="3931348">.</span><span class="ident" id="3931349">productTable</span><span class="op" id="3931361">[</span><span class="ident" id="3931362">reverseBits</span><span class="op" id="3931373">(</span><span class="num" id="3931374">1</span><span class="op" id="3931375">)</span><span class="op" id="3931376">]</span>&nbsp;<span class="op" id="3931378">=</span>&nbsp;<span class="ident" id="3931380">x</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931384">for</span>&nbsp;<span class="ident" id="3931388">i</span>&nbsp;<span class="op" id="3931390">:=</span>&nbsp;<span class="num" id="3931393">2</span><span class="op" id="3931394">;</span>&nbsp;<span class="ident" id="3931396">i</span>&nbsp;<span class="op" id="3931398">&lt;</span>&nbsp;<span class="num" id="3931400">16</span><span class="op" id="3931402">;</span>&nbsp;<span class="ident" id="3931404">i</span>&nbsp;<span class="op" id="3931406">+=</span>&nbsp;<span class="num" id="3931409">2</span>&nbsp;<span class="op" id="3931411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931415">g</span><span class="op" id="3931416">.</span><span class="ident" id="3931417">productTable</span><span class="op" id="3931429">[</span><span class="ident" id="3931430">reverseBits</span><span class="op" id="3931441">(</span><span class="ident" id="3931442">i</span><span class="op" id="3931443">)</span><span class="op" id="3931444">]</span>&nbsp;<span class="op" id="3931446">=</span>&nbsp;<span class="ident" id="3931448">gcmDouble</span><span class="op" id="3931457">(</span><span class="op" id="3931458">&amp;</span><span class="ident" id="3931459">g</span><span class="op" id="3931460">.</span><span class="ident" id="3931461">productTable</span><span class="op" id="3931473">[</span><span class="ident" id="3931474">reverseBits</span><span class="op" id="3931485">(</span><span class="ident" id="3931486">i</span><span class="op" id="3931487">/</span><span class="num" id="3931488">2</span><span class="op" id="3931489">)</span><span class="op" id="3931490">]</span><span class="op" id="3931491">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931495">g</span><span class="op" id="3931496">.</span><span class="ident" id="3931497">productTable</span><span class="op" id="3931509">[</span><span class="ident" id="3931510">reverseBits</span><span class="op" id="3931521">(</span><span class="ident" id="3931522">i</span><span class="op" id="3931523">+</span><span class="num" id="3931524">1</span><span class="op" id="3931525">)</span><span class="op" id="3931526">]</span>&nbsp;<span class="op" id="3931528">=</span>&nbsp;<span class="ident" id="3931530">gcmAdd</span><span class="op" id="3931536">(</span><span class="op" id="3931537">&amp;</span><span class="ident" id="3931538">g</span><span class="op" id="3931539">.</span><span class="ident" id="3931540">productTable</span><span class="op" id="3931552">[</span><span class="ident" id="3931553">reverseBits</span><span class="op" id="3931564">(</span><span class="ident" id="3931565">i</span><span class="op" id="3931566">)</span><span class="op" id="3931567">]</span><span class="op" id="3931568">,</span>&nbsp;<span class="op" id="3931570">&amp;</span><span class="ident" id="3931571">x</span><span class="op" id="3931572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3931575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931579">return</span>&nbsp;<span class="ident" id="3931586">g</span><span class="op" id="3931587">,</span>&nbsp;<span class="ident" id="3931589">nil</span><br>
<span class="lineno"></span><span class="op" id="3931593">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="3931596">const</span>&nbsp;<span class="op" id="3931602">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931605">gcmBlockSize</span>&nbsp;<span class="op" id="3931618">=</span>&nbsp;<span class="num" id="3931620">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931624">gcmTagSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3931637">=</span>&nbsp;<span class="num" id="3931639">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931643">gcmNonceSize</span>&nbsp;<span class="op" id="3931656">=</span>&nbsp;<span class="num" id="3931658">12</span><br>
<span class="lineno">95</span><span class="op" id="3931661">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3931664">func</span>&nbsp;<span class="op" id="3931669">(</span><span class="op" id="3931670">*</span><span class="ident" id="3931671">gcm</span><span class="op" id="3931674">)</span>&nbsp;<span class="ident" id="3931676">NonceSize</span><span class="op" id="3931685">(</span><span class="op" id="3931686">)</span>&nbsp;<span class="builtintype" id="3931688">int</span>&nbsp;<span class="op" id="3931692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931695">return</span>&nbsp;<span class="ident" id="3931702">gcmNonceSize</span><br>
<span class="lineno"></span><span class="op" id="3931715">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="3931718">func</span>&nbsp;<span class="op" id="3931723">(</span><span class="op" id="3931724">*</span><span class="ident" id="3931725">gcm</span><span class="op" id="3931728">)</span>&nbsp;<span class="ident" id="3931730">Overhead</span><span class="op" id="3931738">(</span><span class="op" id="3931739">)</span>&nbsp;<span class="builtintype" id="3931741">int</span>&nbsp;<span class="op" id="3931745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931748">return</span>&nbsp;<span class="ident" id="3931755">gcmTagSize</span><br>
<span class="lineno"></span><span class="op" id="3931766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="3931769">func</span>&nbsp;<span class="op" id="3931774">(</span><span class="ident" id="3931775">g</span>&nbsp;<span class="op" id="3931777">*</span><span class="ident" id="3931778">gcm</span><span class="op" id="3931781">)</span>&nbsp;<span class="ident" id="3931783">Seal</span><span class="op" id="3931787">(</span><span class="ident" id="3931788">dst</span><span class="op" id="3931791">,</span>&nbsp;<span class="ident" id="3931793">nonce</span><span class="op" id="3931798">,</span>&nbsp;<span class="ident" id="3931800">plaintext</span><span class="op" id="3931809">,</span>&nbsp;<span class="ident" id="3931811">data</span>&nbsp;<span class="op" id="3931816">[</span><span class="op" id="3931817">]</span><span class="builtintype" id="3931818">byte</span><span class="op" id="3931822">)</span>&nbsp;<span class="op" id="3931824">[</span><span class="op" id="3931825">]</span><span class="builtintype" id="3931826">byte</span>&nbsp;<span class="op" id="3931831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931834">if</span>&nbsp;<span class="builtinfunc" id="3931837">len</span><span class="op" id="3931840">(</span><span class="ident" id="3931841">nonce</span><span class="op" id="3931846">)</span>&nbsp;<span class="op" id="3931848">!=</span>&nbsp;<span class="ident" id="3931851">gcmNonceSize</span>&nbsp;<span class="op" id="3931864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3931868">panic</span><span class="op" id="3931873">(</span><span class="string" id="3931874">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op" id="3931919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3931922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931926">ret</span><span class="op" id="3931929">,</span>&nbsp;<span class="ident" id="3931931">out</span>&nbsp;<span class="op" id="3931935">:=</span>&nbsp;<span class="ident" id="3931938">sliceForAppend</span><span class="op" id="3931952">(</span><span class="ident" id="3931953">dst</span><span class="op" id="3931956">,</span>&nbsp;<span class="builtinfunc" id="3931958">len</span><span class="op" id="3931961">(</span><span class="ident" id="3931962">plaintext</span><span class="op" id="3931971">)</span><span class="op" id="3931972">+</span><span class="ident" id="3931973">gcmTagSize</span><span class="op" id="3931983">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3931987">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932018">var</span>&nbsp;<span class="ident" id="3932022">counter</span><span class="op" id="3932029">,</span>&nbsp;<span class="ident" id="3932031">tagMask</span>&nbsp;<span class="op" id="3932039">[</span><span class="ident" id="3932040">gcmBlockSize</span><span class="op" id="3932052">]</span><span class="builtintype" id="3932053">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3932059">copy</span><span class="op" id="3932063">(</span><span class="ident" id="3932064">counter</span><span class="op" id="3932071">[</span><span class="op" id="3932072">:</span><span class="op" id="3932073">]</span><span class="op" id="3932074">,</span>&nbsp;<span class="ident" id="3932076">nonce</span><span class="op" id="3932081">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932084">counter</span><span class="op" id="3932091">[</span><span class="ident" id="3932092">gcmBlockSize</span><span class="op" id="3932104">-</span><span class="num" id="3932105">1</span><span class="op" id="3932106">]</span>&nbsp;<span class="op" id="3932108">=</span>&nbsp;<span class="num" id="3932110">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932114">g</span><span class="op" id="3932115">.</span><span class="ident" id="3932116">cipher</span><span class="op" id="3932122">.</span><span class="ident" id="3932123">Encrypt</span><span class="op" id="3932130">(</span><span class="ident" id="3932131">tagMask</span><span class="op" id="3932138">[</span><span class="op" id="3932139">:</span><span class="op" id="3932140">]</span><span class="op" id="3932141">,</span>&nbsp;<span class="ident" id="3932143">counter</span><span class="op" id="3932150">[</span><span class="op" id="3932151">:</span><span class="op" id="3932152">]</span><span class="op" id="3932153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932156">gcmInc32</span><span class="op" id="3932164">(</span><span class="op" id="3932165">&amp;</span><span class="ident" id="3932166">counter</span><span class="op" id="3932173">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932177">g</span><span class="op" id="3932178">.</span><span class="ident" id="3932179">counterCrypt</span><span class="op" id="3932191">(</span><span class="ident" id="3932192">out</span><span class="op" id="3932195">,</span>&nbsp;<span class="ident" id="3932197">plaintext</span><span class="op" id="3932206">,</span>&nbsp;<span class="op" id="3932208">&amp;</span><span class="ident" id="3932209">counter</span><span class="op" id="3932216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932219">g</span><span class="op" id="3932220">.</span><span class="ident" id="3932221">auth</span><span class="op" id="3932225">(</span><span class="ident" id="3932226">out</span><span class="op" id="3932229">[</span><span class="builtinfunc" id="3932230">len</span><span class="op" id="3932233">(</span><span class="ident" id="3932234">plaintext</span><span class="op" id="3932243">)</span><span class="op" id="3932244">:</span><span class="op" id="3932245">]</span><span class="op" id="3932246">,</span>&nbsp;<span class="ident" id="3932248">out</span><span class="op" id="3932251">[</span><span class="op" id="3932252">:</span><span class="builtinfunc" id="3932253">len</span><span class="op" id="3932256">(</span><span class="ident" id="3932257">plaintext</span><span class="op" id="3932266">)</span><span class="op" id="3932267">]</span><span class="op" id="3932268">,</span>&nbsp;<span class="ident" id="3932270">data</span><span class="op" id="3932274">,</span>&nbsp;<span class="op" id="3932276">&amp;</span><span class="ident" id="3932277">tagMask</span><span class="op" id="3932284">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932288">return</span>&nbsp;<span class="ident" id="3932295">ret</span><br>
<span class="lineno"></span><span class="op" id="3932299">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="3932302">var</span>&nbsp;<span class="ident" id="3932306">errOpen</span>&nbsp;<span class="op" id="3932314">=</span>&nbsp;<span class="ident" id="3932316">errors</span><span class="op" id="3932322">.</span><span class="ident" id="3932323">New</span><span class="op" id="3932326">(</span><span class="string" id="3932327">&#34;cipher:&nbsp;message&nbsp;authentication&nbsp;failed&#34;</span><span class="op" id="3932366">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3932369">func</span>&nbsp;<span class="op" id="3932374">(</span><span class="ident" id="3932375">g</span>&nbsp;<span class="op" id="3932377">*</span><span class="ident" id="3932378">gcm</span><span class="op" id="3932381">)</span>&nbsp;<span class="ident" id="3932383">Open</span><span class="op" id="3932387">(</span><span class="ident" id="3932388">dst</span><span class="op" id="3932391">,</span>&nbsp;<span class="ident" id="3932393">nonce</span><span class="op" id="3932398">,</span>&nbsp;<span class="ident" id="3932400">ciphertext</span><span class="op" id="3932410">,</span>&nbsp;<span class="ident" id="3932412">data</span>&nbsp;<span class="op" id="3932417">[</span><span class="op" id="3932418">]</span><span class="builtintype" id="3932419">byte</span><span class="op" id="3932423">)</span>&nbsp;<span class="op" id="3932425">(</span><span class="op" id="3932426">[</span><span class="op" id="3932427">]</span><span class="builtintype" id="3932428">byte</span><span class="op" id="3932432">,</span>&nbsp;<span class="builtintype" id="3932434">error</span><span class="op" id="3932439">)</span>&nbsp;<span class="op" id="3932441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932444">if</span>&nbsp;<span class="builtinfunc" id="3932447">len</span><span class="op" id="3932450">(</span><span class="ident" id="3932451">nonce</span><span class="op" id="3932456">)</span>&nbsp;<span class="op" id="3932458">!=</span>&nbsp;<span class="ident" id="3932461">gcmNonceSize</span>&nbsp;<span class="op" id="3932474">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3932478">panic</span><span class="op" id="3932483">(</span><span class="string" id="3932484">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op" id="3932529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3932532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932536">if</span>&nbsp;<span class="builtinfunc" id="3932539">len</span><span class="op" id="3932542">(</span><span class="ident" id="3932543">ciphertext</span><span class="op" id="3932553">)</span>&nbsp;<span class="op" id="3932555">&lt;</span>&nbsp;<span class="ident" id="3932557">gcmTagSize</span>&nbsp;<span class="op" id="3932568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932572">return</span>&nbsp;<span class="ident" id="3932579">nil</span><span class="op" id="3932582">,</span>&nbsp;<span class="ident" id="3932584">errOpen</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3932593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932596">tag</span>&nbsp;<span class="op" id="3932600">:=</span>&nbsp;<span class="ident" id="3932603">ciphertext</span><span class="op" id="3932613">[</span><span class="builtinfunc" id="3932614">len</span><span class="op" id="3932617">(</span><span class="ident" id="3932618">ciphertext</span><span class="op" id="3932628">)</span><span class="op" id="3932629">-</span><span class="ident" id="3932630">gcmTagSize</span><span class="op" id="3932640">:</span><span class="op" id="3932641">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932644">ciphertext</span>&nbsp;<span class="op" id="3932655">=</span>&nbsp;<span class="ident" id="3932657">ciphertext</span><span class="op" id="3932667">[</span><span class="op" id="3932668">:</span><span class="builtinfunc" id="3932669">len</span><span class="op" id="3932672">(</span><span class="ident" id="3932673">ciphertext</span><span class="op" id="3932683">)</span><span class="op" id="3932684">-</span><span class="ident" id="3932685">gcmTagSize</span><span class="op" id="3932695">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3932699">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932730">var</span>&nbsp;<span class="ident" id="3932734">counter</span><span class="op" id="3932741">,</span>&nbsp;<span class="ident" id="3932743">tagMask</span>&nbsp;<span class="op" id="3932751">[</span><span class="ident" id="3932752">gcmBlockSize</span><span class="op" id="3932764">]</span><span class="builtintype" id="3932765">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3932771">copy</span><span class="op" id="3932775">(</span><span class="ident" id="3932776">counter</span><span class="op" id="3932783">[</span><span class="op" id="3932784">:</span><span class="op" id="3932785">]</span><span class="op" id="3932786">,</span>&nbsp;<span class="ident" id="3932788">nonce</span><span class="op" id="3932793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932796">counter</span><span class="op" id="3932803">[</span><span class="ident" id="3932804">gcmBlockSize</span><span class="op" id="3932816">-</span><span class="num" id="3932817">1</span><span class="op" id="3932818">]</span>&nbsp;<span class="op" id="3932820">=</span>&nbsp;<span class="num" id="3932822">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932826">g</span><span class="op" id="3932827">.</span><span class="ident" id="3932828">cipher</span><span class="op" id="3932834">.</span><span class="ident" id="3932835">Encrypt</span><span class="op" id="3932842">(</span><span class="ident" id="3932843">tagMask</span><span class="op" id="3932850">[</span><span class="op" id="3932851">:</span><span class="op" id="3932852">]</span><span class="op" id="3932853">,</span>&nbsp;<span class="ident" id="3932855">counter</span><span class="op" id="3932862">[</span><span class="op" id="3932863">:</span><span class="op" id="3932864">]</span><span class="op" id="3932865">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932868">gcmInc32</span><span class="op" id="3932876">(</span><span class="op" id="3932877">&amp;</span><span class="ident" id="3932878">counter</span><span class="op" id="3932885">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932889">var</span>&nbsp;<span class="ident" id="3932893">expectedTag</span>&nbsp;<span class="op" id="3932905">[</span><span class="ident" id="3932906">gcmTagSize</span><span class="op" id="3932916">]</span><span class="builtintype" id="3932917">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932923">g</span><span class="op" id="3932924">.</span><span class="ident" id="3932925">auth</span><span class="op" id="3932929">(</span><span class="ident" id="3932930">expectedTag</span><span class="op" id="3932941">[</span><span class="op" id="3932942">:</span><span class="op" id="3932943">]</span><span class="op" id="3932944">,</span>&nbsp;<span class="ident" id="3932946">ciphertext</span><span class="op" id="3932956">,</span>&nbsp;<span class="ident" id="3932958">data</span><span class="op" id="3932962">,</span>&nbsp;<span class="op" id="3932964">&amp;</span><span class="ident" id="3932965">tagMask</span><span class="op" id="3932972">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932976">if</span>&nbsp;<span class="ident" id="3932979">subtle</span><span class="op" id="3932985">.</span><span class="ident" id="3932986">ConstantTimeCompare</span><span class="op" id="3933005">(</span><span class="ident" id="3933006">expectedTag</span><span class="op" id="3933017">[</span><span class="op" id="3933018">:</span><span class="op" id="3933019">]</span><span class="op" id="3933020">,</span>&nbsp;<span class="ident" id="3933022">tag</span><span class="op" id="3933025">)</span>&nbsp;<span class="op" id="3933027">!=</span>&nbsp;<span class="num" id="3933030">1</span>&nbsp;<span class="op" id="3933032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933036">return</span>&nbsp;<span class="ident" id="3933043">nil</span><span class="op" id="3933046">,</span>&nbsp;<span class="ident" id="3933048">errOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933061">ret</span><span class="op" id="3933064">,</span>&nbsp;<span class="ident" id="3933066">out</span>&nbsp;<span class="op" id="3933070">:=</span>&nbsp;<span class="ident" id="3933073">sliceForAppend</span><span class="op" id="3933087">(</span><span class="ident" id="3933088">dst</span><span class="op" id="3933091">,</span>&nbsp;<span class="builtinfunc" id="3933093">len</span><span class="op" id="3933096">(</span><span class="ident" id="3933097">ciphertext</span><span class="op" id="3933107">)</span><span class="op" id="3933108">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933111">g</span><span class="op" id="3933112">.</span><span class="ident" id="3933113">counterCrypt</span><span class="op" id="3933125">(</span><span class="ident" id="3933126">out</span><span class="op" id="3933129">,</span>&nbsp;<span class="ident" id="3933131">ciphertext</span><span class="op" id="3933141">,</span>&nbsp;<span class="op" id="3933143">&amp;</span><span class="ident" id="3933144">counter</span><span class="op" id="3933151">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933155">return</span>&nbsp;<span class="ident" id="3933162">ret</span><span class="op" id="3933165">,</span>&nbsp;<span class="ident" id="3933167">nil</span><br>
<span class="lineno"></span><span class="op" id="3933171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="3933174">//&nbsp;reverseBits&nbsp;reverses&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;bits&nbsp;of&nbsp;4-bit&nbsp;number&nbsp;in&nbsp;i.</span><br>
<span class="lineno"></span><span class="keyword" id="3933242">func</span>&nbsp;<span class="ident" id="3933247">reverseBits</span><span class="op" id="3933258">(</span><span class="ident" id="3933259">i</span>&nbsp;<span class="builtintype" id="3933261">int</span><span class="op" id="3933264">)</span>&nbsp;<span class="builtintype" id="3933266">int</span>&nbsp;<span class="op" id="3933270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933273">i</span>&nbsp;<span class="op" id="3933275">=</span>&nbsp;<span class="op" id="3933277">(</span><span class="op" id="3933278">(</span><span class="ident" id="3933279">i</span>&nbsp;<span class="op" id="3933281">&lt;&lt;</span>&nbsp;<span class="num" id="3933284">2</span><span class="op" id="3933285">)</span>&nbsp;<span class="op" id="3933287">&amp;</span>&nbsp;<span class="num" id="3933289">0xc</span><span class="op" id="3933292">)</span>&nbsp;<span class="op" id="3933294">|</span>&nbsp;<span class="op" id="3933296">(</span><span class="op" id="3933297">(</span><span class="ident" id="3933298">i</span>&nbsp;<span class="op" id="3933300">&gt;&gt;</span>&nbsp;<span class="num" id="3933303">2</span><span class="op" id="3933304">)</span>&nbsp;<span class="op" id="3933306">&amp;</span>&nbsp;<span class="num" id="3933308">0x3</span><span class="op" id="3933311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933314">i</span>&nbsp;<span class="op" id="3933316">=</span>&nbsp;<span class="op" id="3933318">(</span><span class="op" id="3933319">(</span><span class="ident" id="3933320">i</span>&nbsp;<span class="op" id="3933322">&lt;&lt;</span>&nbsp;<span class="num" id="3933325">1</span><span class="op" id="3933326">)</span>&nbsp;<span class="op" id="3933328">&amp;</span>&nbsp;<span class="num" id="3933330">0xa</span><span class="op" id="3933333">)</span>&nbsp;<span class="op" id="3933335">|</span>&nbsp;<span class="op" id="3933337">(</span><span class="op" id="3933338">(</span><span class="ident" id="3933339">i</span>&nbsp;<span class="op" id="3933341">&gt;&gt;</span>&nbsp;<span class="num" id="3933344">1</span><span class="op" id="3933345">)</span>&nbsp;<span class="op" id="3933347">&amp;</span>&nbsp;<span class="num" id="3933349">0x5</span><span class="op" id="3933352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933355">return</span>&nbsp;<span class="ident" id="3933362">i</span><br>
<span class="lineno">165</span><span class="op" id="3933364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3933367">//&nbsp;gcmAdd&nbsp;adds&nbsp;two&nbsp;elements&nbsp;of&nbsp;GF(2¹²⁸)&nbsp;and&nbsp;returns&nbsp;the&nbsp;sum.</span><br>
<span class="lineno"></span><span class="keyword" id="3933432">func</span>&nbsp;<span class="ident" id="3933437">gcmAdd</span><span class="op" id="3933443">(</span><span class="ident" id="3933444">x</span><span class="op" id="3933445">,</span>&nbsp;<span class="ident" id="3933447">y</span>&nbsp;<span class="op" id="3933449">*</span><span class="ident" id="3933450">gcmFieldElement</span><span class="op" id="3933465">)</span>&nbsp;<span class="ident" id="3933467">gcmFieldElement</span>&nbsp;<span class="op" id="3933483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3933486">//&nbsp;Addition&nbsp;in&nbsp;a&nbsp;characteristic&nbsp;2&nbsp;field&nbsp;is&nbsp;just&nbsp;XOR.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933540">return</span>&nbsp;<span class="ident" id="3933547">gcmFieldElement</span><span class="op" id="3933562">{</span><span class="ident" id="3933563">x</span><span class="op" id="3933564">.</span><span class="ident" id="3933565">low</span>&nbsp;<span class="op" id="3933569">^</span>&nbsp;<span class="ident" id="3933571">y</span><span class="op" id="3933572">.</span><span class="ident" id="3933573">low</span><span class="op" id="3933576">,</span>&nbsp;<span class="ident" id="3933578">x</span><span class="op" id="3933579">.</span><span class="ident" id="3933580">high</span>&nbsp;<span class="op" id="3933585">^</span>&nbsp;<span class="ident" id="3933587">y</span><span class="op" id="3933588">.</span><span class="ident" id="3933589">high</span><span class="op" id="3933593">}</span><br>
<span class="lineno"></span><span class="op" id="3933595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3933598">//&nbsp;gcmDouble&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;doubling&nbsp;an&nbsp;element&nbsp;of&nbsp;GF(2¹²⁸).</span><br>
<span class="lineno"></span><span class="keyword" id="3933670">func</span>&nbsp;<span class="ident" id="3933675">gcmDouble</span><span class="op" id="3933684">(</span><span class="ident" id="3933685">x</span>&nbsp;<span class="op" id="3933687">*</span><span class="ident" id="3933688">gcmFieldElement</span><span class="op" id="3933703">)</span>&nbsp;<span class="op" id="3933705">(</span><span class="ident" id="3933706">double</span>&nbsp;<span class="ident" id="3933713">gcmFieldElement</span><span class="op" id="3933728">)</span>&nbsp;<span class="op" id="3933730">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933733">msbSet</span>&nbsp;<span class="op" id="3933740">:=</span>&nbsp;<span class="ident" id="3933743">x</span><span class="op" id="3933744">.</span><span class="ident" id="3933745">high</span><span class="op" id="3933749">&amp;</span><span class="num" id="3933750">1</span>&nbsp;<span class="op" id="3933752">==</span>&nbsp;<span class="num" id="3933755">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3933759">//&nbsp;Because&nbsp;of&nbsp;the&nbsp;bit-ordering,&nbsp;doubling&nbsp;is&nbsp;actually&nbsp;a&nbsp;right&nbsp;shift.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933828">double</span><span class="op" id="3933834">.</span><span class="ident" id="3933835">high</span>&nbsp;<span class="op" id="3933840">=</span>&nbsp;<span class="ident" id="3933842">x</span><span class="op" id="3933843">.</span><span class="ident" id="3933844">high</span>&nbsp;<span class="op" id="3933849">&gt;&gt;</span>&nbsp;<span class="num" id="3933852">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933855">double</span><span class="op" id="3933861">.</span><span class="ident" id="3933862">high</span>&nbsp;<span class="op" id="3933867">|=</span>&nbsp;<span class="ident" id="3933870">x</span><span class="op" id="3933871">.</span><span class="ident" id="3933872">low</span>&nbsp;<span class="op" id="3933876">&lt;&lt;</span>&nbsp;<span class="num" id="3933879">63</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933883">double</span><span class="op" id="3933889">.</span><span class="ident" id="3933890">low</span>&nbsp;<span class="op" id="3933894">=</span>&nbsp;<span class="ident" id="3933896">x</span><span class="op" id="3933897">.</span><span class="ident" id="3933898">low</span>&nbsp;<span class="op" id="3933902">&gt;&gt;</span>&nbsp;<span class="num" id="3933905">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3933909">//&nbsp;If&nbsp;the&nbsp;most-significant&nbsp;bit&nbsp;was&nbsp;set&nbsp;before&nbsp;shifting&nbsp;then&nbsp;it,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3933974">//&nbsp;conceptually,&nbsp;becomes&nbsp;a&nbsp;term&nbsp;of&nbsp;x^128.&nbsp;This&nbsp;is&nbsp;greater&nbsp;than&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3934042">//&nbsp;irreducible&nbsp;polynomial&nbsp;so&nbsp;the&nbsp;result&nbsp;has&nbsp;to&nbsp;be&nbsp;reduced.&nbsp;The</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3934106">//&nbsp;irreducible&nbsp;polynomial&nbsp;is&nbsp;1+x+x^2+x^7+x^128.&nbsp;We&nbsp;can&nbsp;subtract&nbsp;that&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3934179">//&nbsp;eliminate&nbsp;the&nbsp;term&nbsp;at&nbsp;x^128&nbsp;which&nbsp;also&nbsp;means&nbsp;subtracting&nbsp;the&nbsp;other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3934250">//&nbsp;four&nbsp;terms.&nbsp;In&nbsp;characteristic&nbsp;2&nbsp;fields,&nbsp;subtraction&nbsp;==&nbsp;addition&nbsp;==</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3934321">//&nbsp;XOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934330">if</span>&nbsp;<span class="ident" id="3934333">msbSet</span>&nbsp;<span class="op" id="3934340">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934344">double</span><span class="op" id="3934350">.</span><span class="ident" id="3934351">low</span>&nbsp;<span class="op" id="3934355">^=</span>&nbsp;<span class="num" id="3934358">0xe100000000000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934382">return</span><br>
<span class="lineno"></span><span class="op" id="3934389">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="3934392">var</span>&nbsp;<span class="ident" id="3934396">gcmReductionTable</span>&nbsp;<span class="op" id="3934414">=</span>&nbsp;<span class="op" id="3934416">[</span><span class="op" id="3934417">]</span><span class="builtintype" id="3934418">uint16</span><span class="op" id="3934424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3934427">0x0000</span><span class="op" id="3934433">,</span>&nbsp;<span class="num" id="3934435">0x1c20</span><span class="op" id="3934441">,</span>&nbsp;<span class="num" id="3934443">0x3840</span><span class="op" id="3934449">,</span>&nbsp;<span class="num" id="3934451">0x2460</span><span class="op" id="3934457">,</span>&nbsp;<span class="num" id="3934459">0x7080</span><span class="op" id="3934465">,</span>&nbsp;<span class="num" id="3934467">0x6ca0</span><span class="op" id="3934473">,</span>&nbsp;<span class="num" id="3934475">0x48c0</span><span class="op" id="3934481">,</span>&nbsp;<span class="num" id="3934483">0x54e0</span><span class="op" id="3934489">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3934492">0xe100</span><span class="op" id="3934498">,</span>&nbsp;<span class="num" id="3934500">0xfd20</span><span class="op" id="3934506">,</span>&nbsp;<span class="num" id="3934508">0xd940</span><span class="op" id="3934514">,</span>&nbsp;<span class="num" id="3934516">0xc560</span><span class="op" id="3934522">,</span>&nbsp;<span class="num" id="3934524">0x9180</span><span class="op" id="3934530">,</span>&nbsp;<span class="num" id="3934532">0x8da0</span><span class="op" id="3934538">,</span>&nbsp;<span class="num" id="3934540">0xa9c0</span><span class="op" id="3934546">,</span>&nbsp;<span class="num" id="3934548">0xb5e0</span><span class="op" id="3934554">,</span><br>
<span class="lineno"></span><span class="op" id="3934556">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="3934559">//&nbsp;mul&nbsp;sets&nbsp;y&nbsp;to&nbsp;y*H,&nbsp;where&nbsp;H&nbsp;is&nbsp;the&nbsp;GCM&nbsp;key,&nbsp;fixed&nbsp;during&nbsp;NewGCM.</span><br>
<span class="lineno"></span><span class="keyword" id="3934626">func</span>&nbsp;<span class="op" id="3934631">(</span><span class="ident" id="3934632">g</span>&nbsp;<span class="op" id="3934634">*</span><span class="ident" id="3934635">gcm</span><span class="op" id="3934638">)</span>&nbsp;<span class="ident" id="3934640">mul</span><span class="op" id="3934643">(</span><span class="ident" id="3934644">y</span>&nbsp;<span class="op" id="3934646">*</span><span class="ident" id="3934647">gcmFieldElement</span><span class="op" id="3934662">)</span>&nbsp;<span class="op" id="3934664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934667">var</span>&nbsp;<span class="ident" id="3934671">z</span>&nbsp;<span class="ident" id="3934673">gcmFieldElement</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934691">for</span>&nbsp;<span class="ident" id="3934695">i</span>&nbsp;<span class="op" id="3934697">:=</span>&nbsp;<span class="num" id="3934700">0</span><span class="op" id="3934701">;</span>&nbsp;<span class="ident" id="3934703">i</span>&nbsp;<span class="op" id="3934705">&lt;</span>&nbsp;<span class="num" id="3934707">2</span><span class="op" id="3934708">;</span>&nbsp;<span class="ident" id="3934710">i</span><span class="op" id="3934711">++</span>&nbsp;<span class="op" id="3934714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934718">word</span>&nbsp;<span class="op" id="3934723">:=</span>&nbsp;<span class="ident" id="3934726">y</span><span class="op" id="3934727">.</span><span class="ident" id="3934728">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934735">if</span>&nbsp;<span class="ident" id="3934738">i</span>&nbsp;<span class="op" id="3934740">==</span>&nbsp;<span class="num" id="3934743">1</span>&nbsp;<span class="op" id="3934745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934750">word</span>&nbsp;<span class="op" id="3934755">=</span>&nbsp;<span class="ident" id="3934757">y</span><span class="op" id="3934758">.</span><span class="ident" id="3934759">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934765">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3934770">//&nbsp;Multiplication&nbsp;works&nbsp;by&nbsp;multiplying&nbsp;z&nbsp;by&nbsp;16&nbsp;and&nbsp;adding&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3934833">//&nbsp;one&nbsp;of&nbsp;the&nbsp;precomputed&nbsp;multiples&nbsp;of&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934877">for</span>&nbsp;<span class="ident" id="3934881">j</span>&nbsp;<span class="op" id="3934883">:=</span>&nbsp;<span class="num" id="3934886">0</span><span class="op" id="3934887">;</span>&nbsp;<span class="ident" id="3934889">j</span>&nbsp;<span class="op" id="3934891">&lt;</span>&nbsp;<span class="num" id="3934893">64</span><span class="op" id="3934895">;</span>&nbsp;<span class="ident" id="3934897">j</span>&nbsp;<span class="op" id="3934899">+=</span>&nbsp;<span class="num" id="3934902">4</span>&nbsp;<span class="op" id="3934904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934909">msw</span>&nbsp;<span class="op" id="3934913">:=</span>&nbsp;<span class="ident" id="3934916">z</span><span class="op" id="3934917">.</span><span class="ident" id="3934918">high</span>&nbsp;<span class="op" id="3934923">&amp;</span>&nbsp;<span class="num" id="3934925">0xf</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934932">z</span><span class="op" id="3934933">.</span><span class="ident" id="3934934">high</span>&nbsp;<span class="op" id="3934939">&gt;&gt;=</span>&nbsp;<span class="num" id="3934943">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934948">z</span><span class="op" id="3934949">.</span><span class="ident" id="3934950">high</span>&nbsp;<span class="op" id="3934955">|=</span>&nbsp;<span class="ident" id="3934958">z</span><span class="op" id="3934959">.</span><span class="ident" id="3934960">low</span>&nbsp;<span class="op" id="3934964">&lt;&lt;</span>&nbsp;<span class="num" id="3934967">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934973">z</span><span class="op" id="3934974">.</span><span class="ident" id="3934975">low</span>&nbsp;<span class="op" id="3934979">&gt;&gt;=</span>&nbsp;<span class="num" id="3934983">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934988">z</span><span class="op" id="3934989">.</span><span class="ident" id="3934990">low</span>&nbsp;<span class="op" id="3934994">^=</span>&nbsp;<span class="ident" id="3934997">uint64</span><span class="op" id="3935003">(</span><span class="ident" id="3935004">gcmReductionTable</span><span class="op" id="3935021">[</span><span class="ident" id="3935022">msw</span><span class="op" id="3935025">]</span><span class="op" id="3935026">)</span>&nbsp;<span class="op" id="3935028">&lt;&lt;</span>&nbsp;<span class="num" id="3935031">48</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3935038">//&nbsp;the&nbsp;values&nbsp;in&nbsp;|table|&nbsp;are&nbsp;ordered&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3935082">//&nbsp;little-endian&nbsp;bit&nbsp;positions.&nbsp;See&nbsp;the&nbsp;comment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3935133">//&nbsp;in&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935150">t</span>&nbsp;<span class="op" id="3935152">:=</span>&nbsp;<span class="op" id="3935155">&amp;</span><span class="ident" id="3935156">g</span><span class="op" id="3935157">.</span><span class="ident" id="3935158">productTable</span><span class="op" id="3935170">[</span><span class="ident" id="3935171">word</span><span class="op" id="3935175">&amp;</span><span class="num" id="3935176">0xf</span><span class="op" id="3935179">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935185">z</span><span class="op" id="3935186">.</span><span class="ident" id="3935187">low</span>&nbsp;<span class="op" id="3935191">^=</span>&nbsp;<span class="ident" id="3935194">t</span><span class="op" id="3935195">.</span><span class="ident" id="3935196">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935203">z</span><span class="op" id="3935204">.</span><span class="ident" id="3935205">high</span>&nbsp;<span class="op" id="3935210">^=</span>&nbsp;<span class="ident" id="3935213">t</span><span class="op" id="3935214">.</span><span class="ident" id="3935215">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935223">word</span>&nbsp;<span class="op" id="3935228">&gt;&gt;=</span>&nbsp;<span class="num" id="3935232">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3935236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3935239">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3935243">*</span><span class="ident" id="3935244">y</span>&nbsp;<span class="op" id="3935246">=</span>&nbsp;<span class="ident" id="3935248">z</span><br>
<span class="lineno"></span><span class="op" id="3935250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3935253">//&nbsp;updateBlocks&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;blocks,&nbsp;based&nbsp;on</span><br>
<span class="lineno">235</span><span class="comment" id="3935328">//&nbsp;Horner&#39;s&nbsp;rule.&nbsp;There&nbsp;must&nbsp;be&nbsp;a&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;in&nbsp;blocks.</span><br>
<span class="lineno"></span><span class="keyword" id="3935404">func</span>&nbsp;<span class="op" id="3935409">(</span><span class="ident" id="3935410">g</span>&nbsp;<span class="op" id="3935412">*</span><span class="ident" id="3935413">gcm</span><span class="op" id="3935416">)</span>&nbsp;<span class="ident" id="3935418">updateBlocks</span><span class="op" id="3935430">(</span><span class="ident" id="3935431">y</span>&nbsp;<span class="op" id="3935433">*</span><span class="ident" id="3935434">gcmFieldElement</span><span class="op" id="3935449">,</span>&nbsp;<span class="ident" id="3935451">blocks</span>&nbsp;<span class="op" id="3935458">[</span><span class="op" id="3935459">]</span><span class="builtintype" id="3935460">byte</span><span class="op" id="3935464">)</span>&nbsp;<span class="op" id="3935466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935469">for</span>&nbsp;<span class="builtinfunc" id="3935473">len</span><span class="op" id="3935476">(</span><span class="ident" id="3935477">blocks</span><span class="op" id="3935483">)</span>&nbsp;<span class="op" id="3935485">&gt;</span>&nbsp;<span class="num" id="3935487">0</span>&nbsp;<span class="op" id="3935489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935493">y</span><span class="op" id="3935494">.</span><span class="ident" id="3935495">low</span>&nbsp;<span class="op" id="3935499">^=</span>&nbsp;<span class="ident" id="3935502">getUint64</span><span class="op" id="3935511">(</span><span class="ident" id="3935512">blocks</span><span class="op" id="3935518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935522">y</span><span class="op" id="3935523">.</span><span class="ident" id="3935524">high</span>&nbsp;<span class="op" id="3935529">^=</span>&nbsp;<span class="ident" id="3935532">getUint64</span><span class="op" id="3935541">(</span><span class="ident" id="3935542">blocks</span><span class="op" id="3935548">[</span><span class="num" id="3935549">8</span><span class="op" id="3935550">:</span><span class="op" id="3935551">]</span><span class="op" id="3935552">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935556">g</span><span class="op" id="3935557">.</span><span class="ident" id="3935558">mul</span><span class="op" id="3935561">(</span><span class="ident" id="3935562">y</span><span class="op" id="3935563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935567">blocks</span>&nbsp;<span class="op" id="3935574">=</span>&nbsp;<span class="ident" id="3935576">blocks</span><span class="op" id="3935582">[</span><span class="ident" id="3935583">gcmBlockSize</span><span class="op" id="3935595">:</span><span class="op" id="3935596">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3935599">}</span><br>
<span class="lineno"></span><span class="op" id="3935601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="comment" id="3935604">//&nbsp;update&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;data.&nbsp;If&nbsp;data&nbsp;is&nbsp;not&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3935679">//&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;long&nbsp;then&nbsp;the&nbsp;remainder&nbsp;is&nbsp;zero&nbsp;padded.</span><br>
<span class="lineno"></span><span class="keyword" id="3935753">func</span>&nbsp;<span class="op" id="3935758">(</span><span class="ident" id="3935759">g</span>&nbsp;<span class="op" id="3935761">*</span><span class="ident" id="3935762">gcm</span><span class="op" id="3935765">)</span>&nbsp;<span class="ident" id="3935767">update</span><span class="op" id="3935773">(</span><span class="ident" id="3935774">y</span>&nbsp;<span class="op" id="3935776">*</span><span class="ident" id="3935777">gcmFieldElement</span><span class="op" id="3935792">,</span>&nbsp;<span class="ident" id="3935794">data</span>&nbsp;<span class="op" id="3935799">[</span><span class="op" id="3935800">]</span><span class="builtintype" id="3935801">byte</span><span class="op" id="3935805">)</span>&nbsp;<span class="op" id="3935807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935810">fullBlocks</span>&nbsp;<span class="op" id="3935821">:=</span>&nbsp;<span class="op" id="3935824">(</span><span class="builtinfunc" id="3935825">len</span><span class="op" id="3935828">(</span><span class="ident" id="3935829">data</span><span class="op" id="3935833">)</span>&nbsp;<span class="op" id="3935835">&gt;&gt;</span>&nbsp;<span class="num" id="3935838">4</span><span class="op" id="3935839">)</span>&nbsp;<span class="op" id="3935841">&lt;&lt;</span>&nbsp;<span class="num" id="3935844">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935847">g</span><span class="op" id="3935848">.</span><span class="ident" id="3935849">updateBlocks</span><span class="op" id="3935861">(</span><span class="ident" id="3935862">y</span><span class="op" id="3935863">,</span>&nbsp;<span class="ident" id="3935865">data</span><span class="op" id="3935869">[</span><span class="op" id="3935870">:</span><span class="ident" id="3935871">fullBlocks</span><span class="op" id="3935881">]</span><span class="op" id="3935882">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935886">if</span>&nbsp;<span class="builtinfunc" id="3935889">len</span><span class="op" id="3935892">(</span><span class="ident" id="3935893">data</span><span class="op" id="3935897">)</span>&nbsp;<span class="op" id="3935899">!=</span>&nbsp;<span class="ident" id="3935902">fullBlocks</span>&nbsp;<span class="op" id="3935913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935917">var</span>&nbsp;<span class="ident" id="3935921">partialBlock</span>&nbsp;<span class="op" id="3935934">[</span><span class="ident" id="3935935">gcmBlockSize</span><span class="op" id="3935947">]</span><span class="builtintype" id="3935948">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3935955">copy</span><span class="op" id="3935959">(</span><span class="ident" id="3935960">partialBlock</span><span class="op" id="3935972">[</span><span class="op" id="3935973">:</span><span class="op" id="3935974">]</span><span class="op" id="3935975">,</span>&nbsp;<span class="ident" id="3935977">data</span><span class="op" id="3935981">[</span><span class="ident" id="3935982">fullBlocks</span><span class="op" id="3935992">:</span><span class="op" id="3935993">]</span><span class="op" id="3935994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935998">g</span><span class="op" id="3935999">.</span><span class="ident" id="3936000">updateBlocks</span><span class="op" id="3936012">(</span><span class="ident" id="3936013">y</span><span class="op" id="3936014">,</span>&nbsp;<span class="ident" id="3936016">partialBlock</span><span class="op" id="3936028">[</span><span class="op" id="3936029">:</span><span class="op" id="3936030">]</span><span class="op" id="3936031">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936034">}</span><br>
<span class="lineno"></span><span class="op" id="3936036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3936039">//&nbsp;gcmInc32&nbsp;treats&nbsp;the&nbsp;final&nbsp;four&nbsp;bytes&nbsp;of&nbsp;counterBlock&nbsp;as&nbsp;a&nbsp;big-endian&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3936117">//&nbsp;and&nbsp;increments&nbsp;it.</span><br>
<span class="lineno">260</span><span class="keyword" id="3936139">func</span>&nbsp;<span class="ident" id="3936144">gcmInc32</span><span class="op" id="3936152">(</span><span class="ident" id="3936153">counterBlock</span>&nbsp;<span class="op" id="3936166">*</span><span class="op" id="3936167">[</span><span class="num" id="3936168">16</span><span class="op" id="3936170">]</span><span class="builtintype" id="3936171">byte</span><span class="op" id="3936175">)</span>&nbsp;<span class="op" id="3936177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936180">for</span>&nbsp;<span class="ident" id="3936184">i</span>&nbsp;<span class="op" id="3936186">:=</span>&nbsp;<span class="ident" id="3936189">gcmBlockSize</span>&nbsp;<span class="op" id="3936202">-</span>&nbsp;<span class="num" id="3936204">1</span><span class="op" id="3936205">;</span>&nbsp;<span class="ident" id="3936207">i</span>&nbsp;<span class="op" id="3936209">&gt;=</span>&nbsp;<span class="ident" id="3936212">gcmBlockSize</span><span class="op" id="3936224">-</span><span class="num" id="3936225">4</span><span class="op" id="3936226">;</span>&nbsp;<span class="ident" id="3936228">i</span><span class="op" id="3936229">--</span>&nbsp;<span class="op" id="3936232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936236">counterBlock</span><span class="op" id="3936248">[</span><span class="ident" id="3936249">i</span><span class="op" id="3936250">]</span><span class="op" id="3936251">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936256">if</span>&nbsp;<span class="ident" id="3936259">counterBlock</span><span class="op" id="3936271">[</span><span class="ident" id="3936272">i</span><span class="op" id="3936273">]</span>&nbsp;<span class="op" id="3936275">!=</span>&nbsp;<span class="num" id="3936278">0</span>&nbsp;<span class="op" id="3936280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936285">break</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936296">}</span><br>
<span class="lineno"></span><span class="op" id="3936298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3936301">//&nbsp;sliceForAppend&nbsp;takes&nbsp;a&nbsp;slice&nbsp;and&nbsp;a&nbsp;requested&nbsp;number&nbsp;of&nbsp;bytes.&nbsp;It&nbsp;returns&nbsp;a</span><br>
<span class="lineno">270</span><span class="comment" id="3936379">//&nbsp;slice&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;given&nbsp;slice&nbsp;followed&nbsp;by&nbsp;that&nbsp;many&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3936459">//&nbsp;second&nbsp;slice&nbsp;that&nbsp;aliases&nbsp;into&nbsp;it&nbsp;and&nbsp;contains&nbsp;only&nbsp;the&nbsp;extra&nbsp;bytes.&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3936538">//&nbsp;original&nbsp;slice&nbsp;has&nbsp;sufficient&nbsp;capacity&nbsp;then&nbsp;no&nbsp;allocation&nbsp;is&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="3936613">func</span>&nbsp;<span class="ident" id="3936618">sliceForAppend</span><span class="op" id="3936632">(</span><span class="ident" id="3936633">in</span>&nbsp;<span class="op" id="3936636">[</span><span class="op" id="3936637">]</span><span class="builtintype" id="3936638">byte</span><span class="op" id="3936642">,</span>&nbsp;<span class="ident" id="3936644">n</span>&nbsp;<span class="builtintype" id="3936646">int</span><span class="op" id="3936649">)</span>&nbsp;<span class="op" id="3936651">(</span><span class="ident" id="3936652">head</span><span class="op" id="3936656">,</span>&nbsp;<span class="ident" id="3936658">tail</span>&nbsp;<span class="op" id="3936663">[</span><span class="op" id="3936664">]</span><span class="builtintype" id="3936665">byte</span><span class="op" id="3936669">)</span>&nbsp;<span class="op" id="3936671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936674">if</span>&nbsp;<span class="ident" id="3936677">total</span>&nbsp;<span class="op" id="3936683">:=</span>&nbsp;<span class="builtinfunc" id="3936686">len</span><span class="op" id="3936689">(</span><span class="ident" id="3936690">in</span><span class="op" id="3936692">)</span>&nbsp;<span class="op" id="3936694">+</span>&nbsp;<span class="ident" id="3936696">n</span><span class="op" id="3936697">;</span>&nbsp;<span class="builtinfunc" id="3936699">cap</span><span class="op" id="3936702">(</span><span class="ident" id="3936703">in</span><span class="op" id="3936705">)</span>&nbsp;<span class="op" id="3936707">&gt;=</span>&nbsp;<span class="ident" id="3936710">total</span>&nbsp;<span class="op" id="3936716">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936720">head</span>&nbsp;<span class="op" id="3936725">=</span>&nbsp;<span class="ident" id="3936727">in</span><span class="op" id="3936729">[</span><span class="op" id="3936730">:</span><span class="ident" id="3936731">total</span><span class="op" id="3936736">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936739">}</span>&nbsp;<span class="keyword" id="3936741">else</span>&nbsp;<span class="op" id="3936746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936750">head</span>&nbsp;<span class="op" id="3936755">=</span>&nbsp;<span class="builtinfunc" id="3936757">make</span><span class="op" id="3936761">(</span><span class="op" id="3936762">[</span><span class="op" id="3936763">]</span><span class="builtintype" id="3936764">byte</span><span class="op" id="3936768">,</span>&nbsp;<span class="ident" id="3936770">total</span><span class="op" id="3936775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3936779">copy</span><span class="op" id="3936783">(</span><span class="ident" id="3936784">head</span><span class="op" id="3936788">,</span>&nbsp;<span class="ident" id="3936790">in</span><span class="op" id="3936792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936795">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936798">tail</span>&nbsp;<span class="op" id="3936803">=</span>&nbsp;<span class="ident" id="3936805">head</span><span class="op" id="3936809">[</span><span class="builtinfunc" id="3936810">len</span><span class="op" id="3936813">(</span><span class="ident" id="3936814">in</span><span class="op" id="3936816">)</span><span class="op" id="3936817">:</span><span class="op" id="3936818">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936821">return</span><br>
<span class="lineno"></span><span class="op" id="3936828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3936831">//&nbsp;counterCrypt&nbsp;crypts&nbsp;in&nbsp;to&nbsp;out&nbsp;using&nbsp;g.cipher&nbsp;in&nbsp;counter&nbsp;mode.</span><br>
<span class="lineno">285</span><span class="keyword" id="3936896">func</span>&nbsp;<span class="op" id="3936901">(</span><span class="ident" id="3936902">g</span>&nbsp;<span class="op" id="3936904">*</span><span class="ident" id="3936905">gcm</span><span class="op" id="3936908">)</span>&nbsp;<span class="ident" id="3936910">counterCrypt</span><span class="op" id="3936922">(</span><span class="ident" id="3936923">out</span><span class="op" id="3936926">,</span>&nbsp;<span class="ident" id="3936928">in</span>&nbsp;<span class="op" id="3936931">[</span><span class="op" id="3936932">]</span><span class="builtintype" id="3936933">byte</span><span class="op" id="3936937">,</span>&nbsp;<span class="ident" id="3936939">counter</span>&nbsp;<span class="op" id="3936947">*</span><span class="op" id="3936948">[</span><span class="ident" id="3936949">gcmBlockSize</span><span class="op" id="3936961">]</span><span class="builtintype" id="3936962">byte</span><span class="op" id="3936966">)</span>&nbsp;<span class="op" id="3936968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936971">var</span>&nbsp;<span class="ident" id="3936975">mask</span>&nbsp;<span class="op" id="3936980">[</span><span class="ident" id="3936981">gcmBlockSize</span><span class="op" id="3936993">]</span><span class="builtintype" id="3936994">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937001">for</span>&nbsp;<span class="builtinfunc" id="3937005">len</span><span class="op" id="3937008">(</span><span class="ident" id="3937009">in</span><span class="op" id="3937011">)</span>&nbsp;<span class="op" id="3937013">&gt;=</span>&nbsp;<span class="ident" id="3937016">gcmBlockSize</span>&nbsp;<span class="op" id="3937029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937033">g</span><span class="op" id="3937034">.</span><span class="ident" id="3937035">cipher</span><span class="op" id="3937041">.</span><span class="ident" id="3937042">Encrypt</span><span class="op" id="3937049">(</span><span class="ident" id="3937050">mask</span><span class="op" id="3937054">[</span><span class="op" id="3937055">:</span><span class="op" id="3937056">]</span><span class="op" id="3937057">,</span>&nbsp;<span class="ident" id="3937059">counter</span><span class="op" id="3937066">[</span><span class="op" id="3937067">:</span><span class="op" id="3937068">]</span><span class="op" id="3937069">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937073">gcmInc32</span><span class="op" id="3937081">(</span><span class="ident" id="3937082">counter</span><span class="op" id="3937089">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937094">xorWords</span><span class="op" id="3937102">(</span><span class="ident" id="3937103">out</span><span class="op" id="3937106">,</span>&nbsp;<span class="ident" id="3937108">in</span><span class="op" id="3937110">,</span>&nbsp;<span class="ident" id="3937112">mask</span><span class="op" id="3937116">[</span><span class="op" id="3937117">:</span><span class="op" id="3937118">]</span><span class="op" id="3937119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937123">out</span>&nbsp;<span class="op" id="3937127">=</span>&nbsp;<span class="ident" id="3937129">out</span><span class="op" id="3937132">[</span><span class="ident" id="3937133">gcmBlockSize</span><span class="op" id="3937145">:</span><span class="op" id="3937146">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937150">in</span>&nbsp;<span class="op" id="3937153">=</span>&nbsp;<span class="ident" id="3937155">in</span><span class="op" id="3937157">[</span><span class="ident" id="3937158">gcmBlockSize</span><span class="op" id="3937170">:</span><span class="op" id="3937171">]</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937178">if</span>&nbsp;<span class="builtinfunc" id="3937181">len</span><span class="op" id="3937184">(</span><span class="ident" id="3937185">in</span><span class="op" id="3937187">)</span>&nbsp;<span class="op" id="3937189">&gt;</span>&nbsp;<span class="num" id="3937191">0</span>&nbsp;<span class="op" id="3937193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937197">g</span><span class="op" id="3937198">.</span><span class="ident" id="3937199">cipher</span><span class="op" id="3937205">.</span><span class="ident" id="3937206">Encrypt</span><span class="op" id="3937213">(</span><span class="ident" id="3937214">mask</span><span class="op" id="3937218">[</span><span class="op" id="3937219">:</span><span class="op" id="3937220">]</span><span class="op" id="3937221">,</span>&nbsp;<span class="ident" id="3937223">counter</span><span class="op" id="3937230">[</span><span class="op" id="3937231">:</span><span class="op" id="3937232">]</span><span class="op" id="3937233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937237">gcmInc32</span><span class="op" id="3937245">(</span><span class="ident" id="3937246">counter</span><span class="op" id="3937253">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937257">xorBytes</span><span class="op" id="3937265">(</span><span class="ident" id="3937266">out</span><span class="op" id="3937269">,</span>&nbsp;<span class="ident" id="3937271">in</span><span class="op" id="3937273">,</span>&nbsp;<span class="ident" id="3937275">mask</span><span class="op" id="3937279">[</span><span class="op" id="3937280">:</span><span class="op" id="3937281">]</span><span class="op" id="3937282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937285">}</span><br>
<span class="lineno"></span><span class="op" id="3937287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3937290">//&nbsp;auth&nbsp;calculates&nbsp;GHASH(ciphertext,&nbsp;additionalData),&nbsp;masks&nbsp;the&nbsp;result&nbsp;with</span><br>
<span class="lineno">305</span><span class="comment" id="3937366">//&nbsp;tagMask&nbsp;and&nbsp;writes&nbsp;the&nbsp;result&nbsp;to&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3937407">func</span>&nbsp;<span class="op" id="3937412">(</span><span class="ident" id="3937413">g</span>&nbsp;<span class="op" id="3937415">*</span><span class="ident" id="3937416">gcm</span><span class="op" id="3937419">)</span>&nbsp;<span class="ident" id="3937421">auth</span><span class="op" id="3937425">(</span><span class="ident" id="3937426">out</span><span class="op" id="3937429">,</span>&nbsp;<span class="ident" id="3937431">ciphertext</span><span class="op" id="3937441">,</span>&nbsp;<span class="ident" id="3937443">additionalData</span>&nbsp;<span class="op" id="3937458">[</span><span class="op" id="3937459">]</span><span class="builtintype" id="3937460">byte</span><span class="op" id="3937464">,</span>&nbsp;<span class="ident" id="3937466">tagMask</span>&nbsp;<span class="op" id="3937474">*</span><span class="op" id="3937475">[</span><span class="ident" id="3937476">gcmTagSize</span><span class="op" id="3937486">]</span><span class="builtintype" id="3937487">byte</span><span class="op" id="3937491">)</span>&nbsp;<span class="op" id="3937493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937496">var</span>&nbsp;<span class="ident" id="3937500">y</span>&nbsp;<span class="ident" id="3937502">gcmFieldElement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937519">g</span><span class="op" id="3937520">.</span><span class="ident" id="3937521">update</span><span class="op" id="3937527">(</span><span class="op" id="3937528">&amp;</span><span class="ident" id="3937529">y</span><span class="op" id="3937530">,</span>&nbsp;<span class="ident" id="3937532">additionalData</span><span class="op" id="3937546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937549">g</span><span class="op" id="3937550">.</span><span class="ident" id="3937551">update</span><span class="op" id="3937557">(</span><span class="op" id="3937558">&amp;</span><span class="ident" id="3937559">y</span><span class="op" id="3937560">,</span>&nbsp;<span class="ident" id="3937562">ciphertext</span><span class="op" id="3937572">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937576">y</span><span class="op" id="3937577">.</span><span class="ident" id="3937578">low</span>&nbsp;<span class="op" id="3937582">^=</span>&nbsp;<span class="ident" id="3937585">uint64</span><span class="op" id="3937591">(</span><span class="builtinfunc" id="3937592">len</span><span class="op" id="3937595">(</span><span class="ident" id="3937596">additionalData</span><span class="op" id="3937610">)</span><span class="op" id="3937611">)</span>&nbsp;<span class="op" id="3937613">*</span>&nbsp;<span class="num" id="3937615">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937618">y</span><span class="op" id="3937619">.</span><span class="ident" id="3937620">high</span>&nbsp;<span class="op" id="3937625">^=</span>&nbsp;<span class="ident" id="3937628">uint64</span><span class="op" id="3937634">(</span><span class="builtinfunc" id="3937635">len</span><span class="op" id="3937638">(</span><span class="ident" id="3937639">ciphertext</span><span class="op" id="3937649">)</span><span class="op" id="3937650">)</span>&nbsp;<span class="op" id="3937652">*</span>&nbsp;<span class="num" id="3937654">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937658">g</span><span class="op" id="3937659">.</span><span class="ident" id="3937660">mul</span><span class="op" id="3937663">(</span><span class="op" id="3937664">&amp;</span><span class="ident" id="3937665">y</span><span class="op" id="3937666">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937670">putUint64</span><span class="op" id="3937679">(</span><span class="ident" id="3937680">out</span><span class="op" id="3937683">,</span>&nbsp;<span class="ident" id="3937685">y</span><span class="op" id="3937686">.</span><span class="ident" id="3937687">low</span><span class="op" id="3937690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937693">putUint64</span><span class="op" id="3937702">(</span><span class="ident" id="3937703">out</span><span class="op" id="3937706">[</span><span class="num" id="3937707">8</span><span class="op" id="3937708">:</span><span class="op" id="3937709">]</span><span class="op" id="3937710">,</span>&nbsp;<span class="ident" id="3937712">y</span><span class="op" id="3937713">.</span><span class="ident" id="3937714">high</span><span class="op" id="3937718">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937722">xorWords</span><span class="op" id="3937730">(</span><span class="ident" id="3937731">out</span><span class="op" id="3937734">,</span>&nbsp;<span class="ident" id="3937736">out</span><span class="op" id="3937739">,</span>&nbsp;<span class="ident" id="3937741">tagMask</span><span class="op" id="3937748">[</span><span class="op" id="3937749">:</span><span class="op" id="3937750">]</span><span class="op" id="3937751">)</span><br>
<span class="lineno">320</span><span class="op" id="3937753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3937756">func</span>&nbsp;<span class="ident" id="3937761">getUint64</span><span class="op" id="3937770">(</span><span class="ident" id="3937771">data</span>&nbsp;<span class="op" id="3937776">[</span><span class="op" id="3937777">]</span><span class="builtintype" id="3937778">byte</span><span class="op" id="3937782">)</span>&nbsp;<span class="ident" id="3937784">uint64</span>&nbsp;<span class="op" id="3937791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937794">r</span>&nbsp;<span class="op" id="3937796">:=</span>&nbsp;<span class="ident" id="3937799">uint64</span><span class="op" id="3937805">(</span><span class="ident" id="3937806">data</span><span class="op" id="3937810">[</span><span class="num" id="3937811">0</span><span class="op" id="3937812">]</span><span class="op" id="3937813">)</span><span class="op" id="3937814">&lt;&lt;</span><span class="num" id="3937816">56</span>&nbsp;<span class="op" id="3937819">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937823">uint64</span><span class="op" id="3937829">(</span><span class="ident" id="3937830">data</span><span class="op" id="3937834">[</span><span class="num" id="3937835">1</span><span class="op" id="3937836">]</span><span class="op" id="3937837">)</span><span class="op" id="3937838">&lt;&lt;</span><span class="num" id="3937840">48</span>&nbsp;<span class="op" id="3937843">|</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937847">uint64</span><span class="op" id="3937853">(</span><span class="ident" id="3937854">data</span><span class="op" id="3937858">[</span><span class="num" id="3937859">2</span><span class="op" id="3937860">]</span><span class="op" id="3937861">)</span><span class="op" id="3937862">&lt;&lt;</span><span class="num" id="3937864">40</span>&nbsp;<span class="op" id="3937867">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937871">uint64</span><span class="op" id="3937877">(</span><span class="ident" id="3937878">data</span><span class="op" id="3937882">[</span><span class="num" id="3937883">3</span><span class="op" id="3937884">]</span><span class="op" id="3937885">)</span><span class="op" id="3937886">&lt;&lt;</span><span class="num" id="3937888">32</span>&nbsp;<span class="op" id="3937891">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937895">uint64</span><span class="op" id="3937901">(</span><span class="ident" id="3937902">data</span><span class="op" id="3937906">[</span><span class="num" id="3937907">4</span><span class="op" id="3937908">]</span><span class="op" id="3937909">)</span><span class="op" id="3937910">&lt;&lt;</span><span class="num" id="3937912">24</span>&nbsp;<span class="op" id="3937915">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937919">uint64</span><span class="op" id="3937925">(</span><span class="ident" id="3937926">data</span><span class="op" id="3937930">[</span><span class="num" id="3937931">5</span><span class="op" id="3937932">]</span><span class="op" id="3937933">)</span><span class="op" id="3937934">&lt;&lt;</span><span class="num" id="3937936">16</span>&nbsp;<span class="op" id="3937939">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937943">uint64</span><span class="op" id="3937949">(</span><span class="ident" id="3937950">data</span><span class="op" id="3937954">[</span><span class="num" id="3937955">6</span><span class="op" id="3937956">]</span><span class="op" id="3937957">)</span><span class="op" id="3937958">&lt;&lt;</span><span class="num" id="3937960">8</span>&nbsp;<span class="op" id="3937962">|</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937966">uint64</span><span class="op" id="3937972">(</span><span class="ident" id="3937973">data</span><span class="op" id="3937977">[</span><span class="num" id="3937978">7</span><span class="op" id="3937979">]</span><span class="op" id="3937980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937983">return</span>&nbsp;<span class="ident" id="3937990">r</span><br>
<span class="lineno"></span><span class="op" id="3937992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3937995">func</span>&nbsp;<span class="ident" id="3938000">putUint64</span><span class="op" id="3938009">(</span><span class="ident" id="3938010">out</span>&nbsp;<span class="op" id="3938014">[</span><span class="op" id="3938015">]</span><span class="builtintype" id="3938016">byte</span><span class="op" id="3938020">,</span>&nbsp;<span class="ident" id="3938022">v</span>&nbsp;<span class="ident" id="3938024">uint64</span><span class="op" id="3938030">)</span>&nbsp;<span class="op" id="3938032">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938035">out</span><span class="op" id="3938038">[</span><span class="num" id="3938039">0</span><span class="op" id="3938040">]</span>&nbsp;<span class="op" id="3938042">=</span>&nbsp;<span class="builtintype" id="3938044">byte</span><span class="op" id="3938048">(</span><span class="ident" id="3938049">v</span>&nbsp;<span class="op" id="3938051">&gt;&gt;</span>&nbsp;<span class="num" id="3938054">56</span><span class="op" id="3938056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938059">out</span><span class="op" id="3938062">[</span><span class="num" id="3938063">1</span><span class="op" id="3938064">]</span>&nbsp;<span class="op" id="3938066">=</span>&nbsp;<span class="builtintype" id="3938068">byte</span><span class="op" id="3938072">(</span><span class="ident" id="3938073">v</span>&nbsp;<span class="op" id="3938075">&gt;&gt;</span>&nbsp;<span class="num" id="3938078">48</span><span class="op" id="3938080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938083">out</span><span class="op" id="3938086">[</span><span class="num" id="3938087">2</span><span class="op" id="3938088">]</span>&nbsp;<span class="op" id="3938090">=</span>&nbsp;<span class="builtintype" id="3938092">byte</span><span class="op" id="3938096">(</span><span class="ident" id="3938097">v</span>&nbsp;<span class="op" id="3938099">&gt;&gt;</span>&nbsp;<span class="num" id="3938102">40</span><span class="op" id="3938104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938107">out</span><span class="op" id="3938110">[</span><span class="num" id="3938111">3</span><span class="op" id="3938112">]</span>&nbsp;<span class="op" id="3938114">=</span>&nbsp;<span class="builtintype" id="3938116">byte</span><span class="op" id="3938120">(</span><span class="ident" id="3938121">v</span>&nbsp;<span class="op" id="3938123">&gt;&gt;</span>&nbsp;<span class="num" id="3938126">32</span><span class="op" id="3938128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938131">out</span><span class="op" id="3938134">[</span><span class="num" id="3938135">4</span><span class="op" id="3938136">]</span>&nbsp;<span class="op" id="3938138">=</span>&nbsp;<span class="builtintype" id="3938140">byte</span><span class="op" id="3938144">(</span><span class="ident" id="3938145">v</span>&nbsp;<span class="op" id="3938147">&gt;&gt;</span>&nbsp;<span class="num" id="3938150">24</span><span class="op" id="3938152">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938155">out</span><span class="op" id="3938158">[</span><span class="num" id="3938159">5</span><span class="op" id="3938160">]</span>&nbsp;<span class="op" id="3938162">=</span>&nbsp;<span class="builtintype" id="3938164">byte</span><span class="op" id="3938168">(</span><span class="ident" id="3938169">v</span>&nbsp;<span class="op" id="3938171">&gt;&gt;</span>&nbsp;<span class="num" id="3938174">16</span><span class="op" id="3938176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938179">out</span><span class="op" id="3938182">[</span><span class="num" id="3938183">6</span><span class="op" id="3938184">]</span>&nbsp;<span class="op" id="3938186">=</span>&nbsp;<span class="builtintype" id="3938188">byte</span><span class="op" id="3938192">(</span><span class="ident" id="3938193">v</span>&nbsp;<span class="op" id="3938195">&gt;&gt;</span>&nbsp;<span class="num" id="3938198">8</span><span class="op" id="3938199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938202">out</span><span class="op" id="3938205">[</span><span class="num" id="3938206">7</span><span class="op" id="3938207">]</span>&nbsp;<span class="op" id="3938209">=</span>&nbsp;<span class="builtintype" id="3938211">byte</span><span class="op" id="3938215">(</span><span class="ident" id="3938216">v</span><span class="op" id="3938217">)</span><br>
<span class="lineno"></span><span class="op" id="3938219">}</span>
</div>
</body>
</html>
