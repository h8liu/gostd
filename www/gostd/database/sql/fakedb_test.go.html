<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6596972">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6597027">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6597081">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6597132">package</span>&nbsp;<span class="ident" id="6597140">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6597145">import</span>&nbsp;<span class="op" id="6597152">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6597155">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6597178">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6597188">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6597195">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6597201">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6597208">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6597216">&#34;strconv&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6597227">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6597238">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6597246">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6597257">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6597264">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="6597267">var</span>&nbsp;<span class="ident" id="6597271">_</span>&nbsp;<span class="op" id="6597273">=</span>&nbsp;<span class="ident" id="6597275">log</span><span class="op" id="6597278">.</span><span class="ident" id="6597279">Printf</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6597287">//&nbsp;fakeDriver&nbsp;is&nbsp;a&nbsp;fake&nbsp;database&nbsp;that&nbsp;implements&nbsp;Go&#39;s&nbsp;driver.Driver</span><br>
<span class="lineno"></span><span class="comment" id="6597355">//&nbsp;interface,&nbsp;just&nbsp;for&nbsp;testing.</span><br>
<span class="lineno">25</span><span class="comment" id="6597387">//</span><br>
<span class="lineno"></span><span class="comment" id="6597390">//&nbsp;It&nbsp;speaks&nbsp;a&nbsp;query&nbsp;language&nbsp;that&#39;s&nbsp;semantically&nbsp;similar&nbsp;to&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="6597455">//&nbsp;syntactically&nbsp;different&nbsp;and&nbsp;simpler&nbsp;than&nbsp;SQL.&nbsp;&nbsp;The&nbsp;syntax&nbsp;is&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="6597522">//&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="6597534">//</span><br>
<span class="lineno">30</span><span class="comment" id="6597537">//&nbsp;&nbsp;&nbsp;WIPE</span><br>
<span class="lineno"></span><span class="comment" id="6597547">//&nbsp;&nbsp;&nbsp;CREATE|&lt;tablename&gt;|&lt;col&gt;=&lt;type&gt;,&lt;col&gt;=&lt;type&gt;,...</span><br>
<span class="lineno"></span><span class="comment" id="6597601">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;types&nbsp;are:&nbsp;&#34;string&#34;,&nbsp;[u]int{8,16,32,64},&nbsp;&#34;bool&#34;</span><br>
<span class="lineno"></span><span class="comment" id="6597662">//&nbsp;&nbsp;&nbsp;INSERT|&lt;tablename&gt;|col=val,col2=val2,col3=?</span><br>
<span class="lineno"></span><span class="comment" id="6597711">//&nbsp;&nbsp;&nbsp;SELECT|&lt;tablename&gt;|projectcol1,projectcol2|filtercol=?,filtercol2=?</span><br>
<span class="lineno">35</span><span class="comment" id="6597784">//</span><br>
<span class="lineno"></span><span class="comment" id="6597787">//&nbsp;When&nbsp;opening&nbsp;a&nbsp;fakeDriver&#39;s&nbsp;database,&nbsp;it&nbsp;starts&nbsp;empty&nbsp;with&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="6597852">//&nbsp;tables.&nbsp;&nbsp;All&nbsp;tables&nbsp;and&nbsp;data&nbsp;are&nbsp;stored&nbsp;in&nbsp;memory&nbsp;only.</span><br>
<span class="lineno"></span><span class="keyword" id="6597911">type</span>&nbsp;<span class="ident" id="6597916">fakeDriver</span>&nbsp;<span class="keyword" id="6597927">struct</span>&nbsp;<span class="op" id="6597934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6597937">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6597948">sync</span><span class="op" id="6597952">.</span><span class="ident" id="6597953">Mutex</span>&nbsp;<span class="comment" id="6597959">//&nbsp;guards&nbsp;3&nbsp;following&nbsp;fields</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6597989">openCount</span>&nbsp;&nbsp;<span class="builtintype" id="6598000">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6598011">//&nbsp;conn&nbsp;opens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598026">closeCount</span>&nbsp;<span class="builtintype" id="6598037">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6598048">//&nbsp;conn&nbsp;closes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598064">waitCh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6598075">chan</span>&nbsp;<span class="keyword" id="6598080">struct</span><span class="op" id="6598086">{</span><span class="op" id="6598087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598090">waitingCh</span>&nbsp;&nbsp;<span class="keyword" id="6598101">chan</span>&nbsp;<span class="keyword" id="6598106">struct</span><span class="op" id="6598112">{</span><span class="op" id="6598113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598116">dbs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6598127">map</span><span class="op" id="6598130">[</span><span class="builtintype" id="6598131">string</span><span class="op" id="6598137">]</span><span class="op" id="6598138">*</span><span class="ident" id="6598139">fakeDB</span><br>
<span class="lineno">45</span><span class="op" id="6598146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6598149">type</span>&nbsp;<span class="ident" id="6598154">fakeDB</span>&nbsp;<span class="keyword" id="6598161">struct</span>&nbsp;<span class="op" id="6598168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598171">name</span>&nbsp;<span class="builtintype" id="6598176">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598185">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6598193">sync</span><span class="op" id="6598197">.</span><span class="ident" id="6598198">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598205">free</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6598213">[</span><span class="op" id="6598214">]</span><span class="op" id="6598215">*</span><span class="ident" id="6598216">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598226">tables</span>&nbsp;&nbsp;<span class="keyword" id="6598234">map</span><span class="op" id="6598237">[</span><span class="builtintype" id="6598238">string</span><span class="op" id="6598244">]</span><span class="op" id="6598245">*</span><span class="ident" id="6598246">table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598253">badConn</span>&nbsp;<span class="builtintype" id="6598261">bool</span><br>
<span class="lineno"></span><span class="op" id="6598266">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="6598269">type</span>&nbsp;<span class="ident" id="6598274">table</span>&nbsp;<span class="keyword" id="6598280">struct</span>&nbsp;<span class="op" id="6598287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598290">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6598298">sync</span><span class="op" id="6598302">.</span><span class="ident" id="6598303">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598310">colname</span>&nbsp;<span class="op" id="6598318">[</span><span class="op" id="6598319">]</span><span class="builtintype" id="6598320">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598328">coltype</span>&nbsp;<span class="op" id="6598336">[</span><span class="op" id="6598337">]</span><span class="builtintype" id="6598338">string</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598346">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6598354">[</span><span class="op" id="6598355">]</span><span class="op" id="6598356">*</span><span class="ident" id="6598357">row</span><br>
<span class="lineno"></span><span class="op" id="6598361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6598364">func</span>&nbsp;<span class="op" id="6598369">(</span><span class="ident" id="6598370">t</span>&nbsp;<span class="op" id="6598372">*</span><span class="ident" id="6598373">table</span><span class="op" id="6598378">)</span>&nbsp;<span class="ident" id="6598380">columnIndex</span><span class="op" id="6598391">(</span><span class="ident" id="6598392">name</span>&nbsp;<span class="builtintype" id="6598397">string</span><span class="op" id="6598403">)</span>&nbsp;<span class="builtintype" id="6598405">int</span>&nbsp;<span class="op" id="6598409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6598412">for</span>&nbsp;<span class="ident" id="6598416">n</span><span class="op" id="6598417">,</span>&nbsp;<span class="ident" id="6598419">nname</span>&nbsp;<span class="op" id="6598425">:=</span>&nbsp;<span class="keyword" id="6598428">range</span>&nbsp;<span class="ident" id="6598434">t</span><span class="op" id="6598435">.</span><span class="ident" id="6598436">colname</span>&nbsp;<span class="op" id="6598444">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6598448">if</span>&nbsp;<span class="ident" id="6598451">name</span>&nbsp;<span class="op" id="6598456">==</span>&nbsp;<span class="ident" id="6598459">nname</span>&nbsp;<span class="op" id="6598465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6598470">return</span>&nbsp;<span class="ident" id="6598477">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6598481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6598484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6598487">return</span>&nbsp;<span class="op" id="6598494">-</span><span class="num" id="6598495">1</span><br>
<span class="lineno">70</span><span class="op" id="6598497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6598500">type</span>&nbsp;<span class="ident" id="6598505">row</span>&nbsp;<span class="keyword" id="6598509">struct</span>&nbsp;<span class="op" id="6598516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598519">cols</span>&nbsp;<span class="op" id="6598524">[</span><span class="op" id="6598525">]</span><span class="keyword" id="6598526">interface</span><span class="op" id="6598535">{</span><span class="op" id="6598536">}</span>&nbsp;<span class="comment" id="6598538">//&nbsp;must&nbsp;be&nbsp;same&nbsp;size&nbsp;as&nbsp;its&nbsp;table&nbsp;colname&nbsp;+&nbsp;coltype</span><br>
<span class="lineno"></span><span class="op" id="6598590">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="6598593">func</span>&nbsp;<span class="op" id="6598598">(</span><span class="ident" id="6598599">r</span>&nbsp;<span class="op" id="6598601">*</span><span class="ident" id="6598602">row</span><span class="op" id="6598605">)</span>&nbsp;<span class="ident" id="6598607">clone</span><span class="op" id="6598612">(</span><span class="op" id="6598613">)</span>&nbsp;<span class="op" id="6598615">*</span><span class="ident" id="6598616">row</span>&nbsp;<span class="op" id="6598620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598623">nrow</span>&nbsp;<span class="op" id="6598628">:=</span>&nbsp;<span class="op" id="6598631">&amp;</span><span class="ident" id="6598632">row</span><span class="op" id="6598635">{</span><span class="ident" id="6598636">cols</span><span class="op" id="6598640">:</span>&nbsp;<span class="builtinfunc" id="6598642">make</span><span class="op" id="6598646">(</span><span class="op" id="6598647">[</span><span class="op" id="6598648">]</span><span class="keyword" id="6598649">interface</span><span class="op" id="6598658">{</span><span class="op" id="6598659">}</span><span class="op" id="6598660">,</span>&nbsp;<span class="builtinfunc" id="6598662">len</span><span class="op" id="6598665">(</span><span class="ident" id="6598666">r</span><span class="op" id="6598667">.</span><span class="ident" id="6598668">cols</span><span class="op" id="6598672">)</span><span class="op" id="6598673">)</span><span class="op" id="6598674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6598677">copy</span><span class="op" id="6598681">(</span><span class="ident" id="6598682">nrow</span><span class="op" id="6598686">.</span><span class="ident" id="6598687">cols</span><span class="op" id="6598691">,</span>&nbsp;<span class="ident" id="6598693">r</span><span class="op" id="6598694">.</span><span class="ident" id="6598695">cols</span><span class="op" id="6598699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6598702">return</span>&nbsp;<span class="ident" id="6598709">nrow</span><br>
<span class="lineno">80</span><span class="op" id="6598714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6598717">type</span>&nbsp;<span class="ident" id="6598722">fakeConn</span>&nbsp;<span class="keyword" id="6598731">struct</span>&nbsp;<span class="op" id="6598738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598741">db</span>&nbsp;<span class="op" id="6598744">*</span><span class="ident" id="6598745">fakeDB</span>&nbsp;<span class="comment" id="6598752">//&nbsp;where&nbsp;to&nbsp;return&nbsp;ourselves&nbsp;to</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598786">currTx</span>&nbsp;<span class="op" id="6598793">*</span><span class="ident" id="6598794">fakeTx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6598803">//&nbsp;Stats&nbsp;for&nbsp;tests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598824">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6598836">sync</span><span class="op" id="6598840">.</span><span class="ident" id="6598841">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598848">stmtsMade</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6598860">int</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598865">stmtsClosed</span>&nbsp;<span class="builtintype" id="6598877">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598882">numPrepare</span>&nbsp;&nbsp;<span class="builtintype" id="6598894">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598899">bad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6598911">bool</span><br>
<span class="lineno"></span><span class="op" id="6598916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="6598919">func</span>&nbsp;<span class="op" id="6598924">(</span><span class="ident" id="6598925">c</span>&nbsp;<span class="op" id="6598927">*</span><span class="ident" id="6598928">fakeConn</span><span class="op" id="6598936">)</span>&nbsp;<span class="ident" id="6598938">incrStat</span><span class="op" id="6598946">(</span><span class="ident" id="6598947">v</span>&nbsp;<span class="op" id="6598949">*</span><span class="builtintype" id="6598950">int</span><span class="op" id="6598953">)</span>&nbsp;<span class="op" id="6598955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598958">c</span><span class="op" id="6598959">.</span><span class="ident" id="6598960">mu</span><span class="op" id="6598962">.</span><span class="ident" id="6598963">Lock</span><span class="op" id="6598967">(</span><span class="op" id="6598968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6598971">*</span><span class="ident" id="6598972">v</span><span class="op" id="6598973">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6598977">c</span><span class="op" id="6598978">.</span><span class="ident" id="6598979">mu</span><span class="op" id="6598981">.</span><span class="ident" id="6598982">Unlock</span><span class="op" id="6598988">(</span><span class="op" id="6598989">)</span><br>
<span class="lineno"></span><span class="op" id="6598991">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="6598994">type</span>&nbsp;<span class="ident" id="6598999">fakeTx</span>&nbsp;<span class="keyword" id="6599006">struct</span>&nbsp;<span class="op" id="6599013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599016">c</span>&nbsp;<span class="op" id="6599018">*</span><span class="ident" id="6599019">fakeConn</span><br>
<span class="lineno"></span><span class="op" id="6599028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="6599031">type</span>&nbsp;<span class="ident" id="6599036">fakeStmt</span>&nbsp;<span class="keyword" id="6599045">struct</span>&nbsp;<span class="op" id="6599052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599055">c</span>&nbsp;<span class="op" id="6599057">*</span><span class="ident" id="6599058">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599068">q</span>&nbsp;<span class="builtintype" id="6599070">string</span>&nbsp;<span class="comment" id="6599077">//&nbsp;just&nbsp;for&nbsp;debugging</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599101">cmd</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6599107">string</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599115">table</span>&nbsp;<span class="builtintype" id="6599121">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599130">closed</span>&nbsp;<span class="builtintype" id="6599137">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599144">colName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6599157">[</span><span class="op" id="6599158">]</span><span class="builtintype" id="6599159">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6599171">//&nbsp;used&nbsp;by&nbsp;CREATE,&nbsp;INSERT,&nbsp;SELECT&nbsp;(selected&nbsp;columns)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599225">colType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6599238">[</span><span class="op" id="6599239">]</span><span class="builtintype" id="6599240">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6599252">//&nbsp;used&nbsp;by&nbsp;CREATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599271">colValue</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6599284">[</span><span class="op" id="6599285">]</span><span class="keyword" id="6599286">interface</span><span class="op" id="6599295">{</span><span class="op" id="6599296">}</span>&nbsp;<span class="comment" id="6599298">//&nbsp;used&nbsp;by&nbsp;INSERT&nbsp;(mix&nbsp;of&nbsp;strings&nbsp;and&nbsp;&#34;?&#34;&nbsp;for&nbsp;bound&nbsp;params)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599359">placeholders</span>&nbsp;<span class="builtintype" id="6599372">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6599386">//&nbsp;used&nbsp;by&nbsp;INSERT/SELECT:&nbsp;number&nbsp;of&nbsp;?&nbsp;params</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599433">whereCol</span>&nbsp;<span class="op" id="6599442">[</span><span class="op" id="6599443">]</span><span class="builtintype" id="6599444">string</span>&nbsp;<span class="comment" id="6599451">//&nbsp;used&nbsp;by&nbsp;SELECT&nbsp;(all&nbsp;placeholders)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599490">placeholderConverter</span>&nbsp;<span class="op" id="6599511">[</span><span class="op" id="6599512">]</span><span class="ident" id="6599513">driver</span><span class="op" id="6599519">.</span><span class="ident" id="6599520">ValueConverter</span>&nbsp;<span class="comment" id="6599535">//&nbsp;used&nbsp;by&nbsp;INSERT</span><br>
<span class="lineno"></span><span class="op" id="6599553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6599556">var</span>&nbsp;<span class="ident" id="6599560">fdriver</span>&nbsp;<span class="ident" id="6599568">driver</span><span class="op" id="6599574">.</span><span class="ident" id="6599575">Driver</span>&nbsp;<span class="op" id="6599582">=</span>&nbsp;<span class="op" id="6599584">&amp;</span><span class="ident" id="6599585">fakeDriver</span><span class="op" id="6599595">{</span><span class="op" id="6599596">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="6599599">func</span>&nbsp;<span class="ident" id="6599604">init</span><span class="op" id="6599608">(</span><span class="op" id="6599609">)</span>&nbsp;<span class="op" id="6599611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599614">Register</span><span class="op" id="6599622">(</span><span class="string" id="6599623">&#34;test&#34;</span><span class="op" id="6599629">,</span>&nbsp;<span class="ident" id="6599631">fdriver</span><span class="op" id="6599638">)</span><br>
<span class="lineno"></span><span class="op" id="6599640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="6599643">func</span>&nbsp;<span class="ident" id="6599648">contains</span><span class="op" id="6599656">(</span><span class="ident" id="6599657">list</span>&nbsp;<span class="op" id="6599662">[</span><span class="op" id="6599663">]</span><span class="builtintype" id="6599664">string</span><span class="op" id="6599670">,</span>&nbsp;<span class="ident" id="6599672">y</span>&nbsp;<span class="builtintype" id="6599674">string</span><span class="op" id="6599680">)</span>&nbsp;<span class="builtintype" id="6599682">bool</span>&nbsp;<span class="op" id="6599687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6599690">for</span>&nbsp;<span class="ident" id="6599694">_</span><span class="op" id="6599695">,</span>&nbsp;<span class="ident" id="6599697">x</span>&nbsp;<span class="op" id="6599699">:=</span>&nbsp;<span class="keyword" id="6599702">range</span>&nbsp;<span class="ident" id="6599708">list</span>&nbsp;<span class="op" id="6599713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6599717">if</span>&nbsp;<span class="ident" id="6599720">x</span>&nbsp;<span class="op" id="6599722">==</span>&nbsp;<span class="ident" id="6599725">y</span>&nbsp;<span class="op" id="6599727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6599732">return</span>&nbsp;<span class="builtintype" id="6599739">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6599746">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6599749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6599752">return</span>&nbsp;<span class="builtintype" id="6599759">false</span><br>
<span class="lineno"></span><span class="op" id="6599765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6599768">type</span>&nbsp;<span class="ident" id="6599773">Dummy</span>&nbsp;<span class="keyword" id="6599779">struct</span>&nbsp;<span class="op" id="6599786">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599789">driver</span><span class="op" id="6599795">.</span><span class="ident" id="6599796">Driver</span><br>
<span class="lineno"></span><span class="op" id="6599803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6599806">func</span>&nbsp;<span class="ident" id="6599811">TestDrivers</span><span class="op" id="6599822">(</span><span class="ident" id="6599823">t</span>&nbsp;<span class="op" id="6599825">*</span><span class="ident" id="6599826">testing</span><span class="op" id="6599833">.</span><span class="ident" id="6599834">T</span><span class="op" id="6599835">)</span>&nbsp;<span class="op" id="6599837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599840">unregisterAllDrivers</span><span class="op" id="6599860">(</span><span class="op" id="6599861">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599864">Register</span><span class="op" id="6599872">(</span><span class="string" id="6599873">&#34;test&#34;</span><span class="op" id="6599879">,</span>&nbsp;<span class="ident" id="6599881">fdriver</span><span class="op" id="6599888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599891">Register</span><span class="op" id="6599899">(</span><span class="string" id="6599900">&#34;invalid&#34;</span><span class="op" id="6599909">,</span>&nbsp;<span class="ident" id="6599911">Dummy</span><span class="op" id="6599916">{</span><span class="op" id="6599917">}</span><span class="op" id="6599918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6599921">all</span>&nbsp;<span class="op" id="6599925">:=</span>&nbsp;<span class="ident" id="6599928">Drivers</span><span class="op" id="6599935">(</span><span class="op" id="6599936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6599939">if</span>&nbsp;<span class="builtinfunc" id="6599942">len</span><span class="op" id="6599945">(</span><span class="ident" id="6599946">all</span><span class="op" id="6599949">)</span>&nbsp;<span class="op" id="6599951">&lt;</span>&nbsp;<span class="num" id="6599953">2</span>&nbsp;<span class="op" id="6599955">||</span>&nbsp;<span class="op" id="6599958">!</span><span class="ident" id="6599959">sort</span><span class="op" id="6599963">.</span><span class="ident" id="6599964">StringsAreSorted</span><span class="op" id="6599980">(</span><span class="ident" id="6599981">all</span><span class="op" id="6599984">)</span>&nbsp;<span class="op" id="6599986">||</span>&nbsp;<span class="op" id="6599989">!</span><span class="ident" id="6599990">contains</span><span class="op" id="6599998">(</span><span class="ident" id="6599999">all</span><span class="op" id="6600002">,</span>&nbsp;<span class="string" id="6600004">&#34;test&#34;</span><span class="op" id="6600010">)</span>&nbsp;<span class="op" id="6600012">||</span>&nbsp;<span class="op" id="6600015">!</span><span class="ident" id="6600016">contains</span><span class="op" id="6600024">(</span><span class="ident" id="6600025">all</span><span class="op" id="6600028">,</span>&nbsp;<span class="string" id="6600030">&#34;invalid&#34;</span><span class="op" id="6600039">)</span>&nbsp;<span class="op" id="6600041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6600045">t</span><span class="op" id="6600046">.</span><span class="ident" id="6600047">Fatalf</span><span class="op" id="6600053">(</span><span class="string" id="6600054">&#34;Drivers&nbsp;=&nbsp;%v,&nbsp;want&nbsp;sorted&nbsp;list&nbsp;with&nbsp;at&nbsp;least&nbsp;[invalid,&nbsp;test]&#34;</span><span class="op" id="6600116">,</span>&nbsp;<span class="ident" id="6600118">all</span><span class="op" id="6600121">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6600124">}</span><br>
<span class="lineno"></span><span class="op" id="6600126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6600129">//&nbsp;Supports&nbsp;dsn&nbsp;forms:</span><br>
<span class="lineno"></span><span class="comment" id="6600152">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;</span><br>
<span class="lineno">155</span><span class="comment" id="6600167">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;;&lt;opts&gt;&nbsp;&nbsp;(only&nbsp;currently&nbsp;supported&nbsp;option&nbsp;is&nbsp;`badConn`,</span><br>
<span class="lineno"></span><span class="comment" id="6600237">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;causes&nbsp;driver.ErrBadConn&nbsp;to&nbsp;be&nbsp;returned&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="6600310">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;every&nbsp;other&nbsp;conn.Begin())</span><br>
<span class="lineno"></span><span class="keyword" id="6600360">func</span>&nbsp;<span class="op" id="6600365">(</span><span class="ident" id="6600366">d</span>&nbsp;<span class="op" id="6600368">*</span><span class="ident" id="6600369">fakeDriver</span><span class="op" id="6600379">)</span>&nbsp;<span class="ident" id="6600381">Open</span><span class="op" id="6600385">(</span><span class="ident" id="6600386">dsn</span>&nbsp;<span class="builtintype" id="6600390">string</span><span class="op" id="6600396">)</span>&nbsp;<span class="op" id="6600398">(</span><span class="ident" id="6600399">driver</span><span class="op" id="6600405">.</span><span class="ident" id="6600406">Conn</span><span class="op" id="6600410">,</span>&nbsp;<span class="builtintype" id="6600412">error</span><span class="op" id="6600417">)</span>&nbsp;<span class="op" id="6600419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6600422">parts</span>&nbsp;<span class="op" id="6600428">:=</span>&nbsp;<span class="ident" id="6600431">strings</span><span class="op" id="6600438">.</span><span class="ident" id="6600439">Split</span><span class="op" id="6600444">(</span><span class="ident" id="6600445">dsn</span><span class="op" id="6600448">,</span>&nbsp;<span class="string" id="6600450">&#34;;&#34;</span><span class="op" id="6600453">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6600456">if</span>&nbsp;<span class="builtinfunc" id="6600459">len</span><span class="op" id="6600462">(</span><span class="ident" id="6600463">parts</span><span class="op" id="6600468">)</span>&nbsp;<span class="op" id="6600470">&lt;</span>&nbsp;<span class="num" id="6600472">1</span>&nbsp;<span class="op" id="6600474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6600478">return</span>&nbsp;<span class="ident" id="6600485">nil</span><span class="op" id="6600488">,</span>&nbsp;<span class="ident" id="6600490">errors</span><span class="op" id="6600496">.</span><span class="ident" id="6600497">New</span><span class="op" id="6600500">(</span><span class="string" id="6600501">&#34;fakedb:&nbsp;no&nbsp;database&nbsp;name&#34;</span><span class="op" id="6600527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6600530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6600533">name</span>&nbsp;<span class="op" id="6600538">:=</span>&nbsp;<span class="ident" id="6600541">parts</span><span class="op" id="6600546">[</span><span class="num" id="6600547">0</span><span class="op" id="6600548">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6600552">db</span>&nbsp;<span class="op" id="6600555">:=</span>&nbsp;<span class="ident" id="6600558">d</span><span class="op" id="6600559">.</span><span class="ident" id="6600560">getDB</span><span class="op" id="6600565">(</span><span class="ident" id="6600566">name</span><span class="op" id="6600570">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6600574">d</span><span class="op" id="6600575">.</span><span class="ident" id="6600576">mu</span><span class="op" id="6600578">.</span><span class="ident" id="6600579">Lock</span><span class="op" id="6600583">(</span><span class="op" id="6600584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6600587">d</span><span class="op" id="6600588">.</span><span class="ident" id="6600589">openCount</span><span class="op" id="6600598">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6600602">d</span><span class="op" id="6600603">.</span><span class="ident" id="6600604">mu</span><span class="op" id="6600606">.</span><span class="ident" id="6600607">Unlock</span><span class="op" id="6600613">(</span><span class="op" id="6600614">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6600617">conn</span>&nbsp;<span class="op" id="6600622">:=</span>&nbsp;<span class="op" id="6600625">&amp;</span><span class="ident" id="6600626">fakeConn</span><span class="op" id="6600634">{</span><span class="ident" id="6600635">db</span><span class="op" id="6600637">:</span>&nbsp;<span class="ident" id="6600639">db</span><span class="op" id="6600641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6600645">if</span>&nbsp;<span class="builtinfunc" id="6600648">len</span><span class="op" id="6600651">(</span><span class="ident" id="6600652">parts</span><span class="op" id="6600657">)</span>&nbsp;<span class="op" id="6600659">&gt;=</span>&nbsp;<span class="num" id="6600662">2</span>&nbsp;<span class="op" id="6600664">&amp;&amp;</span>&nbsp;<span class="ident" id="6600667">parts</span><span class="op" id="6600672">[</span><span class="num" id="6600673">1</span><span class="op" id="6600674">]</span>&nbsp;<span class="op" id="6600676">==</span>&nbsp;<span class="string" id="6600679">&#34;badConn&#34;</span>&nbsp;<span class="op" id="6600689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6600693">conn</span><span class="op" id="6600697">.</span><span class="ident" id="6600698">bad</span>&nbsp;<span class="op" id="6600702">=</span>&nbsp;<span class="builtintype" id="6600704">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6600710">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6600713">if</span>&nbsp;<span class="ident" id="6600716">d</span><span class="op" id="6600717">.</span><span class="ident" id="6600718">waitCh</span>&nbsp;<span class="op" id="6600725">!=</span>&nbsp;<span class="ident" id="6600728">nil</span>&nbsp;<span class="op" id="6600732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6600736">d</span><span class="op" id="6600737">.</span><span class="ident" id="6600738">waitingCh</span>&nbsp;<span class="op" id="6600748">&lt;-</span>&nbsp;<span class="keyword" id="6600751">struct</span><span class="op" id="6600757">{</span><span class="op" id="6600758">}</span><span class="op" id="6600759">{</span><span class="op" id="6600760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6600764">&lt;-</span><span class="ident" id="6600766">d</span><span class="op" id="6600767">.</span><span class="ident" id="6600768">waitCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6600777">d</span><span class="op" id="6600778">.</span><span class="ident" id="6600779">waitCh</span>&nbsp;<span class="op" id="6600786">=</span>&nbsp;<span class="ident" id="6600788">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6600794">d</span><span class="op" id="6600795">.</span><span class="ident" id="6600796">waitingCh</span>&nbsp;<span class="op" id="6600806">=</span>&nbsp;<span class="ident" id="6600808">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6600813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6600816">return</span>&nbsp;<span class="ident" id="6600823">conn</span><span class="op" id="6600827">,</span>&nbsp;<span class="ident" id="6600829">nil</span><br>
<span class="lineno"></span><span class="op" id="6600833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6600836">func</span>&nbsp;<span class="op" id="6600841">(</span><span class="ident" id="6600842">d</span>&nbsp;<span class="op" id="6600844">*</span><span class="ident" id="6600845">fakeDriver</span><span class="op" id="6600855">)</span>&nbsp;<span class="ident" id="6600857">getDB</span><span class="op" id="6600862">(</span><span class="ident" id="6600863">name</span>&nbsp;<span class="builtintype" id="6600868">string</span><span class="op" id="6600874">)</span>&nbsp;<span class="op" id="6600876">*</span><span class="ident" id="6600877">fakeDB</span>&nbsp;<span class="op" id="6600884">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6600887">d</span><span class="op" id="6600888">.</span><span class="ident" id="6600889">mu</span><span class="op" id="6600891">.</span><span class="ident" id="6600892">Lock</span><span class="op" id="6600896">(</span><span class="op" id="6600897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6600900">defer</span>&nbsp;<span class="ident" id="6600906">d</span><span class="op" id="6600907">.</span><span class="ident" id="6600908">mu</span><span class="op" id="6600910">.</span><span class="ident" id="6600911">Unlock</span><span class="op" id="6600917">(</span><span class="op" id="6600918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6600921">if</span>&nbsp;<span class="ident" id="6600924">d</span><span class="op" id="6600925">.</span><span class="ident" id="6600926">dbs</span>&nbsp;<span class="op" id="6600930">==</span>&nbsp;<span class="ident" id="6600933">nil</span>&nbsp;<span class="op" id="6600937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6600941">d</span><span class="op" id="6600942">.</span><span class="ident" id="6600943">dbs</span>&nbsp;<span class="op" id="6600947">=</span>&nbsp;<span class="builtinfunc" id="6600949">make</span><span class="op" id="6600953">(</span><span class="keyword" id="6600954">map</span><span class="op" id="6600957">[</span><span class="builtintype" id="6600958">string</span><span class="op" id="6600964">]</span><span class="op" id="6600965">*</span><span class="ident" id="6600966">fakeDB</span><span class="op" id="6600972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6600975">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6600978">db</span><span class="op" id="6600980">,</span>&nbsp;<span class="ident" id="6600982">ok</span>&nbsp;<span class="op" id="6600985">:=</span>&nbsp;<span class="ident" id="6600988">d</span><span class="op" id="6600989">.</span><span class="ident" id="6600990">dbs</span><span class="op" id="6600993">[</span><span class="ident" id="6600994">name</span><span class="op" id="6600998">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6601001">if</span>&nbsp;<span class="op" id="6601004">!</span><span class="ident" id="6601005">ok</span>&nbsp;<span class="op" id="6601008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6601012">db</span>&nbsp;<span class="op" id="6601015">=</span>&nbsp;<span class="op" id="6601017">&amp;</span><span class="ident" id="6601018">fakeDB</span><span class="op" id="6601024">{</span><span class="ident" id="6601025">name</span><span class="op" id="6601029">:</span>&nbsp;<span class="ident" id="6601031">name</span><span class="op" id="6601035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6601039">d</span><span class="op" id="6601040">.</span><span class="ident" id="6601041">dbs</span><span class="op" id="6601044">[</span><span class="ident" id="6601045">name</span><span class="op" id="6601049">]</span>&nbsp;<span class="op" id="6601051">=</span>&nbsp;<span class="ident" id="6601053">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6601057">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6601060">return</span>&nbsp;<span class="ident" id="6601067">db</span><br>
<span class="lineno"></span><span class="op" id="6601070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6601073">func</span>&nbsp;<span class="op" id="6601078">(</span><span class="ident" id="6601079">db</span>&nbsp;<span class="op" id="6601082">*</span><span class="ident" id="6601083">fakeDB</span><span class="op" id="6601089">)</span>&nbsp;<span class="ident" id="6601091">wipe</span><span class="op" id="6601095">(</span><span class="op" id="6601096">)</span>&nbsp;<span class="op" id="6601098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6601101">db</span><span class="op" id="6601103">.</span><span class="ident" id="6601104">mu</span><span class="op" id="6601106">.</span><span class="ident" id="6601107">Lock</span><span class="op" id="6601111">(</span><span class="op" id="6601112">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6601115">defer</span>&nbsp;<span class="ident" id="6601121">db</span><span class="op" id="6601123">.</span><span class="ident" id="6601124">mu</span><span class="op" id="6601126">.</span><span class="ident" id="6601127">Unlock</span><span class="op" id="6601133">(</span><span class="op" id="6601134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6601137">db</span><span class="op" id="6601139">.</span><span class="ident" id="6601140">tables</span>&nbsp;<span class="op" id="6601147">=</span>&nbsp;<span class="ident" id="6601149">nil</span><br>
<span class="lineno"></span><span class="op" id="6601153">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6601156">func</span>&nbsp;<span class="op" id="6601161">(</span><span class="ident" id="6601162">db</span>&nbsp;<span class="op" id="6601165">*</span><span class="ident" id="6601166">fakeDB</span><span class="op" id="6601172">)</span>&nbsp;<span class="ident" id="6601174">createTable</span><span class="op" id="6601185">(</span><span class="ident" id="6601186">name</span>&nbsp;<span class="builtintype" id="6601191">string</span><span class="op" id="6601197">,</span>&nbsp;<span class="ident" id="6601199">columnNames</span><span class="op" id="6601210">,</span>&nbsp;<span class="ident" id="6601212">columnTypes</span>&nbsp;<span class="op" id="6601224">[</span><span class="op" id="6601225">]</span><span class="builtintype" id="6601226">string</span><span class="op" id="6601232">)</span>&nbsp;<span class="builtintype" id="6601234">error</span>&nbsp;<span class="op" id="6601240">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6601243">db</span><span class="op" id="6601245">.</span><span class="ident" id="6601246">mu</span><span class="op" id="6601248">.</span><span class="ident" id="6601249">Lock</span><span class="op" id="6601253">(</span><span class="op" id="6601254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6601257">defer</span>&nbsp;<span class="ident" id="6601263">db</span><span class="op" id="6601265">.</span><span class="ident" id="6601266">mu</span><span class="op" id="6601268">.</span><span class="ident" id="6601269">Unlock</span><span class="op" id="6601275">(</span><span class="op" id="6601276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6601279">if</span>&nbsp;<span class="ident" id="6601282">db</span><span class="op" id="6601284">.</span><span class="ident" id="6601285">tables</span>&nbsp;<span class="op" id="6601292">==</span>&nbsp;<span class="ident" id="6601295">nil</span>&nbsp;<span class="op" id="6601299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6601303">db</span><span class="op" id="6601305">.</span><span class="ident" id="6601306">tables</span>&nbsp;<span class="op" id="6601313">=</span>&nbsp;<span class="builtinfunc" id="6601315">make</span><span class="op" id="6601319">(</span><span class="keyword" id="6601320">map</span><span class="op" id="6601323">[</span><span class="builtintype" id="6601324">string</span><span class="op" id="6601330">]</span><span class="op" id="6601331">*</span><span class="ident" id="6601332">table</span><span class="op" id="6601337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6601340">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6601343">if</span>&nbsp;<span class="ident" id="6601346">_</span><span class="op" id="6601347">,</span>&nbsp;<span class="ident" id="6601349">exist</span>&nbsp;<span class="op" id="6601355">:=</span>&nbsp;<span class="ident" id="6601358">db</span><span class="op" id="6601360">.</span><span class="ident" id="6601361">tables</span><span class="op" id="6601367">[</span><span class="ident" id="6601368">name</span><span class="op" id="6601372">]</span><span class="op" id="6601373">;</span>&nbsp;<span class="ident" id="6601375">exist</span>&nbsp;<span class="op" id="6601381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6601385">return</span>&nbsp;<span class="ident" id="6601392">fmt</span><span class="op" id="6601395">.</span><span class="ident" id="6601396">Errorf</span><span class="op" id="6601402">(</span><span class="string" id="6601403">&#34;table&nbsp;%q&nbsp;already&nbsp;exists&#34;</span><span class="op" id="6601428">,</span>&nbsp;<span class="ident" id="6601430">name</span><span class="op" id="6601434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6601437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6601440">if</span>&nbsp;<span class="builtinfunc" id="6601443">len</span><span class="op" id="6601446">(</span><span class="ident" id="6601447">columnNames</span><span class="op" id="6601458">)</span>&nbsp;<span class="op" id="6601460">!=</span>&nbsp;<span class="builtinfunc" id="6601463">len</span><span class="op" id="6601466">(</span><span class="ident" id="6601467">columnTypes</span><span class="op" id="6601478">)</span>&nbsp;<span class="op" id="6601480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6601484">return</span>&nbsp;<span class="ident" id="6601491">fmt</span><span class="op" id="6601494">.</span><span class="ident" id="6601495">Errorf</span><span class="op" id="6601501">(</span><span class="string" id="6601502">&#34;create&nbsp;table&nbsp;of&nbsp;%q&nbsp;len(names)&nbsp;!=&nbsp;len(types):&nbsp;%d&nbsp;vs&nbsp;%d&#34;</span><span class="op" id="6601557">,</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6601562">name</span><span class="op" id="6601566">,</span>&nbsp;<span class="builtinfunc" id="6601568">len</span><span class="op" id="6601571">(</span><span class="ident" id="6601572">columnNames</span><span class="op" id="6601583">)</span><span class="op" id="6601584">,</span>&nbsp;<span class="builtinfunc" id="6601586">len</span><span class="op" id="6601589">(</span><span class="ident" id="6601590">columnTypes</span><span class="op" id="6601601">)</span><span class="op" id="6601602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6601605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6601608">db</span><span class="op" id="6601610">.</span><span class="ident" id="6601611">tables</span><span class="op" id="6601617">[</span><span class="ident" id="6601618">name</span><span class="op" id="6601622">]</span>&nbsp;<span class="op" id="6601624">=</span>&nbsp;<span class="op" id="6601626">&amp;</span><span class="ident" id="6601627">table</span><span class="op" id="6601632">{</span><span class="ident" id="6601633">colname</span><span class="op" id="6601640">:</span>&nbsp;<span class="ident" id="6601642">columnNames</span><span class="op" id="6601653">,</span>&nbsp;<span class="ident" id="6601655">coltype</span><span class="op" id="6601662">:</span>&nbsp;<span class="ident" id="6601664">columnTypes</span><span class="op" id="6601675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6601678">return</span>&nbsp;<span class="ident" id="6601685">nil</span><br>
<span class="lineno"></span><span class="op" id="6601689">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="6601692">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;db.mu&nbsp;lock&nbsp;held</span><br>
<span class="lineno"></span><span class="keyword" id="6601731">func</span>&nbsp;<span class="op" id="6601736">(</span><span class="ident" id="6601737">db</span>&nbsp;<span class="op" id="6601740">*</span><span class="ident" id="6601741">fakeDB</span><span class="op" id="6601747">)</span>&nbsp;<span class="ident" id="6601749">table</span><span class="op" id="6601754">(</span><span class="ident" id="6601755">table</span>&nbsp;<span class="builtintype" id="6601761">string</span><span class="op" id="6601767">)</span>&nbsp;<span class="op" id="6601769">(</span><span class="op" id="6601770">*</span><span class="ident" id="6601771">table</span><span class="op" id="6601776">,</span>&nbsp;<span class="builtintype" id="6601778">bool</span><span class="op" id="6601782">)</span>&nbsp;<span class="op" id="6601784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6601787">if</span>&nbsp;<span class="ident" id="6601790">db</span><span class="op" id="6601792">.</span><span class="ident" id="6601793">tables</span>&nbsp;<span class="op" id="6601800">==</span>&nbsp;<span class="ident" id="6601803">nil</span>&nbsp;<span class="op" id="6601807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6601811">return</span>&nbsp;<span class="ident" id="6601818">nil</span><span class="op" id="6601821">,</span>&nbsp;<span class="builtintype" id="6601823">false</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6601830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6601833">t</span><span class="op" id="6601834">,</span>&nbsp;<span class="ident" id="6601836">ok</span>&nbsp;<span class="op" id="6601839">:=</span>&nbsp;<span class="ident" id="6601842">db</span><span class="op" id="6601844">.</span><span class="ident" id="6601845">tables</span><span class="op" id="6601851">[</span><span class="ident" id="6601852">table</span><span class="op" id="6601857">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6601860">return</span>&nbsp;<span class="ident" id="6601867">t</span><span class="op" id="6601868">,</span>&nbsp;<span class="ident" id="6601870">ok</span><br>
<span class="lineno"></span><span class="op" id="6601873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="6601876">func</span>&nbsp;<span class="op" id="6601881">(</span><span class="ident" id="6601882">db</span>&nbsp;<span class="op" id="6601885">*</span><span class="ident" id="6601886">fakeDB</span><span class="op" id="6601892">)</span>&nbsp;<span class="ident" id="6601894">columnType</span><span class="op" id="6601904">(</span><span class="ident" id="6601905">table</span><span class="op" id="6601910">,</span>&nbsp;<span class="ident" id="6601912">column</span>&nbsp;<span class="builtintype" id="6601919">string</span><span class="op" id="6601925">)</span>&nbsp;<span class="op" id="6601927">(</span><span class="ident" id="6601928">typ</span>&nbsp;<span class="builtintype" id="6601932">string</span><span class="op" id="6601938">,</span>&nbsp;<span class="ident" id="6601940">ok</span>&nbsp;<span class="builtintype" id="6601943">bool</span><span class="op" id="6601947">)</span>&nbsp;<span class="op" id="6601949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6601952">db</span><span class="op" id="6601954">.</span><span class="ident" id="6601955">mu</span><span class="op" id="6601957">.</span><span class="ident" id="6601958">Lock</span><span class="op" id="6601962">(</span><span class="op" id="6601963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6601966">defer</span>&nbsp;<span class="ident" id="6601972">db</span><span class="op" id="6601974">.</span><span class="ident" id="6601975">mu</span><span class="op" id="6601977">.</span><span class="ident" id="6601978">Unlock</span><span class="op" id="6601984">(</span><span class="op" id="6601985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6601988">t</span><span class="op" id="6601989">,</span>&nbsp;<span class="ident" id="6601991">ok</span>&nbsp;<span class="op" id="6601994">:=</span>&nbsp;<span class="ident" id="6601997">db</span><span class="op" id="6601999">.</span><span class="ident" id="6602000">table</span><span class="op" id="6602005">(</span><span class="ident" id="6602006">table</span><span class="op" id="6602011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6602014">if</span>&nbsp;<span class="op" id="6602017">!</span><span class="ident" id="6602018">ok</span>&nbsp;<span class="op" id="6602021">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6602025">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6602033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6602036">for</span>&nbsp;<span class="ident" id="6602040">n</span><span class="op" id="6602041">,</span>&nbsp;<span class="ident" id="6602043">cname</span>&nbsp;<span class="op" id="6602049">:=</span>&nbsp;<span class="keyword" id="6602052">range</span>&nbsp;<span class="ident" id="6602058">t</span><span class="op" id="6602059">.</span><span class="ident" id="6602060">colname</span>&nbsp;<span class="op" id="6602068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6602072">if</span>&nbsp;<span class="ident" id="6602075">cname</span>&nbsp;<span class="op" id="6602081">==</span>&nbsp;<span class="ident" id="6602084">column</span>&nbsp;<span class="op" id="6602091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6602096">return</span>&nbsp;<span class="ident" id="6602103">t</span><span class="op" id="6602104">.</span><span class="ident" id="6602105">coltype</span><span class="op" id="6602112">[</span><span class="ident" id="6602113">n</span><span class="op" id="6602114">]</span><span class="op" id="6602115">,</span>&nbsp;<span class="builtintype" id="6602117">true</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6602124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6602127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6602130">return</span>&nbsp;<span class="string" id="6602137">&#34;&#34;</span><span class="op" id="6602139">,</span>&nbsp;<span class="builtintype" id="6602141">false</span><br>
<span class="lineno"></span><span class="op" id="6602147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="keyword" id="6602150">func</span>&nbsp;<span class="op" id="6602155">(</span><span class="ident" id="6602156">c</span>&nbsp;<span class="op" id="6602158">*</span><span class="ident" id="6602159">fakeConn</span><span class="op" id="6602167">)</span>&nbsp;<span class="ident" id="6602169">isBad</span><span class="op" id="6602174">(</span><span class="op" id="6602175">)</span>&nbsp;<span class="builtintype" id="6602177">bool</span>&nbsp;<span class="op" id="6602182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6602185">//&nbsp;if&nbsp;not&nbsp;simulating&nbsp;bad&nbsp;conn,&nbsp;do&nbsp;nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6602228">if</span>&nbsp;<span class="op" id="6602231">!</span><span class="ident" id="6602232">c</span><span class="op" id="6602233">.</span><span class="ident" id="6602234">bad</span>&nbsp;<span class="op" id="6602238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6602242">return</span>&nbsp;<span class="builtintype" id="6602249">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6602256">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6602259">//&nbsp;alternate&nbsp;between&nbsp;bad&nbsp;conn&nbsp;and&nbsp;not&nbsp;bad&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6602307">c</span><span class="op" id="6602308">.</span><span class="ident" id="6602309">db</span><span class="op" id="6602311">.</span><span class="ident" id="6602312">badConn</span>&nbsp;<span class="op" id="6602320">=</span>&nbsp;<span class="op" id="6602322">!</span><span class="ident" id="6602323">c</span><span class="op" id="6602324">.</span><span class="ident" id="6602325">db</span><span class="op" id="6602327">.</span><span class="ident" id="6602328">badConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6602337">return</span>&nbsp;<span class="ident" id="6602344">c</span><span class="op" id="6602345">.</span><span class="ident" id="6602346">db</span><span class="op" id="6602348">.</span><span class="ident" id="6602349">badConn</span><br>
<span class="lineno"></span><span class="op" id="6602357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="6602360">func</span>&nbsp;<span class="op" id="6602365">(</span><span class="ident" id="6602366">c</span>&nbsp;<span class="op" id="6602368">*</span><span class="ident" id="6602369">fakeConn</span><span class="op" id="6602377">)</span>&nbsp;<span class="ident" id="6602379">Begin</span><span class="op" id="6602384">(</span><span class="op" id="6602385">)</span>&nbsp;<span class="op" id="6602387">(</span><span class="ident" id="6602388">driver</span><span class="op" id="6602394">.</span><span class="ident" id="6602395">Tx</span><span class="op" id="6602397">,</span>&nbsp;<span class="builtintype" id="6602399">error</span><span class="op" id="6602404">)</span>&nbsp;<span class="op" id="6602406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6602409">if</span>&nbsp;<span class="ident" id="6602412">c</span><span class="op" id="6602413">.</span><span class="ident" id="6602414">isBad</span><span class="op" id="6602419">(</span><span class="op" id="6602420">)</span>&nbsp;<span class="op" id="6602422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6602426">return</span>&nbsp;<span class="ident" id="6602433">nil</span><span class="op" id="6602436">,</span>&nbsp;<span class="ident" id="6602438">driver</span><span class="op" id="6602444">.</span><span class="ident" id="6602445">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6602457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6602460">if</span>&nbsp;<span class="ident" id="6602463">c</span><span class="op" id="6602464">.</span><span class="ident" id="6602465">currTx</span>&nbsp;<span class="op" id="6602472">!=</span>&nbsp;<span class="ident" id="6602475">nil</span>&nbsp;<span class="op" id="6602479">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6602483">return</span>&nbsp;<span class="ident" id="6602490">nil</span><span class="op" id="6602493">,</span>&nbsp;<span class="ident" id="6602495">errors</span><span class="op" id="6602501">.</span><span class="ident" id="6602502">New</span><span class="op" id="6602505">(</span><span class="string" id="6602506">&#34;already&nbsp;in&nbsp;a&nbsp;transaction&#34;</span><span class="op" id="6602532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6602535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6602538">c</span><span class="op" id="6602539">.</span><span class="ident" id="6602540">currTx</span>&nbsp;<span class="op" id="6602547">=</span>&nbsp;<span class="op" id="6602549">&amp;</span><span class="ident" id="6602550">fakeTx</span><span class="op" id="6602556">{</span><span class="ident" id="6602557">c</span><span class="op" id="6602558">:</span>&nbsp;<span class="ident" id="6602560">c</span><span class="op" id="6602561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6602564">return</span>&nbsp;<span class="ident" id="6602571">c</span><span class="op" id="6602572">.</span><span class="ident" id="6602573">currTx</span><span class="op" id="6602579">,</span>&nbsp;<span class="ident" id="6602581">nil</span><br>
<span class="lineno"></span><span class="op" id="6602585">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="6602588">var</span>&nbsp;<span class="ident" id="6602592">hookPostCloseConn</span>&nbsp;<span class="keyword" id="6602610">struct</span>&nbsp;<span class="op" id="6602617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6602620">sync</span><span class="op" id="6602624">.</span><span class="ident" id="6602625">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6602632">fn</span>&nbsp;<span class="keyword" id="6602635">func</span><span class="op" id="6602639">(</span><span class="op" id="6602640">*</span><span class="ident" id="6602641">fakeConn</span><span class="op" id="6602649">,</span>&nbsp;<span class="builtintype" id="6602651">error</span><span class="op" id="6602656">)</span><br>
<span class="lineno"></span><span class="op" id="6602658">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="6602661">func</span>&nbsp;<span class="ident" id="6602666">setHookpostCloseConn</span><span class="op" id="6602686">(</span><span class="ident" id="6602687">fn</span>&nbsp;<span class="keyword" id="6602690">func</span><span class="op" id="6602694">(</span><span class="op" id="6602695">*</span><span class="ident" id="6602696">fakeConn</span><span class="op" id="6602704">,</span>&nbsp;<span class="builtintype" id="6602706">error</span><span class="op" id="6602711">)</span><span class="op" id="6602712">)</span>&nbsp;<span class="op" id="6602714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6602717">hookPostCloseConn</span><span class="op" id="6602734">.</span><span class="ident" id="6602735">Lock</span><span class="op" id="6602739">(</span><span class="op" id="6602740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6602743">defer</span>&nbsp;<span class="ident" id="6602749">hookPostCloseConn</span><span class="op" id="6602766">.</span><span class="ident" id="6602767">Unlock</span><span class="op" id="6602773">(</span><span class="op" id="6602774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6602777">hookPostCloseConn</span><span class="op" id="6602794">.</span><span class="ident" id="6602795">fn</span>&nbsp;<span class="op" id="6602798">=</span>&nbsp;<span class="ident" id="6602800">fn</span><br>
<span class="lineno">275</span><span class="op" id="6602803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6602806">var</span>&nbsp;<span class="ident" id="6602810">testStrictClose</span>&nbsp;<span class="op" id="6602826">*</span><span class="ident" id="6602827">testing</span><span class="op" id="6602834">.</span><span class="ident" id="6602835">T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6602838">//&nbsp;setStrictFakeConnClose&nbsp;sets&nbsp;the&nbsp;t&nbsp;to&nbsp;Errorf&nbsp;on&nbsp;when&nbsp;fakeConn.Close</span><br>
<span class="lineno">280</span><span class="comment" id="6602908">//&nbsp;fails&nbsp;to&nbsp;close.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;check&nbsp;is&nbsp;disabled.</span><br>
<span class="lineno"></span><span class="keyword" id="6602958">func</span>&nbsp;<span class="ident" id="6602963">setStrictFakeConnClose</span><span class="op" id="6602985">(</span><span class="ident" id="6602986">t</span>&nbsp;<span class="op" id="6602988">*</span><span class="ident" id="6602989">testing</span><span class="op" id="6602996">.</span><span class="ident" id="6602997">T</span><span class="op" id="6602998">)</span>&nbsp;<span class="op" id="6603000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6603003">testStrictClose</span>&nbsp;<span class="op" id="6603019">=</span>&nbsp;<span class="ident" id="6603021">t</span><br>
<span class="lineno"></span><span class="op" id="6603023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="6603026">func</span>&nbsp;<span class="op" id="6603031">(</span><span class="ident" id="6603032">c</span>&nbsp;<span class="op" id="6603034">*</span><span class="ident" id="6603035">fakeConn</span><span class="op" id="6603043">)</span>&nbsp;<span class="ident" id="6603045">Close</span><span class="op" id="6603050">(</span><span class="op" id="6603051">)</span>&nbsp;<span class="op" id="6603053">(</span><span class="ident" id="6603054">err</span>&nbsp;<span class="builtintype" id="6603058">error</span><span class="op" id="6603063">)</span>&nbsp;<span class="op" id="6603065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6603068">drv</span>&nbsp;<span class="op" id="6603072">:=</span>&nbsp;<span class="ident" id="6603075">fdriver</span><span class="op" id="6603082">.</span><span class="op" id="6603083">(</span><span class="op" id="6603084">*</span><span class="ident" id="6603085">fakeDriver</span><span class="op" id="6603095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603098">defer</span>&nbsp;<span class="keyword" id="6603104">func</span><span class="op" id="6603108">(</span><span class="op" id="6603109">)</span>&nbsp;<span class="op" id="6603111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603115">if</span>&nbsp;<span class="ident" id="6603118">err</span>&nbsp;<span class="op" id="6603122">!=</span>&nbsp;<span class="ident" id="6603125">nil</span>&nbsp;<span class="op" id="6603129">&amp;&amp;</span>&nbsp;<span class="ident" id="6603132">testStrictClose</span>&nbsp;<span class="op" id="6603148">!=</span>&nbsp;<span class="ident" id="6603151">nil</span>&nbsp;<span class="op" id="6603155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6603160">testStrictClose</span><span class="op" id="6603175">.</span><span class="ident" id="6603176">Errorf</span><span class="op" id="6603182">(</span><span class="string" id="6603183">&#34;failed&nbsp;to&nbsp;close&nbsp;a&nbsp;test&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="6603220">,</span>&nbsp;<span class="ident" id="6603222">err</span><span class="op" id="6603225">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6603229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6603233">hookPostCloseConn</span><span class="op" id="6603250">.</span><span class="ident" id="6603251">Lock</span><span class="op" id="6603255">(</span><span class="op" id="6603256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6603260">fn</span>&nbsp;<span class="op" id="6603263">:=</span>&nbsp;<span class="ident" id="6603266">hookPostCloseConn</span><span class="op" id="6603283">.</span><span class="ident" id="6603284">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6603289">hookPostCloseConn</span><span class="op" id="6603306">.</span><span class="ident" id="6603307">Unlock</span><span class="op" id="6603313">(</span><span class="op" id="6603314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603318">if</span>&nbsp;<span class="ident" id="6603321">fn</span>&nbsp;<span class="op" id="6603324">!=</span>&nbsp;<span class="ident" id="6603327">nil</span>&nbsp;<span class="op" id="6603331">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6603336">fn</span><span class="op" id="6603338">(</span><span class="ident" id="6603339">c</span><span class="op" id="6603340">,</span>&nbsp;<span class="ident" id="6603342">err</span><span class="op" id="6603345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6603349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603353">if</span>&nbsp;<span class="ident" id="6603356">err</span>&nbsp;<span class="op" id="6603360">==</span>&nbsp;<span class="ident" id="6603363">nil</span>&nbsp;<span class="op" id="6603367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6603372">drv</span><span class="op" id="6603375">.</span><span class="ident" id="6603376">mu</span><span class="op" id="6603378">.</span><span class="ident" id="6603379">Lock</span><span class="op" id="6603383">(</span><span class="op" id="6603384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6603389">drv</span><span class="op" id="6603392">.</span><span class="ident" id="6603393">closeCount</span><span class="op" id="6603403">++</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6603409">drv</span><span class="op" id="6603412">.</span><span class="ident" id="6603413">mu</span><span class="op" id="6603415">.</span><span class="ident" id="6603416">Unlock</span><span class="op" id="6603422">(</span><span class="op" id="6603423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6603427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6603430">}</span><span class="op" id="6603431">(</span><span class="op" id="6603432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603435">if</span>&nbsp;<span class="ident" id="6603438">c</span><span class="op" id="6603439">.</span><span class="ident" id="6603440">currTx</span>&nbsp;<span class="op" id="6603447">!=</span>&nbsp;<span class="ident" id="6603450">nil</span>&nbsp;<span class="op" id="6603454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603458">return</span>&nbsp;<span class="ident" id="6603465">errors</span><span class="op" id="6603471">.</span><span class="ident" id="6603472">New</span><span class="op" id="6603475">(</span><span class="string" id="6603476">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;in&nbsp;a&nbsp;Transaction&#34;</span><span class="op" id="6603516">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6603519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603522">if</span>&nbsp;<span class="ident" id="6603525">c</span><span class="op" id="6603526">.</span><span class="ident" id="6603527">db</span>&nbsp;<span class="op" id="6603530">==</span>&nbsp;<span class="ident" id="6603533">nil</span>&nbsp;<span class="op" id="6603537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603541">return</span>&nbsp;<span class="ident" id="6603548">errors</span><span class="op" id="6603554">.</span><span class="ident" id="6603555">New</span><span class="op" id="6603558">(</span><span class="string" id="6603559">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;already&nbsp;closed&#34;</span><span class="op" id="6603597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6603600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603603">if</span>&nbsp;<span class="ident" id="6603606">c</span><span class="op" id="6603607">.</span><span class="ident" id="6603608">stmtsMade</span>&nbsp;<span class="op" id="6603618">&gt;</span>&nbsp;<span class="ident" id="6603620">c</span><span class="op" id="6603621">.</span><span class="ident" id="6603622">stmtsClosed</span>&nbsp;<span class="op" id="6603634">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603638">return</span>&nbsp;<span class="ident" id="6603645">errors</span><span class="op" id="6603651">.</span><span class="ident" id="6603652">New</span><span class="op" id="6603655">(</span><span class="string" id="6603656">&#34;can&#39;t&nbsp;close;&nbsp;dangling&nbsp;statement(s)&#34;</span><span class="op" id="6603692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6603695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6603698">c</span><span class="op" id="6603699">.</span><span class="ident" id="6603700">db</span>&nbsp;<span class="op" id="6603703">=</span>&nbsp;<span class="ident" id="6603705">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603710">return</span>&nbsp;<span class="ident" id="6603717">nil</span><br>
<span class="lineno"></span><span class="op" id="6603721">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="6603724">func</span>&nbsp;<span class="ident" id="6603729">checkSubsetTypes</span><span class="op" id="6603745">(</span><span class="ident" id="6603746">args</span>&nbsp;<span class="op" id="6603751">[</span><span class="op" id="6603752">]</span><span class="ident" id="6603753">driver</span><span class="op" id="6603759">.</span><span class="ident" id="6603760">Value</span><span class="op" id="6603765">)</span>&nbsp;<span class="builtintype" id="6603767">error</span>&nbsp;<span class="op" id="6603773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603776">for</span>&nbsp;<span class="ident" id="6603780">n</span><span class="op" id="6603781">,</span>&nbsp;<span class="ident" id="6603783">arg</span>&nbsp;<span class="op" id="6603787">:=</span>&nbsp;<span class="keyword" id="6603790">range</span>&nbsp;<span class="ident" id="6603796">args</span>&nbsp;<span class="op" id="6603801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603805">switch</span>&nbsp;<span class="ident" id="6603812">arg</span><span class="op" id="6603815">.</span><span class="op" id="6603816">(</span><span class="keyword" id="6603817">type</span><span class="op" id="6603821">)</span>&nbsp;<span class="op" id="6603823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603827">case</span>&nbsp;<span class="ident" id="6603832">int64</span><span class="op" id="6603837">,</span>&nbsp;<span class="builtintype" id="6603839">float64</span><span class="op" id="6603846">,</span>&nbsp;<span class="builtintype" id="6603848">bool</span><span class="op" id="6603852">,</span>&nbsp;<span class="ident" id="6603854">nil</span><span class="op" id="6603857">,</span>&nbsp;<span class="op" id="6603859">[</span><span class="op" id="6603860">]</span><span class="builtintype" id="6603861">byte</span><span class="op" id="6603865">,</span>&nbsp;<span class="builtintype" id="6603867">string</span><span class="op" id="6603873">,</span>&nbsp;<span class="ident" id="6603875">time</span><span class="op" id="6603879">.</span><span class="ident" id="6603880">Time</span><span class="op" id="6603884">:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603888">default</span><span class="op" id="6603895">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603900">return</span>&nbsp;<span class="ident" id="6603907">fmt</span><span class="op" id="6603910">.</span><span class="ident" id="6603911">Errorf</span><span class="op" id="6603917">(</span><span class="string" id="6603918">&#34;fakedb_test:&nbsp;invalid&nbsp;argument&nbsp;#%d:&nbsp;%v,&nbsp;type&nbsp;%T&#34;</span><span class="op" id="6603966">,</span>&nbsp;<span class="ident" id="6603968">n</span><span class="op" id="6603969">+</span><span class="num" id="6603970">1</span><span class="op" id="6603971">,</span>&nbsp;<span class="ident" id="6603973">arg</span><span class="op" id="6603976">,</span>&nbsp;<span class="ident" id="6603978">arg</span><span class="op" id="6603981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6603985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6603988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6603991">return</span>&nbsp;<span class="ident" id="6603998">nil</span><br>
<span class="lineno">325</span><span class="op" id="6604002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6604005">func</span>&nbsp;<span class="op" id="6604010">(</span><span class="ident" id="6604011">c</span>&nbsp;<span class="op" id="6604013">*</span><span class="ident" id="6604014">fakeConn</span><span class="op" id="6604022">)</span>&nbsp;<span class="ident" id="6604024">Exec</span><span class="op" id="6604028">(</span><span class="ident" id="6604029">query</span>&nbsp;<span class="builtintype" id="6604035">string</span><span class="op" id="6604041">,</span>&nbsp;<span class="ident" id="6604043">args</span>&nbsp;<span class="op" id="6604048">[</span><span class="op" id="6604049">]</span><span class="ident" id="6604050">driver</span><span class="op" id="6604056">.</span><span class="ident" id="6604057">Value</span><span class="op" id="6604062">)</span>&nbsp;<span class="op" id="6604064">(</span><span class="ident" id="6604065">driver</span><span class="op" id="6604071">.</span><span class="ident" id="6604072">Result</span><span class="op" id="6604078">,</span>&nbsp;<span class="builtintype" id="6604080">error</span><span class="op" id="6604085">)</span>&nbsp;<span class="op" id="6604087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6604090">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6604151">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6604212">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6604271">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6604298">err</span>&nbsp;<span class="op" id="6604302">:=</span>&nbsp;<span class="ident" id="6604305">checkSubsetTypes</span><span class="op" id="6604321">(</span><span class="ident" id="6604322">args</span><span class="op" id="6604326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6604329">if</span>&nbsp;<span class="ident" id="6604332">err</span>&nbsp;<span class="op" id="6604336">!=</span>&nbsp;<span class="ident" id="6604339">nil</span>&nbsp;<span class="op" id="6604343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6604347">return</span>&nbsp;<span class="ident" id="6604354">nil</span><span class="op" id="6604357">,</span>&nbsp;<span class="ident" id="6604359">err</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6604364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6604367">return</span>&nbsp;<span class="ident" id="6604374">nil</span><span class="op" id="6604377">,</span>&nbsp;<span class="ident" id="6604379">driver</span><span class="op" id="6604385">.</span><span class="ident" id="6604386">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="6604394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6604397">func</span>&nbsp;<span class="op" id="6604402">(</span><span class="ident" id="6604403">c</span>&nbsp;<span class="op" id="6604405">*</span><span class="ident" id="6604406">fakeConn</span><span class="op" id="6604414">)</span>&nbsp;<span class="ident" id="6604416">Query</span><span class="op" id="6604421">(</span><span class="ident" id="6604422">query</span>&nbsp;<span class="builtintype" id="6604428">string</span><span class="op" id="6604434">,</span>&nbsp;<span class="ident" id="6604436">args</span>&nbsp;<span class="op" id="6604441">[</span><span class="op" id="6604442">]</span><span class="ident" id="6604443">driver</span><span class="op" id="6604449">.</span><span class="ident" id="6604450">Value</span><span class="op" id="6604455">)</span>&nbsp;<span class="op" id="6604457">(</span><span class="ident" id="6604458">driver</span><span class="op" id="6604464">.</span><span class="ident" id="6604465">Rows</span><span class="op" id="6604469">,</span>&nbsp;<span class="builtintype" id="6604471">error</span><span class="op" id="6604476">)</span>&nbsp;<span class="op" id="6604478">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6604481">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6604542">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6604603">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6604662">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6604689">err</span>&nbsp;<span class="op" id="6604693">:=</span>&nbsp;<span class="ident" id="6604696">checkSubsetTypes</span><span class="op" id="6604712">(</span><span class="ident" id="6604713">args</span><span class="op" id="6604717">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6604720">if</span>&nbsp;<span class="ident" id="6604723">err</span>&nbsp;<span class="op" id="6604727">!=</span>&nbsp;<span class="ident" id="6604730">nil</span>&nbsp;<span class="op" id="6604734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6604738">return</span>&nbsp;<span class="ident" id="6604745">nil</span><span class="op" id="6604748">,</span>&nbsp;<span class="ident" id="6604750">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6604755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6604758">return</span>&nbsp;<span class="ident" id="6604765">nil</span><span class="op" id="6604768">,</span>&nbsp;<span class="ident" id="6604770">driver</span><span class="op" id="6604776">.</span><span class="ident" id="6604777">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="6604785">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="6604788">func</span>&nbsp;<span class="ident" id="6604793">errf</span><span class="op" id="6604797">(</span><span class="ident" id="6604798">msg</span>&nbsp;<span class="builtintype" id="6604802">string</span><span class="op" id="6604808">,</span>&nbsp;<span class="ident" id="6604810">args</span>&nbsp;<span class="op" id="6604815">...</span><span class="keyword" id="6604818">interface</span><span class="op" id="6604827">{</span><span class="op" id="6604828">}</span><span class="op" id="6604829">)</span>&nbsp;<span class="builtintype" id="6604831">error</span>&nbsp;<span class="op" id="6604837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6604840">return</span>&nbsp;<span class="ident" id="6604847">errors</span><span class="op" id="6604853">.</span><span class="ident" id="6604854">New</span><span class="op" id="6604857">(</span><span class="string" id="6604858">&#34;fakedb:&nbsp;&#34;</span>&nbsp;<span class="op" id="6604869">+</span>&nbsp;<span class="ident" id="6604871">fmt</span><span class="op" id="6604874">.</span><span class="ident" id="6604875">Sprintf</span><span class="op" id="6604882">(</span><span class="ident" id="6604883">msg</span><span class="op" id="6604886">,</span>&nbsp;<span class="ident" id="6604888">args</span><span class="op" id="6604892">...</span><span class="op" id="6604895">)</span><span class="op" id="6604896">)</span><br>
<span class="lineno"></span><span class="op" id="6604898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="6604901">//&nbsp;parts&nbsp;are&nbsp;table|selectCol1,selectCol2|whereCol=?,whereCol2=?</span><br>
<span class="lineno"></span><span class="comment" id="6604965">//&nbsp;(note&nbsp;that&nbsp;where&nbsp;columns&nbsp;must&nbsp;always&nbsp;contain&nbsp;?&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="6605022">//&nbsp;&nbsp;just&nbsp;a&nbsp;limitation&nbsp;for&nbsp;fakedb)</span><br>
<span class="lineno"></span><span class="keyword" id="6605056">func</span>&nbsp;<span class="op" id="6605061">(</span><span class="ident" id="6605062">c</span>&nbsp;<span class="op" id="6605064">*</span><span class="ident" id="6605065">fakeConn</span><span class="op" id="6605073">)</span>&nbsp;<span class="ident" id="6605075">prepareSelect</span><span class="op" id="6605088">(</span><span class="ident" id="6605089">stmt</span>&nbsp;<span class="op" id="6605094">*</span><span class="ident" id="6605095">fakeStmt</span><span class="op" id="6605103">,</span>&nbsp;<span class="ident" id="6605105">parts</span>&nbsp;<span class="op" id="6605111">[</span><span class="op" id="6605112">]</span><span class="builtintype" id="6605113">string</span><span class="op" id="6605119">)</span>&nbsp;<span class="op" id="6605121">(</span><span class="ident" id="6605122">driver</span><span class="op" id="6605128">.</span><span class="ident" id="6605129">Stmt</span><span class="op" id="6605133">,</span>&nbsp;<span class="builtintype" id="6605135">error</span><span class="op" id="6605140">)</span>&nbsp;<span class="op" id="6605142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6605145">if</span>&nbsp;<span class="builtinfunc" id="6605148">len</span><span class="op" id="6605151">(</span><span class="ident" id="6605152">parts</span><span class="op" id="6605157">)</span>&nbsp;<span class="op" id="6605159">!=</span>&nbsp;<span class="num" id="6605162">3</span>&nbsp;<span class="op" id="6605164">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6605168">stmt</span><span class="op" id="6605172">.</span><span class="ident" id="6605173">Close</span><span class="op" id="6605178">(</span><span class="op" id="6605179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6605183">return</span>&nbsp;<span class="ident" id="6605190">nil</span><span class="op" id="6605193">,</span>&nbsp;<span class="ident" id="6605195">errf</span><span class="op" id="6605199">(</span><span class="string" id="6605200">&#34;invalid&nbsp;SELECT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;3&#34;</span><span class="op" id="6605245">,</span>&nbsp;<span class="builtinfunc" id="6605247">len</span><span class="op" id="6605250">(</span><span class="ident" id="6605251">parts</span><span class="op" id="6605256">)</span><span class="op" id="6605257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6605260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6605263">stmt</span><span class="op" id="6605267">.</span><span class="ident" id="6605268">table</span>&nbsp;<span class="op" id="6605274">=</span>&nbsp;<span class="ident" id="6605276">parts</span><span class="op" id="6605281">[</span><span class="num" id="6605282">0</span><span class="op" id="6605283">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6605286">stmt</span><span class="op" id="6605290">.</span><span class="ident" id="6605291">colName</span>&nbsp;<span class="op" id="6605299">=</span>&nbsp;<span class="ident" id="6605301">strings</span><span class="op" id="6605308">.</span><span class="ident" id="6605309">Split</span><span class="op" id="6605314">(</span><span class="ident" id="6605315">parts</span><span class="op" id="6605320">[</span><span class="num" id="6605321">1</span><span class="op" id="6605322">]</span><span class="op" id="6605323">,</span>&nbsp;<span class="string" id="6605325">&#34;,&#34;</span><span class="op" id="6605328">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6605331">for</span>&nbsp;<span class="ident" id="6605335">n</span><span class="op" id="6605336">,</span>&nbsp;<span class="ident" id="6605338">colspec</span>&nbsp;<span class="op" id="6605346">:=</span>&nbsp;<span class="keyword" id="6605349">range</span>&nbsp;<span class="ident" id="6605355">strings</span><span class="op" id="6605362">.</span><span class="ident" id="6605363">Split</span><span class="op" id="6605368">(</span><span class="ident" id="6605369">parts</span><span class="op" id="6605374">[</span><span class="num" id="6605375">2</span><span class="op" id="6605376">]</span><span class="op" id="6605377">,</span>&nbsp;<span class="string" id="6605379">&#34;,&#34;</span><span class="op" id="6605382">)</span>&nbsp;<span class="op" id="6605384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6605388">if</span>&nbsp;<span class="ident" id="6605391">colspec</span>&nbsp;<span class="op" id="6605399">==</span>&nbsp;<span class="string" id="6605402">&#34;&#34;</span>&nbsp;<span class="op" id="6605405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6605410">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6605421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6605425">nameVal</span>&nbsp;<span class="op" id="6605433">:=</span>&nbsp;<span class="ident" id="6605436">strings</span><span class="op" id="6605443">.</span><span class="ident" id="6605444">Split</span><span class="op" id="6605449">(</span><span class="ident" id="6605450">colspec</span><span class="op" id="6605457">,</span>&nbsp;<span class="string" id="6605459">&#34;=&#34;</span><span class="op" id="6605462">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6605466">if</span>&nbsp;<span class="builtinfunc" id="6605469">len</span><span class="op" id="6605472">(</span><span class="ident" id="6605473">nameVal</span><span class="op" id="6605480">)</span>&nbsp;<span class="op" id="6605482">!=</span>&nbsp;<span class="num" id="6605485">2</span>&nbsp;<span class="op" id="6605487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6605492">stmt</span><span class="op" id="6605496">.</span><span class="ident" id="6605497">Close</span><span class="op" id="6605502">(</span><span class="op" id="6605503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6605508">return</span>&nbsp;<span class="ident" id="6605515">nil</span><span class="op" id="6605518">,</span>&nbsp;<span class="ident" id="6605520">errf</span><span class="op" id="6605524">(</span><span class="string" id="6605525">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="6605586">,</span>&nbsp;<span class="ident" id="6605588">stmt</span><span class="op" id="6605592">.</span><span class="ident" id="6605593">table</span><span class="op" id="6605598">,</span>&nbsp;<span class="ident" id="6605600">colspec</span><span class="op" id="6605607">,</span>&nbsp;<span class="ident" id="6605609">n</span><span class="op" id="6605610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6605614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6605618">column</span><span class="op" id="6605624">,</span>&nbsp;<span class="ident" id="6605626">value</span>&nbsp;<span class="op" id="6605632">:=</span>&nbsp;<span class="ident" id="6605635">nameVal</span><span class="op" id="6605642">[</span><span class="num" id="6605643">0</span><span class="op" id="6605644">]</span><span class="op" id="6605645">,</span>&nbsp;<span class="ident" id="6605647">nameVal</span><span class="op" id="6605654">[</span><span class="num" id="6605655">1</span><span class="op" id="6605656">]</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6605660">_</span><span class="op" id="6605661">,</span>&nbsp;<span class="ident" id="6605663">ok</span>&nbsp;<span class="op" id="6605666">:=</span>&nbsp;<span class="ident" id="6605669">c</span><span class="op" id="6605670">.</span><span class="ident" id="6605671">db</span><span class="op" id="6605673">.</span><span class="ident" id="6605674">columnType</span><span class="op" id="6605684">(</span><span class="ident" id="6605685">stmt</span><span class="op" id="6605689">.</span><span class="ident" id="6605690">table</span><span class="op" id="6605695">,</span>&nbsp;<span class="ident" id="6605697">column</span><span class="op" id="6605703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6605707">if</span>&nbsp;<span class="op" id="6605710">!</span><span class="ident" id="6605711">ok</span>&nbsp;<span class="op" id="6605714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6605719">stmt</span><span class="op" id="6605723">.</span><span class="ident" id="6605724">Close</span><span class="op" id="6605729">(</span><span class="op" id="6605730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6605735">return</span>&nbsp;<span class="ident" id="6605742">nil</span><span class="op" id="6605745">,</span>&nbsp;<span class="ident" id="6605747">errf</span><span class="op" id="6605751">(</span><span class="string" id="6605752">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="6605806">,</span>&nbsp;<span class="ident" id="6605808">stmt</span><span class="op" id="6605812">.</span><span class="ident" id="6605813">table</span><span class="op" id="6605818">,</span>&nbsp;<span class="ident" id="6605820">column</span><span class="op" id="6605826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6605830">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6605834">if</span>&nbsp;<span class="ident" id="6605837">value</span>&nbsp;<span class="op" id="6605843">!=</span>&nbsp;<span class="string" id="6605846">&#34;?&#34;</span>&nbsp;<span class="op" id="6605850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6605855">stmt</span><span class="op" id="6605859">.</span><span class="ident" id="6605860">Close</span><span class="op" id="6605865">(</span><span class="op" id="6605866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6605871">return</span>&nbsp;<span class="ident" id="6605878">nil</span><span class="op" id="6605881">,</span>&nbsp;<span class="ident" id="6605883">errf</span><span class="op" id="6605887">(</span><span class="string" id="6605888">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;pre-bound&nbsp;value&nbsp;for&nbsp;where&nbsp;column&nbsp;%q;&nbsp;need&nbsp;a&nbsp;question&nbsp;mark&#34;</span><span class="op" id="6605970">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6605976">stmt</span><span class="op" id="6605980">.</span><span class="ident" id="6605981">table</span><span class="op" id="6605986">,</span>&nbsp;<span class="ident" id="6605988">column</span><span class="op" id="6605994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6605998">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6606002">stmt</span><span class="op" id="6606006">.</span><span class="ident" id="6606007">whereCol</span>&nbsp;<span class="op" id="6606016">=</span>&nbsp;<span class="builtinfunc" id="6606018">append</span><span class="op" id="6606024">(</span><span class="ident" id="6606025">stmt</span><span class="op" id="6606029">.</span><span class="ident" id="6606030">whereCol</span><span class="op" id="6606038">,</span>&nbsp;<span class="ident" id="6606040">column</span><span class="op" id="6606046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6606050">stmt</span><span class="op" id="6606054">.</span><span class="ident" id="6606055">placeholders</span><span class="op" id="6606067">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6606071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6606074">return</span>&nbsp;<span class="ident" id="6606081">stmt</span><span class="op" id="6606085">,</span>&nbsp;<span class="ident" id="6606087">nil</span><br>
<span class="lineno"></span><span class="op" id="6606091">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span><span class="comment" id="6606094">//&nbsp;parts&nbsp;are&nbsp;table|col=type,col2=type2</span><br>
<span class="lineno"></span><span class="keyword" id="6606133">func</span>&nbsp;<span class="op" id="6606138">(</span><span class="ident" id="6606139">c</span>&nbsp;<span class="op" id="6606141">*</span><span class="ident" id="6606142">fakeConn</span><span class="op" id="6606150">)</span>&nbsp;<span class="ident" id="6606152">prepareCreate</span><span class="op" id="6606165">(</span><span class="ident" id="6606166">stmt</span>&nbsp;<span class="op" id="6606171">*</span><span class="ident" id="6606172">fakeStmt</span><span class="op" id="6606180">,</span>&nbsp;<span class="ident" id="6606182">parts</span>&nbsp;<span class="op" id="6606188">[</span><span class="op" id="6606189">]</span><span class="builtintype" id="6606190">string</span><span class="op" id="6606196">)</span>&nbsp;<span class="op" id="6606198">(</span><span class="ident" id="6606199">driver</span><span class="op" id="6606205">.</span><span class="ident" id="6606206">Stmt</span><span class="op" id="6606210">,</span>&nbsp;<span class="builtintype" id="6606212">error</span><span class="op" id="6606217">)</span>&nbsp;<span class="op" id="6606219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6606222">if</span>&nbsp;<span class="builtinfunc" id="6606225">len</span><span class="op" id="6606228">(</span><span class="ident" id="6606229">parts</span><span class="op" id="6606234">)</span>&nbsp;<span class="op" id="6606236">!=</span>&nbsp;<span class="num" id="6606239">2</span>&nbsp;<span class="op" id="6606241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6606245">stmt</span><span class="op" id="6606249">.</span><span class="ident" id="6606250">Close</span><span class="op" id="6606255">(</span><span class="op" id="6606256">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6606260">return</span>&nbsp;<span class="ident" id="6606267">nil</span><span class="op" id="6606270">,</span>&nbsp;<span class="ident" id="6606272">errf</span><span class="op" id="6606276">(</span><span class="string" id="6606277">&#34;invalid&nbsp;CREATE&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="6606322">,</span>&nbsp;<span class="builtinfunc" id="6606324">len</span><span class="op" id="6606327">(</span><span class="ident" id="6606328">parts</span><span class="op" id="6606333">)</span><span class="op" id="6606334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6606337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6606340">stmt</span><span class="op" id="6606344">.</span><span class="ident" id="6606345">table</span>&nbsp;<span class="op" id="6606351">=</span>&nbsp;<span class="ident" id="6606353">parts</span><span class="op" id="6606358">[</span><span class="num" id="6606359">0</span><span class="op" id="6606360">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6606363">for</span>&nbsp;<span class="ident" id="6606367">n</span><span class="op" id="6606368">,</span>&nbsp;<span class="ident" id="6606370">colspec</span>&nbsp;<span class="op" id="6606378">:=</span>&nbsp;<span class="keyword" id="6606381">range</span>&nbsp;<span class="ident" id="6606387">strings</span><span class="op" id="6606394">.</span><span class="ident" id="6606395">Split</span><span class="op" id="6606400">(</span><span class="ident" id="6606401">parts</span><span class="op" id="6606406">[</span><span class="num" id="6606407">1</span><span class="op" id="6606408">]</span><span class="op" id="6606409">,</span>&nbsp;<span class="string" id="6606411">&#34;,&#34;</span><span class="op" id="6606414">)</span>&nbsp;<span class="op" id="6606416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6606420">nameType</span>&nbsp;<span class="op" id="6606429">:=</span>&nbsp;<span class="ident" id="6606432">strings</span><span class="op" id="6606439">.</span><span class="ident" id="6606440">Split</span><span class="op" id="6606445">(</span><span class="ident" id="6606446">colspec</span><span class="op" id="6606453">,</span>&nbsp;<span class="string" id="6606455">&#34;=&#34;</span><span class="op" id="6606458">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6606462">if</span>&nbsp;<span class="builtinfunc" id="6606465">len</span><span class="op" id="6606468">(</span><span class="ident" id="6606469">nameType</span><span class="op" id="6606477">)</span>&nbsp;<span class="op" id="6606479">!=</span>&nbsp;<span class="num" id="6606482">2</span>&nbsp;<span class="op" id="6606484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6606489">stmt</span><span class="op" id="6606493">.</span><span class="ident" id="6606494">Close</span><span class="op" id="6606499">(</span><span class="op" id="6606500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6606505">return</span>&nbsp;<span class="ident" id="6606512">nil</span><span class="op" id="6606515">,</span>&nbsp;<span class="ident" id="6606517">errf</span><span class="op" id="6606521">(</span><span class="string" id="6606522">&#34;CREATE&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="6606580">,</span>&nbsp;<span class="ident" id="6606582">stmt</span><span class="op" id="6606586">.</span><span class="ident" id="6606587">table</span><span class="op" id="6606592">,</span>&nbsp;<span class="ident" id="6606594">colspec</span><span class="op" id="6606601">,</span>&nbsp;<span class="ident" id="6606603">n</span><span class="op" id="6606604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6606608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6606612">stmt</span><span class="op" id="6606616">.</span><span class="ident" id="6606617">colName</span>&nbsp;<span class="op" id="6606625">=</span>&nbsp;<span class="builtinfunc" id="6606627">append</span><span class="op" id="6606633">(</span><span class="ident" id="6606634">stmt</span><span class="op" id="6606638">.</span><span class="ident" id="6606639">colName</span><span class="op" id="6606646">,</span>&nbsp;<span class="ident" id="6606648">nameType</span><span class="op" id="6606656">[</span><span class="num" id="6606657">0</span><span class="op" id="6606658">]</span><span class="op" id="6606659">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6606663">stmt</span><span class="op" id="6606667">.</span><span class="ident" id="6606668">colType</span>&nbsp;<span class="op" id="6606676">=</span>&nbsp;<span class="builtinfunc" id="6606678">append</span><span class="op" id="6606684">(</span><span class="ident" id="6606685">stmt</span><span class="op" id="6606689">.</span><span class="ident" id="6606690">colType</span><span class="op" id="6606697">,</span>&nbsp;<span class="ident" id="6606699">nameType</span><span class="op" id="6606707">[</span><span class="num" id="6606708">1</span><span class="op" id="6606709">]</span><span class="op" id="6606710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6606713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6606716">return</span>&nbsp;<span class="ident" id="6606723">stmt</span><span class="op" id="6606727">,</span>&nbsp;<span class="ident" id="6606729">nil</span><br>
<span class="lineno"></span><span class="op" id="6606733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="6606736">//&nbsp;parts&nbsp;are&nbsp;table|col=?,col2=val</span><br>
<span class="lineno"></span><span class="keyword" id="6606770">func</span>&nbsp;<span class="op" id="6606775">(</span><span class="ident" id="6606776">c</span>&nbsp;<span class="op" id="6606778">*</span><span class="ident" id="6606779">fakeConn</span><span class="op" id="6606787">)</span>&nbsp;<span class="ident" id="6606789">prepareInsert</span><span class="op" id="6606802">(</span><span class="ident" id="6606803">stmt</span>&nbsp;<span class="op" id="6606808">*</span><span class="ident" id="6606809">fakeStmt</span><span class="op" id="6606817">,</span>&nbsp;<span class="ident" id="6606819">parts</span>&nbsp;<span class="op" id="6606825">[</span><span class="op" id="6606826">]</span><span class="builtintype" id="6606827">string</span><span class="op" id="6606833">)</span>&nbsp;<span class="op" id="6606835">(</span><span class="ident" id="6606836">driver</span><span class="op" id="6606842">.</span><span class="ident" id="6606843">Stmt</span><span class="op" id="6606847">,</span>&nbsp;<span class="builtintype" id="6606849">error</span><span class="op" id="6606854">)</span>&nbsp;<span class="op" id="6606856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6606859">if</span>&nbsp;<span class="builtinfunc" id="6606862">len</span><span class="op" id="6606865">(</span><span class="ident" id="6606866">parts</span><span class="op" id="6606871">)</span>&nbsp;<span class="op" id="6606873">!=</span>&nbsp;<span class="num" id="6606876">2</span>&nbsp;<span class="op" id="6606878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6606882">stmt</span><span class="op" id="6606886">.</span><span class="ident" id="6606887">Close</span><span class="op" id="6606892">(</span><span class="op" id="6606893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6606897">return</span>&nbsp;<span class="ident" id="6606904">nil</span><span class="op" id="6606907">,</span>&nbsp;<span class="ident" id="6606909">errf</span><span class="op" id="6606913">(</span><span class="string" id="6606914">&#34;invalid&nbsp;INSERT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="6606959">,</span>&nbsp;<span class="builtinfunc" id="6606961">len</span><span class="op" id="6606964">(</span><span class="ident" id="6606965">parts</span><span class="op" id="6606970">)</span><span class="op" id="6606971">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6606974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6606977">stmt</span><span class="op" id="6606981">.</span><span class="ident" id="6606982">table</span>&nbsp;<span class="op" id="6606988">=</span>&nbsp;<span class="ident" id="6606990">parts</span><span class="op" id="6606995">[</span><span class="num" id="6606996">0</span><span class="op" id="6606997">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6607000">for</span>&nbsp;<span class="ident" id="6607004">n</span><span class="op" id="6607005">,</span>&nbsp;<span class="ident" id="6607007">colspec</span>&nbsp;<span class="op" id="6607015">:=</span>&nbsp;<span class="keyword" id="6607018">range</span>&nbsp;<span class="ident" id="6607024">strings</span><span class="op" id="6607031">.</span><span class="ident" id="6607032">Split</span><span class="op" id="6607037">(</span><span class="ident" id="6607038">parts</span><span class="op" id="6607043">[</span><span class="num" id="6607044">1</span><span class="op" id="6607045">]</span><span class="op" id="6607046">,</span>&nbsp;<span class="string" id="6607048">&#34;,&#34;</span><span class="op" id="6607051">)</span>&nbsp;<span class="op" id="6607053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6607057">nameVal</span>&nbsp;<span class="op" id="6607065">:=</span>&nbsp;<span class="ident" id="6607068">strings</span><span class="op" id="6607075">.</span><span class="ident" id="6607076">Split</span><span class="op" id="6607081">(</span><span class="ident" id="6607082">colspec</span><span class="op" id="6607089">,</span>&nbsp;<span class="string" id="6607091">&#34;=&#34;</span><span class="op" id="6607094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6607098">if</span>&nbsp;<span class="builtinfunc" id="6607101">len</span><span class="op" id="6607104">(</span><span class="ident" id="6607105">nameVal</span><span class="op" id="6607112">)</span>&nbsp;<span class="op" id="6607114">!=</span>&nbsp;<span class="num" id="6607117">2</span>&nbsp;<span class="op" id="6607119">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6607124">stmt</span><span class="op" id="6607128">.</span><span class="ident" id="6607129">Close</span><span class="op" id="6607134">(</span><span class="op" id="6607135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6607140">return</span>&nbsp;<span class="ident" id="6607147">nil</span><span class="op" id="6607150">,</span>&nbsp;<span class="ident" id="6607152">errf</span><span class="op" id="6607156">(</span><span class="string" id="6607157">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="6607215">,</span>&nbsp;<span class="ident" id="6607217">stmt</span><span class="op" id="6607221">.</span><span class="ident" id="6607222">table</span><span class="op" id="6607227">,</span>&nbsp;<span class="ident" id="6607229">colspec</span><span class="op" id="6607236">,</span>&nbsp;<span class="ident" id="6607238">n</span><span class="op" id="6607239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6607243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6607247">column</span><span class="op" id="6607253">,</span>&nbsp;<span class="ident" id="6607255">value</span>&nbsp;<span class="op" id="6607261">:=</span>&nbsp;<span class="ident" id="6607264">nameVal</span><span class="op" id="6607271">[</span><span class="num" id="6607272">0</span><span class="op" id="6607273">]</span><span class="op" id="6607274">,</span>&nbsp;<span class="ident" id="6607276">nameVal</span><span class="op" id="6607283">[</span><span class="num" id="6607284">1</span><span class="op" id="6607285">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6607289">ctype</span><span class="op" id="6607294">,</span>&nbsp;<span class="ident" id="6607296">ok</span>&nbsp;<span class="op" id="6607299">:=</span>&nbsp;<span class="ident" id="6607302">c</span><span class="op" id="6607303">.</span><span class="ident" id="6607304">db</span><span class="op" id="6607306">.</span><span class="ident" id="6607307">columnType</span><span class="op" id="6607317">(</span><span class="ident" id="6607318">stmt</span><span class="op" id="6607322">.</span><span class="ident" id="6607323">table</span><span class="op" id="6607328">,</span>&nbsp;<span class="ident" id="6607330">column</span><span class="op" id="6607336">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6607340">if</span>&nbsp;<span class="op" id="6607343">!</span><span class="ident" id="6607344">ok</span>&nbsp;<span class="op" id="6607347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6607352">stmt</span><span class="op" id="6607356">.</span><span class="ident" id="6607357">Close</span><span class="op" id="6607362">(</span><span class="op" id="6607363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6607368">return</span>&nbsp;<span class="ident" id="6607375">nil</span><span class="op" id="6607378">,</span>&nbsp;<span class="ident" id="6607380">errf</span><span class="op" id="6607384">(</span><span class="string" id="6607385">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="6607436">,</span>&nbsp;<span class="ident" id="6607438">stmt</span><span class="op" id="6607442">.</span><span class="ident" id="6607443">table</span><span class="op" id="6607448">,</span>&nbsp;<span class="ident" id="6607450">column</span><span class="op" id="6607456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6607460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6607464">stmt</span><span class="op" id="6607468">.</span><span class="ident" id="6607469">colName</span>&nbsp;<span class="op" id="6607477">=</span>&nbsp;<span class="builtinfunc" id="6607479">append</span><span class="op" id="6607485">(</span><span class="ident" id="6607486">stmt</span><span class="op" id="6607490">.</span><span class="ident" id="6607491">colName</span><span class="op" id="6607498">,</span>&nbsp;<span class="ident" id="6607500">column</span><span class="op" id="6607506">)</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6607511">if</span>&nbsp;<span class="ident" id="6607514">value</span>&nbsp;<span class="op" id="6607520">!=</span>&nbsp;<span class="string" id="6607523">&#34;?&#34;</span>&nbsp;<span class="op" id="6607527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6607532">var</span>&nbsp;<span class="ident" id="6607536">subsetVal</span>&nbsp;<span class="keyword" id="6607546">interface</span><span class="op" id="6607555">{</span><span class="op" id="6607556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6607561">//&nbsp;Convert&nbsp;to&nbsp;driver&nbsp;subset&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6607597">switch</span>&nbsp;<span class="ident" id="6607604">ctype</span>&nbsp;<span class="op" id="6607610">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6607615">case</span>&nbsp;<span class="string" id="6607620">&#34;string&#34;</span><span class="op" id="6607628">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6607634">subsetVal</span>&nbsp;<span class="op" id="6607644">=</span>&nbsp;<span class="op" id="6607646">[</span><span class="op" id="6607647">]</span><span class="builtintype" id="6607648">byte</span><span class="op" id="6607652">(</span><span class="ident" id="6607653">value</span><span class="op" id="6607658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6607663">case</span>&nbsp;<span class="string" id="6607668">&#34;blob&#34;</span><span class="op" id="6607674">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6607680">subsetVal</span>&nbsp;<span class="op" id="6607690">=</span>&nbsp;<span class="op" id="6607692">[</span><span class="op" id="6607693">]</span><span class="builtintype" id="6607694">byte</span><span class="op" id="6607698">(</span><span class="ident" id="6607699">value</span><span class="op" id="6607704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6607709">case</span>&nbsp;<span class="string" id="6607714">&#34;int32&#34;</span><span class="op" id="6607721">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6607727">i</span><span class="op" id="6607728">,</span>&nbsp;<span class="ident" id="6607730">err</span>&nbsp;<span class="op" id="6607734">:=</span>&nbsp;<span class="ident" id="6607737">strconv</span><span class="op" id="6607744">.</span><span class="ident" id="6607745">Atoi</span><span class="op" id="6607749">(</span><span class="ident" id="6607750">value</span><span class="op" id="6607755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6607761">if</span>&nbsp;<span class="ident" id="6607764">err</span>&nbsp;<span class="op" id="6607768">!=</span>&nbsp;<span class="ident" id="6607771">nil</span>&nbsp;<span class="op" id="6607775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6607782">stmt</span><span class="op" id="6607786">.</span><span class="ident" id="6607787">Close</span><span class="op" id="6607792">(</span><span class="op" id="6607793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6607800">return</span>&nbsp;<span class="ident" id="6607807">nil</span><span class="op" id="6607810">,</span>&nbsp;<span class="ident" id="6607812">errf</span><span class="op" id="6607816">(</span><span class="string" id="6607817">&#34;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;%q&#34;</span><span class="op" id="6607854">,</span>&nbsp;<span class="ident" id="6607856">value</span><span class="op" id="6607861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6607867">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6607873">subsetVal</span>&nbsp;<span class="op" id="6607883">=</span>&nbsp;<span class="ident" id="6607885">int64</span><span class="op" id="6607890">(</span><span class="ident" id="6607891">i</span><span class="op" id="6607892">)</span>&nbsp;<span class="comment" id="6607894">//&nbsp;int64&nbsp;is&nbsp;a&nbsp;subset&nbsp;type,&nbsp;but&nbsp;not&nbsp;int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6607938">default</span><span class="op" id="6607945">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6607951">stmt</span><span class="op" id="6607955">.</span><span class="ident" id="6607956">Close</span><span class="op" id="6607961">(</span><span class="op" id="6607962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6607968">return</span>&nbsp;<span class="ident" id="6607975">nil</span><span class="op" id="6607978">,</span>&nbsp;<span class="ident" id="6607980">errf</span><span class="op" id="6607984">(</span><span class="string" id="6607985">&#34;unsupported&nbsp;conversion&nbsp;for&nbsp;pre-bound&nbsp;parameter&nbsp;%q&nbsp;to&nbsp;type&nbsp;%q&#34;</span><span class="op" id="6608047">,</span>&nbsp;<span class="ident" id="6608049">value</span><span class="op" id="6608054">,</span>&nbsp;<span class="ident" id="6608056">ctype</span><span class="op" id="6608061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6608066">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6608071">stmt</span><span class="op" id="6608075">.</span><span class="ident" id="6608076">colValue</span>&nbsp;<span class="op" id="6608085">=</span>&nbsp;<span class="builtinfunc" id="6608087">append</span><span class="op" id="6608093">(</span><span class="ident" id="6608094">stmt</span><span class="op" id="6608098">.</span><span class="ident" id="6608099">colValue</span><span class="op" id="6608107">,</span>&nbsp;<span class="ident" id="6608109">subsetVal</span><span class="op" id="6608118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6608122">}</span>&nbsp;<span class="keyword" id="6608124">else</span>&nbsp;<span class="op" id="6608129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6608134">stmt</span><span class="op" id="6608138">.</span><span class="ident" id="6608139">placeholders</span><span class="op" id="6608151">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6608157">stmt</span><span class="op" id="6608161">.</span><span class="ident" id="6608162">placeholderConverter</span>&nbsp;<span class="op" id="6608183">=</span>&nbsp;<span class="builtinfunc" id="6608185">append</span><span class="op" id="6608191">(</span><span class="ident" id="6608192">stmt</span><span class="op" id="6608196">.</span><span class="ident" id="6608197">placeholderConverter</span><span class="op" id="6608217">,</span>&nbsp;<span class="ident" id="6608219">converterForType</span><span class="op" id="6608235">(</span><span class="ident" id="6608236">ctype</span><span class="op" id="6608241">)</span><span class="op" id="6608242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6608247">stmt</span><span class="op" id="6608251">.</span><span class="ident" id="6608252">colValue</span>&nbsp;<span class="op" id="6608261">=</span>&nbsp;<span class="builtinfunc" id="6608263">append</span><span class="op" id="6608269">(</span><span class="ident" id="6608270">stmt</span><span class="op" id="6608274">.</span><span class="ident" id="6608275">colValue</span><span class="op" id="6608283">,</span>&nbsp;<span class="string" id="6608285">&#34;?&#34;</span><span class="op" id="6608288">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6608292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6608295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6608298">return</span>&nbsp;<span class="ident" id="6608305">stmt</span><span class="op" id="6608309">,</span>&nbsp;<span class="ident" id="6608311">nil</span><br>
<span class="lineno"></span><span class="op" id="6608315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="6608318">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="6608357">var</span>&nbsp;<span class="ident" id="6608361">hookPrepareBadConn</span>&nbsp;<span class="keyword" id="6608380">func</span><span class="op" id="6608384">(</span><span class="op" id="6608385">)</span>&nbsp;<span class="builtintype" id="6608387">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6608393">func</span>&nbsp;<span class="op" id="6608398">(</span><span class="ident" id="6608399">c</span>&nbsp;<span class="op" id="6608401">*</span><span class="ident" id="6608402">fakeConn</span><span class="op" id="6608410">)</span>&nbsp;<span class="ident" id="6608412">Prepare</span><span class="op" id="6608419">(</span><span class="ident" id="6608420">query</span>&nbsp;<span class="builtintype" id="6608426">string</span><span class="op" id="6608432">)</span>&nbsp;<span class="op" id="6608434">(</span><span class="ident" id="6608435">driver</span><span class="op" id="6608441">.</span><span class="ident" id="6608442">Stmt</span><span class="op" id="6608446">,</span>&nbsp;<span class="builtintype" id="6608448">error</span><span class="op" id="6608453">)</span>&nbsp;<span class="op" id="6608455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6608458">c</span><span class="op" id="6608459">.</span><span class="ident" id="6608460">numPrepare</span><span class="op" id="6608470">++</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6608474">if</span>&nbsp;<span class="ident" id="6608477">c</span><span class="op" id="6608478">.</span><span class="ident" id="6608479">db</span>&nbsp;<span class="op" id="6608482">==</span>&nbsp;<span class="ident" id="6608485">nil</span>&nbsp;<span class="op" id="6608489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6608493">panic</span><span class="op" id="6608498">(</span><span class="string" id="6608499">&#34;nil&nbsp;c.db;&nbsp;conn&nbsp;=&nbsp;&#34;</span>&nbsp;<span class="op" id="6608519">+</span>&nbsp;<span class="ident" id="6608521">fmt</span><span class="op" id="6608524">.</span><span class="ident" id="6608525">Sprintf</span><span class="op" id="6608532">(</span><span class="string" id="6608533">&#34;%#v&#34;</span><span class="op" id="6608538">,</span>&nbsp;<span class="ident" id="6608540">c</span><span class="op" id="6608541">)</span><span class="op" id="6608542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6608545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6608549">if</span>&nbsp;<span class="ident" id="6608552">hookPrepareBadConn</span>&nbsp;<span class="op" id="6608571">!=</span>&nbsp;<span class="ident" id="6608574">nil</span>&nbsp;<span class="op" id="6608578">&amp;&amp;</span>&nbsp;<span class="ident" id="6608581">hookPrepareBadConn</span><span class="op" id="6608599">(</span><span class="op" id="6608600">)</span>&nbsp;<span class="op" id="6608602">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6608606">return</span>&nbsp;<span class="ident" id="6608613">nil</span><span class="op" id="6608616">,</span>&nbsp;<span class="ident" id="6608618">driver</span><span class="op" id="6608624">.</span><span class="ident" id="6608625">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6608637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6608641">parts</span>&nbsp;<span class="op" id="6608647">:=</span>&nbsp;<span class="ident" id="6608650">strings</span><span class="op" id="6608657">.</span><span class="ident" id="6608658">Split</span><span class="op" id="6608663">(</span><span class="ident" id="6608664">query</span><span class="op" id="6608669">,</span>&nbsp;<span class="string" id="6608671">&#34;|&#34;</span><span class="op" id="6608674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6608677">if</span>&nbsp;<span class="builtinfunc" id="6608680">len</span><span class="op" id="6608683">(</span><span class="ident" id="6608684">parts</span><span class="op" id="6608689">)</span>&nbsp;<span class="op" id="6608691">&lt;</span>&nbsp;<span class="num" id="6608693">1</span>&nbsp;<span class="op" id="6608695">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6608699">return</span>&nbsp;<span class="ident" id="6608706">nil</span><span class="op" id="6608709">,</span>&nbsp;<span class="ident" id="6608711">errf</span><span class="op" id="6608715">(</span><span class="string" id="6608716">&#34;empty&nbsp;query&#34;</span><span class="op" id="6608729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6608732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6608735">cmd</span>&nbsp;<span class="op" id="6608739">:=</span>&nbsp;<span class="ident" id="6608742">parts</span><span class="op" id="6608747">[</span><span class="num" id="6608748">0</span><span class="op" id="6608749">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6608752">parts</span>&nbsp;<span class="op" id="6608758">=</span>&nbsp;<span class="ident" id="6608760">parts</span><span class="op" id="6608765">[</span><span class="num" id="6608766">1</span><span class="op" id="6608767">:</span><span class="op" id="6608768">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6608771">stmt</span>&nbsp;<span class="op" id="6608776">:=</span>&nbsp;<span class="op" id="6608779">&amp;</span><span class="ident" id="6608780">fakeStmt</span><span class="op" id="6608788">{</span><span class="ident" id="6608789">q</span><span class="op" id="6608790">:</span>&nbsp;<span class="ident" id="6608792">query</span><span class="op" id="6608797">,</span>&nbsp;<span class="ident" id="6608799">c</span><span class="op" id="6608800">:</span>&nbsp;<span class="ident" id="6608802">c</span><span class="op" id="6608803">,</span>&nbsp;<span class="ident" id="6608805">cmd</span><span class="op" id="6608808">:</span>&nbsp;<span class="ident" id="6608810">cmd</span><span class="op" id="6608813">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6608816">c</span><span class="op" id="6608817">.</span><span class="ident" id="6608818">incrStat</span><span class="op" id="6608826">(</span><span class="op" id="6608827">&amp;</span><span class="ident" id="6608828">c</span><span class="op" id="6608829">.</span><span class="ident" id="6608830">stmtsMade</span><span class="op" id="6608839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6608842">switch</span>&nbsp;<span class="ident" id="6608849">cmd</span>&nbsp;<span class="op" id="6608853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6608856">case</span>&nbsp;<span class="string" id="6608861">&#34;WIPE&#34;</span><span class="op" id="6608867">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6608871">//&nbsp;Nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6608883">case</span>&nbsp;<span class="string" id="6608888">&#34;SELECT&#34;</span><span class="op" id="6608896">:</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6608900">return</span>&nbsp;<span class="ident" id="6608907">c</span><span class="op" id="6608908">.</span><span class="ident" id="6608909">prepareSelect</span><span class="op" id="6608922">(</span><span class="ident" id="6608923">stmt</span><span class="op" id="6608927">,</span>&nbsp;<span class="ident" id="6608929">parts</span><span class="op" id="6608934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6608937">case</span>&nbsp;<span class="string" id="6608942">&#34;CREATE&#34;</span><span class="op" id="6608950">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6608954">return</span>&nbsp;<span class="ident" id="6608961">c</span><span class="op" id="6608962">.</span><span class="ident" id="6608963">prepareCreate</span><span class="op" id="6608976">(</span><span class="ident" id="6608977">stmt</span><span class="op" id="6608981">,</span>&nbsp;<span class="ident" id="6608983">parts</span><span class="op" id="6608988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6608991">case</span>&nbsp;<span class="string" id="6608996">&#34;INSERT&#34;</span><span class="op" id="6609004">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6609008">return</span>&nbsp;<span class="ident" id="6609015">c</span><span class="op" id="6609016">.</span><span class="ident" id="6609017">prepareInsert</span><span class="op" id="6609030">(</span><span class="ident" id="6609031">stmt</span><span class="op" id="6609035">,</span>&nbsp;<span class="ident" id="6609037">parts</span><span class="op" id="6609042">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6609045">case</span>&nbsp;<span class="string" id="6609050">&#34;NOSERT&#34;</span><span class="op" id="6609058">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6609062">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6609142">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6609186">return</span>&nbsp;<span class="ident" id="6609193">c</span><span class="op" id="6609194">.</span><span class="ident" id="6609195">prepareInsert</span><span class="op" id="6609208">(</span><span class="ident" id="6609209">stmt</span><span class="op" id="6609213">,</span>&nbsp;<span class="ident" id="6609215">parts</span><span class="op" id="6609220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6609223">default</span><span class="op" id="6609230">:</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6609234">stmt</span><span class="op" id="6609238">.</span><span class="ident" id="6609239">Close</span><span class="op" id="6609244">(</span><span class="op" id="6609245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6609249">return</span>&nbsp;<span class="ident" id="6609256">nil</span><span class="op" id="6609259">,</span>&nbsp;<span class="ident" id="6609261">errf</span><span class="op" id="6609265">(</span><span class="string" id="6609266">&#34;unsupported&nbsp;command&nbsp;type&nbsp;%q&#34;</span><span class="op" id="6609295">,</span>&nbsp;<span class="ident" id="6609297">cmd</span><span class="op" id="6609300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6609303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6609306">return</span>&nbsp;<span class="ident" id="6609313">stmt</span><span class="op" id="6609317">,</span>&nbsp;<span class="ident" id="6609319">nil</span><br>
<span class="lineno"></span><span class="op" id="6609323">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="6609326">func</span>&nbsp;<span class="op" id="6609331">(</span><span class="ident" id="6609332">s</span>&nbsp;<span class="op" id="6609334">*</span><span class="ident" id="6609335">fakeStmt</span><span class="op" id="6609343">)</span>&nbsp;<span class="ident" id="6609345">ColumnConverter</span><span class="op" id="6609360">(</span><span class="ident" id="6609361">idx</span>&nbsp;<span class="builtintype" id="6609365">int</span><span class="op" id="6609368">)</span>&nbsp;<span class="ident" id="6609370">driver</span><span class="op" id="6609376">.</span><span class="ident" id="6609377">ValueConverter</span>&nbsp;<span class="op" id="6609392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6609395">if</span>&nbsp;<span class="builtinfunc" id="6609398">len</span><span class="op" id="6609401">(</span><span class="ident" id="6609402">s</span><span class="op" id="6609403">.</span><span class="ident" id="6609404">placeholderConverter</span><span class="op" id="6609424">)</span>&nbsp;<span class="op" id="6609426">==</span>&nbsp;<span class="num" id="6609429">0</span>&nbsp;<span class="op" id="6609431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6609435">return</span>&nbsp;<span class="ident" id="6609442">driver</span><span class="op" id="6609448">.</span><span class="ident" id="6609449">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6609476">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6609479">return</span>&nbsp;<span class="ident" id="6609486">s</span><span class="op" id="6609487">.</span><span class="ident" id="6609488">placeholderConverter</span><span class="op" id="6609508">[</span><span class="ident" id="6609509">idx</span><span class="op" id="6609512">]</span><br>
<span class="lineno"></span><span class="op" id="6609514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6609517">func</span>&nbsp;<span class="op" id="6609522">(</span><span class="ident" id="6609523">s</span>&nbsp;<span class="op" id="6609525">*</span><span class="ident" id="6609526">fakeStmt</span><span class="op" id="6609534">)</span>&nbsp;<span class="ident" id="6609536">Close</span><span class="op" id="6609541">(</span><span class="op" id="6609542">)</span>&nbsp;<span class="builtintype" id="6609544">error</span>&nbsp;<span class="op" id="6609550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6609553">if</span>&nbsp;<span class="ident" id="6609556">s</span><span class="op" id="6609557">.</span><span class="ident" id="6609558">c</span>&nbsp;<span class="op" id="6609560">==</span>&nbsp;<span class="ident" id="6609563">nil</span>&nbsp;<span class="op" id="6609567">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6609571">panic</span><span class="op" id="6609576">(</span><span class="string" id="6609577">&#34;nil&nbsp;conn&nbsp;in&nbsp;fakeStmt.Close&#34;</span><span class="op" id="6609605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6609608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6609611">if</span>&nbsp;<span class="ident" id="6609614">s</span><span class="op" id="6609615">.</span><span class="ident" id="6609616">c</span><span class="op" id="6609617">.</span><span class="ident" id="6609618">db</span>&nbsp;<span class="op" id="6609621">==</span>&nbsp;<span class="ident" id="6609624">nil</span>&nbsp;<span class="op" id="6609628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6609632">panic</span><span class="op" id="6609637">(</span><span class="string" id="6609638">&#34;in&nbsp;fakeStmt.Close,&nbsp;conn&#39;s&nbsp;db&nbsp;is&nbsp;nil&nbsp;(already&nbsp;closed)&#34;</span><span class="op" id="6609692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6609695">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6609698">if</span>&nbsp;<span class="op" id="6609701">!</span><span class="ident" id="6609702">s</span><span class="op" id="6609703">.</span><span class="ident" id="6609704">closed</span>&nbsp;<span class="op" id="6609711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6609715">s</span><span class="op" id="6609716">.</span><span class="ident" id="6609717">c</span><span class="op" id="6609718">.</span><span class="ident" id="6609719">incrStat</span><span class="op" id="6609727">(</span><span class="op" id="6609728">&amp;</span><span class="ident" id="6609729">s</span><span class="op" id="6609730">.</span><span class="ident" id="6609731">c</span><span class="op" id="6609732">.</span><span class="ident" id="6609733">stmtsClosed</span><span class="op" id="6609744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6609748">s</span><span class="op" id="6609749">.</span><span class="ident" id="6609750">closed</span>&nbsp;<span class="op" id="6609757">=</span>&nbsp;<span class="builtintype" id="6609759">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6609765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6609768">return</span>&nbsp;<span class="ident" id="6609775">nil</span><br>
<span class="lineno">520</span><span class="op" id="6609779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6609782">var</span>&nbsp;<span class="ident" id="6609786">errClosed</span>&nbsp;<span class="op" id="6609796">=</span>&nbsp;<span class="ident" id="6609798">errors</span><span class="op" id="6609804">.</span><span class="ident" id="6609805">New</span><span class="op" id="6609808">(</span><span class="string" id="6609809">&#34;fakedb:&nbsp;statement&nbsp;has&nbsp;been&nbsp;closed&#34;</span><span class="op" id="6609844">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6609847">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno">525</span><span class="keyword" id="6609886">var</span>&nbsp;<span class="ident" id="6609890">hookExecBadConn</span>&nbsp;<span class="keyword" id="6609906">func</span><span class="op" id="6609910">(</span><span class="op" id="6609911">)</span>&nbsp;<span class="builtintype" id="6609913">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6609919">func</span>&nbsp;<span class="op" id="6609924">(</span><span class="ident" id="6609925">s</span>&nbsp;<span class="op" id="6609927">*</span><span class="ident" id="6609928">fakeStmt</span><span class="op" id="6609936">)</span>&nbsp;<span class="ident" id="6609938">Exec</span><span class="op" id="6609942">(</span><span class="ident" id="6609943">args</span>&nbsp;<span class="op" id="6609948">[</span><span class="op" id="6609949">]</span><span class="ident" id="6609950">driver</span><span class="op" id="6609956">.</span><span class="ident" id="6609957">Value</span><span class="op" id="6609962">)</span>&nbsp;<span class="op" id="6609964">(</span><span class="ident" id="6609965">driver</span><span class="op" id="6609971">.</span><span class="ident" id="6609972">Result</span><span class="op" id="6609978">,</span>&nbsp;<span class="builtintype" id="6609980">error</span><span class="op" id="6609985">)</span>&nbsp;<span class="op" id="6609987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6609990">if</span>&nbsp;<span class="ident" id="6609993">s</span><span class="op" id="6609994">.</span><span class="ident" id="6609995">closed</span>&nbsp;<span class="op" id="6610002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610006">return</span>&nbsp;<span class="ident" id="6610013">nil</span><span class="op" id="6610016">,</span>&nbsp;<span class="ident" id="6610018">errClosed</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6610029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610033">if</span>&nbsp;<span class="ident" id="6610036">hookExecBadConn</span>&nbsp;<span class="op" id="6610052">!=</span>&nbsp;<span class="ident" id="6610055">nil</span>&nbsp;<span class="op" id="6610059">&amp;&amp;</span>&nbsp;<span class="ident" id="6610062">hookExecBadConn</span><span class="op" id="6610077">(</span><span class="op" id="6610078">)</span>&nbsp;<span class="op" id="6610080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610084">return</span>&nbsp;<span class="ident" id="6610091">nil</span><span class="op" id="6610094">,</span>&nbsp;<span class="ident" id="6610096">driver</span><span class="op" id="6610102">.</span><span class="ident" id="6610103">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6610115">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6610119">err</span>&nbsp;<span class="op" id="6610123">:=</span>&nbsp;<span class="ident" id="6610126">checkSubsetTypes</span><span class="op" id="6610142">(</span><span class="ident" id="6610143">args</span><span class="op" id="6610147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610150">if</span>&nbsp;<span class="ident" id="6610153">err</span>&nbsp;<span class="op" id="6610157">!=</span>&nbsp;<span class="ident" id="6610160">nil</span>&nbsp;<span class="op" id="6610164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610168">return</span>&nbsp;<span class="ident" id="6610175">nil</span><span class="op" id="6610178">,</span>&nbsp;<span class="ident" id="6610180">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6610185">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6610189">db</span>&nbsp;<span class="op" id="6610192">:=</span>&nbsp;<span class="ident" id="6610195">s</span><span class="op" id="6610196">.</span><span class="ident" id="6610197">c</span><span class="op" id="6610198">.</span><span class="ident" id="6610199">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610203">switch</span>&nbsp;<span class="ident" id="6610210">s</span><span class="op" id="6610211">.</span><span class="ident" id="6610212">cmd</span>&nbsp;<span class="op" id="6610216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610219">case</span>&nbsp;<span class="string" id="6610224">&#34;WIPE&#34;</span><span class="op" id="6610230">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6610234">db</span><span class="op" id="6610236">.</span><span class="ident" id="6610237">wipe</span><span class="op" id="6610241">(</span><span class="op" id="6610242">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610246">return</span>&nbsp;<span class="ident" id="6610253">driver</span><span class="op" id="6610259">.</span><span class="ident" id="6610260">ResultNoRows</span><span class="op" id="6610272">,</span>&nbsp;<span class="ident" id="6610274">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610279">case</span>&nbsp;<span class="string" id="6610284">&#34;CREATE&#34;</span><span class="op" id="6610292">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610296">if</span>&nbsp;<span class="ident" id="6610299">err</span>&nbsp;<span class="op" id="6610303">:=</span>&nbsp;<span class="ident" id="6610306">db</span><span class="op" id="6610308">.</span><span class="ident" id="6610309">createTable</span><span class="op" id="6610320">(</span><span class="ident" id="6610321">s</span><span class="op" id="6610322">.</span><span class="ident" id="6610323">table</span><span class="op" id="6610328">,</span>&nbsp;<span class="ident" id="6610330">s</span><span class="op" id="6610331">.</span><span class="ident" id="6610332">colName</span><span class="op" id="6610339">,</span>&nbsp;<span class="ident" id="6610341">s</span><span class="op" id="6610342">.</span><span class="ident" id="6610343">colType</span><span class="op" id="6610350">)</span><span class="op" id="6610351">;</span>&nbsp;<span class="ident" id="6610353">err</span>&nbsp;<span class="op" id="6610357">!=</span>&nbsp;<span class="ident" id="6610360">nil</span>&nbsp;<span class="op" id="6610364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610369">return</span>&nbsp;<span class="ident" id="6610376">nil</span><span class="op" id="6610379">,</span>&nbsp;<span class="ident" id="6610381">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6610387">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610391">return</span>&nbsp;<span class="ident" id="6610398">driver</span><span class="op" id="6610404">.</span><span class="ident" id="6610405">ResultNoRows</span><span class="op" id="6610417">,</span>&nbsp;<span class="ident" id="6610419">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610424">case</span>&nbsp;<span class="string" id="6610429">&#34;INSERT&#34;</span><span class="op" id="6610437">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610441">return</span>&nbsp;<span class="ident" id="6610448">s</span><span class="op" id="6610449">.</span><span class="ident" id="6610450">execInsert</span><span class="op" id="6610460">(</span><span class="ident" id="6610461">args</span><span class="op" id="6610465">,</span>&nbsp;<span class="builtintype" id="6610467">true</span><span class="op" id="6610471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610474">case</span>&nbsp;<span class="string" id="6610479">&#34;NOSERT&#34;</span><span class="op" id="6610487">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6610491">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6610571">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610615">return</span>&nbsp;<span class="ident" id="6610622">s</span><span class="op" id="6610623">.</span><span class="ident" id="6610624">execInsert</span><span class="op" id="6610634">(</span><span class="ident" id="6610635">args</span><span class="op" id="6610639">,</span>&nbsp;<span class="builtintype" id="6610641">false</span><span class="op" id="6610646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6610649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6610652">fmt</span><span class="op" id="6610655">.</span><span class="ident" id="6610656">Printf</span><span class="op" id="6610662">(</span><span class="string" id="6610663">&#34;EXEC&nbsp;statement,&nbsp;cmd=%q:&nbsp;%#v\n&#34;</span><span class="op" id="6610694">,</span>&nbsp;<span class="ident" id="6610696">s</span><span class="op" id="6610697">.</span><span class="ident" id="6610698">cmd</span><span class="op" id="6610701">,</span>&nbsp;<span class="ident" id="6610703">s</span><span class="op" id="6610704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6610707">return</span>&nbsp;<span class="ident" id="6610714">nil</span><span class="op" id="6610717">,</span>&nbsp;<span class="ident" id="6610719">fmt</span><span class="op" id="6610722">.</span><span class="ident" id="6610723">Errorf</span><span class="op" id="6610729">(</span><span class="string" id="6610730">&#34;unimplemented&nbsp;statement&nbsp;Exec&nbsp;command&nbsp;type&nbsp;of&nbsp;%q&#34;</span><span class="op" id="6610779">,</span>&nbsp;<span class="ident" id="6610781">s</span><span class="op" id="6610782">.</span><span class="ident" id="6610783">cmd</span><span class="op" id="6610786">)</span><br>
<span class="lineno">560</span><span class="op" id="6610788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6610791">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;true,&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span><span class="comment" id="6610843">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;false&nbsp;do&nbsp;prep-work&nbsp;and&nbsp;error&nbsp;checking,&nbsp;but&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="6610912">//&nbsp;actually&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno">565</span><span class="keyword" id="6610950">func</span>&nbsp;<span class="op" id="6610955">(</span><span class="ident" id="6610956">s</span>&nbsp;<span class="op" id="6610958">*</span><span class="ident" id="6610959">fakeStmt</span><span class="op" id="6610967">)</span>&nbsp;<span class="ident" id="6610969">execInsert</span><span class="op" id="6610979">(</span><span class="ident" id="6610980">args</span>&nbsp;<span class="op" id="6610985">[</span><span class="op" id="6610986">]</span><span class="ident" id="6610987">driver</span><span class="op" id="6610993">.</span><span class="ident" id="6610994">Value</span><span class="op" id="6610999">,</span>&nbsp;<span class="ident" id="6611001">doInsert</span>&nbsp;<span class="builtintype" id="6611010">bool</span><span class="op" id="6611014">)</span>&nbsp;<span class="op" id="6611016">(</span><span class="ident" id="6611017">driver</span><span class="op" id="6611023">.</span><span class="ident" id="6611024">Result</span><span class="op" id="6611030">,</span>&nbsp;<span class="builtintype" id="6611032">error</span><span class="op" id="6611037">)</span>&nbsp;<span class="op" id="6611039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6611042">db</span>&nbsp;<span class="op" id="6611045">:=</span>&nbsp;<span class="ident" id="6611048">s</span><span class="op" id="6611049">.</span><span class="ident" id="6611050">c</span><span class="op" id="6611051">.</span><span class="ident" id="6611052">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6611056">if</span>&nbsp;<span class="builtinfunc" id="6611059">len</span><span class="op" id="6611062">(</span><span class="ident" id="6611063">args</span><span class="op" id="6611067">)</span>&nbsp;<span class="op" id="6611069">!=</span>&nbsp;<span class="ident" id="6611072">s</span><span class="op" id="6611073">.</span><span class="ident" id="6611074">placeholders</span>&nbsp;<span class="op" id="6611087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6611091">panic</span><span class="op" id="6611096">(</span><span class="string" id="6611097">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="6611155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6611158">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6611161">db</span><span class="op" id="6611163">.</span><span class="ident" id="6611164">mu</span><span class="op" id="6611166">.</span><span class="ident" id="6611167">Lock</span><span class="op" id="6611171">(</span><span class="op" id="6611172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6611175">t</span><span class="op" id="6611176">,</span>&nbsp;<span class="ident" id="6611178">ok</span>&nbsp;<span class="op" id="6611181">:=</span>&nbsp;<span class="ident" id="6611184">db</span><span class="op" id="6611186">.</span><span class="ident" id="6611187">table</span><span class="op" id="6611192">(</span><span class="ident" id="6611193">s</span><span class="op" id="6611194">.</span><span class="ident" id="6611195">table</span><span class="op" id="6611200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6611203">db</span><span class="op" id="6611205">.</span><span class="ident" id="6611206">mu</span><span class="op" id="6611208">.</span><span class="ident" id="6611209">Unlock</span><span class="op" id="6611215">(</span><span class="op" id="6611216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6611219">if</span>&nbsp;<span class="op" id="6611222">!</span><span class="ident" id="6611223">ok</span>&nbsp;<span class="op" id="6611226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6611230">return</span>&nbsp;<span class="ident" id="6611237">nil</span><span class="op" id="6611240">,</span>&nbsp;<span class="ident" id="6611242">fmt</span><span class="op" id="6611245">.</span><span class="ident" id="6611246">Errorf</span><span class="op" id="6611252">(</span><span class="string" id="6611253">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="6611285">,</span>&nbsp;<span class="ident" id="6611287">s</span><span class="op" id="6611288">.</span><span class="ident" id="6611289">table</span><span class="op" id="6611294">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6611297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6611301">t</span><span class="op" id="6611302">.</span><span class="ident" id="6611303">mu</span><span class="op" id="6611305">.</span><span class="ident" id="6611306">Lock</span><span class="op" id="6611310">(</span><span class="op" id="6611311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6611314">defer</span>&nbsp;<span class="ident" id="6611320">t</span><span class="op" id="6611321">.</span><span class="ident" id="6611322">mu</span><span class="op" id="6611324">.</span><span class="ident" id="6611325">Unlock</span><span class="op" id="6611331">(</span><span class="op" id="6611332">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6611336">var</span>&nbsp;<span class="ident" id="6611340">cols</span>&nbsp;<span class="op" id="6611345">[</span><span class="op" id="6611346">]</span><span class="keyword" id="6611347">interface</span><span class="op" id="6611356">{</span><span class="op" id="6611357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6611360">if</span>&nbsp;<span class="ident" id="6611363">doInsert</span>&nbsp;<span class="op" id="6611372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6611376">cols</span>&nbsp;<span class="op" id="6611381">=</span>&nbsp;<span class="builtinfunc" id="6611383">make</span><span class="op" id="6611387">(</span><span class="op" id="6611388">[</span><span class="op" id="6611389">]</span><span class="keyword" id="6611390">interface</span><span class="op" id="6611399">{</span><span class="op" id="6611400">}</span><span class="op" id="6611401">,</span>&nbsp;<span class="builtinfunc" id="6611403">len</span><span class="op" id="6611406">(</span><span class="ident" id="6611407">t</span><span class="op" id="6611408">.</span><span class="ident" id="6611409">colname</span><span class="op" id="6611416">)</span><span class="op" id="6611417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6611420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6611423">argPos</span>&nbsp;<span class="op" id="6611430">:=</span>&nbsp;<span class="num" id="6611433">0</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6611436">for</span>&nbsp;<span class="ident" id="6611440">n</span><span class="op" id="6611441">,</span>&nbsp;<span class="ident" id="6611443">colname</span>&nbsp;<span class="op" id="6611451">:=</span>&nbsp;<span class="keyword" id="6611454">range</span>&nbsp;<span class="ident" id="6611460">s</span><span class="op" id="6611461">.</span><span class="ident" id="6611462">colName</span>&nbsp;<span class="op" id="6611470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6611474">colidx</span>&nbsp;<span class="op" id="6611481">:=</span>&nbsp;<span class="ident" id="6611484">t</span><span class="op" id="6611485">.</span><span class="ident" id="6611486">columnIndex</span><span class="op" id="6611497">(</span><span class="ident" id="6611498">colname</span><span class="op" id="6611505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6611509">if</span>&nbsp;<span class="ident" id="6611512">colidx</span>&nbsp;<span class="op" id="6611519">==</span>&nbsp;<span class="op" id="6611522">-</span><span class="num" id="6611523">1</span>&nbsp;<span class="op" id="6611525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6611530">return</span>&nbsp;<span class="ident" id="6611537">nil</span><span class="op" id="6611540">,</span>&nbsp;<span class="ident" id="6611542">fmt</span><span class="op" id="6611545">.</span><span class="ident" id="6611546">Errorf</span><span class="op" id="6611552">(</span><span class="string" id="6611553">&#34;fakedb:&nbsp;column&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&nbsp;or&nbsp;dropped&nbsp;since&nbsp;prepared&nbsp;statement&nbsp;was&nbsp;created&#34;</span><span class="op" id="6611634">,</span>&nbsp;<span class="ident" id="6611636">colname</span><span class="op" id="6611643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6611647">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6611651">var</span>&nbsp;<span class="ident" id="6611655">val</span>&nbsp;<span class="keyword" id="6611659">interface</span><span class="op" id="6611668">{</span><span class="op" id="6611669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6611673">if</span>&nbsp;<span class="ident" id="6611676">strvalue</span><span class="op" id="6611684">,</span>&nbsp;<span class="ident" id="6611686">ok</span>&nbsp;<span class="op" id="6611689">:=</span>&nbsp;<span class="ident" id="6611692">s</span><span class="op" id="6611693">.</span><span class="ident" id="6611694">colValue</span><span class="op" id="6611702">[</span><span class="ident" id="6611703">n</span><span class="op" id="6611704">]</span><span class="op" id="6611705">.</span><span class="op" id="6611706">(</span><span class="builtintype" id="6611707">string</span><span class="op" id="6611713">)</span><span class="op" id="6611714">;</span>&nbsp;<span class="ident" id="6611716">ok</span>&nbsp;<span class="op" id="6611719">&amp;&amp;</span>&nbsp;<span class="ident" id="6611722">strvalue</span>&nbsp;<span class="op" id="6611731">==</span>&nbsp;<span class="string" id="6611734">&#34;?&#34;</span>&nbsp;<span class="op" id="6611738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6611743">val</span>&nbsp;<span class="op" id="6611747">=</span>&nbsp;<span class="ident" id="6611749">args</span><span class="op" id="6611753">[</span><span class="ident" id="6611754">argPos</span><span class="op" id="6611760">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6611765">argPos</span><span class="op" id="6611771">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6611776">}</span>&nbsp;<span class="keyword" id="6611778">else</span>&nbsp;<span class="op" id="6611783">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6611788">val</span>&nbsp;<span class="op" id="6611792">=</span>&nbsp;<span class="ident" id="6611794">s</span><span class="op" id="6611795">.</span><span class="ident" id="6611796">colValue</span><span class="op" id="6611804">[</span><span class="ident" id="6611805">n</span><span class="op" id="6611806">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6611810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6611814">if</span>&nbsp;<span class="ident" id="6611817">doInsert</span>&nbsp;<span class="op" id="6611826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6611831">cols</span><span class="op" id="6611835">[</span><span class="ident" id="6611836">colidx</span><span class="op" id="6611842">]</span>&nbsp;<span class="op" id="6611844">=</span>&nbsp;<span class="ident" id="6611846">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6611852">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6611855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6611859">if</span>&nbsp;<span class="ident" id="6611862">doInsert</span>&nbsp;<span class="op" id="6611871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6611875">t</span><span class="op" id="6611876">.</span><span class="ident" id="6611877">rows</span>&nbsp;<span class="op" id="6611882">=</span>&nbsp;<span class="builtinfunc" id="6611884">append</span><span class="op" id="6611890">(</span><span class="ident" id="6611891">t</span><span class="op" id="6611892">.</span><span class="ident" id="6611893">rows</span><span class="op" id="6611897">,</span>&nbsp;<span class="op" id="6611899">&amp;</span><span class="ident" id="6611900">row</span><span class="op" id="6611903">{</span><span class="ident" id="6611904">cols</span><span class="op" id="6611908">:</span>&nbsp;<span class="ident" id="6611910">cols</span><span class="op" id="6611914">}</span><span class="op" id="6611915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6611918">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6611921">return</span>&nbsp;<span class="ident" id="6611928">driver</span><span class="op" id="6611934">.</span><span class="ident" id="6611935">RowsAffected</span><span class="op" id="6611947">(</span><span class="num" id="6611948">1</span><span class="op" id="6611949">)</span><span class="op" id="6611950">,</span>&nbsp;<span class="ident" id="6611952">nil</span><br>
<span class="lineno"></span><span class="op" id="6611956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6611959">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="6611998">var</span>&nbsp;<span class="ident" id="6612002">hookQueryBadConn</span>&nbsp;<span class="keyword" id="6612019">func</span><span class="op" id="6612023">(</span><span class="op" id="6612024">)</span>&nbsp;<span class="builtintype" id="6612026">bool</span><br>
<span class="lineno">610</span><br>
<span class="lineno"></span><span class="keyword" id="6612032">func</span>&nbsp;<span class="op" id="6612037">(</span><span class="ident" id="6612038">s</span>&nbsp;<span class="op" id="6612040">*</span><span class="ident" id="6612041">fakeStmt</span><span class="op" id="6612049">)</span>&nbsp;<span class="ident" id="6612051">Query</span><span class="op" id="6612056">(</span><span class="ident" id="6612057">args</span>&nbsp;<span class="op" id="6612062">[</span><span class="op" id="6612063">]</span><span class="ident" id="6612064">driver</span><span class="op" id="6612070">.</span><span class="ident" id="6612071">Value</span><span class="op" id="6612076">)</span>&nbsp;<span class="op" id="6612078">(</span><span class="ident" id="6612079">driver</span><span class="op" id="6612085">.</span><span class="ident" id="6612086">Rows</span><span class="op" id="6612090">,</span>&nbsp;<span class="builtintype" id="6612092">error</span><span class="op" id="6612097">)</span>&nbsp;<span class="op" id="6612099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6612102">if</span>&nbsp;<span class="ident" id="6612105">s</span><span class="op" id="6612106">.</span><span class="ident" id="6612107">closed</span>&nbsp;<span class="op" id="6612114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6612118">return</span>&nbsp;<span class="ident" id="6612125">nil</span><span class="op" id="6612128">,</span>&nbsp;<span class="ident" id="6612130">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6612141">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6612145">if</span>&nbsp;<span class="ident" id="6612148">hookQueryBadConn</span>&nbsp;<span class="op" id="6612165">!=</span>&nbsp;<span class="ident" id="6612168">nil</span>&nbsp;<span class="op" id="6612172">&amp;&amp;</span>&nbsp;<span class="ident" id="6612175">hookQueryBadConn</span><span class="op" id="6612191">(</span><span class="op" id="6612192">)</span>&nbsp;<span class="op" id="6612194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6612198">return</span>&nbsp;<span class="ident" id="6612205">nil</span><span class="op" id="6612208">,</span>&nbsp;<span class="ident" id="6612210">driver</span><span class="op" id="6612216">.</span><span class="ident" id="6612217">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6612229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6612233">err</span>&nbsp;<span class="op" id="6612237">:=</span>&nbsp;<span class="ident" id="6612240">checkSubsetTypes</span><span class="op" id="6612256">(</span><span class="ident" id="6612257">args</span><span class="op" id="6612261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6612264">if</span>&nbsp;<span class="ident" id="6612267">err</span>&nbsp;<span class="op" id="6612271">!=</span>&nbsp;<span class="ident" id="6612274">nil</span>&nbsp;<span class="op" id="6612278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6612282">return</span>&nbsp;<span class="ident" id="6612289">nil</span><span class="op" id="6612292">,</span>&nbsp;<span class="ident" id="6612294">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6612299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6612303">db</span>&nbsp;<span class="op" id="6612306">:=</span>&nbsp;<span class="ident" id="6612309">s</span><span class="op" id="6612310">.</span><span class="ident" id="6612311">c</span><span class="op" id="6612312">.</span><span class="ident" id="6612313">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6612317">if</span>&nbsp;<span class="builtinfunc" id="6612320">len</span><span class="op" id="6612323">(</span><span class="ident" id="6612324">args</span><span class="op" id="6612328">)</span>&nbsp;<span class="op" id="6612330">!=</span>&nbsp;<span class="ident" id="6612333">s</span><span class="op" id="6612334">.</span><span class="ident" id="6612335">placeholders</span>&nbsp;<span class="op" id="6612348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6612352">panic</span><span class="op" id="6612357">(</span><span class="string" id="6612358">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="6612416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6612419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6612423">db</span><span class="op" id="6612425">.</span><span class="ident" id="6612426">mu</span><span class="op" id="6612428">.</span><span class="ident" id="6612429">Lock</span><span class="op" id="6612433">(</span><span class="op" id="6612434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6612437">t</span><span class="op" id="6612438">,</span>&nbsp;<span class="ident" id="6612440">ok</span>&nbsp;<span class="op" id="6612443">:=</span>&nbsp;<span class="ident" id="6612446">db</span><span class="op" id="6612448">.</span><span class="ident" id="6612449">table</span><span class="op" id="6612454">(</span><span class="ident" id="6612455">s</span><span class="op" id="6612456">.</span><span class="ident" id="6612457">table</span><span class="op" id="6612462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6612465">db</span><span class="op" id="6612467">.</span><span class="ident" id="6612468">mu</span><span class="op" id="6612470">.</span><span class="ident" id="6612471">Unlock</span><span class="op" id="6612477">(</span><span class="op" id="6612478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6612481">if</span>&nbsp;<span class="op" id="6612484">!</span><span class="ident" id="6612485">ok</span>&nbsp;<span class="op" id="6612488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6612492">return</span>&nbsp;<span class="ident" id="6612499">nil</span><span class="op" id="6612502">,</span>&nbsp;<span class="ident" id="6612504">fmt</span><span class="op" id="6612507">.</span><span class="ident" id="6612508">Errorf</span><span class="op" id="6612514">(</span><span class="string" id="6612515">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="6612547">,</span>&nbsp;<span class="ident" id="6612549">s</span><span class="op" id="6612550">.</span><span class="ident" id="6612551">table</span><span class="op" id="6612556">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6612559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6612563">if</span>&nbsp;<span class="ident" id="6612566">s</span><span class="op" id="6612567">.</span><span class="ident" id="6612568">table</span>&nbsp;<span class="op" id="6612574">==</span>&nbsp;<span class="string" id="6612577">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="6612590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6612594">if</span>&nbsp;<span class="builtinfunc" id="6612597">len</span><span class="op" id="6612600">(</span><span class="ident" id="6612601">s</span><span class="op" id="6612602">.</span><span class="ident" id="6612603">whereCol</span><span class="op" id="6612611">)</span>&nbsp;<span class="op" id="6612613">==</span>&nbsp;<span class="num" id="6612616">2</span>&nbsp;<span class="op" id="6612618">&amp;&amp;</span>&nbsp;<span class="ident" id="6612621">s</span><span class="op" id="6612622">.</span><span class="ident" id="6612623">whereCol</span><span class="op" id="6612631">[</span><span class="num" id="6612632">0</span><span class="op" id="6612633">]</span>&nbsp;<span class="op" id="6612635">==</span>&nbsp;<span class="string" id="6612638">&#34;op&#34;</span>&nbsp;<span class="op" id="6612643">&amp;&amp;</span>&nbsp;<span class="ident" id="6612646">s</span><span class="op" id="6612647">.</span><span class="ident" id="6612648">whereCol</span><span class="op" id="6612656">[</span><span class="num" id="6612657">1</span><span class="op" id="6612658">]</span>&nbsp;<span class="op" id="6612660">==</span>&nbsp;<span class="string" id="6612663">&#34;millis&#34;</span>&nbsp;<span class="op" id="6612672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6612677">if</span>&nbsp;<span class="ident" id="6612680">args</span><span class="op" id="6612684">[</span><span class="num" id="6612685">0</span><span class="op" id="6612686">]</span>&nbsp;<span class="op" id="6612688">==</span>&nbsp;<span class="string" id="6612691">&#34;sleep&#34;</span>&nbsp;<span class="op" id="6612699">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6612705">time</span><span class="op" id="6612709">.</span><span class="ident" id="6612710">Sleep</span><span class="op" id="6612715">(</span><span class="ident" id="6612716">time</span><span class="op" id="6612720">.</span><span class="ident" id="6612721">Duration</span><span class="op" id="6612729">(</span><span class="ident" id="6612730">args</span><span class="op" id="6612734">[</span><span class="num" id="6612735">1</span><span class="op" id="6612736">]</span><span class="op" id="6612737">.</span><span class="op" id="6612738">(</span><span class="ident" id="6612739">int64</span><span class="op" id="6612744">)</span><span class="op" id="6612745">)</span>&nbsp;<span class="op" id="6612747">*</span>&nbsp;<span class="ident" id="6612749">time</span><span class="op" id="6612753">.</span><span class="ident" id="6612754">Millisecond</span><span class="op" id="6612765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6612770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6612774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6612777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6612781">t</span><span class="op" id="6612782">.</span><span class="ident" id="6612783">mu</span><span class="op" id="6612785">.</span><span class="ident" id="6612786">Lock</span><span class="op" id="6612790">(</span><span class="op" id="6612791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6612794">defer</span>&nbsp;<span class="ident" id="6612800">t</span><span class="op" id="6612801">.</span><span class="ident" id="6612802">mu</span><span class="op" id="6612804">.</span><span class="ident" id="6612805">Unlock</span><span class="op" id="6612811">(</span><span class="op" id="6612812">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6612816">colIdx</span>&nbsp;<span class="op" id="6612823">:=</span>&nbsp;<span class="builtinfunc" id="6612826">make</span><span class="op" id="6612830">(</span><span class="keyword" id="6612831">map</span><span class="op" id="6612834">[</span><span class="builtintype" id="6612835">string</span><span class="op" id="6612841">]</span><span class="builtintype" id="6612842">int</span><span class="op" id="6612845">)</span>&nbsp;<span class="comment" id="6612847">//&nbsp;select&nbsp;column&nbsp;name&nbsp;-&gt;&nbsp;column&nbsp;index&nbsp;in&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6612895">for</span>&nbsp;<span class="ident" id="6612899">_</span><span class="op" id="6612900">,</span>&nbsp;<span class="ident" id="6612902">name</span>&nbsp;<span class="op" id="6612907">:=</span>&nbsp;<span class="keyword" id="6612910">range</span>&nbsp;<span class="ident" id="6612916">s</span><span class="op" id="6612917">.</span><span class="ident" id="6612918">colName</span>&nbsp;<span class="op" id="6612926">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6612930">idx</span>&nbsp;<span class="op" id="6612934">:=</span>&nbsp;<span class="ident" id="6612937">t</span><span class="op" id="6612938">.</span><span class="ident" id="6612939">columnIndex</span><span class="op" id="6612950">(</span><span class="ident" id="6612951">name</span><span class="op" id="6612955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6612959">if</span>&nbsp;<span class="ident" id="6612962">idx</span>&nbsp;<span class="op" id="6612966">==</span>&nbsp;<span class="op" id="6612969">-</span><span class="num" id="6612970">1</span>&nbsp;<span class="op" id="6612972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6612977">return</span>&nbsp;<span class="ident" id="6612984">nil</span><span class="op" id="6612987">,</span>&nbsp;<span class="ident" id="6612989">fmt</span><span class="op" id="6612992">.</span><span class="ident" id="6612993">Errorf</span><span class="op" id="6612999">(</span><span class="string" id="6613000">&#34;fakedb:&nbsp;unknown&nbsp;column&nbsp;name&nbsp;%q&#34;</span><span class="op" id="6613032">,</span>&nbsp;<span class="ident" id="6613034">name</span><span class="op" id="6613038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6613042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613046">colIdx</span><span class="op" id="6613052">[</span><span class="ident" id="6613053">name</span><span class="op" id="6613057">]</span>&nbsp;<span class="op" id="6613059">=</span>&nbsp;<span class="ident" id="6613061">idx</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6613066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613070">mrows</span>&nbsp;<span class="op" id="6613076">:=</span>&nbsp;<span class="op" id="6613079">[</span><span class="op" id="6613080">]</span><span class="op" id="6613081">*</span><span class="ident" id="6613082">row</span><span class="op" id="6613085">{</span><span class="op" id="6613086">}</span><br>
<span class="lineno"></span><span class="ident" id="6613088">rows</span><span class="op" id="6613092">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6613095">for</span>&nbsp;<span class="ident" id="6613099">_</span><span class="op" id="6613100">,</span>&nbsp;<span class="ident" id="6613102">trow</span>&nbsp;<span class="op" id="6613107">:=</span>&nbsp;<span class="keyword" id="6613110">range</span>&nbsp;<span class="ident" id="6613116">t</span><span class="op" id="6613117">.</span><span class="ident" id="6613118">rows</span>&nbsp;<span class="op" id="6613123">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6613127">//&nbsp;Process&nbsp;the&nbsp;where&nbsp;clause,&nbsp;skipping&nbsp;non-match&nbsp;rows.&nbsp;This&nbsp;is&nbsp;lazy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6613196">//&nbsp;and&nbsp;just&nbsp;uses&nbsp;fmt.Sprintf(&#34;%v&#34;)&nbsp;to&nbsp;test&nbsp;equality.&nbsp;&nbsp;Good&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6613264">//&nbsp;for&nbsp;test&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6613284">for</span>&nbsp;<span class="ident" id="6613288">widx</span><span class="op" id="6613292">,</span>&nbsp;<span class="ident" id="6613294">wcol</span>&nbsp;<span class="op" id="6613299">:=</span>&nbsp;<span class="keyword" id="6613302">range</span>&nbsp;<span class="ident" id="6613308">s</span><span class="op" id="6613309">.</span><span class="ident" id="6613310">whereCol</span>&nbsp;<span class="op" id="6613319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613324">idx</span>&nbsp;<span class="op" id="6613328">:=</span>&nbsp;<span class="ident" id="6613331">t</span><span class="op" id="6613332">.</span><span class="ident" id="6613333">columnIndex</span><span class="op" id="6613344">(</span><span class="ident" id="6613345">wcol</span><span class="op" id="6613349">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6613354">if</span>&nbsp;<span class="ident" id="6613357">idx</span>&nbsp;<span class="op" id="6613361">==</span>&nbsp;<span class="op" id="6613364">-</span><span class="num" id="6613365">1</span>&nbsp;<span class="op" id="6613367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6613373">return</span>&nbsp;<span class="ident" id="6613380">nil</span><span class="op" id="6613383">,</span>&nbsp;<span class="ident" id="6613385">fmt</span><span class="op" id="6613388">.</span><span class="ident" id="6613389">Errorf</span><span class="op" id="6613395">(</span><span class="string" id="6613396">&#34;db:&nbsp;invalid&nbsp;where&nbsp;clause&nbsp;column&nbsp;%q&#34;</span><span class="op" id="6613432">,</span>&nbsp;<span class="ident" id="6613434">wcol</span><span class="op" id="6613438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6613443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613448">tcol</span>&nbsp;<span class="op" id="6613453">:=</span>&nbsp;<span class="ident" id="6613456">trow</span><span class="op" id="6613460">.</span><span class="ident" id="6613461">cols</span><span class="op" id="6613465">[</span><span class="ident" id="6613466">idx</span><span class="op" id="6613469">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6613474">if</span>&nbsp;<span class="ident" id="6613477">bs</span><span class="op" id="6613479">,</span>&nbsp;<span class="ident" id="6613481">ok</span>&nbsp;<span class="op" id="6613484">:=</span>&nbsp;<span class="ident" id="6613487">tcol</span><span class="op" id="6613491">.</span><span class="op" id="6613492">(</span><span class="op" id="6613493">[</span><span class="op" id="6613494">]</span><span class="builtintype" id="6613495">byte</span><span class="op" id="6613499">)</span><span class="op" id="6613500">;</span>&nbsp;<span class="ident" id="6613502">ok</span>&nbsp;<span class="op" id="6613505">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6613511">//&nbsp;lazy&nbsp;hack&nbsp;to&nbsp;avoid&nbsp;sprintf&nbsp;%v&nbsp;on&nbsp;a&nbsp;[]byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613560">tcol</span>&nbsp;<span class="op" id="6613565">=</span>&nbsp;<span class="builtintype" id="6613567">string</span><span class="op" id="6613573">(</span><span class="ident" id="6613574">bs</span><span class="op" id="6613576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6613581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6613586">if</span>&nbsp;<span class="ident" id="6613589">fmt</span><span class="op" id="6613592">.</span><span class="ident" id="6613593">Sprintf</span><span class="op" id="6613600">(</span><span class="string" id="6613601">&#34;%v&#34;</span><span class="op" id="6613605">,</span>&nbsp;<span class="ident" id="6613607">tcol</span><span class="op" id="6613611">)</span>&nbsp;<span class="op" id="6613613">!=</span>&nbsp;<span class="ident" id="6613616">fmt</span><span class="op" id="6613619">.</span><span class="ident" id="6613620">Sprintf</span><span class="op" id="6613627">(</span><span class="string" id="6613628">&#34;%v&#34;</span><span class="op" id="6613632">,</span>&nbsp;<span class="ident" id="6613634">args</span><span class="op" id="6613638">[</span><span class="ident" id="6613639">widx</span><span class="op" id="6613643">]</span><span class="op" id="6613644">)</span>&nbsp;<span class="op" id="6613646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6613652">continue</span>&nbsp;<span class="ident" id="6613661">rows</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6613669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6613673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613677">mrow</span>&nbsp;<span class="op" id="6613682">:=</span>&nbsp;<span class="op" id="6613685">&amp;</span><span class="ident" id="6613686">row</span><span class="op" id="6613689">{</span><span class="ident" id="6613690">cols</span><span class="op" id="6613694">:</span>&nbsp;<span class="builtinfunc" id="6613696">make</span><span class="op" id="6613700">(</span><span class="op" id="6613701">[</span><span class="op" id="6613702">]</span><span class="keyword" id="6613703">interface</span><span class="op" id="6613712">{</span><span class="op" id="6613713">}</span><span class="op" id="6613714">,</span>&nbsp;<span class="builtinfunc" id="6613716">len</span><span class="op" id="6613719">(</span><span class="ident" id="6613720">s</span><span class="op" id="6613721">.</span><span class="ident" id="6613722">colName</span><span class="op" id="6613729">)</span><span class="op" id="6613730">)</span><span class="op" id="6613731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6613735">for</span>&nbsp;<span class="ident" id="6613739">seli</span><span class="op" id="6613743">,</span>&nbsp;<span class="ident" id="6613745">name</span>&nbsp;<span class="op" id="6613750">:=</span>&nbsp;<span class="keyword" id="6613753">range</span>&nbsp;<span class="ident" id="6613759">s</span><span class="op" id="6613760">.</span><span class="ident" id="6613761">colName</span>&nbsp;<span class="op" id="6613769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613774">mrow</span><span class="op" id="6613778">.</span><span class="ident" id="6613779">cols</span><span class="op" id="6613783">[</span><span class="ident" id="6613784">seli</span><span class="op" id="6613788">]</span>&nbsp;<span class="op" id="6613790">=</span>&nbsp;<span class="ident" id="6613792">trow</span><span class="op" id="6613796">.</span><span class="ident" id="6613797">cols</span><span class="op" id="6613801">[</span><span class="ident" id="6613802">colIdx</span><span class="op" id="6613808">[</span><span class="ident" id="6613809">name</span><span class="op" id="6613813">]</span><span class="op" id="6613814">]</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6613818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613822">mrows</span>&nbsp;<span class="op" id="6613828">=</span>&nbsp;<span class="builtinfunc" id="6613830">append</span><span class="op" id="6613836">(</span><span class="ident" id="6613837">mrows</span><span class="op" id="6613842">,</span>&nbsp;<span class="ident" id="6613844">mrow</span><span class="op" id="6613848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6613851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613855">cursor</span>&nbsp;<span class="op" id="6613862">:=</span>&nbsp;<span class="op" id="6613865">&amp;</span><span class="ident" id="6613866">rowsCursor</span><span class="op" id="6613876">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613880">pos</span><span class="op" id="6613883">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6613888">-</span><span class="num" id="6613889">1</span><span class="op" id="6613890">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613894">rows</span><span class="op" id="6613898">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6613902">mrows</span><span class="op" id="6613907">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613911">cols</span><span class="op" id="6613915">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6613919">s</span><span class="op" id="6613920">.</span><span class="ident" id="6613921">colName</span><span class="op" id="6613928">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6613932">errPos</span><span class="op" id="6613938">:</span>&nbsp;<span class="op" id="6613940">-</span><span class="num" id="6613941">1</span><span class="op" id="6613942">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6613945">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6613948">return</span>&nbsp;<span class="ident" id="6613955">cursor</span><span class="op" id="6613961">,</span>&nbsp;<span class="ident" id="6613963">nil</span><br>
<span class="lineno"></span><span class="op" id="6613967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6613970">func</span>&nbsp;<span class="op" id="6613975">(</span><span class="ident" id="6613976">s</span>&nbsp;<span class="op" id="6613978">*</span><span class="ident" id="6613979">fakeStmt</span><span class="op" id="6613987">)</span>&nbsp;<span class="ident" id="6613989">NumInput</span><span class="op" id="6613997">(</span><span class="op" id="6613998">)</span>&nbsp;<span class="builtintype" id="6614000">int</span>&nbsp;<span class="op" id="6614004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6614007">return</span>&nbsp;<span class="ident" id="6614014">s</span><span class="op" id="6614015">.</span><span class="ident" id="6614016">placeholders</span><br>
<span class="lineno">695</span><span class="op" id="6614029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6614032">func</span>&nbsp;<span class="op" id="6614037">(</span><span class="ident" id="6614038">tx</span>&nbsp;<span class="op" id="6614041">*</span><span class="ident" id="6614042">fakeTx</span><span class="op" id="6614048">)</span>&nbsp;<span class="ident" id="6614050">Commit</span><span class="op" id="6614056">(</span><span class="op" id="6614057">)</span>&nbsp;<span class="builtintype" id="6614059">error</span>&nbsp;<span class="op" id="6614065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614068">tx</span><span class="op" id="6614070">.</span><span class="ident" id="6614071">c</span><span class="op" id="6614072">.</span><span class="ident" id="6614073">currTx</span>&nbsp;<span class="op" id="6614080">=</span>&nbsp;<span class="ident" id="6614082">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6614087">return</span>&nbsp;<span class="ident" id="6614094">nil</span><br>
<span class="lineno">700</span><span class="op" id="6614098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6614101">func</span>&nbsp;<span class="op" id="6614106">(</span><span class="ident" id="6614107">tx</span>&nbsp;<span class="op" id="6614110">*</span><span class="ident" id="6614111">fakeTx</span><span class="op" id="6614117">)</span>&nbsp;<span class="ident" id="6614119">Rollback</span><span class="op" id="6614127">(</span><span class="op" id="6614128">)</span>&nbsp;<span class="builtintype" id="6614130">error</span>&nbsp;<span class="op" id="6614136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614139">tx</span><span class="op" id="6614141">.</span><span class="ident" id="6614142">c</span><span class="op" id="6614143">.</span><span class="ident" id="6614144">currTx</span>&nbsp;<span class="op" id="6614151">=</span>&nbsp;<span class="ident" id="6614153">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6614158">return</span>&nbsp;<span class="ident" id="6614165">nil</span><br>
<span class="lineno">705</span><span class="op" id="6614169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6614172">type</span>&nbsp;<span class="ident" id="6614177">rowsCursor</span>&nbsp;<span class="keyword" id="6614188">struct</span>&nbsp;<span class="op" id="6614195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614198">cols</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6614205">[</span><span class="op" id="6614206">]</span><span class="builtintype" id="6614207">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614215">pos</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6614222">int</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614227">rows</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6614234">[</span><span class="op" id="6614235">]</span><span class="op" id="6614236">*</span><span class="ident" id="6614237">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614242">closed</span>&nbsp;<span class="builtintype" id="6614249">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6614256">//&nbsp;errPos&nbsp;and&nbsp;err&nbsp;are&nbsp;for&nbsp;making&nbsp;Next&nbsp;return&nbsp;early&nbsp;with&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614320">errPos</span>&nbsp;<span class="builtintype" id="6614327">int</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614332">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6614339">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6614347">//&nbsp;a&nbsp;clone&nbsp;of&nbsp;slices&nbsp;to&nbsp;give&nbsp;out&nbsp;to&nbsp;clients,&nbsp;indexed&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6614408">//&nbsp;the&nbsp;original&nbsp;slice&#39;s&nbsp;first&nbsp;byte&nbsp;address.&nbsp;&nbsp;we&nbsp;clone&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6614468">//&nbsp;just&nbsp;so&nbsp;we&#39;re&nbsp;able&nbsp;to&nbsp;corrupt&nbsp;them&nbsp;on&nbsp;close.</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614517">bytesClone</span>&nbsp;<span class="keyword" id="6614528">map</span><span class="op" id="6614531">[</span><span class="op" id="6614532">*</span><span class="builtintype" id="6614533">byte</span><span class="op" id="6614537">]</span><span class="op" id="6614538">[</span><span class="op" id="6614539">]</span><span class="builtintype" id="6614540">byte</span><br>
<span class="lineno"></span><span class="op" id="6614545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6614548">func</span>&nbsp;<span class="op" id="6614553">(</span><span class="ident" id="6614554">rc</span>&nbsp;<span class="op" id="6614557">*</span><span class="ident" id="6614558">rowsCursor</span><span class="op" id="6614568">)</span>&nbsp;<span class="ident" id="6614570">Close</span><span class="op" id="6614575">(</span><span class="op" id="6614576">)</span>&nbsp;<span class="builtintype" id="6614578">error</span>&nbsp;<span class="op" id="6614584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6614587">if</span>&nbsp;<span class="op" id="6614590">!</span><span class="ident" id="6614591">rc</span><span class="op" id="6614593">.</span><span class="ident" id="6614594">closed</span>&nbsp;<span class="op" id="6614601">{</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6614605">for</span>&nbsp;<span class="ident" id="6614609">_</span><span class="op" id="6614610">,</span>&nbsp;<span class="ident" id="6614612">bs</span>&nbsp;<span class="op" id="6614615">:=</span>&nbsp;<span class="keyword" id="6614618">range</span>&nbsp;<span class="ident" id="6614624">rc</span><span class="op" id="6614626">.</span><span class="ident" id="6614627">bytesClone</span>&nbsp;<span class="op" id="6614638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614643">bs</span><span class="op" id="6614645">[</span><span class="num" id="6614646">0</span><span class="op" id="6614647">]</span>&nbsp;<span class="op" id="6614649">=</span>&nbsp;<span class="num" id="6614651">255</span>&nbsp;<span class="comment" id="6614655">//&nbsp;first&nbsp;byte&nbsp;corrupted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6614687">rc</span><span class="op" id="6614689">.</span><span class="ident" id="6614690">closed</span>&nbsp;<span class="op" id="6614697">=</span>&nbsp;<span class="builtintype" id="6614699">true</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6614705">return</span>&nbsp;<span class="ident" id="6614712">nil</span><br>
<span class="lineno"></span><span class="op" id="6614716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6614719">func</span>&nbsp;<span class="op" id="6614724">(</span><span class="ident" id="6614725">rc</span>&nbsp;<span class="op" id="6614728">*</span><span class="ident" id="6614729">rowsCursor</span><span class="op" id="6614739">)</span>&nbsp;<span class="ident" id="6614741">Columns</span><span class="op" id="6614748">(</span><span class="op" id="6614749">)</span>&nbsp;<span class="op" id="6614751">[</span><span class="op" id="6614752">]</span><span class="builtintype" id="6614753">string</span>&nbsp;<span class="op" id="6614760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6614763">return</span>&nbsp;<span class="ident" id="6614770">rc</span><span class="op" id="6614772">.</span><span class="ident" id="6614773">cols</span><br>
<span class="lineno">735</span><span class="op" id="6614778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6614781">var</span>&nbsp;<span class="ident" id="6614785">rowsCursorNextHook</span>&nbsp;<span class="keyword" id="6614804">func</span><span class="op" id="6614808">(</span><span class="ident" id="6614809">dest</span>&nbsp;<span class="op" id="6614814">[</span><span class="op" id="6614815">]</span><span class="ident" id="6614816">driver</span><span class="op" id="6614822">.</span><span class="ident" id="6614823">Value</span><span class="op" id="6614828">)</span>&nbsp;<span class="builtintype" id="6614830">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6614837">func</span>&nbsp;<span class="op" id="6614842">(</span><span class="ident" id="6614843">rc</span>&nbsp;<span class="op" id="6614846">*</span><span class="ident" id="6614847">rowsCursor</span><span class="op" id="6614857">)</span>&nbsp;<span class="ident" id="6614859">Next</span><span class="op" id="6614863">(</span><span class="ident" id="6614864">dest</span>&nbsp;<span class="op" id="6614869">[</span><span class="op" id="6614870">]</span><span class="ident" id="6614871">driver</span><span class="op" id="6614877">.</span><span class="ident" id="6614878">Value</span><span class="op" id="6614883">)</span>&nbsp;<span class="builtintype" id="6614885">error</span>&nbsp;<span class="op" id="6614891">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6614894">if</span>&nbsp;<span class="ident" id="6614897">rowsCursorNextHook</span>&nbsp;<span class="op" id="6614916">!=</span>&nbsp;<span class="ident" id="6614919">nil</span>&nbsp;<span class="op" id="6614923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6614927">return</span>&nbsp;<span class="ident" id="6614934">rowsCursorNextHook</span><span class="op" id="6614952">(</span><span class="ident" id="6614953">dest</span><span class="op" id="6614957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6614960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6614964">if</span>&nbsp;<span class="ident" id="6614967">rc</span><span class="op" id="6614969">.</span><span class="ident" id="6614970">closed</span>&nbsp;<span class="op" id="6614977">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6614981">return</span>&nbsp;<span class="ident" id="6614988">errors</span><span class="op" id="6614994">.</span><span class="ident" id="6614995">New</span><span class="op" id="6614998">(</span><span class="string" id="6614999">&#34;fakedb:&nbsp;cursor&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6615025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6615028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6615031">rc</span><span class="op" id="6615033">.</span><span class="ident" id="6615034">pos</span><span class="op" id="6615037">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6615041">if</span>&nbsp;<span class="ident" id="6615044">rc</span><span class="op" id="6615046">.</span><span class="ident" id="6615047">pos</span>&nbsp;<span class="op" id="6615051">==</span>&nbsp;<span class="ident" id="6615054">rc</span><span class="op" id="6615056">.</span><span class="ident" id="6615057">errPos</span>&nbsp;<span class="op" id="6615064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6615068">return</span>&nbsp;<span class="ident" id="6615075">rc</span><span class="op" id="6615077">.</span><span class="ident" id="6615078">err</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6615083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6615086">if</span>&nbsp;<span class="ident" id="6615089">rc</span><span class="op" id="6615091">.</span><span class="ident" id="6615092">pos</span>&nbsp;<span class="op" id="6615096">&gt;=</span>&nbsp;<span class="builtinfunc" id="6615099">len</span><span class="op" id="6615102">(</span><span class="ident" id="6615103">rc</span><span class="op" id="6615105">.</span><span class="ident" id="6615106">rows</span><span class="op" id="6615110">)</span>&nbsp;<span class="op" id="6615112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6615116">return</span>&nbsp;<span class="ident" id="6615123">io</span><span class="op" id="6615125">.</span><span class="ident" id="6615126">EOF</span>&nbsp;<span class="comment" id="6615130">//&nbsp;per&nbsp;interface&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6615153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6615156">for</span>&nbsp;<span class="ident" id="6615160">i</span><span class="op" id="6615161">,</span>&nbsp;<span class="ident" id="6615163">v</span>&nbsp;<span class="op" id="6615165">:=</span>&nbsp;<span class="keyword" id="6615168">range</span>&nbsp;<span class="ident" id="6615174">rc</span><span class="op" id="6615176">.</span><span class="ident" id="6615177">rows</span><span class="op" id="6615181">[</span><span class="ident" id="6615182">rc</span><span class="op" id="6615184">.</span><span class="ident" id="6615185">pos</span><span class="op" id="6615188">]</span><span class="op" id="6615189">.</span><span class="ident" id="6615190">cols</span>&nbsp;<span class="op" id="6615195">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6615199">//&nbsp;TODO(bradfitz):&nbsp;convert&nbsp;to&nbsp;subset&nbsp;types?&nbsp;naah,&nbsp;I</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6615253">//&nbsp;think&nbsp;the&nbsp;subset&nbsp;types&nbsp;should&nbsp;only&nbsp;be&nbsp;input&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6615305">//&nbsp;driver,&nbsp;but&nbsp;the&nbsp;sql&nbsp;package&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6615363">//&nbsp;a&nbsp;wider&nbsp;range&nbsp;of&nbsp;types&nbsp;coming&nbsp;out&nbsp;of&nbsp;drivers.&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6615418">//&nbsp;for&nbsp;ease&nbsp;of&nbsp;drivers,&nbsp;and&nbsp;to&nbsp;prevent&nbsp;drivers&nbsp;from</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6615472">//&nbsp;messing&nbsp;up&nbsp;conversions&nbsp;or&nbsp;doing&nbsp;them&nbsp;differently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6615527">dest</span><span class="op" id="6615531">[</span><span class="ident" id="6615532">i</span><span class="op" id="6615533">]</span>&nbsp;<span class="op" id="6615535">=</span>&nbsp;<span class="ident" id="6615537">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6615542">if</span>&nbsp;<span class="ident" id="6615545">bs</span><span class="op" id="6615547">,</span>&nbsp;<span class="ident" id="6615549">ok</span>&nbsp;<span class="op" id="6615552">:=</span>&nbsp;<span class="ident" id="6615555">v</span><span class="op" id="6615556">.</span><span class="op" id="6615557">(</span><span class="op" id="6615558">[</span><span class="op" id="6615559">]</span><span class="builtintype" id="6615560">byte</span><span class="op" id="6615564">)</span><span class="op" id="6615565">;</span>&nbsp;<span class="ident" id="6615567">ok</span>&nbsp;<span class="op" id="6615570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6615575">if</span>&nbsp;<span class="ident" id="6615578">rc</span><span class="op" id="6615580">.</span><span class="ident" id="6615581">bytesClone</span>&nbsp;<span class="op" id="6615592">==</span>&nbsp;<span class="ident" id="6615595">nil</span>&nbsp;<span class="op" id="6615599">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6615605">rc</span><span class="op" id="6615607">.</span><span class="ident" id="6615608">bytesClone</span>&nbsp;<span class="op" id="6615619">=</span>&nbsp;<span class="builtinfunc" id="6615621">make</span><span class="op" id="6615625">(</span><span class="keyword" id="6615626">map</span><span class="op" id="6615629">[</span><span class="op" id="6615630">*</span><span class="builtintype" id="6615631">byte</span><span class="op" id="6615635">]</span><span class="op" id="6615636">[</span><span class="op" id="6615637">]</span><span class="builtintype" id="6615638">byte</span><span class="op" id="6615642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6615647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6615652">clone</span><span class="op" id="6615657">,</span>&nbsp;<span class="ident" id="6615659">ok</span>&nbsp;<span class="op" id="6615662">:=</span>&nbsp;<span class="ident" id="6615665">rc</span><span class="op" id="6615667">.</span><span class="ident" id="6615668">bytesClone</span><span class="op" id="6615678">[</span><span class="op" id="6615679">&amp;</span><span class="ident" id="6615680">bs</span><span class="op" id="6615682">[</span><span class="num" id="6615683">0</span><span class="op" id="6615684">]</span><span class="op" id="6615685">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6615690">if</span>&nbsp;<span class="op" id="6615693">!</span><span class="ident" id="6615694">ok</span>&nbsp;<span class="op" id="6615697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6615703">clone</span>&nbsp;<span class="op" id="6615709">=</span>&nbsp;<span class="builtinfunc" id="6615711">make</span><span class="op" id="6615715">(</span><span class="op" id="6615716">[</span><span class="op" id="6615717">]</span><span class="builtintype" id="6615718">byte</span><span class="op" id="6615722">,</span>&nbsp;<span class="builtinfunc" id="6615724">len</span><span class="op" id="6615727">(</span><span class="ident" id="6615728">bs</span><span class="op" id="6615730">)</span><span class="op" id="6615731">)</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6615737">copy</span><span class="op" id="6615741">(</span><span class="ident" id="6615742">clone</span><span class="op" id="6615747">,</span>&nbsp;<span class="ident" id="6615749">bs</span><span class="op" id="6615751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6615757">rc</span><span class="op" id="6615759">.</span><span class="ident" id="6615760">bytesClone</span><span class="op" id="6615770">[</span><span class="op" id="6615771">&amp;</span><span class="ident" id="6615772">bs</span><span class="op" id="6615774">[</span><span class="num" id="6615775">0</span><span class="op" id="6615776">]</span><span class="op" id="6615777">]</span>&nbsp;<span class="op" id="6615779">=</span>&nbsp;<span class="ident" id="6615781">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6615790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6615795">dest</span><span class="op" id="6615799">[</span><span class="ident" id="6615800">i</span><span class="op" id="6615801">]</span>&nbsp;<span class="op" id="6615803">=</span>&nbsp;<span class="ident" id="6615805">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6615813">}</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6615816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6615819">return</span>&nbsp;<span class="ident" id="6615826">nil</span><br>
<span class="lineno"></span><span class="op" id="6615830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6615833">//&nbsp;fakeDriverString&nbsp;is&nbsp;like&nbsp;driver.String,&nbsp;but&nbsp;indirects&nbsp;pointers&nbsp;like</span><br>
<span class="lineno">780</span><span class="comment" id="6615904">//&nbsp;DefaultValueConverter.</span><br>
<span class="lineno"></span><span class="comment" id="6615930">//</span><br>
<span class="lineno"></span><span class="comment" id="6615933">//&nbsp;This&nbsp;could&nbsp;be&nbsp;surprising&nbsp;behavior&nbsp;to&nbsp;retroactively&nbsp;apply&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6615996">//&nbsp;driver.String&nbsp;now&nbsp;that&nbsp;Go1&nbsp;is&nbsp;out,&nbsp;but&nbsp;this&nbsp;is&nbsp;convenient&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6616061">//&nbsp;our&nbsp;TestPointerParamsAndScans.</span><br>
<span class="lineno">785</span><span class="comment" id="6616095">//</span><br>
<span class="lineno"></span><span class="keyword" id="6616098">type</span>&nbsp;<span class="ident" id="6616103">fakeDriverString</span>&nbsp;<span class="keyword" id="6616120">struct</span><span class="op" id="6616126">{</span><span class="op" id="6616127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6616130">func</span>&nbsp;<span class="op" id="6616135">(</span><span class="ident" id="6616136">fakeDriverString</span><span class="op" id="6616152">)</span>&nbsp;<span class="ident" id="6616154">ConvertValue</span><span class="op" id="6616166">(</span><span class="ident" id="6616167">v</span>&nbsp;<span class="keyword" id="6616169">interface</span><span class="op" id="6616178">{</span><span class="op" id="6616179">}</span><span class="op" id="6616180">)</span>&nbsp;<span class="op" id="6616182">(</span><span class="ident" id="6616183">driver</span><span class="op" id="6616189">.</span><span class="ident" id="6616190">Value</span><span class="op" id="6616195">,</span>&nbsp;<span class="builtintype" id="6616197">error</span><span class="op" id="6616202">)</span>&nbsp;<span class="op" id="6616204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616207">switch</span>&nbsp;<span class="ident" id="6616214">c</span>&nbsp;<span class="op" id="6616216">:=</span>&nbsp;<span class="ident" id="6616219">v</span><span class="op" id="6616220">.</span><span class="op" id="6616221">(</span><span class="keyword" id="6616222">type</span><span class="op" id="6616226">)</span>&nbsp;<span class="op" id="6616228">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616231">case</span>&nbsp;<span class="builtintype" id="6616236">string</span><span class="op" id="6616242">,</span>&nbsp;<span class="op" id="6616244">[</span><span class="op" id="6616245">]</span><span class="builtintype" id="6616246">byte</span><span class="op" id="6616250">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616254">return</span>&nbsp;<span class="ident" id="6616261">v</span><span class="op" id="6616262">,</span>&nbsp;<span class="ident" id="6616264">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616269">case</span>&nbsp;<span class="op" id="6616274">*</span><span class="builtintype" id="6616275">string</span><span class="op" id="6616281">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616285">if</span>&nbsp;<span class="ident" id="6616288">c</span>&nbsp;<span class="op" id="6616290">==</span>&nbsp;<span class="ident" id="6616293">nil</span>&nbsp;<span class="op" id="6616297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616302">return</span>&nbsp;<span class="ident" id="6616309">nil</span><span class="op" id="6616312">,</span>&nbsp;<span class="ident" id="6616314">nil</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6616320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616324">return</span>&nbsp;<span class="op" id="6616331">*</span><span class="ident" id="6616332">c</span><span class="op" id="6616333">,</span>&nbsp;<span class="ident" id="6616335">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6616340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616343">return</span>&nbsp;<span class="ident" id="6616350">fmt</span><span class="op" id="6616353">.</span><span class="ident" id="6616354">Sprintf</span><span class="op" id="6616361">(</span><span class="string" id="6616362">&#34;%v&#34;</span><span class="op" id="6616366">,</span>&nbsp;<span class="ident" id="6616368">v</span><span class="op" id="6616369">)</span><span class="op" id="6616370">,</span>&nbsp;<span class="ident" id="6616372">nil</span><br>
<span class="lineno"></span><span class="op" id="6616376">}</span><br>
<span class="lineno">800</span><br>
<span class="lineno"></span><span class="keyword" id="6616379">func</span>&nbsp;<span class="ident" id="6616384">converterForType</span><span class="op" id="6616400">(</span><span class="ident" id="6616401">typ</span>&nbsp;<span class="builtintype" id="6616405">string</span><span class="op" id="6616411">)</span>&nbsp;<span class="ident" id="6616413">driver</span><span class="op" id="6616419">.</span><span class="ident" id="6616420">ValueConverter</span>&nbsp;<span class="op" id="6616435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616438">switch</span>&nbsp;<span class="ident" id="6616445">typ</span>&nbsp;<span class="op" id="6616449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616452">case</span>&nbsp;<span class="string" id="6616457">&#34;bool&#34;</span><span class="op" id="6616463">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616467">return</span>&nbsp;<span class="ident" id="6616474">driver</span><span class="op" id="6616480">.</span><span class="ident" id="6616481">Bool</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616487">case</span>&nbsp;<span class="string" id="6616492">&#34;nullbool&#34;</span><span class="op" id="6616502">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616506">return</span>&nbsp;<span class="ident" id="6616513">driver</span><span class="op" id="6616519">.</span><span class="ident" id="6616520">Null</span><span class="op" id="6616524">{</span><span class="ident" id="6616525">Converter</span><span class="op" id="6616534">:</span>&nbsp;<span class="ident" id="6616536">driver</span><span class="op" id="6616542">.</span><span class="ident" id="6616543">Bool</span><span class="op" id="6616547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616550">case</span>&nbsp;<span class="string" id="6616555">&#34;int32&#34;</span><span class="op" id="6616562">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616566">return</span>&nbsp;<span class="ident" id="6616573">driver</span><span class="op" id="6616579">.</span><span class="ident" id="6616580">Int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616587">case</span>&nbsp;<span class="string" id="6616592">&#34;string&#34;</span><span class="op" id="6616600">:</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616604">return</span>&nbsp;<span class="ident" id="6616611">driver</span><span class="op" id="6616617">.</span><span class="ident" id="6616618">NotNull</span><span class="op" id="6616625">{</span><span class="ident" id="6616626">Converter</span><span class="op" id="6616635">:</span>&nbsp;<span class="ident" id="6616637">fakeDriverString</span><span class="op" id="6616653">{</span><span class="op" id="6616654">}</span><span class="op" id="6616655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616658">case</span>&nbsp;<span class="string" id="6616663">&#34;nullstring&#34;</span><span class="op" id="6616675">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616679">return</span>&nbsp;<span class="ident" id="6616686">driver</span><span class="op" id="6616692">.</span><span class="ident" id="6616693">Null</span><span class="op" id="6616697">{</span><span class="ident" id="6616698">Converter</span><span class="op" id="6616707">:</span>&nbsp;<span class="ident" id="6616709">fakeDriverString</span><span class="op" id="6616725">{</span><span class="op" id="6616726">}</span><span class="op" id="6616727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616730">case</span>&nbsp;<span class="string" id="6616735">&#34;int64&#34;</span><span class="op" id="6616742">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6616746">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616798">return</span>&nbsp;<span class="ident" id="6616805">driver</span><span class="op" id="6616811">.</span><span class="ident" id="6616812">NotNull</span><span class="op" id="6616819">{</span><span class="ident" id="6616820">Converter</span><span class="op" id="6616829">:</span>&nbsp;<span class="ident" id="6616831">driver</span><span class="op" id="6616837">.</span><span class="ident" id="6616838">DefaultParameterConverter</span><span class="op" id="6616863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616866">case</span>&nbsp;<span class="string" id="6616871">&#34;nullint64&#34;</span><span class="op" id="6616882">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6616886">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6616938">return</span>&nbsp;<span class="ident" id="6616945">driver</span><span class="op" id="6616951">.</span><span class="ident" id="6616952">Null</span><span class="op" id="6616956">{</span><span class="ident" id="6616957">Converter</span><span class="op" id="6616966">:</span>&nbsp;<span class="ident" id="6616968">driver</span><span class="op" id="6616974">.</span><span class="ident" id="6616975">DefaultParameterConverter</span><span class="op" id="6617000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617003">case</span>&nbsp;<span class="string" id="6617008">&#34;float64&#34;</span><span class="op" id="6617017">:</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6617021">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617073">return</span>&nbsp;<span class="ident" id="6617080">driver</span><span class="op" id="6617086">.</span><span class="ident" id="6617087">NotNull</span><span class="op" id="6617094">{</span><span class="ident" id="6617095">Converter</span><span class="op" id="6617104">:</span>&nbsp;<span class="ident" id="6617106">driver</span><span class="op" id="6617112">.</span><span class="ident" id="6617113">DefaultParameterConverter</span><span class="op" id="6617138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617141">case</span>&nbsp;<span class="string" id="6617146">&#34;nullfloat64&#34;</span><span class="op" id="6617159">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6617163">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617215">return</span>&nbsp;<span class="ident" id="6617222">driver</span><span class="op" id="6617228">.</span><span class="ident" id="6617229">Null</span><span class="op" id="6617233">{</span><span class="ident" id="6617234">Converter</span><span class="op" id="6617243">:</span>&nbsp;<span class="ident" id="6617245">driver</span><span class="op" id="6617251">.</span><span class="ident" id="6617252">DefaultParameterConverter</span><span class="op" id="6617277">}</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617280">case</span>&nbsp;<span class="string" id="6617285">&#34;datetime&#34;</span><span class="op" id="6617295">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6617299">return</span>&nbsp;<span class="ident" id="6617306">driver</span><span class="op" id="6617312">.</span><span class="ident" id="6617313">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6617340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6617343">panic</span><span class="op" id="6617348">(</span><span class="string" id="6617349">&#34;invalid&nbsp;fakedb&nbsp;column&nbsp;type&nbsp;of&nbsp;&#34;</span>&nbsp;<span class="op" id="6617382">+</span>&nbsp;<span class="ident" id="6617384">typ</span><span class="op" id="6617387">)</span><br>
<span class="lineno"></span><span class="op" id="6617389">}</span>
</div>
</body>
</html>
