<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3810964">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3811019">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3811073">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3811124">package</span>&nbsp;<span class="ident" id="3811132">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3811137">import</span>&nbsp;<span class="op" id="3811144">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3811147">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3811156">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3811166">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3811182">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3811196">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3811213">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3811228">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3811238">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3811245">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3811251">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3811258">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="3811268">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3811271">type</span>&nbsp;<span class="ident" id="3811276">clientHandshakeState</span>&nbsp;<span class="keyword" id="3811297">struct</span>&nbsp;<span class="op" id="3811304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3811307">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3811320">*</span><span class="ident" id="3811321">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3811327">serverHello</span>&nbsp;&nbsp;<span class="op" id="3811340">*</span><span class="ident" id="3811341">serverHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3811357">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3811370">*</span><span class="ident" id="3811371">clientHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3811387">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3811400">*</span><span class="ident" id="3811401">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3811414">finishedHash</span>&nbsp;<span class="ident" id="3811427">finishedHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3811441">masterSecret</span>&nbsp;<span class="op" id="3811454">[</span><span class="op" id="3811455">]</span><span class="builtintype" id="3811456">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3811462">session</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3811475">*</span><span class="ident" id="3811476">ClientSessionState</span><br>
<span class="lineno"></span><span class="op" id="3811495">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="3811498">func</span>&nbsp;<span class="op" id="3811503">(</span><span class="ident" id="3811504">c</span>&nbsp;<span class="op" id="3811506">*</span><span class="ident" id="3811507">Conn</span><span class="op" id="3811511">)</span>&nbsp;<span class="ident" id="3811513">clientHandshake</span><span class="op" id="3811528">(</span><span class="op" id="3811529">)</span>&nbsp;<span class="builtintype" id="3811531">error</span>&nbsp;<span class="op" id="3811537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3811540">if</span>&nbsp;<span class="ident" id="3811543">c</span><span class="op" id="3811544">.</span><span class="ident" id="3811545">config</span>&nbsp;<span class="op" id="3811552">==</span>&nbsp;<span class="ident" id="3811555">nil</span>&nbsp;<span class="op" id="3811559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3811563">c</span><span class="op" id="3811564">.</span><span class="ident" id="3811565">config</span>&nbsp;<span class="op" id="3811572">=</span>&nbsp;<span class="ident" id="3811574">defaultConfig</span><span class="op" id="3811587">(</span><span class="op" id="3811588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3811591">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3811595">if</span>&nbsp;<span class="builtinfunc" id="3811598">len</span><span class="op" id="3811601">(</span><span class="ident" id="3811602">c</span><span class="op" id="3811603">.</span><span class="ident" id="3811604">config</span><span class="op" id="3811610">.</span><span class="ident" id="3811611">ServerName</span><span class="op" id="3811621">)</span>&nbsp;<span class="op" id="3811623">==</span>&nbsp;<span class="num" id="3811626">0</span>&nbsp;<span class="op" id="3811628">&amp;&amp;</span>&nbsp;<span class="op" id="3811631">!</span><span class="ident" id="3811632">c</span><span class="op" id="3811633">.</span><span class="ident" id="3811634">config</span><span class="op" id="3811640">.</span><span class="ident" id="3811641">InsecureSkipVerify</span>&nbsp;<span class="op" id="3811660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3811664">return</span>&nbsp;<span class="ident" id="3811671">errors</span><span class="op" id="3811677">.</span><span class="ident" id="3811678">New</span><span class="op" id="3811681">(</span><span class="string" id="3811682">&#34;tls:&nbsp;either&nbsp;ServerName&nbsp;or&nbsp;InsecureSkipVerify&nbsp;must&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;tls.Config&#34;</span><span class="op" id="3811764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3811767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3811771">nextProtosLength</span>&nbsp;<span class="op" id="3811788">:=</span>&nbsp;<span class="num" id="3811791">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3811794">for</span>&nbsp;<span class="ident" id="3811798">_</span><span class="op" id="3811799">,</span>&nbsp;<span class="ident" id="3811801">proto</span>&nbsp;<span class="op" id="3811807">:=</span>&nbsp;<span class="keyword" id="3811810">range</span>&nbsp;<span class="ident" id="3811816">c</span><span class="op" id="3811817">.</span><span class="ident" id="3811818">config</span><span class="op" id="3811824">.</span><span class="ident" id="3811825">NextProtos</span>&nbsp;<span class="op" id="3811836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3811840">if</span>&nbsp;<span class="ident" id="3811843">l</span>&nbsp;<span class="op" id="3811845">:=</span>&nbsp;<span class="builtinfunc" id="3811848">len</span><span class="op" id="3811851">(</span><span class="ident" id="3811852">proto</span><span class="op" id="3811857">)</span><span class="op" id="3811858">;</span>&nbsp;<span class="ident" id="3811860">l</span>&nbsp;<span class="op" id="3811862">==</span>&nbsp;<span class="num" id="3811865">0</span>&nbsp;<span class="op" id="3811867">||</span>&nbsp;<span class="ident" id="3811870">l</span>&nbsp;<span class="op" id="3811872">&gt;</span>&nbsp;<span class="num" id="3811874">255</span>&nbsp;<span class="op" id="3811878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3811883">return</span>&nbsp;<span class="ident" id="3811890">errors</span><span class="op" id="3811896">.</span><span class="ident" id="3811897">New</span><span class="op" id="3811900">(</span><span class="string" id="3811901">&#34;tls:&nbsp;invalid&nbsp;NextProtos&nbsp;value&#34;</span><span class="op" id="3811932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3811936">}</span>&nbsp;<span class="keyword" id="3811938">else</span>&nbsp;<span class="op" id="3811943">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3811948">nextProtosLength</span>&nbsp;<span class="op" id="3811965">+=</span>&nbsp;<span class="num" id="3811968">1</span>&nbsp;<span class="op" id="3811970">+</span>&nbsp;<span class="ident" id="3811972">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3811976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3811979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3811982">if</span>&nbsp;<span class="ident" id="3811985">nextProtosLength</span>&nbsp;<span class="op" id="3812002">&gt;</span>&nbsp;<span class="num" id="3812004">0xffff</span>&nbsp;<span class="op" id="3812011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3812015">return</span>&nbsp;<span class="ident" id="3812022">errors</span><span class="op" id="3812028">.</span><span class="ident" id="3812029">New</span><span class="op" id="3812032">(</span><span class="string" id="3812033">&#34;tls:&nbsp;NextProtos&nbsp;values&nbsp;too&nbsp;large&#34;</span><span class="op" id="3812067">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3812070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812074">hello</span>&nbsp;<span class="op" id="3812080">:=</span>&nbsp;<span class="op" id="3812083">&amp;</span><span class="ident" id="3812084">clientHelloMsg</span><span class="op" id="3812098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812102">vers</span><span class="op" id="3812106">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3812123">c</span><span class="op" id="3812124">.</span><span class="ident" id="3812125">config</span><span class="op" id="3812131">.</span><span class="ident" id="3812132">maxVersion</span><span class="op" id="3812142">(</span><span class="op" id="3812143">)</span><span class="op" id="3812144">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812148">compressionMethods</span><span class="op" id="3812166">:</span>&nbsp;&nbsp;<span class="op" id="3812169">[</span><span class="op" id="3812170">]</span><span class="builtintype" id="3812171">uint8</span><span class="op" id="3812176">{</span><span class="ident" id="3812177">compressionNone</span><span class="op" id="3812192">}</span><span class="op" id="3812193">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812197">random</span><span class="op" id="3812203">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3812218">make</span><span class="op" id="3812222">(</span><span class="op" id="3812223">[</span><span class="op" id="3812224">]</span><span class="builtintype" id="3812225">byte</span><span class="op" id="3812229">,</span>&nbsp;<span class="num" id="3812231">32</span><span class="op" id="3812233">)</span><span class="op" id="3812234">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812238">ocspStapling</span><span class="op" id="3812250">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3812259">true</span><span class="op" id="3812263">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812267">serverName</span><span class="op" id="3812277">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3812288">c</span><span class="op" id="3812289">.</span><span class="ident" id="3812290">config</span><span class="op" id="3812296">.</span><span class="ident" id="3812297">ServerName</span><span class="op" id="3812307">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812311">supportedCurves</span><span class="op" id="3812326">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3812332">c</span><span class="op" id="3812333">.</span><span class="ident" id="3812334">config</span><span class="op" id="3812340">.</span><span class="ident" id="3812341">curvePreferences</span><span class="op" id="3812357">(</span><span class="op" id="3812358">)</span><span class="op" id="3812359">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812363">supportedPoints</span><span class="op" id="3812378">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3812384">[</span><span class="op" id="3812385">]</span><span class="builtintype" id="3812386">uint8</span><span class="op" id="3812391">{</span><span class="ident" id="3812392">pointFormatUncompressed</span><span class="op" id="3812415">}</span><span class="op" id="3812416">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812420">nextProtoNeg</span><span class="op" id="3812432">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3812441">len</span><span class="op" id="3812444">(</span><span class="ident" id="3812445">c</span><span class="op" id="3812446">.</span><span class="ident" id="3812447">config</span><span class="op" id="3812453">.</span><span class="ident" id="3812454">NextProtos</span><span class="op" id="3812464">)</span>&nbsp;<span class="op" id="3812466">&gt;</span>&nbsp;<span class="num" id="3812468">0</span><span class="op" id="3812469">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812473">secureRenegotiation</span><span class="op" id="3812492">:</span>&nbsp;<span class="builtintype" id="3812494">true</span><span class="op" id="3812498">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812502">alpnProtocols</span><span class="op" id="3812515">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3812523">c</span><span class="op" id="3812524">.</span><span class="ident" id="3812525">config</span><span class="op" id="3812531">.</span><span class="ident" id="3812532">NextProtos</span><span class="op" id="3812542">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3812545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812549">possibleCipherSuites</span>&nbsp;<span class="op" id="3812570">:=</span>&nbsp;<span class="ident" id="3812573">c</span><span class="op" id="3812574">.</span><span class="ident" id="3812575">config</span><span class="op" id="3812581">.</span><span class="ident" id="3812582">cipherSuites</span><span class="op" id="3812594">(</span><span class="op" id="3812595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812598">hello</span><span class="op" id="3812603">.</span><span class="ident" id="3812604">cipherSuites</span>&nbsp;<span class="op" id="3812617">=</span>&nbsp;<span class="builtinfunc" id="3812619">make</span><span class="op" id="3812623">(</span><span class="op" id="3812624">[</span><span class="op" id="3812625">]</span><span class="builtintype" id="3812626">uint16</span><span class="op" id="3812632">,</span>&nbsp;<span class="num" id="3812634">0</span><span class="op" id="3812635">,</span>&nbsp;<span class="builtinfunc" id="3812637">len</span><span class="op" id="3812640">(</span><span class="ident" id="3812641">possibleCipherSuites</span><span class="op" id="3812661">)</span><span class="op" id="3812662">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="3812665">NextCipherSuite</span><span class="op" id="3812680">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3812683">for</span>&nbsp;<span class="ident" id="3812687">_</span><span class="op" id="3812688">,</span>&nbsp;<span class="ident" id="3812690">suiteId</span>&nbsp;<span class="op" id="3812698">:=</span>&nbsp;<span class="keyword" id="3812701">range</span>&nbsp;<span class="ident" id="3812707">possibleCipherSuites</span>&nbsp;<span class="op" id="3812728">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3812732">for</span>&nbsp;<span class="ident" id="3812736">_</span><span class="op" id="3812737">,</span>&nbsp;<span class="ident" id="3812739">suite</span>&nbsp;<span class="op" id="3812745">:=</span>&nbsp;<span class="keyword" id="3812748">range</span>&nbsp;<span class="ident" id="3812754">cipherSuites</span>&nbsp;<span class="op" id="3812767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3812772">if</span>&nbsp;<span class="ident" id="3812775">suite</span><span class="op" id="3812780">.</span><span class="ident" id="3812781">id</span>&nbsp;<span class="op" id="3812784">!=</span>&nbsp;<span class="ident" id="3812787">suiteId</span>&nbsp;<span class="op" id="3812795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3812801">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3812813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3812818">//&nbsp;Don&#39;t&nbsp;advertise&nbsp;TLS&nbsp;1.2-only&nbsp;cipher&nbsp;suites&nbsp;unless</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3812874">//&nbsp;we&#39;re&nbsp;attempting&nbsp;TLS&nbsp;1.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3812906">if</span>&nbsp;<span class="ident" id="3812909">hello</span><span class="op" id="3812914">.</span><span class="ident" id="3812915">vers</span>&nbsp;<span class="op" id="3812920">&lt;</span>&nbsp;<span class="ident" id="3812922">VersionTLS12</span>&nbsp;<span class="op" id="3812935">&amp;&amp;</span>&nbsp;<span class="ident" id="3812938">suite</span><span class="op" id="3812943">.</span><span class="ident" id="3812944">flags</span><span class="op" id="3812949">&amp;</span><span class="ident" id="3812950">suiteTLS12</span>&nbsp;<span class="op" id="3812961">!=</span>&nbsp;<span class="num" id="3812964">0</span>&nbsp;<span class="op" id="3812966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3812972">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3812984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812989">hello</span><span class="op" id="3812994">.</span><span class="ident" id="3812995">cipherSuites</span>&nbsp;<span class="op" id="3813008">=</span>&nbsp;<span class="builtinfunc" id="3813010">append</span><span class="op" id="3813016">(</span><span class="ident" id="3813017">hello</span><span class="op" id="3813022">.</span><span class="ident" id="3813023">cipherSuites</span><span class="op" id="3813035">,</span>&nbsp;<span class="ident" id="3813037">suiteId</span><span class="op" id="3813044">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3813049">continue</span>&nbsp;<span class="ident" id="3813058">NextCipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3813076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3813079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3813083">_</span><span class="op" id="3813084">,</span>&nbsp;<span class="ident" id="3813086">err</span>&nbsp;<span class="op" id="3813090">:=</span>&nbsp;<span class="ident" id="3813093">io</span><span class="op" id="3813095">.</span><span class="ident" id="3813096">ReadFull</span><span class="op" id="3813104">(</span><span class="ident" id="3813105">c</span><span class="op" id="3813106">.</span><span class="ident" id="3813107">config</span><span class="op" id="3813113">.</span><span class="ident" id="3813114">rand</span><span class="op" id="3813118">(</span><span class="op" id="3813119">)</span><span class="op" id="3813120">,</span>&nbsp;<span class="ident" id="3813122">hello</span><span class="op" id="3813127">.</span><span class="ident" id="3813128">random</span><span class="op" id="3813134">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3813137">if</span>&nbsp;<span class="ident" id="3813140">err</span>&nbsp;<span class="op" id="3813144">!=</span>&nbsp;<span class="ident" id="3813147">nil</span>&nbsp;<span class="op" id="3813151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3813155">c</span><span class="op" id="3813156">.</span><span class="ident" id="3813157">sendAlert</span><span class="op" id="3813166">(</span><span class="ident" id="3813167">alertInternalError</span><span class="op" id="3813185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3813189">return</span>&nbsp;<span class="ident" id="3813196">errors</span><span class="op" id="3813202">.</span><span class="ident" id="3813203">New</span><span class="op" id="3813206">(</span><span class="string" id="3813207">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="3813237">+</span>&nbsp;<span class="ident" id="3813239">err</span><span class="op" id="3813242">.</span><span class="ident" id="3813243">Error</span><span class="op" id="3813248">(</span><span class="op" id="3813249">)</span><span class="op" id="3813250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3813253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3813257">if</span>&nbsp;<span class="ident" id="3813260">hello</span><span class="op" id="3813265">.</span><span class="ident" id="3813266">vers</span>&nbsp;<span class="op" id="3813271">&gt;=</span>&nbsp;<span class="ident" id="3813274">VersionTLS12</span>&nbsp;<span class="op" id="3813287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3813291">hello</span><span class="op" id="3813296">.</span><span class="ident" id="3813297">signatureAndHashes</span>&nbsp;<span class="op" id="3813316">=</span>&nbsp;<span class="ident" id="3813318">supportedSKXSignatureAlgorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3813351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3813355">var</span>&nbsp;<span class="ident" id="3813359">session</span>&nbsp;<span class="op" id="3813367">*</span><span class="ident" id="3813368">ClientSessionState</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3813388">var</span>&nbsp;<span class="ident" id="3813392">cacheKey</span>&nbsp;<span class="builtintype" id="3813401">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3813409">sessionCache</span>&nbsp;<span class="op" id="3813422">:=</span>&nbsp;<span class="ident" id="3813425">c</span><span class="op" id="3813426">.</span><span class="ident" id="3813427">config</span><span class="op" id="3813433">.</span><span class="ident" id="3813434">ClientSessionCache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3813454">if</span>&nbsp;<span class="ident" id="3813457">c</span><span class="op" id="3813458">.</span><span class="ident" id="3813459">config</span><span class="op" id="3813465">.</span><span class="ident" id="3813466">SessionTicketsDisabled</span>&nbsp;<span class="op" id="3813489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3813493">sessionCache</span>&nbsp;<span class="op" id="3813506">=</span>&nbsp;<span class="ident" id="3813508">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3813513">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3813517">if</span>&nbsp;<span class="ident" id="3813520">sessionCache</span>&nbsp;<span class="op" id="3813533">!=</span>&nbsp;<span class="ident" id="3813536">nil</span>&nbsp;<span class="op" id="3813540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3813544">hello</span><span class="op" id="3813549">.</span><span class="ident" id="3813550">ticketSupported</span>&nbsp;<span class="op" id="3813566">=</span>&nbsp;<span class="builtintype" id="3813568">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3813576">//&nbsp;Try&nbsp;to&nbsp;resume&nbsp;a&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;session,&nbsp;if</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3813635">//&nbsp;available.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3813651">cacheKey</span>&nbsp;<span class="op" id="3813660">=</span>&nbsp;<span class="ident" id="3813662">clientSessionCacheKey</span><span class="op" id="3813683">(</span><span class="ident" id="3813684">c</span><span class="op" id="3813685">.</span><span class="ident" id="3813686">conn</span><span class="op" id="3813690">.</span><span class="ident" id="3813691">RemoteAddr</span><span class="op" id="3813701">(</span><span class="op" id="3813702">)</span><span class="op" id="3813703">,</span>&nbsp;<span class="ident" id="3813705">c</span><span class="op" id="3813706">.</span><span class="ident" id="3813707">config</span><span class="op" id="3813713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3813717">candidateSession</span><span class="op" id="3813733">,</span>&nbsp;<span class="ident" id="3813735">ok</span>&nbsp;<span class="op" id="3813738">:=</span>&nbsp;<span class="ident" id="3813741">sessionCache</span><span class="op" id="3813753">.</span><span class="ident" id="3813754">Get</span><span class="op" id="3813757">(</span><span class="ident" id="3813758">cacheKey</span><span class="op" id="3813766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3813770">if</span>&nbsp;<span class="ident" id="3813773">ok</span>&nbsp;<span class="op" id="3813776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3813781">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;ciphersuite/version&nbsp;used&nbsp;for&nbsp;the</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3813835">//&nbsp;previous&nbsp;session&nbsp;are&nbsp;still&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3813875">cipherSuiteOk</span>&nbsp;<span class="op" id="3813889">:=</span>&nbsp;<span class="builtintype" id="3813892">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3813901">for</span>&nbsp;<span class="ident" id="3813905">_</span><span class="op" id="3813906">,</span>&nbsp;<span class="ident" id="3813908">id</span>&nbsp;<span class="op" id="3813911">:=</span>&nbsp;<span class="keyword" id="3813914">range</span>&nbsp;<span class="ident" id="3813920">hello</span><span class="op" id="3813925">.</span><span class="ident" id="3813926">cipherSuites</span>&nbsp;<span class="op" id="3813939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3813945">if</span>&nbsp;<span class="ident" id="3813948">id</span>&nbsp;<span class="op" id="3813951">==</span>&nbsp;<span class="ident" id="3813954">candidateSession</span><span class="op" id="3813970">.</span><span class="ident" id="3813971">cipherSuite</span>&nbsp;<span class="op" id="3813983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3813990">cipherSuiteOk</span>&nbsp;<span class="op" id="3814004">=</span>&nbsp;<span class="builtintype" id="3814006">true</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3814016">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3814026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3814031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3814037">versOk</span>&nbsp;<span class="op" id="3814044">:=</span>&nbsp;<span class="ident" id="3814047">candidateSession</span><span class="op" id="3814063">.</span><span class="ident" id="3814064">vers</span>&nbsp;<span class="op" id="3814069">&gt;=</span>&nbsp;<span class="ident" id="3814072">c</span><span class="op" id="3814073">.</span><span class="ident" id="3814074">config</span><span class="op" id="3814080">.</span><span class="ident" id="3814081">minVersion</span><span class="op" id="3814091">(</span><span class="op" id="3814092">)</span>&nbsp;<span class="op" id="3814094">&amp;&amp;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3814101">candidateSession</span><span class="op" id="3814117">.</span><span class="ident" id="3814118">vers</span>&nbsp;<span class="op" id="3814123">&lt;=</span>&nbsp;<span class="ident" id="3814126">c</span><span class="op" id="3814127">.</span><span class="ident" id="3814128">config</span><span class="op" id="3814134">.</span><span class="ident" id="3814135">maxVersion</span><span class="op" id="3814145">(</span><span class="op" id="3814146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3814151">if</span>&nbsp;<span class="ident" id="3814154">versOk</span>&nbsp;<span class="op" id="3814161">&amp;&amp;</span>&nbsp;<span class="ident" id="3814164">cipherSuiteOk</span>&nbsp;<span class="op" id="3814178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3814184">session</span>&nbsp;<span class="op" id="3814192">=</span>&nbsp;<span class="ident" id="3814194">candidateSession</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3814214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3814218">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3814221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3814225">if</span>&nbsp;<span class="ident" id="3814228">session</span>&nbsp;<span class="op" id="3814236">!=</span>&nbsp;<span class="ident" id="3814239">nil</span>&nbsp;<span class="op" id="3814243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3814247">hello</span><span class="op" id="3814252">.</span><span class="ident" id="3814253">sessionTicket</span>&nbsp;<span class="op" id="3814267">=</span>&nbsp;<span class="ident" id="3814269">session</span><span class="op" id="3814276">.</span><span class="ident" id="3814277">sessionTicket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3814293">//&nbsp;A&nbsp;random&nbsp;session&nbsp;ID&nbsp;is&nbsp;used&nbsp;to&nbsp;detect&nbsp;when&nbsp;the</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3814345">//&nbsp;server&nbsp;accepted&nbsp;the&nbsp;ticket&nbsp;and&nbsp;is&nbsp;resuming&nbsp;a&nbsp;session</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3814403">//&nbsp;(see&nbsp;RFC&nbsp;5077).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3814424">hello</span><span class="op" id="3814429">.</span><span class="ident" id="3814430">sessionId</span>&nbsp;<span class="op" id="3814440">=</span>&nbsp;<span class="builtinfunc" id="3814442">make</span><span class="op" id="3814446">(</span><span class="op" id="3814447">[</span><span class="op" id="3814448">]</span><span class="builtintype" id="3814449">byte</span><span class="op" id="3814453">,</span>&nbsp;<span class="num" id="3814455">16</span><span class="op" id="3814457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3814461">if</span>&nbsp;<span class="ident" id="3814464">_</span><span class="op" id="3814465">,</span>&nbsp;<span class="ident" id="3814467">err</span>&nbsp;<span class="op" id="3814471">:=</span>&nbsp;<span class="ident" id="3814474">io</span><span class="op" id="3814476">.</span><span class="ident" id="3814477">ReadFull</span><span class="op" id="3814485">(</span><span class="ident" id="3814486">c</span><span class="op" id="3814487">.</span><span class="ident" id="3814488">config</span><span class="op" id="3814494">.</span><span class="ident" id="3814495">rand</span><span class="op" id="3814499">(</span><span class="op" id="3814500">)</span><span class="op" id="3814501">,</span>&nbsp;<span class="ident" id="3814503">hello</span><span class="op" id="3814508">.</span><span class="ident" id="3814509">sessionId</span><span class="op" id="3814518">)</span><span class="op" id="3814519">;</span>&nbsp;<span class="ident" id="3814521">err</span>&nbsp;<span class="op" id="3814525">!=</span>&nbsp;<span class="ident" id="3814528">nil</span>&nbsp;<span class="op" id="3814532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3814537">c</span><span class="op" id="3814538">.</span><span class="ident" id="3814539">sendAlert</span><span class="op" id="3814548">(</span><span class="ident" id="3814549">alertInternalError</span><span class="op" id="3814567">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3814572">return</span>&nbsp;<span class="ident" id="3814579">errors</span><span class="op" id="3814585">.</span><span class="ident" id="3814586">New</span><span class="op" id="3814589">(</span><span class="string" id="3814590">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="3814620">+</span>&nbsp;<span class="ident" id="3814622">err</span><span class="op" id="3814625">.</span><span class="ident" id="3814626">Error</span><span class="op" id="3814631">(</span><span class="op" id="3814632">)</span><span class="op" id="3814633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3814637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3814640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3814644">c</span><span class="op" id="3814645">.</span><span class="ident" id="3814646">writeRecord</span><span class="op" id="3814657">(</span><span class="ident" id="3814658">recordTypeHandshake</span><span class="op" id="3814677">,</span>&nbsp;<span class="ident" id="3814679">hello</span><span class="op" id="3814684">.</span><span class="ident" id="3814685">marshal</span><span class="op" id="3814692">(</span><span class="op" id="3814693">)</span><span class="op" id="3814694">)</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3814698">msg</span><span class="op" id="3814701">,</span>&nbsp;<span class="ident" id="3814703">err</span>&nbsp;<span class="op" id="3814707">:=</span>&nbsp;<span class="ident" id="3814710">c</span><span class="op" id="3814711">.</span><span class="ident" id="3814712">readHandshake</span><span class="op" id="3814725">(</span><span class="op" id="3814726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3814729">if</span>&nbsp;<span class="ident" id="3814732">err</span>&nbsp;<span class="op" id="3814736">!=</span>&nbsp;<span class="ident" id="3814739">nil</span>&nbsp;<span class="op" id="3814743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3814747">return</span>&nbsp;<span class="ident" id="3814754">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3814759">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3814762">serverHello</span><span class="op" id="3814773">,</span>&nbsp;<span class="ident" id="3814775">ok</span>&nbsp;<span class="op" id="3814778">:=</span>&nbsp;<span class="ident" id="3814781">msg</span><span class="op" id="3814784">.</span><span class="op" id="3814785">(</span><span class="op" id="3814786">*</span><span class="ident" id="3814787">serverHelloMsg</span><span class="op" id="3814801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3814804">if</span>&nbsp;<span class="op" id="3814807">!</span><span class="ident" id="3814808">ok</span>&nbsp;<span class="op" id="3814811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3814815">c</span><span class="op" id="3814816">.</span><span class="ident" id="3814817">sendAlert</span><span class="op" id="3814826">(</span><span class="ident" id="3814827">alertUnexpectedMessage</span><span class="op" id="3814849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3814853">return</span>&nbsp;<span class="ident" id="3814860">unexpectedMessageError</span><span class="op" id="3814882">(</span><span class="ident" id="3814883">serverHello</span><span class="op" id="3814894">,</span>&nbsp;<span class="ident" id="3814896">msg</span><span class="op" id="3814899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3814902">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3814906">vers</span><span class="op" id="3814910">,</span>&nbsp;<span class="ident" id="3814912">ok</span>&nbsp;<span class="op" id="3814915">:=</span>&nbsp;<span class="ident" id="3814918">c</span><span class="op" id="3814919">.</span><span class="ident" id="3814920">config</span><span class="op" id="3814926">.</span><span class="ident" id="3814927">mutualVersion</span><span class="op" id="3814940">(</span><span class="ident" id="3814941">serverHello</span><span class="op" id="3814952">.</span><span class="ident" id="3814953">vers</span><span class="op" id="3814957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3814960">if</span>&nbsp;<span class="op" id="3814963">!</span><span class="ident" id="3814964">ok</span>&nbsp;<span class="op" id="3814967">||</span>&nbsp;<span class="ident" id="3814970">vers</span>&nbsp;<span class="op" id="3814975">&lt;</span>&nbsp;<span class="ident" id="3814977">VersionTLS10</span>&nbsp;<span class="op" id="3814990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3814994">//&nbsp;TLS&nbsp;1.0&nbsp;is&nbsp;the&nbsp;minimum&nbsp;version&nbsp;supported&nbsp;as&nbsp;a&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3815053">c</span><span class="op" id="3815054">.</span><span class="ident" id="3815055">sendAlert</span><span class="op" id="3815064">(</span><span class="ident" id="3815065">alertProtocolVersion</span><span class="op" id="3815085">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3815089">return</span>&nbsp;<span class="ident" id="3815096">fmt</span><span class="op" id="3815099">.</span><span class="ident" id="3815100">Errorf</span><span class="op" id="3815106">(</span><span class="string" id="3815107">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;protocol&nbsp;version&nbsp;%x&#34;</span><span class="op" id="3815161">,</span>&nbsp;<span class="ident" id="3815163">serverHello</span><span class="op" id="3815174">.</span><span class="ident" id="3815175">vers</span><span class="op" id="3815179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3815182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3815185">c</span><span class="op" id="3815186">.</span><span class="ident" id="3815187">vers</span>&nbsp;<span class="op" id="3815192">=</span>&nbsp;<span class="ident" id="3815194">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3815200">c</span><span class="op" id="3815201">.</span><span class="ident" id="3815202">haveVers</span>&nbsp;<span class="op" id="3815211">=</span>&nbsp;<span class="builtintype" id="3815213">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3815220">suite</span>&nbsp;<span class="op" id="3815226">:=</span>&nbsp;<span class="ident" id="3815229">mutualCipherSuite</span><span class="op" id="3815246">(</span><span class="ident" id="3815247">c</span><span class="op" id="3815248">.</span><span class="ident" id="3815249">config</span><span class="op" id="3815255">.</span><span class="ident" id="3815256">cipherSuites</span><span class="op" id="3815268">(</span><span class="op" id="3815269">)</span><span class="op" id="3815270">,</span>&nbsp;<span class="ident" id="3815272">serverHello</span><span class="op" id="3815283">.</span><span class="ident" id="3815284">cipherSuite</span><span class="op" id="3815295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3815298">if</span>&nbsp;<span class="ident" id="3815301">suite</span>&nbsp;<span class="op" id="3815307">==</span>&nbsp;<span class="ident" id="3815310">nil</span>&nbsp;<span class="op" id="3815314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3815318">c</span><span class="op" id="3815319">.</span><span class="ident" id="3815320">sendAlert</span><span class="op" id="3815329">(</span><span class="ident" id="3815330">alertHandshakeFailure</span><span class="op" id="3815351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3815355">return</span>&nbsp;<span class="ident" id="3815362">fmt</span><span class="op" id="3815365">.</span><span class="ident" id="3815366">Errorf</span><span class="op" id="3815372">(</span><span class="string" id="3815373">&#34;tls:&nbsp;server&nbsp;selected&nbsp;an&nbsp;unsupported&nbsp;cipher&nbsp;suite&#34;</span><span class="op" id="3815423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3815426">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3815430">hs</span>&nbsp;<span class="op" id="3815433">:=</span>&nbsp;<span class="op" id="3815436">&amp;</span><span class="ident" id="3815437">clientHandshakeState</span><span class="op" id="3815457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3815461">c</span><span class="op" id="3815462">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3815475">c</span><span class="op" id="3815476">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3815480">serverHello</span><span class="op" id="3815491">:</span>&nbsp;&nbsp;<span class="ident" id="3815494">serverHello</span><span class="op" id="3815505">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3815509">hello</span><span class="op" id="3815514">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3815523">hello</span><span class="op" id="3815528">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3815532">suite</span><span class="op" id="3815537">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3815546">suite</span><span class="op" id="3815551">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3815555">finishedHash</span><span class="op" id="3815567">:</span>&nbsp;<span class="ident" id="3815569">newFinishedHash</span><span class="op" id="3815584">(</span><span class="ident" id="3815585">c</span><span class="op" id="3815586">.</span><span class="ident" id="3815587">vers</span><span class="op" id="3815591">)</span><span class="op" id="3815592">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3815596">session</span><span class="op" id="3815603">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3815610">session</span><span class="op" id="3815617">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3815620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3815624">hs</span><span class="op" id="3815626">.</span><span class="ident" id="3815627">finishedHash</span><span class="op" id="3815639">.</span><span class="ident" id="3815640">Write</span><span class="op" id="3815645">(</span><span class="ident" id="3815646">hs</span><span class="op" id="3815648">.</span><span class="ident" id="3815649">hello</span><span class="op" id="3815654">.</span><span class="ident" id="3815655">marshal</span><span class="op" id="3815662">(</span><span class="op" id="3815663">)</span><span class="op" id="3815664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3815667">hs</span><span class="op" id="3815669">.</span><span class="ident" id="3815670">finishedHash</span><span class="op" id="3815682">.</span><span class="ident" id="3815683">Write</span><span class="op" id="3815688">(</span><span class="ident" id="3815689">hs</span><span class="op" id="3815691">.</span><span class="ident" id="3815692">serverHello</span><span class="op" id="3815703">.</span><span class="ident" id="3815704">marshal</span><span class="op" id="3815711">(</span><span class="op" id="3815712">)</span><span class="op" id="3815713">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3815717">isResume</span><span class="op" id="3815725">,</span>&nbsp;<span class="ident" id="3815727">err</span>&nbsp;<span class="op" id="3815731">:=</span>&nbsp;<span class="ident" id="3815734">hs</span><span class="op" id="3815736">.</span><span class="ident" id="3815737">processServerHello</span><span class="op" id="3815755">(</span><span class="op" id="3815756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3815759">if</span>&nbsp;<span class="ident" id="3815762">err</span>&nbsp;<span class="op" id="3815766">!=</span>&nbsp;<span class="ident" id="3815769">nil</span>&nbsp;<span class="op" id="3815773">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3815777">return</span>&nbsp;<span class="ident" id="3815784">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3815789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3815793">if</span>&nbsp;<span class="ident" id="3815796">isResume</span>&nbsp;<span class="op" id="3815805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3815809">if</span>&nbsp;<span class="ident" id="3815812">err</span>&nbsp;<span class="op" id="3815816">:=</span>&nbsp;<span class="ident" id="3815819">hs</span><span class="op" id="3815821">.</span><span class="ident" id="3815822">establishKeys</span><span class="op" id="3815835">(</span><span class="op" id="3815836">)</span><span class="op" id="3815837">;</span>&nbsp;<span class="ident" id="3815839">err</span>&nbsp;<span class="op" id="3815843">!=</span>&nbsp;<span class="ident" id="3815846">nil</span>&nbsp;<span class="op" id="3815850">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3815855">return</span>&nbsp;<span class="ident" id="3815862">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3815868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3815872">if</span>&nbsp;<span class="ident" id="3815875">err</span>&nbsp;<span class="op" id="3815879">:=</span>&nbsp;<span class="ident" id="3815882">hs</span><span class="op" id="3815884">.</span><span class="ident" id="3815885">readSessionTicket</span><span class="op" id="3815902">(</span><span class="op" id="3815903">)</span><span class="op" id="3815904">;</span>&nbsp;<span class="ident" id="3815906">err</span>&nbsp;<span class="op" id="3815910">!=</span>&nbsp;<span class="ident" id="3815913">nil</span>&nbsp;<span class="op" id="3815917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3815922">return</span>&nbsp;<span class="ident" id="3815929">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3815935">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3815939">if</span>&nbsp;<span class="ident" id="3815942">err</span>&nbsp;<span class="op" id="3815946">:=</span>&nbsp;<span class="ident" id="3815949">hs</span><span class="op" id="3815951">.</span><span class="ident" id="3815952">readFinished</span><span class="op" id="3815964">(</span><span class="ident" id="3815965">c</span><span class="op" id="3815966">.</span><span class="ident" id="3815967">firstFinished</span><span class="op" id="3815980">[</span><span class="op" id="3815981">:</span><span class="op" id="3815982">]</span><span class="op" id="3815983">)</span><span class="op" id="3815984">;</span>&nbsp;<span class="ident" id="3815986">err</span>&nbsp;<span class="op" id="3815990">!=</span>&nbsp;<span class="ident" id="3815993">nil</span>&nbsp;<span class="op" id="3815997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816002">return</span>&nbsp;<span class="ident" id="3816009">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3816015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816019">if</span>&nbsp;<span class="ident" id="3816022">err</span>&nbsp;<span class="op" id="3816026">:=</span>&nbsp;<span class="ident" id="3816029">hs</span><span class="op" id="3816031">.</span><span class="ident" id="3816032">sendFinished</span><span class="op" id="3816044">(</span><span class="ident" id="3816045">nil</span><span class="op" id="3816048">)</span><span class="op" id="3816049">;</span>&nbsp;<span class="ident" id="3816051">err</span>&nbsp;<span class="op" id="3816055">!=</span>&nbsp;<span class="ident" id="3816058">nil</span>&nbsp;<span class="op" id="3816062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816067">return</span>&nbsp;<span class="ident" id="3816074">err</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3816080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3816083">}</span>&nbsp;<span class="keyword" id="3816085">else</span>&nbsp;<span class="op" id="3816090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816094">if</span>&nbsp;<span class="ident" id="3816097">err</span>&nbsp;<span class="op" id="3816101">:=</span>&nbsp;<span class="ident" id="3816104">hs</span><span class="op" id="3816106">.</span><span class="ident" id="3816107">doFullHandshake</span><span class="op" id="3816122">(</span><span class="op" id="3816123">)</span><span class="op" id="3816124">;</span>&nbsp;<span class="ident" id="3816126">err</span>&nbsp;<span class="op" id="3816130">!=</span>&nbsp;<span class="ident" id="3816133">nil</span>&nbsp;<span class="op" id="3816137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816142">return</span>&nbsp;<span class="ident" id="3816149">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3816155">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816159">if</span>&nbsp;<span class="ident" id="3816162">err</span>&nbsp;<span class="op" id="3816166">:=</span>&nbsp;<span class="ident" id="3816169">hs</span><span class="op" id="3816171">.</span><span class="ident" id="3816172">establishKeys</span><span class="op" id="3816185">(</span><span class="op" id="3816186">)</span><span class="op" id="3816187">;</span>&nbsp;<span class="ident" id="3816189">err</span>&nbsp;<span class="op" id="3816193">!=</span>&nbsp;<span class="ident" id="3816196">nil</span>&nbsp;<span class="op" id="3816200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816205">return</span>&nbsp;<span class="ident" id="3816212">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3816218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816222">if</span>&nbsp;<span class="ident" id="3816225">err</span>&nbsp;<span class="op" id="3816229">:=</span>&nbsp;<span class="ident" id="3816232">hs</span><span class="op" id="3816234">.</span><span class="ident" id="3816235">sendFinished</span><span class="op" id="3816247">(</span><span class="ident" id="3816248">c</span><span class="op" id="3816249">.</span><span class="ident" id="3816250">firstFinished</span><span class="op" id="3816263">[</span><span class="op" id="3816264">:</span><span class="op" id="3816265">]</span><span class="op" id="3816266">)</span><span class="op" id="3816267">;</span>&nbsp;<span class="ident" id="3816269">err</span>&nbsp;<span class="op" id="3816273">!=</span>&nbsp;<span class="ident" id="3816276">nil</span>&nbsp;<span class="op" id="3816280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816285">return</span>&nbsp;<span class="ident" id="3816292">err</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3816298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816302">if</span>&nbsp;<span class="ident" id="3816305">err</span>&nbsp;<span class="op" id="3816309">:=</span>&nbsp;<span class="ident" id="3816312">hs</span><span class="op" id="3816314">.</span><span class="ident" id="3816315">readSessionTicket</span><span class="op" id="3816332">(</span><span class="op" id="3816333">)</span><span class="op" id="3816334">;</span>&nbsp;<span class="ident" id="3816336">err</span>&nbsp;<span class="op" id="3816340">!=</span>&nbsp;<span class="ident" id="3816343">nil</span>&nbsp;<span class="op" id="3816347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816352">return</span>&nbsp;<span class="ident" id="3816359">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3816365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816369">if</span>&nbsp;<span class="ident" id="3816372">err</span>&nbsp;<span class="op" id="3816376">:=</span>&nbsp;<span class="ident" id="3816379">hs</span><span class="op" id="3816381">.</span><span class="ident" id="3816382">readFinished</span><span class="op" id="3816394">(</span><span class="ident" id="3816395">nil</span><span class="op" id="3816398">)</span><span class="op" id="3816399">;</span>&nbsp;<span class="ident" id="3816401">err</span>&nbsp;<span class="op" id="3816405">!=</span>&nbsp;<span class="ident" id="3816408">nil</span>&nbsp;<span class="op" id="3816412">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816417">return</span>&nbsp;<span class="ident" id="3816424">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3816430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3816433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816437">if</span>&nbsp;<span class="ident" id="3816440">sessionCache</span>&nbsp;<span class="op" id="3816453">!=</span>&nbsp;<span class="ident" id="3816456">nil</span>&nbsp;<span class="op" id="3816460">&amp;&amp;</span>&nbsp;<span class="ident" id="3816463">hs</span><span class="op" id="3816465">.</span><span class="ident" id="3816466">session</span>&nbsp;<span class="op" id="3816474">!=</span>&nbsp;<span class="ident" id="3816477">nil</span>&nbsp;<span class="op" id="3816481">&amp;&amp;</span>&nbsp;<span class="ident" id="3816484">session</span>&nbsp;<span class="op" id="3816492">!=</span>&nbsp;<span class="ident" id="3816495">hs</span><span class="op" id="3816497">.</span><span class="ident" id="3816498">session</span>&nbsp;<span class="op" id="3816506">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3816510">sessionCache</span><span class="op" id="3816522">.</span><span class="ident" id="3816523">Put</span><span class="op" id="3816526">(</span><span class="ident" id="3816527">cacheKey</span><span class="op" id="3816535">,</span>&nbsp;<span class="ident" id="3816537">hs</span><span class="op" id="3816539">.</span><span class="ident" id="3816540">session</span><span class="op" id="3816547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3816550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3816554">c</span><span class="op" id="3816555">.</span><span class="ident" id="3816556">didResume</span>&nbsp;<span class="op" id="3816566">=</span>&nbsp;<span class="ident" id="3816568">isResume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3816578">c</span><span class="op" id="3816579">.</span><span class="ident" id="3816580">handshakeComplete</span>&nbsp;<span class="op" id="3816598">=</span>&nbsp;<span class="builtintype" id="3816600">true</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3816606">c</span><span class="op" id="3816607">.</span><span class="ident" id="3816608">cipherSuite</span>&nbsp;<span class="op" id="3816620">=</span>&nbsp;<span class="ident" id="3816622">suite</span><span class="op" id="3816627">.</span><span class="ident" id="3816628">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816632">return</span>&nbsp;<span class="ident" id="3816639">nil</span><br>
<span class="lineno"></span><span class="op" id="3816643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3816646">func</span>&nbsp;<span class="op" id="3816651">(</span><span class="ident" id="3816652">hs</span>&nbsp;<span class="op" id="3816655">*</span><span class="ident" id="3816656">clientHandshakeState</span><span class="op" id="3816676">)</span>&nbsp;<span class="ident" id="3816678">doFullHandshake</span><span class="op" id="3816693">(</span><span class="op" id="3816694">)</span>&nbsp;<span class="builtintype" id="3816696">error</span>&nbsp;<span class="op" id="3816702">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3816705">c</span>&nbsp;<span class="op" id="3816707">:=</span>&nbsp;<span class="ident" id="3816710">hs</span><span class="op" id="3816712">.</span><span class="ident" id="3816713">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3816717">msg</span><span class="op" id="3816720">,</span>&nbsp;<span class="ident" id="3816722">err</span>&nbsp;<span class="op" id="3816726">:=</span>&nbsp;<span class="ident" id="3816729">c</span><span class="op" id="3816730">.</span><span class="ident" id="3816731">readHandshake</span><span class="op" id="3816744">(</span><span class="op" id="3816745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816748">if</span>&nbsp;<span class="ident" id="3816751">err</span>&nbsp;<span class="op" id="3816755">!=</span>&nbsp;<span class="ident" id="3816758">nil</span>&nbsp;<span class="op" id="3816762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816766">return</span>&nbsp;<span class="ident" id="3816773">err</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3816778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3816781">certMsg</span><span class="op" id="3816788">,</span>&nbsp;<span class="ident" id="3816790">ok</span>&nbsp;<span class="op" id="3816793">:=</span>&nbsp;<span class="ident" id="3816796">msg</span><span class="op" id="3816799">.</span><span class="op" id="3816800">(</span><span class="op" id="3816801">*</span><span class="ident" id="3816802">certificateMsg</span><span class="op" id="3816816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816819">if</span>&nbsp;<span class="op" id="3816822">!</span><span class="ident" id="3816823">ok</span>&nbsp;<span class="op" id="3816826">||</span>&nbsp;<span class="builtinfunc" id="3816829">len</span><span class="op" id="3816832">(</span><span class="ident" id="3816833">certMsg</span><span class="op" id="3816840">.</span><span class="ident" id="3816841">certificates</span><span class="op" id="3816853">)</span>&nbsp;<span class="op" id="3816855">==</span>&nbsp;<span class="num" id="3816858">0</span>&nbsp;<span class="op" id="3816860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3816864">c</span><span class="op" id="3816865">.</span><span class="ident" id="3816866">sendAlert</span><span class="op" id="3816875">(</span><span class="ident" id="3816876">alertUnexpectedMessage</span><span class="op" id="3816898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3816902">return</span>&nbsp;<span class="ident" id="3816909">unexpectedMessageError</span><span class="op" id="3816931">(</span><span class="ident" id="3816932">certMsg</span><span class="op" id="3816939">,</span>&nbsp;<span class="ident" id="3816941">msg</span><span class="op" id="3816944">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3816947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3816950">hs</span><span class="op" id="3816952">.</span><span class="ident" id="3816953">finishedHash</span><span class="op" id="3816965">.</span><span class="ident" id="3816966">Write</span><span class="op" id="3816971">(</span><span class="ident" id="3816972">certMsg</span><span class="op" id="3816979">.</span><span class="ident" id="3816980">marshal</span><span class="op" id="3816987">(</span><span class="op" id="3816988">)</span><span class="op" id="3816989">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3816993">certs</span>&nbsp;<span class="op" id="3816999">:=</span>&nbsp;<span class="builtinfunc" id="3817002">make</span><span class="op" id="3817006">(</span><span class="op" id="3817007">[</span><span class="op" id="3817008">]</span><span class="op" id="3817009">*</span><span class="ident" id="3817010">x509</span><span class="op" id="3817014">.</span><span class="ident" id="3817015">Certificate</span><span class="op" id="3817026">,</span>&nbsp;<span class="builtinfunc" id="3817028">len</span><span class="op" id="3817031">(</span><span class="ident" id="3817032">certMsg</span><span class="op" id="3817039">.</span><span class="ident" id="3817040">certificates</span><span class="op" id="3817052">)</span><span class="op" id="3817053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3817056">for</span>&nbsp;<span class="ident" id="3817060">i</span><span class="op" id="3817061">,</span>&nbsp;<span class="ident" id="3817063">asn1Data</span>&nbsp;<span class="op" id="3817072">:=</span>&nbsp;<span class="keyword" id="3817075">range</span>&nbsp;<span class="ident" id="3817081">certMsg</span><span class="op" id="3817088">.</span><span class="ident" id="3817089">certificates</span>&nbsp;<span class="op" id="3817102">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3817106">cert</span><span class="op" id="3817110">,</span>&nbsp;<span class="ident" id="3817112">err</span>&nbsp;<span class="op" id="3817116">:=</span>&nbsp;<span class="ident" id="3817119">x509</span><span class="op" id="3817123">.</span><span class="ident" id="3817124">ParseCertificate</span><span class="op" id="3817140">(</span><span class="ident" id="3817141">asn1Data</span><span class="op" id="3817149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3817153">if</span>&nbsp;<span class="ident" id="3817156">err</span>&nbsp;<span class="op" id="3817160">!=</span>&nbsp;<span class="ident" id="3817163">nil</span>&nbsp;<span class="op" id="3817167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3817172">c</span><span class="op" id="3817173">.</span><span class="ident" id="3817174">sendAlert</span><span class="op" id="3817183">(</span><span class="ident" id="3817184">alertBadCertificate</span><span class="op" id="3817203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3817208">return</span>&nbsp;<span class="ident" id="3817215">errors</span><span class="op" id="3817221">.</span><span class="ident" id="3817222">New</span><span class="op" id="3817225">(</span><span class="string" id="3817226">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;from&nbsp;server:&nbsp;&#34;</span>&nbsp;<span class="op" id="3817275">+</span>&nbsp;<span class="ident" id="3817277">err</span><span class="op" id="3817280">.</span><span class="ident" id="3817281">Error</span><span class="op" id="3817286">(</span><span class="op" id="3817287">)</span><span class="op" id="3817288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3817292">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3817296">certs</span><span class="op" id="3817301">[</span><span class="ident" id="3817302">i</span><span class="op" id="3817303">]</span>&nbsp;<span class="op" id="3817305">=</span>&nbsp;<span class="ident" id="3817307">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3817313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3817317">if</span>&nbsp;<span class="op" id="3817320">!</span><span class="ident" id="3817321">c</span><span class="op" id="3817322">.</span><span class="ident" id="3817323">config</span><span class="op" id="3817329">.</span><span class="ident" id="3817330">InsecureSkipVerify</span>&nbsp;<span class="op" id="3817349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3817353">opts</span>&nbsp;<span class="op" id="3817358">:=</span>&nbsp;<span class="ident" id="3817361">x509</span><span class="op" id="3817365">.</span><span class="ident" id="3817366">VerifyOptions</span><span class="op" id="3817379">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3817384">Roots</span><span class="op" id="3817389">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3817399">c</span><span class="op" id="3817400">.</span><span class="ident" id="3817401">config</span><span class="op" id="3817407">.</span><span class="ident" id="3817408">RootCAs</span><span class="op" id="3817415">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3817420">CurrentTime</span><span class="op" id="3817431">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3817435">c</span><span class="op" id="3817436">.</span><span class="ident" id="3817437">config</span><span class="op" id="3817443">.</span><span class="ident" id="3817444">time</span><span class="op" id="3817448">(</span><span class="op" id="3817449">)</span><span class="op" id="3817450">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3817455">DNSName</span><span class="op" id="3817462">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3817470">c</span><span class="op" id="3817471">.</span><span class="ident" id="3817472">config</span><span class="op" id="3817478">.</span><span class="ident" id="3817479">ServerName</span><span class="op" id="3817489">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3817494">Intermediates</span><span class="op" id="3817507">:</span>&nbsp;<span class="ident" id="3817509">x509</span><span class="op" id="3817513">.</span><span class="ident" id="3817514">NewCertPool</span><span class="op" id="3817525">(</span><span class="op" id="3817526">)</span><span class="op" id="3817527">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3817531">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3817536">for</span>&nbsp;<span class="ident" id="3817540">i</span><span class="op" id="3817541">,</span>&nbsp;<span class="ident" id="3817543">cert</span>&nbsp;<span class="op" id="3817548">:=</span>&nbsp;<span class="keyword" id="3817551">range</span>&nbsp;<span class="ident" id="3817557">certs</span>&nbsp;<span class="op" id="3817563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3817568">if</span>&nbsp;<span class="ident" id="3817571">i</span>&nbsp;<span class="op" id="3817573">==</span>&nbsp;<span class="num" id="3817576">0</span>&nbsp;<span class="op" id="3817578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3817584">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3817596">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3817601">opts</span><span class="op" id="3817605">.</span><span class="ident" id="3817606">Intermediates</span><span class="op" id="3817619">.</span><span class="ident" id="3817620">AddCert</span><span class="op" id="3817627">(</span><span class="ident" id="3817628">cert</span><span class="op" id="3817632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3817636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3817640">c</span><span class="op" id="3817641">.</span><span class="ident" id="3817642">verifiedChains</span><span class="op" id="3817656">,</span>&nbsp;<span class="ident" id="3817658">err</span>&nbsp;<span class="op" id="3817662">=</span>&nbsp;<span class="ident" id="3817664">certs</span><span class="op" id="3817669">[</span><span class="num" id="3817670">0</span><span class="op" id="3817671">]</span><span class="op" id="3817672">.</span><span class="ident" id="3817673">Verify</span><span class="op" id="3817679">(</span><span class="ident" id="3817680">opts</span><span class="op" id="3817684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3817688">if</span>&nbsp;<span class="ident" id="3817691">err</span>&nbsp;<span class="op" id="3817695">!=</span>&nbsp;<span class="ident" id="3817698">nil</span>&nbsp;<span class="op" id="3817702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3817707">c</span><span class="op" id="3817708">.</span><span class="ident" id="3817709">sendAlert</span><span class="op" id="3817718">(</span><span class="ident" id="3817719">alertBadCertificate</span><span class="op" id="3817738">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3817743">return</span>&nbsp;<span class="ident" id="3817750">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3817756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3817759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3817763">switch</span>&nbsp;<span class="ident" id="3817770">certs</span><span class="op" id="3817775">[</span><span class="num" id="3817776">0</span><span class="op" id="3817777">]</span><span class="op" id="3817778">.</span><span class="ident" id="3817779">PublicKey</span><span class="op" id="3817788">.</span><span class="op" id="3817789">(</span><span class="keyword" id="3817790">type</span><span class="op" id="3817794">)</span>&nbsp;<span class="op" id="3817796">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3817799">case</span>&nbsp;<span class="op" id="3817804">*</span><span class="ident" id="3817805">rsa</span><span class="op" id="3817808">.</span><span class="ident" id="3817809">PublicKey</span><span class="op" id="3817818">,</span>&nbsp;<span class="op" id="3817820">*</span><span class="ident" id="3817821">ecdsa</span><span class="op" id="3817826">.</span><span class="ident" id="3817827">PublicKey</span><span class="op" id="3817836">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3817840">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3817847">default</span><span class="op" id="3817854">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3817858">c</span><span class="op" id="3817859">.</span><span class="ident" id="3817860">sendAlert</span><span class="op" id="3817869">(</span><span class="ident" id="3817870">alertUnsupportedCertificate</span><span class="op" id="3817897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3817901">return</span>&nbsp;<span class="ident" id="3817908">fmt</span><span class="op" id="3817911">.</span><span class="ident" id="3817912">Errorf</span><span class="op" id="3817918">(</span><span class="string" id="3817919">&#34;tls:&nbsp;server&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;type&nbsp;of&nbsp;public&nbsp;key:&nbsp;%T&#34;</span><span class="op" id="3817993">,</span>&nbsp;<span class="ident" id="3817995">certs</span><span class="op" id="3818000">[</span><span class="num" id="3818001">0</span><span class="op" id="3818002">]</span><span class="op" id="3818003">.</span><span class="ident" id="3818004">PublicKey</span><span class="op" id="3818013">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3818016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818020">c</span><span class="op" id="3818021">.</span><span class="ident" id="3818022">peerCertificates</span>&nbsp;<span class="op" id="3818039">=</span>&nbsp;<span class="ident" id="3818041">certs</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818049">if</span>&nbsp;<span class="ident" id="3818052">hs</span><span class="op" id="3818054">.</span><span class="ident" id="3818055">serverHello</span><span class="op" id="3818066">.</span><span class="ident" id="3818067">ocspStapling</span>&nbsp;<span class="op" id="3818080">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818084">msg</span><span class="op" id="3818087">,</span>&nbsp;<span class="ident" id="3818089">err</span>&nbsp;<span class="op" id="3818093">=</span>&nbsp;<span class="ident" id="3818095">c</span><span class="op" id="3818096">.</span><span class="ident" id="3818097">readHandshake</span><span class="op" id="3818110">(</span><span class="op" id="3818111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818115">if</span>&nbsp;<span class="ident" id="3818118">err</span>&nbsp;<span class="op" id="3818122">!=</span>&nbsp;<span class="ident" id="3818125">nil</span>&nbsp;<span class="op" id="3818129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818134">return</span>&nbsp;<span class="ident" id="3818141">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3818147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818151">cs</span><span class="op" id="3818153">,</span>&nbsp;<span class="ident" id="3818155">ok</span>&nbsp;<span class="op" id="3818158">:=</span>&nbsp;<span class="ident" id="3818161">msg</span><span class="op" id="3818164">.</span><span class="op" id="3818165">(</span><span class="op" id="3818166">*</span><span class="ident" id="3818167">certificateStatusMsg</span><span class="op" id="3818187">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818191">if</span>&nbsp;<span class="op" id="3818194">!</span><span class="ident" id="3818195">ok</span>&nbsp;<span class="op" id="3818198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818203">c</span><span class="op" id="3818204">.</span><span class="ident" id="3818205">sendAlert</span><span class="op" id="3818214">(</span><span class="ident" id="3818215">alertUnexpectedMessage</span><span class="op" id="3818237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818242">return</span>&nbsp;<span class="ident" id="3818249">unexpectedMessageError</span><span class="op" id="3818271">(</span><span class="ident" id="3818272">cs</span><span class="op" id="3818274">,</span>&nbsp;<span class="ident" id="3818276">msg</span><span class="op" id="3818279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3818283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818287">hs</span><span class="op" id="3818289">.</span><span class="ident" id="3818290">finishedHash</span><span class="op" id="3818302">.</span><span class="ident" id="3818303">Write</span><span class="op" id="3818308">(</span><span class="ident" id="3818309">cs</span><span class="op" id="3818311">.</span><span class="ident" id="3818312">marshal</span><span class="op" id="3818319">(</span><span class="op" id="3818320">)</span><span class="op" id="3818321">)</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818326">if</span>&nbsp;<span class="ident" id="3818329">cs</span><span class="op" id="3818331">.</span><span class="ident" id="3818332">statusType</span>&nbsp;<span class="op" id="3818343">==</span>&nbsp;<span class="ident" id="3818346">statusTypeOCSP</span>&nbsp;<span class="op" id="3818361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818366">c</span><span class="op" id="3818367">.</span><span class="ident" id="3818368">ocspResponse</span>&nbsp;<span class="op" id="3818381">=</span>&nbsp;<span class="ident" id="3818383">cs</span><span class="op" id="3818385">.</span><span class="ident" id="3818386">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3818397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3818400">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818404">msg</span><span class="op" id="3818407">,</span>&nbsp;<span class="ident" id="3818409">err</span>&nbsp;<span class="op" id="3818413">=</span>&nbsp;<span class="ident" id="3818415">c</span><span class="op" id="3818416">.</span><span class="ident" id="3818417">readHandshake</span><span class="op" id="3818430">(</span><span class="op" id="3818431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818434">if</span>&nbsp;<span class="ident" id="3818437">err</span>&nbsp;<span class="op" id="3818441">!=</span>&nbsp;<span class="ident" id="3818444">nil</span>&nbsp;<span class="op" id="3818448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818452">return</span>&nbsp;<span class="ident" id="3818459">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3818464">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818468">keyAgreement</span>&nbsp;<span class="op" id="3818481">:=</span>&nbsp;<span class="ident" id="3818484">hs</span><span class="op" id="3818486">.</span><span class="ident" id="3818487">suite</span><span class="op" id="3818492">.</span><span class="ident" id="3818493">ka</span><span class="op" id="3818495">(</span><span class="ident" id="3818496">c</span><span class="op" id="3818497">.</span><span class="ident" id="3818498">vers</span><span class="op" id="3818502">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818506">skx</span><span class="op" id="3818509">,</span>&nbsp;<span class="ident" id="3818511">ok</span>&nbsp;<span class="op" id="3818514">:=</span>&nbsp;<span class="ident" id="3818517">msg</span><span class="op" id="3818520">.</span><span class="op" id="3818521">(</span><span class="op" id="3818522">*</span><span class="ident" id="3818523">serverKeyExchangeMsg</span><span class="op" id="3818543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818546">if</span>&nbsp;<span class="ident" id="3818549">ok</span>&nbsp;<span class="op" id="3818552">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818556">hs</span><span class="op" id="3818558">.</span><span class="ident" id="3818559">finishedHash</span><span class="op" id="3818571">.</span><span class="ident" id="3818572">Write</span><span class="op" id="3818577">(</span><span class="ident" id="3818578">skx</span><span class="op" id="3818581">.</span><span class="ident" id="3818582">marshal</span><span class="op" id="3818589">(</span><span class="op" id="3818590">)</span><span class="op" id="3818591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818595">err</span>&nbsp;<span class="op" id="3818599">=</span>&nbsp;<span class="ident" id="3818601">keyAgreement</span><span class="op" id="3818613">.</span><span class="ident" id="3818614">processServerKeyExchange</span><span class="op" id="3818638">(</span><span class="ident" id="3818639">c</span><span class="op" id="3818640">.</span><span class="ident" id="3818641">config</span><span class="op" id="3818647">,</span>&nbsp;<span class="ident" id="3818649">hs</span><span class="op" id="3818651">.</span><span class="ident" id="3818652">hello</span><span class="op" id="3818657">,</span>&nbsp;<span class="ident" id="3818659">hs</span><span class="op" id="3818661">.</span><span class="ident" id="3818662">serverHello</span><span class="op" id="3818673">,</span>&nbsp;<span class="ident" id="3818675">certs</span><span class="op" id="3818680">[</span><span class="num" id="3818681">0</span><span class="op" id="3818682">]</span><span class="op" id="3818683">,</span>&nbsp;<span class="ident" id="3818685">skx</span><span class="op" id="3818688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818692">if</span>&nbsp;<span class="ident" id="3818695">err</span>&nbsp;<span class="op" id="3818699">!=</span>&nbsp;<span class="ident" id="3818702">nil</span>&nbsp;<span class="op" id="3818706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818711">c</span><span class="op" id="3818712">.</span><span class="ident" id="3818713">sendAlert</span><span class="op" id="3818722">(</span><span class="ident" id="3818723">alertUnexpectedMessage</span><span class="op" id="3818745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818750">return</span>&nbsp;<span class="ident" id="3818757">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3818763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818768">msg</span><span class="op" id="3818771">,</span>&nbsp;<span class="ident" id="3818773">err</span>&nbsp;<span class="op" id="3818777">=</span>&nbsp;<span class="ident" id="3818779">c</span><span class="op" id="3818780">.</span><span class="ident" id="3818781">readHandshake</span><span class="op" id="3818794">(</span><span class="op" id="3818795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818799">if</span>&nbsp;<span class="ident" id="3818802">err</span>&nbsp;<span class="op" id="3818806">!=</span>&nbsp;<span class="ident" id="3818809">nil</span>&nbsp;<span class="op" id="3818813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818818">return</span>&nbsp;<span class="ident" id="3818825">err</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3818831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3818834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818838">var</span>&nbsp;<span class="ident" id="3818842">chainToSend</span>&nbsp;<span class="op" id="3818854">*</span><span class="ident" id="3818855">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818868">var</span>&nbsp;<span class="ident" id="3818872">certRequested</span>&nbsp;<span class="builtintype" id="3818886">bool</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818892">certReq</span><span class="op" id="3818899">,</span>&nbsp;<span class="ident" id="3818901">ok</span>&nbsp;<span class="op" id="3818904">:=</span>&nbsp;<span class="ident" id="3818907">msg</span><span class="op" id="3818910">.</span><span class="op" id="3818911">(</span><span class="op" id="3818912">*</span><span class="ident" id="3818913">certificateRequestMsg</span><span class="op" id="3818934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818937">if</span>&nbsp;<span class="ident" id="3818940">ok</span>&nbsp;<span class="op" id="3818943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818947">certRequested</span>&nbsp;<span class="op" id="3818961">=</span>&nbsp;<span class="builtintype" id="3818963">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3818971">//&nbsp;RFC&nbsp;4346&nbsp;on&nbsp;the&nbsp;certificateAuthorities&nbsp;field:</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3819022">//&nbsp;A&nbsp;list&nbsp;of&nbsp;the&nbsp;distinguished&nbsp;names&nbsp;of&nbsp;acceptable&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3819087">//&nbsp;authorities.&nbsp;These&nbsp;distinguished&nbsp;names&nbsp;may&nbsp;specify&nbsp;a&nbsp;desired</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3819153">//&nbsp;distinguished&nbsp;name&nbsp;for&nbsp;a&nbsp;root&nbsp;CA&nbsp;or&nbsp;for&nbsp;a&nbsp;subordinate&nbsp;CA;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3819216">//&nbsp;thus,&nbsp;this&nbsp;message&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;describe&nbsp;both&nbsp;known&nbsp;roots</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3819281">//&nbsp;and&nbsp;a&nbsp;desired&nbsp;authorization&nbsp;space.&nbsp;If&nbsp;the</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3819328">//&nbsp;certificate_authorities&nbsp;list&nbsp;is&nbsp;empty&nbsp;then&nbsp;the&nbsp;client&nbsp;MAY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3819391">//&nbsp;send&nbsp;any&nbsp;certificate&nbsp;of&nbsp;the&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3819436">//&nbsp;ClientCertificateType,&nbsp;unless&nbsp;there&nbsp;is&nbsp;some&nbsp;external</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3819494">//&nbsp;arrangement&nbsp;to&nbsp;the&nbsp;contrary.</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819529">hs</span><span class="op" id="3819531">.</span><span class="ident" id="3819532">finishedHash</span><span class="op" id="3819544">.</span><span class="ident" id="3819545">Write</span><span class="op" id="3819550">(</span><span class="ident" id="3819551">certReq</span><span class="op" id="3819558">.</span><span class="ident" id="3819559">marshal</span><span class="op" id="3819566">(</span><span class="op" id="3819567">)</span><span class="op" id="3819568">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3819573">var</span>&nbsp;<span class="ident" id="3819577">rsaAvail</span><span class="op" id="3819585">,</span>&nbsp;<span class="ident" id="3819587">ecdsaAvail</span>&nbsp;<span class="builtintype" id="3819598">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3819605">for</span>&nbsp;<span class="ident" id="3819609">_</span><span class="op" id="3819610">,</span>&nbsp;<span class="ident" id="3819612">certType</span>&nbsp;<span class="op" id="3819621">:=</span>&nbsp;<span class="keyword" id="3819624">range</span>&nbsp;<span class="ident" id="3819630">certReq</span><span class="op" id="3819637">.</span><span class="ident" id="3819638">certificateTypes</span>&nbsp;<span class="op" id="3819655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3819660">switch</span>&nbsp;<span class="ident" id="3819667">certType</span>&nbsp;<span class="op" id="3819676">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3819681">case</span>&nbsp;<span class="ident" id="3819686">certTypeRSASign</span><span class="op" id="3819701">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819707">rsaAvail</span>&nbsp;<span class="op" id="3819716">=</span>&nbsp;<span class="builtintype" id="3819718">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3819726">case</span>&nbsp;<span class="ident" id="3819731">certTypeECDSASign</span><span class="op" id="3819748">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819754">ecdsaAvail</span>&nbsp;<span class="op" id="3819765">=</span>&nbsp;<span class="builtintype" id="3819767">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3819775">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3819779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3819784">//&nbsp;We&nbsp;need&nbsp;to&nbsp;search&nbsp;our&nbsp;list&nbsp;of&nbsp;client&nbsp;certs&nbsp;for&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3819840">//&nbsp;where&nbsp;SignatureAlgorithm&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;the&nbsp;server&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3819906">//&nbsp;Issuer&nbsp;is&nbsp;in&nbsp;certReq.certificateAuthorities</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819954">findCert</span><span class="op" id="3819962">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3819966">for</span>&nbsp;<span class="ident" id="3819970">i</span><span class="op" id="3819971">,</span>&nbsp;<span class="ident" id="3819973">chain</span>&nbsp;<span class="op" id="3819979">:=</span>&nbsp;<span class="keyword" id="3819982">range</span>&nbsp;<span class="ident" id="3819988">c</span><span class="op" id="3819989">.</span><span class="ident" id="3819990">config</span><span class="op" id="3819996">.</span><span class="ident" id="3819997">Certificates</span>&nbsp;<span class="op" id="3820010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3820015">if</span>&nbsp;<span class="op" id="3820018">!</span><span class="ident" id="3820019">rsaAvail</span>&nbsp;<span class="op" id="3820028">&amp;&amp;</span>&nbsp;<span class="op" id="3820031">!</span><span class="ident" id="3820032">ecdsaAvail</span>&nbsp;<span class="op" id="3820043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3820049">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3820061">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3820067">for</span>&nbsp;<span class="ident" id="3820071">j</span><span class="op" id="3820072">,</span>&nbsp;<span class="ident" id="3820074">cert</span>&nbsp;<span class="op" id="3820079">:=</span>&nbsp;<span class="keyword" id="3820082">range</span>&nbsp;<span class="ident" id="3820088">chain</span><span class="op" id="3820093">.</span><span class="ident" id="3820094">Certificate</span>&nbsp;<span class="op" id="3820106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3820112">x509Cert</span>&nbsp;<span class="op" id="3820121">:=</span>&nbsp;<span class="ident" id="3820124">chain</span><span class="op" id="3820129">.</span><span class="ident" id="3820130">Leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3820139">//&nbsp;parse&nbsp;the&nbsp;certificate&nbsp;if&nbsp;this&nbsp;isn&#39;t&nbsp;the&nbsp;leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3820191">//&nbsp;node,&nbsp;or&nbsp;if&nbsp;chain.Leaf&nbsp;was&nbsp;nil</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3820229">if</span>&nbsp;<span class="ident" id="3820232">j</span>&nbsp;<span class="op" id="3820234">!=</span>&nbsp;<span class="num" id="3820237">0</span>&nbsp;<span class="op" id="3820239">||</span>&nbsp;<span class="ident" id="3820242">x509Cert</span>&nbsp;<span class="op" id="3820251">==</span>&nbsp;<span class="ident" id="3820254">nil</span>&nbsp;<span class="op" id="3820258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3820265">if</span>&nbsp;<span class="ident" id="3820268">x509Cert</span><span class="op" id="3820276">,</span>&nbsp;<span class="ident" id="3820278">err</span>&nbsp;<span class="op" id="3820282">=</span>&nbsp;<span class="ident" id="3820284">x509</span><span class="op" id="3820288">.</span><span class="ident" id="3820289">ParseCertificate</span><span class="op" id="3820305">(</span><span class="ident" id="3820306">cert</span><span class="op" id="3820310">)</span><span class="op" id="3820311">;</span>&nbsp;<span class="ident" id="3820313">err</span>&nbsp;<span class="op" id="3820317">!=</span>&nbsp;<span class="ident" id="3820320">nil</span>&nbsp;<span class="op" id="3820324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3820332">c</span><span class="op" id="3820333">.</span><span class="ident" id="3820334">sendAlert</span><span class="op" id="3820343">(</span><span class="ident" id="3820344">alertInternalError</span><span class="op" id="3820362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3820370">return</span>&nbsp;<span class="ident" id="3820377">errors</span><span class="op" id="3820383">.</span><span class="ident" id="3820384">New</span><span class="op" id="3820387">(</span><span class="string" id="3820388">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate&nbsp;#&#34;</span>&nbsp;<span class="op" id="3820432">+</span>&nbsp;<span class="ident" id="3820434">strconv</span><span class="op" id="3820441">.</span><span class="ident" id="3820442">Itoa</span><span class="op" id="3820446">(</span><span class="ident" id="3820447">i</span><span class="op" id="3820448">)</span>&nbsp;<span class="op" id="3820450">+</span>&nbsp;<span class="string" id="3820452">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="3820457">+</span>&nbsp;<span class="ident" id="3820459">err</span><span class="op" id="3820462">.</span><span class="ident" id="3820463">Error</span><span class="op" id="3820468">(</span><span class="op" id="3820469">)</span><span class="op" id="3820470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3820477">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3820483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3820490">switch</span>&nbsp;<span class="op" id="3820497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3820503">case</span>&nbsp;<span class="ident" id="3820508">rsaAvail</span>&nbsp;<span class="op" id="3820517">&amp;&amp;</span>&nbsp;<span class="ident" id="3820520">x509Cert</span><span class="op" id="3820528">.</span><span class="ident" id="3820529">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="3820548">==</span>&nbsp;<span class="ident" id="3820551">x509</span><span class="op" id="3820555">.</span><span class="ident" id="3820556">RSA</span><span class="op" id="3820559">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3820565">case</span>&nbsp;<span class="ident" id="3820570">ecdsaAvail</span>&nbsp;<span class="op" id="3820581">&amp;&amp;</span>&nbsp;<span class="ident" id="3820584">x509Cert</span><span class="op" id="3820592">.</span><span class="ident" id="3820593">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="3820612">==</span>&nbsp;<span class="ident" id="3820615">x509</span><span class="op" id="3820619">.</span><span class="ident" id="3820620">ECDSA</span><span class="op" id="3820625">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3820631">default</span><span class="op" id="3820638">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3820645">continue</span>&nbsp;<span class="ident" id="3820654">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3820667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3820674">if</span>&nbsp;<span class="builtinfunc" id="3820677">len</span><span class="op" id="3820680">(</span><span class="ident" id="3820681">certReq</span><span class="op" id="3820688">.</span><span class="ident" id="3820689">certificateAuthorities</span><span class="op" id="3820711">)</span>&nbsp;<span class="op" id="3820713">==</span>&nbsp;<span class="num" id="3820716">0</span>&nbsp;<span class="op" id="3820718">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3820725">//&nbsp;they&nbsp;gave&nbsp;us&nbsp;an&nbsp;empty&nbsp;list,&nbsp;so&nbsp;just&nbsp;take&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3820778">//&nbsp;first&nbsp;cert&nbsp;from&nbsp;c.config.Certificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3820824">chainToSend</span>&nbsp;<span class="op" id="3820836">=</span>&nbsp;<span class="op" id="3820838">&amp;</span><span class="ident" id="3820839">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3820850">break</span>&nbsp;<span class="ident" id="3820856">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3820869">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3820876">for</span>&nbsp;<span class="ident" id="3820880">_</span><span class="op" id="3820881">,</span>&nbsp;<span class="ident" id="3820883">ca</span>&nbsp;<span class="op" id="3820886">:=</span>&nbsp;<span class="keyword" id="3820889">range</span>&nbsp;<span class="ident" id="3820895">certReq</span><span class="op" id="3820902">.</span><span class="ident" id="3820903">certificateAuthorities</span>&nbsp;<span class="op" id="3820926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3820933">if</span>&nbsp;<span class="ident" id="3820936">bytes</span><span class="op" id="3820941">.</span><span class="ident" id="3820942">Equal</span><span class="op" id="3820947">(</span><span class="ident" id="3820948">x509Cert</span><span class="op" id="3820956">.</span><span class="ident" id="3820957">RawIssuer</span><span class="op" id="3820966">,</span>&nbsp;<span class="ident" id="3820968">ca</span><span class="op" id="3820970">)</span>&nbsp;<span class="op" id="3820972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3820980">chainToSend</span>&nbsp;<span class="op" id="3820992">=</span>&nbsp;<span class="op" id="3820994">&amp;</span><span class="ident" id="3820995">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821007">break</span>&nbsp;<span class="ident" id="3821013">findCert</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3821027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3821033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3821038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3821042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3821047">msg</span><span class="op" id="3821050">,</span>&nbsp;<span class="ident" id="3821052">err</span>&nbsp;<span class="op" id="3821056">=</span>&nbsp;<span class="ident" id="3821058">c</span><span class="op" id="3821059">.</span><span class="ident" id="3821060">readHandshake</span><span class="op" id="3821073">(</span><span class="op" id="3821074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821078">if</span>&nbsp;<span class="ident" id="3821081">err</span>&nbsp;<span class="op" id="3821085">!=</span>&nbsp;<span class="ident" id="3821088">nil</span>&nbsp;<span class="op" id="3821092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821097">return</span>&nbsp;<span class="ident" id="3821104">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3821110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3821113">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3821117">shd</span><span class="op" id="3821120">,</span>&nbsp;<span class="ident" id="3821122">ok</span>&nbsp;<span class="op" id="3821125">:=</span>&nbsp;<span class="ident" id="3821128">msg</span><span class="op" id="3821131">.</span><span class="op" id="3821132">(</span><span class="op" id="3821133">*</span><span class="ident" id="3821134">serverHelloDoneMsg</span><span class="op" id="3821152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821155">if</span>&nbsp;<span class="op" id="3821158">!</span><span class="ident" id="3821159">ok</span>&nbsp;<span class="op" id="3821162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3821166">c</span><span class="op" id="3821167">.</span><span class="ident" id="3821168">sendAlert</span><span class="op" id="3821177">(</span><span class="ident" id="3821178">alertUnexpectedMessage</span><span class="op" id="3821200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821204">return</span>&nbsp;<span class="ident" id="3821211">unexpectedMessageError</span><span class="op" id="3821233">(</span><span class="ident" id="3821234">shd</span><span class="op" id="3821237">,</span>&nbsp;<span class="ident" id="3821239">msg</span><span class="op" id="3821242">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3821245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3821248">hs</span><span class="op" id="3821250">.</span><span class="ident" id="3821251">finishedHash</span><span class="op" id="3821263">.</span><span class="ident" id="3821264">Write</span><span class="op" id="3821269">(</span><span class="ident" id="3821270">shd</span><span class="op" id="3821273">.</span><span class="ident" id="3821274">marshal</span><span class="op" id="3821281">(</span><span class="op" id="3821282">)</span><span class="op" id="3821283">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3821287">//&nbsp;If&nbsp;the&nbsp;server&nbsp;requested&nbsp;a&nbsp;certificate&nbsp;then&nbsp;we&nbsp;have&nbsp;to&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3821352">//&nbsp;Certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3821420">//&nbsp;certificate&nbsp;to&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821445">if</span>&nbsp;<span class="ident" id="3821448">certRequested</span>&nbsp;<span class="op" id="3821462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3821466">certMsg</span>&nbsp;<span class="op" id="3821474">=</span>&nbsp;<span class="builtinfunc" id="3821476">new</span><span class="op" id="3821479">(</span><span class="ident" id="3821480">certificateMsg</span><span class="op" id="3821494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821498">if</span>&nbsp;<span class="ident" id="3821501">chainToSend</span>&nbsp;<span class="op" id="3821513">!=</span>&nbsp;<span class="ident" id="3821516">nil</span>&nbsp;<span class="op" id="3821520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3821525">certMsg</span><span class="op" id="3821532">.</span><span class="ident" id="3821533">certificates</span>&nbsp;<span class="op" id="3821546">=</span>&nbsp;<span class="ident" id="3821548">chainToSend</span><span class="op" id="3821559">.</span><span class="ident" id="3821560">Certificate</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3821574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3821578">hs</span><span class="op" id="3821580">.</span><span class="ident" id="3821581">finishedHash</span><span class="op" id="3821593">.</span><span class="ident" id="3821594">Write</span><span class="op" id="3821599">(</span><span class="ident" id="3821600">certMsg</span><span class="op" id="3821607">.</span><span class="ident" id="3821608">marshal</span><span class="op" id="3821615">(</span><span class="op" id="3821616">)</span><span class="op" id="3821617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3821621">c</span><span class="op" id="3821622">.</span><span class="ident" id="3821623">writeRecord</span><span class="op" id="3821634">(</span><span class="ident" id="3821635">recordTypeHandshake</span><span class="op" id="3821654">,</span>&nbsp;<span class="ident" id="3821656">certMsg</span><span class="op" id="3821663">.</span><span class="ident" id="3821664">marshal</span><span class="op" id="3821671">(</span><span class="op" id="3821672">)</span><span class="op" id="3821673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3821676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3821680">preMasterSecret</span><span class="op" id="3821695">,</span>&nbsp;<span class="ident" id="3821697">ckx</span><span class="op" id="3821700">,</span>&nbsp;<span class="ident" id="3821702">err</span>&nbsp;<span class="op" id="3821706">:=</span>&nbsp;<span class="ident" id="3821709">keyAgreement</span><span class="op" id="3821721">.</span><span class="ident" id="3821722">generateClientKeyExchange</span><span class="op" id="3821747">(</span><span class="ident" id="3821748">c</span><span class="op" id="3821749">.</span><span class="ident" id="3821750">config</span><span class="op" id="3821756">,</span>&nbsp;<span class="ident" id="3821758">hs</span><span class="op" id="3821760">.</span><span class="ident" id="3821761">hello</span><span class="op" id="3821766">,</span>&nbsp;<span class="ident" id="3821768">certs</span><span class="op" id="3821773">[</span><span class="num" id="3821774">0</span><span class="op" id="3821775">]</span><span class="op" id="3821776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821779">if</span>&nbsp;<span class="ident" id="3821782">err</span>&nbsp;<span class="op" id="3821786">!=</span>&nbsp;<span class="ident" id="3821789">nil</span>&nbsp;<span class="op" id="3821793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3821797">c</span><span class="op" id="3821798">.</span><span class="ident" id="3821799">sendAlert</span><span class="op" id="3821808">(</span><span class="ident" id="3821809">alertInternalError</span><span class="op" id="3821827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821831">return</span>&nbsp;<span class="ident" id="3821838">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3821843">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821846">if</span>&nbsp;<span class="ident" id="3821849">ckx</span>&nbsp;<span class="op" id="3821853">!=</span>&nbsp;<span class="ident" id="3821856">nil</span>&nbsp;<span class="op" id="3821860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3821864">hs</span><span class="op" id="3821866">.</span><span class="ident" id="3821867">finishedHash</span><span class="op" id="3821879">.</span><span class="ident" id="3821880">Write</span><span class="op" id="3821885">(</span><span class="ident" id="3821886">ckx</span><span class="op" id="3821889">.</span><span class="ident" id="3821890">marshal</span><span class="op" id="3821897">(</span><span class="op" id="3821898">)</span><span class="op" id="3821899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3821903">c</span><span class="op" id="3821904">.</span><span class="ident" id="3821905">writeRecord</span><span class="op" id="3821916">(</span><span class="ident" id="3821917">recordTypeHandshake</span><span class="op" id="3821936">,</span>&nbsp;<span class="ident" id="3821938">ckx</span><span class="op" id="3821941">.</span><span class="ident" id="3821942">marshal</span><span class="op" id="3821949">(</span><span class="op" id="3821950">)</span><span class="op" id="3821951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3821954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821958">if</span>&nbsp;<span class="ident" id="3821961">chainToSend</span>&nbsp;<span class="op" id="3821973">!=</span>&nbsp;<span class="ident" id="3821976">nil</span>&nbsp;<span class="op" id="3821980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821984">var</span>&nbsp;<span class="ident" id="3821988">signed</span>&nbsp;<span class="op" id="3821995">[</span><span class="op" id="3821996">]</span><span class="builtintype" id="3821997">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822004">certVerify</span>&nbsp;<span class="op" id="3822015">:=</span>&nbsp;<span class="op" id="3822018">&amp;</span><span class="ident" id="3822019">certificateVerifyMsg</span><span class="op" id="3822039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822044">hasSignatureAndHash</span><span class="op" id="3822063">:</span>&nbsp;<span class="ident" id="3822065">c</span><span class="op" id="3822066">.</span><span class="ident" id="3822067">vers</span>&nbsp;<span class="op" id="3822072">&gt;=</span>&nbsp;<span class="ident" id="3822075">VersionTLS12</span><span class="op" id="3822087">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3822091">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822096">key</span><span class="op" id="3822099">,</span>&nbsp;<span class="ident" id="3822101">ok</span>&nbsp;<span class="op" id="3822104">:=</span>&nbsp;<span class="ident" id="3822107">chainToSend</span><span class="op" id="3822118">.</span><span class="ident" id="3822119">PrivateKey</span><span class="op" id="3822129">.</span><span class="op" id="3822130">(</span><span class="ident" id="3822131">crypto</span><span class="op" id="3822137">.</span><span class="ident" id="3822138">Signer</span><span class="op" id="3822144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822148">if</span>&nbsp;<span class="op" id="3822151">!</span><span class="ident" id="3822152">ok</span>&nbsp;<span class="op" id="3822155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822160">c</span><span class="op" id="3822161">.</span><span class="ident" id="3822162">sendAlert</span><span class="op" id="3822171">(</span><span class="ident" id="3822172">alertInternalError</span><span class="op" id="3822190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822195">return</span>&nbsp;<span class="ident" id="3822202">fmt</span><span class="op" id="3822205">.</span><span class="ident" id="3822206">Errorf</span><span class="op" id="3822212">(</span><span class="string" id="3822213">&#34;tls:&nbsp;client&nbsp;certificate&nbsp;private&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&nbsp;does&nbsp;not&nbsp;implement&nbsp;crypto.Signer&#34;</span><span class="op" id="3822294">,</span>&nbsp;<span class="ident" id="3822296">chainToSend</span><span class="op" id="3822307">.</span><span class="ident" id="3822308">PrivateKey</span><span class="op" id="3822318">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3822322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822326">switch</span>&nbsp;<span class="ident" id="3822333">key</span><span class="op" id="3822336">.</span><span class="ident" id="3822337">Public</span><span class="op" id="3822343">(</span><span class="op" id="3822344">)</span><span class="op" id="3822345">.</span><span class="op" id="3822346">(</span><span class="keyword" id="3822347">type</span><span class="op" id="3822351">)</span>&nbsp;<span class="op" id="3822353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822357">case</span>&nbsp;<span class="op" id="3822362">*</span><span class="ident" id="3822363">ecdsa</span><span class="op" id="3822368">.</span><span class="ident" id="3822369">PublicKey</span><span class="op" id="3822378">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822383">digest</span><span class="op" id="3822389">,</span>&nbsp;<span class="ident" id="3822391">hashFunc</span><span class="op" id="3822399">,</span>&nbsp;<span class="ident" id="3822401">hashId</span>&nbsp;<span class="op" id="3822408">:=</span>&nbsp;<span class="ident" id="3822411">hs</span><span class="op" id="3822413">.</span><span class="ident" id="3822414">finishedHash</span><span class="op" id="3822426">.</span><span class="ident" id="3822427">hashForClientCertificate</span><span class="op" id="3822451">(</span><span class="ident" id="3822452">signatureECDSA</span><span class="op" id="3822466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822471">signed</span><span class="op" id="3822477">,</span>&nbsp;<span class="ident" id="3822479">err</span>&nbsp;<span class="op" id="3822483">=</span>&nbsp;<span class="ident" id="3822485">key</span><span class="op" id="3822488">.</span><span class="ident" id="3822489">Sign</span><span class="op" id="3822493">(</span><span class="ident" id="3822494">c</span><span class="op" id="3822495">.</span><span class="ident" id="3822496">config</span><span class="op" id="3822502">.</span><span class="ident" id="3822503">rand</span><span class="op" id="3822507">(</span><span class="op" id="3822508">)</span><span class="op" id="3822509">,</span>&nbsp;<span class="ident" id="3822511">digest</span><span class="op" id="3822517">,</span>&nbsp;<span class="ident" id="3822519">hashFunc</span><span class="op" id="3822527">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822532">certVerify</span><span class="op" id="3822542">.</span><span class="ident" id="3822543">signatureAndHash</span><span class="op" id="3822559">.</span><span class="ident" id="3822560">signature</span>&nbsp;<span class="op" id="3822570">=</span>&nbsp;<span class="ident" id="3822572">signatureECDSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822590">certVerify</span><span class="op" id="3822600">.</span><span class="ident" id="3822601">signatureAndHash</span><span class="op" id="3822617">.</span><span class="ident" id="3822618">hash</span>&nbsp;<span class="op" id="3822623">=</span>&nbsp;<span class="ident" id="3822625">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822634">case</span>&nbsp;<span class="op" id="3822639">*</span><span class="ident" id="3822640">rsa</span><span class="op" id="3822643">.</span><span class="ident" id="3822644">PublicKey</span><span class="op" id="3822653">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822658">digest</span><span class="op" id="3822664">,</span>&nbsp;<span class="ident" id="3822666">hashFunc</span><span class="op" id="3822674">,</span>&nbsp;<span class="ident" id="3822676">hashId</span>&nbsp;<span class="op" id="3822683">:=</span>&nbsp;<span class="ident" id="3822686">hs</span><span class="op" id="3822688">.</span><span class="ident" id="3822689">finishedHash</span><span class="op" id="3822701">.</span><span class="ident" id="3822702">hashForClientCertificate</span><span class="op" id="3822726">(</span><span class="ident" id="3822727">signatureRSA</span><span class="op" id="3822739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822744">signed</span><span class="op" id="3822750">,</span>&nbsp;<span class="ident" id="3822752">err</span>&nbsp;<span class="op" id="3822756">=</span>&nbsp;<span class="ident" id="3822758">key</span><span class="op" id="3822761">.</span><span class="ident" id="3822762">Sign</span><span class="op" id="3822766">(</span><span class="ident" id="3822767">c</span><span class="op" id="3822768">.</span><span class="ident" id="3822769">config</span><span class="op" id="3822775">.</span><span class="ident" id="3822776">rand</span><span class="op" id="3822780">(</span><span class="op" id="3822781">)</span><span class="op" id="3822782">,</span>&nbsp;<span class="ident" id="3822784">digest</span><span class="op" id="3822790">,</span>&nbsp;<span class="ident" id="3822792">hashFunc</span><span class="op" id="3822800">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822805">certVerify</span><span class="op" id="3822815">.</span><span class="ident" id="3822816">signatureAndHash</span><span class="op" id="3822832">.</span><span class="ident" id="3822833">signature</span>&nbsp;<span class="op" id="3822843">=</span>&nbsp;<span class="ident" id="3822845">signatureRSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822861">certVerify</span><span class="op" id="3822871">.</span><span class="ident" id="3822872">signatureAndHash</span><span class="op" id="3822888">.</span><span class="ident" id="3822889">hash</span>&nbsp;<span class="op" id="3822894">=</span>&nbsp;<span class="ident" id="3822896">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822905">default</span><span class="op" id="3822912">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822917">err</span>&nbsp;<span class="op" id="3822921">=</span>&nbsp;<span class="ident" id="3822923">fmt</span><span class="op" id="3822926">.</span><span class="ident" id="3822927">Errorf</span><span class="op" id="3822933">(</span><span class="string" id="3822934">&#34;tls:&nbsp;unknown&nbsp;client&nbsp;certificate&nbsp;key&nbsp;type:&nbsp;%T&#34;</span><span class="op" id="3822980">,</span>&nbsp;<span class="ident" id="3822982">key</span><span class="op" id="3822985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3822989">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822993">if</span>&nbsp;<span class="ident" id="3822996">err</span>&nbsp;<span class="op" id="3823000">!=</span>&nbsp;<span class="ident" id="3823003">nil</span>&nbsp;<span class="op" id="3823007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3823012">c</span><span class="op" id="3823013">.</span><span class="ident" id="3823014">sendAlert</span><span class="op" id="3823023">(</span><span class="ident" id="3823024">alertInternalError</span><span class="op" id="3823042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3823047">return</span>&nbsp;<span class="ident" id="3823054">errors</span><span class="op" id="3823060">.</span><span class="ident" id="3823061">New</span><span class="op" id="3823064">(</span><span class="string" id="3823065">&#34;tls:&nbsp;failed&nbsp;to&nbsp;sign&nbsp;handshake&nbsp;with&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3823123">+</span>&nbsp;<span class="ident" id="3823125">err</span><span class="op" id="3823128">.</span><span class="ident" id="3823129">Error</span><span class="op" id="3823134">(</span><span class="op" id="3823135">)</span><span class="op" id="3823136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3823140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3823144">certVerify</span><span class="op" id="3823154">.</span><span class="ident" id="3823155">signature</span>&nbsp;<span class="op" id="3823165">=</span>&nbsp;<span class="ident" id="3823167">signed</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3823177">hs</span><span class="op" id="3823179">.</span><span class="ident" id="3823180">finishedHash</span><span class="op" id="3823192">.</span><span class="ident" id="3823193">Write</span><span class="op" id="3823198">(</span><span class="ident" id="3823199">certVerify</span><span class="op" id="3823209">.</span><span class="ident" id="3823210">marshal</span><span class="op" id="3823217">(</span><span class="op" id="3823218">)</span><span class="op" id="3823219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3823223">c</span><span class="op" id="3823224">.</span><span class="ident" id="3823225">writeRecord</span><span class="op" id="3823236">(</span><span class="ident" id="3823237">recordTypeHandshake</span><span class="op" id="3823256">,</span>&nbsp;<span class="ident" id="3823258">certVerify</span><span class="op" id="3823268">.</span><span class="ident" id="3823269">marshal</span><span class="op" id="3823276">(</span><span class="op" id="3823277">)</span><span class="op" id="3823278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3823281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3823285">hs</span><span class="op" id="3823287">.</span><span class="ident" id="3823288">masterSecret</span>&nbsp;<span class="op" id="3823301">=</span>&nbsp;<span class="ident" id="3823303">masterFromPreMasterSecret</span><span class="op" id="3823328">(</span><span class="ident" id="3823329">c</span><span class="op" id="3823330">.</span><span class="ident" id="3823331">vers</span><span class="op" id="3823335">,</span>&nbsp;<span class="ident" id="3823337">preMasterSecret</span><span class="op" id="3823352">,</span>&nbsp;<span class="ident" id="3823354">hs</span><span class="op" id="3823356">.</span><span class="ident" id="3823357">hello</span><span class="op" id="3823362">.</span><span class="ident" id="3823363">random</span><span class="op" id="3823369">,</span>&nbsp;<span class="ident" id="3823371">hs</span><span class="op" id="3823373">.</span><span class="ident" id="3823374">serverHello</span><span class="op" id="3823385">.</span><span class="ident" id="3823386">random</span><span class="op" id="3823392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3823395">return</span>&nbsp;<span class="ident" id="3823402">nil</span><br>
<span class="lineno"></span><span class="op" id="3823406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3823409">func</span>&nbsp;<span class="op" id="3823414">(</span><span class="ident" id="3823415">hs</span>&nbsp;<span class="op" id="3823418">*</span><span class="ident" id="3823419">clientHandshakeState</span><span class="op" id="3823439">)</span>&nbsp;<span class="ident" id="3823441">establishKeys</span><span class="op" id="3823454">(</span><span class="op" id="3823455">)</span>&nbsp;<span class="builtintype" id="3823457">error</span>&nbsp;<span class="op" id="3823463">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3823466">c</span>&nbsp;<span class="op" id="3823468">:=</span>&nbsp;<span class="ident" id="3823471">hs</span><span class="op" id="3823473">.</span><span class="ident" id="3823474">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3823478">clientMAC</span><span class="op" id="3823487">,</span>&nbsp;<span class="ident" id="3823489">serverMAC</span><span class="op" id="3823498">,</span>&nbsp;<span class="ident" id="3823500">clientKey</span><span class="op" id="3823509">,</span>&nbsp;<span class="ident" id="3823511">serverKey</span><span class="op" id="3823520">,</span>&nbsp;<span class="ident" id="3823522">clientIV</span><span class="op" id="3823530">,</span>&nbsp;<span class="ident" id="3823532">serverIV</span>&nbsp;<span class="op" id="3823541">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3823546">keysFromMasterSecret</span><span class="op" id="3823566">(</span><span class="ident" id="3823567">c</span><span class="op" id="3823568">.</span><span class="ident" id="3823569">vers</span><span class="op" id="3823573">,</span>&nbsp;<span class="ident" id="3823575">hs</span><span class="op" id="3823577">.</span><span class="ident" id="3823578">masterSecret</span><span class="op" id="3823590">,</span>&nbsp;<span class="ident" id="3823592">hs</span><span class="op" id="3823594">.</span><span class="ident" id="3823595">hello</span><span class="op" id="3823600">.</span><span class="ident" id="3823601">random</span><span class="op" id="3823607">,</span>&nbsp;<span class="ident" id="3823609">hs</span><span class="op" id="3823611">.</span><span class="ident" id="3823612">serverHello</span><span class="op" id="3823623">.</span><span class="ident" id="3823624">random</span><span class="op" id="3823630">,</span>&nbsp;<span class="ident" id="3823632">hs</span><span class="op" id="3823634">.</span><span class="ident" id="3823635">suite</span><span class="op" id="3823640">.</span><span class="ident" id="3823641">macLen</span><span class="op" id="3823647">,</span>&nbsp;<span class="ident" id="3823649">hs</span><span class="op" id="3823651">.</span><span class="ident" id="3823652">suite</span><span class="op" id="3823657">.</span><span class="ident" id="3823658">keyLen</span><span class="op" id="3823664">,</span>&nbsp;<span class="ident" id="3823666">hs</span><span class="op" id="3823668">.</span><span class="ident" id="3823669">suite</span><span class="op" id="3823674">.</span><span class="ident" id="3823675">ivLen</span><span class="op" id="3823680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3823683">var</span>&nbsp;<span class="ident" id="3823687">clientCipher</span><span class="op" id="3823699">,</span>&nbsp;<span class="ident" id="3823701">serverCipher</span>&nbsp;<span class="keyword" id="3823714">interface</span><span class="op" id="3823723">{</span><span class="op" id="3823724">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3823727">var</span>&nbsp;<span class="ident" id="3823731">clientHash</span><span class="op" id="3823741">,</span>&nbsp;<span class="ident" id="3823743">serverHash</span>&nbsp;<span class="ident" id="3823754">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3823767">if</span>&nbsp;<span class="ident" id="3823770">hs</span><span class="op" id="3823772">.</span><span class="ident" id="3823773">suite</span><span class="op" id="3823778">.</span><span class="ident" id="3823779">cipher</span>&nbsp;<span class="op" id="3823786">!=</span>&nbsp;<span class="ident" id="3823789">nil</span>&nbsp;<span class="op" id="3823793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3823797">clientCipher</span>&nbsp;<span class="op" id="3823810">=</span>&nbsp;<span class="ident" id="3823812">hs</span><span class="op" id="3823814">.</span><span class="ident" id="3823815">suite</span><span class="op" id="3823820">.</span><span class="ident" id="3823821">cipher</span><span class="op" id="3823827">(</span><span class="ident" id="3823828">clientKey</span><span class="op" id="3823837">,</span>&nbsp;<span class="ident" id="3823839">clientIV</span><span class="op" id="3823847">,</span>&nbsp;<span class="builtintype" id="3823849">false</span>&nbsp;<span class="comment" id="3823855">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3823876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3823880">clientHash</span>&nbsp;<span class="op" id="3823891">=</span>&nbsp;<span class="ident" id="3823893">hs</span><span class="op" id="3823895">.</span><span class="ident" id="3823896">suite</span><span class="op" id="3823901">.</span><span class="ident" id="3823902">mac</span><span class="op" id="3823905">(</span><span class="ident" id="3823906">c</span><span class="op" id="3823907">.</span><span class="ident" id="3823908">vers</span><span class="op" id="3823912">,</span>&nbsp;<span class="ident" id="3823914">clientMAC</span><span class="op" id="3823923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3823927">serverCipher</span>&nbsp;<span class="op" id="3823940">=</span>&nbsp;<span class="ident" id="3823942">hs</span><span class="op" id="3823944">.</span><span class="ident" id="3823945">suite</span><span class="op" id="3823950">.</span><span class="ident" id="3823951">cipher</span><span class="op" id="3823957">(</span><span class="ident" id="3823958">serverKey</span><span class="op" id="3823967">,</span>&nbsp;<span class="ident" id="3823969">serverIV</span><span class="op" id="3823977">,</span>&nbsp;<span class="builtintype" id="3823979">true</span>&nbsp;<span class="comment" id="3823984">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3824001">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824005">serverHash</span>&nbsp;<span class="op" id="3824016">=</span>&nbsp;<span class="ident" id="3824018">hs</span><span class="op" id="3824020">.</span><span class="ident" id="3824021">suite</span><span class="op" id="3824026">.</span><span class="ident" id="3824027">mac</span><span class="op" id="3824030">(</span><span class="ident" id="3824031">c</span><span class="op" id="3824032">.</span><span class="ident" id="3824033">vers</span><span class="op" id="3824037">,</span>&nbsp;<span class="ident" id="3824039">serverMAC</span><span class="op" id="3824048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3824051">}</span>&nbsp;<span class="keyword" id="3824053">else</span>&nbsp;<span class="op" id="3824058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824062">clientCipher</span>&nbsp;<span class="op" id="3824075">=</span>&nbsp;<span class="ident" id="3824077">hs</span><span class="op" id="3824079">.</span><span class="ident" id="3824080">suite</span><span class="op" id="3824085">.</span><span class="ident" id="3824086">aead</span><span class="op" id="3824090">(</span><span class="ident" id="3824091">clientKey</span><span class="op" id="3824100">,</span>&nbsp;<span class="ident" id="3824102">clientIV</span><span class="op" id="3824110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824114">serverCipher</span>&nbsp;<span class="op" id="3824127">=</span>&nbsp;<span class="ident" id="3824129">hs</span><span class="op" id="3824131">.</span><span class="ident" id="3824132">suite</span><span class="op" id="3824137">.</span><span class="ident" id="3824138">aead</span><span class="op" id="3824142">(</span><span class="ident" id="3824143">serverKey</span><span class="op" id="3824152">,</span>&nbsp;<span class="ident" id="3824154">serverIV</span><span class="op" id="3824162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3824165">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824169">c</span><span class="op" id="3824170">.</span><span class="ident" id="3824171">in</span><span class="op" id="3824173">.</span><span class="ident" id="3824174">prepareCipherSpec</span><span class="op" id="3824191">(</span><span class="ident" id="3824192">c</span><span class="op" id="3824193">.</span><span class="ident" id="3824194">vers</span><span class="op" id="3824198">,</span>&nbsp;<span class="ident" id="3824200">serverCipher</span><span class="op" id="3824212">,</span>&nbsp;<span class="ident" id="3824214">serverHash</span><span class="op" id="3824224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824227">c</span><span class="op" id="3824228">.</span><span class="ident" id="3824229">out</span><span class="op" id="3824232">.</span><span class="ident" id="3824233">prepareCipherSpec</span><span class="op" id="3824250">(</span><span class="ident" id="3824251">c</span><span class="op" id="3824252">.</span><span class="ident" id="3824253">vers</span><span class="op" id="3824257">,</span>&nbsp;<span class="ident" id="3824259">clientCipher</span><span class="op" id="3824271">,</span>&nbsp;<span class="ident" id="3824273">clientHash</span><span class="op" id="3824283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3824286">return</span>&nbsp;<span class="ident" id="3824293">nil</span><br>
<span class="lineno"></span><span class="op" id="3824297">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="3824300">func</span>&nbsp;<span class="op" id="3824305">(</span><span class="ident" id="3824306">hs</span>&nbsp;<span class="op" id="3824309">*</span><span class="ident" id="3824310">clientHandshakeState</span><span class="op" id="3824330">)</span>&nbsp;<span class="ident" id="3824332">serverResumedSession</span><span class="op" id="3824352">(</span><span class="op" id="3824353">)</span>&nbsp;<span class="builtintype" id="3824355">bool</span>&nbsp;<span class="op" id="3824360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3824363">//&nbsp;If&nbsp;the&nbsp;server&nbsp;responded&nbsp;with&nbsp;the&nbsp;same&nbsp;sessionId&nbsp;then&nbsp;it&nbsp;means&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3824433">//&nbsp;sessionTicket&nbsp;is&nbsp;being&nbsp;used&nbsp;to&nbsp;resume&nbsp;a&nbsp;TLS&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3824490">return</span>&nbsp;<span class="ident" id="3824497">hs</span><span class="op" id="3824499">.</span><span class="ident" id="3824500">session</span>&nbsp;<span class="op" id="3824508">!=</span>&nbsp;<span class="ident" id="3824511">nil</span>&nbsp;<span class="op" id="3824515">&amp;&amp;</span>&nbsp;<span class="ident" id="3824518">hs</span><span class="op" id="3824520">.</span><span class="ident" id="3824521">hello</span><span class="op" id="3824526">.</span><span class="ident" id="3824527">sessionId</span>&nbsp;<span class="op" id="3824537">!=</span>&nbsp;<span class="ident" id="3824540">nil</span>&nbsp;<span class="op" id="3824544">&amp;&amp;</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824549">bytes</span><span class="op" id="3824554">.</span><span class="ident" id="3824555">Equal</span><span class="op" id="3824560">(</span><span class="ident" id="3824561">hs</span><span class="op" id="3824563">.</span><span class="ident" id="3824564">serverHello</span><span class="op" id="3824575">.</span><span class="ident" id="3824576">sessionId</span><span class="op" id="3824585">,</span>&nbsp;<span class="ident" id="3824587">hs</span><span class="op" id="3824589">.</span><span class="ident" id="3824590">hello</span><span class="op" id="3824595">.</span><span class="ident" id="3824596">sessionId</span><span class="op" id="3824605">)</span><br>
<span class="lineno"></span><span class="op" id="3824607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3824610">func</span>&nbsp;<span class="op" id="3824615">(</span><span class="ident" id="3824616">hs</span>&nbsp;<span class="op" id="3824619">*</span><span class="ident" id="3824620">clientHandshakeState</span><span class="op" id="3824640">)</span>&nbsp;<span class="ident" id="3824642">processServerHello</span><span class="op" id="3824660">(</span><span class="op" id="3824661">)</span>&nbsp;<span class="op" id="3824663">(</span><span class="builtintype" id="3824664">bool</span><span class="op" id="3824668">,</span>&nbsp;<span class="builtintype" id="3824670">error</span><span class="op" id="3824675">)</span>&nbsp;<span class="op" id="3824677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824680">c</span>&nbsp;<span class="op" id="3824682">:=</span>&nbsp;<span class="ident" id="3824685">hs</span><span class="op" id="3824687">.</span><span class="ident" id="3824688">c</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3824692">if</span>&nbsp;<span class="ident" id="3824695">hs</span><span class="op" id="3824697">.</span><span class="ident" id="3824698">serverHello</span><span class="op" id="3824709">.</span><span class="ident" id="3824710">compressionMethod</span>&nbsp;<span class="op" id="3824728">!=</span>&nbsp;<span class="ident" id="3824731">compressionNone</span>&nbsp;<span class="op" id="3824747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824751">c</span><span class="op" id="3824752">.</span><span class="ident" id="3824753">sendAlert</span><span class="op" id="3824762">(</span><span class="ident" id="3824763">alertUnexpectedMessage</span><span class="op" id="3824785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3824789">return</span>&nbsp;<span class="builtintype" id="3824796">false</span><span class="op" id="3824801">,</span>&nbsp;<span class="ident" id="3824803">errors</span><span class="op" id="3824809">.</span><span class="ident" id="3824810">New</span><span class="op" id="3824813">(</span><span class="string" id="3824814">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;compression&nbsp;format&#34;</span><span class="op" id="3824867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3824870">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824874">clientDidNPN</span>&nbsp;<span class="op" id="3824887">:=</span>&nbsp;<span class="ident" id="3824890">hs</span><span class="op" id="3824892">.</span><span class="ident" id="3824893">hello</span><span class="op" id="3824898">.</span><span class="ident" id="3824899">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824913">clientDidALPN</span>&nbsp;<span class="op" id="3824927">:=</span>&nbsp;<span class="builtinfunc" id="3824930">len</span><span class="op" id="3824933">(</span><span class="ident" id="3824934">hs</span><span class="op" id="3824936">.</span><span class="ident" id="3824937">hello</span><span class="op" id="3824942">.</span><span class="ident" id="3824943">alpnProtocols</span><span class="op" id="3824956">)</span>&nbsp;<span class="op" id="3824958">&gt;</span>&nbsp;<span class="num" id="3824960">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824963">serverHasNPN</span>&nbsp;<span class="op" id="3824976">:=</span>&nbsp;<span class="ident" id="3824979">hs</span><span class="op" id="3824981">.</span><span class="ident" id="3824982">serverHello</span><span class="op" id="3824993">.</span><span class="ident" id="3824994">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825008">serverHasALPN</span>&nbsp;<span class="op" id="3825022">:=</span>&nbsp;<span class="builtinfunc" id="3825025">len</span><span class="op" id="3825028">(</span><span class="ident" id="3825029">hs</span><span class="op" id="3825031">.</span><span class="ident" id="3825032">serverHello</span><span class="op" id="3825043">.</span><span class="ident" id="3825044">alpnProtocol</span><span class="op" id="3825056">)</span>&nbsp;<span class="op" id="3825058">&gt;</span>&nbsp;<span class="num" id="3825060">0</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825064">if</span>&nbsp;<span class="op" id="3825067">!</span><span class="ident" id="3825068">clientDidNPN</span>&nbsp;<span class="op" id="3825081">&amp;&amp;</span>&nbsp;<span class="ident" id="3825084">serverHasNPN</span>&nbsp;<span class="op" id="3825097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825101">c</span><span class="op" id="3825102">.</span><span class="ident" id="3825103">sendAlert</span><span class="op" id="3825112">(</span><span class="ident" id="3825113">alertHandshakeFailure</span><span class="op" id="3825134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825138">return</span>&nbsp;<span class="builtintype" id="3825145">false</span><span class="op" id="3825150">,</span>&nbsp;<span class="ident" id="3825152">errors</span><span class="op" id="3825158">.</span><span class="ident" id="3825159">New</span><span class="op" id="3825162">(</span><span class="string" id="3825163">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;NPN&nbsp;extension&#34;</span><span class="op" id="3825208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3825211">}</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825215">if</span>&nbsp;<span class="op" id="3825218">!</span><span class="ident" id="3825219">clientDidALPN</span>&nbsp;<span class="op" id="3825233">&amp;&amp;</span>&nbsp;<span class="ident" id="3825236">serverHasALPN</span>&nbsp;<span class="op" id="3825250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825254">c</span><span class="op" id="3825255">.</span><span class="ident" id="3825256">sendAlert</span><span class="op" id="3825265">(</span><span class="ident" id="3825266">alertHandshakeFailure</span><span class="op" id="3825287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825291">return</span>&nbsp;<span class="builtintype" id="3825298">false</span><span class="op" id="3825303">,</span>&nbsp;<span class="ident" id="3825305">errors</span><span class="op" id="3825311">.</span><span class="ident" id="3825312">New</span><span class="op" id="3825315">(</span><span class="string" id="3825316">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;ALPN&nbsp;extension&#34;</span><span class="op" id="3825362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3825365">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825369">if</span>&nbsp;<span class="ident" id="3825372">serverHasNPN</span>&nbsp;<span class="op" id="3825385">&amp;&amp;</span>&nbsp;<span class="ident" id="3825388">serverHasALPN</span>&nbsp;<span class="op" id="3825402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825406">c</span><span class="op" id="3825407">.</span><span class="ident" id="3825408">sendAlert</span><span class="op" id="3825417">(</span><span class="ident" id="3825418">alertHandshakeFailure</span><span class="op" id="3825439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825443">return</span>&nbsp;<span class="builtintype" id="3825450">false</span><span class="op" id="3825455">,</span>&nbsp;<span class="ident" id="3825457">errors</span><span class="op" id="3825463">.</span><span class="ident" id="3825464">New</span><span class="op" id="3825467">(</span><span class="string" id="3825468">&#34;server&nbsp;advertised&nbsp;both&nbsp;NPN&nbsp;and&nbsp;ALPN&nbsp;extensions&#34;</span><span class="op" id="3825516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3825519">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825523">if</span>&nbsp;<span class="ident" id="3825526">serverHasALPN</span>&nbsp;<span class="op" id="3825540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825544">c</span><span class="op" id="3825545">.</span><span class="ident" id="3825546">clientProtocol</span>&nbsp;<span class="op" id="3825561">=</span>&nbsp;<span class="ident" id="3825563">hs</span><span class="op" id="3825565">.</span><span class="ident" id="3825566">serverHello</span><span class="op" id="3825577">.</span><span class="ident" id="3825578">alpnProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825593">c</span><span class="op" id="3825594">.</span><span class="ident" id="3825595">clientProtocolFallback</span>&nbsp;<span class="op" id="3825618">=</span>&nbsp;<span class="builtintype" id="3825620">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3825627">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825631">if</span>&nbsp;<span class="ident" id="3825634">hs</span><span class="op" id="3825636">.</span><span class="ident" id="3825637">serverResumedSession</span><span class="op" id="3825657">(</span><span class="op" id="3825658">)</span>&nbsp;<span class="op" id="3825660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3825664">//&nbsp;Restore&nbsp;masterSecret&nbsp;and&nbsp;peerCerts&nbsp;from&nbsp;previous&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825724">hs</span><span class="op" id="3825726">.</span><span class="ident" id="3825727">masterSecret</span>&nbsp;<span class="op" id="3825740">=</span>&nbsp;<span class="ident" id="3825742">hs</span><span class="op" id="3825744">.</span><span class="ident" id="3825745">session</span><span class="op" id="3825752">.</span><span class="ident" id="3825753">masterSecret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825768">c</span><span class="op" id="3825769">.</span><span class="ident" id="3825770">peerCertificates</span>&nbsp;<span class="op" id="3825787">=</span>&nbsp;<span class="ident" id="3825789">hs</span><span class="op" id="3825791">.</span><span class="ident" id="3825792">session</span><span class="op" id="3825799">.</span><span class="ident" id="3825800">serverCertificates</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825821">return</span>&nbsp;<span class="builtintype" id="3825828">true</span><span class="op" id="3825832">,</span>&nbsp;<span class="ident" id="3825834">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3825839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825842">return</span>&nbsp;<span class="builtintype" id="3825849">false</span><span class="op" id="3825854">,</span>&nbsp;<span class="ident" id="3825856">nil</span><br>
<span class="lineno"></span><span class="op" id="3825860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="3825863">func</span>&nbsp;<span class="op" id="3825868">(</span><span class="ident" id="3825869">hs</span>&nbsp;<span class="op" id="3825872">*</span><span class="ident" id="3825873">clientHandshakeState</span><span class="op" id="3825893">)</span>&nbsp;<span class="ident" id="3825895">readFinished</span><span class="op" id="3825907">(</span><span class="ident" id="3825908">out</span>&nbsp;<span class="op" id="3825912">[</span><span class="op" id="3825913">]</span><span class="builtintype" id="3825914">byte</span><span class="op" id="3825918">)</span>&nbsp;<span class="builtintype" id="3825920">error</span>&nbsp;<span class="op" id="3825926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825929">c</span>&nbsp;<span class="op" id="3825931">:=</span>&nbsp;<span class="ident" id="3825934">hs</span><span class="op" id="3825936">.</span><span class="ident" id="3825937">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825941">c</span><span class="op" id="3825942">.</span><span class="ident" id="3825943">readRecord</span><span class="op" id="3825953">(</span><span class="ident" id="3825954">recordTypeChangeCipherSpec</span><span class="op" id="3825980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825983">if</span>&nbsp;<span class="ident" id="3825986">err</span>&nbsp;<span class="op" id="3825990">:=</span>&nbsp;<span class="ident" id="3825993">c</span><span class="op" id="3825994">.</span><span class="ident" id="3825995">in</span><span class="op" id="3825997">.</span><span class="builtintype" id="3825998">error</span><span class="op" id="3826003">(</span><span class="op" id="3826004">)</span><span class="op" id="3826005">;</span>&nbsp;<span class="ident" id="3826007">err</span>&nbsp;<span class="op" id="3826011">!=</span>&nbsp;<span class="ident" id="3826014">nil</span>&nbsp;<span class="op" id="3826018">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826022">return</span>&nbsp;<span class="ident" id="3826029">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3826034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826038">msg</span><span class="op" id="3826041">,</span>&nbsp;<span class="ident" id="3826043">err</span>&nbsp;<span class="op" id="3826047">:=</span>&nbsp;<span class="ident" id="3826050">c</span><span class="op" id="3826051">.</span><span class="ident" id="3826052">readHandshake</span><span class="op" id="3826065">(</span><span class="op" id="3826066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826069">if</span>&nbsp;<span class="ident" id="3826072">err</span>&nbsp;<span class="op" id="3826076">!=</span>&nbsp;<span class="ident" id="3826079">nil</span>&nbsp;<span class="op" id="3826083">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826087">return</span>&nbsp;<span class="ident" id="3826094">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3826099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826102">serverFinished</span><span class="op" id="3826116">,</span>&nbsp;<span class="ident" id="3826118">ok</span>&nbsp;<span class="op" id="3826121">:=</span>&nbsp;<span class="ident" id="3826124">msg</span><span class="op" id="3826127">.</span><span class="op" id="3826128">(</span><span class="op" id="3826129">*</span><span class="ident" id="3826130">finishedMsg</span><span class="op" id="3826141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826144">if</span>&nbsp;<span class="op" id="3826147">!</span><span class="ident" id="3826148">ok</span>&nbsp;<span class="op" id="3826151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826155">c</span><span class="op" id="3826156">.</span><span class="ident" id="3826157">sendAlert</span><span class="op" id="3826166">(</span><span class="ident" id="3826167">alertUnexpectedMessage</span><span class="op" id="3826189">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826193">return</span>&nbsp;<span class="ident" id="3826200">unexpectedMessageError</span><span class="op" id="3826222">(</span><span class="ident" id="3826223">serverFinished</span><span class="op" id="3826237">,</span>&nbsp;<span class="ident" id="3826239">msg</span><span class="op" id="3826242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3826245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826249">verify</span>&nbsp;<span class="op" id="3826256">:=</span>&nbsp;<span class="ident" id="3826259">hs</span><span class="op" id="3826261">.</span><span class="ident" id="3826262">finishedHash</span><span class="op" id="3826274">.</span><span class="ident" id="3826275">serverSum</span><span class="op" id="3826284">(</span><span class="ident" id="3826285">hs</span><span class="op" id="3826287">.</span><span class="ident" id="3826288">masterSecret</span><span class="op" id="3826300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826303">if</span>&nbsp;<span class="builtinfunc" id="3826306">len</span><span class="op" id="3826309">(</span><span class="ident" id="3826310">verify</span><span class="op" id="3826316">)</span>&nbsp;<span class="op" id="3826318">!=</span>&nbsp;<span class="builtinfunc" id="3826321">len</span><span class="op" id="3826324">(</span><span class="ident" id="3826325">serverFinished</span><span class="op" id="3826339">.</span><span class="ident" id="3826340">verifyData</span><span class="op" id="3826350">)</span>&nbsp;<span class="op" id="3826352">||</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826357">subtle</span><span class="op" id="3826363">.</span><span class="ident" id="3826364">ConstantTimeCompare</span><span class="op" id="3826383">(</span><span class="ident" id="3826384">verify</span><span class="op" id="3826390">,</span>&nbsp;<span class="ident" id="3826392">serverFinished</span><span class="op" id="3826406">.</span><span class="ident" id="3826407">verifyData</span><span class="op" id="3826417">)</span>&nbsp;<span class="op" id="3826419">!=</span>&nbsp;<span class="num" id="3826422">1</span>&nbsp;<span class="op" id="3826424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826428">c</span><span class="op" id="3826429">.</span><span class="ident" id="3826430">sendAlert</span><span class="op" id="3826439">(</span><span class="ident" id="3826440">alertHandshakeFailure</span><span class="op" id="3826461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826465">return</span>&nbsp;<span class="ident" id="3826472">errors</span><span class="op" id="3826478">.</span><span class="ident" id="3826479">New</span><span class="op" id="3826482">(</span><span class="string" id="3826483">&#34;tls:&nbsp;server&#39;s&nbsp;Finished&nbsp;message&nbsp;was&nbsp;incorrect&#34;</span><span class="op" id="3826529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3826532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826535">hs</span><span class="op" id="3826537">.</span><span class="ident" id="3826538">finishedHash</span><span class="op" id="3826550">.</span><span class="ident" id="3826551">Write</span><span class="op" id="3826556">(</span><span class="ident" id="3826557">serverFinished</span><span class="op" id="3826571">.</span><span class="ident" id="3826572">marshal</span><span class="op" id="3826579">(</span><span class="op" id="3826580">)</span><span class="op" id="3826581">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3826584">copy</span><span class="op" id="3826588">(</span><span class="ident" id="3826589">out</span><span class="op" id="3826592">,</span>&nbsp;<span class="ident" id="3826594">verify</span><span class="op" id="3826600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826603">return</span>&nbsp;<span class="ident" id="3826610">nil</span><br>
<span class="lineno"></span><span class="op" id="3826614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3826617">func</span>&nbsp;<span class="op" id="3826622">(</span><span class="ident" id="3826623">hs</span>&nbsp;<span class="op" id="3826626">*</span><span class="ident" id="3826627">clientHandshakeState</span><span class="op" id="3826647">)</span>&nbsp;<span class="ident" id="3826649">readSessionTicket</span><span class="op" id="3826666">(</span><span class="op" id="3826667">)</span>&nbsp;<span class="builtintype" id="3826669">error</span>&nbsp;<span class="op" id="3826675">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826678">if</span>&nbsp;<span class="op" id="3826681">!</span><span class="ident" id="3826682">hs</span><span class="op" id="3826684">.</span><span class="ident" id="3826685">serverHello</span><span class="op" id="3826696">.</span><span class="ident" id="3826697">ticketSupported</span>&nbsp;<span class="op" id="3826713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826717">return</span>&nbsp;<span class="ident" id="3826724">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3826729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826733">c</span>&nbsp;<span class="op" id="3826735">:=</span>&nbsp;<span class="ident" id="3826738">hs</span><span class="op" id="3826740">.</span><span class="ident" id="3826741">c</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826744">msg</span><span class="op" id="3826747">,</span>&nbsp;<span class="ident" id="3826749">err</span>&nbsp;<span class="op" id="3826753">:=</span>&nbsp;<span class="ident" id="3826756">c</span><span class="op" id="3826757">.</span><span class="ident" id="3826758">readHandshake</span><span class="op" id="3826771">(</span><span class="op" id="3826772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826775">if</span>&nbsp;<span class="ident" id="3826778">err</span>&nbsp;<span class="op" id="3826782">!=</span>&nbsp;<span class="ident" id="3826785">nil</span>&nbsp;<span class="op" id="3826789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826793">return</span>&nbsp;<span class="ident" id="3826800">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3826805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826808">sessionTicketMsg</span><span class="op" id="3826824">,</span>&nbsp;<span class="ident" id="3826826">ok</span>&nbsp;<span class="op" id="3826829">:=</span>&nbsp;<span class="ident" id="3826832">msg</span><span class="op" id="3826835">.</span><span class="op" id="3826836">(</span><span class="op" id="3826837">*</span><span class="ident" id="3826838">newSessionTicketMsg</span><span class="op" id="3826857">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826860">if</span>&nbsp;<span class="op" id="3826863">!</span><span class="ident" id="3826864">ok</span>&nbsp;<span class="op" id="3826867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826871">c</span><span class="op" id="3826872">.</span><span class="ident" id="3826873">sendAlert</span><span class="op" id="3826882">(</span><span class="ident" id="3826883">alertUnexpectedMessage</span><span class="op" id="3826905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826909">return</span>&nbsp;<span class="ident" id="3826916">unexpectedMessageError</span><span class="op" id="3826938">(</span><span class="ident" id="3826939">sessionTicketMsg</span><span class="op" id="3826955">,</span>&nbsp;<span class="ident" id="3826957">msg</span><span class="op" id="3826960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3826963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826966">hs</span><span class="op" id="3826968">.</span><span class="ident" id="3826969">finishedHash</span><span class="op" id="3826981">.</span><span class="ident" id="3826982">Write</span><span class="op" id="3826987">(</span><span class="ident" id="3826988">sessionTicketMsg</span><span class="op" id="3827004">.</span><span class="ident" id="3827005">marshal</span><span class="op" id="3827012">(</span><span class="op" id="3827013">)</span><span class="op" id="3827014">)</span><br>
<span class="lineno">580</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827018">hs</span><span class="op" id="3827020">.</span><span class="ident" id="3827021">session</span>&nbsp;<span class="op" id="3827029">=</span>&nbsp;<span class="op" id="3827031">&amp;</span><span class="ident" id="3827032">ClientSessionState</span><span class="op" id="3827050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827054">sessionTicket</span><span class="op" id="3827067">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827074">sessionTicketMsg</span><span class="op" id="3827090">.</span><span class="ident" id="3827091">ticket</span><span class="op" id="3827097">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827101">vers</span><span class="op" id="3827105">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827121">c</span><span class="op" id="3827122">.</span><span class="ident" id="3827123">vers</span><span class="op" id="3827127">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827131">cipherSuite</span><span class="op" id="3827142">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827151">hs</span><span class="op" id="3827153">.</span><span class="ident" id="3827154">suite</span><span class="op" id="3827159">.</span><span class="ident" id="3827160">id</span><span class="op" id="3827162">,</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827166">masterSecret</span><span class="op" id="3827178">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827186">hs</span><span class="op" id="3827188">.</span><span class="ident" id="3827189">masterSecret</span><span class="op" id="3827201">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827205">serverCertificates</span><span class="op" id="3827223">:</span>&nbsp;<span class="ident" id="3827225">c</span><span class="op" id="3827226">.</span><span class="ident" id="3827227">peerCertificates</span><span class="op" id="3827243">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3827246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827250">return</span>&nbsp;<span class="ident" id="3827257">nil</span><br>
<span class="lineno">590</span><span class="op" id="3827261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3827264">func</span>&nbsp;<span class="op" id="3827269">(</span><span class="ident" id="3827270">hs</span>&nbsp;<span class="op" id="3827273">*</span><span class="ident" id="3827274">clientHandshakeState</span><span class="op" id="3827294">)</span>&nbsp;<span class="ident" id="3827296">sendFinished</span><span class="op" id="3827308">(</span><span class="ident" id="3827309">out</span>&nbsp;<span class="op" id="3827313">[</span><span class="op" id="3827314">]</span><span class="builtintype" id="3827315">byte</span><span class="op" id="3827319">)</span>&nbsp;<span class="builtintype" id="3827321">error</span>&nbsp;<span class="op" id="3827327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827330">c</span>&nbsp;<span class="op" id="3827332">:=</span>&nbsp;<span class="ident" id="3827335">hs</span><span class="op" id="3827337">.</span><span class="ident" id="3827338">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827342">c</span><span class="op" id="3827343">.</span><span class="ident" id="3827344">writeRecord</span><span class="op" id="3827355">(</span><span class="ident" id="3827356">recordTypeChangeCipherSpec</span><span class="op" id="3827382">,</span>&nbsp;<span class="op" id="3827384">[</span><span class="op" id="3827385">]</span><span class="builtintype" id="3827386">byte</span><span class="op" id="3827390">{</span><span class="num" id="3827391">1</span><span class="op" id="3827392">}</span><span class="op" id="3827393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827396">if</span>&nbsp;<span class="ident" id="3827399">hs</span><span class="op" id="3827401">.</span><span class="ident" id="3827402">serverHello</span><span class="op" id="3827413">.</span><span class="ident" id="3827414">nextProtoNeg</span>&nbsp;<span class="op" id="3827427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827431">nextProto</span>&nbsp;<span class="op" id="3827441">:=</span>&nbsp;<span class="builtinfunc" id="3827444">new</span><span class="op" id="3827447">(</span><span class="ident" id="3827448">nextProtoMsg</span><span class="op" id="3827460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827464">proto</span><span class="op" id="3827469">,</span>&nbsp;<span class="ident" id="3827471">fallback</span>&nbsp;<span class="op" id="3827480">:=</span>&nbsp;<span class="ident" id="3827483">mutualProtocol</span><span class="op" id="3827497">(</span><span class="ident" id="3827498">c</span><span class="op" id="3827499">.</span><span class="ident" id="3827500">config</span><span class="op" id="3827506">.</span><span class="ident" id="3827507">NextProtos</span><span class="op" id="3827517">,</span>&nbsp;<span class="ident" id="3827519">hs</span><span class="op" id="3827521">.</span><span class="ident" id="3827522">serverHello</span><span class="op" id="3827533">.</span><span class="ident" id="3827534">nextProtos</span><span class="op" id="3827544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827548">nextProto</span><span class="op" id="3827557">.</span><span class="ident" id="3827558">proto</span>&nbsp;<span class="op" id="3827564">=</span>&nbsp;<span class="ident" id="3827566">proto</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827574">c</span><span class="op" id="3827575">.</span><span class="ident" id="3827576">clientProtocol</span>&nbsp;<span class="op" id="3827591">=</span>&nbsp;<span class="ident" id="3827593">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827601">c</span><span class="op" id="3827602">.</span><span class="ident" id="3827603">clientProtocolFallback</span>&nbsp;<span class="op" id="3827626">=</span>&nbsp;<span class="ident" id="3827628">fallback</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827640">hs</span><span class="op" id="3827642">.</span><span class="ident" id="3827643">finishedHash</span><span class="op" id="3827655">.</span><span class="ident" id="3827656">Write</span><span class="op" id="3827661">(</span><span class="ident" id="3827662">nextProto</span><span class="op" id="3827671">.</span><span class="ident" id="3827672">marshal</span><span class="op" id="3827679">(</span><span class="op" id="3827680">)</span><span class="op" id="3827681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827685">c</span><span class="op" id="3827686">.</span><span class="ident" id="3827687">writeRecord</span><span class="op" id="3827698">(</span><span class="ident" id="3827699">recordTypeHandshake</span><span class="op" id="3827718">,</span>&nbsp;<span class="ident" id="3827720">nextProto</span><span class="op" id="3827729">.</span><span class="ident" id="3827730">marshal</span><span class="op" id="3827737">(</span><span class="op" id="3827738">)</span><span class="op" id="3827739">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3827742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827746">finished</span>&nbsp;<span class="op" id="3827755">:=</span>&nbsp;<span class="builtinfunc" id="3827758">new</span><span class="op" id="3827761">(</span><span class="ident" id="3827762">finishedMsg</span><span class="op" id="3827773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827776">finished</span><span class="op" id="3827784">.</span><span class="ident" id="3827785">verifyData</span>&nbsp;<span class="op" id="3827796">=</span>&nbsp;<span class="ident" id="3827798">hs</span><span class="op" id="3827800">.</span><span class="ident" id="3827801">finishedHash</span><span class="op" id="3827813">.</span><span class="ident" id="3827814">clientSum</span><span class="op" id="3827823">(</span><span class="ident" id="3827824">hs</span><span class="op" id="3827826">.</span><span class="ident" id="3827827">masterSecret</span><span class="op" id="3827839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827842">hs</span><span class="op" id="3827844">.</span><span class="ident" id="3827845">finishedHash</span><span class="op" id="3827857">.</span><span class="ident" id="3827858">Write</span><span class="op" id="3827863">(</span><span class="ident" id="3827864">finished</span><span class="op" id="3827872">.</span><span class="ident" id="3827873">marshal</span><span class="op" id="3827880">(</span><span class="op" id="3827881">)</span><span class="op" id="3827882">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827885">c</span><span class="op" id="3827886">.</span><span class="ident" id="3827887">writeRecord</span><span class="op" id="3827898">(</span><span class="ident" id="3827899">recordTypeHandshake</span><span class="op" id="3827918">,</span>&nbsp;<span class="ident" id="3827920">finished</span><span class="op" id="3827928">.</span><span class="ident" id="3827929">marshal</span><span class="op" id="3827936">(</span><span class="op" id="3827937">)</span><span class="op" id="3827938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3827941">copy</span><span class="op" id="3827945">(</span><span class="ident" id="3827946">out</span><span class="op" id="3827949">,</span>&nbsp;<span class="ident" id="3827951">finished</span><span class="op" id="3827959">.</span><span class="ident" id="3827960">verifyData</span><span class="op" id="3827970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827973">return</span>&nbsp;<span class="ident" id="3827980">nil</span><br>
<span class="lineno"></span><span class="op" id="3827984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="comment" id="3827987">//&nbsp;clientSessionCacheKey&nbsp;returns&nbsp;a&nbsp;key&nbsp;used&nbsp;to&nbsp;cache&nbsp;sessionTickets&nbsp;that&nbsp;could</span><br>
<span class="lineno"></span><span class="comment" id="3828066">//&nbsp;be&nbsp;used&nbsp;to&nbsp;resume&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;sessions&nbsp;with&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="3828137">func</span>&nbsp;<span class="ident" id="3828142">clientSessionCacheKey</span><span class="op" id="3828163">(</span><span class="ident" id="3828164">serverAddr</span>&nbsp;<span class="ident" id="3828175">net</span><span class="op" id="3828178">.</span><span class="ident" id="3828179">Addr</span><span class="op" id="3828183">,</span>&nbsp;<span class="ident" id="3828185">config</span>&nbsp;<span class="op" id="3828192">*</span><span class="ident" id="3828193">Config</span><span class="op" id="3828199">)</span>&nbsp;<span class="builtintype" id="3828201">string</span>&nbsp;<span class="op" id="3828208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828211">if</span>&nbsp;<span class="builtinfunc" id="3828214">len</span><span class="op" id="3828217">(</span><span class="ident" id="3828218">config</span><span class="op" id="3828224">.</span><span class="ident" id="3828225">ServerName</span><span class="op" id="3828235">)</span>&nbsp;<span class="op" id="3828237">&gt;</span>&nbsp;<span class="num" id="3828239">0</span>&nbsp;<span class="op" id="3828241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828245">return</span>&nbsp;<span class="ident" id="3828252">config</span><span class="op" id="3828258">.</span><span class="ident" id="3828259">ServerName</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3828271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828274">return</span>&nbsp;<span class="ident" id="3828281">serverAddr</span><span class="op" id="3828291">.</span><span class="ident" id="3828292">String</span><span class="op" id="3828298">(</span><span class="op" id="3828299">)</span><br>
<span class="lineno"></span><span class="op" id="3828301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3828304">//&nbsp;mutualProtocol&nbsp;finds&nbsp;the&nbsp;mutual&nbsp;Next&nbsp;Protocol&nbsp;Negotiation&nbsp;or&nbsp;ALPN&nbsp;protocol</span><br>
<span class="lineno">625</span><span class="comment" id="3828382">//&nbsp;given&nbsp;list&nbsp;of&nbsp;possible&nbsp;protocols&nbsp;and&nbsp;a&nbsp;list&nbsp;of&nbsp;the&nbsp;preference&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="3828458">//&nbsp;first&nbsp;list&nbsp;must&nbsp;not&nbsp;be&nbsp;empty.&nbsp;It&nbsp;returns&nbsp;the&nbsp;resulting&nbsp;protocol&nbsp;and&nbsp;flag</span><br>
<span class="lineno"></span><span class="comment" id="3828534">//&nbsp;indicating&nbsp;if&nbsp;the&nbsp;fallback&nbsp;case&nbsp;was&nbsp;reached.</span><br>
<span class="lineno"></span><span class="keyword" id="3828582">func</span>&nbsp;<span class="ident" id="3828587">mutualProtocol</span><span class="op" id="3828601">(</span><span class="ident" id="3828602">protos</span><span class="op" id="3828608">,</span>&nbsp;<span class="ident" id="3828610">preferenceProtos</span>&nbsp;<span class="op" id="3828627">[</span><span class="op" id="3828628">]</span><span class="builtintype" id="3828629">string</span><span class="op" id="3828635">)</span>&nbsp;<span class="op" id="3828637">(</span><span class="builtintype" id="3828638">string</span><span class="op" id="3828644">,</span>&nbsp;<span class="builtintype" id="3828646">bool</span><span class="op" id="3828650">)</span>&nbsp;<span class="op" id="3828652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828655">for</span>&nbsp;<span class="ident" id="3828659">_</span><span class="op" id="3828660">,</span>&nbsp;<span class="ident" id="3828662">s</span>&nbsp;<span class="op" id="3828664">:=</span>&nbsp;<span class="keyword" id="3828667">range</span>&nbsp;<span class="ident" id="3828673">preferenceProtos</span>&nbsp;<span class="op" id="3828690">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828694">for</span>&nbsp;<span class="ident" id="3828698">_</span><span class="op" id="3828699">,</span>&nbsp;<span class="ident" id="3828701">c</span>&nbsp;<span class="op" id="3828703">:=</span>&nbsp;<span class="keyword" id="3828706">range</span>&nbsp;<span class="ident" id="3828712">protos</span>&nbsp;<span class="op" id="3828719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828724">if</span>&nbsp;<span class="ident" id="3828727">s</span>&nbsp;<span class="op" id="3828729">==</span>&nbsp;<span class="ident" id="3828732">c</span>&nbsp;<span class="op" id="3828734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828740">return</span>&nbsp;<span class="ident" id="3828747">s</span><span class="op" id="3828748">,</span>&nbsp;<span class="builtintype" id="3828750">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3828759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3828763">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3828766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828770">return</span>&nbsp;<span class="ident" id="3828777">protos</span><span class="op" id="3828783">[</span><span class="num" id="3828784">0</span><span class="op" id="3828785">]</span><span class="op" id="3828786">,</span>&nbsp;<span class="builtintype" id="3828788">true</span><br>
<span class="lineno"></span><span class="op" id="3828793">}</span>
</div>
</body>
</html>
