<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>html/template</h2>
<ul>
<li><a href="/gostd/html/template/attr.go.html">attr.go</a></li>
<li><a href="/gostd/html/template/clone_test.go.html">clone_test.go</a></li>
<li><a href="/gostd/html/template/content.go.html">content.go</a></li>
<li><a href="/gostd/html/template/content_test.go.html">content_test.go</a></li>
<li><a href="/gostd/html/template/context.go.html">context.go</a></li>
<li><a href="/gostd/html/template/css.go.html">css.go</a></li>
<li><a href="/gostd/html/template/css_test.go.html">css_test.go</a></li>
<li><a href="/gostd/html/template/doc.go.html">doc.go</a></li>
<li><a href="/gostd/html/template/error.go.html">error.go</a></li>
<li><a href="/gostd/html/template/escape.go.html">escape.go</a></li>
<li><a href="/gostd/html/template/escape_test.go.html">escape_test.go</a></li>
<li><a href="/gostd/html/template/html.go.html">html.go</a></li>
<li><a href="/gostd/html/template/html_test.go.html">html_test.go</a></li>
<li><a href="/gostd/html/template/js.go.html">js.go</a></li>
<li><a href="/gostd/html/template/js_test.go.html">js_test.go</a></li>
<li><a href="/gostd/html/template/template.go.html">template.go</a></li>
<li><a href="/gostd/html/template/transition.go.html">transition.go</a></li>
<li><a href="/gostd/html/template/url.go.html">url.go</a></li>
<li><a href="/gostd/html/template/url_test.go.html">url_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2862483">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2862538">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2862592">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2862643">package</span>&nbsp;<span class="ident" id="2862651">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2862661">import</span>&nbsp;<span class="op" id="2862668">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2862671">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2862680">&#34;encoding/json&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2862697">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2862704">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2862715">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2862726">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="2862741">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="2862744">//&nbsp;nextJSCtx&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;determines&nbsp;whether&nbsp;a&nbsp;slash&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2862819">//&nbsp;given&nbsp;run&nbsp;of&nbsp;tokens&nbsp;starts&nbsp;a&nbsp;regular&nbsp;expression&nbsp;instead&nbsp;of&nbsp;a&nbsp;division</span><br>
<span class="lineno"></span><span class="comment" id="2862892">//&nbsp;operator:&nbsp;/&nbsp;or&nbsp;/=.</span><br>
<span class="lineno"></span><span class="comment" id="2862914">//</span><br>
<span class="lineno">20</span><span class="comment" id="2862917">//&nbsp;This&nbsp;assumes&nbsp;that&nbsp;the&nbsp;token&nbsp;run&nbsp;does&nbsp;not&nbsp;include&nbsp;any&nbsp;string&nbsp;tokens,&nbsp;comment</span><br>
<span class="lineno"></span><span class="comment" id="2862996">//&nbsp;tokens,&nbsp;regular&nbsp;expression&nbsp;literal&nbsp;tokens,&nbsp;or&nbsp;division&nbsp;operators.</span><br>
<span class="lineno"></span><span class="comment" id="2863065">//</span><br>
<span class="lineno"></span><span class="comment" id="2863068">//&nbsp;This&nbsp;fails&nbsp;on&nbsp;some&nbsp;valid&nbsp;but&nbsp;nonsensical&nbsp;JavaScript&nbsp;programs&nbsp;like</span><br>
<span class="lineno"></span><span class="comment" id="2863137">//&nbsp;&#34;x&nbsp;=&nbsp;++/foo/i&#34;&nbsp;which&nbsp;is&nbsp;quite&nbsp;different&nbsp;than&nbsp;&#34;x++/foo/i&#34;,&nbsp;but&nbsp;is&nbsp;not&nbsp;known&nbsp;to</span><br>
<span class="lineno">25</span><span class="comment" id="2863218">//&nbsp;fail&nbsp;on&nbsp;any&nbsp;known&nbsp;useful&nbsp;programs.&nbsp;It&nbsp;is&nbsp;based&nbsp;on&nbsp;the&nbsp;draft</span><br>
<span class="lineno"></span><span class="comment" id="2863281">//&nbsp;JavaScript&nbsp;2.0&nbsp;lexical&nbsp;grammar&nbsp;and&nbsp;requires&nbsp;one&nbsp;token&nbsp;of&nbsp;lookbehind:</span><br>
<span class="lineno"></span><span class="comment" id="2863353">//&nbsp;http://www.mozilla.org/js/language/js20-2000-07/rationale/syntax.html</span><br>
<span class="lineno"></span><span class="keyword" id="2863426">func</span>&nbsp;<span class="ident" id="2863431">nextJSCtx</span><span class="op" id="2863440">(</span><span class="ident" id="2863441">s</span>&nbsp;<span class="op" id="2863443">[</span><span class="op" id="2863444">]</span><span class="builtintype" id="2863445">byte</span><span class="op" id="2863449">,</span>&nbsp;<span class="ident" id="2863451">preceding</span>&nbsp;<span class="ident" id="2863461">jsCtx</span><span class="op" id="2863466">)</span>&nbsp;<span class="ident" id="2863468">jsCtx</span>&nbsp;<span class="op" id="2863474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2863477">s</span>&nbsp;<span class="op" id="2863479">=</span>&nbsp;<span class="ident" id="2863481">bytes</span><span class="op" id="2863486">.</span><span class="ident" id="2863487">TrimRight</span><span class="op" id="2863496">(</span><span class="ident" id="2863497">s</span><span class="op" id="2863498">,</span>&nbsp;<span class="string" id="2863500">&#34;\t\n\f\r&nbsp;\u2028\u2029&#34;</span><span class="op" id="2863523">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2863526">if</span>&nbsp;<span class="builtinfunc" id="2863529">len</span><span class="op" id="2863532">(</span><span class="ident" id="2863533">s</span><span class="op" id="2863534">)</span>&nbsp;<span class="op" id="2863536">==</span>&nbsp;<span class="num" id="2863539">0</span>&nbsp;<span class="op" id="2863541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2863545">return</span>&nbsp;<span class="ident" id="2863552">preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2863563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2863567">//&nbsp;All&nbsp;cases&nbsp;below&nbsp;are&nbsp;in&nbsp;the&nbsp;single-byte&nbsp;UTF-8&nbsp;group.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2863623">switch</span>&nbsp;<span class="ident" id="2863630">c</span><span class="op" id="2863631">,</span>&nbsp;<span class="ident" id="2863633">n</span>&nbsp;<span class="op" id="2863635">:=</span>&nbsp;<span class="ident" id="2863638">s</span><span class="op" id="2863639">[</span><span class="builtinfunc" id="2863640">len</span><span class="op" id="2863643">(</span><span class="ident" id="2863644">s</span><span class="op" id="2863645">)</span><span class="op" id="2863646">-</span><span class="num" id="2863647">1</span><span class="op" id="2863648">]</span><span class="op" id="2863649">,</span>&nbsp;<span class="builtinfunc" id="2863651">len</span><span class="op" id="2863654">(</span><span class="ident" id="2863655">s</span><span class="op" id="2863656">)</span><span class="op" id="2863657">;</span>&nbsp;<span class="ident" id="2863659">c</span>&nbsp;<span class="op" id="2863661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2863664">case</span>&nbsp;<span class="string" id="2863669">&#39;+&#39;</span><span class="op" id="2863672">,</span>&nbsp;<span class="string" id="2863674">&#39;-&#39;</span><span class="op" id="2863677">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2863681">//&nbsp;++&nbsp;and&nbsp;--&nbsp;are&nbsp;not&nbsp;regexp&nbsp;preceders,&nbsp;but&nbsp;+&nbsp;and&nbsp;-&nbsp;are&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2863746">//&nbsp;they&nbsp;are&nbsp;used&nbsp;as&nbsp;infix&nbsp;or&nbsp;prefix&nbsp;operators.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2863795">start</span>&nbsp;<span class="op" id="2863801">:=</span>&nbsp;<span class="ident" id="2863804">n</span>&nbsp;<span class="op" id="2863806">-</span>&nbsp;<span class="num" id="2863808">1</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2863812">//&nbsp;Count&nbsp;the&nbsp;number&nbsp;of&nbsp;adjacent&nbsp;dashes&nbsp;or&nbsp;pluses.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2863864">for</span>&nbsp;<span class="ident" id="2863868">start</span>&nbsp;<span class="op" id="2863874">&gt;</span>&nbsp;<span class="num" id="2863876">0</span>&nbsp;<span class="op" id="2863878">&amp;&amp;</span>&nbsp;<span class="ident" id="2863881">s</span><span class="op" id="2863882">[</span><span class="ident" id="2863883">start</span><span class="op" id="2863888">-</span><span class="num" id="2863889">1</span><span class="op" id="2863890">]</span>&nbsp;<span class="op" id="2863892">==</span>&nbsp;<span class="ident" id="2863895">c</span>&nbsp;<span class="op" id="2863897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2863902">start</span><span class="op" id="2863907">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2863912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2863916">if</span>&nbsp;<span class="op" id="2863919">(</span><span class="ident" id="2863920">n</span><span class="op" id="2863921">-</span><span class="ident" id="2863922">start</span><span class="op" id="2863927">)</span><span class="op" id="2863928">&amp;</span><span class="num" id="2863929">1</span>&nbsp;<span class="op" id="2863931">==</span>&nbsp;<span class="num" id="2863934">1</span>&nbsp;<span class="op" id="2863936">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2863941">//&nbsp;Reached&nbsp;for&nbsp;trailing&nbsp;minus&nbsp;signs&nbsp;since&nbsp;&#34;---&#34;&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2863999">//&nbsp;same&nbsp;as&nbsp;&#34;--&nbsp;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2864021">return</span>&nbsp;<span class="ident" id="2864028">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2864042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2864046">return</span>&nbsp;<span class="ident" id="2864053">jsCtxDivOp</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2864065">case</span>&nbsp;<span class="string" id="2864070">&#39;.&#39;</span><span class="op" id="2864073">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2864077">//&nbsp;Handle&nbsp;&#34;42.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2864095">if</span>&nbsp;<span class="ident" id="2864098">n</span>&nbsp;<span class="op" id="2864100">!=</span>&nbsp;<span class="num" id="2864103">1</span>&nbsp;<span class="op" id="2864105">&amp;&amp;</span>&nbsp;<span class="string" id="2864108">&#39;0&#39;</span>&nbsp;<span class="op" id="2864112">&lt;=</span>&nbsp;<span class="ident" id="2864115">s</span><span class="op" id="2864116">[</span><span class="ident" id="2864117">n</span><span class="op" id="2864118">-</span><span class="num" id="2864119">2</span><span class="op" id="2864120">]</span>&nbsp;<span class="op" id="2864122">&amp;&amp;</span>&nbsp;<span class="ident" id="2864125">s</span><span class="op" id="2864126">[</span><span class="ident" id="2864127">n</span><span class="op" id="2864128">-</span><span class="num" id="2864129">2</span><span class="op" id="2864130">]</span>&nbsp;<span class="op" id="2864132">&lt;=</span>&nbsp;<span class="string" id="2864135">&#39;9&#39;</span>&nbsp;<span class="op" id="2864139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2864144">return</span>&nbsp;<span class="ident" id="2864151">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2864164">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2864168">return</span>&nbsp;<span class="ident" id="2864175">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2864188">//&nbsp;Suffixes&nbsp;for&nbsp;all&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2864259">//&nbsp;that&nbsp;only&nbsp;end&nbsp;binary&nbsp;operators&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2864313">case</span>&nbsp;<span class="string" id="2864318">&#39;,&#39;</span><span class="op" id="2864321">,</span>&nbsp;<span class="string" id="2864323">&#39;&lt;&#39;</span><span class="op" id="2864326">,</span>&nbsp;<span class="string" id="2864328">&#39;&gt;&#39;</span><span class="op" id="2864331">,</span>&nbsp;<span class="string" id="2864333">&#39;=&#39;</span><span class="op" id="2864336">,</span>&nbsp;<span class="string" id="2864338">&#39;*&#39;</span><span class="op" id="2864341">,</span>&nbsp;<span class="string" id="2864343">&#39;%&#39;</span><span class="op" id="2864346">,</span>&nbsp;<span class="string" id="2864348">&#39;&amp;&#39;</span><span class="op" id="2864351">,</span>&nbsp;<span class="string" id="2864353">&#39;|&#39;</span><span class="op" id="2864356">,</span>&nbsp;<span class="string" id="2864358">&#39;^&#39;</span><span class="op" id="2864361">,</span>&nbsp;<span class="string" id="2864363">&#39;?&#39;</span><span class="op" id="2864366">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2864370">return</span>&nbsp;<span class="ident" id="2864377">jsCtxRegexp</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2864390">//&nbsp;Suffixes&nbsp;for&nbsp;all&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2864461">//&nbsp;that&nbsp;are&nbsp;prefix&nbsp;operators&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2864510">case</span>&nbsp;<span class="string" id="2864515">&#39;!&#39;</span><span class="op" id="2864518">,</span>&nbsp;<span class="string" id="2864520">&#39;~&#39;</span><span class="op" id="2864523">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2864527">return</span>&nbsp;<span class="ident" id="2864534">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2864547">//&nbsp;Matches&nbsp;all&nbsp;the&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2864617">//&nbsp;that&nbsp;are&nbsp;open&nbsp;brackets&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2864663">case</span>&nbsp;<span class="string" id="2864668">&#39;(&#39;</span><span class="op" id="2864671">,</span>&nbsp;<span class="string" id="2864673">&#39;[&#39;</span><span class="op" id="2864676">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2864680">return</span>&nbsp;<span class="ident" id="2864687">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2864700">//&nbsp;Matches&nbsp;all&nbsp;the&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2864770">//&nbsp;that&nbsp;precede&nbsp;expression&nbsp;starts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2864806">case</span>&nbsp;<span class="string" id="2864811">&#39;:&#39;</span><span class="op" id="2864814">,</span>&nbsp;<span class="string" id="2864816">&#39;;&#39;</span><span class="op" id="2864819">,</span>&nbsp;<span class="string" id="2864821">&#39;{&#39;</span><span class="op" id="2864824">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2864828">return</span>&nbsp;<span class="ident" id="2864835">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2864848">//&nbsp;CAVEAT:&nbsp;the&nbsp;close&nbsp;punctuators&nbsp;(&#39;}&#39;,&nbsp;&#39;]&#39;,&nbsp;&#39;)&#39;)&nbsp;precede&nbsp;div&nbsp;ops&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2864918">//&nbsp;are&nbsp;handled&nbsp;in&nbsp;the&nbsp;default&nbsp;except&nbsp;for&nbsp;&#39;}&#39;&nbsp;which&nbsp;can&nbsp;precede&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2864984">//&nbsp;division&nbsp;op&nbsp;as&nbsp;in</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2865006">//&nbsp;&nbsp;&nbsp;&nbsp;({&nbsp;valueOf:&nbsp;function&nbsp;()&nbsp;{&nbsp;return&nbsp;42&nbsp;}&nbsp;}&nbsp;/&nbsp;2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2865057">//&nbsp;which&nbsp;is&nbsp;valid,&nbsp;but,&nbsp;in&nbsp;practice,&nbsp;developers&nbsp;don&#39;t&nbsp;divide&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2865126">//&nbsp;literals,&nbsp;so&nbsp;our&nbsp;heuristic&nbsp;works&nbsp;well&nbsp;for&nbsp;code&nbsp;like</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2865182">//&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;()&nbsp;{&nbsp;...&nbsp;}&nbsp;&nbsp;/foo/.test(x)&nbsp;&amp;&amp;&nbsp;sideEffect();</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2865241">//&nbsp;The&nbsp;&#39;)&#39;&nbsp;punctuator&nbsp;can&nbsp;precede&nbsp;a&nbsp;regular&nbsp;expression&nbsp;as&nbsp;in</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2865303">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(b)&nbsp;/foo/.test(x)&nbsp;&amp;&amp;&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2865339">//&nbsp;but&nbsp;this&nbsp;is&nbsp;much&nbsp;less&nbsp;likely&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2865377">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(a&nbsp;+&nbsp;b)&nbsp;/&nbsp;c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2865397">case</span>&nbsp;<span class="string" id="2865402">&#39;}&#39;</span><span class="op" id="2865405">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2865409">return</span>&nbsp;<span class="ident" id="2865416">jsCtxRegexp</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2865429">default</span><span class="op" id="2865436">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2865440">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;IdentifierName&nbsp;and&nbsp;see&nbsp;if&nbsp;it&nbsp;is&nbsp;a&nbsp;keyword&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2865504">//&nbsp;can&nbsp;precede&nbsp;a&nbsp;regular&nbsp;expression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2865543">j</span>&nbsp;<span class="op" id="2865545">:=</span>&nbsp;<span class="ident" id="2865548">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2865552">for</span>&nbsp;<span class="ident" id="2865556">j</span>&nbsp;<span class="op" id="2865558">&gt;</span>&nbsp;<span class="num" id="2865560">0</span>&nbsp;<span class="op" id="2865562">&amp;&amp;</span>&nbsp;<span class="ident" id="2865565">isJSIdentPart</span><span class="op" id="2865578">(</span><span class="builtintype" id="2865579">rune</span><span class="op" id="2865583">(</span><span class="ident" id="2865584">s</span><span class="op" id="2865585">[</span><span class="ident" id="2865586">j</span><span class="op" id="2865587">-</span><span class="num" id="2865588">1</span><span class="op" id="2865589">]</span><span class="op" id="2865590">)</span><span class="op" id="2865591">)</span>&nbsp;<span class="op" id="2865593">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2865598">j</span><span class="op" id="2865599">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2865604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2865608">if</span>&nbsp;<span class="ident" id="2865611">regexpPrecederKeywords</span><span class="op" id="2865633">[</span><span class="builtintype" id="2865634">string</span><span class="op" id="2865640">(</span><span class="ident" id="2865641">s</span><span class="op" id="2865642">[</span><span class="ident" id="2865643">j</span><span class="op" id="2865644">:</span><span class="op" id="2865645">]</span><span class="op" id="2865646">)</span><span class="op" id="2865647">]</span>&nbsp;<span class="op" id="2865649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2865654">return</span>&nbsp;<span class="ident" id="2865661">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2865675">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2865678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2865681">//&nbsp;Otherwise&nbsp;is&nbsp;a&nbsp;punctuator&nbsp;not&nbsp;listed&nbsp;above,&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2865732">//&nbsp;a&nbsp;string&nbsp;which&nbsp;precedes&nbsp;a&nbsp;div&nbsp;op,&nbsp;or&nbsp;an&nbsp;identifier</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2865787">//&nbsp;which&nbsp;precedes&nbsp;a&nbsp;div&nbsp;op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2865816">return</span>&nbsp;<span class="ident" id="2865823">jsCtxDivOp</span><br>
<span class="lineno">100</span><span class="op" id="2865834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2865837">//&nbsp;regexpPrecederKeywords&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;reserved&nbsp;JS&nbsp;keywords&nbsp;that&nbsp;can&nbsp;precede&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="2865915">//&nbsp;regular&nbsp;expression&nbsp;in&nbsp;JS&nbsp;source.</span><br>
<span class="lineno"></span><span class="keyword" id="2865951">var</span>&nbsp;<span class="ident" id="2865955">regexpPrecederKeywords</span>&nbsp;<span class="op" id="2865978">=</span>&nbsp;<span class="keyword" id="2865980">map</span><span class="op" id="2865983">[</span><span class="builtintype" id="2865984">string</span><span class="op" id="2865990">]</span><span class="builtintype" id="2865991">bool</span><span class="op" id="2865995">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2865998">&#34;break&#34;</span><span class="op" id="2866005">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2866012">true</span><span class="op" id="2866016">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2866019">&#34;case&#34;</span><span class="op" id="2866025">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2866033">true</span><span class="op" id="2866037">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2866040">&#34;continue&#34;</span><span class="op" id="2866050">:</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2866054">true</span><span class="op" id="2866058">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2866061">&#34;delete&#34;</span><span class="op" id="2866069">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2866075">true</span><span class="op" id="2866079">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2866082">&#34;do&#34;</span><span class="op" id="2866086">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2866096">true</span><span class="op" id="2866100">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2866103">&#34;else&#34;</span><span class="op" id="2866109">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2866117">true</span><span class="op" id="2866121">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2866124">&#34;finally&#34;</span><span class="op" id="2866133">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2866138">true</span><span class="op" id="2866142">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2866145">&#34;in&#34;</span><span class="op" id="2866149">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2866159">true</span><span class="op" id="2866163">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2866166">&#34;instanceof&#34;</span><span class="op" id="2866178">:</span>&nbsp;<span class="builtintype" id="2866180">true</span><span class="op" id="2866184">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2866187">&#34;return&#34;</span><span class="op" id="2866195">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2866201">true</span><span class="op" id="2866205">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2866208">&#34;throw&#34;</span><span class="op" id="2866215">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2866222">true</span><span class="op" id="2866226">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2866229">&#34;try&#34;</span><span class="op" id="2866234">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2866243">true</span><span class="op" id="2866247">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2866250">&#34;typeof&#34;</span><span class="op" id="2866258">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2866264">true</span><span class="op" id="2866268">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2866271">&#34;void&#34;</span><span class="op" id="2866277">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2866285">true</span><span class="op" id="2866289">,</span><br>
<span class="lineno"></span><span class="op" id="2866291">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="keyword" id="2866294">var</span>&nbsp;<span class="ident" id="2866298">jsonMarshalType</span>&nbsp;<span class="op" id="2866314">=</span>&nbsp;<span class="ident" id="2866316">reflect</span><span class="op" id="2866323">.</span><span class="ident" id="2866324">TypeOf</span><span class="op" id="2866330">(</span><span class="op" id="2866331">(</span><span class="op" id="2866332">*</span><span class="ident" id="2866333">json</span><span class="op" id="2866337">.</span><span class="ident" id="2866338">Marshaler</span><span class="op" id="2866347">)</span><span class="op" id="2866348">(</span><span class="ident" id="2866349">nil</span><span class="op" id="2866352">)</span><span class="op" id="2866353">)</span><span class="op" id="2866354">.</span><span class="ident" id="2866355">Elem</span><span class="op" id="2866359">(</span><span class="op" id="2866360">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2866363">//&nbsp;indirectToJSONMarshaler&nbsp;returns&nbsp;the&nbsp;value,&nbsp;after&nbsp;dereferencing&nbsp;as&nbsp;many&nbsp;times</span><br>
<span class="lineno"></span><span class="comment" id="2866443">//&nbsp;as&nbsp;necessary&nbsp;to&nbsp;reach&nbsp;the&nbsp;base&nbsp;type&nbsp;(or&nbsp;nil)&nbsp;or&nbsp;an&nbsp;implementation&nbsp;of&nbsp;json.Marshal.</span><br>
<span class="lineno">125</span><span class="keyword" id="2866529">func</span>&nbsp;<span class="ident" id="2866534">indirectToJSONMarshaler</span><span class="op" id="2866557">(</span><span class="ident" id="2866558">a</span>&nbsp;<span class="keyword" id="2866560">interface</span><span class="op" id="2866569">{</span><span class="op" id="2866570">}</span><span class="op" id="2866571">)</span>&nbsp;<span class="keyword" id="2866573">interface</span><span class="op" id="2866582">{</span><span class="op" id="2866583">}</span>&nbsp;<span class="op" id="2866585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2866588">v</span>&nbsp;<span class="op" id="2866590">:=</span>&nbsp;<span class="ident" id="2866593">reflect</span><span class="op" id="2866600">.</span><span class="ident" id="2866601">ValueOf</span><span class="op" id="2866608">(</span><span class="ident" id="2866609">a</span><span class="op" id="2866610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2866613">for</span>&nbsp;<span class="op" id="2866617">!</span><span class="ident" id="2866618">v</span><span class="op" id="2866619">.</span><span class="ident" id="2866620">Type</span><span class="op" id="2866624">(</span><span class="op" id="2866625">)</span><span class="op" id="2866626">.</span><span class="ident" id="2866627">Implements</span><span class="op" id="2866637">(</span><span class="ident" id="2866638">jsonMarshalType</span><span class="op" id="2866653">)</span>&nbsp;<span class="op" id="2866655">&amp;&amp;</span>&nbsp;<span class="ident" id="2866658">v</span><span class="op" id="2866659">.</span><span class="ident" id="2866660">Kind</span><span class="op" id="2866664">(</span><span class="op" id="2866665">)</span>&nbsp;<span class="op" id="2866667">==</span>&nbsp;<span class="ident" id="2866670">reflect</span><span class="op" id="2866677">.</span><span class="ident" id="2866678">Ptr</span>&nbsp;<span class="op" id="2866682">&amp;&amp;</span>&nbsp;<span class="op" id="2866685">!</span><span class="ident" id="2866686">v</span><span class="op" id="2866687">.</span><span class="ident" id="2866688">IsNil</span><span class="op" id="2866693">(</span><span class="op" id="2866694">)</span>&nbsp;<span class="op" id="2866696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2866700">v</span>&nbsp;<span class="op" id="2866702">=</span>&nbsp;<span class="ident" id="2866704">v</span><span class="op" id="2866705">.</span><span class="ident" id="2866706">Elem</span><span class="op" id="2866710">(</span><span class="op" id="2866711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2866714">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2866717">return</span>&nbsp;<span class="ident" id="2866724">v</span><span class="op" id="2866725">.</span><span class="ident" id="2866726">Interface</span><span class="op" id="2866735">(</span><span class="op" id="2866736">)</span><br>
<span class="lineno"></span><span class="op" id="2866738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2866741">//&nbsp;jsValEscaper&nbsp;escapes&nbsp;its&nbsp;inputs&nbsp;to&nbsp;a&nbsp;JS&nbsp;Expression&nbsp;(section&nbsp;11.14)&nbsp;that&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="2866820">//&nbsp;neither&nbsp;side-effects&nbsp;nor&nbsp;free&nbsp;variables&nbsp;outside&nbsp;(NaN,&nbsp;Infinity).</span><br>
<span class="lineno">135</span><span class="keyword" id="2866888">func</span>&nbsp;<span class="ident" id="2866893">jsValEscaper</span><span class="op" id="2866905">(</span><span class="ident" id="2866906">args</span>&nbsp;<span class="op" id="2866911">...</span><span class="keyword" id="2866914">interface</span><span class="op" id="2866923">{</span><span class="op" id="2866924">}</span><span class="op" id="2866925">)</span>&nbsp;<span class="builtintype" id="2866927">string</span>&nbsp;<span class="op" id="2866934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2866937">var</span>&nbsp;<span class="ident" id="2866941">a</span>&nbsp;<span class="keyword" id="2866943">interface</span><span class="op" id="2866952">{</span><span class="op" id="2866953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2866956">if</span>&nbsp;<span class="builtinfunc" id="2866959">len</span><span class="op" id="2866962">(</span><span class="ident" id="2866963">args</span><span class="op" id="2866967">)</span>&nbsp;<span class="op" id="2866969">==</span>&nbsp;<span class="num" id="2866972">1</span>&nbsp;<span class="op" id="2866974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2866978">a</span>&nbsp;<span class="op" id="2866980">=</span>&nbsp;<span class="ident" id="2866982">indirectToJSONMarshaler</span><span class="op" id="2867005">(</span><span class="ident" id="2867006">args</span><span class="op" id="2867010">[</span><span class="num" id="2867011">0</span><span class="op" id="2867012">]</span><span class="op" id="2867013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2867017">switch</span>&nbsp;<span class="ident" id="2867024">t</span>&nbsp;<span class="op" id="2867026">:=</span>&nbsp;<span class="ident" id="2867029">a</span><span class="op" id="2867030">.</span><span class="op" id="2867031">(</span><span class="keyword" id="2867032">type</span><span class="op" id="2867036">)</span>&nbsp;<span class="op" id="2867038">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2867042">case</span>&nbsp;<span class="ident" id="2867047">JS</span><span class="op" id="2867049">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2867054">return</span>&nbsp;<span class="builtintype" id="2867061">string</span><span class="op" id="2867067">(</span><span class="ident" id="2867068">t</span><span class="op" id="2867069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2867073">case</span>&nbsp;<span class="ident" id="2867078">JSStr</span><span class="op" id="2867083">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2867088">//&nbsp;TODO:&nbsp;normalize&nbsp;quotes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2867118">return</span>&nbsp;<span class="string" id="2867125">`&#34;`</span>&nbsp;<span class="op" id="2867129">+</span>&nbsp;<span class="builtintype" id="2867131">string</span><span class="op" id="2867137">(</span><span class="ident" id="2867138">t</span><span class="op" id="2867139">)</span>&nbsp;<span class="op" id="2867141">+</span>&nbsp;<span class="string" id="2867143">`&#34;`</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2867149">case</span>&nbsp;<span class="ident" id="2867154">json</span><span class="op" id="2867158">.</span><span class="ident" id="2867159">Marshaler</span><span class="op" id="2867168">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2867173">//&nbsp;Do&nbsp;not&nbsp;treat&nbsp;as&nbsp;a&nbsp;Stringer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2867206">case</span>&nbsp;<span class="ident" id="2867211">fmt</span><span class="op" id="2867214">.</span><span class="ident" id="2867215">Stringer</span><span class="op" id="2867223">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2867228">a</span>&nbsp;<span class="op" id="2867230">=</span>&nbsp;<span class="ident" id="2867232">t</span><span class="op" id="2867233">.</span><span class="ident" id="2867234">String</span><span class="op" id="2867240">(</span><span class="op" id="2867241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2867245">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2867248">}</span>&nbsp;<span class="keyword" id="2867250">else</span>&nbsp;<span class="op" id="2867255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2867259">for</span>&nbsp;<span class="ident" id="2867263">i</span><span class="op" id="2867264">,</span>&nbsp;<span class="ident" id="2867266">arg</span>&nbsp;<span class="op" id="2867270">:=</span>&nbsp;<span class="keyword" id="2867273">range</span>&nbsp;<span class="ident" id="2867279">args</span>&nbsp;<span class="op" id="2867284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2867289">args</span><span class="op" id="2867293">[</span><span class="ident" id="2867294">i</span><span class="op" id="2867295">]</span>&nbsp;<span class="op" id="2867297">=</span>&nbsp;<span class="ident" id="2867299">indirectToJSONMarshaler</span><span class="op" id="2867322">(</span><span class="ident" id="2867323">arg</span><span class="op" id="2867326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2867330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2867334">a</span>&nbsp;<span class="op" id="2867336">=</span>&nbsp;<span class="ident" id="2867338">fmt</span><span class="op" id="2867341">.</span><span class="ident" id="2867342">Sprint</span><span class="op" id="2867348">(</span><span class="ident" id="2867349">args</span><span class="op" id="2867353">...</span><span class="op" id="2867356">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2867359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2867362">//&nbsp;TODO:&nbsp;detect&nbsp;cycles&nbsp;before&nbsp;calling&nbsp;Marshal&nbsp;which&nbsp;loops&nbsp;infinitely&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2867435">//&nbsp;cyclic&nbsp;data.&nbsp;This&nbsp;may&nbsp;be&nbsp;an&nbsp;unacceptable&nbsp;DoS&nbsp;risk.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2867491">b</span><span class="op" id="2867492">,</span>&nbsp;<span class="ident" id="2867494">err</span>&nbsp;<span class="op" id="2867498">:=</span>&nbsp;<span class="ident" id="2867501">json</span><span class="op" id="2867505">.</span><span class="ident" id="2867506">Marshal</span><span class="op" id="2867513">(</span><span class="ident" id="2867514">a</span><span class="op" id="2867515">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2867518">if</span>&nbsp;<span class="ident" id="2867521">err</span>&nbsp;<span class="op" id="2867525">!=</span>&nbsp;<span class="ident" id="2867528">nil</span>&nbsp;<span class="op" id="2867532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2867536">//&nbsp;Put&nbsp;a&nbsp;space&nbsp;before&nbsp;comment&nbsp;so&nbsp;that&nbsp;if&nbsp;it&nbsp;is&nbsp;flush&nbsp;against</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2867599">//&nbsp;a&nbsp;division&nbsp;operator&nbsp;it&nbsp;is&nbsp;not&nbsp;turned&nbsp;into&nbsp;a&nbsp;line&nbsp;comment:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2867662">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x/{{y}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2867679">//&nbsp;turning&nbsp;into</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2867697">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x//*&nbsp;error&nbsp;marshalling&nbsp;y:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2867732">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;second&nbsp;line&nbsp;of&nbsp;error&nbsp;message&nbsp;*/null</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2867782">return</span>&nbsp;<span class="ident" id="2867789">fmt</span><span class="op" id="2867792">.</span><span class="ident" id="2867793">Sprintf</span><span class="op" id="2867800">(</span><span class="string" id="2867801">&#34;&nbsp;/*&nbsp;%s&nbsp;*/null&nbsp;&#34;</span><span class="op" id="2867817">,</span>&nbsp;<span class="ident" id="2867819">strings</span><span class="op" id="2867826">.</span><span class="ident" id="2867827">Replace</span><span class="op" id="2867834">(</span><span class="ident" id="2867835">err</span><span class="op" id="2867838">.</span><span class="ident" id="2867839">Error</span><span class="op" id="2867844">(</span><span class="op" id="2867845">)</span><span class="op" id="2867846">,</span>&nbsp;<span class="string" id="2867848">&#34;*/&#34;</span><span class="op" id="2867852">,</span>&nbsp;<span class="string" id="2867854">&#34;*&nbsp;/&#34;</span><span class="op" id="2867859">,</span>&nbsp;<span class="op" id="2867861">-</span><span class="num" id="2867862">1</span><span class="op" id="2867863">)</span><span class="op" id="2867864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2867867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2867871">//&nbsp;TODO:&nbsp;maybe&nbsp;post-process&nbsp;output&nbsp;to&nbsp;prevent&nbsp;it&nbsp;from&nbsp;containing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2867937">//&nbsp;&#34;&lt;!--&#34;,&nbsp;&#34;--&gt;&#34;,&nbsp;&#34;&lt;![CDATA[&#34;,&nbsp;&#34;]]&gt;&#34;,&nbsp;or&nbsp;&#34;&lt;/script&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2867990">//&nbsp;in&nbsp;case&nbsp;custom&nbsp;marshallers&nbsp;produce&nbsp;output&nbsp;containing&nbsp;those.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2868055">//&nbsp;TODO:&nbsp;Maybe&nbsp;abbreviate&nbsp;\u00ab&nbsp;to&nbsp;\xab&nbsp;to&nbsp;produce&nbsp;more&nbsp;compact&nbsp;output.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2868129">if</span>&nbsp;<span class="builtinfunc" id="2868132">len</span><span class="op" id="2868135">(</span><span class="ident" id="2868136">b</span><span class="op" id="2868137">)</span>&nbsp;<span class="op" id="2868139">==</span>&nbsp;<span class="num" id="2868142">0</span>&nbsp;<span class="op" id="2868144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2868148">//&nbsp;In,&nbsp;`x=y/{{.}}*z`&nbsp;a&nbsp;json.Marshaler&nbsp;that&nbsp;produces&nbsp;&#34;&#34;&nbsp;should</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2868212">//&nbsp;not&nbsp;cause&nbsp;the&nbsp;output&nbsp;`x=y/*z`.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2868248">return</span>&nbsp;<span class="string" id="2868255">&#34;&nbsp;null&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2868265">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2868268">first</span><span class="op" id="2868273">,</span>&nbsp;<span class="ident" id="2868275">_</span>&nbsp;<span class="op" id="2868277">:=</span>&nbsp;<span class="ident" id="2868280">utf8</span><span class="op" id="2868284">.</span><span class="ident" id="2868285">DecodeRune</span><span class="op" id="2868295">(</span><span class="ident" id="2868296">b</span><span class="op" id="2868297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2868300">last</span><span class="op" id="2868304">,</span>&nbsp;<span class="ident" id="2868306">_</span>&nbsp;<span class="op" id="2868308">:=</span>&nbsp;<span class="ident" id="2868311">utf8</span><span class="op" id="2868315">.</span><span class="ident" id="2868316">DecodeLastRune</span><span class="op" id="2868330">(</span><span class="ident" id="2868331">b</span><span class="op" id="2868332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2868335">var</span>&nbsp;<span class="ident" id="2868339">buf</span>&nbsp;<span class="ident" id="2868343">bytes</span><span class="op" id="2868348">.</span><span class="ident" id="2868349">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2868357">//&nbsp;Prevent&nbsp;IdentifierNames&nbsp;and&nbsp;NumericLiterals&nbsp;from&nbsp;running&nbsp;into</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2868423">//&nbsp;keywords:&nbsp;in,&nbsp;instanceof,&nbsp;typeof,&nbsp;void</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2868466">pad</span>&nbsp;<span class="op" id="2868470">:=</span>&nbsp;<span class="ident" id="2868473">isJSIdentPart</span><span class="op" id="2868486">(</span><span class="ident" id="2868487">first</span><span class="op" id="2868492">)</span>&nbsp;<span class="op" id="2868494">||</span>&nbsp;<span class="ident" id="2868497">isJSIdentPart</span><span class="op" id="2868510">(</span><span class="ident" id="2868511">last</span><span class="op" id="2868515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2868518">if</span>&nbsp;<span class="ident" id="2868521">pad</span>&nbsp;<span class="op" id="2868525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2868529">buf</span><span class="op" id="2868532">.</span><span class="ident" id="2868533">WriteByte</span><span class="op" id="2868542">(</span><span class="string" id="2868543">&#39;&nbsp;&#39;</span><span class="op" id="2868546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2868549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2868552">written</span>&nbsp;<span class="op" id="2868560">:=</span>&nbsp;<span class="num" id="2868563">0</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2868566">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;json.Marshal&nbsp;escapes&nbsp;codepoints&nbsp;U+2028&nbsp;&amp;&nbsp;U+2029</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2868633">//&nbsp;so&nbsp;it&nbsp;falls&nbsp;within&nbsp;the&nbsp;subset&nbsp;of&nbsp;JSON&nbsp;which&nbsp;is&nbsp;valid&nbsp;JS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2868694">for</span>&nbsp;<span class="ident" id="2868698">i</span>&nbsp;<span class="op" id="2868700">:=</span>&nbsp;<span class="num" id="2868703">0</span><span class="op" id="2868704">;</span>&nbsp;<span class="ident" id="2868706">i</span>&nbsp;<span class="op" id="2868708">&lt;</span>&nbsp;<span class="builtinfunc" id="2868710">len</span><span class="op" id="2868713">(</span><span class="ident" id="2868714">b</span><span class="op" id="2868715">)</span><span class="op" id="2868716">;</span>&nbsp;<span class="op" id="2868718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2868722">rune</span><span class="op" id="2868726">,</span>&nbsp;<span class="ident" id="2868728">n</span>&nbsp;<span class="op" id="2868730">:=</span>&nbsp;<span class="ident" id="2868733">utf8</span><span class="op" id="2868737">.</span><span class="ident" id="2868738">DecodeRune</span><span class="op" id="2868748">(</span><span class="ident" id="2868749">b</span><span class="op" id="2868750">[</span><span class="ident" id="2868751">i</span><span class="op" id="2868752">:</span><span class="op" id="2868753">]</span><span class="op" id="2868754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2868758">repl</span>&nbsp;<span class="op" id="2868763">:=</span>&nbsp;<span class="string" id="2868766">&#34;&#34;</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2868771">if</span>&nbsp;<span class="builtintype" id="2868774">rune</span>&nbsp;<span class="op" id="2868779">==</span>&nbsp;<span class="num" id="2868782">0x2028</span>&nbsp;<span class="op" id="2868789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2868794">repl</span>&nbsp;<span class="op" id="2868799">=</span>&nbsp;<span class="string" id="2868801">`\u2028`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2868812">}</span>&nbsp;<span class="keyword" id="2868814">else</span>&nbsp;<span class="keyword" id="2868819">if</span>&nbsp;<span class="builtintype" id="2868822">rune</span>&nbsp;<span class="op" id="2868827">==</span>&nbsp;<span class="num" id="2868830">0x2029</span>&nbsp;<span class="op" id="2868837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2868842">repl</span>&nbsp;<span class="op" id="2868847">=</span>&nbsp;<span class="string" id="2868849">`\u2029`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2868860">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2868864">if</span>&nbsp;<span class="ident" id="2868867">repl</span>&nbsp;<span class="op" id="2868872">!=</span>&nbsp;<span class="string" id="2868875">&#34;&#34;</span>&nbsp;<span class="op" id="2868878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2868883">buf</span><span class="op" id="2868886">.</span><span class="ident" id="2868887">Write</span><span class="op" id="2868892">(</span><span class="ident" id="2868893">b</span><span class="op" id="2868894">[</span><span class="ident" id="2868895">written</span><span class="op" id="2868902">:</span><span class="ident" id="2868903">i</span><span class="op" id="2868904">]</span><span class="op" id="2868905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2868910">buf</span><span class="op" id="2868913">.</span><span class="ident" id="2868914">WriteString</span><span class="op" id="2868925">(</span><span class="ident" id="2868926">repl</span><span class="op" id="2868930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2868935">written</span>&nbsp;<span class="op" id="2868943">=</span>&nbsp;<span class="ident" id="2868945">i</span>&nbsp;<span class="op" id="2868947">+</span>&nbsp;<span class="ident" id="2868949">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2868953">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2868957">i</span>&nbsp;<span class="op" id="2868959">+=</span>&nbsp;<span class="ident" id="2868962">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2868965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2868968">if</span>&nbsp;<span class="ident" id="2868971">buf</span><span class="op" id="2868974">.</span><span class="ident" id="2868975">Len</span><span class="op" id="2868978">(</span><span class="op" id="2868979">)</span>&nbsp;<span class="op" id="2868981">!=</span>&nbsp;<span class="num" id="2868984">0</span>&nbsp;<span class="op" id="2868986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2868990">buf</span><span class="op" id="2868993">.</span><span class="ident" id="2868994">Write</span><span class="op" id="2868999">(</span><span class="ident" id="2869000">b</span><span class="op" id="2869001">[</span><span class="ident" id="2869002">written</span><span class="op" id="2869009">:</span><span class="op" id="2869010">]</span><span class="op" id="2869011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2869015">if</span>&nbsp;<span class="ident" id="2869018">pad</span>&nbsp;<span class="op" id="2869022">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2869027">buf</span><span class="op" id="2869030">.</span><span class="ident" id="2869031">WriteByte</span><span class="op" id="2869040">(</span><span class="string" id="2869041">&#39;&nbsp;&#39;</span><span class="op" id="2869044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2869048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2869052">b</span>&nbsp;<span class="op" id="2869054">=</span>&nbsp;<span class="ident" id="2869056">buf</span><span class="op" id="2869059">.</span><span class="ident" id="2869060">Bytes</span><span class="op" id="2869065">(</span><span class="op" id="2869066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2869069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2869072">return</span>&nbsp;<span class="builtintype" id="2869079">string</span><span class="op" id="2869085">(</span><span class="ident" id="2869086">b</span><span class="op" id="2869087">)</span><br>
<span class="lineno">215</span><span class="op" id="2869089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2869092">//&nbsp;jsStrEscaper&nbsp;produces&nbsp;a&nbsp;string&nbsp;that&nbsp;can&nbsp;be&nbsp;included&nbsp;between&nbsp;quotes&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="2869165">//&nbsp;JavaScript&nbsp;source,&nbsp;in&nbsp;JavaScript&nbsp;embedded&nbsp;in&nbsp;an&nbsp;HTML5&nbsp;&lt;script&gt;&nbsp;element,</span><br>
<span class="lineno"></span><span class="comment" id="2869240">//&nbsp;or&nbsp;in&nbsp;an&nbsp;HTML5&nbsp;event&nbsp;handler&nbsp;attribute&nbsp;such&nbsp;as&nbsp;onclick.</span><br>
<span class="lineno">220</span><span class="keyword" id="2869299">func</span>&nbsp;<span class="ident" id="2869304">jsStrEscaper</span><span class="op" id="2869316">(</span><span class="ident" id="2869317">args</span>&nbsp;<span class="op" id="2869322">...</span><span class="keyword" id="2869325">interface</span><span class="op" id="2869334">{</span><span class="op" id="2869335">}</span><span class="op" id="2869336">)</span>&nbsp;<span class="builtintype" id="2869338">string</span>&nbsp;<span class="op" id="2869345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2869348">s</span><span class="op" id="2869349">,</span>&nbsp;<span class="ident" id="2869351">t</span>&nbsp;<span class="op" id="2869353">:=</span>&nbsp;<span class="ident" id="2869356">stringify</span><span class="op" id="2869365">(</span><span class="ident" id="2869366">args</span><span class="op" id="2869370">...</span><span class="op" id="2869373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2869376">if</span>&nbsp;<span class="ident" id="2869379">t</span>&nbsp;<span class="op" id="2869381">==</span>&nbsp;<span class="ident" id="2869384">contentTypeJSStr</span>&nbsp;<span class="op" id="2869401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2869405">return</span>&nbsp;<span class="ident" id="2869412">replace</span><span class="op" id="2869419">(</span><span class="ident" id="2869420">s</span><span class="op" id="2869421">,</span>&nbsp;<span class="ident" id="2869423">jsStrNormReplacementTable</span><span class="op" id="2869448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2869451">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2869454">return</span>&nbsp;<span class="ident" id="2869461">replace</span><span class="op" id="2869468">(</span><span class="ident" id="2869469">s</span><span class="op" id="2869470">,</span>&nbsp;<span class="ident" id="2869472">jsStrReplacementTable</span><span class="op" id="2869493">)</span><br>
<span class="lineno"></span><span class="op" id="2869495">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2869498">//&nbsp;jsRegexpEscaper&nbsp;behaves&nbsp;like&nbsp;jsStrEscaper&nbsp;but&nbsp;escapes&nbsp;regular&nbsp;expression</span><br>
<span class="lineno"></span><span class="comment" id="2869574">//&nbsp;specials&nbsp;so&nbsp;the&nbsp;result&nbsp;is&nbsp;treated&nbsp;literally&nbsp;when&nbsp;included&nbsp;in&nbsp;a&nbsp;regular</span><br>
<span class="lineno">230</span><span class="comment" id="2869648">//&nbsp;expression&nbsp;literal.&nbsp;/foo{{.X}}bar/&nbsp;matches&nbsp;the&nbsp;string&nbsp;&#34;foo&#34;&nbsp;followed&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="2869723">//&nbsp;the&nbsp;literal&nbsp;text&nbsp;of&nbsp;{{.X}}&nbsp;followed&nbsp;by&nbsp;the&nbsp;string&nbsp;&#34;bar&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="2869783">func</span>&nbsp;<span class="ident" id="2869788">jsRegexpEscaper</span><span class="op" id="2869803">(</span><span class="ident" id="2869804">args</span>&nbsp;<span class="op" id="2869809">...</span><span class="keyword" id="2869812">interface</span><span class="op" id="2869821">{</span><span class="op" id="2869822">}</span><span class="op" id="2869823">)</span>&nbsp;<span class="builtintype" id="2869825">string</span>&nbsp;<span class="op" id="2869832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2869835">s</span><span class="op" id="2869836">,</span>&nbsp;<span class="ident" id="2869838">_</span>&nbsp;<span class="op" id="2869840">:=</span>&nbsp;<span class="ident" id="2869843">stringify</span><span class="op" id="2869852">(</span><span class="ident" id="2869853">args</span><span class="op" id="2869857">...</span><span class="op" id="2869860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2869863">s</span>&nbsp;<span class="op" id="2869865">=</span>&nbsp;<span class="ident" id="2869867">replace</span><span class="op" id="2869874">(</span><span class="ident" id="2869875">s</span><span class="op" id="2869876">,</span>&nbsp;<span class="ident" id="2869878">jsRegexpReplacementTable</span><span class="op" id="2869902">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2869905">if</span>&nbsp;<span class="ident" id="2869908">s</span>&nbsp;<span class="op" id="2869910">==</span>&nbsp;<span class="string" id="2869913">&#34;&#34;</span>&nbsp;<span class="op" id="2869916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2869920">//&nbsp;/{{.X}}/&nbsp;should&nbsp;not&nbsp;produce&nbsp;a&nbsp;line&nbsp;comment&nbsp;when&nbsp;.X&nbsp;==&nbsp;&#34;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2869983">return</span>&nbsp;<span class="string" id="2869990">&#34;(?:)&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2869998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2870001">return</span>&nbsp;<span class="ident" id="2870008">s</span><br>
<span class="lineno">240</span><span class="op" id="2870010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2870013">//&nbsp;replace&nbsp;replaces&nbsp;each&nbsp;rune&nbsp;r&nbsp;of&nbsp;s&nbsp;with&nbsp;replacementTable[r],&nbsp;provided&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="2870090">//&nbsp;r&nbsp;&lt;&nbsp;len(replacementTable).&nbsp;If&nbsp;replacementTable[r]&nbsp;is&nbsp;the&nbsp;empty&nbsp;string&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="2870168">//&nbsp;no&nbsp;replacement&nbsp;is&nbsp;made.</span><br>
<span class="lineno">245</span><span class="comment" id="2870195">//&nbsp;It&nbsp;also&nbsp;replaces&nbsp;runes&nbsp;U+2028&nbsp;and&nbsp;U+2029&nbsp;with&nbsp;the&nbsp;raw&nbsp;strings&nbsp;`\u2028`&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="2870273">//&nbsp;`\u2029`.</span><br>
<span class="lineno"></span><span class="keyword" id="2870286">func</span>&nbsp;<span class="ident" id="2870291">replace</span><span class="op" id="2870298">(</span><span class="ident" id="2870299">s</span>&nbsp;<span class="builtintype" id="2870301">string</span><span class="op" id="2870307">,</span>&nbsp;<span class="ident" id="2870309">replacementTable</span>&nbsp;<span class="op" id="2870326">[</span><span class="op" id="2870327">]</span><span class="builtintype" id="2870328">string</span><span class="op" id="2870334">)</span>&nbsp;<span class="builtintype" id="2870336">string</span>&nbsp;<span class="op" id="2870343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2870346">var</span>&nbsp;<span class="ident" id="2870350">b</span>&nbsp;<span class="ident" id="2870352">bytes</span><span class="op" id="2870357">.</span><span class="ident" id="2870358">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2870366">written</span>&nbsp;<span class="op" id="2870374">:=</span>&nbsp;<span class="num" id="2870377">0</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2870380">for</span>&nbsp;<span class="ident" id="2870384">i</span><span class="op" id="2870385">,</span>&nbsp;<span class="ident" id="2870387">r</span>&nbsp;<span class="op" id="2870389">:=</span>&nbsp;<span class="keyword" id="2870392">range</span>&nbsp;<span class="ident" id="2870398">s</span>&nbsp;<span class="op" id="2870400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2870404">var</span>&nbsp;<span class="ident" id="2870408">repl</span>&nbsp;<span class="builtintype" id="2870413">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2870422">switch</span>&nbsp;<span class="op" id="2870429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2870433">case</span>&nbsp;<span class="builtintype" id="2870438">int</span><span class="op" id="2870441">(</span><span class="ident" id="2870442">r</span><span class="op" id="2870443">)</span>&nbsp;<span class="op" id="2870445">&lt;</span>&nbsp;<span class="builtinfunc" id="2870447">len</span><span class="op" id="2870450">(</span><span class="ident" id="2870451">replacementTable</span><span class="op" id="2870467">)</span>&nbsp;<span class="op" id="2870469">&amp;&amp;</span>&nbsp;<span class="ident" id="2870472">replacementTable</span><span class="op" id="2870488">[</span><span class="ident" id="2870489">r</span><span class="op" id="2870490">]</span>&nbsp;<span class="op" id="2870492">!=</span>&nbsp;<span class="string" id="2870495">&#34;&#34;</span><span class="op" id="2870497">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2870502">repl</span>&nbsp;<span class="op" id="2870507">=</span>&nbsp;<span class="ident" id="2870509">replacementTable</span><span class="op" id="2870525">[</span><span class="ident" id="2870526">r</span><span class="op" id="2870527">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2870531">case</span>&nbsp;<span class="ident" id="2870536">r</span>&nbsp;<span class="op" id="2870538">==</span>&nbsp;<span class="string" id="2870541">&#39;\u2028&#39;</span><span class="op" id="2870549">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2870554">repl</span>&nbsp;<span class="op" id="2870559">=</span>&nbsp;<span class="string" id="2870561">`\u2028`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2870572">case</span>&nbsp;<span class="ident" id="2870577">r</span>&nbsp;<span class="op" id="2870579">==</span>&nbsp;<span class="string" id="2870582">&#39;\u2029&#39;</span><span class="op" id="2870590">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2870595">repl</span>&nbsp;<span class="op" id="2870600">=</span>&nbsp;<span class="string" id="2870602">`\u2029`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2870613">default</span><span class="op" id="2870620">:</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2870625">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2870636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2870640">b</span><span class="op" id="2870641">.</span><span class="ident" id="2870642">WriteString</span><span class="op" id="2870653">(</span><span class="ident" id="2870654">s</span><span class="op" id="2870655">[</span><span class="ident" id="2870656">written</span><span class="op" id="2870663">:</span><span class="ident" id="2870664">i</span><span class="op" id="2870665">]</span><span class="op" id="2870666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2870670">b</span><span class="op" id="2870671">.</span><span class="ident" id="2870672">WriteString</span><span class="op" id="2870683">(</span><span class="ident" id="2870684">repl</span><span class="op" id="2870688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2870692">written</span>&nbsp;<span class="op" id="2870700">=</span>&nbsp;<span class="ident" id="2870702">i</span>&nbsp;<span class="op" id="2870704">+</span>&nbsp;<span class="ident" id="2870706">utf8</span><span class="op" id="2870710">.</span><span class="ident" id="2870711">RuneLen</span><span class="op" id="2870718">(</span><span class="ident" id="2870719">r</span><span class="op" id="2870720">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2870723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2870726">if</span>&nbsp;<span class="ident" id="2870729">written</span>&nbsp;<span class="op" id="2870737">==</span>&nbsp;<span class="num" id="2870740">0</span>&nbsp;<span class="op" id="2870742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2870746">return</span>&nbsp;<span class="ident" id="2870753">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2870756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2870759">b</span><span class="op" id="2870760">.</span><span class="ident" id="2870761">WriteString</span><span class="op" id="2870772">(</span><span class="ident" id="2870773">s</span><span class="op" id="2870774">[</span><span class="ident" id="2870775">written</span><span class="op" id="2870782">:</span><span class="op" id="2870783">]</span><span class="op" id="2870784">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2870787">return</span>&nbsp;<span class="ident" id="2870794">b</span><span class="op" id="2870795">.</span><span class="ident" id="2870796">String</span><span class="op" id="2870802">(</span><span class="op" id="2870803">)</span><br>
<span class="lineno"></span><span class="op" id="2870805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2870808">var</span>&nbsp;<span class="ident" id="2870812">jsStrReplacementTable</span>&nbsp;<span class="op" id="2870834">=</span>&nbsp;<span class="op" id="2870836">[</span><span class="op" id="2870837">]</span><span class="builtintype" id="2870838">string</span><span class="op" id="2870844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="2870847">0</span><span class="op" id="2870848">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2870853">`\0`</span><span class="op" id="2870857">,</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2870860">&#39;\t&#39;</span><span class="op" id="2870864">:</span>&nbsp;<span class="string" id="2870866">`\t`</span><span class="op" id="2870870">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2870873">&#39;\n&#39;</span><span class="op" id="2870877">:</span>&nbsp;<span class="string" id="2870879">`\n`</span><span class="op" id="2870883">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2870886">&#39;\v&#39;</span><span class="op" id="2870890">:</span>&nbsp;<span class="string" id="2870892">`\x0b`</span><span class="op" id="2870898">,</span>&nbsp;<span class="comment" id="2870900">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2870925">&#39;\f&#39;</span><span class="op" id="2870929">:</span>&nbsp;<span class="string" id="2870931">`\f`</span><span class="op" id="2870935">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2870938">&#39;\r&#39;</span><span class="op" id="2870942">:</span>&nbsp;<span class="string" id="2870944">`\r`</span><span class="op" id="2870948">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2870951">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2871013">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871062">&#39;&#34;&#39;</span><span class="op" id="2871065">:</span>&nbsp;&nbsp;<span class="string" id="2871068">`\x22`</span><span class="op" id="2871074">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871077">&#39;&amp;&#39;</span><span class="op" id="2871080">:</span>&nbsp;&nbsp;<span class="string" id="2871083">`\x26`</span><span class="op" id="2871089">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871092">&#39;\&#39;&#39;</span><span class="op" id="2871096">:</span>&nbsp;<span class="string" id="2871098">`\x27`</span><span class="op" id="2871104">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871107">&#39;+&#39;</span><span class="op" id="2871110">:</span>&nbsp;&nbsp;<span class="string" id="2871113">`\x2b`</span><span class="op" id="2871119">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871122">&#39;/&#39;</span><span class="op" id="2871125">:</span>&nbsp;&nbsp;<span class="string" id="2871128">`\/`</span><span class="op" id="2871132">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871135">&#39;&lt;&#39;</span><span class="op" id="2871138">:</span>&nbsp;&nbsp;<span class="string" id="2871141">`\x3c`</span><span class="op" id="2871147">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871150">&#39;&gt;&#39;</span><span class="op" id="2871153">:</span>&nbsp;&nbsp;<span class="string" id="2871156">`\x3e`</span><span class="op" id="2871162">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871165">&#39;\\&#39;</span><span class="op" id="2871169">:</span>&nbsp;<span class="string" id="2871171">`\\`</span><span class="op" id="2871175">,</span><br>
<span class="lineno">290</span><span class="op" id="2871177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2871180">//&nbsp;jsStrNormReplacementTable&nbsp;is&nbsp;like&nbsp;jsStrReplacementTable&nbsp;but&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="2871252">//&nbsp;overencode&nbsp;existing&nbsp;escapes&nbsp;since&nbsp;this&nbsp;table&nbsp;has&nbsp;no&nbsp;entry&nbsp;for&nbsp;`\`.</span><br>
<span class="lineno"></span><span class="keyword" id="2871322">var</span>&nbsp;<span class="ident" id="2871326">jsStrNormReplacementTable</span>&nbsp;<span class="op" id="2871352">=</span>&nbsp;<span class="op" id="2871354">[</span><span class="op" id="2871355">]</span><span class="builtintype" id="2871356">string</span><span class="op" id="2871362">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="2871365">0</span><span class="op" id="2871366">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2871371">`\0`</span><span class="op" id="2871375">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871378">&#39;\t&#39;</span><span class="op" id="2871382">:</span>&nbsp;<span class="string" id="2871384">`\t`</span><span class="op" id="2871388">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871391">&#39;\n&#39;</span><span class="op" id="2871395">:</span>&nbsp;<span class="string" id="2871397">`\n`</span><span class="op" id="2871401">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871404">&#39;\v&#39;</span><span class="op" id="2871408">:</span>&nbsp;<span class="string" id="2871410">`\x0b`</span><span class="op" id="2871416">,</span>&nbsp;<span class="comment" id="2871418">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871443">&#39;\f&#39;</span><span class="op" id="2871447">:</span>&nbsp;<span class="string" id="2871449">`\f`</span><span class="op" id="2871453">,</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871456">&#39;\r&#39;</span><span class="op" id="2871460">:</span>&nbsp;<span class="string" id="2871462">`\r`</span><span class="op" id="2871466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2871469">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2871531">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871580">&#39;&#34;&#39;</span><span class="op" id="2871583">:</span>&nbsp;&nbsp;<span class="string" id="2871586">`\x22`</span><span class="op" id="2871592">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871595">&#39;&amp;&#39;</span><span class="op" id="2871598">:</span>&nbsp;&nbsp;<span class="string" id="2871601">`\x26`</span><span class="op" id="2871607">,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871610">&#39;\&#39;&#39;</span><span class="op" id="2871614">:</span>&nbsp;<span class="string" id="2871616">`\x27`</span><span class="op" id="2871622">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871625">&#39;+&#39;</span><span class="op" id="2871628">:</span>&nbsp;&nbsp;<span class="string" id="2871631">`\x2b`</span><span class="op" id="2871637">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871640">&#39;/&#39;</span><span class="op" id="2871643">:</span>&nbsp;&nbsp;<span class="string" id="2871646">`\/`</span><span class="op" id="2871650">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871653">&#39;&lt;&#39;</span><span class="op" id="2871656">:</span>&nbsp;&nbsp;<span class="string" id="2871659">`\x3c`</span><span class="op" id="2871665">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871668">&#39;&gt;&#39;</span><span class="op" id="2871671">:</span>&nbsp;&nbsp;<span class="string" id="2871674">`\x3e`</span><span class="op" id="2871680">,</span><br>
<span class="lineno">310</span><span class="op" id="2871682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2871685">var</span>&nbsp;<span class="ident" id="2871689">jsRegexpReplacementTable</span>&nbsp;<span class="op" id="2871714">=</span>&nbsp;<span class="op" id="2871716">[</span><span class="op" id="2871717">]</span><span class="builtintype" id="2871718">string</span><span class="op" id="2871724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="2871727">0</span><span class="op" id="2871728">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2871733">`\0`</span><span class="op" id="2871737">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871740">&#39;\t&#39;</span><span class="op" id="2871744">:</span>&nbsp;<span class="string" id="2871746">`\t`</span><span class="op" id="2871750">,</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871753">&#39;\n&#39;</span><span class="op" id="2871757">:</span>&nbsp;<span class="string" id="2871759">`\n`</span><span class="op" id="2871763">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871766">&#39;\v&#39;</span><span class="op" id="2871770">:</span>&nbsp;<span class="string" id="2871772">`\x0b`</span><span class="op" id="2871778">,</span>&nbsp;<span class="comment" id="2871780">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871805">&#39;\f&#39;</span><span class="op" id="2871809">:</span>&nbsp;<span class="string" id="2871811">`\f`</span><span class="op" id="2871815">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871818">&#39;\r&#39;</span><span class="op" id="2871822">:</span>&nbsp;<span class="string" id="2871824">`\r`</span><span class="op" id="2871828">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2871831">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2871893">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871942">&#39;&#34;&#39;</span><span class="op" id="2871945">:</span>&nbsp;&nbsp;<span class="string" id="2871948">`\x22`</span><span class="op" id="2871954">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871957">&#39;$&#39;</span><span class="op" id="2871960">:</span>&nbsp;&nbsp;<span class="string" id="2871963">`\$`</span><span class="op" id="2871967">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871970">&#39;&amp;&#39;</span><span class="op" id="2871973">:</span>&nbsp;&nbsp;<span class="string" id="2871976">`\x26`</span><span class="op" id="2871982">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2871985">&#39;\&#39;&#39;</span><span class="op" id="2871989">:</span>&nbsp;<span class="string" id="2871991">`\x27`</span><span class="op" id="2871997">,</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872000">&#39;(&#39;</span><span class="op" id="2872003">:</span>&nbsp;&nbsp;<span class="string" id="2872006">`\(`</span><span class="op" id="2872010">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872013">&#39;)&#39;</span><span class="op" id="2872016">:</span>&nbsp;&nbsp;<span class="string" id="2872019">`\)`</span><span class="op" id="2872023">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872026">&#39;*&#39;</span><span class="op" id="2872029">:</span>&nbsp;&nbsp;<span class="string" id="2872032">`\*`</span><span class="op" id="2872036">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872039">&#39;+&#39;</span><span class="op" id="2872042">:</span>&nbsp;&nbsp;<span class="string" id="2872045">`\x2b`</span><span class="op" id="2872051">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872054">&#39;-&#39;</span><span class="op" id="2872057">:</span>&nbsp;&nbsp;<span class="string" id="2872060">`\-`</span><span class="op" id="2872064">,</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872067">&#39;.&#39;</span><span class="op" id="2872070">:</span>&nbsp;&nbsp;<span class="string" id="2872073">`\.`</span><span class="op" id="2872077">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872080">&#39;/&#39;</span><span class="op" id="2872083">:</span>&nbsp;&nbsp;<span class="string" id="2872086">`\/`</span><span class="op" id="2872090">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872093">&#39;&lt;&#39;</span><span class="op" id="2872096">:</span>&nbsp;&nbsp;<span class="string" id="2872099">`\x3c`</span><span class="op" id="2872105">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872108">&#39;&gt;&#39;</span><span class="op" id="2872111">:</span>&nbsp;&nbsp;<span class="string" id="2872114">`\x3e`</span><span class="op" id="2872120">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872123">&#39;?&#39;</span><span class="op" id="2872126">:</span>&nbsp;&nbsp;<span class="string" id="2872129">`\?`</span><span class="op" id="2872133">,</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872136">&#39;[&#39;</span><span class="op" id="2872139">:</span>&nbsp;&nbsp;<span class="string" id="2872142">`\[`</span><span class="op" id="2872146">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872149">&#39;\\&#39;</span><span class="op" id="2872153">:</span>&nbsp;<span class="string" id="2872155">`\\`</span><span class="op" id="2872159">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872162">&#39;]&#39;</span><span class="op" id="2872165">:</span>&nbsp;&nbsp;<span class="string" id="2872168">`\]`</span><span class="op" id="2872172">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872175">&#39;^&#39;</span><span class="op" id="2872178">:</span>&nbsp;&nbsp;<span class="string" id="2872181">`\^`</span><span class="op" id="2872185">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872188">&#39;{&#39;</span><span class="op" id="2872191">:</span>&nbsp;&nbsp;<span class="string" id="2872194">`\{`</span><span class="op" id="2872198">,</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872201">&#39;|&#39;</span><span class="op" id="2872204">:</span>&nbsp;&nbsp;<span class="string" id="2872207">`\|`</span><span class="op" id="2872211">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2872214">&#39;}&#39;</span><span class="op" id="2872217">:</span>&nbsp;&nbsp;<span class="string" id="2872220">`\}`</span><span class="op" id="2872224">,</span><br>
<span class="lineno"></span><span class="op" id="2872226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2872229">//&nbsp;isJSIdentPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;given&nbsp;rune&nbsp;is&nbsp;a&nbsp;JS&nbsp;identifier&nbsp;part.</span><br>
<span class="lineno">345</span><span class="comment" id="2872302">//&nbsp;It&nbsp;does&nbsp;not&nbsp;handle&nbsp;all&nbsp;the&nbsp;non-Latin&nbsp;letters,&nbsp;joiners,&nbsp;and&nbsp;combining&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="2872381">//&nbsp;but&nbsp;it&nbsp;does&nbsp;handle&nbsp;every&nbsp;codepoint&nbsp;that&nbsp;can&nbsp;occur&nbsp;in&nbsp;a&nbsp;numeric&nbsp;literal&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="2872458">//&nbsp;a&nbsp;keyword.</span><br>
<span class="lineno"></span><span class="keyword" id="2872472">func</span>&nbsp;<span class="ident" id="2872477">isJSIdentPart</span><span class="op" id="2872490">(</span><span class="ident" id="2872491">r</span>&nbsp;<span class="builtintype" id="2872493">rune</span><span class="op" id="2872497">)</span>&nbsp;<span class="builtintype" id="2872499">bool</span>&nbsp;<span class="op" id="2872504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2872507">switch</span>&nbsp;<span class="op" id="2872514">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2872517">case</span>&nbsp;<span class="ident" id="2872522">r</span>&nbsp;<span class="op" id="2872524">==</span>&nbsp;<span class="string" id="2872527">&#39;$&#39;</span><span class="op" id="2872530">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2872534">return</span>&nbsp;<span class="builtintype" id="2872541">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2872547">case</span>&nbsp;<span class="string" id="2872552">&#39;0&#39;</span>&nbsp;<span class="op" id="2872556">&lt;=</span>&nbsp;<span class="ident" id="2872559">r</span>&nbsp;<span class="op" id="2872561">&amp;&amp;</span>&nbsp;<span class="ident" id="2872564">r</span>&nbsp;<span class="op" id="2872566">&lt;=</span>&nbsp;<span class="string" id="2872569">&#39;9&#39;</span><span class="op" id="2872572">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2872576">return</span>&nbsp;<span class="builtintype" id="2872583">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2872589">case</span>&nbsp;<span class="string" id="2872594">&#39;A&#39;</span>&nbsp;<span class="op" id="2872598">&lt;=</span>&nbsp;<span class="ident" id="2872601">r</span>&nbsp;<span class="op" id="2872603">&amp;&amp;</span>&nbsp;<span class="ident" id="2872606">r</span>&nbsp;<span class="op" id="2872608">&lt;=</span>&nbsp;<span class="string" id="2872611">&#39;Z&#39;</span><span class="op" id="2872614">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2872618">return</span>&nbsp;<span class="builtintype" id="2872625">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2872631">case</span>&nbsp;<span class="ident" id="2872636">r</span>&nbsp;<span class="op" id="2872638">==</span>&nbsp;<span class="string" id="2872641">&#39;_&#39;</span><span class="op" id="2872644">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2872648">return</span>&nbsp;<span class="builtintype" id="2872655">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2872661">case</span>&nbsp;<span class="string" id="2872666">&#39;a&#39;</span>&nbsp;<span class="op" id="2872670">&lt;=</span>&nbsp;<span class="ident" id="2872673">r</span>&nbsp;<span class="op" id="2872675">&amp;&amp;</span>&nbsp;<span class="ident" id="2872678">r</span>&nbsp;<span class="op" id="2872680">&lt;=</span>&nbsp;<span class="string" id="2872683">&#39;z&#39;</span><span class="op" id="2872686">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2872690">return</span>&nbsp;<span class="builtintype" id="2872697">true</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2872703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2872706">return</span>&nbsp;<span class="builtintype" id="2872713">false</span><br>
<span class="lineno"></span><span class="op" id="2872719">}</span>
</div>
</body>
</html>
