<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1368888">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1368943">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1368997">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1369048">package</span>&nbsp;<span class="ident" id="1369056">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1369062">import</span>&nbsp;<span class="op" id="1369069">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1369072">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1369083">&#34;sync/atomic&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1369098">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1369107">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1369110">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;temporary&nbsp;objects&nbsp;that&nbsp;may&nbsp;be&nbsp;individually&nbsp;saved&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1369185">//&nbsp;retrieved.</span><br>
<span class="lineno">15</span><span class="comment" id="1369199">//</span><br>
<span class="lineno"></span><span class="comment" id="1369202">//&nbsp;Any&nbsp;item&nbsp;stored&nbsp;in&nbsp;the&nbsp;Pool&nbsp;may&nbsp;be&nbsp;removed&nbsp;automatically&nbsp;at&nbsp;any&nbsp;time&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="1369282">//&nbsp;notification.&nbsp;If&nbsp;the&nbsp;Pool&nbsp;holds&nbsp;the&nbsp;only&nbsp;reference&nbsp;when&nbsp;this&nbsp;happens,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1369359">//&nbsp;item&nbsp;might&nbsp;be&nbsp;deallocated.</span><br>
<span class="lineno"></span><span class="comment" id="1369389">//</span><br>
<span class="lineno">20</span><span class="comment" id="1369392">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;safe&nbsp;for&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="1369457">//</span><br>
<span class="lineno"></span><span class="comment" id="1369460">//&nbsp;Pool&#39;s&nbsp;purpose&nbsp;is&nbsp;to&nbsp;cache&nbsp;allocated&nbsp;but&nbsp;unused&nbsp;items&nbsp;for&nbsp;later&nbsp;reuse,</span><br>
<span class="lineno"></span><span class="comment" id="1369534">//&nbsp;relieving&nbsp;pressure&nbsp;on&nbsp;the&nbsp;garbage&nbsp;collector.&nbsp;That&nbsp;is,&nbsp;it&nbsp;makes&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1369611">//&nbsp;build&nbsp;efficient,&nbsp;thread-safe&nbsp;free&nbsp;lists.&nbsp;However,&nbsp;it&nbsp;is&nbsp;not&nbsp;suitable&nbsp;for&nbsp;all</span><br>
<span class="lineno">25</span><span class="comment" id="1369691">//&nbsp;free&nbsp;lists.</span><br>
<span class="lineno"></span><span class="comment" id="1369706">//</span><br>
<span class="lineno"></span><span class="comment" id="1369709">//&nbsp;An&nbsp;appropriate&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;to&nbsp;manage&nbsp;a&nbsp;group&nbsp;of&nbsp;temporary&nbsp;items</span><br>
<span class="lineno"></span><span class="comment" id="1369781">//&nbsp;silently&nbsp;shared&nbsp;among&nbsp;and&nbsp;potentially&nbsp;reused&nbsp;by&nbsp;concurrent&nbsp;independent</span><br>
<span class="lineno"></span><span class="comment" id="1369855">//&nbsp;clients&nbsp;of&nbsp;a&nbsp;package.&nbsp;Pool&nbsp;provides&nbsp;a&nbsp;way&nbsp;to&nbsp;amortize&nbsp;allocation&nbsp;overhead</span><br>
<span class="lineno">30</span><span class="comment" id="1369932">//&nbsp;across&nbsp;many&nbsp;clients.</span><br>
<span class="lineno"></span><span class="comment" id="1369956">//</span><br>
<span class="lineno"></span><span class="comment" id="1369959">//&nbsp;An&nbsp;example&nbsp;of&nbsp;good&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;in&nbsp;the&nbsp;fmt&nbsp;package,&nbsp;which&nbsp;maintains&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1370036">//&nbsp;dynamically-sized&nbsp;store&nbsp;of&nbsp;temporary&nbsp;output&nbsp;buffers.&nbsp;The&nbsp;store&nbsp;scales&nbsp;under</span><br>
<span class="lineno"></span><span class="comment" id="1370115">//&nbsp;load&nbsp;(when&nbsp;many&nbsp;goroutines&nbsp;are&nbsp;actively&nbsp;printing)&nbsp;and&nbsp;shrinks&nbsp;when</span><br>
<span class="lineno">35</span><span class="comment" id="1370185">//&nbsp;quiescent.</span><br>
<span class="lineno"></span><span class="comment" id="1370199">//</span><br>
<span class="lineno"></span><span class="comment" id="1370202">//&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;a&nbsp;free&nbsp;list&nbsp;maintained&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;short-lived&nbsp;object&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1370282">//&nbsp;not&nbsp;a&nbsp;suitable&nbsp;use&nbsp;for&nbsp;a&nbsp;Pool,&nbsp;since&nbsp;the&nbsp;overhead&nbsp;does&nbsp;not&nbsp;amortize&nbsp;well&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1370361">//&nbsp;that&nbsp;scenario.&nbsp;It&nbsp;is&nbsp;more&nbsp;efficient&nbsp;to&nbsp;have&nbsp;such&nbsp;objects&nbsp;implement&nbsp;their&nbsp;own</span><br>
<span class="lineno">40</span><span class="comment" id="1370441">//&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="1370455">//</span><br>
<span class="lineno"></span><span class="keyword" id="1370458">type</span>&nbsp;<span class="ident" id="1370463">Pool</span>&nbsp;<span class="keyword" id="1370468">struct</span>&nbsp;<span class="op" id="1370475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370478">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1370488">unsafe</span><span class="op" id="1370494">.</span><span class="ident" id="1370495">Pointer</span>&nbsp;<span class="comment" id="1370503">//&nbsp;local&nbsp;fixed-size&nbsp;per-P&nbsp;pool,&nbsp;actual&nbsp;type&nbsp;is&nbsp;[P]poolLocal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370564">localSize</span>&nbsp;<span class="builtintype" id="1370574">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1370589">//&nbsp;size&nbsp;of&nbsp;the&nbsp;local&nbsp;array</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370618">//&nbsp;New&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;generate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370670">//&nbsp;a&nbsp;value&nbsp;when&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1370719">//&nbsp;It&nbsp;may&nbsp;not&nbsp;be&nbsp;changed&nbsp;concurrently&nbsp;with&nbsp;calls&nbsp;to&nbsp;Get.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370777">New</span>&nbsp;<span class="keyword" id="1370781">func</span><span class="op" id="1370785">(</span><span class="op" id="1370786">)</span>&nbsp;<span class="keyword" id="1370788">interface</span><span class="op" id="1370797">{</span><span class="op" id="1370798">}</span><br>
<span class="lineno">50</span><span class="op" id="1370800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1370803">//&nbsp;Local&nbsp;per-P&nbsp;Pool&nbsp;appendix.</span><br>
<span class="lineno"></span><span class="keyword" id="1370833">type</span>&nbsp;<span class="ident" id="1370838">poolLocal</span>&nbsp;<span class="keyword" id="1370848">struct</span>&nbsp;<span class="op" id="1370855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370858">private</span>&nbsp;<span class="keyword" id="1370866">interface</span><span class="op" id="1370875">{</span><span class="op" id="1370876">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1370880">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;only&nbsp;by&nbsp;the&nbsp;respective&nbsp;P.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370922">shared</span>&nbsp;&nbsp;<span class="op" id="1370930">[</span><span class="op" id="1370931">]</span><span class="keyword" id="1370932">interface</span><span class="op" id="1370941">{</span><span class="op" id="1370942">}</span>&nbsp;<span class="comment" id="1370944">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;by&nbsp;any&nbsp;P.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1370970">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1370992">//&nbsp;Protects&nbsp;shared.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371013">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1371021">[</span><span class="num" id="1371022">128</span><span class="op" id="1371025">]</span><span class="builtintype" id="1371026">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1371035">//&nbsp;Prevents&nbsp;false&nbsp;sharing.</span><br>
<span class="lineno"></span><span class="op" id="1371062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1371065">//&nbsp;Put&nbsp;adds&nbsp;x&nbsp;to&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1371092">func</span>&nbsp;<span class="op" id="1371097">(</span><span class="ident" id="1371098">p</span>&nbsp;<span class="op" id="1371100">*</span><span class="ident" id="1371101">Pool</span><span class="op" id="1371105">)</span>&nbsp;<span class="ident" id="1371107">Put</span><span class="op" id="1371110">(</span><span class="ident" id="1371111">x</span>&nbsp;<span class="keyword" id="1371113">interface</span><span class="op" id="1371122">{</span><span class="op" id="1371123">}</span><span class="op" id="1371124">)</span>&nbsp;<span class="op" id="1371126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371129">if</span>&nbsp;<span class="ident" id="1371132">raceenabled</span>&nbsp;<span class="op" id="1371144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1371148">//&nbsp;Under&nbsp;race&nbsp;detector&nbsp;the&nbsp;Pool&nbsp;degenerates&nbsp;into&nbsp;no-op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1371206">//&nbsp;It&#39;s&nbsp;conforming,&nbsp;simple&nbsp;and&nbsp;does&nbsp;not&nbsp;introduce&nbsp;excessive</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1371268">//&nbsp;happens-before&nbsp;edges&nbsp;between&nbsp;unrelated&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371324">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371335">if</span>&nbsp;<span class="ident" id="1371338">x</span>&nbsp;<span class="op" id="1371340">==</span>&nbsp;<span class="ident" id="1371343">nil</span>&nbsp;<span class="op" id="1371347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371351">return</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371362">l</span>&nbsp;<span class="op" id="1371364">:=</span>&nbsp;<span class="ident" id="1371367">p</span><span class="op" id="1371368">.</span><span class="ident" id="1371369">pin</span><span class="op" id="1371372">(</span><span class="op" id="1371373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371376">if</span>&nbsp;<span class="ident" id="1371379">l</span><span class="op" id="1371380">.</span><span class="ident" id="1371381">private</span>&nbsp;<span class="op" id="1371389">==</span>&nbsp;<span class="ident" id="1371392">nil</span>&nbsp;<span class="op" id="1371396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371400">l</span><span class="op" id="1371401">.</span><span class="ident" id="1371402">private</span>&nbsp;<span class="op" id="1371410">=</span>&nbsp;<span class="ident" id="1371412">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371416">x</span>&nbsp;<span class="op" id="1371418">=</span>&nbsp;<span class="ident" id="1371420">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371428">runtime_procUnpin</span><span class="op" id="1371445">(</span><span class="op" id="1371446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371449">if</span>&nbsp;<span class="ident" id="1371452">x</span>&nbsp;<span class="op" id="1371454">==</span>&nbsp;<span class="ident" id="1371457">nil</span>&nbsp;<span class="op" id="1371461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371465">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1371473">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371476">l</span><span class="op" id="1371477">.</span><span class="ident" id="1371478">Lock</span><span class="op" id="1371482">(</span><span class="op" id="1371483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371486">l</span><span class="op" id="1371487">.</span><span class="ident" id="1371488">shared</span>&nbsp;<span class="op" id="1371495">=</span>&nbsp;<span class="builtinfunc" id="1371497">append</span><span class="op" id="1371503">(</span><span class="ident" id="1371504">l</span><span class="op" id="1371505">.</span><span class="ident" id="1371506">shared</span><span class="op" id="1371512">,</span>&nbsp;<span class="ident" id="1371514">x</span><span class="op" id="1371515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1371518">l</span><span class="op" id="1371519">.</span><span class="ident" id="1371520">Unlock</span><span class="op" id="1371526">(</span><span class="op" id="1371527">)</span><br>
<span class="lineno"></span><span class="op" id="1371529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="1371532">//&nbsp;Get&nbsp;selects&nbsp;an&nbsp;arbitrary&nbsp;item&nbsp;from&nbsp;the&nbsp;Pool,&nbsp;removes&nbsp;it&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1371600">//&nbsp;Pool,&nbsp;and&nbsp;returns&nbsp;it&nbsp;to&nbsp;the&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment" id="1371639">//&nbsp;Get&nbsp;may&nbsp;choose&nbsp;to&nbsp;ignore&nbsp;the&nbsp;pool&nbsp;and&nbsp;treat&nbsp;it&nbsp;as&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="1371699">//&nbsp;Callers&nbsp;should&nbsp;not&nbsp;assume&nbsp;any&nbsp;relation&nbsp;between&nbsp;values&nbsp;passed&nbsp;to&nbsp;Put&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1371774">//&nbsp;the&nbsp;values&nbsp;returned&nbsp;by&nbsp;Get.</span><br>
<span class="lineno">90</span><span class="comment" id="1371805">//</span><br>
<span class="lineno"></span><span class="comment" id="1371808">//&nbsp;If&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil&nbsp;and&nbsp;p.New&nbsp;is&nbsp;non-nil,&nbsp;Get&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="1371879">//&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;p.New.</span><br>
<span class="lineno"></span><span class="keyword" id="1371911">func</span>&nbsp;<span class="op" id="1371916">(</span><span class="ident" id="1371917">p</span>&nbsp;<span class="op" id="1371919">*</span><span class="ident" id="1371920">Pool</span><span class="op" id="1371924">)</span>&nbsp;<span class="ident" id="1371926">Get</span><span class="op" id="1371929">(</span><span class="op" id="1371930">)</span>&nbsp;<span class="keyword" id="1371932">interface</span><span class="op" id="1371941">{</span><span class="op" id="1371942">}</span>&nbsp;<span class="op" id="1371944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371947">if</span>&nbsp;<span class="ident" id="1371950">raceenabled</span>&nbsp;<span class="op" id="1371962">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371966">if</span>&nbsp;<span class="ident" id="1371969">p</span><span class="op" id="1371970">.</span><span class="ident" id="1371971">New</span>&nbsp;<span class="op" id="1371975">!=</span>&nbsp;<span class="ident" id="1371978">nil</span>&nbsp;<span class="op" id="1371982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1371987">return</span>&nbsp;<span class="ident" id="1371994">p</span><span class="op" id="1371995">.</span><span class="ident" id="1371996">New</span><span class="op" id="1371999">(</span><span class="op" id="1372000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1372004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372008">return</span>&nbsp;<span class="ident" id="1372015">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1372020">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372023">l</span>&nbsp;<span class="op" id="1372025">:=</span>&nbsp;<span class="ident" id="1372028">p</span><span class="op" id="1372029">.</span><span class="ident" id="1372030">pin</span><span class="op" id="1372033">(</span><span class="op" id="1372034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372037">x</span>&nbsp;<span class="op" id="1372039">:=</span>&nbsp;<span class="ident" id="1372042">l</span><span class="op" id="1372043">.</span><span class="ident" id="1372044">private</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372053">l</span><span class="op" id="1372054">.</span><span class="ident" id="1372055">private</span>&nbsp;<span class="op" id="1372063">=</span>&nbsp;<span class="ident" id="1372065">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372070">runtime_procUnpin</span><span class="op" id="1372087">(</span><span class="op" id="1372088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372091">if</span>&nbsp;<span class="ident" id="1372094">x</span>&nbsp;<span class="op" id="1372096">!=</span>&nbsp;<span class="ident" id="1372099">nil</span>&nbsp;<span class="op" id="1372103">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372107">return</span>&nbsp;<span class="ident" id="1372114">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1372117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372120">l</span><span class="op" id="1372121">.</span><span class="ident" id="1372122">Lock</span><span class="op" id="1372126">(</span><span class="op" id="1372127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372130">last</span>&nbsp;<span class="op" id="1372135">:=</span>&nbsp;<span class="builtinfunc" id="1372138">len</span><span class="op" id="1372141">(</span><span class="ident" id="1372142">l</span><span class="op" id="1372143">.</span><span class="ident" id="1372144">shared</span><span class="op" id="1372150">)</span>&nbsp;<span class="op" id="1372152">-</span>&nbsp;<span class="num" id="1372154">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372157">if</span>&nbsp;<span class="ident" id="1372160">last</span>&nbsp;<span class="op" id="1372165">&gt;=</span>&nbsp;<span class="num" id="1372168">0</span>&nbsp;<span class="op" id="1372170">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372174">x</span>&nbsp;<span class="op" id="1372176">=</span>&nbsp;<span class="ident" id="1372178">l</span><span class="op" id="1372179">.</span><span class="ident" id="1372180">shared</span><span class="op" id="1372186">[</span><span class="ident" id="1372187">last</span><span class="op" id="1372191">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372195">l</span><span class="op" id="1372196">.</span><span class="ident" id="1372197">shared</span>&nbsp;<span class="op" id="1372204">=</span>&nbsp;<span class="ident" id="1372206">l</span><span class="op" id="1372207">.</span><span class="ident" id="1372208">shared</span><span class="op" id="1372214">[</span><span class="op" id="1372215">:</span><span class="ident" id="1372216">last</span><span class="op" id="1372220">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1372223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372226">l</span><span class="op" id="1372227">.</span><span class="ident" id="1372228">Unlock</span><span class="op" id="1372234">(</span><span class="op" id="1372235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372238">if</span>&nbsp;<span class="ident" id="1372241">x</span>&nbsp;<span class="op" id="1372243">!=</span>&nbsp;<span class="ident" id="1372246">nil</span>&nbsp;<span class="op" id="1372250">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372254">return</span>&nbsp;<span class="ident" id="1372261">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1372264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372267">return</span>&nbsp;<span class="ident" id="1372274">p</span><span class="op" id="1372275">.</span><span class="ident" id="1372276">getSlow</span><span class="op" id="1372283">(</span><span class="op" id="1372284">)</span><br>
<span class="lineno"></span><span class="op" id="1372286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="1372289">func</span>&nbsp;<span class="op" id="1372294">(</span><span class="ident" id="1372295">p</span>&nbsp;<span class="op" id="1372297">*</span><span class="ident" id="1372298">Pool</span><span class="op" id="1372302">)</span>&nbsp;<span class="ident" id="1372304">getSlow</span><span class="op" id="1372311">(</span><span class="op" id="1372312">)</span>&nbsp;<span class="op" id="1372314">(</span><span class="ident" id="1372315">x</span>&nbsp;<span class="keyword" id="1372317">interface</span><span class="op" id="1372326">{</span><span class="op" id="1372327">}</span><span class="op" id="1372328">)</span>&nbsp;<span class="op" id="1372330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1372333">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;pin&nbsp;regarding&nbsp;ordering&nbsp;of&nbsp;the&nbsp;loads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372393">size</span>&nbsp;<span class="op" id="1372398">:=</span>&nbsp;<span class="ident" id="1372401">atomic</span><span class="op" id="1372407">.</span><span class="ident" id="1372408">LoadUintptr</span><span class="op" id="1372419">(</span><span class="op" id="1372420">&amp;</span><span class="ident" id="1372421">p</span><span class="op" id="1372422">.</span><span class="ident" id="1372423">localSize</span><span class="op" id="1372432">)</span>&nbsp;<span class="comment" id="1372434">//&nbsp;load-acquire</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372451">local</span>&nbsp;<span class="op" id="1372457">:=</span>&nbsp;<span class="ident" id="1372460">p</span><span class="op" id="1372461">.</span><span class="ident" id="1372462">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1372492">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1372509">//&nbsp;Try&nbsp;to&nbsp;steal&nbsp;one&nbsp;element&nbsp;from&nbsp;other&nbsp;procs.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372556">pid</span>&nbsp;<span class="op" id="1372560">:=</span>&nbsp;<span class="ident" id="1372563">runtime_procPin</span><span class="op" id="1372578">(</span><span class="op" id="1372579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372582">runtime_procUnpin</span><span class="op" id="1372599">(</span><span class="op" id="1372600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372603">for</span>&nbsp;<span class="ident" id="1372607">i</span>&nbsp;<span class="op" id="1372609">:=</span>&nbsp;<span class="num" id="1372612">0</span><span class="op" id="1372613">;</span>&nbsp;<span class="ident" id="1372615">i</span>&nbsp;<span class="op" id="1372617">&lt;</span>&nbsp;<span class="builtintype" id="1372619">int</span><span class="op" id="1372622">(</span><span class="ident" id="1372623">size</span><span class="op" id="1372627">)</span><span class="op" id="1372628">;</span>&nbsp;<span class="ident" id="1372630">i</span><span class="op" id="1372631">++</span>&nbsp;<span class="op" id="1372634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372638">l</span>&nbsp;<span class="op" id="1372640">:=</span>&nbsp;<span class="ident" id="1372643">indexLocal</span><span class="op" id="1372653">(</span><span class="ident" id="1372654">local</span><span class="op" id="1372659">,</span>&nbsp;<span class="op" id="1372661">(</span><span class="ident" id="1372662">pid</span><span class="op" id="1372665">+</span><span class="ident" id="1372666">i</span><span class="op" id="1372667">+</span><span class="num" id="1372668">1</span><span class="op" id="1372669">)</span><span class="op" id="1372670">%</span><span class="builtintype" id="1372671">int</span><span class="op" id="1372674">(</span><span class="ident" id="1372675">size</span><span class="op" id="1372679">)</span><span class="op" id="1372680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372684">l</span><span class="op" id="1372685">.</span><span class="ident" id="1372686">Lock</span><span class="op" id="1372690">(</span><span class="op" id="1372691">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372695">last</span>&nbsp;<span class="op" id="1372700">:=</span>&nbsp;<span class="builtinfunc" id="1372703">len</span><span class="op" id="1372706">(</span><span class="ident" id="1372707">l</span><span class="op" id="1372708">.</span><span class="ident" id="1372709">shared</span><span class="op" id="1372715">)</span>&nbsp;<span class="op" id="1372717">-</span>&nbsp;<span class="num" id="1372719">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372723">if</span>&nbsp;<span class="ident" id="1372726">last</span>&nbsp;<span class="op" id="1372731">&gt;=</span>&nbsp;<span class="num" id="1372734">0</span>&nbsp;<span class="op" id="1372736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372741">x</span>&nbsp;<span class="op" id="1372743">=</span>&nbsp;<span class="ident" id="1372745">l</span><span class="op" id="1372746">.</span><span class="ident" id="1372747">shared</span><span class="op" id="1372753">[</span><span class="ident" id="1372754">last</span><span class="op" id="1372758">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372763">l</span><span class="op" id="1372764">.</span><span class="ident" id="1372765">shared</span>&nbsp;<span class="op" id="1372772">=</span>&nbsp;<span class="ident" id="1372774">l</span><span class="op" id="1372775">.</span><span class="ident" id="1372776">shared</span><span class="op" id="1372782">[</span><span class="op" id="1372783">:</span><span class="ident" id="1372784">last</span><span class="op" id="1372788">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372793">l</span><span class="op" id="1372794">.</span><span class="ident" id="1372795">Unlock</span><span class="op" id="1372801">(</span><span class="op" id="1372802">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372807">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1372815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372819">l</span><span class="op" id="1372820">.</span><span class="ident" id="1372821">Unlock</span><span class="op" id="1372827">(</span><span class="op" id="1372828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1372831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372835">if</span>&nbsp;<span class="ident" id="1372838">x</span>&nbsp;<span class="op" id="1372840">==</span>&nbsp;<span class="ident" id="1372843">nil</span>&nbsp;<span class="op" id="1372847">&amp;&amp;</span>&nbsp;<span class="ident" id="1372850">p</span><span class="op" id="1372851">.</span><span class="ident" id="1372852">New</span>&nbsp;<span class="op" id="1372856">!=</span>&nbsp;<span class="ident" id="1372859">nil</span>&nbsp;<span class="op" id="1372863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1372867">x</span>&nbsp;<span class="op" id="1372869">=</span>&nbsp;<span class="ident" id="1372871">p</span><span class="op" id="1372872">.</span><span class="ident" id="1372873">New</span><span class="op" id="1372876">(</span><span class="op" id="1372877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1372880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1372883">return</span>&nbsp;<span class="ident" id="1372890">x</span><br>
<span class="lineno"></span><span class="op" id="1372892">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment" id="1372895">//&nbsp;pin&nbsp;pins&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;to&nbsp;P,&nbsp;disables&nbsp;preemption&nbsp;and&nbsp;returns&nbsp;poolLocal&nbsp;pool&nbsp;for&nbsp;the&nbsp;P.</span><br>
<span class="lineno"></span><span class="comment" id="1372993">//&nbsp;Caller&nbsp;must&nbsp;call&nbsp;runtime_procUnpin()&nbsp;when&nbsp;done&nbsp;with&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1373058">func</span>&nbsp;<span class="op" id="1373063">(</span><span class="ident" id="1373064">p</span>&nbsp;<span class="op" id="1373066">*</span><span class="ident" id="1373067">Pool</span><span class="op" id="1373071">)</span>&nbsp;<span class="ident" id="1373073">pin</span><span class="op" id="1373076">(</span><span class="op" id="1373077">)</span>&nbsp;<span class="op" id="1373079">*</span><span class="ident" id="1373080">poolLocal</span>&nbsp;<span class="op" id="1373090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1373093">pid</span>&nbsp;<span class="op" id="1373097">:=</span>&nbsp;<span class="ident" id="1373100">runtime_procPin</span><span class="op" id="1373115">(</span><span class="op" id="1373116">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1373119">//&nbsp;In&nbsp;pinSlow&nbsp;we&nbsp;store&nbsp;to&nbsp;localSize&nbsp;and&nbsp;then&nbsp;to&nbsp;local,&nbsp;here&nbsp;we&nbsp;load&nbsp;in&nbsp;opposite&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1373207">//&nbsp;Since&nbsp;we&#39;ve&nbsp;disabled&nbsp;preemption,&nbsp;GC&nbsp;can&nbsp;not&nbsp;happen&nbsp;in&nbsp;between.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1373274">//&nbsp;Thus&nbsp;here&nbsp;we&nbsp;must&nbsp;observe&nbsp;local&nbsp;at&nbsp;least&nbsp;as&nbsp;large&nbsp;localSize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1373339">//&nbsp;We&nbsp;can&nbsp;observe&nbsp;a&nbsp;newer/larger&nbsp;local,&nbsp;it&nbsp;is&nbsp;fine&nbsp;(we&nbsp;must&nbsp;observe&nbsp;its&nbsp;zero-initialized-ness).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1373436">s</span>&nbsp;<span class="op" id="1373438">:=</span>&nbsp;<span class="ident" id="1373441">atomic</span><span class="op" id="1373447">.</span><span class="ident" id="1373448">LoadUintptr</span><span class="op" id="1373459">(</span><span class="op" id="1373460">&amp;</span><span class="ident" id="1373461">p</span><span class="op" id="1373462">.</span><span class="ident" id="1373463">localSize</span><span class="op" id="1373472">)</span>&nbsp;<span class="comment" id="1373474">//&nbsp;load-acquire</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1373491">l</span>&nbsp;<span class="op" id="1373493">:=</span>&nbsp;<span class="ident" id="1373496">p</span><span class="op" id="1373497">.</span><span class="ident" id="1373498">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1373529">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373546">if</span>&nbsp;<span class="builtintype" id="1373549">uintptr</span><span class="op" id="1373556">(</span><span class="ident" id="1373557">pid</span><span class="op" id="1373560">)</span>&nbsp;<span class="op" id="1373562">&lt;</span>&nbsp;<span class="ident" id="1373564">s</span>&nbsp;<span class="op" id="1373566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373570">return</span>&nbsp;<span class="ident" id="1373577">indexLocal</span><span class="op" id="1373587">(</span><span class="ident" id="1373588">l</span><span class="op" id="1373589">,</span>&nbsp;<span class="ident" id="1373591">pid</span><span class="op" id="1373594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1373597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373600">return</span>&nbsp;<span class="ident" id="1373607">p</span><span class="op" id="1373608">.</span><span class="ident" id="1373609">pinSlow</span><span class="op" id="1373616">(</span><span class="op" id="1373617">)</span><br>
<span class="lineno">160</span><span class="op" id="1373619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1373622">func</span>&nbsp;<span class="op" id="1373627">(</span><span class="ident" id="1373628">p</span>&nbsp;<span class="op" id="1373630">*</span><span class="ident" id="1373631">Pool</span><span class="op" id="1373635">)</span>&nbsp;<span class="ident" id="1373637">pinSlow</span><span class="op" id="1373644">(</span><span class="op" id="1373645">)</span>&nbsp;<span class="op" id="1373647">*</span><span class="ident" id="1373648">poolLocal</span>&nbsp;<span class="op" id="1373658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1373661">//&nbsp;Retry&nbsp;under&nbsp;the&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1373688">//&nbsp;Can&nbsp;not&nbsp;lock&nbsp;the&nbsp;mutex&nbsp;while&nbsp;pinned.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1373729">runtime_procUnpin</span><span class="op" id="1373746">(</span><span class="op" id="1373747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1373750">allPoolsMu</span><span class="op" id="1373760">.</span><span class="ident" id="1373761">Lock</span><span class="op" id="1373765">(</span><span class="op" id="1373766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373769">defer</span>&nbsp;<span class="ident" id="1373775">allPoolsMu</span><span class="op" id="1373785">.</span><span class="ident" id="1373786">Unlock</span><span class="op" id="1373792">(</span><span class="op" id="1373793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1373796">pid</span>&nbsp;<span class="op" id="1373800">:=</span>&nbsp;<span class="ident" id="1373803">runtime_procPin</span><span class="op" id="1373818">(</span><span class="op" id="1373819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1373822">//&nbsp;poolCleanup&nbsp;won&#39;t&nbsp;be&nbsp;called&nbsp;while&nbsp;we&nbsp;are&nbsp;pinned.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1373875">s</span>&nbsp;<span class="op" id="1373877">:=</span>&nbsp;<span class="ident" id="1373880">p</span><span class="op" id="1373881">.</span><span class="ident" id="1373882">localSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1373893">l</span>&nbsp;<span class="op" id="1373895">:=</span>&nbsp;<span class="ident" id="1373898">p</span><span class="op" id="1373899">.</span><span class="ident" id="1373900">local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373907">if</span>&nbsp;<span class="builtintype" id="1373910">uintptr</span><span class="op" id="1373917">(</span><span class="ident" id="1373918">pid</span><span class="op" id="1373921">)</span>&nbsp;<span class="op" id="1373923">&lt;</span>&nbsp;<span class="ident" id="1373925">s</span>&nbsp;<span class="op" id="1373927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373931">return</span>&nbsp;<span class="ident" id="1373938">indexLocal</span><span class="op" id="1373948">(</span><span class="ident" id="1373949">l</span><span class="op" id="1373950">,</span>&nbsp;<span class="ident" id="1373952">pid</span><span class="op" id="1373955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1373958">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1373961">if</span>&nbsp;<span class="ident" id="1373964">p</span><span class="op" id="1373965">.</span><span class="ident" id="1373966">local</span>&nbsp;<span class="op" id="1373972">==</span>&nbsp;<span class="ident" id="1373975">nil</span>&nbsp;<span class="op" id="1373979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1373983">allPools</span>&nbsp;<span class="op" id="1373992">=</span>&nbsp;<span class="builtinfunc" id="1373994">append</span><span class="op" id="1374000">(</span><span class="ident" id="1374001">allPools</span><span class="op" id="1374009">,</span>&nbsp;<span class="ident" id="1374011">p</span><span class="op" id="1374012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1374015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1374018">//&nbsp;If&nbsp;GOMAXPROCS&nbsp;changes&nbsp;between&nbsp;GCs,&nbsp;we&nbsp;re-allocate&nbsp;the&nbsp;array&nbsp;and&nbsp;lose&nbsp;the&nbsp;old&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374104">size</span>&nbsp;<span class="op" id="1374109">:=</span>&nbsp;<span class="ident" id="1374112">runtime</span><span class="op" id="1374119">.</span><span class="ident" id="1374120">GOMAXPROCS</span><span class="op" id="1374130">(</span><span class="num" id="1374131">0</span><span class="op" id="1374132">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374135">local</span>&nbsp;<span class="op" id="1374141">:=</span>&nbsp;<span class="builtinfunc" id="1374144">make</span><span class="op" id="1374148">(</span><span class="op" id="1374149">[</span><span class="op" id="1374150">]</span><span class="ident" id="1374151">poolLocal</span><span class="op" id="1374160">,</span>&nbsp;<span class="ident" id="1374162">size</span><span class="op" id="1374166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374169">atomic</span><span class="op" id="1374175">.</span><span class="ident" id="1374176">StorePointer</span><span class="op" id="1374188">(</span><span class="op" id="1374189">(</span><span class="op" id="1374190">*</span><span class="ident" id="1374191">unsafe</span><span class="op" id="1374197">.</span><span class="ident" id="1374198">Pointer</span><span class="op" id="1374205">)</span><span class="op" id="1374206">(</span><span class="op" id="1374207">&amp;</span><span class="ident" id="1374208">p</span><span class="op" id="1374209">.</span><span class="ident" id="1374210">local</span><span class="op" id="1374215">)</span><span class="op" id="1374216">,</span>&nbsp;<span class="ident" id="1374218">unsafe</span><span class="op" id="1374224">.</span><span class="ident" id="1374225">Pointer</span><span class="op" id="1374232">(</span><span class="op" id="1374233">&amp;</span><span class="ident" id="1374234">local</span><span class="op" id="1374239">[</span><span class="num" id="1374240">0</span><span class="op" id="1374241">]</span><span class="op" id="1374242">)</span><span class="op" id="1374243">)</span>&nbsp;<span class="comment" id="1374245">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374263">atomic</span><span class="op" id="1374269">.</span><span class="ident" id="1374270">StoreUintptr</span><span class="op" id="1374282">(</span><span class="op" id="1374283">&amp;</span><span class="ident" id="1374284">p</span><span class="op" id="1374285">.</span><span class="ident" id="1374286">localSize</span><span class="op" id="1374295">,</span>&nbsp;<span class="builtintype" id="1374297">uintptr</span><span class="op" id="1374304">(</span><span class="ident" id="1374305">size</span><span class="op" id="1374309">)</span><span class="op" id="1374310">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1374339">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1374357">return</span>&nbsp;<span class="op" id="1374364">&amp;</span><span class="ident" id="1374365">local</span><span class="op" id="1374370">[</span><span class="ident" id="1374371">pid</span><span class="op" id="1374374">]</span><br>
<span class="lineno"></span><span class="op" id="1374376">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="1374379">func</span>&nbsp;<span class="ident" id="1374384">poolCleanup</span><span class="op" id="1374395">(</span><span class="op" id="1374396">)</span>&nbsp;<span class="op" id="1374398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1374401">//&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;with&nbsp;the&nbsp;world&nbsp;stopped,&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1374495">//&nbsp;It&nbsp;must&nbsp;not&nbsp;allocate&nbsp;and&nbsp;probably&nbsp;should&nbsp;not&nbsp;call&nbsp;any&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1374572">//&nbsp;Defensively&nbsp;zero&nbsp;out&nbsp;everything,&nbsp;2&nbsp;reasons:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1374620">//&nbsp;1.&nbsp;To&nbsp;prevent&nbsp;false&nbsp;retention&nbsp;of&nbsp;whole&nbsp;Pools.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1374670">//&nbsp;2.&nbsp;If&nbsp;GC&nbsp;happens&nbsp;while&nbsp;a&nbsp;goroutine&nbsp;works&nbsp;with&nbsp;l.shared&nbsp;in&nbsp;Put/Get,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1374741">//&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;will&nbsp;retain&nbsp;whole&nbsp;Pool.&nbsp;So&nbsp;next&nbsp;cycle&nbsp;memory&nbsp;consumption&nbsp;would&nbsp;be&nbsp;doubled.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1374826">for</span>&nbsp;<span class="ident" id="1374830">i</span><span class="op" id="1374831">,</span>&nbsp;<span class="ident" id="1374833">p</span>&nbsp;<span class="op" id="1374835">:=</span>&nbsp;<span class="keyword" id="1374838">range</span>&nbsp;<span class="ident" id="1374844">allPools</span>&nbsp;<span class="op" id="1374853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374857">allPools</span><span class="op" id="1374865">[</span><span class="ident" id="1374866">i</span><span class="op" id="1374867">]</span>&nbsp;<span class="op" id="1374869">=</span>&nbsp;<span class="ident" id="1374871">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1374877">for</span>&nbsp;<span class="ident" id="1374881">i</span>&nbsp;<span class="op" id="1374883">:=</span>&nbsp;<span class="num" id="1374886">0</span><span class="op" id="1374887">;</span>&nbsp;<span class="ident" id="1374889">i</span>&nbsp;<span class="op" id="1374891">&lt;</span>&nbsp;<span class="builtintype" id="1374893">int</span><span class="op" id="1374896">(</span><span class="ident" id="1374897">p</span><span class="op" id="1374898">.</span><span class="ident" id="1374899">localSize</span><span class="op" id="1374908">)</span><span class="op" id="1374909">;</span>&nbsp;<span class="ident" id="1374911">i</span><span class="op" id="1374912">++</span>&nbsp;<span class="op" id="1374915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374920">l</span>&nbsp;<span class="op" id="1374922">:=</span>&nbsp;<span class="ident" id="1374925">indexLocal</span><span class="op" id="1374935">(</span><span class="ident" id="1374936">p</span><span class="op" id="1374937">.</span><span class="ident" id="1374938">local</span><span class="op" id="1374943">,</span>&nbsp;<span class="ident" id="1374945">i</span><span class="op" id="1374946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1374951">l</span><span class="op" id="1374952">.</span><span class="ident" id="1374953">private</span>&nbsp;<span class="op" id="1374961">=</span>&nbsp;<span class="ident" id="1374963">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1374970">for</span>&nbsp;<span class="ident" id="1374974">j</span>&nbsp;<span class="op" id="1374976">:=</span>&nbsp;<span class="keyword" id="1374979">range</span>&nbsp;<span class="ident" id="1374985">l</span><span class="op" id="1374986">.</span><span class="ident" id="1374987">shared</span>&nbsp;<span class="op" id="1374994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1375000">l</span><span class="op" id="1375001">.</span><span class="ident" id="1375002">shared</span><span class="op" id="1375008">[</span><span class="ident" id="1375009">j</span><span class="op" id="1375010">]</span>&nbsp;<span class="op" id="1375012">=</span>&nbsp;<span class="ident" id="1375014">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1375021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1375026">l</span><span class="op" id="1375027">.</span><span class="ident" id="1375028">shared</span>&nbsp;<span class="op" id="1375035">=</span>&nbsp;<span class="ident" id="1375037">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1375043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1375047">p</span><span class="op" id="1375048">.</span><span class="ident" id="1375049">local</span>&nbsp;<span class="op" id="1375055">=</span>&nbsp;<span class="ident" id="1375057">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1375063">p</span><span class="op" id="1375064">.</span><span class="ident" id="1375065">localSize</span>&nbsp;<span class="op" id="1375075">=</span>&nbsp;<span class="num" id="1375077">0</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1375080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1375083">allPools</span>&nbsp;<span class="op" id="1375092">=</span>&nbsp;<span class="op" id="1375094">[</span><span class="op" id="1375095">]</span><span class="op" id="1375096">*</span><span class="ident" id="1375097">Pool</span><span class="op" id="1375101">{</span><span class="op" id="1375102">}</span><br>
<span class="lineno"></span><span class="op" id="1375104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1375107">var</span>&nbsp;<span class="op" id="1375111">(</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1375114">allPoolsMu</span>&nbsp;<span class="ident" id="1375125">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1375132">allPools</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1375143">[</span><span class="op" id="1375144">]</span><span class="op" id="1375145">*</span><span class="ident" id="1375146">Pool</span><br>
<span class="lineno"></span><span class="op" id="1375151">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1375154">func</span>&nbsp;<span class="ident" id="1375159">init</span><span class="op" id="1375163">(</span><span class="op" id="1375164">)</span>&nbsp;<span class="op" id="1375166">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1375169">runtime_registerPoolCleanup</span><span class="op" id="1375196">(</span><span class="ident" id="1375197">poolCleanup</span><span class="op" id="1375208">)</span><br>
<span class="lineno"></span><span class="op" id="1375210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1375213">func</span>&nbsp;<span class="ident" id="1375218">indexLocal</span><span class="op" id="1375228">(</span><span class="ident" id="1375229">l</span>&nbsp;<span class="ident" id="1375231">unsafe</span><span class="op" id="1375237">.</span><span class="ident" id="1375238">Pointer</span><span class="op" id="1375245">,</span>&nbsp;<span class="ident" id="1375247">i</span>&nbsp;<span class="builtintype" id="1375249">int</span><span class="op" id="1375252">)</span>&nbsp;<span class="op" id="1375254">*</span><span class="ident" id="1375255">poolLocal</span>&nbsp;<span class="op" id="1375265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1375268">return</span>&nbsp;<span class="op" id="1375275">&amp;</span><span class="op" id="1375276">(</span><span class="op" id="1375277">*</span><span class="op" id="1375278">[</span><span class="num" id="1375279">1000000</span><span class="op" id="1375286">]</span><span class="ident" id="1375287">poolLocal</span><span class="op" id="1375296">)</span><span class="op" id="1375297">(</span><span class="ident" id="1375298">l</span><span class="op" id="1375299">)</span><span class="op" id="1375300">[</span><span class="ident" id="1375301">i</span><span class="op" id="1375302">]</span><br>
<span class="lineno">220</span><span class="op" id="1375304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1375307">//&nbsp;Implemented&nbsp;in&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1375334">func</span>&nbsp;<span class="ident" id="1375339">runtime_registerPoolCleanup</span><span class="op" id="1375366">(</span><span class="ident" id="1375367">cleanup</span>&nbsp;<span class="keyword" id="1375375">func</span><span class="op" id="1375379">(</span><span class="op" id="1375380">)</span><span class="op" id="1375381">)</span><br>
<span class="lineno"></span><span class="keyword" id="1375383">func</span>&nbsp;<span class="ident" id="1375388">runtime_procPin</span><span class="op" id="1375403">(</span><span class="op" id="1375404">)</span>&nbsp;<span class="builtintype" id="1375406">int</span><br>
<span class="lineno">225</span><span class="keyword" id="1375410">func</span>&nbsp;<span class="ident" id="1375415">runtime_procUnpin</span><span class="op" id="1375432">(</span><span class="op" id="1375433">)</span>
</div>
</body>
</html>
