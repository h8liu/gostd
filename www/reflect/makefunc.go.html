<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2547893">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2547949">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2548003">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2548054">//&nbsp;MakeFunc&nbsp;implementation.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2548083">package</span>&nbsp;<span class="ident" id="2548091">reflect</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2548100">import</span>&nbsp;<span class="op" id="2548107">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2548110">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2548119">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2548122">//&nbsp;makeFuncImpl&nbsp;is&nbsp;the&nbsp;closure&nbsp;value&nbsp;implementing&nbsp;the&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2548185">//&nbsp;returned&nbsp;by&nbsp;MakeFunc.</span><br>
<span class="lineno">15</span><span class="keyword" id="2548210">type</span>&nbsp;<span class="ident" id="2548215">makeFuncImpl</span>&nbsp;<span class="keyword" id="2548228">struct</span>&nbsp;<span class="op" id="2548235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2548238">code</span>&nbsp;&nbsp;<span class="builtintype" id="2548244">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2548253">stack</span>&nbsp;<span class="op" id="2548259">*</span><span class="ident" id="2548260">bitVector</span>&nbsp;<span class="comment" id="2548270">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2548322">typ</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2548328">*</span><span class="ident" id="2548329">funcType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2548339">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2548345">func</span><span class="op" id="2548349">(</span><span class="op" id="2548350">[</span><span class="op" id="2548351">]</span><span class="ident" id="2548352">Value</span><span class="op" id="2548357">)</span>&nbsp;<span class="op" id="2548359">[</span><span class="op" id="2548360">]</span><span class="ident" id="2548361">Value</span><br>
<span class="lineno">20</span><span class="op" id="2548367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2548370">//&nbsp;MakeFunc&nbsp;returns&nbsp;a&nbsp;new&nbsp;function&nbsp;of&nbsp;the&nbsp;given&nbsp;Type</span><br>
<span class="lineno"></span><span class="comment" id="2548423">//&nbsp;that&nbsp;wraps&nbsp;the&nbsp;function&nbsp;fn.&nbsp;When&nbsp;called,&nbsp;that&nbsp;new&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2548485">//&nbsp;does&nbsp;the&nbsp;following:</span><br>
<span class="lineno">25</span><span class="comment" id="2548508">//</span><br>
<span class="lineno"></span><span class="comment" id="2548511">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;converts&nbsp;its&nbsp;arguments&nbsp;to&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values.</span><br>
<span class="lineno"></span><span class="comment" id="2548561">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;runs&nbsp;results&nbsp;:=&nbsp;fn(args).</span><br>
<span class="lineno"></span><span class="comment" id="2548592">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;returns&nbsp;the&nbsp;results&nbsp;as&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values,&nbsp;one&nbsp;per&nbsp;formal&nbsp;result.</span><br>
<span class="lineno"></span><span class="comment" id="2548662">//</span><br>
<span class="lineno">30</span><span class="comment" id="2548665">//&nbsp;The&nbsp;implementation&nbsp;fn&nbsp;can&nbsp;assume&nbsp;that&nbsp;the&nbsp;argument&nbsp;Value&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="2548731">//&nbsp;has&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;arguments&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2548785">//&nbsp;If&nbsp;typ&nbsp;describes&nbsp;a&nbsp;variadic&nbsp;function,&nbsp;the&nbsp;final&nbsp;Value&nbsp;is&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2548852">//&nbsp;a&nbsp;slice&nbsp;representing&nbsp;the&nbsp;variadic&nbsp;arguments,&nbsp;as&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2548910">//&nbsp;body&nbsp;of&nbsp;a&nbsp;variadic&nbsp;function.&nbsp;The&nbsp;result&nbsp;Value&nbsp;slice&nbsp;returned&nbsp;by&nbsp;fn</span><br>
<span class="lineno">35</span><span class="comment" id="2548980">//&nbsp;must&nbsp;have&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;results&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2549038">//</span><br>
<span class="lineno"></span><span class="comment" id="2549041">//&nbsp;The&nbsp;Value.Call&nbsp;method&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;invoke&nbsp;a&nbsp;typed&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2549111">//&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values;&nbsp;in&nbsp;contrast,&nbsp;MakeFunc&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;implement</span><br>
<span class="lineno"></span><span class="comment" id="2549187">//&nbsp;a&nbsp;typed&nbsp;function&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values.</span><br>
<span class="lineno">40</span><span class="comment" id="2549227">//</span><br>
<span class="lineno"></span><span class="comment" id="2549230">//&nbsp;The&nbsp;Examples&nbsp;section&nbsp;of&nbsp;the&nbsp;documentation&nbsp;includes&nbsp;an&nbsp;illustration</span><br>
<span class="lineno"></span><span class="comment" id="2549300">//&nbsp;of&nbsp;how&nbsp;to&nbsp;use&nbsp;MakeFunc&nbsp;to&nbsp;build&nbsp;a&nbsp;swap&nbsp;function&nbsp;for&nbsp;different&nbsp;types.</span><br>
<span class="lineno"></span><span class="comment" id="2549372">//</span><br>
<span class="lineno"></span><span class="keyword" id="2549375">func</span>&nbsp;<span class="ident" id="2549380">MakeFunc</span><span class="op" id="2549388">(</span><span class="ident" id="2549389">typ</span>&nbsp;<span class="ident" id="2549393">Type</span><span class="op" id="2549397">,</span>&nbsp;<span class="ident" id="2549399">fn</span>&nbsp;<span class="keyword" id="2549402">func</span><span class="op" id="2549406">(</span><span class="ident" id="2549407">args</span>&nbsp;<span class="op" id="2549412">[</span><span class="op" id="2549413">]</span><span class="ident" id="2549414">Value</span><span class="op" id="2549419">)</span>&nbsp;<span class="op" id="2549421">(</span><span class="ident" id="2549422">results</span>&nbsp;<span class="op" id="2549430">[</span><span class="op" id="2549431">]</span><span class="ident" id="2549432">Value</span><span class="op" id="2549437">)</span><span class="op" id="2549438">)</span>&nbsp;<span class="ident" id="2549440">Value</span>&nbsp;<span class="op" id="2549446">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2549449">if</span>&nbsp;<span class="ident" id="2549452">typ</span><span class="op" id="2549455">.</span><span class="ident" id="2549456">Kind</span><span class="op" id="2549460">(</span><span class="op" id="2549461">)</span>&nbsp;<span class="op" id="2549463">!=</span>&nbsp;<span class="ident" id="2549466">Func</span>&nbsp;<span class="op" id="2549471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2549475">panic</span><span class="op" id="2549480">(</span><span class="string" id="2549481">&#34;reflect:&nbsp;call&nbsp;of&nbsp;MakeFunc&nbsp;with&nbsp;non-Func&nbsp;type&#34;</span><span class="op" id="2549527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2549530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2549534">t</span>&nbsp;<span class="op" id="2549536">:=</span>&nbsp;<span class="ident" id="2549539">typ</span><span class="op" id="2549542">.</span><span class="ident" id="2549543">common</span><span class="op" id="2549549">(</span><span class="op" id="2549550">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2549553">ftyp</span>&nbsp;<span class="op" id="2549558">:=</span>&nbsp;<span class="op" id="2549561">(</span><span class="op" id="2549562">*</span><span class="ident" id="2549563">funcType</span><span class="op" id="2549571">)</span><span class="op" id="2549572">(</span><span class="ident" id="2549573">unsafe</span><span class="op" id="2549579">.</span><span class="ident" id="2549580">Pointer</span><span class="op" id="2549587">(</span><span class="ident" id="2549588">t</span><span class="op" id="2549589">)</span><span class="op" id="2549590">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2549594">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2549639">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2549694">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2549754">dummy</span>&nbsp;<span class="op" id="2549760">:=</span>&nbsp;<span class="ident" id="2549763">makeFuncStub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2549777">code</span>&nbsp;<span class="op" id="2549782">:=</span>&nbsp;<span class="op" id="2549785">*</span><span class="op" id="2549786">*</span><span class="op" id="2549787">(</span><span class="op" id="2549788">*</span><span class="op" id="2549789">*</span><span class="builtintype" id="2549790">uintptr</span><span class="op" id="2549797">)</span><span class="op" id="2549798">(</span><span class="ident" id="2549799">unsafe</span><span class="op" id="2549805">.</span><span class="ident" id="2549806">Pointer</span><span class="op" id="2549813">(</span><span class="op" id="2549814">&amp;</span><span class="ident" id="2549815">dummy</span><span class="op" id="2549820">)</span><span class="op" id="2549821">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2549825">//&nbsp;makeFuncImpl&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2549886">_</span><span class="op" id="2549887">,</span>&nbsp;<span class="ident" id="2549889">_</span><span class="op" id="2549890">,</span>&nbsp;<span class="ident" id="2549892">_</span><span class="op" id="2549893">,</span>&nbsp;<span class="ident" id="2549895">stack</span>&nbsp;<span class="op" id="2549901">:=</span>&nbsp;<span class="ident" id="2549904">funcLayout</span><span class="op" id="2549914">(</span><span class="ident" id="2549915">t</span><span class="op" id="2549916">,</span>&nbsp;<span class="ident" id="2549918">nil</span><span class="op" id="2549921">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2549925">impl</span>&nbsp;<span class="op" id="2549930">:=</span>&nbsp;<span class="op" id="2549933">&amp;</span><span class="ident" id="2549934">makeFuncImpl</span><span class="op" id="2549946">{</span><span class="ident" id="2549947">code</span><span class="op" id="2549951">:</span>&nbsp;<span class="ident" id="2549953">code</span><span class="op" id="2549957">,</span>&nbsp;<span class="ident" id="2549959">stack</span><span class="op" id="2549964">:</span>&nbsp;<span class="ident" id="2549966">stack</span><span class="op" id="2549971">,</span>&nbsp;<span class="ident" id="2549973">typ</span><span class="op" id="2549976">:</span>&nbsp;<span class="ident" id="2549978">ftyp</span><span class="op" id="2549982">,</span>&nbsp;<span class="ident" id="2549984">fn</span><span class="op" id="2549986">:</span>&nbsp;<span class="ident" id="2549988">fn</span><span class="op" id="2549990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2549994">return</span>&nbsp;<span class="ident" id="2550001">Value</span><span class="op" id="2550006">{</span><span class="ident" id="2550007">t</span><span class="op" id="2550008">,</span>&nbsp;<span class="ident" id="2550010">unsafe</span><span class="op" id="2550016">.</span><span class="ident" id="2550017">Pointer</span><span class="op" id="2550024">(</span><span class="ident" id="2550025">impl</span><span class="op" id="2550029">)</span><span class="op" id="2550030">,</span>&nbsp;<span class="ident" id="2550032">flag</span><span class="op" id="2550036">(</span><span class="ident" id="2550037">Func</span><span class="op" id="2550041">)</span><span class="op" id="2550042">}</span><br>
<span class="lineno"></span><span class="op" id="2550044">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2550047">//&nbsp;makeFuncStub&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2550112">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;MakeFunc.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*callReflectFunc</span><br>
<span class="lineno"></span><span class="comment" id="2550182">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callReflect(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2550260">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno">70</span><span class="comment" id="2550334">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2550375">func</span>&nbsp;<span class="ident" id="2550380">makeFuncStub</span><span class="op" id="2550392">(</span><span class="op" id="2550393">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2550396">type</span>&nbsp;<span class="ident" id="2550401">methodValue</span>&nbsp;<span class="keyword" id="2550413">struct</span>&nbsp;<span class="op" id="2550420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2550423">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2550430">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2550439">stack</span>&nbsp;&nbsp;<span class="op" id="2550446">*</span><span class="ident" id="2550447">bitVector</span>&nbsp;<span class="comment" id="2550457">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2550509">method</span>&nbsp;<span class="builtintype" id="2550516">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2550521">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2550528">Value</span><br>
<span class="lineno"></span><span class="op" id="2550534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="2550537">//&nbsp;makeMethodValue&nbsp;converts&nbsp;v&nbsp;from&nbsp;the&nbsp;rcvr+method&nbsp;index&nbsp;representation</span><br>
<span class="lineno"></span><span class="comment" id="2550609">//&nbsp;of&nbsp;a&nbsp;method&nbsp;value&nbsp;to&nbsp;an&nbsp;actual&nbsp;method&nbsp;func&nbsp;value,&nbsp;which&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2550671">//&nbsp;basically&nbsp;the&nbsp;receiver&nbsp;value&nbsp;with&nbsp;a&nbsp;special&nbsp;bit&nbsp;set,&nbsp;into&nbsp;a&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="2550739">//&nbsp;func&nbsp;value&nbsp;-&nbsp;a&nbsp;value&nbsp;holding&nbsp;an&nbsp;actual&nbsp;func.&nbsp;The&nbsp;output&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2550801">//&nbsp;semantically&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;input&nbsp;as&nbsp;far&nbsp;as&nbsp;the&nbsp;user&nbsp;of&nbsp;package</span><br>
<span class="lineno">85</span><span class="comment" id="2550871">//&nbsp;reflect&nbsp;can&nbsp;tell,&nbsp;but&nbsp;the&nbsp;true&nbsp;func&nbsp;representation&nbsp;can&nbsp;be&nbsp;handled</span><br>
<span class="lineno"></span><span class="comment" id="2550940">//&nbsp;by&nbsp;code&nbsp;like&nbsp;Convert&nbsp;and&nbsp;Interface&nbsp;and&nbsp;Assign.</span><br>
<span class="lineno"></span><span class="keyword" id="2550990">func</span>&nbsp;<span class="ident" id="2550995">makeMethodValue</span><span class="op" id="2551010">(</span><span class="ident" id="2551011">op</span>&nbsp;<span class="builtintype" id="2551014">string</span><span class="op" id="2551020">,</span>&nbsp;<span class="ident" id="2551022">v</span>&nbsp;<span class="ident" id="2551024">Value</span><span class="op" id="2551029">)</span>&nbsp;<span class="ident" id="2551031">Value</span>&nbsp;<span class="op" id="2551037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2551040">if</span>&nbsp;<span class="ident" id="2551043">v</span><span class="op" id="2551044">.</span><span class="ident" id="2551045">flag</span><span class="op" id="2551049">&amp;</span><span class="ident" id="2551050">flagMethod</span>&nbsp;<span class="op" id="2551061">==</span>&nbsp;<span class="num" id="2551064">0</span>&nbsp;<span class="op" id="2551066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2551070">panic</span><span class="op" id="2551075">(</span><span class="string" id="2551076">&#34;reflect:&nbsp;internal&nbsp;error:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;makeMethodValue&#34;</span><span class="op" id="2551133">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2551136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2551140">//&nbsp;Ignoring&nbsp;the&nbsp;flagMethod&nbsp;bit,&nbsp;v&nbsp;describes&nbsp;the&nbsp;receiver,&nbsp;not&nbsp;the&nbsp;method&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2551220">fl</span>&nbsp;<span class="op" id="2551223">:=</span>&nbsp;<span class="ident" id="2551226">v</span><span class="op" id="2551227">.</span><span class="ident" id="2551228">flag</span>&nbsp;<span class="op" id="2551233">&amp;</span>&nbsp;<span class="op" id="2551235">(</span><span class="ident" id="2551236">flagRO</span>&nbsp;<span class="op" id="2551243">|</span>&nbsp;<span class="ident" id="2551245">flagAddr</span>&nbsp;<span class="op" id="2551254">|</span>&nbsp;<span class="ident" id="2551256">flagIndir</span><span class="op" id="2551265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2551268">fl</span>&nbsp;<span class="op" id="2551271">|=</span>&nbsp;<span class="ident" id="2551274">flag</span><span class="op" id="2551278">(</span><span class="ident" id="2551279">v</span><span class="op" id="2551280">.</span><span class="ident" id="2551281">typ</span><span class="op" id="2551284">.</span><span class="ident" id="2551285">Kind</span><span class="op" id="2551289">(</span><span class="op" id="2551290">)</span><span class="op" id="2551291">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2551294">rcvr</span>&nbsp;<span class="op" id="2551299">:=</span>&nbsp;<span class="ident" id="2551302">Value</span><span class="op" id="2551307">{</span><span class="ident" id="2551308">v</span><span class="op" id="2551309">.</span><span class="ident" id="2551310">typ</span><span class="op" id="2551313">,</span>&nbsp;<span class="ident" id="2551315">v</span><span class="op" id="2551316">.</span><span class="ident" id="2551317">ptr</span><span class="op" id="2551320">,</span>&nbsp;<span class="ident" id="2551322">fl</span><span class="op" id="2551324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2551328">//&nbsp;v.Type&nbsp;returns&nbsp;the&nbsp;actual&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2551384">funcType</span>&nbsp;<span class="op" id="2551393">:=</span>&nbsp;<span class="ident" id="2551396">v</span><span class="op" id="2551397">.</span><span class="ident" id="2551398">Type</span><span class="op" id="2551402">(</span><span class="op" id="2551403">)</span><span class="op" id="2551404">.</span><span class="op" id="2551405">(</span><span class="op" id="2551406">*</span><span class="ident" id="2551407">rtype</span><span class="op" id="2551412">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2551416">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2551461">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2551516">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2551576">dummy</span>&nbsp;<span class="op" id="2551582">:=</span>&nbsp;<span class="ident" id="2551585">methodValueCall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2551602">code</span>&nbsp;<span class="op" id="2551607">:=</span>&nbsp;<span class="op" id="2551610">*</span><span class="op" id="2551611">*</span><span class="op" id="2551612">(</span><span class="op" id="2551613">*</span><span class="op" id="2551614">*</span><span class="builtintype" id="2551615">uintptr</span><span class="op" id="2551622">)</span><span class="op" id="2551623">(</span><span class="ident" id="2551624">unsafe</span><span class="op" id="2551630">.</span><span class="ident" id="2551631">Pointer</span><span class="op" id="2551638">(</span><span class="op" id="2551639">&amp;</span><span class="ident" id="2551640">dummy</span><span class="op" id="2551645">)</span><span class="op" id="2551646">)</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2551650">//&nbsp;methodValue&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2551710">_</span><span class="op" id="2551711">,</span>&nbsp;<span class="ident" id="2551713">_</span><span class="op" id="2551714">,</span>&nbsp;<span class="ident" id="2551716">_</span><span class="op" id="2551717">,</span>&nbsp;<span class="ident" id="2551719">stack</span>&nbsp;<span class="op" id="2551725">:=</span>&nbsp;<span class="ident" id="2551728">funcLayout</span><span class="op" id="2551738">(</span><span class="ident" id="2551739">funcType</span><span class="op" id="2551747">,</span>&nbsp;<span class="ident" id="2551749">nil</span><span class="op" id="2551752">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2551756">fv</span>&nbsp;<span class="op" id="2551759">:=</span>&nbsp;<span class="op" id="2551762">&amp;</span><span class="ident" id="2551763">methodValue</span><span class="op" id="2551774">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2551778">fn</span><span class="op" id="2551780">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2551786">code</span><span class="op" id="2551790">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2551794">stack</span><span class="op" id="2551799">:</span>&nbsp;&nbsp;<span class="ident" id="2551802">stack</span><span class="op" id="2551807">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2551811">method</span><span class="op" id="2551817">:</span>&nbsp;<span class="builtintype" id="2551819">int</span><span class="op" id="2551822">(</span><span class="ident" id="2551823">v</span><span class="op" id="2551824">.</span><span class="ident" id="2551825">flag</span><span class="op" id="2551829">)</span>&nbsp;<span class="op" id="2551831">&gt;&gt;</span>&nbsp;<span class="ident" id="2551834">flagMethodShift</span><span class="op" id="2551849">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2551853">rcvr</span><span class="op" id="2551857">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2551861">rcvr</span><span class="op" id="2551865">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2551868">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2551872">//&nbsp;Cause&nbsp;panic&nbsp;if&nbsp;method&nbsp;is&nbsp;not&nbsp;appropriate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2551918">//&nbsp;The&nbsp;panic&nbsp;would&nbsp;still&nbsp;happen&nbsp;during&nbsp;the&nbsp;call&nbsp;if&nbsp;we&nbsp;omit&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2551984">//&nbsp;but&nbsp;we&nbsp;want&nbsp;Interface()&nbsp;and&nbsp;other&nbsp;operations&nbsp;to&nbsp;fail&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2552048">methodReceiver</span><span class="op" id="2552062">(</span><span class="ident" id="2552063">op</span><span class="op" id="2552065">,</span>&nbsp;<span class="ident" id="2552067">fv</span><span class="op" id="2552069">.</span><span class="ident" id="2552070">rcvr</span><span class="op" id="2552074">,</span>&nbsp;<span class="ident" id="2552076">fv</span><span class="op" id="2552078">.</span><span class="ident" id="2552079">method</span><span class="op" id="2552085">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2552089">return</span>&nbsp;<span class="ident" id="2552096">Value</span><span class="op" id="2552101">{</span><span class="ident" id="2552102">funcType</span><span class="op" id="2552110">,</span>&nbsp;<span class="ident" id="2552112">unsafe</span><span class="op" id="2552118">.</span><span class="ident" id="2552119">Pointer</span><span class="op" id="2552126">(</span><span class="ident" id="2552127">fv</span><span class="op" id="2552129">)</span><span class="op" id="2552130">,</span>&nbsp;<span class="ident" id="2552132">v</span><span class="op" id="2552133">.</span><span class="ident" id="2552134">flag</span><span class="op" id="2552138">&amp;</span><span class="ident" id="2552139">flagRO</span>&nbsp;<span class="op" id="2552146">|</span>&nbsp;<span class="ident" id="2552148">flag</span><span class="op" id="2552152">(</span><span class="ident" id="2552153">Func</span><span class="op" id="2552157">)</span><span class="op" id="2552158">}</span><br>
<span class="lineno"></span><span class="op" id="2552160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2552163">//&nbsp;methodValueCall&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno">125</span><span class="comment" id="2552231">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;makeMethodValue.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*methodValue</span><br>
<span class="lineno"></span><span class="comment" id="2552304">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callMethod(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2552381">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="2552455">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2552496">func</span>&nbsp;<span class="ident" id="2552501">methodValueCall</span><span class="op" id="2552516">(</span><span class="op" id="2552517">)</span>
</div>
</body>
</html>
