<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html" class="current">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7060137">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7060192">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7060246">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7060297">package</span>&nbsp;<span class="ident" id="7060305">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7060310">import</span>&nbsp;<span class="op" id="7060317">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7060320">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7060329">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7060345">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7060359">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7060374">&#34;encoding/pem&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7060390">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7060397">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7060403">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7060410">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7060416">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7060427">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7060444">&#34;strconv&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7060455">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7060466">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7060473">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7060476">//&nbsp;Note:&nbsp;see&nbsp;comment&nbsp;in&nbsp;handshake_test.go&nbsp;for&nbsp;details&nbsp;of&nbsp;how&nbsp;the&nbsp;reference</span><br>
<span class="lineno">25</span><span class="comment" id="7060551">//&nbsp;tests&nbsp;work.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7060567">//&nbsp;blockingSource&nbsp;is&nbsp;an&nbsp;io.Reader&nbsp;that&nbsp;blocks&nbsp;a&nbsp;Read&nbsp;call&nbsp;until&nbsp;it&#39;s&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="7060644">type</span>&nbsp;<span class="ident" id="7060649">blockingSource</span>&nbsp;<span class="keyword" id="7060664">chan</span>&nbsp;<span class="builtintype" id="7060669">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="7060675">func</span>&nbsp;<span class="op" id="7060680">(</span><span class="ident" id="7060681">b</span>&nbsp;<span class="ident" id="7060683">blockingSource</span><span class="op" id="7060697">)</span>&nbsp;<span class="ident" id="7060699">Read</span><span class="op" id="7060703">(</span><span class="op" id="7060704">[</span><span class="op" id="7060705">]</span><span class="builtintype" id="7060706">byte</span><span class="op" id="7060710">)</span>&nbsp;<span class="op" id="7060712">(</span><span class="ident" id="7060713">n</span>&nbsp;<span class="builtintype" id="7060715">int</span><span class="op" id="7060718">,</span>&nbsp;<span class="ident" id="7060720">err</span>&nbsp;<span class="builtintype" id="7060724">error</span><span class="op" id="7060729">)</span>&nbsp;<span class="op" id="7060731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7060734">&lt;-</span><span class="ident" id="7060736">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7060739">return</span>&nbsp;<span class="num" id="7060746">0</span><span class="op" id="7060747">,</span>&nbsp;<span class="ident" id="7060749">io</span><span class="op" id="7060751">.</span><span class="ident" id="7060752">EOF</span><br>
<span class="lineno"></span><span class="op" id="7060756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="7060759">//&nbsp;clientTest&nbsp;represents&nbsp;a&nbsp;test&nbsp;of&nbsp;the&nbsp;TLS&nbsp;client&nbsp;handshake&nbsp;against&nbsp;a&nbsp;reference</span><br>
<span class="lineno"></span><span class="comment" id="7060839">//&nbsp;implementation.</span><br>
<span class="lineno"></span><span class="keyword" id="7060858">type</span>&nbsp;<span class="ident" id="7060863">clientTest</span>&nbsp;<span class="keyword" id="7060874">struct</span>&nbsp;<span class="op" id="7060881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7060884">//&nbsp;name&nbsp;is&nbsp;a&nbsp;freeform&nbsp;string&nbsp;identifying&nbsp;the&nbsp;test&nbsp;and&nbsp;the&nbsp;file&nbsp;in&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7060957">//&nbsp;the&nbsp;expected&nbsp;results&nbsp;will&nbsp;be&nbsp;stored.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7060998">name</span>&nbsp;<span class="builtintype" id="7061003">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7061011">//&nbsp;command,&nbsp;if&nbsp;not&nbsp;empty,&nbsp;contains&nbsp;a&nbsp;series&nbsp;of&nbsp;arguments&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7061077">//&nbsp;command&nbsp;to&nbsp;run&nbsp;for&nbsp;the&nbsp;reference&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7061122">command</span>&nbsp;<span class="op" id="7061130">[</span><span class="op" id="7061131">]</span><span class="builtintype" id="7061132">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7061140">//&nbsp;config,&nbsp;if&nbsp;not&nbsp;nil,&nbsp;contains&nbsp;a&nbsp;custom&nbsp;Config&nbsp;to&nbsp;use&nbsp;for&nbsp;this&nbsp;test.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7061211">config</span>&nbsp;<span class="op" id="7061218">*</span><span class="ident" id="7061219">Config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7061227">//&nbsp;cert,&nbsp;if&nbsp;not&nbsp;empty,&nbsp;contains&nbsp;a&nbsp;DER-encoded&nbsp;certificate&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7061294">//&nbsp;reference&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7061316">cert</span>&nbsp;<span class="op" id="7061321">[</span><span class="op" id="7061322">]</span><span class="builtintype" id="7061323">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7061329">//&nbsp;key,&nbsp;if&nbsp;not&nbsp;nil,&nbsp;contains&nbsp;either&nbsp;a&nbsp;*rsa.PrivateKey&nbsp;or</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7061387">//&nbsp;*ecdsa.PrivateKey&nbsp;which&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;reference&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7061460">key</span>&nbsp;<span class="keyword" id="7061464">interface</span><span class="op" id="7061473">{</span><span class="op" id="7061474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7061477">//&nbsp;validate,&nbsp;if&nbsp;not&nbsp;nil,&nbsp;is&nbsp;a&nbsp;function&nbsp;that&nbsp;will&nbsp;be&nbsp;called&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7061546">//&nbsp;ConnectionState&nbsp;of&nbsp;the&nbsp;resulting&nbsp;connection.&nbsp;It&nbsp;returns&nbsp;a&nbsp;non-nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7061616">//&nbsp;error&nbsp;if&nbsp;the&nbsp;ConnectionState&nbsp;is&nbsp;unacceptable.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7061666">validate</span>&nbsp;<span class="keyword" id="7061675">func</span><span class="op" id="7061679">(</span><span class="ident" id="7061680">ConnectionState</span><span class="op" id="7061695">)</span>&nbsp;<span class="builtintype" id="7061697">error</span><br>
<span class="lineno"></span><span class="op" id="7061703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7061706">var</span>&nbsp;<span class="ident" id="7061710">defaultServerCommand</span>&nbsp;<span class="op" id="7061731">=</span>&nbsp;<span class="op" id="7061733">[</span><span class="op" id="7061734">]</span><span class="builtintype" id="7061735">string</span><span class="op" id="7061741">{</span><span class="string" id="7061742">&#34;openssl&#34;</span><span class="op" id="7061751">,</span>&nbsp;<span class="string" id="7061753">&#34;s_server&#34;</span><span class="op" id="7061763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="7061766">//&nbsp;connFromCommand&nbsp;starts&nbsp;the&nbsp;reference&nbsp;server&nbsp;process,&nbsp;connects&nbsp;to&nbsp;it&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="7061841">//&nbsp;returns&nbsp;a&nbsp;recordingConn&nbsp;for&nbsp;the&nbsp;connection.&nbsp;The&nbsp;stdin&nbsp;return&nbsp;value&nbsp;is&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="7061916">//&nbsp;blockingSource&nbsp;for&nbsp;the&nbsp;stdin&nbsp;of&nbsp;the&nbsp;child&nbsp;process.&nbsp;It&nbsp;must&nbsp;be&nbsp;closed&nbsp;before</span><br>
<span class="lineno"></span><span class="comment" id="7061995">//&nbsp;Waiting&nbsp;for&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword" id="7062017">func</span>&nbsp;<span class="op" id="7062022">(</span><span class="ident" id="7062023">test</span>&nbsp;<span class="op" id="7062028">*</span><span class="ident" id="7062029">clientTest</span><span class="op" id="7062039">)</span>&nbsp;<span class="ident" id="7062041">connFromCommand</span><span class="op" id="7062056">(</span><span class="op" id="7062057">)</span>&nbsp;<span class="op" id="7062059">(</span><span class="ident" id="7062060">conn</span>&nbsp;<span class="op" id="7062065">*</span><span class="ident" id="7062066">recordingConn</span><span class="op" id="7062079">,</span>&nbsp;<span class="ident" id="7062081">child</span>&nbsp;<span class="op" id="7062087">*</span><span class="ident" id="7062088">exec</span><span class="op" id="7062092">.</span><span class="ident" id="7062093">Cmd</span><span class="op" id="7062096">,</span>&nbsp;<span class="ident" id="7062098">stdin</span>&nbsp;<span class="ident" id="7062104">blockingSource</span><span class="op" id="7062118">,</span>&nbsp;<span class="ident" id="7062120">err</span>&nbsp;<span class="builtintype" id="7062124">error</span><span class="op" id="7062129">)</span>&nbsp;<span class="op" id="7062131">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7062134">cert</span>&nbsp;<span class="op" id="7062139">:=</span>&nbsp;<span class="ident" id="7062142">testRSACertificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7062162">if</span>&nbsp;<span class="builtinfunc" id="7062165">len</span><span class="op" id="7062168">(</span><span class="ident" id="7062169">test</span><span class="op" id="7062173">.</span><span class="ident" id="7062174">cert</span><span class="op" id="7062178">)</span>&nbsp;<span class="op" id="7062180">&gt;</span>&nbsp;<span class="num" id="7062182">0</span>&nbsp;<span class="op" id="7062184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7062188">cert</span>&nbsp;<span class="op" id="7062193">=</span>&nbsp;<span class="ident" id="7062195">test</span><span class="op" id="7062199">.</span><span class="ident" id="7062200">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7062206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7062209">certPath</span>&nbsp;<span class="op" id="7062218">:=</span>&nbsp;<span class="ident" id="7062221">tempFile</span><span class="op" id="7062229">(</span><span class="builtintype" id="7062230">string</span><span class="op" id="7062236">(</span><span class="ident" id="7062237">cert</span><span class="op" id="7062241">)</span><span class="op" id="7062242">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7062245">defer</span>&nbsp;<span class="ident" id="7062251">os</span><span class="op" id="7062253">.</span><span class="ident" id="7062254">Remove</span><span class="op" id="7062260">(</span><span class="ident" id="7062261">certPath</span><span class="op" id="7062269">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7062273">var</span>&nbsp;<span class="ident" id="7062277">key</span>&nbsp;<span class="keyword" id="7062281">interface</span><span class="op" id="7062290">{</span><span class="op" id="7062291">}</span>&nbsp;<span class="op" id="7062293">=</span>&nbsp;<span class="ident" id="7062295">testRSAPrivateKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7062314">if</span>&nbsp;<span class="ident" id="7062317">test</span><span class="op" id="7062321">.</span><span class="ident" id="7062322">key</span>&nbsp;<span class="op" id="7062326">!=</span>&nbsp;<span class="builtintype" id="7062329">nil</span>&nbsp;<span class="op" id="7062333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7062337">key</span>&nbsp;<span class="op" id="7062341">=</span>&nbsp;<span class="ident" id="7062343">test</span><span class="op" id="7062347">.</span><span class="ident" id="7062348">key</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7062353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7062356">var</span>&nbsp;<span class="ident" id="7062360">pemType</span>&nbsp;<span class="builtintype" id="7062368">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7062376">var</span>&nbsp;<span class="ident" id="7062380">derBytes</span>&nbsp;<span class="op" id="7062389">[</span><span class="op" id="7062390">]</span><span class="builtintype" id="7062391">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7062397">switch</span>&nbsp;<span class="ident" id="7062404">key</span>&nbsp;<span class="op" id="7062408">:=</span>&nbsp;<span class="ident" id="7062411">key</span><span class="op" id="7062414">.</span><span class="op" id="7062415">(</span><span class="keyword" id="7062416">type</span><span class="op" id="7062420">)</span>&nbsp;<span class="op" id="7062422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7062425">case</span>&nbsp;<span class="op" id="7062430">*</span><span class="ident" id="7062431">rsa</span><span class="op" id="7062434">.</span><span class="ident" id="7062435">PrivateKey</span><span class="op" id="7062445">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7062449">pemType</span>&nbsp;<span class="op" id="7062457">=</span>&nbsp;<span class="string" id="7062459">&#34;RSA&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7062467">derBytes</span>&nbsp;<span class="op" id="7062476">=</span>&nbsp;<span class="ident" id="7062478">x509</span><span class="op" id="7062482">.</span><span class="ident" id="7062483">MarshalPKCS1PrivateKey</span><span class="op" id="7062505">(</span><span class="ident" id="7062506">key</span><span class="op" id="7062509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7062512">case</span>&nbsp;<span class="op" id="7062517">*</span><span class="ident" id="7062518">ecdsa</span><span class="op" id="7062523">.</span><span class="ident" id="7062524">PrivateKey</span><span class="op" id="7062534">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7062538">pemType</span>&nbsp;<span class="op" id="7062546">=</span>&nbsp;<span class="string" id="7062548">&#34;EC&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7062555">var</span>&nbsp;<span class="ident" id="7062559">err</span>&nbsp;<span class="builtintype" id="7062563">error</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7062571">derBytes</span><span class="op" id="7062579">,</span>&nbsp;<span class="ident" id="7062581">err</span>&nbsp;<span class="op" id="7062585">=</span>&nbsp;<span class="ident" id="7062587">x509</span><span class="op" id="7062591">.</span><span class="ident" id="7062592">MarshalECPrivateKey</span><span class="op" id="7062611">(</span><span class="ident" id="7062612">key</span><span class="op" id="7062615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7062619">if</span>&nbsp;<span class="ident" id="7062622">err</span>&nbsp;<span class="op" id="7062626">!=</span>&nbsp;<span class="builtintype" id="7062629">nil</span>&nbsp;<span class="op" id="7062633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7062638">panic</span><span class="op" id="7062643">(</span><span class="ident" id="7062644">err</span><span class="op" id="7062647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7062651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7062654">default</span><span class="op" id="7062661">:</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7062665">panic</span><span class="op" id="7062670">(</span><span class="string" id="7062671">&#34;unknown&nbsp;key&nbsp;type&#34;</span><span class="op" id="7062689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7062692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7062696">var</span>&nbsp;<span class="ident" id="7062700">pemOut</span>&nbsp;<span class="ident" id="7062707">bytes</span><span class="op" id="7062712">.</span><span class="ident" id="7062713">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7062721">pem</span><span class="op" id="7062724">.</span><span class="ident" id="7062725">Encode</span><span class="op" id="7062731">(</span><span class="op" id="7062732">&amp;</span><span class="ident" id="7062733">pemOut</span><span class="op" id="7062739">,</span>&nbsp;<span class="op" id="7062741">&amp;</span><span class="ident" id="7062742">pem</span><span class="op" id="7062745">.</span><span class="ident" id="7062746">Block</span><span class="op" id="7062751">{</span><span class="ident" id="7062752">Type</span><span class="op" id="7062756">:</span>&nbsp;<span class="ident" id="7062758">pemType</span>&nbsp;<span class="op" id="7062766">+</span>&nbsp;<span class="string" id="7062768">&#34;&nbsp;PRIVATE&nbsp;KEY&#34;</span><span class="op" id="7062782">,</span>&nbsp;<span class="ident" id="7062784">Bytes</span><span class="op" id="7062789">:</span>&nbsp;<span class="ident" id="7062791">derBytes</span><span class="op" id="7062799">}</span><span class="op" id="7062800">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7062804">keyPath</span>&nbsp;<span class="op" id="7062812">:=</span>&nbsp;<span class="ident" id="7062815">tempFile</span><span class="op" id="7062823">(</span><span class="builtintype" id="7062824">string</span><span class="op" id="7062830">(</span><span class="ident" id="7062831">pemOut</span><span class="op" id="7062837">.</span><span class="ident" id="7062838">Bytes</span><span class="op" id="7062843">(</span><span class="op" id="7062844">)</span><span class="op" id="7062845">)</span><span class="op" id="7062846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7062849">defer</span>&nbsp;<span class="ident" id="7062855">os</span><span class="op" id="7062857">.</span><span class="ident" id="7062858">Remove</span><span class="op" id="7062864">(</span><span class="ident" id="7062865">keyPath</span><span class="op" id="7062872">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7062876">var</span>&nbsp;<span class="ident" id="7062880">command</span>&nbsp;<span class="op" id="7062888">[</span><span class="op" id="7062889">]</span><span class="builtintype" id="7062890">string</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7062898">if</span>&nbsp;<span class="builtinfunc" id="7062901">len</span><span class="op" id="7062904">(</span><span class="ident" id="7062905">test</span><span class="op" id="7062909">.</span><span class="ident" id="7062910">command</span><span class="op" id="7062917">)</span>&nbsp;<span class="op" id="7062919">&gt;</span>&nbsp;<span class="num" id="7062921">0</span>&nbsp;<span class="op" id="7062923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7062927">command</span>&nbsp;<span class="op" id="7062935">=</span>&nbsp;<span class="builtinfunc" id="7062937">append</span><span class="op" id="7062943">(</span><span class="ident" id="7062944">command</span><span class="op" id="7062951">,</span>&nbsp;<span class="ident" id="7062953">test</span><span class="op" id="7062957">.</span><span class="ident" id="7062958">command</span><span class="op" id="7062965">...</span><span class="op" id="7062968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7062971">}</span>&nbsp;<span class="keyword" id="7062973">else</span>&nbsp;<span class="op" id="7062978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7062982">command</span>&nbsp;<span class="op" id="7062990">=</span>&nbsp;<span class="builtinfunc" id="7062992">append</span><span class="op" id="7062998">(</span><span class="ident" id="7062999">command</span><span class="op" id="7063006">,</span>&nbsp;<span class="ident" id="7063008">defaultServerCommand</span><span class="op" id="7063028">...</span><span class="op" id="7063031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7063034">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7063037">command</span>&nbsp;<span class="op" id="7063045">=</span>&nbsp;<span class="builtinfunc" id="7063047">append</span><span class="op" id="7063053">(</span><span class="ident" id="7063054">command</span><span class="op" id="7063061">,</span>&nbsp;<span class="string" id="7063063">&#34;-cert&#34;</span><span class="op" id="7063070">,</span>&nbsp;<span class="ident" id="7063072">certPath</span><span class="op" id="7063080">,</span>&nbsp;<span class="string" id="7063082">&#34;-certform&#34;</span><span class="op" id="7063093">,</span>&nbsp;<span class="string" id="7063095">&#34;DER&#34;</span><span class="op" id="7063100">,</span>&nbsp;<span class="string" id="7063102">&#34;-key&#34;</span><span class="op" id="7063108">,</span>&nbsp;<span class="ident" id="7063110">keyPath</span><span class="op" id="7063117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7063120">//&nbsp;serverPort&nbsp;contains&nbsp;the&nbsp;port&nbsp;that&nbsp;OpenSSL&nbsp;will&nbsp;listen&nbsp;on.&nbsp;OpenSSL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7063190">//&nbsp;can&#39;t&nbsp;take&nbsp;&#34;0&#34;&nbsp;as&nbsp;an&nbsp;argument&nbsp;here&nbsp;so&nbsp;we&nbsp;have&nbsp;to&nbsp;pick&nbsp;a&nbsp;number&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7063261">//&nbsp;hope&nbsp;that&nbsp;it&#39;s&nbsp;not&nbsp;in&nbsp;use&nbsp;on&nbsp;the&nbsp;machine.&nbsp;Since&nbsp;this&nbsp;only&nbsp;occurs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7063330">//&nbsp;when&nbsp;-update&nbsp;is&nbsp;given&nbsp;and&nbsp;thus&nbsp;when&nbsp;there&#39;s&nbsp;a&nbsp;human&nbsp;watching&nbsp;the</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7063399">//&nbsp;test,&nbsp;this&nbsp;isn&#39;t&nbsp;too&nbsp;bad.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7063429">const</span>&nbsp;<span class="ident" id="7063435">serverPort</span>&nbsp;<span class="op" id="7063446">=</span>&nbsp;<span class="num" id="7063448">24323</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7063455">command</span>&nbsp;<span class="op" id="7063463">=</span>&nbsp;<span class="builtinfunc" id="7063465">append</span><span class="op" id="7063471">(</span><span class="ident" id="7063472">command</span><span class="op" id="7063479">,</span>&nbsp;<span class="string" id="7063481">&#34;-accept&#34;</span><span class="op" id="7063490">,</span>&nbsp;<span class="ident" id="7063492">strconv</span><span class="op" id="7063499">.</span><span class="ident" id="7063500">Itoa</span><span class="op" id="7063504">(</span><span class="ident" id="7063505">serverPort</span><span class="op" id="7063515">)</span><span class="op" id="7063516">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7063520">cmd</span>&nbsp;<span class="op" id="7063524">:=</span>&nbsp;<span class="ident" id="7063527">exec</span><span class="op" id="7063531">.</span><span class="ident" id="7063532">Command</span><span class="op" id="7063539">(</span><span class="ident" id="7063540">command</span><span class="op" id="7063547">[</span><span class="num" id="7063548">0</span><span class="op" id="7063549">]</span><span class="op" id="7063550">,</span>&nbsp;<span class="ident" id="7063552">command</span><span class="op" id="7063559">[</span><span class="num" id="7063560">1</span><span class="op" id="7063561">:</span><span class="op" id="7063562">]</span><span class="op" id="7063563">...</span><span class="op" id="7063566">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7063569">stdin</span>&nbsp;<span class="op" id="7063575">=</span>&nbsp;<span class="ident" id="7063577">blockingSource</span><span class="op" id="7063591">(</span><span class="builtinfunc" id="7063592">make</span><span class="op" id="7063596">(</span><span class="keyword" id="7063597">chan</span>&nbsp;<span class="builtintype" id="7063602">bool</span><span class="op" id="7063606">)</span><span class="op" id="7063607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7063610">cmd</span><span class="op" id="7063613">.</span><span class="ident" id="7063614">Stdin</span>&nbsp;<span class="op" id="7063620">=</span>&nbsp;<span class="ident" id="7063622">stdin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7063629">var</span>&nbsp;<span class="ident" id="7063633">out</span>&nbsp;<span class="ident" id="7063637">bytes</span><span class="op" id="7063642">.</span><span class="ident" id="7063643">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7063651">cmd</span><span class="op" id="7063654">.</span><span class="ident" id="7063655">Stdout</span>&nbsp;<span class="op" id="7063662">=</span>&nbsp;<span class="op" id="7063664">&amp;</span><span class="ident" id="7063665">out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7063670">cmd</span><span class="op" id="7063673">.</span><span class="ident" id="7063674">Stderr</span>&nbsp;<span class="op" id="7063681">=</span>&nbsp;<span class="op" id="7063683">&amp;</span><span class="ident" id="7063684">out</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7063689">if</span>&nbsp;<span class="ident" id="7063692">err</span>&nbsp;<span class="op" id="7063696">:=</span>&nbsp;<span class="ident" id="7063699">cmd</span><span class="op" id="7063702">.</span><span class="ident" id="7063703">Start</span><span class="op" id="7063708">(</span><span class="op" id="7063709">)</span><span class="op" id="7063710">;</span>&nbsp;<span class="ident" id="7063712">err</span>&nbsp;<span class="op" id="7063716">!=</span>&nbsp;<span class="builtintype" id="7063719">nil</span>&nbsp;<span class="op" id="7063723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7063727">return</span>&nbsp;<span class="builtintype" id="7063734">nil</span><span class="op" id="7063737">,</span>&nbsp;<span class="builtintype" id="7063739">nil</span><span class="op" id="7063742">,</span>&nbsp;<span class="builtintype" id="7063744">nil</span><span class="op" id="7063747">,</span>&nbsp;<span class="ident" id="7063749">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7063754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7063758">//&nbsp;OpenSSL&nbsp;does&nbsp;print&nbsp;an&nbsp;&#34;ACCEPT&#34;&nbsp;banner,&nbsp;but&nbsp;it&nbsp;does&nbsp;so&nbsp;*before*</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7063825">//&nbsp;opening&nbsp;the&nbsp;listening&nbsp;socket,&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;use&nbsp;that&nbsp;to&nbsp;wait&nbsp;until&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7063897">//&nbsp;has&nbsp;started&nbsp;listening.&nbsp;Thus&nbsp;we&nbsp;are&nbsp;forced&nbsp;to&nbsp;poll&nbsp;until&nbsp;we&nbsp;get&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7063966">//&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7063982">var</span>&nbsp;<span class="ident" id="7063986">tcpConn</span>&nbsp;<span class="ident" id="7063994">net</span><span class="op" id="7063997">.</span><span class="ident" id="7063998">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064004">for</span>&nbsp;<span class="ident" id="7064008">i</span>&nbsp;<span class="op" id="7064010">:=</span>&nbsp;<span class="builtintype" id="7064013">uint</span><span class="op" id="7064017">(</span><span class="num" id="7064018">0</span><span class="op" id="7064019">)</span><span class="op" id="7064020">;</span>&nbsp;<span class="ident" id="7064022">i</span>&nbsp;<span class="op" id="7064024">&lt;</span>&nbsp;<span class="num" id="7064026">5</span><span class="op" id="7064027">;</span>&nbsp;<span class="ident" id="7064029">i</span><span class="op" id="7064030">++</span>&nbsp;<span class="op" id="7064033">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064037">var</span>&nbsp;<span class="ident" id="7064041">err</span>&nbsp;<span class="builtintype" id="7064045">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7064053">tcpConn</span><span class="op" id="7064060">,</span>&nbsp;<span class="ident" id="7064062">err</span>&nbsp;<span class="op" id="7064066">=</span>&nbsp;<span class="ident" id="7064068">net</span><span class="op" id="7064071">.</span><span class="ident" id="7064072">DialTCP</span><span class="op" id="7064079">(</span><span class="string" id="7064080">&#34;tcp&#34;</span><span class="op" id="7064085">,</span>&nbsp;<span class="builtintype" id="7064087">nil</span><span class="op" id="7064090">,</span>&nbsp;<span class="op" id="7064092">&amp;</span><span class="ident" id="7064093">net</span><span class="op" id="7064096">.</span><span class="ident" id="7064097">TCPAddr</span><span class="op" id="7064104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7064109">IP</span><span class="op" id="7064111">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7064115">net</span><span class="op" id="7064118">.</span><span class="ident" id="7064119">IPv4</span><span class="op" id="7064123">(</span><span class="num" id="7064124">127</span><span class="op" id="7064127">,</span>&nbsp;<span class="num" id="7064129">0</span><span class="op" id="7064130">,</span>&nbsp;<span class="num" id="7064132">0</span><span class="op" id="7064133">,</span>&nbsp;<span class="num" id="7064135">1</span><span class="op" id="7064136">)</span><span class="op" id="7064137">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7064142">Port</span><span class="op" id="7064146">:</span>&nbsp;<span class="ident" id="7064148">serverPort</span><span class="op" id="7064158">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7064162">}</span><span class="op" id="7064163">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064167">if</span>&nbsp;<span class="ident" id="7064170">err</span>&nbsp;<span class="op" id="7064174">==</span>&nbsp;<span class="builtintype" id="7064177">nil</span>&nbsp;<span class="op" id="7064181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064186">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7064194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7064198">time</span><span class="op" id="7064202">.</span><span class="ident" id="7064203">Sleep</span><span class="op" id="7064208">(</span><span class="op" id="7064209">(</span><span class="num" id="7064210">1</span>&nbsp;<span class="op" id="7064212">&lt;&lt;</span>&nbsp;<span class="ident" id="7064215">i</span><span class="op" id="7064216">)</span>&nbsp;<span class="op" id="7064218">*</span>&nbsp;<span class="num" id="7064220">5</span>&nbsp;<span class="op" id="7064222">*</span>&nbsp;<span class="ident" id="7064224">time</span><span class="op" id="7064228">.</span><span class="ident" id="7064229">Millisecond</span><span class="op" id="7064240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7064243">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064246">if</span>&nbsp;<span class="ident" id="7064249">tcpConn</span>&nbsp;<span class="op" id="7064257">==</span>&nbsp;<span class="builtintype" id="7064260">nil</span>&nbsp;<span class="op" id="7064264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7064268">close</span><span class="op" id="7064273">(</span><span class="ident" id="7064274">stdin</span><span class="op" id="7064279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7064283">out</span><span class="op" id="7064286">.</span><span class="ident" id="7064287">WriteTo</span><span class="op" id="7064294">(</span><span class="ident" id="7064295">os</span><span class="op" id="7064297">.</span><span class="ident" id="7064298">Stdout</span><span class="op" id="7064304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7064308">cmd</span><span class="op" id="7064311">.</span><span class="ident" id="7064312">Process</span><span class="op" id="7064319">.</span><span class="ident" id="7064320">Kill</span><span class="op" id="7064324">(</span><span class="op" id="7064325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064329">return</span>&nbsp;<span class="builtintype" id="7064336">nil</span><span class="op" id="7064339">,</span>&nbsp;<span class="builtintype" id="7064341">nil</span><span class="op" id="7064344">,</span>&nbsp;<span class="builtintype" id="7064346">nil</span><span class="op" id="7064349">,</span>&nbsp;<span class="ident" id="7064351">cmd</span><span class="op" id="7064354">.</span><span class="ident" id="7064355">Wait</span><span class="op" id="7064359">(</span><span class="op" id="7064360">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7064363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7064367">record</span>&nbsp;<span class="op" id="7064374">:=</span>&nbsp;<span class="op" id="7064377">&amp;</span><span class="ident" id="7064378">recordingConn</span><span class="op" id="7064391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7064395">Conn</span><span class="op" id="7064399">:</span>&nbsp;<span class="ident" id="7064401">tcpConn</span><span class="op" id="7064408">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7064411">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064415">return</span>&nbsp;<span class="ident" id="7064422">record</span><span class="op" id="7064428">,</span>&nbsp;<span class="ident" id="7064430">cmd</span><span class="op" id="7064433">,</span>&nbsp;<span class="ident" id="7064435">stdin</span><span class="op" id="7064440">,</span>&nbsp;<span class="builtintype" id="7064442">nil</span><br>
<span class="lineno"></span><span class="op" id="7064446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7064449">func</span>&nbsp;<span class="op" id="7064454">(</span><span class="ident" id="7064455">test</span>&nbsp;<span class="op" id="7064460">*</span><span class="ident" id="7064461">clientTest</span><span class="op" id="7064471">)</span>&nbsp;<span class="ident" id="7064473">dataPath</span><span class="op" id="7064481">(</span><span class="op" id="7064482">)</span>&nbsp;<span class="builtintype" id="7064484">string</span>&nbsp;<span class="op" id="7064491">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064494">return</span>&nbsp;<span class="ident" id="7064501">filepath</span><span class="op" id="7064509">.</span><span class="ident" id="7064510">Join</span><span class="op" id="7064514">(</span><span class="string" id="7064515">&#34;testdata&#34;</span><span class="op" id="7064525">,</span>&nbsp;<span class="string" id="7064527">&#34;Client-&#34;</span><span class="op" id="7064536">+</span><span class="ident" id="7064537">test</span><span class="op" id="7064541">.</span><span class="ident" id="7064542">name</span><span class="op" id="7064546">)</span><br>
<span class="lineno"></span><span class="op" id="7064548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7064551">func</span>&nbsp;<span class="op" id="7064556">(</span><span class="ident" id="7064557">test</span>&nbsp;<span class="op" id="7064562">*</span><span class="ident" id="7064563">clientTest</span><span class="op" id="7064573">)</span>&nbsp;<span class="ident" id="7064575">loadData</span><span class="op" id="7064583">(</span><span class="op" id="7064584">)</span>&nbsp;<span class="op" id="7064586">(</span><span class="ident" id="7064587">flows</span>&nbsp;<span class="op" id="7064593">[</span><span class="op" id="7064594">]</span><span class="op" id="7064595">[</span><span class="op" id="7064596">]</span><span class="builtintype" id="7064597">byte</span><span class="op" id="7064601">,</span>&nbsp;<span class="ident" id="7064603">err</span>&nbsp;<span class="builtintype" id="7064607">error</span><span class="op" id="7064612">)</span>&nbsp;<span class="op" id="7064614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7064617">in</span><span class="op" id="7064619">,</span>&nbsp;<span class="ident" id="7064621">err</span>&nbsp;<span class="op" id="7064625">:=</span>&nbsp;<span class="ident" id="7064628">os</span><span class="op" id="7064630">.</span><span class="ident" id="7064631">Open</span><span class="op" id="7064635">(</span><span class="ident" id="7064636">test</span><span class="op" id="7064640">.</span><span class="ident" id="7064641">dataPath</span><span class="op" id="7064649">(</span><span class="op" id="7064650">)</span><span class="op" id="7064651">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064654">if</span>&nbsp;<span class="ident" id="7064657">err</span>&nbsp;<span class="op" id="7064661">!=</span>&nbsp;<span class="builtintype" id="7064664">nil</span>&nbsp;<span class="op" id="7064668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064672">return</span>&nbsp;<span class="builtintype" id="7064679">nil</span><span class="op" id="7064682">,</span>&nbsp;<span class="ident" id="7064684">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7064689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064692">defer</span>&nbsp;<span class="ident" id="7064698">in</span><span class="op" id="7064700">.</span><span class="ident" id="7064701">Close</span><span class="op" id="7064706">(</span><span class="op" id="7064707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064710">return</span>&nbsp;<span class="ident" id="7064717">parseTestData</span><span class="op" id="7064730">(</span><span class="ident" id="7064731">in</span><span class="op" id="7064733">)</span><br>
<span class="lineno">165</span><span class="op" id="7064735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7064738">func</span>&nbsp;<span class="op" id="7064743">(</span><span class="ident" id="7064744">test</span>&nbsp;<span class="op" id="7064749">*</span><span class="ident" id="7064750">clientTest</span><span class="op" id="7064760">)</span>&nbsp;<span class="ident" id="7064762">run</span><span class="op" id="7064765">(</span><span class="ident" id="7064766">t</span>&nbsp;<span class="op" id="7064768">*</span><span class="ident" id="7064769">testing</span><span class="op" id="7064776">.</span><span class="ident" id="7064777">T</span><span class="op" id="7064778">,</span>&nbsp;<span class="ident" id="7064780">write</span>&nbsp;<span class="builtintype" id="7064786">bool</span><span class="op" id="7064790">)</span>&nbsp;<span class="op" id="7064792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064795">var</span>&nbsp;<span class="ident" id="7064799">clientConn</span><span class="op" id="7064809">,</span>&nbsp;<span class="ident" id="7064811">serverConn</span>&nbsp;<span class="ident" id="7064822">net</span><span class="op" id="7064825">.</span><span class="ident" id="7064826">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064832">var</span>&nbsp;<span class="ident" id="7064836">recordingConn</span>&nbsp;<span class="op" id="7064850">*</span><span class="ident" id="7064851">recordingConn</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064866">var</span>&nbsp;<span class="ident" id="7064870">childProcess</span>&nbsp;<span class="op" id="7064883">*</span><span class="ident" id="7064884">exec</span><span class="op" id="7064888">.</span><span class="ident" id="7064889">Cmd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064894">var</span>&nbsp;<span class="ident" id="7064898">stdin</span>&nbsp;<span class="ident" id="7064904">blockingSource</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064921">if</span>&nbsp;<span class="ident" id="7064924">write</span>&nbsp;<span class="op" id="7064930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7064934">var</span>&nbsp;<span class="ident" id="7064938">err</span>&nbsp;<span class="builtintype" id="7064942">error</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7064950">recordingConn</span><span class="op" id="7064963">,</span>&nbsp;<span class="ident" id="7064965">childProcess</span><span class="op" id="7064977">,</span>&nbsp;<span class="ident" id="7064979">stdin</span><span class="op" id="7064984">,</span>&nbsp;<span class="ident" id="7064986">err</span>&nbsp;<span class="op" id="7064990">=</span>&nbsp;<span class="ident" id="7064992">test</span><span class="op" id="7064996">.</span><span class="ident" id="7064997">connFromCommand</span><span class="op" id="7065012">(</span><span class="op" id="7065013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7065017">if</span>&nbsp;<span class="ident" id="7065020">err</span>&nbsp;<span class="op" id="7065024">!=</span>&nbsp;<span class="builtintype" id="7065027">nil</span>&nbsp;<span class="op" id="7065031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065036">t</span><span class="op" id="7065037">.</span><span class="ident" id="7065038">Fatalf</span><span class="op" id="7065044">(</span><span class="string" id="7065045">&#34;Failed&nbsp;to&nbsp;start&nbsp;subcommand:&nbsp;%s&#34;</span><span class="op" id="7065077">,</span>&nbsp;<span class="ident" id="7065079">err</span><span class="op" id="7065082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7065086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065090">clientConn</span>&nbsp;<span class="op" id="7065101">=</span>&nbsp;<span class="ident" id="7065103">recordingConn</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7065118">}</span>&nbsp;<span class="keyword" id="7065120">else</span>&nbsp;<span class="op" id="7065125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065129">clientConn</span><span class="op" id="7065139">,</span>&nbsp;<span class="ident" id="7065141">serverConn</span>&nbsp;<span class="op" id="7065152">=</span>&nbsp;<span class="ident" id="7065154">net</span><span class="op" id="7065157">.</span><span class="ident" id="7065158">Pipe</span><span class="op" id="7065162">(</span><span class="op" id="7065163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7065166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065170">config</span>&nbsp;<span class="op" id="7065177">:=</span>&nbsp;<span class="ident" id="7065180">test</span><span class="op" id="7065184">.</span><span class="ident" id="7065185">config</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7065193">if</span>&nbsp;<span class="ident" id="7065196">config</span>&nbsp;<span class="op" id="7065203">==</span>&nbsp;<span class="builtintype" id="7065206">nil</span>&nbsp;<span class="op" id="7065210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065214">config</span>&nbsp;<span class="op" id="7065221">=</span>&nbsp;<span class="ident" id="7065223">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7065235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065238">client</span>&nbsp;<span class="op" id="7065245">:=</span>&nbsp;<span class="ident" id="7065248">Client</span><span class="op" id="7065254">(</span><span class="ident" id="7065255">clientConn</span><span class="op" id="7065265">,</span>&nbsp;<span class="ident" id="7065267">config</span><span class="op" id="7065273">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065277">doneChan</span>&nbsp;<span class="op" id="7065286">:=</span>&nbsp;<span class="builtinfunc" id="7065289">make</span><span class="op" id="7065293">(</span><span class="keyword" id="7065294">chan</span>&nbsp;<span class="builtintype" id="7065299">bool</span><span class="op" id="7065303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7065306">go</span>&nbsp;<span class="keyword" id="7065309">func</span><span class="op" id="7065313">(</span><span class="op" id="7065314">)</span>&nbsp;<span class="op" id="7065316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7065320">if</span>&nbsp;<span class="ident" id="7065323">_</span><span class="op" id="7065324">,</span>&nbsp;<span class="ident" id="7065326">err</span>&nbsp;<span class="op" id="7065330">:=</span>&nbsp;<span class="ident" id="7065333">client</span><span class="op" id="7065339">.</span><span class="ident" id="7065340">Write</span><span class="op" id="7065345">(</span><span class="op" id="7065346">[</span><span class="op" id="7065347">]</span><span class="builtintype" id="7065348">byte</span><span class="op" id="7065352">(</span><span class="string" id="7065353">&#34;hello\n&#34;</span><span class="op" id="7065362">)</span><span class="op" id="7065363">)</span><span class="op" id="7065364">;</span>&nbsp;<span class="ident" id="7065366">err</span>&nbsp;<span class="op" id="7065370">!=</span>&nbsp;<span class="builtintype" id="7065373">nil</span>&nbsp;<span class="op" id="7065377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065382">t</span><span class="op" id="7065383">.</span><span class="ident" id="7065384">Logf</span><span class="op" id="7065388">(</span><span class="string" id="7065389">&#34;Client.Write&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7065414">,</span>&nbsp;<span class="ident" id="7065416">err</span><span class="op" id="7065419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7065423">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7065427">if</span>&nbsp;<span class="ident" id="7065430">test</span><span class="op" id="7065434">.</span><span class="ident" id="7065435">validate</span>&nbsp;<span class="op" id="7065444">!=</span>&nbsp;<span class="builtintype" id="7065447">nil</span>&nbsp;<span class="op" id="7065451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7065456">if</span>&nbsp;<span class="ident" id="7065459">err</span>&nbsp;<span class="op" id="7065463">:=</span>&nbsp;<span class="ident" id="7065466">test</span><span class="op" id="7065470">.</span><span class="ident" id="7065471">validate</span><span class="op" id="7065479">(</span><span class="ident" id="7065480">client</span><span class="op" id="7065486">.</span><span class="ident" id="7065487">ConnectionState</span><span class="op" id="7065502">(</span><span class="op" id="7065503">)</span><span class="op" id="7065504">)</span><span class="op" id="7065505">;</span>&nbsp;<span class="ident" id="7065507">err</span>&nbsp;<span class="op" id="7065511">!=</span>&nbsp;<span class="builtintype" id="7065514">nil</span>&nbsp;<span class="op" id="7065518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065524">t</span><span class="op" id="7065525">.</span><span class="ident" id="7065526">Logf</span><span class="op" id="7065530">(</span><span class="string" id="7065531">&#34;validate&nbsp;callback&nbsp;returned&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="7065569">,</span>&nbsp;<span class="ident" id="7065571">err</span><span class="op" id="7065574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7065579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7065583">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065587">client</span><span class="op" id="7065593">.</span><span class="ident" id="7065594">Close</span><span class="op" id="7065599">(</span><span class="op" id="7065600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065604">clientConn</span><span class="op" id="7065614">.</span><span class="ident" id="7065615">Close</span><span class="op" id="7065620">(</span><span class="op" id="7065621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065625">doneChan</span>&nbsp;<span class="op" id="7065634">&lt;-</span>&nbsp;<span class="builtintype" id="7065637">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7065643">}</span><span class="op" id="7065644">(</span><span class="op" id="7065645">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7065649">if</span>&nbsp;<span class="op" id="7065652">!</span><span class="ident" id="7065653">write</span>&nbsp;<span class="op" id="7065659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065663">flows</span><span class="op" id="7065668">,</span>&nbsp;<span class="ident" id="7065670">err</span>&nbsp;<span class="op" id="7065674">:=</span>&nbsp;<span class="ident" id="7065677">test</span><span class="op" id="7065681">.</span><span class="ident" id="7065682">loadData</span><span class="op" id="7065690">(</span><span class="op" id="7065691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7065695">if</span>&nbsp;<span class="ident" id="7065698">err</span>&nbsp;<span class="op" id="7065702">!=</span>&nbsp;<span class="builtintype" id="7065705">nil</span>&nbsp;<span class="op" id="7065709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065714">t</span><span class="op" id="7065715">.</span><span class="ident" id="7065716">Fatalf</span><span class="op" id="7065722">(</span><span class="string" id="7065723">&#34;%s:&nbsp;failed&nbsp;to&nbsp;load&nbsp;data&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="7065760">,</span>&nbsp;<span class="ident" id="7065762">test</span><span class="op" id="7065766">.</span><span class="ident" id="7065767">name</span><span class="op" id="7065771">,</span>&nbsp;<span class="ident" id="7065773">test</span><span class="op" id="7065777">.</span><span class="ident" id="7065778">dataPath</span><span class="op" id="7065786">(</span><span class="op" id="7065787">)</span><span class="op" id="7065788">,</span>&nbsp;<span class="ident" id="7065790">err</span><span class="op" id="7065793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7065797">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7065801">for</span>&nbsp;<span class="ident" id="7065805">i</span><span class="op" id="7065806">,</span>&nbsp;<span class="ident" id="7065808">b</span>&nbsp;<span class="op" id="7065810">:=</span>&nbsp;<span class="keyword" id="7065813">range</span>&nbsp;<span class="ident" id="7065819">flows</span>&nbsp;<span class="op" id="7065825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7065830">if</span>&nbsp;<span class="ident" id="7065833">i</span><span class="op" id="7065834">%</span><span class="num" id="7065835">2</span>&nbsp;<span class="op" id="7065837">==</span>&nbsp;<span class="num" id="7065840">1</span>&nbsp;<span class="op" id="7065842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065848">serverConn</span><span class="op" id="7065858">.</span><span class="ident" id="7065859">Write</span><span class="op" id="7065864">(</span><span class="ident" id="7065865">b</span><span class="op" id="7065866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7065872">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7065884">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065889">bb</span>&nbsp;<span class="op" id="7065892">:=</span>&nbsp;<span class="builtinfunc" id="7065895">make</span><span class="op" id="7065899">(</span><span class="op" id="7065900">[</span><span class="op" id="7065901">]</span><span class="builtintype" id="7065902">byte</span><span class="op" id="7065906">,</span>&nbsp;<span class="builtinfunc" id="7065908">len</span><span class="op" id="7065911">(</span><span class="ident" id="7065912">b</span><span class="op" id="7065913">)</span><span class="op" id="7065914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065919">_</span><span class="op" id="7065920">,</span>&nbsp;<span class="ident" id="7065922">err</span>&nbsp;<span class="op" id="7065926">:=</span>&nbsp;<span class="ident" id="7065929">io</span><span class="op" id="7065931">.</span><span class="ident" id="7065932">ReadFull</span><span class="op" id="7065940">(</span><span class="ident" id="7065941">serverConn</span><span class="op" id="7065951">,</span>&nbsp;<span class="ident" id="7065953">bb</span><span class="op" id="7065955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7065960">if</span>&nbsp;<span class="ident" id="7065963">err</span>&nbsp;<span class="op" id="7065967">!=</span>&nbsp;<span class="builtintype" id="7065970">nil</span>&nbsp;<span class="op" id="7065974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7065980">t</span><span class="op" id="7065981">.</span><span class="ident" id="7065982">Fatalf</span><span class="op" id="7065988">(</span><span class="string" id="7065989">&#34;%s&nbsp;#%d:&nbsp;%s&#34;</span><span class="op" id="7066001">,</span>&nbsp;<span class="ident" id="7066003">test</span><span class="op" id="7066007">.</span><span class="ident" id="7066008">name</span><span class="op" id="7066012">,</span>&nbsp;<span class="ident" id="7066014">i</span><span class="op" id="7066015">,</span>&nbsp;<span class="ident" id="7066017">err</span><span class="op" id="7066020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7066025">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7066030">if</span>&nbsp;<span class="op" id="7066033">!</span><span class="ident" id="7066034">bytes</span><span class="op" id="7066039">.</span><span class="ident" id="7066040">Equal</span><span class="op" id="7066045">(</span><span class="ident" id="7066046">b</span><span class="op" id="7066047">,</span>&nbsp;<span class="ident" id="7066049">bb</span><span class="op" id="7066051">)</span>&nbsp;<span class="op" id="7066053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066059">t</span><span class="op" id="7066060">.</span><span class="ident" id="7066061">Fatalf</span><span class="op" id="7066067">(</span><span class="string" id="7066068">&#34;%s&nbsp;#%d:&nbsp;mismatch&nbsp;on&nbsp;read:&nbsp;got:%x&nbsp;want:%x&#34;</span><span class="op" id="7066110">,</span>&nbsp;<span class="ident" id="7066112">test</span><span class="op" id="7066116">.</span><span class="ident" id="7066117">name</span><span class="op" id="7066121">,</span>&nbsp;<span class="ident" id="7066123">i</span><span class="op" id="7066124">,</span>&nbsp;<span class="ident" id="7066126">bb</span><span class="op" id="7066128">,</span>&nbsp;<span class="ident" id="7066130">b</span><span class="op" id="7066131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7066136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7066140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066144">serverConn</span><span class="op" id="7066154">.</span><span class="ident" id="7066155">Close</span><span class="op" id="7066160">(</span><span class="op" id="7066161">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7066164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7066168">&lt;-</span><span class="ident" id="7066170">doneChan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7066181">if</span>&nbsp;<span class="ident" id="7066184">write</span>&nbsp;<span class="op" id="7066190">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066194">path</span>&nbsp;<span class="op" id="7066199">:=</span>&nbsp;<span class="ident" id="7066202">test</span><span class="op" id="7066206">.</span><span class="ident" id="7066207">dataPath</span><span class="op" id="7066215">(</span><span class="op" id="7066216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066220">out</span><span class="op" id="7066223">,</span>&nbsp;<span class="ident" id="7066225">err</span>&nbsp;<span class="op" id="7066229">:=</span>&nbsp;<span class="ident" id="7066232">os</span><span class="op" id="7066234">.</span><span class="ident" id="7066235">OpenFile</span><span class="op" id="7066243">(</span><span class="ident" id="7066244">path</span><span class="op" id="7066248">,</span>&nbsp;<span class="ident" id="7066250">os</span><span class="op" id="7066252">.</span><span class="ident" id="7066253">O_WRONLY</span><span class="op" id="7066261">|</span><span class="ident" id="7066262">os</span><span class="op" id="7066264">.</span><span class="ident" id="7066265">O_CREATE</span><span class="op" id="7066273">|</span><span class="ident" id="7066274">os</span><span class="op" id="7066276">.</span><span class="ident" id="7066277">O_TRUNC</span><span class="op" id="7066284">,</span>&nbsp;<span class="num" id="7066286">0644</span><span class="op" id="7066290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7066294">if</span>&nbsp;<span class="ident" id="7066297">err</span>&nbsp;<span class="op" id="7066301">!=</span>&nbsp;<span class="builtintype" id="7066304">nil</span>&nbsp;<span class="op" id="7066308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066313">t</span><span class="op" id="7066314">.</span><span class="ident" id="7066315">Fatalf</span><span class="op" id="7066321">(</span><span class="string" id="7066322">&#34;Failed&nbsp;to&nbsp;create&nbsp;output&nbsp;file:&nbsp;%s&#34;</span><span class="op" id="7066356">,</span>&nbsp;<span class="ident" id="7066358">err</span><span class="op" id="7066361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7066365">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7066369">defer</span>&nbsp;<span class="ident" id="7066375">out</span><span class="op" id="7066378">.</span><span class="ident" id="7066379">Close</span><span class="op" id="7066384">(</span><span class="op" id="7066385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066389">recordingConn</span><span class="op" id="7066402">.</span><span class="ident" id="7066403">Close</span><span class="op" id="7066408">(</span><span class="op" id="7066409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7066413">close</span><span class="op" id="7066418">(</span><span class="ident" id="7066419">stdin</span><span class="op" id="7066424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066428">childProcess</span><span class="op" id="7066440">.</span><span class="ident" id="7066441">Process</span><span class="op" id="7066448">.</span><span class="ident" id="7066449">Kill</span><span class="op" id="7066453">(</span><span class="op" id="7066454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066458">childProcess</span><span class="op" id="7066470">.</span><span class="ident" id="7066471">Wait</span><span class="op" id="7066475">(</span><span class="op" id="7066476">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7066480">if</span>&nbsp;<span class="builtinfunc" id="7066483">len</span><span class="op" id="7066486">(</span><span class="ident" id="7066487">recordingConn</span><span class="op" id="7066500">.</span><span class="ident" id="7066501">flows</span><span class="op" id="7066506">)</span>&nbsp;<span class="op" id="7066508">&lt;</span>&nbsp;<span class="num" id="7066510">3</span>&nbsp;<span class="op" id="7066512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066517">childProcess</span><span class="op" id="7066529">.</span><span class="ident" id="7066530">Stdout</span><span class="op" id="7066536">.</span><span class="op" id="7066537">(</span><span class="op" id="7066538">*</span><span class="ident" id="7066539">bytes</span><span class="op" id="7066544">.</span><span class="ident" id="7066545">Buffer</span><span class="op" id="7066551">)</span><span class="op" id="7066552">.</span><span class="ident" id="7066553">WriteTo</span><span class="op" id="7066560">(</span><span class="ident" id="7066561">os</span><span class="op" id="7066563">.</span><span class="ident" id="7066564">Stdout</span><span class="op" id="7066570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066575">t</span><span class="op" id="7066576">.</span><span class="ident" id="7066577">Fatalf</span><span class="op" id="7066583">(</span><span class="string" id="7066584">&#34;Client&nbsp;connection&nbsp;didn&#39;t&nbsp;work&#34;</span><span class="op" id="7066615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7066619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066623">recordingConn</span><span class="op" id="7066636">.</span><span class="ident" id="7066637">WriteTo</span><span class="op" id="7066644">(</span><span class="ident" id="7066645">out</span><span class="op" id="7066648">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066652">fmt</span><span class="op" id="7066655">.</span><span class="ident" id="7066656">Printf</span><span class="op" id="7066662">(</span><span class="string" id="7066663">&#34;Wrote&nbsp;%s\n&#34;</span><span class="op" id="7066675">,</span>&nbsp;<span class="ident" id="7066677">path</span><span class="op" id="7066681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7066684">}</span><br>
<span class="lineno"></span><span class="op" id="7066686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7066689">func</span>&nbsp;<span class="ident" id="7066694">runClientTestForVersion</span><span class="op" id="7066717">(</span><span class="ident" id="7066718">t</span>&nbsp;<span class="op" id="7066720">*</span><span class="ident" id="7066721">testing</span><span class="op" id="7066728">.</span><span class="ident" id="7066729">T</span><span class="op" id="7066730">,</span>&nbsp;<span class="ident" id="7066732">template</span>&nbsp;<span class="op" id="7066741">*</span><span class="ident" id="7066742">clientTest</span><span class="op" id="7066752">,</span>&nbsp;<span class="ident" id="7066754">prefix</span><span class="op" id="7066760">,</span>&nbsp;<span class="ident" id="7066762">option</span>&nbsp;<span class="builtintype" id="7066769">string</span><span class="op" id="7066775">)</span>&nbsp;<span class="op" id="7066777">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066780">test</span>&nbsp;<span class="op" id="7066785">:=</span>&nbsp;<span class="op" id="7066788">*</span><span class="ident" id="7066789">template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066799">test</span><span class="op" id="7066803">.</span><span class="ident" id="7066804">name</span>&nbsp;<span class="op" id="7066809">=</span>&nbsp;<span class="ident" id="7066811">prefix</span>&nbsp;<span class="op" id="7066818">+</span>&nbsp;<span class="ident" id="7066820">test</span><span class="op" id="7066824">.</span><span class="ident" id="7066825">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7066831">if</span>&nbsp;<span class="builtinfunc" id="7066834">len</span><span class="op" id="7066837">(</span><span class="ident" id="7066838">test</span><span class="op" id="7066842">.</span><span class="ident" id="7066843">command</span><span class="op" id="7066850">)</span>&nbsp;<span class="op" id="7066852">==</span>&nbsp;<span class="num" id="7066855">0</span>&nbsp;<span class="op" id="7066857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066861">test</span><span class="op" id="7066865">.</span><span class="ident" id="7066866">command</span>&nbsp;<span class="op" id="7066874">=</span>&nbsp;<span class="ident" id="7066876">defaultClientCommand</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7066898">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066901">test</span><span class="op" id="7066905">.</span><span class="ident" id="7066906">command</span>&nbsp;<span class="op" id="7066914">=</span>&nbsp;<span class="builtinfunc" id="7066916">append</span><span class="op" id="7066922">(</span><span class="op" id="7066923">[</span><span class="op" id="7066924">]</span><span class="builtintype" id="7066925">string</span><span class="op" id="7066931">(</span><span class="builtintype" id="7066932">nil</span><span class="op" id="7066935">)</span><span class="op" id="7066936">,</span>&nbsp;<span class="ident" id="7066938">test</span><span class="op" id="7066942">.</span><span class="ident" id="7066943">command</span><span class="op" id="7066950">...</span><span class="op" id="7066953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7066956">test</span><span class="op" id="7066960">.</span><span class="ident" id="7066961">command</span>&nbsp;<span class="op" id="7066969">=</span>&nbsp;<span class="builtinfunc" id="7066971">append</span><span class="op" id="7066977">(</span><span class="ident" id="7066978">test</span><span class="op" id="7066982">.</span><span class="ident" id="7066983">command</span><span class="op" id="7066990">,</span>&nbsp;<span class="ident" id="7066992">option</span><span class="op" id="7066998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067001">test</span><span class="op" id="7067005">.</span><span class="ident" id="7067006">run</span><span class="op" id="7067009">(</span><span class="ident" id="7067010">t</span><span class="op" id="7067011">,</span>&nbsp;<span class="op" id="7067013">*</span><span class="ident" id="7067014">update</span><span class="op" id="7067020">)</span><br>
<span class="lineno"></span><span class="op" id="7067022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="keyword" id="7067025">func</span>&nbsp;<span class="ident" id="7067030">runClientTestTLS10</span><span class="op" id="7067048">(</span><span class="ident" id="7067049">t</span>&nbsp;<span class="op" id="7067051">*</span><span class="ident" id="7067052">testing</span><span class="op" id="7067059">.</span><span class="ident" id="7067060">T</span><span class="op" id="7067061">,</span>&nbsp;<span class="ident" id="7067063">template</span>&nbsp;<span class="op" id="7067072">*</span><span class="ident" id="7067073">clientTest</span><span class="op" id="7067083">)</span>&nbsp;<span class="op" id="7067085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067088">runClientTestForVersion</span><span class="op" id="7067111">(</span><span class="ident" id="7067112">t</span><span class="op" id="7067113">,</span>&nbsp;<span class="ident" id="7067115">template</span><span class="op" id="7067123">,</span>&nbsp;<span class="string" id="7067125">&#34;TLSv10-&#34;</span><span class="op" id="7067134">,</span>&nbsp;<span class="string" id="7067136">&#34;-tls1&#34;</span><span class="op" id="7067143">)</span><br>
<span class="lineno"></span><span class="op" id="7067145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7067148">func</span>&nbsp;<span class="ident" id="7067153">runClientTestTLS11</span><span class="op" id="7067171">(</span><span class="ident" id="7067172">t</span>&nbsp;<span class="op" id="7067174">*</span><span class="ident" id="7067175">testing</span><span class="op" id="7067182">.</span><span class="ident" id="7067183">T</span><span class="op" id="7067184">,</span>&nbsp;<span class="ident" id="7067186">template</span>&nbsp;<span class="op" id="7067195">*</span><span class="ident" id="7067196">clientTest</span><span class="op" id="7067206">)</span>&nbsp;<span class="op" id="7067208">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067211">runClientTestForVersion</span><span class="op" id="7067234">(</span><span class="ident" id="7067235">t</span><span class="op" id="7067236">,</span>&nbsp;<span class="ident" id="7067238">template</span><span class="op" id="7067246">,</span>&nbsp;<span class="string" id="7067248">&#34;TLSv11-&#34;</span><span class="op" id="7067257">,</span>&nbsp;<span class="string" id="7067259">&#34;-tls1_1&#34;</span><span class="op" id="7067268">)</span><br>
<span class="lineno"></span><span class="op" id="7067270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7067273">func</span>&nbsp;<span class="ident" id="7067278">runClientTestTLS12</span><span class="op" id="7067296">(</span><span class="ident" id="7067297">t</span>&nbsp;<span class="op" id="7067299">*</span><span class="ident" id="7067300">testing</span><span class="op" id="7067307">.</span><span class="ident" id="7067308">T</span><span class="op" id="7067309">,</span>&nbsp;<span class="ident" id="7067311">template</span>&nbsp;<span class="op" id="7067320">*</span><span class="ident" id="7067321">clientTest</span><span class="op" id="7067331">)</span>&nbsp;<span class="op" id="7067333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067336">runClientTestForVersion</span><span class="op" id="7067359">(</span><span class="ident" id="7067360">t</span><span class="op" id="7067361">,</span>&nbsp;<span class="ident" id="7067363">template</span><span class="op" id="7067371">,</span>&nbsp;<span class="string" id="7067373">&#34;TLSv12-&#34;</span><span class="op" id="7067382">,</span>&nbsp;<span class="string" id="7067384">&#34;-tls1_2&#34;</span><span class="op" id="7067393">)</span><br>
<span class="lineno">270</span><span class="op" id="7067395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7067398">func</span>&nbsp;<span class="ident" id="7067403">TestHandshakeClientRSARC4</span><span class="op" id="7067428">(</span><span class="ident" id="7067429">t</span>&nbsp;<span class="op" id="7067431">*</span><span class="ident" id="7067432">testing</span><span class="op" id="7067439">.</span><span class="ident" id="7067440">T</span><span class="op" id="7067441">)</span>&nbsp;<span class="op" id="7067443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067446">test</span>&nbsp;<span class="op" id="7067451">:=</span>&nbsp;<span class="op" id="7067454">&amp;</span><span class="ident" id="7067455">clientTest</span><span class="op" id="7067465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067469">name</span><span class="op" id="7067473">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7067478">&#34;RSA-RC4&#34;</span><span class="op" id="7067487">,</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067491">command</span><span class="op" id="7067498">:</span>&nbsp;<span class="op" id="7067500">[</span><span class="op" id="7067501">]</span><span class="builtintype" id="7067502">string</span><span class="op" id="7067508">{</span><span class="string" id="7067509">&#34;openssl&#34;</span><span class="op" id="7067518">,</span>&nbsp;<span class="string" id="7067520">&#34;s_server&#34;</span><span class="op" id="7067530">,</span>&nbsp;<span class="string" id="7067532">&#34;-cipher&#34;</span><span class="op" id="7067541">,</span>&nbsp;<span class="string" id="7067543">&#34;RC4-SHA&#34;</span><span class="op" id="7067552">}</span><span class="op" id="7067553">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7067556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067559">runClientTestTLS10</span><span class="op" id="7067577">(</span><span class="ident" id="7067578">t</span><span class="op" id="7067579">,</span>&nbsp;<span class="ident" id="7067581">test</span><span class="op" id="7067585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067588">runClientTestTLS11</span><span class="op" id="7067606">(</span><span class="ident" id="7067607">t</span><span class="op" id="7067608">,</span>&nbsp;<span class="ident" id="7067610">test</span><span class="op" id="7067614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067617">runClientTestTLS12</span><span class="op" id="7067635">(</span><span class="ident" id="7067636">t</span><span class="op" id="7067637">,</span>&nbsp;<span class="ident" id="7067639">test</span><span class="op" id="7067643">)</span><br>
<span class="lineno">280</span><span class="op" id="7067645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7067648">func</span>&nbsp;<span class="ident" id="7067653">TestHandshakeClientECDHERSAAES</span><span class="op" id="7067683">(</span><span class="ident" id="7067684">t</span>&nbsp;<span class="op" id="7067686">*</span><span class="ident" id="7067687">testing</span><span class="op" id="7067694">.</span><span class="ident" id="7067695">T</span><span class="op" id="7067696">)</span>&nbsp;<span class="op" id="7067698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067701">test</span>&nbsp;<span class="op" id="7067706">:=</span>&nbsp;<span class="op" id="7067709">&amp;</span><span class="ident" id="7067710">clientTest</span><span class="op" id="7067720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067724">name</span><span class="op" id="7067728">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7067733">&#34;ECDHE-RSA-AES&#34;</span><span class="op" id="7067748">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067752">command</span><span class="op" id="7067759">:</span>&nbsp;<span class="op" id="7067761">[</span><span class="op" id="7067762">]</span><span class="builtintype" id="7067763">string</span><span class="op" id="7067769">{</span><span class="string" id="7067770">&#34;openssl&#34;</span><span class="op" id="7067779">,</span>&nbsp;<span class="string" id="7067781">&#34;s_server&#34;</span><span class="op" id="7067791">,</span>&nbsp;<span class="string" id="7067793">&#34;-cipher&#34;</span><span class="op" id="7067802">,</span>&nbsp;<span class="string" id="7067804">&#34;ECDHE-RSA-AES128-SHA&#34;</span><span class="op" id="7067826">}</span><span class="op" id="7067827">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7067830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067833">runClientTestTLS10</span><span class="op" id="7067851">(</span><span class="ident" id="7067852">t</span><span class="op" id="7067853">,</span>&nbsp;<span class="ident" id="7067855">test</span><span class="op" id="7067859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067862">runClientTestTLS11</span><span class="op" id="7067880">(</span><span class="ident" id="7067881">t</span><span class="op" id="7067882">,</span>&nbsp;<span class="ident" id="7067884">test</span><span class="op" id="7067888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067891">runClientTestTLS12</span><span class="op" id="7067909">(</span><span class="ident" id="7067910">t</span><span class="op" id="7067911">,</span>&nbsp;<span class="ident" id="7067913">test</span><span class="op" id="7067917">)</span><br>
<span class="lineno">290</span><span class="op" id="7067919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7067922">func</span>&nbsp;<span class="ident" id="7067927">TestHandshakeClientECDHEECDSAAES</span><span class="op" id="7067959">(</span><span class="ident" id="7067960">t</span>&nbsp;<span class="op" id="7067962">*</span><span class="ident" id="7067963">testing</span><span class="op" id="7067970">.</span><span class="ident" id="7067971">T</span><span class="op" id="7067972">)</span>&nbsp;<span class="op" id="7067974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7067977">test</span>&nbsp;<span class="op" id="7067982">:=</span>&nbsp;<span class="op" id="7067985">&amp;</span><span class="ident" id="7067986">clientTest</span><span class="op" id="7067996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068000">name</span><span class="op" id="7068004">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7068009">&#34;ECDHE-ECDSA-AES&#34;</span><span class="op" id="7068026">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068030">command</span><span class="op" id="7068037">:</span>&nbsp;<span class="op" id="7068039">[</span><span class="op" id="7068040">]</span><span class="builtintype" id="7068041">string</span><span class="op" id="7068047">{</span><span class="string" id="7068048">&#34;openssl&#34;</span><span class="op" id="7068057">,</span>&nbsp;<span class="string" id="7068059">&#34;s_server&#34;</span><span class="op" id="7068069">,</span>&nbsp;<span class="string" id="7068071">&#34;-cipher&#34;</span><span class="op" id="7068080">,</span>&nbsp;<span class="string" id="7068082">&#34;ECDHE-ECDSA-AES128-SHA&#34;</span><span class="op" id="7068106">}</span><span class="op" id="7068107">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068111">cert</span><span class="op" id="7068115">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068120">testECDSACertificate</span><span class="op" id="7068140">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068144">key</span><span class="op" id="7068147">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068153">testECDSAPrivateKey</span><span class="op" id="7068172">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7068175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068178">runClientTestTLS10</span><span class="op" id="7068196">(</span><span class="ident" id="7068197">t</span><span class="op" id="7068198">,</span>&nbsp;<span class="ident" id="7068200">test</span><span class="op" id="7068204">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068207">runClientTestTLS11</span><span class="op" id="7068225">(</span><span class="ident" id="7068226">t</span><span class="op" id="7068227">,</span>&nbsp;<span class="ident" id="7068229">test</span><span class="op" id="7068233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068236">runClientTestTLS12</span><span class="op" id="7068254">(</span><span class="ident" id="7068255">t</span><span class="op" id="7068256">,</span>&nbsp;<span class="ident" id="7068258">test</span><span class="op" id="7068262">)</span><br>
<span class="lineno"></span><span class="op" id="7068264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7068267">func</span>&nbsp;<span class="ident" id="7068272">TestHandshakeClientECDHEECDSAAESGCM</span><span class="op" id="7068307">(</span><span class="ident" id="7068308">t</span>&nbsp;<span class="op" id="7068310">*</span><span class="ident" id="7068311">testing</span><span class="op" id="7068318">.</span><span class="ident" id="7068319">T</span><span class="op" id="7068320">)</span>&nbsp;<span class="op" id="7068322">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068325">test</span>&nbsp;<span class="op" id="7068330">:=</span>&nbsp;<span class="op" id="7068333">&amp;</span><span class="ident" id="7068334">clientTest</span><span class="op" id="7068344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068348">name</span><span class="op" id="7068352">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7068357">&#34;ECDHE-ECDSA-AES-GCM&#34;</span><span class="op" id="7068378">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068382">command</span><span class="op" id="7068389">:</span>&nbsp;<span class="op" id="7068391">[</span><span class="op" id="7068392">]</span><span class="builtintype" id="7068393">string</span><span class="op" id="7068399">{</span><span class="string" id="7068400">&#34;openssl&#34;</span><span class="op" id="7068409">,</span>&nbsp;<span class="string" id="7068411">&#34;s_server&#34;</span><span class="op" id="7068421">,</span>&nbsp;<span class="string" id="7068423">&#34;-cipher&#34;</span><span class="op" id="7068432">,</span>&nbsp;<span class="string" id="7068434">&#34;ECDHE-ECDSA-AES128-GCM-SHA256&#34;</span><span class="op" id="7068465">}</span><span class="op" id="7068466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068470">cert</span><span class="op" id="7068474">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068479">testECDSACertificate</span><span class="op" id="7068499">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068503">key</span><span class="op" id="7068506">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068512">testECDSAPrivateKey</span><span class="op" id="7068531">,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7068534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068537">runClientTestTLS12</span><span class="op" id="7068555">(</span><span class="ident" id="7068556">t</span><span class="op" id="7068557">,</span>&nbsp;<span class="ident" id="7068559">test</span><span class="op" id="7068563">)</span><br>
<span class="lineno"></span><span class="op" id="7068565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7068568">func</span>&nbsp;<span class="ident" id="7068573">TestHandshakeClientCertRSA</span><span class="op" id="7068599">(</span><span class="ident" id="7068600">t</span>&nbsp;<span class="op" id="7068602">*</span><span class="ident" id="7068603">testing</span><span class="op" id="7068610">.</span><span class="ident" id="7068611">T</span><span class="op" id="7068612">)</span>&nbsp;<span class="op" id="7068614">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068617">config</span>&nbsp;<span class="op" id="7068624">:=</span>&nbsp;<span class="op" id="7068627">*</span><span class="ident" id="7068628">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068640">cert</span><span class="op" id="7068644">,</span>&nbsp;<span class="ident" id="7068646">_</span>&nbsp;<span class="op" id="7068648">:=</span>&nbsp;<span class="ident" id="7068651">X509KeyPair</span><span class="op" id="7068662">(</span><span class="op" id="7068663">[</span><span class="op" id="7068664">]</span><span class="builtintype" id="7068665">byte</span><span class="op" id="7068669">(</span><span class="ident" id="7068670">clientCertificatePEM</span><span class="op" id="7068690">)</span><span class="op" id="7068691">,</span>&nbsp;<span class="op" id="7068693">[</span><span class="op" id="7068694">]</span><span class="builtintype" id="7068695">byte</span><span class="op" id="7068699">(</span><span class="ident" id="7068700">clientKeyPEM</span><span class="op" id="7068712">)</span><span class="op" id="7068713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068716">config</span><span class="op" id="7068722">.</span><span class="ident" id="7068723">Certificates</span>&nbsp;<span class="op" id="7068736">=</span>&nbsp;<span class="op" id="7068738">[</span><span class="op" id="7068739">]</span><span class="ident" id="7068740">Certificate</span><span class="op" id="7068751">{</span><span class="ident" id="7068752">cert</span><span class="op" id="7068756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068760">test</span>&nbsp;<span class="op" id="7068765">:=</span>&nbsp;<span class="op" id="7068768">&amp;</span><span class="ident" id="7068769">clientTest</span><span class="op" id="7068779">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068783">name</span><span class="op" id="7068787">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7068792">&#34;ClientCert-RSA-RSA&#34;</span><span class="op" id="7068812">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068816">command</span><span class="op" id="7068823">:</span>&nbsp;<span class="op" id="7068825">[</span><span class="op" id="7068826">]</span><span class="builtintype" id="7068827">string</span><span class="op" id="7068833">{</span><span class="string" id="7068834">&#34;openssl&#34;</span><span class="op" id="7068843">,</span>&nbsp;<span class="string" id="7068845">&#34;s_server&#34;</span><span class="op" id="7068855">,</span>&nbsp;<span class="string" id="7068857">&#34;-cipher&#34;</span><span class="op" id="7068866">,</span>&nbsp;<span class="string" id="7068868">&#34;RC4-SHA&#34;</span><span class="op" id="7068877">,</span>&nbsp;<span class="string" id="7068879">&#34;-verify&#34;</span><span class="op" id="7068888">,</span>&nbsp;<span class="string" id="7068890">&#34;1&#34;</span><span class="op" id="7068893">}</span><span class="op" id="7068894">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068898">config</span><span class="op" id="7068904">:</span>&nbsp;&nbsp;<span class="op" id="7068907">&amp;</span><span class="ident" id="7068908">config</span><span class="op" id="7068914">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7068917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068921">runClientTestTLS10</span><span class="op" id="7068939">(</span><span class="ident" id="7068940">t</span><span class="op" id="7068941">,</span>&nbsp;<span class="ident" id="7068943">test</span><span class="op" id="7068947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068950">runClientTestTLS12</span><span class="op" id="7068968">(</span><span class="ident" id="7068969">t</span><span class="op" id="7068970">,</span>&nbsp;<span class="ident" id="7068972">test</span><span class="op" id="7068976">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7068980">test</span>&nbsp;<span class="op" id="7068985">=</span>&nbsp;<span class="op" id="7068987">&amp;</span><span class="ident" id="7068988">clientTest</span><span class="op" id="7068998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069002">name</span><span class="op" id="7069006">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7069011">&#34;ClientCert-RSA-ECDSA&#34;</span><span class="op" id="7069033">,</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069037">command</span><span class="op" id="7069044">:</span>&nbsp;<span class="op" id="7069046">[</span><span class="op" id="7069047">]</span><span class="builtintype" id="7069048">string</span><span class="op" id="7069054">{</span><span class="string" id="7069055">&#34;openssl&#34;</span><span class="op" id="7069064">,</span>&nbsp;<span class="string" id="7069066">&#34;s_server&#34;</span><span class="op" id="7069076">,</span>&nbsp;<span class="string" id="7069078">&#34;-cipher&#34;</span><span class="op" id="7069087">,</span>&nbsp;<span class="string" id="7069089">&#34;ECDHE-ECDSA-AES128-SHA&#34;</span><span class="op" id="7069113">,</span>&nbsp;<span class="string" id="7069115">&#34;-verify&#34;</span><span class="op" id="7069124">,</span>&nbsp;<span class="string" id="7069126">&#34;1&#34;</span><span class="op" id="7069129">}</span><span class="op" id="7069130">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069134">config</span><span class="op" id="7069140">:</span>&nbsp;&nbsp;<span class="op" id="7069143">&amp;</span><span class="ident" id="7069144">config</span><span class="op" id="7069150">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069154">cert</span><span class="op" id="7069158">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069163">testECDSACertificate</span><span class="op" id="7069183">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069187">key</span><span class="op" id="7069190">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069196">testECDSAPrivateKey</span><span class="op" id="7069215">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7069218">}</span><br>
<span class="lineno">335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069222">runClientTestTLS10</span><span class="op" id="7069240">(</span><span class="ident" id="7069241">t</span><span class="op" id="7069242">,</span>&nbsp;<span class="ident" id="7069244">test</span><span class="op" id="7069248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069251">runClientTestTLS12</span><span class="op" id="7069269">(</span><span class="ident" id="7069270">t</span><span class="op" id="7069271">,</span>&nbsp;<span class="ident" id="7069273">test</span><span class="op" id="7069277">)</span><br>
<span class="lineno"></span><span class="op" id="7069279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="keyword" id="7069282">func</span>&nbsp;<span class="ident" id="7069287">TestHandshakeClientCertECDSA</span><span class="op" id="7069315">(</span><span class="ident" id="7069316">t</span>&nbsp;<span class="op" id="7069318">*</span><span class="ident" id="7069319">testing</span><span class="op" id="7069326">.</span><span class="ident" id="7069327">T</span><span class="op" id="7069328">)</span>&nbsp;<span class="op" id="7069330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069333">config</span>&nbsp;<span class="op" id="7069340">:=</span>&nbsp;<span class="op" id="7069343">*</span><span class="ident" id="7069344">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069356">cert</span><span class="op" id="7069360">,</span>&nbsp;<span class="ident" id="7069362">_</span>&nbsp;<span class="op" id="7069364">:=</span>&nbsp;<span class="ident" id="7069367">X509KeyPair</span><span class="op" id="7069378">(</span><span class="op" id="7069379">[</span><span class="op" id="7069380">]</span><span class="builtintype" id="7069381">byte</span><span class="op" id="7069385">(</span><span class="ident" id="7069386">clientECDSACertificatePEM</span><span class="op" id="7069411">)</span><span class="op" id="7069412">,</span>&nbsp;<span class="op" id="7069414">[</span><span class="op" id="7069415">]</span><span class="builtintype" id="7069416">byte</span><span class="op" id="7069420">(</span><span class="ident" id="7069421">clientECDSAKeyPEM</span><span class="op" id="7069438">)</span><span class="op" id="7069439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069442">config</span><span class="op" id="7069448">.</span><span class="ident" id="7069449">Certificates</span>&nbsp;<span class="op" id="7069462">=</span>&nbsp;<span class="op" id="7069464">[</span><span class="op" id="7069465">]</span><span class="ident" id="7069466">Certificate</span><span class="op" id="7069477">{</span><span class="ident" id="7069478">cert</span><span class="op" id="7069482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069486">test</span>&nbsp;<span class="op" id="7069491">:=</span>&nbsp;<span class="op" id="7069494">&amp;</span><span class="ident" id="7069495">clientTest</span><span class="op" id="7069505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069509">name</span><span class="op" id="7069513">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7069518">&#34;ClientCert-ECDSA-RSA&#34;</span><span class="op" id="7069540">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069544">command</span><span class="op" id="7069551">:</span>&nbsp;<span class="op" id="7069553">[</span><span class="op" id="7069554">]</span><span class="builtintype" id="7069555">string</span><span class="op" id="7069561">{</span><span class="string" id="7069562">&#34;openssl&#34;</span><span class="op" id="7069571">,</span>&nbsp;<span class="string" id="7069573">&#34;s_server&#34;</span><span class="op" id="7069583">,</span>&nbsp;<span class="string" id="7069585">&#34;-cipher&#34;</span><span class="op" id="7069594">,</span>&nbsp;<span class="string" id="7069596">&#34;RC4-SHA&#34;</span><span class="op" id="7069605">,</span>&nbsp;<span class="string" id="7069607">&#34;-verify&#34;</span><span class="op" id="7069616">,</span>&nbsp;<span class="string" id="7069618">&#34;1&#34;</span><span class="op" id="7069621">}</span><span class="op" id="7069622">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069626">config</span><span class="op" id="7069632">:</span>&nbsp;&nbsp;<span class="op" id="7069635">&amp;</span><span class="ident" id="7069636">config</span><span class="op" id="7069642">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7069645">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069649">runClientTestTLS10</span><span class="op" id="7069667">(</span><span class="ident" id="7069668">t</span><span class="op" id="7069669">,</span>&nbsp;<span class="ident" id="7069671">test</span><span class="op" id="7069675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069678">runClientTestTLS12</span><span class="op" id="7069696">(</span><span class="ident" id="7069697">t</span><span class="op" id="7069698">,</span>&nbsp;<span class="ident" id="7069700">test</span><span class="op" id="7069704">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069708">test</span>&nbsp;<span class="op" id="7069713">=</span>&nbsp;<span class="op" id="7069715">&amp;</span><span class="ident" id="7069716">clientTest</span><span class="op" id="7069726">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069730">name</span><span class="op" id="7069734">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7069739">&#34;ClientCert-ECDSA-ECDSA&#34;</span><span class="op" id="7069763">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069767">command</span><span class="op" id="7069774">:</span>&nbsp;<span class="op" id="7069776">[</span><span class="op" id="7069777">]</span><span class="builtintype" id="7069778">string</span><span class="op" id="7069784">{</span><span class="string" id="7069785">&#34;openssl&#34;</span><span class="op" id="7069794">,</span>&nbsp;<span class="string" id="7069796">&#34;s_server&#34;</span><span class="op" id="7069806">,</span>&nbsp;<span class="string" id="7069808">&#34;-cipher&#34;</span><span class="op" id="7069817">,</span>&nbsp;<span class="string" id="7069819">&#34;ECDHE-ECDSA-AES128-SHA&#34;</span><span class="op" id="7069843">,</span>&nbsp;<span class="string" id="7069845">&#34;-verify&#34;</span><span class="op" id="7069854">,</span>&nbsp;<span class="string" id="7069856">&#34;1&#34;</span><span class="op" id="7069859">}</span><span class="op" id="7069860">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069864">config</span><span class="op" id="7069870">:</span>&nbsp;&nbsp;<span class="op" id="7069873">&amp;</span><span class="ident" id="7069874">config</span><span class="op" id="7069880">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069884">cert</span><span class="op" id="7069888">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069893">testECDSACertificate</span><span class="op" id="7069913">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069917">key</span><span class="op" id="7069920">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069926">testECDSAPrivateKey</span><span class="op" id="7069945">,</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7069948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069952">runClientTestTLS10</span><span class="op" id="7069970">(</span><span class="ident" id="7069971">t</span><span class="op" id="7069972">,</span>&nbsp;<span class="ident" id="7069974">test</span><span class="op" id="7069978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7069981">runClientTestTLS12</span><span class="op" id="7069999">(</span><span class="ident" id="7070000">t</span><span class="op" id="7070001">,</span>&nbsp;<span class="ident" id="7070003">test</span><span class="op" id="7070007">)</span><br>
<span class="lineno"></span><span class="op" id="7070009">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword" id="7070012">func</span>&nbsp;<span class="ident" id="7070017">TestClientResumption</span><span class="op" id="7070037">(</span><span class="ident" id="7070038">t</span>&nbsp;<span class="op" id="7070040">*</span><span class="ident" id="7070041">testing</span><span class="op" id="7070048">.</span><span class="ident" id="7070049">T</span><span class="op" id="7070050">)</span>&nbsp;<span class="op" id="7070052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7070055">serverConfig</span>&nbsp;<span class="op" id="7070068">:=</span>&nbsp;<span class="op" id="7070071">&amp;</span><span class="ident" id="7070072">Config</span><span class="op" id="7070078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7070082">CipherSuites</span><span class="op" id="7070094">:</span>&nbsp;<span class="op" id="7070096">[</span><span class="op" id="7070097">]</span><span class="builtintype" id="7070098">uint16</span><span class="op" id="7070104">{</span><span class="ident" id="7070105">TLS_RSA_WITH_RC4_128_SHA</span><span class="op" id="7070129">,</span>&nbsp;<span class="ident" id="7070131">TLS_ECDHE_RSA_WITH_RC4_128_SHA</span><span class="op" id="7070161">}</span><span class="op" id="7070162">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7070166">Certificates</span><span class="op" id="7070178">:</span>&nbsp;<span class="ident" id="7070180">testConfig</span><span class="op" id="7070190">.</span><span class="ident" id="7070191">Certificates</span><span class="op" id="7070203">,</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7070206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7070209">clientConfig</span>&nbsp;<span class="op" id="7070222">:=</span>&nbsp;<span class="op" id="7070225">&amp;</span><span class="ident" id="7070226">Config</span><span class="op" id="7070232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7070236">CipherSuites</span><span class="op" id="7070248">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7070256">[</span><span class="op" id="7070257">]</span><span class="builtintype" id="7070258">uint16</span><span class="op" id="7070264">{</span><span class="ident" id="7070265">TLS_RSA_WITH_RC4_128_SHA</span><span class="op" id="7070289">}</span><span class="op" id="7070290">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7070294">InsecureSkipVerify</span><span class="op" id="7070312">:</span>&nbsp;<span class="builtintype" id="7070314">true</span><span class="op" id="7070318">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7070322">ClientSessionCache</span><span class="op" id="7070340">:</span>&nbsp;<span class="ident" id="7070342">NewLRUClientSessionCache</span><span class="op" id="7070366">(</span><span class="num" id="7070367">32</span><span class="op" id="7070369">)</span><span class="op" id="7070370">,</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7070373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7070377">testResumeState</span>&nbsp;<span class="op" id="7070393">:=</span>&nbsp;<span class="keyword" id="7070396">func</span><span class="op" id="7070400">(</span><span class="ident" id="7070401">test</span>&nbsp;<span class="builtintype" id="7070406">string</span><span class="op" id="7070412">,</span>&nbsp;<span class="ident" id="7070414">didResume</span>&nbsp;<span class="builtintype" id="7070424">bool</span><span class="op" id="7070428">)</span>&nbsp;<span class="op" id="7070430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7070434">hs</span><span class="op" id="7070436">,</span>&nbsp;<span class="ident" id="7070438">err</span>&nbsp;<span class="op" id="7070442">:=</span>&nbsp;<span class="ident" id="7070445">testHandshake</span><span class="op" id="7070458">(</span><span class="ident" id="7070459">clientConfig</span><span class="op" id="7070471">,</span>&nbsp;<span class="ident" id="7070473">serverConfig</span><span class="op" id="7070485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7070489">if</span>&nbsp;<span class="ident" id="7070492">err</span>&nbsp;<span class="op" id="7070496">!=</span>&nbsp;<span class="builtintype" id="7070499">nil</span>&nbsp;<span class="op" id="7070503">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7070508">t</span><span class="op" id="7070509">.</span><span class="ident" id="7070510">Fatalf</span><span class="op" id="7070516">(</span><span class="string" id="7070517">&#34;%s:&nbsp;handshake&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7070543">,</span>&nbsp;<span class="ident" id="7070545">test</span><span class="op" id="7070549">,</span>&nbsp;<span class="ident" id="7070551">err</span><span class="op" id="7070554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7070558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7070562">if</span>&nbsp;<span class="ident" id="7070565">hs</span><span class="op" id="7070567">.</span><span class="ident" id="7070568">DidResume</span>&nbsp;<span class="op" id="7070578">!=</span>&nbsp;<span class="ident" id="7070581">didResume</span>&nbsp;<span class="op" id="7070591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7070596">t</span><span class="op" id="7070597">.</span><span class="ident" id="7070598">Fatalf</span><span class="op" id="7070604">(</span><span class="string" id="7070605">&#34;%s&nbsp;resumed:&nbsp;%v,&nbsp;expected:&nbsp;%v&#34;</span><span class="op" id="7070635">,</span>&nbsp;<span class="ident" id="7070637">test</span><span class="op" id="7070641">,</span>&nbsp;<span class="ident" id="7070643">hs</span><span class="op" id="7070645">.</span><span class="ident" id="7070646">DidResume</span><span class="op" id="7070655">,</span>&nbsp;<span class="ident" id="7070657">didResume</span><span class="op" id="7070666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7070670">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7070673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7070677">testResumeState</span><span class="op" id="7070692">(</span><span class="string" id="7070693">&#34;Handshake&#34;</span><span class="op" id="7070704">,</span>&nbsp;<span class="builtintype" id="7070706">false</span><span class="op" id="7070711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7070714">testResumeState</span><span class="op" id="7070729">(</span><span class="string" id="7070730">&#34;Resume&#34;</span><span class="op" id="7070738">,</span>&nbsp;<span class="builtintype" id="7070740">true</span><span class="op" id="7070744">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7070748">if</span>&nbsp;<span class="ident" id="7070751">_</span><span class="op" id="7070752">,</span>&nbsp;<span class="ident" id="7070754">err</span>&nbsp;<span class="op" id="7070758">:=</span>&nbsp;<span class="ident" id="7070761">io</span><span class="op" id="7070763">.</span><span class="ident" id="7070764">ReadFull</span><span class="op" id="7070772">(</span><span class="ident" id="7070773">serverConfig</span><span class="op" id="7070785">.</span><span class="ident" id="7070786">rand</span><span class="op" id="7070790">(</span><span class="op" id="7070791">)</span><span class="op" id="7070792">,</span>&nbsp;<span class="ident" id="7070794">serverConfig</span><span class="op" id="7070806">.</span><span class="ident" id="7070807">SessionTicketKey</span><span class="op" id="7070823">[</span><span class="op" id="7070824">:</span><span class="op" id="7070825">]</span><span class="op" id="7070826">)</span><span class="op" id="7070827">;</span>&nbsp;<span class="ident" id="7070829">err</span>&nbsp;<span class="op" id="7070833">!=</span>&nbsp;<span class="builtintype" id="7070836">nil</span>&nbsp;<span class="op" id="7070840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7070844">t</span><span class="op" id="7070845">.</span><span class="ident" id="7070846">Fatalf</span><span class="op" id="7070852">(</span><span class="string" id="7070853">&#34;Failed&nbsp;to&nbsp;invalidate&nbsp;SessionTicketKey&#34;</span><span class="op" id="7070892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7070895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7070898">testResumeState</span><span class="op" id="7070913">(</span><span class="string" id="7070914">&#34;InvalidSessionTicketKey&#34;</span><span class="op" id="7070939">,</span>&nbsp;<span class="builtintype" id="7070941">false</span><span class="op" id="7070946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7070949">testResumeState</span><span class="op" id="7070964">(</span><span class="string" id="7070965">&#34;ResumeAfterInvalidSessionTicketKey&#34;</span><span class="op" id="7071001">,</span>&nbsp;<span class="builtintype" id="7071003">true</span><span class="op" id="7071007">)</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7071011">clientConfig</span><span class="op" id="7071023">.</span><span class="ident" id="7071024">CipherSuites</span>&nbsp;<span class="op" id="7071037">=</span>&nbsp;<span class="op" id="7071039">[</span><span class="op" id="7071040">]</span><span class="builtintype" id="7071041">uint16</span><span class="op" id="7071047">{</span><span class="ident" id="7071048">TLS_ECDHE_RSA_WITH_RC4_128_SHA</span><span class="op" id="7071078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7071081">testResumeState</span><span class="op" id="7071096">(</span><span class="string" id="7071097">&#34;DifferentCipherSuite&#34;</span><span class="op" id="7071119">,</span>&nbsp;<span class="builtintype" id="7071121">false</span><span class="op" id="7071126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7071129">testResumeState</span><span class="op" id="7071144">(</span><span class="string" id="7071145">&#34;DifferentCipherSuiteRecovers&#34;</span><span class="op" id="7071175">,</span>&nbsp;<span class="builtintype" id="7071177">true</span><span class="op" id="7071181">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7071185">clientConfig</span><span class="op" id="7071197">.</span><span class="ident" id="7071198">ClientSessionCache</span>&nbsp;<span class="op" id="7071217">=</span>&nbsp;<span class="builtintype" id="7071219">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7071224">testResumeState</span><span class="op" id="7071239">(</span><span class="string" id="7071240">&#34;WithoutSessionCache&#34;</span><span class="op" id="7071261">,</span>&nbsp;<span class="builtintype" id="7071263">false</span><span class="op" id="7071268">)</span><br>
<span class="lineno"></span><span class="op" id="7071270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7071273">func</span>&nbsp;<span class="ident" id="7071278">TestLRUClientSessionCache</span><span class="op" id="7071303">(</span><span class="ident" id="7071304">t</span>&nbsp;<span class="op" id="7071306">*</span><span class="ident" id="7071307">testing</span><span class="op" id="7071314">.</span><span class="ident" id="7071315">T</span><span class="op" id="7071316">)</span>&nbsp;<span class="op" id="7071318">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7071321">//&nbsp;Initialize&nbsp;cache&nbsp;of&nbsp;capacity&nbsp;4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7071357">cache</span>&nbsp;<span class="op" id="7071363">:=</span>&nbsp;<span class="ident" id="7071366">NewLRUClientSessionCache</span><span class="op" id="7071390">(</span><span class="num" id="7071391">4</span><span class="op" id="7071392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7071395">cs</span>&nbsp;<span class="op" id="7071398">:=</span>&nbsp;<span class="builtinfunc" id="7071401">make</span><span class="op" id="7071405">(</span><span class="op" id="7071406">[</span><span class="op" id="7071407">]</span><span class="ident" id="7071408">ClientSessionState</span><span class="op" id="7071426">,</span>&nbsp;<span class="num" id="7071428">6</span><span class="op" id="7071429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7071432">keys</span>&nbsp;<span class="op" id="7071437">:=</span>&nbsp;<span class="op" id="7071440">[</span><span class="op" id="7071441">]</span><span class="builtintype" id="7071442">string</span><span class="op" id="7071448">{</span><span class="string" id="7071449">&#34;0&#34;</span><span class="op" id="7071452">,</span>&nbsp;<span class="string" id="7071454">&#34;1&#34;</span><span class="op" id="7071457">,</span>&nbsp;<span class="string" id="7071459">&#34;2&#34;</span><span class="op" id="7071462">,</span>&nbsp;<span class="string" id="7071464">&#34;3&#34;</span><span class="op" id="7071467">,</span>&nbsp;<span class="string" id="7071469">&#34;4&#34;</span><span class="op" id="7071472">,</span>&nbsp;<span class="string" id="7071474">&#34;5&#34;</span><span class="op" id="7071477">,</span>&nbsp;<span class="string" id="7071479">&#34;6&#34;</span><span class="op" id="7071482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7071486">//&nbsp;Add&nbsp;4&nbsp;entries&nbsp;to&nbsp;the&nbsp;cache&nbsp;and&nbsp;look&nbsp;them&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7071535">for</span>&nbsp;<span class="ident" id="7071539">i</span>&nbsp;<span class="op" id="7071541">:=</span>&nbsp;<span class="num" id="7071544">0</span><span class="op" id="7071545">;</span>&nbsp;<span class="ident" id="7071547">i</span>&nbsp;<span class="op" id="7071549">&lt;</span>&nbsp;<span class="num" id="7071551">4</span><span class="op" id="7071552">;</span>&nbsp;<span class="ident" id="7071554">i</span><span class="op" id="7071555">++</span>&nbsp;<span class="op" id="7071558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7071562">cache</span><span class="op" id="7071567">.</span><span class="ident" id="7071568">Put</span><span class="op" id="7071571">(</span><span class="ident" id="7071572">keys</span><span class="op" id="7071576">[</span><span class="ident" id="7071577">i</span><span class="op" id="7071578">]</span><span class="op" id="7071579">,</span>&nbsp;<span class="op" id="7071581">&amp;</span><span class="ident" id="7071582">cs</span><span class="op" id="7071584">[</span><span class="ident" id="7071585">i</span><span class="op" id="7071586">]</span><span class="op" id="7071587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7071590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7071593">for</span>&nbsp;<span class="ident" id="7071597">i</span>&nbsp;<span class="op" id="7071599">:=</span>&nbsp;<span class="num" id="7071602">0</span><span class="op" id="7071603">;</span>&nbsp;<span class="ident" id="7071605">i</span>&nbsp;<span class="op" id="7071607">&lt;</span>&nbsp;<span class="num" id="7071609">4</span><span class="op" id="7071610">;</span>&nbsp;<span class="ident" id="7071612">i</span><span class="op" id="7071613">++</span>&nbsp;<span class="op" id="7071616">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7071620">if</span>&nbsp;<span class="ident" id="7071623">s</span><span class="op" id="7071624">,</span>&nbsp;<span class="ident" id="7071626">ok</span>&nbsp;<span class="op" id="7071629">:=</span>&nbsp;<span class="ident" id="7071632">cache</span><span class="op" id="7071637">.</span><span class="ident" id="7071638">Get</span><span class="op" id="7071641">(</span><span class="ident" id="7071642">keys</span><span class="op" id="7071646">[</span><span class="ident" id="7071647">i</span><span class="op" id="7071648">]</span><span class="op" id="7071649">)</span><span class="op" id="7071650">;</span>&nbsp;<span class="op" id="7071652">!</span><span class="ident" id="7071653">ok</span>&nbsp;<span class="op" id="7071656">||</span>&nbsp;<span class="ident" id="7071659">s</span>&nbsp;<span class="op" id="7071661">!=</span>&nbsp;<span class="op" id="7071664">&amp;</span><span class="ident" id="7071665">cs</span><span class="op" id="7071667">[</span><span class="ident" id="7071668">i</span><span class="op" id="7071669">]</span>&nbsp;<span class="op" id="7071671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7071676">t</span><span class="op" id="7071677">.</span><span class="ident" id="7071678">Fatalf</span><span class="op" id="7071684">(</span><span class="string" id="7071685">&#34;session&nbsp;cache&nbsp;failed&nbsp;lookup&nbsp;for&nbsp;added&nbsp;key:&nbsp;%s&#34;</span><span class="op" id="7071732">,</span>&nbsp;<span class="ident" id="7071734">keys</span><span class="op" id="7071738">[</span><span class="ident" id="7071739">i</span><span class="op" id="7071740">]</span><span class="op" id="7071741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7071745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7071748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7071752">//&nbsp;Add&nbsp;2&nbsp;more&nbsp;entries&nbsp;to&nbsp;the&nbsp;cache.&nbsp;First&nbsp;2&nbsp;should&nbsp;be&nbsp;evicted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7071816">for</span>&nbsp;<span class="ident" id="7071820">i</span>&nbsp;<span class="op" id="7071822">:=</span>&nbsp;<span class="num" id="7071825">4</span><span class="op" id="7071826">;</span>&nbsp;<span class="ident" id="7071828">i</span>&nbsp;<span class="op" id="7071830">&lt;</span>&nbsp;<span class="num" id="7071832">6</span><span class="op" id="7071833">;</span>&nbsp;<span class="ident" id="7071835">i</span><span class="op" id="7071836">++</span>&nbsp;<span class="op" id="7071839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7071843">cache</span><span class="op" id="7071848">.</span><span class="ident" id="7071849">Put</span><span class="op" id="7071852">(</span><span class="ident" id="7071853">keys</span><span class="op" id="7071857">[</span><span class="ident" id="7071858">i</span><span class="op" id="7071859">]</span><span class="op" id="7071860">,</span>&nbsp;<span class="op" id="7071862">&amp;</span><span class="ident" id="7071863">cs</span><span class="op" id="7071865">[</span><span class="ident" id="7071866">i</span><span class="op" id="7071867">]</span><span class="op" id="7071868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7071871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7071874">for</span>&nbsp;<span class="ident" id="7071878">i</span>&nbsp;<span class="op" id="7071880">:=</span>&nbsp;<span class="num" id="7071883">0</span><span class="op" id="7071884">;</span>&nbsp;<span class="ident" id="7071886">i</span>&nbsp;<span class="op" id="7071888">&lt;</span>&nbsp;<span class="num" id="7071890">2</span><span class="op" id="7071891">;</span>&nbsp;<span class="ident" id="7071893">i</span><span class="op" id="7071894">++</span>&nbsp;<span class="op" id="7071897">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7071901">if</span>&nbsp;<span class="ident" id="7071904">s</span><span class="op" id="7071905">,</span>&nbsp;<span class="ident" id="7071907">ok</span>&nbsp;<span class="op" id="7071910">:=</span>&nbsp;<span class="ident" id="7071913">cache</span><span class="op" id="7071918">.</span><span class="ident" id="7071919">Get</span><span class="op" id="7071922">(</span><span class="ident" id="7071923">keys</span><span class="op" id="7071927">[</span><span class="ident" id="7071928">i</span><span class="op" id="7071929">]</span><span class="op" id="7071930">)</span><span class="op" id="7071931">;</span>&nbsp;<span class="ident" id="7071933">ok</span>&nbsp;<span class="op" id="7071936">||</span>&nbsp;<span class="ident" id="7071939">s</span>&nbsp;<span class="op" id="7071941">!=</span>&nbsp;<span class="builtintype" id="7071944">nil</span>&nbsp;<span class="op" id="7071948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7071953">t</span><span class="op" id="7071954">.</span><span class="ident" id="7071955">Fatalf</span><span class="op" id="7071961">(</span><span class="string" id="7071962">&#34;session&nbsp;cache&nbsp;should&nbsp;have&nbsp;evicted&nbsp;key:&nbsp;%s&#34;</span><span class="op" id="7072005">,</span>&nbsp;<span class="ident" id="7072007">keys</span><span class="op" id="7072011">[</span><span class="ident" id="7072012">i</span><span class="op" id="7072013">]</span><span class="op" id="7072014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7072018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7072021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7072025">//&nbsp;Touch&nbsp;entry&nbsp;2.&nbsp;LRU&nbsp;should&nbsp;evict&nbsp;3&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7072069">cache</span><span class="op" id="7072074">.</span><span class="ident" id="7072075">Get</span><span class="op" id="7072078">(</span><span class="ident" id="7072079">keys</span><span class="op" id="7072083">[</span><span class="num" id="7072084">2</span><span class="op" id="7072085">]</span><span class="op" id="7072086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7072089">cache</span><span class="op" id="7072094">.</span><span class="ident" id="7072095">Put</span><span class="op" id="7072098">(</span><span class="ident" id="7072099">keys</span><span class="op" id="7072103">[</span><span class="num" id="7072104">0</span><span class="op" id="7072105">]</span><span class="op" id="7072106">,</span>&nbsp;<span class="op" id="7072108">&amp;</span><span class="ident" id="7072109">cs</span><span class="op" id="7072111">[</span><span class="num" id="7072112">0</span><span class="op" id="7072113">]</span><span class="op" id="7072114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7072117">if</span>&nbsp;<span class="ident" id="7072120">s</span><span class="op" id="7072121">,</span>&nbsp;<span class="ident" id="7072123">ok</span>&nbsp;<span class="op" id="7072126">:=</span>&nbsp;<span class="ident" id="7072129">cache</span><span class="op" id="7072134">.</span><span class="ident" id="7072135">Get</span><span class="op" id="7072138">(</span><span class="ident" id="7072139">keys</span><span class="op" id="7072143">[</span><span class="num" id="7072144">3</span><span class="op" id="7072145">]</span><span class="op" id="7072146">)</span><span class="op" id="7072147">;</span>&nbsp;<span class="ident" id="7072149">ok</span>&nbsp;<span class="op" id="7072152">||</span>&nbsp;<span class="ident" id="7072155">s</span>&nbsp;<span class="op" id="7072157">!=</span>&nbsp;<span class="builtintype" id="7072160">nil</span>&nbsp;<span class="op" id="7072164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7072168">t</span><span class="op" id="7072169">.</span><span class="ident" id="7072170">Fatalf</span><span class="op" id="7072176">(</span><span class="string" id="7072177">&#34;session&nbsp;cache&nbsp;should&nbsp;have&nbsp;evicted&nbsp;key&nbsp;3&#34;</span><span class="op" id="7072218">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7072221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7072225">//&nbsp;Update&nbsp;entry&nbsp;0&nbsp;in&nbsp;place.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7072254">cache</span><span class="op" id="7072259">.</span><span class="ident" id="7072260">Put</span><span class="op" id="7072263">(</span><span class="ident" id="7072264">keys</span><span class="op" id="7072268">[</span><span class="num" id="7072269">0</span><span class="op" id="7072270">]</span><span class="op" id="7072271">,</span>&nbsp;<span class="op" id="7072273">&amp;</span><span class="ident" id="7072274">cs</span><span class="op" id="7072276">[</span><span class="num" id="7072277">3</span><span class="op" id="7072278">]</span><span class="op" id="7072279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7072282">if</span>&nbsp;<span class="ident" id="7072285">s</span><span class="op" id="7072286">,</span>&nbsp;<span class="ident" id="7072288">ok</span>&nbsp;<span class="op" id="7072291">:=</span>&nbsp;<span class="ident" id="7072294">cache</span><span class="op" id="7072299">.</span><span class="ident" id="7072300">Get</span><span class="op" id="7072303">(</span><span class="ident" id="7072304">keys</span><span class="op" id="7072308">[</span><span class="num" id="7072309">0</span><span class="op" id="7072310">]</span><span class="op" id="7072311">)</span><span class="op" id="7072312">;</span>&nbsp;<span class="op" id="7072314">!</span><span class="ident" id="7072315">ok</span>&nbsp;<span class="op" id="7072318">||</span>&nbsp;<span class="ident" id="7072321">s</span>&nbsp;<span class="op" id="7072323">!=</span>&nbsp;<span class="op" id="7072326">&amp;</span><span class="ident" id="7072327">cs</span><span class="op" id="7072329">[</span><span class="num" id="7072330">3</span><span class="op" id="7072331">]</span>&nbsp;<span class="op" id="7072333">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7072337">t</span><span class="op" id="7072338">.</span><span class="ident" id="7072339">Fatalf</span><span class="op" id="7072345">(</span><span class="string" id="7072346">&#34;session&nbsp;cache&nbsp;failed&nbsp;update&nbsp;for&nbsp;key&nbsp;0&#34;</span><span class="op" id="7072385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7072388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7072392">//&nbsp;Adding&nbsp;a&nbsp;nil&nbsp;entry&nbsp;is&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7072425">cache</span><span class="op" id="7072430">.</span><span class="ident" id="7072431">Put</span><span class="op" id="7072434">(</span><span class="ident" id="7072435">keys</span><span class="op" id="7072439">[</span><span class="num" id="7072440">0</span><span class="op" id="7072441">]</span><span class="op" id="7072442">,</span>&nbsp;<span class="builtintype" id="7072444">nil</span><span class="op" id="7072447">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7072450">if</span>&nbsp;<span class="ident" id="7072453">s</span><span class="op" id="7072454">,</span>&nbsp;<span class="ident" id="7072456">ok</span>&nbsp;<span class="op" id="7072459">:=</span>&nbsp;<span class="ident" id="7072462">cache</span><span class="op" id="7072467">.</span><span class="ident" id="7072468">Get</span><span class="op" id="7072471">(</span><span class="ident" id="7072472">keys</span><span class="op" id="7072476">[</span><span class="num" id="7072477">0</span><span class="op" id="7072478">]</span><span class="op" id="7072479">)</span><span class="op" id="7072480">;</span>&nbsp;<span class="op" id="7072482">!</span><span class="ident" id="7072483">ok</span>&nbsp;<span class="op" id="7072486">||</span>&nbsp;<span class="ident" id="7072489">s</span>&nbsp;<span class="op" id="7072491">!=</span>&nbsp;<span class="builtintype" id="7072494">nil</span>&nbsp;<span class="op" id="7072498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7072502">t</span><span class="op" id="7072503">.</span><span class="ident" id="7072504">Fatalf</span><span class="op" id="7072510">(</span><span class="string" id="7072511">&#34;failed&nbsp;to&nbsp;add&nbsp;nil&nbsp;entry&nbsp;to&nbsp;cache&#34;</span><span class="op" id="7072545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7072548">}</span><br>
<span class="lineno"></span><span class="op" id="7072550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">450</span><span class="keyword" id="7072553">func</span>&nbsp;<span class="ident" id="7072558">TestHandshakeClientALPNMatch</span><span class="op" id="7072586">(</span><span class="ident" id="7072587">t</span>&nbsp;<span class="op" id="7072589">*</span><span class="ident" id="7072590">testing</span><span class="op" id="7072597">.</span><span class="ident" id="7072598">T</span><span class="op" id="7072599">)</span>&nbsp;<span class="op" id="7072601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7072604">config</span>&nbsp;<span class="op" id="7072611">:=</span>&nbsp;<span class="op" id="7072614">*</span><span class="ident" id="7072615">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7072627">config</span><span class="op" id="7072633">.</span><span class="ident" id="7072634">NextProtos</span>&nbsp;<span class="op" id="7072645">=</span>&nbsp;<span class="op" id="7072647">[</span><span class="op" id="7072648">]</span><span class="builtintype" id="7072649">string</span><span class="op" id="7072655">{</span><span class="string" id="7072656">&#34;proto2&#34;</span><span class="op" id="7072664">,</span>&nbsp;<span class="string" id="7072666">&#34;proto1&#34;</span><span class="op" id="7072674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7072678">test</span>&nbsp;<span class="op" id="7072683">:=</span>&nbsp;<span class="op" id="7072686">&amp;</span><span class="ident" id="7072687">clientTest</span><span class="op" id="7072697">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7072701">name</span><span class="op" id="7072705">:</span>&nbsp;<span class="string" id="7072707">&#34;ALPN&#34;</span><span class="op" id="7072713">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7072717">//&nbsp;Note&nbsp;that&nbsp;this&nbsp;needs&nbsp;OpenSSL&nbsp;1.0.2&nbsp;because&nbsp;that&nbsp;is&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7072783">//&nbsp;version&nbsp;that&nbsp;supports&nbsp;the&nbsp;-alpn&nbsp;flag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7072826">command</span><span class="op" id="7072833">:</span>&nbsp;<span class="op" id="7072835">[</span><span class="op" id="7072836">]</span><span class="builtintype" id="7072837">string</span><span class="op" id="7072843">{</span><span class="string" id="7072844">&#34;openssl&#34;</span><span class="op" id="7072853">,</span>&nbsp;<span class="string" id="7072855">&#34;s_server&#34;</span><span class="op" id="7072865">,</span>&nbsp;<span class="string" id="7072867">&#34;-alpn&#34;</span><span class="op" id="7072874">,</span>&nbsp;<span class="string" id="7072876">&#34;proto1,proto2&#34;</span><span class="op" id="7072891">}</span><span class="op" id="7072892">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7072896">config</span><span class="op" id="7072902">:</span>&nbsp;&nbsp;<span class="op" id="7072905">&amp;</span><span class="ident" id="7072906">config</span><span class="op" id="7072912">,</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7072916">validate</span><span class="op" id="7072924">:</span>&nbsp;<span class="keyword" id="7072926">func</span><span class="op" id="7072930">(</span><span class="ident" id="7072931">state</span>&nbsp;<span class="ident" id="7072937">ConnectionState</span><span class="op" id="7072952">)</span>&nbsp;<span class="builtintype" id="7072954">error</span>&nbsp;<span class="op" id="7072960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7072965">//&nbsp;The&nbsp;server&#39;s&nbsp;preferences&nbsp;should&nbsp;override&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7073024">if</span>&nbsp;<span class="ident" id="7073027">state</span><span class="op" id="7073032">.</span><span class="ident" id="7073033">NegotiatedProtocol</span>&nbsp;<span class="op" id="7073052">!=</span>&nbsp;<span class="string" id="7073055">&#34;proto1&#34;</span>&nbsp;<span class="op" id="7073064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7073070">return</span>&nbsp;<span class="ident" id="7073077">fmt</span><span class="op" id="7073080">.</span><span class="ident" id="7073081">Errorf</span><span class="op" id="7073087">(</span><span class="string" id="7073088">&#34;Got&nbsp;protocol&nbsp;%q,&nbsp;wanted&nbsp;proto1&#34;</span><span class="op" id="7073120">,</span>&nbsp;<span class="ident" id="7073122">state</span><span class="op" id="7073127">.</span><span class="ident" id="7073128">NegotiatedProtocol</span><span class="op" id="7073146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7073151">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7073156">return</span>&nbsp;<span class="builtintype" id="7073163">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7073169">}</span><span class="op" id="7073170">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7073173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7073176">runClientTestTLS12</span><span class="op" id="7073194">(</span><span class="ident" id="7073195">t</span><span class="op" id="7073196">,</span>&nbsp;<span class="ident" id="7073198">test</span><span class="op" id="7073202">)</span><br>
<span class="lineno"></span><span class="op" id="7073204">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="keyword" id="7073207">func</span>&nbsp;<span class="ident" id="7073212">TestHandshakeClientALPNNoMatch</span><span class="op" id="7073242">(</span><span class="ident" id="7073243">t</span>&nbsp;<span class="op" id="7073245">*</span><span class="ident" id="7073246">testing</span><span class="op" id="7073253">.</span><span class="ident" id="7073254">T</span><span class="op" id="7073255">)</span>&nbsp;<span class="op" id="7073257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7073260">config</span>&nbsp;<span class="op" id="7073267">:=</span>&nbsp;<span class="op" id="7073270">*</span><span class="ident" id="7073271">testConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7073283">config</span><span class="op" id="7073289">.</span><span class="ident" id="7073290">NextProtos</span>&nbsp;<span class="op" id="7073301">=</span>&nbsp;<span class="op" id="7073303">[</span><span class="op" id="7073304">]</span><span class="builtintype" id="7073305">string</span><span class="op" id="7073311">{</span><span class="string" id="7073312">&#34;proto3&#34;</span><span class="op" id="7073320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7073324">test</span>&nbsp;<span class="op" id="7073329">:=</span>&nbsp;<span class="op" id="7073332">&amp;</span><span class="ident" id="7073333">clientTest</span><span class="op" id="7073343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7073347">name</span><span class="op" id="7073351">:</span>&nbsp;<span class="string" id="7073353">&#34;ALPN-NoMatch&#34;</span><span class="op" id="7073367">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7073371">//&nbsp;Note&nbsp;that&nbsp;this&nbsp;needs&nbsp;OpenSSL&nbsp;1.0.2&nbsp;because&nbsp;that&nbsp;is&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7073437">//&nbsp;version&nbsp;that&nbsp;supports&nbsp;the&nbsp;-alpn&nbsp;flag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7073480">command</span><span class="op" id="7073487">:</span>&nbsp;<span class="op" id="7073489">[</span><span class="op" id="7073490">]</span><span class="builtintype" id="7073491">string</span><span class="op" id="7073497">{</span><span class="string" id="7073498">&#34;openssl&#34;</span><span class="op" id="7073507">,</span>&nbsp;<span class="string" id="7073509">&#34;s_server&#34;</span><span class="op" id="7073519">,</span>&nbsp;<span class="string" id="7073521">&#34;-alpn&#34;</span><span class="op" id="7073528">,</span>&nbsp;<span class="string" id="7073530">&#34;proto1,proto2&#34;</span><span class="op" id="7073545">}</span><span class="op" id="7073546">,</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7073550">config</span><span class="op" id="7073556">:</span>&nbsp;&nbsp;<span class="op" id="7073559">&amp;</span><span class="ident" id="7073560">config</span><span class="op" id="7073566">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7073570">validate</span><span class="op" id="7073578">:</span>&nbsp;<span class="keyword" id="7073580">func</span><span class="op" id="7073584">(</span><span class="ident" id="7073585">state</span>&nbsp;<span class="ident" id="7073591">ConnectionState</span><span class="op" id="7073606">)</span>&nbsp;<span class="builtintype" id="7073608">error</span>&nbsp;<span class="op" id="7073614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7073619">//&nbsp;There&#39;s&nbsp;no&nbsp;overlap&nbsp;so&nbsp;OpenSSL&nbsp;will&nbsp;not&nbsp;select&nbsp;a&nbsp;protocol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7073683">if</span>&nbsp;<span class="ident" id="7073686">state</span><span class="op" id="7073691">.</span><span class="ident" id="7073692">NegotiatedProtocol</span>&nbsp;<span class="op" id="7073711">!=</span>&nbsp;<span class="string" id="7073714">&#34;&#34;</span>&nbsp;<span class="op" id="7073717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7073723">return</span>&nbsp;<span class="ident" id="7073730">fmt</span><span class="op" id="7073733">.</span><span class="ident" id="7073734">Errorf</span><span class="op" id="7073740">(</span><span class="string" id="7073741">&#34;Got&nbsp;protocol&nbsp;%q,&nbsp;wanted&nbsp;&#39;&#39;&#34;</span><span class="op" id="7073769">,</span>&nbsp;<span class="ident" id="7073771">state</span><span class="op" id="7073776">.</span><span class="ident" id="7073777">NegotiatedProtocol</span><span class="op" id="7073795">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7073800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7073805">return</span>&nbsp;<span class="builtintype" id="7073812">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7073818">}</span><span class="op" id="7073819">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7073822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7073825">runClientTestTLS12</span><span class="op" id="7073843">(</span><span class="ident" id="7073844">t</span><span class="op" id="7073845">,</span>&nbsp;<span class="ident" id="7073847">test</span><span class="op" id="7073851">)</span><br>
<span class="lineno">490</span><span class="op" id="7073853">}</span>
</div>
</body>
</html>
