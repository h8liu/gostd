<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html" class="current">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1585387">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1585442">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1585496">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1585547">package</span>&nbsp;<span class="ident" id="1585555">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1585564">import</span>&nbsp;<span class="op" id="1585571">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1585574">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1585583">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1585586">const</span>&nbsp;<span class="op" id="1585592">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585595">debugMalloc</span>&nbsp;<span class="op" id="1585607">=</span>&nbsp;<span class="builtintype" id="1585609">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585617">flagNoScan</span>&nbsp;<span class="op" id="1585628">=</span>&nbsp;<span class="ident" id="1585630">_FlagNoScan</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585643">flagNoZero</span>&nbsp;<span class="op" id="1585654">=</span>&nbsp;<span class="ident" id="1585656">_FlagNoZero</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585670">maxTinySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1585684">=</span>&nbsp;<span class="ident" id="1585686">_TinySize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585697">tinySizeClass</span>&nbsp;<span class="op" id="1585711">=</span>&nbsp;<span class="ident" id="1585713">_TinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585729">maxSmallSize</span>&nbsp;&nbsp;<span class="op" id="1585743">=</span>&nbsp;<span class="ident" id="1585745">_MaxSmallSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585761">pageShift</span>&nbsp;<span class="op" id="1585771">=</span>&nbsp;<span class="ident" id="1585773">_PageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585785">pageSize</span>&nbsp;&nbsp;<span class="op" id="1585795">=</span>&nbsp;<span class="ident" id="1585797">_PageSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585808">pageMask</span>&nbsp;&nbsp;<span class="op" id="1585818">=</span>&nbsp;<span class="ident" id="1585820">_PageMask</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585832">bitsPerPointer</span>&nbsp;&nbsp;<span class="op" id="1585848">=</span>&nbsp;<span class="ident" id="1585850">_BitsPerPointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585867">bitsMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1585883">=</span>&nbsp;<span class="ident" id="1585885">_BitsMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585896">pointersPerByte</span>&nbsp;<span class="op" id="1585912">=</span>&nbsp;<span class="ident" id="1585914">_PointersPerByte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585932">maxGCMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1585948">=</span>&nbsp;<span class="ident" id="1585950">_MaxGCMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585962">bitsDead</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1585978">=</span>&nbsp;<span class="ident" id="1585980">_BitsDead</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585991">bitsPointer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1586007">=</span>&nbsp;<span class="ident" id="1586009">_BitsPointer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586024">mSpanInUse</span>&nbsp;<span class="op" id="1586035">=</span>&nbsp;<span class="ident" id="1586037">_MSpanInUse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586051">concurrentSweep</span>&nbsp;<span class="op" id="1586067">=</span>&nbsp;<span class="ident" id="1586069">_ConcurrentSweep</span>&nbsp;<span class="op" id="1586086">!=</span>&nbsp;<span class="num" id="1586089">0</span><br>
<span class="lineno">35</span><span class="op" id="1586091">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1586094">//&nbsp;Page&nbsp;number&nbsp;(address&gt;&gt;pageShift)</span><br>
<span class="lineno"></span><span class="keyword" id="1586130">type</span>&nbsp;<span class="ident" id="1586135">pageID</span>&nbsp;<span class="builtintype" id="1586142">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1586151">//&nbsp;base&nbsp;address&nbsp;for&nbsp;all&nbsp;0-byte&nbsp;allocations</span><br>
<span class="lineno"></span><span class="keyword" id="1586194">var</span>&nbsp;<span class="ident" id="1586198">zerobase</span>&nbsp;<span class="builtintype" id="1586207">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1586216">//&nbsp;Allocate&nbsp;an&nbsp;object&nbsp;of&nbsp;size&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="1586253">//&nbsp;Small&nbsp;objects&nbsp;are&nbsp;allocated&nbsp;from&nbsp;the&nbsp;per-P&nbsp;cache&#39;s&nbsp;free&nbsp;lists.</span><br>
<span class="lineno">45</span><span class="comment" id="1586319">//&nbsp;Large&nbsp;objects&nbsp;(&gt;&nbsp;32&nbsp;kB)&nbsp;are&nbsp;allocated&nbsp;straight&nbsp;from&nbsp;the&nbsp;heap.</span><br>
<span class="lineno"></span><span class="keyword" id="1586384">func</span>&nbsp;<span class="ident" id="1586389">mallocgc</span><span class="op" id="1586397">(</span><span class="ident" id="1586398">size</span>&nbsp;<span class="builtintype" id="1586403">uintptr</span><span class="op" id="1586410">,</span>&nbsp;<span class="ident" id="1586412">typ</span>&nbsp;<span class="op" id="1586416">*</span><span class="ident" id="1586417">_type</span><span class="op" id="1586422">,</span>&nbsp;<span class="ident" id="1586424">flags</span>&nbsp;<span class="builtintype" id="1586430">uint32</span><span class="op" id="1586436">)</span>&nbsp;<span class="ident" id="1586438">unsafe</span><span class="op" id="1586444">.</span><span class="ident" id="1586445">Pointer</span>&nbsp;<span class="op" id="1586453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586456">if</span>&nbsp;<span class="ident" id="1586459">size</span>&nbsp;<span class="op" id="1586464">==</span>&nbsp;<span class="num" id="1586467">0</span>&nbsp;<span class="op" id="1586469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586473">return</span>&nbsp;<span class="ident" id="1586480">unsafe</span><span class="op" id="1586486">.</span><span class="ident" id="1586487">Pointer</span><span class="op" id="1586494">(</span><span class="op" id="1586495">&amp;</span><span class="ident" id="1586496">zerobase</span><span class="op" id="1586504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586507">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586510">size0</span>&nbsp;<span class="op" id="1586516">:=</span>&nbsp;<span class="ident" id="1586519">size</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586526">if</span>&nbsp;<span class="ident" id="1586529">flags</span><span class="op" id="1586534">&amp;</span><span class="ident" id="1586535">flagNoScan</span>&nbsp;<span class="op" id="1586546">==</span>&nbsp;<span class="num" id="1586549">0</span>&nbsp;<span class="op" id="1586551">&amp;&amp;</span>&nbsp;<span class="ident" id="1586554">typ</span>&nbsp;<span class="op" id="1586558">==</span>&nbsp;<span class="ident" id="1586561">nil</span>&nbsp;<span class="op" id="1586565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586569">gothrow</span><span class="op" id="1586576">(</span><span class="string" id="1586577">&#34;malloc&nbsp;missing&nbsp;type&#34;</span><span class="op" id="1586598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586601">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1586605">//&nbsp;This&nbsp;function&nbsp;must&nbsp;be&nbsp;atomic&nbsp;wrt&nbsp;GC,&nbsp;but&nbsp;for&nbsp;performance&nbsp;reasons</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1586674">//&nbsp;we&nbsp;don&#39;t&nbsp;acquirem/releasem&nbsp;on&nbsp;fast&nbsp;path.&nbsp;The&nbsp;code&nbsp;below&nbsp;does&nbsp;not&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1586748">//&nbsp;split&nbsp;stack&nbsp;checks,&nbsp;so&nbsp;it&nbsp;can&#39;t&nbsp;be&nbsp;preempted&nbsp;by&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1586804">//&nbsp;Functions&nbsp;like&nbsp;roundup/add&nbsp;are&nbsp;inlined.&nbsp;And&nbsp;onM/racemalloc&nbsp;are&nbsp;nosplit.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1586880">//&nbsp;If&nbsp;debugMalloc&nbsp;=&nbsp;true,&nbsp;these&nbsp;assumptions&nbsp;are&nbsp;checked&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586944">if</span>&nbsp;<span class="ident" id="1586947">debugMalloc</span>&nbsp;<span class="op" id="1586959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586963">mp</span>&nbsp;<span class="op" id="1586966">:=</span>&nbsp;<span class="ident" id="1586969">acquirem</span><span class="op" id="1586977">(</span><span class="op" id="1586978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586982">if</span>&nbsp;<span class="ident" id="1586985">mp</span><span class="op" id="1586987">.</span><span class="ident" id="1586988">mallocing</span>&nbsp;<span class="op" id="1586998">!=</span>&nbsp;<span class="num" id="1587001">0</span>&nbsp;<span class="op" id="1587003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587008">gothrow</span><span class="op" id="1587015">(</span><span class="string" id="1587016">&#34;malloc&nbsp;deadlock&#34;</span><span class="op" id="1587033">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587041">mp</span><span class="op" id="1587043">.</span><span class="ident" id="1587044">mallocing</span>&nbsp;<span class="op" id="1587054">=</span>&nbsp;<span class="num" id="1587056">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587060">if</span>&nbsp;<span class="ident" id="1587063">mp</span><span class="op" id="1587065">.</span><span class="ident" id="1587066">curg</span>&nbsp;<span class="op" id="1587071">!=</span>&nbsp;<span class="ident" id="1587074">nil</span>&nbsp;<span class="op" id="1587078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587083">mp</span><span class="op" id="1587085">.</span><span class="ident" id="1587086">curg</span><span class="op" id="1587090">.</span><span class="ident" id="1587091">stackguard0</span>&nbsp;<span class="op" id="1587103">=</span>&nbsp;<span class="op" id="1587105">^</span><span class="builtintype" id="1587106">uintptr</span><span class="op" id="1587113">(</span><span class="num" id="1587114">0xfff</span><span class="op" id="1587119">)</span>&nbsp;<span class="op" id="1587121">|</span>&nbsp;<span class="num" id="1587123">0xbad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587131">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587138">c</span>&nbsp;<span class="op" id="1587140">:=</span>&nbsp;<span class="ident" id="1587143">gomcache</span><span class="op" id="1587151">(</span><span class="op" id="1587152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587155">var</span>&nbsp;<span class="ident" id="1587159">s</span>&nbsp;<span class="op" id="1587161">*</span><span class="ident" id="1587162">mspan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587169">var</span>&nbsp;<span class="ident" id="1587173">x</span>&nbsp;<span class="ident" id="1587175">unsafe</span><span class="op" id="1587181">.</span><span class="ident" id="1587182">Pointer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587191">if</span>&nbsp;<span class="ident" id="1587194">size</span>&nbsp;<span class="op" id="1587199">&lt;=</span>&nbsp;<span class="ident" id="1587202">maxSmallSize</span>&nbsp;<span class="op" id="1587215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587219">if</span>&nbsp;<span class="ident" id="1587222">flags</span><span class="op" id="1587227">&amp;</span><span class="ident" id="1587228">flagNoScan</span>&nbsp;<span class="op" id="1587239">!=</span>&nbsp;<span class="num" id="1587242">0</span>&nbsp;<span class="op" id="1587244">&amp;&amp;</span>&nbsp;<span class="ident" id="1587247">size</span>&nbsp;<span class="op" id="1587252">&lt;</span>&nbsp;<span class="ident" id="1587254">maxTinySize</span>&nbsp;<span class="op" id="1587266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587271">//&nbsp;Tiny&nbsp;allocator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587293">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587299">//&nbsp;Tiny&nbsp;allocator&nbsp;combines&nbsp;several&nbsp;tiny&nbsp;allocation&nbsp;requests</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587362">//&nbsp;into&nbsp;a&nbsp;single&nbsp;memory&nbsp;block.&nbsp;The&nbsp;resulting&nbsp;memory&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587423">//&nbsp;is&nbsp;freed&nbsp;when&nbsp;all&nbsp;subobjects&nbsp;are&nbsp;unreachable.&nbsp;The&nbsp;subobjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587490">//&nbsp;must&nbsp;be&nbsp;FlagNoScan&nbsp;(don&#39;t&nbsp;have&nbsp;pointers),&nbsp;this&nbsp;ensures&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587556">//&nbsp;the&nbsp;amount&nbsp;of&nbsp;potentially&nbsp;wasted&nbsp;memory&nbsp;is&nbsp;bounded.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587614">//</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587620">//&nbsp;Size&nbsp;of&nbsp;the&nbsp;memory&nbsp;block&nbsp;used&nbsp;for&nbsp;combining&nbsp;(maxTinySize)&nbsp;is&nbsp;tunable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587696">//&nbsp;Current&nbsp;setting&nbsp;is&nbsp;16&nbsp;bytes,&nbsp;which&nbsp;relates&nbsp;to&nbsp;2x&nbsp;worst&nbsp;case&nbsp;memory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587769">//&nbsp;wastage&nbsp;(when&nbsp;all&nbsp;but&nbsp;one&nbsp;subobjects&nbsp;are&nbsp;unreachable).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587830">//&nbsp;8&nbsp;bytes&nbsp;would&nbsp;result&nbsp;in&nbsp;no&nbsp;wastage&nbsp;at&nbsp;all,&nbsp;but&nbsp;provides&nbsp;less</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587897">//&nbsp;opportunities&nbsp;for&nbsp;combining.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587932">//&nbsp;32&nbsp;bytes&nbsp;provides&nbsp;more&nbsp;opportunities&nbsp;for&nbsp;combining,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587990">//&nbsp;but&nbsp;can&nbsp;lead&nbsp;to&nbsp;4x&nbsp;worst&nbsp;case&nbsp;wastage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588035">//&nbsp;The&nbsp;best&nbsp;case&nbsp;winning&nbsp;is&nbsp;8x&nbsp;regardless&nbsp;of&nbsp;block&nbsp;size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588095">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588101">//&nbsp;Objects&nbsp;obtained&nbsp;from&nbsp;tiny&nbsp;allocator&nbsp;must&nbsp;not&nbsp;be&nbsp;freed&nbsp;explicitly.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588174">//&nbsp;So&nbsp;when&nbsp;an&nbsp;object&nbsp;will&nbsp;be&nbsp;freed&nbsp;explicitly,&nbsp;we&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588239">//&nbsp;its&nbsp;size&nbsp;&gt;=&nbsp;maxTinySize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588270">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588276">//&nbsp;SetFinalizer&nbsp;has&nbsp;a&nbsp;special&nbsp;case&nbsp;for&nbsp;objects&nbsp;potentially&nbsp;coming</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588345">//&nbsp;from&nbsp;tiny&nbsp;allocator,&nbsp;it&nbsp;such&nbsp;case&nbsp;it&nbsp;allows&nbsp;to&nbsp;set&nbsp;finalizers</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588413">//&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte&nbsp;of&nbsp;a&nbsp;memory&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588456">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588462">//&nbsp;The&nbsp;main&nbsp;targets&nbsp;of&nbsp;tiny&nbsp;allocator&nbsp;are&nbsp;small&nbsp;strings&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588525">//&nbsp;standalone&nbsp;escaping&nbsp;variables.&nbsp;On&nbsp;a&nbsp;json&nbsp;benchmark</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588582">//&nbsp;the&nbsp;allocator&nbsp;reduces&nbsp;number&nbsp;of&nbsp;allocations&nbsp;by&nbsp;~12%&nbsp;and</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588644">//&nbsp;reduces&nbsp;heap&nbsp;size&nbsp;by&nbsp;~20%.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588677">tinysize</span>&nbsp;<span class="op" id="1588686">:=</span>&nbsp;<span class="builtintype" id="1588689">uintptr</span><span class="op" id="1588696">(</span><span class="ident" id="1588697">c</span><span class="op" id="1588698">.</span><span class="ident" id="1588699">tinysize</span><span class="op" id="1588707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588712">if</span>&nbsp;<span class="ident" id="1588715">size</span>&nbsp;<span class="op" id="1588720">&lt;=</span>&nbsp;<span class="ident" id="1588723">tinysize</span>&nbsp;<span class="op" id="1588732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588738">tiny</span>&nbsp;<span class="op" id="1588743">:=</span>&nbsp;<span class="ident" id="1588746">unsafe</span><span class="op" id="1588752">.</span><span class="ident" id="1588753">Pointer</span><span class="op" id="1588760">(</span><span class="ident" id="1588761">c</span><span class="op" id="1588762">.</span><span class="ident" id="1588763">tiny</span><span class="op" id="1588767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1588773">//&nbsp;Align&nbsp;tiny&nbsp;pointer&nbsp;for&nbsp;required&nbsp;(conservative)&nbsp;alignment.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588838">if</span>&nbsp;<span class="ident" id="1588841">size</span><span class="op" id="1588845">&amp;</span><span class="num" id="1588846">7</span>&nbsp;<span class="op" id="1588848">==</span>&nbsp;<span class="num" id="1588851">0</span>&nbsp;<span class="op" id="1588853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588860">tiny</span>&nbsp;<span class="op" id="1588865">=</span>&nbsp;<span class="ident" id="1588867">roundup</span><span class="op" id="1588874">(</span><span class="ident" id="1588875">tiny</span><span class="op" id="1588879">,</span>&nbsp;<span class="num" id="1588881">8</span><span class="op" id="1588882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588888">}</span>&nbsp;<span class="keyword" id="1588890">else</span>&nbsp;<span class="keyword" id="1588895">if</span>&nbsp;<span class="ident" id="1588898">size</span><span class="op" id="1588902">&amp;</span><span class="num" id="1588903">3</span>&nbsp;<span class="op" id="1588905">==</span>&nbsp;<span class="num" id="1588908">0</span>&nbsp;<span class="op" id="1588910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588917">tiny</span>&nbsp;<span class="op" id="1588922">=</span>&nbsp;<span class="ident" id="1588924">roundup</span><span class="op" id="1588931">(</span><span class="ident" id="1588932">tiny</span><span class="op" id="1588936">,</span>&nbsp;<span class="num" id="1588938">4</span><span class="op" id="1588939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588945">}</span>&nbsp;<span class="keyword" id="1588947">else</span>&nbsp;<span class="keyword" id="1588952">if</span>&nbsp;<span class="ident" id="1588955">size</span><span class="op" id="1588959">&amp;</span><span class="num" id="1588960">1</span>&nbsp;<span class="op" id="1588962">==</span>&nbsp;<span class="num" id="1588965">0</span>&nbsp;<span class="op" id="1588967">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588974">tiny</span>&nbsp;<span class="op" id="1588979">=</span>&nbsp;<span class="ident" id="1588981">roundup</span><span class="op" id="1588988">(</span><span class="ident" id="1588989">tiny</span><span class="op" id="1588993">,</span>&nbsp;<span class="num" id="1588995">2</span><span class="op" id="1588996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589008">size1</span>&nbsp;<span class="op" id="1589014">:=</span>&nbsp;<span class="ident" id="1589017">size</span>&nbsp;<span class="op" id="1589022">+</span>&nbsp;<span class="op" id="1589024">(</span><span class="builtintype" id="1589025">uintptr</span><span class="op" id="1589032">(</span><span class="ident" id="1589033">tiny</span><span class="op" id="1589037">)</span>&nbsp;<span class="op" id="1589039">-</span>&nbsp;<span class="builtintype" id="1589041">uintptr</span><span class="op" id="1589048">(</span><span class="ident" id="1589049">unsafe</span><span class="op" id="1589055">.</span><span class="ident" id="1589056">Pointer</span><span class="op" id="1589063">(</span><span class="ident" id="1589064">c</span><span class="op" id="1589065">.</span><span class="ident" id="1589066">tiny</span><span class="op" id="1589070">)</span><span class="op" id="1589071">)</span><span class="op" id="1589072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589078">if</span>&nbsp;<span class="ident" id="1589081">size1</span>&nbsp;<span class="op" id="1589087">&lt;=</span>&nbsp;<span class="ident" id="1589090">tinysize</span>&nbsp;<span class="op" id="1589099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1589106">//&nbsp;The&nbsp;object&nbsp;fits&nbsp;into&nbsp;existing&nbsp;tiny&nbsp;block.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589156">x</span>&nbsp;<span class="op" id="1589158">=</span>&nbsp;<span class="ident" id="1589160">tiny</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589170">c</span><span class="op" id="1589171">.</span><span class="ident" id="1589172">tiny</span>&nbsp;<span class="op" id="1589177">=</span>&nbsp;<span class="op" id="1589179">(</span><span class="op" id="1589180">*</span><span class="builtintype" id="1589181">byte</span><span class="op" id="1589185">)</span><span class="op" id="1589186">(</span><span class="ident" id="1589187">add</span><span class="op" id="1589190">(</span><span class="ident" id="1589191">x</span><span class="op" id="1589192">,</span>&nbsp;<span class="ident" id="1589194">size</span><span class="op" id="1589198">)</span><span class="op" id="1589199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589206">c</span><span class="op" id="1589207">.</span><span class="ident" id="1589208">tinysize</span>&nbsp;<span class="op" id="1589217">-=</span>&nbsp;<span class="builtintype" id="1589220">uintptr</span><span class="op" id="1589227">(</span><span class="ident" id="1589228">size1</span><span class="op" id="1589233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589240">c</span><span class="op" id="1589241">.</span><span class="ident" id="1589242">local_tinyallocs</span><span class="op" id="1589258">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589266">if</span>&nbsp;<span class="ident" id="1589269">debugMalloc</span>&nbsp;<span class="op" id="1589281">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589289">mp</span>&nbsp;<span class="op" id="1589292">:=</span>&nbsp;<span class="ident" id="1589295">acquirem</span><span class="op" id="1589303">(</span><span class="op" id="1589304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589312">if</span>&nbsp;<span class="ident" id="1589315">mp</span><span class="op" id="1589317">.</span><span class="ident" id="1589318">mallocing</span>&nbsp;<span class="op" id="1589328">==</span>&nbsp;<span class="num" id="1589331">0</span>&nbsp;<span class="op" id="1589333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589342">gothrow</span><span class="op" id="1589349">(</span><span class="string" id="1589350">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1589362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589378">mp</span><span class="op" id="1589380">.</span><span class="ident" id="1589381">mallocing</span>&nbsp;<span class="op" id="1589391">=</span>&nbsp;<span class="num" id="1589393">0</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589401">if</span>&nbsp;<span class="ident" id="1589404">mp</span><span class="op" id="1589406">.</span><span class="ident" id="1589407">curg</span>&nbsp;<span class="op" id="1589412">!=</span>&nbsp;<span class="ident" id="1589415">nil</span>&nbsp;<span class="op" id="1589419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589428">mp</span><span class="op" id="1589430">.</span><span class="ident" id="1589431">curg</span><span class="op" id="1589435">.</span><span class="ident" id="1589436">stackguard0</span>&nbsp;<span class="op" id="1589448">=</span>&nbsp;<span class="ident" id="1589450">mp</span><span class="op" id="1589452">.</span><span class="ident" id="1589453">curg</span><span class="op" id="1589457">.</span><span class="ident" id="1589458">stack</span><span class="op" id="1589463">.</span><span class="ident" id="1589464">lo</span>&nbsp;<span class="op" id="1589467">+</span>&nbsp;<span class="ident" id="1589469">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1589495">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1589552">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589608">releasem</span><span class="op" id="1589616">(</span><span class="ident" id="1589617">mp</span><span class="op" id="1589619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589627">releasem</span><span class="op" id="1589635">(</span><span class="ident" id="1589636">mp</span><span class="op" id="1589638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589652">return</span>&nbsp;<span class="ident" id="1589659">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589665">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1589675">//&nbsp;Allocate&nbsp;a&nbsp;new&nbsp;maxTinySize&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589715">s</span>&nbsp;<span class="op" id="1589717">=</span>&nbsp;<span class="ident" id="1589719">c</span><span class="op" id="1589720">.</span><span class="ident" id="1589721">alloc</span><span class="op" id="1589726">[</span><span class="ident" id="1589727">tinySizeClass</span><span class="op" id="1589740">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589745">v</span>&nbsp;<span class="op" id="1589747">:=</span>&nbsp;<span class="ident" id="1589750">s</span><span class="op" id="1589751">.</span><span class="ident" id="1589752">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589764">if</span>&nbsp;<span class="ident" id="1589767">v</span>&nbsp;<span class="op" id="1589769">==</span>&nbsp;<span class="ident" id="1589772">nil</span>&nbsp;<span class="op" id="1589776">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589782">mp</span>&nbsp;<span class="op" id="1589785">:=</span>&nbsp;<span class="ident" id="1589788">acquirem</span><span class="op" id="1589796">(</span><span class="op" id="1589797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589803">mp</span><span class="op" id="1589805">.</span><span class="ident" id="1589806">scalararg</span><span class="op" id="1589815">[</span><span class="num" id="1589816">0</span><span class="op" id="1589817">]</span>&nbsp;<span class="op" id="1589819">=</span>&nbsp;<span class="ident" id="1589821">tinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589839">onM</span><span class="op" id="1589842">(</span><span class="ident" id="1589843">mcacheRefill_m</span><span class="op" id="1589857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589863">releasem</span><span class="op" id="1589871">(</span><span class="ident" id="1589872">mp</span><span class="op" id="1589874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589880">s</span>&nbsp;<span class="op" id="1589882">=</span>&nbsp;<span class="ident" id="1589884">c</span><span class="op" id="1589885">.</span><span class="ident" id="1589886">alloc</span><span class="op" id="1589891">[</span><span class="ident" id="1589892">tinySizeClass</span><span class="op" id="1589905">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589911">v</span>&nbsp;<span class="op" id="1589913">=</span>&nbsp;<span class="ident" id="1589915">s</span><span class="op" id="1589916">.</span><span class="ident" id="1589917">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589934">s</span><span class="op" id="1589935">.</span><span class="ident" id="1589936">freelist</span>&nbsp;<span class="op" id="1589945">=</span>&nbsp;<span class="ident" id="1589947">v</span><span class="op" id="1589948">.</span><span class="ident" id="1589949">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589957">s</span><span class="op" id="1589958">.</span><span class="ident" id="1589959">ref</span><span class="op" id="1589962">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1589968">//TODO:&nbsp;prefetch&nbsp;v.next</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589995">x</span>&nbsp;<span class="op" id="1589997">=</span>&nbsp;<span class="ident" id="1589999">unsafe</span><span class="op" id="1590005">.</span><span class="ident" id="1590006">Pointer</span><span class="op" id="1590013">(</span><span class="ident" id="1590014">v</span><span class="op" id="1590015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590020">(</span><span class="op" id="1590021">*</span><span class="op" id="1590022">[</span><span class="num" id="1590023">2</span><span class="op" id="1590024">]</span><span class="ident" id="1590025">uint64</span><span class="op" id="1590031">)</span><span class="op" id="1590032">(</span><span class="ident" id="1590033">x</span><span class="op" id="1590034">)</span><span class="op" id="1590035">[</span><span class="num" id="1590036">0</span><span class="op" id="1590037">]</span>&nbsp;<span class="op" id="1590039">=</span>&nbsp;<span class="num" id="1590041">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590046">(</span><span class="op" id="1590047">*</span><span class="op" id="1590048">[</span><span class="num" id="1590049">2</span><span class="op" id="1590050">]</span><span class="ident" id="1590051">uint64</span><span class="op" id="1590057">)</span><span class="op" id="1590058">(</span><span class="ident" id="1590059">x</span><span class="op" id="1590060">)</span><span class="op" id="1590061">[</span><span class="num" id="1590062">1</span><span class="op" id="1590063">]</span>&nbsp;<span class="op" id="1590065">=</span>&nbsp;<span class="num" id="1590067">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1590072">//&nbsp;See&nbsp;if&nbsp;we&nbsp;need&nbsp;to&nbsp;replace&nbsp;the&nbsp;existing&nbsp;tiny&nbsp;block&nbsp;with&nbsp;the&nbsp;new&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1590145">//&nbsp;based&nbsp;on&nbsp;amount&nbsp;of&nbsp;remaining&nbsp;free&nbsp;space.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590192">if</span>&nbsp;<span class="ident" id="1590195">maxTinySize</span><span class="op" id="1590206">-</span><span class="ident" id="1590207">size</span>&nbsp;<span class="op" id="1590212">&gt;</span>&nbsp;<span class="ident" id="1590214">tinysize</span>&nbsp;<span class="op" id="1590223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590229">c</span><span class="op" id="1590230">.</span><span class="ident" id="1590231">tiny</span>&nbsp;<span class="op" id="1590236">=</span>&nbsp;<span class="op" id="1590238">(</span><span class="op" id="1590239">*</span><span class="builtintype" id="1590240">byte</span><span class="op" id="1590244">)</span><span class="op" id="1590245">(</span><span class="ident" id="1590246">add</span><span class="op" id="1590249">(</span><span class="ident" id="1590250">x</span><span class="op" id="1590251">,</span>&nbsp;<span class="ident" id="1590253">size</span><span class="op" id="1590257">)</span><span class="op" id="1590258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590264">c</span><span class="op" id="1590265">.</span><span class="ident" id="1590266">tinysize</span>&nbsp;<span class="op" id="1590275">=</span>&nbsp;<span class="builtintype" id="1590277">uintptr</span><span class="op" id="1590284">(</span><span class="ident" id="1590285">maxTinySize</span>&nbsp;<span class="op" id="1590297">-</span>&nbsp;<span class="ident" id="1590299">size</span><span class="op" id="1590303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590313">size</span>&nbsp;<span class="op" id="1590318">=</span>&nbsp;<span class="ident" id="1590320">maxTinySize</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590334">}</span>&nbsp;<span class="keyword" id="1590336">else</span>&nbsp;<span class="op" id="1590341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590346">var</span>&nbsp;<span class="ident" id="1590350">sizeclass</span>&nbsp;<span class="builtintype" id="1590360">int8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590368">if</span>&nbsp;<span class="ident" id="1590371">size</span>&nbsp;<span class="op" id="1590376">&lt;=</span>&nbsp;<span class="num" id="1590379">1024</span><span class="op" id="1590383">-</span><span class="num" id="1590384">8</span>&nbsp;<span class="op" id="1590386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590392">sizeclass</span>&nbsp;<span class="op" id="1590402">=</span>&nbsp;<span class="ident" id="1590404">size_to_class8</span><span class="op" id="1590418">[</span><span class="op" id="1590419">(</span><span class="ident" id="1590420">size</span><span class="op" id="1590424">+</span><span class="num" id="1590425">7</span><span class="op" id="1590426">)</span><span class="op" id="1590427">&gt;&gt;</span><span class="num" id="1590429">3</span><span class="op" id="1590430">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590435">}</span>&nbsp;<span class="keyword" id="1590437">else</span>&nbsp;<span class="op" id="1590442">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590448">sizeclass</span>&nbsp;<span class="op" id="1590458">=</span>&nbsp;<span class="ident" id="1590460">size_to_class128</span><span class="op" id="1590476">[</span><span class="op" id="1590477">(</span><span class="ident" id="1590478">size</span><span class="op" id="1590482">-</span><span class="num" id="1590483">1024</span><span class="op" id="1590487">+</span><span class="num" id="1590488">127</span><span class="op" id="1590491">)</span><span class="op" id="1590492">&gt;&gt;</span><span class="num" id="1590494">7</span><span class="op" id="1590495">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590505">size</span>&nbsp;<span class="op" id="1590510">=</span>&nbsp;<span class="builtintype" id="1590512">uintptr</span><span class="op" id="1590519">(</span><span class="ident" id="1590520">class_to_size</span><span class="op" id="1590533">[</span><span class="ident" id="1590534">sizeclass</span><span class="op" id="1590543">]</span><span class="op" id="1590544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590549">s</span>&nbsp;<span class="op" id="1590551">=</span>&nbsp;<span class="ident" id="1590553">c</span><span class="op" id="1590554">.</span><span class="ident" id="1590555">alloc</span><span class="op" id="1590560">[</span><span class="ident" id="1590561">sizeclass</span><span class="op" id="1590570">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590575">v</span>&nbsp;<span class="op" id="1590577">:=</span>&nbsp;<span class="ident" id="1590580">s</span><span class="op" id="1590581">.</span><span class="ident" id="1590582">freelist</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590594">if</span>&nbsp;<span class="ident" id="1590597">v</span>&nbsp;<span class="op" id="1590599">==</span>&nbsp;<span class="ident" id="1590602">nil</span>&nbsp;<span class="op" id="1590606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590612">mp</span>&nbsp;<span class="op" id="1590615">:=</span>&nbsp;<span class="ident" id="1590618">acquirem</span><span class="op" id="1590626">(</span><span class="op" id="1590627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590633">mp</span><span class="op" id="1590635">.</span><span class="ident" id="1590636">scalararg</span><span class="op" id="1590645">[</span><span class="num" id="1590646">0</span><span class="op" id="1590647">]</span>&nbsp;<span class="op" id="1590649">=</span>&nbsp;<span class="builtintype" id="1590651">uintptr</span><span class="op" id="1590658">(</span><span class="ident" id="1590659">sizeclass</span><span class="op" id="1590668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590674">onM</span><span class="op" id="1590677">(</span><span class="ident" id="1590678">mcacheRefill_m</span><span class="op" id="1590692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590698">releasem</span><span class="op" id="1590706">(</span><span class="ident" id="1590707">mp</span><span class="op" id="1590709">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590715">s</span>&nbsp;<span class="op" id="1590717">=</span>&nbsp;<span class="ident" id="1590719">c</span><span class="op" id="1590720">.</span><span class="ident" id="1590721">alloc</span><span class="op" id="1590726">[</span><span class="ident" id="1590727">sizeclass</span><span class="op" id="1590736">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590742">v</span>&nbsp;<span class="op" id="1590744">=</span>&nbsp;<span class="ident" id="1590746">s</span><span class="op" id="1590747">.</span><span class="ident" id="1590748">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590765">s</span><span class="op" id="1590766">.</span><span class="ident" id="1590767">freelist</span>&nbsp;<span class="op" id="1590776">=</span>&nbsp;<span class="ident" id="1590778">v</span><span class="op" id="1590779">.</span><span class="ident" id="1590780">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590788">s</span><span class="op" id="1590789">.</span><span class="ident" id="1590790">ref</span><span class="op" id="1590793">++</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1590799">//TODO:&nbsp;prefetch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590819">x</span>&nbsp;<span class="op" id="1590821">=</span>&nbsp;<span class="ident" id="1590823">unsafe</span><span class="op" id="1590829">.</span><span class="ident" id="1590830">Pointer</span><span class="op" id="1590837">(</span><span class="ident" id="1590838">v</span><span class="op" id="1590839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590844">if</span>&nbsp;<span class="ident" id="1590847">flags</span><span class="op" id="1590852">&amp;</span><span class="ident" id="1590853">flagNoZero</span>&nbsp;<span class="op" id="1590864">==</span>&nbsp;<span class="num" id="1590867">0</span>&nbsp;<span class="op" id="1590869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590875">v</span><span class="op" id="1590876">.</span><span class="ident" id="1590877">next</span>&nbsp;<span class="op" id="1590882">=</span>&nbsp;<span class="ident" id="1590884">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590892">if</span>&nbsp;<span class="ident" id="1590895">size</span>&nbsp;<span class="op" id="1590900">&gt;</span>&nbsp;<span class="num" id="1590902">2</span><span class="op" id="1590903">*</span><span class="ident" id="1590904">ptrSize</span>&nbsp;<span class="op" id="1590912">&amp;&amp;</span>&nbsp;<span class="op" id="1590915">(</span><span class="op" id="1590916">(</span><span class="op" id="1590917">*</span><span class="op" id="1590918">[</span><span class="num" id="1590919">2</span><span class="op" id="1590920">]</span><span class="builtintype" id="1590921">uintptr</span><span class="op" id="1590928">)</span><span class="op" id="1590929">(</span><span class="ident" id="1590930">x</span><span class="op" id="1590931">)</span><span class="op" id="1590932">)</span><span class="op" id="1590933">[</span><span class="num" id="1590934">1</span><span class="op" id="1590935">]</span>&nbsp;<span class="op" id="1590937">!=</span>&nbsp;<span class="num" id="1590940">0</span>&nbsp;<span class="op" id="1590942">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590949">memclr</span><span class="op" id="1590955">(</span><span class="ident" id="1590956">unsafe</span><span class="op" id="1590962">.</span><span class="ident" id="1590963">Pointer</span><span class="op" id="1590970">(</span><span class="ident" id="1590971">v</span><span class="op" id="1590972">)</span><span class="op" id="1590973">,</span>&nbsp;<span class="ident" id="1590975">size</span><span class="op" id="1590979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590998">c</span><span class="op" id="1590999">.</span><span class="ident" id="1591000">local_cachealloc</span>&nbsp;<span class="op" id="1591017">+=</span>&nbsp;<span class="ident" id="1591020">intptr</span><span class="op" id="1591026">(</span><span class="ident" id="1591027">size</span><span class="op" id="1591031">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591034">}</span>&nbsp;<span class="keyword" id="1591036">else</span>&nbsp;<span class="op" id="1591041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591045">mp</span>&nbsp;<span class="op" id="1591048">:=</span>&nbsp;<span class="ident" id="1591051">acquirem</span><span class="op" id="1591059">(</span><span class="op" id="1591060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591064">mp</span><span class="op" id="1591066">.</span><span class="ident" id="1591067">scalararg</span><span class="op" id="1591076">[</span><span class="num" id="1591077">0</span><span class="op" id="1591078">]</span>&nbsp;<span class="op" id="1591080">=</span>&nbsp;<span class="builtintype" id="1591082">uintptr</span><span class="op" id="1591089">(</span><span class="ident" id="1591090">size</span><span class="op" id="1591094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591098">mp</span><span class="op" id="1591100">.</span><span class="ident" id="1591101">scalararg</span><span class="op" id="1591110">[</span><span class="num" id="1591111">1</span><span class="op" id="1591112">]</span>&nbsp;<span class="op" id="1591114">=</span>&nbsp;<span class="builtintype" id="1591116">uintptr</span><span class="op" id="1591123">(</span><span class="ident" id="1591124">flags</span><span class="op" id="1591129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591133">onM</span><span class="op" id="1591136">(</span><span class="ident" id="1591137">largeAlloc_m</span><span class="op" id="1591149">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591153">s</span>&nbsp;<span class="op" id="1591155">=</span>&nbsp;<span class="op" id="1591157">(</span><span class="op" id="1591158">*</span><span class="ident" id="1591159">mspan</span><span class="op" id="1591164">)</span><span class="op" id="1591165">(</span><span class="ident" id="1591166">mp</span><span class="op" id="1591168">.</span><span class="ident" id="1591169">ptrarg</span><span class="op" id="1591175">[</span><span class="num" id="1591176">0</span><span class="op" id="1591177">]</span><span class="op" id="1591178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591182">mp</span><span class="op" id="1591184">.</span><span class="ident" id="1591185">ptrarg</span><span class="op" id="1591191">[</span><span class="num" id="1591192">0</span><span class="op" id="1591193">]</span>&nbsp;<span class="op" id="1591195">=</span>&nbsp;<span class="ident" id="1591197">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591203">releasem</span><span class="op" id="1591211">(</span><span class="ident" id="1591212">mp</span><span class="op" id="1591214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591218">x</span>&nbsp;<span class="op" id="1591220">=</span>&nbsp;<span class="ident" id="1591222">unsafe</span><span class="op" id="1591228">.</span><span class="ident" id="1591229">Pointer</span><span class="op" id="1591236">(</span><span class="builtintype" id="1591237">uintptr</span><span class="op" id="1591244">(</span><span class="ident" id="1591245">s</span><span class="op" id="1591246">.</span><span class="ident" id="1591247">start</span>&nbsp;<span class="op" id="1591253">&lt;&lt;</span>&nbsp;<span class="ident" id="1591256">pageShift</span><span class="op" id="1591265">)</span><span class="op" id="1591266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591270">size</span>&nbsp;<span class="op" id="1591275">=</span>&nbsp;<span class="builtintype" id="1591277">uintptr</span><span class="op" id="1591284">(</span><span class="ident" id="1591285">s</span><span class="op" id="1591286">.</span><span class="ident" id="1591287">elemsize</span><span class="op" id="1591295">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591302">if</span>&nbsp;<span class="ident" id="1591305">flags</span><span class="op" id="1591310">&amp;</span><span class="ident" id="1591311">flagNoScan</span>&nbsp;<span class="op" id="1591322">!=</span>&nbsp;<span class="num" id="1591325">0</span>&nbsp;<span class="op" id="1591327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591331">//&nbsp;All&nbsp;objects&nbsp;are&nbsp;pre-marked&nbsp;as&nbsp;noscan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591374">goto</span>&nbsp;<span class="ident" id="1591379">marked</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591391">//&nbsp;If&nbsp;allocating&nbsp;a&nbsp;defer+arg&nbsp;block,&nbsp;now&nbsp;that&nbsp;we&#39;ve&nbsp;picked&nbsp;a&nbsp;malloc&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591464">//&nbsp;large&nbsp;enough&nbsp;to&nbsp;hold&nbsp;everything,&nbsp;cut&nbsp;the&nbsp;&#34;asked&nbsp;for&#34;&nbsp;size&nbsp;down&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591534">//&nbsp;just&nbsp;the&nbsp;defer&nbsp;header,&nbsp;so&nbsp;that&nbsp;the&nbsp;GC&nbsp;bitmap&nbsp;will&nbsp;record&nbsp;the&nbsp;arg&nbsp;block</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591609">//&nbsp;as&nbsp;containing&nbsp;nothing&nbsp;at&nbsp;all&nbsp;(as&nbsp;if&nbsp;it&nbsp;were&nbsp;unused&nbsp;space&nbsp;at&nbsp;the&nbsp;end&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591684">//&nbsp;a&nbsp;malloc&nbsp;block&nbsp;caused&nbsp;by&nbsp;size&nbsp;rounding).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591729">//&nbsp;The&nbsp;defer&nbsp;arg&nbsp;areas&nbsp;are&nbsp;scanned&nbsp;as&nbsp;part&nbsp;of&nbsp;scanstack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591787">if</span>&nbsp;<span class="ident" id="1591790">typ</span>&nbsp;<span class="op" id="1591794">==</span>&nbsp;<span class="ident" id="1591797">deferType</span>&nbsp;<span class="op" id="1591807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591811">size0</span>&nbsp;<span class="op" id="1591817">=</span>&nbsp;<span class="ident" id="1591819">unsafe</span><span class="op" id="1591825">.</span><span class="ident" id="1591826">Sizeof</span><span class="op" id="1591832">(</span><span class="ident" id="1591833">_defer</span><span class="op" id="1591839">{</span><span class="op" id="1591840">}</span><span class="op" id="1591841">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591848">//&nbsp;From&nbsp;here&nbsp;till&nbsp;marked&nbsp;label&nbsp;marking&nbsp;the&nbsp;object&nbsp;as&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591912">//&nbsp;and&nbsp;storing&nbsp;type&nbsp;info&nbsp;in&nbsp;the&nbsp;GC&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591956">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591960">arena_start</span>&nbsp;<span class="op" id="1591972">:=</span>&nbsp;<span class="builtintype" id="1591975">uintptr</span><span class="op" id="1591982">(</span><span class="ident" id="1591983">unsafe</span><span class="op" id="1591989">.</span><span class="ident" id="1591990">Pointer</span><span class="op" id="1591997">(</span><span class="ident" id="1591998">mheap_</span><span class="op" id="1592004">.</span><span class="ident" id="1592005">arena_start</span><span class="op" id="1592016">)</span><span class="op" id="1592017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592021">off</span>&nbsp;<span class="op" id="1592025">:=</span>&nbsp;<span class="op" id="1592028">(</span><span class="builtintype" id="1592029">uintptr</span><span class="op" id="1592036">(</span><span class="ident" id="1592037">x</span><span class="op" id="1592038">)</span>&nbsp;<span class="op" id="1592040">-</span>&nbsp;<span class="ident" id="1592042">arena_start</span><span class="op" id="1592053">)</span>&nbsp;<span class="op" id="1592055">/</span>&nbsp;<span class="ident" id="1592057">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592067">xbits</span>&nbsp;<span class="op" id="1592073">:=</span>&nbsp;<span class="op" id="1592076">(</span><span class="op" id="1592077">*</span><span class="builtintype" id="1592078">uint8</span><span class="op" id="1592083">)</span><span class="op" id="1592084">(</span><span class="ident" id="1592085">unsafe</span><span class="op" id="1592091">.</span><span class="ident" id="1592092">Pointer</span><span class="op" id="1592099">(</span><span class="ident" id="1592100">arena_start</span>&nbsp;<span class="op" id="1592112">-</span>&nbsp;<span class="ident" id="1592114">off</span><span class="op" id="1592117">/</span><span class="ident" id="1592118">wordsPerBitmapByte</span>&nbsp;<span class="op" id="1592137">-</span>&nbsp;<span class="num" id="1592139">1</span><span class="op" id="1592140">)</span><span class="op" id="1592141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592145">shift</span>&nbsp;<span class="op" id="1592151">:=</span>&nbsp;<span class="op" id="1592154">(</span><span class="ident" id="1592155">off</span>&nbsp;<span class="op" id="1592159">%</span>&nbsp;<span class="ident" id="1592161">wordsPerBitmapByte</span><span class="op" id="1592179">)</span>&nbsp;<span class="op" id="1592181">*</span>&nbsp;<span class="ident" id="1592183">gcBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1592192">if</span>&nbsp;<span class="ident" id="1592195">debugMalloc</span>&nbsp;<span class="op" id="1592207">&amp;&amp;</span>&nbsp;<span class="op" id="1592210">(</span><span class="op" id="1592211">(</span><span class="op" id="1592212">*</span><span class="ident" id="1592213">xbits</span><span class="op" id="1592218">&gt;&gt;</span><span class="ident" id="1592220">shift</span><span class="op" id="1592225">)</span><span class="op" id="1592226">&amp;</span><span class="op" id="1592227">(</span><span class="ident" id="1592228">bitMask</span><span class="op" id="1592235">|</span><span class="ident" id="1592236">bitPtrMask</span><span class="op" id="1592246">)</span><span class="op" id="1592247">)</span>&nbsp;<span class="op" id="1592249">!=</span>&nbsp;<span class="ident" id="1592252">bitBoundary</span>&nbsp;<span class="op" id="1592264">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1592269">println</span><span class="op" id="1592276">(</span><span class="string" id="1592277">&#34;runtime:&nbsp;bits&nbsp;=&#34;</span><span class="op" id="1592294">,</span>&nbsp;<span class="op" id="1592296">(</span><span class="op" id="1592297">*</span><span class="ident" id="1592298">xbits</span><span class="op" id="1592303">&gt;&gt;</span><span class="ident" id="1592305">shift</span><span class="op" id="1592310">)</span><span class="op" id="1592311">&amp;</span><span class="op" id="1592312">(</span><span class="ident" id="1592313">bitMask</span><span class="op" id="1592320">|</span><span class="ident" id="1592321">bitPtrMask</span><span class="op" id="1592331">)</span><span class="op" id="1592332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592337">gothrow</span><span class="op" id="1592344">(</span><span class="string" id="1592345">&#34;bad&nbsp;bits&nbsp;in&nbsp;markallocated&#34;</span><span class="op" id="1592372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1592376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1592381">var</span>&nbsp;<span class="ident" id="1592385">ti</span><span class="op" id="1592387">,</span>&nbsp;<span class="ident" id="1592389">te</span>&nbsp;<span class="builtintype" id="1592392">uintptr</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1592402">var</span>&nbsp;<span class="ident" id="1592406">ptrmask</span>&nbsp;<span class="op" id="1592414">*</span><span class="builtintype" id="1592415">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1592423">if</span>&nbsp;<span class="ident" id="1592426">size</span>&nbsp;<span class="op" id="1592431">==</span>&nbsp;<span class="ident" id="1592434">ptrSize</span>&nbsp;<span class="op" id="1592442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1592447">//&nbsp;It&#39;s&nbsp;one&nbsp;word&nbsp;and&nbsp;it&nbsp;has&nbsp;pointers,&nbsp;it&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1592510">*</span><span class="ident" id="1592511">xbits</span>&nbsp;<span class="op" id="1592517">|=</span>&nbsp;<span class="op" id="1592520">(</span><span class="ident" id="1592521">bitsPointer</span>&nbsp;<span class="op" id="1592533">&lt;&lt;</span>&nbsp;<span class="num" id="1592536">2</span><span class="op" id="1592537">)</span>&nbsp;<span class="op" id="1592539">&lt;&lt;</span>&nbsp;<span class="ident" id="1592542">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1592551">goto</span>&nbsp;<span class="ident" id="1592556">marked</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1592565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1592569">if</span>&nbsp;<span class="ident" id="1592572">typ</span><span class="op" id="1592575">.</span><span class="ident" id="1592576">kind</span><span class="op" id="1592580">&amp;</span><span class="ident" id="1592581">kindGCProg</span>&nbsp;<span class="op" id="1592592">!=</span>&nbsp;<span class="num" id="1592595">0</span>&nbsp;<span class="op" id="1592597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592602">nptr</span>&nbsp;<span class="op" id="1592607">:=</span>&nbsp;<span class="op" id="1592610">(</span><span class="builtintype" id="1592611">uintptr</span><span class="op" id="1592618">(</span><span class="ident" id="1592619">typ</span><span class="op" id="1592622">.</span><span class="ident" id="1592623">size</span><span class="op" id="1592627">)</span>&nbsp;<span class="op" id="1592629">+</span>&nbsp;<span class="ident" id="1592631">ptrSize</span>&nbsp;<span class="op" id="1592639">-</span>&nbsp;<span class="num" id="1592641">1</span><span class="op" id="1592642">)</span>&nbsp;<span class="op" id="1592644">/</span>&nbsp;<span class="ident" id="1592646">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592657">masksize</span>&nbsp;<span class="op" id="1592666">:=</span>&nbsp;<span class="ident" id="1592669">nptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1592677">if</span>&nbsp;<span class="ident" id="1592680">masksize</span><span class="op" id="1592688">%</span><span class="num" id="1592689">2</span>&nbsp;<span class="op" id="1592691">!=</span>&nbsp;<span class="num" id="1592694">0</span>&nbsp;<span class="op" id="1592696">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592702">masksize</span>&nbsp;<span class="op" id="1592711">*=</span>&nbsp;<span class="num" id="1592714">2</span>&nbsp;<span class="comment" id="1592716">//&nbsp;repeated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1592731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592736">masksize</span>&nbsp;<span class="op" id="1592745">=</span>&nbsp;<span class="ident" id="1592747">masksize</span>&nbsp;<span class="op" id="1592756">*</span>&nbsp;<span class="ident" id="1592758">pointersPerByte</span>&nbsp;<span class="op" id="1592774">/</span>&nbsp;<span class="num" id="1592776">8</span>&nbsp;<span class="comment" id="1592778">//&nbsp;4&nbsp;bits&nbsp;per&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592800">masksize</span><span class="op" id="1592808">++</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1592842">//&nbsp;unroll&nbsp;flag&nbsp;in&nbsp;the&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1592877">if</span>&nbsp;<span class="ident" id="1592880">masksize</span>&nbsp;<span class="op" id="1592889">&gt;</span>&nbsp;<span class="ident" id="1592891">maxGCMask</span>&nbsp;<span class="op" id="1592901">&amp;&amp;</span>&nbsp;<span class="ident" id="1592904">typ</span><span class="op" id="1592907">.</span><span class="ident" id="1592908">gc</span><span class="op" id="1592910">[</span><span class="num" id="1592911">1</span><span class="op" id="1592912">]</span>&nbsp;<span class="op" id="1592914">!=</span>&nbsp;<span class="num" id="1592917">0</span>&nbsp;<span class="op" id="1592919">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1592925">//&nbsp;If&nbsp;the&nbsp;mask&nbsp;is&nbsp;too&nbsp;large,&nbsp;unroll&nbsp;the&nbsp;program&nbsp;directly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1592986">//&nbsp;into&nbsp;the&nbsp;GC&nbsp;bitmap.&nbsp;It&#39;s&nbsp;7&nbsp;times&nbsp;slower&nbsp;than&nbsp;copying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1593046">//&nbsp;from&nbsp;the&nbsp;pre-unrolled&nbsp;mask,&nbsp;but&nbsp;saves&nbsp;1/16&nbsp;of&nbsp;type&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1593109">//&nbsp;memory&nbsp;for&nbsp;the&nbsp;mask.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593137">mp</span>&nbsp;<span class="op" id="1593140">:=</span>&nbsp;<span class="ident" id="1593143">acquirem</span><span class="op" id="1593151">(</span><span class="op" id="1593152">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593158">mp</span><span class="op" id="1593160">.</span><span class="ident" id="1593161">ptrarg</span><span class="op" id="1593167">[</span><span class="num" id="1593168">0</span><span class="op" id="1593169">]</span>&nbsp;<span class="op" id="1593171">=</span>&nbsp;<span class="ident" id="1593173">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593179">mp</span><span class="op" id="1593181">.</span><span class="ident" id="1593182">ptrarg</span><span class="op" id="1593188">[</span><span class="num" id="1593189">1</span><span class="op" id="1593190">]</span>&nbsp;<span class="op" id="1593192">=</span>&nbsp;<span class="ident" id="1593194">unsafe</span><span class="op" id="1593200">.</span><span class="ident" id="1593201">Pointer</span><span class="op" id="1593208">(</span><span class="ident" id="1593209">typ</span><span class="op" id="1593212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593218">mp</span><span class="op" id="1593220">.</span><span class="ident" id="1593221">scalararg</span><span class="op" id="1593230">[</span><span class="num" id="1593231">0</span><span class="op" id="1593232">]</span>&nbsp;<span class="op" id="1593234">=</span>&nbsp;<span class="builtintype" id="1593236">uintptr</span><span class="op" id="1593243">(</span><span class="ident" id="1593244">size</span><span class="op" id="1593248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593254">mp</span><span class="op" id="1593256">.</span><span class="ident" id="1593257">scalararg</span><span class="op" id="1593266">[</span><span class="num" id="1593267">1</span><span class="op" id="1593268">]</span>&nbsp;<span class="op" id="1593270">=</span>&nbsp;<span class="builtintype" id="1593272">uintptr</span><span class="op" id="1593279">(</span><span class="ident" id="1593280">size0</span><span class="op" id="1593285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593291">onM</span><span class="op" id="1593294">(</span><span class="ident" id="1593295">unrollgcproginplace_m</span><span class="op" id="1593316">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593322">releasem</span><span class="op" id="1593330">(</span><span class="ident" id="1593331">mp</span><span class="op" id="1593333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1593339">goto</span>&nbsp;<span class="ident" id="1593344">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1593354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593359">ptrmask</span>&nbsp;<span class="op" id="1593367">=</span>&nbsp;<span class="op" id="1593369">(</span><span class="op" id="1593370">*</span><span class="builtintype" id="1593371">uint8</span><span class="op" id="1593376">)</span><span class="op" id="1593377">(</span><span class="ident" id="1593378">unsafe</span><span class="op" id="1593384">.</span><span class="ident" id="1593385">Pointer</span><span class="op" id="1593392">(</span><span class="builtintype" id="1593393">uintptr</span><span class="op" id="1593400">(</span><span class="ident" id="1593401">typ</span><span class="op" id="1593404">.</span><span class="ident" id="1593405">gc</span><span class="op" id="1593407">[</span><span class="num" id="1593408">0</span><span class="op" id="1593409">]</span><span class="op" id="1593410">)</span><span class="op" id="1593411">)</span><span class="op" id="1593412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1593417">//&nbsp;Check&nbsp;whether&nbsp;the&nbsp;program&nbsp;is&nbsp;already&nbsp;unrolled.</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1593470">if</span>&nbsp;<span class="builtintype" id="1593473">uintptr</span><span class="op" id="1593480">(</span><span class="ident" id="1593481">atomicloadp</span><span class="op" id="1593492">(</span><span class="ident" id="1593493">unsafe</span><span class="op" id="1593499">.</span><span class="ident" id="1593500">Pointer</span><span class="op" id="1593507">(</span><span class="ident" id="1593508">ptrmask</span><span class="op" id="1593515">)</span><span class="op" id="1593516">)</span><span class="op" id="1593517">)</span><span class="op" id="1593518">&amp;</span><span class="num" id="1593519">0xff</span>&nbsp;<span class="op" id="1593524">==</span>&nbsp;<span class="num" id="1593527">0</span>&nbsp;<span class="op" id="1593529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593535">mp</span>&nbsp;<span class="op" id="1593538">:=</span>&nbsp;<span class="ident" id="1593541">acquirem</span><span class="op" id="1593549">(</span><span class="op" id="1593550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593556">mp</span><span class="op" id="1593558">.</span><span class="ident" id="1593559">ptrarg</span><span class="op" id="1593565">[</span><span class="num" id="1593566">0</span><span class="op" id="1593567">]</span>&nbsp;<span class="op" id="1593569">=</span>&nbsp;<span class="ident" id="1593571">unsafe</span><span class="op" id="1593577">.</span><span class="ident" id="1593578">Pointer</span><span class="op" id="1593585">(</span><span class="ident" id="1593586">typ</span><span class="op" id="1593589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593595">onM</span><span class="op" id="1593598">(</span><span class="ident" id="1593599">unrollgcprog_m</span><span class="op" id="1593613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593619">releasem</span><span class="op" id="1593627">(</span><span class="ident" id="1593628">mp</span><span class="op" id="1593630">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1593635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593640">ptrmask</span>&nbsp;<span class="op" id="1593648">=</span>&nbsp;<span class="op" id="1593650">(</span><span class="op" id="1593651">*</span><span class="builtintype" id="1593652">uint8</span><span class="op" id="1593657">)</span><span class="op" id="1593658">(</span><span class="ident" id="1593659">add</span><span class="op" id="1593662">(</span><span class="ident" id="1593663">unsafe</span><span class="op" id="1593669">.</span><span class="ident" id="1593670">Pointer</span><span class="op" id="1593677">(</span><span class="ident" id="1593678">ptrmask</span><span class="op" id="1593685">)</span><span class="op" id="1593686">,</span>&nbsp;<span class="num" id="1593688">1</span><span class="op" id="1593689">)</span><span class="op" id="1593690">)</span>&nbsp;<span class="comment" id="1593692">//&nbsp;skip&nbsp;the&nbsp;unroll&nbsp;flag&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1593723">}</span>&nbsp;<span class="keyword" id="1593725">else</span>&nbsp;<span class="op" id="1593730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593735">ptrmask</span>&nbsp;<span class="op" id="1593743">=</span>&nbsp;<span class="op" id="1593745">(</span><span class="op" id="1593746">*</span><span class="builtintype" id="1593747">uint8</span><span class="op" id="1593752">)</span><span class="op" id="1593753">(</span><span class="ident" id="1593754">unsafe</span><span class="op" id="1593760">.</span><span class="ident" id="1593761">Pointer</span><span class="op" id="1593768">(</span><span class="ident" id="1593769">typ</span><span class="op" id="1593772">.</span><span class="ident" id="1593773">gc</span><span class="op" id="1593775">[</span><span class="num" id="1593776">0</span><span class="op" id="1593777">]</span><span class="op" id="1593778">)</span><span class="op" id="1593779">)</span>&nbsp;<span class="comment" id="1593781">//&nbsp;pointer&nbsp;to&nbsp;unrolled&nbsp;mask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1593811">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1593815">if</span>&nbsp;<span class="ident" id="1593818">size</span>&nbsp;<span class="op" id="1593823">==</span>&nbsp;<span class="num" id="1593826">2</span><span class="op" id="1593827">*</span><span class="ident" id="1593828">ptrSize</span>&nbsp;<span class="op" id="1593836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1593841">*</span><span class="ident" id="1593842">xbits</span>&nbsp;<span class="op" id="1593848">=</span>&nbsp;<span class="op" id="1593850">*</span><span class="ident" id="1593851">ptrmask</span>&nbsp;<span class="op" id="1593859">|</span>&nbsp;<span class="ident" id="1593861">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1593876">goto</span>&nbsp;<span class="ident" id="1593881">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1593890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1593894">te</span>&nbsp;<span class="op" id="1593897">=</span>&nbsp;<span class="builtintype" id="1593899">uintptr</span><span class="op" id="1593906">(</span><span class="ident" id="1593907">typ</span><span class="op" id="1593910">.</span><span class="ident" id="1593911">size</span><span class="op" id="1593915">)</span>&nbsp;<span class="op" id="1593917">/</span>&nbsp;<span class="ident" id="1593919">ptrSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1593929">//&nbsp;If&nbsp;the&nbsp;type&nbsp;occupies&nbsp;odd&nbsp;number&nbsp;of&nbsp;words,&nbsp;its&nbsp;mask&nbsp;is&nbsp;repeated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1593998">if</span>&nbsp;<span class="ident" id="1594001">te</span><span class="op" id="1594003">%</span><span class="num" id="1594004">2</span>&nbsp;<span class="op" id="1594006">==</span>&nbsp;<span class="num" id="1594009">0</span>&nbsp;<span class="op" id="1594011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594016">te</span>&nbsp;<span class="op" id="1594019">/=</span>&nbsp;<span class="num" id="1594022">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1594030">//&nbsp;Copy&nbsp;pointer&nbsp;bitmask&nbsp;into&nbsp;the&nbsp;bitmap.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594073">for</span>&nbsp;<span class="ident" id="1594077">i</span>&nbsp;<span class="op" id="1594079">:=</span>&nbsp;<span class="builtintype" id="1594082">uintptr</span><span class="op" id="1594089">(</span><span class="num" id="1594090">0</span><span class="op" id="1594091">)</span><span class="op" id="1594092">;</span>&nbsp;<span class="ident" id="1594094">i</span>&nbsp;<span class="op" id="1594096">&lt;</span>&nbsp;<span class="ident" id="1594098">size0</span><span class="op" id="1594103">;</span>&nbsp;<span class="ident" id="1594105">i</span>&nbsp;<span class="op" id="1594107">+=</span>&nbsp;<span class="num" id="1594110">2</span>&nbsp;<span class="op" id="1594112">*</span>&nbsp;<span class="ident" id="1594114">ptrSize</span>&nbsp;<span class="op" id="1594122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594127">v</span>&nbsp;<span class="op" id="1594129">:=</span>&nbsp;<span class="op" id="1594132">*</span><span class="op" id="1594133">(</span><span class="op" id="1594134">*</span><span class="builtintype" id="1594135">uint8</span><span class="op" id="1594140">)</span><span class="op" id="1594141">(</span><span class="ident" id="1594142">add</span><span class="op" id="1594145">(</span><span class="ident" id="1594146">unsafe</span><span class="op" id="1594152">.</span><span class="ident" id="1594153">Pointer</span><span class="op" id="1594160">(</span><span class="ident" id="1594161">ptrmask</span><span class="op" id="1594168">)</span><span class="op" id="1594169">,</span>&nbsp;<span class="ident" id="1594171">ti</span><span class="op" id="1594173">)</span><span class="op" id="1594174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594179">ti</span><span class="op" id="1594181">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594187">if</span>&nbsp;<span class="ident" id="1594190">ti</span>&nbsp;<span class="op" id="1594193">==</span>&nbsp;<span class="ident" id="1594196">te</span>&nbsp;<span class="op" id="1594199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594205">ti</span>&nbsp;<span class="op" id="1594208">=</span>&nbsp;<span class="num" id="1594210">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594220">if</span>&nbsp;<span class="ident" id="1594223">i</span>&nbsp;<span class="op" id="1594225">==</span>&nbsp;<span class="num" id="1594228">0</span>&nbsp;<span class="op" id="1594230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594236">v</span>&nbsp;<span class="op" id="1594238">|=</span>&nbsp;<span class="ident" id="1594241">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594261">if</span>&nbsp;<span class="ident" id="1594264">i</span><span class="op" id="1594265">+</span><span class="ident" id="1594266">ptrSize</span>&nbsp;<span class="op" id="1594274">==</span>&nbsp;<span class="ident" id="1594277">size0</span>&nbsp;<span class="op" id="1594283">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594289">v</span>&nbsp;<span class="op" id="1594291">&amp;^=</span>&nbsp;<span class="builtintype" id="1594295">uint8</span><span class="op" id="1594300">(</span><span class="ident" id="1594301">bitPtrMask</span>&nbsp;<span class="op" id="1594312">&lt;&lt;</span>&nbsp;<span class="num" id="1594315">4</span><span class="op" id="1594316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594327">*</span><span class="ident" id="1594328">xbits</span>&nbsp;<span class="op" id="1594334">=</span>&nbsp;<span class="ident" id="1594336">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594341">xbits</span>&nbsp;<span class="op" id="1594347">=</span>&nbsp;<span class="op" id="1594349">(</span><span class="op" id="1594350">*</span><span class="builtintype" id="1594351">byte</span><span class="op" id="1594355">)</span><span class="op" id="1594356">(</span><span class="ident" id="1594357">add</span><span class="op" id="1594360">(</span><span class="ident" id="1594361">unsafe</span><span class="op" id="1594367">.</span><span class="ident" id="1594368">Pointer</span><span class="op" id="1594375">(</span><span class="ident" id="1594376">xbits</span><span class="op" id="1594381">)</span><span class="op" id="1594382">,</span>&nbsp;<span class="op" id="1594384">^</span><span class="builtintype" id="1594385">uintptr</span><span class="op" id="1594392">(</span><span class="num" id="1594393">0</span><span class="op" id="1594394">)</span><span class="op" id="1594395">)</span><span class="op" id="1594396">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594404">if</span>&nbsp;<span class="ident" id="1594407">size0</span><span class="op" id="1594412">%</span><span class="op" id="1594413">(</span><span class="num" id="1594414">2</span><span class="op" id="1594415">*</span><span class="ident" id="1594416">ptrSize</span><span class="op" id="1594423">)</span>&nbsp;<span class="op" id="1594425">==</span>&nbsp;<span class="num" id="1594428">0</span>&nbsp;<span class="op" id="1594430">&amp;&amp;</span>&nbsp;<span class="ident" id="1594433">size0</span>&nbsp;<span class="op" id="1594439">&lt;</span>&nbsp;<span class="ident" id="1594441">size</span>&nbsp;<span class="op" id="1594446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1594451">//&nbsp;Mark&nbsp;the&nbsp;word&nbsp;after&nbsp;last&nbsp;object&#39;s&nbsp;word&nbsp;as&nbsp;bitsDead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594509">*</span><span class="ident" id="1594510">xbits</span>&nbsp;<span class="op" id="1594516">=</span>&nbsp;<span class="ident" id="1594518">bitsDead</span>&nbsp;<span class="op" id="1594527">&lt;&lt;</span>&nbsp;<span class="num" id="1594530">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594534">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594537">}</span><br>
<span class="lineno"></span><span class="ident" id="1594539">marked</span><span class="op" id="1594545">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594548">if</span>&nbsp;<span class="ident" id="1594551">raceenabled</span>&nbsp;<span class="op" id="1594563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594567">racemalloc</span><span class="op" id="1594577">(</span><span class="ident" id="1594578">x</span><span class="op" id="1594579">,</span>&nbsp;<span class="ident" id="1594581">size</span><span class="op" id="1594585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594588">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594592">if</span>&nbsp;<span class="ident" id="1594595">debugMalloc</span>&nbsp;<span class="op" id="1594607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594611">mp</span>&nbsp;<span class="op" id="1594614">:=</span>&nbsp;<span class="ident" id="1594617">acquirem</span><span class="op" id="1594625">(</span><span class="op" id="1594626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594630">if</span>&nbsp;<span class="ident" id="1594633">mp</span><span class="op" id="1594635">.</span><span class="ident" id="1594636">mallocing</span>&nbsp;<span class="op" id="1594646">==</span>&nbsp;<span class="num" id="1594649">0</span>&nbsp;<span class="op" id="1594651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594656">gothrow</span><span class="op" id="1594663">(</span><span class="string" id="1594664">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1594676">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594684">mp</span><span class="op" id="1594686">.</span><span class="ident" id="1594687">mallocing</span>&nbsp;<span class="op" id="1594697">=</span>&nbsp;<span class="num" id="1594699">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594703">if</span>&nbsp;<span class="ident" id="1594706">mp</span><span class="op" id="1594708">.</span><span class="ident" id="1594709">curg</span>&nbsp;<span class="op" id="1594714">!=</span>&nbsp;<span class="ident" id="1594717">nil</span>&nbsp;<span class="op" id="1594721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594726">mp</span><span class="op" id="1594728">.</span><span class="ident" id="1594729">curg</span><span class="op" id="1594733">.</span><span class="ident" id="1594734">stackguard0</span>&nbsp;<span class="op" id="1594746">=</span>&nbsp;<span class="ident" id="1594748">mp</span><span class="op" id="1594750">.</span><span class="ident" id="1594751">curg</span><span class="op" id="1594755">.</span><span class="ident" id="1594756">stack</span><span class="op" id="1594761">.</span><span class="ident" id="1594762">lo</span>&nbsp;<span class="op" id="1594765">+</span>&nbsp;<span class="ident" id="1594767">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594781">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1594785">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1594838">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594890">releasem</span><span class="op" id="1594898">(</span><span class="ident" id="1594899">mp</span><span class="op" id="1594901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594905">releasem</span><span class="op" id="1594913">(</span><span class="ident" id="1594914">mp</span><span class="op" id="1594916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594919">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594923">if</span>&nbsp;<span class="ident" id="1594926">debug</span><span class="op" id="1594931">.</span><span class="ident" id="1594932">allocfreetrace</span>&nbsp;<span class="op" id="1594947">!=</span>&nbsp;<span class="num" id="1594950">0</span>&nbsp;<span class="op" id="1594952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594956">tracealloc</span><span class="op" id="1594966">(</span><span class="ident" id="1594967">x</span><span class="op" id="1594968">,</span>&nbsp;<span class="ident" id="1594970">size</span><span class="op" id="1594974">,</span>&nbsp;<span class="ident" id="1594976">typ</span><span class="op" id="1594979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594986">if</span>&nbsp;<span class="ident" id="1594989">rate</span>&nbsp;<span class="op" id="1594994">:=</span>&nbsp;<span class="ident" id="1594997">MemProfileRate</span><span class="op" id="1595011">;</span>&nbsp;<span class="ident" id="1595013">rate</span>&nbsp;<span class="op" id="1595018">&gt;</span>&nbsp;<span class="num" id="1595020">0</span>&nbsp;<span class="op" id="1595022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595026">if</span>&nbsp;<span class="ident" id="1595029">size</span>&nbsp;<span class="op" id="1595034">&lt;</span>&nbsp;<span class="builtintype" id="1595036">uintptr</span><span class="op" id="1595043">(</span><span class="ident" id="1595044">rate</span><span class="op" id="1595048">)</span>&nbsp;<span class="op" id="1595050">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1595053">int32</span><span class="op" id="1595058">(</span><span class="ident" id="1595059">size</span><span class="op" id="1595063">)</span>&nbsp;<span class="op" id="1595065">&lt;</span>&nbsp;<span class="ident" id="1595067">c</span><span class="op" id="1595068">.</span><span class="ident" id="1595069">next_sample</span>&nbsp;<span class="op" id="1595081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595086">c</span><span class="op" id="1595087">.</span><span class="ident" id="1595088">next_sample</span>&nbsp;<span class="op" id="1595100">-=</span>&nbsp;<span class="builtintype" id="1595103">int32</span><span class="op" id="1595108">(</span><span class="ident" id="1595109">size</span><span class="op" id="1595113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1595117">}</span>&nbsp;<span class="keyword" id="1595119">else</span>&nbsp;<span class="op" id="1595124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595129">mp</span>&nbsp;<span class="op" id="1595132">:=</span>&nbsp;<span class="ident" id="1595135">acquirem</span><span class="op" id="1595143">(</span><span class="op" id="1595144">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595149">profilealloc</span><span class="op" id="1595161">(</span><span class="ident" id="1595162">mp</span><span class="op" id="1595164">,</span>&nbsp;<span class="ident" id="1595166">x</span><span class="op" id="1595167">,</span>&nbsp;<span class="ident" id="1595169">size</span><span class="op" id="1595173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595178">releasem</span><span class="op" id="1595186">(</span><span class="ident" id="1595187">mp</span><span class="op" id="1595189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1595193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1595196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595200">if</span>&nbsp;<span class="ident" id="1595203">memstats</span><span class="op" id="1595211">.</span><span class="ident" id="1595212">heap_alloc</span>&nbsp;<span class="op" id="1595223">&gt;=</span>&nbsp;<span class="ident" id="1595226">memstats</span><span class="op" id="1595234">.</span><span class="ident" id="1595235">next_gc</span>&nbsp;<span class="op" id="1595243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595247">gogc</span><span class="op" id="1595251">(</span><span class="num" id="1595252">0</span><span class="op" id="1595253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1595256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595260">return</span>&nbsp;<span class="ident" id="1595267">x</span><br>
<span class="lineno">345</span><span class="op" id="1595269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1595272">//&nbsp;implementation&nbsp;of&nbsp;new&nbsp;builtin</span><br>
<span class="lineno"></span><span class="keyword" id="1595305">func</span>&nbsp;<span class="ident" id="1595310">newobject</span><span class="op" id="1595319">(</span><span class="ident" id="1595320">typ</span>&nbsp;<span class="op" id="1595324">*</span><span class="ident" id="1595325">_type</span><span class="op" id="1595330">)</span>&nbsp;<span class="ident" id="1595332">unsafe</span><span class="op" id="1595338">.</span><span class="ident" id="1595339">Pointer</span>&nbsp;<span class="op" id="1595347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595350">flags</span>&nbsp;<span class="op" id="1595356">:=</span>&nbsp;<span class="builtintype" id="1595359">uint32</span><span class="op" id="1595365">(</span><span class="num" id="1595366">0</span><span class="op" id="1595367">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595370">if</span>&nbsp;<span class="ident" id="1595373">typ</span><span class="op" id="1595376">.</span><span class="ident" id="1595377">kind</span><span class="op" id="1595381">&amp;</span><span class="ident" id="1595382">kindNoPointers</span>&nbsp;<span class="op" id="1595397">!=</span>&nbsp;<span class="num" id="1595400">0</span>&nbsp;<span class="op" id="1595402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595406">flags</span>&nbsp;<span class="op" id="1595412">|=</span>&nbsp;<span class="ident" id="1595415">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1595427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595430">return</span>&nbsp;<span class="ident" id="1595437">mallocgc</span><span class="op" id="1595445">(</span><span class="builtintype" id="1595446">uintptr</span><span class="op" id="1595453">(</span><span class="ident" id="1595454">typ</span><span class="op" id="1595457">.</span><span class="ident" id="1595458">size</span><span class="op" id="1595462">)</span><span class="op" id="1595463">,</span>&nbsp;<span class="ident" id="1595465">typ</span><span class="op" id="1595468">,</span>&nbsp;<span class="ident" id="1595470">flags</span><span class="op" id="1595475">)</span><br>
<span class="lineno"></span><span class="op" id="1595477">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="1595480">//&nbsp;implementation&nbsp;of&nbsp;make&nbsp;builtin&nbsp;for&nbsp;slices</span><br>
<span class="lineno"></span><span class="keyword" id="1595525">func</span>&nbsp;<span class="ident" id="1595530">newarray</span><span class="op" id="1595538">(</span><span class="ident" id="1595539">typ</span>&nbsp;<span class="op" id="1595543">*</span><span class="ident" id="1595544">_type</span><span class="op" id="1595549">,</span>&nbsp;<span class="ident" id="1595551">n</span>&nbsp;<span class="builtintype" id="1595553">uintptr</span><span class="op" id="1595560">)</span>&nbsp;<span class="ident" id="1595562">unsafe</span><span class="op" id="1595568">.</span><span class="ident" id="1595569">Pointer</span>&nbsp;<span class="op" id="1595577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595580">flags</span>&nbsp;<span class="op" id="1595586">:=</span>&nbsp;<span class="builtintype" id="1595589">uint32</span><span class="op" id="1595595">(</span><span class="num" id="1595596">0</span><span class="op" id="1595597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595600">if</span>&nbsp;<span class="ident" id="1595603">typ</span><span class="op" id="1595606">.</span><span class="ident" id="1595607">kind</span><span class="op" id="1595611">&amp;</span><span class="ident" id="1595612">kindNoPointers</span>&nbsp;<span class="op" id="1595627">!=</span>&nbsp;<span class="num" id="1595630">0</span>&nbsp;<span class="op" id="1595632">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595636">flags</span>&nbsp;<span class="op" id="1595642">|=</span>&nbsp;<span class="ident" id="1595645">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1595657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595660">if</span>&nbsp;<span class="builtintype" id="1595663">int</span><span class="op" id="1595666">(</span><span class="ident" id="1595667">n</span><span class="op" id="1595668">)</span>&nbsp;<span class="op" id="1595670">&lt;</span>&nbsp;<span class="num" id="1595672">0</span>&nbsp;<span class="op" id="1595674">||</span>&nbsp;<span class="op" id="1595677">(</span><span class="ident" id="1595678">typ</span><span class="op" id="1595681">.</span><span class="ident" id="1595682">size</span>&nbsp;<span class="op" id="1595687">&gt;</span>&nbsp;<span class="num" id="1595689">0</span>&nbsp;<span class="op" id="1595691">&amp;&amp;</span>&nbsp;<span class="ident" id="1595694">n</span>&nbsp;<span class="op" id="1595696">&gt;</span>&nbsp;<span class="ident" id="1595698">maxmem</span><span class="op" id="1595704">/</span><span class="builtintype" id="1595705">uintptr</span><span class="op" id="1595712">(</span><span class="ident" id="1595713">typ</span><span class="op" id="1595716">.</span><span class="ident" id="1595717">size</span><span class="op" id="1595721">)</span><span class="op" id="1595722">)</span>&nbsp;<span class="op" id="1595724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1595728">panic</span><span class="op" id="1595733">(</span><span class="string" id="1595734">&#34;runtime:&nbsp;allocation&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1595773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1595776">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595779">return</span>&nbsp;<span class="ident" id="1595786">mallocgc</span><span class="op" id="1595794">(</span><span class="builtintype" id="1595795">uintptr</span><span class="op" id="1595802">(</span><span class="ident" id="1595803">typ</span><span class="op" id="1595806">.</span><span class="ident" id="1595807">size</span><span class="op" id="1595811">)</span><span class="op" id="1595812">*</span><span class="ident" id="1595813">n</span><span class="op" id="1595814">,</span>&nbsp;<span class="ident" id="1595816">typ</span><span class="op" id="1595819">,</span>&nbsp;<span class="ident" id="1595821">flags</span><span class="op" id="1595826">)</span><br>
<span class="lineno"></span><span class="op" id="1595828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1595831">//&nbsp;rawmem&nbsp;returns&nbsp;a&nbsp;chunk&nbsp;of&nbsp;pointerless&nbsp;memory.&nbsp;&nbsp;It&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1595887">//&nbsp;not&nbsp;zeroed.</span><br>
<span class="lineno">370</span><span class="keyword" id="1595902">func</span>&nbsp;<span class="ident" id="1595907">rawmem</span><span class="op" id="1595913">(</span><span class="ident" id="1595914">size</span>&nbsp;<span class="builtintype" id="1595919">uintptr</span><span class="op" id="1595926">)</span>&nbsp;<span class="ident" id="1595928">unsafe</span><span class="op" id="1595934">.</span><span class="ident" id="1595935">Pointer</span>&nbsp;<span class="op" id="1595943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595946">return</span>&nbsp;<span class="ident" id="1595953">mallocgc</span><span class="op" id="1595961">(</span><span class="ident" id="1595962">size</span><span class="op" id="1595966">,</span>&nbsp;<span class="ident" id="1595968">nil</span><span class="op" id="1595971">,</span>&nbsp;<span class="ident" id="1595973">flagNoScan</span><span class="op" id="1595983">|</span><span class="ident" id="1595984">flagNoZero</span><span class="op" id="1595994">)</span><br>
<span class="lineno"></span><span class="op" id="1595996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1595999">//&nbsp;round&nbsp;size&nbsp;up&nbsp;to&nbsp;next&nbsp;size&nbsp;class</span><br>
<span class="lineno">375</span><span class="keyword" id="1596035">func</span>&nbsp;<span class="ident" id="1596040">goroundupsize</span><span class="op" id="1596053">(</span><span class="ident" id="1596054">size</span>&nbsp;<span class="builtintype" id="1596059">uintptr</span><span class="op" id="1596066">)</span>&nbsp;<span class="builtintype" id="1596068">uintptr</span>&nbsp;<span class="op" id="1596076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596079">if</span>&nbsp;<span class="ident" id="1596082">size</span>&nbsp;<span class="op" id="1596087">&lt;</span>&nbsp;<span class="ident" id="1596089">maxSmallSize</span>&nbsp;<span class="op" id="1596102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596106">if</span>&nbsp;<span class="ident" id="1596109">size</span>&nbsp;<span class="op" id="1596114">&lt;=</span>&nbsp;<span class="num" id="1596117">1024</span><span class="op" id="1596121">-</span><span class="num" id="1596122">8</span>&nbsp;<span class="op" id="1596124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596129">return</span>&nbsp;<span class="builtintype" id="1596136">uintptr</span><span class="op" id="1596143">(</span><span class="ident" id="1596144">class_to_size</span><span class="op" id="1596157">[</span><span class="ident" id="1596158">size_to_class8</span><span class="op" id="1596172">[</span><span class="op" id="1596173">(</span><span class="ident" id="1596174">size</span><span class="op" id="1596178">+</span><span class="num" id="1596179">7</span><span class="op" id="1596180">)</span><span class="op" id="1596181">&gt;&gt;</span><span class="num" id="1596183">3</span><span class="op" id="1596184">]</span><span class="op" id="1596185">]</span><span class="op" id="1596186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596190">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596194">return</span>&nbsp;<span class="builtintype" id="1596201">uintptr</span><span class="op" id="1596208">(</span><span class="ident" id="1596209">class_to_size</span><span class="op" id="1596222">[</span><span class="ident" id="1596223">size_to_class128</span><span class="op" id="1596239">[</span><span class="op" id="1596240">(</span><span class="ident" id="1596241">size</span><span class="op" id="1596245">-</span><span class="num" id="1596246">1024</span><span class="op" id="1596250">+</span><span class="num" id="1596251">127</span><span class="op" id="1596254">)</span><span class="op" id="1596255">&gt;&gt;</span><span class="num" id="1596257">7</span><span class="op" id="1596258">]</span><span class="op" id="1596259">]</span><span class="op" id="1596260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596266">if</span>&nbsp;<span class="ident" id="1596269">size</span><span class="op" id="1596273">+</span><span class="ident" id="1596274">pageSize</span>&nbsp;<span class="op" id="1596283">&lt;</span>&nbsp;<span class="ident" id="1596285">size</span>&nbsp;<span class="op" id="1596290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596294">return</span>&nbsp;<span class="ident" id="1596301">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596307">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596310">return</span>&nbsp;<span class="op" id="1596317">(</span><span class="ident" id="1596318">size</span>&nbsp;<span class="op" id="1596323">+</span>&nbsp;<span class="ident" id="1596325">pageSize</span>&nbsp;<span class="op" id="1596334">-</span>&nbsp;<span class="num" id="1596336">1</span><span class="op" id="1596337">)</span>&nbsp;<span class="op" id="1596339">&amp;^</span>&nbsp;<span class="ident" id="1596342">pageMask</span><br>
<span class="lineno"></span><span class="op" id="1596351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1596354">func</span>&nbsp;<span class="ident" id="1596359">profilealloc</span><span class="op" id="1596371">(</span><span class="ident" id="1596372">mp</span>&nbsp;<span class="op" id="1596375">*</span><span class="ident" id="1596376">m</span><span class="op" id="1596377">,</span>&nbsp;<span class="ident" id="1596379">x</span>&nbsp;<span class="ident" id="1596381">unsafe</span><span class="op" id="1596387">.</span><span class="ident" id="1596388">Pointer</span><span class="op" id="1596395">,</span>&nbsp;<span class="ident" id="1596397">size</span>&nbsp;<span class="builtintype" id="1596402">uintptr</span><span class="op" id="1596409">)</span>&nbsp;<span class="op" id="1596411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596414">c</span>&nbsp;<span class="op" id="1596416">:=</span>&nbsp;<span class="ident" id="1596419">mp</span><span class="op" id="1596421">.</span><span class="ident" id="1596422">mcache</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596430">rate</span>&nbsp;<span class="op" id="1596435">:=</span>&nbsp;<span class="ident" id="1596438">MemProfileRate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596454">if</span>&nbsp;<span class="ident" id="1596457">size</span>&nbsp;<span class="op" id="1596462">&lt;</span>&nbsp;<span class="builtintype" id="1596464">uintptr</span><span class="op" id="1596471">(</span><span class="ident" id="1596472">rate</span><span class="op" id="1596476">)</span>&nbsp;<span class="op" id="1596478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1596482">//&nbsp;pick&nbsp;next&nbsp;profile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1596510">//&nbsp;If&nbsp;you&nbsp;change&nbsp;this,&nbsp;also&nbsp;change&nbsp;allocmcache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596560">if</span>&nbsp;<span class="ident" id="1596563">rate</span>&nbsp;<span class="op" id="1596568">&gt;</span>&nbsp;<span class="num" id="1596570">0x3fffffff</span>&nbsp;<span class="op" id="1596581">{</span>&nbsp;<span class="comment" id="1596583">//&nbsp;make&nbsp;2*rate&nbsp;not&nbsp;overflow</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596614">rate</span>&nbsp;<span class="op" id="1596619">=</span>&nbsp;<span class="num" id="1596621">0x3fffffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596638">next</span>&nbsp;<span class="op" id="1596643">:=</span>&nbsp;<span class="builtintype" id="1596646">int32</span><span class="op" id="1596651">(</span><span class="ident" id="1596652">fastrand1</span><span class="op" id="1596661">(</span><span class="op" id="1596662">)</span><span class="op" id="1596663">)</span>&nbsp;<span class="op" id="1596665">%</span>&nbsp;<span class="op" id="1596667">(</span><span class="num" id="1596668">2</span>&nbsp;<span class="op" id="1596670">*</span>&nbsp;<span class="builtintype" id="1596672">int32</span><span class="op" id="1596677">(</span><span class="ident" id="1596678">rate</span><span class="op" id="1596682">)</span><span class="op" id="1596683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1596687">//&nbsp;Subtract&nbsp;the&nbsp;&#34;remainder&#34;&nbsp;of&nbsp;the&nbsp;current&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1596744">//&nbsp;Otherwise&nbsp;objects&nbsp;that&nbsp;are&nbsp;close&nbsp;in&nbsp;size&nbsp;to&nbsp;sampling&nbsp;rate</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1596807">//&nbsp;will&nbsp;be&nbsp;under-sampled,&nbsp;because&nbsp;we&nbsp;consistently&nbsp;discard&nbsp;this&nbsp;remainder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596883">next</span>&nbsp;<span class="op" id="1596888">-=</span>&nbsp;<span class="op" id="1596891">(</span><span class="builtintype" id="1596892">int32</span><span class="op" id="1596897">(</span><span class="ident" id="1596898">size</span><span class="op" id="1596902">)</span>&nbsp;<span class="op" id="1596904">-</span>&nbsp;<span class="ident" id="1596906">c</span><span class="op" id="1596907">.</span><span class="ident" id="1596908">next_sample</span><span class="op" id="1596919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596923">if</span>&nbsp;<span class="ident" id="1596926">next</span>&nbsp;<span class="op" id="1596931">&lt;</span>&nbsp;<span class="num" id="1596933">0</span>&nbsp;<span class="op" id="1596935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596940">next</span>&nbsp;<span class="op" id="1596945">=</span>&nbsp;<span class="num" id="1596947">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596951">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596955">c</span><span class="op" id="1596956">.</span><span class="ident" id="1596957">next_sample</span>&nbsp;<span class="op" id="1596969">=</span>&nbsp;<span class="ident" id="1596971">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596981">mProf_Malloc</span><span class="op" id="1596993">(</span><span class="ident" id="1596994">x</span><span class="op" id="1596995">,</span>&nbsp;<span class="ident" id="1596997">size</span><span class="op" id="1597001">)</span><br>
<span class="lineno"></span><span class="op" id="1597003">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="1597006">//&nbsp;force&nbsp;=&nbsp;1&nbsp;-&nbsp;do&nbsp;GC&nbsp;regardless&nbsp;of&nbsp;current&nbsp;heap&nbsp;usage</span><br>
<span class="lineno"></span><span class="comment" id="1597060">//&nbsp;force&nbsp;=&nbsp;2&nbsp;-&nbsp;go&nbsp;GC&nbsp;and&nbsp;eager&nbsp;sweep</span><br>
<span class="lineno"></span><span class="keyword" id="1597097">func</span>&nbsp;<span class="ident" id="1597102">gogc</span><span class="op" id="1597106">(</span><span class="ident" id="1597107">force</span>&nbsp;<span class="builtintype" id="1597113">int32</span><span class="op" id="1597118">)</span>&nbsp;<span class="op" id="1597120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597123">//&nbsp;The&nbsp;gc&nbsp;is&nbsp;turned&nbsp;off&nbsp;(via&nbsp;enablegc)&nbsp;until&nbsp;the&nbsp;bootstrap&nbsp;has&nbsp;completed.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597198">//&nbsp;Also,&nbsp;malloc&nbsp;gets&nbsp;called&nbsp;in&nbsp;the&nbsp;guts&nbsp;of&nbsp;a&nbsp;number&nbsp;of&nbsp;libraries&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597278">//&nbsp;holding&nbsp;locks.&nbsp;To&nbsp;avoid&nbsp;deadlocks&nbsp;during&nbsp;stoptheworld,&nbsp;don&#39;t&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597350">//&nbsp;trying&nbsp;to&nbsp;run&nbsp;gc&nbsp;while&nbsp;holding&nbsp;a&nbsp;lock.&nbsp;The&nbsp;next&nbsp;mallocgc&nbsp;without&nbsp;a&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597426">//&nbsp;will&nbsp;do&nbsp;the&nbsp;gc&nbsp;instead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597454">mp</span>&nbsp;<span class="op" id="1597457">:=</span>&nbsp;<span class="ident" id="1597460">acquirem</span><span class="op" id="1597468">(</span><span class="op" id="1597469">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597472">if</span>&nbsp;<span class="ident" id="1597475">gp</span>&nbsp;<span class="op" id="1597478">:=</span>&nbsp;<span class="ident" id="1597481">getg</span><span class="op" id="1597485">(</span><span class="op" id="1597486">)</span><span class="op" id="1597487">;</span>&nbsp;<span class="ident" id="1597489">gp</span>&nbsp;<span class="op" id="1597492">==</span>&nbsp;<span class="ident" id="1597495">mp</span><span class="op" id="1597497">.</span><span class="ident" id="1597498">g0</span>&nbsp;<span class="op" id="1597501">||</span>&nbsp;<span class="ident" id="1597504">mp</span><span class="op" id="1597506">.</span><span class="ident" id="1597507">locks</span>&nbsp;<span class="op" id="1597513">&gt;</span>&nbsp;<span class="num" id="1597515">1</span>&nbsp;<span class="op" id="1597517">||</span>&nbsp;<span class="op" id="1597520">!</span><span class="ident" id="1597521">memstats</span><span class="op" id="1597529">.</span><span class="ident" id="1597530">enablegc</span>&nbsp;<span class="op" id="1597539">||</span>&nbsp;<span class="ident" id="1597542">panicking</span>&nbsp;<span class="op" id="1597552">!=</span>&nbsp;<span class="num" id="1597555">0</span>&nbsp;<span class="op" id="1597557">||</span>&nbsp;<span class="ident" id="1597560">gcpercent</span>&nbsp;<span class="op" id="1597570">&lt;</span>&nbsp;<span class="num" id="1597572">0</span>&nbsp;<span class="op" id="1597574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597578">releasem</span><span class="op" id="1597586">(</span><span class="ident" id="1597587">mp</span><span class="op" id="1597589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597593">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597604">releasem</span><span class="op" id="1597612">(</span><span class="ident" id="1597613">mp</span><span class="op" id="1597615">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597618">mp</span>&nbsp;<span class="op" id="1597621">=</span>&nbsp;<span class="ident" id="1597623">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597629">semacquire</span><span class="op" id="1597639">(</span><span class="op" id="1597640">&amp;</span><span class="ident" id="1597641">worldsema</span><span class="op" id="1597650">,</span>&nbsp;<span class="builtintype" id="1597652">false</span><span class="op" id="1597657">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597661">if</span>&nbsp;<span class="ident" id="1597664">force</span>&nbsp;<span class="op" id="1597670">==</span>&nbsp;<span class="num" id="1597673">0</span>&nbsp;<span class="op" id="1597675">&amp;&amp;</span>&nbsp;<span class="ident" id="1597678">memstats</span><span class="op" id="1597686">.</span><span class="ident" id="1597687">heap_alloc</span>&nbsp;<span class="op" id="1597698">&lt;</span>&nbsp;<span class="ident" id="1597700">memstats</span><span class="op" id="1597708">.</span><span class="ident" id="1597709">next_gc</span>&nbsp;<span class="op" id="1597717">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597721">//&nbsp;typically&nbsp;threads&nbsp;which&nbsp;lost&nbsp;the&nbsp;race&nbsp;to&nbsp;grab</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597772">//&nbsp;worldsema&nbsp;exit&nbsp;here&nbsp;when&nbsp;gc&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597814">semrelease</span><span class="op" id="1597824">(</span><span class="op" id="1597825">&amp;</span><span class="ident" id="1597826">worldsema</span><span class="op" id="1597835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597839">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597847">}</span><br>
<span class="lineno">435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597851">//&nbsp;Ok,&nbsp;we&#39;re&nbsp;doing&nbsp;it!&nbsp;&nbsp;Stop&nbsp;everybody&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597896">startTime</span>&nbsp;<span class="op" id="1597906">:=</span>&nbsp;<span class="ident" id="1597909">nanotime</span><span class="op" id="1597917">(</span><span class="op" id="1597918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597921">mp</span>&nbsp;<span class="op" id="1597924">=</span>&nbsp;<span class="ident" id="1597926">acquirem</span><span class="op" id="1597934">(</span><span class="op" id="1597935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597938">mp</span><span class="op" id="1597940">.</span><span class="ident" id="1597941">gcing</span>&nbsp;<span class="op" id="1597947">=</span>&nbsp;<span class="num" id="1597949">1</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597952">releasem</span><span class="op" id="1597960">(</span><span class="ident" id="1597961">mp</span><span class="op" id="1597963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597966">onM</span><span class="op" id="1597969">(</span><span class="ident" id="1597970">stoptheworld</span><span class="op" id="1597982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597985">if</span>&nbsp;<span class="ident" id="1597988">mp</span>&nbsp;<span class="op" id="1597991">!=</span>&nbsp;<span class="ident" id="1597994">acquirem</span><span class="op" id="1598002">(</span><span class="op" id="1598003">)</span>&nbsp;<span class="op" id="1598005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598009">gothrow</span><span class="op" id="1598016">(</span><span class="string" id="1598017">&#34;gogc:&nbsp;rescheduled&#34;</span><span class="op" id="1598036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598039">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598043">clearpools</span><span class="op" id="1598053">(</span><span class="op" id="1598054">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598058">//&nbsp;Run&nbsp;gc&nbsp;on&nbsp;the&nbsp;g0&nbsp;stack.&nbsp;&nbsp;We&nbsp;do&nbsp;this&nbsp;so&nbsp;that&nbsp;the&nbsp;g&nbsp;stack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598118">//&nbsp;we&#39;re&nbsp;currently&nbsp;running&nbsp;on&nbsp;will&nbsp;no&nbsp;longer&nbsp;change.&nbsp;&nbsp;Cuts</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598178">//&nbsp;the&nbsp;root&nbsp;set&nbsp;down&nbsp;a&nbsp;bit&nbsp;(g0&nbsp;stacks&nbsp;are&nbsp;not&nbsp;scanned,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598238">//&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;scan&nbsp;gc&#39;s&nbsp;internal&nbsp;state).&nbsp;&nbsp;We&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598295">//&nbsp;need&nbsp;to&nbsp;switch&nbsp;to&nbsp;g0&nbsp;so&nbsp;we&nbsp;can&nbsp;shrink&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598348">n</span>&nbsp;<span class="op" id="1598350">:=</span>&nbsp;<span class="num" id="1598353">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598356">if</span>&nbsp;<span class="ident" id="1598359">debug</span><span class="op" id="1598364">.</span><span class="ident" id="1598365">gctrace</span>&nbsp;<span class="op" id="1598373">&gt;</span>&nbsp;<span class="num" id="1598375">1</span>&nbsp;<span class="op" id="1598377">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598381">n</span>&nbsp;<span class="op" id="1598383">=</span>&nbsp;<span class="num" id="1598385">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598391">for</span>&nbsp;<span class="ident" id="1598395">i</span>&nbsp;<span class="op" id="1598397">:=</span>&nbsp;<span class="num" id="1598400">0</span><span class="op" id="1598401">;</span>&nbsp;<span class="ident" id="1598403">i</span>&nbsp;<span class="op" id="1598405">&lt;</span>&nbsp;<span class="ident" id="1598407">n</span><span class="op" id="1598408">;</span>&nbsp;<span class="ident" id="1598410">i</span><span class="op" id="1598411">++</span>&nbsp;<span class="op" id="1598414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598418">if</span>&nbsp;<span class="ident" id="1598421">i</span>&nbsp;<span class="op" id="1598423">&gt;</span>&nbsp;<span class="num" id="1598425">0</span>&nbsp;<span class="op" id="1598427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598432">startTime</span>&nbsp;<span class="op" id="1598442">=</span>&nbsp;<span class="ident" id="1598444">nanotime</span><span class="op" id="1598452">(</span><span class="op" id="1598453">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598461">//&nbsp;switch&nbsp;to&nbsp;g0,&nbsp;call&nbsp;gc,&nbsp;then&nbsp;switch&nbsp;back</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598506">mp</span><span class="op" id="1598508">.</span><span class="ident" id="1598509">scalararg</span><span class="op" id="1598518">[</span><span class="num" id="1598519">0</span><span class="op" id="1598520">]</span>&nbsp;<span class="op" id="1598522">=</span>&nbsp;<span class="builtintype" id="1598524">uintptr</span><span class="op" id="1598531">(</span><span class="builtintype" id="1598532">uint32</span><span class="op" id="1598538">(</span><span class="ident" id="1598539">startTime</span><span class="op" id="1598548">)</span><span class="op" id="1598549">)</span>&nbsp;<span class="comment" id="1598551">//&nbsp;low&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598568">mp</span><span class="op" id="1598570">.</span><span class="ident" id="1598571">scalararg</span><span class="op" id="1598580">[</span><span class="num" id="1598581">1</span><span class="op" id="1598582">]</span>&nbsp;<span class="op" id="1598584">=</span>&nbsp;<span class="builtintype" id="1598586">uintptr</span><span class="op" id="1598593">(</span><span class="ident" id="1598594">startTime</span>&nbsp;<span class="op" id="1598604">&gt;&gt;</span>&nbsp;<span class="num" id="1598607">32</span><span class="op" id="1598609">)</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1598613">//&nbsp;high&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598631">if</span>&nbsp;<span class="ident" id="1598634">force</span>&nbsp;<span class="op" id="1598640">&gt;=</span>&nbsp;<span class="num" id="1598643">2</span>&nbsp;<span class="op" id="1598645">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598650">mp</span><span class="op" id="1598652">.</span><span class="ident" id="1598653">scalararg</span><span class="op" id="1598662">[</span><span class="num" id="1598663">2</span><span class="op" id="1598664">]</span>&nbsp;<span class="op" id="1598666">=</span>&nbsp;<span class="num" id="1598668">1</span>&nbsp;<span class="comment" id="1598670">//&nbsp;eagersweep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598686">}</span>&nbsp;<span class="keyword" id="1598688">else</span>&nbsp;<span class="op" id="1598693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598698">mp</span><span class="op" id="1598700">.</span><span class="ident" id="1598701">scalararg</span><span class="op" id="1598710">[</span><span class="num" id="1598711">2</span><span class="op" id="1598712">]</span>&nbsp;<span class="op" id="1598714">=</span>&nbsp;<span class="num" id="1598716">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598724">onM</span><span class="op" id="1598727">(</span><span class="ident" id="1598728">gc_m</span><span class="op" id="1598732">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598739">//&nbsp;all&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598752">mp</span><span class="op" id="1598754">.</span><span class="ident" id="1598755">gcing</span>&nbsp;<span class="op" id="1598761">=</span>&nbsp;<span class="num" id="1598763">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598766">semrelease</span><span class="op" id="1598776">(</span><span class="op" id="1598777">&amp;</span><span class="ident" id="1598778">worldsema</span><span class="op" id="1598787">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598790">onM</span><span class="op" id="1598793">(</span><span class="ident" id="1598794">starttheworld</span><span class="op" id="1598807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598810">releasem</span><span class="op" id="1598818">(</span><span class="ident" id="1598819">mp</span><span class="op" id="1598821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598824">mp</span>&nbsp;<span class="op" id="1598827">=</span>&nbsp;<span class="ident" id="1598829">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598835">//&nbsp;now&nbsp;that&nbsp;gc&nbsp;is&nbsp;done,&nbsp;kick&nbsp;off&nbsp;finalizer&nbsp;thread&nbsp;if&nbsp;needed</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598896">if</span>&nbsp;<span class="op" id="1598899">!</span><span class="ident" id="1598900">concurrentSweep</span>&nbsp;<span class="op" id="1598916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598920">//&nbsp;give&nbsp;the&nbsp;queued&nbsp;finalizers,&nbsp;if&nbsp;any,&nbsp;a&nbsp;chance&nbsp;to&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598977">Gosched</span><span class="op" id="1598984">(</span><span class="op" id="1598985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598988">}</span><br>
<span class="lineno"></span><span class="op" id="1598990">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="1598993">//&nbsp;GC&nbsp;runs&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span><span class="keyword" id="1599026">func</span>&nbsp;<span class="ident" id="1599031">GC</span><span class="op" id="1599033">(</span><span class="op" id="1599034">)</span>&nbsp;<span class="op" id="1599036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599039">gogc</span><span class="op" id="1599043">(</span><span class="num" id="1599044">2</span><span class="op" id="1599045">)</span><br>
<span class="lineno"></span><span class="op" id="1599047">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="comment" id="1599050">//&nbsp;linker-provided</span><br>
<span class="lineno"></span><span class="keyword" id="1599069">var</span>&nbsp;<span class="ident" id="1599073">noptrdata</span>&nbsp;<span class="keyword" id="1599083">struct</span><span class="op" id="1599089">{</span><span class="op" id="1599090">}</span><br>
<span class="lineno"></span><span class="keyword" id="1599092">var</span>&nbsp;<span class="ident" id="1599096">enoptrdata</span>&nbsp;<span class="keyword" id="1599107">struct</span><span class="op" id="1599113">{</span><span class="op" id="1599114">}</span><br>
<span class="lineno"></span><span class="keyword" id="1599116">var</span>&nbsp;<span class="ident" id="1599120">noptrbss</span>&nbsp;<span class="keyword" id="1599129">struct</span><span class="op" id="1599135">{</span><span class="op" id="1599136">}</span><br>
<span class="lineno">495</span><span class="keyword" id="1599138">var</span>&nbsp;<span class="ident" id="1599142">enoptrbss</span>&nbsp;<span class="keyword" id="1599152">struct</span><span class="op" id="1599158">{</span><span class="op" id="1599159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1599162">//&nbsp;SetFinalizer&nbsp;sets&nbsp;the&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span><span class="comment" id="1599221">//&nbsp;When&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;finds&nbsp;an&nbsp;unreachable&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="1599278">//&nbsp;with&nbsp;an&nbsp;associated&nbsp;finalizer,&nbsp;it&nbsp;clears&nbsp;the&nbsp;association&nbsp;and&nbsp;runs</span><br>
<span class="lineno">500</span><span class="comment" id="1599346">//&nbsp;f(x)&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine.&nbsp;&nbsp;This&nbsp;makes&nbsp;x&nbsp;reachable&nbsp;again,&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="1599414">//&nbsp;now&nbsp;without&nbsp;an&nbsp;associated&nbsp;finalizer.&nbsp;&nbsp;Assuming&nbsp;that&nbsp;SetFinalizer</span><br>
<span class="lineno"></span><span class="comment" id="1599482">//&nbsp;is&nbsp;not&nbsp;called&nbsp;again,&nbsp;the&nbsp;next&nbsp;time&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;sees</span><br>
<span class="lineno"></span><span class="comment" id="1599547">//&nbsp;that&nbsp;x&nbsp;is&nbsp;unreachable,&nbsp;it&nbsp;will&nbsp;free&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1599589">//</span><br>
<span class="lineno">505</span><span class="comment" id="1599592">//&nbsp;SetFinalizer(x,&nbsp;nil)&nbsp;clears&nbsp;any&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1599656">//</span><br>
<span class="lineno"></span><span class="comment" id="1599659">//&nbsp;The&nbsp;argument&nbsp;x&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an&nbsp;object&nbsp;allocated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="1599721">//&nbsp;calling&nbsp;new&nbsp;or&nbsp;by&nbsp;taking&nbsp;the&nbsp;address&nbsp;of&nbsp;a&nbsp;composite&nbsp;literal.</span><br>
<span class="lineno"></span><span class="comment" id="1599785">//&nbsp;The&nbsp;argument&nbsp;f&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;that&nbsp;takes&nbsp;a&nbsp;single&nbsp;argument</span><br>
<span class="lineno">510</span><span class="comment" id="1599851">//&nbsp;to&nbsp;which&nbsp;x&#39;s&nbsp;type&nbsp;can&nbsp;be&nbsp;assigned,&nbsp;and&nbsp;can&nbsp;have&nbsp;arbitrary&nbsp;ignored&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="1599927">//&nbsp;values.&nbsp;If&nbsp;either&nbsp;of&nbsp;these&nbsp;is&nbsp;not&nbsp;true,&nbsp;SetFinalizer&nbsp;aborts&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1599994">//&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1600006">//</span><br>
<span class="lineno"></span><span class="comment" id="1600009">//&nbsp;Finalizers&nbsp;are&nbsp;run&nbsp;in&nbsp;dependency&nbsp;order:&nbsp;if&nbsp;A&nbsp;points&nbsp;at&nbsp;B,&nbsp;both&nbsp;have</span><br>
<span class="lineno">515</span><span class="comment" id="1600080">//&nbsp;finalizers,&nbsp;and&nbsp;they&nbsp;are&nbsp;otherwise&nbsp;unreachable,&nbsp;only&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1600150">//&nbsp;for&nbsp;A&nbsp;runs;&nbsp;once&nbsp;A&nbsp;is&nbsp;freed,&nbsp;the&nbsp;finalizer&nbsp;for&nbsp;B&nbsp;can&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="1600211">//&nbsp;If&nbsp;a&nbsp;cyclic&nbsp;structure&nbsp;includes&nbsp;a&nbsp;block&nbsp;with&nbsp;a&nbsp;finalizer,&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1600276">//&nbsp;cycle&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;and&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1600345">//&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;run,&nbsp;because&nbsp;there&nbsp;is&nbsp;no&nbsp;ordering&nbsp;that</span><br>
<span class="lineno">520</span><span class="comment" id="1600408">//&nbsp;respects&nbsp;the&nbsp;dependencies.</span><br>
<span class="lineno"></span><span class="comment" id="1600438">//</span><br>
<span class="lineno"></span><span class="comment" id="1600441">//&nbsp;The&nbsp;finalizer&nbsp;for&nbsp;x&nbsp;is&nbsp;scheduled&nbsp;to&nbsp;run&nbsp;at&nbsp;some&nbsp;arbitrary&nbsp;time&nbsp;after</span><br>
<span class="lineno"></span><span class="comment" id="1600513">//&nbsp;x&nbsp;becomes&nbsp;unreachable.</span><br>
<span class="lineno"></span><span class="comment" id="1600539">//&nbsp;There&nbsp;is&nbsp;no&nbsp;guarantee&nbsp;that&nbsp;finalizers&nbsp;will&nbsp;run&nbsp;before&nbsp;a&nbsp;program&nbsp;exits,</span><br>
<span class="lineno">525</span><span class="comment" id="1600613">//&nbsp;so&nbsp;typically&nbsp;they&nbsp;are&nbsp;useful&nbsp;only&nbsp;for&nbsp;releasing&nbsp;non-memory&nbsp;resources</span><br>
<span class="lineno"></span><span class="comment" id="1600685">//&nbsp;associated&nbsp;with&nbsp;an&nbsp;object&nbsp;during&nbsp;a&nbsp;long-running&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1600745">//&nbsp;For&nbsp;example,&nbsp;an&nbsp;os.File&nbsp;object&nbsp;could&nbsp;use&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;close&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1600814">//&nbsp;associated&nbsp;operating&nbsp;system&nbsp;file&nbsp;descriptor&nbsp;when&nbsp;a&nbsp;program&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="1600885">//&nbsp;an&nbsp;os.File&nbsp;without&nbsp;calling&nbsp;Close,&nbsp;but&nbsp;it&nbsp;would&nbsp;be&nbsp;a&nbsp;mistake</span><br>
<span class="lineno">530</span><span class="comment" id="1600948">//&nbsp;to&nbsp;depend&nbsp;on&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;flush&nbsp;an&nbsp;in-memory&nbsp;I/O&nbsp;buffer&nbsp;such&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1601019">//&nbsp;bufio.Writer,&nbsp;because&nbsp;the&nbsp;buffer&nbsp;would&nbsp;not&nbsp;be&nbsp;flushed&nbsp;at&nbsp;program&nbsp;exit.</span><br>
<span class="lineno"></span><span class="comment" id="1601093">//</span><br>
<span class="lineno"></span><span class="comment" id="1601096">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;*x&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1601167">//&nbsp;zero&nbsp;bytes.</span><br>
<span class="lineno">535</span><span class="comment" id="1601182">//</span><br>
<span class="lineno"></span><span class="comment" id="1601185">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;for&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1601257">//&nbsp;in&nbsp;initializers&nbsp;for&nbsp;package-level&nbsp;variables.&nbsp;Such&nbsp;objects&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1601325">//&nbsp;linker-allocated,&nbsp;not&nbsp;heap-allocated.</span><br>
<span class="lineno"></span><span class="comment" id="1601366">//</span><br>
<span class="lineno">540</span><span class="comment" id="1601369">//&nbsp;A&nbsp;single&nbsp;goroutine&nbsp;runs&nbsp;all&nbsp;finalizers&nbsp;for&nbsp;a&nbsp;program,&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="comment" id="1601440">//&nbsp;If&nbsp;a&nbsp;finalizer&nbsp;must&nbsp;run&nbsp;for&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;should&nbsp;do&nbsp;so&nbsp;by&nbsp;starting</span><br>
<span class="lineno"></span><span class="comment" id="1601512">//&nbsp;a&nbsp;new&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1601532">func</span>&nbsp;<span class="ident" id="1601537">SetFinalizer</span><span class="op" id="1601549">(</span><span class="ident" id="1601550">obj</span>&nbsp;<span class="keyword" id="1601554">interface</span><span class="op" id="1601563">{</span><span class="op" id="1601564">}</span><span class="op" id="1601565">,</span>&nbsp;<span class="ident" id="1601567">finalizer</span>&nbsp;<span class="keyword" id="1601577">interface</span><span class="op" id="1601586">{</span><span class="op" id="1601587">}</span><span class="op" id="1601588">)</span>&nbsp;<span class="op" id="1601590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601593">e</span>&nbsp;<span class="op" id="1601595">:=</span>&nbsp;<span class="op" id="1601598">(</span><span class="op" id="1601599">*</span><span class="ident" id="1601600">eface</span><span class="op" id="1601605">)</span><span class="op" id="1601606">(</span><span class="ident" id="1601607">unsafe</span><span class="op" id="1601613">.</span><span class="ident" id="1601614">Pointer</span><span class="op" id="1601621">(</span><span class="op" id="1601622">&amp;</span><span class="ident" id="1601623">obj</span><span class="op" id="1601626">)</span><span class="op" id="1601627">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601630">etyp</span>&nbsp;<span class="op" id="1601635">:=</span>&nbsp;<span class="ident" id="1601638">e</span><span class="op" id="1601639">.</span><span class="ident" id="1601640">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601647">if</span>&nbsp;<span class="ident" id="1601650">etyp</span>&nbsp;<span class="op" id="1601655">==</span>&nbsp;<span class="ident" id="1601658">nil</span>&nbsp;<span class="op" id="1601662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601666">gothrow</span><span class="op" id="1601673">(</span><span class="string" id="1601674">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;nil&#34;</span><span class="op" id="1601719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1601722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601725">if</span>&nbsp;<span class="ident" id="1601728">etyp</span><span class="op" id="1601732">.</span><span class="ident" id="1601733">kind</span><span class="op" id="1601737">&amp;</span><span class="ident" id="1601738">kindMask</span>&nbsp;<span class="op" id="1601747">!=</span>&nbsp;<span class="ident" id="1601750">kindPtr</span>&nbsp;<span class="op" id="1601758">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601762">gothrow</span><span class="op" id="1601769">(</span><span class="string" id="1601770">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1601813">+</span>&nbsp;<span class="op" id="1601815">*</span><span class="ident" id="1601816">etyp</span><span class="op" id="1601820">.</span><span class="ident" id="1601821">_string</span>&nbsp;<span class="op" id="1601829">+</span>&nbsp;<span class="string" id="1601831">&#34;,&nbsp;not&nbsp;pointer&#34;</span><span class="op" id="1601846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1601849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601852">ot</span>&nbsp;<span class="op" id="1601855">:=</span>&nbsp;<span class="op" id="1601858">(</span><span class="op" id="1601859">*</span><span class="ident" id="1601860">ptrtype</span><span class="op" id="1601867">)</span><span class="op" id="1601868">(</span><span class="ident" id="1601869">unsafe</span><span class="op" id="1601875">.</span><span class="ident" id="1601876">Pointer</span><span class="op" id="1601883">(</span><span class="ident" id="1601884">etyp</span><span class="op" id="1601888">)</span><span class="op" id="1601889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601892">if</span>&nbsp;<span class="ident" id="1601895">ot</span><span class="op" id="1601897">.</span><span class="ident" id="1601898">elem</span>&nbsp;<span class="op" id="1601903">==</span>&nbsp;<span class="ident" id="1601906">nil</span>&nbsp;<span class="op" id="1601910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601914">gothrow</span><span class="op" id="1601921">(</span><span class="string" id="1601922">&#34;nil&nbsp;elem&nbsp;type!&#34;</span><span class="op" id="1601938">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1601941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1601945">//&nbsp;find&nbsp;the&nbsp;containing&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601976">_</span><span class="op" id="1601977">,</span>&nbsp;<span class="ident" id="1601979">base</span><span class="op" id="1601983">,</span>&nbsp;<span class="ident" id="1601985">_</span>&nbsp;<span class="op" id="1601987">:=</span>&nbsp;<span class="ident" id="1601990">findObject</span><span class="op" id="1602000">(</span><span class="ident" id="1602001">e</span><span class="op" id="1602002">.</span><span class="ident" id="1602003">data</span><span class="op" id="1602007">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602011">if</span>&nbsp;<span class="ident" id="1602014">base</span>&nbsp;<span class="op" id="1602019">==</span>&nbsp;<span class="ident" id="1602022">nil</span>&nbsp;<span class="op" id="1602026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1602030">//&nbsp;0-length&nbsp;objects&nbsp;are&nbsp;okay.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602062">if</span>&nbsp;<span class="ident" id="1602065">e</span><span class="op" id="1602066">.</span><span class="ident" id="1602067">data</span>&nbsp;<span class="op" id="1602072">==</span>&nbsp;<span class="ident" id="1602075">unsafe</span><span class="op" id="1602081">.</span><span class="ident" id="1602082">Pointer</span><span class="op" id="1602089">(</span><span class="op" id="1602090">&amp;</span><span class="ident" id="1602091">zerobase</span><span class="op" id="1602099">)</span>&nbsp;<span class="op" id="1602101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602106">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602115">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1602120">//&nbsp;Global&nbsp;initializers&nbsp;might&nbsp;be&nbsp;linker-allocated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1602172">//&nbsp;&nbsp;&nbsp;&nbspvar&nbsp;Foo&nbsp;=&nbsp;&amp;Object{}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1602197">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1602216">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspruntime.SetFinalizer(Foo,&nbsp;nil)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1602253">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1602260">//&nbsp;The&nbsp;relevant&nbsp;segments&nbsp;are:&nbsp;noptrdata,&nbsp;data,&nbsp;bss,&nbsp;noptrbss.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1602324">//&nbsp;We&nbsp;cannot&nbsp;assume&nbsp;they&nbsp;are&nbsp;in&nbsp;any&nbsp;order&nbsp;or&nbsp;even&nbsp;contiguous,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1602388">//&nbsp;due&nbsp;to&nbsp;external&nbsp;linking.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602418">if</span>&nbsp;<span class="builtintype" id="1602421">uintptr</span><span class="op" id="1602428">(</span><span class="ident" id="1602429">unsafe</span><span class="op" id="1602435">.</span><span class="ident" id="1602436">Pointer</span><span class="op" id="1602443">(</span><span class="op" id="1602444">&amp;</span><span class="ident" id="1602445">noptrdata</span><span class="op" id="1602454">)</span><span class="op" id="1602455">)</span>&nbsp;<span class="op" id="1602457">&lt;=</span>&nbsp;<span class="builtintype" id="1602460">uintptr</span><span class="op" id="1602467">(</span><span class="ident" id="1602468">e</span><span class="op" id="1602469">.</span><span class="ident" id="1602470">data</span><span class="op" id="1602474">)</span>&nbsp;<span class="op" id="1602476">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1602479">uintptr</span><span class="op" id="1602486">(</span><span class="ident" id="1602487">e</span><span class="op" id="1602488">.</span><span class="ident" id="1602489">data</span><span class="op" id="1602493">)</span>&nbsp;<span class="op" id="1602495">&lt;</span>&nbsp;<span class="builtintype" id="1602497">uintptr</span><span class="op" id="1602504">(</span><span class="ident" id="1602505">unsafe</span><span class="op" id="1602511">.</span><span class="ident" id="1602512">Pointer</span><span class="op" id="1602519">(</span><span class="op" id="1602520">&amp;</span><span class="ident" id="1602521">enoptrdata</span><span class="op" id="1602531">)</span><span class="op" id="1602532">)</span>&nbsp;<span class="op" id="1602534">||</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1602540">uintptr</span><span class="op" id="1602547">(</span><span class="ident" id="1602548">unsafe</span><span class="op" id="1602554">.</span><span class="ident" id="1602555">Pointer</span><span class="op" id="1602562">(</span><span class="op" id="1602563">&amp;</span><span class="ident" id="1602564">data</span><span class="op" id="1602568">)</span><span class="op" id="1602569">)</span>&nbsp;<span class="op" id="1602571">&lt;=</span>&nbsp;<span class="builtintype" id="1602574">uintptr</span><span class="op" id="1602581">(</span><span class="ident" id="1602582">e</span><span class="op" id="1602583">.</span><span class="ident" id="1602584">data</span><span class="op" id="1602588">)</span>&nbsp;<span class="op" id="1602590">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1602593">uintptr</span><span class="op" id="1602600">(</span><span class="ident" id="1602601">e</span><span class="op" id="1602602">.</span><span class="ident" id="1602603">data</span><span class="op" id="1602607">)</span>&nbsp;<span class="op" id="1602609">&lt;</span>&nbsp;<span class="builtintype" id="1602611">uintptr</span><span class="op" id="1602618">(</span><span class="ident" id="1602619">unsafe</span><span class="op" id="1602625">.</span><span class="ident" id="1602626">Pointer</span><span class="op" id="1602633">(</span><span class="op" id="1602634">&amp;</span><span class="ident" id="1602635">edata</span><span class="op" id="1602640">)</span><span class="op" id="1602641">)</span>&nbsp;<span class="op" id="1602643">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1602649">uintptr</span><span class="op" id="1602656">(</span><span class="ident" id="1602657">unsafe</span><span class="op" id="1602663">.</span><span class="ident" id="1602664">Pointer</span><span class="op" id="1602671">(</span><span class="op" id="1602672">&amp;</span><span class="ident" id="1602673">bss</span><span class="op" id="1602676">)</span><span class="op" id="1602677">)</span>&nbsp;<span class="op" id="1602679">&lt;=</span>&nbsp;<span class="builtintype" id="1602682">uintptr</span><span class="op" id="1602689">(</span><span class="ident" id="1602690">e</span><span class="op" id="1602691">.</span><span class="ident" id="1602692">data</span><span class="op" id="1602696">)</span>&nbsp;<span class="op" id="1602698">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1602701">uintptr</span><span class="op" id="1602708">(</span><span class="ident" id="1602709">e</span><span class="op" id="1602710">.</span><span class="ident" id="1602711">data</span><span class="op" id="1602715">)</span>&nbsp;<span class="op" id="1602717">&lt;</span>&nbsp;<span class="builtintype" id="1602719">uintptr</span><span class="op" id="1602726">(</span><span class="ident" id="1602727">unsafe</span><span class="op" id="1602733">.</span><span class="ident" id="1602734">Pointer</span><span class="op" id="1602741">(</span><span class="op" id="1602742">&amp;</span><span class="ident" id="1602743">ebss</span><span class="op" id="1602747">)</span><span class="op" id="1602748">)</span>&nbsp;<span class="op" id="1602750">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1602756">uintptr</span><span class="op" id="1602763">(</span><span class="ident" id="1602764">unsafe</span><span class="op" id="1602770">.</span><span class="ident" id="1602771">Pointer</span><span class="op" id="1602778">(</span><span class="op" id="1602779">&amp;</span><span class="ident" id="1602780">noptrbss</span><span class="op" id="1602788">)</span><span class="op" id="1602789">)</span>&nbsp;<span class="op" id="1602791">&lt;=</span>&nbsp;<span class="builtintype" id="1602794">uintptr</span><span class="op" id="1602801">(</span><span class="ident" id="1602802">e</span><span class="op" id="1602803">.</span><span class="ident" id="1602804">data</span><span class="op" id="1602808">)</span>&nbsp;<span class="op" id="1602810">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1602813">uintptr</span><span class="op" id="1602820">(</span><span class="ident" id="1602821">e</span><span class="op" id="1602822">.</span><span class="ident" id="1602823">data</span><span class="op" id="1602827">)</span>&nbsp;<span class="op" id="1602829">&lt;</span>&nbsp;<span class="builtintype" id="1602831">uintptr</span><span class="op" id="1602838">(</span><span class="ident" id="1602839">unsafe</span><span class="op" id="1602845">.</span><span class="ident" id="1602846">Pointer</span><span class="op" id="1602853">(</span><span class="op" id="1602854">&amp;</span><span class="ident" id="1602855">enoptrbss</span><span class="op" id="1602864">)</span><span class="op" id="1602865">)</span>&nbsp;<span class="op" id="1602867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602872">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602881">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602885">gothrow</span><span class="op" id="1602892">(</span><span class="string" id="1602893">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;in&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1602947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602954">if</span>&nbsp;<span class="ident" id="1602957">e</span><span class="op" id="1602958">.</span><span class="ident" id="1602959">data</span>&nbsp;<span class="op" id="1602964">!=</span>&nbsp;<span class="ident" id="1602967">base</span>&nbsp;<span class="op" id="1602972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1602976">//&nbsp;As&nbsp;an&nbsp;implementation&nbsp;detail&nbsp;we&nbsp;allow&nbsp;to&nbsp;set&nbsp;finalizers&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1603054">//&nbsp;of&nbsp;an&nbsp;object&nbsp;if&nbsp;it&nbsp;could&nbsp;come&nbsp;from&nbsp;tiny&nbsp;alloc&nbsp;(see&nbsp;mallocgc&nbsp;for&nbsp;details).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603133">if</span>&nbsp;<span class="ident" id="1603136">ot</span><span class="op" id="1603138">.</span><span class="ident" id="1603139">elem</span>&nbsp;<span class="op" id="1603144">==</span>&nbsp;<span class="ident" id="1603147">nil</span>&nbsp;<span class="op" id="1603151">||</span>&nbsp;<span class="ident" id="1603154">ot</span><span class="op" id="1603156">.</span><span class="ident" id="1603157">elem</span><span class="op" id="1603161">.</span><span class="ident" id="1603162">kind</span><span class="op" id="1603166">&amp;</span><span class="ident" id="1603167">kindNoPointers</span>&nbsp;<span class="op" id="1603182">==</span>&nbsp;<span class="num" id="1603185">0</span>&nbsp;<span class="op" id="1603187">||</span>&nbsp;<span class="ident" id="1603190">ot</span><span class="op" id="1603192">.</span><span class="ident" id="1603193">elem</span><span class="op" id="1603197">.</span><span class="ident" id="1603198">size</span>&nbsp;<span class="op" id="1603203">&gt;=</span>&nbsp;<span class="ident" id="1603206">maxTinySize</span>&nbsp;<span class="op" id="1603218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603223">gothrow</span><span class="op" id="1603230">(</span><span class="string" id="1603231">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;at&nbsp;beginning&nbsp;of&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1603298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1603302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1603305">}</span><br>
<span class="lineno">590</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603309">f</span>&nbsp;<span class="op" id="1603311">:=</span>&nbsp;<span class="op" id="1603314">(</span><span class="op" id="1603315">*</span><span class="ident" id="1603316">eface</span><span class="op" id="1603321">)</span><span class="op" id="1603322">(</span><span class="ident" id="1603323">unsafe</span><span class="op" id="1603329">.</span><span class="ident" id="1603330">Pointer</span><span class="op" id="1603337">(</span><span class="op" id="1603338">&amp;</span><span class="ident" id="1603339">finalizer</span><span class="op" id="1603348">)</span><span class="op" id="1603349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603352">ftyp</span>&nbsp;<span class="op" id="1603357">:=</span>&nbsp;<span class="ident" id="1603360">f</span><span class="op" id="1603361">.</span><span class="ident" id="1603362">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603369">if</span>&nbsp;<span class="ident" id="1603372">ftyp</span>&nbsp;<span class="op" id="1603377">==</span>&nbsp;<span class="ident" id="1603380">nil</span>&nbsp;<span class="op" id="1603384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1603388">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;and&nbsp;remove&nbsp;finalizer</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603432">mp</span>&nbsp;<span class="op" id="1603435">:=</span>&nbsp;<span class="ident" id="1603438">acquirem</span><span class="op" id="1603446">(</span><span class="op" id="1603447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603451">mp</span><span class="op" id="1603453">.</span><span class="ident" id="1603454">ptrarg</span><span class="op" id="1603460">[</span><span class="num" id="1603461">0</span><span class="op" id="1603462">]</span>&nbsp;<span class="op" id="1603464">=</span>&nbsp;<span class="ident" id="1603466">e</span><span class="op" id="1603467">.</span><span class="ident" id="1603468">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603475">onM</span><span class="op" id="1603478">(</span><span class="ident" id="1603479">removeFinalizer_m</span><span class="op" id="1603496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603500">releasem</span><span class="op" id="1603508">(</span><span class="ident" id="1603509">mp</span><span class="op" id="1603511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603515">return</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1603523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603527">if</span>&nbsp;<span class="ident" id="1603530">ftyp</span><span class="op" id="1603534">.</span><span class="ident" id="1603535">kind</span><span class="op" id="1603539">&amp;</span><span class="ident" id="1603540">kindMask</span>&nbsp;<span class="op" id="1603549">!=</span>&nbsp;<span class="ident" id="1603552">kindFunc</span>&nbsp;<span class="op" id="1603561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603565">gothrow</span><span class="op" id="1603572">(</span><span class="string" id="1603573">&#34;runtime.SetFinalizer:&nbsp;second&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1603617">+</span>&nbsp;<span class="op" id="1603619">*</span><span class="ident" id="1603620">ftyp</span><span class="op" id="1603624">.</span><span class="ident" id="1603625">_string</span>&nbsp;<span class="op" id="1603633">+</span>&nbsp;<span class="string" id="1603635">&#34;,&nbsp;not&nbsp;a&nbsp;function&#34;</span><span class="op" id="1603653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1603656">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603659">ft</span>&nbsp;<span class="op" id="1603662">:=</span>&nbsp;<span class="op" id="1603665">(</span><span class="op" id="1603666">*</span><span class="ident" id="1603667">functype</span><span class="op" id="1603675">)</span><span class="op" id="1603676">(</span><span class="ident" id="1603677">unsafe</span><span class="op" id="1603683">.</span><span class="ident" id="1603684">Pointer</span><span class="op" id="1603691">(</span><span class="ident" id="1603692">ftyp</span><span class="op" id="1603696">)</span><span class="op" id="1603697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603700">ins</span>&nbsp;<span class="op" id="1603704">:=</span>&nbsp;<span class="op" id="1603707">*</span><span class="op" id="1603708">(</span><span class="op" id="1603709">*</span><span class="op" id="1603710">[</span><span class="op" id="1603711">]</span><span class="op" id="1603712">*</span><span class="ident" id="1603713">_type</span><span class="op" id="1603718">)</span><span class="op" id="1603719">(</span><span class="ident" id="1603720">unsafe</span><span class="op" id="1603726">.</span><span class="ident" id="1603727">Pointer</span><span class="op" id="1603734">(</span><span class="op" id="1603735">&amp;</span><span class="ident" id="1603736">ft</span><span class="op" id="1603738">.</span><span class="ident" id="1603739">in</span><span class="op" id="1603741">)</span><span class="op" id="1603742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603745">if</span>&nbsp;<span class="ident" id="1603748">ft</span><span class="op" id="1603750">.</span><span class="ident" id="1603751">dotdotdot</span>&nbsp;<span class="op" id="1603761">||</span>&nbsp;<span class="builtinfunc" id="1603764">len</span><span class="op" id="1603767">(</span><span class="ident" id="1603768">ins</span><span class="op" id="1603771">)</span>&nbsp;<span class="op" id="1603773">!=</span>&nbsp;<span class="num" id="1603776">1</span>&nbsp;<span class="op" id="1603778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603782">gothrow</span><span class="op" id="1603789">(</span><span class="string" id="1603790">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1603827">+</span>&nbsp;<span class="op" id="1603829">*</span><span class="ident" id="1603830">etyp</span><span class="op" id="1603834">.</span><span class="ident" id="1603835">_string</span>&nbsp;<span class="op" id="1603843">+</span>&nbsp;<span class="string" id="1603845">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1603862">+</span>&nbsp;<span class="op" id="1603864">*</span><span class="ident" id="1603865">ftyp</span><span class="op" id="1603869">.</span><span class="ident" id="1603870">_string</span><span class="op" id="1603877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1603880">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603883">fint</span>&nbsp;<span class="op" id="1603888">:=</span>&nbsp;<span class="ident" id="1603891">ins</span><span class="op" id="1603894">[</span><span class="num" id="1603895">0</span><span class="op" id="1603896">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603899">switch</span>&nbsp;<span class="op" id="1603906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603909">case</span>&nbsp;<span class="ident" id="1603914">fint</span>&nbsp;<span class="op" id="1603919">==</span>&nbsp;<span class="ident" id="1603922">etyp</span><span class="op" id="1603926">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1603930">//&nbsp;ok&nbsp;-&nbsp;same&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603950">goto</span>&nbsp;<span class="ident" id="1603955">okarg</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603962">case</span>&nbsp;<span class="ident" id="1603967">fint</span><span class="op" id="1603971">.</span><span class="ident" id="1603972">kind</span><span class="op" id="1603976">&amp;</span><span class="ident" id="1603977">kindMask</span>&nbsp;<span class="op" id="1603986">==</span>&nbsp;<span class="ident" id="1603989">kindPtr</span><span class="op" id="1603996">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604000">if</span>&nbsp;<span class="op" id="1604003">(</span><span class="ident" id="1604004">fint</span><span class="op" id="1604008">.</span><span class="ident" id="1604009">x</span>&nbsp;<span class="op" id="1604011">==</span>&nbsp;<span class="ident" id="1604014">nil</span>&nbsp;<span class="op" id="1604018">||</span>&nbsp;<span class="ident" id="1604021">fint</span><span class="op" id="1604025">.</span><span class="ident" id="1604026">x</span><span class="op" id="1604027">.</span><span class="ident" id="1604028">name</span>&nbsp;<span class="op" id="1604033">==</span>&nbsp;<span class="ident" id="1604036">nil</span>&nbsp;<span class="op" id="1604040">||</span>&nbsp;<span class="ident" id="1604043">etyp</span><span class="op" id="1604047">.</span><span class="ident" id="1604048">x</span>&nbsp;<span class="op" id="1604050">==</span>&nbsp;<span class="ident" id="1604053">nil</span>&nbsp;<span class="op" id="1604057">||</span>&nbsp;<span class="ident" id="1604060">etyp</span><span class="op" id="1604064">.</span><span class="ident" id="1604065">x</span><span class="op" id="1604066">.</span><span class="ident" id="1604067">name</span>&nbsp;<span class="op" id="1604072">==</span>&nbsp;<span class="ident" id="1604075">nil</span><span class="op" id="1604078">)</span>&nbsp;<span class="op" id="1604080">&amp;&amp;</span>&nbsp;<span class="op" id="1604083">(</span><span class="op" id="1604084">*</span><span class="ident" id="1604085">ptrtype</span><span class="op" id="1604092">)</span><span class="op" id="1604093">(</span><span class="ident" id="1604094">unsafe</span><span class="op" id="1604100">.</span><span class="ident" id="1604101">Pointer</span><span class="op" id="1604108">(</span><span class="ident" id="1604109">fint</span><span class="op" id="1604113">)</span><span class="op" id="1604114">)</span><span class="op" id="1604115">.</span><span class="ident" id="1604116">elem</span>&nbsp;<span class="op" id="1604121">==</span>&nbsp;<span class="ident" id="1604124">ot</span><span class="op" id="1604126">.</span><span class="ident" id="1604127">elem</span>&nbsp;<span class="op" id="1604132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1604137">//&nbsp;ok&nbsp;-&nbsp;not&nbsp;same&nbsp;type,&nbsp;but&nbsp;both&nbsp;pointers,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1604182">//&nbsp;one&nbsp;or&nbsp;the&nbsp;other&nbsp;is&nbsp;unnamed,&nbsp;and&nbsp;same&nbsp;element&nbsp;type,&nbsp;so&nbsp;assignable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604255">goto</span>&nbsp;<span class="ident" id="1604260">okarg</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1604268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604271">case</span>&nbsp;<span class="ident" id="1604276">fint</span><span class="op" id="1604280">.</span><span class="ident" id="1604281">kind</span><span class="op" id="1604285">&amp;</span><span class="ident" id="1604286">kindMask</span>&nbsp;<span class="op" id="1604295">==</span>&nbsp;<span class="ident" id="1604298">kindInterface</span><span class="op" id="1604311">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604315">ityp</span>&nbsp;<span class="op" id="1604320">:=</span>&nbsp;<span class="op" id="1604323">(</span><span class="op" id="1604324">*</span><span class="ident" id="1604325">interfacetype</span><span class="op" id="1604338">)</span><span class="op" id="1604339">(</span><span class="ident" id="1604340">unsafe</span><span class="op" id="1604346">.</span><span class="ident" id="1604347">Pointer</span><span class="op" id="1604354">(</span><span class="ident" id="1604355">fint</span><span class="op" id="1604359">)</span><span class="op" id="1604360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604364">if</span>&nbsp;<span class="builtinfunc" id="1604367">len</span><span class="op" id="1604370">(</span><span class="ident" id="1604371">ityp</span><span class="op" id="1604375">.</span><span class="ident" id="1604376">mhdr</span><span class="op" id="1604380">)</span>&nbsp;<span class="op" id="1604382">==</span>&nbsp;<span class="num" id="1604385">0</span>&nbsp;<span class="op" id="1604387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1604392">//&nbsp;ok&nbsp;-&nbsp;satisfies&nbsp;empty&nbsp;interface</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604429">goto</span>&nbsp;<span class="ident" id="1604434">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1604442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604446">if</span>&nbsp;<span class="ident" id="1604449">_</span><span class="op" id="1604450">,</span>&nbsp;<span class="ident" id="1604452">ok</span>&nbsp;<span class="op" id="1604455">:=</span>&nbsp;<span class="ident" id="1604458">assertE2I2</span><span class="op" id="1604468">(</span><span class="ident" id="1604469">ityp</span><span class="op" id="1604473">,</span>&nbsp;<span class="ident" id="1604475">obj</span><span class="op" id="1604478">)</span><span class="op" id="1604479">;</span>&nbsp;<span class="ident" id="1604481">ok</span>&nbsp;<span class="op" id="1604484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604489">goto</span>&nbsp;<span class="ident" id="1604494">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1604502">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1604505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604508">gothrow</span><span class="op" id="1604515">(</span><span class="string" id="1604516">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1604553">+</span>&nbsp;<span class="op" id="1604555">*</span><span class="ident" id="1604556">etyp</span><span class="op" id="1604560">.</span><span class="ident" id="1604561">_string</span>&nbsp;<span class="op" id="1604569">+</span>&nbsp;<span class="string" id="1604571">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1604588">+</span>&nbsp;<span class="op" id="1604590">*</span><span class="ident" id="1604591">ftyp</span><span class="op" id="1604595">.</span><span class="ident" id="1604596">_string</span><span class="op" id="1604603">)</span><br>
<span class="lineno"></span><span class="ident" id="1604605">okarg</span><span class="op" id="1604610">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1604613">//&nbsp;compute&nbsp;size&nbsp;needed&nbsp;for&nbsp;return&nbsp;parameters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604659">nret</span>&nbsp;<span class="op" id="1604664">:=</span>&nbsp;<span class="builtintype" id="1604667">uintptr</span><span class="op" id="1604674">(</span><span class="num" id="1604675">0</span><span class="op" id="1604676">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604679">for</span>&nbsp;<span class="ident" id="1604683">_</span><span class="op" id="1604684">,</span>&nbsp;<span class="ident" id="1604686">t</span>&nbsp;<span class="op" id="1604688">:=</span>&nbsp;<span class="keyword" id="1604691">range</span>&nbsp;<span class="op" id="1604697">*</span><span class="op" id="1604698">(</span><span class="op" id="1604699">*</span><span class="op" id="1604700">[</span><span class="op" id="1604701">]</span><span class="op" id="1604702">*</span><span class="ident" id="1604703">_type</span><span class="op" id="1604708">)</span><span class="op" id="1604709">(</span><span class="ident" id="1604710">unsafe</span><span class="op" id="1604716">.</span><span class="ident" id="1604717">Pointer</span><span class="op" id="1604724">(</span><span class="op" id="1604725">&amp;</span><span class="ident" id="1604726">ft</span><span class="op" id="1604728">.</span><span class="ident" id="1604729">out</span><span class="op" id="1604732">)</span><span class="op" id="1604733">)</span>&nbsp;<span class="op" id="1604735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604739">nret</span>&nbsp;<span class="op" id="1604744">=</span>&nbsp;<span class="ident" id="1604746">round</span><span class="op" id="1604751">(</span><span class="ident" id="1604752">nret</span><span class="op" id="1604756">,</span>&nbsp;<span class="builtintype" id="1604758">uintptr</span><span class="op" id="1604765">(</span><span class="ident" id="1604766">t</span><span class="op" id="1604767">.</span><span class="ident" id="1604768">align</span><span class="op" id="1604773">)</span><span class="op" id="1604774">)</span>&nbsp;<span class="op" id="1604776">+</span>&nbsp;<span class="builtintype" id="1604778">uintptr</span><span class="op" id="1604785">(</span><span class="ident" id="1604786">t</span><span class="op" id="1604787">.</span><span class="ident" id="1604788">size</span><span class="op" id="1604792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1604795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604798">nret</span>&nbsp;<span class="op" id="1604803">=</span>&nbsp;<span class="ident" id="1604805">round</span><span class="op" id="1604810">(</span><span class="ident" id="1604811">nret</span><span class="op" id="1604815">,</span>&nbsp;<span class="ident" id="1604817">ptrSize</span><span class="op" id="1604824">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1604828">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;have&nbsp;a&nbsp;finalizer&nbsp;goroutine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604872">createfing</span><span class="op" id="1604882">(</span><span class="op" id="1604883">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1604887">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;to&nbsp;add&nbsp;finalizer&nbsp;record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604933">mp</span>&nbsp;<span class="op" id="1604936">:=</span>&nbsp;<span class="ident" id="1604939">acquirem</span><span class="op" id="1604947">(</span><span class="op" id="1604948">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604951">mp</span><span class="op" id="1604953">.</span><span class="ident" id="1604954">ptrarg</span><span class="op" id="1604960">[</span><span class="num" id="1604961">0</span><span class="op" id="1604962">]</span>&nbsp;<span class="op" id="1604964">=</span>&nbsp;<span class="ident" id="1604966">f</span><span class="op" id="1604967">.</span><span class="ident" id="1604968">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604974">mp</span><span class="op" id="1604976">.</span><span class="ident" id="1604977">ptrarg</span><span class="op" id="1604983">[</span><span class="num" id="1604984">1</span><span class="op" id="1604985">]</span>&nbsp;<span class="op" id="1604987">=</span>&nbsp;<span class="ident" id="1604989">e</span><span class="op" id="1604990">.</span><span class="ident" id="1604991">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604997">mp</span><span class="op" id="1604999">.</span><span class="ident" id="1605000">scalararg</span><span class="op" id="1605009">[</span><span class="num" id="1605010">0</span><span class="op" id="1605011">]</span>&nbsp;<span class="op" id="1605013">=</span>&nbsp;<span class="ident" id="1605015">nret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605021">mp</span><span class="op" id="1605023">.</span><span class="ident" id="1605024">ptrarg</span><span class="op" id="1605030">[</span><span class="num" id="1605031">2</span><span class="op" id="1605032">]</span>&nbsp;<span class="op" id="1605034">=</span>&nbsp;<span class="ident" id="1605036">unsafe</span><span class="op" id="1605042">.</span><span class="ident" id="1605043">Pointer</span><span class="op" id="1605050">(</span><span class="ident" id="1605051">fint</span><span class="op" id="1605055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605058">mp</span><span class="op" id="1605060">.</span><span class="ident" id="1605061">ptrarg</span><span class="op" id="1605067">[</span><span class="num" id="1605068">3</span><span class="op" id="1605069">]</span>&nbsp;<span class="op" id="1605071">=</span>&nbsp;<span class="ident" id="1605073">unsafe</span><span class="op" id="1605079">.</span><span class="ident" id="1605080">Pointer</span><span class="op" id="1605087">(</span><span class="ident" id="1605088">ot</span><span class="op" id="1605090">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605093">onM</span><span class="op" id="1605096">(</span><span class="ident" id="1605097">setFinalizer_m</span><span class="op" id="1605111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1605114">if</span>&nbsp;<span class="ident" id="1605117">mp</span><span class="op" id="1605119">.</span><span class="ident" id="1605120">scalararg</span><span class="op" id="1605129">[</span><span class="num" id="1605130">0</span><span class="op" id="1605131">]</span>&nbsp;<span class="op" id="1605133">!=</span>&nbsp;<span class="num" id="1605136">1</span>&nbsp;<span class="op" id="1605138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605142">gothrow</span><span class="op" id="1605149">(</span><span class="string" id="1605150">&#34;runtime.SetFinalizer:&nbsp;finalizer&nbsp;already&nbsp;set&#34;</span><span class="op" id="1605195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1605198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605201">releasem</span><span class="op" id="1605209">(</span><span class="ident" id="1605210">mp</span><span class="op" id="1605212">)</span><br>
<span class="lineno">655</span><span class="op" id="1605214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1605217">//&nbsp;round&nbsp;n&nbsp;up&nbsp;to&nbsp;a&nbsp;multiple&nbsp;of&nbsp;a.&nbsp;&nbsp;a&nbsp;must&nbsp;be&nbsp;a&nbsp;power&nbsp;of&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="1605276">func</span>&nbsp;<span class="ident" id="1605281">round</span><span class="op" id="1605286">(</span><span class="ident" id="1605287">n</span><span class="op" id="1605288">,</span>&nbsp;<span class="ident" id="1605290">a</span>&nbsp;<span class="builtintype" id="1605292">uintptr</span><span class="op" id="1605299">)</span>&nbsp;<span class="builtintype" id="1605301">uintptr</span>&nbsp;<span class="op" id="1605309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1605312">return</span>&nbsp;<span class="op" id="1605319">(</span><span class="ident" id="1605320">n</span>&nbsp;<span class="op" id="1605322">+</span>&nbsp;<span class="ident" id="1605324">a</span>&nbsp;<span class="op" id="1605326">-</span>&nbsp;<span class="num" id="1605328">1</span><span class="op" id="1605329">)</span>&nbsp;<span class="op" id="1605331">&amp;^</span>&nbsp;<span class="op" id="1605334">(</span><span class="ident" id="1605335">a</span>&nbsp;<span class="op" id="1605337">-</span>&nbsp;<span class="num" id="1605339">1</span><span class="op" id="1605340">)</span><br>
<span class="lineno">660</span><span class="op" id="1605342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1605345">//&nbsp;Look&nbsp;up&nbsp;pointer&nbsp;v&nbsp;in&nbsp;heap.&nbsp;&nbsp;Return&nbsp;the&nbsp;span&nbsp;containing&nbsp;the&nbsp;object,</span><br>
<span class="lineno"></span><span class="comment" id="1605415">//&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;object,&nbsp;and&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;If&nbsp;the&nbsp;object</span><br>
<span class="lineno"></span><span class="comment" id="1605486">//&nbsp;does&nbsp;not&nbsp;exist,&nbsp;return&nbsp;nil,&nbsp;nil,&nbsp;0.</span><br>
<span class="lineno">665</span><span class="keyword" id="1605525">func</span>&nbsp;<span class="ident" id="1605530">findObject</span><span class="op" id="1605540">(</span><span class="ident" id="1605541">v</span>&nbsp;<span class="ident" id="1605543">unsafe</span><span class="op" id="1605549">.</span><span class="ident" id="1605550">Pointer</span><span class="op" id="1605557">)</span>&nbsp;<span class="op" id="1605559">(</span><span class="ident" id="1605560">s</span>&nbsp;<span class="op" id="1605562">*</span><span class="ident" id="1605563">mspan</span><span class="op" id="1605568">,</span>&nbsp;<span class="ident" id="1605570">x</span>&nbsp;<span class="ident" id="1605572">unsafe</span><span class="op" id="1605578">.</span><span class="ident" id="1605579">Pointer</span><span class="op" id="1605586">,</span>&nbsp;<span class="ident" id="1605588">n</span>&nbsp;<span class="builtintype" id="1605590">uintptr</span><span class="op" id="1605597">)</span>&nbsp;<span class="op" id="1605599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605602">c</span>&nbsp;<span class="op" id="1605604">:=</span>&nbsp;<span class="ident" id="1605607">gomcache</span><span class="op" id="1605615">(</span><span class="op" id="1605616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605619">c</span><span class="op" id="1605620">.</span><span class="ident" id="1605621">local_nlookup</span><span class="op" id="1605634">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1605638">if</span>&nbsp;<span class="ident" id="1605641">ptrSize</span>&nbsp;<span class="op" id="1605649">==</span>&nbsp;<span class="num" id="1605652">4</span>&nbsp;<span class="op" id="1605654">&amp;&amp;</span>&nbsp;<span class="ident" id="1605657">c</span><span class="op" id="1605658">.</span><span class="ident" id="1605659">local_nlookup</span>&nbsp;<span class="op" id="1605673">&gt;=</span>&nbsp;<span class="num" id="1605676">1</span><span class="op" id="1605677">&lt;&lt;</span><span class="num" id="1605679">30</span>&nbsp;<span class="op" id="1605682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1605686">//&nbsp;purge&nbsp;cache&nbsp;stats&nbsp;to&nbsp;prevent&nbsp;overflow</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605729">lock</span><span class="op" id="1605733">(</span><span class="op" id="1605734">&amp;</span><span class="ident" id="1605735">mheap_</span><span class="op" id="1605741">.</span><span class="ident" id="1605742">lock</span><span class="op" id="1605746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605750">purgecachedstats</span><span class="op" id="1605766">(</span><span class="ident" id="1605767">c</span><span class="op" id="1605768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605772">unlock</span><span class="op" id="1605778">(</span><span class="op" id="1605779">&amp;</span><span class="ident" id="1605780">mheap_</span><span class="op" id="1605786">.</span><span class="ident" id="1605787">lock</span><span class="op" id="1605791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1605794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1605798">//&nbsp;find&nbsp;span</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605812">arena_start</span>&nbsp;<span class="op" id="1605824">:=</span>&nbsp;<span class="builtintype" id="1605827">uintptr</span><span class="op" id="1605834">(</span><span class="ident" id="1605835">unsafe</span><span class="op" id="1605841">.</span><span class="ident" id="1605842">Pointer</span><span class="op" id="1605849">(</span><span class="ident" id="1605850">mheap_</span><span class="op" id="1605856">.</span><span class="ident" id="1605857">arena_start</span><span class="op" id="1605868">)</span><span class="op" id="1605869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1605872">arena_used</span>&nbsp;<span class="op" id="1605883">:=</span>&nbsp;<span class="builtintype" id="1605886">uintptr</span><span class="op" id="1605893">(</span><span class="ident" id="1605894">unsafe</span><span class="op" id="1605900">.</span><span class="ident" id="1605901">Pointer</span><span class="op" id="1605908">(</span><span class="ident" id="1605909">mheap_</span><span class="op" id="1605915">.</span><span class="ident" id="1605916">arena_used</span><span class="op" id="1605926">)</span><span class="op" id="1605927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1605930">if</span>&nbsp;<span class="builtintype" id="1605933">uintptr</span><span class="op" id="1605940">(</span><span class="ident" id="1605941">v</span><span class="op" id="1605942">)</span>&nbsp;<span class="op" id="1605944">&lt;</span>&nbsp;<span class="ident" id="1605946">arena_start</span>&nbsp;<span class="op" id="1605958">||</span>&nbsp;<span class="builtintype" id="1605961">uintptr</span><span class="op" id="1605968">(</span><span class="ident" id="1605969">v</span><span class="op" id="1605970">)</span>&nbsp;<span class="op" id="1605972">&gt;=</span>&nbsp;<span class="ident" id="1605975">arena_used</span>&nbsp;<span class="op" id="1605986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1605990">return</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1605998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606001">p</span>&nbsp;<span class="op" id="1606003">:=</span>&nbsp;<span class="builtintype" id="1606006">uintptr</span><span class="op" id="1606013">(</span><span class="ident" id="1606014">v</span><span class="op" id="1606015">)</span>&nbsp;<span class="op" id="1606017">&gt;&gt;</span>&nbsp;<span class="ident" id="1606020">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606031">q</span>&nbsp;<span class="op" id="1606033">:=</span>&nbsp;<span class="ident" id="1606036">p</span>&nbsp;<span class="op" id="1606038">-</span>&nbsp;<span class="ident" id="1606040">arena_start</span><span class="op" id="1606051">&gt;&gt;</span><span class="ident" id="1606053">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606064">s</span>&nbsp;<span class="op" id="1606066">=</span>&nbsp;<span class="op" id="1606068">*</span><span class="op" id="1606069">(</span><span class="op" id="1606070">*</span><span class="op" id="1606071">*</span><span class="ident" id="1606072">mspan</span><span class="op" id="1606077">)</span><span class="op" id="1606078">(</span><span class="ident" id="1606079">add</span><span class="op" id="1606082">(</span><span class="ident" id="1606083">unsafe</span><span class="op" id="1606089">.</span><span class="ident" id="1606090">Pointer</span><span class="op" id="1606097">(</span><span class="ident" id="1606098">mheap_</span><span class="op" id="1606104">.</span><span class="ident" id="1606105">spans</span><span class="op" id="1606110">)</span><span class="op" id="1606111">,</span>&nbsp;<span class="ident" id="1606113">q</span><span class="op" id="1606114">*</span><span class="ident" id="1606115">ptrSize</span><span class="op" id="1606122">)</span><span class="op" id="1606123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1606126">if</span>&nbsp;<span class="ident" id="1606129">s</span>&nbsp;<span class="op" id="1606131">==</span>&nbsp;<span class="ident" id="1606134">nil</span>&nbsp;<span class="op" id="1606138">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1606142">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1606150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606153">x</span>&nbsp;<span class="op" id="1606155">=</span>&nbsp;<span class="ident" id="1606157">unsafe</span><span class="op" id="1606163">.</span><span class="ident" id="1606164">Pointer</span><span class="op" id="1606171">(</span><span class="builtintype" id="1606172">uintptr</span><span class="op" id="1606179">(</span><span class="ident" id="1606180">s</span><span class="op" id="1606181">.</span><span class="ident" id="1606182">start</span><span class="op" id="1606187">)</span>&nbsp;<span class="op" id="1606189">&lt;&lt;</span>&nbsp;<span class="ident" id="1606192">pageShift</span><span class="op" id="1606201">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1606205">if</span>&nbsp;<span class="builtintype" id="1606208">uintptr</span><span class="op" id="1606215">(</span><span class="ident" id="1606216">v</span><span class="op" id="1606217">)</span>&nbsp;<span class="op" id="1606219">&lt;</span>&nbsp;<span class="builtintype" id="1606221">uintptr</span><span class="op" id="1606228">(</span><span class="ident" id="1606229">x</span><span class="op" id="1606230">)</span>&nbsp;<span class="op" id="1606232">||</span>&nbsp;<span class="builtintype" id="1606235">uintptr</span><span class="op" id="1606242">(</span><span class="ident" id="1606243">v</span><span class="op" id="1606244">)</span>&nbsp;<span class="op" id="1606246">&gt;=</span>&nbsp;<span class="builtintype" id="1606249">uintptr</span><span class="op" id="1606256">(</span><span class="ident" id="1606257">unsafe</span><span class="op" id="1606263">.</span><span class="ident" id="1606264">Pointer</span><span class="op" id="1606271">(</span><span class="ident" id="1606272">s</span><span class="op" id="1606273">.</span><span class="ident" id="1606274">limit</span><span class="op" id="1606279">)</span><span class="op" id="1606280">)</span>&nbsp;<span class="op" id="1606282">||</span>&nbsp;<span class="ident" id="1606285">s</span><span class="op" id="1606286">.</span><span class="ident" id="1606287">state</span>&nbsp;<span class="op" id="1606293">!=</span>&nbsp;<span class="ident" id="1606296">mSpanInUse</span>&nbsp;<span class="op" id="1606307">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606311">s</span>&nbsp;<span class="op" id="1606313">=</span>&nbsp;<span class="ident" id="1606315">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606321">x</span>&nbsp;<span class="op" id="1606323">=</span>&nbsp;<span class="ident" id="1606325">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1606331">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1606339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606343">n</span>&nbsp;<span class="op" id="1606345">=</span>&nbsp;<span class="builtintype" id="1606347">uintptr</span><span class="op" id="1606354">(</span><span class="ident" id="1606355">s</span><span class="op" id="1606356">.</span><span class="ident" id="1606357">elemsize</span><span class="op" id="1606365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1606368">if</span>&nbsp;<span class="ident" id="1606371">s</span><span class="op" id="1606372">.</span><span class="ident" id="1606373">sizeclass</span>&nbsp;<span class="op" id="1606383">!=</span>&nbsp;<span class="num" id="1606386">0</span>&nbsp;<span class="op" id="1606388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606392">x</span>&nbsp;<span class="op" id="1606394">=</span>&nbsp;<span class="ident" id="1606396">add</span><span class="op" id="1606399">(</span><span class="ident" id="1606400">x</span><span class="op" id="1606401">,</span>&nbsp;<span class="op" id="1606403">(</span><span class="builtintype" id="1606404">uintptr</span><span class="op" id="1606411">(</span><span class="ident" id="1606412">v</span><span class="op" id="1606413">)</span><span class="op" id="1606414">-</span><span class="builtintype" id="1606415">uintptr</span><span class="op" id="1606422">(</span><span class="ident" id="1606423">x</span><span class="op" id="1606424">)</span><span class="op" id="1606425">)</span><span class="op" id="1606426">/</span><span class="ident" id="1606427">n</span><span class="op" id="1606428">*</span><span class="ident" id="1606429">n</span><span class="op" id="1606430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1606433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1606436">return</span><br>
<span class="lineno">700</span><span class="op" id="1606443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1606446">var</span>&nbsp;<span class="ident" id="1606450">fingCreate</span>&nbsp;<span class="builtintype" id="1606461">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1606469">func</span>&nbsp;<span class="ident" id="1606474">createfing</span><span class="op" id="1606484">(</span><span class="op" id="1606485">)</span>&nbsp;<span class="op" id="1606487">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1606490">//&nbsp;start&nbsp;the&nbsp;finalizer&nbsp;goroutine&nbsp;exactly&nbsp;once</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1606537">if</span>&nbsp;<span class="ident" id="1606540">fingCreate</span>&nbsp;<span class="op" id="1606551">==</span>&nbsp;<span class="num" id="1606554">0</span>&nbsp;<span class="op" id="1606556">&amp;&amp;</span>&nbsp;<span class="ident" id="1606559">cas</span><span class="op" id="1606562">(</span><span class="op" id="1606563">&amp;</span><span class="ident" id="1606564">fingCreate</span><span class="op" id="1606574">,</span>&nbsp;<span class="num" id="1606576">0</span><span class="op" id="1606577">,</span>&nbsp;<span class="num" id="1606579">1</span><span class="op" id="1606580">)</span>&nbsp;<span class="op" id="1606582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1606586">go</span>&nbsp;<span class="ident" id="1606589">runfinq</span><span class="op" id="1606596">(</span><span class="op" id="1606597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1606600">}</span><br>
<span class="lineno"></span><span class="op" id="1606602">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="1606605">//&nbsp;This&nbsp;is&nbsp;the&nbsp;goroutine&nbsp;that&nbsp;runs&nbsp;all&nbsp;of&nbsp;the&nbsp;finalizers</span><br>
<span class="lineno"></span><span class="keyword" id="1606662">func</span>&nbsp;<span class="ident" id="1606667">runfinq</span><span class="op" id="1606674">(</span><span class="op" id="1606675">)</span>&nbsp;<span class="op" id="1606677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1606680">var</span>&nbsp;<span class="op" id="1606684">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606688">frame</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606697">unsafe</span><span class="op" id="1606703">.</span><span class="ident" id="1606704">Pointer</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606714">framecap</span>&nbsp;<span class="builtintype" id="1606723">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1606732">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1606736">for</span>&nbsp;<span class="op" id="1606740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606744">lock</span><span class="op" id="1606748">(</span><span class="op" id="1606749">&amp;</span><span class="ident" id="1606750">finlock</span><span class="op" id="1606757">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606761">fb</span>&nbsp;<span class="op" id="1606764">:=</span>&nbsp;<span class="ident" id="1606767">finq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606774">finq</span>&nbsp;<span class="op" id="1606779">=</span>&nbsp;<span class="ident" id="1606781">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1606787">if</span>&nbsp;<span class="ident" id="1606790">fb</span>&nbsp;<span class="op" id="1606793">==</span>&nbsp;<span class="ident" id="1606796">nil</span>&nbsp;<span class="op" id="1606800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606805">gp</span>&nbsp;<span class="op" id="1606808">:=</span>&nbsp;<span class="ident" id="1606811">getg</span><span class="op" id="1606815">(</span><span class="op" id="1606816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606821">fing</span>&nbsp;<span class="op" id="1606826">=</span>&nbsp;<span class="ident" id="1606828">gp</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606834">fingwait</span>&nbsp;<span class="op" id="1606843">=</span>&nbsp;<span class="builtintype" id="1606845">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606853">gp</span><span class="op" id="1606855">.</span><span class="ident" id="1606856">issystem</span>&nbsp;<span class="op" id="1606865">=</span>&nbsp;<span class="builtintype" id="1606867">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606875">goparkunlock</span><span class="op" id="1606887">(</span><span class="op" id="1606888">&amp;</span><span class="ident" id="1606889">finlock</span><span class="op" id="1606896">,</span>&nbsp;<span class="string" id="1606898">&#34;finalizer&nbsp;wait&#34;</span><span class="op" id="1606914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606919">gp</span><span class="op" id="1606921">.</span><span class="ident" id="1606922">issystem</span>&nbsp;<span class="op" id="1606931">=</span>&nbsp;<span class="builtintype" id="1606933">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1606942">continue</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1606953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606957">unlock</span><span class="op" id="1606963">(</span><span class="op" id="1606964">&amp;</span><span class="ident" id="1606965">finlock</span><span class="op" id="1606972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1606976">if</span>&nbsp;<span class="ident" id="1606979">raceenabled</span>&nbsp;<span class="op" id="1606991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1606996">racefingo</span><span class="op" id="1607005">(</span><span class="op" id="1607006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1607010">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1607014">for</span>&nbsp;<span class="ident" id="1607018">fb</span>&nbsp;<span class="op" id="1607021">!=</span>&nbsp;<span class="ident" id="1607024">nil</span>&nbsp;<span class="op" id="1607028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1607033">for</span>&nbsp;<span class="ident" id="1607037">i</span>&nbsp;<span class="op" id="1607039">:=</span>&nbsp;<span class="builtintype" id="1607042">int32</span><span class="op" id="1607047">(</span><span class="num" id="1607048">0</span><span class="op" id="1607049">)</span><span class="op" id="1607050">;</span>&nbsp;<span class="ident" id="1607052">i</span>&nbsp;<span class="op" id="1607054">&lt;</span>&nbsp;<span class="ident" id="1607056">fb</span><span class="op" id="1607058">.</span><span class="ident" id="1607059">cnt</span><span class="op" id="1607062">;</span>&nbsp;<span class="ident" id="1607064">i</span><span class="op" id="1607065">++</span>&nbsp;<span class="op" id="1607068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607074">f</span>&nbsp;<span class="op" id="1607076">:=</span>&nbsp;<span class="op" id="1607079">(</span><span class="op" id="1607080">*</span><span class="ident" id="1607081">finalizer</span><span class="op" id="1607090">)</span><span class="op" id="1607091">(</span><span class="ident" id="1607092">add</span><span class="op" id="1607095">(</span><span class="ident" id="1607096">unsafe</span><span class="op" id="1607102">.</span><span class="ident" id="1607103">Pointer</span><span class="op" id="1607110">(</span><span class="op" id="1607111">&amp;</span><span class="ident" id="1607112">fb</span><span class="op" id="1607114">.</span><span class="ident" id="1607115">fin</span><span class="op" id="1607118">)</span><span class="op" id="1607119">,</span>&nbsp;<span class="builtintype" id="1607121">uintptr</span><span class="op" id="1607128">(</span><span class="ident" id="1607129">i</span><span class="op" id="1607130">)</span><span class="op" id="1607131">*</span><span class="ident" id="1607132">unsafe</span><span class="op" id="1607138">.</span><span class="ident" id="1607139">Sizeof</span><span class="op" id="1607145">(</span><span class="ident" id="1607146">finalizer</span><span class="op" id="1607155">{</span><span class="op" id="1607156">}</span><span class="op" id="1607157">)</span><span class="op" id="1607158">)</span><span class="op" id="1607159">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607166">framesz</span>&nbsp;<span class="op" id="1607174">:=</span>&nbsp;<span class="ident" id="1607177">unsafe</span><span class="op" id="1607183">.</span><span class="ident" id="1607184">Sizeof</span><span class="op" id="1607190">(</span><span class="op" id="1607191">(</span><span class="keyword" id="1607192">interface</span><span class="op" id="1607201">{</span><span class="op" id="1607202">}</span><span class="op" id="1607203">)</span><span class="op" id="1607204">(</span><span class="ident" id="1607205">nil</span><span class="op" id="1607208">)</span><span class="op" id="1607209">)</span>&nbsp;<span class="op" id="1607211">+</span>&nbsp;<span class="builtintype" id="1607213">uintptr</span><span class="op" id="1607220">(</span><span class="ident" id="1607221">f</span><span class="op" id="1607222">.</span><span class="ident" id="1607223">nret</span><span class="op" id="1607227">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1607233">if</span>&nbsp;<span class="ident" id="1607236">framecap</span>&nbsp;<span class="op" id="1607245">&lt;</span>&nbsp;<span class="ident" id="1607247">framesz</span>&nbsp;<span class="op" id="1607255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1607262">//&nbsp;The&nbsp;frame&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1607326">//&nbsp;all&nbsp;not&nbsp;yet&nbsp;finalized&nbsp;objects&nbsp;are&nbsp;stored&nbsp;in&nbsp;finq.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1607384">//&nbsp;If&nbsp;we&nbsp;do&nbsp;not&nbsp;mark&nbsp;it&nbsp;as&nbsp;FlagNoScan,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1607428">//&nbsp;the&nbsp;last&nbsp;finalized&nbsp;object&nbsp;is&nbsp;not&nbsp;collected.</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607480">frame</span>&nbsp;<span class="op" id="1607486">=</span>&nbsp;<span class="ident" id="1607488">mallocgc</span><span class="op" id="1607496">(</span><span class="ident" id="1607497">framesz</span><span class="op" id="1607504">,</span>&nbsp;<span class="ident" id="1607506">nil</span><span class="op" id="1607509">,</span>&nbsp;<span class="ident" id="1607511">flagNoScan</span><span class="op" id="1607521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607528">framecap</span>&nbsp;<span class="op" id="1607537">=</span>&nbsp;<span class="ident" id="1607539">framesz</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1607551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1607558">if</span>&nbsp;<span class="ident" id="1607561">f</span><span class="op" id="1607562">.</span><span class="ident" id="1607563">fint</span>&nbsp;<span class="op" id="1607568">==</span>&nbsp;<span class="ident" id="1607571">nil</span>&nbsp;<span class="op" id="1607575">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607582">gothrow</span><span class="op" id="1607589">(</span><span class="string" id="1607590">&#34;missing&nbsp;type&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1607615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1607621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1607627">switch</span>&nbsp;<span class="ident" id="1607634">f</span><span class="op" id="1607635">.</span><span class="ident" id="1607636">fint</span><span class="op" id="1607640">.</span><span class="ident" id="1607641">kind</span>&nbsp;<span class="op" id="1607646">&amp;</span>&nbsp;<span class="ident" id="1607648">kindMask</span>&nbsp;<span class="op" id="1607657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1607663">case</span>&nbsp;<span class="ident" id="1607668">kindPtr</span><span class="op" id="1607675">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1607682">//&nbsp;direct&nbsp;use&nbsp;of&nbsp;pointer</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1607712">*</span><span class="op" id="1607713">(</span><span class="op" id="1607714">*</span><span class="ident" id="1607715">unsafe</span><span class="op" id="1607721">.</span><span class="ident" id="1607722">Pointer</span><span class="op" id="1607729">)</span><span class="op" id="1607730">(</span><span class="ident" id="1607731">frame</span><span class="op" id="1607736">)</span>&nbsp;<span class="op" id="1607738">=</span>&nbsp;<span class="ident" id="1607740">f</span><span class="op" id="1607741">.</span><span class="ident" id="1607742">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1607750">case</span>&nbsp;<span class="ident" id="1607755">kindInterface</span><span class="op" id="1607768">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607775">ityp</span>&nbsp;<span class="op" id="1607780">:=</span>&nbsp;<span class="op" id="1607783">(</span><span class="op" id="1607784">*</span><span class="ident" id="1607785">interfacetype</span><span class="op" id="1607798">)</span><span class="op" id="1607799">(</span><span class="ident" id="1607800">unsafe</span><span class="op" id="1607806">.</span><span class="ident" id="1607807">Pointer</span><span class="op" id="1607814">(</span><span class="ident" id="1607815">f</span><span class="op" id="1607816">.</span><span class="ident" id="1607817">fint</span><span class="op" id="1607821">)</span><span class="op" id="1607822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1607829">//&nbsp;set&nbsp;up&nbsp;with&nbsp;empty&nbsp;interface</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1607865">(</span><span class="op" id="1607866">*</span><span class="ident" id="1607867">eface</span><span class="op" id="1607872">)</span><span class="op" id="1607873">(</span><span class="ident" id="1607874">frame</span><span class="op" id="1607879">)</span><span class="op" id="1607880">.</span><span class="ident" id="1607881">_type</span>&nbsp;<span class="op" id="1607887">=</span>&nbsp;<span class="op" id="1607889">&amp;</span><span class="ident" id="1607890">f</span><span class="op" id="1607891">.</span><span class="ident" id="1607892">ot</span><span class="op" id="1607894">.</span><span class="ident" id="1607895">typ</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1607904">(</span><span class="op" id="1607905">*</span><span class="ident" id="1607906">eface</span><span class="op" id="1607911">)</span><span class="op" id="1607912">(</span><span class="ident" id="1607913">frame</span><span class="op" id="1607918">)</span><span class="op" id="1607919">.</span><span class="ident" id="1607920">data</span>&nbsp;<span class="op" id="1607925">=</span>&nbsp;<span class="ident" id="1607927">f</span><span class="op" id="1607928">.</span><span class="ident" id="1607929">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1607938">if</span>&nbsp;<span class="builtinfunc" id="1607941">len</span><span class="op" id="1607944">(</span><span class="ident" id="1607945">ityp</span><span class="op" id="1607949">.</span><span class="ident" id="1607950">mhdr</span><span class="op" id="1607954">)</span>&nbsp;<span class="op" id="1607956">!=</span>&nbsp;<span class="num" id="1607959">0</span>&nbsp;<span class="op" id="1607961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1607969">//&nbsp;convert&nbsp;to&nbsp;interface&nbsp;with&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608012">//&nbsp;this&nbsp;conversion&nbsp;is&nbsp;guaranteed&nbsp;to&nbsp;succeed&nbsp;-&nbsp;we&nbsp;checked&nbsp;in&nbsp;SetFinalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1608091">*</span><span class="op" id="1608092">(</span><span class="op" id="1608093">*</span><span class="ident" id="1608094">fInterface</span><span class="op" id="1608104">)</span><span class="op" id="1608105">(</span><span class="ident" id="1608106">frame</span><span class="op" id="1608111">)</span>&nbsp;<span class="op" id="1608113">=</span>&nbsp;<span class="ident" id="1608115">assertE2I</span><span class="op" id="1608124">(</span><span class="ident" id="1608125">ityp</span><span class="op" id="1608129">,</span>&nbsp;<span class="op" id="1608131">*</span><span class="op" id="1608132">(</span><span class="op" id="1608133">*</span><span class="keyword" id="1608134">interface</span><span class="op" id="1608143">{</span><span class="op" id="1608144">}</span><span class="op" id="1608145">)</span><span class="op" id="1608146">(</span><span class="ident" id="1608147">frame</span><span class="op" id="1608152">)</span><span class="op" id="1608153">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1608160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1608166">default</span><span class="op" id="1608173">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608180">gothrow</span><span class="op" id="1608187">(</span><span class="string" id="1608188">&#34;bad&nbsp;kind&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1608209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1608215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608221">reflectcall</span><span class="op" id="1608232">(</span><span class="ident" id="1608233">unsafe</span><span class="op" id="1608239">.</span><span class="ident" id="1608240">Pointer</span><span class="op" id="1608247">(</span><span class="ident" id="1608248">f</span><span class="op" id="1608249">.</span><span class="ident" id="1608250">fn</span><span class="op" id="1608252">)</span><span class="op" id="1608253">,</span>&nbsp;<span class="ident" id="1608255">frame</span><span class="op" id="1608260">,</span>&nbsp;<span class="builtintype" id="1608262">uint32</span><span class="op" id="1608268">(</span><span class="ident" id="1608269">framesz</span><span class="op" id="1608276">)</span><span class="op" id="1608277">,</span>&nbsp;<span class="builtintype" id="1608279">uint32</span><span class="op" id="1608285">(</span><span class="ident" id="1608286">framesz</span><span class="op" id="1608293">)</span><span class="op" id="1608294">)</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608301">//&nbsp;drop&nbsp;finalizer&nbsp;queue&nbsp;references&nbsp;to&nbsp;finalized&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608360">f</span><span class="op" id="1608361">.</span><span class="ident" id="1608362">fn</span>&nbsp;<span class="op" id="1608365">=</span>&nbsp;<span class="ident" id="1608367">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608375">f</span><span class="op" id="1608376">.</span><span class="ident" id="1608377">arg</span>&nbsp;<span class="op" id="1608381">=</span>&nbsp;<span class="ident" id="1608383">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608391">f</span><span class="op" id="1608392">.</span><span class="ident" id="1608393">ot</span>&nbsp;<span class="op" id="1608396">=</span>&nbsp;<span class="ident" id="1608398">nil</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1608405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608410">fb</span><span class="op" id="1608412">.</span><span class="ident" id="1608413">cnt</span>&nbsp;<span class="op" id="1608417">=</span>&nbsp;<span class="num" id="1608419">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608424">next</span>&nbsp;<span class="op" id="1608429">:=</span>&nbsp;<span class="ident" id="1608432">fb</span><span class="op" id="1608434">.</span><span class="ident" id="1608435">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608443">lock</span><span class="op" id="1608447">(</span><span class="op" id="1608448">&amp;</span><span class="ident" id="1608449">finlock</span><span class="op" id="1608456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608461">fb</span><span class="op" id="1608463">.</span><span class="ident" id="1608464">next</span>&nbsp;<span class="op" id="1608469">=</span>&nbsp;<span class="ident" id="1608471">finc</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608479">finc</span>&nbsp;<span class="op" id="1608484">=</span>&nbsp;<span class="ident" id="1608486">fb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608492">unlock</span><span class="op" id="1608498">(</span><span class="op" id="1608499">&amp;</span><span class="ident" id="1608500">finlock</span><span class="op" id="1608507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608512">fb</span>&nbsp;<span class="op" id="1608515">=</span>&nbsp;<span class="ident" id="1608517">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1608524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1608527">}</span><br>
<span class="lineno">785</span><span class="op" id="1608529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1608532">var</span>&nbsp;<span class="ident" id="1608536">persistent</span>&nbsp;<span class="keyword" id="1608547">struct</span>&nbsp;<span class="op" id="1608554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608557">lock</span>&nbsp;<span class="ident" id="1608562">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608569">pos</span>&nbsp;&nbsp;<span class="ident" id="1608574">unsafe</span><span class="op" id="1608580">.</span><span class="ident" id="1608581">Pointer</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608590">end</span>&nbsp;&nbsp;<span class="ident" id="1608595">unsafe</span><span class="op" id="1608601">.</span><span class="ident" id="1608602">Pointer</span><br>
<span class="lineno"></span><span class="op" id="1608610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1608613">//&nbsp;Wrapper&nbsp;around&nbsp;sysAlloc&nbsp;that&nbsp;can&nbsp;allocate&nbsp;small&nbsp;chunks.</span><br>
<span class="lineno"></span><span class="comment" id="1608672">//&nbsp;There&nbsp;is&nbsp;no&nbsp;associated&nbsp;free&nbsp;operation.</span><br>
<span class="lineno">795</span><span class="comment" id="1608714">//&nbsp;Intended&nbsp;for&nbsp;things&nbsp;like&nbsp;function/type/debug-related&nbsp;persistent&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1608787">//&nbsp;If&nbsp;align&nbsp;is&nbsp;0,&nbsp;uses&nbsp;default&nbsp;align&nbsp;(currently&nbsp;8).</span><br>
<span class="lineno"></span><span class="keyword" id="1608839">func</span>&nbsp;<span class="ident" id="1608844">persistentalloc</span><span class="op" id="1608859">(</span><span class="ident" id="1608860">size</span><span class="op" id="1608864">,</span>&nbsp;<span class="ident" id="1608866">align</span>&nbsp;<span class="builtintype" id="1608872">uintptr</span><span class="op" id="1608879">,</span>&nbsp;<span class="ident" id="1608881">stat</span>&nbsp;<span class="op" id="1608886">*</span><span class="ident" id="1608887">uint64</span><span class="op" id="1608893">)</span>&nbsp;<span class="ident" id="1608895">unsafe</span><span class="op" id="1608901">.</span><span class="ident" id="1608902">Pointer</span>&nbsp;<span class="op" id="1608910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1608913">const</span>&nbsp;<span class="op" id="1608919">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608923">chunk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608932">=</span>&nbsp;<span class="num" id="1608934">256</span>&nbsp;<span class="op" id="1608938">&lt;&lt;</span>&nbsp;<span class="num" id="1608941">10</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608946">maxBlock</span>&nbsp;<span class="op" id="1608955">=</span>&nbsp;<span class="num" id="1608957">64</span>&nbsp;<span class="op" id="1608960">&lt;&lt;</span>&nbsp;<span class="num" id="1608963">10</span>&nbsp;<span class="comment" id="1608966">//&nbsp;VM&nbsp;reservation&nbsp;granularity&nbsp;is&nbsp;64K&nbsp;on&nbsp;windows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1609015">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609019">if</span>&nbsp;<span class="ident" id="1609022">align</span>&nbsp;<span class="op" id="1609028">!=</span>&nbsp;<span class="num" id="1609031">0</span>&nbsp;<span class="op" id="1609033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609037">if</span>&nbsp;<span class="ident" id="1609040">align</span><span class="op" id="1609045">&amp;</span><span class="op" id="1609046">(</span><span class="ident" id="1609047">align</span><span class="op" id="1609052">-</span><span class="num" id="1609053">1</span><span class="op" id="1609054">)</span>&nbsp;<span class="op" id="1609056">!=</span>&nbsp;<span class="num" id="1609059">0</span>&nbsp;<span class="op" id="1609061">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609066">gothrow</span><span class="op" id="1609073">(</span><span class="string" id="1609074">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;not&nbsp;a&nbsp;power&nbsp;of&nbsp;2&#34;</span><span class="op" id="1609118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1609122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609126">if</span>&nbsp;<span class="ident" id="1609129">align</span>&nbsp;<span class="op" id="1609135">&gt;</span>&nbsp;<span class="ident" id="1609137">_PageSize</span>&nbsp;<span class="op" id="1609147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609152">gothrow</span><span class="op" id="1609159">(</span><span class="string" id="1609160">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;too&nbsp;large&#34;</span><span class="op" id="1609197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1609201">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1609204">}</span>&nbsp;<span class="keyword" id="1609206">else</span>&nbsp;<span class="op" id="1609211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609215">align</span>&nbsp;<span class="op" id="1609221">=</span>&nbsp;<span class="num" id="1609223">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1609226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609230">if</span>&nbsp;<span class="ident" id="1609233">size</span>&nbsp;<span class="op" id="1609238">&gt;=</span>&nbsp;<span class="ident" id="1609241">maxBlock</span>&nbsp;<span class="op" id="1609250">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609254">return</span>&nbsp;<span class="ident" id="1609261">sysAlloc</span><span class="op" id="1609269">(</span><span class="ident" id="1609270">size</span><span class="op" id="1609274">,</span>&nbsp;<span class="ident" id="1609276">stat</span><span class="op" id="1609280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1609283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609287">lock</span><span class="op" id="1609291">(</span><span class="op" id="1609292">&amp;</span><span class="ident" id="1609293">persistent</span><span class="op" id="1609303">.</span><span class="ident" id="1609304">lock</span><span class="op" id="1609308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609311">persistent</span><span class="op" id="1609321">.</span><span class="ident" id="1609322">pos</span>&nbsp;<span class="op" id="1609326">=</span>&nbsp;<span class="ident" id="1609328">roundup</span><span class="op" id="1609335">(</span><span class="ident" id="1609336">persistent</span><span class="op" id="1609346">.</span><span class="ident" id="1609347">pos</span><span class="op" id="1609350">,</span>&nbsp;<span class="ident" id="1609352">align</span><span class="op" id="1609357">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609360">if</span>&nbsp;<span class="builtintype" id="1609363">uintptr</span><span class="op" id="1609370">(</span><span class="ident" id="1609371">persistent</span><span class="op" id="1609381">.</span><span class="ident" id="1609382">pos</span><span class="op" id="1609385">)</span><span class="op" id="1609386">+</span><span class="ident" id="1609387">size</span>&nbsp;<span class="op" id="1609392">&gt;</span>&nbsp;<span class="builtintype" id="1609394">uintptr</span><span class="op" id="1609401">(</span><span class="ident" id="1609402">persistent</span><span class="op" id="1609412">.</span><span class="ident" id="1609413">end</span><span class="op" id="1609416">)</span>&nbsp;<span class="op" id="1609418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609422">persistent</span><span class="op" id="1609432">.</span><span class="ident" id="1609433">pos</span>&nbsp;<span class="op" id="1609437">=</span>&nbsp;<span class="ident" id="1609439">sysAlloc</span><span class="op" id="1609447">(</span><span class="ident" id="1609448">chunk</span><span class="op" id="1609453">,</span>&nbsp;<span class="op" id="1609455">&amp;</span><span class="ident" id="1609456">memstats</span><span class="op" id="1609464">.</span><span class="ident" id="1609465">other_sys</span><span class="op" id="1609474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609478">if</span>&nbsp;<span class="ident" id="1609481">persistent</span><span class="op" id="1609491">.</span><span class="ident" id="1609492">pos</span>&nbsp;<span class="op" id="1609496">==</span>&nbsp;<span class="ident" id="1609499">nil</span>&nbsp;<span class="op" id="1609503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609508">unlock</span><span class="op" id="1609514">(</span><span class="op" id="1609515">&amp;</span><span class="ident" id="1609516">persistent</span><span class="op" id="1609526">.</span><span class="ident" id="1609527">lock</span><span class="op" id="1609531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609536">gothrow</span><span class="op" id="1609543">(</span><span class="string" id="1609544">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1609577">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1609581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609585">persistent</span><span class="op" id="1609595">.</span><span class="ident" id="1609596">end</span>&nbsp;<span class="op" id="1609600">=</span>&nbsp;<span class="ident" id="1609602">add</span><span class="op" id="1609605">(</span><span class="ident" id="1609606">persistent</span><span class="op" id="1609616">.</span><span class="ident" id="1609617">pos</span><span class="op" id="1609620">,</span>&nbsp;<span class="ident" id="1609622">chunk</span><span class="op" id="1609627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1609630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609633">p</span>&nbsp;<span class="op" id="1609635">:=</span>&nbsp;<span class="ident" id="1609638">persistent</span><span class="op" id="1609648">.</span><span class="ident" id="1609649">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609654">persistent</span><span class="op" id="1609664">.</span><span class="ident" id="1609665">pos</span>&nbsp;<span class="op" id="1609669">=</span>&nbsp;<span class="ident" id="1609671">add</span><span class="op" id="1609674">(</span><span class="ident" id="1609675">persistent</span><span class="op" id="1609685">.</span><span class="ident" id="1609686">pos</span><span class="op" id="1609689">,</span>&nbsp;<span class="ident" id="1609691">size</span><span class="op" id="1609695">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609698">unlock</span><span class="op" id="1609704">(</span><span class="op" id="1609705">&amp;</span><span class="ident" id="1609706">persistent</span><span class="op" id="1609716">.</span><span class="ident" id="1609717">lock</span><span class="op" id="1609721">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609725">if</span>&nbsp;<span class="ident" id="1609728">stat</span>&nbsp;<span class="op" id="1609733">!=</span>&nbsp;<span class="op" id="1609736">&amp;</span><span class="ident" id="1609737">memstats</span><span class="op" id="1609745">.</span><span class="ident" id="1609746">other_sys</span>&nbsp;<span class="op" id="1609756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609760">xadd64</span><span class="op" id="1609766">(</span><span class="ident" id="1609767">stat</span><span class="op" id="1609771">,</span>&nbsp;<span class="ident" id="1609773">int64</span><span class="op" id="1609778">(</span><span class="ident" id="1609779">size</span><span class="op" id="1609783">)</span><span class="op" id="1609784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609788">xadd64</span><span class="op" id="1609794">(</span><span class="op" id="1609795">&amp;</span><span class="ident" id="1609796">memstats</span><span class="op" id="1609804">.</span><span class="ident" id="1609805">other_sys</span><span class="op" id="1609814">,</span>&nbsp;<span class="op" id="1609816">-</span><span class="ident" id="1609817">int64</span><span class="op" id="1609822">(</span><span class="ident" id="1609823">size</span><span class="op" id="1609827">)</span><span class="op" id="1609828">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1609831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609834">return</span>&nbsp;<span class="ident" id="1609841">p</span><br>
<span class="lineno"></span><span class="op" id="1609843">}</span>
</div>
</body>
</html>
