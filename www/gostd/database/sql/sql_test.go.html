<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8380694">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8380749">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8380803">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8380854">package</span>&nbsp;<span class="ident" id="8380862">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8380867">import</span>&nbsp;<span class="op" id="8380874">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8380877">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8380900">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8380910">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8380917">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8380930">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8380941">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8380952">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8380963">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8380971">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8380982">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8380989">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="8380992">func</span>&nbsp;<span class="ident" id="8380997">init</span><span class="op" id="8381001">(</span><span class="op" id="8381002">)</span>&nbsp;<span class="op" id="8381004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8381007">type</span>&nbsp;<span class="ident" id="8381012">dbConn</span>&nbsp;<span class="keyword" id="8381019">struct</span>&nbsp;<span class="op" id="8381026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8381030">db</span>&nbsp;<span class="op" id="8381033">*</span><span class="ident" id="8381034">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8381039">c</span>&nbsp;&nbsp;<span class="op" id="8381042">*</span><span class="ident" id="8381043">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8381055">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8381058">freedFrom</span>&nbsp;<span class="op" id="8381068">:=</span>&nbsp;<span class="builtinfunc" id="8381071">make</span><span class="op" id="8381075">(</span><span class="keyword" id="8381076">map</span><span class="op" id="8381079">[</span><span class="ident" id="8381080">dbConn</span><span class="op" id="8381086">]</span><span class="builtintype" id="8381087">string</span><span class="op" id="8381093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8381096">putConnHook</span>&nbsp;<span class="op" id="8381108">=</span>&nbsp;<span class="keyword" id="8381110">func</span><span class="op" id="8381114">(</span><span class="ident" id="8381115">db</span>&nbsp;<span class="op" id="8381118">*</span><span class="ident" id="8381119">DB</span><span class="op" id="8381121">,</span>&nbsp;<span class="ident" id="8381123">c</span>&nbsp;<span class="op" id="8381125">*</span><span class="ident" id="8381126">driverConn</span><span class="op" id="8381136">)</span>&nbsp;<span class="op" id="8381138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8381142">idx</span>&nbsp;<span class="op" id="8381146">:=</span>&nbsp;<span class="op" id="8381149">-</span><span class="num" id="8381150">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8381154">for</span>&nbsp;<span class="ident" id="8381158">i</span><span class="op" id="8381159">,</span>&nbsp;<span class="ident" id="8381161">v</span>&nbsp;<span class="op" id="8381163">:=</span>&nbsp;<span class="keyword" id="8381166">range</span>&nbsp;<span class="ident" id="8381172">db</span><span class="op" id="8381174">.</span><span class="ident" id="8381175">freeConn</span>&nbsp;<span class="op" id="8381184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8381189">if</span>&nbsp;<span class="ident" id="8381192">v</span>&nbsp;<span class="op" id="8381194">==</span>&nbsp;<span class="ident" id="8381197">c</span>&nbsp;<span class="op" id="8381199">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8381205">idx</span>&nbsp;<span class="op" id="8381209">=</span>&nbsp;<span class="ident" id="8381211">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8381217">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8381226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8381230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8381234">if</span>&nbsp;<span class="ident" id="8381237">idx</span>&nbsp;<span class="op" id="8381241">&gt;=</span>&nbsp;<span class="num" id="8381244">0</span>&nbsp;<span class="op" id="8381246">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8381251">//&nbsp;print&nbsp;before&nbsp;panic,&nbsp;as&nbsp;panic&nbsp;may&nbsp;get&nbsp;lost&nbsp;due&nbsp;to&nbsp;conflicting&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8381324">//&nbsp;(all&nbsp;goroutines&nbsp;asleep)&nbsp;elsewhere,&nbsp;since&nbsp;we&nbsp;might&nbsp;not&nbsp;unlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8381391">//&nbsp;the&nbsp;mutex&nbsp;in&nbsp;freeConn&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8381425">println</span><span class="op" id="8381432">(</span><span class="string" id="8381433">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&nbsp;conflicts&nbsp;are:\nA)&nbsp;&#34;</span>&nbsp;<span class="op" id="8381476">+</span>&nbsp;<span class="ident" id="8381478">freedFrom</span><span class="op" id="8381487">[</span><span class="ident" id="8381488">dbConn</span><span class="op" id="8381494">{</span><span class="ident" id="8381495">db</span><span class="op" id="8381497">,</span>&nbsp;<span class="ident" id="8381499">c</span><span class="op" id="8381500">}</span><span class="op" id="8381501">]</span>&nbsp;<span class="op" id="8381503">+</span>&nbsp;<span class="string" id="8381505">&#34;\n\nand\nB)&nbsp;&#34;</span>&nbsp;<span class="op" id="8381520">+</span>&nbsp;<span class="ident" id="8381522">stack</span><span class="op" id="8381527">(</span><span class="op" id="8381528">)</span><span class="op" id="8381529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8381534">panic</span><span class="op" id="8381539">(</span><span class="string" id="8381540">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&#34;</span><span class="op" id="8381562">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8381566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8381570">freedFrom</span><span class="op" id="8381579">[</span><span class="ident" id="8381580">dbConn</span><span class="op" id="8381586">{</span><span class="ident" id="8381587">db</span><span class="op" id="8381589">,</span>&nbsp;<span class="ident" id="8381591">c</span><span class="op" id="8381592">}</span><span class="op" id="8381593">]</span>&nbsp;<span class="op" id="8381595">=</span>&nbsp;<span class="ident" id="8381597">stack</span><span class="op" id="8381602">(</span><span class="op" id="8381603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8381606">}</span><br>
<span class="lineno"></span><span class="op" id="8381608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="8381611">const</span>&nbsp;<span class="ident" id="8381617">fakeDBName</span>&nbsp;<span class="op" id="8381628">=</span>&nbsp;<span class="string" id="8381630">&#34;foo&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8381637">var</span>&nbsp;<span class="ident" id="8381641">chrisBirthday</span>&nbsp;<span class="op" id="8381655">=</span>&nbsp;<span class="ident" id="8381657">time</span><span class="op" id="8381661">.</span><span class="ident" id="8381662">Unix</span><span class="op" id="8381666">(</span><span class="num" id="8381667">123456789</span><span class="op" id="8381676">,</span>&nbsp;<span class="num" id="8381678">0</span><span class="op" id="8381679">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8381682">func</span>&nbsp;<span class="ident" id="8381687">newTestDB</span><span class="op" id="8381696">(</span><span class="ident" id="8381697">t</span>&nbsp;<span class="ident" id="8381699">testing</span><span class="op" id="8381706">.</span><span class="ident" id="8381707">TB</span><span class="op" id="8381709">,</span>&nbsp;<span class="ident" id="8381711">name</span>&nbsp;<span class="builtintype" id="8381716">string</span><span class="op" id="8381722">)</span>&nbsp;<span class="op" id="8381724">*</span><span class="ident" id="8381725">DB</span>&nbsp;<span class="op" id="8381728">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8381731">db</span><span class="op" id="8381733">,</span>&nbsp;<span class="ident" id="8381735">err</span>&nbsp;<span class="op" id="8381739">:=</span>&nbsp;<span class="ident" id="8381742">Open</span><span class="op" id="8381746">(</span><span class="string" id="8381747">&#34;test&#34;</span><span class="op" id="8381753">,</span>&nbsp;<span class="ident" id="8381755">fakeDBName</span><span class="op" id="8381765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8381768">if</span>&nbsp;<span class="ident" id="8381771">err</span>&nbsp;<span class="op" id="8381775">!=</span>&nbsp;<span class="ident" id="8381778">nil</span>&nbsp;<span class="op" id="8381782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8381786">t</span><span class="op" id="8381787">.</span><span class="ident" id="8381788">Fatalf</span><span class="op" id="8381794">(</span><span class="string" id="8381795">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="8381805">,</span>&nbsp;<span class="ident" id="8381807">err</span><span class="op" id="8381810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8381813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8381816">if</span>&nbsp;<span class="ident" id="8381819">_</span><span class="op" id="8381820">,</span>&nbsp;<span class="ident" id="8381822">err</span>&nbsp;<span class="op" id="8381826">:=</span>&nbsp;<span class="ident" id="8381829">db</span><span class="op" id="8381831">.</span><span class="ident" id="8381832">Exec</span><span class="op" id="8381836">(</span><span class="string" id="8381837">&#34;WIPE&#34;</span><span class="op" id="8381843">)</span><span class="op" id="8381844">;</span>&nbsp;<span class="ident" id="8381846">err</span>&nbsp;<span class="op" id="8381850">!=</span>&nbsp;<span class="ident" id="8381853">nil</span>&nbsp;<span class="op" id="8381857">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8381861">t</span><span class="op" id="8381862">.</span><span class="ident" id="8381863">Fatalf</span><span class="op" id="8381869">(</span><span class="string" id="8381870">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="8381885">,</span>&nbsp;<span class="ident" id="8381887">err</span><span class="op" id="8381890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8381893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8381896">if</span>&nbsp;<span class="ident" id="8381899">name</span>&nbsp;<span class="op" id="8381904">==</span>&nbsp;<span class="string" id="8381907">&#34;people&#34;</span>&nbsp;<span class="op" id="8381916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8381920">exec</span><span class="op" id="8381924">(</span><span class="ident" id="8381925">t</span><span class="op" id="8381926">,</span>&nbsp;<span class="ident" id="8381928">db</span><span class="op" id="8381930">,</span>&nbsp;<span class="string" id="8381932">&#34;CREATE|people|name=string,age=int32,photo=blob,dead=bool,bdate=datetime&#34;</span><span class="op" id="8382005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8382009">exec</span><span class="op" id="8382013">(</span><span class="ident" id="8382014">t</span><span class="op" id="8382015">,</span>&nbsp;<span class="ident" id="8382017">db</span><span class="op" id="8382019">,</span>&nbsp;<span class="string" id="8382021">&#34;INSERT|people|name=Alice,age=?,photo=APHOTO&#34;</span><span class="op" id="8382066">,</span>&nbsp;<span class="num" id="8382068">1</span><span class="op" id="8382069">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8382073">exec</span><span class="op" id="8382077">(</span><span class="ident" id="8382078">t</span><span class="op" id="8382079">,</span>&nbsp;<span class="ident" id="8382081">db</span><span class="op" id="8382083">,</span>&nbsp;<span class="string" id="8382085">&#34;INSERT|people|name=Bob,age=?,photo=BPHOTO&#34;</span><span class="op" id="8382128">,</span>&nbsp;<span class="num" id="8382130">2</span><span class="op" id="8382131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8382135">exec</span><span class="op" id="8382139">(</span><span class="ident" id="8382140">t</span><span class="op" id="8382141">,</span>&nbsp;<span class="ident" id="8382143">db</span><span class="op" id="8382145">,</span>&nbsp;<span class="string" id="8382147">&#34;INSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8382200">,</span>&nbsp;<span class="num" id="8382202">3</span><span class="op" id="8382203">,</span>&nbsp;<span class="ident" id="8382205">chrisBirthday</span><span class="op" id="8382218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8382221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8382224">if</span>&nbsp;<span class="ident" id="8382227">name</span>&nbsp;<span class="op" id="8382232">==</span>&nbsp;<span class="string" id="8382235">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="8382248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8382252">//&nbsp;Magic&nbsp;table&nbsp;name&nbsp;and&nbsp;column,&nbsp;known&nbsp;by&nbsp;fakedb_test.go.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8382311">exec</span><span class="op" id="8382315">(</span><span class="ident" id="8382316">t</span><span class="op" id="8382317">,</span>&nbsp;<span class="ident" id="8382319">db</span><span class="op" id="8382321">,</span>&nbsp;<span class="string" id="8382323">&#34;CREATE|magicquery|op=string,millis=int32&#34;</span><span class="op" id="8382365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8382369">exec</span><span class="op" id="8382373">(</span><span class="ident" id="8382374">t</span><span class="op" id="8382375">,</span>&nbsp;<span class="ident" id="8382377">db</span><span class="op" id="8382379">,</span>&nbsp;<span class="string" id="8382381">&#34;INSERT|magicquery|op=sleep,millis=10&#34;</span><span class="op" id="8382419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8382422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8382425">return</span>&nbsp;<span class="ident" id="8382432">db</span><br>
<span class="lineno"></span><span class="op" id="8382435">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="8382438">func</span>&nbsp;<span class="ident" id="8382443">exec</span><span class="op" id="8382447">(</span><span class="ident" id="8382448">t</span>&nbsp;<span class="ident" id="8382450">testing</span><span class="op" id="8382457">.</span><span class="ident" id="8382458">TB</span><span class="op" id="8382460">,</span>&nbsp;<span class="ident" id="8382462">db</span>&nbsp;<span class="op" id="8382465">*</span><span class="ident" id="8382466">DB</span><span class="op" id="8382468">,</span>&nbsp;<span class="ident" id="8382470">query</span>&nbsp;<span class="builtintype" id="8382476">string</span><span class="op" id="8382482">,</span>&nbsp;<span class="ident" id="8382484">args</span>&nbsp;<span class="op" id="8382489">...</span><span class="keyword" id="8382492">interface</span><span class="op" id="8382501">{</span><span class="op" id="8382502">}</span><span class="op" id="8382503">)</span>&nbsp;<span class="op" id="8382505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8382508">_</span><span class="op" id="8382509">,</span>&nbsp;<span class="ident" id="8382511">err</span>&nbsp;<span class="op" id="8382515">:=</span>&nbsp;<span class="ident" id="8382518">db</span><span class="op" id="8382520">.</span><span class="ident" id="8382521">Exec</span><span class="op" id="8382525">(</span><span class="ident" id="8382526">query</span><span class="op" id="8382531">,</span>&nbsp;<span class="ident" id="8382533">args</span><span class="op" id="8382537">...</span><span class="op" id="8382540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8382543">if</span>&nbsp;<span class="ident" id="8382546">err</span>&nbsp;<span class="op" id="8382550">!=</span>&nbsp;<span class="ident" id="8382553">nil</span>&nbsp;<span class="op" id="8382557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8382561">t</span><span class="op" id="8382562">.</span><span class="ident" id="8382563">Fatalf</span><span class="op" id="8382569">(</span><span class="string" id="8382570">&#34;Exec&nbsp;of&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="8382586">,</span>&nbsp;<span class="ident" id="8382588">query</span><span class="op" id="8382593">,</span>&nbsp;<span class="ident" id="8382595">err</span><span class="op" id="8382598">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8382601">}</span><br>
<span class="lineno"></span><span class="op" id="8382603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8382606">func</span>&nbsp;<span class="ident" id="8382611">closeDB</span><span class="op" id="8382618">(</span><span class="ident" id="8382619">t</span>&nbsp;<span class="ident" id="8382621">testing</span><span class="op" id="8382628">.</span><span class="ident" id="8382629">TB</span><span class="op" id="8382631">,</span>&nbsp;<span class="ident" id="8382633">db</span>&nbsp;<span class="op" id="8382636">*</span><span class="ident" id="8382637">DB</span><span class="op" id="8382639">)</span>&nbsp;<span class="op" id="8382641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8382644">if</span>&nbsp;<span class="ident" id="8382647">e</span>&nbsp;<span class="op" id="8382649">:=</span>&nbsp;<span class="builtinfunc" id="8382652">recover</span><span class="op" id="8382659">(</span><span class="op" id="8382660">)</span><span class="op" id="8382661">;</span>&nbsp;<span class="ident" id="8382663">e</span>&nbsp;<span class="op" id="8382665">!=</span>&nbsp;<span class="ident" id="8382668">nil</span>&nbsp;<span class="op" id="8382672">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8382676">fmt</span><span class="op" id="8382679">.</span><span class="ident" id="8382680">Printf</span><span class="op" id="8382686">(</span><span class="string" id="8382687">&#34;Panic:&nbsp;%v\n&#34;</span><span class="op" id="8382700">,</span>&nbsp;<span class="ident" id="8382702">e</span><span class="op" id="8382703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8382707">panic</span><span class="op" id="8382712">(</span><span class="ident" id="8382713">e</span><span class="op" id="8382714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8382717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8382720">defer</span>&nbsp;<span class="ident" id="8382726">setHookpostCloseConn</span><span class="op" id="8382746">(</span><span class="ident" id="8382747">nil</span><span class="op" id="8382750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8382753">setHookpostCloseConn</span><span class="op" id="8382773">(</span><span class="keyword" id="8382774">func</span><span class="op" id="8382778">(</span><span class="ident" id="8382779">_</span>&nbsp;<span class="op" id="8382781">*</span><span class="ident" id="8382782">fakeConn</span><span class="op" id="8382790">,</span>&nbsp;<span class="ident" id="8382792">err</span>&nbsp;<span class="builtintype" id="8382796">error</span><span class="op" id="8382801">)</span>&nbsp;<span class="op" id="8382803">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8382807">if</span>&nbsp;<span class="ident" id="8382810">err</span>&nbsp;<span class="op" id="8382814">!=</span>&nbsp;<span class="ident" id="8382817">nil</span>&nbsp;<span class="op" id="8382821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8382826">t</span><span class="op" id="8382827">.</span><span class="ident" id="8382828">Errorf</span><span class="op" id="8382834">(</span><span class="string" id="8382835">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="8382863">,</span>&nbsp;<span class="ident" id="8382865">err</span><span class="op" id="8382868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8382872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8382875">}</span><span class="op" id="8382876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8382879">for</span>&nbsp;<span class="ident" id="8382883">i</span><span class="op" id="8382884">,</span>&nbsp;<span class="ident" id="8382886">dc</span>&nbsp;<span class="op" id="8382889">:=</span>&nbsp;<span class="keyword" id="8382892">range</span>&nbsp;<span class="ident" id="8382898">db</span><span class="op" id="8382900">.</span><span class="ident" id="8382901">freeConn</span>&nbsp;<span class="op" id="8382910">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8382914">if</span>&nbsp;<span class="ident" id="8382917">n</span>&nbsp;<span class="op" id="8382919">:=</span>&nbsp;<span class="builtinfunc" id="8382922">len</span><span class="op" id="8382925">(</span><span class="ident" id="8382926">dc</span><span class="op" id="8382928">.</span><span class="ident" id="8382929">openStmt</span><span class="op" id="8382937">)</span><span class="op" id="8382938">;</span>&nbsp;<span class="ident" id="8382940">n</span>&nbsp;<span class="op" id="8382942">&gt;</span>&nbsp;<span class="num" id="8382944">0</span>&nbsp;<span class="op" id="8382946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8382951">//&nbsp;Just&nbsp;a&nbsp;sanity&nbsp;check.&nbsp;This&nbsp;is&nbsp;legal&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8382995">//&nbsp;general,&nbsp;but&nbsp;if&nbsp;we&nbsp;make&nbsp;the&nbsp;tests&nbsp;clean&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8383044">//&nbsp;their&nbsp;statements&nbsp;first,&nbsp;then&nbsp;we&nbsp;can&nbsp;safely</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8383093">//&nbsp;verify&nbsp;this&nbsp;is&nbsp;always&nbsp;zero&nbsp;here,&nbsp;and&nbsp;any</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8383140">//&nbsp;other&nbsp;value&nbsp;is&nbsp;a&nbsp;leak.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8383169">t</span><span class="op" id="8383170">.</span><span class="ident" id="8383171">Errorf</span><span class="op" id="8383177">(</span><span class="string" id="8383178">&#34;while&nbsp;closing&nbsp;db,&nbsp;freeConn&nbsp;%d/%d&nbsp;had&nbsp;%d&nbsp;open&nbsp;stmts;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8383238">,</span>&nbsp;<span class="ident" id="8383240">i</span><span class="op" id="8383241">,</span>&nbsp;<span class="builtinfunc" id="8383243">len</span><span class="op" id="8383246">(</span><span class="ident" id="8383247">db</span><span class="op" id="8383249">.</span><span class="ident" id="8383250">freeConn</span><span class="op" id="8383258">)</span><span class="op" id="8383259">,</span>&nbsp;<span class="ident" id="8383261">n</span><span class="op" id="8383262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8383266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8383269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8383272">err</span>&nbsp;<span class="op" id="8383276">:=</span>&nbsp;<span class="ident" id="8383279">db</span><span class="op" id="8383281">.</span><span class="ident" id="8383282">Close</span><span class="op" id="8383287">(</span><span class="op" id="8383288">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8383291">if</span>&nbsp;<span class="ident" id="8383294">err</span>&nbsp;<span class="op" id="8383298">!=</span>&nbsp;<span class="ident" id="8383301">nil</span>&nbsp;<span class="op" id="8383305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8383309">t</span><span class="op" id="8383310">.</span><span class="ident" id="8383311">Fatalf</span><span class="op" id="8383317">(</span><span class="string" id="8383318">&#34;error&nbsp;closing&nbsp;DB:&nbsp;%v&#34;</span><span class="op" id="8383340">,</span>&nbsp;<span class="ident" id="8383342">err</span><span class="op" id="8383345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8383348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8383351">db</span><span class="op" id="8383353">.</span><span class="ident" id="8383354">mu</span><span class="op" id="8383356">.</span><span class="ident" id="8383357">Lock</span><span class="op" id="8383361">(</span><span class="op" id="8383362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8383365">count</span>&nbsp;<span class="op" id="8383371">:=</span>&nbsp;<span class="ident" id="8383374">db</span><span class="op" id="8383376">.</span><span class="ident" id="8383377">numOpen</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8383386">db</span><span class="op" id="8383388">.</span><span class="ident" id="8383389">mu</span><span class="op" id="8383391">.</span><span class="ident" id="8383392">Unlock</span><span class="op" id="8383398">(</span><span class="op" id="8383399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8383402">if</span>&nbsp;<span class="ident" id="8383405">count</span>&nbsp;<span class="op" id="8383411">!=</span>&nbsp;<span class="num" id="8383414">0</span>&nbsp;<span class="op" id="8383416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8383420">t</span><span class="op" id="8383421">.</span><span class="ident" id="8383422">Fatalf</span><span class="op" id="8383428">(</span><span class="string" id="8383429">&#34;%d&nbsp;connections&nbsp;still&nbsp;open&nbsp;after&nbsp;closing&nbsp;DB&#34;</span><span class="op" id="8383473">,</span>&nbsp;<span class="ident" id="8383475">db</span><span class="op" id="8383477">.</span><span class="ident" id="8383478">numOpen</span><span class="op" id="8383485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8383488">}</span><br>
<span class="lineno"></span><span class="op" id="8383490">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="comment" id="8383493">//&nbsp;numPrepares&nbsp;assumes&nbsp;that&nbsp;db&nbsp;has&nbsp;exactly&nbsp;1&nbsp;idle&nbsp;conn&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="8383560">//&nbsp;its&nbsp;count&nbsp;of&nbsp;calls&nbsp;to&nbsp;Prepare</span><br>
<span class="lineno"></span><span class="keyword" id="8383593">func</span>&nbsp;<span class="ident" id="8383598">numPrepares</span><span class="op" id="8383609">(</span><span class="ident" id="8383610">t</span>&nbsp;<span class="op" id="8383612">*</span><span class="ident" id="8383613">testing</span><span class="op" id="8383620">.</span><span class="ident" id="8383621">T</span><span class="op" id="8383622">,</span>&nbsp;<span class="ident" id="8383624">db</span>&nbsp;<span class="op" id="8383627">*</span><span class="ident" id="8383628">DB</span><span class="op" id="8383630">)</span>&nbsp;<span class="builtintype" id="8383632">int</span>&nbsp;<span class="op" id="8383636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8383639">if</span>&nbsp;<span class="ident" id="8383642">n</span>&nbsp;<span class="op" id="8383644">:=</span>&nbsp;<span class="builtinfunc" id="8383647">len</span><span class="op" id="8383650">(</span><span class="ident" id="8383651">db</span><span class="op" id="8383653">.</span><span class="ident" id="8383654">freeConn</span><span class="op" id="8383662">)</span><span class="op" id="8383663">;</span>&nbsp;<span class="ident" id="8383665">n</span>&nbsp;<span class="op" id="8383667">!=</span>&nbsp;<span class="num" id="8383670">1</span>&nbsp;<span class="op" id="8383672">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8383676">t</span><span class="op" id="8383677">.</span><span class="ident" id="8383678">Fatalf</span><span class="op" id="8383684">(</span><span class="string" id="8383685">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8383710">,</span>&nbsp;<span class="ident" id="8383712">n</span><span class="op" id="8383713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8383716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8383719">return</span>&nbsp;<span class="ident" id="8383726">db</span><span class="op" id="8383728">.</span><span class="ident" id="8383729">freeConn</span><span class="op" id="8383737">[</span><span class="num" id="8383738">0</span><span class="op" id="8383739">]</span><span class="op" id="8383740">.</span><span class="ident" id="8383741">ci</span><span class="op" id="8383743">.</span><span class="op" id="8383744">(</span><span class="op" id="8383745">*</span><span class="ident" id="8383746">fakeConn</span><span class="op" id="8383754">)</span><span class="op" id="8383755">.</span><span class="ident" id="8383756">numPrepare</span><br>
<span class="lineno"></span><span class="op" id="8383767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="8383770">func</span>&nbsp;<span class="op" id="8383775">(</span><span class="ident" id="8383776">db</span>&nbsp;<span class="op" id="8383779">*</span><span class="ident" id="8383780">DB</span><span class="op" id="8383782">)</span>&nbsp;<span class="ident" id="8383784">numDeps</span><span class="op" id="8383791">(</span><span class="op" id="8383792">)</span>&nbsp;<span class="builtintype" id="8383794">int</span>&nbsp;<span class="op" id="8383798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8383801">db</span><span class="op" id="8383803">.</span><span class="ident" id="8383804">mu</span><span class="op" id="8383806">.</span><span class="ident" id="8383807">Lock</span><span class="op" id="8383811">(</span><span class="op" id="8383812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8383815">defer</span>&nbsp;<span class="ident" id="8383821">db</span><span class="op" id="8383823">.</span><span class="ident" id="8383824">mu</span><span class="op" id="8383826">.</span><span class="ident" id="8383827">Unlock</span><span class="op" id="8383833">(</span><span class="op" id="8383834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8383837">return</span>&nbsp;<span class="builtinfunc" id="8383844">len</span><span class="op" id="8383847">(</span><span class="ident" id="8383848">db</span><span class="op" id="8383850">.</span><span class="ident" id="8383851">dep</span><span class="op" id="8383854">)</span><br>
<span class="lineno"></span><span class="op" id="8383856">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="8383859">//&nbsp;Dependencies&nbsp;are&nbsp;closed&nbsp;via&nbsp;a&nbsp;goroutine,&nbsp;so&nbsp;this&nbsp;polls&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="8383929">//&nbsp;numDeps&nbsp;to&nbsp;fall&nbsp;to&nbsp;want,&nbsp;waiting&nbsp;up&nbsp;to&nbsp;d.</span><br>
<span class="lineno"></span><span class="keyword" id="8383974">func</span>&nbsp;<span class="op" id="8383979">(</span><span class="ident" id="8383980">db</span>&nbsp;<span class="op" id="8383983">*</span><span class="ident" id="8383984">DB</span><span class="op" id="8383986">)</span>&nbsp;<span class="ident" id="8383988">numDepsPollUntil</span><span class="op" id="8384004">(</span><span class="ident" id="8384005">want</span>&nbsp;<span class="builtintype" id="8384010">int</span><span class="op" id="8384013">,</span>&nbsp;<span class="ident" id="8384015">d</span>&nbsp;<span class="ident" id="8384017">time</span><span class="op" id="8384021">.</span><span class="ident" id="8384022">Duration</span><span class="op" id="8384030">)</span>&nbsp;<span class="builtintype" id="8384032">int</span>&nbsp;<span class="op" id="8384036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8384039">deadline</span>&nbsp;<span class="op" id="8384048">:=</span>&nbsp;<span class="ident" id="8384051">time</span><span class="op" id="8384055">.</span><span class="ident" id="8384056">Now</span><span class="op" id="8384059">(</span><span class="op" id="8384060">)</span><span class="op" id="8384061">.</span><span class="ident" id="8384062">Add</span><span class="op" id="8384065">(</span><span class="ident" id="8384066">d</span><span class="op" id="8384067">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8384070">for</span>&nbsp;<span class="op" id="8384074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8384078">n</span>&nbsp;<span class="op" id="8384080">:=</span>&nbsp;<span class="ident" id="8384083">db</span><span class="op" id="8384085">.</span><span class="ident" id="8384086">numDeps</span><span class="op" id="8384093">(</span><span class="op" id="8384094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8384098">if</span>&nbsp;<span class="ident" id="8384101">n</span>&nbsp;<span class="op" id="8384103">&lt;=</span>&nbsp;<span class="ident" id="8384106">want</span>&nbsp;<span class="op" id="8384111">||</span>&nbsp;<span class="ident" id="8384114">time</span><span class="op" id="8384118">.</span><span class="ident" id="8384119">Now</span><span class="op" id="8384122">(</span><span class="op" id="8384123">)</span><span class="op" id="8384124">.</span><span class="ident" id="8384125">After</span><span class="op" id="8384130">(</span><span class="ident" id="8384131">deadline</span><span class="op" id="8384139">)</span>&nbsp;<span class="op" id="8384141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8384146">return</span>&nbsp;<span class="ident" id="8384153">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8384157">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8384161">time</span><span class="op" id="8384165">.</span><span class="ident" id="8384166">Sleep</span><span class="op" id="8384171">(</span><span class="num" id="8384172">50</span>&nbsp;<span class="op" id="8384175">*</span>&nbsp;<span class="ident" id="8384177">time</span><span class="op" id="8384181">.</span><span class="ident" id="8384182">Millisecond</span><span class="op" id="8384193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8384196">}</span><br>
<span class="lineno"></span><span class="op" id="8384198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8384201">func</span>&nbsp;<span class="op" id="8384206">(</span><span class="ident" id="8384207">db</span>&nbsp;<span class="op" id="8384210">*</span><span class="ident" id="8384211">DB</span><span class="op" id="8384213">)</span>&nbsp;<span class="ident" id="8384215">numFreeConns</span><span class="op" id="8384227">(</span><span class="op" id="8384228">)</span>&nbsp;<span class="builtintype" id="8384230">int</span>&nbsp;<span class="op" id="8384234">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8384237">db</span><span class="op" id="8384239">.</span><span class="ident" id="8384240">mu</span><span class="op" id="8384242">.</span><span class="ident" id="8384243">Lock</span><span class="op" id="8384247">(</span><span class="op" id="8384248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8384251">defer</span>&nbsp;<span class="ident" id="8384257">db</span><span class="op" id="8384259">.</span><span class="ident" id="8384260">mu</span><span class="op" id="8384262">.</span><span class="ident" id="8384263">Unlock</span><span class="op" id="8384269">(</span><span class="op" id="8384270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8384273">return</span>&nbsp;<span class="builtinfunc" id="8384280">len</span><span class="op" id="8384283">(</span><span class="ident" id="8384284">db</span><span class="op" id="8384286">.</span><span class="ident" id="8384287">freeConn</span><span class="op" id="8384295">)</span><br>
<span class="lineno"></span><span class="op" id="8384297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="8384300">func</span>&nbsp;<span class="op" id="8384305">(</span><span class="ident" id="8384306">db</span>&nbsp;<span class="op" id="8384309">*</span><span class="ident" id="8384310">DB</span><span class="op" id="8384312">)</span>&nbsp;<span class="ident" id="8384314">dumpDeps</span><span class="op" id="8384322">(</span><span class="ident" id="8384323">t</span>&nbsp;<span class="op" id="8384325">*</span><span class="ident" id="8384326">testing</span><span class="op" id="8384333">.</span><span class="ident" id="8384334">T</span><span class="op" id="8384335">)</span>&nbsp;<span class="op" id="8384337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8384340">for</span>&nbsp;<span class="ident" id="8384344">fc</span>&nbsp;<span class="op" id="8384347">:=</span>&nbsp;<span class="keyword" id="8384350">range</span>&nbsp;<span class="ident" id="8384356">db</span><span class="op" id="8384358">.</span><span class="ident" id="8384359">dep</span>&nbsp;<span class="op" id="8384363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8384367">db</span><span class="op" id="8384369">.</span><span class="ident" id="8384370">dumpDep</span><span class="op" id="8384377">(</span><span class="ident" id="8384378">t</span><span class="op" id="8384379">,</span>&nbsp;<span class="num" id="8384381">0</span><span class="op" id="8384382">,</span>&nbsp;<span class="ident" id="8384384">fc</span><span class="op" id="8384386">,</span>&nbsp;<span class="keyword" id="8384388">map</span><span class="op" id="8384391">[</span><span class="ident" id="8384392">finalCloser</span><span class="op" id="8384403">]</span><span class="builtintype" id="8384404">bool</span><span class="op" id="8384408">{</span><span class="op" id="8384409">}</span><span class="op" id="8384410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8384413">}</span><br>
<span class="lineno"></span><span class="op" id="8384415">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="8384418">func</span>&nbsp;<span class="op" id="8384423">(</span><span class="ident" id="8384424">db</span>&nbsp;<span class="op" id="8384427">*</span><span class="ident" id="8384428">DB</span><span class="op" id="8384430">)</span>&nbsp;<span class="ident" id="8384432">dumpDep</span><span class="op" id="8384439">(</span><span class="ident" id="8384440">t</span>&nbsp;<span class="op" id="8384442">*</span><span class="ident" id="8384443">testing</span><span class="op" id="8384450">.</span><span class="ident" id="8384451">T</span><span class="op" id="8384452">,</span>&nbsp;<span class="ident" id="8384454">depth</span>&nbsp;<span class="builtintype" id="8384460">int</span><span class="op" id="8384463">,</span>&nbsp;<span class="ident" id="8384465">dep</span>&nbsp;<span class="ident" id="8384469">finalCloser</span><span class="op" id="8384480">,</span>&nbsp;<span class="ident" id="8384482">seen</span>&nbsp;<span class="keyword" id="8384487">map</span><span class="op" id="8384490">[</span><span class="ident" id="8384491">finalCloser</span><span class="op" id="8384502">]</span><span class="builtintype" id="8384503">bool</span><span class="op" id="8384507">)</span>&nbsp;<span class="op" id="8384509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8384512">seen</span><span class="op" id="8384516">[</span><span class="ident" id="8384517">dep</span><span class="op" id="8384520">]</span>&nbsp;<span class="op" id="8384522">=</span>&nbsp;<span class="builtintype" id="8384524">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8384530">indent</span>&nbsp;<span class="op" id="8384537">:=</span>&nbsp;<span class="ident" id="8384540">strings</span><span class="op" id="8384547">.</span><span class="ident" id="8384548">Repeat</span><span class="op" id="8384554">(</span><span class="string" id="8384555">&#34;&nbsp;&nbsp;&#34;</span><span class="op" id="8384559">,</span>&nbsp;<span class="ident" id="8384561">depth</span><span class="op" id="8384566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8384569">ds</span>&nbsp;<span class="op" id="8384572">:=</span>&nbsp;<span class="ident" id="8384575">db</span><span class="op" id="8384577">.</span><span class="ident" id="8384578">dep</span><span class="op" id="8384581">[</span><span class="ident" id="8384582">dep</span><span class="op" id="8384585">]</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8384588">for</span>&nbsp;<span class="ident" id="8384592">k</span>&nbsp;<span class="op" id="8384594">:=</span>&nbsp;<span class="keyword" id="8384597">range</span>&nbsp;<span class="ident" id="8384603">ds</span>&nbsp;<span class="op" id="8384606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8384610">t</span><span class="op" id="8384611">.</span><span class="ident" id="8384612">Logf</span><span class="op" id="8384616">(</span><span class="string" id="8384617">&#34;%s%T&nbsp;(%p)&nbsp;waiting&nbsp;for&nbsp;-&gt;&nbsp;%T&nbsp;(%p)&#34;</span><span class="op" id="8384651">,</span>&nbsp;<span class="ident" id="8384653">indent</span><span class="op" id="8384659">,</span>&nbsp;<span class="ident" id="8384661">dep</span><span class="op" id="8384664">,</span>&nbsp;<span class="ident" id="8384666">dep</span><span class="op" id="8384669">,</span>&nbsp;<span class="ident" id="8384671">k</span><span class="op" id="8384672">,</span>&nbsp;<span class="ident" id="8384674">k</span><span class="op" id="8384675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8384679">if</span>&nbsp;<span class="ident" id="8384682">fc</span><span class="op" id="8384684">,</span>&nbsp;<span class="ident" id="8384686">ok</span>&nbsp;<span class="op" id="8384689">:=</span>&nbsp;<span class="ident" id="8384692">k</span><span class="op" id="8384693">.</span><span class="op" id="8384694">(</span><span class="ident" id="8384695">finalCloser</span><span class="op" id="8384706">)</span><span class="op" id="8384707">;</span>&nbsp;<span class="ident" id="8384709">ok</span>&nbsp;<span class="op" id="8384712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8384717">if</span>&nbsp;<span class="op" id="8384720">!</span><span class="ident" id="8384721">seen</span><span class="op" id="8384725">[</span><span class="ident" id="8384726">fc</span><span class="op" id="8384728">]</span>&nbsp;<span class="op" id="8384730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8384736">db</span><span class="op" id="8384738">.</span><span class="ident" id="8384739">dumpDep</span><span class="op" id="8384746">(</span><span class="ident" id="8384747">t</span><span class="op" id="8384748">,</span>&nbsp;<span class="ident" id="8384750">depth</span><span class="op" id="8384755">+</span><span class="num" id="8384756">1</span><span class="op" id="8384757">,</span>&nbsp;<span class="ident" id="8384759">fc</span><span class="op" id="8384761">,</span>&nbsp;<span class="ident" id="8384763">seen</span><span class="op" id="8384767">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8384772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8384776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8384779">}</span><br>
<span class="lineno"></span><span class="op" id="8384781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="8384784">func</span>&nbsp;<span class="ident" id="8384789">TestQuery</span><span class="op" id="8384798">(</span><span class="ident" id="8384799">t</span>&nbsp;<span class="op" id="8384801">*</span><span class="ident" id="8384802">testing</span><span class="op" id="8384809">.</span><span class="ident" id="8384810">T</span><span class="op" id="8384811">)</span>&nbsp;<span class="op" id="8384813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8384816">db</span>&nbsp;<span class="op" id="8384819">:=</span>&nbsp;<span class="ident" id="8384822">newTestDB</span><span class="op" id="8384831">(</span><span class="ident" id="8384832">t</span><span class="op" id="8384833">,</span>&nbsp;<span class="string" id="8384835">&#34;people&#34;</span><span class="op" id="8384843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8384846">defer</span>&nbsp;<span class="ident" id="8384852">closeDB</span><span class="op" id="8384859">(</span><span class="ident" id="8384860">t</span><span class="op" id="8384861">,</span>&nbsp;<span class="ident" id="8384863">db</span><span class="op" id="8384865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8384868">prepares0</span>&nbsp;<span class="op" id="8384878">:=</span>&nbsp;<span class="ident" id="8384881">numPrepares</span><span class="op" id="8384892">(</span><span class="ident" id="8384893">t</span><span class="op" id="8384894">,</span>&nbsp;<span class="ident" id="8384896">db</span><span class="op" id="8384898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8384901">rows</span><span class="op" id="8384905">,</span>&nbsp;<span class="ident" id="8384907">err</span>&nbsp;<span class="op" id="8384911">:=</span>&nbsp;<span class="ident" id="8384914">db</span><span class="op" id="8384916">.</span><span class="ident" id="8384917">Query</span><span class="op" id="8384922">(</span><span class="string" id="8384923">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8384948">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8384951">if</span>&nbsp;<span class="ident" id="8384954">err</span>&nbsp;<span class="op" id="8384958">!=</span>&nbsp;<span class="ident" id="8384961">nil</span>&nbsp;<span class="op" id="8384965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8384969">t</span><span class="op" id="8384970">.</span><span class="ident" id="8384971">Fatalf</span><span class="op" id="8384977">(</span><span class="string" id="8384978">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="8384989">,</span>&nbsp;<span class="ident" id="8384991">err</span><span class="op" id="8384994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8384997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8385000">type</span>&nbsp;<span class="ident" id="8385005">row</span>&nbsp;<span class="keyword" id="8385009">struct</span>&nbsp;<span class="op" id="8385016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8385020">age</span>&nbsp;&nbsp;<span class="builtintype" id="8385025">int</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8385031">name</span>&nbsp;<span class="builtintype" id="8385036">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8385044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8385047">got</span>&nbsp;<span class="op" id="8385051">:=</span>&nbsp;<span class="op" id="8385054">[</span><span class="op" id="8385055">]</span><span class="ident" id="8385056">row</span><span class="op" id="8385059">{</span><span class="op" id="8385060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8385063">for</span>&nbsp;<span class="ident" id="8385067">rows</span><span class="op" id="8385071">.</span><span class="ident" id="8385072">Next</span><span class="op" id="8385076">(</span><span class="op" id="8385077">)</span>&nbsp;<span class="op" id="8385079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8385083">var</span>&nbsp;<span class="ident" id="8385087">r</span>&nbsp;<span class="ident" id="8385089">row</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8385095">err</span>&nbsp;<span class="op" id="8385099">=</span>&nbsp;<span class="ident" id="8385101">rows</span><span class="op" id="8385105">.</span><span class="ident" id="8385106">Scan</span><span class="op" id="8385110">(</span><span class="op" id="8385111">&amp;</span><span class="ident" id="8385112">r</span><span class="op" id="8385113">.</span><span class="ident" id="8385114">age</span><span class="op" id="8385117">,</span>&nbsp;<span class="op" id="8385119">&amp;</span><span class="ident" id="8385120">r</span><span class="op" id="8385121">.</span><span class="ident" id="8385122">name</span><span class="op" id="8385126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8385130">if</span>&nbsp;<span class="ident" id="8385133">err</span>&nbsp;<span class="op" id="8385137">!=</span>&nbsp;<span class="ident" id="8385140">nil</span>&nbsp;<span class="op" id="8385144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8385149">t</span><span class="op" id="8385150">.</span><span class="ident" id="8385151">Fatalf</span><span class="op" id="8385157">(</span><span class="string" id="8385158">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="8385168">,</span>&nbsp;<span class="ident" id="8385170">err</span><span class="op" id="8385173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8385177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8385181">got</span>&nbsp;<span class="op" id="8385185">=</span>&nbsp;<span class="builtinfunc" id="8385187">append</span><span class="op" id="8385193">(</span><span class="ident" id="8385194">got</span><span class="op" id="8385197">,</span>&nbsp;<span class="ident" id="8385199">r</span><span class="op" id="8385200">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8385203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8385206">err</span>&nbsp;<span class="op" id="8385210">=</span>&nbsp;<span class="ident" id="8385212">rows</span><span class="op" id="8385216">.</span><span class="ident" id="8385217">Err</span><span class="op" id="8385220">(</span><span class="op" id="8385221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8385224">if</span>&nbsp;<span class="ident" id="8385227">err</span>&nbsp;<span class="op" id="8385231">!=</span>&nbsp;<span class="ident" id="8385234">nil</span>&nbsp;<span class="op" id="8385238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8385242">t</span><span class="op" id="8385243">.</span><span class="ident" id="8385244">Fatalf</span><span class="op" id="8385250">(</span><span class="string" id="8385251">&#34;Err:&nbsp;%v&#34;</span><span class="op" id="8385260">,</span>&nbsp;<span class="ident" id="8385262">err</span><span class="op" id="8385265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8385268">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8385271">want</span>&nbsp;<span class="op" id="8385276">:=</span>&nbsp;<span class="op" id="8385279">[</span><span class="op" id="8385280">]</span><span class="ident" id="8385281">row</span><span class="op" id="8385284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8385288">{</span><span class="ident" id="8385289">age</span><span class="op" id="8385292">:</span>&nbsp;<span class="num" id="8385294">1</span><span class="op" id="8385295">,</span>&nbsp;<span class="ident" id="8385297">name</span><span class="op" id="8385301">:</span>&nbsp;<span class="string" id="8385303">&#34;Alice&#34;</span><span class="op" id="8385310">}</span><span class="op" id="8385311">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8385315">{</span><span class="ident" id="8385316">age</span><span class="op" id="8385319">:</span>&nbsp;<span class="num" id="8385321">2</span><span class="op" id="8385322">,</span>&nbsp;<span class="ident" id="8385324">name</span><span class="op" id="8385328">:</span>&nbsp;<span class="string" id="8385330">&#34;Bob&#34;</span><span class="op" id="8385335">}</span><span class="op" id="8385336">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8385340">{</span><span class="ident" id="8385341">age</span><span class="op" id="8385344">:</span>&nbsp;<span class="num" id="8385346">3</span><span class="op" id="8385347">,</span>&nbsp;<span class="ident" id="8385349">name</span><span class="op" id="8385353">:</span>&nbsp;<span class="string" id="8385355">&#34;Chris&#34;</span><span class="op" id="8385362">}</span><span class="op" id="8385363">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8385366">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8385369">if</span>&nbsp;<span class="op" id="8385372">!</span><span class="ident" id="8385373">reflect</span><span class="op" id="8385380">.</span><span class="ident" id="8385381">DeepEqual</span><span class="op" id="8385390">(</span><span class="ident" id="8385391">got</span><span class="op" id="8385394">,</span>&nbsp;<span class="ident" id="8385396">want</span><span class="op" id="8385400">)</span>&nbsp;<span class="op" id="8385402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8385406">t</span><span class="op" id="8385407">.</span><span class="ident" id="8385408">Errorf</span><span class="op" id="8385414">(</span><span class="string" id="8385415">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="8385448">,</span>&nbsp;<span class="ident" id="8385450">got</span><span class="op" id="8385453">,</span>&nbsp;<span class="ident" id="8385455">want</span><span class="op" id="8385459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8385462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8385466">//&nbsp;And&nbsp;verify&nbsp;that&nbsp;the&nbsp;final&nbsp;rows.Next()&nbsp;call,&nbsp;which&nbsp;hit&nbsp;EOF,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8385529">//&nbsp;also&nbsp;closed&nbsp;the&nbsp;rows&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8385566">if</span>&nbsp;<span class="ident" id="8385569">n</span>&nbsp;<span class="op" id="8385571">:=</span>&nbsp;<span class="ident" id="8385574">db</span><span class="op" id="8385576">.</span><span class="ident" id="8385577">numFreeConns</span><span class="op" id="8385589">(</span><span class="op" id="8385590">)</span><span class="op" id="8385591">;</span>&nbsp;<span class="ident" id="8385593">n</span>&nbsp;<span class="op" id="8385595">!=</span>&nbsp;<span class="num" id="8385598">1</span>&nbsp;<span class="op" id="8385600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8385604">t</span><span class="op" id="8385605">.</span><span class="ident" id="8385606">Fatalf</span><span class="op" id="8385612">(</span><span class="string" id="8385613">&#34;free&nbsp;conns&nbsp;after&nbsp;query&nbsp;hitting&nbsp;EOF&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8385662">,</span>&nbsp;<span class="ident" id="8385664">n</span><span class="op" id="8385665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8385668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8385671">if</span>&nbsp;<span class="ident" id="8385674">prepares</span>&nbsp;<span class="op" id="8385683">:=</span>&nbsp;<span class="ident" id="8385686">numPrepares</span><span class="op" id="8385697">(</span><span class="ident" id="8385698">t</span><span class="op" id="8385699">,</span>&nbsp;<span class="ident" id="8385701">db</span><span class="op" id="8385703">)</span>&nbsp;<span class="op" id="8385705">-</span>&nbsp;<span class="ident" id="8385707">prepares0</span><span class="op" id="8385716">;</span>&nbsp;<span class="ident" id="8385718">prepares</span>&nbsp;<span class="op" id="8385727">!=</span>&nbsp;<span class="num" id="8385730">1</span>&nbsp;<span class="op" id="8385732">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8385736">t</span><span class="op" id="8385737">.</span><span class="ident" id="8385738">Errorf</span><span class="op" id="8385744">(</span><span class="string" id="8385745">&#34;executed&nbsp;%d&nbsp;Prepare&nbsp;statements;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8385785">,</span>&nbsp;<span class="ident" id="8385787">prepares</span><span class="op" id="8385795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8385798">}</span><br>
<span class="lineno"></span><span class="op" id="8385800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8385803">func</span>&nbsp;<span class="ident" id="8385808">TestByteOwnership</span><span class="op" id="8385825">(</span><span class="ident" id="8385826">t</span>&nbsp;<span class="op" id="8385828">*</span><span class="ident" id="8385829">testing</span><span class="op" id="8385836">.</span><span class="ident" id="8385837">T</span><span class="op" id="8385838">)</span>&nbsp;<span class="op" id="8385840">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8385843">db</span>&nbsp;<span class="op" id="8385846">:=</span>&nbsp;<span class="ident" id="8385849">newTestDB</span><span class="op" id="8385858">(</span><span class="ident" id="8385859">t</span><span class="op" id="8385860">,</span>&nbsp;<span class="string" id="8385862">&#34;people&#34;</span><span class="op" id="8385870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8385873">defer</span>&nbsp;<span class="ident" id="8385879">closeDB</span><span class="op" id="8385886">(</span><span class="ident" id="8385887">t</span><span class="op" id="8385888">,</span>&nbsp;<span class="ident" id="8385890">db</span><span class="op" id="8385892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8385895">rows</span><span class="op" id="8385899">,</span>&nbsp;<span class="ident" id="8385901">err</span>&nbsp;<span class="op" id="8385905">:=</span>&nbsp;<span class="ident" id="8385908">db</span><span class="op" id="8385910">.</span><span class="ident" id="8385911">Query</span><span class="op" id="8385916">(</span><span class="string" id="8385917">&#34;SELECT|people|name,photo|&#34;</span><span class="op" id="8385944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8385947">if</span>&nbsp;<span class="ident" id="8385950">err</span>&nbsp;<span class="op" id="8385954">!=</span>&nbsp;<span class="ident" id="8385957">nil</span>&nbsp;<span class="op" id="8385961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8385965">t</span><span class="op" id="8385966">.</span><span class="ident" id="8385967">Fatalf</span><span class="op" id="8385973">(</span><span class="string" id="8385974">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="8385985">,</span>&nbsp;<span class="ident" id="8385987">err</span><span class="op" id="8385990">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8385993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8385996">type</span>&nbsp;<span class="ident" id="8386001">row</span>&nbsp;<span class="keyword" id="8386005">struct</span>&nbsp;<span class="op" id="8386012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386016">name</span>&nbsp;&nbsp;<span class="op" id="8386022">[</span><span class="op" id="8386023">]</span><span class="builtintype" id="8386024">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386031">photo</span>&nbsp;<span class="ident" id="8386037">RawBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8386047">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386050">got</span>&nbsp;<span class="op" id="8386054">:=</span>&nbsp;<span class="op" id="8386057">[</span><span class="op" id="8386058">]</span><span class="ident" id="8386059">row</span><span class="op" id="8386062">{</span><span class="op" id="8386063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8386066">for</span>&nbsp;<span class="ident" id="8386070">rows</span><span class="op" id="8386074">.</span><span class="ident" id="8386075">Next</span><span class="op" id="8386079">(</span><span class="op" id="8386080">)</span>&nbsp;<span class="op" id="8386082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8386086">var</span>&nbsp;<span class="ident" id="8386090">r</span>&nbsp;<span class="ident" id="8386092">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386098">err</span>&nbsp;<span class="op" id="8386102">=</span>&nbsp;<span class="ident" id="8386104">rows</span><span class="op" id="8386108">.</span><span class="ident" id="8386109">Scan</span><span class="op" id="8386113">(</span><span class="op" id="8386114">&amp;</span><span class="ident" id="8386115">r</span><span class="op" id="8386116">.</span><span class="ident" id="8386117">name</span><span class="op" id="8386121">,</span>&nbsp;<span class="op" id="8386123">&amp;</span><span class="ident" id="8386124">r</span><span class="op" id="8386125">.</span><span class="ident" id="8386126">photo</span><span class="op" id="8386131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8386135">if</span>&nbsp;<span class="ident" id="8386138">err</span>&nbsp;<span class="op" id="8386142">!=</span>&nbsp;<span class="ident" id="8386145">nil</span>&nbsp;<span class="op" id="8386149">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386154">t</span><span class="op" id="8386155">.</span><span class="ident" id="8386156">Fatalf</span><span class="op" id="8386162">(</span><span class="string" id="8386163">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="8386173">,</span>&nbsp;<span class="ident" id="8386175">err</span><span class="op" id="8386178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8386182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386186">got</span>&nbsp;<span class="op" id="8386190">=</span>&nbsp;<span class="builtinfunc" id="8386192">append</span><span class="op" id="8386198">(</span><span class="ident" id="8386199">got</span><span class="op" id="8386202">,</span>&nbsp;<span class="ident" id="8386204">r</span><span class="op" id="8386205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8386208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386211">corruptMemory</span>&nbsp;<span class="op" id="8386225">:=</span>&nbsp;<span class="op" id="8386228">[</span><span class="op" id="8386229">]</span><span class="builtintype" id="8386230">byte</span><span class="op" id="8386234">(</span><span class="string" id="8386235">&#34;\xffPHOTO&#34;</span><span class="op" id="8386246">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386249">want</span>&nbsp;<span class="op" id="8386254">:=</span>&nbsp;<span class="op" id="8386257">[</span><span class="op" id="8386258">]</span><span class="ident" id="8386259">row</span><span class="op" id="8386262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8386266">{</span><span class="ident" id="8386267">name</span><span class="op" id="8386271">:</span>&nbsp;<span class="op" id="8386273">[</span><span class="op" id="8386274">]</span><span class="builtintype" id="8386275">byte</span><span class="op" id="8386279">(</span><span class="string" id="8386280">&#34;Alice&#34;</span><span class="op" id="8386287">)</span><span class="op" id="8386288">,</span>&nbsp;<span class="ident" id="8386290">photo</span><span class="op" id="8386295">:</span>&nbsp;<span class="ident" id="8386297">corruptMemory</span><span class="op" id="8386310">}</span><span class="op" id="8386311">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8386315">{</span><span class="ident" id="8386316">name</span><span class="op" id="8386320">:</span>&nbsp;<span class="op" id="8386322">[</span><span class="op" id="8386323">]</span><span class="builtintype" id="8386324">byte</span><span class="op" id="8386328">(</span><span class="string" id="8386329">&#34;Bob&#34;</span><span class="op" id="8386334">)</span><span class="op" id="8386335">,</span>&nbsp;<span class="ident" id="8386337">photo</span><span class="op" id="8386342">:</span>&nbsp;<span class="ident" id="8386344">corruptMemory</span><span class="op" id="8386357">}</span><span class="op" id="8386358">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8386362">{</span><span class="ident" id="8386363">name</span><span class="op" id="8386367">:</span>&nbsp;<span class="op" id="8386369">[</span><span class="op" id="8386370">]</span><span class="builtintype" id="8386371">byte</span><span class="op" id="8386375">(</span><span class="string" id="8386376">&#34;Chris&#34;</span><span class="op" id="8386383">)</span><span class="op" id="8386384">,</span>&nbsp;<span class="ident" id="8386386">photo</span><span class="op" id="8386391">:</span>&nbsp;<span class="ident" id="8386393">corruptMemory</span><span class="op" id="8386406">}</span><span class="op" id="8386407">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8386410">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8386413">if</span>&nbsp;<span class="op" id="8386416">!</span><span class="ident" id="8386417">reflect</span><span class="op" id="8386424">.</span><span class="ident" id="8386425">DeepEqual</span><span class="op" id="8386434">(</span><span class="ident" id="8386435">got</span><span class="op" id="8386438">,</span>&nbsp;<span class="ident" id="8386440">want</span><span class="op" id="8386444">)</span>&nbsp;<span class="op" id="8386446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386450">t</span><span class="op" id="8386451">.</span><span class="ident" id="8386452">Errorf</span><span class="op" id="8386458">(</span><span class="string" id="8386459">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="8386492">,</span>&nbsp;<span class="ident" id="8386494">got</span><span class="op" id="8386497">,</span>&nbsp;<span class="ident" id="8386499">want</span><span class="op" id="8386503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8386506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8386510">var</span>&nbsp;<span class="ident" id="8386514">photo</span>&nbsp;<span class="ident" id="8386520">RawBytes</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386530">err</span>&nbsp;<span class="op" id="8386534">=</span>&nbsp;<span class="ident" id="8386536">db</span><span class="op" id="8386538">.</span><span class="ident" id="8386539">QueryRow</span><span class="op" id="8386547">(</span><span class="string" id="8386548">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="8386576">,</span>&nbsp;<span class="string" id="8386578">&#34;Alice&#34;</span><span class="op" id="8386585">)</span><span class="op" id="8386586">.</span><span class="ident" id="8386587">Scan</span><span class="op" id="8386591">(</span><span class="op" id="8386592">&amp;</span><span class="ident" id="8386593">photo</span><span class="op" id="8386598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8386601">if</span>&nbsp;<span class="ident" id="8386604">err</span>&nbsp;<span class="op" id="8386608">==</span>&nbsp;<span class="ident" id="8386611">nil</span>&nbsp;<span class="op" id="8386615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386619">t</span><span class="op" id="8386620">.</span><span class="ident" id="8386621">Error</span><span class="op" id="8386626">(</span><span class="string" id="8386627">&#34;want&nbsp;error&nbsp;scanning&nbsp;into&nbsp;RawBytes&nbsp;from&nbsp;QueryRow&#34;</span><span class="op" id="8386676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8386679">}</span><br>
<span class="lineno"></span><span class="op" id="8386681">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="8386684">func</span>&nbsp;<span class="ident" id="8386689">TestRowsColumns</span><span class="op" id="8386704">(</span><span class="ident" id="8386705">t</span>&nbsp;<span class="op" id="8386707">*</span><span class="ident" id="8386708">testing</span><span class="op" id="8386715">.</span><span class="ident" id="8386716">T</span><span class="op" id="8386717">)</span>&nbsp;<span class="op" id="8386719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386722">db</span>&nbsp;<span class="op" id="8386725">:=</span>&nbsp;<span class="ident" id="8386728">newTestDB</span><span class="op" id="8386737">(</span><span class="ident" id="8386738">t</span><span class="op" id="8386739">,</span>&nbsp;<span class="string" id="8386741">&#34;people&#34;</span><span class="op" id="8386749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8386752">defer</span>&nbsp;<span class="ident" id="8386758">closeDB</span><span class="op" id="8386765">(</span><span class="ident" id="8386766">t</span><span class="op" id="8386767">,</span>&nbsp;<span class="ident" id="8386769">db</span><span class="op" id="8386771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386774">rows</span><span class="op" id="8386778">,</span>&nbsp;<span class="ident" id="8386780">err</span>&nbsp;<span class="op" id="8386784">:=</span>&nbsp;<span class="ident" id="8386787">db</span><span class="op" id="8386789">.</span><span class="ident" id="8386790">Query</span><span class="op" id="8386795">(</span><span class="string" id="8386796">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8386821">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8386824">if</span>&nbsp;<span class="ident" id="8386827">err</span>&nbsp;<span class="op" id="8386831">!=</span>&nbsp;<span class="ident" id="8386834">nil</span>&nbsp;<span class="op" id="8386838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386842">t</span><span class="op" id="8386843">.</span><span class="ident" id="8386844">Fatalf</span><span class="op" id="8386850">(</span><span class="string" id="8386851">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="8386862">,</span>&nbsp;<span class="ident" id="8386864">err</span><span class="op" id="8386867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8386870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386873">cols</span><span class="op" id="8386877">,</span>&nbsp;<span class="ident" id="8386879">err</span>&nbsp;<span class="op" id="8386883">:=</span>&nbsp;<span class="ident" id="8386886">rows</span><span class="op" id="8386890">.</span><span class="ident" id="8386891">Columns</span><span class="op" id="8386898">(</span><span class="op" id="8386899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8386902">if</span>&nbsp;<span class="ident" id="8386905">err</span>&nbsp;<span class="op" id="8386909">!=</span>&nbsp;<span class="ident" id="8386912">nil</span>&nbsp;<span class="op" id="8386916">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386920">t</span><span class="op" id="8386921">.</span><span class="ident" id="8386922">Fatalf</span><span class="op" id="8386928">(</span><span class="string" id="8386929">&#34;Columns:&nbsp;%v&#34;</span><span class="op" id="8386942">,</span>&nbsp;<span class="ident" id="8386944">err</span><span class="op" id="8386947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8386950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8386953">want</span>&nbsp;<span class="op" id="8386958">:=</span>&nbsp;<span class="op" id="8386961">[</span><span class="op" id="8386962">]</span><span class="builtintype" id="8386963">string</span><span class="op" id="8386969">{</span><span class="string" id="8386970">&#34;age&#34;</span><span class="op" id="8386975">,</span>&nbsp;<span class="string" id="8386977">&#34;name&#34;</span><span class="op" id="8386983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8386986">if</span>&nbsp;<span class="op" id="8386989">!</span><span class="ident" id="8386990">reflect</span><span class="op" id="8386997">.</span><span class="ident" id="8386998">DeepEqual</span><span class="op" id="8387007">(</span><span class="ident" id="8387008">cols</span><span class="op" id="8387012">,</span>&nbsp;<span class="ident" id="8387014">want</span><span class="op" id="8387018">)</span>&nbsp;<span class="op" id="8387020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8387024">t</span><span class="op" id="8387025">.</span><span class="ident" id="8387026">Errorf</span><span class="op" id="8387032">(</span><span class="string" id="8387033">&#34;got&nbsp;%#v;&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="8387052">,</span>&nbsp;<span class="ident" id="8387054">cols</span><span class="op" id="8387058">,</span>&nbsp;<span class="ident" id="8387060">want</span><span class="op" id="8387064">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8387067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8387070">if</span>&nbsp;<span class="ident" id="8387073">err</span>&nbsp;<span class="op" id="8387077">:=</span>&nbsp;<span class="ident" id="8387080">rows</span><span class="op" id="8387084">.</span><span class="ident" id="8387085">Close</span><span class="op" id="8387090">(</span><span class="op" id="8387091">)</span><span class="op" id="8387092">;</span>&nbsp;<span class="ident" id="8387094">err</span>&nbsp;<span class="op" id="8387098">!=</span>&nbsp;<span class="ident" id="8387101">nil</span>&nbsp;<span class="op" id="8387105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8387109">t</span><span class="op" id="8387110">.</span><span class="ident" id="8387111">Errorf</span><span class="op" id="8387117">(</span><span class="string" id="8387118">&#34;error&nbsp;closing&nbsp;rows:&nbsp;%s&#34;</span><span class="op" id="8387142">,</span>&nbsp;<span class="ident" id="8387144">err</span><span class="op" id="8387147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8387150">}</span><br>
<span class="lineno"></span><span class="op" id="8387152">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="8387155">func</span>&nbsp;<span class="ident" id="8387160">TestQueryRow</span><span class="op" id="8387172">(</span><span class="ident" id="8387173">t</span>&nbsp;<span class="op" id="8387175">*</span><span class="ident" id="8387176">testing</span><span class="op" id="8387183">.</span><span class="ident" id="8387184">T</span><span class="op" id="8387185">)</span>&nbsp;<span class="op" id="8387187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8387190">db</span>&nbsp;<span class="op" id="8387193">:=</span>&nbsp;<span class="ident" id="8387196">newTestDB</span><span class="op" id="8387205">(</span><span class="ident" id="8387206">t</span><span class="op" id="8387207">,</span>&nbsp;<span class="string" id="8387209">&#34;people&#34;</span><span class="op" id="8387217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8387220">defer</span>&nbsp;<span class="ident" id="8387226">closeDB</span><span class="op" id="8387233">(</span><span class="ident" id="8387234">t</span><span class="op" id="8387235">,</span>&nbsp;<span class="ident" id="8387237">db</span><span class="op" id="8387239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8387242">var</span>&nbsp;<span class="ident" id="8387246">name</span>&nbsp;<span class="builtintype" id="8387251">string</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8387259">var</span>&nbsp;<span class="ident" id="8387263">age</span>&nbsp;<span class="builtintype" id="8387267">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8387272">var</span>&nbsp;<span class="ident" id="8387276">birthday</span>&nbsp;<span class="ident" id="8387285">time</span><span class="op" id="8387289">.</span><span class="ident" id="8387290">Time</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8387297">err</span>&nbsp;<span class="op" id="8387301">:=</span>&nbsp;<span class="ident" id="8387304">db</span><span class="op" id="8387306">.</span><span class="ident" id="8387307">QueryRow</span><span class="op" id="8387315">(</span><span class="string" id="8387316">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="8387346">,</span>&nbsp;<span class="num" id="8387348">3</span><span class="op" id="8387349">)</span><span class="op" id="8387350">.</span><span class="ident" id="8387351">Scan</span><span class="op" id="8387355">(</span><span class="op" id="8387356">&amp;</span><span class="ident" id="8387357">age</span><span class="op" id="8387360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8387363">if</span>&nbsp;<span class="ident" id="8387366">err</span>&nbsp;<span class="op" id="8387370">==</span>&nbsp;<span class="ident" id="8387373">nil</span>&nbsp;<span class="op" id="8387377">||</span>&nbsp;<span class="op" id="8387380">!</span><span class="ident" id="8387381">strings</span><span class="op" id="8387388">.</span><span class="ident" id="8387389">Contains</span><span class="op" id="8387397">(</span><span class="ident" id="8387398">err</span><span class="op" id="8387401">.</span><span class="ident" id="8387402">Error</span><span class="op" id="8387407">(</span><span class="op" id="8387408">)</span><span class="op" id="8387409">,</span>&nbsp;<span class="string" id="8387411">&#34;expected&nbsp;2&nbsp;destination&nbsp;arguments&#34;</span><span class="op" id="8387445">)</span>&nbsp;<span class="op" id="8387447">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8387451">t</span><span class="op" id="8387452">.</span><span class="ident" id="8387453">Errorf</span><span class="op" id="8387459">(</span><span class="string" id="8387460">&#34;expected&nbsp;error&nbsp;from&nbsp;wrong&nbsp;number&nbsp;of&nbsp;arguments;&nbsp;actually&nbsp;got:&nbsp;%v&#34;</span><span class="op" id="8387525">,</span>&nbsp;<span class="ident" id="8387527">err</span><span class="op" id="8387530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8387533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8387537">err</span>&nbsp;<span class="op" id="8387541">=</span>&nbsp;<span class="ident" id="8387543">db</span><span class="op" id="8387545">.</span><span class="ident" id="8387546">QueryRow</span><span class="op" id="8387554">(</span><span class="string" id="8387555">&#34;SELECT|people|bdate|age=?&#34;</span><span class="op" id="8387582">,</span>&nbsp;<span class="num" id="8387584">3</span><span class="op" id="8387585">)</span><span class="op" id="8387586">.</span><span class="ident" id="8387587">Scan</span><span class="op" id="8387591">(</span><span class="op" id="8387592">&amp;</span><span class="ident" id="8387593">birthday</span><span class="op" id="8387601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8387604">if</span>&nbsp;<span class="ident" id="8387607">err</span>&nbsp;<span class="op" id="8387611">!=</span>&nbsp;<span class="ident" id="8387614">nil</span>&nbsp;<span class="op" id="8387618">||</span>&nbsp;<span class="op" id="8387621">!</span><span class="ident" id="8387622">birthday</span><span class="op" id="8387630">.</span><span class="ident" id="8387631">Equal</span><span class="op" id="8387636">(</span><span class="ident" id="8387637">chrisBirthday</span><span class="op" id="8387650">)</span>&nbsp;<span class="op" id="8387652">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8387656">t</span><span class="op" id="8387657">.</span><span class="ident" id="8387658">Errorf</span><span class="op" id="8387664">(</span><span class="string" id="8387665">&#34;chris&nbsp;birthday&nbsp;=&nbsp;%v,&nbsp;err&nbsp;=&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8387705">,</span>&nbsp;<span class="ident" id="8387707">birthday</span><span class="op" id="8387715">,</span>&nbsp;<span class="ident" id="8387717">err</span><span class="op" id="8387720">,</span>&nbsp;<span class="ident" id="8387722">chrisBirthday</span><span class="op" id="8387735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8387738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8387742">err</span>&nbsp;<span class="op" id="8387746">=</span>&nbsp;<span class="ident" id="8387748">db</span><span class="op" id="8387750">.</span><span class="ident" id="8387751">QueryRow</span><span class="op" id="8387759">(</span><span class="string" id="8387760">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="8387790">,</span>&nbsp;<span class="num" id="8387792">2</span><span class="op" id="8387793">)</span><span class="op" id="8387794">.</span><span class="ident" id="8387795">Scan</span><span class="op" id="8387799">(</span><span class="op" id="8387800">&amp;</span><span class="ident" id="8387801">age</span><span class="op" id="8387804">,</span>&nbsp;<span class="op" id="8387806">&amp;</span><span class="ident" id="8387807">name</span><span class="op" id="8387811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8387814">if</span>&nbsp;<span class="ident" id="8387817">err</span>&nbsp;<span class="op" id="8387821">!=</span>&nbsp;<span class="ident" id="8387824">nil</span>&nbsp;<span class="op" id="8387828">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8387832">t</span><span class="op" id="8387833">.</span><span class="ident" id="8387834">Fatalf</span><span class="op" id="8387840">(</span><span class="string" id="8387841">&#34;age&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="8387864">,</span>&nbsp;<span class="ident" id="8387866">err</span><span class="op" id="8387869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8387872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8387875">if</span>&nbsp;<span class="ident" id="8387878">name</span>&nbsp;<span class="op" id="8387883">!=</span>&nbsp;<span class="string" id="8387886">&#34;Bob&#34;</span>&nbsp;<span class="op" id="8387892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8387896">t</span><span class="op" id="8387897">.</span><span class="ident" id="8387898">Errorf</span><span class="op" id="8387904">(</span><span class="string" id="8387905">&#34;expected&nbsp;name&nbsp;Bob,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8387932">,</span>&nbsp;<span class="ident" id="8387934">name</span><span class="op" id="8387938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8387941">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8387944">if</span>&nbsp;<span class="ident" id="8387947">age</span>&nbsp;<span class="op" id="8387951">!=</span>&nbsp;<span class="num" id="8387954">2</span>&nbsp;<span class="op" id="8387956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8387960">t</span><span class="op" id="8387961">.</span><span class="ident" id="8387962">Errorf</span><span class="op" id="8387968">(</span><span class="string" id="8387969">&#34;expected&nbsp;age&nbsp;2,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8387993">,</span>&nbsp;<span class="ident" id="8387995">age</span><span class="op" id="8387998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8388001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8388005">err</span>&nbsp;<span class="op" id="8388009">=</span>&nbsp;<span class="ident" id="8388011">db</span><span class="op" id="8388013">.</span><span class="ident" id="8388014">QueryRow</span><span class="op" id="8388022">(</span><span class="string" id="8388023">&#34;SELECT|people|age,name|name=?&#34;</span><span class="op" id="8388054">,</span>&nbsp;<span class="string" id="8388056">&#34;Alice&#34;</span><span class="op" id="8388063">)</span><span class="op" id="8388064">.</span><span class="ident" id="8388065">Scan</span><span class="op" id="8388069">(</span><span class="op" id="8388070">&amp;</span><span class="ident" id="8388071">age</span><span class="op" id="8388074">,</span>&nbsp;<span class="op" id="8388076">&amp;</span><span class="ident" id="8388077">name</span><span class="op" id="8388081">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8388084">if</span>&nbsp;<span class="ident" id="8388087">err</span>&nbsp;<span class="op" id="8388091">!=</span>&nbsp;<span class="ident" id="8388094">nil</span>&nbsp;<span class="op" id="8388098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8388102">t</span><span class="op" id="8388103">.</span><span class="ident" id="8388104">Fatalf</span><span class="op" id="8388110">(</span><span class="string" id="8388111">&#34;name&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="8388135">,</span>&nbsp;<span class="ident" id="8388137">err</span><span class="op" id="8388140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8388143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8388146">if</span>&nbsp;<span class="ident" id="8388149">name</span>&nbsp;<span class="op" id="8388154">!=</span>&nbsp;<span class="string" id="8388157">&#34;Alice&#34;</span>&nbsp;<span class="op" id="8388165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8388169">t</span><span class="op" id="8388170">.</span><span class="ident" id="8388171">Errorf</span><span class="op" id="8388177">(</span><span class="string" id="8388178">&#34;expected&nbsp;name&nbsp;Alice,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8388207">,</span>&nbsp;<span class="ident" id="8388209">name</span><span class="op" id="8388213">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8388216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8388219">if</span>&nbsp;<span class="ident" id="8388222">age</span>&nbsp;<span class="op" id="8388226">!=</span>&nbsp;<span class="num" id="8388229">1</span>&nbsp;<span class="op" id="8388231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8388235">t</span><span class="op" id="8388236">.</span><span class="ident" id="8388237">Errorf</span><span class="op" id="8388243">(</span><span class="string" id="8388244">&#34;expected&nbsp;age&nbsp;1,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8388268">,</span>&nbsp;<span class="ident" id="8388270">age</span><span class="op" id="8388273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8388276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8388280">var</span>&nbsp;<span class="ident" id="8388284">photo</span>&nbsp;<span class="op" id="8388290">[</span><span class="op" id="8388291">]</span><span class="builtintype" id="8388292">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8388298">err</span>&nbsp;<span class="op" id="8388302">=</span>&nbsp;<span class="ident" id="8388304">db</span><span class="op" id="8388306">.</span><span class="ident" id="8388307">QueryRow</span><span class="op" id="8388315">(</span><span class="string" id="8388316">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="8388344">,</span>&nbsp;<span class="string" id="8388346">&#34;Alice&#34;</span><span class="op" id="8388353">)</span><span class="op" id="8388354">.</span><span class="ident" id="8388355">Scan</span><span class="op" id="8388359">(</span><span class="op" id="8388360">&amp;</span><span class="ident" id="8388361">photo</span><span class="op" id="8388366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8388369">if</span>&nbsp;<span class="ident" id="8388372">err</span>&nbsp;<span class="op" id="8388376">!=</span>&nbsp;<span class="ident" id="8388379">nil</span>&nbsp;<span class="op" id="8388383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8388387">t</span><span class="op" id="8388388">.</span><span class="ident" id="8388389">Fatalf</span><span class="op" id="8388395">(</span><span class="string" id="8388396">&#34;photo&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="8388421">,</span>&nbsp;<span class="ident" id="8388423">err</span><span class="op" id="8388426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8388429">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8388432">want</span>&nbsp;<span class="op" id="8388437">:=</span>&nbsp;<span class="op" id="8388440">[</span><span class="op" id="8388441">]</span><span class="builtintype" id="8388442">byte</span><span class="op" id="8388446">(</span><span class="string" id="8388447">&#34;APHOTO&#34;</span><span class="op" id="8388455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8388458">if</span>&nbsp;<span class="op" id="8388461">!</span><span class="ident" id="8388462">reflect</span><span class="op" id="8388469">.</span><span class="ident" id="8388470">DeepEqual</span><span class="op" id="8388479">(</span><span class="ident" id="8388480">photo</span><span class="op" id="8388485">,</span>&nbsp;<span class="ident" id="8388487">want</span><span class="op" id="8388491">)</span>&nbsp;<span class="op" id="8388493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8388497">t</span><span class="op" id="8388498">.</span><span class="ident" id="8388499">Errorf</span><span class="op" id="8388505">(</span><span class="string" id="8388506">&#34;photo&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8388527">,</span>&nbsp;<span class="ident" id="8388529">photo</span><span class="op" id="8388534">,</span>&nbsp;<span class="ident" id="8388536">want</span><span class="op" id="8388540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8388543">}</span><br>
<span class="lineno"></span><span class="op" id="8388545">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="8388548">func</span>&nbsp;<span class="ident" id="8388553">TestStatementErrorAfterClose</span><span class="op" id="8388581">(</span><span class="ident" id="8388582">t</span>&nbsp;<span class="op" id="8388584">*</span><span class="ident" id="8388585">testing</span><span class="op" id="8388592">.</span><span class="ident" id="8388593">T</span><span class="op" id="8388594">)</span>&nbsp;<span class="op" id="8388596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8388599">db</span>&nbsp;<span class="op" id="8388602">:=</span>&nbsp;<span class="ident" id="8388605">newTestDB</span><span class="op" id="8388614">(</span><span class="ident" id="8388615">t</span><span class="op" id="8388616">,</span>&nbsp;<span class="string" id="8388618">&#34;people&#34;</span><span class="op" id="8388626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8388629">defer</span>&nbsp;<span class="ident" id="8388635">closeDB</span><span class="op" id="8388642">(</span><span class="ident" id="8388643">t</span><span class="op" id="8388644">,</span>&nbsp;<span class="ident" id="8388646">db</span><span class="op" id="8388648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8388651">stmt</span><span class="op" id="8388655">,</span>&nbsp;<span class="ident" id="8388657">err</span>&nbsp;<span class="op" id="8388661">:=</span>&nbsp;<span class="ident" id="8388664">db</span><span class="op" id="8388666">.</span><span class="ident" id="8388667">Prepare</span><span class="op" id="8388674">(</span><span class="string" id="8388675">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="8388701">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8388704">if</span>&nbsp;<span class="ident" id="8388707">err</span>&nbsp;<span class="op" id="8388711">!=</span>&nbsp;<span class="ident" id="8388714">nil</span>&nbsp;<span class="op" id="8388718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8388722">t</span><span class="op" id="8388723">.</span><span class="ident" id="8388724">Fatalf</span><span class="op" id="8388730">(</span><span class="string" id="8388731">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="8388744">,</span>&nbsp;<span class="ident" id="8388746">err</span><span class="op" id="8388749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8388752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8388755">err</span>&nbsp;<span class="op" id="8388759">=</span>&nbsp;<span class="ident" id="8388761">stmt</span><span class="op" id="8388765">.</span><span class="ident" id="8388766">Close</span><span class="op" id="8388771">(</span><span class="op" id="8388772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8388775">if</span>&nbsp;<span class="ident" id="8388778">err</span>&nbsp;<span class="op" id="8388782">!=</span>&nbsp;<span class="ident" id="8388785">nil</span>&nbsp;<span class="op" id="8388789">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8388793">t</span><span class="op" id="8388794">.</span><span class="ident" id="8388795">Fatalf</span><span class="op" id="8388801">(</span><span class="string" id="8388802">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="8388813">,</span>&nbsp;<span class="ident" id="8388815">err</span><span class="op" id="8388818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8388821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8388824">var</span>&nbsp;<span class="ident" id="8388828">name</span>&nbsp;<span class="builtintype" id="8388833">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8388841">err</span>&nbsp;<span class="op" id="8388845">=</span>&nbsp;<span class="ident" id="8388847">stmt</span><span class="op" id="8388851">.</span><span class="ident" id="8388852">QueryRow</span><span class="op" id="8388860">(</span><span class="string" id="8388861">&#34;foo&#34;</span><span class="op" id="8388866">)</span><span class="op" id="8388867">.</span><span class="ident" id="8388868">Scan</span><span class="op" id="8388872">(</span><span class="op" id="8388873">&amp;</span><span class="ident" id="8388874">name</span><span class="op" id="8388878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8388881">if</span>&nbsp;<span class="ident" id="8388884">err</span>&nbsp;<span class="op" id="8388888">==</span>&nbsp;<span class="ident" id="8388891">nil</span>&nbsp;<span class="op" id="8388895">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8388899">t</span><span class="op" id="8388900">.</span><span class="ident" id="8388901">Errorf</span><span class="op" id="8388907">(</span><span class="string" id="8388908">&#34;expected&nbsp;error&nbsp;from&nbsp;QueryRow.Scan&nbsp;after&nbsp;Stmt.Close&#34;</span><span class="op" id="8388960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8388963">}</span><br>
<span class="lineno"></span><span class="op" id="8388965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8388968">func</span>&nbsp;<span class="ident" id="8388973">TestStatementQueryRow</span><span class="op" id="8388994">(</span><span class="ident" id="8388995">t</span>&nbsp;<span class="op" id="8388997">*</span><span class="ident" id="8388998">testing</span><span class="op" id="8389005">.</span><span class="ident" id="8389006">T</span><span class="op" id="8389007">)</span>&nbsp;<span class="op" id="8389009">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8389012">db</span>&nbsp;<span class="op" id="8389015">:=</span>&nbsp;<span class="ident" id="8389018">newTestDB</span><span class="op" id="8389027">(</span><span class="ident" id="8389028">t</span><span class="op" id="8389029">,</span>&nbsp;<span class="string" id="8389031">&#34;people&#34;</span><span class="op" id="8389039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8389042">defer</span>&nbsp;<span class="ident" id="8389048">closeDB</span><span class="op" id="8389055">(</span><span class="ident" id="8389056">t</span><span class="op" id="8389057">,</span>&nbsp;<span class="ident" id="8389059">db</span><span class="op" id="8389061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8389064">stmt</span><span class="op" id="8389068">,</span>&nbsp;<span class="ident" id="8389070">err</span>&nbsp;<span class="op" id="8389074">:=</span>&nbsp;<span class="ident" id="8389077">db</span><span class="op" id="8389079">.</span><span class="ident" id="8389080">Prepare</span><span class="op" id="8389087">(</span><span class="string" id="8389088">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="8389114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8389117">if</span>&nbsp;<span class="ident" id="8389120">err</span>&nbsp;<span class="op" id="8389124">!=</span>&nbsp;<span class="ident" id="8389127">nil</span>&nbsp;<span class="op" id="8389131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8389135">t</span><span class="op" id="8389136">.</span><span class="ident" id="8389137">Fatalf</span><span class="op" id="8389143">(</span><span class="string" id="8389144">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="8389157">,</span>&nbsp;<span class="ident" id="8389159">err</span><span class="op" id="8389162">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8389165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8389168">defer</span>&nbsp;<span class="ident" id="8389174">stmt</span><span class="op" id="8389178">.</span><span class="ident" id="8389179">Close</span><span class="op" id="8389184">(</span><span class="op" id="8389185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8389188">var</span>&nbsp;<span class="ident" id="8389192">age</span>&nbsp;<span class="builtintype" id="8389196">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8389201">for</span>&nbsp;<span class="ident" id="8389205">n</span><span class="op" id="8389206">,</span>&nbsp;<span class="ident" id="8389208">tt</span>&nbsp;<span class="op" id="8389211">:=</span>&nbsp;<span class="keyword" id="8389214">range</span>&nbsp;<span class="op" id="8389220">[</span><span class="op" id="8389221">]</span><span class="keyword" id="8389222">struct</span>&nbsp;<span class="op" id="8389229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8389233">name</span>&nbsp;<span class="builtintype" id="8389238">string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8389247">want</span>&nbsp;<span class="builtintype" id="8389252">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8389257">}</span><span class="op" id="8389258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8389262">{</span><span class="string" id="8389263">&#34;Alice&#34;</span><span class="op" id="8389270">,</span>&nbsp;<span class="num" id="8389272">1</span><span class="op" id="8389273">}</span><span class="op" id="8389274">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8389278">{</span><span class="string" id="8389279">&#34;Bob&#34;</span><span class="op" id="8389284">,</span>&nbsp;<span class="num" id="8389286">2</span><span class="op" id="8389287">}</span><span class="op" id="8389288">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8389292">{</span><span class="string" id="8389293">&#34;Chris&#34;</span><span class="op" id="8389300">,</span>&nbsp;<span class="num" id="8389302">3</span><span class="op" id="8389303">}</span><span class="op" id="8389304">,</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8389307">}</span>&nbsp;<span class="op" id="8389309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8389313">if</span>&nbsp;<span class="ident" id="8389316">err</span>&nbsp;<span class="op" id="8389320">:=</span>&nbsp;<span class="ident" id="8389323">stmt</span><span class="op" id="8389327">.</span><span class="ident" id="8389328">QueryRow</span><span class="op" id="8389336">(</span><span class="ident" id="8389337">tt</span><span class="op" id="8389339">.</span><span class="ident" id="8389340">name</span><span class="op" id="8389344">)</span><span class="op" id="8389345">.</span><span class="ident" id="8389346">Scan</span><span class="op" id="8389350">(</span><span class="op" id="8389351">&amp;</span><span class="ident" id="8389352">age</span><span class="op" id="8389355">)</span><span class="op" id="8389356">;</span>&nbsp;<span class="ident" id="8389358">err</span>&nbsp;<span class="op" id="8389362">!=</span>&nbsp;<span class="ident" id="8389365">nil</span>&nbsp;<span class="op" id="8389369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8389374">t</span><span class="op" id="8389375">.</span><span class="ident" id="8389376">Errorf</span><span class="op" id="8389382">(</span><span class="string" id="8389383">&#34;%d:&nbsp;on&nbsp;%q,&nbsp;QueryRow/Scan:&nbsp;%v&#34;</span><span class="op" id="8389413">,</span>&nbsp;<span class="ident" id="8389415">n</span><span class="op" id="8389416">,</span>&nbsp;<span class="ident" id="8389418">tt</span><span class="op" id="8389420">.</span><span class="ident" id="8389421">name</span><span class="op" id="8389425">,</span>&nbsp;<span class="ident" id="8389427">err</span><span class="op" id="8389430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8389434">}</span>&nbsp;<span class="keyword" id="8389436">else</span>&nbsp;<span class="keyword" id="8389441">if</span>&nbsp;<span class="ident" id="8389444">age</span>&nbsp;<span class="op" id="8389448">!=</span>&nbsp;<span class="ident" id="8389451">tt</span><span class="op" id="8389453">.</span><span class="ident" id="8389454">want</span>&nbsp;<span class="op" id="8389459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8389464">t</span><span class="op" id="8389465">.</span><span class="ident" id="8389466">Errorf</span><span class="op" id="8389472">(</span><span class="string" id="8389473">&#34;%d:&nbsp;age=%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8389494">,</span>&nbsp;<span class="ident" id="8389496">n</span><span class="op" id="8389497">,</span>&nbsp;<span class="ident" id="8389499">age</span><span class="op" id="8389502">,</span>&nbsp;<span class="ident" id="8389504">tt</span><span class="op" id="8389506">.</span><span class="ident" id="8389507">want</span><span class="op" id="8389511">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8389515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8389518">}</span><br>
<span class="lineno"></span><span class="op" id="8389520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8389523">//&nbsp;golang.org/issue/3734</span><br>
<span class="lineno">360</span><span class="keyword" id="8389548">func</span>&nbsp;<span class="ident" id="8389553">TestStatementQueryRowConcurrent</span><span class="op" id="8389584">(</span><span class="ident" id="8389585">t</span>&nbsp;<span class="op" id="8389587">*</span><span class="ident" id="8389588">testing</span><span class="op" id="8389595">.</span><span class="ident" id="8389596">T</span><span class="op" id="8389597">)</span>&nbsp;<span class="op" id="8389599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8389602">db</span>&nbsp;<span class="op" id="8389605">:=</span>&nbsp;<span class="ident" id="8389608">newTestDB</span><span class="op" id="8389617">(</span><span class="ident" id="8389618">t</span><span class="op" id="8389619">,</span>&nbsp;<span class="string" id="8389621">&#34;people&#34;</span><span class="op" id="8389629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8389632">defer</span>&nbsp;<span class="ident" id="8389638">closeDB</span><span class="op" id="8389645">(</span><span class="ident" id="8389646">t</span><span class="op" id="8389647">,</span>&nbsp;<span class="ident" id="8389649">db</span><span class="op" id="8389651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8389654">stmt</span><span class="op" id="8389658">,</span>&nbsp;<span class="ident" id="8389660">err</span>&nbsp;<span class="op" id="8389664">:=</span>&nbsp;<span class="ident" id="8389667">db</span><span class="op" id="8389669">.</span><span class="ident" id="8389670">Prepare</span><span class="op" id="8389677">(</span><span class="string" id="8389678">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="8389704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8389707">if</span>&nbsp;<span class="ident" id="8389710">err</span>&nbsp;<span class="op" id="8389714">!=</span>&nbsp;<span class="ident" id="8389717">nil</span>&nbsp;<span class="op" id="8389721">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8389725">t</span><span class="op" id="8389726">.</span><span class="ident" id="8389727">Fatalf</span><span class="op" id="8389733">(</span><span class="string" id="8389734">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="8389747">,</span>&nbsp;<span class="ident" id="8389749">err</span><span class="op" id="8389752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8389755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8389758">defer</span>&nbsp;<span class="ident" id="8389764">stmt</span><span class="op" id="8389768">.</span><span class="ident" id="8389769">Close</span><span class="op" id="8389774">(</span><span class="op" id="8389775">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8389779">const</span>&nbsp;<span class="ident" id="8389785">n</span>&nbsp;<span class="op" id="8389787">=</span>&nbsp;<span class="num" id="8389789">10</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8389793">ch</span>&nbsp;<span class="op" id="8389796">:=</span>&nbsp;<span class="builtinfunc" id="8389799">make</span><span class="op" id="8389803">(</span><span class="keyword" id="8389804">chan</span>&nbsp;<span class="builtintype" id="8389809">error</span><span class="op" id="8389814">,</span>&nbsp;<span class="ident" id="8389816">n</span><span class="op" id="8389817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8389820">for</span>&nbsp;<span class="ident" id="8389824">i</span>&nbsp;<span class="op" id="8389826">:=</span>&nbsp;<span class="num" id="8389829">0</span><span class="op" id="8389830">;</span>&nbsp;<span class="ident" id="8389832">i</span>&nbsp;<span class="op" id="8389834">&lt;</span>&nbsp;<span class="ident" id="8389836">n</span><span class="op" id="8389837">;</span>&nbsp;<span class="ident" id="8389839">i</span><span class="op" id="8389840">++</span>&nbsp;<span class="op" id="8389843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8389847">go</span>&nbsp;<span class="keyword" id="8389850">func</span><span class="op" id="8389854">(</span><span class="op" id="8389855">)</span>&nbsp;<span class="op" id="8389857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8389862">var</span>&nbsp;<span class="ident" id="8389866">age</span>&nbsp;<span class="builtintype" id="8389870">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8389877">err</span>&nbsp;<span class="op" id="8389881">:=</span>&nbsp;<span class="ident" id="8389884">stmt</span><span class="op" id="8389888">.</span><span class="ident" id="8389889">QueryRow</span><span class="op" id="8389897">(</span><span class="string" id="8389898">&#34;Alice&#34;</span><span class="op" id="8389905">)</span><span class="op" id="8389906">.</span><span class="ident" id="8389907">Scan</span><span class="op" id="8389911">(</span><span class="op" id="8389912">&amp;</span><span class="ident" id="8389913">age</span><span class="op" id="8389916">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8389921">if</span>&nbsp;<span class="ident" id="8389924">err</span>&nbsp;<span class="op" id="8389928">==</span>&nbsp;<span class="ident" id="8389931">nil</span>&nbsp;<span class="op" id="8389935">&amp;&amp;</span>&nbsp;<span class="ident" id="8389938">age</span>&nbsp;<span class="op" id="8389942">!=</span>&nbsp;<span class="num" id="8389945">1</span>&nbsp;<span class="op" id="8389947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8389953">err</span>&nbsp;<span class="op" id="8389957">=</span>&nbsp;<span class="ident" id="8389959">fmt</span><span class="op" id="8389962">.</span><span class="ident" id="8389963">Errorf</span><span class="op" id="8389969">(</span><span class="string" id="8389970">&#34;unexpected&nbsp;age&nbsp;%d&#34;</span><span class="op" id="8389989">,</span>&nbsp;<span class="ident" id="8389991">age</span><span class="op" id="8389994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8389999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8390004">ch</span>&nbsp;<span class="op" id="8390007">&lt;-</span>&nbsp;<span class="ident" id="8390010">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8390016">}</span><span class="op" id="8390017">(</span><span class="op" id="8390018">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8390021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8390024">for</span>&nbsp;<span class="ident" id="8390028">i</span>&nbsp;<span class="op" id="8390030">:=</span>&nbsp;<span class="num" id="8390033">0</span><span class="op" id="8390034">;</span>&nbsp;<span class="ident" id="8390036">i</span>&nbsp;<span class="op" id="8390038">&lt;</span>&nbsp;<span class="ident" id="8390040">n</span><span class="op" id="8390041">;</span>&nbsp;<span class="ident" id="8390043">i</span><span class="op" id="8390044">++</span>&nbsp;<span class="op" id="8390047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8390051">if</span>&nbsp;<span class="ident" id="8390054">err</span>&nbsp;<span class="op" id="8390058">:=</span>&nbsp;<span class="op" id="8390061">&lt;-</span><span class="ident" id="8390063">ch</span><span class="op" id="8390065">;</span>&nbsp;<span class="ident" id="8390067">err</span>&nbsp;<span class="op" id="8390071">!=</span>&nbsp;<span class="ident" id="8390074">nil</span>&nbsp;<span class="op" id="8390078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8390083">t</span><span class="op" id="8390084">.</span><span class="ident" id="8390085">Error</span><span class="op" id="8390090">(</span><span class="ident" id="8390091">err</span><span class="op" id="8390094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8390098">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8390101">}</span><br>
<span class="lineno"></span><span class="op" id="8390103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8390106">//&nbsp;just&nbsp;a&nbsp;test&nbsp;of&nbsp;fakedb&nbsp;itself</span><br>
<span class="lineno"></span><span class="keyword" id="8390138">func</span>&nbsp;<span class="ident" id="8390143">TestBogusPreboundParameters</span><span class="op" id="8390170">(</span><span class="ident" id="8390171">t</span>&nbsp;<span class="op" id="8390173">*</span><span class="ident" id="8390174">testing</span><span class="op" id="8390181">.</span><span class="ident" id="8390182">T</span><span class="op" id="8390183">)</span>&nbsp;<span class="op" id="8390185">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8390188">db</span>&nbsp;<span class="op" id="8390191">:=</span>&nbsp;<span class="ident" id="8390194">newTestDB</span><span class="op" id="8390203">(</span><span class="ident" id="8390204">t</span><span class="op" id="8390205">,</span>&nbsp;<span class="string" id="8390207">&#34;foo&#34;</span><span class="op" id="8390212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8390215">defer</span>&nbsp;<span class="ident" id="8390221">closeDB</span><span class="op" id="8390228">(</span><span class="ident" id="8390229">t</span><span class="op" id="8390230">,</span>&nbsp;<span class="ident" id="8390232">db</span><span class="op" id="8390234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8390237">exec</span><span class="op" id="8390241">(</span><span class="ident" id="8390242">t</span><span class="op" id="8390243">,</span>&nbsp;<span class="ident" id="8390245">db</span><span class="op" id="8390247">,</span>&nbsp;<span class="string" id="8390249">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8390292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8390295">_</span><span class="op" id="8390296">,</span>&nbsp;<span class="ident" id="8390298">err</span>&nbsp;<span class="op" id="8390302">:=</span>&nbsp;<span class="ident" id="8390305">db</span><span class="op" id="8390307">.</span><span class="ident" id="8390308">Prepare</span><span class="op" id="8390315">(</span><span class="string" id="8390316">&#34;INSERT|t1|name=?,age=bogusconversion&#34;</span><span class="op" id="8390354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8390357">if</span>&nbsp;<span class="ident" id="8390360">err</span>&nbsp;<span class="op" id="8390364">==</span>&nbsp;<span class="ident" id="8390367">nil</span>&nbsp;<span class="op" id="8390371">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8390375">t</span><span class="op" id="8390376">.</span><span class="ident" id="8390377">Fatalf</span><span class="op" id="8390383">(</span><span class="string" id="8390384">&#34;expected&nbsp;error&#34;</span><span class="op" id="8390400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8390403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8390406">if</span>&nbsp;<span class="ident" id="8390409">err</span><span class="op" id="8390412">.</span><span class="ident" id="8390413">Error</span><span class="op" id="8390418">(</span><span class="op" id="8390419">)</span>&nbsp;<span class="op" id="8390421">!=</span>&nbsp;<span class="string" id="8390424">`fakedb:&nbsp;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;&#34;bogusconversion&#34;`</span>&nbsp;<span class="op" id="8390485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8390489">t</span><span class="op" id="8390490">.</span><span class="ident" id="8390491">Errorf</span><span class="op" id="8390497">(</span><span class="string" id="8390498">&#34;unexpected&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8390520">,</span>&nbsp;<span class="ident" id="8390522">err</span><span class="op" id="8390525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8390528">}</span><br>
<span class="lineno">400</span><span class="op" id="8390530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8390533">func</span>&nbsp;<span class="ident" id="8390538">TestExec</span><span class="op" id="8390546">(</span><span class="ident" id="8390547">t</span>&nbsp;<span class="op" id="8390549">*</span><span class="ident" id="8390550">testing</span><span class="op" id="8390557">.</span><span class="ident" id="8390558">T</span><span class="op" id="8390559">)</span>&nbsp;<span class="op" id="8390561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8390564">db</span>&nbsp;<span class="op" id="8390567">:=</span>&nbsp;<span class="ident" id="8390570">newTestDB</span><span class="op" id="8390579">(</span><span class="ident" id="8390580">t</span><span class="op" id="8390581">,</span>&nbsp;<span class="string" id="8390583">&#34;foo&#34;</span><span class="op" id="8390588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8390591">defer</span>&nbsp;<span class="ident" id="8390597">closeDB</span><span class="op" id="8390604">(</span><span class="ident" id="8390605">t</span><span class="op" id="8390606">,</span>&nbsp;<span class="ident" id="8390608">db</span><span class="op" id="8390610">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8390613">exec</span><span class="op" id="8390617">(</span><span class="ident" id="8390618">t</span><span class="op" id="8390619">,</span>&nbsp;<span class="ident" id="8390621">db</span><span class="op" id="8390623">,</span>&nbsp;<span class="string" id="8390625">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8390668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8390671">stmt</span><span class="op" id="8390675">,</span>&nbsp;<span class="ident" id="8390677">err</span>&nbsp;<span class="op" id="8390681">:=</span>&nbsp;<span class="ident" id="8390684">db</span><span class="op" id="8390686">.</span><span class="ident" id="8390687">Prepare</span><span class="op" id="8390694">(</span><span class="string" id="8390695">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="8390719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8390722">if</span>&nbsp;<span class="ident" id="8390725">err</span>&nbsp;<span class="op" id="8390729">!=</span>&nbsp;<span class="ident" id="8390732">nil</span>&nbsp;<span class="op" id="8390736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8390740">t</span><span class="op" id="8390741">.</span><span class="ident" id="8390742">Errorf</span><span class="op" id="8390748">(</span><span class="string" id="8390749">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8390769">,</span>&nbsp;<span class="ident" id="8390771">stmt</span><span class="op" id="8390775">,</span>&nbsp;<span class="ident" id="8390777">err</span><span class="op" id="8390780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8390783">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8390786">defer</span>&nbsp;<span class="ident" id="8390792">stmt</span><span class="op" id="8390796">.</span><span class="ident" id="8390797">Close</span><span class="op" id="8390802">(</span><span class="op" id="8390803">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8390807">type</span>&nbsp;<span class="ident" id="8390812">execTest</span>&nbsp;<span class="keyword" id="8390821">struct</span>&nbsp;<span class="op" id="8390828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8390832">args</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8390840">[</span><span class="op" id="8390841">]</span><span class="keyword" id="8390842">interface</span><span class="op" id="8390851">{</span><span class="op" id="8390852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8390856">wantErr</span>&nbsp;<span class="builtintype" id="8390864">string</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8390872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8390875">execTests</span>&nbsp;<span class="op" id="8390885">:=</span>&nbsp;<span class="op" id="8390888">[</span><span class="op" id="8390889">]</span><span class="ident" id="8390890">execTest</span><span class="op" id="8390898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8390902">//&nbsp;Okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8390913">{</span><span class="op" id="8390914">[</span><span class="op" id="8390915">]</span><span class="keyword" id="8390916">interface</span><span class="op" id="8390925">{</span><span class="op" id="8390926">}</span><span class="op" id="8390927">{</span><span class="string" id="8390928">&#34;Brad&#34;</span><span class="op" id="8390934">,</span>&nbsp;<span class="num" id="8390936">31</span><span class="op" id="8390938">}</span><span class="op" id="8390939">,</span>&nbsp;<span class="string" id="8390941">&#34;&#34;</span><span class="op" id="8390943">}</span><span class="op" id="8390944">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8390948">{</span><span class="op" id="8390949">[</span><span class="op" id="8390950">]</span><span class="keyword" id="8390951">interface</span><span class="op" id="8390960">{</span><span class="op" id="8390961">}</span><span class="op" id="8390962">{</span><span class="string" id="8390963">&#34;Brad&#34;</span><span class="op" id="8390969">,</span>&nbsp;<span class="ident" id="8390971">int64</span><span class="op" id="8390976">(</span><span class="num" id="8390977">31</span><span class="op" id="8390979">)</span><span class="op" id="8390980">}</span><span class="op" id="8390981">,</span>&nbsp;<span class="string" id="8390983">&#34;&#34;</span><span class="op" id="8390985">}</span><span class="op" id="8390986">,</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8390990">{</span><span class="op" id="8390991">[</span><span class="op" id="8390992">]</span><span class="keyword" id="8390993">interface</span><span class="op" id="8391002">{</span><span class="op" id="8391003">}</span><span class="op" id="8391004">{</span><span class="string" id="8391005">&#34;Bob&#34;</span><span class="op" id="8391010">,</span>&nbsp;<span class="string" id="8391012">&#34;32&#34;</span><span class="op" id="8391016">}</span><span class="op" id="8391017">,</span>&nbsp;<span class="string" id="8391019">&#34;&#34;</span><span class="op" id="8391021">}</span><span class="op" id="8391022">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8391026">{</span><span class="op" id="8391027">[</span><span class="op" id="8391028">]</span><span class="keyword" id="8391029">interface</span><span class="op" id="8391038">{</span><span class="op" id="8391039">}</span><span class="op" id="8391040">{</span><span class="num" id="8391041">7</span><span class="op" id="8391042">,</span>&nbsp;<span class="num" id="8391044">9</span><span class="op" id="8391045">}</span><span class="op" id="8391046">,</span>&nbsp;<span class="string" id="8391048">&#34;&#34;</span><span class="op" id="8391050">}</span><span class="op" id="8391051">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8391056">//&nbsp;Invalid&nbsp;conversions:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8391082">{</span><span class="op" id="8391083">[</span><span class="op" id="8391084">]</span><span class="keyword" id="8391085">interface</span><span class="op" id="8391094">{</span><span class="op" id="8391095">}</span><span class="op" id="8391096">{</span><span class="string" id="8391097">&#34;Brad&#34;</span><span class="op" id="8391103">,</span>&nbsp;<span class="ident" id="8391105">int64</span><span class="op" id="8391110">(</span><span class="num" id="8391111">0xFFFFFFFF</span><span class="op" id="8391121">)</span><span class="op" id="8391122">}</span><span class="op" id="8391123">,</span>&nbsp;<span class="string" id="8391125">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;4294967295&nbsp;overflows&nbsp;int32&#34;</span><span class="op" id="8391207">}</span><span class="op" id="8391208">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8391212">{</span><span class="op" id="8391213">[</span><span class="op" id="8391214">]</span><span class="keyword" id="8391215">interface</span><span class="op" id="8391224">{</span><span class="op" id="8391225">}</span><span class="op" id="8391226">{</span><span class="string" id="8391227">&#34;Brad&#34;</span><span class="op" id="8391233">,</span>&nbsp;<span class="string" id="8391235">&#34;strconv&nbsp;fail&#34;</span><span class="op" id="8391249">}</span><span class="op" id="8391250">,</span>&nbsp;<span class="string" id="8391252">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;\&#34;strconv&nbsp;fail\&#34;&nbsp;can&#39;t&nbsp;be&nbsp;converted&nbsp;to&nbsp;int32&#34;</span><span class="op" id="8391352">}</span><span class="op" id="8391353">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8391358">//&nbsp;Wrong&nbsp;number&nbsp;of&nbsp;args:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8391385">{</span><span class="op" id="8391386">[</span><span class="op" id="8391387">]</span><span class="keyword" id="8391388">interface</span><span class="op" id="8391397">{</span><span class="op" id="8391398">}</span><span class="op" id="8391399">{</span><span class="op" id="8391400">}</span><span class="op" id="8391401">,</span>&nbsp;<span class="string" id="8391403">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;0&#34;</span><span class="op" id="8391437">}</span><span class="op" id="8391438">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8391442">{</span><span class="op" id="8391443">[</span><span class="op" id="8391444">]</span><span class="keyword" id="8391445">interface</span><span class="op" id="8391454">{</span><span class="op" id="8391455">}</span><span class="op" id="8391456">{</span><span class="num" id="8391457">1</span><span class="op" id="8391458">,</span>&nbsp;<span class="num" id="8391460">2</span><span class="op" id="8391461">,</span>&nbsp;<span class="num" id="8391463">3</span><span class="op" id="8391464">}</span><span class="op" id="8391465">,</span>&nbsp;<span class="string" id="8391467">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;3&#34;</span><span class="op" id="8391501">}</span><span class="op" id="8391502">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8391505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8391508">for</span>&nbsp;<span class="ident" id="8391512">n</span><span class="op" id="8391513">,</span>&nbsp;<span class="ident" id="8391515">et</span>&nbsp;<span class="op" id="8391518">:=</span>&nbsp;<span class="keyword" id="8391521">range</span>&nbsp;<span class="ident" id="8391527">execTests</span>&nbsp;<span class="op" id="8391537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8391541">_</span><span class="op" id="8391542">,</span>&nbsp;<span class="ident" id="8391544">err</span>&nbsp;<span class="op" id="8391548">:=</span>&nbsp;<span class="ident" id="8391551">stmt</span><span class="op" id="8391555">.</span><span class="ident" id="8391556">Exec</span><span class="op" id="8391560">(</span><span class="ident" id="8391561">et</span><span class="op" id="8391563">.</span><span class="ident" id="8391564">args</span><span class="op" id="8391568">...</span><span class="op" id="8391571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8391575">errStr</span>&nbsp;<span class="op" id="8391582">:=</span>&nbsp;<span class="string" id="8391585">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8391590">if</span>&nbsp;<span class="ident" id="8391593">err</span>&nbsp;<span class="op" id="8391597">!=</span>&nbsp;<span class="ident" id="8391600">nil</span>&nbsp;<span class="op" id="8391604">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8391609">errStr</span>&nbsp;<span class="op" id="8391616">=</span>&nbsp;<span class="ident" id="8391618">err</span><span class="op" id="8391621">.</span><span class="ident" id="8391622">Error</span><span class="op" id="8391627">(</span><span class="op" id="8391628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8391632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8391636">if</span>&nbsp;<span class="ident" id="8391639">errStr</span>&nbsp;<span class="op" id="8391646">!=</span>&nbsp;<span class="ident" id="8391649">et</span><span class="op" id="8391651">.</span><span class="ident" id="8391652">wantErr</span>&nbsp;<span class="op" id="8391660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8391665">t</span><span class="op" id="8391666">.</span><span class="ident" id="8391667">Errorf</span><span class="op" id="8391673">(</span><span class="string" id="8391674">&#34;stmt.Execute&nbsp;#%d:&nbsp;for&nbsp;%v,&nbsp;got&nbsp;error&nbsp;%q,&nbsp;want&nbsp;error&nbsp;%q&#34;</span><span class="op" id="8391729">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8391735">n</span><span class="op" id="8391736">,</span>&nbsp;<span class="ident" id="8391738">et</span><span class="op" id="8391740">.</span><span class="ident" id="8391741">args</span><span class="op" id="8391745">,</span>&nbsp;<span class="ident" id="8391747">errStr</span><span class="op" id="8391753">,</span>&nbsp;<span class="ident" id="8391755">et</span><span class="op" id="8391757">.</span><span class="ident" id="8391758">wantErr</span><span class="op" id="8391765">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8391769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8391772">}</span><br>
<span class="lineno"></span><span class="op" id="8391774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8391777">func</span>&nbsp;<span class="ident" id="8391782">TestTxPrepare</span><span class="op" id="8391795">(</span><span class="ident" id="8391796">t</span>&nbsp;<span class="op" id="8391798">*</span><span class="ident" id="8391799">testing</span><span class="op" id="8391806">.</span><span class="ident" id="8391807">T</span><span class="op" id="8391808">)</span>&nbsp;<span class="op" id="8391810">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8391813">db</span>&nbsp;<span class="op" id="8391816">:=</span>&nbsp;<span class="ident" id="8391819">newTestDB</span><span class="op" id="8391828">(</span><span class="ident" id="8391829">t</span><span class="op" id="8391830">,</span>&nbsp;<span class="string" id="8391832">&#34;&#34;</span><span class="op" id="8391834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8391837">defer</span>&nbsp;<span class="ident" id="8391843">closeDB</span><span class="op" id="8391850">(</span><span class="ident" id="8391851">t</span><span class="op" id="8391852">,</span>&nbsp;<span class="ident" id="8391854">db</span><span class="op" id="8391856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8391859">exec</span><span class="op" id="8391863">(</span><span class="ident" id="8391864">t</span><span class="op" id="8391865">,</span>&nbsp;<span class="ident" id="8391867">db</span><span class="op" id="8391869">,</span>&nbsp;<span class="string" id="8391871">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8391914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8391917">tx</span><span class="op" id="8391919">,</span>&nbsp;<span class="ident" id="8391921">err</span>&nbsp;<span class="op" id="8391925">:=</span>&nbsp;<span class="ident" id="8391928">db</span><span class="op" id="8391930">.</span><span class="ident" id="8391931">Begin</span><span class="op" id="8391936">(</span><span class="op" id="8391937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8391940">if</span>&nbsp;<span class="ident" id="8391943">err</span>&nbsp;<span class="op" id="8391947">!=</span>&nbsp;<span class="ident" id="8391950">nil</span>&nbsp;<span class="op" id="8391954">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8391958">t</span><span class="op" id="8391959">.</span><span class="ident" id="8391960">Fatalf</span><span class="op" id="8391966">(</span><span class="string" id="8391967">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8391979">,</span>&nbsp;<span class="ident" id="8391981">err</span><span class="op" id="8391984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8391987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8391990">stmt</span><span class="op" id="8391994">,</span>&nbsp;<span class="ident" id="8391996">err</span>&nbsp;<span class="op" id="8392000">:=</span>&nbsp;<span class="ident" id="8392003">tx</span><span class="op" id="8392005">.</span><span class="ident" id="8392006">Prepare</span><span class="op" id="8392013">(</span><span class="string" id="8392014">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="8392038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8392041">if</span>&nbsp;<span class="ident" id="8392044">err</span>&nbsp;<span class="op" id="8392048">!=</span>&nbsp;<span class="ident" id="8392051">nil</span>&nbsp;<span class="op" id="8392055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392059">t</span><span class="op" id="8392060">.</span><span class="ident" id="8392061">Fatalf</span><span class="op" id="8392067">(</span><span class="string" id="8392068">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8392088">,</span>&nbsp;<span class="ident" id="8392090">stmt</span><span class="op" id="8392094">,</span>&nbsp;<span class="ident" id="8392096">err</span><span class="op" id="8392099">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8392102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8392105">defer</span>&nbsp;<span class="ident" id="8392111">stmt</span><span class="op" id="8392115">.</span><span class="ident" id="8392116">Close</span><span class="op" id="8392121">(</span><span class="op" id="8392122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392125">_</span><span class="op" id="8392126">,</span>&nbsp;<span class="ident" id="8392128">err</span>&nbsp;<span class="op" id="8392132">=</span>&nbsp;<span class="ident" id="8392134">stmt</span><span class="op" id="8392138">.</span><span class="ident" id="8392139">Exec</span><span class="op" id="8392143">(</span><span class="string" id="8392144">&#34;Bobby&#34;</span><span class="op" id="8392151">,</span>&nbsp;<span class="num" id="8392153">7</span><span class="op" id="8392154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8392157">if</span>&nbsp;<span class="ident" id="8392160">err</span>&nbsp;<span class="op" id="8392164">!=</span>&nbsp;<span class="ident" id="8392167">nil</span>&nbsp;<span class="op" id="8392171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392175">t</span><span class="op" id="8392176">.</span><span class="ident" id="8392177">Fatalf</span><span class="op" id="8392183">(</span><span class="string" id="8392184">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8392195">,</span>&nbsp;<span class="ident" id="8392197">err</span><span class="op" id="8392200">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8392203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392206">err</span>&nbsp;<span class="op" id="8392210">=</span>&nbsp;<span class="ident" id="8392212">tx</span><span class="op" id="8392214">.</span><span class="ident" id="8392215">Commit</span><span class="op" id="8392221">(</span><span class="op" id="8392222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8392225">if</span>&nbsp;<span class="ident" id="8392228">err</span>&nbsp;<span class="op" id="8392232">!=</span>&nbsp;<span class="ident" id="8392235">nil</span>&nbsp;<span class="op" id="8392239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392243">t</span><span class="op" id="8392244">.</span><span class="ident" id="8392245">Fatalf</span><span class="op" id="8392251">(</span><span class="string" id="8392252">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8392265">,</span>&nbsp;<span class="ident" id="8392267">err</span><span class="op" id="8392270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8392273">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8392276">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8392322">if</span>&nbsp;<span class="op" id="8392325">!</span><span class="ident" id="8392326">stmt</span><span class="op" id="8392330">.</span><span class="ident" id="8392331">closed</span>&nbsp;<span class="op" id="8392338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392342">t</span><span class="op" id="8392343">.</span><span class="ident" id="8392344">Fatal</span><span class="op" id="8392349">(</span><span class="string" id="8392350">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="8392380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8392383">}</span><br>
<span class="lineno"></span><span class="op" id="8392385">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="keyword" id="8392388">func</span>&nbsp;<span class="ident" id="8392393">TestTxStmt</span><span class="op" id="8392403">(</span><span class="ident" id="8392404">t</span>&nbsp;<span class="op" id="8392406">*</span><span class="ident" id="8392407">testing</span><span class="op" id="8392414">.</span><span class="ident" id="8392415">T</span><span class="op" id="8392416">)</span>&nbsp;<span class="op" id="8392418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392421">db</span>&nbsp;<span class="op" id="8392424">:=</span>&nbsp;<span class="ident" id="8392427">newTestDB</span><span class="op" id="8392436">(</span><span class="ident" id="8392437">t</span><span class="op" id="8392438">,</span>&nbsp;<span class="string" id="8392440">&#34;&#34;</span><span class="op" id="8392442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8392445">defer</span>&nbsp;<span class="ident" id="8392451">closeDB</span><span class="op" id="8392458">(</span><span class="ident" id="8392459">t</span><span class="op" id="8392460">,</span>&nbsp;<span class="ident" id="8392462">db</span><span class="op" id="8392464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392467">exec</span><span class="op" id="8392471">(</span><span class="ident" id="8392472">t</span><span class="op" id="8392473">,</span>&nbsp;<span class="ident" id="8392475">db</span><span class="op" id="8392477">,</span>&nbsp;<span class="string" id="8392479">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8392522">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392525">stmt</span><span class="op" id="8392529">,</span>&nbsp;<span class="ident" id="8392531">err</span>&nbsp;<span class="op" id="8392535">:=</span>&nbsp;<span class="ident" id="8392538">db</span><span class="op" id="8392540">.</span><span class="ident" id="8392541">Prepare</span><span class="op" id="8392548">(</span><span class="string" id="8392549">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="8392573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8392576">if</span>&nbsp;<span class="ident" id="8392579">err</span>&nbsp;<span class="op" id="8392583">!=</span>&nbsp;<span class="ident" id="8392586">nil</span>&nbsp;<span class="op" id="8392590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392594">t</span><span class="op" id="8392595">.</span><span class="ident" id="8392596">Fatalf</span><span class="op" id="8392602">(</span><span class="string" id="8392603">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8392623">,</span>&nbsp;<span class="ident" id="8392625">stmt</span><span class="op" id="8392629">,</span>&nbsp;<span class="ident" id="8392631">err</span><span class="op" id="8392634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8392637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8392640">defer</span>&nbsp;<span class="ident" id="8392646">stmt</span><span class="op" id="8392650">.</span><span class="ident" id="8392651">Close</span><span class="op" id="8392656">(</span><span class="op" id="8392657">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392660">tx</span><span class="op" id="8392662">,</span>&nbsp;<span class="ident" id="8392664">err</span>&nbsp;<span class="op" id="8392668">:=</span>&nbsp;<span class="ident" id="8392671">db</span><span class="op" id="8392673">.</span><span class="ident" id="8392674">Begin</span><span class="op" id="8392679">(</span><span class="op" id="8392680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8392683">if</span>&nbsp;<span class="ident" id="8392686">err</span>&nbsp;<span class="op" id="8392690">!=</span>&nbsp;<span class="ident" id="8392693">nil</span>&nbsp;<span class="op" id="8392697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392701">t</span><span class="op" id="8392702">.</span><span class="ident" id="8392703">Fatalf</span><span class="op" id="8392709">(</span><span class="string" id="8392710">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8392722">,</span>&nbsp;<span class="ident" id="8392724">err</span><span class="op" id="8392727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8392730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392733">txs</span>&nbsp;<span class="op" id="8392737">:=</span>&nbsp;<span class="ident" id="8392740">tx</span><span class="op" id="8392742">.</span><span class="ident" id="8392743">Stmt</span><span class="op" id="8392747">(</span><span class="ident" id="8392748">stmt</span><span class="op" id="8392752">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8392755">defer</span>&nbsp;<span class="ident" id="8392761">txs</span><span class="op" id="8392764">.</span><span class="ident" id="8392765">Close</span><span class="op" id="8392770">(</span><span class="op" id="8392771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392774">_</span><span class="op" id="8392775">,</span>&nbsp;<span class="ident" id="8392777">err</span>&nbsp;<span class="op" id="8392781">=</span>&nbsp;<span class="ident" id="8392783">txs</span><span class="op" id="8392786">.</span><span class="ident" id="8392787">Exec</span><span class="op" id="8392791">(</span><span class="string" id="8392792">&#34;Bobby&#34;</span><span class="op" id="8392799">,</span>&nbsp;<span class="num" id="8392801">7</span><span class="op" id="8392802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8392805">if</span>&nbsp;<span class="ident" id="8392808">err</span>&nbsp;<span class="op" id="8392812">!=</span>&nbsp;<span class="ident" id="8392815">nil</span>&nbsp;<span class="op" id="8392819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392823">t</span><span class="op" id="8392824">.</span><span class="ident" id="8392825">Fatalf</span><span class="op" id="8392831">(</span><span class="string" id="8392832">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8392843">,</span>&nbsp;<span class="ident" id="8392845">err</span><span class="op" id="8392848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8392851">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392854">err</span>&nbsp;<span class="op" id="8392858">=</span>&nbsp;<span class="ident" id="8392860">tx</span><span class="op" id="8392862">.</span><span class="ident" id="8392863">Commit</span><span class="op" id="8392869">(</span><span class="op" id="8392870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8392873">if</span>&nbsp;<span class="ident" id="8392876">err</span>&nbsp;<span class="op" id="8392880">!=</span>&nbsp;<span class="ident" id="8392883">nil</span>&nbsp;<span class="op" id="8392887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392891">t</span><span class="op" id="8392892">.</span><span class="ident" id="8392893">Fatalf</span><span class="op" id="8392899">(</span><span class="string" id="8392900">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8392913">,</span>&nbsp;<span class="ident" id="8392915">err</span><span class="op" id="8392918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8392921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8392924">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8392970">if</span>&nbsp;<span class="op" id="8392973">!</span><span class="ident" id="8392974">txs</span><span class="op" id="8392977">.</span><span class="ident" id="8392978">closed</span>&nbsp;<span class="op" id="8392985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8392989">t</span><span class="op" id="8392990">.</span><span class="ident" id="8392991">Fatal</span><span class="op" id="8392996">(</span><span class="string" id="8392997">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="8393027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8393030">}</span><br>
<span class="lineno"></span><span class="op" id="8393032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">500</span><span class="comment" id="8393035">//&nbsp;Issue:&nbsp;http://golang.org/issue/2784</span><br>
<span class="lineno"></span><span class="comment" id="8393074">//&nbsp;This&nbsp;test&nbsp;didn&#39;t&nbsp;fail&nbsp;before&nbsp;because&nbsp;we&nbsp;got&nbsp;lucky&nbsp;with&nbsp;the&nbsp;fakedb&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="8393151">//&nbsp;It&nbsp;was&nbsp;failing,&nbsp;and&nbsp;now&nbsp;not,&nbsp;in&nbsp;github.com/bradfitz/go-sql-test</span><br>
<span class="lineno"></span><span class="keyword" id="8393218">func</span>&nbsp;<span class="ident" id="8393223">TestTxQuery</span><span class="op" id="8393234">(</span><span class="ident" id="8393235">t</span>&nbsp;<span class="op" id="8393237">*</span><span class="ident" id="8393238">testing</span><span class="op" id="8393245">.</span><span class="ident" id="8393246">T</span><span class="op" id="8393247">)</span>&nbsp;<span class="op" id="8393249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8393252">db</span>&nbsp;<span class="op" id="8393255">:=</span>&nbsp;<span class="ident" id="8393258">newTestDB</span><span class="op" id="8393267">(</span><span class="ident" id="8393268">t</span><span class="op" id="8393269">,</span>&nbsp;<span class="string" id="8393271">&#34;&#34;</span><span class="op" id="8393273">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8393276">defer</span>&nbsp;<span class="ident" id="8393282">closeDB</span><span class="op" id="8393289">(</span><span class="ident" id="8393290">t</span><span class="op" id="8393291">,</span>&nbsp;<span class="ident" id="8393293">db</span><span class="op" id="8393295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8393298">exec</span><span class="op" id="8393302">(</span><span class="ident" id="8393303">t</span><span class="op" id="8393304">,</span>&nbsp;<span class="ident" id="8393306">db</span><span class="op" id="8393308">,</span>&nbsp;<span class="string" id="8393310">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8393353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8393356">exec</span><span class="op" id="8393360">(</span><span class="ident" id="8393361">t</span><span class="op" id="8393362">,</span>&nbsp;<span class="ident" id="8393364">db</span><span class="op" id="8393366">,</span>&nbsp;<span class="string" id="8393368">&#34;INSERT|t1|name=Alice&#34;</span><span class="op" id="8393390">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8393394">tx</span><span class="op" id="8393396">,</span>&nbsp;<span class="ident" id="8393398">err</span>&nbsp;<span class="op" id="8393402">:=</span>&nbsp;<span class="ident" id="8393405">db</span><span class="op" id="8393407">.</span><span class="ident" id="8393408">Begin</span><span class="op" id="8393413">(</span><span class="op" id="8393414">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8393417">if</span>&nbsp;<span class="ident" id="8393420">err</span>&nbsp;<span class="op" id="8393424">!=</span>&nbsp;<span class="ident" id="8393427">nil</span>&nbsp;<span class="op" id="8393431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8393435">t</span><span class="op" id="8393436">.</span><span class="ident" id="8393437">Fatal</span><span class="op" id="8393442">(</span><span class="ident" id="8393443">err</span><span class="op" id="8393446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8393449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8393452">defer</span>&nbsp;<span class="ident" id="8393458">tx</span><span class="op" id="8393460">.</span><span class="ident" id="8393461">Rollback</span><span class="op" id="8393469">(</span><span class="op" id="8393470">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8393474">r</span><span class="op" id="8393475">,</span>&nbsp;<span class="ident" id="8393477">err</span>&nbsp;<span class="op" id="8393481">:=</span>&nbsp;<span class="ident" id="8393484">tx</span><span class="op" id="8393486">.</span><span class="ident" id="8393487">Query</span><span class="op" id="8393492">(</span><span class="string" id="8393493">&#34;SELECT|t1|name|&#34;</span><span class="op" id="8393510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8393513">if</span>&nbsp;<span class="ident" id="8393516">err</span>&nbsp;<span class="op" id="8393520">!=</span>&nbsp;<span class="ident" id="8393523">nil</span>&nbsp;<span class="op" id="8393527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8393531">t</span><span class="op" id="8393532">.</span><span class="ident" id="8393533">Fatal</span><span class="op" id="8393538">(</span><span class="ident" id="8393539">err</span><span class="op" id="8393542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8393545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8393548">defer</span>&nbsp;<span class="ident" id="8393554">r</span><span class="op" id="8393555">.</span><span class="ident" id="8393556">Close</span><span class="op" id="8393561">(</span><span class="op" id="8393562">)</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8393566">if</span>&nbsp;<span class="op" id="8393569">!</span><span class="ident" id="8393570">r</span><span class="op" id="8393571">.</span><span class="ident" id="8393572">Next</span><span class="op" id="8393576">(</span><span class="op" id="8393577">)</span>&nbsp;<span class="op" id="8393579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8393583">if</span>&nbsp;<span class="ident" id="8393586">r</span><span class="op" id="8393587">.</span><span class="ident" id="8393588">Err</span><span class="op" id="8393591">(</span><span class="op" id="8393592">)</span>&nbsp;<span class="op" id="8393594">!=</span>&nbsp;<span class="ident" id="8393597">nil</span>&nbsp;<span class="op" id="8393601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8393606">t</span><span class="op" id="8393607">.</span><span class="ident" id="8393608">Fatal</span><span class="op" id="8393613">(</span><span class="ident" id="8393614">r</span><span class="op" id="8393615">.</span><span class="ident" id="8393616">Err</span><span class="op" id="8393619">(</span><span class="op" id="8393620">)</span><span class="op" id="8393621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8393625">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8393629">t</span><span class="op" id="8393630">.</span><span class="ident" id="8393631">Fatal</span><span class="op" id="8393636">(</span><span class="string" id="8393637">&#34;expected&nbsp;one&nbsp;row&#34;</span><span class="op" id="8393655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8393658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8393662">var</span>&nbsp;<span class="ident" id="8393666">x</span>&nbsp;<span class="builtintype" id="8393668">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8393676">err</span>&nbsp;<span class="op" id="8393680">=</span>&nbsp;<span class="ident" id="8393682">r</span><span class="op" id="8393683">.</span><span class="ident" id="8393684">Scan</span><span class="op" id="8393688">(</span><span class="op" id="8393689">&amp;</span><span class="ident" id="8393690">x</span><span class="op" id="8393691">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8393694">if</span>&nbsp;<span class="ident" id="8393697">err</span>&nbsp;<span class="op" id="8393701">!=</span>&nbsp;<span class="ident" id="8393704">nil</span>&nbsp;<span class="op" id="8393708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8393712">t</span><span class="op" id="8393713">.</span><span class="ident" id="8393714">Fatal</span><span class="op" id="8393719">(</span><span class="ident" id="8393720">err</span><span class="op" id="8393723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8393726">}</span><br>
<span class="lineno"></span><span class="op" id="8393728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="8393731">func</span>&nbsp;<span class="ident" id="8393736">TestTxQueryInvalid</span><span class="op" id="8393754">(</span><span class="ident" id="8393755">t</span>&nbsp;<span class="op" id="8393757">*</span><span class="ident" id="8393758">testing</span><span class="op" id="8393765">.</span><span class="ident" id="8393766">T</span><span class="op" id="8393767">)</span>&nbsp;<span class="op" id="8393769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8393772">db</span>&nbsp;<span class="op" id="8393775">:=</span>&nbsp;<span class="ident" id="8393778">newTestDB</span><span class="op" id="8393787">(</span><span class="ident" id="8393788">t</span><span class="op" id="8393789">,</span>&nbsp;<span class="string" id="8393791">&#34;&#34;</span><span class="op" id="8393793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8393796">defer</span>&nbsp;<span class="ident" id="8393802">closeDB</span><span class="op" id="8393809">(</span><span class="ident" id="8393810">t</span><span class="op" id="8393811">,</span>&nbsp;<span class="ident" id="8393813">db</span><span class="op" id="8393815">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8393819">tx</span><span class="op" id="8393821">,</span>&nbsp;<span class="ident" id="8393823">err</span>&nbsp;<span class="op" id="8393827">:=</span>&nbsp;<span class="ident" id="8393830">db</span><span class="op" id="8393832">.</span><span class="ident" id="8393833">Begin</span><span class="op" id="8393838">(</span><span class="op" id="8393839">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8393842">if</span>&nbsp;<span class="ident" id="8393845">err</span>&nbsp;<span class="op" id="8393849">!=</span>&nbsp;<span class="ident" id="8393852">nil</span>&nbsp;<span class="op" id="8393856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8393860">t</span><span class="op" id="8393861">.</span><span class="ident" id="8393862">Fatal</span><span class="op" id="8393867">(</span><span class="ident" id="8393868">err</span><span class="op" id="8393871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8393874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8393877">defer</span>&nbsp;<span class="ident" id="8393883">tx</span><span class="op" id="8393885">.</span><span class="ident" id="8393886">Rollback</span><span class="op" id="8393894">(</span><span class="op" id="8393895">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8393899">_</span><span class="op" id="8393900">,</span>&nbsp;<span class="ident" id="8393902">err</span>&nbsp;<span class="op" id="8393906">=</span>&nbsp;<span class="ident" id="8393908">tx</span><span class="op" id="8393910">.</span><span class="ident" id="8393911">Query</span><span class="op" id="8393916">(</span><span class="string" id="8393917">&#34;SELECT|t1|name|&#34;</span><span class="op" id="8393934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8393937">if</span>&nbsp;<span class="ident" id="8393940">err</span>&nbsp;<span class="op" id="8393944">==</span>&nbsp;<span class="ident" id="8393947">nil</span>&nbsp;<span class="op" id="8393951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8393955">t</span><span class="op" id="8393956">.</span><span class="ident" id="8393957">Fatal</span><span class="op" id="8393962">(</span><span class="string" id="8393963">&#34;Error&nbsp;expected&#34;</span><span class="op" id="8393979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8393982">}</span><br>
<span class="lineno"></span><span class="op" id="8393984">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="8393987">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;4433,&nbsp;that&nbsp;retries&nbsp;in&nbsp;Begin&nbsp;happen&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="8394050">//&nbsp;conn.Begin()&nbsp;returns&nbsp;ErrBadConn</span><br>
<span class="lineno"></span><span class="keyword" id="8394085">func</span>&nbsp;<span class="ident" id="8394090">TestTxErrBadConn</span><span class="op" id="8394106">(</span><span class="ident" id="8394107">t</span>&nbsp;<span class="op" id="8394109">*</span><span class="ident" id="8394110">testing</span><span class="op" id="8394117">.</span><span class="ident" id="8394118">T</span><span class="op" id="8394119">)</span>&nbsp;<span class="op" id="8394121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8394124">db</span><span class="op" id="8394126">,</span>&nbsp;<span class="ident" id="8394128">err</span>&nbsp;<span class="op" id="8394132">:=</span>&nbsp;<span class="ident" id="8394135">Open</span><span class="op" id="8394139">(</span><span class="string" id="8394140">&#34;test&#34;</span><span class="op" id="8394146">,</span>&nbsp;<span class="ident" id="8394148">fakeDBName</span><span class="op" id="8394158">+</span><span class="string" id="8394159">&#34;;badConn&#34;</span><span class="op" id="8394169">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8394172">if</span>&nbsp;<span class="ident" id="8394175">err</span>&nbsp;<span class="op" id="8394179">!=</span>&nbsp;<span class="ident" id="8394182">nil</span>&nbsp;<span class="op" id="8394186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8394190">t</span><span class="op" id="8394191">.</span><span class="ident" id="8394192">Fatalf</span><span class="op" id="8394198">(</span><span class="string" id="8394199">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="8394209">,</span>&nbsp;<span class="ident" id="8394211">err</span><span class="op" id="8394214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8394217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8394220">if</span>&nbsp;<span class="ident" id="8394223">_</span><span class="op" id="8394224">,</span>&nbsp;<span class="ident" id="8394226">err</span>&nbsp;<span class="op" id="8394230">:=</span>&nbsp;<span class="ident" id="8394233">db</span><span class="op" id="8394235">.</span><span class="ident" id="8394236">Exec</span><span class="op" id="8394240">(</span><span class="string" id="8394241">&#34;WIPE&#34;</span><span class="op" id="8394247">)</span><span class="op" id="8394248">;</span>&nbsp;<span class="ident" id="8394250">err</span>&nbsp;<span class="op" id="8394254">!=</span>&nbsp;<span class="ident" id="8394257">nil</span>&nbsp;<span class="op" id="8394261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8394265">t</span><span class="op" id="8394266">.</span><span class="ident" id="8394267">Fatalf</span><span class="op" id="8394273">(</span><span class="string" id="8394274">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="8394289">,</span>&nbsp;<span class="ident" id="8394291">err</span><span class="op" id="8394294">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8394297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8394300">defer</span>&nbsp;<span class="ident" id="8394306">closeDB</span><span class="op" id="8394313">(</span><span class="ident" id="8394314">t</span><span class="op" id="8394315">,</span>&nbsp;<span class="ident" id="8394317">db</span><span class="op" id="8394319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8394322">exec</span><span class="op" id="8394326">(</span><span class="ident" id="8394327">t</span><span class="op" id="8394328">,</span>&nbsp;<span class="ident" id="8394330">db</span><span class="op" id="8394332">,</span>&nbsp;<span class="string" id="8394334">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8394377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8394380">stmt</span><span class="op" id="8394384">,</span>&nbsp;<span class="ident" id="8394386">err</span>&nbsp;<span class="op" id="8394390">:=</span>&nbsp;<span class="ident" id="8394393">db</span><span class="op" id="8394395">.</span><span class="ident" id="8394396">Prepare</span><span class="op" id="8394403">(</span><span class="string" id="8394404">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="8394428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8394431">if</span>&nbsp;<span class="ident" id="8394434">err</span>&nbsp;<span class="op" id="8394438">!=</span>&nbsp;<span class="ident" id="8394441">nil</span>&nbsp;<span class="op" id="8394445">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8394449">t</span><span class="op" id="8394450">.</span><span class="ident" id="8394451">Fatalf</span><span class="op" id="8394457">(</span><span class="string" id="8394458">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8394478">,</span>&nbsp;<span class="ident" id="8394480">stmt</span><span class="op" id="8394484">,</span>&nbsp;<span class="ident" id="8394486">err</span><span class="op" id="8394489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8394492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8394495">defer</span>&nbsp;<span class="ident" id="8394501">stmt</span><span class="op" id="8394505">.</span><span class="ident" id="8394506">Close</span><span class="op" id="8394511">(</span><span class="op" id="8394512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8394515">tx</span><span class="op" id="8394517">,</span>&nbsp;<span class="ident" id="8394519">err</span>&nbsp;<span class="op" id="8394523">:=</span>&nbsp;<span class="ident" id="8394526">db</span><span class="op" id="8394528">.</span><span class="ident" id="8394529">Begin</span><span class="op" id="8394534">(</span><span class="op" id="8394535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8394538">if</span>&nbsp;<span class="ident" id="8394541">err</span>&nbsp;<span class="op" id="8394545">!=</span>&nbsp;<span class="ident" id="8394548">nil</span>&nbsp;<span class="op" id="8394552">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8394556">t</span><span class="op" id="8394557">.</span><span class="ident" id="8394558">Fatalf</span><span class="op" id="8394564">(</span><span class="string" id="8394565">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8394577">,</span>&nbsp;<span class="ident" id="8394579">err</span><span class="op" id="8394582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8394585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8394588">txs</span>&nbsp;<span class="op" id="8394592">:=</span>&nbsp;<span class="ident" id="8394595">tx</span><span class="op" id="8394597">.</span><span class="ident" id="8394598">Stmt</span><span class="op" id="8394602">(</span><span class="ident" id="8394603">stmt</span><span class="op" id="8394607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8394610">defer</span>&nbsp;<span class="ident" id="8394616">txs</span><span class="op" id="8394619">.</span><span class="ident" id="8394620">Close</span><span class="op" id="8394625">(</span><span class="op" id="8394626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8394629">_</span><span class="op" id="8394630">,</span>&nbsp;<span class="ident" id="8394632">err</span>&nbsp;<span class="op" id="8394636">=</span>&nbsp;<span class="ident" id="8394638">txs</span><span class="op" id="8394641">.</span><span class="ident" id="8394642">Exec</span><span class="op" id="8394646">(</span><span class="string" id="8394647">&#34;Bobby&#34;</span><span class="op" id="8394654">,</span>&nbsp;<span class="num" id="8394656">7</span><span class="op" id="8394657">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8394660">if</span>&nbsp;<span class="ident" id="8394663">err</span>&nbsp;<span class="op" id="8394667">!=</span>&nbsp;<span class="ident" id="8394670">nil</span>&nbsp;<span class="op" id="8394674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8394678">t</span><span class="op" id="8394679">.</span><span class="ident" id="8394680">Fatalf</span><span class="op" id="8394686">(</span><span class="string" id="8394687">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8394698">,</span>&nbsp;<span class="ident" id="8394700">err</span><span class="op" id="8394703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8394706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8394709">err</span>&nbsp;<span class="op" id="8394713">=</span>&nbsp;<span class="ident" id="8394715">tx</span><span class="op" id="8394717">.</span><span class="ident" id="8394718">Commit</span><span class="op" id="8394724">(</span><span class="op" id="8394725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8394728">if</span>&nbsp;<span class="ident" id="8394731">err</span>&nbsp;<span class="op" id="8394735">!=</span>&nbsp;<span class="ident" id="8394738">nil</span>&nbsp;<span class="op" id="8394742">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8394746">t</span><span class="op" id="8394747">.</span><span class="ident" id="8394748">Fatalf</span><span class="op" id="8394754">(</span><span class="string" id="8394755">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8394768">,</span>&nbsp;<span class="ident" id="8394770">err</span><span class="op" id="8394773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8394776">}</span><br>
<span class="lineno"></span><span class="op" id="8394778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8394781">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2542,&nbsp;that&nbsp;we&nbsp;release&nbsp;a&nbsp;lock&nbsp;when&nbsp;querying&nbsp;on</span><br>
<span class="lineno">585</span><span class="comment" id="8394850">//&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="8394874">func</span>&nbsp;<span class="ident" id="8394879">TestIssue2542Deadlock</span><span class="op" id="8394900">(</span><span class="ident" id="8394901">t</span>&nbsp;<span class="op" id="8394903">*</span><span class="ident" id="8394904">testing</span><span class="op" id="8394911">.</span><span class="ident" id="8394912">T</span><span class="op" id="8394913">)</span>&nbsp;<span class="op" id="8394915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8394918">db</span>&nbsp;<span class="op" id="8394921">:=</span>&nbsp;<span class="ident" id="8394924">newTestDB</span><span class="op" id="8394933">(</span><span class="ident" id="8394934">t</span><span class="op" id="8394935">,</span>&nbsp;<span class="string" id="8394937">&#34;people&#34;</span><span class="op" id="8394945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8394948">closeDB</span><span class="op" id="8394955">(</span><span class="ident" id="8394956">t</span><span class="op" id="8394957">,</span>&nbsp;<span class="ident" id="8394959">db</span><span class="op" id="8394961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8394964">for</span>&nbsp;<span class="ident" id="8394968">i</span>&nbsp;<span class="op" id="8394970">:=</span>&nbsp;<span class="num" id="8394973">0</span><span class="op" id="8394974">;</span>&nbsp;<span class="ident" id="8394976">i</span>&nbsp;<span class="op" id="8394978">&lt;</span>&nbsp;<span class="num" id="8394980">2</span><span class="op" id="8394981">;</span>&nbsp;<span class="ident" id="8394983">i</span><span class="op" id="8394984">++</span>&nbsp;<span class="op" id="8394987">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8394991">_</span><span class="op" id="8394992">,</span>&nbsp;<span class="ident" id="8394994">err</span>&nbsp;<span class="op" id="8394998">:=</span>&nbsp;<span class="ident" id="8395001">db</span><span class="op" id="8395003">.</span><span class="ident" id="8395004">Query</span><span class="op" id="8395009">(</span><span class="string" id="8395010">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8395035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8395039">if</span>&nbsp;<span class="ident" id="8395042">err</span>&nbsp;<span class="op" id="8395046">==</span>&nbsp;<span class="ident" id="8395049">nil</span>&nbsp;<span class="op" id="8395053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395058">t</span><span class="op" id="8395059">.</span><span class="ident" id="8395060">Fatalf</span><span class="op" id="8395066">(</span><span class="string" id="8395067">&#34;expected&nbsp;error&#34;</span><span class="op" id="8395083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8395087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8395090">}</span><br>
<span class="lineno">595</span><span class="op" id="8395092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8395095">//&nbsp;From&nbsp;golang.org/issue/3865</span><br>
<span class="lineno"></span><span class="keyword" id="8395125">func</span>&nbsp;<span class="ident" id="8395130">TestCloseStmtBeforeRows</span><span class="op" id="8395153">(</span><span class="ident" id="8395154">t</span>&nbsp;<span class="op" id="8395156">*</span><span class="ident" id="8395157">testing</span><span class="op" id="8395164">.</span><span class="ident" id="8395165">T</span><span class="op" id="8395166">)</span>&nbsp;<span class="op" id="8395168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395171">db</span>&nbsp;<span class="op" id="8395174">:=</span>&nbsp;<span class="ident" id="8395177">newTestDB</span><span class="op" id="8395186">(</span><span class="ident" id="8395187">t</span><span class="op" id="8395188">,</span>&nbsp;<span class="string" id="8395190">&#34;people&#34;</span><span class="op" id="8395198">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8395201">defer</span>&nbsp;<span class="ident" id="8395207">closeDB</span><span class="op" id="8395214">(</span><span class="ident" id="8395215">t</span><span class="op" id="8395216">,</span>&nbsp;<span class="ident" id="8395218">db</span><span class="op" id="8395220">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395224">s</span><span class="op" id="8395225">,</span>&nbsp;<span class="ident" id="8395227">err</span>&nbsp;<span class="op" id="8395231">:=</span>&nbsp;<span class="ident" id="8395234">db</span><span class="op" id="8395236">.</span><span class="ident" id="8395237">Prepare</span><span class="op" id="8395244">(</span><span class="string" id="8395245">&#34;SELECT|people|name|&#34;</span><span class="op" id="8395266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8395269">if</span>&nbsp;<span class="ident" id="8395272">err</span>&nbsp;<span class="op" id="8395276">!=</span>&nbsp;<span class="ident" id="8395279">nil</span>&nbsp;<span class="op" id="8395283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395287">t</span><span class="op" id="8395288">.</span><span class="ident" id="8395289">Fatal</span><span class="op" id="8395294">(</span><span class="ident" id="8395295">err</span><span class="op" id="8395298">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8395301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395305">r</span><span class="op" id="8395306">,</span>&nbsp;<span class="ident" id="8395308">err</span>&nbsp;<span class="op" id="8395312">:=</span>&nbsp;<span class="ident" id="8395315">s</span><span class="op" id="8395316">.</span><span class="ident" id="8395317">Query</span><span class="op" id="8395322">(</span><span class="op" id="8395323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8395326">if</span>&nbsp;<span class="ident" id="8395329">err</span>&nbsp;<span class="op" id="8395333">!=</span>&nbsp;<span class="ident" id="8395336">nil</span>&nbsp;<span class="op" id="8395340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395344">s</span><span class="op" id="8395345">.</span><span class="ident" id="8395346">Close</span><span class="op" id="8395351">(</span><span class="op" id="8395352">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395356">t</span><span class="op" id="8395357">.</span><span class="ident" id="8395358">Fatal</span><span class="op" id="8395363">(</span><span class="ident" id="8395364">err</span><span class="op" id="8395367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8395370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395374">err</span>&nbsp;<span class="op" id="8395378">=</span>&nbsp;<span class="ident" id="8395380">s</span><span class="op" id="8395381">.</span><span class="ident" id="8395382">Close</span><span class="op" id="8395387">(</span><span class="op" id="8395388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8395391">if</span>&nbsp;<span class="ident" id="8395394">err</span>&nbsp;<span class="op" id="8395398">!=</span>&nbsp;<span class="ident" id="8395401">nil</span>&nbsp;<span class="op" id="8395405">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395409">t</span><span class="op" id="8395410">.</span><span class="ident" id="8395411">Fatal</span><span class="op" id="8395416">(</span><span class="ident" id="8395417">err</span><span class="op" id="8395420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8395423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395427">r</span><span class="op" id="8395428">.</span><span class="ident" id="8395429">Close</span><span class="op" id="8395434">(</span><span class="op" id="8395435">)</span><br>
<span class="lineno"></span><span class="op" id="8395437">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="comment" id="8395440">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2788,&nbsp;that&nbsp;we&nbsp;bind&nbsp;nil&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="8395505">//&nbsp;value&nbsp;in&nbsp;the&nbsp;column&nbsp;is&nbsp;sql&nbsp;null</span><br>
<span class="lineno"></span><span class="keyword" id="8395540">func</span>&nbsp;<span class="ident" id="8395545">TestNullByteSlice</span><span class="op" id="8395562">(</span><span class="ident" id="8395563">t</span>&nbsp;<span class="op" id="8395565">*</span><span class="ident" id="8395566">testing</span><span class="op" id="8395573">.</span><span class="ident" id="8395574">T</span><span class="op" id="8395575">)</span>&nbsp;<span class="op" id="8395577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395580">db</span>&nbsp;<span class="op" id="8395583">:=</span>&nbsp;<span class="ident" id="8395586">newTestDB</span><span class="op" id="8395595">(</span><span class="ident" id="8395596">t</span><span class="op" id="8395597">,</span>&nbsp;<span class="string" id="8395599">&#34;&#34;</span><span class="op" id="8395601">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8395604">defer</span>&nbsp;<span class="ident" id="8395610">closeDB</span><span class="op" id="8395617">(</span><span class="ident" id="8395618">t</span><span class="op" id="8395619">,</span>&nbsp;<span class="ident" id="8395621">db</span><span class="op" id="8395623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395626">exec</span><span class="op" id="8395630">(</span><span class="ident" id="8395631">t</span><span class="op" id="8395632">,</span>&nbsp;<span class="ident" id="8395634">db</span><span class="op" id="8395636">,</span>&nbsp;<span class="string" id="8395638">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="8395673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395676">exec</span><span class="op" id="8395680">(</span><span class="ident" id="8395681">t</span><span class="op" id="8395682">,</span>&nbsp;<span class="ident" id="8395684">db</span><span class="op" id="8395686">,</span>&nbsp;<span class="string" id="8395688">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="8395711">,</span>&nbsp;<span class="ident" id="8395713">nil</span><span class="op" id="8395716">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8395720">var</span>&nbsp;<span class="ident" id="8395724">name</span>&nbsp;<span class="op" id="8395729">[</span><span class="op" id="8395730">]</span><span class="builtintype" id="8395731">byte</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395738">err</span>&nbsp;<span class="op" id="8395742">:=</span>&nbsp;<span class="ident" id="8395745">db</span><span class="op" id="8395747">.</span><span class="ident" id="8395748">QueryRow</span><span class="op" id="8395756">(</span><span class="string" id="8395757">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="8395777">,</span>&nbsp;<span class="num" id="8395779">10</span><span class="op" id="8395781">)</span><span class="op" id="8395782">.</span><span class="ident" id="8395783">Scan</span><span class="op" id="8395787">(</span><span class="op" id="8395788">&amp;</span><span class="ident" id="8395789">name</span><span class="op" id="8395793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8395796">if</span>&nbsp;<span class="ident" id="8395799">err</span>&nbsp;<span class="op" id="8395803">!=</span>&nbsp;<span class="ident" id="8395806">nil</span>&nbsp;<span class="op" id="8395810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395814">t</span><span class="op" id="8395815">.</span><span class="ident" id="8395816">Fatal</span><span class="op" id="8395821">(</span><span class="ident" id="8395822">err</span><span class="op" id="8395825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8395828">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8395831">if</span>&nbsp;<span class="ident" id="8395834">name</span>&nbsp;<span class="op" id="8395839">!=</span>&nbsp;<span class="ident" id="8395842">nil</span>&nbsp;<span class="op" id="8395846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395850">t</span><span class="op" id="8395851">.</span><span class="ident" id="8395852">Fatalf</span><span class="op" id="8395858">(</span><span class="string" id="8395859">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;nil&nbsp;for&nbsp;null&nbsp;column&nbsp;value,&nbsp;got:&nbsp;%#v&#34;</span><span class="op" id="8395918">,</span>&nbsp;<span class="ident" id="8395920">name</span><span class="op" id="8395924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8395927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395931">exec</span><span class="op" id="8395935">(</span><span class="ident" id="8395936">t</span><span class="op" id="8395937">,</span>&nbsp;<span class="ident" id="8395939">db</span><span class="op" id="8395941">,</span>&nbsp;<span class="string" id="8395943">&#34;INSERT|t|id=11,name=?&#34;</span><span class="op" id="8395966">,</span>&nbsp;<span class="string" id="8395968">&#34;bob&#34;</span><span class="op" id="8395973">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8395976">err</span>&nbsp;<span class="op" id="8395980">=</span>&nbsp;<span class="ident" id="8395982">db</span><span class="op" id="8395984">.</span><span class="ident" id="8395985">QueryRow</span><span class="op" id="8395993">(</span><span class="string" id="8395994">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="8396014">,</span>&nbsp;<span class="num" id="8396016">11</span><span class="op" id="8396018">)</span><span class="op" id="8396019">.</span><span class="ident" id="8396020">Scan</span><span class="op" id="8396024">(</span><span class="op" id="8396025">&amp;</span><span class="ident" id="8396026">name</span><span class="op" id="8396030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8396033">if</span>&nbsp;<span class="ident" id="8396036">err</span>&nbsp;<span class="op" id="8396040">!=</span>&nbsp;<span class="ident" id="8396043">nil</span>&nbsp;<span class="op" id="8396047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396051">t</span><span class="op" id="8396052">.</span><span class="ident" id="8396053">Fatal</span><span class="op" id="8396058">(</span><span class="ident" id="8396059">err</span><span class="op" id="8396062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8396065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8396068">if</span>&nbsp;<span class="builtintype" id="8396071">string</span><span class="op" id="8396077">(</span><span class="ident" id="8396078">name</span><span class="op" id="8396082">)</span>&nbsp;<span class="op" id="8396084">!=</span>&nbsp;<span class="string" id="8396087">&#34;bob&#34;</span>&nbsp;<span class="op" id="8396093">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396097">t</span><span class="op" id="8396098">.</span><span class="ident" id="8396099">Fatalf</span><span class="op" id="8396105">(</span><span class="string" id="8396106">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;bob,&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="8396142">,</span>&nbsp;<span class="builtintype" id="8396144">string</span><span class="op" id="8396150">(</span><span class="ident" id="8396151">name</span><span class="op" id="8396155">)</span><span class="op" id="8396156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8396159">}</span><br>
<span class="lineno"></span><span class="op" id="8396161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8396164">func</span>&nbsp;<span class="ident" id="8396169">TestPointerParamsAndScans</span><span class="op" id="8396194">(</span><span class="ident" id="8396195">t</span>&nbsp;<span class="op" id="8396197">*</span><span class="ident" id="8396198">testing</span><span class="op" id="8396205">.</span><span class="ident" id="8396206">T</span><span class="op" id="8396207">)</span>&nbsp;<span class="op" id="8396209">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396212">db</span>&nbsp;<span class="op" id="8396215">:=</span>&nbsp;<span class="ident" id="8396218">newTestDB</span><span class="op" id="8396227">(</span><span class="ident" id="8396228">t</span><span class="op" id="8396229">,</span>&nbsp;<span class="string" id="8396231">&#34;&#34;</span><span class="op" id="8396233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8396236">defer</span>&nbsp;<span class="ident" id="8396242">closeDB</span><span class="op" id="8396249">(</span><span class="ident" id="8396250">t</span><span class="op" id="8396251">,</span>&nbsp;<span class="ident" id="8396253">db</span><span class="op" id="8396255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396258">exec</span><span class="op" id="8396262">(</span><span class="ident" id="8396263">t</span><span class="op" id="8396264">,</span>&nbsp;<span class="ident" id="8396266">db</span><span class="op" id="8396268">,</span>&nbsp;<span class="string" id="8396270">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="8396305">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396309">bob</span>&nbsp;<span class="op" id="8396313">:=</span>&nbsp;<span class="string" id="8396316">&#34;bob&#34;</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8396323">var</span>&nbsp;<span class="ident" id="8396327">name</span>&nbsp;<span class="op" id="8396332">*</span><span class="builtintype" id="8396333">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396342">name</span>&nbsp;<span class="op" id="8396347">=</span>&nbsp;<span class="op" id="8396349">&amp;</span><span class="ident" id="8396350">bob</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396355">exec</span><span class="op" id="8396359">(</span><span class="ident" id="8396360">t</span><span class="op" id="8396361">,</span>&nbsp;<span class="ident" id="8396363">db</span><span class="op" id="8396365">,</span>&nbsp;<span class="string" id="8396367">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="8396390">,</span>&nbsp;<span class="ident" id="8396392">name</span><span class="op" id="8396396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396399">name</span>&nbsp;<span class="op" id="8396404">=</span>&nbsp;<span class="ident" id="8396406">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396411">exec</span><span class="op" id="8396415">(</span><span class="ident" id="8396416">t</span><span class="op" id="8396417">,</span>&nbsp;<span class="ident" id="8396419">db</span><span class="op" id="8396421">,</span>&nbsp;<span class="string" id="8396423">&#34;INSERT|t|id=20,name=?&#34;</span><span class="op" id="8396446">,</span>&nbsp;<span class="ident" id="8396448">name</span><span class="op" id="8396452">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396456">err</span>&nbsp;<span class="op" id="8396460">:=</span>&nbsp;<span class="ident" id="8396463">db</span><span class="op" id="8396465">.</span><span class="ident" id="8396466">QueryRow</span><span class="op" id="8396474">(</span><span class="string" id="8396475">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="8396495">,</span>&nbsp;<span class="num" id="8396497">10</span><span class="op" id="8396499">)</span><span class="op" id="8396500">.</span><span class="ident" id="8396501">Scan</span><span class="op" id="8396505">(</span><span class="op" id="8396506">&amp;</span><span class="ident" id="8396507">name</span><span class="op" id="8396511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8396514">if</span>&nbsp;<span class="ident" id="8396517">err</span>&nbsp;<span class="op" id="8396521">!=</span>&nbsp;<span class="ident" id="8396524">nil</span>&nbsp;<span class="op" id="8396528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396532">t</span><span class="op" id="8396533">.</span><span class="ident" id="8396534">Fatalf</span><span class="op" id="8396540">(</span><span class="string" id="8396541">&#34;querying&nbsp;id&nbsp;10:&nbsp;%v&#34;</span><span class="op" id="8396561">,</span>&nbsp;<span class="ident" id="8396563">err</span><span class="op" id="8396566">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8396569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8396572">if</span>&nbsp;<span class="ident" id="8396575">name</span>&nbsp;<span class="op" id="8396580">==</span>&nbsp;<span class="ident" id="8396583">nil</span>&nbsp;<span class="op" id="8396587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396591">t</span><span class="op" id="8396592">.</span><span class="ident" id="8396593">Errorf</span><span class="op" id="8396599">(</span><span class="string" id="8396600">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;nil;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="8396630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8396633">}</span>&nbsp;<span class="keyword" id="8396635">else</span>&nbsp;<span class="keyword" id="8396640">if</span>&nbsp;<span class="op" id="8396643">*</span><span class="ident" id="8396644">name</span>&nbsp;<span class="op" id="8396649">!=</span>&nbsp;<span class="string" id="8396652">&#34;bob&#34;</span>&nbsp;<span class="op" id="8396658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396662">t</span><span class="op" id="8396663">.</span><span class="ident" id="8396664">Errorf</span><span class="op" id="8396670">(</span><span class="string" id="8396671">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="8396700">,</span>&nbsp;<span class="op" id="8396702">*</span><span class="ident" id="8396703">name</span><span class="op" id="8396707">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8396710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396714">err</span>&nbsp;<span class="op" id="8396718">=</span>&nbsp;<span class="ident" id="8396720">db</span><span class="op" id="8396722">.</span><span class="ident" id="8396723">QueryRow</span><span class="op" id="8396731">(</span><span class="string" id="8396732">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="8396752">,</span>&nbsp;<span class="num" id="8396754">20</span><span class="op" id="8396756">)</span><span class="op" id="8396757">.</span><span class="ident" id="8396758">Scan</span><span class="op" id="8396762">(</span><span class="op" id="8396763">&amp;</span><span class="ident" id="8396764">name</span><span class="op" id="8396768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8396771">if</span>&nbsp;<span class="ident" id="8396774">err</span>&nbsp;<span class="op" id="8396778">!=</span>&nbsp;<span class="ident" id="8396781">nil</span>&nbsp;<span class="op" id="8396785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396789">t</span><span class="op" id="8396790">.</span><span class="ident" id="8396791">Fatalf</span><span class="op" id="8396797">(</span><span class="string" id="8396798">&#34;querying&nbsp;id&nbsp;20:&nbsp;%v&#34;</span><span class="op" id="8396818">,</span>&nbsp;<span class="ident" id="8396820">err</span><span class="op" id="8396823">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8396826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8396829">if</span>&nbsp;<span class="ident" id="8396832">name</span>&nbsp;<span class="op" id="8396837">!=</span>&nbsp;<span class="ident" id="8396840">nil</span>&nbsp;<span class="op" id="8396844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396848">t</span><span class="op" id="8396849">.</span><span class="ident" id="8396850">Errorf</span><span class="op" id="8396856">(</span><span class="string" id="8396857">&#34;id&nbsp;20&nbsp;=&nbsp;%q;&nbsp;want&nbsp;nil&#34;</span><span class="op" id="8396879">,</span>&nbsp;<span class="op" id="8396881">*</span><span class="ident" id="8396882">name</span><span class="op" id="8396886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8396889">}</span><br>
<span class="lineno"></span><span class="op" id="8396891">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="8396894">func</span>&nbsp;<span class="ident" id="8396899">TestQueryRowClosingStmt</span><span class="op" id="8396922">(</span><span class="ident" id="8396923">t</span>&nbsp;<span class="op" id="8396925">*</span><span class="ident" id="8396926">testing</span><span class="op" id="8396933">.</span><span class="ident" id="8396934">T</span><span class="op" id="8396935">)</span>&nbsp;<span class="op" id="8396937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396940">db</span>&nbsp;<span class="op" id="8396943">:=</span>&nbsp;<span class="ident" id="8396946">newTestDB</span><span class="op" id="8396955">(</span><span class="ident" id="8396956">t</span><span class="op" id="8396957">,</span>&nbsp;<span class="string" id="8396959">&#34;people&#34;</span><span class="op" id="8396967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8396970">defer</span>&nbsp;<span class="ident" id="8396976">closeDB</span><span class="op" id="8396983">(</span><span class="ident" id="8396984">t</span><span class="op" id="8396985">,</span>&nbsp;<span class="ident" id="8396987">db</span><span class="op" id="8396989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8396992">var</span>&nbsp;<span class="ident" id="8396996">name</span>&nbsp;<span class="builtintype" id="8397001">string</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8397009">var</span>&nbsp;<span class="ident" id="8397013">age</span>&nbsp;<span class="builtintype" id="8397017">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397022">err</span>&nbsp;<span class="op" id="8397026">:=</span>&nbsp;<span class="ident" id="8397029">db</span><span class="op" id="8397031">.</span><span class="ident" id="8397032">QueryRow</span><span class="op" id="8397040">(</span><span class="string" id="8397041">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="8397071">,</span>&nbsp;<span class="num" id="8397073">3</span><span class="op" id="8397074">)</span><span class="op" id="8397075">.</span><span class="ident" id="8397076">Scan</span><span class="op" id="8397080">(</span><span class="op" id="8397081">&amp;</span><span class="ident" id="8397082">age</span><span class="op" id="8397085">,</span>&nbsp;<span class="op" id="8397087">&amp;</span><span class="ident" id="8397088">name</span><span class="op" id="8397092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8397095">if</span>&nbsp;<span class="ident" id="8397098">err</span>&nbsp;<span class="op" id="8397102">!=</span>&nbsp;<span class="ident" id="8397105">nil</span>&nbsp;<span class="op" id="8397109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397113">t</span><span class="op" id="8397114">.</span><span class="ident" id="8397115">Fatal</span><span class="op" id="8397120">(</span><span class="ident" id="8397121">err</span><span class="op" id="8397124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8397127">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8397130">if</span>&nbsp;<span class="builtinfunc" id="8397133">len</span><span class="op" id="8397136">(</span><span class="ident" id="8397137">db</span><span class="op" id="8397139">.</span><span class="ident" id="8397140">freeConn</span><span class="op" id="8397148">)</span>&nbsp;<span class="op" id="8397150">!=</span>&nbsp;<span class="num" id="8397153">1</span>&nbsp;<span class="op" id="8397155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397159">t</span><span class="op" id="8397160">.</span><span class="ident" id="8397161">Fatalf</span><span class="op" id="8397167">(</span><span class="string" id="8397168">&#34;expected&nbsp;1&nbsp;free&nbsp;conn&#34;</span><span class="op" id="8397190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8397193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397196">fakeConn</span>&nbsp;<span class="op" id="8397205">:=</span>&nbsp;<span class="ident" id="8397208">db</span><span class="op" id="8397210">.</span><span class="ident" id="8397211">freeConn</span><span class="op" id="8397219">[</span><span class="num" id="8397220">0</span><span class="op" id="8397221">]</span><span class="op" id="8397222">.</span><span class="ident" id="8397223">ci</span><span class="op" id="8397225">.</span><span class="op" id="8397226">(</span><span class="op" id="8397227">*</span><span class="ident" id="8397228">fakeConn</span><span class="op" id="8397236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8397239">if</span>&nbsp;<span class="ident" id="8397242">made</span><span class="op" id="8397246">,</span>&nbsp;<span class="ident" id="8397248">closed</span>&nbsp;<span class="op" id="8397255">:=</span>&nbsp;<span class="ident" id="8397258">fakeConn</span><span class="op" id="8397266">.</span><span class="ident" id="8397267">stmtsMade</span><span class="op" id="8397276">,</span>&nbsp;<span class="ident" id="8397278">fakeConn</span><span class="op" id="8397286">.</span><span class="ident" id="8397287">stmtsClosed</span><span class="op" id="8397298">;</span>&nbsp;<span class="ident" id="8397300">made</span>&nbsp;<span class="op" id="8397305">!=</span>&nbsp;<span class="ident" id="8397308">closed</span>&nbsp;<span class="op" id="8397315">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397319">t</span><span class="op" id="8397320">.</span><span class="ident" id="8397321">Errorf</span><span class="op" id="8397327">(</span><span class="string" id="8397328">&#34;statement&nbsp;close&nbsp;mismatch:&nbsp;made&nbsp;%d,&nbsp;closed&nbsp;%d&#34;</span><span class="op" id="8397374">,</span>&nbsp;<span class="ident" id="8397376">made</span><span class="op" id="8397380">,</span>&nbsp;<span class="ident" id="8397382">closed</span><span class="op" id="8397388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8397391">}</span><br>
<span class="lineno"></span><span class="op" id="8397393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8397396">//&nbsp;Test&nbsp;issue&nbsp;6651</span><br>
<span class="lineno">700</span><span class="keyword" id="8397415">func</span>&nbsp;<span class="ident" id="8397420">TestIssue6651</span><span class="op" id="8397433">(</span><span class="ident" id="8397434">t</span>&nbsp;<span class="op" id="8397436">*</span><span class="ident" id="8397437">testing</span><span class="op" id="8397444">.</span><span class="ident" id="8397445">T</span><span class="op" id="8397446">)</span>&nbsp;<span class="op" id="8397448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397451">db</span>&nbsp;<span class="op" id="8397454">:=</span>&nbsp;<span class="ident" id="8397457">newTestDB</span><span class="op" id="8397466">(</span><span class="ident" id="8397467">t</span><span class="op" id="8397468">,</span>&nbsp;<span class="string" id="8397470">&#34;people&#34;</span><span class="op" id="8397478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8397481">defer</span>&nbsp;<span class="ident" id="8397487">closeDB</span><span class="op" id="8397494">(</span><span class="ident" id="8397495">t</span><span class="op" id="8397496">,</span>&nbsp;<span class="ident" id="8397498">db</span><span class="op" id="8397500">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8397504">var</span>&nbsp;<span class="ident" id="8397508">v</span>&nbsp;<span class="builtintype" id="8397510">string</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397519">want</span>&nbsp;<span class="op" id="8397524">:=</span>&nbsp;<span class="string" id="8397527">&#34;error&nbsp;in&nbsp;rows.Next&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397549">rowsCursorNextHook</span>&nbsp;<span class="op" id="8397568">=</span>&nbsp;<span class="keyword" id="8397570">func</span><span class="op" id="8397574">(</span><span class="ident" id="8397575">dest</span>&nbsp;<span class="op" id="8397580">[</span><span class="op" id="8397581">]</span><span class="ident" id="8397582">driver</span><span class="op" id="8397588">.</span><span class="ident" id="8397589">Value</span><span class="op" id="8397594">)</span>&nbsp;<span class="builtintype" id="8397596">error</span>&nbsp;<span class="op" id="8397602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8397606">return</span>&nbsp;<span class="ident" id="8397613">fmt</span><span class="op" id="8397616">.</span><span class="ident" id="8397617">Errorf</span><span class="op" id="8397623">(</span><span class="ident" id="8397624">want</span><span class="op" id="8397628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8397631">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8397634">defer</span>&nbsp;<span class="keyword" id="8397640">func</span><span class="op" id="8397644">(</span><span class="op" id="8397645">)</span>&nbsp;<span class="op" id="8397647">{</span>&nbsp;<span class="ident" id="8397649">rowsCursorNextHook</span>&nbsp;<span class="op" id="8397668">=</span>&nbsp;<span class="ident" id="8397670">nil</span>&nbsp;<span class="op" id="8397674">}</span><span class="op" id="8397675">(</span><span class="op" id="8397676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397679">err</span>&nbsp;<span class="op" id="8397683">:=</span>&nbsp;<span class="ident" id="8397686">db</span><span class="op" id="8397688">.</span><span class="ident" id="8397689">QueryRow</span><span class="op" id="8397697">(</span><span class="string" id="8397698">&#34;SELECT|people|name|&#34;</span><span class="op" id="8397719">)</span><span class="op" id="8397720">.</span><span class="ident" id="8397721">Scan</span><span class="op" id="8397725">(</span><span class="op" id="8397726">&amp;</span><span class="ident" id="8397727">v</span><span class="op" id="8397728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8397731">if</span>&nbsp;<span class="ident" id="8397734">err</span>&nbsp;<span class="op" id="8397738">==</span>&nbsp;<span class="ident" id="8397741">nil</span>&nbsp;<span class="op" id="8397745">||</span>&nbsp;<span class="ident" id="8397748">err</span><span class="op" id="8397751">.</span><span class="ident" id="8397752">Error</span><span class="op" id="8397757">(</span><span class="op" id="8397758">)</span>&nbsp;<span class="op" id="8397760">!=</span>&nbsp;<span class="ident" id="8397763">want</span>&nbsp;<span class="op" id="8397768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397772">t</span><span class="op" id="8397773">.</span><span class="ident" id="8397774">Errorf</span><span class="op" id="8397780">(</span><span class="string" id="8397781">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8397802">,</span>&nbsp;<span class="ident" id="8397804">err</span><span class="op" id="8397807">,</span>&nbsp;<span class="ident" id="8397809">want</span><span class="op" id="8397813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8397816">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397819">rowsCursorNextHook</span>&nbsp;<span class="op" id="8397838">=</span>&nbsp;<span class="ident" id="8397840">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397846">want</span>&nbsp;<span class="op" id="8397851">=</span>&nbsp;<span class="string" id="8397853">&#34;error&nbsp;in&nbsp;rows.Close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397876">rowsCloseHook</span>&nbsp;<span class="op" id="8397890">=</span>&nbsp;<span class="keyword" id="8397892">func</span><span class="op" id="8397896">(</span><span class="ident" id="8397897">rows</span>&nbsp;<span class="op" id="8397902">*</span><span class="ident" id="8397903">Rows</span><span class="op" id="8397907">,</span>&nbsp;<span class="ident" id="8397909">err</span>&nbsp;<span class="op" id="8397913">*</span><span class="builtintype" id="8397914">error</span><span class="op" id="8397919">)</span>&nbsp;<span class="op" id="8397921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8397925">*</span><span class="ident" id="8397926">err</span>&nbsp;<span class="op" id="8397930">=</span>&nbsp;<span class="ident" id="8397932">fmt</span><span class="op" id="8397935">.</span><span class="ident" id="8397936">Errorf</span><span class="op" id="8397942">(</span><span class="ident" id="8397943">want</span><span class="op" id="8397947">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8397950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8397953">defer</span>&nbsp;<span class="keyword" id="8397959">func</span><span class="op" id="8397963">(</span><span class="op" id="8397964">)</span>&nbsp;<span class="op" id="8397966">{</span>&nbsp;<span class="ident" id="8397968">rowsCloseHook</span>&nbsp;<span class="op" id="8397982">=</span>&nbsp;<span class="ident" id="8397984">nil</span>&nbsp;<span class="op" id="8397988">}</span><span class="op" id="8397989">(</span><span class="op" id="8397990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397993">err</span>&nbsp;<span class="op" id="8397997">=</span>&nbsp;<span class="ident" id="8397999">db</span><span class="op" id="8398001">.</span><span class="ident" id="8398002">QueryRow</span><span class="op" id="8398010">(</span><span class="string" id="8398011">&#34;SELECT|people|name|&#34;</span><span class="op" id="8398032">)</span><span class="op" id="8398033">.</span><span class="ident" id="8398034">Scan</span><span class="op" id="8398038">(</span><span class="op" id="8398039">&amp;</span><span class="ident" id="8398040">v</span><span class="op" id="8398041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8398044">if</span>&nbsp;<span class="ident" id="8398047">err</span>&nbsp;<span class="op" id="8398051">==</span>&nbsp;<span class="ident" id="8398054">nil</span>&nbsp;<span class="op" id="8398058">||</span>&nbsp;<span class="ident" id="8398061">err</span><span class="op" id="8398064">.</span><span class="ident" id="8398065">Error</span><span class="op" id="8398070">(</span><span class="op" id="8398071">)</span>&nbsp;<span class="op" id="8398073">!=</span>&nbsp;<span class="ident" id="8398076">want</span>&nbsp;<span class="op" id="8398081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398085">t</span><span class="op" id="8398086">.</span><span class="ident" id="8398087">Errorf</span><span class="op" id="8398093">(</span><span class="string" id="8398094">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8398115">,</span>&nbsp;<span class="ident" id="8398117">err</span><span class="op" id="8398120">,</span>&nbsp;<span class="ident" id="8398122">want</span><span class="op" id="8398126">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398129">}</span><br>
<span class="lineno"></span><span class="op" id="8398131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8398134">type</span>&nbsp;<span class="ident" id="8398139">nullTestRow</span>&nbsp;<span class="keyword" id="8398151">struct</span>&nbsp;<span class="op" id="8398158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398161">nullParam</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8398174">interface</span><span class="op" id="8398183">{</span><span class="op" id="8398184">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398187">notNullParam</span>&nbsp;<span class="keyword" id="8398200">interface</span><span class="op" id="8398209">{</span><span class="op" id="8398210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398213">scanNullVal</span>&nbsp;&nbsp;<span class="keyword" id="8398226">interface</span><span class="op" id="8398235">{</span><span class="op" id="8398236">}</span><br>
<span class="lineno"></span><span class="op" id="8398238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8398241">type</span>&nbsp;<span class="ident" id="8398246">nullTestSpec</span>&nbsp;<span class="keyword" id="8398259">struct</span>&nbsp;<span class="op" id="8398266">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398269">nullType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8398281">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398289">notNullType</span>&nbsp;<span class="builtintype" id="8398301">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398309">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8398321">[</span><span class="num" id="8398322">6</span><span class="op" id="8398323">]</span><span class="ident" id="8398324">nullTestRow</span><br>
<span class="lineno"></span><span class="op" id="8398336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">740</span><span class="keyword" id="8398339">func</span>&nbsp;<span class="ident" id="8398344">TestNullStringParam</span><span class="op" id="8398363">(</span><span class="ident" id="8398364">t</span>&nbsp;<span class="op" id="8398366">*</span><span class="ident" id="8398367">testing</span><span class="op" id="8398374">.</span><span class="ident" id="8398375">T</span><span class="op" id="8398376">)</span>&nbsp;<span class="op" id="8398378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398381">spec</span>&nbsp;<span class="op" id="8398386">:=</span>&nbsp;<span class="ident" id="8398389">nullTestSpec</span><span class="op" id="8398401">{</span><span class="string" id="8398402">&#34;nullstring&#34;</span><span class="op" id="8398414">,</span>&nbsp;<span class="string" id="8398416">&#34;string&#34;</span><span class="op" id="8398424">,</span>&nbsp;<span class="op" id="8398426">[</span><span class="num" id="8398427">6</span><span class="op" id="8398428">]</span><span class="ident" id="8398429">nullTestRow</span><span class="op" id="8398440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398444">{</span><span class="ident" id="8398445">NullString</span><span class="op" id="8398455">{</span><span class="string" id="8398456">&#34;aqua&#34;</span><span class="op" id="8398462">,</span>&nbsp;<span class="builtintype" id="8398464">true</span><span class="op" id="8398468">}</span><span class="op" id="8398469">,</span>&nbsp;<span class="string" id="8398471">&#34;&#34;</span><span class="op" id="8398473">,</span>&nbsp;<span class="ident" id="8398475">NullString</span><span class="op" id="8398485">{</span><span class="string" id="8398486">&#34;aqua&#34;</span><span class="op" id="8398492">,</span>&nbsp;<span class="builtintype" id="8398494">true</span><span class="op" id="8398498">}</span><span class="op" id="8398499">}</span><span class="op" id="8398500">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398504">{</span><span class="ident" id="8398505">NullString</span><span class="op" id="8398515">{</span><span class="string" id="8398516">&#34;brown&#34;</span><span class="op" id="8398523">,</span>&nbsp;<span class="builtintype" id="8398525">false</span><span class="op" id="8398530">}</span><span class="op" id="8398531">,</span>&nbsp;<span class="string" id="8398533">&#34;&#34;</span><span class="op" id="8398535">,</span>&nbsp;<span class="ident" id="8398537">NullString</span><span class="op" id="8398547">{</span><span class="string" id="8398548">&#34;&#34;</span><span class="op" id="8398550">,</span>&nbsp;<span class="builtintype" id="8398552">false</span><span class="op" id="8398557">}</span><span class="op" id="8398558">}</span><span class="op" id="8398559">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398563">{</span><span class="string" id="8398564">&#34;chartreuse&#34;</span><span class="op" id="8398576">,</span>&nbsp;<span class="string" id="8398578">&#34;&#34;</span><span class="op" id="8398580">,</span>&nbsp;<span class="ident" id="8398582">NullString</span><span class="op" id="8398592">{</span><span class="string" id="8398593">&#34;chartreuse&#34;</span><span class="op" id="8398605">,</span>&nbsp;<span class="builtintype" id="8398607">true</span><span class="op" id="8398611">}</span><span class="op" id="8398612">}</span><span class="op" id="8398613">,</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398617">{</span><span class="ident" id="8398618">NullString</span><span class="op" id="8398628">{</span><span class="string" id="8398629">&#34;darkred&#34;</span><span class="op" id="8398638">,</span>&nbsp;<span class="builtintype" id="8398640">true</span><span class="op" id="8398644">}</span><span class="op" id="8398645">,</span>&nbsp;<span class="string" id="8398647">&#34;&#34;</span><span class="op" id="8398649">,</span>&nbsp;<span class="ident" id="8398651">NullString</span><span class="op" id="8398661">{</span><span class="string" id="8398662">&#34;darkred&#34;</span><span class="op" id="8398671">,</span>&nbsp;<span class="builtintype" id="8398673">true</span><span class="op" id="8398677">}</span><span class="op" id="8398678">}</span><span class="op" id="8398679">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398683">{</span><span class="ident" id="8398684">NullString</span><span class="op" id="8398694">{</span><span class="string" id="8398695">&#34;eel&#34;</span><span class="op" id="8398700">,</span>&nbsp;<span class="builtintype" id="8398702">false</span><span class="op" id="8398707">}</span><span class="op" id="8398708">,</span>&nbsp;<span class="string" id="8398710">&#34;&#34;</span><span class="op" id="8398712">,</span>&nbsp;<span class="ident" id="8398714">NullString</span><span class="op" id="8398724">{</span><span class="string" id="8398725">&#34;&#34;</span><span class="op" id="8398727">,</span>&nbsp;<span class="builtintype" id="8398729">false</span><span class="op" id="8398734">}</span><span class="op" id="8398735">}</span><span class="op" id="8398736">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398740">{</span><span class="string" id="8398741">&#34;foo&#34;</span><span class="op" id="8398746">,</span>&nbsp;<span class="ident" id="8398748">NullString</span><span class="op" id="8398758">{</span><span class="string" id="8398759">&#34;black&#34;</span><span class="op" id="8398766">,</span>&nbsp;<span class="builtintype" id="8398768">false</span><span class="op" id="8398773">}</span><span class="op" id="8398774">,</span>&nbsp;<span class="ident" id="8398776">nil</span><span class="op" id="8398779">}</span><span class="op" id="8398780">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398783">}</span><span class="op" id="8398784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398787">nullTestRun</span><span class="op" id="8398798">(</span><span class="ident" id="8398799">t</span><span class="op" id="8398800">,</span>&nbsp;<span class="ident" id="8398802">spec</span><span class="op" id="8398806">)</span><br>
<span class="lineno">750</span><span class="op" id="8398808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8398811">func</span>&nbsp;<span class="ident" id="8398816">TestNullInt64Param</span><span class="op" id="8398834">(</span><span class="ident" id="8398835">t</span>&nbsp;<span class="op" id="8398837">*</span><span class="ident" id="8398838">testing</span><span class="op" id="8398845">.</span><span class="ident" id="8398846">T</span><span class="op" id="8398847">)</span>&nbsp;<span class="op" id="8398849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398852">spec</span>&nbsp;<span class="op" id="8398857">:=</span>&nbsp;<span class="ident" id="8398860">nullTestSpec</span><span class="op" id="8398872">{</span><span class="string" id="8398873">&#34;nullint64&#34;</span><span class="op" id="8398884">,</span>&nbsp;<span class="string" id="8398886">&#34;int64&#34;</span><span class="op" id="8398893">,</span>&nbsp;<span class="op" id="8398895">[</span><span class="num" id="8398896">6</span><span class="op" id="8398897">]</span><span class="ident" id="8398898">nullTestRow</span><span class="op" id="8398909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398913">{</span><span class="ident" id="8398914">NullInt64</span><span class="op" id="8398923">{</span><span class="num" id="8398924">31</span><span class="op" id="8398926">,</span>&nbsp;<span class="builtintype" id="8398928">true</span><span class="op" id="8398932">}</span><span class="op" id="8398933">,</span>&nbsp;<span class="num" id="8398935">1</span><span class="op" id="8398936">,</span>&nbsp;<span class="ident" id="8398938">NullInt64</span><span class="op" id="8398947">{</span><span class="num" id="8398948">31</span><span class="op" id="8398950">,</span>&nbsp;<span class="builtintype" id="8398952">true</span><span class="op" id="8398956">}</span><span class="op" id="8398957">}</span><span class="op" id="8398958">,</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398962">{</span><span class="ident" id="8398963">NullInt64</span><span class="op" id="8398972">{</span><span class="op" id="8398973">-</span><span class="num" id="8398974">22</span><span class="op" id="8398976">,</span>&nbsp;<span class="builtintype" id="8398978">false</span><span class="op" id="8398983">}</span><span class="op" id="8398984">,</span>&nbsp;<span class="num" id="8398986">1</span><span class="op" id="8398987">,</span>&nbsp;<span class="ident" id="8398989">NullInt64</span><span class="op" id="8398998">{</span><span class="num" id="8398999">0</span><span class="op" id="8399000">,</span>&nbsp;<span class="builtintype" id="8399002">false</span><span class="op" id="8399007">}</span><span class="op" id="8399008">}</span><span class="op" id="8399009">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399013">{</span><span class="num" id="8399014">22</span><span class="op" id="8399016">,</span>&nbsp;<span class="num" id="8399018">1</span><span class="op" id="8399019">,</span>&nbsp;<span class="ident" id="8399021">NullInt64</span><span class="op" id="8399030">{</span><span class="num" id="8399031">22</span><span class="op" id="8399033">,</span>&nbsp;<span class="builtintype" id="8399035">true</span><span class="op" id="8399039">}</span><span class="op" id="8399040">}</span><span class="op" id="8399041">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399045">{</span><span class="ident" id="8399046">NullInt64</span><span class="op" id="8399055">{</span><span class="num" id="8399056">33</span><span class="op" id="8399058">,</span>&nbsp;<span class="builtintype" id="8399060">true</span><span class="op" id="8399064">}</span><span class="op" id="8399065">,</span>&nbsp;<span class="num" id="8399067">1</span><span class="op" id="8399068">,</span>&nbsp;<span class="ident" id="8399070">NullInt64</span><span class="op" id="8399079">{</span><span class="num" id="8399080">33</span><span class="op" id="8399082">,</span>&nbsp;<span class="builtintype" id="8399084">true</span><span class="op" id="8399088">}</span><span class="op" id="8399089">}</span><span class="op" id="8399090">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399094">{</span><span class="ident" id="8399095">NullInt64</span><span class="op" id="8399104">{</span><span class="num" id="8399105">222</span><span class="op" id="8399108">,</span>&nbsp;<span class="builtintype" id="8399110">false</span><span class="op" id="8399115">}</span><span class="op" id="8399116">,</span>&nbsp;<span class="num" id="8399118">1</span><span class="op" id="8399119">,</span>&nbsp;<span class="ident" id="8399121">NullInt64</span><span class="op" id="8399130">{</span><span class="num" id="8399131">0</span><span class="op" id="8399132">,</span>&nbsp;<span class="builtintype" id="8399134">false</span><span class="op" id="8399139">}</span><span class="op" id="8399140">}</span><span class="op" id="8399141">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399145">{</span><span class="num" id="8399146">0</span><span class="op" id="8399147">,</span>&nbsp;<span class="ident" id="8399149">NullInt64</span><span class="op" id="8399158">{</span><span class="num" id="8399159">31</span><span class="op" id="8399161">,</span>&nbsp;<span class="builtintype" id="8399163">false</span><span class="op" id="8399168">}</span><span class="op" id="8399169">,</span>&nbsp;<span class="ident" id="8399171">nil</span><span class="op" id="8399174">}</span><span class="op" id="8399175">,</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399178">}</span><span class="op" id="8399179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8399182">nullTestRun</span><span class="op" id="8399193">(</span><span class="ident" id="8399194">t</span><span class="op" id="8399195">,</span>&nbsp;<span class="ident" id="8399197">spec</span><span class="op" id="8399201">)</span><br>
<span class="lineno"></span><span class="op" id="8399203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8399206">func</span>&nbsp;<span class="ident" id="8399211">TestNullFloat64Param</span><span class="op" id="8399231">(</span><span class="ident" id="8399232">t</span>&nbsp;<span class="op" id="8399234">*</span><span class="ident" id="8399235">testing</span><span class="op" id="8399242">.</span><span class="ident" id="8399243">T</span><span class="op" id="8399244">)</span>&nbsp;<span class="op" id="8399246">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8399249">spec</span>&nbsp;<span class="op" id="8399254">:=</span>&nbsp;<span class="ident" id="8399257">nullTestSpec</span><span class="op" id="8399269">{</span><span class="string" id="8399270">&#34;nullfloat64&#34;</span><span class="op" id="8399283">,</span>&nbsp;<span class="string" id="8399285">&#34;float64&#34;</span><span class="op" id="8399294">,</span>&nbsp;<span class="op" id="8399296">[</span><span class="num" id="8399297">6</span><span class="op" id="8399298">]</span><span class="ident" id="8399299">nullTestRow</span><span class="op" id="8399310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399314">{</span><span class="ident" id="8399315">NullFloat64</span><span class="op" id="8399326">{</span><span class="num" id="8399327">31.2</span><span class="op" id="8399331">,</span>&nbsp;<span class="builtintype" id="8399333">true</span><span class="op" id="8399337">}</span><span class="op" id="8399338">,</span>&nbsp;<span class="num" id="8399340">1</span><span class="op" id="8399341">,</span>&nbsp;<span class="ident" id="8399343">NullFloat64</span><span class="op" id="8399354">{</span><span class="num" id="8399355">31.2</span><span class="op" id="8399359">,</span>&nbsp;<span class="builtintype" id="8399361">true</span><span class="op" id="8399365">}</span><span class="op" id="8399366">}</span><span class="op" id="8399367">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399371">{</span><span class="ident" id="8399372">NullFloat64</span><span class="op" id="8399383">{</span><span class="num" id="8399384">13.1</span><span class="op" id="8399388">,</span>&nbsp;<span class="builtintype" id="8399390">false</span><span class="op" id="8399395">}</span><span class="op" id="8399396">,</span>&nbsp;<span class="num" id="8399398">1</span><span class="op" id="8399399">,</span>&nbsp;<span class="ident" id="8399401">NullFloat64</span><span class="op" id="8399412">{</span><span class="num" id="8399413">0</span><span class="op" id="8399414">,</span>&nbsp;<span class="builtintype" id="8399416">false</span><span class="op" id="8399421">}</span><span class="op" id="8399422">}</span><span class="op" id="8399423">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399427">{</span><span class="op" id="8399428">-</span><span class="num" id="8399429">22.9</span><span class="op" id="8399433">,</span>&nbsp;<span class="num" id="8399435">1</span><span class="op" id="8399436">,</span>&nbsp;<span class="ident" id="8399438">NullFloat64</span><span class="op" id="8399449">{</span><span class="op" id="8399450">-</span><span class="num" id="8399451">22.9</span><span class="op" id="8399455">,</span>&nbsp;<span class="builtintype" id="8399457">true</span><span class="op" id="8399461">}</span><span class="op" id="8399462">}</span><span class="op" id="8399463">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399467">{</span><span class="ident" id="8399468">NullFloat64</span><span class="op" id="8399479">{</span><span class="num" id="8399480">33.81</span><span class="op" id="8399485">,</span>&nbsp;<span class="builtintype" id="8399487">true</span><span class="op" id="8399491">}</span><span class="op" id="8399492">,</span>&nbsp;<span class="num" id="8399494">1</span><span class="op" id="8399495">,</span>&nbsp;<span class="ident" id="8399497">NullFloat64</span><span class="op" id="8399508">{</span><span class="num" id="8399509">33.81</span><span class="op" id="8399514">,</span>&nbsp;<span class="builtintype" id="8399516">true</span><span class="op" id="8399520">}</span><span class="op" id="8399521">}</span><span class="op" id="8399522">,</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399526">{</span><span class="ident" id="8399527">NullFloat64</span><span class="op" id="8399538">{</span><span class="num" id="8399539">222</span><span class="op" id="8399542">,</span>&nbsp;<span class="builtintype" id="8399544">false</span><span class="op" id="8399549">}</span><span class="op" id="8399550">,</span>&nbsp;<span class="num" id="8399552">1</span><span class="op" id="8399553">,</span>&nbsp;<span class="ident" id="8399555">NullFloat64</span><span class="op" id="8399566">{</span><span class="num" id="8399567">0</span><span class="op" id="8399568">,</span>&nbsp;<span class="builtintype" id="8399570">false</span><span class="op" id="8399575">}</span><span class="op" id="8399576">}</span><span class="op" id="8399577">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399581">{</span><span class="num" id="8399582">10</span><span class="op" id="8399584">,</span>&nbsp;<span class="ident" id="8399586">NullFloat64</span><span class="op" id="8399597">{</span><span class="num" id="8399598">31.2</span><span class="op" id="8399602">,</span>&nbsp;<span class="builtintype" id="8399604">false</span><span class="op" id="8399609">}</span><span class="op" id="8399610">,</span>&nbsp;<span class="ident" id="8399612">nil</span><span class="op" id="8399615">}</span><span class="op" id="8399616">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399619">}</span><span class="op" id="8399620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8399623">nullTestRun</span><span class="op" id="8399634">(</span><span class="ident" id="8399635">t</span><span class="op" id="8399636">,</span>&nbsp;<span class="ident" id="8399638">spec</span><span class="op" id="8399642">)</span><br>
<span class="lineno"></span><span class="op" id="8399644">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="keyword" id="8399647">func</span>&nbsp;<span class="ident" id="8399652">TestNullBoolParam</span><span class="op" id="8399669">(</span><span class="ident" id="8399670">t</span>&nbsp;<span class="op" id="8399672">*</span><span class="ident" id="8399673">testing</span><span class="op" id="8399680">.</span><span class="ident" id="8399681">T</span><span class="op" id="8399682">)</span>&nbsp;<span class="op" id="8399684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8399687">spec</span>&nbsp;<span class="op" id="8399692">:=</span>&nbsp;<span class="ident" id="8399695">nullTestSpec</span><span class="op" id="8399707">{</span><span class="string" id="8399708">&#34;nullbool&#34;</span><span class="op" id="8399718">,</span>&nbsp;<span class="string" id="8399720">&#34;bool&#34;</span><span class="op" id="8399726">,</span>&nbsp;<span class="op" id="8399728">[</span><span class="num" id="8399729">6</span><span class="op" id="8399730">]</span><span class="ident" id="8399731">nullTestRow</span><span class="op" id="8399742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399746">{</span><span class="ident" id="8399747">NullBool</span><span class="op" id="8399755">{</span><span class="builtintype" id="8399756">false</span><span class="op" id="8399761">,</span>&nbsp;<span class="builtintype" id="8399763">true</span><span class="op" id="8399767">}</span><span class="op" id="8399768">,</span>&nbsp;<span class="builtintype" id="8399770">true</span><span class="op" id="8399774">,</span>&nbsp;<span class="ident" id="8399776">NullBool</span><span class="op" id="8399784">{</span><span class="builtintype" id="8399785">false</span><span class="op" id="8399790">,</span>&nbsp;<span class="builtintype" id="8399792">true</span><span class="op" id="8399796">}</span><span class="op" id="8399797">}</span><span class="op" id="8399798">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399802">{</span><span class="ident" id="8399803">NullBool</span><span class="op" id="8399811">{</span><span class="builtintype" id="8399812">true</span><span class="op" id="8399816">,</span>&nbsp;<span class="builtintype" id="8399818">false</span><span class="op" id="8399823">}</span><span class="op" id="8399824">,</span>&nbsp;<span class="builtintype" id="8399826">false</span><span class="op" id="8399831">,</span>&nbsp;<span class="ident" id="8399833">NullBool</span><span class="op" id="8399841">{</span><span class="builtintype" id="8399842">false</span><span class="op" id="8399847">,</span>&nbsp;<span class="builtintype" id="8399849">false</span><span class="op" id="8399854">}</span><span class="op" id="8399855">}</span><span class="op" id="8399856">,</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399860">{</span><span class="builtintype" id="8399861">true</span><span class="op" id="8399865">,</span>&nbsp;<span class="builtintype" id="8399867">true</span><span class="op" id="8399871">,</span>&nbsp;<span class="ident" id="8399873">NullBool</span><span class="op" id="8399881">{</span><span class="builtintype" id="8399882">true</span><span class="op" id="8399886">,</span>&nbsp;<span class="builtintype" id="8399888">true</span><span class="op" id="8399892">}</span><span class="op" id="8399893">}</span><span class="op" id="8399894">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399898">{</span><span class="ident" id="8399899">NullBool</span><span class="op" id="8399907">{</span><span class="builtintype" id="8399908">true</span><span class="op" id="8399912">,</span>&nbsp;<span class="builtintype" id="8399914">true</span><span class="op" id="8399918">}</span><span class="op" id="8399919">,</span>&nbsp;<span class="builtintype" id="8399921">false</span><span class="op" id="8399926">,</span>&nbsp;<span class="ident" id="8399928">NullBool</span><span class="op" id="8399936">{</span><span class="builtintype" id="8399937">true</span><span class="op" id="8399941">,</span>&nbsp;<span class="builtintype" id="8399943">true</span><span class="op" id="8399947">}</span><span class="op" id="8399948">}</span><span class="op" id="8399949">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399953">{</span><span class="ident" id="8399954">NullBool</span><span class="op" id="8399962">{</span><span class="builtintype" id="8399963">true</span><span class="op" id="8399967">,</span>&nbsp;<span class="builtintype" id="8399969">false</span><span class="op" id="8399974">}</span><span class="op" id="8399975">,</span>&nbsp;<span class="builtintype" id="8399977">true</span><span class="op" id="8399981">,</span>&nbsp;<span class="ident" id="8399983">NullBool</span><span class="op" id="8399991">{</span><span class="builtintype" id="8399992">false</span><span class="op" id="8399997">,</span>&nbsp;<span class="builtintype" id="8399999">false</span><span class="op" id="8400004">}</span><span class="op" id="8400005">}</span><span class="op" id="8400006">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8400010">{</span><span class="builtintype" id="8400011">true</span><span class="op" id="8400015">,</span>&nbsp;<span class="ident" id="8400017">NullBool</span><span class="op" id="8400025">{</span><span class="builtintype" id="8400026">true</span><span class="op" id="8400030">,</span>&nbsp;<span class="builtintype" id="8400032">false</span><span class="op" id="8400037">}</span><span class="op" id="8400038">,</span>&nbsp;<span class="ident" id="8400040">nil</span><span class="op" id="8400043">}</span><span class="op" id="8400044">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8400047">}</span><span class="op" id="8400048">}</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400051">nullTestRun</span><span class="op" id="8400062">(</span><span class="ident" id="8400063">t</span><span class="op" id="8400064">,</span>&nbsp;<span class="ident" id="8400066">spec</span><span class="op" id="8400070">)</span><br>
<span class="lineno"></span><span class="op" id="8400072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8400075">func</span>&nbsp;<span class="ident" id="8400080">nullTestRun</span><span class="op" id="8400091">(</span><span class="ident" id="8400092">t</span>&nbsp;<span class="op" id="8400094">*</span><span class="ident" id="8400095">testing</span><span class="op" id="8400102">.</span><span class="ident" id="8400103">T</span><span class="op" id="8400104">,</span>&nbsp;<span class="ident" id="8400106">spec</span>&nbsp;<span class="ident" id="8400111">nullTestSpec</span><span class="op" id="8400123">)</span>&nbsp;<span class="op" id="8400125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400128">db</span>&nbsp;<span class="op" id="8400131">:=</span>&nbsp;<span class="ident" id="8400134">newTestDB</span><span class="op" id="8400143">(</span><span class="ident" id="8400144">t</span><span class="op" id="8400145">,</span>&nbsp;<span class="string" id="8400147">&#34;&#34;</span><span class="op" id="8400149">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8400152">defer</span>&nbsp;<span class="ident" id="8400158">closeDB</span><span class="op" id="8400165">(</span><span class="ident" id="8400166">t</span><span class="op" id="8400167">,</span>&nbsp;<span class="ident" id="8400169">db</span><span class="op" id="8400171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400174">exec</span><span class="op" id="8400178">(</span><span class="ident" id="8400179">t</span><span class="op" id="8400180">,</span>&nbsp;<span class="ident" id="8400182">db</span><span class="op" id="8400184">,</span>&nbsp;<span class="ident" id="8400186">fmt</span><span class="op" id="8400189">.</span><span class="ident" id="8400190">Sprintf</span><span class="op" id="8400197">(</span><span class="string" id="8400198">&#34;CREATE|t|id=int32,name=string,nullf=%s,notnullf=%s&#34;</span><span class="op" id="8400250">,</span>&nbsp;<span class="ident" id="8400252">spec</span><span class="op" id="8400256">.</span><span class="ident" id="8400257">nullType</span><span class="op" id="8400265">,</span>&nbsp;<span class="ident" id="8400267">spec</span><span class="op" id="8400271">.</span><span class="ident" id="8400272">notNullType</span><span class="op" id="8400283">)</span><span class="op" id="8400284">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8400288">//&nbsp;Inserts&nbsp;with&nbsp;db.Exec:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400314">exec</span><span class="op" id="8400318">(</span><span class="ident" id="8400319">t</span><span class="op" id="8400320">,</span>&nbsp;<span class="ident" id="8400322">db</span><span class="op" id="8400324">,</span>&nbsp;<span class="string" id="8400326">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="8400367">,</span>&nbsp;<span class="num" id="8400369">1</span><span class="op" id="8400370">,</span>&nbsp;<span class="string" id="8400372">&#34;alice&#34;</span><span class="op" id="8400379">,</span>&nbsp;<span class="ident" id="8400381">spec</span><span class="op" id="8400385">.</span><span class="ident" id="8400386">rows</span><span class="op" id="8400390">[</span><span class="num" id="8400391">0</span><span class="op" id="8400392">]</span><span class="op" id="8400393">.</span><span class="ident" id="8400394">nullParam</span><span class="op" id="8400403">,</span>&nbsp;<span class="ident" id="8400405">spec</span><span class="op" id="8400409">.</span><span class="ident" id="8400410">rows</span><span class="op" id="8400414">[</span><span class="num" id="8400415">0</span><span class="op" id="8400416">]</span><span class="op" id="8400417">.</span><span class="ident" id="8400418">notNullParam</span><span class="op" id="8400430">)</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400433">exec</span><span class="op" id="8400437">(</span><span class="ident" id="8400438">t</span><span class="op" id="8400439">,</span>&nbsp;<span class="ident" id="8400441">db</span><span class="op" id="8400443">,</span>&nbsp;<span class="string" id="8400445">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="8400486">,</span>&nbsp;<span class="num" id="8400488">2</span><span class="op" id="8400489">,</span>&nbsp;<span class="string" id="8400491">&#34;bob&#34;</span><span class="op" id="8400496">,</span>&nbsp;<span class="ident" id="8400498">spec</span><span class="op" id="8400502">.</span><span class="ident" id="8400503">rows</span><span class="op" id="8400507">[</span><span class="num" id="8400508">1</span><span class="op" id="8400509">]</span><span class="op" id="8400510">.</span><span class="ident" id="8400511">nullParam</span><span class="op" id="8400520">,</span>&nbsp;<span class="ident" id="8400522">spec</span><span class="op" id="8400526">.</span><span class="ident" id="8400527">rows</span><span class="op" id="8400531">[</span><span class="num" id="8400532">1</span><span class="op" id="8400533">]</span><span class="op" id="8400534">.</span><span class="ident" id="8400535">notNullParam</span><span class="op" id="8400547">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8400551">//&nbsp;Inserts&nbsp;with&nbsp;a&nbsp;prepared&nbsp;statement:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400590">stmt</span><span class="op" id="8400594">,</span>&nbsp;<span class="ident" id="8400596">err</span>&nbsp;<span class="op" id="8400600">:=</span>&nbsp;<span class="ident" id="8400603">db</span><span class="op" id="8400605">.</span><span class="ident" id="8400606">Prepare</span><span class="op" id="8400613">(</span><span class="string" id="8400614">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="8400655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8400658">if</span>&nbsp;<span class="ident" id="8400661">err</span>&nbsp;<span class="op" id="8400665">!=</span>&nbsp;<span class="ident" id="8400668">nil</span>&nbsp;<span class="op" id="8400672">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400676">t</span><span class="op" id="8400677">.</span><span class="ident" id="8400678">Fatalf</span><span class="op" id="8400684">(</span><span class="string" id="8400685">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="8400698">,</span>&nbsp;<span class="ident" id="8400700">err</span><span class="op" id="8400703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8400706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8400709">defer</span>&nbsp;<span class="ident" id="8400715">stmt</span><span class="op" id="8400719">.</span><span class="ident" id="8400720">Close</span><span class="op" id="8400725">(</span><span class="op" id="8400726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8400729">if</span>&nbsp;<span class="ident" id="8400732">_</span><span class="op" id="8400733">,</span>&nbsp;<span class="ident" id="8400735">err</span>&nbsp;<span class="op" id="8400739">:=</span>&nbsp;<span class="ident" id="8400742">stmt</span><span class="op" id="8400746">.</span><span class="ident" id="8400747">Exec</span><span class="op" id="8400751">(</span><span class="num" id="8400752">3</span><span class="op" id="8400753">,</span>&nbsp;<span class="string" id="8400755">&#34;chris&#34;</span><span class="op" id="8400762">,</span>&nbsp;<span class="ident" id="8400764">spec</span><span class="op" id="8400768">.</span><span class="ident" id="8400769">rows</span><span class="op" id="8400773">[</span><span class="num" id="8400774">2</span><span class="op" id="8400775">]</span><span class="op" id="8400776">.</span><span class="ident" id="8400777">nullParam</span><span class="op" id="8400786">,</span>&nbsp;<span class="ident" id="8400788">spec</span><span class="op" id="8400792">.</span><span class="ident" id="8400793">rows</span><span class="op" id="8400797">[</span><span class="num" id="8400798">2</span><span class="op" id="8400799">]</span><span class="op" id="8400800">.</span><span class="ident" id="8400801">notNullParam</span><span class="op" id="8400813">)</span><span class="op" id="8400814">;</span>&nbsp;<span class="ident" id="8400816">err</span>&nbsp;<span class="op" id="8400820">!=</span>&nbsp;<span class="ident" id="8400823">nil</span>&nbsp;<span class="op" id="8400827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400831">t</span><span class="op" id="8400832">.</span><span class="ident" id="8400833">Errorf</span><span class="op" id="8400839">(</span><span class="string" id="8400840">&#34;exec&nbsp;insert&nbsp;chris:&nbsp;%v&#34;</span><span class="op" id="8400863">,</span>&nbsp;<span class="ident" id="8400865">err</span><span class="op" id="8400868">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8400871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8400874">if</span>&nbsp;<span class="ident" id="8400877">_</span><span class="op" id="8400878">,</span>&nbsp;<span class="ident" id="8400880">err</span>&nbsp;<span class="op" id="8400884">:=</span>&nbsp;<span class="ident" id="8400887">stmt</span><span class="op" id="8400891">.</span><span class="ident" id="8400892">Exec</span><span class="op" id="8400896">(</span><span class="num" id="8400897">4</span><span class="op" id="8400898">,</span>&nbsp;<span class="string" id="8400900">&#34;dave&#34;</span><span class="op" id="8400906">,</span>&nbsp;<span class="ident" id="8400908">spec</span><span class="op" id="8400912">.</span><span class="ident" id="8400913">rows</span><span class="op" id="8400917">[</span><span class="num" id="8400918">3</span><span class="op" id="8400919">]</span><span class="op" id="8400920">.</span><span class="ident" id="8400921">nullParam</span><span class="op" id="8400930">,</span>&nbsp;<span class="ident" id="8400932">spec</span><span class="op" id="8400936">.</span><span class="ident" id="8400937">rows</span><span class="op" id="8400941">[</span><span class="num" id="8400942">3</span><span class="op" id="8400943">]</span><span class="op" id="8400944">.</span><span class="ident" id="8400945">notNullParam</span><span class="op" id="8400957">)</span><span class="op" id="8400958">;</span>&nbsp;<span class="ident" id="8400960">err</span>&nbsp;<span class="op" id="8400964">!=</span>&nbsp;<span class="ident" id="8400967">nil</span>&nbsp;<span class="op" id="8400971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400975">t</span><span class="op" id="8400976">.</span><span class="ident" id="8400977">Errorf</span><span class="op" id="8400983">(</span><span class="string" id="8400984">&#34;exec&nbsp;insert&nbsp;dave:&nbsp;%v&#34;</span><span class="op" id="8401006">,</span>&nbsp;<span class="ident" id="8401008">err</span><span class="op" id="8401011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8401014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8401017">if</span>&nbsp;<span class="ident" id="8401020">_</span><span class="op" id="8401021">,</span>&nbsp;<span class="ident" id="8401023">err</span>&nbsp;<span class="op" id="8401027">:=</span>&nbsp;<span class="ident" id="8401030">stmt</span><span class="op" id="8401034">.</span><span class="ident" id="8401035">Exec</span><span class="op" id="8401039">(</span><span class="num" id="8401040">5</span><span class="op" id="8401041">,</span>&nbsp;<span class="string" id="8401043">&#34;eleanor&#34;</span><span class="op" id="8401052">,</span>&nbsp;<span class="ident" id="8401054">spec</span><span class="op" id="8401058">.</span><span class="ident" id="8401059">rows</span><span class="op" id="8401063">[</span><span class="num" id="8401064">4</span><span class="op" id="8401065">]</span><span class="op" id="8401066">.</span><span class="ident" id="8401067">nullParam</span><span class="op" id="8401076">,</span>&nbsp;<span class="ident" id="8401078">spec</span><span class="op" id="8401082">.</span><span class="ident" id="8401083">rows</span><span class="op" id="8401087">[</span><span class="num" id="8401088">4</span><span class="op" id="8401089">]</span><span class="op" id="8401090">.</span><span class="ident" id="8401091">notNullParam</span><span class="op" id="8401103">)</span><span class="op" id="8401104">;</span>&nbsp;<span class="ident" id="8401106">err</span>&nbsp;<span class="op" id="8401110">!=</span>&nbsp;<span class="ident" id="8401113">nil</span>&nbsp;<span class="op" id="8401117">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8401121">t</span><span class="op" id="8401122">.</span><span class="ident" id="8401123">Errorf</span><span class="op" id="8401129">(</span><span class="string" id="8401130">&#34;exec&nbsp;insert&nbsp;eleanor:&nbsp;%v&#34;</span><span class="op" id="8401155">,</span>&nbsp;<span class="ident" id="8401157">err</span><span class="op" id="8401160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8401163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8401167">//&nbsp;Can&#39;t&nbsp;put&nbsp;null&nbsp;val&nbsp;into&nbsp;non-null&nbsp;col</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8401208">if</span>&nbsp;<span class="ident" id="8401211">_</span><span class="op" id="8401212">,</span>&nbsp;<span class="ident" id="8401214">err</span>&nbsp;<span class="op" id="8401218">:=</span>&nbsp;<span class="ident" id="8401221">stmt</span><span class="op" id="8401225">.</span><span class="ident" id="8401226">Exec</span><span class="op" id="8401230">(</span><span class="num" id="8401231">6</span><span class="op" id="8401232">,</span>&nbsp;<span class="string" id="8401234">&#34;bob&#34;</span><span class="op" id="8401239">,</span>&nbsp;<span class="ident" id="8401241">spec</span><span class="op" id="8401245">.</span><span class="ident" id="8401246">rows</span><span class="op" id="8401250">[</span><span class="num" id="8401251">5</span><span class="op" id="8401252">]</span><span class="op" id="8401253">.</span><span class="ident" id="8401254">nullParam</span><span class="op" id="8401263">,</span>&nbsp;<span class="ident" id="8401265">spec</span><span class="op" id="8401269">.</span><span class="ident" id="8401270">rows</span><span class="op" id="8401274">[</span><span class="num" id="8401275">5</span><span class="op" id="8401276">]</span><span class="op" id="8401277">.</span><span class="ident" id="8401278">notNullParam</span><span class="op" id="8401290">)</span><span class="op" id="8401291">;</span>&nbsp;<span class="ident" id="8401293">err</span>&nbsp;<span class="op" id="8401297">==</span>&nbsp;<span class="ident" id="8401300">nil</span>&nbsp;<span class="op" id="8401304">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8401308">t</span><span class="op" id="8401309">.</span><span class="ident" id="8401310">Errorf</span><span class="op" id="8401316">(</span><span class="string" id="8401317">&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;val&nbsp;with&nbsp;prepared&nbsp;statement&nbsp;Exec&#34;</span><span class="op" id="8401380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8401383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8401387">_</span><span class="op" id="8401388">,</span>&nbsp;<span class="ident" id="8401390">err</span>&nbsp;<span class="op" id="8401394">=</span>&nbsp;<span class="ident" id="8401396">db</span><span class="op" id="8401398">.</span><span class="ident" id="8401399">Exec</span><span class="op" id="8401403">(</span><span class="string" id="8401404">&#34;INSERT|t|id=?,name=?,nullf=?&#34;</span><span class="op" id="8401434">,</span>&nbsp;<span class="num" id="8401436">999</span><span class="op" id="8401439">,</span>&nbsp;<span class="ident" id="8401441">nil</span><span class="op" id="8401444">,</span>&nbsp;<span class="ident" id="8401446">nil</span><span class="op" id="8401449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8401452">if</span>&nbsp;<span class="ident" id="8401455">err</span>&nbsp;<span class="op" id="8401459">==</span>&nbsp;<span class="ident" id="8401462">nil</span>&nbsp;<span class="op" id="8401466">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8401470">//&nbsp;TODO:&nbsp;this&nbsp;test&nbsp;fails,&nbsp;but&nbsp;it&#39;s&nbsp;just&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8401520">//&nbsp;fakeConn&nbsp;implements&nbsp;the&nbsp;optional&nbsp;Execer&nbsp;interface,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8401576">//&nbsp;so&nbsp;arguably&nbsp;this&nbsp;is&nbsp;the&nbsp;correct&nbsp;behavior.&nbsp;&nbsp;But</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8401628">//&nbsp;maybe&nbsp;I&nbsp;should&nbsp;flesh&nbsp;out&nbsp;the&nbsp;fakeConn.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8401676">//&nbsp;implementation&nbsp;so&nbsp;this&nbsp;properly&nbsp;fails.</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8401720">//&nbsp;t.Errorf(&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;name&nbsp;with&nbsp;Exec&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8401780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8401784">paramtype</span>&nbsp;<span class="op" id="8401794">:=</span>&nbsp;<span class="ident" id="8401797">reflect</span><span class="op" id="8401804">.</span><span class="ident" id="8401805">TypeOf</span><span class="op" id="8401811">(</span><span class="ident" id="8401812">spec</span><span class="op" id="8401816">.</span><span class="ident" id="8401817">rows</span><span class="op" id="8401821">[</span><span class="num" id="8401822">0</span><span class="op" id="8401823">]</span><span class="op" id="8401824">.</span><span class="ident" id="8401825">nullParam</span><span class="op" id="8401834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8401837">bindVal</span>&nbsp;<span class="op" id="8401845">:=</span>&nbsp;<span class="ident" id="8401848">reflect</span><span class="op" id="8401855">.</span><span class="ident" id="8401856">New</span><span class="op" id="8401859">(</span><span class="ident" id="8401860">paramtype</span><span class="op" id="8401869">)</span><span class="op" id="8401870">.</span><span class="ident" id="8401871">Interface</span><span class="op" id="8401880">(</span><span class="op" id="8401881">)</span><br>
<span class="lineno">830</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8401885">for</span>&nbsp;<span class="ident" id="8401889">i</span>&nbsp;<span class="op" id="8401891">:=</span>&nbsp;<span class="num" id="8401894">0</span><span class="op" id="8401895">;</span>&nbsp;<span class="ident" id="8401897">i</span>&nbsp;<span class="op" id="8401899">&lt;</span>&nbsp;<span class="num" id="8401901">5</span><span class="op" id="8401902">;</span>&nbsp;<span class="ident" id="8401904">i</span><span class="op" id="8401905">++</span>&nbsp;<span class="op" id="8401908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8401912">id</span>&nbsp;<span class="op" id="8401915">:=</span>&nbsp;<span class="ident" id="8401918">i</span>&nbsp;<span class="op" id="8401920">+</span>&nbsp;<span class="num" id="8401922">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8401926">if</span>&nbsp;<span class="ident" id="8401929">err</span>&nbsp;<span class="op" id="8401933">:=</span>&nbsp;<span class="ident" id="8401936">db</span><span class="op" id="8401938">.</span><span class="ident" id="8401939">QueryRow</span><span class="op" id="8401947">(</span><span class="string" id="8401948">&#34;SELECT|t|nullf|id=?&#34;</span><span class="op" id="8401969">,</span>&nbsp;<span class="ident" id="8401971">id</span><span class="op" id="8401973">)</span><span class="op" id="8401974">.</span><span class="ident" id="8401975">Scan</span><span class="op" id="8401979">(</span><span class="ident" id="8401980">bindVal</span><span class="op" id="8401987">)</span><span class="op" id="8401988">;</span>&nbsp;<span class="ident" id="8401990">err</span>&nbsp;<span class="op" id="8401994">!=</span>&nbsp;<span class="ident" id="8401997">nil</span>&nbsp;<span class="op" id="8402001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402006">t</span><span class="op" id="8402007">.</span><span class="ident" id="8402008">Errorf</span><span class="op" id="8402014">(</span><span class="string" id="8402015">&#34;id=%d&nbsp;Scan:&nbsp;%v&#34;</span><span class="op" id="8402031">,</span>&nbsp;<span class="ident" id="8402033">id</span><span class="op" id="8402035">,</span>&nbsp;<span class="ident" id="8402037">err</span><span class="op" id="8402040">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8402044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402048">bindValDeref</span>&nbsp;<span class="op" id="8402061">:=</span>&nbsp;<span class="ident" id="8402064">reflect</span><span class="op" id="8402071">.</span><span class="ident" id="8402072">ValueOf</span><span class="op" id="8402079">(</span><span class="ident" id="8402080">bindVal</span><span class="op" id="8402087">)</span><span class="op" id="8402088">.</span><span class="ident" id="8402089">Elem</span><span class="op" id="8402093">(</span><span class="op" id="8402094">)</span><span class="op" id="8402095">.</span><span class="ident" id="8402096">Interface</span><span class="op" id="8402105">(</span><span class="op" id="8402106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402110">if</span>&nbsp;<span class="op" id="8402113">!</span><span class="ident" id="8402114">reflect</span><span class="op" id="8402121">.</span><span class="ident" id="8402122">DeepEqual</span><span class="op" id="8402131">(</span><span class="ident" id="8402132">bindValDeref</span><span class="op" id="8402144">,</span>&nbsp;<span class="ident" id="8402146">spec</span><span class="op" id="8402150">.</span><span class="ident" id="8402151">rows</span><span class="op" id="8402155">[</span><span class="ident" id="8402156">i</span><span class="op" id="8402157">]</span><span class="op" id="8402158">.</span><span class="ident" id="8402159">scanNullVal</span><span class="op" id="8402170">)</span>&nbsp;<span class="op" id="8402172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402177">t</span><span class="op" id="8402178">.</span><span class="ident" id="8402179">Errorf</span><span class="op" id="8402185">(</span><span class="string" id="8402186">&#34;id=%d&nbsp;got&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="8402211">,</span>&nbsp;<span class="ident" id="8402213">id</span><span class="op" id="8402215">,</span>&nbsp;<span class="ident" id="8402217">bindValDeref</span><span class="op" id="8402229">,</span>&nbsp;<span class="ident" id="8402231">spec</span><span class="op" id="8402235">.</span><span class="ident" id="8402236">rows</span><span class="op" id="8402240">[</span><span class="ident" id="8402241">i</span><span class="op" id="8402242">]</span><span class="op" id="8402243">.</span><span class="ident" id="8402244">scanNullVal</span><span class="op" id="8402255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8402259">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8402262">}</span><br>
<span class="lineno"></span><span class="op" id="8402264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8402267">//&nbsp;golang.org/issue/4859</span><br>
<span class="lineno"></span><span class="keyword" id="8402292">func</span>&nbsp;<span class="ident" id="8402297">TestQueryRowNilScanDest</span><span class="op" id="8402320">(</span><span class="ident" id="8402321">t</span>&nbsp;<span class="op" id="8402323">*</span><span class="ident" id="8402324">testing</span><span class="op" id="8402331">.</span><span class="ident" id="8402332">T</span><span class="op" id="8402333">)</span>&nbsp;<span class="op" id="8402335">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402338">db</span>&nbsp;<span class="op" id="8402341">:=</span>&nbsp;<span class="ident" id="8402344">newTestDB</span><span class="op" id="8402353">(</span><span class="ident" id="8402354">t</span><span class="op" id="8402355">,</span>&nbsp;<span class="string" id="8402357">&#34;people&#34;</span><span class="op" id="8402365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402368">defer</span>&nbsp;<span class="ident" id="8402374">closeDB</span><span class="op" id="8402381">(</span><span class="ident" id="8402382">t</span><span class="op" id="8402383">,</span>&nbsp;<span class="ident" id="8402385">db</span><span class="op" id="8402387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402390">var</span>&nbsp;<span class="ident" id="8402394">name</span>&nbsp;<span class="op" id="8402399">*</span><span class="builtintype" id="8402400">string</span>&nbsp;<span class="comment" id="8402407">//&nbsp;nil&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402423">err</span>&nbsp;<span class="op" id="8402427">:=</span>&nbsp;<span class="ident" id="8402430">db</span><span class="op" id="8402432">.</span><span class="ident" id="8402433">QueryRow</span><span class="op" id="8402441">(</span><span class="string" id="8402442">&#34;SELECT|people|name|&#34;</span><span class="op" id="8402463">)</span><span class="op" id="8402464">.</span><span class="ident" id="8402465">Scan</span><span class="op" id="8402469">(</span><span class="ident" id="8402470">name</span><span class="op" id="8402474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402477">want</span>&nbsp;<span class="op" id="8402482">:=</span>&nbsp;<span class="string" id="8402485">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;0:&nbsp;destination&nbsp;pointer&nbsp;is&nbsp;nil&#34;</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402550">if</span>&nbsp;<span class="ident" id="8402553">err</span>&nbsp;<span class="op" id="8402557">==</span>&nbsp;<span class="ident" id="8402560">nil</span>&nbsp;<span class="op" id="8402564">||</span>&nbsp;<span class="ident" id="8402567">err</span><span class="op" id="8402570">.</span><span class="ident" id="8402571">Error</span><span class="op" id="8402576">(</span><span class="op" id="8402577">)</span>&nbsp;<span class="op" id="8402579">!=</span>&nbsp;<span class="ident" id="8402582">want</span>&nbsp;<span class="op" id="8402587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402591">t</span><span class="op" id="8402592">.</span><span class="ident" id="8402593">Errorf</span><span class="op" id="8402599">(</span><span class="string" id="8402600">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8402621">,</span>&nbsp;<span class="ident" id="8402623">err</span><span class="op" id="8402626">.</span><span class="ident" id="8402627">Error</span><span class="op" id="8402632">(</span><span class="op" id="8402633">)</span><span class="op" id="8402634">,</span>&nbsp;<span class="ident" id="8402636">want</span><span class="op" id="8402640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8402643">}</span><br>
<span class="lineno"></span><span class="op" id="8402645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">855</span><span class="keyword" id="8402648">func</span>&nbsp;<span class="ident" id="8402653">TestIssue4902</span><span class="op" id="8402666">(</span><span class="ident" id="8402667">t</span>&nbsp;<span class="op" id="8402669">*</span><span class="ident" id="8402670">testing</span><span class="op" id="8402677">.</span><span class="ident" id="8402678">T</span><span class="op" id="8402679">)</span>&nbsp;<span class="op" id="8402681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402684">db</span>&nbsp;<span class="op" id="8402687">:=</span>&nbsp;<span class="ident" id="8402690">newTestDB</span><span class="op" id="8402699">(</span><span class="ident" id="8402700">t</span><span class="op" id="8402701">,</span>&nbsp;<span class="string" id="8402703">&#34;people&#34;</span><span class="op" id="8402711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402714">defer</span>&nbsp;<span class="ident" id="8402720">closeDB</span><span class="op" id="8402727">(</span><span class="ident" id="8402728">t</span><span class="op" id="8402729">,</span>&nbsp;<span class="ident" id="8402731">db</span><span class="op" id="8402733">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402737">driver</span>&nbsp;<span class="op" id="8402744">:=</span>&nbsp;<span class="ident" id="8402747">db</span><span class="op" id="8402749">.</span><span class="ident" id="8402750">driver</span><span class="op" id="8402756">.</span><span class="op" id="8402757">(</span><span class="op" id="8402758">*</span><span class="ident" id="8402759">fakeDriver</span><span class="op" id="8402769">)</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402772">opens0</span>&nbsp;<span class="op" id="8402779">:=</span>&nbsp;<span class="ident" id="8402782">driver</span><span class="op" id="8402788">.</span><span class="ident" id="8402789">openCount</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402801">var</span>&nbsp;<span class="ident" id="8402805">stmt</span>&nbsp;<span class="op" id="8402810">*</span><span class="ident" id="8402811">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402817">var</span>&nbsp;<span class="ident" id="8402821">err</span>&nbsp;<span class="builtintype" id="8402825">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402832">for</span>&nbsp;<span class="ident" id="8402836">i</span>&nbsp;<span class="op" id="8402838">:=</span>&nbsp;<span class="num" id="8402841">0</span><span class="op" id="8402842">;</span>&nbsp;<span class="ident" id="8402844">i</span>&nbsp;<span class="op" id="8402846">&lt;</span>&nbsp;<span class="num" id="8402848">10</span><span class="op" id="8402850">;</span>&nbsp;<span class="ident" id="8402852">i</span><span class="op" id="8402853">++</span>&nbsp;<span class="op" id="8402856">{</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402860">stmt</span><span class="op" id="8402864">,</span>&nbsp;<span class="ident" id="8402866">err</span>&nbsp;<span class="op" id="8402870">=</span>&nbsp;<span class="ident" id="8402872">db</span><span class="op" id="8402874">.</span><span class="ident" id="8402875">Prepare</span><span class="op" id="8402882">(</span><span class="string" id="8402883">&#34;SELECT|people|name|&#34;</span><span class="op" id="8402904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402908">if</span>&nbsp;<span class="ident" id="8402911">err</span>&nbsp;<span class="op" id="8402915">!=</span>&nbsp;<span class="ident" id="8402918">nil</span>&nbsp;<span class="op" id="8402922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402927">t</span><span class="op" id="8402928">.</span><span class="ident" id="8402929">Fatal</span><span class="op" id="8402934">(</span><span class="ident" id="8402935">err</span><span class="op" id="8402938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8402942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402946">err</span>&nbsp;<span class="op" id="8402950">=</span>&nbsp;<span class="ident" id="8402952">stmt</span><span class="op" id="8402956">.</span><span class="ident" id="8402957">Close</span><span class="op" id="8402962">(</span><span class="op" id="8402963">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402967">if</span>&nbsp;<span class="ident" id="8402970">err</span>&nbsp;<span class="op" id="8402974">!=</span>&nbsp;<span class="ident" id="8402977">nil</span>&nbsp;<span class="op" id="8402981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402986">t</span><span class="op" id="8402987">.</span><span class="ident" id="8402988">Fatal</span><span class="op" id="8402993">(</span><span class="ident" id="8402994">err</span><span class="op" id="8402997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8403001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8403004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403008">opens</span>&nbsp;<span class="op" id="8403014">:=</span>&nbsp;<span class="ident" id="8403017">driver</span><span class="op" id="8403023">.</span><span class="ident" id="8403024">openCount</span>&nbsp;<span class="op" id="8403034">-</span>&nbsp;<span class="ident" id="8403036">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403044">if</span>&nbsp;<span class="ident" id="8403047">opens</span>&nbsp;<span class="op" id="8403053">&gt;</span>&nbsp;<span class="num" id="8403055">1</span>&nbsp;<span class="op" id="8403057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403061">t</span><span class="op" id="8403062">.</span><span class="ident" id="8403063">Errorf</span><span class="op" id="8403069">(</span><span class="string" id="8403070">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="8403093">,</span>&nbsp;<span class="ident" id="8403095">opens</span><span class="op" id="8403100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403104">t</span><span class="op" id="8403105">.</span><span class="ident" id="8403106">Logf</span><span class="op" id="8403110">(</span><span class="string" id="8403111">&#34;db&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="8403121">,</span>&nbsp;<span class="ident" id="8403123">db</span><span class="op" id="8403125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403129">t</span><span class="op" id="8403130">.</span><span class="ident" id="8403131">Logf</span><span class="op" id="8403135">(</span><span class="string" id="8403136">&#34;driver&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="8403150">,</span>&nbsp;<span class="ident" id="8403152">driver</span><span class="op" id="8403158">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403162">t</span><span class="op" id="8403163">.</span><span class="ident" id="8403164">Logf</span><span class="op" id="8403168">(</span><span class="string" id="8403169">&#34;stmt&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="8403181">,</span>&nbsp;<span class="ident" id="8403183">stmt</span><span class="op" id="8403187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8403190">}</span><br>
<span class="lineno"></span><span class="op" id="8403192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8403195">//&nbsp;Issue&nbsp;3857</span><br>
<span class="lineno">885</span><span class="comment" id="8403209">//&nbsp;This&nbsp;used&nbsp;to&nbsp;deadlock.</span><br>
<span class="lineno"></span><span class="keyword" id="8403235">func</span>&nbsp;<span class="ident" id="8403240">TestSimultaneousQueries</span><span class="op" id="8403263">(</span><span class="ident" id="8403264">t</span>&nbsp;<span class="op" id="8403266">*</span><span class="ident" id="8403267">testing</span><span class="op" id="8403274">.</span><span class="ident" id="8403275">T</span><span class="op" id="8403276">)</span>&nbsp;<span class="op" id="8403278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403281">db</span>&nbsp;<span class="op" id="8403284">:=</span>&nbsp;<span class="ident" id="8403287">newTestDB</span><span class="op" id="8403296">(</span><span class="ident" id="8403297">t</span><span class="op" id="8403298">,</span>&nbsp;<span class="string" id="8403300">&#34;people&#34;</span><span class="op" id="8403308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403311">defer</span>&nbsp;<span class="ident" id="8403317">closeDB</span><span class="op" id="8403324">(</span><span class="ident" id="8403325">t</span><span class="op" id="8403326">,</span>&nbsp;<span class="ident" id="8403328">db</span><span class="op" id="8403330">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403334">tx</span><span class="op" id="8403336">,</span>&nbsp;<span class="ident" id="8403338">err</span>&nbsp;<span class="op" id="8403342">:=</span>&nbsp;<span class="ident" id="8403345">db</span><span class="op" id="8403347">.</span><span class="ident" id="8403348">Begin</span><span class="op" id="8403353">(</span><span class="op" id="8403354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403357">if</span>&nbsp;<span class="ident" id="8403360">err</span>&nbsp;<span class="op" id="8403364">!=</span>&nbsp;<span class="ident" id="8403367">nil</span>&nbsp;<span class="op" id="8403371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403375">t</span><span class="op" id="8403376">.</span><span class="ident" id="8403377">Fatal</span><span class="op" id="8403382">(</span><span class="ident" id="8403383">err</span><span class="op" id="8403386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8403389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403392">defer</span>&nbsp;<span class="ident" id="8403398">tx</span><span class="op" id="8403400">.</span><span class="ident" id="8403401">Rollback</span><span class="op" id="8403409">(</span><span class="op" id="8403410">)</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403414">r1</span><span class="op" id="8403416">,</span>&nbsp;<span class="ident" id="8403418">err</span>&nbsp;<span class="op" id="8403422">:=</span>&nbsp;<span class="ident" id="8403425">tx</span><span class="op" id="8403427">.</span><span class="ident" id="8403428">Query</span><span class="op" id="8403433">(</span><span class="string" id="8403434">&#34;SELECT|people|name|&#34;</span><span class="op" id="8403455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403458">if</span>&nbsp;<span class="ident" id="8403461">err</span>&nbsp;<span class="op" id="8403465">!=</span>&nbsp;<span class="ident" id="8403468">nil</span>&nbsp;<span class="op" id="8403472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403476">t</span><span class="op" id="8403477">.</span><span class="ident" id="8403478">Fatal</span><span class="op" id="8403483">(</span><span class="ident" id="8403484">err</span><span class="op" id="8403487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8403490">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403493">defer</span>&nbsp;<span class="ident" id="8403499">r1</span><span class="op" id="8403501">.</span><span class="ident" id="8403502">Close</span><span class="op" id="8403507">(</span><span class="op" id="8403508">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403512">r2</span><span class="op" id="8403514">,</span>&nbsp;<span class="ident" id="8403516">err</span>&nbsp;<span class="op" id="8403520">:=</span>&nbsp;<span class="ident" id="8403523">tx</span><span class="op" id="8403525">.</span><span class="ident" id="8403526">Query</span><span class="op" id="8403531">(</span><span class="string" id="8403532">&#34;SELECT|people|name|&#34;</span><span class="op" id="8403553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403556">if</span>&nbsp;<span class="ident" id="8403559">err</span>&nbsp;<span class="op" id="8403563">!=</span>&nbsp;<span class="ident" id="8403566">nil</span>&nbsp;<span class="op" id="8403570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403574">t</span><span class="op" id="8403575">.</span><span class="ident" id="8403576">Fatal</span><span class="op" id="8403581">(</span><span class="ident" id="8403582">err</span><span class="op" id="8403585">)</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8403588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403591">defer</span>&nbsp;<span class="ident" id="8403597">r2</span><span class="op" id="8403599">.</span><span class="ident" id="8403600">Close</span><span class="op" id="8403605">(</span><span class="op" id="8403606">)</span><br>
<span class="lineno"></span><span class="op" id="8403608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8403611">func</span>&nbsp;<span class="ident" id="8403616">TestMaxIdleConns</span><span class="op" id="8403632">(</span><span class="ident" id="8403633">t</span>&nbsp;<span class="op" id="8403635">*</span><span class="ident" id="8403636">testing</span><span class="op" id="8403643">.</span><span class="ident" id="8403644">T</span><span class="op" id="8403645">)</span>&nbsp;<span class="op" id="8403647">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403650">db</span>&nbsp;<span class="op" id="8403653">:=</span>&nbsp;<span class="ident" id="8403656">newTestDB</span><span class="op" id="8403665">(</span><span class="ident" id="8403666">t</span><span class="op" id="8403667">,</span>&nbsp;<span class="string" id="8403669">&#34;people&#34;</span><span class="op" id="8403677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403680">defer</span>&nbsp;<span class="ident" id="8403686">closeDB</span><span class="op" id="8403693">(</span><span class="ident" id="8403694">t</span><span class="op" id="8403695">,</span>&nbsp;<span class="ident" id="8403697">db</span><span class="op" id="8403699">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403703">tx</span><span class="op" id="8403705">,</span>&nbsp;<span class="ident" id="8403707">err</span>&nbsp;<span class="op" id="8403711">:=</span>&nbsp;<span class="ident" id="8403714">db</span><span class="op" id="8403716">.</span><span class="ident" id="8403717">Begin</span><span class="op" id="8403722">(</span><span class="op" id="8403723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403726">if</span>&nbsp;<span class="ident" id="8403729">err</span>&nbsp;<span class="op" id="8403733">!=</span>&nbsp;<span class="ident" id="8403736">nil</span>&nbsp;<span class="op" id="8403740">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403744">t</span><span class="op" id="8403745">.</span><span class="ident" id="8403746">Fatal</span><span class="op" id="8403751">(</span><span class="ident" id="8403752">err</span><span class="op" id="8403755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8403758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403761">tx</span><span class="op" id="8403763">.</span><span class="ident" id="8403764">Commit</span><span class="op" id="8403770">(</span><span class="op" id="8403771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403774">if</span>&nbsp;<span class="ident" id="8403777">got</span>&nbsp;<span class="op" id="8403781">:=</span>&nbsp;<span class="builtinfunc" id="8403784">len</span><span class="op" id="8403787">(</span><span class="ident" id="8403788">db</span><span class="op" id="8403790">.</span><span class="ident" id="8403791">freeConn</span><span class="op" id="8403799">)</span><span class="op" id="8403800">;</span>&nbsp;<span class="ident" id="8403802">got</span>&nbsp;<span class="op" id="8403806">!=</span>&nbsp;<span class="num" id="8403809">1</span>&nbsp;<span class="op" id="8403811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403815">t</span><span class="op" id="8403816">.</span><span class="ident" id="8403817">Errorf</span><span class="op" id="8403823">(</span><span class="string" id="8403824">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8403848">,</span>&nbsp;<span class="ident" id="8403850">got</span><span class="op" id="8403853">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8403856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403860">db</span><span class="op" id="8403862">.</span><span class="ident" id="8403863">SetMaxIdleConns</span><span class="op" id="8403878">(</span><span class="num" id="8403879">0</span><span class="op" id="8403880">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403884">if</span>&nbsp;<span class="ident" id="8403887">got</span>&nbsp;<span class="op" id="8403891">:=</span>&nbsp;<span class="builtinfunc" id="8403894">len</span><span class="op" id="8403897">(</span><span class="ident" id="8403898">db</span><span class="op" id="8403900">.</span><span class="ident" id="8403901">freeConn</span><span class="op" id="8403909">)</span><span class="op" id="8403910">;</span>&nbsp;<span class="ident" id="8403912">got</span>&nbsp;<span class="op" id="8403916">!=</span>&nbsp;<span class="num" id="8403919">0</span>&nbsp;<span class="op" id="8403921">{</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403925">t</span><span class="op" id="8403926">.</span><span class="ident" id="8403927">Errorf</span><span class="op" id="8403933">(</span><span class="string" id="8403934">&#34;freeConns&nbsp;after&nbsp;set&nbsp;to&nbsp;zero&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8403976">,</span>&nbsp;<span class="ident" id="8403978">got</span><span class="op" id="8403981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8403984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403988">tx</span><span class="op" id="8403990">,</span>&nbsp;<span class="ident" id="8403992">err</span>&nbsp;<span class="op" id="8403996">=</span>&nbsp;<span class="ident" id="8403998">db</span><span class="op" id="8404000">.</span><span class="ident" id="8404001">Begin</span><span class="op" id="8404006">(</span><span class="op" id="8404007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404010">if</span>&nbsp;<span class="ident" id="8404013">err</span>&nbsp;<span class="op" id="8404017">!=</span>&nbsp;<span class="ident" id="8404020">nil</span>&nbsp;<span class="op" id="8404024">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404028">t</span><span class="op" id="8404029">.</span><span class="ident" id="8404030">Fatal</span><span class="op" id="8404035">(</span><span class="ident" id="8404036">err</span><span class="op" id="8404039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8404042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404045">tx</span><span class="op" id="8404047">.</span><span class="ident" id="8404048">Commit</span><span class="op" id="8404054">(</span><span class="op" id="8404055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404058">if</span>&nbsp;<span class="ident" id="8404061">got</span>&nbsp;<span class="op" id="8404065">:=</span>&nbsp;<span class="builtinfunc" id="8404068">len</span><span class="op" id="8404071">(</span><span class="ident" id="8404072">db</span><span class="op" id="8404074">.</span><span class="ident" id="8404075">freeConn</span><span class="op" id="8404083">)</span><span class="op" id="8404084">;</span>&nbsp;<span class="ident" id="8404086">got</span>&nbsp;<span class="op" id="8404090">!=</span>&nbsp;<span class="num" id="8404093">0</span>&nbsp;<span class="op" id="8404095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404099">t</span><span class="op" id="8404100">.</span><span class="ident" id="8404101">Errorf</span><span class="op" id="8404107">(</span><span class="string" id="8404108">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8404132">,</span>&nbsp;<span class="ident" id="8404134">got</span><span class="op" id="8404137">)</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8404140">}</span><br>
<span class="lineno"></span><span class="op" id="8404142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8404145">func</span>&nbsp;<span class="ident" id="8404150">TestMaxOpenConns</span><span class="op" id="8404166">(</span><span class="ident" id="8404167">t</span>&nbsp;<span class="op" id="8404169">*</span><span class="ident" id="8404170">testing</span><span class="op" id="8404177">.</span><span class="ident" id="8404178">T</span><span class="op" id="8404179">)</span>&nbsp;<span class="op" id="8404181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404184">if</span>&nbsp;<span class="ident" id="8404187">testing</span><span class="op" id="8404194">.</span><span class="ident" id="8404195">Short</span><span class="op" id="8404200">(</span><span class="op" id="8404201">)</span>&nbsp;<span class="op" id="8404203">{</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404207">t</span><span class="op" id="8404208">.</span><span class="ident" id="8404209">Skip</span><span class="op" id="8404213">(</span><span class="string" id="8404214">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="8404238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8404241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404244">defer</span>&nbsp;<span class="ident" id="8404250">setHookpostCloseConn</span><span class="op" id="8404270">(</span><span class="ident" id="8404271">nil</span><span class="op" id="8404274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404277">setHookpostCloseConn</span><span class="op" id="8404297">(</span><span class="keyword" id="8404298">func</span><span class="op" id="8404302">(</span><span class="ident" id="8404303">_</span>&nbsp;<span class="op" id="8404305">*</span><span class="ident" id="8404306">fakeConn</span><span class="op" id="8404314">,</span>&nbsp;<span class="ident" id="8404316">err</span>&nbsp;<span class="builtintype" id="8404320">error</span><span class="op" id="8404325">)</span>&nbsp;<span class="op" id="8404327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404331">if</span>&nbsp;<span class="ident" id="8404334">err</span>&nbsp;<span class="op" id="8404338">!=</span>&nbsp;<span class="ident" id="8404341">nil</span>&nbsp;<span class="op" id="8404345">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404350">t</span><span class="op" id="8404351">.</span><span class="ident" id="8404352">Errorf</span><span class="op" id="8404358">(</span><span class="string" id="8404359">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="8404387">,</span>&nbsp;<span class="ident" id="8404389">err</span><span class="op" id="8404392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8404396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8404399">}</span><span class="op" id="8404400">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404404">db</span>&nbsp;<span class="op" id="8404407">:=</span>&nbsp;<span class="ident" id="8404410">newTestDB</span><span class="op" id="8404419">(</span><span class="ident" id="8404420">t</span><span class="op" id="8404421">,</span>&nbsp;<span class="string" id="8404423">&#34;magicquery&#34;</span><span class="op" id="8404435">)</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404438">defer</span>&nbsp;<span class="ident" id="8404444">closeDB</span><span class="op" id="8404451">(</span><span class="ident" id="8404452">t</span><span class="op" id="8404453">,</span>&nbsp;<span class="ident" id="8404455">db</span><span class="op" id="8404457">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404461">driver</span>&nbsp;<span class="op" id="8404468">:=</span>&nbsp;<span class="ident" id="8404471">db</span><span class="op" id="8404473">.</span><span class="ident" id="8404474">driver</span><span class="op" id="8404480">.</span><span class="op" id="8404481">(</span><span class="op" id="8404482">*</span><span class="ident" id="8404483">fakeDriver</span><span class="op" id="8404493">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8404497">//&nbsp;Force&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;0&nbsp;so&nbsp;we&nbsp;can&nbsp;get&nbsp;an&nbsp;accurate</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8404569">//&nbsp;count&nbsp;for&nbsp;the&nbsp;test</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404592">db</span><span class="op" id="8404594">.</span><span class="ident" id="8404595">SetMaxIdleConns</span><span class="op" id="8404610">(</span><span class="num" id="8404611">0</span><span class="op" id="8404612">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404616">if</span>&nbsp;<span class="ident" id="8404619">g</span><span class="op" id="8404620">,</span>&nbsp;<span class="ident" id="8404622">w</span>&nbsp;<span class="op" id="8404624">:=</span>&nbsp;<span class="ident" id="8404627">db</span><span class="op" id="8404629">.</span><span class="ident" id="8404630">numFreeConns</span><span class="op" id="8404642">(</span><span class="op" id="8404643">)</span><span class="op" id="8404644">,</span>&nbsp;<span class="num" id="8404646">0</span><span class="op" id="8404647">;</span>&nbsp;<span class="ident" id="8404649">g</span>&nbsp;<span class="op" id="8404651">!=</span>&nbsp;<span class="ident" id="8404654">w</span>&nbsp;<span class="op" id="8404656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404660">t</span><span class="op" id="8404661">.</span><span class="ident" id="8404662">Errorf</span><span class="op" id="8404668">(</span><span class="string" id="8404669">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8404695">,</span>&nbsp;<span class="ident" id="8404697">g</span><span class="op" id="8404698">,</span>&nbsp;<span class="ident" id="8404700">w</span><span class="op" id="8404701">)</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8404704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404708">if</span>&nbsp;<span class="ident" id="8404711">n</span>&nbsp;<span class="op" id="8404713">:=</span>&nbsp;<span class="ident" id="8404716">db</span><span class="op" id="8404718">.</span><span class="ident" id="8404719">numDepsPollUntil</span><span class="op" id="8404735">(</span><span class="num" id="8404736">0</span><span class="op" id="8404737">,</span>&nbsp;<span class="ident" id="8404739">time</span><span class="op" id="8404743">.</span><span class="ident" id="8404744">Second</span><span class="op" id="8404750">)</span><span class="op" id="8404751">;</span>&nbsp;<span class="ident" id="8404753">n</span>&nbsp;<span class="op" id="8404755">&gt;</span>&nbsp;<span class="num" id="8404757">0</span>&nbsp;<span class="op" id="8404759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404763">t</span><span class="op" id="8404764">.</span><span class="ident" id="8404765">Errorf</span><span class="op" id="8404771">(</span><span class="string" id="8404772">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8404813">,</span>&nbsp;<span class="ident" id="8404815">n</span><span class="op" id="8404816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404820">db</span><span class="op" id="8404822">.</span><span class="ident" id="8404823">dumpDeps</span><span class="op" id="8404831">(</span><span class="ident" id="8404832">t</span><span class="op" id="8404833">)</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8404836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404840">driver</span><span class="op" id="8404846">.</span><span class="ident" id="8404847">mu</span><span class="op" id="8404849">.</span><span class="ident" id="8404850">Lock</span><span class="op" id="8404854">(</span><span class="op" id="8404855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404858">opens0</span>&nbsp;<span class="op" id="8404865">:=</span>&nbsp;<span class="ident" id="8404868">driver</span><span class="op" id="8404874">.</span><span class="ident" id="8404875">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404886">closes0</span>&nbsp;<span class="op" id="8404894">:=</span>&nbsp;<span class="ident" id="8404897">driver</span><span class="op" id="8404903">.</span><span class="ident" id="8404904">closeCount</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404916">driver</span><span class="op" id="8404922">.</span><span class="ident" id="8404923">mu</span><span class="op" id="8404925">.</span><span class="ident" id="8404926">Unlock</span><span class="op" id="8404932">(</span><span class="op" id="8404933">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404937">db</span><span class="op" id="8404939">.</span><span class="ident" id="8404940">SetMaxIdleConns</span><span class="op" id="8404955">(</span><span class="num" id="8404956">10</span><span class="op" id="8404958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404961">db</span><span class="op" id="8404963">.</span><span class="ident" id="8404964">SetMaxOpenConns</span><span class="op" id="8404979">(</span><span class="num" id="8404980">10</span><span class="op" id="8404982">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404986">stmt</span><span class="op" id="8404990">,</span>&nbsp;<span class="ident" id="8404992">err</span>&nbsp;<span class="op" id="8404996">:=</span>&nbsp;<span class="ident" id="8404999">db</span><span class="op" id="8405001">.</span><span class="ident" id="8405002">Prepare</span><span class="op" id="8405009">(</span><span class="string" id="8405010">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="8405046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405049">if</span>&nbsp;<span class="ident" id="8405052">err</span>&nbsp;<span class="op" id="8405056">!=</span>&nbsp;<span class="ident" id="8405059">nil</span>&nbsp;<span class="op" id="8405063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405067">t</span><span class="op" id="8405068">.</span><span class="ident" id="8405069">Fatal</span><span class="op" id="8405074">(</span><span class="ident" id="8405075">err</span><span class="op" id="8405078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8405081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8405085">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405121">const</span>&nbsp;<span class="op" id="8405127">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405131">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8405143">=</span>&nbsp;<span class="num" id="8405145">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405150">sleepMillis</span>&nbsp;<span class="op" id="8405162">=</span>&nbsp;<span class="num" id="8405164">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405169">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8405181">=</span>&nbsp;<span class="num" id="8405183">2</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8405186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405189">var</span>&nbsp;<span class="ident" id="8405193">wg</span>&nbsp;<span class="ident" id="8405196">sync</span><span class="op" id="8405200">.</span><span class="ident" id="8405201">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405212">for</span>&nbsp;<span class="ident" id="8405216">batch</span>&nbsp;<span class="op" id="8405222">:=</span>&nbsp;<span class="num" id="8405225">0</span><span class="op" id="8405226">;</span>&nbsp;<span class="ident" id="8405228">batch</span>&nbsp;<span class="op" id="8405234">&lt;</span>&nbsp;<span class="ident" id="8405236">nbatch</span><span class="op" id="8405242">;</span>&nbsp;<span class="ident" id="8405244">batch</span><span class="op" id="8405249">++</span>&nbsp;<span class="op" id="8405252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405256">for</span>&nbsp;<span class="ident" id="8405260">i</span>&nbsp;<span class="op" id="8405262">:=</span>&nbsp;<span class="num" id="8405265">0</span><span class="op" id="8405266">;</span>&nbsp;<span class="ident" id="8405268">i</span>&nbsp;<span class="op" id="8405270">&lt;</span>&nbsp;<span class="ident" id="8405272">nquery</span><span class="op" id="8405278">;</span>&nbsp;<span class="ident" id="8405280">i</span><span class="op" id="8405281">++</span>&nbsp;<span class="op" id="8405284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405289">wg</span><span class="op" id="8405291">.</span><span class="ident" id="8405292">Add</span><span class="op" id="8405295">(</span><span class="num" id="8405296">1</span><span class="op" id="8405297">)</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405302">go</span>&nbsp;<span class="keyword" id="8405305">func</span><span class="op" id="8405309">(</span><span class="op" id="8405310">)</span>&nbsp;<span class="op" id="8405312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405318">defer</span>&nbsp;<span class="ident" id="8405324">wg</span><span class="op" id="8405326">.</span><span class="ident" id="8405327">Done</span><span class="op" id="8405331">(</span><span class="op" id="8405332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405338">var</span>&nbsp;<span class="ident" id="8405342">op</span>&nbsp;<span class="builtintype" id="8405345">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405356">if</span>&nbsp;<span class="ident" id="8405359">err</span>&nbsp;<span class="op" id="8405363">:=</span>&nbsp;<span class="ident" id="8405366">stmt</span><span class="op" id="8405370">.</span><span class="ident" id="8405371">QueryRow</span><span class="op" id="8405379">(</span><span class="string" id="8405380">&#34;sleep&#34;</span><span class="op" id="8405387">,</span>&nbsp;<span class="ident" id="8405389">sleepMillis</span><span class="op" id="8405400">)</span><span class="op" id="8405401">.</span><span class="ident" id="8405402">Scan</span><span class="op" id="8405406">(</span><span class="op" id="8405407">&amp;</span><span class="ident" id="8405408">op</span><span class="op" id="8405410">)</span><span class="op" id="8405411">;</span>&nbsp;<span class="ident" id="8405413">err</span>&nbsp;<span class="op" id="8405417">!=</span>&nbsp;<span class="ident" id="8405420">nil</span>&nbsp;<span class="op" id="8405424">&amp;&amp;</span>&nbsp;<span class="ident" id="8405427">err</span>&nbsp;<span class="op" id="8405431">!=</span>&nbsp;<span class="ident" id="8405434">ErrNoRows</span>&nbsp;<span class="op" id="8405444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405451">t</span><span class="op" id="8405452">.</span><span class="ident" id="8405453">Error</span><span class="op" id="8405458">(</span><span class="ident" id="8405459">err</span><span class="op" id="8405462">)</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8405468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8405473">}</span><span class="op" id="8405474">(</span><span class="op" id="8405475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8405479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8405483">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8405540">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8405597">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405618">time</span><span class="op" id="8405622">.</span><span class="ident" id="8405623">Sleep</span><span class="op" id="8405628">(</span><span class="num" id="8405629">2</span>&nbsp;<span class="op" id="8405631">*</span>&nbsp;<span class="ident" id="8405633">sleepMillis</span>&nbsp;<span class="op" id="8405645">*</span>&nbsp;<span class="ident" id="8405647">time</span><span class="op" id="8405651">.</span><span class="ident" id="8405652">Millisecond</span><span class="op" id="8405663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8405666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405669">wg</span><span class="op" id="8405671">.</span><span class="ident" id="8405672">Wait</span><span class="op" id="8405676">(</span><span class="op" id="8405677">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405681">if</span>&nbsp;<span class="ident" id="8405684">g</span><span class="op" id="8405685">,</span>&nbsp;<span class="ident" id="8405687">w</span>&nbsp;<span class="op" id="8405689">:=</span>&nbsp;<span class="ident" id="8405692">db</span><span class="op" id="8405694">.</span><span class="ident" id="8405695">numFreeConns</span><span class="op" id="8405707">(</span><span class="op" id="8405708">)</span><span class="op" id="8405709">,</span>&nbsp;<span class="num" id="8405711">10</span><span class="op" id="8405713">;</span>&nbsp;<span class="ident" id="8405715">g</span>&nbsp;<span class="op" id="8405717">!=</span>&nbsp;<span class="ident" id="8405720">w</span>&nbsp;<span class="op" id="8405722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405726">t</span><span class="op" id="8405727">.</span><span class="ident" id="8405728">Errorf</span><span class="op" id="8405734">(</span><span class="string" id="8405735">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8405761">,</span>&nbsp;<span class="ident" id="8405763">g</span><span class="op" id="8405764">,</span>&nbsp;<span class="ident" id="8405766">w</span><span class="op" id="8405767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8405770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405774">if</span>&nbsp;<span class="ident" id="8405777">n</span>&nbsp;<span class="op" id="8405779">:=</span>&nbsp;<span class="ident" id="8405782">db</span><span class="op" id="8405784">.</span><span class="ident" id="8405785">numDepsPollUntil</span><span class="op" id="8405801">(</span><span class="num" id="8405802">20</span><span class="op" id="8405804">,</span>&nbsp;<span class="ident" id="8405806">time</span><span class="op" id="8405810">.</span><span class="ident" id="8405811">Second</span><span class="op" id="8405817">)</span><span class="op" id="8405818">;</span>&nbsp;<span class="ident" id="8405820">n</span>&nbsp;<span class="op" id="8405822">&gt;</span>&nbsp;<span class="num" id="8405824">20</span>&nbsp;<span class="op" id="8405827">{</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405831">t</span><span class="op" id="8405832">.</span><span class="ident" id="8405833">Errorf</span><span class="op" id="8405839">(</span><span class="string" id="8405840">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;20&#34;</span><span class="op" id="8405885">,</span>&nbsp;<span class="ident" id="8405887">n</span><span class="op" id="8405888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405892">db</span><span class="op" id="8405894">.</span><span class="ident" id="8405895">dumpDeps</span><span class="op" id="8405903">(</span><span class="ident" id="8405904">t</span><span class="op" id="8405905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8405908">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405912">driver</span><span class="op" id="8405918">.</span><span class="ident" id="8405919">mu</span><span class="op" id="8405921">.</span><span class="ident" id="8405922">Lock</span><span class="op" id="8405926">(</span><span class="op" id="8405927">)</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405930">opens</span>&nbsp;<span class="op" id="8405936">:=</span>&nbsp;<span class="ident" id="8405939">driver</span><span class="op" id="8405945">.</span><span class="ident" id="8405946">openCount</span>&nbsp;<span class="op" id="8405956">-</span>&nbsp;<span class="ident" id="8405958">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405966">closes</span>&nbsp;<span class="op" id="8405973">:=</span>&nbsp;<span class="ident" id="8405976">driver</span><span class="op" id="8405982">.</span><span class="ident" id="8405983">closeCount</span>&nbsp;<span class="op" id="8405994">-</span>&nbsp;<span class="ident" id="8405996">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406005">driver</span><span class="op" id="8406011">.</span><span class="ident" id="8406012">mu</span><span class="op" id="8406014">.</span><span class="ident" id="8406015">Unlock</span><span class="op" id="8406021">(</span><span class="op" id="8406022">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8406026">if</span>&nbsp;<span class="ident" id="8406029">opens</span>&nbsp;<span class="op" id="8406035">&gt;</span>&nbsp;<span class="num" id="8406037">10</span>&nbsp;<span class="op" id="8406040">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406044">t</span><span class="op" id="8406045">.</span><span class="ident" id="8406046">Logf</span><span class="op" id="8406050">(</span><span class="string" id="8406051">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8406068">,</span>&nbsp;<span class="ident" id="8406070">opens</span><span class="op" id="8406075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406079">t</span><span class="op" id="8406080">.</span><span class="ident" id="8406081">Logf</span><span class="op" id="8406085">(</span><span class="string" id="8406086">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8406104">,</span>&nbsp;<span class="ident" id="8406106">closes</span><span class="op" id="8406112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406116">t</span><span class="op" id="8406117">.</span><span class="ident" id="8406118">Errorf</span><span class="op" id="8406124">(</span><span class="string" id="8406125">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="8406165">,</span>&nbsp;<span class="ident" id="8406167">opens</span><span class="op" id="8406172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406176">db</span><span class="op" id="8406178">.</span><span class="ident" id="8406179">dumpDeps</span><span class="op" id="8406187">(</span><span class="ident" id="8406188">t</span><span class="op" id="8406189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8406192">}</span><br>
<span class="lineno">1025</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8406196">if</span>&nbsp;<span class="ident" id="8406199">err</span>&nbsp;<span class="op" id="8406203">:=</span>&nbsp;<span class="ident" id="8406206">stmt</span><span class="op" id="8406210">.</span><span class="ident" id="8406211">Close</span><span class="op" id="8406216">(</span><span class="op" id="8406217">)</span><span class="op" id="8406218">;</span>&nbsp;<span class="ident" id="8406220">err</span>&nbsp;<span class="op" id="8406224">!=</span>&nbsp;<span class="ident" id="8406227">nil</span>&nbsp;<span class="op" id="8406231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406235">t</span><span class="op" id="8406236">.</span><span class="ident" id="8406237">Fatal</span><span class="op" id="8406242">(</span><span class="ident" id="8406243">err</span><span class="op" id="8406246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8406249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8406253">if</span>&nbsp;<span class="ident" id="8406256">g</span><span class="op" id="8406257">,</span>&nbsp;<span class="ident" id="8406259">w</span>&nbsp;<span class="op" id="8406261">:=</span>&nbsp;<span class="ident" id="8406264">db</span><span class="op" id="8406266">.</span><span class="ident" id="8406267">numFreeConns</span><span class="op" id="8406279">(</span><span class="op" id="8406280">)</span><span class="op" id="8406281">,</span>&nbsp;<span class="num" id="8406283">10</span><span class="op" id="8406285">;</span>&nbsp;<span class="ident" id="8406287">g</span>&nbsp;<span class="op" id="8406289">!=</span>&nbsp;<span class="ident" id="8406292">w</span>&nbsp;<span class="op" id="8406294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406298">t</span><span class="op" id="8406299">.</span><span class="ident" id="8406300">Errorf</span><span class="op" id="8406306">(</span><span class="string" id="8406307">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8406333">,</span>&nbsp;<span class="ident" id="8406335">g</span><span class="op" id="8406336">,</span>&nbsp;<span class="ident" id="8406338">w</span><span class="op" id="8406339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8406342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8406346">if</span>&nbsp;<span class="ident" id="8406349">n</span>&nbsp;<span class="op" id="8406351">:=</span>&nbsp;<span class="ident" id="8406354">db</span><span class="op" id="8406356">.</span><span class="ident" id="8406357">numDepsPollUntil</span><span class="op" id="8406373">(</span><span class="num" id="8406374">10</span><span class="op" id="8406376">,</span>&nbsp;<span class="ident" id="8406378">time</span><span class="op" id="8406382">.</span><span class="ident" id="8406383">Second</span><span class="op" id="8406389">)</span><span class="op" id="8406390">;</span>&nbsp;<span class="ident" id="8406392">n</span>&nbsp;<span class="op" id="8406394">&gt;</span>&nbsp;<span class="num" id="8406396">10</span>&nbsp;<span class="op" id="8406399">{</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406403">t</span><span class="op" id="8406404">.</span><span class="ident" id="8406405">Errorf</span><span class="op" id="8406411">(</span><span class="string" id="8406412">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="8406457">,</span>&nbsp;<span class="ident" id="8406459">n</span><span class="op" id="8406460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406464">db</span><span class="op" id="8406466">.</span><span class="ident" id="8406467">dumpDeps</span><span class="op" id="8406475">(</span><span class="ident" id="8406476">t</span><span class="op" id="8406477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8406480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406484">db</span><span class="op" id="8406486">.</span><span class="ident" id="8406487">SetMaxOpenConns</span><span class="op" id="8406502">(</span><span class="num" id="8406503">5</span><span class="op" id="8406504">)</span><br>
<span class="lineno">1040</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8406508">if</span>&nbsp;<span class="ident" id="8406511">g</span><span class="op" id="8406512">,</span>&nbsp;<span class="ident" id="8406514">w</span>&nbsp;<span class="op" id="8406516">:=</span>&nbsp;<span class="ident" id="8406519">db</span><span class="op" id="8406521">.</span><span class="ident" id="8406522">numFreeConns</span><span class="op" id="8406534">(</span><span class="op" id="8406535">)</span><span class="op" id="8406536">,</span>&nbsp;<span class="num" id="8406538">5</span><span class="op" id="8406539">;</span>&nbsp;<span class="ident" id="8406541">g</span>&nbsp;<span class="op" id="8406543">!=</span>&nbsp;<span class="ident" id="8406546">w</span>&nbsp;<span class="op" id="8406548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406552">t</span><span class="op" id="8406553">.</span><span class="ident" id="8406554">Errorf</span><span class="op" id="8406560">(</span><span class="string" id="8406561">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8406587">,</span>&nbsp;<span class="ident" id="8406589">g</span><span class="op" id="8406590">,</span>&nbsp;<span class="ident" id="8406592">w</span><span class="op" id="8406593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8406596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8406600">if</span>&nbsp;<span class="ident" id="8406603">n</span>&nbsp;<span class="op" id="8406605">:=</span>&nbsp;<span class="ident" id="8406608">db</span><span class="op" id="8406610">.</span><span class="ident" id="8406611">numDepsPollUntil</span><span class="op" id="8406627">(</span><span class="num" id="8406628">5</span><span class="op" id="8406629">,</span>&nbsp;<span class="ident" id="8406631">time</span><span class="op" id="8406635">.</span><span class="ident" id="8406636">Second</span><span class="op" id="8406642">)</span><span class="op" id="8406643">;</span>&nbsp;<span class="ident" id="8406645">n</span>&nbsp;<span class="op" id="8406647">&gt;</span>&nbsp;<span class="num" id="8406649">5</span>&nbsp;<span class="op" id="8406651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406655">t</span><span class="op" id="8406656">.</span><span class="ident" id="8406657">Errorf</span><span class="op" id="8406663">(</span><span class="string" id="8406664">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8406705">,</span>&nbsp;<span class="ident" id="8406707">n</span><span class="op" id="8406708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406712">db</span><span class="op" id="8406714">.</span><span class="ident" id="8406715">dumpDeps</span><span class="op" id="8406723">(</span><span class="ident" id="8406724">t</span><span class="op" id="8406725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8406728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406732">db</span><span class="op" id="8406734">.</span><span class="ident" id="8406735">SetMaxOpenConns</span><span class="op" id="8406750">(</span><span class="num" id="8406751">0</span><span class="op" id="8406752">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8406756">if</span>&nbsp;<span class="ident" id="8406759">g</span><span class="op" id="8406760">,</span>&nbsp;<span class="ident" id="8406762">w</span>&nbsp;<span class="op" id="8406764">:=</span>&nbsp;<span class="ident" id="8406767">db</span><span class="op" id="8406769">.</span><span class="ident" id="8406770">numFreeConns</span><span class="op" id="8406782">(</span><span class="op" id="8406783">)</span><span class="op" id="8406784">,</span>&nbsp;<span class="num" id="8406786">5</span><span class="op" id="8406787">;</span>&nbsp;<span class="ident" id="8406789">g</span>&nbsp;<span class="op" id="8406791">!=</span>&nbsp;<span class="ident" id="8406794">w</span>&nbsp;<span class="op" id="8406796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406800">t</span><span class="op" id="8406801">.</span><span class="ident" id="8406802">Errorf</span><span class="op" id="8406808">(</span><span class="string" id="8406809">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8406835">,</span>&nbsp;<span class="ident" id="8406837">g</span><span class="op" id="8406838">,</span>&nbsp;<span class="ident" id="8406840">w</span><span class="op" id="8406841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8406844">}</span><br>
<span class="lineno">1055</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8406848">if</span>&nbsp;<span class="ident" id="8406851">n</span>&nbsp;<span class="op" id="8406853">:=</span>&nbsp;<span class="ident" id="8406856">db</span><span class="op" id="8406858">.</span><span class="ident" id="8406859">numDepsPollUntil</span><span class="op" id="8406875">(</span><span class="num" id="8406876">5</span><span class="op" id="8406877">,</span>&nbsp;<span class="ident" id="8406879">time</span><span class="op" id="8406883">.</span><span class="ident" id="8406884">Second</span><span class="op" id="8406890">)</span><span class="op" id="8406891">;</span>&nbsp;<span class="ident" id="8406893">n</span>&nbsp;<span class="op" id="8406895">&gt;</span>&nbsp;<span class="num" id="8406897">5</span>&nbsp;<span class="op" id="8406899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406903">t</span><span class="op" id="8406904">.</span><span class="ident" id="8406905">Errorf</span><span class="op" id="8406911">(</span><span class="string" id="8406912">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8406953">,</span>&nbsp;<span class="ident" id="8406955">n</span><span class="op" id="8406956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406960">db</span><span class="op" id="8406962">.</span><span class="ident" id="8406963">dumpDeps</span><span class="op" id="8406971">(</span><span class="ident" id="8406972">t</span><span class="op" id="8406973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8406976">}</span><br>
<span class="lineno">1060</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406980">db</span><span class="op" id="8406982">.</span><span class="ident" id="8406983">SetMaxIdleConns</span><span class="op" id="8406998">(</span><span class="num" id="8406999">0</span><span class="op" id="8407000">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407004">if</span>&nbsp;<span class="ident" id="8407007">g</span><span class="op" id="8407008">,</span>&nbsp;<span class="ident" id="8407010">w</span>&nbsp;<span class="op" id="8407012">:=</span>&nbsp;<span class="ident" id="8407015">db</span><span class="op" id="8407017">.</span><span class="ident" id="8407018">numFreeConns</span><span class="op" id="8407030">(</span><span class="op" id="8407031">)</span><span class="op" id="8407032">,</span>&nbsp;<span class="num" id="8407034">0</span><span class="op" id="8407035">;</span>&nbsp;<span class="ident" id="8407037">g</span>&nbsp;<span class="op" id="8407039">!=</span>&nbsp;<span class="ident" id="8407042">w</span>&nbsp;<span class="op" id="8407044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407048">t</span><span class="op" id="8407049">.</span><span class="ident" id="8407050">Errorf</span><span class="op" id="8407056">(</span><span class="string" id="8407057">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8407083">,</span>&nbsp;<span class="ident" id="8407085">g</span><span class="op" id="8407086">,</span>&nbsp;<span class="ident" id="8407088">w</span><span class="op" id="8407089">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407096">if</span>&nbsp;<span class="ident" id="8407099">n</span>&nbsp;<span class="op" id="8407101">:=</span>&nbsp;<span class="ident" id="8407104">db</span><span class="op" id="8407106">.</span><span class="ident" id="8407107">numDepsPollUntil</span><span class="op" id="8407123">(</span><span class="num" id="8407124">0</span><span class="op" id="8407125">,</span>&nbsp;<span class="ident" id="8407127">time</span><span class="op" id="8407131">.</span><span class="ident" id="8407132">Second</span><span class="op" id="8407138">)</span><span class="op" id="8407139">;</span>&nbsp;<span class="ident" id="8407141">n</span>&nbsp;<span class="op" id="8407143">&gt;</span>&nbsp;<span class="num" id="8407145">0</span>&nbsp;<span class="op" id="8407147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407151">t</span><span class="op" id="8407152">.</span><span class="ident" id="8407153">Errorf</span><span class="op" id="8407159">(</span><span class="string" id="8407160">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8407201">,</span>&nbsp;<span class="ident" id="8407203">n</span><span class="op" id="8407204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407208">db</span><span class="op" id="8407210">.</span><span class="ident" id="8407211">dumpDeps</span><span class="op" id="8407219">(</span><span class="ident" id="8407220">t</span><span class="op" id="8407221">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407224">}</span><br>
<span class="lineno"></span><span class="op" id="8407226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8407229">func</span>&nbsp;<span class="ident" id="8407234">TestSingleOpenConn</span><span class="op" id="8407252">(</span><span class="ident" id="8407253">t</span>&nbsp;<span class="op" id="8407255">*</span><span class="ident" id="8407256">testing</span><span class="op" id="8407263">.</span><span class="ident" id="8407264">T</span><span class="op" id="8407265">)</span>&nbsp;<span class="op" id="8407267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407270">db</span>&nbsp;<span class="op" id="8407273">:=</span>&nbsp;<span class="ident" id="8407276">newTestDB</span><span class="op" id="8407285">(</span><span class="ident" id="8407286">t</span><span class="op" id="8407287">,</span>&nbsp;<span class="string" id="8407289">&#34;people&#34;</span><span class="op" id="8407297">)</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407300">defer</span>&nbsp;<span class="ident" id="8407306">closeDB</span><span class="op" id="8407313">(</span><span class="ident" id="8407314">t</span><span class="op" id="8407315">,</span>&nbsp;<span class="ident" id="8407317">db</span><span class="op" id="8407319">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407323">db</span><span class="op" id="8407325">.</span><span class="ident" id="8407326">SetMaxOpenConns</span><span class="op" id="8407341">(</span><span class="num" id="8407342">1</span><span class="op" id="8407343">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407347">rows</span><span class="op" id="8407351">,</span>&nbsp;<span class="ident" id="8407353">err</span>&nbsp;<span class="op" id="8407357">:=</span>&nbsp;<span class="ident" id="8407360">db</span><span class="op" id="8407362">.</span><span class="ident" id="8407363">Query</span><span class="op" id="8407368">(</span><span class="string" id="8407369">&#34;SELECT|people|name|&#34;</span><span class="op" id="8407390">)</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407393">if</span>&nbsp;<span class="ident" id="8407396">err</span>&nbsp;<span class="op" id="8407400">!=</span>&nbsp;<span class="ident" id="8407403">nil</span>&nbsp;<span class="op" id="8407407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407411">t</span><span class="op" id="8407412">.</span><span class="ident" id="8407413">Fatal</span><span class="op" id="8407418">(</span><span class="ident" id="8407419">err</span><span class="op" id="8407422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407428">if</span>&nbsp;<span class="ident" id="8407431">err</span>&nbsp;<span class="op" id="8407435">=</span>&nbsp;<span class="ident" id="8407437">rows</span><span class="op" id="8407441">.</span><span class="ident" id="8407442">Close</span><span class="op" id="8407447">(</span><span class="op" id="8407448">)</span><span class="op" id="8407449">;</span>&nbsp;<span class="ident" id="8407451">err</span>&nbsp;<span class="op" id="8407455">!=</span>&nbsp;<span class="ident" id="8407458">nil</span>&nbsp;<span class="op" id="8407462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407466">t</span><span class="op" id="8407467">.</span><span class="ident" id="8407468">Fatal</span><span class="op" id="8407473">(</span><span class="ident" id="8407474">err</span><span class="op" id="8407477">)</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8407483">//&nbsp;shouldn&#39;t&nbsp;deadlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407506">rows</span><span class="op" id="8407510">,</span>&nbsp;<span class="ident" id="8407512">err</span>&nbsp;<span class="op" id="8407516">=</span>&nbsp;<span class="ident" id="8407518">db</span><span class="op" id="8407520">.</span><span class="ident" id="8407521">Query</span><span class="op" id="8407526">(</span><span class="string" id="8407527">&#34;SELECT|people|name|&#34;</span><span class="op" id="8407548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407551">if</span>&nbsp;<span class="ident" id="8407554">err</span>&nbsp;<span class="op" id="8407558">!=</span>&nbsp;<span class="ident" id="8407561">nil</span>&nbsp;<span class="op" id="8407565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407569">t</span><span class="op" id="8407570">.</span><span class="ident" id="8407571">Fatal</span><span class="op" id="8407576">(</span><span class="ident" id="8407577">err</span><span class="op" id="8407580">)</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407586">if</span>&nbsp;<span class="ident" id="8407589">err</span>&nbsp;<span class="op" id="8407593">=</span>&nbsp;<span class="ident" id="8407595">rows</span><span class="op" id="8407599">.</span><span class="ident" id="8407600">Close</span><span class="op" id="8407605">(</span><span class="op" id="8407606">)</span><span class="op" id="8407607">;</span>&nbsp;<span class="ident" id="8407609">err</span>&nbsp;<span class="op" id="8407613">!=</span>&nbsp;<span class="ident" id="8407616">nil</span>&nbsp;<span class="op" id="8407620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407624">t</span><span class="op" id="8407625">.</span><span class="ident" id="8407626">Fatal</span><span class="op" id="8407631">(</span><span class="ident" id="8407632">err</span><span class="op" id="8407635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407638">}</span><br>
<span class="lineno"></span><span class="op" id="8407640">}</span><br>
<span class="lineno">1095</span><br>
<span class="lineno"></span><span class="comment" id="8407643">//&nbsp;golang.org/issue/5323</span><br>
<span class="lineno"></span><span class="keyword" id="8407668">func</span>&nbsp;<span class="ident" id="8407673">TestStmtCloseDeps</span><span class="op" id="8407690">(</span><span class="ident" id="8407691">t</span>&nbsp;<span class="op" id="8407693">*</span><span class="ident" id="8407694">testing</span><span class="op" id="8407701">.</span><span class="ident" id="8407702">T</span><span class="op" id="8407703">)</span>&nbsp;<span class="op" id="8407705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407708">if</span>&nbsp;<span class="ident" id="8407711">testing</span><span class="op" id="8407718">.</span><span class="ident" id="8407719">Short</span><span class="op" id="8407724">(</span><span class="op" id="8407725">)</span>&nbsp;<span class="op" id="8407727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407731">t</span><span class="op" id="8407732">.</span><span class="ident" id="8407733">Skip</span><span class="op" id="8407737">(</span><span class="string" id="8407738">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="8407762">)</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407768">defer</span>&nbsp;<span class="ident" id="8407774">setHookpostCloseConn</span><span class="op" id="8407794">(</span><span class="ident" id="8407795">nil</span><span class="op" id="8407798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407801">setHookpostCloseConn</span><span class="op" id="8407821">(</span><span class="keyword" id="8407822">func</span><span class="op" id="8407826">(</span><span class="ident" id="8407827">_</span>&nbsp;<span class="op" id="8407829">*</span><span class="ident" id="8407830">fakeConn</span><span class="op" id="8407838">,</span>&nbsp;<span class="ident" id="8407840">err</span>&nbsp;<span class="builtintype" id="8407844">error</span><span class="op" id="8407849">)</span>&nbsp;<span class="op" id="8407851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407855">if</span>&nbsp;<span class="ident" id="8407858">err</span>&nbsp;<span class="op" id="8407862">!=</span>&nbsp;<span class="ident" id="8407865">nil</span>&nbsp;<span class="op" id="8407869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407874">t</span><span class="op" id="8407875">.</span><span class="ident" id="8407876">Errorf</span><span class="op" id="8407882">(</span><span class="string" id="8407883">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="8407911">,</span>&nbsp;<span class="ident" id="8407913">err</span><span class="op" id="8407916">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407923">}</span><span class="op" id="8407924">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407928">db</span>&nbsp;<span class="op" id="8407931">:=</span>&nbsp;<span class="ident" id="8407934">newTestDB</span><span class="op" id="8407943">(</span><span class="ident" id="8407944">t</span><span class="op" id="8407945">,</span>&nbsp;<span class="string" id="8407947">&#34;magicquery&#34;</span><span class="op" id="8407959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407962">defer</span>&nbsp;<span class="ident" id="8407968">closeDB</span><span class="op" id="8407975">(</span><span class="ident" id="8407976">t</span><span class="op" id="8407977">,</span>&nbsp;<span class="ident" id="8407979">db</span><span class="op" id="8407981">)</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407985">driver</span>&nbsp;<span class="op" id="8407992">:=</span>&nbsp;<span class="ident" id="8407995">db</span><span class="op" id="8407997">.</span><span class="ident" id="8407998">driver</span><span class="op" id="8408004">.</span><span class="op" id="8408005">(</span><span class="op" id="8408006">*</span><span class="ident" id="8408007">fakeDriver</span><span class="op" id="8408017">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408021">driver</span><span class="op" id="8408027">.</span><span class="ident" id="8408028">mu</span><span class="op" id="8408030">.</span><span class="ident" id="8408031">Lock</span><span class="op" id="8408035">(</span><span class="op" id="8408036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408039">opens0</span>&nbsp;<span class="op" id="8408046">:=</span>&nbsp;<span class="ident" id="8408049">driver</span><span class="op" id="8408055">.</span><span class="ident" id="8408056">openCount</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408067">closes0</span>&nbsp;<span class="op" id="8408075">:=</span>&nbsp;<span class="ident" id="8408078">driver</span><span class="op" id="8408084">.</span><span class="ident" id="8408085">closeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408097">driver</span><span class="op" id="8408103">.</span><span class="ident" id="8408104">mu</span><span class="op" id="8408106">.</span><span class="ident" id="8408107">Unlock</span><span class="op" id="8408113">(</span><span class="op" id="8408114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408117">openDelta0</span>&nbsp;<span class="op" id="8408128">:=</span>&nbsp;<span class="ident" id="8408131">opens0</span>&nbsp;<span class="op" id="8408138">-</span>&nbsp;<span class="ident" id="8408140">closes0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408150">stmt</span><span class="op" id="8408154">,</span>&nbsp;<span class="ident" id="8408156">err</span>&nbsp;<span class="op" id="8408160">:=</span>&nbsp;<span class="ident" id="8408163">db</span><span class="op" id="8408165">.</span><span class="ident" id="8408166">Prepare</span><span class="op" id="8408173">(</span><span class="string" id="8408174">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="8408210">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8408213">if</span>&nbsp;<span class="ident" id="8408216">err</span>&nbsp;<span class="op" id="8408220">!=</span>&nbsp;<span class="ident" id="8408223">nil</span>&nbsp;<span class="op" id="8408227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408231">t</span><span class="op" id="8408232">.</span><span class="ident" id="8408233">Fatal</span><span class="op" id="8408238">(</span><span class="ident" id="8408239">err</span><span class="op" id="8408242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8408245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8408249">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8408285">const</span>&nbsp;<span class="op" id="8408291">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408295">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8408307">=</span>&nbsp;<span class="num" id="8408309">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408314">sleepMillis</span>&nbsp;<span class="op" id="8408326">=</span>&nbsp;<span class="num" id="8408328">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408333">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8408345">=</span>&nbsp;<span class="num" id="8408347">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8408350">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8408353">var</span>&nbsp;<span class="ident" id="8408357">wg</span>&nbsp;<span class="ident" id="8408360">sync</span><span class="op" id="8408364">.</span><span class="ident" id="8408365">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8408376">for</span>&nbsp;<span class="ident" id="8408380">batch</span>&nbsp;<span class="op" id="8408386">:=</span>&nbsp;<span class="num" id="8408389">0</span><span class="op" id="8408390">;</span>&nbsp;<span class="ident" id="8408392">batch</span>&nbsp;<span class="op" id="8408398">&lt;</span>&nbsp;<span class="ident" id="8408400">nbatch</span><span class="op" id="8408406">;</span>&nbsp;<span class="ident" id="8408408">batch</span><span class="op" id="8408413">++</span>&nbsp;<span class="op" id="8408416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8408420">for</span>&nbsp;<span class="ident" id="8408424">i</span>&nbsp;<span class="op" id="8408426">:=</span>&nbsp;<span class="num" id="8408429">0</span><span class="op" id="8408430">;</span>&nbsp;<span class="ident" id="8408432">i</span>&nbsp;<span class="op" id="8408434">&lt;</span>&nbsp;<span class="ident" id="8408436">nquery</span><span class="op" id="8408442">;</span>&nbsp;<span class="ident" id="8408444">i</span><span class="op" id="8408445">++</span>&nbsp;<span class="op" id="8408448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408453">wg</span><span class="op" id="8408455">.</span><span class="ident" id="8408456">Add</span><span class="op" id="8408459">(</span><span class="num" id="8408460">1</span><span class="op" id="8408461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8408466">go</span>&nbsp;<span class="keyword" id="8408469">func</span><span class="op" id="8408473">(</span><span class="op" id="8408474">)</span>&nbsp;<span class="op" id="8408476">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8408482">defer</span>&nbsp;<span class="ident" id="8408488">wg</span><span class="op" id="8408490">.</span><span class="ident" id="8408491">Done</span><span class="op" id="8408495">(</span><span class="op" id="8408496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8408502">var</span>&nbsp;<span class="ident" id="8408506">op</span>&nbsp;<span class="builtintype" id="8408509">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8408520">if</span>&nbsp;<span class="ident" id="8408523">err</span>&nbsp;<span class="op" id="8408527">:=</span>&nbsp;<span class="ident" id="8408530">stmt</span><span class="op" id="8408534">.</span><span class="ident" id="8408535">QueryRow</span><span class="op" id="8408543">(</span><span class="string" id="8408544">&#34;sleep&#34;</span><span class="op" id="8408551">,</span>&nbsp;<span class="ident" id="8408553">sleepMillis</span><span class="op" id="8408564">)</span><span class="op" id="8408565">.</span><span class="ident" id="8408566">Scan</span><span class="op" id="8408570">(</span><span class="op" id="8408571">&amp;</span><span class="ident" id="8408572">op</span><span class="op" id="8408574">)</span><span class="op" id="8408575">;</span>&nbsp;<span class="ident" id="8408577">err</span>&nbsp;<span class="op" id="8408581">!=</span>&nbsp;<span class="ident" id="8408584">nil</span>&nbsp;<span class="op" id="8408588">&amp;&amp;</span>&nbsp;<span class="ident" id="8408591">err</span>&nbsp;<span class="op" id="8408595">!=</span>&nbsp;<span class="ident" id="8408598">ErrNoRows</span>&nbsp;<span class="op" id="8408608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408615">t</span><span class="op" id="8408616">.</span><span class="ident" id="8408617">Error</span><span class="op" id="8408622">(</span><span class="ident" id="8408623">err</span><span class="op" id="8408626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8408632">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8408637">}</span><span class="op" id="8408638">(</span><span class="op" id="8408639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8408643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8408647">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8408704">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8408761">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408782">time</span><span class="op" id="8408786">.</span><span class="ident" id="8408787">Sleep</span><span class="op" id="8408792">(</span><span class="num" id="8408793">2</span>&nbsp;<span class="op" id="8408795">*</span>&nbsp;<span class="ident" id="8408797">sleepMillis</span>&nbsp;<span class="op" id="8408809">*</span>&nbsp;<span class="ident" id="8408811">time</span><span class="op" id="8408815">.</span><span class="ident" id="8408816">Millisecond</span><span class="op" id="8408827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8408830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408833">wg</span><span class="op" id="8408835">.</span><span class="ident" id="8408836">Wait</span><span class="op" id="8408840">(</span><span class="op" id="8408841">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8408845">if</span>&nbsp;<span class="ident" id="8408848">g</span><span class="op" id="8408849">,</span>&nbsp;<span class="ident" id="8408851">w</span>&nbsp;<span class="op" id="8408853">:=</span>&nbsp;<span class="ident" id="8408856">db</span><span class="op" id="8408858">.</span><span class="ident" id="8408859">numFreeConns</span><span class="op" id="8408871">(</span><span class="op" id="8408872">)</span><span class="op" id="8408873">,</span>&nbsp;<span class="num" id="8408875">2</span><span class="op" id="8408876">;</span>&nbsp;<span class="ident" id="8408878">g</span>&nbsp;<span class="op" id="8408880">!=</span>&nbsp;<span class="ident" id="8408883">w</span>&nbsp;<span class="op" id="8408885">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408889">t</span><span class="op" id="8408890">.</span><span class="ident" id="8408891">Errorf</span><span class="op" id="8408897">(</span><span class="string" id="8408898">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8408924">,</span>&nbsp;<span class="ident" id="8408926">g</span><span class="op" id="8408927">,</span>&nbsp;<span class="ident" id="8408929">w</span><span class="op" id="8408930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8408933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8408937">if</span>&nbsp;<span class="ident" id="8408940">n</span>&nbsp;<span class="op" id="8408942">:=</span>&nbsp;<span class="ident" id="8408945">db</span><span class="op" id="8408947">.</span><span class="ident" id="8408948">numDepsPollUntil</span><span class="op" id="8408964">(</span><span class="num" id="8408965">4</span><span class="op" id="8408966">,</span>&nbsp;<span class="ident" id="8408968">time</span><span class="op" id="8408972">.</span><span class="ident" id="8408973">Second</span><span class="op" id="8408979">)</span><span class="op" id="8408980">;</span>&nbsp;<span class="ident" id="8408982">n</span>&nbsp;<span class="op" id="8408984">&gt;</span>&nbsp;<span class="num" id="8408986">4</span>&nbsp;<span class="op" id="8408988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408992">t</span><span class="op" id="8408993">.</span><span class="ident" id="8408994">Errorf</span><span class="op" id="8409000">(</span><span class="string" id="8409001">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;4&#34;</span><span class="op" id="8409045">,</span>&nbsp;<span class="ident" id="8409047">n</span><span class="op" id="8409048">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409052">db</span><span class="op" id="8409054">.</span><span class="ident" id="8409055">dumpDeps</span><span class="op" id="8409063">(</span><span class="ident" id="8409064">t</span><span class="op" id="8409065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8409068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409072">driver</span><span class="op" id="8409078">.</span><span class="ident" id="8409079">mu</span><span class="op" id="8409081">.</span><span class="ident" id="8409082">Lock</span><span class="op" id="8409086">(</span><span class="op" id="8409087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409090">opens</span>&nbsp;<span class="op" id="8409096">:=</span>&nbsp;<span class="ident" id="8409099">driver</span><span class="op" id="8409105">.</span><span class="ident" id="8409106">openCount</span>&nbsp;<span class="op" id="8409116">-</span>&nbsp;<span class="ident" id="8409118">opens0</span><br>
<span class="lineno">1160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409126">closes</span>&nbsp;<span class="op" id="8409133">:=</span>&nbsp;<span class="ident" id="8409136">driver</span><span class="op" id="8409142">.</span><span class="ident" id="8409143">closeCount</span>&nbsp;<span class="op" id="8409154">-</span>&nbsp;<span class="ident" id="8409156">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409165">openDelta</span>&nbsp;<span class="op" id="8409175">:=</span>&nbsp;<span class="op" id="8409178">(</span><span class="ident" id="8409179">driver</span><span class="op" id="8409185">.</span><span class="ident" id="8409186">openCount</span>&nbsp;<span class="op" id="8409196">-</span>&nbsp;<span class="ident" id="8409198">driver</span><span class="op" id="8409204">.</span><span class="ident" id="8409205">closeCount</span><span class="op" id="8409215">)</span>&nbsp;<span class="op" id="8409217">-</span>&nbsp;<span class="ident" id="8409219">openDelta0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409231">driver</span><span class="op" id="8409237">.</span><span class="ident" id="8409238">mu</span><span class="op" id="8409240">.</span><span class="ident" id="8409241">Unlock</span><span class="op" id="8409247">(</span><span class="op" id="8409248">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8409252">if</span>&nbsp;<span class="ident" id="8409255">openDelta</span>&nbsp;<span class="op" id="8409265">&gt;</span>&nbsp;<span class="num" id="8409267">2</span>&nbsp;<span class="op" id="8409269">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409273">t</span><span class="op" id="8409274">.</span><span class="ident" id="8409275">Logf</span><span class="op" id="8409279">(</span><span class="string" id="8409280">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8409297">,</span>&nbsp;<span class="ident" id="8409299">opens</span><span class="op" id="8409304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409308">t</span><span class="op" id="8409309">.</span><span class="ident" id="8409310">Logf</span><span class="op" id="8409314">(</span><span class="string" id="8409315">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8409333">,</span>&nbsp;<span class="ident" id="8409335">closes</span><span class="op" id="8409341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409345">t</span><span class="op" id="8409346">.</span><span class="ident" id="8409347">Logf</span><span class="op" id="8409351">(</span><span class="string" id="8409352">&#34;open&nbsp;delta&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8409369">,</span>&nbsp;<span class="ident" id="8409371">openDelta</span><span class="op" id="8409380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409384">t</span><span class="op" id="8409385">.</span><span class="ident" id="8409386">Errorf</span><span class="op" id="8409392">(</span><span class="string" id="8409393">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="8409432">,</span>&nbsp;<span class="ident" id="8409434">openDelta</span><span class="op" id="8409443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409447">db</span><span class="op" id="8409449">.</span><span class="ident" id="8409450">dumpDeps</span><span class="op" id="8409458">(</span><span class="ident" id="8409459">t</span><span class="op" id="8409460">)</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8409463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8409467">if</span>&nbsp;<span class="builtinfunc" id="8409470">len</span><span class="op" id="8409473">(</span><span class="ident" id="8409474">stmt</span><span class="op" id="8409478">.</span><span class="ident" id="8409479">css</span><span class="op" id="8409482">)</span>&nbsp;<span class="op" id="8409484">&gt;</span>&nbsp;<span class="ident" id="8409486">nquery</span>&nbsp;<span class="op" id="8409493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409497">t</span><span class="op" id="8409498">.</span><span class="ident" id="8409499">Errorf</span><span class="op" id="8409505">(</span><span class="string" id="8409506">&#34;len(stmt.css)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;%d&#34;</span><span class="op" id="8409538">,</span>&nbsp;<span class="builtinfunc" id="8409540">len</span><span class="op" id="8409543">(</span><span class="ident" id="8409544">stmt</span><span class="op" id="8409548">.</span><span class="ident" id="8409549">css</span><span class="op" id="8409552">)</span><span class="op" id="8409553">,</span>&nbsp;<span class="ident" id="8409555">nquery</span><span class="op" id="8409561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8409564">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8409568">if</span>&nbsp;<span class="ident" id="8409571">err</span>&nbsp;<span class="op" id="8409575">:=</span>&nbsp;<span class="ident" id="8409578">stmt</span><span class="op" id="8409582">.</span><span class="ident" id="8409583">Close</span><span class="op" id="8409588">(</span><span class="op" id="8409589">)</span><span class="op" id="8409590">;</span>&nbsp;<span class="ident" id="8409592">err</span>&nbsp;<span class="op" id="8409596">!=</span>&nbsp;<span class="ident" id="8409599">nil</span>&nbsp;<span class="op" id="8409603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409607">t</span><span class="op" id="8409608">.</span><span class="ident" id="8409609">Fatal</span><span class="op" id="8409614">(</span><span class="ident" id="8409615">err</span><span class="op" id="8409618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8409621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8409625">if</span>&nbsp;<span class="ident" id="8409628">g</span><span class="op" id="8409629">,</span>&nbsp;<span class="ident" id="8409631">w</span>&nbsp;<span class="op" id="8409633">:=</span>&nbsp;<span class="ident" id="8409636">db</span><span class="op" id="8409638">.</span><span class="ident" id="8409639">numFreeConns</span><span class="op" id="8409651">(</span><span class="op" id="8409652">)</span><span class="op" id="8409653">,</span>&nbsp;<span class="num" id="8409655">2</span><span class="op" id="8409656">;</span>&nbsp;<span class="ident" id="8409658">g</span>&nbsp;<span class="op" id="8409660">!=</span>&nbsp;<span class="ident" id="8409663">w</span>&nbsp;<span class="op" id="8409665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409669">t</span><span class="op" id="8409670">.</span><span class="ident" id="8409671">Errorf</span><span class="op" id="8409677">(</span><span class="string" id="8409678">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8409704">,</span>&nbsp;<span class="ident" id="8409706">g</span><span class="op" id="8409707">,</span>&nbsp;<span class="ident" id="8409709">w</span><span class="op" id="8409710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8409713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8409717">if</span>&nbsp;<span class="ident" id="8409720">n</span>&nbsp;<span class="op" id="8409722">:=</span>&nbsp;<span class="ident" id="8409725">db</span><span class="op" id="8409727">.</span><span class="ident" id="8409728">numDepsPollUntil</span><span class="op" id="8409744">(</span><span class="num" id="8409745">2</span><span class="op" id="8409746">,</span>&nbsp;<span class="ident" id="8409748">time</span><span class="op" id="8409752">.</span><span class="ident" id="8409753">Second</span><span class="op" id="8409759">)</span><span class="op" id="8409760">;</span>&nbsp;<span class="ident" id="8409762">n</span>&nbsp;<span class="op" id="8409764">&gt;</span>&nbsp;<span class="num" id="8409766">2</span>&nbsp;<span class="op" id="8409768">{</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409772">t</span><span class="op" id="8409773">.</span><span class="ident" id="8409774">Errorf</span><span class="op" id="8409780">(</span><span class="string" id="8409781">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="8409825">,</span>&nbsp;<span class="ident" id="8409827">n</span><span class="op" id="8409828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409832">db</span><span class="op" id="8409834">.</span><span class="ident" id="8409835">dumpDeps</span><span class="op" id="8409843">(</span><span class="ident" id="8409844">t</span><span class="op" id="8409845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8409848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409852">db</span><span class="op" id="8409854">.</span><span class="ident" id="8409855">SetMaxIdleConns</span><span class="op" id="8409870">(</span><span class="num" id="8409871">0</span><span class="op" id="8409872">)</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8409876">if</span>&nbsp;<span class="ident" id="8409879">g</span><span class="op" id="8409880">,</span>&nbsp;<span class="ident" id="8409882">w</span>&nbsp;<span class="op" id="8409884">:=</span>&nbsp;<span class="ident" id="8409887">db</span><span class="op" id="8409889">.</span><span class="ident" id="8409890">numFreeConns</span><span class="op" id="8409902">(</span><span class="op" id="8409903">)</span><span class="op" id="8409904">,</span>&nbsp;<span class="num" id="8409906">0</span><span class="op" id="8409907">;</span>&nbsp;<span class="ident" id="8409909">g</span>&nbsp;<span class="op" id="8409911">!=</span>&nbsp;<span class="ident" id="8409914">w</span>&nbsp;<span class="op" id="8409916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409920">t</span><span class="op" id="8409921">.</span><span class="ident" id="8409922">Errorf</span><span class="op" id="8409928">(</span><span class="string" id="8409929">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8409955">,</span>&nbsp;<span class="ident" id="8409957">g</span><span class="op" id="8409958">,</span>&nbsp;<span class="ident" id="8409960">w</span><span class="op" id="8409961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8409964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8409968">if</span>&nbsp;<span class="ident" id="8409971">n</span>&nbsp;<span class="op" id="8409973">:=</span>&nbsp;<span class="ident" id="8409976">db</span><span class="op" id="8409978">.</span><span class="ident" id="8409979">numDepsPollUntil</span><span class="op" id="8409995">(</span><span class="num" id="8409996">0</span><span class="op" id="8409997">,</span>&nbsp;<span class="ident" id="8409999">time</span><span class="op" id="8410003">.</span><span class="ident" id="8410004">Second</span><span class="op" id="8410010">)</span><span class="op" id="8410011">;</span>&nbsp;<span class="ident" id="8410013">n</span>&nbsp;<span class="op" id="8410015">&gt;</span>&nbsp;<span class="num" id="8410017">0</span>&nbsp;<span class="op" id="8410019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410023">t</span><span class="op" id="8410024">.</span><span class="ident" id="8410025">Errorf</span><span class="op" id="8410031">(</span><span class="string" id="8410032">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8410073">,</span>&nbsp;<span class="ident" id="8410075">n</span><span class="op" id="8410076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410080">db</span><span class="op" id="8410082">.</span><span class="ident" id="8410083">dumpDeps</span><span class="op" id="8410091">(</span><span class="ident" id="8410092">t</span><span class="op" id="8410093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8410096">}</span><br>
<span class="lineno"></span><span class="op" id="8410098">}</span><br>
<span class="lineno">1200</span><br>
<span class="lineno"></span><span class="comment" id="8410101">//&nbsp;golang.org/issue/5046</span><br>
<span class="lineno"></span><span class="keyword" id="8410126">func</span>&nbsp;<span class="ident" id="8410131">TestCloseConnBeforeStmts</span><span class="op" id="8410155">(</span><span class="ident" id="8410156">t</span>&nbsp;<span class="op" id="8410158">*</span><span class="ident" id="8410159">testing</span><span class="op" id="8410166">.</span><span class="ident" id="8410167">T</span><span class="op" id="8410168">)</span>&nbsp;<span class="op" id="8410170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410173">db</span>&nbsp;<span class="op" id="8410176">:=</span>&nbsp;<span class="ident" id="8410179">newTestDB</span><span class="op" id="8410188">(</span><span class="ident" id="8410189">t</span><span class="op" id="8410190">,</span>&nbsp;<span class="string" id="8410192">&#34;people&#34;</span><span class="op" id="8410200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410203">defer</span>&nbsp;<span class="ident" id="8410209">closeDB</span><span class="op" id="8410216">(</span><span class="ident" id="8410217">t</span><span class="op" id="8410218">,</span>&nbsp;<span class="ident" id="8410220">db</span><span class="op" id="8410222">)</span><br>
<span class="lineno">1205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410226">defer</span>&nbsp;<span class="ident" id="8410232">setHookpostCloseConn</span><span class="op" id="8410252">(</span><span class="ident" id="8410253">nil</span><span class="op" id="8410256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410259">setHookpostCloseConn</span><span class="op" id="8410279">(</span><span class="keyword" id="8410280">func</span><span class="op" id="8410284">(</span><span class="ident" id="8410285">_</span>&nbsp;<span class="op" id="8410287">*</span><span class="ident" id="8410288">fakeConn</span><span class="op" id="8410296">,</span>&nbsp;<span class="ident" id="8410298">err</span>&nbsp;<span class="builtintype" id="8410302">error</span><span class="op" id="8410307">)</span>&nbsp;<span class="op" id="8410309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410313">if</span>&nbsp;<span class="ident" id="8410316">err</span>&nbsp;<span class="op" id="8410320">!=</span>&nbsp;<span class="ident" id="8410323">nil</span>&nbsp;<span class="op" id="8410327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410332">t</span><span class="op" id="8410333">.</span><span class="ident" id="8410334">Errorf</span><span class="op" id="8410340">(</span><span class="string" id="8410341">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v;&nbsp;from&nbsp;%s&#34;</span><span class="op" id="8410378">,</span>&nbsp;<span class="ident" id="8410380">err</span><span class="op" id="8410383">,</span>&nbsp;<span class="ident" id="8410385">stack</span><span class="op" id="8410390">(</span><span class="op" id="8410391">)</span><span class="op" id="8410392">)</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410397">db</span><span class="op" id="8410399">.</span><span class="ident" id="8410400">dumpDeps</span><span class="op" id="8410408">(</span><span class="ident" id="8410409">t</span><span class="op" id="8410410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410415">t</span><span class="op" id="8410416">.</span><span class="ident" id="8410417">Errorf</span><span class="op" id="8410423">(</span><span class="string" id="8410424">&#34;DB&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="8410434">,</span>&nbsp;<span class="ident" id="8410436">db</span><span class="op" id="8410438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8410442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8410445">}</span><span class="op" id="8410446">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410450">stmt</span><span class="op" id="8410454">,</span>&nbsp;<span class="ident" id="8410456">err</span>&nbsp;<span class="op" id="8410460">:=</span>&nbsp;<span class="ident" id="8410463">db</span><span class="op" id="8410465">.</span><span class="ident" id="8410466">Prepare</span><span class="op" id="8410473">(</span><span class="string" id="8410474">&#34;SELECT|people|name|&#34;</span><span class="op" id="8410495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410498">if</span>&nbsp;<span class="ident" id="8410501">err</span>&nbsp;<span class="op" id="8410505">!=</span>&nbsp;<span class="ident" id="8410508">nil</span>&nbsp;<span class="op" id="8410512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410516">t</span><span class="op" id="8410517">.</span><span class="ident" id="8410518">Fatal</span><span class="op" id="8410523">(</span><span class="ident" id="8410524">err</span><span class="op" id="8410527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8410530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410534">if</span>&nbsp;<span class="builtinfunc" id="8410537">len</span><span class="op" id="8410540">(</span><span class="ident" id="8410541">db</span><span class="op" id="8410543">.</span><span class="ident" id="8410544">freeConn</span><span class="op" id="8410552">)</span>&nbsp;<span class="op" id="8410554">!=</span>&nbsp;<span class="num" id="8410557">1</span>&nbsp;<span class="op" id="8410559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410563">t</span><span class="op" id="8410564">.</span><span class="ident" id="8410565">Fatalf</span><span class="op" id="8410571">(</span><span class="string" id="8410572">&#34;expected&nbsp;1&nbsp;freeConn;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8410601">,</span>&nbsp;<span class="builtinfunc" id="8410603">len</span><span class="op" id="8410606">(</span><span class="ident" id="8410607">db</span><span class="op" id="8410609">.</span><span class="ident" id="8410610">freeConn</span><span class="op" id="8410618">)</span><span class="op" id="8410619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8410622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410625">dc</span>&nbsp;<span class="op" id="8410628">:=</span>&nbsp;<span class="ident" id="8410631">db</span><span class="op" id="8410633">.</span><span class="ident" id="8410634">freeConn</span><span class="op" id="8410642">[</span><span class="num" id="8410643">0</span><span class="op" id="8410644">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410647">if</span>&nbsp;<span class="ident" id="8410650">dc</span><span class="op" id="8410652">.</span><span class="ident" id="8410653">closed</span>&nbsp;<span class="op" id="8410660">{</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410664">t</span><span class="op" id="8410665">.</span><span class="ident" id="8410666">Errorf</span><span class="op" id="8410672">(</span><span class="string" id="8410673">&#34;conn&nbsp;shouldn&#39;t&nbsp;be&nbsp;closed&#34;</span><span class="op" id="8410699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8410702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410706">if</span>&nbsp;<span class="ident" id="8410709">n</span>&nbsp;<span class="op" id="8410711">:=</span>&nbsp;<span class="builtinfunc" id="8410714">len</span><span class="op" id="8410717">(</span><span class="ident" id="8410718">dc</span><span class="op" id="8410720">.</span><span class="ident" id="8410721">openStmt</span><span class="op" id="8410729">)</span><span class="op" id="8410730">;</span>&nbsp;<span class="ident" id="8410732">n</span>&nbsp;<span class="op" id="8410734">!=</span>&nbsp;<span class="num" id="8410737">1</span>&nbsp;<span class="op" id="8410739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410743">t</span><span class="op" id="8410744">.</span><span class="ident" id="8410745">Errorf</span><span class="op" id="8410751">(</span><span class="string" id="8410752">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8410790">,</span>&nbsp;<span class="ident" id="8410792">n</span><span class="op" id="8410793">)</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8410796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410799">err</span>&nbsp;<span class="op" id="8410803">=</span>&nbsp;<span class="ident" id="8410805">db</span><span class="op" id="8410807">.</span><span class="ident" id="8410808">Close</span><span class="op" id="8410813">(</span><span class="op" id="8410814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410817">if</span>&nbsp;<span class="ident" id="8410820">err</span>&nbsp;<span class="op" id="8410824">!=</span>&nbsp;<span class="ident" id="8410827">nil</span>&nbsp;<span class="op" id="8410831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410835">t</span><span class="op" id="8410836">.</span><span class="ident" id="8410837">Errorf</span><span class="op" id="8410843">(</span><span class="string" id="8410844">&#34;db&nbsp;Close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8410859">,</span>&nbsp;<span class="ident" id="8410861">err</span><span class="op" id="8410864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8410867">}</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410870">if</span>&nbsp;<span class="op" id="8410873">!</span><span class="ident" id="8410874">dc</span><span class="op" id="8410876">.</span><span class="ident" id="8410877">closed</span>&nbsp;<span class="op" id="8410884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410888">t</span><span class="op" id="8410889">.</span><span class="ident" id="8410890">Errorf</span><span class="op" id="8410896">(</span><span class="string" id="8410897">&#34;after&nbsp;db.Close,&nbsp;driverConn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="8410942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8410945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410948">if</span>&nbsp;<span class="ident" id="8410951">n</span>&nbsp;<span class="op" id="8410953">:=</span>&nbsp;<span class="builtinfunc" id="8410956">len</span><span class="op" id="8410959">(</span><span class="ident" id="8410960">dc</span><span class="op" id="8410962">.</span><span class="ident" id="8410963">openStmt</span><span class="op" id="8410971">)</span><span class="op" id="8410972">;</span>&nbsp;<span class="ident" id="8410974">n</span>&nbsp;<span class="op" id="8410976">!=</span>&nbsp;<span class="num" id="8410979">0</span>&nbsp;<span class="op" id="8410981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410985">t</span><span class="op" id="8410986">.</span><span class="ident" id="8410987">Errorf</span><span class="op" id="8410993">(</span><span class="string" id="8410994">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8411032">,</span>&nbsp;<span class="ident" id="8411034">n</span><span class="op" id="8411035">)</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8411038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411042">err</span>&nbsp;<span class="op" id="8411046">=</span>&nbsp;<span class="ident" id="8411048">stmt</span><span class="op" id="8411052">.</span><span class="ident" id="8411053">Close</span><span class="op" id="8411058">(</span><span class="op" id="8411059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411062">if</span>&nbsp;<span class="ident" id="8411065">err</span>&nbsp;<span class="op" id="8411069">!=</span>&nbsp;<span class="ident" id="8411072">nil</span>&nbsp;<span class="op" id="8411076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411080">t</span><span class="op" id="8411081">.</span><span class="ident" id="8411082">Errorf</span><span class="op" id="8411088">(</span><span class="string" id="8411089">&#34;Stmt&nbsp;close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8411106">,</span>&nbsp;<span class="ident" id="8411108">err</span><span class="op" id="8411111">)</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8411114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411118">if</span>&nbsp;<span class="op" id="8411121">!</span><span class="ident" id="8411122">dc</span><span class="op" id="8411124">.</span><span class="ident" id="8411125">closed</span>&nbsp;<span class="op" id="8411132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411136">t</span><span class="op" id="8411137">.</span><span class="ident" id="8411138">Errorf</span><span class="op" id="8411144">(</span><span class="string" id="8411145">&#34;conn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="8411168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8411171">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411174">if</span>&nbsp;<span class="ident" id="8411177">dc</span><span class="op" id="8411179">.</span><span class="ident" id="8411180">ci</span>&nbsp;<span class="op" id="8411183">!=</span>&nbsp;<span class="ident" id="8411186">nil</span>&nbsp;<span class="op" id="8411190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411194">t</span><span class="op" id="8411195">.</span><span class="ident" id="8411196">Errorf</span><span class="op" id="8411202">(</span><span class="string" id="8411203">&#34;after&nbsp;Stmt&nbsp;Close,&nbsp;driverConn&#39;s&nbsp;Conn&nbsp;interface&nbsp;should&nbsp;be&nbsp;nil&#34;</span><span class="op" id="8411264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8411267">}</span><br>
<span class="lineno"></span><span class="op" id="8411269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1255</span><span class="comment" id="8411272">//&nbsp;golang.org/issue/5283:&nbsp;don&#39;t&nbsp;release&nbsp;the&nbsp;Rows&#39;&nbsp;connection&nbsp;in&nbsp;Close</span><br>
<span class="lineno"></span><span class="comment" id="8411342">//&nbsp;before&nbsp;calling&nbsp;Stmt.Close.</span><br>
<span class="lineno"></span><span class="keyword" id="8411372">func</span>&nbsp;<span class="ident" id="8411377">TestRowsCloseOrder</span><span class="op" id="8411395">(</span><span class="ident" id="8411396">t</span>&nbsp;<span class="op" id="8411398">*</span><span class="ident" id="8411399">testing</span><span class="op" id="8411406">.</span><span class="ident" id="8411407">T</span><span class="op" id="8411408">)</span>&nbsp;<span class="op" id="8411410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411413">db</span>&nbsp;<span class="op" id="8411416">:=</span>&nbsp;<span class="ident" id="8411419">newTestDB</span><span class="op" id="8411428">(</span><span class="ident" id="8411429">t</span><span class="op" id="8411430">,</span>&nbsp;<span class="string" id="8411432">&#34;people&#34;</span><span class="op" id="8411440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411443">defer</span>&nbsp;<span class="ident" id="8411449">closeDB</span><span class="op" id="8411456">(</span><span class="ident" id="8411457">t</span><span class="op" id="8411458">,</span>&nbsp;<span class="ident" id="8411460">db</span><span class="op" id="8411462">)</span><br>
<span class="lineno">1260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411466">db</span><span class="op" id="8411468">.</span><span class="ident" id="8411469">SetMaxIdleConns</span><span class="op" id="8411484">(</span><span class="num" id="8411485">0</span><span class="op" id="8411486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411489">setStrictFakeConnClose</span><span class="op" id="8411511">(</span><span class="ident" id="8411512">t</span><span class="op" id="8411513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411516">defer</span>&nbsp;<span class="ident" id="8411522">setStrictFakeConnClose</span><span class="op" id="8411544">(</span><span class="ident" id="8411545">nil</span><span class="op" id="8411548">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411552">rows</span><span class="op" id="8411556">,</span>&nbsp;<span class="ident" id="8411558">err</span>&nbsp;<span class="op" id="8411562">:=</span>&nbsp;<span class="ident" id="8411565">db</span><span class="op" id="8411567">.</span><span class="ident" id="8411568">Query</span><span class="op" id="8411573">(</span><span class="string" id="8411574">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8411599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411602">if</span>&nbsp;<span class="ident" id="8411605">err</span>&nbsp;<span class="op" id="8411609">!=</span>&nbsp;<span class="ident" id="8411612">nil</span>&nbsp;<span class="op" id="8411616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411620">t</span><span class="op" id="8411621">.</span><span class="ident" id="8411622">Fatal</span><span class="op" id="8411627">(</span><span class="ident" id="8411628">err</span><span class="op" id="8411631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8411634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411637">err</span>&nbsp;<span class="op" id="8411641">=</span>&nbsp;<span class="ident" id="8411643">rows</span><span class="op" id="8411647">.</span><span class="ident" id="8411648">Close</span><span class="op" id="8411653">(</span><span class="op" id="8411654">)</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411657">if</span>&nbsp;<span class="ident" id="8411660">err</span>&nbsp;<span class="op" id="8411664">!=</span>&nbsp;<span class="ident" id="8411667">nil</span>&nbsp;<span class="op" id="8411671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411675">t</span><span class="op" id="8411676">.</span><span class="ident" id="8411677">Fatal</span><span class="op" id="8411682">(</span><span class="ident" id="8411683">err</span><span class="op" id="8411686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8411689">}</span><br>
<span class="lineno"></span><span class="op" id="8411691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1275</span><span class="keyword" id="8411694">func</span>&nbsp;<span class="ident" id="8411699">TestRowsImplicitClose</span><span class="op" id="8411720">(</span><span class="ident" id="8411721">t</span>&nbsp;<span class="op" id="8411723">*</span><span class="ident" id="8411724">testing</span><span class="op" id="8411731">.</span><span class="ident" id="8411732">T</span><span class="op" id="8411733">)</span>&nbsp;<span class="op" id="8411735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411738">db</span>&nbsp;<span class="op" id="8411741">:=</span>&nbsp;<span class="ident" id="8411744">newTestDB</span><span class="op" id="8411753">(</span><span class="ident" id="8411754">t</span><span class="op" id="8411755">,</span>&nbsp;<span class="string" id="8411757">&#34;people&#34;</span><span class="op" id="8411765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411768">defer</span>&nbsp;<span class="ident" id="8411774">closeDB</span><span class="op" id="8411781">(</span><span class="ident" id="8411782">t</span><span class="op" id="8411783">,</span>&nbsp;<span class="ident" id="8411785">db</span><span class="op" id="8411787">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411791">rows</span><span class="op" id="8411795">,</span>&nbsp;<span class="ident" id="8411797">err</span>&nbsp;<span class="op" id="8411801">:=</span>&nbsp;<span class="ident" id="8411804">db</span><span class="op" id="8411806">.</span><span class="ident" id="8411807">Query</span><span class="op" id="8411812">(</span><span class="string" id="8411813">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8411838">)</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411841">if</span>&nbsp;<span class="ident" id="8411844">err</span>&nbsp;<span class="op" id="8411848">!=</span>&nbsp;<span class="ident" id="8411851">nil</span>&nbsp;<span class="op" id="8411855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411859">t</span><span class="op" id="8411860">.</span><span class="ident" id="8411861">Fatal</span><span class="op" id="8411866">(</span><span class="ident" id="8411867">err</span><span class="op" id="8411870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8411873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411877">want</span><span class="op" id="8411881">,</span>&nbsp;<span class="ident" id="8411883">fail</span>&nbsp;<span class="op" id="8411888">:=</span>&nbsp;<span class="num" id="8411891">2</span><span class="op" id="8411892">,</span>&nbsp;<span class="ident" id="8411894">errors</span><span class="op" id="8411900">.</span><span class="ident" id="8411901">New</span><span class="op" id="8411904">(</span><span class="string" id="8411905">&#34;fail&#34;</span><span class="op" id="8411911">)</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411914">r</span>&nbsp;<span class="op" id="8411916">:=</span>&nbsp;<span class="ident" id="8411919">rows</span><span class="op" id="8411923">.</span><span class="ident" id="8411924">rowsi</span><span class="op" id="8411929">.</span><span class="op" id="8411930">(</span><span class="op" id="8411931">*</span><span class="ident" id="8411932">rowsCursor</span><span class="op" id="8411942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411945">r</span><span class="op" id="8411946">.</span><span class="ident" id="8411947">errPos</span><span class="op" id="8411953">,</span>&nbsp;<span class="ident" id="8411955">r</span><span class="op" id="8411956">.</span><span class="ident" id="8411957">err</span>&nbsp;<span class="op" id="8411961">=</span>&nbsp;<span class="ident" id="8411963">want</span><span class="op" id="8411967">,</span>&nbsp;<span class="ident" id="8411969">fail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411976">got</span>&nbsp;<span class="op" id="8411980">:=</span>&nbsp;<span class="num" id="8411983">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411986">for</span>&nbsp;<span class="ident" id="8411990">rows</span><span class="op" id="8411994">.</span><span class="ident" id="8411995">Next</span><span class="op" id="8411999">(</span><span class="op" id="8412000">)</span>&nbsp;<span class="op" id="8412002">{</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412006">got</span><span class="op" id="8412009">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8412013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8412016">if</span>&nbsp;<span class="ident" id="8412019">got</span>&nbsp;<span class="op" id="8412023">!=</span>&nbsp;<span class="ident" id="8412026">want</span>&nbsp;<span class="op" id="8412031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412035">t</span><span class="op" id="8412036">.</span><span class="ident" id="8412037">Errorf</span><span class="op" id="8412043">(</span><span class="string" id="8412044">&#34;got&nbsp;%d&nbsp;rows,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8412066">,</span>&nbsp;<span class="ident" id="8412068">got</span><span class="op" id="8412071">,</span>&nbsp;<span class="ident" id="8412073">want</span><span class="op" id="8412077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8412080">}</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8412083">if</span>&nbsp;<span class="ident" id="8412086">err</span>&nbsp;<span class="op" id="8412090">:=</span>&nbsp;<span class="ident" id="8412093">rows</span><span class="op" id="8412097">.</span><span class="ident" id="8412098">Err</span><span class="op" id="8412101">(</span><span class="op" id="8412102">)</span><span class="op" id="8412103">;</span>&nbsp;<span class="ident" id="8412105">err</span>&nbsp;<span class="op" id="8412109">!=</span>&nbsp;<span class="ident" id="8412112">fail</span>&nbsp;<span class="op" id="8412117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412121">t</span><span class="op" id="8412122">.</span><span class="ident" id="8412123">Errorf</span><span class="op" id="8412129">(</span><span class="string" id="8412130">&#34;got&nbsp;error&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8412153">,</span>&nbsp;<span class="ident" id="8412155">err</span><span class="op" id="8412158">,</span>&nbsp;<span class="ident" id="8412160">fail</span><span class="op" id="8412164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8412167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8412170">if</span>&nbsp;<span class="op" id="8412173">!</span><span class="ident" id="8412174">r</span><span class="op" id="8412175">.</span><span class="ident" id="8412176">closed</span>&nbsp;<span class="op" id="8412183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412187">t</span><span class="op" id="8412188">.</span><span class="ident" id="8412189">Errorf</span><span class="op" id="8412195">(</span><span class="string" id="8412196">&#34;r.closed&nbsp;is&nbsp;false,&nbsp;want&nbsp;true&#34;</span><span class="op" id="8412226">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8412229">}</span><br>
<span class="lineno"></span><span class="op" id="8412231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8412234">func</span>&nbsp;<span class="ident" id="8412239">TestStmtCloseOrder</span><span class="op" id="8412257">(</span><span class="ident" id="8412258">t</span>&nbsp;<span class="op" id="8412260">*</span><span class="ident" id="8412261">testing</span><span class="op" id="8412268">.</span><span class="ident" id="8412269">T</span><span class="op" id="8412270">)</span>&nbsp;<span class="op" id="8412272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412275">db</span>&nbsp;<span class="op" id="8412278">:=</span>&nbsp;<span class="ident" id="8412281">newTestDB</span><span class="op" id="8412290">(</span><span class="ident" id="8412291">t</span><span class="op" id="8412292">,</span>&nbsp;<span class="string" id="8412294">&#34;people&#34;</span><span class="op" id="8412302">)</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8412305">defer</span>&nbsp;<span class="ident" id="8412311">closeDB</span><span class="op" id="8412318">(</span><span class="ident" id="8412319">t</span><span class="op" id="8412320">,</span>&nbsp;<span class="ident" id="8412322">db</span><span class="op" id="8412324">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412328">db</span><span class="op" id="8412330">.</span><span class="ident" id="8412331">SetMaxIdleConns</span><span class="op" id="8412346">(</span><span class="num" id="8412347">0</span><span class="op" id="8412348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412351">setStrictFakeConnClose</span><span class="op" id="8412373">(</span><span class="ident" id="8412374">t</span><span class="op" id="8412375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8412378">defer</span>&nbsp;<span class="ident" id="8412384">setStrictFakeConnClose</span><span class="op" id="8412406">(</span><span class="ident" id="8412407">nil</span><span class="op" id="8412410">)</span><br>
<span class="lineno">1310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412414">_</span><span class="op" id="8412415">,</span>&nbsp;<span class="ident" id="8412417">err</span>&nbsp;<span class="op" id="8412421">:=</span>&nbsp;<span class="ident" id="8412424">db</span><span class="op" id="8412426">.</span><span class="ident" id="8412427">Query</span><span class="op" id="8412432">(</span><span class="string" id="8412433">&#34;SELECT|non_existent|name|&#34;</span><span class="op" id="8412460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8412463">if</span>&nbsp;<span class="ident" id="8412466">err</span>&nbsp;<span class="op" id="8412470">==</span>&nbsp;<span class="ident" id="8412473">nil</span>&nbsp;<span class="op" id="8412477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412481">t</span><span class="op" id="8412482">.</span><span class="ident" id="8412483">Fatal</span><span class="op" id="8412488">(</span><span class="string" id="8412489">&#34;Quering&nbsp;non-existent&nbsp;table&nbsp;should&nbsp;fail&#34;</span><span class="op" id="8412529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8412532">}</span><br>
<span class="lineno">1315</span><span class="op" id="8412534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8412537">//&nbsp;golang.org/issue/5781</span><br>
<span class="lineno"></span><span class="keyword" id="8412562">func</span>&nbsp;<span class="ident" id="8412567">TestErrBadConnReconnect</span><span class="op" id="8412590">(</span><span class="ident" id="8412591">t</span>&nbsp;<span class="op" id="8412593">*</span><span class="ident" id="8412594">testing</span><span class="op" id="8412601">.</span><span class="ident" id="8412602">T</span><span class="op" id="8412603">)</span>&nbsp;<span class="op" id="8412605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412608">db</span>&nbsp;<span class="op" id="8412611">:=</span>&nbsp;<span class="ident" id="8412614">newTestDB</span><span class="op" id="8412623">(</span><span class="ident" id="8412624">t</span><span class="op" id="8412625">,</span>&nbsp;<span class="string" id="8412627">&#34;foo&#34;</span><span class="op" id="8412632">)</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8412635">defer</span>&nbsp;<span class="ident" id="8412641">closeDB</span><span class="op" id="8412648">(</span><span class="ident" id="8412649">t</span><span class="op" id="8412650">,</span>&nbsp;<span class="ident" id="8412652">db</span><span class="op" id="8412654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412657">exec</span><span class="op" id="8412661">(</span><span class="ident" id="8412662">t</span><span class="op" id="8412663">,</span>&nbsp;<span class="ident" id="8412665">db</span><span class="op" id="8412667">,</span>&nbsp;<span class="string" id="8412669">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8412712">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412716">simulateBadConn</span>&nbsp;<span class="op" id="8412732">:=</span>&nbsp;<span class="keyword" id="8412735">func</span><span class="op" id="8412739">(</span><span class="ident" id="8412740">name</span>&nbsp;<span class="builtintype" id="8412745">string</span><span class="op" id="8412751">,</span>&nbsp;<span class="ident" id="8412753">hook</span>&nbsp;<span class="op" id="8412758">*</span><span class="keyword" id="8412759">func</span><span class="op" id="8412763">(</span><span class="op" id="8412764">)</span>&nbsp;<span class="builtintype" id="8412766">bool</span><span class="op" id="8412770">,</span>&nbsp;<span class="ident" id="8412772">op</span>&nbsp;<span class="keyword" id="8412775">func</span><span class="op" id="8412779">(</span><span class="op" id="8412780">)</span>&nbsp;<span class="builtintype" id="8412782">error</span><span class="op" id="8412787">)</span>&nbsp;<span class="op" id="8412789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412793">broken</span><span class="op" id="8412799">,</span>&nbsp;<span class="ident" id="8412801">retried</span>&nbsp;<span class="op" id="8412809">:=</span>&nbsp;<span class="builtintype" id="8412812">false</span><span class="op" id="8412817">,</span>&nbsp;<span class="builtintype" id="8412819">false</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412827">numOpen</span>&nbsp;<span class="op" id="8412835">:=</span>&nbsp;<span class="ident" id="8412838">db</span><span class="op" id="8412840">.</span><span class="ident" id="8412841">numOpen</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8412852">//&nbsp;simulate&nbsp;a&nbsp;broken&nbsp;connection&nbsp;on&nbsp;the&nbsp;first&nbsp;try</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8412903">*</span><span class="ident" id="8412904">hook</span>&nbsp;<span class="op" id="8412909">=</span>&nbsp;<span class="keyword" id="8412911">func</span><span class="op" id="8412915">(</span><span class="op" id="8412916">)</span>&nbsp;<span class="builtintype" id="8412918">bool</span>&nbsp;<span class="op" id="8412923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8412928">if</span>&nbsp;<span class="op" id="8412931">!</span><span class="ident" id="8412932">broken</span>&nbsp;<span class="op" id="8412939">{</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412945">broken</span>&nbsp;<span class="op" id="8412952">=</span>&nbsp;<span class="builtintype" id="8412954">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8412963">return</span>&nbsp;<span class="builtintype" id="8412970">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8412978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412983">retried</span>&nbsp;<span class="op" id="8412991">=</span>&nbsp;<span class="builtintype" id="8412993">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8413001">return</span>&nbsp;<span class="builtintype" id="8413008">false</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8413016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8413021">if</span>&nbsp;<span class="ident" id="8413024">err</span>&nbsp;<span class="op" id="8413028">:=</span>&nbsp;<span class="ident" id="8413031">op</span><span class="op" id="8413033">(</span><span class="op" id="8413034">)</span><span class="op" id="8413035">;</span>&nbsp;<span class="ident" id="8413037">err</span>&nbsp;<span class="op" id="8413041">!=</span>&nbsp;<span class="ident" id="8413044">nil</span>&nbsp;<span class="op" id="8413048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8413053">t</span><span class="op" id="8413054">.</span><span class="ident" id="8413055">Errorf</span><span class="op" id="8413061">(</span><span class="ident" id="8413062">name</span><span class="op" id="8413066">+</span><span class="string" id="8413067">&#34;:&nbsp;%v&#34;</span><span class="op" id="8413073">,</span>&nbsp;<span class="ident" id="8413075">err</span><span class="op" id="8413078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8413083">return</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8413092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8413097">if</span>&nbsp;<span class="op" id="8413100">!</span><span class="ident" id="8413101">broken</span>&nbsp;<span class="op" id="8413108">||</span>&nbsp;<span class="op" id="8413111">!</span><span class="ident" id="8413112">retried</span>&nbsp;<span class="op" id="8413120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8413125">t</span><span class="op" id="8413126">.</span><span class="ident" id="8413127">Error</span><span class="op" id="8413132">(</span><span class="ident" id="8413133">name</span>&nbsp;<span class="op" id="8413138">+</span>&nbsp;<span class="string" id="8413140">&#34;:&nbsp;Failed&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="8413180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8413184">}</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8413188">*</span><span class="ident" id="8413189">hook</span>&nbsp;<span class="op" id="8413194">=</span>&nbsp;<span class="ident" id="8413196">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8413203">if</span>&nbsp;<span class="ident" id="8413206">numOpen</span>&nbsp;<span class="op" id="8413214">!=</span>&nbsp;<span class="ident" id="8413217">db</span><span class="op" id="8413219">.</span><span class="ident" id="8413220">numOpen</span>&nbsp;<span class="op" id="8413228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8413233">t</span><span class="op" id="8413234">.</span><span class="ident" id="8413235">Errorf</span><span class="op" id="8413241">(</span><span class="ident" id="8413242">name</span><span class="op" id="8413246">+</span><span class="string" id="8413247">&#34;:&nbsp;leaked&nbsp;%d&nbsp;connection(s)!&#34;</span><span class="op" id="8413275">,</span>&nbsp;<span class="ident" id="8413277">db</span><span class="op" id="8413279">.</span><span class="ident" id="8413280">numOpen</span><span class="op" id="8413287">-</span><span class="ident" id="8413288">numOpen</span><span class="op" id="8413295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8413300">numOpen</span>&nbsp;<span class="op" id="8413308">=</span>&nbsp;<span class="ident" id="8413310">db</span><span class="op" id="8413312">.</span><span class="ident" id="8413313">numOpen</span><br>
<span class="lineno">1350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8413323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8413326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8413330">//&nbsp;db.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8413342">dbExec</span>&nbsp;<span class="op" id="8413349">:=</span>&nbsp;<span class="keyword" id="8413352">func</span><span class="op" id="8413356">(</span><span class="op" id="8413357">)</span>&nbsp;<span class="builtintype" id="8413359">error</span>&nbsp;<span class="op" id="8413365">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8413369">_</span><span class="op" id="8413370">,</span>&nbsp;<span class="ident" id="8413372">err</span>&nbsp;<span class="op" id="8413376">:=</span>&nbsp;<span class="ident" id="8413379">db</span><span class="op" id="8413381">.</span><span class="ident" id="8413382">Exec</span><span class="op" id="8413386">(</span><span class="string" id="8413387">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="8413418">,</span>&nbsp;<span class="string" id="8413420">&#34;Gordon&#34;</span><span class="op" id="8413428">,</span>&nbsp;<span class="num" id="8413430">3</span><span class="op" id="8413431">,</span>&nbsp;<span class="builtintype" id="8413433">true</span><span class="op" id="8413437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8413441">return</span>&nbsp;<span class="ident" id="8413448">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8413453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8413456">simulateBadConn</span><span class="op" id="8413471">(</span><span class="string" id="8413472">&#34;db.Exec&nbsp;prepare&#34;</span><span class="op" id="8413489">,</span>&nbsp;<span class="op" id="8413491">&amp;</span><span class="ident" id="8413492">hookPrepareBadConn</span><span class="op" id="8413510">,</span>&nbsp;<span class="ident" id="8413512">dbExec</span><span class="op" id="8413518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8413521">simulateBadConn</span><span class="op" id="8413536">(</span><span class="string" id="8413537">&#34;db.Exec&nbsp;exec&#34;</span><span class="op" id="8413551">,</span>&nbsp;<span class="op" id="8413553">&amp;</span><span class="ident" id="8413554">hookExecBadConn</span><span class="op" id="8413569">,</span>&nbsp;<span class="ident" id="8413571">dbExec</span><span class="op" id="8413577">)</span><br>
<span class="lineno">1360</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8413581">//&nbsp;db.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8413594">dbQuery</span>&nbsp;<span class="op" id="8413602">:=</span>&nbsp;<span class="keyword" id="8413605">func</span><span class="op" id="8413609">(</span><span class="op" id="8413610">)</span>&nbsp;<span class="builtintype" id="8413612">error</span>&nbsp;<span class="op" id="8413618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8413622">rows</span><span class="op" id="8413626">,</span>&nbsp;<span class="ident" id="8413628">err</span>&nbsp;<span class="op" id="8413632">:=</span>&nbsp;<span class="ident" id="8413635">db</span><span class="op" id="8413637">.</span><span class="ident" id="8413638">Query</span><span class="op" id="8413643">(</span><span class="string" id="8413644">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="8413665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8413669">if</span>&nbsp;<span class="ident" id="8413672">err</span>&nbsp;<span class="op" id="8413676">==</span>&nbsp;<span class="ident" id="8413679">nil</span>&nbsp;<span class="op" id="8413683">{</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8413688">err</span>&nbsp;<span class="op" id="8413692">=</span>&nbsp;<span class="ident" id="8413694">rows</span><span class="op" id="8413698">.</span><span class="ident" id="8413699">Close</span><span class="op" id="8413704">(</span><span class="op" id="8413705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8413709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8413713">return</span>&nbsp;<span class="ident" id="8413720">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8413725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8413728">simulateBadConn</span><span class="op" id="8413743">(</span><span class="string" id="8413744">&#34;db.Query&nbsp;prepare&#34;</span><span class="op" id="8413762">,</span>&nbsp;<span class="op" id="8413764">&amp;</span><span class="ident" id="8413765">hookPrepareBadConn</span><span class="op" id="8413783">,</span>&nbsp;<span class="ident" id="8413785">dbQuery</span><span class="op" id="8413792">)</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8413795">simulateBadConn</span><span class="op" id="8413810">(</span><span class="string" id="8413811">&#34;db.Query&nbsp;query&#34;</span><span class="op" id="8413827">,</span>&nbsp;<span class="op" id="8413829">&amp;</span><span class="ident" id="8413830">hookQueryBadConn</span><span class="op" id="8413846">,</span>&nbsp;<span class="ident" id="8413848">dbQuery</span><span class="op" id="8413855">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8413859">//&nbsp;db.Prepare</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8413874">simulateBadConn</span><span class="op" id="8413889">(</span><span class="string" id="8413890">&#34;db.Prepare&#34;</span><span class="op" id="8413902">,</span>&nbsp;<span class="op" id="8413904">&amp;</span><span class="ident" id="8413905">hookPrepareBadConn</span><span class="op" id="8413923">,</span>&nbsp;<span class="keyword" id="8413925">func</span><span class="op" id="8413929">(</span><span class="op" id="8413930">)</span>&nbsp;<span class="builtintype" id="8413932">error</span>&nbsp;<span class="op" id="8413938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8413942">stmt</span><span class="op" id="8413946">,</span>&nbsp;<span class="ident" id="8413948">err</span>&nbsp;<span class="op" id="8413952">:=</span>&nbsp;<span class="ident" id="8413955">db</span><span class="op" id="8413957">.</span><span class="ident" id="8413958">Prepare</span><span class="op" id="8413965">(</span><span class="string" id="8413966">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="8413997">)</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8414001">if</span>&nbsp;<span class="ident" id="8414004">err</span>&nbsp;<span class="op" id="8414008">!=</span>&nbsp;<span class="ident" id="8414011">nil</span>&nbsp;<span class="op" id="8414015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8414020">return</span>&nbsp;<span class="ident" id="8414027">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8414033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414037">stmt</span><span class="op" id="8414041">.</span><span class="ident" id="8414042">Close</span><span class="op" id="8414047">(</span><span class="op" id="8414048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8414052">return</span>&nbsp;<span class="ident" id="8414059">nil</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8414064">}</span><span class="op" id="8414065">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8414069">//&nbsp;Provide&nbsp;a&nbsp;way&nbsp;to&nbsp;force&nbsp;a&nbsp;re-prepare&nbsp;of&nbsp;a&nbsp;statement&nbsp;on&nbsp;next&nbsp;execution</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414142">forcePrepare</span>&nbsp;<span class="op" id="8414155">:=</span>&nbsp;<span class="keyword" id="8414158">func</span><span class="op" id="8414162">(</span><span class="ident" id="8414163">stmt</span>&nbsp;<span class="op" id="8414168">*</span><span class="ident" id="8414169">Stmt</span><span class="op" id="8414173">)</span>&nbsp;<span class="op" id="8414175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414179">stmt</span><span class="op" id="8414183">.</span><span class="ident" id="8414184">css</span>&nbsp;<span class="op" id="8414188">=</span>&nbsp;<span class="ident" id="8414190">nil</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8414195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8414199">//&nbsp;stmt.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414213">stmt1</span><span class="op" id="8414218">,</span>&nbsp;<span class="ident" id="8414220">err</span>&nbsp;<span class="op" id="8414224">:=</span>&nbsp;<span class="ident" id="8414227">db</span><span class="op" id="8414229">.</span><span class="ident" id="8414230">Prepare</span><span class="op" id="8414237">(</span><span class="string" id="8414238">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="8414269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8414272">if</span>&nbsp;<span class="ident" id="8414275">err</span>&nbsp;<span class="op" id="8414279">!=</span>&nbsp;<span class="ident" id="8414282">nil</span>&nbsp;<span class="op" id="8414286">{</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414290">t</span><span class="op" id="8414291">.</span><span class="ident" id="8414292">Fatalf</span><span class="op" id="8414298">(</span><span class="string" id="8414299">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="8414312">,</span>&nbsp;<span class="ident" id="8414314">err</span><span class="op" id="8414317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8414320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8414323">defer</span>&nbsp;<span class="ident" id="8414329">stmt1</span><span class="op" id="8414334">.</span><span class="ident" id="8414335">Close</span><span class="op" id="8414340">(</span><span class="op" id="8414341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8414344">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414389">forcePrepare</span><span class="op" id="8414401">(</span><span class="ident" id="8414402">stmt1</span><span class="op" id="8414407">)</span><br>
<span class="lineno">1395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414411">stmtExec</span>&nbsp;<span class="op" id="8414420">:=</span>&nbsp;<span class="keyword" id="8414423">func</span><span class="op" id="8414427">(</span><span class="op" id="8414428">)</span>&nbsp;<span class="builtintype" id="8414430">error</span>&nbsp;<span class="op" id="8414436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414440">_</span><span class="op" id="8414441">,</span>&nbsp;<span class="ident" id="8414443">err</span>&nbsp;<span class="op" id="8414447">:=</span>&nbsp;<span class="ident" id="8414450">stmt1</span><span class="op" id="8414455">.</span><span class="ident" id="8414456">Exec</span><span class="op" id="8414460">(</span><span class="string" id="8414461">&#34;Gopher&#34;</span><span class="op" id="8414469">,</span>&nbsp;<span class="num" id="8414471">3</span><span class="op" id="8414472">,</span>&nbsp;<span class="builtintype" id="8414474">false</span><span class="op" id="8414479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8414483">return</span>&nbsp;<span class="ident" id="8414490">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8414495">}</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414498">simulateBadConn</span><span class="op" id="8414513">(</span><span class="string" id="8414514">&#34;stmt.Exec&nbsp;prepare&#34;</span><span class="op" id="8414533">,</span>&nbsp;<span class="op" id="8414535">&amp;</span><span class="ident" id="8414536">hookPrepareBadConn</span><span class="op" id="8414554">,</span>&nbsp;<span class="ident" id="8414556">stmtExec</span><span class="op" id="8414564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414567">simulateBadConn</span><span class="op" id="8414582">(</span><span class="string" id="8414583">&#34;stmt.Exec&nbsp;exec&#34;</span><span class="op" id="8414599">,</span>&nbsp;<span class="op" id="8414601">&amp;</span><span class="ident" id="8414602">hookExecBadConn</span><span class="op" id="8414617">,</span>&nbsp;<span class="ident" id="8414619">stmtExec</span><span class="op" id="8414627">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8414631">//&nbsp;stmt.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414646">stmt2</span><span class="op" id="8414651">,</span>&nbsp;<span class="ident" id="8414653">err</span>&nbsp;<span class="op" id="8414657">:=</span>&nbsp;<span class="ident" id="8414660">db</span><span class="op" id="8414662">.</span><span class="ident" id="8414663">Prepare</span><span class="op" id="8414670">(</span><span class="string" id="8414671">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="8414692">)</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8414695">if</span>&nbsp;<span class="ident" id="8414698">err</span>&nbsp;<span class="op" id="8414702">!=</span>&nbsp;<span class="ident" id="8414705">nil</span>&nbsp;<span class="op" id="8414709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414713">t</span><span class="op" id="8414714">.</span><span class="ident" id="8414715">Fatalf</span><span class="op" id="8414721">(</span><span class="string" id="8414722">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="8414735">,</span>&nbsp;<span class="ident" id="8414737">err</span><span class="op" id="8414740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8414743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8414746">defer</span>&nbsp;<span class="ident" id="8414752">stmt2</span><span class="op" id="8414757">.</span><span class="ident" id="8414758">Close</span><span class="op" id="8414763">(</span><span class="op" id="8414764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8414767">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414812">forcePrepare</span><span class="op" id="8414824">(</span><span class="ident" id="8414825">stmt2</span><span class="op" id="8414830">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414834">stmtQuery</span>&nbsp;<span class="op" id="8414844">:=</span>&nbsp;<span class="keyword" id="8414847">func</span><span class="op" id="8414851">(</span><span class="op" id="8414852">)</span>&nbsp;<span class="builtintype" id="8414854">error</span>&nbsp;<span class="op" id="8414860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414864">rows</span><span class="op" id="8414868">,</span>&nbsp;<span class="ident" id="8414870">err</span>&nbsp;<span class="op" id="8414874">:=</span>&nbsp;<span class="ident" id="8414877">stmt2</span><span class="op" id="8414882">.</span><span class="ident" id="8414883">Query</span><span class="op" id="8414888">(</span><span class="op" id="8414889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8414893">if</span>&nbsp;<span class="ident" id="8414896">err</span>&nbsp;<span class="op" id="8414900">==</span>&nbsp;<span class="ident" id="8414903">nil</span>&nbsp;<span class="op" id="8414907">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414912">err</span>&nbsp;<span class="op" id="8414916">=</span>&nbsp;<span class="ident" id="8414918">rows</span><span class="op" id="8414922">.</span><span class="ident" id="8414923">Close</span><span class="op" id="8414928">(</span><span class="op" id="8414929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8414933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8414937">return</span>&nbsp;<span class="ident" id="8414944">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8414949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8414952">simulateBadConn</span><span class="op" id="8414967">(</span><span class="string" id="8414968">&#34;stmt.Query&nbsp;prepare&#34;</span><span class="op" id="8414988">,</span>&nbsp;<span class="op" id="8414990">&amp;</span><span class="ident" id="8414991">hookPrepareBadConn</span><span class="op" id="8415009">,</span>&nbsp;<span class="ident" id="8415011">stmtQuery</span><span class="op" id="8415020">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415023">simulateBadConn</span><span class="op" id="8415038">(</span><span class="string" id="8415039">&#34;stmt.Query&nbsp;exec&#34;</span><span class="op" id="8415056">,</span>&nbsp;<span class="op" id="8415058">&amp;</span><span class="ident" id="8415059">hookQueryBadConn</span><span class="op" id="8415075">,</span>&nbsp;<span class="ident" id="8415077">stmtQuery</span><span class="op" id="8415086">)</span><br>
<span class="lineno"></span><span class="op" id="8415088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8415091">type</span>&nbsp;<span class="ident" id="8415096">concurrentTest</span>&nbsp;<span class="keyword" id="8415111">interface</span>&nbsp;<span class="op" id="8415121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415124">init</span><span class="op" id="8415128">(</span><span class="ident" id="8415129">t</span>&nbsp;<span class="ident" id="8415131">testing</span><span class="op" id="8415138">.</span><span class="ident" id="8415139">TB</span><span class="op" id="8415141">,</span>&nbsp;<span class="ident" id="8415143">db</span>&nbsp;<span class="op" id="8415146">*</span><span class="ident" id="8415147">DB</span><span class="op" id="8415149">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415152">finish</span><span class="op" id="8415158">(</span><span class="ident" id="8415159">t</span>&nbsp;<span class="ident" id="8415161">testing</span><span class="op" id="8415168">.</span><span class="ident" id="8415169">TB</span><span class="op" id="8415171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415174">test</span><span class="op" id="8415178">(</span><span class="ident" id="8415179">t</span>&nbsp;<span class="ident" id="8415181">testing</span><span class="op" id="8415188">.</span><span class="ident" id="8415189">TB</span><span class="op" id="8415191">)</span>&nbsp;<span class="builtintype" id="8415193">error</span><br>
<span class="lineno"></span><span class="op" id="8415199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8415202">type</span>&nbsp;<span class="ident" id="8415207">concurrentDBQueryTest</span>&nbsp;<span class="keyword" id="8415229">struct</span>&nbsp;<span class="op" id="8415236">{</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415239">db</span>&nbsp;<span class="op" id="8415242">*</span><span class="ident" id="8415243">DB</span><br>
<span class="lineno"></span><span class="op" id="8415246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8415249">func</span>&nbsp;<span class="op" id="8415254">(</span><span class="ident" id="8415255">c</span>&nbsp;<span class="op" id="8415257">*</span><span class="ident" id="8415258">concurrentDBQueryTest</span><span class="op" id="8415279">)</span>&nbsp;<span class="ident" id="8415281">init</span><span class="op" id="8415285">(</span><span class="ident" id="8415286">t</span>&nbsp;<span class="ident" id="8415288">testing</span><span class="op" id="8415295">.</span><span class="ident" id="8415296">TB</span><span class="op" id="8415298">,</span>&nbsp;<span class="ident" id="8415300">db</span>&nbsp;<span class="op" id="8415303">*</span><span class="ident" id="8415304">DB</span><span class="op" id="8415306">)</span>&nbsp;<span class="op" id="8415308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415311">c</span><span class="op" id="8415312">.</span><span class="ident" id="8415313">db</span>&nbsp;<span class="op" id="8415316">=</span>&nbsp;<span class="ident" id="8415318">db</span><br>
<span class="lineno">1435</span><span class="op" id="8415321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8415324">func</span>&nbsp;<span class="op" id="8415329">(</span><span class="ident" id="8415330">c</span>&nbsp;<span class="op" id="8415332">*</span><span class="ident" id="8415333">concurrentDBQueryTest</span><span class="op" id="8415354">)</span>&nbsp;<span class="ident" id="8415356">finish</span><span class="op" id="8415362">(</span><span class="ident" id="8415363">t</span>&nbsp;<span class="ident" id="8415365">testing</span><span class="op" id="8415372">.</span><span class="ident" id="8415373">TB</span><span class="op" id="8415375">)</span>&nbsp;<span class="op" id="8415377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415380">c</span><span class="op" id="8415381">.</span><span class="ident" id="8415382">db</span>&nbsp;<span class="op" id="8415385">=</span>&nbsp;<span class="ident" id="8415387">nil</span><br>
<span class="lineno"></span><span class="op" id="8415391">}</span><br>
<span class="lineno">1440</span><br>
<span class="lineno"></span><span class="keyword" id="8415394">func</span>&nbsp;<span class="op" id="8415399">(</span><span class="ident" id="8415400">c</span>&nbsp;<span class="op" id="8415402">*</span><span class="ident" id="8415403">concurrentDBQueryTest</span><span class="op" id="8415424">)</span>&nbsp;<span class="ident" id="8415426">test</span><span class="op" id="8415430">(</span><span class="ident" id="8415431">t</span>&nbsp;<span class="ident" id="8415433">testing</span><span class="op" id="8415440">.</span><span class="ident" id="8415441">TB</span><span class="op" id="8415443">)</span>&nbsp;<span class="builtintype" id="8415445">error</span>&nbsp;<span class="op" id="8415451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415454">rows</span><span class="op" id="8415458">,</span>&nbsp;<span class="ident" id="8415460">err</span>&nbsp;<span class="op" id="8415464">:=</span>&nbsp;<span class="ident" id="8415467">c</span><span class="op" id="8415468">.</span><span class="ident" id="8415469">db</span><span class="op" id="8415471">.</span><span class="ident" id="8415472">Query</span><span class="op" id="8415477">(</span><span class="string" id="8415478">&#34;SELECT|people|name|&#34;</span><span class="op" id="8415499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8415502">if</span>&nbsp;<span class="ident" id="8415505">err</span>&nbsp;<span class="op" id="8415509">!=</span>&nbsp;<span class="ident" id="8415512">nil</span>&nbsp;<span class="op" id="8415516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415520">t</span><span class="op" id="8415521">.</span><span class="ident" id="8415522">Error</span><span class="op" id="8415527">(</span><span class="ident" id="8415528">err</span><span class="op" id="8415531">)</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8415535">return</span>&nbsp;<span class="ident" id="8415542">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8415547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8415550">var</span>&nbsp;<span class="ident" id="8415554">name</span>&nbsp;<span class="builtintype" id="8415559">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8415567">for</span>&nbsp;<span class="ident" id="8415571">rows</span><span class="op" id="8415575">.</span><span class="ident" id="8415576">Next</span><span class="op" id="8415580">(</span><span class="op" id="8415581">)</span>&nbsp;<span class="op" id="8415583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415587">rows</span><span class="op" id="8415591">.</span><span class="ident" id="8415592">Scan</span><span class="op" id="8415596">(</span><span class="op" id="8415597">&amp;</span><span class="ident" id="8415598">name</span><span class="op" id="8415602">)</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8415605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415608">rows</span><span class="op" id="8415612">.</span><span class="ident" id="8415613">Close</span><span class="op" id="8415618">(</span><span class="op" id="8415619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8415622">return</span>&nbsp;<span class="ident" id="8415629">nil</span><br>
<span class="lineno"></span><span class="op" id="8415633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1455</span><span class="keyword" id="8415636">type</span>&nbsp;<span class="ident" id="8415641">concurrentDBExecTest</span>&nbsp;<span class="keyword" id="8415662">struct</span>&nbsp;<span class="op" id="8415669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415672">db</span>&nbsp;<span class="op" id="8415675">*</span><span class="ident" id="8415676">DB</span><br>
<span class="lineno"></span><span class="op" id="8415679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8415682">func</span>&nbsp;<span class="op" id="8415687">(</span><span class="ident" id="8415688">c</span>&nbsp;<span class="op" id="8415690">*</span><span class="ident" id="8415691">concurrentDBExecTest</span><span class="op" id="8415711">)</span>&nbsp;<span class="ident" id="8415713">init</span><span class="op" id="8415717">(</span><span class="ident" id="8415718">t</span>&nbsp;<span class="ident" id="8415720">testing</span><span class="op" id="8415727">.</span><span class="ident" id="8415728">TB</span><span class="op" id="8415730">,</span>&nbsp;<span class="ident" id="8415732">db</span>&nbsp;<span class="op" id="8415735">*</span><span class="ident" id="8415736">DB</span><span class="op" id="8415738">)</span>&nbsp;<span class="op" id="8415740">{</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415743">c</span><span class="op" id="8415744">.</span><span class="ident" id="8415745">db</span>&nbsp;<span class="op" id="8415748">=</span>&nbsp;<span class="ident" id="8415750">db</span><br>
<span class="lineno"></span><span class="op" id="8415753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8415756">func</span>&nbsp;<span class="op" id="8415761">(</span><span class="ident" id="8415762">c</span>&nbsp;<span class="op" id="8415764">*</span><span class="ident" id="8415765">concurrentDBExecTest</span><span class="op" id="8415785">)</span>&nbsp;<span class="ident" id="8415787">finish</span><span class="op" id="8415793">(</span><span class="ident" id="8415794">t</span>&nbsp;<span class="ident" id="8415796">testing</span><span class="op" id="8415803">.</span><span class="ident" id="8415804">TB</span><span class="op" id="8415806">)</span>&nbsp;<span class="op" id="8415808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415811">c</span><span class="op" id="8415812">.</span><span class="ident" id="8415813">db</span>&nbsp;<span class="op" id="8415816">=</span>&nbsp;<span class="ident" id="8415818">nil</span><br>
<span class="lineno">1465</span><span class="op" id="8415822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8415825">func</span>&nbsp;<span class="op" id="8415830">(</span><span class="ident" id="8415831">c</span>&nbsp;<span class="op" id="8415833">*</span><span class="ident" id="8415834">concurrentDBExecTest</span><span class="op" id="8415854">)</span>&nbsp;<span class="ident" id="8415856">test</span><span class="op" id="8415860">(</span><span class="ident" id="8415861">t</span>&nbsp;<span class="ident" id="8415863">testing</span><span class="op" id="8415870">.</span><span class="ident" id="8415871">TB</span><span class="op" id="8415873">)</span>&nbsp;<span class="builtintype" id="8415875">error</span>&nbsp;<span class="op" id="8415881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415884">_</span><span class="op" id="8415885">,</span>&nbsp;<span class="ident" id="8415887">err</span>&nbsp;<span class="op" id="8415891">:=</span>&nbsp;<span class="ident" id="8415894">c</span><span class="op" id="8415895">.</span><span class="ident" id="8415896">db</span><span class="op" id="8415898">.</span><span class="ident" id="8415899">Exec</span><span class="op" id="8415903">(</span><span class="string" id="8415904">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8415957">,</span>&nbsp;<span class="num" id="8415959">3</span><span class="op" id="8415960">,</span>&nbsp;<span class="ident" id="8415962">chrisBirthday</span><span class="op" id="8415975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8415978">if</span>&nbsp;<span class="ident" id="8415981">err</span>&nbsp;<span class="op" id="8415985">!=</span>&nbsp;<span class="ident" id="8415988">nil</span>&nbsp;<span class="op" id="8415992">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8415996">t</span><span class="op" id="8415997">.</span><span class="ident" id="8415998">Error</span><span class="op" id="8416003">(</span><span class="ident" id="8416004">err</span><span class="op" id="8416007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416011">return</span>&nbsp;<span class="ident" id="8416018">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416026">return</span>&nbsp;<span class="ident" id="8416033">nil</span><br>
<span class="lineno"></span><span class="op" id="8416037">}</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span><span class="keyword" id="8416040">type</span>&nbsp;<span class="ident" id="8416045">concurrentStmtQueryTest</span>&nbsp;<span class="keyword" id="8416069">struct</span>&nbsp;<span class="op" id="8416076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416079">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8416084">*</span><span class="ident" id="8416085">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416089">stmt</span>&nbsp;<span class="op" id="8416094">*</span><span class="ident" id="8416095">Stmt</span><br>
<span class="lineno"></span><span class="op" id="8416100">}</span><br>
<span class="lineno">1480</span><br>
<span class="lineno"></span><span class="keyword" id="8416103">func</span>&nbsp;<span class="op" id="8416108">(</span><span class="ident" id="8416109">c</span>&nbsp;<span class="op" id="8416111">*</span><span class="ident" id="8416112">concurrentStmtQueryTest</span><span class="op" id="8416135">)</span>&nbsp;<span class="ident" id="8416137">init</span><span class="op" id="8416141">(</span><span class="ident" id="8416142">t</span>&nbsp;<span class="ident" id="8416144">testing</span><span class="op" id="8416151">.</span><span class="ident" id="8416152">TB</span><span class="op" id="8416154">,</span>&nbsp;<span class="ident" id="8416156">db</span>&nbsp;<span class="op" id="8416159">*</span><span class="ident" id="8416160">DB</span><span class="op" id="8416162">)</span>&nbsp;<span class="op" id="8416164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416167">c</span><span class="op" id="8416168">.</span><span class="ident" id="8416169">db</span>&nbsp;<span class="op" id="8416172">=</span>&nbsp;<span class="ident" id="8416174">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416178">var</span>&nbsp;<span class="ident" id="8416182">err</span>&nbsp;<span class="builtintype" id="8416186">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416193">c</span><span class="op" id="8416194">.</span><span class="ident" id="8416195">stmt</span><span class="op" id="8416199">,</span>&nbsp;<span class="ident" id="8416201">err</span>&nbsp;<span class="op" id="8416205">=</span>&nbsp;<span class="ident" id="8416207">db</span><span class="op" id="8416209">.</span><span class="ident" id="8416210">Prepare</span><span class="op" id="8416217">(</span><span class="string" id="8416218">&#34;SELECT|people|name|&#34;</span><span class="op" id="8416239">)</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416242">if</span>&nbsp;<span class="ident" id="8416245">err</span>&nbsp;<span class="op" id="8416249">!=</span>&nbsp;<span class="ident" id="8416252">nil</span>&nbsp;<span class="op" id="8416256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416260">t</span><span class="op" id="8416261">.</span><span class="ident" id="8416262">Fatal</span><span class="op" id="8416267">(</span><span class="ident" id="8416268">err</span><span class="op" id="8416271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416274">}</span><br>
<span class="lineno"></span><span class="op" id="8416276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1490</span><span class="keyword" id="8416279">func</span>&nbsp;<span class="op" id="8416284">(</span><span class="ident" id="8416285">c</span>&nbsp;<span class="op" id="8416287">*</span><span class="ident" id="8416288">concurrentStmtQueryTest</span><span class="op" id="8416311">)</span>&nbsp;<span class="ident" id="8416313">finish</span><span class="op" id="8416319">(</span><span class="ident" id="8416320">t</span>&nbsp;<span class="ident" id="8416322">testing</span><span class="op" id="8416329">.</span><span class="ident" id="8416330">TB</span><span class="op" id="8416332">)</span>&nbsp;<span class="op" id="8416334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416337">if</span>&nbsp;<span class="ident" id="8416340">c</span><span class="op" id="8416341">.</span><span class="ident" id="8416342">stmt</span>&nbsp;<span class="op" id="8416347">!=</span>&nbsp;<span class="ident" id="8416350">nil</span>&nbsp;<span class="op" id="8416354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416358">c</span><span class="op" id="8416359">.</span><span class="ident" id="8416360">stmt</span><span class="op" id="8416364">.</span><span class="ident" id="8416365">Close</span><span class="op" id="8416370">(</span><span class="op" id="8416371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416375">c</span><span class="op" id="8416376">.</span><span class="ident" id="8416377">stmt</span>&nbsp;<span class="op" id="8416382">=</span>&nbsp;<span class="ident" id="8416384">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416389">}</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416392">c</span><span class="op" id="8416393">.</span><span class="ident" id="8416394">db</span>&nbsp;<span class="op" id="8416397">=</span>&nbsp;<span class="ident" id="8416399">nil</span><br>
<span class="lineno"></span><span class="op" id="8416403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8416406">func</span>&nbsp;<span class="op" id="8416411">(</span><span class="ident" id="8416412">c</span>&nbsp;<span class="op" id="8416414">*</span><span class="ident" id="8416415">concurrentStmtQueryTest</span><span class="op" id="8416438">)</span>&nbsp;<span class="ident" id="8416440">test</span><span class="op" id="8416444">(</span><span class="ident" id="8416445">t</span>&nbsp;<span class="ident" id="8416447">testing</span><span class="op" id="8416454">.</span><span class="ident" id="8416455">TB</span><span class="op" id="8416457">)</span>&nbsp;<span class="builtintype" id="8416459">error</span>&nbsp;<span class="op" id="8416465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416468">rows</span><span class="op" id="8416472">,</span>&nbsp;<span class="ident" id="8416474">err</span>&nbsp;<span class="op" id="8416478">:=</span>&nbsp;<span class="ident" id="8416481">c</span><span class="op" id="8416482">.</span><span class="ident" id="8416483">stmt</span><span class="op" id="8416487">.</span><span class="ident" id="8416488">Query</span><span class="op" id="8416493">(</span><span class="op" id="8416494">)</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416497">if</span>&nbsp;<span class="ident" id="8416500">err</span>&nbsp;<span class="op" id="8416504">!=</span>&nbsp;<span class="ident" id="8416507">nil</span>&nbsp;<span class="op" id="8416511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416515">t</span><span class="op" id="8416516">.</span><span class="ident" id="8416517">Errorf</span><span class="op" id="8416523">(</span><span class="string" id="8416524">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8416545">,</span>&nbsp;<span class="ident" id="8416547">err</span><span class="op" id="8416550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416554">return</span>&nbsp;<span class="ident" id="8416561">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416570">var</span>&nbsp;<span class="ident" id="8416574">name</span>&nbsp;<span class="builtintype" id="8416579">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416587">for</span>&nbsp;<span class="ident" id="8416591">rows</span><span class="op" id="8416595">.</span><span class="ident" id="8416596">Next</span><span class="op" id="8416600">(</span><span class="op" id="8416601">)</span>&nbsp;<span class="op" id="8416603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416607">rows</span><span class="op" id="8416611">.</span><span class="ident" id="8416612">Scan</span><span class="op" id="8416616">(</span><span class="op" id="8416617">&amp;</span><span class="ident" id="8416618">name</span><span class="op" id="8416622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416628">rows</span><span class="op" id="8416632">.</span><span class="ident" id="8416633">Close</span><span class="op" id="8416638">(</span><span class="op" id="8416639">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416642">return</span>&nbsp;<span class="ident" id="8416649">nil</span><br>
<span class="lineno"></span><span class="op" id="8416653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8416656">type</span>&nbsp;<span class="ident" id="8416661">concurrentStmtExecTest</span>&nbsp;<span class="keyword" id="8416684">struct</span>&nbsp;<span class="op" id="8416691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416694">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8416699">*</span><span class="ident" id="8416700">DB</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416704">stmt</span>&nbsp;<span class="op" id="8416709">*</span><span class="ident" id="8416710">Stmt</span><br>
<span class="lineno"></span><span class="op" id="8416715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8416718">func</span>&nbsp;<span class="op" id="8416723">(</span><span class="ident" id="8416724">c</span>&nbsp;<span class="op" id="8416726">*</span><span class="ident" id="8416727">concurrentStmtExecTest</span><span class="op" id="8416749">)</span>&nbsp;<span class="ident" id="8416751">init</span><span class="op" id="8416755">(</span><span class="ident" id="8416756">t</span>&nbsp;<span class="ident" id="8416758">testing</span><span class="op" id="8416765">.</span><span class="ident" id="8416766">TB</span><span class="op" id="8416768">,</span>&nbsp;<span class="ident" id="8416770">db</span>&nbsp;<span class="op" id="8416773">*</span><span class="ident" id="8416774">DB</span><span class="op" id="8416776">)</span>&nbsp;<span class="op" id="8416778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416781">c</span><span class="op" id="8416782">.</span><span class="ident" id="8416783">db</span>&nbsp;<span class="op" id="8416786">=</span>&nbsp;<span class="ident" id="8416788">db</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416792">var</span>&nbsp;<span class="ident" id="8416796">err</span>&nbsp;<span class="builtintype" id="8416800">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416807">c</span><span class="op" id="8416808">.</span><span class="ident" id="8416809">stmt</span><span class="op" id="8416813">,</span>&nbsp;<span class="ident" id="8416815">err</span>&nbsp;<span class="op" id="8416819">=</span>&nbsp;<span class="ident" id="8416821">db</span><span class="op" id="8416823">.</span><span class="ident" id="8416824">Prepare</span><span class="op" id="8416831">(</span><span class="string" id="8416832">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8416885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416888">if</span>&nbsp;<span class="ident" id="8416891">err</span>&nbsp;<span class="op" id="8416895">!=</span>&nbsp;<span class="ident" id="8416898">nil</span>&nbsp;<span class="op" id="8416902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8416906">t</span><span class="op" id="8416907">.</span><span class="ident" id="8416908">Fatal</span><span class="op" id="8416913">(</span><span class="ident" id="8416914">err</span><span class="op" id="8416917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8416920">}</span><br>
<span class="lineno">1525</span><span class="op" id="8416922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8416925">func</span>&nbsp;<span class="op" id="8416930">(</span><span class="ident" id="8416931">c</span>&nbsp;<span class="op" id="8416933">*</span><span class="ident" id="8416934">concurrentStmtExecTest</span><span class="op" id="8416956">)</span>&nbsp;<span class="ident" id="8416958">finish</span><span class="op" id="8416964">(</span><span class="ident" id="8416965">t</span>&nbsp;<span class="ident" id="8416967">testing</span><span class="op" id="8416974">.</span><span class="ident" id="8416975">TB</span><span class="op" id="8416977">)</span>&nbsp;<span class="op" id="8416979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8416982">if</span>&nbsp;<span class="ident" id="8416985">c</span><span class="op" id="8416986">.</span><span class="ident" id="8416987">stmt</span>&nbsp;<span class="op" id="8416992">!=</span>&nbsp;<span class="ident" id="8416995">nil</span>&nbsp;<span class="op" id="8416999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417003">c</span><span class="op" id="8417004">.</span><span class="ident" id="8417005">stmt</span><span class="op" id="8417009">.</span><span class="ident" id="8417010">Close</span><span class="op" id="8417015">(</span><span class="op" id="8417016">)</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417020">c</span><span class="op" id="8417021">.</span><span class="ident" id="8417022">stmt</span>&nbsp;<span class="op" id="8417027">=</span>&nbsp;<span class="ident" id="8417029">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417037">c</span><span class="op" id="8417038">.</span><span class="ident" id="8417039">db</span>&nbsp;<span class="op" id="8417042">=</span>&nbsp;<span class="ident" id="8417044">nil</span><br>
<span class="lineno"></span><span class="op" id="8417048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1535</span><span class="keyword" id="8417051">func</span>&nbsp;<span class="op" id="8417056">(</span><span class="ident" id="8417057">c</span>&nbsp;<span class="op" id="8417059">*</span><span class="ident" id="8417060">concurrentStmtExecTest</span><span class="op" id="8417082">)</span>&nbsp;<span class="ident" id="8417084">test</span><span class="op" id="8417088">(</span><span class="ident" id="8417089">t</span>&nbsp;<span class="ident" id="8417091">testing</span><span class="op" id="8417098">.</span><span class="ident" id="8417099">TB</span><span class="op" id="8417101">)</span>&nbsp;<span class="builtintype" id="8417103">error</span>&nbsp;<span class="op" id="8417109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417112">_</span><span class="op" id="8417113">,</span>&nbsp;<span class="ident" id="8417115">err</span>&nbsp;<span class="op" id="8417119">:=</span>&nbsp;<span class="ident" id="8417122">c</span><span class="op" id="8417123">.</span><span class="ident" id="8417124">stmt</span><span class="op" id="8417128">.</span><span class="ident" id="8417129">Exec</span><span class="op" id="8417133">(</span><span class="num" id="8417134">3</span><span class="op" id="8417135">,</span>&nbsp;<span class="ident" id="8417137">chrisBirthday</span><span class="op" id="8417150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417153">if</span>&nbsp;<span class="ident" id="8417156">err</span>&nbsp;<span class="op" id="8417160">!=</span>&nbsp;<span class="ident" id="8417163">nil</span>&nbsp;<span class="op" id="8417167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417171">t</span><span class="op" id="8417172">.</span><span class="ident" id="8417173">Errorf</span><span class="op" id="8417179">(</span><span class="string" id="8417180">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8417200">,</span>&nbsp;<span class="ident" id="8417202">err</span><span class="op" id="8417205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417209">return</span>&nbsp;<span class="ident" id="8417216">err</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417224">return</span>&nbsp;<span class="ident" id="8417231">nil</span><br>
<span class="lineno"></span><span class="op" id="8417235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8417238">type</span>&nbsp;<span class="ident" id="8417243">concurrentTxQueryTest</span>&nbsp;<span class="keyword" id="8417265">struct</span>&nbsp;<span class="op" id="8417272">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417275">db</span>&nbsp;<span class="op" id="8417278">*</span><span class="ident" id="8417279">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417283">tx</span>&nbsp;<span class="op" id="8417286">*</span><span class="ident" id="8417287">Tx</span><br>
<span class="lineno"></span><span class="op" id="8417290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8417293">func</span>&nbsp;<span class="op" id="8417298">(</span><span class="ident" id="8417299">c</span>&nbsp;<span class="op" id="8417301">*</span><span class="ident" id="8417302">concurrentTxQueryTest</span><span class="op" id="8417323">)</span>&nbsp;<span class="ident" id="8417325">init</span><span class="op" id="8417329">(</span><span class="ident" id="8417330">t</span>&nbsp;<span class="ident" id="8417332">testing</span><span class="op" id="8417339">.</span><span class="ident" id="8417340">TB</span><span class="op" id="8417342">,</span>&nbsp;<span class="ident" id="8417344">db</span>&nbsp;<span class="op" id="8417347">*</span><span class="ident" id="8417348">DB</span><span class="op" id="8417350">)</span>&nbsp;<span class="op" id="8417352">{</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417355">c</span><span class="op" id="8417356">.</span><span class="ident" id="8417357">db</span>&nbsp;<span class="op" id="8417360">=</span>&nbsp;<span class="ident" id="8417362">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417366">var</span>&nbsp;<span class="ident" id="8417370">err</span>&nbsp;<span class="builtintype" id="8417374">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417381">c</span><span class="op" id="8417382">.</span><span class="ident" id="8417383">tx</span><span class="op" id="8417385">,</span>&nbsp;<span class="ident" id="8417387">err</span>&nbsp;<span class="op" id="8417391">=</span>&nbsp;<span class="ident" id="8417393">c</span><span class="op" id="8417394">.</span><span class="ident" id="8417395">db</span><span class="op" id="8417397">.</span><span class="ident" id="8417398">Begin</span><span class="op" id="8417403">(</span><span class="op" id="8417404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417407">if</span>&nbsp;<span class="ident" id="8417410">err</span>&nbsp;<span class="op" id="8417414">!=</span>&nbsp;<span class="ident" id="8417417">nil</span>&nbsp;<span class="op" id="8417421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417425">t</span><span class="op" id="8417426">.</span><span class="ident" id="8417427">Fatal</span><span class="op" id="8417432">(</span><span class="ident" id="8417433">err</span><span class="op" id="8417436">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417439">}</span><br>
<span class="lineno"></span><span class="op" id="8417441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8417444">func</span>&nbsp;<span class="op" id="8417449">(</span><span class="ident" id="8417450">c</span>&nbsp;<span class="op" id="8417452">*</span><span class="ident" id="8417453">concurrentTxQueryTest</span><span class="op" id="8417474">)</span>&nbsp;<span class="ident" id="8417476">finish</span><span class="op" id="8417482">(</span><span class="ident" id="8417483">t</span>&nbsp;<span class="ident" id="8417485">testing</span><span class="op" id="8417492">.</span><span class="ident" id="8417493">TB</span><span class="op" id="8417495">)</span>&nbsp;<span class="op" id="8417497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417500">if</span>&nbsp;<span class="ident" id="8417503">c</span><span class="op" id="8417504">.</span><span class="ident" id="8417505">tx</span>&nbsp;<span class="op" id="8417508">!=</span>&nbsp;<span class="ident" id="8417511">nil</span>&nbsp;<span class="op" id="8417515">{</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417519">c</span><span class="op" id="8417520">.</span><span class="ident" id="8417521">tx</span><span class="op" id="8417523">.</span><span class="ident" id="8417524">Rollback</span><span class="op" id="8417532">(</span><span class="op" id="8417533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417537">c</span><span class="op" id="8417538">.</span><span class="ident" id="8417539">tx</span>&nbsp;<span class="op" id="8417542">=</span>&nbsp;<span class="ident" id="8417544">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417552">c</span><span class="op" id="8417553">.</span><span class="ident" id="8417554">db</span>&nbsp;<span class="op" id="8417557">=</span>&nbsp;<span class="ident" id="8417559">nil</span><br>
<span class="lineno"></span><span class="op" id="8417563">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span><span class="keyword" id="8417566">func</span>&nbsp;<span class="op" id="8417571">(</span><span class="ident" id="8417572">c</span>&nbsp;<span class="op" id="8417574">*</span><span class="ident" id="8417575">concurrentTxQueryTest</span><span class="op" id="8417596">)</span>&nbsp;<span class="ident" id="8417598">test</span><span class="op" id="8417602">(</span><span class="ident" id="8417603">t</span>&nbsp;<span class="ident" id="8417605">testing</span><span class="op" id="8417612">.</span><span class="ident" id="8417613">TB</span><span class="op" id="8417615">)</span>&nbsp;<span class="builtintype" id="8417617">error</span>&nbsp;<span class="op" id="8417623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417626">rows</span><span class="op" id="8417630">,</span>&nbsp;<span class="ident" id="8417632">err</span>&nbsp;<span class="op" id="8417636">:=</span>&nbsp;<span class="ident" id="8417639">c</span><span class="op" id="8417640">.</span><span class="ident" id="8417641">db</span><span class="op" id="8417643">.</span><span class="ident" id="8417644">Query</span><span class="op" id="8417649">(</span><span class="string" id="8417650">&#34;SELECT|people|name|&#34;</span><span class="op" id="8417671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417674">if</span>&nbsp;<span class="ident" id="8417677">err</span>&nbsp;<span class="op" id="8417681">!=</span>&nbsp;<span class="ident" id="8417684">nil</span>&nbsp;<span class="op" id="8417688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417692">t</span><span class="op" id="8417693">.</span><span class="ident" id="8417694">Error</span><span class="op" id="8417699">(</span><span class="ident" id="8417700">err</span><span class="op" id="8417703">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417707">return</span>&nbsp;<span class="ident" id="8417714">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417722">var</span>&nbsp;<span class="ident" id="8417726">name</span>&nbsp;<span class="builtintype" id="8417731">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417739">for</span>&nbsp;<span class="ident" id="8417743">rows</span><span class="op" id="8417747">.</span><span class="ident" id="8417748">Next</span><span class="op" id="8417752">(</span><span class="op" id="8417753">)</span>&nbsp;<span class="op" id="8417755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417759">rows</span><span class="op" id="8417763">.</span><span class="ident" id="8417764">Scan</span><span class="op" id="8417768">(</span><span class="op" id="8417769">&amp;</span><span class="ident" id="8417770">name</span><span class="op" id="8417774">)</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8417777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417780">rows</span><span class="op" id="8417784">.</span><span class="ident" id="8417785">Close</span><span class="op" id="8417790">(</span><span class="op" id="8417791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417794">return</span>&nbsp;<span class="ident" id="8417801">nil</span><br>
<span class="lineno"></span><span class="op" id="8417805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1580</span><span class="keyword" id="8417808">type</span>&nbsp;<span class="ident" id="8417813">concurrentTxExecTest</span>&nbsp;<span class="keyword" id="8417834">struct</span>&nbsp;<span class="op" id="8417841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417844">db</span>&nbsp;<span class="op" id="8417847">*</span><span class="ident" id="8417848">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417852">tx</span>&nbsp;<span class="op" id="8417855">*</span><span class="ident" id="8417856">Tx</span><br>
<span class="lineno"></span><span class="op" id="8417859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1585</span><span class="keyword" id="8417862">func</span>&nbsp;<span class="op" id="8417867">(</span><span class="ident" id="8417868">c</span>&nbsp;<span class="op" id="8417870">*</span><span class="ident" id="8417871">concurrentTxExecTest</span><span class="op" id="8417891">)</span>&nbsp;<span class="ident" id="8417893">init</span><span class="op" id="8417897">(</span><span class="ident" id="8417898">t</span>&nbsp;<span class="ident" id="8417900">testing</span><span class="op" id="8417907">.</span><span class="ident" id="8417908">TB</span><span class="op" id="8417910">,</span>&nbsp;<span class="ident" id="8417912">db</span>&nbsp;<span class="op" id="8417915">*</span><span class="ident" id="8417916">DB</span><span class="op" id="8417918">)</span>&nbsp;<span class="op" id="8417920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417923">c</span><span class="op" id="8417924">.</span><span class="ident" id="8417925">db</span>&nbsp;<span class="op" id="8417928">=</span>&nbsp;<span class="ident" id="8417930">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417934">var</span>&nbsp;<span class="ident" id="8417938">err</span>&nbsp;<span class="builtintype" id="8417942">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417949">c</span><span class="op" id="8417950">.</span><span class="ident" id="8417951">tx</span><span class="op" id="8417953">,</span>&nbsp;<span class="ident" id="8417955">err</span>&nbsp;<span class="op" id="8417959">=</span>&nbsp;<span class="ident" id="8417961">c</span><span class="op" id="8417962">.</span><span class="ident" id="8417963">db</span><span class="op" id="8417965">.</span><span class="ident" id="8417966">Begin</span><span class="op" id="8417971">(</span><span class="op" id="8417972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8417975">if</span>&nbsp;<span class="ident" id="8417978">err</span>&nbsp;<span class="op" id="8417982">!=</span>&nbsp;<span class="ident" id="8417985">nil</span>&nbsp;<span class="op" id="8417989">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8417993">t</span><span class="op" id="8417994">.</span><span class="ident" id="8417995">Fatal</span><span class="op" id="8418000">(</span><span class="ident" id="8418001">err</span><span class="op" id="8418004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8418007">}</span><br>
<span class="lineno"></span><span class="op" id="8418009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8418012">func</span>&nbsp;<span class="op" id="8418017">(</span><span class="ident" id="8418018">c</span>&nbsp;<span class="op" id="8418020">*</span><span class="ident" id="8418021">concurrentTxExecTest</span><span class="op" id="8418041">)</span>&nbsp;<span class="ident" id="8418043">finish</span><span class="op" id="8418049">(</span><span class="ident" id="8418050">t</span>&nbsp;<span class="ident" id="8418052">testing</span><span class="op" id="8418059">.</span><span class="ident" id="8418060">TB</span><span class="op" id="8418062">)</span>&nbsp;<span class="op" id="8418064">{</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8418067">if</span>&nbsp;<span class="ident" id="8418070">c</span><span class="op" id="8418071">.</span><span class="ident" id="8418072">tx</span>&nbsp;<span class="op" id="8418075">!=</span>&nbsp;<span class="ident" id="8418078">nil</span>&nbsp;<span class="op" id="8418082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418086">c</span><span class="op" id="8418087">.</span><span class="ident" id="8418088">tx</span><span class="op" id="8418090">.</span><span class="ident" id="8418091">Rollback</span><span class="op" id="8418099">(</span><span class="op" id="8418100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418104">c</span><span class="op" id="8418105">.</span><span class="ident" id="8418106">tx</span>&nbsp;<span class="op" id="8418109">=</span>&nbsp;<span class="ident" id="8418111">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8418116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418119">c</span><span class="op" id="8418120">.</span><span class="ident" id="8418121">db</span>&nbsp;<span class="op" id="8418124">=</span>&nbsp;<span class="ident" id="8418126">nil</span><br>
<span class="lineno">1600</span><span class="op" id="8418130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8418133">func</span>&nbsp;<span class="op" id="8418138">(</span><span class="ident" id="8418139">c</span>&nbsp;<span class="op" id="8418141">*</span><span class="ident" id="8418142">concurrentTxExecTest</span><span class="op" id="8418162">)</span>&nbsp;<span class="ident" id="8418164">test</span><span class="op" id="8418168">(</span><span class="ident" id="8418169">t</span>&nbsp;<span class="ident" id="8418171">testing</span><span class="op" id="8418178">.</span><span class="ident" id="8418179">TB</span><span class="op" id="8418181">)</span>&nbsp;<span class="builtintype" id="8418183">error</span>&nbsp;<span class="op" id="8418189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418192">_</span><span class="op" id="8418193">,</span>&nbsp;<span class="ident" id="8418195">err</span>&nbsp;<span class="op" id="8418199">:=</span>&nbsp;<span class="ident" id="8418202">c</span><span class="op" id="8418203">.</span><span class="ident" id="8418204">tx</span><span class="op" id="8418206">.</span><span class="ident" id="8418207">Exec</span><span class="op" id="8418211">(</span><span class="string" id="8418212">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8418265">,</span>&nbsp;<span class="num" id="8418267">3</span><span class="op" id="8418268">,</span>&nbsp;<span class="ident" id="8418270">chrisBirthday</span><span class="op" id="8418283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8418286">if</span>&nbsp;<span class="ident" id="8418289">err</span>&nbsp;<span class="op" id="8418293">!=</span>&nbsp;<span class="ident" id="8418296">nil</span>&nbsp;<span class="op" id="8418300">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418304">t</span><span class="op" id="8418305">.</span><span class="ident" id="8418306">Error</span><span class="op" id="8418311">(</span><span class="ident" id="8418312">err</span><span class="op" id="8418315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8418319">return</span>&nbsp;<span class="ident" id="8418326">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8418331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8418334">return</span>&nbsp;<span class="ident" id="8418341">nil</span><br>
<span class="lineno"></span><span class="op" id="8418345">}</span><br>
<span class="lineno">1610</span><br>
<span class="lineno"></span><span class="keyword" id="8418348">type</span>&nbsp;<span class="ident" id="8418353">concurrentTxStmtQueryTest</span>&nbsp;<span class="keyword" id="8418379">struct</span>&nbsp;<span class="op" id="8418386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418389">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8418394">*</span><span class="ident" id="8418395">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418399">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8418404">*</span><span class="ident" id="8418405">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418409">stmt</span>&nbsp;<span class="op" id="8418414">*</span><span class="ident" id="8418415">Stmt</span><br>
<span class="lineno">1615</span><span class="op" id="8418420">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8418423">func</span>&nbsp;<span class="op" id="8418428">(</span><span class="ident" id="8418429">c</span>&nbsp;<span class="op" id="8418431">*</span><span class="ident" id="8418432">concurrentTxStmtQueryTest</span><span class="op" id="8418457">)</span>&nbsp;<span class="ident" id="8418459">init</span><span class="op" id="8418463">(</span><span class="ident" id="8418464">t</span>&nbsp;<span class="ident" id="8418466">testing</span><span class="op" id="8418473">.</span><span class="ident" id="8418474">TB</span><span class="op" id="8418476">,</span>&nbsp;<span class="ident" id="8418478">db</span>&nbsp;<span class="op" id="8418481">*</span><span class="ident" id="8418482">DB</span><span class="op" id="8418484">)</span>&nbsp;<span class="op" id="8418486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418489">c</span><span class="op" id="8418490">.</span><span class="ident" id="8418491">db</span>&nbsp;<span class="op" id="8418494">=</span>&nbsp;<span class="ident" id="8418496">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8418500">var</span>&nbsp;<span class="ident" id="8418504">err</span>&nbsp;<span class="builtintype" id="8418508">error</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418515">c</span><span class="op" id="8418516">.</span><span class="ident" id="8418517">tx</span><span class="op" id="8418519">,</span>&nbsp;<span class="ident" id="8418521">err</span>&nbsp;<span class="op" id="8418525">=</span>&nbsp;<span class="ident" id="8418527">c</span><span class="op" id="8418528">.</span><span class="ident" id="8418529">db</span><span class="op" id="8418531">.</span><span class="ident" id="8418532">Begin</span><span class="op" id="8418537">(</span><span class="op" id="8418538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8418541">if</span>&nbsp;<span class="ident" id="8418544">err</span>&nbsp;<span class="op" id="8418548">!=</span>&nbsp;<span class="ident" id="8418551">nil</span>&nbsp;<span class="op" id="8418555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418559">t</span><span class="op" id="8418560">.</span><span class="ident" id="8418561">Fatal</span><span class="op" id="8418566">(</span><span class="ident" id="8418567">err</span><span class="op" id="8418570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8418573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418576">c</span><span class="op" id="8418577">.</span><span class="ident" id="8418578">stmt</span><span class="op" id="8418582">,</span>&nbsp;<span class="ident" id="8418584">err</span>&nbsp;<span class="op" id="8418588">=</span>&nbsp;<span class="ident" id="8418590">c</span><span class="op" id="8418591">.</span><span class="ident" id="8418592">tx</span><span class="op" id="8418594">.</span><span class="ident" id="8418595">Prepare</span><span class="op" id="8418602">(</span><span class="string" id="8418603">&#34;SELECT|people|name|&#34;</span><span class="op" id="8418624">)</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8418627">if</span>&nbsp;<span class="ident" id="8418630">err</span>&nbsp;<span class="op" id="8418634">!=</span>&nbsp;<span class="ident" id="8418637">nil</span>&nbsp;<span class="op" id="8418641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418645">t</span><span class="op" id="8418646">.</span><span class="ident" id="8418647">Fatal</span><span class="op" id="8418652">(</span><span class="ident" id="8418653">err</span><span class="op" id="8418656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8418659">}</span><br>
<span class="lineno"></span><span class="op" id="8418661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1630</span><span class="keyword" id="8418664">func</span>&nbsp;<span class="op" id="8418669">(</span><span class="ident" id="8418670">c</span>&nbsp;<span class="op" id="8418672">*</span><span class="ident" id="8418673">concurrentTxStmtQueryTest</span><span class="op" id="8418698">)</span>&nbsp;<span class="ident" id="8418700">finish</span><span class="op" id="8418706">(</span><span class="ident" id="8418707">t</span>&nbsp;<span class="ident" id="8418709">testing</span><span class="op" id="8418716">.</span><span class="ident" id="8418717">TB</span><span class="op" id="8418719">)</span>&nbsp;<span class="op" id="8418721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8418724">if</span>&nbsp;<span class="ident" id="8418727">c</span><span class="op" id="8418728">.</span><span class="ident" id="8418729">stmt</span>&nbsp;<span class="op" id="8418734">!=</span>&nbsp;<span class="ident" id="8418737">nil</span>&nbsp;<span class="op" id="8418741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418745">c</span><span class="op" id="8418746">.</span><span class="ident" id="8418747">stmt</span><span class="op" id="8418751">.</span><span class="ident" id="8418752">Close</span><span class="op" id="8418757">(</span><span class="op" id="8418758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418762">c</span><span class="op" id="8418763">.</span><span class="ident" id="8418764">stmt</span>&nbsp;<span class="op" id="8418769">=</span>&nbsp;<span class="ident" id="8418771">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8418776">}</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8418779">if</span>&nbsp;<span class="ident" id="8418782">c</span><span class="op" id="8418783">.</span><span class="ident" id="8418784">tx</span>&nbsp;<span class="op" id="8418787">!=</span>&nbsp;<span class="ident" id="8418790">nil</span>&nbsp;<span class="op" id="8418794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418798">c</span><span class="op" id="8418799">.</span><span class="ident" id="8418800">tx</span><span class="op" id="8418802">.</span><span class="ident" id="8418803">Rollback</span><span class="op" id="8418811">(</span><span class="op" id="8418812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418816">c</span><span class="op" id="8418817">.</span><span class="ident" id="8418818">tx</span>&nbsp;<span class="op" id="8418821">=</span>&nbsp;<span class="ident" id="8418823">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8418828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418831">c</span><span class="op" id="8418832">.</span><span class="ident" id="8418833">db</span>&nbsp;<span class="op" id="8418836">=</span>&nbsp;<span class="ident" id="8418838">nil</span><br>
<span class="lineno">1640</span><span class="op" id="8418842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8418845">func</span>&nbsp;<span class="op" id="8418850">(</span><span class="ident" id="8418851">c</span>&nbsp;<span class="op" id="8418853">*</span><span class="ident" id="8418854">concurrentTxStmtQueryTest</span><span class="op" id="8418879">)</span>&nbsp;<span class="ident" id="8418881">test</span><span class="op" id="8418885">(</span><span class="ident" id="8418886">t</span>&nbsp;<span class="ident" id="8418888">testing</span><span class="op" id="8418895">.</span><span class="ident" id="8418896">TB</span><span class="op" id="8418898">)</span>&nbsp;<span class="builtintype" id="8418900">error</span>&nbsp;<span class="op" id="8418906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418909">rows</span><span class="op" id="8418913">,</span>&nbsp;<span class="ident" id="8418915">err</span>&nbsp;<span class="op" id="8418919">:=</span>&nbsp;<span class="ident" id="8418922">c</span><span class="op" id="8418923">.</span><span class="ident" id="8418924">stmt</span><span class="op" id="8418928">.</span><span class="ident" id="8418929">Query</span><span class="op" id="8418934">(</span><span class="op" id="8418935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8418938">if</span>&nbsp;<span class="ident" id="8418941">err</span>&nbsp;<span class="op" id="8418945">!=</span>&nbsp;<span class="ident" id="8418948">nil</span>&nbsp;<span class="op" id="8418952">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8418956">t</span><span class="op" id="8418957">.</span><span class="ident" id="8418958">Errorf</span><span class="op" id="8418964">(</span><span class="string" id="8418965">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8418986">,</span>&nbsp;<span class="ident" id="8418988">err</span><span class="op" id="8418991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8418995">return</span>&nbsp;<span class="ident" id="8419002">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8419007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8419011">var</span>&nbsp;<span class="ident" id="8419015">name</span>&nbsp;<span class="builtintype" id="8419020">string</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8419028">for</span>&nbsp;<span class="ident" id="8419032">rows</span><span class="op" id="8419036">.</span><span class="ident" id="8419037">Next</span><span class="op" id="8419041">(</span><span class="op" id="8419042">)</span>&nbsp;<span class="op" id="8419044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419048">rows</span><span class="op" id="8419052">.</span><span class="ident" id="8419053">Scan</span><span class="op" id="8419057">(</span><span class="op" id="8419058">&amp;</span><span class="ident" id="8419059">name</span><span class="op" id="8419063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8419066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419069">rows</span><span class="op" id="8419073">.</span><span class="ident" id="8419074">Close</span><span class="op" id="8419079">(</span><span class="op" id="8419080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8419083">return</span>&nbsp;<span class="ident" id="8419090">nil</span><br>
<span class="lineno">1655</span><span class="op" id="8419094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8419097">type</span>&nbsp;<span class="ident" id="8419102">concurrentTxStmtExecTest</span>&nbsp;<span class="keyword" id="8419127">struct</span>&nbsp;<span class="op" id="8419134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419137">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8419142">*</span><span class="ident" id="8419143">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419147">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8419152">*</span><span class="ident" id="8419153">Tx</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419157">stmt</span>&nbsp;<span class="op" id="8419162">*</span><span class="ident" id="8419163">Stmt</span><br>
<span class="lineno"></span><span class="op" id="8419168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8419171">func</span>&nbsp;<span class="op" id="8419176">(</span><span class="ident" id="8419177">c</span>&nbsp;<span class="op" id="8419179">*</span><span class="ident" id="8419180">concurrentTxStmtExecTest</span><span class="op" id="8419204">)</span>&nbsp;<span class="ident" id="8419206">init</span><span class="op" id="8419210">(</span><span class="ident" id="8419211">t</span>&nbsp;<span class="ident" id="8419213">testing</span><span class="op" id="8419220">.</span><span class="ident" id="8419221">TB</span><span class="op" id="8419223">,</span>&nbsp;<span class="ident" id="8419225">db</span>&nbsp;<span class="op" id="8419228">*</span><span class="ident" id="8419229">DB</span><span class="op" id="8419231">)</span>&nbsp;<span class="op" id="8419233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419236">c</span><span class="op" id="8419237">.</span><span class="ident" id="8419238">db</span>&nbsp;<span class="op" id="8419241">=</span>&nbsp;<span class="ident" id="8419243">db</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8419247">var</span>&nbsp;<span class="ident" id="8419251">err</span>&nbsp;<span class="builtintype" id="8419255">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419262">c</span><span class="op" id="8419263">.</span><span class="ident" id="8419264">tx</span><span class="op" id="8419266">,</span>&nbsp;<span class="ident" id="8419268">err</span>&nbsp;<span class="op" id="8419272">=</span>&nbsp;<span class="ident" id="8419274">c</span><span class="op" id="8419275">.</span><span class="ident" id="8419276">db</span><span class="op" id="8419278">.</span><span class="ident" id="8419279">Begin</span><span class="op" id="8419284">(</span><span class="op" id="8419285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8419288">if</span>&nbsp;<span class="ident" id="8419291">err</span>&nbsp;<span class="op" id="8419295">!=</span>&nbsp;<span class="ident" id="8419298">nil</span>&nbsp;<span class="op" id="8419302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419306">t</span><span class="op" id="8419307">.</span><span class="ident" id="8419308">Fatal</span><span class="op" id="8419313">(</span><span class="ident" id="8419314">err</span><span class="op" id="8419317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8419320">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419323">c</span><span class="op" id="8419324">.</span><span class="ident" id="8419325">stmt</span><span class="op" id="8419329">,</span>&nbsp;<span class="ident" id="8419331">err</span>&nbsp;<span class="op" id="8419335">=</span>&nbsp;<span class="ident" id="8419337">c</span><span class="op" id="8419338">.</span><span class="ident" id="8419339">tx</span><span class="op" id="8419341">.</span><span class="ident" id="8419342">Prepare</span><span class="op" id="8419349">(</span><span class="string" id="8419350">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8419403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8419406">if</span>&nbsp;<span class="ident" id="8419409">err</span>&nbsp;<span class="op" id="8419413">!=</span>&nbsp;<span class="ident" id="8419416">nil</span>&nbsp;<span class="op" id="8419420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419424">t</span><span class="op" id="8419425">.</span><span class="ident" id="8419426">Fatal</span><span class="op" id="8419431">(</span><span class="ident" id="8419432">err</span><span class="op" id="8419435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8419438">}</span><br>
<span class="lineno"></span><span class="op" id="8419440">}</span><br>
<span class="lineno">1675</span><br>
<span class="lineno"></span><span class="keyword" id="8419443">func</span>&nbsp;<span class="op" id="8419448">(</span><span class="ident" id="8419449">c</span>&nbsp;<span class="op" id="8419451">*</span><span class="ident" id="8419452">concurrentTxStmtExecTest</span><span class="op" id="8419476">)</span>&nbsp;<span class="ident" id="8419478">finish</span><span class="op" id="8419484">(</span><span class="ident" id="8419485">t</span>&nbsp;<span class="ident" id="8419487">testing</span><span class="op" id="8419494">.</span><span class="ident" id="8419495">TB</span><span class="op" id="8419497">)</span>&nbsp;<span class="op" id="8419499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8419502">if</span>&nbsp;<span class="ident" id="8419505">c</span><span class="op" id="8419506">.</span><span class="ident" id="8419507">stmt</span>&nbsp;<span class="op" id="8419512">!=</span>&nbsp;<span class="ident" id="8419515">nil</span>&nbsp;<span class="op" id="8419519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419523">c</span><span class="op" id="8419524">.</span><span class="ident" id="8419525">stmt</span><span class="op" id="8419529">.</span><span class="ident" id="8419530">Close</span><span class="op" id="8419535">(</span><span class="op" id="8419536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419540">c</span><span class="op" id="8419541">.</span><span class="ident" id="8419542">stmt</span>&nbsp;<span class="op" id="8419547">=</span>&nbsp;<span class="ident" id="8419549">nil</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8419554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8419557">if</span>&nbsp;<span class="ident" id="8419560">c</span><span class="op" id="8419561">.</span><span class="ident" id="8419562">tx</span>&nbsp;<span class="op" id="8419565">!=</span>&nbsp;<span class="ident" id="8419568">nil</span>&nbsp;<span class="op" id="8419572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419576">c</span><span class="op" id="8419577">.</span><span class="ident" id="8419578">tx</span><span class="op" id="8419580">.</span><span class="ident" id="8419581">Rollback</span><span class="op" id="8419589">(</span><span class="op" id="8419590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419594">c</span><span class="op" id="8419595">.</span><span class="ident" id="8419596">tx</span>&nbsp;<span class="op" id="8419599">=</span>&nbsp;<span class="ident" id="8419601">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8419606">}</span><br>
<span class="lineno">1685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419609">c</span><span class="op" id="8419610">.</span><span class="ident" id="8419611">db</span>&nbsp;<span class="op" id="8419614">=</span>&nbsp;<span class="ident" id="8419616">nil</span><br>
<span class="lineno"></span><span class="op" id="8419620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8419623">func</span>&nbsp;<span class="op" id="8419628">(</span><span class="ident" id="8419629">c</span>&nbsp;<span class="op" id="8419631">*</span><span class="ident" id="8419632">concurrentTxStmtExecTest</span><span class="op" id="8419656">)</span>&nbsp;<span class="ident" id="8419658">test</span><span class="op" id="8419662">(</span><span class="ident" id="8419663">t</span>&nbsp;<span class="ident" id="8419665">testing</span><span class="op" id="8419672">.</span><span class="ident" id="8419673">TB</span><span class="op" id="8419675">)</span>&nbsp;<span class="builtintype" id="8419677">error</span>&nbsp;<span class="op" id="8419683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419686">_</span><span class="op" id="8419687">,</span>&nbsp;<span class="ident" id="8419689">err</span>&nbsp;<span class="op" id="8419693">:=</span>&nbsp;<span class="ident" id="8419696">c</span><span class="op" id="8419697">.</span><span class="ident" id="8419698">stmt</span><span class="op" id="8419702">.</span><span class="ident" id="8419703">Exec</span><span class="op" id="8419707">(</span><span class="num" id="8419708">3</span><span class="op" id="8419709">,</span>&nbsp;<span class="ident" id="8419711">chrisBirthday</span><span class="op" id="8419724">)</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8419727">if</span>&nbsp;<span class="ident" id="8419730">err</span>&nbsp;<span class="op" id="8419734">!=</span>&nbsp;<span class="ident" id="8419737">nil</span>&nbsp;<span class="op" id="8419741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419745">t</span><span class="op" id="8419746">.</span><span class="ident" id="8419747">Errorf</span><span class="op" id="8419753">(</span><span class="string" id="8419754">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8419774">,</span>&nbsp;<span class="ident" id="8419776">err</span><span class="op" id="8419779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8419783">return</span>&nbsp;<span class="ident" id="8419790">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8419795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8419798">return</span>&nbsp;<span class="ident" id="8419805">nil</span><br>
<span class="lineno">1695</span><span class="op" id="8419809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8419812">type</span>&nbsp;<span class="ident" id="8419817">concurrentRandomTest</span>&nbsp;<span class="keyword" id="8419838">struct</span>&nbsp;<span class="op" id="8419845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419848">tests</span>&nbsp;<span class="op" id="8419854">[</span><span class="op" id="8419855">]</span><span class="ident" id="8419856">concurrentTest</span><br>
<span class="lineno"></span><span class="op" id="8419871">}</span><br>
<span class="lineno">1700</span><br>
<span class="lineno"></span><span class="keyword" id="8419874">func</span>&nbsp;<span class="op" id="8419879">(</span><span class="ident" id="8419880">c</span>&nbsp;<span class="op" id="8419882">*</span><span class="ident" id="8419883">concurrentRandomTest</span><span class="op" id="8419903">)</span>&nbsp;<span class="ident" id="8419905">init</span><span class="op" id="8419909">(</span><span class="ident" id="8419910">t</span>&nbsp;<span class="ident" id="8419912">testing</span><span class="op" id="8419919">.</span><span class="ident" id="8419920">TB</span><span class="op" id="8419922">,</span>&nbsp;<span class="ident" id="8419924">db</span>&nbsp;<span class="op" id="8419927">*</span><span class="ident" id="8419928">DB</span><span class="op" id="8419930">)</span>&nbsp;<span class="op" id="8419932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8419935">c</span><span class="op" id="8419936">.</span><span class="ident" id="8419937">tests</span>&nbsp;<span class="op" id="8419943">=</span>&nbsp;<span class="op" id="8419945">[</span><span class="op" id="8419946">]</span><span class="ident" id="8419947">concurrentTest</span><span class="op" id="8419961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8419965">new</span><span class="op" id="8419968">(</span><span class="ident" id="8419969">concurrentDBQueryTest</span><span class="op" id="8419990">)</span><span class="op" id="8419991">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8419995">new</span><span class="op" id="8419998">(</span><span class="ident" id="8419999">concurrentDBExecTest</span><span class="op" id="8420019">)</span><span class="op" id="8420020">,</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8420024">new</span><span class="op" id="8420027">(</span><span class="ident" id="8420028">concurrentStmtQueryTest</span><span class="op" id="8420051">)</span><span class="op" id="8420052">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8420056">new</span><span class="op" id="8420059">(</span><span class="ident" id="8420060">concurrentStmtExecTest</span><span class="op" id="8420082">)</span><span class="op" id="8420083">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8420087">new</span><span class="op" id="8420090">(</span><span class="ident" id="8420091">concurrentTxQueryTest</span><span class="op" id="8420112">)</span><span class="op" id="8420113">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8420117">new</span><span class="op" id="8420120">(</span><span class="ident" id="8420121">concurrentTxExecTest</span><span class="op" id="8420141">)</span><span class="op" id="8420142">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8420146">new</span><span class="op" id="8420149">(</span><span class="ident" id="8420150">concurrentTxStmtQueryTest</span><span class="op" id="8420175">)</span><span class="op" id="8420176">,</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8420180">new</span><span class="op" id="8420183">(</span><span class="ident" id="8420184">concurrentTxStmtExecTest</span><span class="op" id="8420208">)</span><span class="op" id="8420209">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8420212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8420215">for</span>&nbsp;<span class="ident" id="8420219">_</span><span class="op" id="8420220">,</span>&nbsp;<span class="ident" id="8420222">ct</span>&nbsp;<span class="op" id="8420225">:=</span>&nbsp;<span class="keyword" id="8420228">range</span>&nbsp;<span class="ident" id="8420234">c</span><span class="op" id="8420235">.</span><span class="ident" id="8420236">tests</span>&nbsp;<span class="op" id="8420242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8420246">ct</span><span class="op" id="8420248">.</span><span class="ident" id="8420249">init</span><span class="op" id="8420253">(</span><span class="ident" id="8420254">t</span><span class="op" id="8420255">,</span>&nbsp;<span class="ident" id="8420257">db</span><span class="op" id="8420259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8420262">}</span><br>
<span class="lineno">1715</span><span class="op" id="8420264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8420267">func</span>&nbsp;<span class="op" id="8420272">(</span><span class="ident" id="8420273">c</span>&nbsp;<span class="op" id="8420275">*</span><span class="ident" id="8420276">concurrentRandomTest</span><span class="op" id="8420296">)</span>&nbsp;<span class="ident" id="8420298">finish</span><span class="op" id="8420304">(</span><span class="ident" id="8420305">t</span>&nbsp;<span class="ident" id="8420307">testing</span><span class="op" id="8420314">.</span><span class="ident" id="8420315">TB</span><span class="op" id="8420317">)</span>&nbsp;<span class="op" id="8420319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8420322">for</span>&nbsp;<span class="ident" id="8420326">_</span><span class="op" id="8420327">,</span>&nbsp;<span class="ident" id="8420329">ct</span>&nbsp;<span class="op" id="8420332">:=</span>&nbsp;<span class="keyword" id="8420335">range</span>&nbsp;<span class="ident" id="8420341">c</span><span class="op" id="8420342">.</span><span class="ident" id="8420343">tests</span>&nbsp;<span class="op" id="8420349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8420353">ct</span><span class="op" id="8420355">.</span><span class="ident" id="8420356">finish</span><span class="op" id="8420362">(</span><span class="ident" id="8420363">t</span><span class="op" id="8420364">)</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8420367">}</span><br>
<span class="lineno"></span><span class="op" id="8420369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8420372">func</span>&nbsp;<span class="op" id="8420377">(</span><span class="ident" id="8420378">c</span>&nbsp;<span class="op" id="8420380">*</span><span class="ident" id="8420381">concurrentRandomTest</span><span class="op" id="8420401">)</span>&nbsp;<span class="ident" id="8420403">test</span><span class="op" id="8420407">(</span><span class="ident" id="8420408">t</span>&nbsp;<span class="ident" id="8420410">testing</span><span class="op" id="8420417">.</span><span class="ident" id="8420418">TB</span><span class="op" id="8420420">)</span>&nbsp;<span class="builtintype" id="8420422">error</span>&nbsp;<span class="op" id="8420428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8420431">ct</span>&nbsp;<span class="op" id="8420434">:=</span>&nbsp;<span class="ident" id="8420437">c</span><span class="op" id="8420438">.</span><span class="ident" id="8420439">tests</span><span class="op" id="8420444">[</span><span class="ident" id="8420445">rand</span><span class="op" id="8420449">.</span><span class="ident" id="8420450">Intn</span><span class="op" id="8420454">(</span><span class="builtinfunc" id="8420455">len</span><span class="op" id="8420458">(</span><span class="ident" id="8420459">c</span><span class="op" id="8420460">.</span><span class="ident" id="8420461">tests</span><span class="op" id="8420466">)</span><span class="op" id="8420467">)</span><span class="op" id="8420468">]</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8420471">return</span>&nbsp;<span class="ident" id="8420478">ct</span><span class="op" id="8420480">.</span><span class="ident" id="8420481">test</span><span class="op" id="8420485">(</span><span class="ident" id="8420486">t</span><span class="op" id="8420487">)</span><br>
<span class="lineno"></span><span class="op" id="8420489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8420492">func</span>&nbsp;<span class="ident" id="8420497">doConcurrentTest</span><span class="op" id="8420513">(</span><span class="ident" id="8420514">t</span>&nbsp;<span class="ident" id="8420516">testing</span><span class="op" id="8420523">.</span><span class="ident" id="8420524">TB</span><span class="op" id="8420526">,</span>&nbsp;<span class="ident" id="8420528">ct</span>&nbsp;<span class="ident" id="8420531">concurrentTest</span><span class="op" id="8420545">)</span>&nbsp;<span class="op" id="8420547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8420550">maxProcs</span><span class="op" id="8420558">,</span>&nbsp;<span class="ident" id="8420560">numReqs</span>&nbsp;<span class="op" id="8420568">:=</span>&nbsp;<span class="num" id="8420571">1</span><span class="op" id="8420572">,</span>&nbsp;<span class="num" id="8420574">500</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8420579">if</span>&nbsp;<span class="ident" id="8420582">testing</span><span class="op" id="8420589">.</span><span class="ident" id="8420590">Short</span><span class="op" id="8420595">(</span><span class="op" id="8420596">)</span>&nbsp;<span class="op" id="8420598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8420602">maxProcs</span><span class="op" id="8420610">,</span>&nbsp;<span class="ident" id="8420612">numReqs</span>&nbsp;<span class="op" id="8420620">=</span>&nbsp;<span class="num" id="8420622">4</span><span class="op" id="8420623">,</span>&nbsp;<span class="num" id="8420625">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8420629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8420632">defer</span>&nbsp;<span class="ident" id="8420638">runtime</span><span class="op" id="8420645">.</span><span class="ident" id="8420646">GOMAXPROCS</span><span class="op" id="8420656">(</span><span class="ident" id="8420657">runtime</span><span class="op" id="8420664">.</span><span class="ident" id="8420665">GOMAXPROCS</span><span class="op" id="8420675">(</span><span class="ident" id="8420676">maxProcs</span><span class="op" id="8420684">)</span><span class="op" id="8420685">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8420689">db</span>&nbsp;<span class="op" id="8420692">:=</span>&nbsp;<span class="ident" id="8420695">newTestDB</span><span class="op" id="8420704">(</span><span class="ident" id="8420705">t</span><span class="op" id="8420706">,</span>&nbsp;<span class="string" id="8420708">&#34;people&#34;</span><span class="op" id="8420716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8420719">defer</span>&nbsp;<span class="ident" id="8420725">closeDB</span><span class="op" id="8420732">(</span><span class="ident" id="8420733">t</span><span class="op" id="8420734">,</span>&nbsp;<span class="ident" id="8420736">db</span><span class="op" id="8420738">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8420742">ct</span><span class="op" id="8420744">.</span><span class="ident" id="8420745">init</span><span class="op" id="8420749">(</span><span class="ident" id="8420750">t</span><span class="op" id="8420751">,</span>&nbsp;<span class="ident" id="8420753">db</span><span class="op" id="8420755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8420758">defer</span>&nbsp;<span class="ident" id="8420764">ct</span><span class="op" id="8420766">.</span><span class="ident" id="8420767">finish</span><span class="op" id="8420773">(</span><span class="ident" id="8420774">t</span><span class="op" id="8420775">)</span><br>
<span class="lineno">1740</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8420779">var</span>&nbsp;<span class="ident" id="8420783">wg</span>&nbsp;<span class="ident" id="8420786">sync</span><span class="op" id="8420790">.</span><span class="ident" id="8420791">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8420802">wg</span><span class="op" id="8420804">.</span><span class="ident" id="8420805">Add</span><span class="op" id="8420808">(</span><span class="ident" id="8420809">numReqs</span><span class="op" id="8420816">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8420820">reqs</span>&nbsp;<span class="op" id="8420825">:=</span>&nbsp;<span class="builtinfunc" id="8420828">make</span><span class="op" id="8420832">(</span><span class="keyword" id="8420833">chan</span>&nbsp;<span class="builtintype" id="8420838">bool</span><span class="op" id="8420842">)</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8420845">defer</span>&nbsp;<span class="builtinfunc" id="8420851">close</span><span class="op" id="8420856">(</span><span class="ident" id="8420857">reqs</span><span class="op" id="8420861">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8420865">for</span>&nbsp;<span class="ident" id="8420869">i</span>&nbsp;<span class="op" id="8420871">:=</span>&nbsp;<span class="num" id="8420874">0</span><span class="op" id="8420875">;</span>&nbsp;<span class="ident" id="8420877">i</span>&nbsp;<span class="op" id="8420879">&lt;</span>&nbsp;<span class="ident" id="8420881">maxProcs</span><span class="op" id="8420889">*</span><span class="num" id="8420890">2</span><span class="op" id="8420891">;</span>&nbsp;<span class="ident" id="8420893">i</span><span class="op" id="8420894">++</span>&nbsp;<span class="op" id="8420897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8420901">go</span>&nbsp;<span class="keyword" id="8420904">func</span><span class="op" id="8420908">(</span><span class="op" id="8420909">)</span>&nbsp;<span class="op" id="8420911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8420916">for</span>&nbsp;<span class="keyword" id="8420920">range</span>&nbsp;<span class="ident" id="8420926">reqs</span>&nbsp;<span class="op" id="8420931">{</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8420937">err</span>&nbsp;<span class="op" id="8420941">:=</span>&nbsp;<span class="ident" id="8420944">ct</span><span class="op" id="8420946">.</span><span class="ident" id="8420947">test</span><span class="op" id="8420951">(</span><span class="ident" id="8420952">t</span><span class="op" id="8420953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8420959">if</span>&nbsp;<span class="ident" id="8420962">err</span>&nbsp;<span class="op" id="8420966">!=</span>&nbsp;<span class="ident" id="8420969">nil</span>&nbsp;<span class="op" id="8420973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8420980">wg</span><span class="op" id="8420982">.</span><span class="ident" id="8420983">Done</span><span class="op" id="8420987">(</span><span class="op" id="8420988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8420995">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8421008">}</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421014">wg</span><span class="op" id="8421016">.</span><span class="ident" id="8421017">Done</span><span class="op" id="8421021">(</span><span class="op" id="8421022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8421027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8421031">}</span><span class="op" id="8421032">(</span><span class="op" id="8421033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8421036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421040">for</span>&nbsp;<span class="ident" id="8421044">i</span>&nbsp;<span class="op" id="8421046">:=</span>&nbsp;<span class="num" id="8421049">0</span><span class="op" id="8421050">;</span>&nbsp;<span class="ident" id="8421052">i</span>&nbsp;<span class="op" id="8421054">&lt;</span>&nbsp;<span class="ident" id="8421056">numReqs</span><span class="op" id="8421063">;</span>&nbsp;<span class="ident" id="8421065">i</span><span class="op" id="8421066">++</span>&nbsp;<span class="op" id="8421069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421073">reqs</span>&nbsp;<span class="op" id="8421078">&lt;-</span>&nbsp;<span class="builtintype" id="8421081">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8421087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421091">wg</span><span class="op" id="8421093">.</span><span class="ident" id="8421094">Wait</span><span class="op" id="8421098">(</span><span class="op" id="8421099">)</span><br>
<span class="lineno">1765</span><span class="op" id="8421101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8421104">func</span>&nbsp;<span class="ident" id="8421109">manyConcurrentQueries</span><span class="op" id="8421130">(</span><span class="ident" id="8421131">t</span>&nbsp;<span class="ident" id="8421133">testing</span><span class="op" id="8421140">.</span><span class="ident" id="8421141">TB</span><span class="op" id="8421143">)</span>&nbsp;<span class="op" id="8421145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421148">maxProcs</span><span class="op" id="8421156">,</span>&nbsp;<span class="ident" id="8421158">numReqs</span>&nbsp;<span class="op" id="8421166">:=</span>&nbsp;<span class="num" id="8421169">16</span><span class="op" id="8421171">,</span>&nbsp;<span class="num" id="8421173">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421178">if</span>&nbsp;<span class="ident" id="8421181">testing</span><span class="op" id="8421188">.</span><span class="ident" id="8421189">Short</span><span class="op" id="8421194">(</span><span class="op" id="8421195">)</span>&nbsp;<span class="op" id="8421197">{</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421201">maxProcs</span><span class="op" id="8421209">,</span>&nbsp;<span class="ident" id="8421211">numReqs</span>&nbsp;<span class="op" id="8421219">=</span>&nbsp;<span class="num" id="8421221">4</span><span class="op" id="8421222">,</span>&nbsp;<span class="num" id="8421224">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8421228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421231">defer</span>&nbsp;<span class="ident" id="8421237">runtime</span><span class="op" id="8421244">.</span><span class="ident" id="8421245">GOMAXPROCS</span><span class="op" id="8421255">(</span><span class="ident" id="8421256">runtime</span><span class="op" id="8421263">.</span><span class="ident" id="8421264">GOMAXPROCS</span><span class="op" id="8421274">(</span><span class="ident" id="8421275">maxProcs</span><span class="op" id="8421283">)</span><span class="op" id="8421284">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421288">db</span>&nbsp;<span class="op" id="8421291">:=</span>&nbsp;<span class="ident" id="8421294">newTestDB</span><span class="op" id="8421303">(</span><span class="ident" id="8421304">t</span><span class="op" id="8421305">,</span>&nbsp;<span class="string" id="8421307">&#34;people&#34;</span><span class="op" id="8421315">)</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421318">defer</span>&nbsp;<span class="ident" id="8421324">closeDB</span><span class="op" id="8421331">(</span><span class="ident" id="8421332">t</span><span class="op" id="8421333">,</span>&nbsp;<span class="ident" id="8421335">db</span><span class="op" id="8421337">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421341">stmt</span><span class="op" id="8421345">,</span>&nbsp;<span class="ident" id="8421347">err</span>&nbsp;<span class="op" id="8421351">:=</span>&nbsp;<span class="ident" id="8421354">db</span><span class="op" id="8421356">.</span><span class="ident" id="8421357">Prepare</span><span class="op" id="8421364">(</span><span class="string" id="8421365">&#34;SELECT|people|name|&#34;</span><span class="op" id="8421386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421389">if</span>&nbsp;<span class="ident" id="8421392">err</span>&nbsp;<span class="op" id="8421396">!=</span>&nbsp;<span class="ident" id="8421399">nil</span>&nbsp;<span class="op" id="8421403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421407">t</span><span class="op" id="8421408">.</span><span class="ident" id="8421409">Fatal</span><span class="op" id="8421414">(</span><span class="ident" id="8421415">err</span><span class="op" id="8421418">)</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8421421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421424">defer</span>&nbsp;<span class="ident" id="8421430">stmt</span><span class="op" id="8421434">.</span><span class="ident" id="8421435">Close</span><span class="op" id="8421440">(</span><span class="op" id="8421441">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421445">var</span>&nbsp;<span class="ident" id="8421449">wg</span>&nbsp;<span class="ident" id="8421452">sync</span><span class="op" id="8421456">.</span><span class="ident" id="8421457">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421468">wg</span><span class="op" id="8421470">.</span><span class="ident" id="8421471">Add</span><span class="op" id="8421474">(</span><span class="ident" id="8421475">numReqs</span><span class="op" id="8421482">)</span><br>
<span class="lineno">1785</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421486">reqs</span>&nbsp;<span class="op" id="8421491">:=</span>&nbsp;<span class="builtinfunc" id="8421494">make</span><span class="op" id="8421498">(</span><span class="keyword" id="8421499">chan</span>&nbsp;<span class="builtintype" id="8421504">bool</span><span class="op" id="8421508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421511">defer</span>&nbsp;<span class="builtinfunc" id="8421517">close</span><span class="op" id="8421522">(</span><span class="ident" id="8421523">reqs</span><span class="op" id="8421527">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421531">for</span>&nbsp;<span class="ident" id="8421535">i</span>&nbsp;<span class="op" id="8421537">:=</span>&nbsp;<span class="num" id="8421540">0</span><span class="op" id="8421541">;</span>&nbsp;<span class="ident" id="8421543">i</span>&nbsp;<span class="op" id="8421545">&lt;</span>&nbsp;<span class="ident" id="8421547">maxProcs</span><span class="op" id="8421555">*</span><span class="num" id="8421556">2</span><span class="op" id="8421557">;</span>&nbsp;<span class="ident" id="8421559">i</span><span class="op" id="8421560">++</span>&nbsp;<span class="op" id="8421563">{</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421567">go</span>&nbsp;<span class="keyword" id="8421570">func</span><span class="op" id="8421574">(</span><span class="op" id="8421575">)</span>&nbsp;<span class="op" id="8421577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421582">for</span>&nbsp;<span class="keyword" id="8421586">range</span>&nbsp;<span class="ident" id="8421592">reqs</span>&nbsp;<span class="op" id="8421597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421603">rows</span><span class="op" id="8421607">,</span>&nbsp;<span class="ident" id="8421609">err</span>&nbsp;<span class="op" id="8421613">:=</span>&nbsp;<span class="ident" id="8421616">stmt</span><span class="op" id="8421620">.</span><span class="ident" id="8421621">Query</span><span class="op" id="8421626">(</span><span class="op" id="8421627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421633">if</span>&nbsp;<span class="ident" id="8421636">err</span>&nbsp;<span class="op" id="8421640">!=</span>&nbsp;<span class="ident" id="8421643">nil</span>&nbsp;<span class="op" id="8421647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421654">t</span><span class="op" id="8421655">.</span><span class="ident" id="8421656">Errorf</span><span class="op" id="8421662">(</span><span class="string" id="8421663">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8421684">,</span>&nbsp;<span class="ident" id="8421686">err</span><span class="op" id="8421689">)</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421696">wg</span><span class="op" id="8421698">.</span><span class="ident" id="8421699">Done</span><span class="op" id="8421703">(</span><span class="op" id="8421704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421711">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8421724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421731">var</span>&nbsp;<span class="ident" id="8421735">name</span>&nbsp;<span class="builtintype" id="8421740">string</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421751">for</span>&nbsp;<span class="ident" id="8421755">rows</span><span class="op" id="8421759">.</span><span class="ident" id="8421760">Next</span><span class="op" id="8421764">(</span><span class="op" id="8421765">)</span>&nbsp;<span class="op" id="8421767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421774">rows</span><span class="op" id="8421778">.</span><span class="ident" id="8421779">Scan</span><span class="op" id="8421783">(</span><span class="op" id="8421784">&amp;</span><span class="ident" id="8421785">name</span><span class="op" id="8421789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8421795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421801">rows</span><span class="op" id="8421805">.</span><span class="ident" id="8421806">Close</span><span class="op" id="8421811">(</span><span class="op" id="8421812">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421819">wg</span><span class="op" id="8421821">.</span><span class="ident" id="8421822">Done</span><span class="op" id="8421826">(</span><span class="op" id="8421827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8421832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8421836">}</span><span class="op" id="8421837">(</span><span class="op" id="8421838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8421841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421845">for</span>&nbsp;<span class="ident" id="8421849">i</span>&nbsp;<span class="op" id="8421851">:=</span>&nbsp;<span class="num" id="8421854">0</span><span class="op" id="8421855">;</span>&nbsp;<span class="ident" id="8421857">i</span>&nbsp;<span class="op" id="8421859">&lt;</span>&nbsp;<span class="ident" id="8421861">numReqs</span><span class="op" id="8421868">;</span>&nbsp;<span class="ident" id="8421870">i</span><span class="op" id="8421871">++</span>&nbsp;<span class="op" id="8421874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421878">reqs</span>&nbsp;<span class="op" id="8421883">&lt;-</span>&nbsp;<span class="builtintype" id="8421886">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8421892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421896">wg</span><span class="op" id="8421898">.</span><span class="ident" id="8421899">Wait</span><span class="op" id="8421903">(</span><span class="op" id="8421904">)</span><br>
<span class="lineno">1815</span><span class="op" id="8421906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8421909">func</span>&nbsp;<span class="ident" id="8421914">TestIssue6081</span><span class="op" id="8421927">(</span><span class="ident" id="8421928">t</span>&nbsp;<span class="op" id="8421930">*</span><span class="ident" id="8421931">testing</span><span class="op" id="8421938">.</span><span class="ident" id="8421939">T</span><span class="op" id="8421940">)</span>&nbsp;<span class="op" id="8421942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421945">db</span>&nbsp;<span class="op" id="8421948">:=</span>&nbsp;<span class="ident" id="8421951">newTestDB</span><span class="op" id="8421960">(</span><span class="ident" id="8421961">t</span><span class="op" id="8421962">,</span>&nbsp;<span class="string" id="8421964">&#34;people&#34;</span><span class="op" id="8421972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8421975">defer</span>&nbsp;<span class="ident" id="8421981">closeDB</span><span class="op" id="8421988">(</span><span class="ident" id="8421989">t</span><span class="op" id="8421990">,</span>&nbsp;<span class="ident" id="8421992">db</span><span class="op" id="8421994">)</span><br>
<span class="lineno">1820</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8421998">drv</span>&nbsp;<span class="op" id="8422002">:=</span>&nbsp;<span class="ident" id="8422005">db</span><span class="op" id="8422007">.</span><span class="ident" id="8422008">driver</span><span class="op" id="8422014">.</span><span class="op" id="8422015">(</span><span class="op" id="8422016">*</span><span class="ident" id="8422017">fakeDriver</span><span class="op" id="8422027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422030">drv</span><span class="op" id="8422033">.</span><span class="ident" id="8422034">mu</span><span class="op" id="8422036">.</span><span class="ident" id="8422037">Lock</span><span class="op" id="8422041">(</span><span class="op" id="8422042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422045">opens0</span>&nbsp;<span class="op" id="8422052">:=</span>&nbsp;<span class="ident" id="8422055">drv</span><span class="op" id="8422058">.</span><span class="ident" id="8422059">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422070">closes0</span>&nbsp;<span class="op" id="8422078">:=</span>&nbsp;<span class="ident" id="8422081">drv</span><span class="op" id="8422084">.</span><span class="ident" id="8422085">closeCount</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422097">drv</span><span class="op" id="8422100">.</span><span class="ident" id="8422101">mu</span><span class="op" id="8422103">.</span><span class="ident" id="8422104">Unlock</span><span class="op" id="8422110">(</span><span class="op" id="8422111">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422115">stmt</span><span class="op" id="8422119">,</span>&nbsp;<span class="ident" id="8422121">err</span>&nbsp;<span class="op" id="8422125">:=</span>&nbsp;<span class="ident" id="8422128">db</span><span class="op" id="8422130">.</span><span class="ident" id="8422131">Prepare</span><span class="op" id="8422138">(</span><span class="string" id="8422139">&#34;SELECT|people|name|&#34;</span><span class="op" id="8422160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8422163">if</span>&nbsp;<span class="ident" id="8422166">err</span>&nbsp;<span class="op" id="8422170">!=</span>&nbsp;<span class="ident" id="8422173">nil</span>&nbsp;<span class="op" id="8422177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422181">t</span><span class="op" id="8422182">.</span><span class="ident" id="8422183">Fatal</span><span class="op" id="8422188">(</span><span class="ident" id="8422189">err</span><span class="op" id="8422192">)</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8422195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422198">rowsCloseHook</span>&nbsp;<span class="op" id="8422212">=</span>&nbsp;<span class="keyword" id="8422214">func</span><span class="op" id="8422218">(</span><span class="ident" id="8422219">rows</span>&nbsp;<span class="op" id="8422224">*</span><span class="ident" id="8422225">Rows</span><span class="op" id="8422229">,</span>&nbsp;<span class="ident" id="8422231">err</span>&nbsp;<span class="op" id="8422235">*</span><span class="builtintype" id="8422236">error</span><span class="op" id="8422241">)</span>&nbsp;<span class="op" id="8422243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8422247">*</span><span class="ident" id="8422248">err</span>&nbsp;<span class="op" id="8422252">=</span>&nbsp;<span class="ident" id="8422254">driver</span><span class="op" id="8422260">.</span><span class="ident" id="8422261">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8422273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8422276">defer</span>&nbsp;<span class="keyword" id="8422282">func</span><span class="op" id="8422286">(</span><span class="op" id="8422287">)</span>&nbsp;<span class="op" id="8422289">{</span>&nbsp;<span class="ident" id="8422291">rowsCloseHook</span>&nbsp;<span class="op" id="8422305">=</span>&nbsp;<span class="ident" id="8422307">nil</span>&nbsp;<span class="op" id="8422311">}</span><span class="op" id="8422312">(</span><span class="op" id="8422313">)</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8422316">for</span>&nbsp;<span class="ident" id="8422320">i</span>&nbsp;<span class="op" id="8422322">:=</span>&nbsp;<span class="num" id="8422325">0</span><span class="op" id="8422326">;</span>&nbsp;<span class="ident" id="8422328">i</span>&nbsp;<span class="op" id="8422330">&lt;</span>&nbsp;<span class="num" id="8422332">10</span><span class="op" id="8422334">;</span>&nbsp;<span class="ident" id="8422336">i</span><span class="op" id="8422337">++</span>&nbsp;<span class="op" id="8422340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422344">rows</span><span class="op" id="8422348">,</span>&nbsp;<span class="ident" id="8422350">err</span>&nbsp;<span class="op" id="8422354">:=</span>&nbsp;<span class="ident" id="8422357">stmt</span><span class="op" id="8422361">.</span><span class="ident" id="8422362">Query</span><span class="op" id="8422367">(</span><span class="op" id="8422368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8422372">if</span>&nbsp;<span class="ident" id="8422375">err</span>&nbsp;<span class="op" id="8422379">!=</span>&nbsp;<span class="ident" id="8422382">nil</span>&nbsp;<span class="op" id="8422386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422391">t</span><span class="op" id="8422392">.</span><span class="ident" id="8422393">Fatal</span><span class="op" id="8422398">(</span><span class="ident" id="8422399">err</span><span class="op" id="8422402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8422406">}</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422410">rows</span><span class="op" id="8422414">.</span><span class="ident" id="8422415">Close</span><span class="op" id="8422420">(</span><span class="op" id="8422421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8422424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8422427">if</span>&nbsp;<span class="ident" id="8422430">n</span>&nbsp;<span class="op" id="8422432">:=</span>&nbsp;<span class="builtinfunc" id="8422435">len</span><span class="op" id="8422438">(</span><span class="ident" id="8422439">stmt</span><span class="op" id="8422443">.</span><span class="ident" id="8422444">css</span><span class="op" id="8422447">)</span><span class="op" id="8422448">;</span>&nbsp;<span class="ident" id="8422450">n</span>&nbsp;<span class="op" id="8422452">&gt;</span>&nbsp;<span class="num" id="8422454">1</span>&nbsp;<span class="op" id="8422456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422460">t</span><span class="op" id="8422461">.</span><span class="ident" id="8422462">Errorf</span><span class="op" id="8422468">(</span><span class="string" id="8422469">&#34;len(css&nbsp;slice)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="8422501">,</span>&nbsp;<span class="ident" id="8422503">n</span><span class="op" id="8422504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8422507">}</span><br>
<span class="lineno">1845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422510">stmt</span><span class="op" id="8422514">.</span><span class="ident" id="8422515">Close</span><span class="op" id="8422520">(</span><span class="op" id="8422521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8422524">if</span>&nbsp;<span class="ident" id="8422527">n</span>&nbsp;<span class="op" id="8422529">:=</span>&nbsp;<span class="builtinfunc" id="8422532">len</span><span class="op" id="8422535">(</span><span class="ident" id="8422536">stmt</span><span class="op" id="8422540">.</span><span class="ident" id="8422541">css</span><span class="op" id="8422544">)</span><span class="op" id="8422545">;</span>&nbsp;<span class="ident" id="8422547">n</span>&nbsp;<span class="op" id="8422549">!=</span>&nbsp;<span class="num" id="8422552">0</span>&nbsp;<span class="op" id="8422554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422558">t</span><span class="op" id="8422559">.</span><span class="ident" id="8422560">Errorf</span><span class="op" id="8422566">(</span><span class="string" id="8422567">&#34;len(css&nbsp;slice)&nbsp;after&nbsp;Close&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8422608">,</span>&nbsp;<span class="ident" id="8422610">n</span><span class="op" id="8422611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8422614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422618">drv</span><span class="op" id="8422621">.</span><span class="ident" id="8422622">mu</span><span class="op" id="8422624">.</span><span class="ident" id="8422625">Lock</span><span class="op" id="8422629">(</span><span class="op" id="8422630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422633">opens</span>&nbsp;<span class="op" id="8422639">:=</span>&nbsp;<span class="ident" id="8422642">drv</span><span class="op" id="8422645">.</span><span class="ident" id="8422646">openCount</span>&nbsp;<span class="op" id="8422656">-</span>&nbsp;<span class="ident" id="8422658">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422666">closes</span>&nbsp;<span class="op" id="8422673">:=</span>&nbsp;<span class="ident" id="8422676">drv</span><span class="op" id="8422679">.</span><span class="ident" id="8422680">closeCount</span>&nbsp;<span class="op" id="8422691">-</span>&nbsp;<span class="ident" id="8422693">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422702">drv</span><span class="op" id="8422705">.</span><span class="ident" id="8422706">mu</span><span class="op" id="8422708">.</span><span class="ident" id="8422709">Unlock</span><span class="op" id="8422715">(</span><span class="op" id="8422716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8422719">if</span>&nbsp;<span class="ident" id="8422722">opens</span>&nbsp;<span class="op" id="8422728">&lt;</span>&nbsp;<span class="num" id="8422730">9</span>&nbsp;<span class="op" id="8422732">{</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422736">t</span><span class="op" id="8422737">.</span><span class="ident" id="8422738">Errorf</span><span class="op" id="8422744">(</span><span class="string" id="8422745">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="8422768">,</span>&nbsp;<span class="ident" id="8422770">opens</span><span class="op" id="8422775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8422778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8422781">if</span>&nbsp;<span class="ident" id="8422784">closes</span>&nbsp;<span class="op" id="8422791">&lt;</span>&nbsp;<span class="num" id="8422793">9</span>&nbsp;<span class="op" id="8422795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422799">t</span><span class="op" id="8422800">.</span><span class="ident" id="8422801">Errorf</span><span class="op" id="8422807">(</span><span class="string" id="8422808">&#34;closes&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="8422832">,</span>&nbsp;<span class="ident" id="8422834">closes</span><span class="op" id="8422840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8422843">}</span><br>
<span class="lineno">1860</span><span class="op" id="8422845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8422848">func</span>&nbsp;<span class="ident" id="8422853">TestConcurrency</span><span class="op" id="8422868">(</span><span class="ident" id="8422869">t</span>&nbsp;<span class="op" id="8422871">*</span><span class="ident" id="8422872">testing</span><span class="op" id="8422879">.</span><span class="ident" id="8422880">T</span><span class="op" id="8422881">)</span>&nbsp;<span class="op" id="8422883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422886">doConcurrentTest</span><span class="op" id="8422902">(</span><span class="ident" id="8422903">t</span><span class="op" id="8422904">,</span>&nbsp;<span class="builtinfunc" id="8422906">new</span><span class="op" id="8422909">(</span><span class="ident" id="8422910">concurrentDBQueryTest</span><span class="op" id="8422931">)</span><span class="op" id="8422932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422935">doConcurrentTest</span><span class="op" id="8422951">(</span><span class="ident" id="8422952">t</span><span class="op" id="8422953">,</span>&nbsp;<span class="builtinfunc" id="8422955">new</span><span class="op" id="8422958">(</span><span class="ident" id="8422959">concurrentDBExecTest</span><span class="op" id="8422979">)</span><span class="op" id="8422980">)</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8422983">doConcurrentTest</span><span class="op" id="8422999">(</span><span class="ident" id="8423000">t</span><span class="op" id="8423001">,</span>&nbsp;<span class="builtinfunc" id="8423003">new</span><span class="op" id="8423006">(</span><span class="ident" id="8423007">concurrentStmtQueryTest</span><span class="op" id="8423030">)</span><span class="op" id="8423031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8423034">doConcurrentTest</span><span class="op" id="8423050">(</span><span class="ident" id="8423051">t</span><span class="op" id="8423052">,</span>&nbsp;<span class="builtinfunc" id="8423054">new</span><span class="op" id="8423057">(</span><span class="ident" id="8423058">concurrentStmtExecTest</span><span class="op" id="8423080">)</span><span class="op" id="8423081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8423084">doConcurrentTest</span><span class="op" id="8423100">(</span><span class="ident" id="8423101">t</span><span class="op" id="8423102">,</span>&nbsp;<span class="builtinfunc" id="8423104">new</span><span class="op" id="8423107">(</span><span class="ident" id="8423108">concurrentTxQueryTest</span><span class="op" id="8423129">)</span><span class="op" id="8423130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8423133">doConcurrentTest</span><span class="op" id="8423149">(</span><span class="ident" id="8423150">t</span><span class="op" id="8423151">,</span>&nbsp;<span class="builtinfunc" id="8423153">new</span><span class="op" id="8423156">(</span><span class="ident" id="8423157">concurrentTxExecTest</span><span class="op" id="8423177">)</span><span class="op" id="8423178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8423181">doConcurrentTest</span><span class="op" id="8423197">(</span><span class="ident" id="8423198">t</span><span class="op" id="8423199">,</span>&nbsp;<span class="builtinfunc" id="8423201">new</span><span class="op" id="8423204">(</span><span class="ident" id="8423205">concurrentTxStmtQueryTest</span><span class="op" id="8423230">)</span><span class="op" id="8423231">)</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8423234">doConcurrentTest</span><span class="op" id="8423250">(</span><span class="ident" id="8423251">t</span><span class="op" id="8423252">,</span>&nbsp;<span class="builtinfunc" id="8423254">new</span><span class="op" id="8423257">(</span><span class="ident" id="8423258">concurrentTxStmtExecTest</span><span class="op" id="8423282">)</span><span class="op" id="8423283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8423286">doConcurrentTest</span><span class="op" id="8423302">(</span><span class="ident" id="8423303">t</span><span class="op" id="8423304">,</span>&nbsp;<span class="builtinfunc" id="8423306">new</span><span class="op" id="8423309">(</span><span class="ident" id="8423310">concurrentRandomTest</span><span class="op" id="8423330">)</span><span class="op" id="8423331">)</span><br>
<span class="lineno"></span><span class="op" id="8423333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8423336">func</span>&nbsp;<span class="ident" id="8423341">TestConnectionLeak</span><span class="op" id="8423359">(</span><span class="ident" id="8423360">t</span>&nbsp;<span class="op" id="8423362">*</span><span class="ident" id="8423363">testing</span><span class="op" id="8423370">.</span><span class="ident" id="8423371">T</span><span class="op" id="8423372">)</span>&nbsp;<span class="op" id="8423374">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8423377">db</span>&nbsp;<span class="op" id="8423380">:=</span>&nbsp;<span class="ident" id="8423383">newTestDB</span><span class="op" id="8423392">(</span><span class="ident" id="8423393">t</span><span class="op" id="8423394">,</span>&nbsp;<span class="string" id="8423396">&#34;people&#34;</span><span class="op" id="8423404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8423407">defer</span>&nbsp;<span class="ident" id="8423413">closeDB</span><span class="op" id="8423420">(</span><span class="ident" id="8423421">t</span><span class="op" id="8423422">,</span>&nbsp;<span class="ident" id="8423424">db</span><span class="op" id="8423426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8423429">//&nbsp;Start&nbsp;by&nbsp;opening&nbsp;defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8423470">rows</span>&nbsp;<span class="op" id="8423475">:=</span>&nbsp;<span class="builtinfunc" id="8423478">make</span><span class="op" id="8423482">(</span><span class="op" id="8423483">[</span><span class="op" id="8423484">]</span><span class="op" id="8423485">*</span><span class="ident" id="8423486">Rows</span><span class="op" id="8423490">,</span>&nbsp;<span class="ident" id="8423492">defaultMaxIdleConns</span><span class="op" id="8423511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8423514">//&nbsp;We&nbsp;need&nbsp;to&nbsp;SetMaxOpenConns&nbsp;&gt;&nbsp;MaxIdleConns,&nbsp;so&nbsp;the&nbsp;DB&nbsp;can&nbsp;open</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8423580">//&nbsp;a&nbsp;new&nbsp;connection&nbsp;and&nbsp;we&nbsp;can&nbsp;fill&nbsp;the&nbsp;idle&nbsp;queue&nbsp;with&nbsp;the&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8423650">//&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8423667">db</span><span class="op" id="8423669">.</span><span class="ident" id="8423670">SetMaxOpenConns</span><span class="op" id="8423685">(</span><span class="builtinfunc" id="8423686">len</span><span class="op" id="8423689">(</span><span class="ident" id="8423690">rows</span><span class="op" id="8423694">)</span>&nbsp;<span class="op" id="8423696">+</span>&nbsp;<span class="num" id="8423698">1</span><span class="op" id="8423699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8423702">for</span>&nbsp;<span class="ident" id="8423706">ii</span>&nbsp;<span class="op" id="8423709">:=</span>&nbsp;<span class="keyword" id="8423712">range</span>&nbsp;<span class="ident" id="8423718">rows</span>&nbsp;<span class="op" id="8423723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8423727">r</span><span class="op" id="8423728">,</span>&nbsp;<span class="ident" id="8423730">err</span>&nbsp;<span class="op" id="8423734">:=</span>&nbsp;<span class="ident" id="8423737">db</span><span class="op" id="8423739">.</span><span class="ident" id="8423740">Query</span><span class="op" id="8423745">(</span><span class="string" id="8423746">&#34;SELECT|people|name|&#34;</span><span class="op" id="8423767">)</span><br>
<span class="lineno">1885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8423771">if</span>&nbsp;<span class="ident" id="8423774">err</span>&nbsp;<span class="op" id="8423778">!=</span>&nbsp;<span class="ident" id="8423781">nil</span>&nbsp;<span class="op" id="8423785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8423790">t</span><span class="op" id="8423791">.</span><span class="ident" id="8423792">Fatal</span><span class="op" id="8423797">(</span><span class="ident" id="8423798">err</span><span class="op" id="8423801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8423805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8423809">r</span><span class="op" id="8423810">.</span><span class="ident" id="8423811">Next</span><span class="op" id="8423815">(</span><span class="op" id="8423816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8423820">if</span>&nbsp;<span class="ident" id="8423823">err</span>&nbsp;<span class="op" id="8423827">:=</span>&nbsp;<span class="ident" id="8423830">r</span><span class="op" id="8423831">.</span><span class="ident" id="8423832">Err</span><span class="op" id="8423835">(</span><span class="op" id="8423836">)</span><span class="op" id="8423837">;</span>&nbsp;<span class="ident" id="8423839">err</span>&nbsp;<span class="op" id="8423843">!=</span>&nbsp;<span class="ident" id="8423846">nil</span>&nbsp;<span class="op" id="8423850">{</span><br>
<span class="lineno">1890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8423855">t</span><span class="op" id="8423856">.</span><span class="ident" id="8423857">Fatal</span><span class="op" id="8423862">(</span><span class="ident" id="8423863">err</span><span class="op" id="8423866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8423870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8423874">rows</span><span class="op" id="8423878">[</span><span class="ident" id="8423879">ii</span><span class="op" id="8423881">]</span>&nbsp;<span class="op" id="8423883">=</span>&nbsp;<span class="ident" id="8423885">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8423888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8423891">//&nbsp;Now&nbsp;we&nbsp;have&nbsp;defaultMaxIdleConns&nbsp;busy&nbsp;connections.&nbsp;Open</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8423950">//&nbsp;a&nbsp;new&nbsp;one,&nbsp;but&nbsp;wait&nbsp;until&nbsp;the&nbsp;busy&nbsp;connections&nbsp;are&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8424014">//&nbsp;before&nbsp;returning&nbsp;control&nbsp;to&nbsp;DB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8424050">drv</span>&nbsp;<span class="op" id="8424054">:=</span>&nbsp;<span class="ident" id="8424057">db</span><span class="op" id="8424059">.</span><span class="ident" id="8424060">driver</span><span class="op" id="8424066">.</span><span class="op" id="8424067">(</span><span class="op" id="8424068">*</span><span class="ident" id="8424069">fakeDriver</span><span class="op" id="8424079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8424082">drv</span><span class="op" id="8424085">.</span><span class="ident" id="8424086">waitCh</span>&nbsp;<span class="op" id="8424093">=</span>&nbsp;<span class="builtinfunc" id="8424095">make</span><span class="op" id="8424099">(</span><span class="keyword" id="8424100">chan</span>&nbsp;<span class="keyword" id="8424105">struct</span><span class="op" id="8424111">{</span><span class="op" id="8424112">}</span><span class="op" id="8424113">,</span>&nbsp;<span class="num" id="8424115">1</span><span class="op" id="8424116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8424119">drv</span><span class="op" id="8424122">.</span><span class="ident" id="8424123">waitingCh</span>&nbsp;<span class="op" id="8424133">=</span>&nbsp;<span class="builtinfunc" id="8424135">make</span><span class="op" id="8424139">(</span><span class="keyword" id="8424140">chan</span>&nbsp;<span class="keyword" id="8424145">struct</span><span class="op" id="8424151">{</span><span class="op" id="8424152">}</span><span class="op" id="8424153">,</span>&nbsp;<span class="num" id="8424155">1</span><span class="op" id="8424156">)</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8424159">var</span>&nbsp;<span class="ident" id="8424163">wg</span>&nbsp;<span class="ident" id="8424166">sync</span><span class="op" id="8424170">.</span><span class="ident" id="8424171">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8424182">wg</span><span class="op" id="8424184">.</span><span class="ident" id="8424185">Add</span><span class="op" id="8424188">(</span><span class="num" id="8424189">1</span><span class="op" id="8424190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8424193">go</span>&nbsp;<span class="keyword" id="8424196">func</span><span class="op" id="8424200">(</span><span class="op" id="8424201">)</span>&nbsp;<span class="op" id="8424203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8424207">r</span><span class="op" id="8424208">,</span>&nbsp;<span class="ident" id="8424210">err</span>&nbsp;<span class="op" id="8424214">:=</span>&nbsp;<span class="ident" id="8424217">db</span><span class="op" id="8424219">.</span><span class="ident" id="8424220">Query</span><span class="op" id="8424225">(</span><span class="string" id="8424226">&#34;SELECT|people|name|&#34;</span><span class="op" id="8424247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8424251">if</span>&nbsp;<span class="ident" id="8424254">err</span>&nbsp;<span class="op" id="8424258">!=</span>&nbsp;<span class="ident" id="8424261">nil</span>&nbsp;<span class="op" id="8424265">{</span><br>
<span class="lineno">1905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8424270">t</span><span class="op" id="8424271">.</span><span class="ident" id="8424272">Fatal</span><span class="op" id="8424277">(</span><span class="ident" id="8424278">err</span><span class="op" id="8424281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8424285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8424289">r</span><span class="op" id="8424290">.</span><span class="ident" id="8424291">Close</span><span class="op" id="8424296">(</span><span class="op" id="8424297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8424301">wg</span><span class="op" id="8424303">.</span><span class="ident" id="8424304">Done</span><span class="op" id="8424308">(</span><span class="op" id="8424309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8424312">}</span><span class="op" id="8424313">(</span><span class="op" id="8424314">)</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8424317">//&nbsp;Wait&nbsp;until&nbsp;the&nbsp;goroutine&nbsp;we&#39;ve&nbsp;just&nbsp;created&nbsp;has&nbsp;started&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8424386">&lt;-</span><span class="ident" id="8424388">drv</span><span class="op" id="8424391">.</span><span class="ident" id="8424392">waitingCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8424403">//&nbsp;Now&nbsp;close&nbsp;the&nbsp;busy&nbsp;connections.&nbsp;This&nbsp;provides&nbsp;a&nbsp;connection&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8424470">//&nbsp;the&nbsp;blocked&nbsp;goroutine&nbsp;and&nbsp;then&nbsp;fills&nbsp;up&nbsp;the&nbsp;idle&nbsp;queue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8424530">for</span>&nbsp;<span class="ident" id="8424534">_</span><span class="op" id="8424535">,</span>&nbsp;<span class="ident" id="8424537">v</span>&nbsp;<span class="op" id="8424539">:=</span>&nbsp;<span class="keyword" id="8424542">range</span>&nbsp;<span class="ident" id="8424548">rows</span>&nbsp;<span class="op" id="8424553">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8424557">v</span><span class="op" id="8424558">.</span><span class="ident" id="8424559">Close</span><span class="op" id="8424564">(</span><span class="op" id="8424565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8424568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8424571">//&nbsp;At&nbsp;this&nbsp;point&nbsp;we&nbsp;give&nbsp;the&nbsp;new&nbsp;connection&nbsp;to&nbsp;DB.&nbsp;This&nbsp;connection&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8424642">//&nbsp;now&nbsp;useless,&nbsp;since&nbsp;the&nbsp;idle&nbsp;queue&nbsp;is&nbsp;full&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8424713">//&nbsp;requests.&nbsp;DB&nbsp;should&nbsp;deal&nbsp;with&nbsp;this&nbsp;situation&nbsp;without&nbsp;leaking&nbsp;the</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8424782">//&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8424798">drv</span><span class="op" id="8424801">.</span><span class="ident" id="8424802">waitCh</span>&nbsp;<span class="op" id="8424809">&lt;-</span>&nbsp;<span class="keyword" id="8424812">struct</span><span class="op" id="8424818">{</span><span class="op" id="8424819">}</span><span class="op" id="8424820">{</span><span class="op" id="8424821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8424824">wg</span><span class="op" id="8424826">.</span><span class="ident" id="8424827">Wait</span><span class="op" id="8424831">(</span><span class="op" id="8424832">)</span><br>
<span class="lineno"></span><span class="op" id="8424834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1925</span><span class="keyword" id="8424837">func</span>&nbsp;<span class="ident" id="8424842">BenchmarkConcurrentDBExec</span><span class="op" id="8424867">(</span><span class="ident" id="8424868">b</span>&nbsp;<span class="op" id="8424870">*</span><span class="ident" id="8424871">testing</span><span class="op" id="8424878">.</span><span class="ident" id="8424879">B</span><span class="op" id="8424880">)</span>&nbsp;<span class="op" id="8424882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8424885">b</span><span class="op" id="8424886">.</span><span class="ident" id="8424887">ReportAllocs</span><span class="op" id="8424899">(</span><span class="op" id="8424900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8424903">ct</span>&nbsp;<span class="op" id="8424906">:=</span>&nbsp;<span class="builtinfunc" id="8424909">new</span><span class="op" id="8424912">(</span><span class="ident" id="8424913">concurrentDBExecTest</span><span class="op" id="8424933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8424936">for</span>&nbsp;<span class="ident" id="8424940">i</span>&nbsp;<span class="op" id="8424942">:=</span>&nbsp;<span class="num" id="8424945">0</span><span class="op" id="8424946">;</span>&nbsp;<span class="ident" id="8424948">i</span>&nbsp;<span class="op" id="8424950">&lt;</span>&nbsp;<span class="ident" id="8424952">b</span><span class="op" id="8424953">.</span><span class="ident" id="8424954">N</span><span class="op" id="8424955">;</span>&nbsp;<span class="ident" id="8424957">i</span><span class="op" id="8424958">++</span>&nbsp;<span class="op" id="8424961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8424965">doConcurrentTest</span><span class="op" id="8424981">(</span><span class="ident" id="8424982">b</span><span class="op" id="8424983">,</span>&nbsp;<span class="ident" id="8424985">ct</span><span class="op" id="8424987">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8424990">}</span><br>
<span class="lineno"></span><span class="op" id="8424992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8424995">func</span>&nbsp;<span class="ident" id="8425000">BenchmarkConcurrentStmtQuery</span><span class="op" id="8425028">(</span><span class="ident" id="8425029">b</span>&nbsp;<span class="op" id="8425031">*</span><span class="ident" id="8425032">testing</span><span class="op" id="8425039">.</span><span class="ident" id="8425040">B</span><span class="op" id="8425041">)</span>&nbsp;<span class="op" id="8425043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425046">b</span><span class="op" id="8425047">.</span><span class="ident" id="8425048">ReportAllocs</span><span class="op" id="8425060">(</span><span class="op" id="8425061">)</span><br>
<span class="lineno">1935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425064">ct</span>&nbsp;<span class="op" id="8425067">:=</span>&nbsp;<span class="builtinfunc" id="8425070">new</span><span class="op" id="8425073">(</span><span class="ident" id="8425074">concurrentStmtQueryTest</span><span class="op" id="8425097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8425100">for</span>&nbsp;<span class="ident" id="8425104">i</span>&nbsp;<span class="op" id="8425106">:=</span>&nbsp;<span class="num" id="8425109">0</span><span class="op" id="8425110">;</span>&nbsp;<span class="ident" id="8425112">i</span>&nbsp;<span class="op" id="8425114">&lt;</span>&nbsp;<span class="ident" id="8425116">b</span><span class="op" id="8425117">.</span><span class="ident" id="8425118">N</span><span class="op" id="8425119">;</span>&nbsp;<span class="ident" id="8425121">i</span><span class="op" id="8425122">++</span>&nbsp;<span class="op" id="8425125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425129">doConcurrentTest</span><span class="op" id="8425145">(</span><span class="ident" id="8425146">b</span><span class="op" id="8425147">,</span>&nbsp;<span class="ident" id="8425149">ct</span><span class="op" id="8425151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8425154">}</span><br>
<span class="lineno"></span><span class="op" id="8425156">}</span><br>
<span class="lineno">1940</span><br>
<span class="lineno"></span><span class="keyword" id="8425159">func</span>&nbsp;<span class="ident" id="8425164">BenchmarkConcurrentStmtExec</span><span class="op" id="8425191">(</span><span class="ident" id="8425192">b</span>&nbsp;<span class="op" id="8425194">*</span><span class="ident" id="8425195">testing</span><span class="op" id="8425202">.</span><span class="ident" id="8425203">B</span><span class="op" id="8425204">)</span>&nbsp;<span class="op" id="8425206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425209">b</span><span class="op" id="8425210">.</span><span class="ident" id="8425211">ReportAllocs</span><span class="op" id="8425223">(</span><span class="op" id="8425224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425227">ct</span>&nbsp;<span class="op" id="8425230">:=</span>&nbsp;<span class="builtinfunc" id="8425233">new</span><span class="op" id="8425236">(</span><span class="ident" id="8425237">concurrentStmtExecTest</span><span class="op" id="8425259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8425262">for</span>&nbsp;<span class="ident" id="8425266">i</span>&nbsp;<span class="op" id="8425268">:=</span>&nbsp;<span class="num" id="8425271">0</span><span class="op" id="8425272">;</span>&nbsp;<span class="ident" id="8425274">i</span>&nbsp;<span class="op" id="8425276">&lt;</span>&nbsp;<span class="ident" id="8425278">b</span><span class="op" id="8425279">.</span><span class="ident" id="8425280">N</span><span class="op" id="8425281">;</span>&nbsp;<span class="ident" id="8425283">i</span><span class="op" id="8425284">++</span>&nbsp;<span class="op" id="8425287">{</span><br>
<span class="lineno">1945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425291">doConcurrentTest</span><span class="op" id="8425307">(</span><span class="ident" id="8425308">b</span><span class="op" id="8425309">,</span>&nbsp;<span class="ident" id="8425311">ct</span><span class="op" id="8425313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8425316">}</span><br>
<span class="lineno"></span><span class="op" id="8425318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8425321">func</span>&nbsp;<span class="ident" id="8425326">BenchmarkConcurrentTxQuery</span><span class="op" id="8425352">(</span><span class="ident" id="8425353">b</span>&nbsp;<span class="op" id="8425355">*</span><span class="ident" id="8425356">testing</span><span class="op" id="8425363">.</span><span class="ident" id="8425364">B</span><span class="op" id="8425365">)</span>&nbsp;<span class="op" id="8425367">{</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425370">b</span><span class="op" id="8425371">.</span><span class="ident" id="8425372">ReportAllocs</span><span class="op" id="8425384">(</span><span class="op" id="8425385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425388">ct</span>&nbsp;<span class="op" id="8425391">:=</span>&nbsp;<span class="builtinfunc" id="8425394">new</span><span class="op" id="8425397">(</span><span class="ident" id="8425398">concurrentTxQueryTest</span><span class="op" id="8425419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8425422">for</span>&nbsp;<span class="ident" id="8425426">i</span>&nbsp;<span class="op" id="8425428">:=</span>&nbsp;<span class="num" id="8425431">0</span><span class="op" id="8425432">;</span>&nbsp;<span class="ident" id="8425434">i</span>&nbsp;<span class="op" id="8425436">&lt;</span>&nbsp;<span class="ident" id="8425438">b</span><span class="op" id="8425439">.</span><span class="ident" id="8425440">N</span><span class="op" id="8425441">;</span>&nbsp;<span class="ident" id="8425443">i</span><span class="op" id="8425444">++</span>&nbsp;<span class="op" id="8425447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425451">doConcurrentTest</span><span class="op" id="8425467">(</span><span class="ident" id="8425468">b</span><span class="op" id="8425469">,</span>&nbsp;<span class="ident" id="8425471">ct</span><span class="op" id="8425473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8425476">}</span><br>
<span class="lineno">1955</span><span class="op" id="8425478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8425481">func</span>&nbsp;<span class="ident" id="8425486">BenchmarkConcurrentTxExec</span><span class="op" id="8425511">(</span><span class="ident" id="8425512">b</span>&nbsp;<span class="op" id="8425514">*</span><span class="ident" id="8425515">testing</span><span class="op" id="8425522">.</span><span class="ident" id="8425523">B</span><span class="op" id="8425524">)</span>&nbsp;<span class="op" id="8425526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425529">b</span><span class="op" id="8425530">.</span><span class="ident" id="8425531">ReportAllocs</span><span class="op" id="8425543">(</span><span class="op" id="8425544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425547">ct</span>&nbsp;<span class="op" id="8425550">:=</span>&nbsp;<span class="builtinfunc" id="8425553">new</span><span class="op" id="8425556">(</span><span class="ident" id="8425557">concurrentTxExecTest</span><span class="op" id="8425577">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8425580">for</span>&nbsp;<span class="ident" id="8425584">i</span>&nbsp;<span class="op" id="8425586">:=</span>&nbsp;<span class="num" id="8425589">0</span><span class="op" id="8425590">;</span>&nbsp;<span class="ident" id="8425592">i</span>&nbsp;<span class="op" id="8425594">&lt;</span>&nbsp;<span class="ident" id="8425596">b</span><span class="op" id="8425597">.</span><span class="ident" id="8425598">N</span><span class="op" id="8425599">;</span>&nbsp;<span class="ident" id="8425601">i</span><span class="op" id="8425602">++</span>&nbsp;<span class="op" id="8425605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425609">doConcurrentTest</span><span class="op" id="8425625">(</span><span class="ident" id="8425626">b</span><span class="op" id="8425627">,</span>&nbsp;<span class="ident" id="8425629">ct</span><span class="op" id="8425631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8425634">}</span><br>
<span class="lineno"></span><span class="op" id="8425636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1965</span><span class="keyword" id="8425639">func</span>&nbsp;<span class="ident" id="8425644">BenchmarkConcurrentTxStmtQuery</span><span class="op" id="8425674">(</span><span class="ident" id="8425675">b</span>&nbsp;<span class="op" id="8425677">*</span><span class="ident" id="8425678">testing</span><span class="op" id="8425685">.</span><span class="ident" id="8425686">B</span><span class="op" id="8425687">)</span>&nbsp;<span class="op" id="8425689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425692">b</span><span class="op" id="8425693">.</span><span class="ident" id="8425694">ReportAllocs</span><span class="op" id="8425706">(</span><span class="op" id="8425707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425710">ct</span>&nbsp;<span class="op" id="8425713">:=</span>&nbsp;<span class="builtinfunc" id="8425716">new</span><span class="op" id="8425719">(</span><span class="ident" id="8425720">concurrentTxStmtQueryTest</span><span class="op" id="8425745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8425748">for</span>&nbsp;<span class="ident" id="8425752">i</span>&nbsp;<span class="op" id="8425754">:=</span>&nbsp;<span class="num" id="8425757">0</span><span class="op" id="8425758">;</span>&nbsp;<span class="ident" id="8425760">i</span>&nbsp;<span class="op" id="8425762">&lt;</span>&nbsp;<span class="ident" id="8425764">b</span><span class="op" id="8425765">.</span><span class="ident" id="8425766">N</span><span class="op" id="8425767">;</span>&nbsp;<span class="ident" id="8425769">i</span><span class="op" id="8425770">++</span>&nbsp;<span class="op" id="8425773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425777">doConcurrentTest</span><span class="op" id="8425793">(</span><span class="ident" id="8425794">b</span><span class="op" id="8425795">,</span>&nbsp;<span class="ident" id="8425797">ct</span><span class="op" id="8425799">)</span><br>
<span class="lineno">1970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8425802">}</span><br>
<span class="lineno"></span><span class="op" id="8425804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8425807">func</span>&nbsp;<span class="ident" id="8425812">BenchmarkConcurrentTxStmtExec</span><span class="op" id="8425841">(</span><span class="ident" id="8425842">b</span>&nbsp;<span class="op" id="8425844">*</span><span class="ident" id="8425845">testing</span><span class="op" id="8425852">.</span><span class="ident" id="8425853">B</span><span class="op" id="8425854">)</span>&nbsp;<span class="op" id="8425856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425859">b</span><span class="op" id="8425860">.</span><span class="ident" id="8425861">ReportAllocs</span><span class="op" id="8425873">(</span><span class="op" id="8425874">)</span><br>
<span class="lineno">1975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425877">ct</span>&nbsp;<span class="op" id="8425880">:=</span>&nbsp;<span class="builtinfunc" id="8425883">new</span><span class="op" id="8425886">(</span><span class="ident" id="8425887">concurrentTxStmtExecTest</span><span class="op" id="8425911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8425914">for</span>&nbsp;<span class="ident" id="8425918">i</span>&nbsp;<span class="op" id="8425920">:=</span>&nbsp;<span class="num" id="8425923">0</span><span class="op" id="8425924">;</span>&nbsp;<span class="ident" id="8425926">i</span>&nbsp;<span class="op" id="8425928">&lt;</span>&nbsp;<span class="ident" id="8425930">b</span><span class="op" id="8425931">.</span><span class="ident" id="8425932">N</span><span class="op" id="8425933">;</span>&nbsp;<span class="ident" id="8425935">i</span><span class="op" id="8425936">++</span>&nbsp;<span class="op" id="8425939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8425943">doConcurrentTest</span><span class="op" id="8425959">(</span><span class="ident" id="8425960">b</span><span class="op" id="8425961">,</span>&nbsp;<span class="ident" id="8425963">ct</span><span class="op" id="8425965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8425968">}</span><br>
<span class="lineno"></span><span class="op" id="8425970">}</span><br>
<span class="lineno">1980</span><br>
<span class="lineno"></span><span class="keyword" id="8425973">func</span>&nbsp;<span class="ident" id="8425978">BenchmarkConcurrentRandom</span><span class="op" id="8426003">(</span><span class="ident" id="8426004">b</span>&nbsp;<span class="op" id="8426006">*</span><span class="ident" id="8426007">testing</span><span class="op" id="8426014">.</span><span class="ident" id="8426015">B</span><span class="op" id="8426016">)</span>&nbsp;<span class="op" id="8426018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8426021">b</span><span class="op" id="8426022">.</span><span class="ident" id="8426023">ReportAllocs</span><span class="op" id="8426035">(</span><span class="op" id="8426036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8426039">ct</span>&nbsp;<span class="op" id="8426042">:=</span>&nbsp;<span class="builtinfunc" id="8426045">new</span><span class="op" id="8426048">(</span><span class="ident" id="8426049">concurrentRandomTest</span><span class="op" id="8426069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8426072">for</span>&nbsp;<span class="ident" id="8426076">i</span>&nbsp;<span class="op" id="8426078">:=</span>&nbsp;<span class="num" id="8426081">0</span><span class="op" id="8426082">;</span>&nbsp;<span class="ident" id="8426084">i</span>&nbsp;<span class="op" id="8426086">&lt;</span>&nbsp;<span class="ident" id="8426088">b</span><span class="op" id="8426089">.</span><span class="ident" id="8426090">N</span><span class="op" id="8426091">;</span>&nbsp;<span class="ident" id="8426093">i</span><span class="op" id="8426094">++</span>&nbsp;<span class="op" id="8426097">{</span><br>
<span class="lineno">1985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8426101">doConcurrentTest</span><span class="op" id="8426117">(</span><span class="ident" id="8426118">b</span><span class="op" id="8426119">,</span>&nbsp;<span class="ident" id="8426121">ct</span><span class="op" id="8426123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8426126">}</span><br>
<span class="lineno"></span><span class="op" id="8426128">}</span>
</div>
</body>
</html>
