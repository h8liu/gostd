<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">os</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;syscall&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment">//&nbsp;File&nbsp;represents&nbsp;an&nbsp;open&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">File</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">file</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment">//&nbsp;file&nbsp;is&nbsp;the&nbsp;real&nbsp;representation&nbsp;of&nbsp;*File.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;extra&nbsp;level&nbsp;of&nbsp;indirection&nbsp;ensures&nbsp;that&nbsp;no&nbsp;clients&nbsp;of&nbsp;os</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;can&nbsp;overwrite&nbsp;this&nbsp;data,&nbsp;which&nbsp;could&nbsp;cause&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;to&nbsp;close&nbsp;the&nbsp;wrong&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">file</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dirinfo</span>&nbsp;<span class="op">*</span><span class="ident">dirInfo</span>&nbsp;<span class="comment">//&nbsp;nil&nbsp;unless&nbsp;directory&nbsp;being&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nepipe</span>&nbsp;&nbsp;<span class="builtintype">int32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;number&nbsp;of&nbsp;consecutive&nbsp;EPIPE&nbsp;in&nbsp;Write</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Fd&nbsp;returns&nbsp;the&nbsp;integer&nbsp;Unix&nbsp;file&nbsp;descriptor&nbsp;referencing&nbsp;the&nbsp;open&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;file&nbsp;descriptor&nbsp;is&nbsp;valid&nbsp;only&nbsp;until&nbsp;f.Close&nbsp;is&nbsp;called&nbsp;or&nbsp;f&nbsp;is&nbsp;garbage&nbsp;collected.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">f</span>&nbsp;<span class="op">*</span><span class="ident">File</span><span class="op">)</span>&nbsp;<span class="ident">Fd</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">uintptr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">^</span><span class="op">(</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">fd</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment">//&nbsp;NewFile&nbsp;returns&nbsp;a&nbsp;new&nbsp;File&nbsp;with&nbsp;the&nbsp;given&nbsp;file&nbsp;descriptor&nbsp;and&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">NewFile</span><span class="op">(</span><span class="ident">fd</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">,</span>&nbsp;<span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">File</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fdi</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">fd</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">fdi</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">File</span><span class="op">{</span><span class="op">&amp;</span><span class="ident">file</span><span class="op">{</span><span class="ident">fd</span><span class="op">:</span>&nbsp;<span class="ident">fdi</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">:</span>&nbsp;<span class="ident">name</span><span class="op">}</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runtime</span><span class="op">.</span><span class="ident">SetFinalizer</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">file</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">file</span><span class="op">)</span><span class="op">.</span><span class="builtinfunc">close</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Auxiliary&nbsp;information&nbsp;if&nbsp;the&nbsp;File&nbsp;describes&nbsp;a&nbsp;directory</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">dirInfo</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span>&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;<span class="comment">//&nbsp;buffer&nbsp;for&nbsp;directory&nbsp;I/O</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nbuf</span>&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;length&nbsp;of&nbsp;buf;&nbsp;return&nbsp;value&nbsp;from&nbsp;Getdirentries</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bufp</span>&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;location&nbsp;of&nbsp;next&nbsp;record&nbsp;in&nbsp;buf.</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">epipecheck</span><span class="op">(</span><span class="ident">file</span>&nbsp;<span class="op">*</span><span class="ident">File</span><span class="op">,</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EPIPE</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">atomic</span><span class="op">.</span><span class="ident">AddInt32</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">file</span><span class="op">.</span><span class="ident">nepipe</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">)</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">10</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sigpipe</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">atomic</span><span class="op">.</span><span class="ident">StoreInt32</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">file</span><span class="op">.</span><span class="ident">nepipe</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;DevNull&nbsp;is&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;operating&nbsp;system&#39;s&nbsp;``null&nbsp;device.&#39;&#39;</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;On&nbsp;Unix-like&nbsp;systems,&nbsp;it&nbsp;is&nbsp;&#34;/dev/null&#34;;&nbsp;on&nbsp;Windows,&nbsp;&#34;NUL&#34;.</span><br>
<span class="lineno">70</span><span class="keyword">const</span>&nbsp;<span class="ident">DevNull</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;/dev/null&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;OpenFile&nbsp;is&nbsp;the&nbsp;generalized&nbsp;open&nbsp;call;&nbsp;most&nbsp;users&nbsp;will&nbsp;use&nbsp;Open</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;or&nbsp;Create&nbsp;instead.&nbsp;&nbsp;It&nbsp;opens&nbsp;the&nbsp;named&nbsp;file&nbsp;with&nbsp;specified&nbsp;flag</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;(O_RDONLY&nbsp;etc.)&nbsp;and&nbsp;perm,&nbsp;(0666&nbsp;etc.)&nbsp;if&nbsp;applicable.&nbsp;&nbsp;If&nbsp;successful,</span><br>
<span class="lineno">75</span><span class="comment">//&nbsp;methods&nbsp;on&nbsp;the&nbsp;returned&nbsp;File&nbsp;can&nbsp;be&nbsp;used&nbsp;for&nbsp;I/O.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;there&nbsp;is&nbsp;an&nbsp;error,&nbsp;it&nbsp;will&nbsp;be&nbsp;of&nbsp;type&nbsp;*PathError.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">OpenFile</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">flag</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">perm</span>&nbsp;<span class="ident">FileMode</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">file</span>&nbsp;<span class="op">*</span><span class="ident">File</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Open</span><span class="op">(</span><span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">flag</span><span class="op">|</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">O_CLOEXEC</span><span class="op">,</span>&nbsp;<span class="ident">syscallMode</span><span class="op">(</span><span class="ident">perm</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">PathError</span><span class="op">{</span><span class="string">&#34;open&#34;</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">e</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;There&#39;s&nbsp;a&nbsp;race&nbsp;here&nbsp;with&nbsp;fork/exec,&nbsp;which&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;content&nbsp;to&nbsp;live&nbsp;with.&nbsp;&nbsp;See&nbsp;../syscall/exec_unix.go.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">supportsCloseOnExec</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">syscall</span><span class="op">.</span><span class="ident">CloseOnExec</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">NewFile</span><span class="op">(</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">90</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;File,&nbsp;rendering&nbsp;it&nbsp;unusable&nbsp;for&nbsp;I/O.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">f</span>&nbsp;<span class="op">*</span><span class="ident">File</span><span class="op">)</span>&nbsp;<span class="ident">Close</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">ErrInvalid</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">file</span><span class="op">.</span><span class="builtinfunc">close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">file</span>&nbsp;<span class="op">*</span><span class="ident">file</span><span class="op">)</span>&nbsp;<span class="builtinfunc">close</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">file</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">file</span><span class="op">.</span><span class="ident">fd</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="ident">file</span><span class="op">.</span><span class="ident">fd</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">PathError</span><span class="op">{</span><span class="string">&#34;close&#34;</span><span class="op">,</span>&nbsp;<span class="ident">file</span><span class="op">.</span><span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">e</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">file</span><span class="op">.</span><span class="ident">fd</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="num">1</span>&nbsp;<span class="comment">//&nbsp;so&nbsp;it&nbsp;can&#39;t&nbsp;be&nbsp;closed&nbsp;again</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;no&nbsp;need&nbsp;for&nbsp;a&nbsp;finalizer&nbsp;anymore</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runtime</span><span class="op">.</span><span class="ident">SetFinalizer</span><span class="op">(</span><span class="ident">file</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Stat&nbsp;returns&nbsp;the&nbsp;FileInfo&nbsp;structure&nbsp;describing&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;there&nbsp;is&nbsp;an&nbsp;error,&nbsp;it&nbsp;will&nbsp;be&nbsp;of&nbsp;type&nbsp;*PathError.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">f</span>&nbsp;<span class="op">*</span><span class="ident">File</span><span class="op">)</span>&nbsp;<span class="ident">Stat</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">fi</span>&nbsp;<span class="ident">FileInfo</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">ErrInvalid</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">stat</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Stat_t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Fstat</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">fd</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">stat</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">PathError</span><span class="op">{</span><span class="string">&#34;stat&#34;</span><span class="op">,</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fileInfoFromStat</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">stat</span><span class="op">,</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">name</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment">//&nbsp;Stat&nbsp;returns&nbsp;a&nbsp;FileInfo&nbsp;describing&nbsp;the&nbsp;named&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;there&nbsp;is&nbsp;an&nbsp;error,&nbsp;it&nbsp;will&nbsp;be&nbsp;of&nbsp;type&nbsp;*PathError.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">Stat</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">fi</span>&nbsp;<span class="ident">FileInfo</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">stat</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Stat_t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Stat</span><span class="op">(</span><span class="ident">name</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">stat</span><span class="op">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">PathError</span><span class="op">{</span><span class="string">&#34;stat&#34;</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fileInfoFromStat</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">stat</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Lstat&nbsp;returns&nbsp;a&nbsp;FileInfo&nbsp;describing&nbsp;the&nbsp;named&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;the&nbsp;file&nbsp;is&nbsp;a&nbsp;symbolic&nbsp;link,&nbsp;the&nbsp;returned&nbsp;FileInfo</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;describes&nbsp;the&nbsp;symbolic&nbsp;link.&nbsp;&nbsp;Lstat&nbsp;makes&nbsp;no&nbsp;attempt&nbsp;to&nbsp;follow&nbsp;the&nbsp;link.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;there&nbsp;is&nbsp;an&nbsp;error,&nbsp;it&nbsp;will&nbsp;be&nbsp;of&nbsp;type&nbsp;*PathError.</span><br>
<span class="lineno">145</span><span class="keyword">func</span>&nbsp;<span class="ident">Lstat</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">fi</span>&nbsp;<span class="ident">FileInfo</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">stat</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Stat_t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Lstat</span><span class="op">(</span><span class="ident">name</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">stat</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">PathError</span><span class="op">{</span><span class="string">&#34;lstat&#34;</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fileInfoFromStat</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">stat</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">f</span>&nbsp;<span class="op">*</span><span class="ident">File</span><span class="op">)</span>&nbsp;<span class="ident">readdir</span><span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">fi</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">FileInfo</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dirname</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">dirname</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dirname</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">names</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">Readdirnames</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fi</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="ident">FileInfo</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">names</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">filename</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">names</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fip</span><span class="op">,</span>&nbsp;<span class="ident">lerr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">lstat</span><span class="op">(</span><span class="ident">dirname</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;/&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">filename</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">IsNotExist</span><span class="op">(</span><span class="ident">lerr</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;File&nbsp;disappeared&nbsp;between&nbsp;readdir&nbsp;+&nbsp;stat.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Just&nbsp;treat&nbsp;it&nbsp;as&nbsp;if&nbsp;it&nbsp;didn&#39;t&nbsp;exist.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">lerr</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fi</span><span class="op">,</span>&nbsp;<span class="ident">lerr</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fi</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">fi</span><span class="op">,</span>&nbsp;<span class="ident">fip</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fi</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Darwin&nbsp;and&nbsp;FreeBSD&nbsp;can&#39;t&nbsp;read&nbsp;or&nbsp;write&nbsp;2GB+&nbsp;at&nbsp;a&nbsp;time,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;even&nbsp;on&nbsp;64-bit&nbsp;systems.&nbsp;See&nbsp;golang.org/issue/7812.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;1GB&nbsp;instead&nbsp;of,&nbsp;say,&nbsp;2GB-1,&nbsp;to&nbsp;keep&nbsp;subsequent</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;reads&nbsp;aligned.</span><br>
<span class="lineno">180</span><span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">needsMaxRW</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;darwin&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;freebsd&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">maxRW</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">30</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span><span class="comment">//&nbsp;read&nbsp;reads&nbsp;up&nbsp;to&nbsp;len(b)&nbsp;bytes&nbsp;from&nbsp;the&nbsp;File.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;read&nbsp;and&nbsp;an&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">f</span>&nbsp;<span class="op">*</span><span class="ident">File</span><span class="op">)</span>&nbsp;<span class="ident">read</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">needsMaxRW</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">maxRW</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">[</span><span class="op">:</span><span class="ident">maxRW</span><span class="op">]</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fixCount</span><span class="op">(</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">Read</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">fd</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;pread&nbsp;reads&nbsp;len(b)&nbsp;bytes&nbsp;from&nbsp;the&nbsp;File&nbsp;starting&nbsp;at&nbsp;byte&nbsp;offset&nbsp;off.</span><br>
<span class="lineno">195</span><span class="comment">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;read&nbsp;and&nbsp;the&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;EOF&nbsp;is&nbsp;signaled&nbsp;by&nbsp;a&nbsp;zero&nbsp;count&nbsp;with&nbsp;err&nbsp;set&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">f</span>&nbsp;<span class="op">*</span><span class="ident">File</span><span class="op">)</span>&nbsp;<span class="ident">pread</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">off</span>&nbsp;<span class="ident">int64</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">needsMaxRW</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">maxRW</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">[</span><span class="op">:</span><span class="ident">maxRW</span><span class="op">]</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fixCount</span><span class="op">(</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">Pread</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">fd</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">off</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;write&nbsp;writes&nbsp;len(b)&nbsp;bytes&nbsp;to&nbsp;the&nbsp;File.</span><br>
<span class="lineno">205</span><span class="comment">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;and&nbsp;an&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">f</span>&nbsp;<span class="op">*</span><span class="ident">File</span><span class="op">)</span>&nbsp;<span class="ident">write</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bcap</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">needsMaxRW</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">bcap</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">maxRW</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bcap</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bcap</span><span class="op">[</span><span class="op">:</span><span class="ident">maxRW</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">fixCount</span><span class="op">(</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">fd</span><span class="op">,</span>&nbsp;<span class="ident">bcap</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">m</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;the&nbsp;syscall&nbsp;wrote&nbsp;some&nbsp;data&nbsp;but&nbsp;not&nbsp;all&nbsp;(short&nbsp;write)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;or&nbsp;it&nbsp;returned&nbsp;EINTR,&nbsp;then&nbsp;assume&nbsp;it&nbsp;stopped&nbsp;early&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;reasons&nbsp;that&nbsp;are&nbsp;uninteresting&nbsp;to&nbsp;the&nbsp;caller,&nbsp;and&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">bcap</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EINTR</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">[</span><span class="ident">m</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">needsMaxRW</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">bcap</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">[</span><span class="ident">m</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">230</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;pwrite&nbsp;writes&nbsp;len(b)&nbsp;bytes&nbsp;to&nbsp;the&nbsp;File&nbsp;starting&nbsp;at&nbsp;byte&nbsp;offset&nbsp;off.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;and&nbsp;an&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">f</span>&nbsp;<span class="op">*</span><span class="ident">File</span><span class="op">)</span>&nbsp;<span class="ident">pwrite</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">off</span>&nbsp;<span class="ident">int64</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">n</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">needsMaxRW</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">maxRW</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">[</span><span class="op">:</span><span class="ident">maxRW</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fixCount</span><span class="op">(</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">Pwrite</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">fd</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">off</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;seek&nbsp;sets&nbsp;the&nbsp;offset&nbsp;for&nbsp;the&nbsp;next&nbsp;Read&nbsp;or&nbsp;Write&nbsp;on&nbsp;file&nbsp;to&nbsp;offset,&nbsp;interpreted</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;according&nbsp;to&nbsp;whence:&nbsp;0&nbsp;means&nbsp;relative&nbsp;to&nbsp;the&nbsp;origin&nbsp;of&nbsp;the&nbsp;file,&nbsp;1&nbsp;means</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;relative&nbsp;to&nbsp;the&nbsp;current&nbsp;offset,&nbsp;and&nbsp;2&nbsp;means&nbsp;relative&nbsp;to&nbsp;the&nbsp;end.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;new&nbsp;offset&nbsp;and&nbsp;an&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno">245</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">f</span>&nbsp;<span class="op">*</span><span class="ident">File</span><span class="op">)</span>&nbsp;<span class="ident">seek</span><span class="op">(</span><span class="ident">offset</span>&nbsp;<span class="ident">int64</span><span class="op">,</span>&nbsp;<span class="ident">whence</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">ret</span>&nbsp;<span class="ident">int64</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Seek</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">fd</span><span class="op">,</span>&nbsp;<span class="ident">offset</span><span class="op">,</span>&nbsp;<span class="ident">whence</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Truncate&nbsp;changes&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;named&nbsp;file.</span><br>
<span class="lineno">250</span><span class="comment">//&nbsp;If&nbsp;the&nbsp;file&nbsp;is&nbsp;a&nbsp;symbolic&nbsp;link,&nbsp;it&nbsp;changes&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;link&#39;s&nbsp;target.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;there&nbsp;is&nbsp;an&nbsp;error,&nbsp;it&nbsp;will&nbsp;be&nbsp;of&nbsp;type&nbsp;*PathError.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">Truncate</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="ident">int64</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Truncate</span><span class="op">(</span><span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">size</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">PathError</span><span class="op">{</span><span class="string">&#34;truncate&#34;</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">e</span><span class="op">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Remove&nbsp;removes&nbsp;the&nbsp;named&nbsp;file&nbsp;or&nbsp;directory.</span><br>
<span class="lineno">260</span><span class="comment">//&nbsp;If&nbsp;there&nbsp;is&nbsp;an&nbsp;error,&nbsp;it&nbsp;will&nbsp;be&nbsp;of&nbsp;type&nbsp;*PathError.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">Remove</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;System&nbsp;call&nbsp;interface&nbsp;forces&nbsp;us&nbsp;to&nbsp;know</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;whether&nbsp;name&nbsp;is&nbsp;a&nbsp;file&nbsp;or&nbsp;directory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Try&nbsp;both:&nbsp;it&nbsp;is&nbsp;cheaper&nbsp;on&nbsp;average&nbsp;than</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;doing&nbsp;a&nbsp;Stat&nbsp;plus&nbsp;the&nbsp;right&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Unlink</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Rmdir</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e1</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Both&nbsp;failed:&nbsp;figure&nbsp;out&nbsp;which&nbsp;error&nbsp;to&nbsp;return.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;OS&nbsp;X&nbsp;and&nbsp;Linux&nbsp;differ&nbsp;on&nbsp;whether&nbsp;unlink(dir)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;returns&nbsp;EISDIR,&nbsp;so&nbsp;can&#39;t&nbsp;use&nbsp;that.&nbsp;&nbsp;However,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;both&nbsp;agree&nbsp;that&nbsp;rmdir(file)&nbsp;returns&nbsp;ENOTDIR,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;that&nbsp;to&nbsp;decide&nbsp;which&nbsp;error&nbsp;is&nbsp;real.</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Rmdir&nbsp;might&nbsp;also&nbsp;return&nbsp;ENOTDIR&nbsp;if&nbsp;given&nbsp;a&nbsp;bad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;file&nbsp;path,&nbsp;like&nbsp;/etc/passwd/foo,&nbsp;but&nbsp;in&nbsp;that&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;both&nbsp;errors&nbsp;will&nbsp;be&nbsp;ENOTDIR,&nbsp;so&nbsp;it&#39;s&nbsp;okay&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;use&nbsp;the&nbsp;error&nbsp;from&nbsp;unlink.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e1</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">ENOTDIR</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">e1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">PathError</span><span class="op">{</span><span class="string">&#34;remove&#34;</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">e</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="comment">//&nbsp;basename&nbsp;removes&nbsp;trailing&nbsp;slashes&nbsp;and&nbsp;the&nbsp;leading&nbsp;directory&nbsp;name&nbsp;from&nbsp;path&nbsp;name</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">basename</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Remove&nbsp;trailing&nbsp;slashes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">name</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#39;/&#39;</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">--</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">name</span><span class="op">[</span><span class="op">:</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Remove&nbsp;leading&nbsp;directory&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">--</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">--</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">name</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#39;/&#39;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">name</span><span class="op">[</span><span class="ident">i</span><span class="op">+</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">name</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;TempDir&nbsp;returns&nbsp;the&nbsp;default&nbsp;directory&nbsp;to&nbsp;use&nbsp;for&nbsp;temporary&nbsp;files.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TempDir</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dir</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Getenv</span><span class="op">(</span><span class="string">&#34;TMPDIR&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">dir</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;android&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dir</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;/data/local/tmp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dir</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;/tmp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">dir</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Link&nbsp;creates&nbsp;newname&nbsp;as&nbsp;a&nbsp;hard&nbsp;link&nbsp;to&nbsp;the&nbsp;oldname&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;there&nbsp;is&nbsp;an&nbsp;error,&nbsp;it&nbsp;will&nbsp;be&nbsp;of&nbsp;type&nbsp;*LinkError.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">Link</span><span class="op">(</span><span class="ident">oldname</span><span class="op">,</span>&nbsp;<span class="ident">newname</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Link</span><span class="op">(</span><span class="ident">oldname</span><span class="op">,</span>&nbsp;<span class="ident">newname</span><span class="op">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">LinkError</span><span class="op">{</span><span class="string">&#34;link&#34;</span><span class="op">,</span>&nbsp;<span class="ident">oldname</span><span class="op">,</span>&nbsp;<span class="ident">newname</span><span class="op">,</span>&nbsp;<span class="ident">e</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Symlink&nbsp;creates&nbsp;newname&nbsp;as&nbsp;a&nbsp;symbolic&nbsp;link&nbsp;to&nbsp;oldname.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;there&nbsp;is&nbsp;an&nbsp;error,&nbsp;it&nbsp;will&nbsp;be&nbsp;of&nbsp;type&nbsp;*LinkError.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">Symlink</span><span class="op">(</span><span class="ident">oldname</span><span class="op">,</span>&nbsp;<span class="ident">newname</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Symlink</span><span class="op">(</span><span class="ident">oldname</span><span class="op">,</span>&nbsp;<span class="ident">newname</span><span class="op">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">LinkError</span><span class="op">{</span><span class="string">&#34;symlink&#34;</span><span class="op">,</span>&nbsp;<span class="ident">oldname</span><span class="op">,</span>&nbsp;<span class="ident">newname</span><span class="op">,</span>&nbsp;<span class="ident">e</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
