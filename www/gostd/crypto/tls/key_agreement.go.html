<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html" class="current">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4287866">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4287921">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4287975">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4288026">package</span>&nbsp;<span class="ident" id="4288034">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4288039">import</span>&nbsp;<span class="op" id="4288046">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4288049">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4288059">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4288075">&#34;crypto/elliptic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4288094">&#34;crypto/md5&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4288108">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4288122">&#34;crypto/sha1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4288137">&#34;crypto/sha256&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4288154">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4288169">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4288186">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4288196">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4288202">&#34;math/big&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4288213">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4288216">var</span>&nbsp;<span class="ident" id="4288220">errClientKeyExchange</span>&nbsp;<span class="op" id="4288241">=</span>&nbsp;<span class="ident" id="4288243">errors</span><span class="op" id="4288249">.</span><span class="ident" id="4288250">New</span><span class="op" id="4288253">(</span><span class="string" id="4288254">&#34;tls:&nbsp;invalid&nbsp;ClientKeyExchange&nbsp;message&#34;</span><span class="op" id="4288294">)</span><br>
<span class="lineno"></span><span class="keyword" id="4288296">var</span>&nbsp;<span class="ident" id="4288300">errServerKeyExchange</span>&nbsp;<span class="op" id="4288321">=</span>&nbsp;<span class="ident" id="4288323">errors</span><span class="op" id="4288329">.</span><span class="ident" id="4288330">New</span><span class="op" id="4288333">(</span><span class="string" id="4288334">&#34;tls:&nbsp;invalid&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="4288374">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4288377">//&nbsp;rsaKeyAgreement&nbsp;implements&nbsp;the&nbsp;standard&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="4288455">//&nbsp;encrypts&nbsp;the&nbsp;pre-master&nbsp;secret&nbsp;to&nbsp;the&nbsp;server&#39;s&nbsp;public&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="4288517">type</span>&nbsp;<span class="ident" id="4288522">rsaKeyAgreement</span>&nbsp;<span class="keyword" id="4288538">struct</span><span class="op" id="4288544">{</span><span class="op" id="4288545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4288548">func</span>&nbsp;<span class="op" id="4288553">(</span><span class="ident" id="4288554">ka</span>&nbsp;<span class="ident" id="4288557">rsaKeyAgreement</span><span class="op" id="4288572">)</span>&nbsp;<span class="ident" id="4288574">generateServerKeyExchange</span><span class="op" id="4288599">(</span><span class="ident" id="4288600">config</span>&nbsp;<span class="op" id="4288607">*</span><span class="ident" id="4288608">Config</span><span class="op" id="4288614">,</span>&nbsp;<span class="ident" id="4288616">cert</span>&nbsp;<span class="op" id="4288621">*</span><span class="ident" id="4288622">Certificate</span><span class="op" id="4288633">,</span>&nbsp;<span class="ident" id="4288635">clientHello</span>&nbsp;<span class="op" id="4288647">*</span><span class="ident" id="4288648">clientHelloMsg</span><span class="op" id="4288662">,</span>&nbsp;<span class="ident" id="4288664">hello</span>&nbsp;<span class="op" id="4288670">*</span><span class="ident" id="4288671">serverHelloMsg</span><span class="op" id="4288685">)</span>&nbsp;<span class="op" id="4288687">(</span><span class="op" id="4288688">*</span><span class="ident" id="4288689">serverKeyExchangeMsg</span><span class="op" id="4288709">,</span>&nbsp;<span class="builtintype" id="4288711">error</span><span class="op" id="4288716">)</span>&nbsp;<span class="op" id="4288718">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4288721">return</span>&nbsp;<span class="builtintype" id="4288728">nil</span><span class="op" id="4288731">,</span>&nbsp;<span class="builtintype" id="4288733">nil</span><br>
<span class="lineno"></span><span class="op" id="4288737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4288740">func</span>&nbsp;<span class="op" id="4288745">(</span><span class="ident" id="4288746">ka</span>&nbsp;<span class="ident" id="4288749">rsaKeyAgreement</span><span class="op" id="4288764">)</span>&nbsp;<span class="ident" id="4288766">processClientKeyExchange</span><span class="op" id="4288790">(</span><span class="ident" id="4288791">config</span>&nbsp;<span class="op" id="4288798">*</span><span class="ident" id="4288799">Config</span><span class="op" id="4288805">,</span>&nbsp;<span class="ident" id="4288807">cert</span>&nbsp;<span class="op" id="4288812">*</span><span class="ident" id="4288813">Certificate</span><span class="op" id="4288824">,</span>&nbsp;<span class="ident" id="4288826">ckx</span>&nbsp;<span class="op" id="4288830">*</span><span class="ident" id="4288831">clientKeyExchangeMsg</span><span class="op" id="4288851">,</span>&nbsp;<span class="ident" id="4288853">version</span>&nbsp;<span class="builtintype" id="4288861">uint16</span><span class="op" id="4288867">)</span>&nbsp;<span class="op" id="4288869">(</span><span class="op" id="4288870">[</span><span class="op" id="4288871">]</span><span class="builtintype" id="4288872">byte</span><span class="op" id="4288876">,</span>&nbsp;<span class="builtintype" id="4288878">error</span><span class="op" id="4288883">)</span>&nbsp;<span class="op" id="4288885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4288888">preMasterSecret</span>&nbsp;<span class="op" id="4288904">:=</span>&nbsp;<span class="builtinfunc" id="4288907">make</span><span class="op" id="4288911">(</span><span class="op" id="4288912">[</span><span class="op" id="4288913">]</span><span class="builtintype" id="4288914">byte</span><span class="op" id="4288918">,</span>&nbsp;<span class="num" id="4288920">48</span><span class="op" id="4288922">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4288925">_</span><span class="op" id="4288926">,</span>&nbsp;<span class="ident" id="4288928">err</span>&nbsp;<span class="op" id="4288932">:=</span>&nbsp;<span class="ident" id="4288935">io</span><span class="op" id="4288937">.</span><span class="ident" id="4288938">ReadFull</span><span class="op" id="4288946">(</span><span class="ident" id="4288947">config</span><span class="op" id="4288953">.</span><span class="ident" id="4288954">rand</span><span class="op" id="4288958">(</span><span class="op" id="4288959">)</span><span class="op" id="4288960">,</span>&nbsp;<span class="ident" id="4288962">preMasterSecret</span><span class="op" id="4288977">[</span><span class="num" id="4288978">2</span><span class="op" id="4288979">:</span><span class="op" id="4288980">]</span><span class="op" id="4288981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4288984">if</span>&nbsp;<span class="ident" id="4288987">err</span>&nbsp;<span class="op" id="4288991">!=</span>&nbsp;<span class="builtintype" id="4288994">nil</span>&nbsp;<span class="op" id="4288998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4289002">return</span>&nbsp;<span class="builtintype" id="4289009">nil</span><span class="op" id="4289012">,</span>&nbsp;<span class="ident" id="4289014">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4289019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4289023">if</span>&nbsp;<span class="builtinfunc" id="4289026">len</span><span class="op" id="4289029">(</span><span class="ident" id="4289030">ckx</span><span class="op" id="4289033">.</span><span class="ident" id="4289034">ciphertext</span><span class="op" id="4289044">)</span>&nbsp;<span class="op" id="4289046">&lt;</span>&nbsp;<span class="num" id="4289048">2</span>&nbsp;<span class="op" id="4289050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4289054">return</span>&nbsp;<span class="builtintype" id="4289061">nil</span><span class="op" id="4289064">,</span>&nbsp;<span class="ident" id="4289066">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4289088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4289092">ciphertext</span>&nbsp;<span class="op" id="4289103">:=</span>&nbsp;<span class="ident" id="4289106">ckx</span><span class="op" id="4289109">.</span><span class="ident" id="4289110">ciphertext</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4289122">if</span>&nbsp;<span class="ident" id="4289125">version</span>&nbsp;<span class="op" id="4289133">!=</span>&nbsp;<span class="ident" id="4289136">VersionSSL30</span>&nbsp;<span class="op" id="4289149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4289153">ciphertextLen</span>&nbsp;<span class="op" id="4289167">:=</span>&nbsp;<span class="builtintype" id="4289170">int</span><span class="op" id="4289173">(</span><span class="ident" id="4289174">ckx</span><span class="op" id="4289177">.</span><span class="ident" id="4289178">ciphertext</span><span class="op" id="4289188">[</span><span class="num" id="4289189">0</span><span class="op" id="4289190">]</span><span class="op" id="4289191">)</span><span class="op" id="4289192">&lt;&lt;</span><span class="num" id="4289194">8</span>&nbsp;<span class="op" id="4289196">|</span>&nbsp;<span class="builtintype" id="4289198">int</span><span class="op" id="4289201">(</span><span class="ident" id="4289202">ckx</span><span class="op" id="4289205">.</span><span class="ident" id="4289206">ciphertext</span><span class="op" id="4289216">[</span><span class="num" id="4289217">1</span><span class="op" id="4289218">]</span><span class="op" id="4289219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4289223">if</span>&nbsp;<span class="ident" id="4289226">ciphertextLen</span>&nbsp;<span class="op" id="4289240">!=</span>&nbsp;<span class="builtinfunc" id="4289243">len</span><span class="op" id="4289246">(</span><span class="ident" id="4289247">ckx</span><span class="op" id="4289250">.</span><span class="ident" id="4289251">ciphertext</span><span class="op" id="4289261">)</span><span class="op" id="4289262">-</span><span class="num" id="4289263">2</span>&nbsp;<span class="op" id="4289265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4289270">return</span>&nbsp;<span class="builtintype" id="4289277">nil</span><span class="op" id="4289280">,</span>&nbsp;<span class="ident" id="4289282">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4289305">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4289309">ciphertext</span>&nbsp;<span class="op" id="4289320">=</span>&nbsp;<span class="ident" id="4289322">ckx</span><span class="op" id="4289325">.</span><span class="ident" id="4289326">ciphertext</span><span class="op" id="4289336">[</span><span class="num" id="4289337">2</span><span class="op" id="4289338">:</span><span class="op" id="4289339">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4289342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4289346">err</span>&nbsp;<span class="op" id="4289350">=</span>&nbsp;<span class="ident" id="4289352">rsa</span><span class="op" id="4289355">.</span><span class="ident" id="4289356">DecryptPKCS1v15SessionKey</span><span class="op" id="4289381">(</span><span class="ident" id="4289382">config</span><span class="op" id="4289388">.</span><span class="ident" id="4289389">rand</span><span class="op" id="4289393">(</span><span class="op" id="4289394">)</span><span class="op" id="4289395">,</span>&nbsp;<span class="ident" id="4289397">cert</span><span class="op" id="4289401">.</span><span class="ident" id="4289402">PrivateKey</span><span class="op" id="4289412">.</span><span class="op" id="4289413">(</span><span class="op" id="4289414">*</span><span class="ident" id="4289415">rsa</span><span class="op" id="4289418">.</span><span class="ident" id="4289419">PrivateKey</span><span class="op" id="4289429">)</span><span class="op" id="4289430">,</span>&nbsp;<span class="ident" id="4289432">ciphertext</span><span class="op" id="4289442">,</span>&nbsp;<span class="ident" id="4289444">preMasterSecret</span><span class="op" id="4289459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4289462">if</span>&nbsp;<span class="ident" id="4289465">err</span>&nbsp;<span class="op" id="4289469">!=</span>&nbsp;<span class="builtintype" id="4289472">nil</span>&nbsp;<span class="op" id="4289476">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4289480">return</span>&nbsp;<span class="builtintype" id="4289487">nil</span><span class="op" id="4289490">,</span>&nbsp;<span class="ident" id="4289492">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4289497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4289500">//&nbsp;We&nbsp;don&#39;t&nbsp;check&nbsp;the&nbsp;version&nbsp;number&nbsp;in&nbsp;the&nbsp;premaster&nbsp;secret.&nbsp;&nbsp;For&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4289573">//&nbsp;by&nbsp;checking&nbsp;it,&nbsp;we&nbsp;would&nbsp;leak&nbsp;information&nbsp;about&nbsp;the&nbsp;validity&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4289645">//&nbsp;encrypted&nbsp;pre-master&nbsp;secret.&nbsp;Secondly,&nbsp;it&nbsp;provides&nbsp;only&nbsp;a&nbsp;small</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4289713">//&nbsp;benefit&nbsp;against&nbsp;a&nbsp;downgrade&nbsp;attack&nbsp;and&nbsp;some&nbsp;implementations&nbsp;send&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4289786">//&nbsp;wrong&nbsp;version&nbsp;anyway.&nbsp;See&nbsp;the&nbsp;discussion&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;section</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4289853">//&nbsp;7.4.7.1&nbsp;of&nbsp;RFC&nbsp;4346.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4289878">return</span>&nbsp;<span class="ident" id="4289885">preMasterSecret</span><span class="op" id="4289900">,</span>&nbsp;<span class="builtintype" id="4289902">nil</span><br>
<span class="lineno"></span><span class="op" id="4289906">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="4289909">func</span>&nbsp;<span class="op" id="4289914">(</span><span class="ident" id="4289915">ka</span>&nbsp;<span class="ident" id="4289918">rsaKeyAgreement</span><span class="op" id="4289933">)</span>&nbsp;<span class="ident" id="4289935">processServerKeyExchange</span><span class="op" id="4289959">(</span><span class="ident" id="4289960">config</span>&nbsp;<span class="op" id="4289967">*</span><span class="ident" id="4289968">Config</span><span class="op" id="4289974">,</span>&nbsp;<span class="ident" id="4289976">clientHello</span>&nbsp;<span class="op" id="4289988">*</span><span class="ident" id="4289989">clientHelloMsg</span><span class="op" id="4290003">,</span>&nbsp;<span class="ident" id="4290005">serverHello</span>&nbsp;<span class="op" id="4290017">*</span><span class="ident" id="4290018">serverHelloMsg</span><span class="op" id="4290032">,</span>&nbsp;<span class="ident" id="4290034">cert</span>&nbsp;<span class="op" id="4290039">*</span><span class="ident" id="4290040">x509</span><span class="op" id="4290044">.</span><span class="ident" id="4290045">Certificate</span><span class="op" id="4290056">,</span>&nbsp;<span class="ident" id="4290058">skx</span>&nbsp;<span class="op" id="4290062">*</span><span class="ident" id="4290063">serverKeyExchangeMsg</span><span class="op" id="4290083">)</span>&nbsp;<span class="builtintype" id="4290085">error</span>&nbsp;<span class="op" id="4290091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4290094">return</span>&nbsp;<span class="ident" id="4290101">errors</span><span class="op" id="4290107">.</span><span class="ident" id="4290108">New</span><span class="op" id="4290111">(</span><span class="string" id="4290112">&#34;tls:&nbsp;unexpected&nbsp;ServerKeyExchange&#34;</span><span class="op" id="4290147">)</span><br>
<span class="lineno"></span><span class="op" id="4290149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="4290152">func</span>&nbsp;<span class="op" id="4290157">(</span><span class="ident" id="4290158">ka</span>&nbsp;<span class="ident" id="4290161">rsaKeyAgreement</span><span class="op" id="4290176">)</span>&nbsp;<span class="ident" id="4290178">generateClientKeyExchange</span><span class="op" id="4290203">(</span><span class="ident" id="4290204">config</span>&nbsp;<span class="op" id="4290211">*</span><span class="ident" id="4290212">Config</span><span class="op" id="4290218">,</span>&nbsp;<span class="ident" id="4290220">clientHello</span>&nbsp;<span class="op" id="4290232">*</span><span class="ident" id="4290233">clientHelloMsg</span><span class="op" id="4290247">,</span>&nbsp;<span class="ident" id="4290249">cert</span>&nbsp;<span class="op" id="4290254">*</span><span class="ident" id="4290255">x509</span><span class="op" id="4290259">.</span><span class="ident" id="4290260">Certificate</span><span class="op" id="4290271">)</span>&nbsp;<span class="op" id="4290273">(</span><span class="op" id="4290274">[</span><span class="op" id="4290275">]</span><span class="builtintype" id="4290276">byte</span><span class="op" id="4290280">,</span>&nbsp;<span class="op" id="4290282">*</span><span class="ident" id="4290283">clientKeyExchangeMsg</span><span class="op" id="4290303">,</span>&nbsp;<span class="builtintype" id="4290305">error</span><span class="op" id="4290310">)</span>&nbsp;<span class="op" id="4290312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4290315">preMasterSecret</span>&nbsp;<span class="op" id="4290331">:=</span>&nbsp;<span class="builtinfunc" id="4290334">make</span><span class="op" id="4290338">(</span><span class="op" id="4290339">[</span><span class="op" id="4290340">]</span><span class="builtintype" id="4290341">byte</span><span class="op" id="4290345">,</span>&nbsp;<span class="num" id="4290347">48</span><span class="op" id="4290349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4290352">preMasterSecret</span><span class="op" id="4290367">[</span><span class="num" id="4290368">0</span><span class="op" id="4290369">]</span>&nbsp;<span class="op" id="4290371">=</span>&nbsp;<span class="builtintype" id="4290373">byte</span><span class="op" id="4290377">(</span><span class="ident" id="4290378">clientHello</span><span class="op" id="4290389">.</span><span class="ident" id="4290390">vers</span>&nbsp;<span class="op" id="4290395">&gt;&gt;</span>&nbsp;<span class="num" id="4290398">8</span><span class="op" id="4290399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4290402">preMasterSecret</span><span class="op" id="4290417">[</span><span class="num" id="4290418">1</span><span class="op" id="4290419">]</span>&nbsp;<span class="op" id="4290421">=</span>&nbsp;<span class="builtintype" id="4290423">byte</span><span class="op" id="4290427">(</span><span class="ident" id="4290428">clientHello</span><span class="op" id="4290439">.</span><span class="ident" id="4290440">vers</span><span class="op" id="4290444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4290447">_</span><span class="op" id="4290448">,</span>&nbsp;<span class="ident" id="4290450">err</span>&nbsp;<span class="op" id="4290454">:=</span>&nbsp;<span class="ident" id="4290457">io</span><span class="op" id="4290459">.</span><span class="ident" id="4290460">ReadFull</span><span class="op" id="4290468">(</span><span class="ident" id="4290469">config</span><span class="op" id="4290475">.</span><span class="ident" id="4290476">rand</span><span class="op" id="4290480">(</span><span class="op" id="4290481">)</span><span class="op" id="4290482">,</span>&nbsp;<span class="ident" id="4290484">preMasterSecret</span><span class="op" id="4290499">[</span><span class="num" id="4290500">2</span><span class="op" id="4290501">:</span><span class="op" id="4290502">]</span><span class="op" id="4290503">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4290506">if</span>&nbsp;<span class="ident" id="4290509">err</span>&nbsp;<span class="op" id="4290513">!=</span>&nbsp;<span class="builtintype" id="4290516">nil</span>&nbsp;<span class="op" id="4290520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4290524">return</span>&nbsp;<span class="builtintype" id="4290531">nil</span><span class="op" id="4290534">,</span>&nbsp;<span class="builtintype" id="4290536">nil</span><span class="op" id="4290539">,</span>&nbsp;<span class="ident" id="4290541">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4290546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4290550">encrypted</span><span class="op" id="4290559">,</span>&nbsp;<span class="ident" id="4290561">err</span>&nbsp;<span class="op" id="4290565">:=</span>&nbsp;<span class="ident" id="4290568">rsa</span><span class="op" id="4290571">.</span><span class="ident" id="4290572">EncryptPKCS1v15</span><span class="op" id="4290587">(</span><span class="ident" id="4290588">config</span><span class="op" id="4290594">.</span><span class="ident" id="4290595">rand</span><span class="op" id="4290599">(</span><span class="op" id="4290600">)</span><span class="op" id="4290601">,</span>&nbsp;<span class="ident" id="4290603">cert</span><span class="op" id="4290607">.</span><span class="ident" id="4290608">PublicKey</span><span class="op" id="4290617">.</span><span class="op" id="4290618">(</span><span class="op" id="4290619">*</span><span class="ident" id="4290620">rsa</span><span class="op" id="4290623">.</span><span class="ident" id="4290624">PublicKey</span><span class="op" id="4290633">)</span><span class="op" id="4290634">,</span>&nbsp;<span class="ident" id="4290636">preMasterSecret</span><span class="op" id="4290651">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4290654">if</span>&nbsp;<span class="ident" id="4290657">err</span>&nbsp;<span class="op" id="4290661">!=</span>&nbsp;<span class="builtintype" id="4290664">nil</span>&nbsp;<span class="op" id="4290668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4290672">return</span>&nbsp;<span class="builtintype" id="4290679">nil</span><span class="op" id="4290682">,</span>&nbsp;<span class="builtintype" id="4290684">nil</span><span class="op" id="4290687">,</span>&nbsp;<span class="ident" id="4290689">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4290694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4290697">ckx</span>&nbsp;<span class="op" id="4290701">:=</span>&nbsp;<span class="builtinfunc" id="4290704">new</span><span class="op" id="4290707">(</span><span class="ident" id="4290708">clientKeyExchangeMsg</span><span class="op" id="4290728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4290731">ckx</span><span class="op" id="4290734">.</span><span class="ident" id="4290735">ciphertext</span>&nbsp;<span class="op" id="4290746">=</span>&nbsp;<span class="builtinfunc" id="4290748">make</span><span class="op" id="4290752">(</span><span class="op" id="4290753">[</span><span class="op" id="4290754">]</span><span class="builtintype" id="4290755">byte</span><span class="op" id="4290759">,</span>&nbsp;<span class="builtinfunc" id="4290761">len</span><span class="op" id="4290764">(</span><span class="ident" id="4290765">encrypted</span><span class="op" id="4290774">)</span><span class="op" id="4290775">+</span><span class="num" id="4290776">2</span><span class="op" id="4290777">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4290780">ckx</span><span class="op" id="4290783">.</span><span class="ident" id="4290784">ciphertext</span><span class="op" id="4290794">[</span><span class="num" id="4290795">0</span><span class="op" id="4290796">]</span>&nbsp;<span class="op" id="4290798">=</span>&nbsp;<span class="builtintype" id="4290800">byte</span><span class="op" id="4290804">(</span><span class="builtinfunc" id="4290805">len</span><span class="op" id="4290808">(</span><span class="ident" id="4290809">encrypted</span><span class="op" id="4290818">)</span>&nbsp;<span class="op" id="4290820">&gt;&gt;</span>&nbsp;<span class="num" id="4290823">8</span><span class="op" id="4290824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4290827">ckx</span><span class="op" id="4290830">.</span><span class="ident" id="4290831">ciphertext</span><span class="op" id="4290841">[</span><span class="num" id="4290842">1</span><span class="op" id="4290843">]</span>&nbsp;<span class="op" id="4290845">=</span>&nbsp;<span class="builtintype" id="4290847">byte</span><span class="op" id="4290851">(</span><span class="builtinfunc" id="4290852">len</span><span class="op" id="4290855">(</span><span class="ident" id="4290856">encrypted</span><span class="op" id="4290865">)</span><span class="op" id="4290866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4290869">copy</span><span class="op" id="4290873">(</span><span class="ident" id="4290874">ckx</span><span class="op" id="4290877">.</span><span class="ident" id="4290878">ciphertext</span><span class="op" id="4290888">[</span><span class="num" id="4290889">2</span><span class="op" id="4290890">:</span><span class="op" id="4290891">]</span><span class="op" id="4290892">,</span>&nbsp;<span class="ident" id="4290894">encrypted</span><span class="op" id="4290903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4290906">return</span>&nbsp;<span class="ident" id="4290913">preMasterSecret</span><span class="op" id="4290928">,</span>&nbsp;<span class="ident" id="4290930">ckx</span><span class="op" id="4290933">,</span>&nbsp;<span class="builtintype" id="4290935">nil</span><br>
<span class="lineno"></span><span class="op" id="4290939">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4290942">//&nbsp;sha1Hash&nbsp;calculates&nbsp;a&nbsp;SHA1&nbsp;hash&nbsp;over&nbsp;the&nbsp;given&nbsp;byte&nbsp;slices.</span><br>
<span class="lineno"></span><span class="keyword" id="4291005">func</span>&nbsp;<span class="ident" id="4291010">sha1Hash</span><span class="op" id="4291018">(</span><span class="ident" id="4291019">slices</span>&nbsp;<span class="op" id="4291026">[</span><span class="op" id="4291027">]</span><span class="op" id="4291028">[</span><span class="op" id="4291029">]</span><span class="builtintype" id="4291030">byte</span><span class="op" id="4291034">)</span>&nbsp;<span class="op" id="4291036">[</span><span class="op" id="4291037">]</span><span class="builtintype" id="4291038">byte</span>&nbsp;<span class="op" id="4291043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4291046">hsha1</span>&nbsp;<span class="op" id="4291052">:=</span>&nbsp;<span class="ident" id="4291055">sha1</span><span class="op" id="4291059">.</span><span class="ident" id="4291060">New</span><span class="op" id="4291063">(</span><span class="op" id="4291064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4291067">for</span>&nbsp;<span class="ident" id="4291071">_</span><span class="op" id="4291072">,</span>&nbsp;<span class="ident" id="4291074">slice</span>&nbsp;<span class="op" id="4291080">:=</span>&nbsp;<span class="keyword" id="4291083">range</span>&nbsp;<span class="ident" id="4291089">slices</span>&nbsp;<span class="op" id="4291096">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4291100">hsha1</span><span class="op" id="4291105">.</span><span class="ident" id="4291106">Write</span><span class="op" id="4291111">(</span><span class="ident" id="4291112">slice</span><span class="op" id="4291117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4291120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4291123">return</span>&nbsp;<span class="ident" id="4291130">hsha1</span><span class="op" id="4291135">.</span><span class="ident" id="4291136">Sum</span><span class="op" id="4291139">(</span><span class="builtintype" id="4291140">nil</span><span class="op" id="4291143">)</span><br>
<span class="lineno"></span><span class="op" id="4291145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="4291148">//&nbsp;md5SHA1Hash&nbsp;implements&nbsp;TLS&nbsp;1.0&#39;s&nbsp;hybrid&nbsp;hash&nbsp;function&nbsp;which&nbsp;consists&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4291227">//&nbsp;concatenation&nbsp;of&nbsp;an&nbsp;MD5&nbsp;and&nbsp;SHA1&nbsp;hash.</span><br>
<span class="lineno"></span><span class="keyword" id="4291269">func</span>&nbsp;<span class="ident" id="4291274">md5SHA1Hash</span><span class="op" id="4291285">(</span><span class="ident" id="4291286">slices</span>&nbsp;<span class="op" id="4291293">[</span><span class="op" id="4291294">]</span><span class="op" id="4291295">[</span><span class="op" id="4291296">]</span><span class="builtintype" id="4291297">byte</span><span class="op" id="4291301">)</span>&nbsp;<span class="op" id="4291303">[</span><span class="op" id="4291304">]</span><span class="builtintype" id="4291305">byte</span>&nbsp;<span class="op" id="4291310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4291313">md5sha1</span>&nbsp;<span class="op" id="4291321">:=</span>&nbsp;<span class="builtinfunc" id="4291324">make</span><span class="op" id="4291328">(</span><span class="op" id="4291329">[</span><span class="op" id="4291330">]</span><span class="builtintype" id="4291331">byte</span><span class="op" id="4291335">,</span>&nbsp;<span class="ident" id="4291337">md5</span><span class="op" id="4291340">.</span><span class="ident" id="4291341">Size</span><span class="op" id="4291345">+</span><span class="ident" id="4291346">sha1</span><span class="op" id="4291350">.</span><span class="ident" id="4291351">Size</span><span class="op" id="4291355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4291358">hmd5</span>&nbsp;<span class="op" id="4291363">:=</span>&nbsp;<span class="ident" id="4291366">md5</span><span class="op" id="4291369">.</span><span class="ident" id="4291370">New</span><span class="op" id="4291373">(</span><span class="op" id="4291374">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4291377">for</span>&nbsp;<span class="ident" id="4291381">_</span><span class="op" id="4291382">,</span>&nbsp;<span class="ident" id="4291384">slice</span>&nbsp;<span class="op" id="4291390">:=</span>&nbsp;<span class="keyword" id="4291393">range</span>&nbsp;<span class="ident" id="4291399">slices</span>&nbsp;<span class="op" id="4291406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4291410">hmd5</span><span class="op" id="4291414">.</span><span class="ident" id="4291415">Write</span><span class="op" id="4291420">(</span><span class="ident" id="4291421">slice</span><span class="op" id="4291426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4291429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4291432">copy</span><span class="op" id="4291436">(</span><span class="ident" id="4291437">md5sha1</span><span class="op" id="4291444">,</span>&nbsp;<span class="ident" id="4291446">hmd5</span><span class="op" id="4291450">.</span><span class="ident" id="4291451">Sum</span><span class="op" id="4291454">(</span><span class="builtintype" id="4291455">nil</span><span class="op" id="4291458">)</span><span class="op" id="4291459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4291462">copy</span><span class="op" id="4291466">(</span><span class="ident" id="4291467">md5sha1</span><span class="op" id="4291474">[</span><span class="ident" id="4291475">md5</span><span class="op" id="4291478">.</span><span class="ident" id="4291479">Size</span><span class="op" id="4291483">:</span><span class="op" id="4291484">]</span><span class="op" id="4291485">,</span>&nbsp;<span class="ident" id="4291487">sha1Hash</span><span class="op" id="4291495">(</span><span class="ident" id="4291496">slices</span><span class="op" id="4291502">)</span><span class="op" id="4291503">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4291506">return</span>&nbsp;<span class="ident" id="4291513">md5sha1</span><br>
<span class="lineno"></span><span class="op" id="4291521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4291524">//&nbsp;sha256Hash&nbsp;implements&nbsp;TLS&nbsp;1.2&#39;s&nbsp;hash&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="4291574">func</span>&nbsp;<span class="ident" id="4291579">sha256Hash</span><span class="op" id="4291589">(</span><span class="ident" id="4291590">slices</span>&nbsp;<span class="op" id="4291597">[</span><span class="op" id="4291598">]</span><span class="op" id="4291599">[</span><span class="op" id="4291600">]</span><span class="builtintype" id="4291601">byte</span><span class="op" id="4291605">)</span>&nbsp;<span class="op" id="4291607">[</span><span class="op" id="4291608">]</span><span class="builtintype" id="4291609">byte</span>&nbsp;<span class="op" id="4291614">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4291617">h</span>&nbsp;<span class="op" id="4291619">:=</span>&nbsp;<span class="ident" id="4291622">sha256</span><span class="op" id="4291628">.</span><span class="ident" id="4291629">New</span><span class="op" id="4291632">(</span><span class="op" id="4291633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4291636">for</span>&nbsp;<span class="ident" id="4291640">_</span><span class="op" id="4291641">,</span>&nbsp;<span class="ident" id="4291643">slice</span>&nbsp;<span class="op" id="4291649">:=</span>&nbsp;<span class="keyword" id="4291652">range</span>&nbsp;<span class="ident" id="4291658">slices</span>&nbsp;<span class="op" id="4291665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4291669">h</span><span class="op" id="4291670">.</span><span class="ident" id="4291671">Write</span><span class="op" id="4291676">(</span><span class="ident" id="4291677">slice</span><span class="op" id="4291682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4291685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4291688">return</span>&nbsp;<span class="ident" id="4291695">h</span><span class="op" id="4291696">.</span><span class="ident" id="4291697">Sum</span><span class="op" id="4291700">(</span><span class="builtintype" id="4291701">nil</span><span class="op" id="4291704">)</span><br>
<span class="lineno">120</span><span class="op" id="4291706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4291709">//&nbsp;hashForServerKeyExchange&nbsp;hashes&nbsp;the&nbsp;given&nbsp;slices&nbsp;and&nbsp;returns&nbsp;their&nbsp;digest</span><br>
<span class="lineno"></span><span class="comment" id="4291786">//&nbsp;and&nbsp;the&nbsp;identifier&nbsp;of&nbsp;the&nbsp;hash&nbsp;function&nbsp;used.&nbsp;The&nbsp;hashFunc&nbsp;argument&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="4291865">//&nbsp;used&nbsp;for&nbsp;&gt;=&nbsp;TLS&nbsp;1.2&nbsp;and&nbsp;precisely&nbsp;identifies&nbsp;the&nbsp;hash&nbsp;function&nbsp;to&nbsp;use.</span><br>
<span class="lineno">125</span><span class="keyword" id="4291939">func</span>&nbsp;<span class="ident" id="4291944">hashForServerKeyExchange</span><span class="op" id="4291968">(</span><span class="ident" id="4291969">sigType</span><span class="op" id="4291976">,</span>&nbsp;<span class="ident" id="4291978">hashFunc</span>&nbsp;<span class="builtintype" id="4291987">uint8</span><span class="op" id="4291992">,</span>&nbsp;<span class="ident" id="4291994">version</span>&nbsp;<span class="builtintype" id="4292002">uint16</span><span class="op" id="4292008">,</span>&nbsp;<span class="ident" id="4292010">slices</span>&nbsp;<span class="op" id="4292017">...</span><span class="op" id="4292020">[</span><span class="op" id="4292021">]</span><span class="builtintype" id="4292022">byte</span><span class="op" id="4292026">)</span>&nbsp;<span class="op" id="4292028">(</span><span class="op" id="4292029">[</span><span class="op" id="4292030">]</span><span class="builtintype" id="4292031">byte</span><span class="op" id="4292035">,</span>&nbsp;<span class="ident" id="4292037">crypto</span><span class="op" id="4292043">.</span><span class="ident" id="4292044">Hash</span><span class="op" id="4292048">,</span>&nbsp;<span class="builtintype" id="4292050">error</span><span class="op" id="4292055">)</span>&nbsp;<span class="op" id="4292057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4292060">if</span>&nbsp;<span class="ident" id="4292063">version</span>&nbsp;<span class="op" id="4292071">&gt;=</span>&nbsp;<span class="ident" id="4292074">VersionTLS12</span>&nbsp;<span class="op" id="4292087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4292091">switch</span>&nbsp;<span class="ident" id="4292098">hashFunc</span>&nbsp;<span class="op" id="4292107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4292111">case</span>&nbsp;<span class="ident" id="4292116">hashSHA256</span><span class="op" id="4292126">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4292131">return</span>&nbsp;<span class="ident" id="4292138">sha256Hash</span><span class="op" id="4292148">(</span><span class="ident" id="4292149">slices</span><span class="op" id="4292155">)</span><span class="op" id="4292156">,</span>&nbsp;<span class="ident" id="4292158">crypto</span><span class="op" id="4292164">.</span><span class="ident" id="4292165">SHA256</span><span class="op" id="4292171">,</span>&nbsp;<span class="builtintype" id="4292173">nil</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4292179">case</span>&nbsp;<span class="ident" id="4292184">hashSHA1</span><span class="op" id="4292192">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4292197">return</span>&nbsp;<span class="ident" id="4292204">sha1Hash</span><span class="op" id="4292212">(</span><span class="ident" id="4292213">slices</span><span class="op" id="4292219">)</span><span class="op" id="4292220">,</span>&nbsp;<span class="ident" id="4292222">crypto</span><span class="op" id="4292228">.</span><span class="ident" id="4292229">SHA1</span><span class="op" id="4292233">,</span>&nbsp;<span class="builtintype" id="4292235">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4292241">default</span><span class="op" id="4292248">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4292253">return</span>&nbsp;<span class="builtintype" id="4292260">nil</span><span class="op" id="4292263">,</span>&nbsp;<span class="ident" id="4292265">crypto</span><span class="op" id="4292271">.</span><span class="ident" id="4292272">Hash</span><span class="op" id="4292276">(</span><span class="num" id="4292277">0</span><span class="op" id="4292278">)</span><span class="op" id="4292279">,</span>&nbsp;<span class="ident" id="4292281">errors</span><span class="op" id="4292287">.</span><span class="ident" id="4292288">New</span><span class="op" id="4292291">(</span><span class="string" id="4292292">&#34;tls:&nbsp;unknown&nbsp;hash&nbsp;function&nbsp;used&nbsp;by&nbsp;peer&#34;</span><span class="op" id="4292333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4292337">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4292340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4292343">if</span>&nbsp;<span class="ident" id="4292346">sigType</span>&nbsp;<span class="op" id="4292354">==</span>&nbsp;<span class="ident" id="4292357">signatureECDSA</span>&nbsp;<span class="op" id="4292372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4292376">return</span>&nbsp;<span class="ident" id="4292383">sha1Hash</span><span class="op" id="4292391">(</span><span class="ident" id="4292392">slices</span><span class="op" id="4292398">)</span><span class="op" id="4292399">,</span>&nbsp;<span class="ident" id="4292401">crypto</span><span class="op" id="4292407">.</span><span class="ident" id="4292408">SHA1</span><span class="op" id="4292412">,</span>&nbsp;<span class="builtintype" id="4292414">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4292419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4292422">return</span>&nbsp;<span class="ident" id="4292429">md5SHA1Hash</span><span class="op" id="4292440">(</span><span class="ident" id="4292441">slices</span><span class="op" id="4292447">)</span><span class="op" id="4292448">,</span>&nbsp;<span class="ident" id="4292450">crypto</span><span class="op" id="4292456">.</span><span class="ident" id="4292457">MD5SHA1</span><span class="op" id="4292464">,</span>&nbsp;<span class="builtintype" id="4292466">nil</span><br>
<span class="lineno">140</span><span class="op" id="4292470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4292473">//&nbsp;pickTLS12HashForSignature&nbsp;returns&nbsp;a&nbsp;TLS&nbsp;1.2&nbsp;hash&nbsp;identifier&nbsp;for&nbsp;signing&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4292550">//&nbsp;ServerKeyExchange&nbsp;given&nbsp;the&nbsp;signature&nbsp;type&nbsp;being&nbsp;used&nbsp;and&nbsp;the&nbsp;client&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4292624">//&nbsp;advertised&nbsp;list&nbsp;of&nbsp;supported&nbsp;signature&nbsp;and&nbsp;hash&nbsp;combinations.</span><br>
<span class="lineno">145</span><span class="keyword" id="4292689">func</span>&nbsp;<span class="ident" id="4292694">pickTLS12HashForSignature</span><span class="op" id="4292719">(</span><span class="ident" id="4292720">sigType</span>&nbsp;<span class="builtintype" id="4292728">uint8</span><span class="op" id="4292733">,</span>&nbsp;<span class="ident" id="4292735">clientSignatureAndHashes</span>&nbsp;<span class="op" id="4292760">[</span><span class="op" id="4292761">]</span><span class="ident" id="4292762">signatureAndHash</span><span class="op" id="4292778">)</span>&nbsp;<span class="op" id="4292780">(</span><span class="builtintype" id="4292781">uint8</span><span class="op" id="4292786">,</span>&nbsp;<span class="builtintype" id="4292788">error</span><span class="op" id="4292793">)</span>&nbsp;<span class="op" id="4292795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4292798">if</span>&nbsp;<span class="builtinfunc" id="4292801">len</span><span class="op" id="4292804">(</span><span class="ident" id="4292805">clientSignatureAndHashes</span><span class="op" id="4292829">)</span>&nbsp;<span class="op" id="4292831">==</span>&nbsp;<span class="num" id="4292834">0</span>&nbsp;<span class="op" id="4292836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4292840">//&nbsp;If&nbsp;the&nbsp;client&nbsp;didn&#39;t&nbsp;specify&nbsp;any&nbsp;signature_algorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4292899">//&nbsp;extension&nbsp;then&nbsp;we&nbsp;can&nbsp;assume&nbsp;that&nbsp;it&nbsp;supports&nbsp;SHA1.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4292960">//&nbsp;http://tools.ietf.org/html/rfc5246#section-7.4.1.4.1</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293018">return</span>&nbsp;<span class="ident" id="4293025">hashSHA1</span><span class="op" id="4293033">,</span>&nbsp;<span class="builtintype" id="4293035">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4293040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293044">for</span>&nbsp;<span class="ident" id="4293048">_</span><span class="op" id="4293049">,</span>&nbsp;<span class="ident" id="4293051">sigAndHash</span>&nbsp;<span class="op" id="4293062">:=</span>&nbsp;<span class="keyword" id="4293065">range</span>&nbsp;<span class="ident" id="4293071">clientSignatureAndHashes</span>&nbsp;<span class="op" id="4293096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293100">if</span>&nbsp;<span class="ident" id="4293103">sigAndHash</span><span class="op" id="4293113">.</span><span class="ident" id="4293114">signature</span>&nbsp;<span class="op" id="4293124">!=</span>&nbsp;<span class="ident" id="4293127">sigType</span>&nbsp;<span class="op" id="4293135">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293140">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4293151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293155">switch</span>&nbsp;<span class="ident" id="4293162">sigAndHash</span><span class="op" id="4293172">.</span><span class="ident" id="4293173">hash</span>&nbsp;<span class="op" id="4293178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293182">case</span>&nbsp;<span class="ident" id="4293187">hashSHA1</span><span class="op" id="4293195">,</span>&nbsp;<span class="ident" id="4293197">hashSHA256</span><span class="op" id="4293207">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293212">return</span>&nbsp;<span class="ident" id="4293219">sigAndHash</span><span class="op" id="4293229">.</span><span class="ident" id="4293230">hash</span><span class="op" id="4293234">,</span>&nbsp;<span class="builtintype" id="4293236">nil</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4293242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4293245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293249">return</span>&nbsp;<span class="num" id="4293256">0</span><span class="op" id="4293257">,</span>&nbsp;<span class="ident" id="4293259">errors</span><span class="op" id="4293265">.</span><span class="ident" id="4293266">New</span><span class="op" id="4293269">(</span><span class="string" id="4293270">&#34;tls:&nbsp;client&nbsp;doesn&#39;t&nbsp;support&nbsp;any&nbsp;common&nbsp;hash&nbsp;functions&#34;</span><span class="op" id="4293325">)</span><br>
<span class="lineno"></span><span class="op" id="4293327">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="4293330">func</span>&nbsp;<span class="ident" id="4293335">curveForCurveID</span><span class="op" id="4293350">(</span><span class="ident" id="4293351">id</span>&nbsp;<span class="ident" id="4293354">CurveID</span><span class="op" id="4293361">)</span>&nbsp;<span class="op" id="4293363">(</span><span class="ident" id="4293364">elliptic</span><span class="op" id="4293372">.</span><span class="ident" id="4293373">Curve</span><span class="op" id="4293378">,</span>&nbsp;<span class="builtintype" id="4293380">bool</span><span class="op" id="4293384">)</span>&nbsp;<span class="op" id="4293386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293389">switch</span>&nbsp;<span class="ident" id="4293396">id</span>&nbsp;<span class="op" id="4293399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293402">case</span>&nbsp;<span class="ident" id="4293407">CurveP256</span><span class="op" id="4293416">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293420">return</span>&nbsp;<span class="ident" id="4293427">elliptic</span><span class="op" id="4293435">.</span><span class="ident" id="4293436">P256</span><span class="op" id="4293440">(</span><span class="op" id="4293441">)</span><span class="op" id="4293442">,</span>&nbsp;<span class="builtintype" id="4293444">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293450">case</span>&nbsp;<span class="ident" id="4293455">CurveP384</span><span class="op" id="4293464">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293468">return</span>&nbsp;<span class="ident" id="4293475">elliptic</span><span class="op" id="4293483">.</span><span class="ident" id="4293484">P384</span><span class="op" id="4293488">(</span><span class="op" id="4293489">)</span><span class="op" id="4293490">,</span>&nbsp;<span class="builtintype" id="4293492">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293498">case</span>&nbsp;<span class="ident" id="4293503">CurveP521</span><span class="op" id="4293512">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293516">return</span>&nbsp;<span class="ident" id="4293523">elliptic</span><span class="op" id="4293531">.</span><span class="ident" id="4293532">P521</span><span class="op" id="4293536">(</span><span class="op" id="4293537">)</span><span class="op" id="4293538">,</span>&nbsp;<span class="builtintype" id="4293540">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293546">default</span><span class="op" id="4293553">:</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4293557">return</span>&nbsp;<span class="builtintype" id="4293564">nil</span><span class="op" id="4293567">,</span>&nbsp;<span class="builtintype" id="4293569">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4293576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="4293579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="comment" id="4293582">//&nbsp;ecdheRSAKeyAgreement&nbsp;implements&nbsp;a&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="4293654">//&nbsp;generates&nbsp;a&nbsp;ephemeral&nbsp;EC&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;and&nbsp;signs&nbsp;it.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="4293724">//&nbsp;pre-master&nbsp;secret&nbsp;is&nbsp;then&nbsp;calculated&nbsp;using&nbsp;ECDH.&nbsp;The&nbsp;signature&nbsp;may</span><br>
<span class="lineno"></span><span class="comment" id="4293794">//&nbsp;either&nbsp;be&nbsp;ECDSA&nbsp;or&nbsp;RSA.</span><br>
<span class="lineno"></span><span class="keyword" id="4293821">type</span>&nbsp;<span class="ident" id="4293826">ecdheKeyAgreement</span>&nbsp;<span class="keyword" id="4293844">struct</span>&nbsp;<span class="op" id="4293851">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4293854">version</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4293865">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4293873">sigType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4293884">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4293891">privateKey</span>&nbsp;<span class="op" id="4293902">[</span><span class="op" id="4293903">]</span><span class="builtintype" id="4293904">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4293910">curve</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4293921">elliptic</span><span class="op" id="4293929">.</span><span class="ident" id="4293930">Curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4293937">x</span><span class="op" id="4293938">,</span>&nbsp;<span class="ident" id="4293940">y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4293948">*</span><span class="ident" id="4293949">big</span><span class="op" id="4293952">.</span><span class="ident" id="4293953">Int</span><br>
<span class="lineno">190</span><span class="op" id="4293957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4293960">func</span>&nbsp;<span class="op" id="4293965">(</span><span class="ident" id="4293966">ka</span>&nbsp;<span class="op" id="4293969">*</span><span class="ident" id="4293970">ecdheKeyAgreement</span><span class="op" id="4293987">)</span>&nbsp;<span class="ident" id="4293989">generateServerKeyExchange</span><span class="op" id="4294014">(</span><span class="ident" id="4294015">config</span>&nbsp;<span class="op" id="4294022">*</span><span class="ident" id="4294023">Config</span><span class="op" id="4294029">,</span>&nbsp;<span class="ident" id="4294031">cert</span>&nbsp;<span class="op" id="4294036">*</span><span class="ident" id="4294037">Certificate</span><span class="op" id="4294048">,</span>&nbsp;<span class="ident" id="4294050">clientHello</span>&nbsp;<span class="op" id="4294062">*</span><span class="ident" id="4294063">clientHelloMsg</span><span class="op" id="4294077">,</span>&nbsp;<span class="ident" id="4294079">hello</span>&nbsp;<span class="op" id="4294085">*</span><span class="ident" id="4294086">serverHelloMsg</span><span class="op" id="4294100">)</span>&nbsp;<span class="op" id="4294102">(</span><span class="op" id="4294103">*</span><span class="ident" id="4294104">serverKeyExchangeMsg</span><span class="op" id="4294124">,</span>&nbsp;<span class="builtintype" id="4294126">error</span><span class="op" id="4294131">)</span>&nbsp;<span class="op" id="4294133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4294136">var</span>&nbsp;<span class="ident" id="4294140">curveid</span>&nbsp;<span class="ident" id="4294148">CurveID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4294157">preferredCurves</span>&nbsp;<span class="op" id="4294173">:=</span>&nbsp;<span class="ident" id="4294176">config</span><span class="op" id="4294182">.</span><span class="ident" id="4294183">curvePreferences</span><span class="op" id="4294199">(</span><span class="op" id="4294200">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="ident" id="4294203">NextCandidate</span><span class="op" id="4294216">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4294219">for</span>&nbsp;<span class="ident" id="4294223">_</span><span class="op" id="4294224">,</span>&nbsp;<span class="ident" id="4294226">candidate</span>&nbsp;<span class="op" id="4294236">:=</span>&nbsp;<span class="keyword" id="4294239">range</span>&nbsp;<span class="ident" id="4294245">preferredCurves</span>&nbsp;<span class="op" id="4294261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4294265">for</span>&nbsp;<span class="ident" id="4294269">_</span><span class="op" id="4294270">,</span>&nbsp;<span class="ident" id="4294272">c</span>&nbsp;<span class="op" id="4294274">:=</span>&nbsp;<span class="keyword" id="4294277">range</span>&nbsp;<span class="ident" id="4294283">clientHello</span><span class="op" id="4294294">.</span><span class="ident" id="4294295">supportedCurves</span>&nbsp;<span class="op" id="4294311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4294316">if</span>&nbsp;<span class="ident" id="4294319">candidate</span>&nbsp;<span class="op" id="4294329">==</span>&nbsp;<span class="ident" id="4294332">c</span>&nbsp;<span class="op" id="4294334">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4294340">curveid</span>&nbsp;<span class="op" id="4294348">=</span>&nbsp;<span class="ident" id="4294350">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4294356">break</span>&nbsp;<span class="ident" id="4294362">NextCandidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4294379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4294383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4294386">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4294390">if</span>&nbsp;<span class="ident" id="4294393">curveid</span>&nbsp;<span class="op" id="4294401">==</span>&nbsp;<span class="num" id="4294404">0</span>&nbsp;<span class="op" id="4294406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4294410">return</span>&nbsp;<span class="builtintype" id="4294417">nil</span><span class="op" id="4294420">,</span>&nbsp;<span class="ident" id="4294422">errors</span><span class="op" id="4294428">.</span><span class="ident" id="4294429">New</span><span class="op" id="4294432">(</span><span class="string" id="4294433">&#34;tls:&nbsp;no&nbsp;supported&nbsp;elliptic&nbsp;curves&nbsp;offered&#34;</span><span class="op" id="4294476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4294479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4294483">var</span>&nbsp;<span class="ident" id="4294487">ok</span>&nbsp;<span class="builtintype" id="4294490">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4294496">if</span>&nbsp;<span class="ident" id="4294499">ka</span><span class="op" id="4294501">.</span><span class="ident" id="4294502">curve</span><span class="op" id="4294507">,</span>&nbsp;<span class="ident" id="4294509">ok</span>&nbsp;<span class="op" id="4294512">=</span>&nbsp;<span class="ident" id="4294514">curveForCurveID</span><span class="op" id="4294529">(</span><span class="ident" id="4294530">curveid</span><span class="op" id="4294537">)</span><span class="op" id="4294538">;</span>&nbsp;<span class="op" id="4294540">!</span><span class="ident" id="4294541">ok</span>&nbsp;<span class="op" id="4294544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4294548">return</span>&nbsp;<span class="builtintype" id="4294555">nil</span><span class="op" id="4294558">,</span>&nbsp;<span class="ident" id="4294560">errors</span><span class="op" id="4294566">.</span><span class="ident" id="4294567">New</span><span class="op" id="4294570">(</span><span class="string" id="4294571">&#34;tls:&nbsp;preferredCurves&nbsp;includes&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4294620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4294623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4294627">var</span>&nbsp;<span class="ident" id="4294631">x</span><span class="op" id="4294632">,</span>&nbsp;<span class="ident" id="4294634">y</span>&nbsp;<span class="op" id="4294636">*</span><span class="ident" id="4294637">big</span><span class="op" id="4294640">.</span><span class="ident" id="4294641">Int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4294646">var</span>&nbsp;<span class="ident" id="4294650">err</span>&nbsp;<span class="builtintype" id="4294654">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4294661">ka</span><span class="op" id="4294663">.</span><span class="ident" id="4294664">privateKey</span><span class="op" id="4294674">,</span>&nbsp;<span class="ident" id="4294676">x</span><span class="op" id="4294677">,</span>&nbsp;<span class="ident" id="4294679">y</span><span class="op" id="4294680">,</span>&nbsp;<span class="ident" id="4294682">err</span>&nbsp;<span class="op" id="4294686">=</span>&nbsp;<span class="ident" id="4294688">elliptic</span><span class="op" id="4294696">.</span><span class="ident" id="4294697">GenerateKey</span><span class="op" id="4294708">(</span><span class="ident" id="4294709">ka</span><span class="op" id="4294711">.</span><span class="ident" id="4294712">curve</span><span class="op" id="4294717">,</span>&nbsp;<span class="ident" id="4294719">config</span><span class="op" id="4294725">.</span><span class="ident" id="4294726">rand</span><span class="op" id="4294730">(</span><span class="op" id="4294731">)</span><span class="op" id="4294732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4294735">if</span>&nbsp;<span class="ident" id="4294738">err</span>&nbsp;<span class="op" id="4294742">!=</span>&nbsp;<span class="builtintype" id="4294745">nil</span>&nbsp;<span class="op" id="4294749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4294753">return</span>&nbsp;<span class="builtintype" id="4294760">nil</span><span class="op" id="4294763">,</span>&nbsp;<span class="ident" id="4294765">err</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4294770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4294773">ecdhePublic</span>&nbsp;<span class="op" id="4294785">:=</span>&nbsp;<span class="ident" id="4294788">elliptic</span><span class="op" id="4294796">.</span><span class="ident" id="4294797">Marshal</span><span class="op" id="4294804">(</span><span class="ident" id="4294805">ka</span><span class="op" id="4294807">.</span><span class="ident" id="4294808">curve</span><span class="op" id="4294813">,</span>&nbsp;<span class="ident" id="4294815">x</span><span class="op" id="4294816">,</span>&nbsp;<span class="ident" id="4294818">y</span><span class="op" id="4294819">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4294823">//&nbsp;http://tools.ietf.org/html/rfc4492#section-5.4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4294874">serverECDHParams</span>&nbsp;<span class="op" id="4294891">:=</span>&nbsp;<span class="builtinfunc" id="4294894">make</span><span class="op" id="4294898">(</span><span class="op" id="4294899">[</span><span class="op" id="4294900">]</span><span class="builtintype" id="4294901">byte</span><span class="op" id="4294905">,</span>&nbsp;<span class="num" id="4294907">1</span><span class="op" id="4294908">+</span><span class="num" id="4294909">2</span><span class="op" id="4294910">+</span><span class="num" id="4294911">1</span><span class="op" id="4294912">+</span><span class="builtinfunc" id="4294913">len</span><span class="op" id="4294916">(</span><span class="ident" id="4294917">ecdhePublic</span><span class="op" id="4294928">)</span><span class="op" id="4294929">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4294932">serverECDHParams</span><span class="op" id="4294948">[</span><span class="num" id="4294949">0</span><span class="op" id="4294950">]</span>&nbsp;<span class="op" id="4294952">=</span>&nbsp;<span class="num" id="4294954">3</span>&nbsp;<span class="comment" id="4294956">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4294972">serverECDHParams</span><span class="op" id="4294988">[</span><span class="num" id="4294989">1</span><span class="op" id="4294990">]</span>&nbsp;<span class="op" id="4294992">=</span>&nbsp;<span class="builtintype" id="4294994">byte</span><span class="op" id="4294998">(</span><span class="ident" id="4294999">curveid</span>&nbsp;<span class="op" id="4295007">&gt;&gt;</span>&nbsp;<span class="num" id="4295010">8</span><span class="op" id="4295011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4295014">serverECDHParams</span><span class="op" id="4295030">[</span><span class="num" id="4295031">2</span><span class="op" id="4295032">]</span>&nbsp;<span class="op" id="4295034">=</span>&nbsp;<span class="builtintype" id="4295036">byte</span><span class="op" id="4295040">(</span><span class="ident" id="4295041">curveid</span><span class="op" id="4295048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4295051">serverECDHParams</span><span class="op" id="4295067">[</span><span class="num" id="4295068">3</span><span class="op" id="4295069">]</span>&nbsp;<span class="op" id="4295071">=</span>&nbsp;<span class="builtintype" id="4295073">byte</span><span class="op" id="4295077">(</span><span class="builtinfunc" id="4295078">len</span><span class="op" id="4295081">(</span><span class="ident" id="4295082">ecdhePublic</span><span class="op" id="4295093">)</span><span class="op" id="4295094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4295097">copy</span><span class="op" id="4295101">(</span><span class="ident" id="4295102">serverECDHParams</span><span class="op" id="4295118">[</span><span class="num" id="4295119">4</span><span class="op" id="4295120">:</span><span class="op" id="4295121">]</span><span class="op" id="4295122">,</span>&nbsp;<span class="ident" id="4295124">ecdhePublic</span><span class="op" id="4295135">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4295139">var</span>&nbsp;<span class="ident" id="4295143">tls12HashId</span>&nbsp;<span class="builtintype" id="4295155">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4295162">if</span>&nbsp;<span class="ident" id="4295165">ka</span><span class="op" id="4295167">.</span><span class="ident" id="4295168">version</span>&nbsp;<span class="op" id="4295176">&gt;=</span>&nbsp;<span class="ident" id="4295179">VersionTLS12</span>&nbsp;<span class="op" id="4295192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4295196">if</span>&nbsp;<span class="ident" id="4295199">tls12HashId</span><span class="op" id="4295210">,</span>&nbsp;<span class="ident" id="4295212">err</span>&nbsp;<span class="op" id="4295216">=</span>&nbsp;<span class="ident" id="4295218">pickTLS12HashForSignature</span><span class="op" id="4295243">(</span><span class="ident" id="4295244">ka</span><span class="op" id="4295246">.</span><span class="ident" id="4295247">sigType</span><span class="op" id="4295254">,</span>&nbsp;<span class="ident" id="4295256">clientHello</span><span class="op" id="4295267">.</span><span class="ident" id="4295268">signatureAndHashes</span><span class="op" id="4295286">)</span><span class="op" id="4295287">;</span>&nbsp;<span class="ident" id="4295289">err</span>&nbsp;<span class="op" id="4295293">!=</span>&nbsp;<span class="builtintype" id="4295296">nil</span>&nbsp;<span class="op" id="4295300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4295305">return</span>&nbsp;<span class="builtintype" id="4295312">nil</span><span class="op" id="4295315">,</span>&nbsp;<span class="ident" id="4295317">err</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4295323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4295326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4295330">digest</span><span class="op" id="4295336">,</span>&nbsp;<span class="ident" id="4295338">hashFunc</span><span class="op" id="4295346">,</span>&nbsp;<span class="ident" id="4295348">err</span>&nbsp;<span class="op" id="4295352">:=</span>&nbsp;<span class="ident" id="4295355">hashForServerKeyExchange</span><span class="op" id="4295379">(</span><span class="ident" id="4295380">ka</span><span class="op" id="4295382">.</span><span class="ident" id="4295383">sigType</span><span class="op" id="4295390">,</span>&nbsp;<span class="ident" id="4295392">tls12HashId</span><span class="op" id="4295403">,</span>&nbsp;<span class="ident" id="4295405">ka</span><span class="op" id="4295407">.</span><span class="ident" id="4295408">version</span><span class="op" id="4295415">,</span>&nbsp;<span class="ident" id="4295417">clientHello</span><span class="op" id="4295428">.</span><span class="ident" id="4295429">random</span><span class="op" id="4295435">,</span>&nbsp;<span class="ident" id="4295437">hello</span><span class="op" id="4295442">.</span><span class="ident" id="4295443">random</span><span class="op" id="4295449">,</span>&nbsp;<span class="ident" id="4295451">serverECDHParams</span><span class="op" id="4295467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4295470">if</span>&nbsp;<span class="ident" id="4295473">err</span>&nbsp;<span class="op" id="4295477">!=</span>&nbsp;<span class="builtintype" id="4295480">nil</span>&nbsp;<span class="op" id="4295484">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4295488">return</span>&nbsp;<span class="builtintype" id="4295495">nil</span><span class="op" id="4295498">,</span>&nbsp;<span class="ident" id="4295500">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4295505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4295508">var</span>&nbsp;<span class="ident" id="4295512">sig</span>&nbsp;<span class="op" id="4295516">[</span><span class="op" id="4295517">]</span><span class="builtintype" id="4295518">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4295524">switch</span>&nbsp;<span class="ident" id="4295531">ka</span><span class="op" id="4295533">.</span><span class="ident" id="4295534">sigType</span>&nbsp;<span class="op" id="4295542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4295545">case</span>&nbsp;<span class="ident" id="4295550">signatureECDSA</span><span class="op" id="4295564">:</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4295568">privKey</span><span class="op" id="4295575">,</span>&nbsp;<span class="ident" id="4295577">ok</span>&nbsp;<span class="op" id="4295580">:=</span>&nbsp;<span class="ident" id="4295583">cert</span><span class="op" id="4295587">.</span><span class="ident" id="4295588">PrivateKey</span><span class="op" id="4295598">.</span><span class="op" id="4295599">(</span><span class="op" id="4295600">*</span><span class="ident" id="4295601">ecdsa</span><span class="op" id="4295606">.</span><span class="ident" id="4295607">PrivateKey</span><span class="op" id="4295617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4295621">if</span>&nbsp;<span class="op" id="4295624">!</span><span class="ident" id="4295625">ok</span>&nbsp;<span class="op" id="4295628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4295633">return</span>&nbsp;<span class="builtintype" id="4295640">nil</span><span class="op" id="4295643">,</span>&nbsp;<span class="ident" id="4295645">errors</span><span class="op" id="4295651">.</span><span class="ident" id="4295652">New</span><span class="op" id="4295655">(</span><span class="string" id="4295656">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;an&nbsp;ECDSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="4295706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4295710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4295714">r</span><span class="op" id="4295715">,</span>&nbsp;<span class="ident" id="4295717">s</span><span class="op" id="4295718">,</span>&nbsp;<span class="ident" id="4295720">err</span>&nbsp;<span class="op" id="4295724">:=</span>&nbsp;<span class="ident" id="4295727">ecdsa</span><span class="op" id="4295732">.</span><span class="ident" id="4295733">Sign</span><span class="op" id="4295737">(</span><span class="ident" id="4295738">config</span><span class="op" id="4295744">.</span><span class="ident" id="4295745">rand</span><span class="op" id="4295749">(</span><span class="op" id="4295750">)</span><span class="op" id="4295751">,</span>&nbsp;<span class="ident" id="4295753">privKey</span><span class="op" id="4295760">,</span>&nbsp;<span class="ident" id="4295762">digest</span><span class="op" id="4295768">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4295772">if</span>&nbsp;<span class="ident" id="4295775">err</span>&nbsp;<span class="op" id="4295779">!=</span>&nbsp;<span class="builtintype" id="4295782">nil</span>&nbsp;<span class="op" id="4295786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4295791">return</span>&nbsp;<span class="builtintype" id="4295798">nil</span><span class="op" id="4295801">,</span>&nbsp;<span class="ident" id="4295803">errors</span><span class="op" id="4295809">.</span><span class="ident" id="4295810">New</span><span class="op" id="4295813">(</span><span class="string" id="4295814">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="4295850">+</span>&nbsp;<span class="ident" id="4295852">err</span><span class="op" id="4295855">.</span><span class="ident" id="4295856">Error</span><span class="op" id="4295861">(</span><span class="op" id="4295862">)</span><span class="op" id="4295863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4295867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4295871">sig</span><span class="op" id="4295874">,</span>&nbsp;<span class="ident" id="4295876">err</span>&nbsp;<span class="op" id="4295880">=</span>&nbsp;<span class="ident" id="4295882">asn1</span><span class="op" id="4295886">.</span><span class="ident" id="4295887">Marshal</span><span class="op" id="4295894">(</span><span class="ident" id="4295895">ecdsaSignature</span><span class="op" id="4295909">{</span><span class="ident" id="4295910">r</span><span class="op" id="4295911">,</span>&nbsp;<span class="ident" id="4295913">s</span><span class="op" id="4295914">}</span><span class="op" id="4295915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4295918">case</span>&nbsp;<span class="ident" id="4295923">signatureRSA</span><span class="op" id="4295935">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4295939">privKey</span><span class="op" id="4295946">,</span>&nbsp;<span class="ident" id="4295948">ok</span>&nbsp;<span class="op" id="4295951">:=</span>&nbsp;<span class="ident" id="4295954">cert</span><span class="op" id="4295958">.</span><span class="ident" id="4295959">PrivateKey</span><span class="op" id="4295969">.</span><span class="op" id="4295970">(</span><span class="op" id="4295971">*</span><span class="ident" id="4295972">rsa</span><span class="op" id="4295975">.</span><span class="ident" id="4295976">PrivateKey</span><span class="op" id="4295986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4295990">if</span>&nbsp;<span class="op" id="4295993">!</span><span class="ident" id="4295994">ok</span>&nbsp;<span class="op" id="4295997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4296002">return</span>&nbsp;<span class="builtintype" id="4296009">nil</span><span class="op" id="4296012">,</span>&nbsp;<span class="ident" id="4296014">errors</span><span class="op" id="4296020">.</span><span class="ident" id="4296021">New</span><span class="op" id="4296024">(</span><span class="string" id="4296025">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="4296070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4296074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4296078">sig</span><span class="op" id="4296081">,</span>&nbsp;<span class="ident" id="4296083">err</span>&nbsp;<span class="op" id="4296087">=</span>&nbsp;<span class="ident" id="4296089">rsa</span><span class="op" id="4296092">.</span><span class="ident" id="4296093">SignPKCS1v15</span><span class="op" id="4296105">(</span><span class="ident" id="4296106">config</span><span class="op" id="4296112">.</span><span class="ident" id="4296113">rand</span><span class="op" id="4296117">(</span><span class="op" id="4296118">)</span><span class="op" id="4296119">,</span>&nbsp;<span class="ident" id="4296121">privKey</span><span class="op" id="4296128">,</span>&nbsp;<span class="ident" id="4296130">hashFunc</span><span class="op" id="4296138">,</span>&nbsp;<span class="ident" id="4296140">digest</span><span class="op" id="4296146">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4296150">if</span>&nbsp;<span class="ident" id="4296153">err</span>&nbsp;<span class="op" id="4296157">!=</span>&nbsp;<span class="builtintype" id="4296160">nil</span>&nbsp;<span class="op" id="4296164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4296169">return</span>&nbsp;<span class="builtintype" id="4296176">nil</span><span class="op" id="4296179">,</span>&nbsp;<span class="ident" id="4296181">errors</span><span class="op" id="4296187">.</span><span class="ident" id="4296188">New</span><span class="op" id="4296191">(</span><span class="string" id="4296192">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="4296228">+</span>&nbsp;<span class="ident" id="4296230">err</span><span class="op" id="4296233">.</span><span class="ident" id="4296234">Error</span><span class="op" id="4296239">(</span><span class="op" id="4296240">)</span><span class="op" id="4296241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4296245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4296248">default</span><span class="op" id="4296255">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4296259">return</span>&nbsp;<span class="builtintype" id="4296266">nil</span><span class="op" id="4296269">,</span>&nbsp;<span class="ident" id="4296271">errors</span><span class="op" id="4296277">.</span><span class="ident" id="4296278">New</span><span class="op" id="4296281">(</span><span class="string" id="4296282">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="4296317">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4296320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4296324">skx</span>&nbsp;<span class="op" id="4296328">:=</span>&nbsp;<span class="builtinfunc" id="4296331">new</span><span class="op" id="4296334">(</span><span class="ident" id="4296335">serverKeyExchangeMsg</span><span class="op" id="4296355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4296358">sigAndHashLen</span>&nbsp;<span class="op" id="4296372">:=</span>&nbsp;<span class="num" id="4296375">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4296378">if</span>&nbsp;<span class="ident" id="4296381">ka</span><span class="op" id="4296383">.</span><span class="ident" id="4296384">version</span>&nbsp;<span class="op" id="4296392">&gt;=</span>&nbsp;<span class="ident" id="4296395">VersionTLS12</span>&nbsp;<span class="op" id="4296408">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4296412">sigAndHashLen</span>&nbsp;<span class="op" id="4296426">=</span>&nbsp;<span class="num" id="4296428">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4296431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4296434">skx</span><span class="op" id="4296437">.</span><span class="ident" id="4296438">key</span>&nbsp;<span class="op" id="4296442">=</span>&nbsp;<span class="builtinfunc" id="4296444">make</span><span class="op" id="4296448">(</span><span class="op" id="4296449">[</span><span class="op" id="4296450">]</span><span class="builtintype" id="4296451">byte</span><span class="op" id="4296455">,</span>&nbsp;<span class="builtinfunc" id="4296457">len</span><span class="op" id="4296460">(</span><span class="ident" id="4296461">serverECDHParams</span><span class="op" id="4296477">)</span><span class="op" id="4296478">+</span><span class="ident" id="4296479">sigAndHashLen</span><span class="op" id="4296492">+</span><span class="num" id="4296493">2</span><span class="op" id="4296494">+</span><span class="builtinfunc" id="4296495">len</span><span class="op" id="4296498">(</span><span class="ident" id="4296499">sig</span><span class="op" id="4296502">)</span><span class="op" id="4296503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4296506">copy</span><span class="op" id="4296510">(</span><span class="ident" id="4296511">skx</span><span class="op" id="4296514">.</span><span class="ident" id="4296515">key</span><span class="op" id="4296518">,</span>&nbsp;<span class="ident" id="4296520">serverECDHParams</span><span class="op" id="4296536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4296539">k</span>&nbsp;<span class="op" id="4296541">:=</span>&nbsp;<span class="ident" id="4296544">skx</span><span class="op" id="4296547">.</span><span class="ident" id="4296548">key</span><span class="op" id="4296551">[</span><span class="builtinfunc" id="4296552">len</span><span class="op" id="4296555">(</span><span class="ident" id="4296556">serverECDHParams</span><span class="op" id="4296572">)</span><span class="op" id="4296573">:</span><span class="op" id="4296574">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4296577">if</span>&nbsp;<span class="ident" id="4296580">ka</span><span class="op" id="4296582">.</span><span class="ident" id="4296583">version</span>&nbsp;<span class="op" id="4296591">&gt;=</span>&nbsp;<span class="ident" id="4296594">VersionTLS12</span>&nbsp;<span class="op" id="4296607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4296611">k</span><span class="op" id="4296612">[</span><span class="num" id="4296613">0</span><span class="op" id="4296614">]</span>&nbsp;<span class="op" id="4296616">=</span>&nbsp;<span class="ident" id="4296618">tls12HashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4296632">k</span><span class="op" id="4296633">[</span><span class="num" id="4296634">1</span><span class="op" id="4296635">]</span>&nbsp;<span class="op" id="4296637">=</span>&nbsp;<span class="ident" id="4296639">ka</span><span class="op" id="4296641">.</span><span class="ident" id="4296642">sigType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4296652">k</span>&nbsp;<span class="op" id="4296654">=</span>&nbsp;<span class="ident" id="4296656">k</span><span class="op" id="4296657">[</span><span class="num" id="4296658">2</span><span class="op" id="4296659">:</span><span class="op" id="4296660">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4296663">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4296666">k</span><span class="op" id="4296667">[</span><span class="num" id="4296668">0</span><span class="op" id="4296669">]</span>&nbsp;<span class="op" id="4296671">=</span>&nbsp;<span class="builtintype" id="4296673">byte</span><span class="op" id="4296677">(</span><span class="builtinfunc" id="4296678">len</span><span class="op" id="4296681">(</span><span class="ident" id="4296682">sig</span><span class="op" id="4296685">)</span>&nbsp;<span class="op" id="4296687">&gt;&gt;</span>&nbsp;<span class="num" id="4296690">8</span><span class="op" id="4296691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4296694">k</span><span class="op" id="4296695">[</span><span class="num" id="4296696">1</span><span class="op" id="4296697">]</span>&nbsp;<span class="op" id="4296699">=</span>&nbsp;<span class="builtintype" id="4296701">byte</span><span class="op" id="4296705">(</span><span class="builtinfunc" id="4296706">len</span><span class="op" id="4296709">(</span><span class="ident" id="4296710">sig</span><span class="op" id="4296713">)</span><span class="op" id="4296714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4296717">copy</span><span class="op" id="4296721">(</span><span class="ident" id="4296722">k</span><span class="op" id="4296723">[</span><span class="num" id="4296724">2</span><span class="op" id="4296725">:</span><span class="op" id="4296726">]</span><span class="op" id="4296727">,</span>&nbsp;<span class="ident" id="4296729">sig</span><span class="op" id="4296732">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4296736">return</span>&nbsp;<span class="ident" id="4296743">skx</span><span class="op" id="4296746">,</span>&nbsp;<span class="builtintype" id="4296748">nil</span><br>
<span class="lineno">285</span><span class="op" id="4296752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4296755">func</span>&nbsp;<span class="op" id="4296760">(</span><span class="ident" id="4296761">ka</span>&nbsp;<span class="op" id="4296764">*</span><span class="ident" id="4296765">ecdheKeyAgreement</span><span class="op" id="4296782">)</span>&nbsp;<span class="ident" id="4296784">processClientKeyExchange</span><span class="op" id="4296808">(</span><span class="ident" id="4296809">config</span>&nbsp;<span class="op" id="4296816">*</span><span class="ident" id="4296817">Config</span><span class="op" id="4296823">,</span>&nbsp;<span class="ident" id="4296825">cert</span>&nbsp;<span class="op" id="4296830">*</span><span class="ident" id="4296831">Certificate</span><span class="op" id="4296842">,</span>&nbsp;<span class="ident" id="4296844">ckx</span>&nbsp;<span class="op" id="4296848">*</span><span class="ident" id="4296849">clientKeyExchangeMsg</span><span class="op" id="4296869">,</span>&nbsp;<span class="ident" id="4296871">version</span>&nbsp;<span class="builtintype" id="4296879">uint16</span><span class="op" id="4296885">)</span>&nbsp;<span class="op" id="4296887">(</span><span class="op" id="4296888">[</span><span class="op" id="4296889">]</span><span class="builtintype" id="4296890">byte</span><span class="op" id="4296894">,</span>&nbsp;<span class="builtintype" id="4296896">error</span><span class="op" id="4296901">)</span>&nbsp;<span class="op" id="4296903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4296906">if</span>&nbsp;<span class="builtinfunc" id="4296909">len</span><span class="op" id="4296912">(</span><span class="ident" id="4296913">ckx</span><span class="op" id="4296916">.</span><span class="ident" id="4296917">ciphertext</span><span class="op" id="4296927">)</span>&nbsp;<span class="op" id="4296929">==</span>&nbsp;<span class="num" id="4296932">0</span>&nbsp;<span class="op" id="4296934">||</span>&nbsp;<span class="builtintype" id="4296937">int</span><span class="op" id="4296940">(</span><span class="ident" id="4296941">ckx</span><span class="op" id="4296944">.</span><span class="ident" id="4296945">ciphertext</span><span class="op" id="4296955">[</span><span class="num" id="4296956">0</span><span class="op" id="4296957">]</span><span class="op" id="4296958">)</span>&nbsp;<span class="op" id="4296960">!=</span>&nbsp;<span class="builtinfunc" id="4296963">len</span><span class="op" id="4296966">(</span><span class="ident" id="4296967">ckx</span><span class="op" id="4296970">.</span><span class="ident" id="4296971">ciphertext</span><span class="op" id="4296981">)</span><span class="op" id="4296982">-</span><span class="num" id="4296983">1</span>&nbsp;<span class="op" id="4296985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4296989">return</span>&nbsp;<span class="builtintype" id="4296996">nil</span><span class="op" id="4296999">,</span>&nbsp;<span class="ident" id="4297001">errClientKeyExchange</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4297023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4297026">x</span><span class="op" id="4297027">,</span>&nbsp;<span class="ident" id="4297029">y</span>&nbsp;<span class="op" id="4297031">:=</span>&nbsp;<span class="ident" id="4297034">elliptic</span><span class="op" id="4297042">.</span><span class="ident" id="4297043">Unmarshal</span><span class="op" id="4297052">(</span><span class="ident" id="4297053">ka</span><span class="op" id="4297055">.</span><span class="ident" id="4297056">curve</span><span class="op" id="4297061">,</span>&nbsp;<span class="ident" id="4297063">ckx</span><span class="op" id="4297066">.</span><span class="ident" id="4297067">ciphertext</span><span class="op" id="4297077">[</span><span class="num" id="4297078">1</span><span class="op" id="4297079">:</span><span class="op" id="4297080">]</span><span class="op" id="4297081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4297084">if</span>&nbsp;<span class="ident" id="4297087">x</span>&nbsp;<span class="op" id="4297089">==</span>&nbsp;<span class="builtintype" id="4297092">nil</span>&nbsp;<span class="op" id="4297096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4297100">return</span>&nbsp;<span class="builtintype" id="4297107">nil</span><span class="op" id="4297110">,</span>&nbsp;<span class="ident" id="4297112">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4297134">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4297137">if</span>&nbsp;<span class="op" id="4297140">!</span><span class="ident" id="4297141">ka</span><span class="op" id="4297143">.</span><span class="ident" id="4297144">curve</span><span class="op" id="4297149">.</span><span class="ident" id="4297150">IsOnCurve</span><span class="op" id="4297159">(</span><span class="ident" id="4297160">x</span><span class="op" id="4297161">,</span>&nbsp;<span class="ident" id="4297163">y</span><span class="op" id="4297164">)</span>&nbsp;<span class="op" id="4297166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4297170">return</span>&nbsp;<span class="builtintype" id="4297177">nil</span><span class="op" id="4297180">,</span>&nbsp;<span class="ident" id="4297182">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4297204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4297207">x</span><span class="op" id="4297208">,</span>&nbsp;<span class="ident" id="4297210">_</span>&nbsp;<span class="op" id="4297212">=</span>&nbsp;<span class="ident" id="4297214">ka</span><span class="op" id="4297216">.</span><span class="ident" id="4297217">curve</span><span class="op" id="4297222">.</span><span class="ident" id="4297223">ScalarMult</span><span class="op" id="4297233">(</span><span class="ident" id="4297234">x</span><span class="op" id="4297235">,</span>&nbsp;<span class="ident" id="4297237">y</span><span class="op" id="4297238">,</span>&nbsp;<span class="ident" id="4297240">ka</span><span class="op" id="4297242">.</span><span class="ident" id="4297243">privateKey</span><span class="op" id="4297253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4297256">preMasterSecret</span>&nbsp;<span class="op" id="4297272">:=</span>&nbsp;<span class="builtinfunc" id="4297275">make</span><span class="op" id="4297279">(</span><span class="op" id="4297280">[</span><span class="op" id="4297281">]</span><span class="builtintype" id="4297282">byte</span><span class="op" id="4297286">,</span>&nbsp;<span class="op" id="4297288">(</span><span class="ident" id="4297289">ka</span><span class="op" id="4297291">.</span><span class="ident" id="4297292">curve</span><span class="op" id="4297297">.</span><span class="ident" id="4297298">Params</span><span class="op" id="4297304">(</span><span class="op" id="4297305">)</span><span class="op" id="4297306">.</span><span class="ident" id="4297307">BitSize</span><span class="op" id="4297314">+</span><span class="num" id="4297315">7</span><span class="op" id="4297316">)</span><span class="op" id="4297317">&gt;&gt;</span><span class="num" id="4297319">3</span><span class="op" id="4297320">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4297323">xBytes</span>&nbsp;<span class="op" id="4297330">:=</span>&nbsp;<span class="ident" id="4297333">x</span><span class="op" id="4297334">.</span><span class="ident" id="4297335">Bytes</span><span class="op" id="4297340">(</span><span class="op" id="4297341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4297344">copy</span><span class="op" id="4297348">(</span><span class="ident" id="4297349">preMasterSecret</span><span class="op" id="4297364">[</span><span class="builtinfunc" id="4297365">len</span><span class="op" id="4297368">(</span><span class="ident" id="4297369">preMasterSecret</span><span class="op" id="4297384">)</span><span class="op" id="4297385">-</span><span class="builtinfunc" id="4297386">len</span><span class="op" id="4297389">(</span><span class="ident" id="4297390">xBytes</span><span class="op" id="4297396">)</span><span class="op" id="4297397">:</span><span class="op" id="4297398">]</span><span class="op" id="4297399">,</span>&nbsp;<span class="ident" id="4297401">xBytes</span><span class="op" id="4297407">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4297411">return</span>&nbsp;<span class="ident" id="4297418">preMasterSecret</span><span class="op" id="4297433">,</span>&nbsp;<span class="builtintype" id="4297435">nil</span><br>
<span class="lineno"></span><span class="op" id="4297439">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="4297442">func</span>&nbsp;<span class="op" id="4297447">(</span><span class="ident" id="4297448">ka</span>&nbsp;<span class="op" id="4297451">*</span><span class="ident" id="4297452">ecdheKeyAgreement</span><span class="op" id="4297469">)</span>&nbsp;<span class="ident" id="4297471">processServerKeyExchange</span><span class="op" id="4297495">(</span><span class="ident" id="4297496">config</span>&nbsp;<span class="op" id="4297503">*</span><span class="ident" id="4297504">Config</span><span class="op" id="4297510">,</span>&nbsp;<span class="ident" id="4297512">clientHello</span>&nbsp;<span class="op" id="4297524">*</span><span class="ident" id="4297525">clientHelloMsg</span><span class="op" id="4297539">,</span>&nbsp;<span class="ident" id="4297541">serverHello</span>&nbsp;<span class="op" id="4297553">*</span><span class="ident" id="4297554">serverHelloMsg</span><span class="op" id="4297568">,</span>&nbsp;<span class="ident" id="4297570">cert</span>&nbsp;<span class="op" id="4297575">*</span><span class="ident" id="4297576">x509</span><span class="op" id="4297580">.</span><span class="ident" id="4297581">Certificate</span><span class="op" id="4297592">,</span>&nbsp;<span class="ident" id="4297594">skx</span>&nbsp;<span class="op" id="4297598">*</span><span class="ident" id="4297599">serverKeyExchangeMsg</span><span class="op" id="4297619">)</span>&nbsp;<span class="builtintype" id="4297621">error</span>&nbsp;<span class="op" id="4297627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4297630">if</span>&nbsp;<span class="builtinfunc" id="4297633">len</span><span class="op" id="4297636">(</span><span class="ident" id="4297637">skx</span><span class="op" id="4297640">.</span><span class="ident" id="4297641">key</span><span class="op" id="4297644">)</span>&nbsp;<span class="op" id="4297646">&lt;</span>&nbsp;<span class="num" id="4297648">4</span>&nbsp;<span class="op" id="4297650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4297654">return</span>&nbsp;<span class="ident" id="4297661">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4297683">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4297686">if</span>&nbsp;<span class="ident" id="4297689">skx</span><span class="op" id="4297692">.</span><span class="ident" id="4297693">key</span><span class="op" id="4297696">[</span><span class="num" id="4297697">0</span><span class="op" id="4297698">]</span>&nbsp;<span class="op" id="4297700">!=</span>&nbsp;<span class="num" id="4297703">3</span>&nbsp;<span class="op" id="4297705">{</span>&nbsp;<span class="comment" id="4297707">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4297724">return</span>&nbsp;<span class="ident" id="4297731">errors</span><span class="op" id="4297737">.</span><span class="ident" id="4297738">New</span><span class="op" id="4297741">(</span><span class="string" id="4297742">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4297782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4297785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4297788">curveid</span>&nbsp;<span class="op" id="4297796">:=</span>&nbsp;<span class="ident" id="4297799">CurveID</span><span class="op" id="4297806">(</span><span class="ident" id="4297807">skx</span><span class="op" id="4297810">.</span><span class="ident" id="4297811">key</span><span class="op" id="4297814">[</span><span class="num" id="4297815">1</span><span class="op" id="4297816">]</span><span class="op" id="4297817">)</span><span class="op" id="4297818">&lt;&lt;</span><span class="num" id="4297820">8</span>&nbsp;<span class="op" id="4297822">|</span>&nbsp;<span class="ident" id="4297824">CurveID</span><span class="op" id="4297831">(</span><span class="ident" id="4297832">skx</span><span class="op" id="4297835">.</span><span class="ident" id="4297836">key</span><span class="op" id="4297839">[</span><span class="num" id="4297840">2</span><span class="op" id="4297841">]</span><span class="op" id="4297842">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4297846">var</span>&nbsp;<span class="ident" id="4297850">ok</span>&nbsp;<span class="builtintype" id="4297853">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4297859">if</span>&nbsp;<span class="ident" id="4297862">ka</span><span class="op" id="4297864">.</span><span class="ident" id="4297865">curve</span><span class="op" id="4297870">,</span>&nbsp;<span class="ident" id="4297872">ok</span>&nbsp;<span class="op" id="4297875">=</span>&nbsp;<span class="ident" id="4297877">curveForCurveID</span><span class="op" id="4297892">(</span><span class="ident" id="4297893">curveid</span><span class="op" id="4297900">)</span><span class="op" id="4297901">;</span>&nbsp;<span class="op" id="4297903">!</span><span class="ident" id="4297904">ok</span>&nbsp;<span class="op" id="4297907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4297911">return</span>&nbsp;<span class="ident" id="4297918">errors</span><span class="op" id="4297924">.</span><span class="ident" id="4297925">New</span><span class="op" id="4297928">(</span><span class="string" id="4297929">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4297969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4297972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4297976">publicLen</span>&nbsp;<span class="op" id="4297986">:=</span>&nbsp;<span class="builtintype" id="4297989">int</span><span class="op" id="4297992">(</span><span class="ident" id="4297993">skx</span><span class="op" id="4297996">.</span><span class="ident" id="4297997">key</span><span class="op" id="4298000">[</span><span class="num" id="4298001">3</span><span class="op" id="4298002">]</span><span class="op" id="4298003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298006">if</span>&nbsp;<span class="ident" id="4298009">publicLen</span><span class="op" id="4298018">+</span><span class="num" id="4298019">4</span>&nbsp;<span class="op" id="4298021">&gt;</span>&nbsp;<span class="builtinfunc" id="4298023">len</span><span class="op" id="4298026">(</span><span class="ident" id="4298027">skx</span><span class="op" id="4298030">.</span><span class="ident" id="4298031">key</span><span class="op" id="4298034">)</span>&nbsp;<span class="op" id="4298036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298040">return</span>&nbsp;<span class="ident" id="4298047">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4298069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4298072">ka</span><span class="op" id="4298074">.</span><span class="ident" id="4298075">x</span><span class="op" id="4298076">,</span>&nbsp;<span class="ident" id="4298078">ka</span><span class="op" id="4298080">.</span><span class="ident" id="4298081">y</span>&nbsp;<span class="op" id="4298083">=</span>&nbsp;<span class="ident" id="4298085">elliptic</span><span class="op" id="4298093">.</span><span class="ident" id="4298094">Unmarshal</span><span class="op" id="4298103">(</span><span class="ident" id="4298104">ka</span><span class="op" id="4298106">.</span><span class="ident" id="4298107">curve</span><span class="op" id="4298112">,</span>&nbsp;<span class="ident" id="4298114">skx</span><span class="op" id="4298117">.</span><span class="ident" id="4298118">key</span><span class="op" id="4298121">[</span><span class="num" id="4298122">4</span><span class="op" id="4298123">:</span><span class="num" id="4298124">4</span><span class="op" id="4298125">+</span><span class="ident" id="4298126">publicLen</span><span class="op" id="4298135">]</span><span class="op" id="4298136">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298139">if</span>&nbsp;<span class="ident" id="4298142">ka</span><span class="op" id="4298144">.</span><span class="ident" id="4298145">x</span>&nbsp;<span class="op" id="4298147">==</span>&nbsp;<span class="builtintype" id="4298150">nil</span>&nbsp;<span class="op" id="4298154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298158">return</span>&nbsp;<span class="ident" id="4298165">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4298187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298190">if</span>&nbsp;<span class="op" id="4298193">!</span><span class="ident" id="4298194">ka</span><span class="op" id="4298196">.</span><span class="ident" id="4298197">curve</span><span class="op" id="4298202">.</span><span class="ident" id="4298203">IsOnCurve</span><span class="op" id="4298212">(</span><span class="ident" id="4298213">ka</span><span class="op" id="4298215">.</span><span class="ident" id="4298216">x</span><span class="op" id="4298217">,</span>&nbsp;<span class="ident" id="4298219">ka</span><span class="op" id="4298221">.</span><span class="ident" id="4298222">y</span><span class="op" id="4298223">)</span>&nbsp;<span class="op" id="4298225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298229">return</span>&nbsp;<span class="ident" id="4298236">errServerKeyExchange</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4298258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4298261">serverECDHParams</span>&nbsp;<span class="op" id="4298278">:=</span>&nbsp;<span class="ident" id="4298281">skx</span><span class="op" id="4298284">.</span><span class="ident" id="4298285">key</span><span class="op" id="4298288">[</span><span class="op" id="4298289">:</span><span class="num" id="4298290">4</span><span class="op" id="4298291">+</span><span class="ident" id="4298292">publicLen</span><span class="op" id="4298301">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4298305">sig</span>&nbsp;<span class="op" id="4298309">:=</span>&nbsp;<span class="ident" id="4298312">skx</span><span class="op" id="4298315">.</span><span class="ident" id="4298316">key</span><span class="op" id="4298319">[</span><span class="num" id="4298320">4</span><span class="op" id="4298321">+</span><span class="ident" id="4298322">publicLen</span><span class="op" id="4298331">:</span><span class="op" id="4298332">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298335">if</span>&nbsp;<span class="builtinfunc" id="4298338">len</span><span class="op" id="4298341">(</span><span class="ident" id="4298342">sig</span><span class="op" id="4298345">)</span>&nbsp;<span class="op" id="4298347">&lt;</span>&nbsp;<span class="num" id="4298349">2</span>&nbsp;<span class="op" id="4298351">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298355">return</span>&nbsp;<span class="ident" id="4298362">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4298384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298388">var</span>&nbsp;<span class="ident" id="4298392">tls12HashId</span>&nbsp;<span class="builtintype" id="4298404">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298411">if</span>&nbsp;<span class="ident" id="4298414">ka</span><span class="op" id="4298416">.</span><span class="ident" id="4298417">version</span>&nbsp;<span class="op" id="4298425">&gt;=</span>&nbsp;<span class="ident" id="4298428">VersionTLS12</span>&nbsp;<span class="op" id="4298441">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4298445">//&nbsp;handle&nbsp;SignatureAndHashAlgorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298483">var</span>&nbsp;<span class="ident" id="4298487">sigAndHash</span>&nbsp;<span class="op" id="4298498">[</span><span class="op" id="4298499">]</span><span class="builtintype" id="4298500">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4298508">sigAndHash</span><span class="op" id="4298518">,</span>&nbsp;<span class="ident" id="4298520">sig</span>&nbsp;<span class="op" id="4298524">=</span>&nbsp;<span class="ident" id="4298526">sig</span><span class="op" id="4298529">[</span><span class="op" id="4298530">:</span><span class="num" id="4298531">2</span><span class="op" id="4298532">]</span><span class="op" id="4298533">,</span>&nbsp;<span class="ident" id="4298535">sig</span><span class="op" id="4298538">[</span><span class="num" id="4298539">2</span><span class="op" id="4298540">:</span><span class="op" id="4298541">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298545">if</span>&nbsp;<span class="ident" id="4298548">sigAndHash</span><span class="op" id="4298558">[</span><span class="num" id="4298559">1</span><span class="op" id="4298560">]</span>&nbsp;<span class="op" id="4298562">!=</span>&nbsp;<span class="ident" id="4298565">ka</span><span class="op" id="4298567">.</span><span class="ident" id="4298568">sigType</span>&nbsp;<span class="op" id="4298576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298581">return</span>&nbsp;<span class="ident" id="4298588">errServerKeyExchange</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4298611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4298615">tls12HashId</span>&nbsp;<span class="op" id="4298627">=</span>&nbsp;<span class="ident" id="4298629">sigAndHash</span><span class="op" id="4298639">[</span><span class="num" id="4298640">0</span><span class="op" id="4298641">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298645">if</span>&nbsp;<span class="builtinfunc" id="4298648">len</span><span class="op" id="4298651">(</span><span class="ident" id="4298652">sig</span><span class="op" id="4298655">)</span>&nbsp;<span class="op" id="4298657">&lt;</span>&nbsp;<span class="num" id="4298659">2</span>&nbsp;<span class="op" id="4298661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298666">return</span>&nbsp;<span class="ident" id="4298673">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4298696">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4298699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4298702">sigLen</span>&nbsp;<span class="op" id="4298709">:=</span>&nbsp;<span class="builtintype" id="4298712">int</span><span class="op" id="4298715">(</span><span class="ident" id="4298716">sig</span><span class="op" id="4298719">[</span><span class="num" id="4298720">0</span><span class="op" id="4298721">]</span><span class="op" id="4298722">)</span><span class="op" id="4298723">&lt;&lt;</span><span class="num" id="4298725">8</span>&nbsp;<span class="op" id="4298727">|</span>&nbsp;<span class="builtintype" id="4298729">int</span><span class="op" id="4298732">(</span><span class="ident" id="4298733">sig</span><span class="op" id="4298736">[</span><span class="num" id="4298737">1</span><span class="op" id="4298738">]</span><span class="op" id="4298739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298742">if</span>&nbsp;<span class="ident" id="4298745">sigLen</span><span class="op" id="4298751">+</span><span class="num" id="4298752">2</span>&nbsp;<span class="op" id="4298754">!=</span>&nbsp;<span class="builtinfunc" id="4298757">len</span><span class="op" id="4298760">(</span><span class="ident" id="4298761">sig</span><span class="op" id="4298764">)</span>&nbsp;<span class="op" id="4298766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298770">return</span>&nbsp;<span class="ident" id="4298777">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4298799">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4298802">sig</span>&nbsp;<span class="op" id="4298806">=</span>&nbsp;<span class="ident" id="4298808">sig</span><span class="op" id="4298811">[</span><span class="num" id="4298812">2</span><span class="op" id="4298813">:</span><span class="op" id="4298814">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4298818">digest</span><span class="op" id="4298824">,</span>&nbsp;<span class="ident" id="4298826">hashFunc</span><span class="op" id="4298834">,</span>&nbsp;<span class="ident" id="4298836">err</span>&nbsp;<span class="op" id="4298840">:=</span>&nbsp;<span class="ident" id="4298843">hashForServerKeyExchange</span><span class="op" id="4298867">(</span><span class="ident" id="4298868">ka</span><span class="op" id="4298870">.</span><span class="ident" id="4298871">sigType</span><span class="op" id="4298878">,</span>&nbsp;<span class="ident" id="4298880">tls12HashId</span><span class="op" id="4298891">,</span>&nbsp;<span class="ident" id="4298893">ka</span><span class="op" id="4298895">.</span><span class="ident" id="4298896">version</span><span class="op" id="4298903">,</span>&nbsp;<span class="ident" id="4298905">clientHello</span><span class="op" id="4298916">.</span><span class="ident" id="4298917">random</span><span class="op" id="4298923">,</span>&nbsp;<span class="ident" id="4298925">serverHello</span><span class="op" id="4298936">.</span><span class="ident" id="4298937">random</span><span class="op" id="4298943">,</span>&nbsp;<span class="ident" id="4298945">serverECDHParams</span><span class="op" id="4298961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298964">if</span>&nbsp;<span class="ident" id="4298967">err</span>&nbsp;<span class="op" id="4298971">!=</span>&nbsp;<span class="builtintype" id="4298974">nil</span>&nbsp;<span class="op" id="4298978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298982">return</span>&nbsp;<span class="ident" id="4298989">err</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4298994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4298997">switch</span>&nbsp;<span class="ident" id="4299004">ka</span><span class="op" id="4299006">.</span><span class="ident" id="4299007">sigType</span>&nbsp;<span class="op" id="4299015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299018">case</span>&nbsp;<span class="ident" id="4299023">signatureECDSA</span><span class="op" id="4299037">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4299041">pubKey</span><span class="op" id="4299047">,</span>&nbsp;<span class="ident" id="4299049">ok</span>&nbsp;<span class="op" id="4299052">:=</span>&nbsp;<span class="ident" id="4299055">cert</span><span class="op" id="4299059">.</span><span class="ident" id="4299060">PublicKey</span><span class="op" id="4299069">.</span><span class="op" id="4299070">(</span><span class="op" id="4299071">*</span><span class="ident" id="4299072">ecdsa</span><span class="op" id="4299077">.</span><span class="ident" id="4299078">PublicKey</span><span class="op" id="4299087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299091">if</span>&nbsp;<span class="op" id="4299094">!</span><span class="ident" id="4299095">ok</span>&nbsp;<span class="op" id="4299098">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299103">return</span>&nbsp;<span class="ident" id="4299110">errors</span><span class="op" id="4299116">.</span><span class="ident" id="4299117">New</span><span class="op" id="4299120">(</span><span class="string" id="4299121">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;a&nbsp;ECDSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="4299169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4299177">ecdsaSig</span>&nbsp;<span class="op" id="4299186">:=</span>&nbsp;<span class="builtinfunc" id="4299189">new</span><span class="op" id="4299192">(</span><span class="ident" id="4299193">ecdsaSignature</span><span class="op" id="4299207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299211">if</span>&nbsp;<span class="ident" id="4299214">_</span><span class="op" id="4299215">,</span>&nbsp;<span class="ident" id="4299217">err</span>&nbsp;<span class="op" id="4299221">:=</span>&nbsp;<span class="ident" id="4299224">asn1</span><span class="op" id="4299228">.</span><span class="ident" id="4299229">Unmarshal</span><span class="op" id="4299238">(</span><span class="ident" id="4299239">sig</span><span class="op" id="4299242">,</span>&nbsp;<span class="ident" id="4299244">ecdsaSig</span><span class="op" id="4299252">)</span><span class="op" id="4299253">;</span>&nbsp;<span class="ident" id="4299255">err</span>&nbsp;<span class="op" id="4299259">!=</span>&nbsp;<span class="builtintype" id="4299262">nil</span>&nbsp;<span class="op" id="4299266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299271">return</span>&nbsp;<span class="ident" id="4299278">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299288">if</span>&nbsp;<span class="ident" id="4299291">ecdsaSig</span><span class="op" id="4299299">.</span><span class="ident" id="4299300">R</span><span class="op" id="4299301">.</span><span class="ident" id="4299302">Sign</span><span class="op" id="4299306">(</span><span class="op" id="4299307">)</span>&nbsp;<span class="op" id="4299309">&lt;=</span>&nbsp;<span class="num" id="4299312">0</span>&nbsp;<span class="op" id="4299314">||</span>&nbsp;<span class="ident" id="4299317">ecdsaSig</span><span class="op" id="4299325">.</span><span class="ident" id="4299326">S</span><span class="op" id="4299327">.</span><span class="ident" id="4299328">Sign</span><span class="op" id="4299332">(</span><span class="op" id="4299333">)</span>&nbsp;<span class="op" id="4299335">&lt;=</span>&nbsp;<span class="num" id="4299338">0</span>&nbsp;<span class="op" id="4299340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299345">return</span>&nbsp;<span class="ident" id="4299352">errors</span><span class="op" id="4299358">.</span><span class="ident" id="4299359">New</span><span class="op" id="4299362">(</span><span class="string" id="4299363">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="4299414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299422">if</span>&nbsp;<span class="op" id="4299425">!</span><span class="ident" id="4299426">ecdsa</span><span class="op" id="4299431">.</span><span class="ident" id="4299432">Verify</span><span class="op" id="4299438">(</span><span class="ident" id="4299439">pubKey</span><span class="op" id="4299445">,</span>&nbsp;<span class="ident" id="4299447">digest</span><span class="op" id="4299453">,</span>&nbsp;<span class="ident" id="4299455">ecdsaSig</span><span class="op" id="4299463">.</span><span class="ident" id="4299464">R</span><span class="op" id="4299465">,</span>&nbsp;<span class="ident" id="4299467">ecdsaSig</span><span class="op" id="4299475">.</span><span class="ident" id="4299476">S</span><span class="op" id="4299477">)</span>&nbsp;<span class="op" id="4299479">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299484">return</span>&nbsp;<span class="ident" id="4299491">errors</span><span class="op" id="4299497">.</span><span class="ident" id="4299498">New</span><span class="op" id="4299501">(</span><span class="string" id="4299502">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="4299530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299537">case</span>&nbsp;<span class="ident" id="4299542">signatureRSA</span><span class="op" id="4299554">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4299558">pubKey</span><span class="op" id="4299564">,</span>&nbsp;<span class="ident" id="4299566">ok</span>&nbsp;<span class="op" id="4299569">:=</span>&nbsp;<span class="ident" id="4299572">cert</span><span class="op" id="4299576">.</span><span class="ident" id="4299577">PublicKey</span><span class="op" id="4299586">.</span><span class="op" id="4299587">(</span><span class="op" id="4299588">*</span><span class="ident" id="4299589">rsa</span><span class="op" id="4299592">.</span><span class="ident" id="4299593">PublicKey</span><span class="op" id="4299602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299606">if</span>&nbsp;<span class="op" id="4299609">!</span><span class="ident" id="4299610">ok</span>&nbsp;<span class="op" id="4299613">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299618">return</span>&nbsp;<span class="ident" id="4299625">errors</span><span class="op" id="4299631">.</span><span class="ident" id="4299632">New</span><span class="op" id="4299635">(</span><span class="string" id="4299636">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="4299680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299688">if</span>&nbsp;<span class="ident" id="4299691">err</span>&nbsp;<span class="op" id="4299695">:=</span>&nbsp;<span class="ident" id="4299698">rsa</span><span class="op" id="4299701">.</span><span class="ident" id="4299702">VerifyPKCS1v15</span><span class="op" id="4299716">(</span><span class="ident" id="4299717">pubKey</span><span class="op" id="4299723">,</span>&nbsp;<span class="ident" id="4299725">hashFunc</span><span class="op" id="4299733">,</span>&nbsp;<span class="ident" id="4299735">digest</span><span class="op" id="4299741">,</span>&nbsp;<span class="ident" id="4299743">sig</span><span class="op" id="4299746">)</span><span class="op" id="4299747">;</span>&nbsp;<span class="ident" id="4299749">err</span>&nbsp;<span class="op" id="4299753">!=</span>&nbsp;<span class="builtintype" id="4299756">nil</span>&nbsp;<span class="op" id="4299760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299765">return</span>&nbsp;<span class="ident" id="4299772">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299778">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299781">default</span><span class="op" id="4299788">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299792">return</span>&nbsp;<span class="ident" id="4299799">errors</span><span class="op" id="4299805">.</span><span class="ident" id="4299806">New</span><span class="op" id="4299809">(</span><span class="string" id="4299810">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="4299845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4299852">return</span>&nbsp;<span class="builtintype" id="4299859">nil</span><br>
<span class="lineno">390</span><span class="op" id="4299863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4299866">func</span>&nbsp;<span class="op" id="4299871">(</span><span class="ident" id="4299872">ka</span>&nbsp;<span class="op" id="4299875">*</span><span class="ident" id="4299876">ecdheKeyAgreement</span><span class="op" id="4299893">)</span>&nbsp;<span class="ident" id="4299895">generateClientKeyExchange</span><span class="op" id="4299920">(</span><span class="ident" id="4299921">config</span>&nbsp;<span class="op" id="4299928">*</span><span class="ident" id="4299929">Config</span><span class="op" id="4299935">,</span>&nbsp;<span class="ident" id="4299937">clientHello</span>&nbsp;<span class="op" id="4299949">*</span><span class="ident" id="4299950">clientHelloMsg</span><span class="op" id="4299964">,</span>&nbsp;<span class="ident" id="4299966">cert</span>&nbsp;<span class="op" id="4299971">*</span><span class="ident" id="4299972">x509</span><span class="op" id="4299976">.</span><span class="ident" id="4299977">Certificate</span><span class="op" id="4299988">)</span>&nbsp;<span class="op" id="4299990">(</span><span class="op" id="4299991">[</span><span class="op" id="4299992">]</span><span class="builtintype" id="4299993">byte</span><span class="op" id="4299997">,</span>&nbsp;<span class="op" id="4299999">*</span><span class="ident" id="4300000">clientKeyExchangeMsg</span><span class="op" id="4300020">,</span>&nbsp;<span class="builtintype" id="4300022">error</span><span class="op" id="4300027">)</span>&nbsp;<span class="op" id="4300029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4300032">if</span>&nbsp;<span class="ident" id="4300035">ka</span><span class="op" id="4300037">.</span><span class="ident" id="4300038">curve</span>&nbsp;<span class="op" id="4300044">==</span>&nbsp;<span class="builtintype" id="4300047">nil</span>&nbsp;<span class="op" id="4300051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4300055">return</span>&nbsp;<span class="builtintype" id="4300062">nil</span><span class="op" id="4300065">,</span>&nbsp;<span class="builtintype" id="4300067">nil</span><span class="op" id="4300070">,</span>&nbsp;<span class="ident" id="4300072">errors</span><span class="op" id="4300078">.</span><span class="ident" id="4300079">New</span><span class="op" id="4300082">(</span><span class="string" id="4300083">&#34;missing&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="4300118">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4300121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4300124">priv</span><span class="op" id="4300128">,</span>&nbsp;<span class="ident" id="4300130">mx</span><span class="op" id="4300132">,</span>&nbsp;<span class="ident" id="4300134">my</span><span class="op" id="4300136">,</span>&nbsp;<span class="ident" id="4300138">err</span>&nbsp;<span class="op" id="4300142">:=</span>&nbsp;<span class="ident" id="4300145">elliptic</span><span class="op" id="4300153">.</span><span class="ident" id="4300154">GenerateKey</span><span class="op" id="4300165">(</span><span class="ident" id="4300166">ka</span><span class="op" id="4300168">.</span><span class="ident" id="4300169">curve</span><span class="op" id="4300174">,</span>&nbsp;<span class="ident" id="4300176">config</span><span class="op" id="4300182">.</span><span class="ident" id="4300183">rand</span><span class="op" id="4300187">(</span><span class="op" id="4300188">)</span><span class="op" id="4300189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4300192">if</span>&nbsp;<span class="ident" id="4300195">err</span>&nbsp;<span class="op" id="4300199">!=</span>&nbsp;<span class="builtintype" id="4300202">nil</span>&nbsp;<span class="op" id="4300206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4300210">return</span>&nbsp;<span class="builtintype" id="4300217">nil</span><span class="op" id="4300220">,</span>&nbsp;<span class="builtintype" id="4300222">nil</span><span class="op" id="4300225">,</span>&nbsp;<span class="ident" id="4300227">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4300232">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4300235">x</span><span class="op" id="4300236">,</span>&nbsp;<span class="ident" id="4300238">_</span>&nbsp;<span class="op" id="4300240">:=</span>&nbsp;<span class="ident" id="4300243">ka</span><span class="op" id="4300245">.</span><span class="ident" id="4300246">curve</span><span class="op" id="4300251">.</span><span class="ident" id="4300252">ScalarMult</span><span class="op" id="4300262">(</span><span class="ident" id="4300263">ka</span><span class="op" id="4300265">.</span><span class="ident" id="4300266">x</span><span class="op" id="4300267">,</span>&nbsp;<span class="ident" id="4300269">ka</span><span class="op" id="4300271">.</span><span class="ident" id="4300272">y</span><span class="op" id="4300273">,</span>&nbsp;<span class="ident" id="4300275">priv</span><span class="op" id="4300279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4300282">preMasterSecret</span>&nbsp;<span class="op" id="4300298">:=</span>&nbsp;<span class="builtinfunc" id="4300301">make</span><span class="op" id="4300305">(</span><span class="op" id="4300306">[</span><span class="op" id="4300307">]</span><span class="builtintype" id="4300308">byte</span><span class="op" id="4300312">,</span>&nbsp;<span class="op" id="4300314">(</span><span class="ident" id="4300315">ka</span><span class="op" id="4300317">.</span><span class="ident" id="4300318">curve</span><span class="op" id="4300323">.</span><span class="ident" id="4300324">Params</span><span class="op" id="4300330">(</span><span class="op" id="4300331">)</span><span class="op" id="4300332">.</span><span class="ident" id="4300333">BitSize</span><span class="op" id="4300340">+</span><span class="num" id="4300341">7</span><span class="op" id="4300342">)</span><span class="op" id="4300343">&gt;&gt;</span><span class="num" id="4300345">3</span><span class="op" id="4300346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4300349">xBytes</span>&nbsp;<span class="op" id="4300356">:=</span>&nbsp;<span class="ident" id="4300359">x</span><span class="op" id="4300360">.</span><span class="ident" id="4300361">Bytes</span><span class="op" id="4300366">(</span><span class="op" id="4300367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4300370">copy</span><span class="op" id="4300374">(</span><span class="ident" id="4300375">preMasterSecret</span><span class="op" id="4300390">[</span><span class="builtinfunc" id="4300391">len</span><span class="op" id="4300394">(</span><span class="ident" id="4300395">preMasterSecret</span><span class="op" id="4300410">)</span><span class="op" id="4300411">-</span><span class="builtinfunc" id="4300412">len</span><span class="op" id="4300415">(</span><span class="ident" id="4300416">xBytes</span><span class="op" id="4300422">)</span><span class="op" id="4300423">:</span><span class="op" id="4300424">]</span><span class="op" id="4300425">,</span>&nbsp;<span class="ident" id="4300427">xBytes</span><span class="op" id="4300433">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4300437">serialized</span>&nbsp;<span class="op" id="4300448">:=</span>&nbsp;<span class="ident" id="4300451">elliptic</span><span class="op" id="4300459">.</span><span class="ident" id="4300460">Marshal</span><span class="op" id="4300467">(</span><span class="ident" id="4300468">ka</span><span class="op" id="4300470">.</span><span class="ident" id="4300471">curve</span><span class="op" id="4300476">,</span>&nbsp;<span class="ident" id="4300478">mx</span><span class="op" id="4300480">,</span>&nbsp;<span class="ident" id="4300482">my</span><span class="op" id="4300484">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4300488">ckx</span>&nbsp;<span class="op" id="4300492">:=</span>&nbsp;<span class="builtinfunc" id="4300495">new</span><span class="op" id="4300498">(</span><span class="ident" id="4300499">clientKeyExchangeMsg</span><span class="op" id="4300519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4300522">ckx</span><span class="op" id="4300525">.</span><span class="ident" id="4300526">ciphertext</span>&nbsp;<span class="op" id="4300537">=</span>&nbsp;<span class="builtinfunc" id="4300539">make</span><span class="op" id="4300543">(</span><span class="op" id="4300544">[</span><span class="op" id="4300545">]</span><span class="builtintype" id="4300546">byte</span><span class="op" id="4300550">,</span>&nbsp;<span class="num" id="4300552">1</span><span class="op" id="4300553">+</span><span class="builtinfunc" id="4300554">len</span><span class="op" id="4300557">(</span><span class="ident" id="4300558">serialized</span><span class="op" id="4300568">)</span><span class="op" id="4300569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4300572">ckx</span><span class="op" id="4300575">.</span><span class="ident" id="4300576">ciphertext</span><span class="op" id="4300586">[</span><span class="num" id="4300587">0</span><span class="op" id="4300588">]</span>&nbsp;<span class="op" id="4300590">=</span>&nbsp;<span class="builtintype" id="4300592">byte</span><span class="op" id="4300596">(</span><span class="builtinfunc" id="4300597">len</span><span class="op" id="4300600">(</span><span class="ident" id="4300601">serialized</span><span class="op" id="4300611">)</span><span class="op" id="4300612">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4300615">copy</span><span class="op" id="4300619">(</span><span class="ident" id="4300620">ckx</span><span class="op" id="4300623">.</span><span class="ident" id="4300624">ciphertext</span><span class="op" id="4300634">[</span><span class="num" id="4300635">1</span><span class="op" id="4300636">:</span><span class="op" id="4300637">]</span><span class="op" id="4300638">,</span>&nbsp;<span class="ident" id="4300640">serialized</span><span class="op" id="4300650">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4300654">return</span>&nbsp;<span class="ident" id="4300661">preMasterSecret</span><span class="op" id="4300676">,</span>&nbsp;<span class="ident" id="4300678">ckx</span><span class="op" id="4300681">,</span>&nbsp;<span class="builtintype" id="4300683">nil</span><br>
<span class="lineno"></span><span class="op" id="4300687">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
