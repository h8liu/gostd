<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6483674">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6483729">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6483783">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6483834">//&nbsp;Package&nbsp;fcgi&nbsp;implements&nbsp;the&nbsp;FastCGI&nbsp;protocol.</span><br>
<span class="lineno"></span><span class="comment" id="6483883">//&nbsp;Currently&nbsp;only&nbsp;the&nbsp;responder&nbsp;role&nbsp;is&nbsp;supported.</span><br>
<span class="lineno"></span><span class="comment" id="6483934">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;defined&nbsp;at&nbsp;http://www.fastcgi.com/drupal/node/6?q=node/22</span><br>
<span class="lineno"></span><span class="keyword" id="6484011">package</span>&nbsp;<span class="ident" id="6484019">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="6484025">//&nbsp;This&nbsp;file&nbsp;defines&nbsp;the&nbsp;raw&nbsp;protocol&nbsp;and&nbsp;some&nbsp;utilities&nbsp;used&nbsp;by&nbsp;the&nbsp;child&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6484104">//&nbsp;the&nbsp;host.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6484118">import</span>&nbsp;<span class="op" id="6484125">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6484128">&#34;bufio&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6484137">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6484146">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6484165">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6484175">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6484181">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="6484188">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6484191">//&nbsp;recType&nbsp;is&nbsp;a&nbsp;record&nbsp;type,&nbsp;as&nbsp;defined&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="6484234">//&nbsp;http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S8</span><br>
<span class="lineno"></span><span class="keyword" id="6484289">type</span>&nbsp;<span class="ident" id="6484294">recType</span>&nbsp;<span class="builtintype" id="6484302">uint8</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6484309">const</span>&nbsp;<span class="op" id="6484315">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484318">typeBeginRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6484338">recType</span>&nbsp;<span class="op" id="6484346">=</span>&nbsp;<span class="num" id="6484348">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484351">typeAbortRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6484371">recType</span>&nbsp;<span class="op" id="6484379">=</span>&nbsp;<span class="num" id="6484381">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484384">typeEndRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6484404">recType</span>&nbsp;<span class="op" id="6484412">=</span>&nbsp;<span class="num" id="6484414">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484417">typeParams</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6484437">recType</span>&nbsp;<span class="op" id="6484445">=</span>&nbsp;<span class="num" id="6484447">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484450">typeStdin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6484470">recType</span>&nbsp;<span class="op" id="6484478">=</span>&nbsp;<span class="num" id="6484480">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484483">typeStdout</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6484503">recType</span>&nbsp;<span class="op" id="6484511">=</span>&nbsp;<span class="num" id="6484513">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484516">typeStderr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6484536">recType</span>&nbsp;<span class="op" id="6484544">=</span>&nbsp;<span class="num" id="6484546">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484549">typeData</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6484569">recType</span>&nbsp;<span class="op" id="6484577">=</span>&nbsp;<span class="num" id="6484579">8</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484582">typeGetValues</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6484602">recType</span>&nbsp;<span class="op" id="6484610">=</span>&nbsp;<span class="num" id="6484612">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484615">typeGetValuesResult</span>&nbsp;<span class="ident" id="6484635">recType</span>&nbsp;<span class="op" id="6484643">=</span>&nbsp;<span class="num" id="6484645">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484649">typeUnknownType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6484669">recType</span>&nbsp;<span class="op" id="6484677">=</span>&nbsp;<span class="num" id="6484679">11</span><br>
<span class="lineno"></span><span class="op" id="6484682">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="6484685">//&nbsp;keep&nbsp;the&nbsp;connection&nbsp;between&nbsp;web-server&nbsp;and&nbsp;responder&nbsp;open&nbsp;after&nbsp;request</span><br>
<span class="lineno"></span><span class="keyword" id="6484760">const</span>&nbsp;<span class="ident" id="6484766">flagKeepConn</span>&nbsp;<span class="op" id="6484779">=</span>&nbsp;<span class="num" id="6484781">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6484784">const</span>&nbsp;<span class="op" id="6484790">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484793">maxWrite</span>&nbsp;<span class="op" id="6484802">=</span>&nbsp;<span class="num" id="6484804">65535</span>&nbsp;<span class="comment" id="6484810">//&nbsp;maximum&nbsp;record&nbsp;body</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484834">maxPad</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6484843">=</span>&nbsp;<span class="num" id="6484845">255</span><br>
<span class="lineno"></span><span class="op" id="6484849">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6484852">const</span>&nbsp;<span class="op" id="6484858">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484861">roleResponder</span>&nbsp;<span class="op" id="6484875">=</span>&nbsp;<span class="ident" id="6484877">iota</span>&nbsp;<span class="op" id="6484882">+</span>&nbsp;<span class="num" id="6484884">1</span>&nbsp;<span class="comment" id="6484886">//&nbsp;only&nbsp;Responders&nbsp;are&nbsp;implemented.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484923">roleAuthorizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484939">roleFilter</span><br>
<span class="lineno"></span><span class="op" id="6484950">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6484953">const</span>&nbsp;<span class="op" id="6484959">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484962">statusRequestComplete</span>&nbsp;<span class="op" id="6484984">=</span>&nbsp;<span class="ident" id="6484986">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6484992">statusCantMultiplex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485013">statusOverloaded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485031">statusUnknownRole</span><br>
<span class="lineno"></span><span class="op" id="6485049">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6485052">const</span>&nbsp;<span class="ident" id="6485058">headerLen</span>&nbsp;<span class="op" id="6485068">=</span>&nbsp;<span class="num" id="6485070">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6485073">type</span>&nbsp;<span class="ident" id="6485078">header</span>&nbsp;<span class="keyword" id="6485085">struct</span>&nbsp;<span class="op" id="6485092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485095">Version</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6485109">uint8</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485116">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6485130">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485139">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6485153">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485161">ContentLength</span>&nbsp;<span class="builtintype" id="6485175">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485183">PaddingLength</span>&nbsp;<span class="builtintype" id="6485197">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485204">Reserved</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6485218">uint8</span><br>
<span class="lineno">70</span><span class="op" id="6485224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6485227">type</span>&nbsp;<span class="ident" id="6485232">beginRequest</span>&nbsp;<span class="keyword" id="6485245">struct</span>&nbsp;<span class="op" id="6485252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485255">role</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6485264">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485272">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6485281">uint8</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485288">reserved</span>&nbsp;<span class="op" id="6485297">[</span><span class="num" id="6485298">5</span><span class="op" id="6485299">]</span><span class="builtintype" id="6485300">uint8</span><br>
<span class="lineno"></span><span class="op" id="6485306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6485309">func</span>&nbsp;<span class="op" id="6485314">(</span><span class="ident" id="6485315">br</span>&nbsp;<span class="op" id="6485318">*</span><span class="ident" id="6485319">beginRequest</span><span class="op" id="6485331">)</span>&nbsp;<span class="ident" id="6485333">read</span><span class="op" id="6485337">(</span><span class="ident" id="6485338">content</span>&nbsp;<span class="op" id="6485346">[</span><span class="op" id="6485347">]</span><span class="builtintype" id="6485348">byte</span><span class="op" id="6485352">)</span>&nbsp;<span class="builtintype" id="6485354">error</span>&nbsp;<span class="op" id="6485360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6485363">if</span>&nbsp;<span class="builtinfunc" id="6485366">len</span><span class="op" id="6485369">(</span><span class="ident" id="6485370">content</span><span class="op" id="6485377">)</span>&nbsp;<span class="op" id="6485379">!=</span>&nbsp;<span class="num" id="6485382">8</span>&nbsp;<span class="op" id="6485384">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6485388">return</span>&nbsp;<span class="ident" id="6485395">errors</span><span class="op" id="6485401">.</span><span class="ident" id="6485402">New</span><span class="op" id="6485405">(</span><span class="string" id="6485406">&#34;fcgi:&nbsp;invalid&nbsp;begin&nbsp;request&nbsp;record&#34;</span><span class="op" id="6485442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6485445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485448">br</span><span class="op" id="6485450">.</span><span class="ident" id="6485451">role</span>&nbsp;<span class="op" id="6485456">=</span>&nbsp;<span class="ident" id="6485458">binary</span><span class="op" id="6485464">.</span><span class="ident" id="6485465">BigEndian</span><span class="op" id="6485474">.</span><span class="ident" id="6485475">Uint16</span><span class="op" id="6485481">(</span><span class="ident" id="6485482">content</span><span class="op" id="6485489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485492">br</span><span class="op" id="6485494">.</span><span class="ident" id="6485495">flags</span>&nbsp;<span class="op" id="6485501">=</span>&nbsp;<span class="ident" id="6485503">content</span><span class="op" id="6485510">[</span><span class="num" id="6485511">2</span><span class="op" id="6485512">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6485515">return</span>&nbsp;<span class="ident" id="6485522">nil</span><br>
<span class="lineno">85</span><span class="op" id="6485526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6485529">//&nbsp;for&nbsp;padding&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to&nbsp;allocate&nbsp;all&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="6485586">//&nbsp;not&nbsp;synchronized&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;care&nbsp;what&nbsp;the&nbsp;contents&nbsp;are</span><br>
<span class="lineno"></span><span class="keyword" id="6485650">var</span>&nbsp;<span class="ident" id="6485654">pad</span>&nbsp;<span class="op" id="6485658">[</span><span class="ident" id="6485659">maxPad</span><span class="op" id="6485665">]</span><span class="builtintype" id="6485666">byte</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="6485672">func</span>&nbsp;<span class="op" id="6485677">(</span><span class="ident" id="6485678">h</span>&nbsp;<span class="op" id="6485680">*</span><span class="ident" id="6485681">header</span><span class="op" id="6485687">)</span>&nbsp;<span class="ident" id="6485689">init</span><span class="op" id="6485693">(</span><span class="ident" id="6485694">recType</span>&nbsp;<span class="ident" id="6485702">recType</span><span class="op" id="6485709">,</span>&nbsp;<span class="ident" id="6485711">reqId</span>&nbsp;<span class="builtintype" id="6485717">uint16</span><span class="op" id="6485723">,</span>&nbsp;<span class="ident" id="6485725">contentLength</span>&nbsp;<span class="builtintype" id="6485739">int</span><span class="op" id="6485742">)</span>&nbsp;<span class="op" id="6485744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485747">h</span><span class="op" id="6485748">.</span><span class="ident" id="6485749">Version</span>&nbsp;<span class="op" id="6485757">=</span>&nbsp;<span class="num" id="6485759">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485762">h</span><span class="op" id="6485763">.</span><span class="ident" id="6485764">Type</span>&nbsp;<span class="op" id="6485769">=</span>&nbsp;<span class="ident" id="6485771">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485780">h</span><span class="op" id="6485781">.</span><span class="ident" id="6485782">Id</span>&nbsp;<span class="op" id="6485785">=</span>&nbsp;<span class="ident" id="6485787">reqId</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485794">h</span><span class="op" id="6485795">.</span><span class="ident" id="6485796">ContentLength</span>&nbsp;<span class="op" id="6485810">=</span>&nbsp;<span class="builtintype" id="6485812">uint16</span><span class="op" id="6485818">(</span><span class="ident" id="6485819">contentLength</span><span class="op" id="6485832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485835">h</span><span class="op" id="6485836">.</span><span class="ident" id="6485837">PaddingLength</span>&nbsp;<span class="op" id="6485851">=</span>&nbsp;<span class="builtintype" id="6485853">uint8</span><span class="op" id="6485858">(</span><span class="op" id="6485859">-</span><span class="ident" id="6485860">contentLength</span>&nbsp;<span class="op" id="6485874">&amp;</span>&nbsp;<span class="num" id="6485876">7</span><span class="op" id="6485877">)</span><br>
<span class="lineno"></span><span class="op" id="6485879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6485882">//&nbsp;conn&nbsp;sends&nbsp;records&nbsp;over&nbsp;rwc</span><br>
<span class="lineno">100</span><span class="keyword" id="6485913">type</span>&nbsp;<span class="ident" id="6485918">conn</span>&nbsp;<span class="keyword" id="6485923">struct</span>&nbsp;<span class="op" id="6485930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485933">mutex</span>&nbsp;<span class="ident" id="6485939">sync</span><span class="op" id="6485943">.</span><span class="ident" id="6485944">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6485951">rwc</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6485957">io</span><span class="op" id="6485959">.</span><span class="ident" id="6485960">ReadWriteCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6485978">//&nbsp;to&nbsp;avoid&nbsp;allocations</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6486003">buf</span>&nbsp;<span class="ident" id="6486007">bytes</span><span class="op" id="6486012">.</span><span class="ident" id="6486013">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6486021">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6486025">header</span><br>
<span class="lineno"></span><span class="op" id="6486032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6486035">func</span>&nbsp;<span class="ident" id="6486040">newConn</span><span class="op" id="6486047">(</span><span class="ident" id="6486048">rwc</span>&nbsp;<span class="ident" id="6486052">io</span><span class="op" id="6486054">.</span><span class="ident" id="6486055">ReadWriteCloser</span><span class="op" id="6486070">)</span>&nbsp;<span class="op" id="6486072">*</span><span class="ident" id="6486073">conn</span>&nbsp;<span class="op" id="6486078">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6486081">return</span>&nbsp;<span class="op" id="6486088">&amp;</span><span class="ident" id="6486089">conn</span><span class="op" id="6486093">{</span><span class="ident" id="6486094">rwc</span><span class="op" id="6486097">:</span>&nbsp;<span class="ident" id="6486099">rwc</span><span class="op" id="6486102">}</span><br>
<span class="lineno"></span><span class="op" id="6486104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6486107">func</span>&nbsp;<span class="op" id="6486112">(</span><span class="ident" id="6486113">c</span>&nbsp;<span class="op" id="6486115">*</span><span class="ident" id="6486116">conn</span><span class="op" id="6486120">)</span>&nbsp;<span class="ident" id="6486122">Close</span><span class="op" id="6486127">(</span><span class="op" id="6486128">)</span>&nbsp;<span class="builtintype" id="6486130">error</span>&nbsp;<span class="op" id="6486136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6486139">c</span><span class="op" id="6486140">.</span><span class="ident" id="6486141">mutex</span><span class="op" id="6486146">.</span><span class="ident" id="6486147">Lock</span><span class="op" id="6486151">(</span><span class="op" id="6486152">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6486155">defer</span>&nbsp;<span class="ident" id="6486161">c</span><span class="op" id="6486162">.</span><span class="ident" id="6486163">mutex</span><span class="op" id="6486168">.</span><span class="ident" id="6486169">Unlock</span><span class="op" id="6486175">(</span><span class="op" id="6486176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6486179">return</span>&nbsp;<span class="ident" id="6486186">c</span><span class="op" id="6486187">.</span><span class="ident" id="6486188">rwc</span><span class="op" id="6486191">.</span><span class="ident" id="6486192">Close</span><span class="op" id="6486197">(</span><span class="op" id="6486198">)</span><br>
<span class="lineno"></span><span class="op" id="6486200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6486203">type</span>&nbsp;<span class="ident" id="6486208">record</span>&nbsp;<span class="keyword" id="6486215">struct</span>&nbsp;<span class="op" id="6486222">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6486225">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6486229">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6486237">buf</span>&nbsp;<span class="op" id="6486241">[</span><span class="ident" id="6486242">maxWrite</span>&nbsp;<span class="op" id="6486251">+</span>&nbsp;<span class="ident" id="6486253">maxPad</span><span class="op" id="6486259">]</span><span class="builtintype" id="6486260">byte</span><br>
<span class="lineno"></span><span class="op" id="6486265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6486268">func</span>&nbsp;<span class="op" id="6486273">(</span><span class="ident" id="6486274">rec</span>&nbsp;<span class="op" id="6486278">*</span><span class="ident" id="6486279">record</span><span class="op" id="6486285">)</span>&nbsp;<span class="ident" id="6486287">read</span><span class="op" id="6486291">(</span><span class="ident" id="6486292">r</span>&nbsp;<span class="ident" id="6486294">io</span><span class="op" id="6486296">.</span><span class="ident" id="6486297">Reader</span><span class="op" id="6486303">)</span>&nbsp;<span class="op" id="6486305">(</span><span class="ident" id="6486306">err</span>&nbsp;<span class="builtintype" id="6486310">error</span><span class="op" id="6486315">)</span>&nbsp;<span class="op" id="6486317">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6486320">if</span>&nbsp;<span class="ident" id="6486323">err</span>&nbsp;<span class="op" id="6486327">=</span>&nbsp;<span class="ident" id="6486329">binary</span><span class="op" id="6486335">.</span><span class="ident" id="6486336">Read</span><span class="op" id="6486340">(</span><span class="ident" id="6486341">r</span><span class="op" id="6486342">,</span>&nbsp;<span class="ident" id="6486344">binary</span><span class="op" id="6486350">.</span><span class="ident" id="6486351">BigEndian</span><span class="op" id="6486360">,</span>&nbsp;<span class="op" id="6486362">&amp;</span><span class="ident" id="6486363">rec</span><span class="op" id="6486366">.</span><span class="ident" id="6486367">h</span><span class="op" id="6486368">)</span><span class="op" id="6486369">;</span>&nbsp;<span class="ident" id="6486371">err</span>&nbsp;<span class="op" id="6486375">!=</span>&nbsp;<span class="ident" id="6486378">nil</span>&nbsp;<span class="op" id="6486382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6486386">return</span>&nbsp;<span class="ident" id="6486393">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6486398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6486401">if</span>&nbsp;<span class="ident" id="6486404">rec</span><span class="op" id="6486407">.</span><span class="ident" id="6486408">h</span><span class="op" id="6486409">.</span><span class="ident" id="6486410">Version</span>&nbsp;<span class="op" id="6486418">!=</span>&nbsp;<span class="num" id="6486421">1</span>&nbsp;<span class="op" id="6486423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6486427">return</span>&nbsp;<span class="ident" id="6486434">errors</span><span class="op" id="6486440">.</span><span class="ident" id="6486441">New</span><span class="op" id="6486444">(</span><span class="string" id="6486445">&#34;fcgi:&nbsp;invalid&nbsp;header&nbsp;version&#34;</span><span class="op" id="6486475">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6486478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6486481">n</span>&nbsp;<span class="op" id="6486483">:=</span>&nbsp;<span class="builtintype" id="6486486">int</span><span class="op" id="6486489">(</span><span class="ident" id="6486490">rec</span><span class="op" id="6486493">.</span><span class="ident" id="6486494">h</span><span class="op" id="6486495">.</span><span class="ident" id="6486496">ContentLength</span><span class="op" id="6486509">)</span>&nbsp;<span class="op" id="6486511">+</span>&nbsp;<span class="builtintype" id="6486513">int</span><span class="op" id="6486516">(</span><span class="ident" id="6486517">rec</span><span class="op" id="6486520">.</span><span class="ident" id="6486521">h</span><span class="op" id="6486522">.</span><span class="ident" id="6486523">PaddingLength</span><span class="op" id="6486536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6486539">if</span>&nbsp;<span class="ident" id="6486542">_</span><span class="op" id="6486543">,</span>&nbsp;<span class="ident" id="6486545">err</span>&nbsp;<span class="op" id="6486549">=</span>&nbsp;<span class="ident" id="6486551">io</span><span class="op" id="6486553">.</span><span class="ident" id="6486554">ReadFull</span><span class="op" id="6486562">(</span><span class="ident" id="6486563">r</span><span class="op" id="6486564">,</span>&nbsp;<span class="ident" id="6486566">rec</span><span class="op" id="6486569">.</span><span class="ident" id="6486570">buf</span><span class="op" id="6486573">[</span><span class="op" id="6486574">:</span><span class="ident" id="6486575">n</span><span class="op" id="6486576">]</span><span class="op" id="6486577">)</span><span class="op" id="6486578">;</span>&nbsp;<span class="ident" id="6486580">err</span>&nbsp;<span class="op" id="6486584">!=</span>&nbsp;<span class="ident" id="6486587">nil</span>&nbsp;<span class="op" id="6486591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6486595">return</span>&nbsp;<span class="ident" id="6486602">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6486607">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6486610">return</span>&nbsp;<span class="ident" id="6486617">nil</span><br>
<span class="lineno"></span><span class="op" id="6486621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6486624">func</span>&nbsp;<span class="op" id="6486629">(</span><span class="ident" id="6486630">r</span>&nbsp;<span class="op" id="6486632">*</span><span class="ident" id="6486633">record</span><span class="op" id="6486639">)</span>&nbsp;<span class="ident" id="6486641">content</span><span class="op" id="6486648">(</span><span class="op" id="6486649">)</span>&nbsp;<span class="op" id="6486651">[</span><span class="op" id="6486652">]</span><span class="builtintype" id="6486653">byte</span>&nbsp;<span class="op" id="6486658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6486661">return</span>&nbsp;<span class="ident" id="6486668">r</span><span class="op" id="6486669">.</span><span class="ident" id="6486670">buf</span><span class="op" id="6486673">[</span><span class="op" id="6486674">:</span><span class="ident" id="6486675">r</span><span class="op" id="6486676">.</span><span class="ident" id="6486677">h</span><span class="op" id="6486678">.</span><span class="ident" id="6486679">ContentLength</span><span class="op" id="6486692">]</span><br>
<span class="lineno">140</span><span class="op" id="6486694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6486697">//&nbsp;writeRecord&nbsp;writes&nbsp;and&nbsp;sends&nbsp;a&nbsp;single&nbsp;record.</span><br>
<span class="lineno"></span><span class="keyword" id="6486746">func</span>&nbsp;<span class="op" id="6486751">(</span><span class="ident" id="6486752">c</span>&nbsp;<span class="op" id="6486754">*</span><span class="ident" id="6486755">conn</span><span class="op" id="6486759">)</span>&nbsp;<span class="ident" id="6486761">writeRecord</span><span class="op" id="6486772">(</span><span class="ident" id="6486773">recType</span>&nbsp;<span class="ident" id="6486781">recType</span><span class="op" id="6486788">,</span>&nbsp;<span class="ident" id="6486790">reqId</span>&nbsp;<span class="builtintype" id="6486796">uint16</span><span class="op" id="6486802">,</span>&nbsp;<span class="ident" id="6486804">b</span>&nbsp;<span class="op" id="6486806">[</span><span class="op" id="6486807">]</span><span class="builtintype" id="6486808">byte</span><span class="op" id="6486812">)</span>&nbsp;<span class="builtintype" id="6486814">error</span>&nbsp;<span class="op" id="6486820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6486823">c</span><span class="op" id="6486824">.</span><span class="ident" id="6486825">mutex</span><span class="op" id="6486830">.</span><span class="ident" id="6486831">Lock</span><span class="op" id="6486835">(</span><span class="op" id="6486836">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6486839">defer</span>&nbsp;<span class="ident" id="6486845">c</span><span class="op" id="6486846">.</span><span class="ident" id="6486847">mutex</span><span class="op" id="6486852">.</span><span class="ident" id="6486853">Unlock</span><span class="op" id="6486859">(</span><span class="op" id="6486860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6486863">c</span><span class="op" id="6486864">.</span><span class="ident" id="6486865">buf</span><span class="op" id="6486868">.</span><span class="ident" id="6486869">Reset</span><span class="op" id="6486874">(</span><span class="op" id="6486875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6486878">c</span><span class="op" id="6486879">.</span><span class="ident" id="6486880">h</span><span class="op" id="6486881">.</span><span class="ident" id="6486882">init</span><span class="op" id="6486886">(</span><span class="ident" id="6486887">recType</span><span class="op" id="6486894">,</span>&nbsp;<span class="ident" id="6486896">reqId</span><span class="op" id="6486901">,</span>&nbsp;<span class="builtinfunc" id="6486903">len</span><span class="op" id="6486906">(</span><span class="ident" id="6486907">b</span><span class="op" id="6486908">)</span><span class="op" id="6486909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6486912">if</span>&nbsp;<span class="ident" id="6486915">err</span>&nbsp;<span class="op" id="6486919">:=</span>&nbsp;<span class="ident" id="6486922">binary</span><span class="op" id="6486928">.</span><span class="ident" id="6486929">Write</span><span class="op" id="6486934">(</span><span class="op" id="6486935">&amp;</span><span class="ident" id="6486936">c</span><span class="op" id="6486937">.</span><span class="ident" id="6486938">buf</span><span class="op" id="6486941">,</span>&nbsp;<span class="ident" id="6486943">binary</span><span class="op" id="6486949">.</span><span class="ident" id="6486950">BigEndian</span><span class="op" id="6486959">,</span>&nbsp;<span class="ident" id="6486961">c</span><span class="op" id="6486962">.</span><span class="ident" id="6486963">h</span><span class="op" id="6486964">)</span><span class="op" id="6486965">;</span>&nbsp;<span class="ident" id="6486967">err</span>&nbsp;<span class="op" id="6486971">!=</span>&nbsp;<span class="ident" id="6486974">nil</span>&nbsp;<span class="op" id="6486978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6486982">return</span>&nbsp;<span class="ident" id="6486989">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6486994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6486997">if</span>&nbsp;<span class="ident" id="6487000">_</span><span class="op" id="6487001">,</span>&nbsp;<span class="ident" id="6487003">err</span>&nbsp;<span class="op" id="6487007">:=</span>&nbsp;<span class="ident" id="6487010">c</span><span class="op" id="6487011">.</span><span class="ident" id="6487012">buf</span><span class="op" id="6487015">.</span><span class="ident" id="6487016">Write</span><span class="op" id="6487021">(</span><span class="ident" id="6487022">b</span><span class="op" id="6487023">)</span><span class="op" id="6487024">;</span>&nbsp;<span class="ident" id="6487026">err</span>&nbsp;<span class="op" id="6487030">!=</span>&nbsp;<span class="ident" id="6487033">nil</span>&nbsp;<span class="op" id="6487037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6487041">return</span>&nbsp;<span class="ident" id="6487048">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6487053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6487056">if</span>&nbsp;<span class="ident" id="6487059">_</span><span class="op" id="6487060">,</span>&nbsp;<span class="ident" id="6487062">err</span>&nbsp;<span class="op" id="6487066">:=</span>&nbsp;<span class="ident" id="6487069">c</span><span class="op" id="6487070">.</span><span class="ident" id="6487071">buf</span><span class="op" id="6487074">.</span><span class="ident" id="6487075">Write</span><span class="op" id="6487080">(</span><span class="ident" id="6487081">pad</span><span class="op" id="6487084">[</span><span class="op" id="6487085">:</span><span class="ident" id="6487086">c</span><span class="op" id="6487087">.</span><span class="ident" id="6487088">h</span><span class="op" id="6487089">.</span><span class="ident" id="6487090">PaddingLength</span><span class="op" id="6487103">]</span><span class="op" id="6487104">)</span><span class="op" id="6487105">;</span>&nbsp;<span class="ident" id="6487107">err</span>&nbsp;<span class="op" id="6487111">!=</span>&nbsp;<span class="ident" id="6487114">nil</span>&nbsp;<span class="op" id="6487118">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6487122">return</span>&nbsp;<span class="ident" id="6487129">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6487134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6487137">_</span><span class="op" id="6487138">,</span>&nbsp;<span class="ident" id="6487140">err</span>&nbsp;<span class="op" id="6487144">:=</span>&nbsp;<span class="ident" id="6487147">c</span><span class="op" id="6487148">.</span><span class="ident" id="6487149">rwc</span><span class="op" id="6487152">.</span><span class="ident" id="6487153">Write</span><span class="op" id="6487158">(</span><span class="ident" id="6487159">c</span><span class="op" id="6487160">.</span><span class="ident" id="6487161">buf</span><span class="op" id="6487164">.</span><span class="ident" id="6487165">Bytes</span><span class="op" id="6487170">(</span><span class="op" id="6487171">)</span><span class="op" id="6487172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6487175">return</span>&nbsp;<span class="ident" id="6487182">err</span><br>
<span class="lineno"></span><span class="op" id="6487186">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="keyword" id="6487189">func</span>&nbsp;<span class="op" id="6487194">(</span><span class="ident" id="6487195">c</span>&nbsp;<span class="op" id="6487197">*</span><span class="ident" id="6487198">conn</span><span class="op" id="6487202">)</span>&nbsp;<span class="ident" id="6487204">writeBeginRequest</span><span class="op" id="6487221">(</span><span class="ident" id="6487222">reqId</span>&nbsp;<span class="builtintype" id="6487228">uint16</span><span class="op" id="6487234">,</span>&nbsp;<span class="ident" id="6487236">role</span>&nbsp;<span class="builtintype" id="6487241">uint16</span><span class="op" id="6487247">,</span>&nbsp;<span class="ident" id="6487249">flags</span>&nbsp;<span class="builtintype" id="6487255">uint8</span><span class="op" id="6487260">)</span>&nbsp;<span class="builtintype" id="6487262">error</span>&nbsp;<span class="op" id="6487268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6487271">b</span>&nbsp;<span class="op" id="6487273">:=</span>&nbsp;<span class="op" id="6487276">[</span><span class="num" id="6487277">8</span><span class="op" id="6487278">]</span><span class="builtintype" id="6487279">byte</span><span class="op" id="6487283">{</span><span class="builtintype" id="6487284">byte</span><span class="op" id="6487288">(</span><span class="ident" id="6487289">role</span>&nbsp;<span class="op" id="6487294">&gt;&gt;</span>&nbsp;<span class="num" id="6487297">8</span><span class="op" id="6487298">)</span><span class="op" id="6487299">,</span>&nbsp;<span class="builtintype" id="6487301">byte</span><span class="op" id="6487305">(</span><span class="ident" id="6487306">role</span><span class="op" id="6487310">)</span><span class="op" id="6487311">,</span>&nbsp;<span class="ident" id="6487313">flags</span><span class="op" id="6487318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6487321">return</span>&nbsp;<span class="ident" id="6487328">c</span><span class="op" id="6487329">.</span><span class="ident" id="6487330">writeRecord</span><span class="op" id="6487341">(</span><span class="ident" id="6487342">typeBeginRequest</span><span class="op" id="6487358">,</span>&nbsp;<span class="ident" id="6487360">reqId</span><span class="op" id="6487365">,</span>&nbsp;<span class="ident" id="6487367">b</span><span class="op" id="6487368">[</span><span class="op" id="6487369">:</span><span class="op" id="6487370">]</span><span class="op" id="6487371">)</span><br>
<span class="lineno"></span><span class="op" id="6487373">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="6487376">func</span>&nbsp;<span class="op" id="6487381">(</span><span class="ident" id="6487382">c</span>&nbsp;<span class="op" id="6487384">*</span><span class="ident" id="6487385">conn</span><span class="op" id="6487389">)</span>&nbsp;<span class="ident" id="6487391">writeEndRequest</span><span class="op" id="6487406">(</span><span class="ident" id="6487407">reqId</span>&nbsp;<span class="builtintype" id="6487413">uint16</span><span class="op" id="6487419">,</span>&nbsp;<span class="ident" id="6487421">appStatus</span>&nbsp;<span class="builtintype" id="6487431">int</span><span class="op" id="6487434">,</span>&nbsp;<span class="ident" id="6487436">protocolStatus</span>&nbsp;<span class="builtintype" id="6487451">uint8</span><span class="op" id="6487456">)</span>&nbsp;<span class="builtintype" id="6487458">error</span>&nbsp;<span class="op" id="6487464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6487467">b</span>&nbsp;<span class="op" id="6487469">:=</span>&nbsp;<span class="builtinfunc" id="6487472">make</span><span class="op" id="6487476">(</span><span class="op" id="6487477">[</span><span class="op" id="6487478">]</span><span class="builtintype" id="6487479">byte</span><span class="op" id="6487483">,</span>&nbsp;<span class="num" id="6487485">8</span><span class="op" id="6487486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6487489">binary</span><span class="op" id="6487495">.</span><span class="ident" id="6487496">BigEndian</span><span class="op" id="6487505">.</span><span class="ident" id="6487506">PutUint32</span><span class="op" id="6487515">(</span><span class="ident" id="6487516">b</span><span class="op" id="6487517">,</span>&nbsp;<span class="builtintype" id="6487519">uint32</span><span class="op" id="6487525">(</span><span class="ident" id="6487526">appStatus</span><span class="op" id="6487535">)</span><span class="op" id="6487536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6487539">b</span><span class="op" id="6487540">[</span><span class="num" id="6487541">4</span><span class="op" id="6487542">]</span>&nbsp;<span class="op" id="6487544">=</span>&nbsp;<span class="ident" id="6487546">protocolStatus</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6487562">return</span>&nbsp;<span class="ident" id="6487569">c</span><span class="op" id="6487570">.</span><span class="ident" id="6487571">writeRecord</span><span class="op" id="6487582">(</span><span class="ident" id="6487583">typeEndRequest</span><span class="op" id="6487597">,</span>&nbsp;<span class="ident" id="6487599">reqId</span><span class="op" id="6487604">,</span>&nbsp;<span class="ident" id="6487606">b</span><span class="op" id="6487607">)</span><br>
<span class="lineno"></span><span class="op" id="6487609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6487612">func</span>&nbsp;<span class="op" id="6487617">(</span><span class="ident" id="6487618">c</span>&nbsp;<span class="op" id="6487620">*</span><span class="ident" id="6487621">conn</span><span class="op" id="6487625">)</span>&nbsp;<span class="ident" id="6487627">writePairs</span><span class="op" id="6487637">(</span><span class="ident" id="6487638">recType</span>&nbsp;<span class="ident" id="6487646">recType</span><span class="op" id="6487653">,</span>&nbsp;<span class="ident" id="6487655">reqId</span>&nbsp;<span class="builtintype" id="6487661">uint16</span><span class="op" id="6487667">,</span>&nbsp;<span class="ident" id="6487669">pairs</span>&nbsp;<span class="keyword" id="6487675">map</span><span class="op" id="6487678">[</span><span class="builtintype" id="6487679">string</span><span class="op" id="6487685">]</span><span class="builtintype" id="6487686">string</span><span class="op" id="6487692">)</span>&nbsp;<span class="builtintype" id="6487694">error</span>&nbsp;<span class="op" id="6487700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6487703">w</span>&nbsp;<span class="op" id="6487705">:=</span>&nbsp;<span class="ident" id="6487708">newWriter</span><span class="op" id="6487717">(</span><span class="ident" id="6487718">c</span><span class="op" id="6487719">,</span>&nbsp;<span class="ident" id="6487721">recType</span><span class="op" id="6487728">,</span>&nbsp;<span class="ident" id="6487730">reqId</span><span class="op" id="6487735">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6487738">b</span>&nbsp;<span class="op" id="6487740">:=</span>&nbsp;<span class="builtinfunc" id="6487743">make</span><span class="op" id="6487747">(</span><span class="op" id="6487748">[</span><span class="op" id="6487749">]</span><span class="builtintype" id="6487750">byte</span><span class="op" id="6487754">,</span>&nbsp;<span class="num" id="6487756">8</span><span class="op" id="6487757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6487760">for</span>&nbsp;<span class="ident" id="6487764">k</span><span class="op" id="6487765">,</span>&nbsp;<span class="ident" id="6487767">v</span>&nbsp;<span class="op" id="6487769">:=</span>&nbsp;<span class="keyword" id="6487772">range</span>&nbsp;<span class="ident" id="6487778">pairs</span>&nbsp;<span class="op" id="6487784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6487788">n</span>&nbsp;<span class="op" id="6487790">:=</span>&nbsp;<span class="ident" id="6487793">encodeSize</span><span class="op" id="6487803">(</span><span class="ident" id="6487804">b</span><span class="op" id="6487805">,</span>&nbsp;<span class="builtintype" id="6487807">uint32</span><span class="op" id="6487813">(</span><span class="builtinfunc" id="6487814">len</span><span class="op" id="6487817">(</span><span class="ident" id="6487818">k</span><span class="op" id="6487819">)</span><span class="op" id="6487820">)</span><span class="op" id="6487821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6487825">n</span>&nbsp;<span class="op" id="6487827">+=</span>&nbsp;<span class="ident" id="6487830">encodeSize</span><span class="op" id="6487840">(</span><span class="ident" id="6487841">b</span><span class="op" id="6487842">[</span><span class="ident" id="6487843">n</span><span class="op" id="6487844">:</span><span class="op" id="6487845">]</span><span class="op" id="6487846">,</span>&nbsp;<span class="builtintype" id="6487848">uint32</span><span class="op" id="6487854">(</span><span class="builtinfunc" id="6487855">len</span><span class="op" id="6487858">(</span><span class="ident" id="6487859">v</span><span class="op" id="6487860">)</span><span class="op" id="6487861">)</span><span class="op" id="6487862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6487866">if</span>&nbsp;<span class="ident" id="6487869">_</span><span class="op" id="6487870">,</span>&nbsp;<span class="ident" id="6487872">err</span>&nbsp;<span class="op" id="6487876">:=</span>&nbsp;<span class="ident" id="6487879">w</span><span class="op" id="6487880">.</span><span class="ident" id="6487881">Write</span><span class="op" id="6487886">(</span><span class="ident" id="6487887">b</span><span class="op" id="6487888">[</span><span class="op" id="6487889">:</span><span class="ident" id="6487890">n</span><span class="op" id="6487891">]</span><span class="op" id="6487892">)</span><span class="op" id="6487893">;</span>&nbsp;<span class="ident" id="6487895">err</span>&nbsp;<span class="op" id="6487899">!=</span>&nbsp;<span class="ident" id="6487902">nil</span>&nbsp;<span class="op" id="6487906">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6487911">return</span>&nbsp;<span class="ident" id="6487918">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6487924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6487928">if</span>&nbsp;<span class="ident" id="6487931">_</span><span class="op" id="6487932">,</span>&nbsp;<span class="ident" id="6487934">err</span>&nbsp;<span class="op" id="6487938">:=</span>&nbsp;<span class="ident" id="6487941">w</span><span class="op" id="6487942">.</span><span class="ident" id="6487943">WriteString</span><span class="op" id="6487954">(</span><span class="ident" id="6487955">k</span><span class="op" id="6487956">)</span><span class="op" id="6487957">;</span>&nbsp;<span class="ident" id="6487959">err</span>&nbsp;<span class="op" id="6487963">!=</span>&nbsp;<span class="ident" id="6487966">nil</span>&nbsp;<span class="op" id="6487970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6487975">return</span>&nbsp;<span class="ident" id="6487982">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6487988">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6487992">if</span>&nbsp;<span class="ident" id="6487995">_</span><span class="op" id="6487996">,</span>&nbsp;<span class="ident" id="6487998">err</span>&nbsp;<span class="op" id="6488002">:=</span>&nbsp;<span class="ident" id="6488005">w</span><span class="op" id="6488006">.</span><span class="ident" id="6488007">WriteString</span><span class="op" id="6488018">(</span><span class="ident" id="6488019">v</span><span class="op" id="6488020">)</span><span class="op" id="6488021">;</span>&nbsp;<span class="ident" id="6488023">err</span>&nbsp;<span class="op" id="6488027">!=</span>&nbsp;<span class="ident" id="6488030">nil</span>&nbsp;<span class="op" id="6488034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488039">return</span>&nbsp;<span class="ident" id="6488046">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6488052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6488055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6488058">w</span><span class="op" id="6488059">.</span><span class="ident" id="6488060">Close</span><span class="op" id="6488065">(</span><span class="op" id="6488066">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488069">return</span>&nbsp;<span class="ident" id="6488076">nil</span><br>
<span class="lineno"></span><span class="op" id="6488080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6488083">func</span>&nbsp;<span class="ident" id="6488088">readSize</span><span class="op" id="6488096">(</span><span class="ident" id="6488097">s</span>&nbsp;<span class="op" id="6488099">[</span><span class="op" id="6488100">]</span><span class="builtintype" id="6488101">byte</span><span class="op" id="6488105">)</span>&nbsp;<span class="op" id="6488107">(</span><span class="builtintype" id="6488108">uint32</span><span class="op" id="6488114">,</span>&nbsp;<span class="builtintype" id="6488116">int</span><span class="op" id="6488119">)</span>&nbsp;<span class="op" id="6488121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488124">if</span>&nbsp;<span class="builtinfunc" id="6488127">len</span><span class="op" id="6488130">(</span><span class="ident" id="6488131">s</span><span class="op" id="6488132">)</span>&nbsp;<span class="op" id="6488134">==</span>&nbsp;<span class="num" id="6488137">0</span>&nbsp;<span class="op" id="6488139">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488143">return</span>&nbsp;<span class="num" id="6488150">0</span><span class="op" id="6488151">,</span>&nbsp;<span class="num" id="6488153">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6488156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6488159">size</span><span class="op" id="6488163">,</span>&nbsp;<span class="ident" id="6488165">n</span>&nbsp;<span class="op" id="6488167">:=</span>&nbsp;<span class="builtintype" id="6488170">uint32</span><span class="op" id="6488176">(</span><span class="ident" id="6488177">s</span><span class="op" id="6488178">[</span><span class="num" id="6488179">0</span><span class="op" id="6488180">]</span><span class="op" id="6488181">)</span><span class="op" id="6488182">,</span>&nbsp;<span class="num" id="6488184">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488187">if</span>&nbsp;<span class="ident" id="6488190">size</span><span class="op" id="6488194">&amp;</span><span class="op" id="6488195">(</span><span class="num" id="6488196">1</span><span class="op" id="6488197">&lt;&lt;</span><span class="num" id="6488199">7</span><span class="op" id="6488200">)</span>&nbsp;<span class="op" id="6488202">!=</span>&nbsp;<span class="num" id="6488205">0</span>&nbsp;<span class="op" id="6488207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488211">if</span>&nbsp;<span class="builtinfunc" id="6488214">len</span><span class="op" id="6488217">(</span><span class="ident" id="6488218">s</span><span class="op" id="6488219">)</span>&nbsp;<span class="op" id="6488221">&lt;</span>&nbsp;<span class="num" id="6488223">4</span>&nbsp;<span class="op" id="6488225">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488230">return</span>&nbsp;<span class="num" id="6488237">0</span><span class="op" id="6488238">,</span>&nbsp;<span class="num" id="6488240">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6488244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6488248">n</span>&nbsp;<span class="op" id="6488250">=</span>&nbsp;<span class="num" id="6488252">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6488256">size</span>&nbsp;<span class="op" id="6488261">=</span>&nbsp;<span class="ident" id="6488263">binary</span><span class="op" id="6488269">.</span><span class="ident" id="6488270">BigEndian</span><span class="op" id="6488279">.</span><span class="ident" id="6488280">Uint32</span><span class="op" id="6488286">(</span><span class="ident" id="6488287">s</span><span class="op" id="6488288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6488292">size</span>&nbsp;<span class="op" id="6488297">&amp;^=</span>&nbsp;<span class="num" id="6488301">1</span>&nbsp;<span class="op" id="6488303">&lt;&lt;</span>&nbsp;<span class="num" id="6488306">31</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6488310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488313">return</span>&nbsp;<span class="ident" id="6488320">size</span><span class="op" id="6488324">,</span>&nbsp;<span class="ident" id="6488326">n</span><br>
<span class="lineno"></span><span class="op" id="6488328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6488331">func</span>&nbsp;<span class="ident" id="6488336">readString</span><span class="op" id="6488346">(</span><span class="ident" id="6488347">s</span>&nbsp;<span class="op" id="6488349">[</span><span class="op" id="6488350">]</span><span class="builtintype" id="6488351">byte</span><span class="op" id="6488355">,</span>&nbsp;<span class="ident" id="6488357">size</span>&nbsp;<span class="builtintype" id="6488362">uint32</span><span class="op" id="6488368">)</span>&nbsp;<span class="builtintype" id="6488370">string</span>&nbsp;<span class="op" id="6488377">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488380">if</span>&nbsp;<span class="ident" id="6488383">size</span>&nbsp;<span class="op" id="6488388">&gt;</span>&nbsp;<span class="builtintype" id="6488390">uint32</span><span class="op" id="6488396">(</span><span class="builtinfunc" id="6488397">len</span><span class="op" id="6488400">(</span><span class="ident" id="6488401">s</span><span class="op" id="6488402">)</span><span class="op" id="6488403">)</span>&nbsp;<span class="op" id="6488405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488409">return</span>&nbsp;<span class="string" id="6488416">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6488420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488423">return</span>&nbsp;<span class="builtintype" id="6488430">string</span><span class="op" id="6488436">(</span><span class="ident" id="6488437">s</span><span class="op" id="6488438">[</span><span class="op" id="6488439">:</span><span class="ident" id="6488440">size</span><span class="op" id="6488444">]</span><span class="op" id="6488445">)</span><br>
<span class="lineno"></span><span class="op" id="6488447">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6488450">func</span>&nbsp;<span class="ident" id="6488455">encodeSize</span><span class="op" id="6488465">(</span><span class="ident" id="6488466">b</span>&nbsp;<span class="op" id="6488468">[</span><span class="op" id="6488469">]</span><span class="builtintype" id="6488470">byte</span><span class="op" id="6488474">,</span>&nbsp;<span class="ident" id="6488476">size</span>&nbsp;<span class="builtintype" id="6488481">uint32</span><span class="op" id="6488487">)</span>&nbsp;<span class="builtintype" id="6488489">int</span>&nbsp;<span class="op" id="6488493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488496">if</span>&nbsp;<span class="ident" id="6488499">size</span>&nbsp;<span class="op" id="6488504">&gt;</span>&nbsp;<span class="num" id="6488506">127</span>&nbsp;<span class="op" id="6488510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6488514">size</span>&nbsp;<span class="op" id="6488519">|=</span>&nbsp;<span class="num" id="6488522">1</span>&nbsp;<span class="op" id="6488524">&lt;&lt;</span>&nbsp;<span class="num" id="6488527">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6488532">binary</span><span class="op" id="6488538">.</span><span class="ident" id="6488539">BigEndian</span><span class="op" id="6488548">.</span><span class="ident" id="6488549">PutUint32</span><span class="op" id="6488558">(</span><span class="ident" id="6488559">b</span><span class="op" id="6488560">,</span>&nbsp;<span class="ident" id="6488562">size</span><span class="op" id="6488566">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488570">return</span>&nbsp;<span class="num" id="6488577">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6488580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6488583">b</span><span class="op" id="6488584">[</span><span class="num" id="6488585">0</span><span class="op" id="6488586">]</span>&nbsp;<span class="op" id="6488588">=</span>&nbsp;<span class="builtintype" id="6488590">byte</span><span class="op" id="6488594">(</span><span class="ident" id="6488595">size</span><span class="op" id="6488599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488602">return</span>&nbsp;<span class="num" id="6488609">1</span><br>
<span class="lineno"></span><span class="op" id="6488611">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="6488614">//&nbsp;bufWriter&nbsp;encapsulates&nbsp;bufio.Writer&nbsp;but&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;stream&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="6488696">//&nbsp;Closed.</span><br>
<span class="lineno"></span><span class="keyword" id="6488707">type</span>&nbsp;<span class="ident" id="6488712">bufWriter</span>&nbsp;<span class="keyword" id="6488722">struct</span>&nbsp;<span class="op" id="6488729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6488732">closer</span>&nbsp;<span class="ident" id="6488739">io</span><span class="op" id="6488741">.</span><span class="ident" id="6488742">Closer</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6488750">*</span><span class="ident" id="6488751">bufio</span><span class="op" id="6488756">.</span><span class="ident" id="6488757">Writer</span><br>
<span class="lineno"></span><span class="op" id="6488764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6488767">func</span>&nbsp;<span class="op" id="6488772">(</span><span class="ident" id="6488773">w</span>&nbsp;<span class="op" id="6488775">*</span><span class="ident" id="6488776">bufWriter</span><span class="op" id="6488785">)</span>&nbsp;<span class="ident" id="6488787">Close</span><span class="op" id="6488792">(</span><span class="op" id="6488793">)</span>&nbsp;<span class="builtintype" id="6488795">error</span>&nbsp;<span class="op" id="6488801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488804">if</span>&nbsp;<span class="ident" id="6488807">err</span>&nbsp;<span class="op" id="6488811">:=</span>&nbsp;<span class="ident" id="6488814">w</span><span class="op" id="6488815">.</span><span class="ident" id="6488816">Writer</span><span class="op" id="6488822">.</span><span class="ident" id="6488823">Flush</span><span class="op" id="6488828">(</span><span class="op" id="6488829">)</span><span class="op" id="6488830">;</span>&nbsp;<span class="ident" id="6488832">err</span>&nbsp;<span class="op" id="6488836">!=</span>&nbsp;<span class="ident" id="6488839">nil</span>&nbsp;<span class="op" id="6488843">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6488847">w</span><span class="op" id="6488848">.</span><span class="ident" id="6488849">closer</span><span class="op" id="6488855">.</span><span class="ident" id="6488856">Close</span><span class="op" id="6488861">(</span><span class="op" id="6488862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488866">return</span>&nbsp;<span class="ident" id="6488873">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6488878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6488881">return</span>&nbsp;<span class="ident" id="6488888">w</span><span class="op" id="6488889">.</span><span class="ident" id="6488890">closer</span><span class="op" id="6488896">.</span><span class="ident" id="6488897">Close</span><span class="op" id="6488902">(</span><span class="op" id="6488903">)</span><br>
<span class="lineno"></span><span class="op" id="6488905">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword" id="6488908">func</span>&nbsp;<span class="ident" id="6488913">newWriter</span><span class="op" id="6488922">(</span><span class="ident" id="6488923">c</span>&nbsp;<span class="op" id="6488925">*</span><span class="ident" id="6488926">conn</span><span class="op" id="6488930">,</span>&nbsp;<span class="ident" id="6488932">recType</span>&nbsp;<span class="ident" id="6488940">recType</span><span class="op" id="6488947">,</span>&nbsp;<span class="ident" id="6488949">reqId</span>&nbsp;<span class="builtintype" id="6488955">uint16</span><span class="op" id="6488961">)</span>&nbsp;<span class="op" id="6488963">*</span><span class="ident" id="6488964">bufWriter</span>&nbsp;<span class="op" id="6488974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6488977">s</span>&nbsp;<span class="op" id="6488979">:=</span>&nbsp;<span class="op" id="6488982">&amp;</span><span class="ident" id="6488983">streamWriter</span><span class="op" id="6488995">{</span><span class="ident" id="6488996">c</span><span class="op" id="6488997">:</span>&nbsp;<span class="ident" id="6488999">c</span><span class="op" id="6489000">,</span>&nbsp;<span class="ident" id="6489002">recType</span><span class="op" id="6489009">:</span>&nbsp;<span class="ident" id="6489011">recType</span><span class="op" id="6489018">,</span>&nbsp;<span class="ident" id="6489020">reqId</span><span class="op" id="6489025">:</span>&nbsp;<span class="ident" id="6489027">reqId</span><span class="op" id="6489032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6489035">w</span>&nbsp;<span class="op" id="6489037">:=</span>&nbsp;<span class="ident" id="6489040">bufio</span><span class="op" id="6489045">.</span><span class="ident" id="6489046">NewWriterSize</span><span class="op" id="6489059">(</span><span class="ident" id="6489060">s</span><span class="op" id="6489061">,</span>&nbsp;<span class="ident" id="6489063">maxWrite</span><span class="op" id="6489071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6489074">return</span>&nbsp;<span class="op" id="6489081">&amp;</span><span class="ident" id="6489082">bufWriter</span><span class="op" id="6489091">{</span><span class="ident" id="6489092">s</span><span class="op" id="6489093">,</span>&nbsp;<span class="ident" id="6489095">w</span><span class="op" id="6489096">}</span><br>
<span class="lineno">245</span><span class="op" id="6489098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6489101">//&nbsp;streamWriter&nbsp;abstracts&nbsp;out&nbsp;the&nbsp;separation&nbsp;of&nbsp;a&nbsp;stream&nbsp;into&nbsp;discrete&nbsp;records.</span><br>
<span class="lineno"></span><span class="comment" id="6489181">//&nbsp;It&nbsp;only&nbsp;writes&nbsp;maxWrite&nbsp;bytes&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="6489225">type</span>&nbsp;<span class="ident" id="6489230">streamWriter</span>&nbsp;<span class="keyword" id="6489243">struct</span>&nbsp;<span class="op" id="6489250">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6489253">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6489261">*</span><span class="ident" id="6489262">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6489268">recType</span>&nbsp;<span class="ident" id="6489276">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6489285">reqId</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6489293">uint16</span><br>
<span class="lineno"></span><span class="op" id="6489300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="6489303">func</span>&nbsp;<span class="op" id="6489308">(</span><span class="ident" id="6489309">w</span>&nbsp;<span class="op" id="6489311">*</span><span class="ident" id="6489312">streamWriter</span><span class="op" id="6489324">)</span>&nbsp;<span class="ident" id="6489326">Write</span><span class="op" id="6489331">(</span><span class="ident" id="6489332">p</span>&nbsp;<span class="op" id="6489334">[</span><span class="op" id="6489335">]</span><span class="builtintype" id="6489336">byte</span><span class="op" id="6489340">)</span>&nbsp;<span class="op" id="6489342">(</span><span class="builtintype" id="6489343">int</span><span class="op" id="6489346">,</span>&nbsp;<span class="builtintype" id="6489348">error</span><span class="op" id="6489353">)</span>&nbsp;<span class="op" id="6489355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6489358">nn</span>&nbsp;<span class="op" id="6489361">:=</span>&nbsp;<span class="num" id="6489364">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6489367">for</span>&nbsp;<span class="builtinfunc" id="6489371">len</span><span class="op" id="6489374">(</span><span class="ident" id="6489375">p</span><span class="op" id="6489376">)</span>&nbsp;<span class="op" id="6489378">&gt;</span>&nbsp;<span class="num" id="6489380">0</span>&nbsp;<span class="op" id="6489382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6489386">n</span>&nbsp;<span class="op" id="6489388">:=</span>&nbsp;<span class="builtinfunc" id="6489391">len</span><span class="op" id="6489394">(</span><span class="ident" id="6489395">p</span><span class="op" id="6489396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6489400">if</span>&nbsp;<span class="ident" id="6489403">n</span>&nbsp;<span class="op" id="6489405">&gt;</span>&nbsp;<span class="ident" id="6489407">maxWrite</span>&nbsp;<span class="op" id="6489416">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6489421">n</span>&nbsp;<span class="op" id="6489423">=</span>&nbsp;<span class="ident" id="6489425">maxWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6489436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6489440">if</span>&nbsp;<span class="ident" id="6489443">err</span>&nbsp;<span class="op" id="6489447">:=</span>&nbsp;<span class="ident" id="6489450">w</span><span class="op" id="6489451">.</span><span class="ident" id="6489452">c</span><span class="op" id="6489453">.</span><span class="ident" id="6489454">writeRecord</span><span class="op" id="6489465">(</span><span class="ident" id="6489466">w</span><span class="op" id="6489467">.</span><span class="ident" id="6489468">recType</span><span class="op" id="6489475">,</span>&nbsp;<span class="ident" id="6489477">w</span><span class="op" id="6489478">.</span><span class="ident" id="6489479">reqId</span><span class="op" id="6489484">,</span>&nbsp;<span class="ident" id="6489486">p</span><span class="op" id="6489487">[</span><span class="op" id="6489488">:</span><span class="ident" id="6489489">n</span><span class="op" id="6489490">]</span><span class="op" id="6489491">)</span><span class="op" id="6489492">;</span>&nbsp;<span class="ident" id="6489494">err</span>&nbsp;<span class="op" id="6489498">!=</span>&nbsp;<span class="ident" id="6489501">nil</span>&nbsp;<span class="op" id="6489505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6489510">return</span>&nbsp;<span class="ident" id="6489517">nn</span><span class="op" id="6489519">,</span>&nbsp;<span class="ident" id="6489521">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6489527">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6489531">nn</span>&nbsp;<span class="op" id="6489534">+=</span>&nbsp;<span class="ident" id="6489537">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6489541">p</span>&nbsp;<span class="op" id="6489543">=</span>&nbsp;<span class="ident" id="6489545">p</span><span class="op" id="6489546">[</span><span class="ident" id="6489547">n</span><span class="op" id="6489548">:</span><span class="op" id="6489549">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6489552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6489555">return</span>&nbsp;<span class="ident" id="6489562">nn</span><span class="op" id="6489564">,</span>&nbsp;<span class="ident" id="6489566">nil</span><br>
<span class="lineno"></span><span class="op" id="6489570">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="6489573">func</span>&nbsp;<span class="op" id="6489578">(</span><span class="ident" id="6489579">w</span>&nbsp;<span class="op" id="6489581">*</span><span class="ident" id="6489582">streamWriter</span><span class="op" id="6489594">)</span>&nbsp;<span class="ident" id="6489596">Close</span><span class="op" id="6489601">(</span><span class="op" id="6489602">)</span>&nbsp;<span class="builtintype" id="6489604">error</span>&nbsp;<span class="op" id="6489610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6489613">//&nbsp;send&nbsp;empty&nbsp;record&nbsp;to&nbsp;close&nbsp;the&nbsp;stream</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6489655">return</span>&nbsp;<span class="ident" id="6489662">w</span><span class="op" id="6489663">.</span><span class="ident" id="6489664">c</span><span class="op" id="6489665">.</span><span class="ident" id="6489666">writeRecord</span><span class="op" id="6489677">(</span><span class="ident" id="6489678">w</span><span class="op" id="6489679">.</span><span class="ident" id="6489680">recType</span><span class="op" id="6489687">,</span>&nbsp;<span class="ident" id="6489689">w</span><span class="op" id="6489690">.</span><span class="ident" id="6489691">reqId</span><span class="op" id="6489696">,</span>&nbsp;<span class="ident" id="6489698">nil</span><span class="op" id="6489701">)</span><br>
<span class="lineno"></span><span class="op" id="6489703">}</span>
</div>
</body>
</html>
