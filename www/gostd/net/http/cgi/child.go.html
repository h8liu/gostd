<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5508618">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5508673">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5508727">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5508778">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;CGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="5508838">//&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5508851">package</span>&nbsp;<span class="ident" id="5508859">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5508864">import</span>&nbsp;<span class="op" id="5508871">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5508874">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5508883">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5508897">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5508907">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5508914">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5508920">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5508933">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5508940">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5508952">&#34;net/url&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5508963">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5508969">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5508980">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5508990">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5508993">//&nbsp;Request&nbsp;returns&nbsp;the&nbsp;HTTP&nbsp;request&nbsp;as&nbsp;represented&nbsp;in&nbsp;the&nbsp;current</span><br>
<span class="lineno"></span><span class="comment" id="5509059">//&nbsp;environment.&nbsp;This&nbsp;assumes&nbsp;the&nbsp;current&nbsp;program&nbsp;is&nbsp;being&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="5509121">//&nbsp;by&nbsp;a&nbsp;web&nbsp;server&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment.</span><br>
<span class="lineno"></span><span class="comment" id="5509162">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;populated,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="5509222">func</span>&nbsp;<span class="ident" id="5509227">Request</span><span class="op" id="5509234">(</span><span class="op" id="5509235">)</span>&nbsp;<span class="op" id="5509237">(</span><span class="op" id="5509238">*</span><span class="ident" id="5509239">http</span><span class="op" id="5509243">.</span><span class="ident" id="5509244">Request</span><span class="op" id="5509251">,</span>&nbsp;<span class="builtintype" id="5509253">error</span><span class="op" id="5509258">)</span>&nbsp;<span class="op" id="5509260">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509263">r</span><span class="op" id="5509264">,</span>&nbsp;<span class="ident" id="5509266">err</span>&nbsp;<span class="op" id="5509270">:=</span>&nbsp;<span class="ident" id="5509273">RequestFromMap</span><span class="op" id="5509287">(</span><span class="ident" id="5509288">envMap</span><span class="op" id="5509294">(</span><span class="ident" id="5509295">os</span><span class="op" id="5509297">.</span><span class="ident" id="5509298">Environ</span><span class="op" id="5509305">(</span><span class="op" id="5509306">)</span><span class="op" id="5509307">)</span><span class="op" id="5509308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509311">if</span>&nbsp;<span class="ident" id="5509314">err</span>&nbsp;<span class="op" id="5509318">!=</span>&nbsp;<span class="ident" id="5509321">nil</span>&nbsp;<span class="op" id="5509325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509329">return</span>&nbsp;<span class="ident" id="5509336">nil</span><span class="op" id="5509339">,</span>&nbsp;<span class="ident" id="5509341">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509349">if</span>&nbsp;<span class="ident" id="5509352">r</span><span class="op" id="5509353">.</span><span class="ident" id="5509354">ContentLength</span>&nbsp;<span class="op" id="5509368">&gt;</span>&nbsp;<span class="num" id="5509370">0</span>&nbsp;<span class="op" id="5509372">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509376">r</span><span class="op" id="5509377">.</span><span class="ident" id="5509378">Body</span>&nbsp;<span class="op" id="5509383">=</span>&nbsp;<span class="ident" id="5509385">ioutil</span><span class="op" id="5509391">.</span><span class="ident" id="5509392">NopCloser</span><span class="op" id="5509401">(</span><span class="ident" id="5509402">io</span><span class="op" id="5509404">.</span><span class="ident" id="5509405">LimitReader</span><span class="op" id="5509416">(</span><span class="ident" id="5509417">os</span><span class="op" id="5509419">.</span><span class="ident" id="5509420">Stdin</span><span class="op" id="5509425">,</span>&nbsp;<span class="ident" id="5509427">r</span><span class="op" id="5509428">.</span><span class="ident" id="5509429">ContentLength</span><span class="op" id="5509442">)</span><span class="op" id="5509443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509449">return</span>&nbsp;<span class="ident" id="5509456">r</span><span class="op" id="5509457">,</span>&nbsp;<span class="ident" id="5509459">nil</span><br>
<span class="lineno"></span><span class="op" id="5509463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="5509466">func</span>&nbsp;<span class="ident" id="5509471">envMap</span><span class="op" id="5509477">(</span><span class="ident" id="5509478">env</span>&nbsp;<span class="op" id="5509482">[</span><span class="op" id="5509483">]</span><span class="builtintype" id="5509484">string</span><span class="op" id="5509490">)</span>&nbsp;<span class="keyword" id="5509492">map</span><span class="op" id="5509495">[</span><span class="builtintype" id="5509496">string</span><span class="op" id="5509502">]</span><span class="builtintype" id="5509503">string</span>&nbsp;<span class="op" id="5509510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509513">m</span>&nbsp;<span class="op" id="5509515">:=</span>&nbsp;<span class="builtinfunc" id="5509518">make</span><span class="op" id="5509522">(</span><span class="keyword" id="5509523">map</span><span class="op" id="5509526">[</span><span class="builtintype" id="5509527">string</span><span class="op" id="5509533">]</span><span class="builtintype" id="5509534">string</span><span class="op" id="5509540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509543">for</span>&nbsp;<span class="ident" id="5509547">_</span><span class="op" id="5509548">,</span>&nbsp;<span class="ident" id="5509550">kv</span>&nbsp;<span class="op" id="5509553">:=</span>&nbsp;<span class="keyword" id="5509556">range</span>&nbsp;<span class="ident" id="5509562">env</span>&nbsp;<span class="op" id="5509566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509570">if</span>&nbsp;<span class="ident" id="5509573">idx</span>&nbsp;<span class="op" id="5509577">:=</span>&nbsp;<span class="ident" id="5509580">strings</span><span class="op" id="5509587">.</span><span class="ident" id="5509588">Index</span><span class="op" id="5509593">(</span><span class="ident" id="5509594">kv</span><span class="op" id="5509596">,</span>&nbsp;<span class="string" id="5509598">&#34;=&#34;</span><span class="op" id="5509601">)</span><span class="op" id="5509602">;</span>&nbsp;<span class="ident" id="5509604">idx</span>&nbsp;<span class="op" id="5509608">!=</span>&nbsp;<span class="op" id="5509611">-</span><span class="num" id="5509612">1</span>&nbsp;<span class="op" id="5509614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509619">m</span><span class="op" id="5509620">[</span><span class="ident" id="5509621">kv</span><span class="op" id="5509623">[</span><span class="op" id="5509624">:</span><span class="ident" id="5509625">idx</span><span class="op" id="5509628">]</span><span class="op" id="5509629">]</span>&nbsp;<span class="op" id="5509631">=</span>&nbsp;<span class="ident" id="5509633">kv</span><span class="op" id="5509635">[</span><span class="ident" id="5509636">idx</span><span class="op" id="5509639">+</span><span class="num" id="5509640">1</span><span class="op" id="5509641">:</span><span class="op" id="5509642">]</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509652">return</span>&nbsp;<span class="ident" id="5509659">m</span><br>
<span class="lineno"></span><span class="op" id="5509661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5509664">//&nbsp;RequestFromMap&nbsp;creates&nbsp;an&nbsp;http.Request&nbsp;from&nbsp;CGI&nbsp;variables.</span><br>
<span class="lineno"></span><span class="comment" id="5509726">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;field&nbsp;is&nbsp;not&nbsp;populated.</span><br>
<span class="lineno"></span><span class="keyword" id="5509781">func</span>&nbsp;<span class="ident" id="5509786">RequestFromMap</span><span class="op" id="5509800">(</span><span class="ident" id="5509801">params</span>&nbsp;<span class="keyword" id="5509808">map</span><span class="op" id="5509811">[</span><span class="builtintype" id="5509812">string</span><span class="op" id="5509818">]</span><span class="builtintype" id="5509819">string</span><span class="op" id="5509825">)</span>&nbsp;<span class="op" id="5509827">(</span><span class="op" id="5509828">*</span><span class="ident" id="5509829">http</span><span class="op" id="5509833">.</span><span class="ident" id="5509834">Request</span><span class="op" id="5509841">,</span>&nbsp;<span class="builtintype" id="5509843">error</span><span class="op" id="5509848">)</span>&nbsp;<span class="op" id="5509850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509853">r</span>&nbsp;<span class="op" id="5509855">:=</span>&nbsp;<span class="builtinfunc" id="5509858">new</span><span class="op" id="5509861">(</span><span class="ident" id="5509862">http</span><span class="op" id="5509866">.</span><span class="ident" id="5509867">Request</span><span class="op" id="5509874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509877">r</span><span class="op" id="5509878">.</span><span class="ident" id="5509879">Method</span>&nbsp;<span class="op" id="5509886">=</span>&nbsp;<span class="ident" id="5509888">params</span><span class="op" id="5509894">[</span><span class="string" id="5509895">&#34;REQUEST_METHOD&#34;</span><span class="op" id="5509911">]</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509914">if</span>&nbsp;<span class="ident" id="5509917">r</span><span class="op" id="5509918">.</span><span class="ident" id="5509919">Method</span>&nbsp;<span class="op" id="5509926">==</span>&nbsp;<span class="string" id="5509929">&#34;&#34;</span>&nbsp;<span class="op" id="5509932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509936">return</span>&nbsp;<span class="ident" id="5509943">nil</span><span class="op" id="5509946">,</span>&nbsp;<span class="ident" id="5509948">errors</span><span class="op" id="5509954">.</span><span class="ident" id="5509955">New</span><span class="op" id="5509958">(</span><span class="string" id="5509959">&#34;cgi:&nbsp;no&nbsp;REQUEST_METHOD&nbsp;in&nbsp;environment&#34;</span><span class="op" id="5509998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510005">r</span><span class="op" id="5510006">.</span><span class="ident" id="5510007">Proto</span>&nbsp;<span class="op" id="5510013">=</span>&nbsp;<span class="ident" id="5510015">params</span><span class="op" id="5510021">[</span><span class="string" id="5510022">&#34;SERVER_PROTOCOL&#34;</span><span class="op" id="5510039">]</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510042">var</span>&nbsp;<span class="ident" id="5510046">ok</span>&nbsp;<span class="builtintype" id="5510049">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510055">r</span><span class="op" id="5510056">.</span><span class="ident" id="5510057">ProtoMajor</span><span class="op" id="5510067">,</span>&nbsp;<span class="ident" id="5510069">r</span><span class="op" id="5510070">.</span><span class="ident" id="5510071">ProtoMinor</span><span class="op" id="5510081">,</span>&nbsp;<span class="ident" id="5510083">ok</span>&nbsp;<span class="op" id="5510086">=</span>&nbsp;<span class="ident" id="5510088">http</span><span class="op" id="5510092">.</span><span class="ident" id="5510093">ParseHTTPVersion</span><span class="op" id="5510109">(</span><span class="ident" id="5510110">r</span><span class="op" id="5510111">.</span><span class="ident" id="5510112">Proto</span><span class="op" id="5510117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510120">if</span>&nbsp;<span class="op" id="5510123">!</span><span class="ident" id="5510124">ok</span>&nbsp;<span class="op" id="5510127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510131">return</span>&nbsp;<span class="ident" id="5510138">nil</span><span class="op" id="5510141">,</span>&nbsp;<span class="ident" id="5510143">errors</span><span class="op" id="5510149">.</span><span class="ident" id="5510150">New</span><span class="op" id="5510153">(</span><span class="string" id="5510154">&#34;cgi:&nbsp;invalid&nbsp;SERVER_PROTOCOL&nbsp;version&#34;</span><span class="op" id="5510192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510195">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510199">r</span><span class="op" id="5510200">.</span><span class="ident" id="5510201">Close</span>&nbsp;<span class="op" id="5510207">=</span>&nbsp;<span class="builtintype" id="5510209">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510215">r</span><span class="op" id="5510216">.</span><span class="ident" id="5510217">Trailer</span>&nbsp;<span class="op" id="5510225">=</span>&nbsp;<span class="ident" id="5510227">http</span><span class="op" id="5510231">.</span><span class="ident" id="5510232">Header</span><span class="op" id="5510238">{</span><span class="op" id="5510239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510242">r</span><span class="op" id="5510243">.</span><span class="ident" id="5510244">Header</span>&nbsp;<span class="op" id="5510251">=</span>&nbsp;<span class="ident" id="5510253">http</span><span class="op" id="5510257">.</span><span class="ident" id="5510258">Header</span><span class="op" id="5510264">{</span><span class="op" id="5510265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510269">r</span><span class="op" id="5510270">.</span><span class="ident" id="5510271">Host</span>&nbsp;<span class="op" id="5510276">=</span>&nbsp;<span class="ident" id="5510278">params</span><span class="op" id="5510284">[</span><span class="string" id="5510285">&#34;HTTP_HOST&#34;</span><span class="op" id="5510296">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510300">if</span>&nbsp;<span class="ident" id="5510303">lenstr</span>&nbsp;<span class="op" id="5510310">:=</span>&nbsp;<span class="ident" id="5510313">params</span><span class="op" id="5510319">[</span><span class="string" id="5510320">&#34;CONTENT_LENGTH&#34;</span><span class="op" id="5510336">]</span><span class="op" id="5510337">;</span>&nbsp;<span class="ident" id="5510339">lenstr</span>&nbsp;<span class="op" id="5510346">!=</span>&nbsp;<span class="string" id="5510349">&#34;&#34;</span>&nbsp;<span class="op" id="5510352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510356">clen</span><span class="op" id="5510360">,</span>&nbsp;<span class="ident" id="5510362">err</span>&nbsp;<span class="op" id="5510366">:=</span>&nbsp;<span class="ident" id="5510369">strconv</span><span class="op" id="5510376">.</span><span class="ident" id="5510377">ParseInt</span><span class="op" id="5510385">(</span><span class="ident" id="5510386">lenstr</span><span class="op" id="5510392">,</span>&nbsp;<span class="num" id="5510394">10</span><span class="op" id="5510396">,</span>&nbsp;<span class="num" id="5510398">64</span><span class="op" id="5510400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510404">if</span>&nbsp;<span class="ident" id="5510407">err</span>&nbsp;<span class="op" id="5510411">!=</span>&nbsp;<span class="ident" id="5510414">nil</span>&nbsp;<span class="op" id="5510418">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510423">return</span>&nbsp;<span class="ident" id="5510430">nil</span><span class="op" id="5510433">,</span>&nbsp;<span class="ident" id="5510435">errors</span><span class="op" id="5510441">.</span><span class="ident" id="5510442">New</span><span class="op" id="5510445">(</span><span class="string" id="5510446">&#34;cgi:&nbsp;bad&nbsp;CONTENT_LENGTH&nbsp;in&nbsp;environment:&nbsp;&#34;</span>&nbsp;<span class="op" id="5510489">+</span>&nbsp;<span class="ident" id="5510491">lenstr</span><span class="op" id="5510497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510505">r</span><span class="op" id="5510506">.</span><span class="ident" id="5510507">ContentLength</span>&nbsp;<span class="op" id="5510521">=</span>&nbsp;<span class="ident" id="5510523">clen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510533">if</span>&nbsp;<span class="ident" id="5510536">ct</span>&nbsp;<span class="op" id="5510539">:=</span>&nbsp;<span class="ident" id="5510542">params</span><span class="op" id="5510548">[</span><span class="string" id="5510549">&#34;CONTENT_TYPE&#34;</span><span class="op" id="5510563">]</span><span class="op" id="5510564">;</span>&nbsp;<span class="ident" id="5510566">ct</span>&nbsp;<span class="op" id="5510569">!=</span>&nbsp;<span class="string" id="5510572">&#34;&#34;</span>&nbsp;<span class="op" id="5510575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510579">r</span><span class="op" id="5510580">.</span><span class="ident" id="5510581">Header</span><span class="op" id="5510587">.</span><span class="ident" id="5510588">Set</span><span class="op" id="5510591">(</span><span class="string" id="5510592">&#34;Content-Type&#34;</span><span class="op" id="5510606">,</span>&nbsp;<span class="ident" id="5510608">ct</span><span class="op" id="5510610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5510617">//&nbsp;Copy&nbsp;&#34;HTTP_FOO_BAR&#34;&nbsp;variables&nbsp;to&nbsp;&#34;Foo-Bar&#34;&nbsp;Headers</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510672">for</span>&nbsp;<span class="ident" id="5510676">k</span><span class="op" id="5510677">,</span>&nbsp;<span class="ident" id="5510679">v</span>&nbsp;<span class="op" id="5510681">:=</span>&nbsp;<span class="keyword" id="5510684">range</span>&nbsp;<span class="ident" id="5510690">params</span>&nbsp;<span class="op" id="5510697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510701">if</span>&nbsp;<span class="op" id="5510704">!</span><span class="ident" id="5510705">strings</span><span class="op" id="5510712">.</span><span class="ident" id="5510713">HasPrefix</span><span class="op" id="5510722">(</span><span class="ident" id="5510723">k</span><span class="op" id="5510724">,</span>&nbsp;<span class="string" id="5510726">&#34;HTTP_&#34;</span><span class="op" id="5510733">)</span>&nbsp;<span class="op" id="5510735">||</span>&nbsp;<span class="ident" id="5510738">k</span>&nbsp;<span class="op" id="5510740">==</span>&nbsp;<span class="string" id="5510743">&#34;HTTP_HOST&#34;</span>&nbsp;<span class="op" id="5510755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510760">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510775">r</span><span class="op" id="5510776">.</span><span class="ident" id="5510777">Header</span><span class="op" id="5510783">.</span><span class="ident" id="5510784">Add</span><span class="op" id="5510787">(</span><span class="ident" id="5510788">strings</span><span class="op" id="5510795">.</span><span class="ident" id="5510796">Replace</span><span class="op" id="5510803">(</span><span class="ident" id="5510804">k</span><span class="op" id="5510805">[</span><span class="num" id="5510806">5</span><span class="op" id="5510807">:</span><span class="op" id="5510808">]</span><span class="op" id="5510809">,</span>&nbsp;<span class="string" id="5510811">&#34;_&#34;</span><span class="op" id="5510814">,</span>&nbsp;<span class="string" id="5510816">&#34;-&#34;</span><span class="op" id="5510819">,</span>&nbsp;<span class="op" id="5510821">-</span><span class="num" id="5510822">1</span><span class="op" id="5510823">)</span><span class="op" id="5510824">,</span>&nbsp;<span class="ident" id="5510826">v</span><span class="op" id="5510827">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5510834">//&nbsp;TODO:&nbsp;cookies.&nbsp;&nbsp;parsing&nbsp;them&nbsp;isn&#39;t&nbsp;exported,&nbsp;though.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510892">uriStr</span>&nbsp;<span class="op" id="5510899">:=</span>&nbsp;<span class="ident" id="5510902">params</span><span class="op" id="5510908">[</span><span class="string" id="5510909">&#34;REQUEST_URI&#34;</span><span class="op" id="5510922">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510925">if</span>&nbsp;<span class="ident" id="5510928">uriStr</span>&nbsp;<span class="op" id="5510935">==</span>&nbsp;<span class="string" id="5510938">&#34;&#34;</span>&nbsp;<span class="op" id="5510941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5510945">//&nbsp;Fallback&nbsp;to&nbsp;SCRIPT_NAME,&nbsp;PATH_INFO&nbsp;and&nbsp;QUERY_STRING.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511003">uriStr</span>&nbsp;<span class="op" id="5511010">=</span>&nbsp;<span class="ident" id="5511012">params</span><span class="op" id="5511018">[</span><span class="string" id="5511019">&#34;SCRIPT_NAME&#34;</span><span class="op" id="5511032">]</span>&nbsp;<span class="op" id="5511034">+</span>&nbsp;<span class="ident" id="5511036">params</span><span class="op" id="5511042">[</span><span class="string" id="5511043">&#34;PATH_INFO&#34;</span><span class="op" id="5511054">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511058">s</span>&nbsp;<span class="op" id="5511060">:=</span>&nbsp;<span class="ident" id="5511063">params</span><span class="op" id="5511069">[</span><span class="string" id="5511070">&#34;QUERY_STRING&#34;</span><span class="op" id="5511084">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511088">if</span>&nbsp;<span class="ident" id="5511091">s</span>&nbsp;<span class="op" id="5511093">!=</span>&nbsp;<span class="string" id="5511096">&#34;&#34;</span>&nbsp;<span class="op" id="5511099">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511104">uriStr</span>&nbsp;<span class="op" id="5511111">+=</span>&nbsp;<span class="string" id="5511114">&#34;?&#34;</span>&nbsp;<span class="op" id="5511118">+</span>&nbsp;<span class="ident" id="5511120">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5511131">//&nbsp;There&#39;s&nbsp;apparently&nbsp;a&nbsp;de-facto&nbsp;standard&nbsp;for&nbsp;this.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5511184">//&nbsp;http://docstore.mik.ua/orelly/linux/cgi/ch03_02.htm#ch03-35636</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511251">if</span>&nbsp;<span class="ident" id="5511254">s</span>&nbsp;<span class="op" id="5511256">:=</span>&nbsp;<span class="ident" id="5511259">params</span><span class="op" id="5511265">[</span><span class="string" id="5511266">&#34;HTTPS&#34;</span><span class="op" id="5511273">]</span><span class="op" id="5511274">;</span>&nbsp;<span class="ident" id="5511276">s</span>&nbsp;<span class="op" id="5511278">==</span>&nbsp;<span class="string" id="5511281">&#34;on&#34;</span>&nbsp;<span class="op" id="5511286">||</span>&nbsp;<span class="ident" id="5511289">s</span>&nbsp;<span class="op" id="5511291">==</span>&nbsp;<span class="string" id="5511294">&#34;ON&#34;</span>&nbsp;<span class="op" id="5511299">||</span>&nbsp;<span class="ident" id="5511302">s</span>&nbsp;<span class="op" id="5511304">==</span>&nbsp;<span class="string" id="5511307">&#34;1&#34;</span>&nbsp;<span class="op" id="5511311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511315">r</span><span class="op" id="5511316">.</span><span class="ident" id="5511317">TLS</span>&nbsp;<span class="op" id="5511321">=</span>&nbsp;<span class="op" id="5511323">&amp;</span><span class="ident" id="5511324">tls</span><span class="op" id="5511327">.</span><span class="ident" id="5511328">ConnectionState</span><span class="op" id="5511343">{</span><span class="ident" id="5511344">HandshakeComplete</span><span class="op" id="5511361">:</span>&nbsp;<span class="builtintype" id="5511363">true</span><span class="op" id="5511367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511374">if</span>&nbsp;<span class="ident" id="5511377">r</span><span class="op" id="5511378">.</span><span class="ident" id="5511379">Host</span>&nbsp;<span class="op" id="5511384">!=</span>&nbsp;<span class="string" id="5511387">&#34;&#34;</span>&nbsp;<span class="op" id="5511390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5511394">//&nbsp;Hostname&nbsp;is&nbsp;provided,&nbsp;so&nbsp;we&nbsp;can&nbsp;reasonably&nbsp;construct&nbsp;a&nbsp;URL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511459">rawurl</span>&nbsp;<span class="op" id="5511466">:=</span>&nbsp;<span class="ident" id="5511469">r</span><span class="op" id="5511470">.</span><span class="ident" id="5511471">Host</span>&nbsp;<span class="op" id="5511476">+</span>&nbsp;<span class="ident" id="5511478">uriStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511487">if</span>&nbsp;<span class="ident" id="5511490">r</span><span class="op" id="5511491">.</span><span class="ident" id="5511492">TLS</span>&nbsp;<span class="op" id="5511496">==</span>&nbsp;<span class="ident" id="5511499">nil</span>&nbsp;<span class="op" id="5511503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511508">rawurl</span>&nbsp;<span class="op" id="5511515">=</span>&nbsp;<span class="string" id="5511517">&#34;http://&#34;</span>&nbsp;<span class="op" id="5511527">+</span>&nbsp;<span class="ident" id="5511529">rawurl</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511538">}</span>&nbsp;<span class="keyword" id="5511540">else</span>&nbsp;<span class="op" id="5511545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511550">rawurl</span>&nbsp;<span class="op" id="5511557">=</span>&nbsp;<span class="string" id="5511559">&#34;https://&#34;</span>&nbsp;<span class="op" id="5511570">+</span>&nbsp;<span class="ident" id="5511572">rawurl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511585">url</span><span class="op" id="5511588">,</span>&nbsp;<span class="ident" id="5511590">err</span>&nbsp;<span class="op" id="5511594">:=</span>&nbsp;<span class="ident" id="5511597">url</span><span class="op" id="5511600">.</span><span class="ident" id="5511601">Parse</span><span class="op" id="5511606">(</span><span class="ident" id="5511607">rawurl</span><span class="op" id="5511613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511617">if</span>&nbsp;<span class="ident" id="5511620">err</span>&nbsp;<span class="op" id="5511624">!=</span>&nbsp;<span class="ident" id="5511627">nil</span>&nbsp;<span class="op" id="5511631">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511636">return</span>&nbsp;<span class="ident" id="5511643">nil</span><span class="op" id="5511646">,</span>&nbsp;<span class="ident" id="5511648">errors</span><span class="op" id="5511654">.</span><span class="ident" id="5511655">New</span><span class="op" id="5511658">(</span><span class="string" id="5511659">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;host&nbsp;and&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="5511716">+</span>&nbsp;<span class="ident" id="5511718">rawurl</span><span class="op" id="5511724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511732">r</span><span class="op" id="5511733">.</span><span class="ident" id="5511734">URL</span>&nbsp;<span class="op" id="5511738">=</span>&nbsp;<span class="ident" id="5511740">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5511748">//&nbsp;Fallback&nbsp;logic&nbsp;if&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a&nbsp;Host&nbsp;header&nbsp;or&nbsp;the&nbsp;URL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5511809">//&nbsp;failed&nbsp;to&nbsp;parse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511829">if</span>&nbsp;<span class="ident" id="5511832">r</span><span class="op" id="5511833">.</span><span class="ident" id="5511834">URL</span>&nbsp;<span class="op" id="5511838">==</span>&nbsp;<span class="ident" id="5511841">nil</span>&nbsp;<span class="op" id="5511845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511849">url</span><span class="op" id="5511852">,</span>&nbsp;<span class="ident" id="5511854">err</span>&nbsp;<span class="op" id="5511858">:=</span>&nbsp;<span class="ident" id="5511861">url</span><span class="op" id="5511864">.</span><span class="ident" id="5511865">Parse</span><span class="op" id="5511870">(</span><span class="ident" id="5511871">uriStr</span><span class="op" id="5511877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511881">if</span>&nbsp;<span class="ident" id="5511884">err</span>&nbsp;<span class="op" id="5511888">!=</span>&nbsp;<span class="ident" id="5511891">nil</span>&nbsp;<span class="op" id="5511895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5511900">return</span>&nbsp;<span class="ident" id="5511907">nil</span><span class="op" id="5511910">,</span>&nbsp;<span class="ident" id="5511912">errors</span><span class="op" id="5511918">.</span><span class="ident" id="5511919">New</span><span class="op" id="5511922">(</span><span class="string" id="5511923">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="5511971">+</span>&nbsp;<span class="ident" id="5511973">uriStr</span><span class="op" id="5511979">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5511983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5511987">r</span><span class="op" id="5511988">.</span><span class="ident" id="5511989">URL</span>&nbsp;<span class="op" id="5511993">=</span>&nbsp;<span class="ident" id="5511995">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5512000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5512004">//&nbsp;Request.RemoteAddr&nbsp;has&nbsp;its&nbsp;port&nbsp;set&nbsp;by&nbsp;Go&#39;s&nbsp;standard&nbsp;http</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5512066">//&nbsp;server,&nbsp;so&nbsp;we&nbsp;do&nbsp;here&nbsp;too.&nbsp;We&nbsp;don&#39;t&nbsp;have&nbsp;one,&nbsp;though,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5512130">//&nbsp;use&nbsp;a&nbsp;dummy&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512151">r</span><span class="op" id="5512152">.</span><span class="ident" id="5512153">RemoteAddr</span>&nbsp;<span class="op" id="5512164">=</span>&nbsp;<span class="ident" id="5512166">net</span><span class="op" id="5512169">.</span><span class="ident" id="5512170">JoinHostPort</span><span class="op" id="5512182">(</span><span class="ident" id="5512183">params</span><span class="op" id="5512189">[</span><span class="string" id="5512190">&#34;REMOTE_ADDR&#34;</span><span class="op" id="5512203">]</span><span class="op" id="5512204">,</span>&nbsp;<span class="string" id="5512206">&#34;0&#34;</span><span class="op" id="5512209">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512213">return</span>&nbsp;<span class="ident" id="5512220">r</span><span class="op" id="5512221">,</span>&nbsp;<span class="ident" id="5512223">nil</span><br>
<span class="lineno">140</span><span class="op" id="5512227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5512230">//&nbsp;Serve&nbsp;executes&nbsp;the&nbsp;provided&nbsp;Handler&nbsp;on&nbsp;the&nbsp;currently&nbsp;active&nbsp;CGI</span><br>
<span class="lineno"></span><span class="comment" id="5512297">//&nbsp;request,&nbsp;if&nbsp;any.&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;current&nbsp;CGI&nbsp;environment</span><br>
<span class="lineno"></span><span class="comment" id="5512355">//&nbsp;an&nbsp;error&nbsp;is&nbsp;returned.&nbsp;The&nbsp;provided&nbsp;handler&nbsp;may&nbsp;be&nbsp;nil&nbsp;to&nbsp;use</span><br>
<span class="lineno">145</span><span class="comment" id="5512419">//&nbsp;http.DefaultServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="5512444">func</span>&nbsp;<span class="ident" id="5512449">Serve</span><span class="op" id="5512454">(</span><span class="ident" id="5512455">handler</span>&nbsp;<span class="ident" id="5512463">http</span><span class="op" id="5512467">.</span><span class="ident" id="5512468">Handler</span><span class="op" id="5512475">)</span>&nbsp;<span class="builtintype" id="5512477">error</span>&nbsp;<span class="op" id="5512483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512486">req</span><span class="op" id="5512489">,</span>&nbsp;<span class="ident" id="5512491">err</span>&nbsp;<span class="op" id="5512495">:=</span>&nbsp;<span class="ident" id="5512498">Request</span><span class="op" id="5512505">(</span><span class="op" id="5512506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512509">if</span>&nbsp;<span class="ident" id="5512512">err</span>&nbsp;<span class="op" id="5512516">!=</span>&nbsp;<span class="ident" id="5512519">nil</span>&nbsp;<span class="op" id="5512523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512527">return</span>&nbsp;<span class="ident" id="5512534">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5512539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512542">if</span>&nbsp;<span class="ident" id="5512545">handler</span>&nbsp;<span class="op" id="5512553">==</span>&nbsp;<span class="ident" id="5512556">nil</span>&nbsp;<span class="op" id="5512560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512564">handler</span>&nbsp;<span class="op" id="5512572">=</span>&nbsp;<span class="ident" id="5512574">http</span><span class="op" id="5512578">.</span><span class="ident" id="5512579">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5512596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512599">rw</span>&nbsp;<span class="op" id="5512602">:=</span>&nbsp;<span class="op" id="5512605">&amp;</span><span class="ident" id="5512606">response</span><span class="op" id="5512614">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512618">req</span><span class="op" id="5512621">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5512626">req</span><span class="op" id="5512629">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512633">header</span><span class="op" id="5512639">:</span>&nbsp;<span class="builtinfunc" id="5512641">make</span><span class="op" id="5512645">(</span><span class="ident" id="5512646">http</span><span class="op" id="5512650">.</span><span class="ident" id="5512651">Header</span><span class="op" id="5512657">)</span><span class="op" id="5512658">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512662">bufw</span><span class="op" id="5512666">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5512670">bufio</span><span class="op" id="5512675">.</span><span class="ident" id="5512676">NewWriter</span><span class="op" id="5512685">(</span><span class="ident" id="5512686">os</span><span class="op" id="5512688">.</span><span class="ident" id="5512689">Stdout</span><span class="op" id="5512695">)</span><span class="op" id="5512696">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5512699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512702">handler</span><span class="op" id="5512709">.</span><span class="ident" id="5512710">ServeHTTP</span><span class="op" id="5512719">(</span><span class="ident" id="5512720">rw</span><span class="op" id="5512722">,</span>&nbsp;<span class="ident" id="5512724">req</span><span class="op" id="5512727">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512730">rw</span><span class="op" id="5512732">.</span><span class="ident" id="5512733">Write</span><span class="op" id="5512738">(</span><span class="ident" id="5512739">nil</span><span class="op" id="5512742">)</span>&nbsp;<span class="comment" id="5512744">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;response&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512777">if</span>&nbsp;<span class="ident" id="5512780">err</span>&nbsp;<span class="op" id="5512784">=</span>&nbsp;<span class="ident" id="5512786">rw</span><span class="op" id="5512788">.</span><span class="ident" id="5512789">bufw</span><span class="op" id="5512793">.</span><span class="ident" id="5512794">Flush</span><span class="op" id="5512799">(</span><span class="op" id="5512800">)</span><span class="op" id="5512801">;</span>&nbsp;<span class="ident" id="5512803">err</span>&nbsp;<span class="op" id="5512807">!=</span>&nbsp;<span class="ident" id="5512810">nil</span>&nbsp;<span class="op" id="5512814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512818">return</span>&nbsp;<span class="ident" id="5512825">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5512830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5512833">return</span>&nbsp;<span class="ident" id="5512840">nil</span><br>
<span class="lineno">165</span><span class="op" id="5512844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5512847">type</span>&nbsp;<span class="ident" id="5512852">response</span>&nbsp;<span class="keyword" id="5512861">struct</span>&nbsp;<span class="op" id="5512868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512871">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5512882">*</span><span class="ident" id="5512883">http</span><span class="op" id="5512887">.</span><span class="ident" id="5512888">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512897">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5512908">http</span><span class="op" id="5512912">.</span><span class="ident" id="5512913">Header</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512921">bufw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5512932">*</span><span class="ident" id="5512933">bufio</span><span class="op" id="5512938">.</span><span class="ident" id="5512939">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512947">headerSent</span>&nbsp;<span class="builtintype" id="5512958">bool</span><br>
<span class="lineno"></span><span class="op" id="5512963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5512966">func</span>&nbsp;<span class="op" id="5512971">(</span><span class="ident" id="5512972">r</span>&nbsp;<span class="op" id="5512974">*</span><span class="ident" id="5512975">response</span><span class="op" id="5512983">)</span>&nbsp;<span class="ident" id="5512985">Flush</span><span class="op" id="5512990">(</span><span class="op" id="5512991">)</span>&nbsp;<span class="op" id="5512993">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5512996">r</span><span class="op" id="5512997">.</span><span class="ident" id="5512998">bufw</span><span class="op" id="5513002">.</span><span class="ident" id="5513003">Flush</span><span class="op" id="5513008">(</span><span class="op" id="5513009">)</span><br>
<span class="lineno"></span><span class="op" id="5513011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5513014">func</span>&nbsp;<span class="op" id="5513019">(</span><span class="ident" id="5513020">r</span>&nbsp;<span class="op" id="5513022">*</span><span class="ident" id="5513023">response</span><span class="op" id="5513031">)</span>&nbsp;<span class="ident" id="5513033">Header</span><span class="op" id="5513039">(</span><span class="op" id="5513040">)</span>&nbsp;<span class="ident" id="5513042">http</span><span class="op" id="5513046">.</span><span class="ident" id="5513047">Header</span>&nbsp;<span class="op" id="5513054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5513057">return</span>&nbsp;<span class="ident" id="5513064">r</span><span class="op" id="5513065">.</span><span class="ident" id="5513066">header</span><br>
<span class="lineno">180</span><span class="op" id="5513073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5513076">func</span>&nbsp;<span class="op" id="5513081">(</span><span class="ident" id="5513082">r</span>&nbsp;<span class="op" id="5513084">*</span><span class="ident" id="5513085">response</span><span class="op" id="5513093">)</span>&nbsp;<span class="ident" id="5513095">Write</span><span class="op" id="5513100">(</span><span class="ident" id="5513101">p</span>&nbsp;<span class="op" id="5513103">[</span><span class="op" id="5513104">]</span><span class="builtintype" id="5513105">byte</span><span class="op" id="5513109">)</span>&nbsp;<span class="op" id="5513111">(</span><span class="ident" id="5513112">n</span>&nbsp;<span class="builtintype" id="5513114">int</span><span class="op" id="5513117">,</span>&nbsp;<span class="ident" id="5513119">err</span>&nbsp;<span class="builtintype" id="5513123">error</span><span class="op" id="5513128">)</span>&nbsp;<span class="op" id="5513130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5513133">if</span>&nbsp;<span class="op" id="5513136">!</span><span class="ident" id="5513137">r</span><span class="op" id="5513138">.</span><span class="ident" id="5513139">headerSent</span>&nbsp;<span class="op" id="5513150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513154">r</span><span class="op" id="5513155">.</span><span class="ident" id="5513156">WriteHeader</span><span class="op" id="5513167">(</span><span class="ident" id="5513168">http</span><span class="op" id="5513172">.</span><span class="ident" id="5513173">StatusOK</span><span class="op" id="5513181">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5513184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5513187">return</span>&nbsp;<span class="ident" id="5513194">r</span><span class="op" id="5513195">.</span><span class="ident" id="5513196">bufw</span><span class="op" id="5513200">.</span><span class="ident" id="5513201">Write</span><span class="op" id="5513206">(</span><span class="ident" id="5513207">p</span><span class="op" id="5513208">)</span><br>
<span class="lineno"></span><span class="op" id="5513210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5513213">func</span>&nbsp;<span class="op" id="5513218">(</span><span class="ident" id="5513219">r</span>&nbsp;<span class="op" id="5513221">*</span><span class="ident" id="5513222">response</span><span class="op" id="5513230">)</span>&nbsp;<span class="ident" id="5513232">WriteHeader</span><span class="op" id="5513243">(</span><span class="ident" id="5513244">code</span>&nbsp;<span class="builtintype" id="5513249">int</span><span class="op" id="5513252">)</span>&nbsp;<span class="op" id="5513254">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5513257">if</span>&nbsp;<span class="ident" id="5513260">r</span><span class="op" id="5513261">.</span><span class="ident" id="5513262">headerSent</span>&nbsp;<span class="op" id="5513273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5513277">//&nbsp;Note:&nbsp;explicitly&nbsp;using&nbsp;Stderr,&nbsp;as&nbsp;Stdout&nbsp;is&nbsp;our&nbsp;HTTP&nbsp;output.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513343">fmt</span><span class="op" id="5513346">.</span><span class="ident" id="5513347">Fprintf</span><span class="op" id="5513354">(</span><span class="ident" id="5513355">os</span><span class="op" id="5513357">.</span><span class="ident" id="5513358">Stderr</span><span class="op" id="5513364">,</span>&nbsp;<span class="string" id="5513366">&#34;CGI&nbsp;attempted&nbsp;to&nbsp;write&nbsp;header&nbsp;twice&nbsp;on&nbsp;request&nbsp;for&nbsp;%s&#34;</span><span class="op" id="5513421">,</span>&nbsp;<span class="ident" id="5513423">r</span><span class="op" id="5513424">.</span><span class="ident" id="5513425">req</span><span class="op" id="5513428">.</span><span class="ident" id="5513429">URL</span><span class="op" id="5513432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5513436">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5513444">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513447">r</span><span class="op" id="5513448">.</span><span class="ident" id="5513449">headerSent</span>&nbsp;<span class="op" id="5513460">=</span>&nbsp;<span class="builtintype" id="5513462">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513468">fmt</span><span class="op" id="5513471">.</span><span class="ident" id="5513472">Fprintf</span><span class="op" id="5513479">(</span><span class="ident" id="5513480">r</span><span class="op" id="5513481">.</span><span class="ident" id="5513482">bufw</span><span class="op" id="5513486">,</span>&nbsp;<span class="string" id="5513488">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="5513507">,</span>&nbsp;<span class="ident" id="5513509">code</span><span class="op" id="5513513">,</span>&nbsp;<span class="ident" id="5513515">http</span><span class="op" id="5513519">.</span><span class="ident" id="5513520">StatusText</span><span class="op" id="5513530">(</span><span class="ident" id="5513531">code</span><span class="op" id="5513535">)</span><span class="op" id="5513536">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5513540">//&nbsp;Set&nbsp;a&nbsp;default&nbsp;Content-Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5513571">if</span>&nbsp;<span class="ident" id="5513574">_</span><span class="op" id="5513575">,</span>&nbsp;<span class="ident" id="5513577">hasType</span>&nbsp;<span class="op" id="5513585">:=</span>&nbsp;<span class="ident" id="5513588">r</span><span class="op" id="5513589">.</span><span class="ident" id="5513590">header</span><span class="op" id="5513596">[</span><span class="string" id="5513597">&#34;Content-Type&#34;</span><span class="op" id="5513611">]</span><span class="op" id="5513612">;</span>&nbsp;<span class="op" id="5513614">!</span><span class="ident" id="5513615">hasType</span>&nbsp;<span class="op" id="5513623">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513627">r</span><span class="op" id="5513628">.</span><span class="ident" id="5513629">header</span><span class="op" id="5513635">.</span><span class="ident" id="5513636">Add</span><span class="op" id="5513639">(</span><span class="string" id="5513640">&#34;Content-Type&#34;</span><span class="op" id="5513654">,</span>&nbsp;<span class="string" id="5513656">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="5513682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5513685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513689">r</span><span class="op" id="5513690">.</span><span class="ident" id="5513691">header</span><span class="op" id="5513697">.</span><span class="ident" id="5513698">Write</span><span class="op" id="5513703">(</span><span class="ident" id="5513704">r</span><span class="op" id="5513705">.</span><span class="ident" id="5513706">bufw</span><span class="op" id="5513710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513713">r</span><span class="op" id="5513714">.</span><span class="ident" id="5513715">bufw</span><span class="op" id="5513719">.</span><span class="ident" id="5513720">WriteString</span><span class="op" id="5513731">(</span><span class="string" id="5513732">&#34;\r\n&#34;</span><span class="op" id="5513738">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5513741">r</span><span class="op" id="5513742">.</span><span class="ident" id="5513743">bufw</span><span class="op" id="5513747">.</span><span class="ident" id="5513748">Flush</span><span class="op" id="5513753">(</span><span class="op" id="5513754">)</span><br>
<span class="lineno"></span><span class="op" id="5513756">}</span>
</div>
</body>
</html>
