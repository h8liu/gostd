<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3352903">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3352958">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3353012">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3353063">//&nbsp;TLS&nbsp;low&nbsp;level&nbsp;connection&nbsp;and&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3353109">package</span>&nbsp;<span class="ident" id="3353117">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3353122">import</span>&nbsp;<span class="op" id="3353129">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3353132">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3353141">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3353158">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3353175">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3353190">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3353200">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3353207">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3353213">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3353220">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3353228">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3353235">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3353238">//&nbsp;A&nbsp;Conn&nbsp;represents&nbsp;a&nbsp;secured&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3353281">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;net.Conn&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3353322">type</span>&nbsp;<span class="ident" id="3353327">Conn</span>&nbsp;<span class="keyword" id="3353332">struct</span>&nbsp;<span class="op" id="3353339">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3353342">//&nbsp;constant</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353355">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3353364">net</span><span class="op" id="3353367">.</span><span class="ident" id="3353368">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353374">isClient</span>&nbsp;<span class="builtintype" id="3353383">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3353390">//&nbsp;constant&nbsp;after&nbsp;handshake;&nbsp;protected&nbsp;by&nbsp;handshakeMutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353448">handshakeMutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3353466">sync</span><span class="op" id="3353470">.</span><span class="ident" id="3353471">Mutex</span>&nbsp;<span class="comment" id="3353477">//&nbsp;handshakeMutex&nbsp;&lt;&nbsp;in.Mutex,&nbsp;out.Mutex,&nbsp;errMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353528">handshakeErr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3353546">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3353557">//&nbsp;error&nbsp;resulting&nbsp;from&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353592">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3353610">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3353621">//&nbsp;TLS&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353637">haveVers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3353655">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3353666">//&nbsp;version&nbsp;has&nbsp;been&nbsp;negotiated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353698">config</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3353716">*</span><span class="ident" id="3353717">Config</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3353727">//&nbsp;configuration&nbsp;passed&nbsp;to&nbsp;constructor</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353767">handshakeComplete</span>&nbsp;<span class="builtintype" id="3353785">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353791">didResume</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3353809">bool</span>&nbsp;<span class="comment" id="3353814">//&nbsp;whether&nbsp;this&nbsp;connection&nbsp;was&nbsp;a&nbsp;session&nbsp;resumption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353867">cipherSuite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3353885">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353893">ocspResponse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3353911">[</span><span class="op" id="3353912">]</span><span class="builtintype" id="3353913">byte</span>&nbsp;<span class="comment" id="3353918">//&nbsp;stapled&nbsp;OCSP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353944">peerCertificates</span>&nbsp;&nbsp;<span class="op" id="3353962">[</span><span class="op" id="3353963">]</span><span class="op" id="3353964">*</span><span class="ident" id="3353965">x509</span><span class="op" id="3353969">.</span><span class="ident" id="3353970">Certificate</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3353983">//&nbsp;verifiedChains&nbsp;contains&nbsp;the&nbsp;certificate&nbsp;chains&nbsp;that&nbsp;we&nbsp;built,&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3354052">//&nbsp;opposed&nbsp;to&nbsp;the&nbsp;ones&nbsp;presented&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354101">verifiedChains</span>&nbsp;<span class="op" id="3354116">[</span><span class="op" id="3354117">]</span><span class="op" id="3354118">[</span><span class="op" id="3354119">]</span><span class="op" id="3354120">*</span><span class="ident" id="3354121">x509</span><span class="op" id="3354125">.</span><span class="ident" id="3354126">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3354139">//&nbsp;serverName&nbsp;contains&nbsp;the&nbsp;server&nbsp;name&nbsp;indicated&nbsp;by&nbsp;the&nbsp;client,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354212">serverName</span>&nbsp;<span class="builtintype" id="3354223">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3354231">//&nbsp;firstFinished&nbsp;contains&nbsp;the&nbsp;first&nbsp;Finished&nbsp;hash&nbsp;sent&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3354298">//&nbsp;handshake.&nbsp;This&nbsp;is&nbsp;the&nbsp;&#34;tls-unique&#34;&nbsp;channel&nbsp;binding&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354361">firstFinished</span>&nbsp;<span class="op" id="3354375">[</span><span class="num" id="3354376">12</span><span class="op" id="3354378">]</span><span class="builtintype" id="3354379">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354386">clientProtocol</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3354409">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354417">clientProtocolFallback</span>&nbsp;<span class="builtintype" id="3354440">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3354447">//&nbsp;input/output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354464">in</span><span class="op" id="3354466">,</span>&nbsp;<span class="ident" id="3354468">out</span>&nbsp;&nbsp;<span class="ident" id="3354473">halfConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3354486">//&nbsp;in.Mutex&nbsp;&lt;&nbsp;out.Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354511">rawInput</span>&nbsp;<span class="op" id="3354520">*</span><span class="ident" id="3354521">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3354533">//&nbsp;raw&nbsp;input,&nbsp;right&nbsp;off&nbsp;the&nbsp;wire</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354567">input</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3354576">*</span><span class="ident" id="3354577">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3354589">//&nbsp;application&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354629">hand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3354638">bytes</span><span class="op" id="3354643">.</span><span class="ident" id="3354644">Buffer</span>&nbsp;<span class="comment" id="3354651">//&nbsp;handshake&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354690">tmp</span>&nbsp;<span class="op" id="3354694">[</span><span class="num" id="3354695">16</span><span class="op" id="3354697">]</span><span class="builtintype" id="3354698">byte</span><br>
<span class="lineno"></span><span class="op" id="3354703">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="3354706">//&nbsp;Access&nbsp;to&nbsp;net.Conn&nbsp;methods.</span><br>
<span class="lineno"></span><span class="comment" id="3354737">//&nbsp;Cannot&nbsp;just&nbsp;embed&nbsp;net.Conn&nbsp;because&nbsp;that&nbsp;would</span><br>
<span class="lineno"></span><span class="comment" id="3354786">//&nbsp;export&nbsp;the&nbsp;struct&nbsp;field&nbsp;too.</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3354819">//&nbsp;LocalAddr&nbsp;returns&nbsp;the&nbsp;local&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="3354867">func</span>&nbsp;<span class="op" id="3354872">(</span><span class="ident" id="3354873">c</span>&nbsp;<span class="op" id="3354875">*</span><span class="ident" id="3354876">Conn</span><span class="op" id="3354880">)</span>&nbsp;<span class="ident" id="3354882">LocalAddr</span><span class="op" id="3354891">(</span><span class="op" id="3354892">)</span>&nbsp;<span class="ident" id="3354894">net</span><span class="op" id="3354897">.</span><span class="ident" id="3354898">Addr</span>&nbsp;<span class="op" id="3354903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354906">return</span>&nbsp;<span class="ident" id="3354913">c</span><span class="op" id="3354914">.</span><span class="ident" id="3354915">conn</span><span class="op" id="3354919">.</span><span class="ident" id="3354920">LocalAddr</span><span class="op" id="3354929">(</span><span class="op" id="3354930">)</span><br>
<span class="lineno"></span><span class="op" id="3354932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="3354935">//&nbsp;RemoteAddr&nbsp;returns&nbsp;the&nbsp;remote&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="3354985">func</span>&nbsp;<span class="op" id="3354990">(</span><span class="ident" id="3354991">c</span>&nbsp;<span class="op" id="3354993">*</span><span class="ident" id="3354994">Conn</span><span class="op" id="3354998">)</span>&nbsp;<span class="ident" id="3355000">RemoteAddr</span><span class="op" id="3355010">(</span><span class="op" id="3355011">)</span>&nbsp;<span class="ident" id="3355013">net</span><span class="op" id="3355016">.</span><span class="ident" id="3355017">Addr</span>&nbsp;<span class="op" id="3355022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355025">return</span>&nbsp;<span class="ident" id="3355032">c</span><span class="op" id="3355033">.</span><span class="ident" id="3355034">conn</span><span class="op" id="3355038">.</span><span class="ident" id="3355039">RemoteAddr</span><span class="op" id="3355049">(</span><span class="op" id="3355050">)</span><br>
<span class="lineno"></span><span class="op" id="3355052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3355055">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;and&nbsp;write&nbsp;deadlines&nbsp;associated&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3355136">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;and&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3355198">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3355305">func</span>&nbsp;<span class="op" id="3355310">(</span><span class="ident" id="3355311">c</span>&nbsp;<span class="op" id="3355313">*</span><span class="ident" id="3355314">Conn</span><span class="op" id="3355318">)</span>&nbsp;<span class="ident" id="3355320">SetDeadline</span><span class="op" id="3355331">(</span><span class="ident" id="3355332">t</span>&nbsp;<span class="ident" id="3355334">time</span><span class="op" id="3355338">.</span><span class="ident" id="3355339">Time</span><span class="op" id="3355343">)</span>&nbsp;<span class="builtintype" id="3355345">error</span>&nbsp;<span class="op" id="3355351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355354">return</span>&nbsp;<span class="ident" id="3355361">c</span><span class="op" id="3355362">.</span><span class="ident" id="3355363">conn</span><span class="op" id="3355367">.</span><span class="ident" id="3355368">SetDeadline</span><span class="op" id="3355379">(</span><span class="ident" id="3355380">t</span><span class="op" id="3355381">)</span><br>
<span class="lineno">80</span><span class="op" id="3355383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3355386">//&nbsp;SetReadDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3355458">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3355510">func</span>&nbsp;<span class="op" id="3355515">(</span><span class="ident" id="3355516">c</span>&nbsp;<span class="op" id="3355518">*</span><span class="ident" id="3355519">Conn</span><span class="op" id="3355523">)</span>&nbsp;<span class="ident" id="3355525">SetReadDeadline</span><span class="op" id="3355540">(</span><span class="ident" id="3355541">t</span>&nbsp;<span class="ident" id="3355543">time</span><span class="op" id="3355547">.</span><span class="ident" id="3355548">Time</span><span class="op" id="3355552">)</span>&nbsp;<span class="builtintype" id="3355554">error</span>&nbsp;<span class="op" id="3355560">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355563">return</span>&nbsp;<span class="ident" id="3355570">c</span><span class="op" id="3355571">.</span><span class="ident" id="3355572">conn</span><span class="op" id="3355576">.</span><span class="ident" id="3355577">SetReadDeadline</span><span class="op" id="3355592">(</span><span class="ident" id="3355593">t</span><span class="op" id="3355594">)</span><br>
<span class="lineno"></span><span class="op" id="3355596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3355599">//&nbsp;SetWriteDeadline&nbsp;sets&nbsp;the&nbsp;write&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3355673">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno">90</span><span class="comment" id="3355726">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3355833">func</span>&nbsp;<span class="op" id="3355838">(</span><span class="ident" id="3355839">c</span>&nbsp;<span class="op" id="3355841">*</span><span class="ident" id="3355842">Conn</span><span class="op" id="3355846">)</span>&nbsp;<span class="ident" id="3355848">SetWriteDeadline</span><span class="op" id="3355864">(</span><span class="ident" id="3355865">t</span>&nbsp;<span class="ident" id="3355867">time</span><span class="op" id="3355871">.</span><span class="ident" id="3355872">Time</span><span class="op" id="3355876">)</span>&nbsp;<span class="builtintype" id="3355878">error</span>&nbsp;<span class="op" id="3355884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355887">return</span>&nbsp;<span class="ident" id="3355894">c</span><span class="op" id="3355895">.</span><span class="ident" id="3355896">conn</span><span class="op" id="3355900">.</span><span class="ident" id="3355901">SetWriteDeadline</span><span class="op" id="3355917">(</span><span class="ident" id="3355918">t</span><span class="op" id="3355919">)</span><br>
<span class="lineno"></span><span class="op" id="3355921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3355924">//&nbsp;A&nbsp;halfConn&nbsp;represents&nbsp;one&nbsp;direction&nbsp;of&nbsp;the&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><span class="comment" id="3355983">//&nbsp;connection,&nbsp;either&nbsp;sending&nbsp;or&nbsp;receiving.</span><br>
<span class="lineno"></span><span class="keyword" id="3356027">type</span>&nbsp;<span class="ident" id="3356032">halfConn</span>&nbsp;<span class="keyword" id="3356041">struct</span>&nbsp;<span class="op" id="3356048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356051">sync</span><span class="op" id="3356055">.</span><span class="ident" id="3356056">Mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356064">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3356072">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3356084">//&nbsp;first&nbsp;permanent&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356110">version</span>&nbsp;<span class="builtintype" id="3356118">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3356130">//&nbsp;protocol&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356151">cipher</span>&nbsp;&nbsp;<span class="keyword" id="3356159">interface</span><span class="op" id="3356168">{</span><span class="op" id="3356169">}</span>&nbsp;<span class="comment" id="3356171">//&nbsp;cipher&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356192">mac</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3356200">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356213">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3356221">[</span><span class="num" id="3356222">8</span><span class="op" id="3356223">]</span><span class="builtintype" id="3356224">byte</span>&nbsp;<span class="comment" id="3356229">//&nbsp;64-bit&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356256">bfree</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3356264">*</span><span class="ident" id="3356265">block</span>&nbsp;&nbsp;<span class="comment" id="3356272">//&nbsp;list&nbsp;of&nbsp;free&nbsp;blocks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356297">nextCipher</span>&nbsp;<span class="keyword" id="3356308">interface</span><span class="op" id="3356317">{</span><span class="op" id="3356318">}</span>&nbsp;<span class="comment" id="3356320">//&nbsp;next&nbsp;encryption&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356346">nextMac</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3356357">macFunction</span>&nbsp;<span class="comment" id="3356369">//&nbsp;next&nbsp;MAC&nbsp;algorithm</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3356393">//&nbsp;used&nbsp;to&nbsp;save&nbsp;allocating&nbsp;a&nbsp;new&nbsp;buffer&nbsp;for&nbsp;each&nbsp;MAC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356448">inDigestBuf</span><span class="op" id="3356459">,</span>&nbsp;<span class="ident" id="3356461">outDigestBuf</span>&nbsp;<span class="op" id="3356474">[</span><span class="op" id="3356475">]</span><span class="builtintype" id="3356476">byte</span><br>
<span class="lineno"></span><span class="op" id="3356481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3356484">func</span>&nbsp;<span class="op" id="3356489">(</span><span class="ident" id="3356490">hc</span>&nbsp;<span class="op" id="3356493">*</span><span class="ident" id="3356494">halfConn</span><span class="op" id="3356502">)</span>&nbsp;<span class="ident" id="3356504">setErrorLocked</span><span class="op" id="3356518">(</span><span class="ident" id="3356519">err</span>&nbsp;<span class="builtintype" id="3356523">error</span><span class="op" id="3356528">)</span>&nbsp;<span class="builtintype" id="3356530">error</span>&nbsp;<span class="op" id="3356536">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356539">hc</span><span class="op" id="3356541">.</span><span class="ident" id="3356542">err</span>&nbsp;<span class="op" id="3356546">=</span>&nbsp;<span class="ident" id="3356548">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3356553">return</span>&nbsp;<span class="ident" id="3356560">err</span><br>
<span class="lineno"></span><span class="op" id="3356564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3356567">func</span>&nbsp;<span class="op" id="3356572">(</span><span class="ident" id="3356573">hc</span>&nbsp;<span class="op" id="3356576">*</span><span class="ident" id="3356577">halfConn</span><span class="op" id="3356585">)</span>&nbsp;<span class="builtintype" id="3356587">error</span><span class="op" id="3356592">(</span><span class="op" id="3356593">)</span>&nbsp;<span class="builtintype" id="3356595">error</span>&nbsp;<span class="op" id="3356601">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356604">hc</span><span class="op" id="3356606">.</span><span class="ident" id="3356607">Lock</span><span class="op" id="3356611">(</span><span class="op" id="3356612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356615">err</span>&nbsp;<span class="op" id="3356619">:=</span>&nbsp;<span class="ident" id="3356622">hc</span><span class="op" id="3356624">.</span><span class="ident" id="3356625">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356630">hc</span><span class="op" id="3356632">.</span><span class="ident" id="3356633">Unlock</span><span class="op" id="3356639">(</span><span class="op" id="3356640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3356643">return</span>&nbsp;<span class="ident" id="3356650">err</span><br>
<span class="lineno"></span><span class="op" id="3356654">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="3356657">//&nbsp;prepareCipherSpec&nbsp;sets&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno"></span><span class="comment" id="3356713">//&nbsp;that&nbsp;a&nbsp;subsequent&nbsp;changeCipherSpec&nbsp;will&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3356761">func</span>&nbsp;<span class="op" id="3356766">(</span><span class="ident" id="3356767">hc</span>&nbsp;<span class="op" id="3356770">*</span><span class="ident" id="3356771">halfConn</span><span class="op" id="3356779">)</span>&nbsp;<span class="ident" id="3356781">prepareCipherSpec</span><span class="op" id="3356798">(</span><span class="ident" id="3356799">version</span>&nbsp;<span class="builtintype" id="3356807">uint16</span><span class="op" id="3356813">,</span>&nbsp;<span class="ident" id="3356815">cipher</span>&nbsp;<span class="keyword" id="3356822">interface</span><span class="op" id="3356831">{</span><span class="op" id="3356832">}</span><span class="op" id="3356833">,</span>&nbsp;<span class="ident" id="3356835">mac</span>&nbsp;<span class="ident" id="3356839">macFunction</span><span class="op" id="3356850">)</span>&nbsp;<span class="op" id="3356852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356855">hc</span><span class="op" id="3356857">.</span><span class="ident" id="3356858">version</span>&nbsp;<span class="op" id="3356866">=</span>&nbsp;<span class="ident" id="3356868">version</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356877">hc</span><span class="op" id="3356879">.</span><span class="ident" id="3356880">nextCipher</span>&nbsp;<span class="op" id="3356891">=</span>&nbsp;<span class="ident" id="3356893">cipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356901">hc</span><span class="op" id="3356903">.</span><span class="ident" id="3356904">nextMac</span>&nbsp;<span class="op" id="3356912">=</span>&nbsp;<span class="ident" id="3356914">mac</span><br>
<span class="lineno"></span><span class="op" id="3356918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3356921">//&nbsp;changeCipherSpec&nbsp;changes&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno">135</span><span class="comment" id="3356979">//&nbsp;to&nbsp;the&nbsp;ones&nbsp;previously&nbsp;passed&nbsp;to&nbsp;prepareCipherSpec.</span><br>
<span class="lineno"></span><span class="keyword" id="3357034">func</span>&nbsp;<span class="op" id="3357039">(</span><span class="ident" id="3357040">hc</span>&nbsp;<span class="op" id="3357043">*</span><span class="ident" id="3357044">halfConn</span><span class="op" id="3357052">)</span>&nbsp;<span class="ident" id="3357054">changeCipherSpec</span><span class="op" id="3357070">(</span><span class="op" id="3357071">)</span>&nbsp;<span class="builtintype" id="3357073">error</span>&nbsp;<span class="op" id="3357079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357082">if</span>&nbsp;<span class="ident" id="3357085">hc</span><span class="op" id="3357087">.</span><span class="ident" id="3357088">nextCipher</span>&nbsp;<span class="op" id="3357099">==</span>&nbsp;<span class="ident" id="3357102">nil</span>&nbsp;<span class="op" id="3357106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357110">return</span>&nbsp;<span class="ident" id="3357117">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3357137">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3357140">hc</span><span class="op" id="3357142">.</span><span class="ident" id="3357143">cipher</span>&nbsp;<span class="op" id="3357150">=</span>&nbsp;<span class="ident" id="3357152">hc</span><span class="op" id="3357154">.</span><span class="ident" id="3357155">nextCipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3357167">hc</span><span class="op" id="3357169">.</span><span class="ident" id="3357170">mac</span>&nbsp;<span class="op" id="3357174">=</span>&nbsp;<span class="ident" id="3357176">hc</span><span class="op" id="3357178">.</span><span class="ident" id="3357179">nextMac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3357188">hc</span><span class="op" id="3357190">.</span><span class="ident" id="3357191">nextCipher</span>&nbsp;<span class="op" id="3357202">=</span>&nbsp;<span class="ident" id="3357204">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3357209">hc</span><span class="op" id="3357211">.</span><span class="ident" id="3357212">nextMac</span>&nbsp;<span class="op" id="3357220">=</span>&nbsp;<span class="ident" id="3357222">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357227">for</span>&nbsp;<span class="ident" id="3357231">i</span>&nbsp;<span class="op" id="3357233">:=</span>&nbsp;<span class="keyword" id="3357236">range</span>&nbsp;<span class="ident" id="3357242">hc</span><span class="op" id="3357244">.</span><span class="ident" id="3357245">seq</span>&nbsp;<span class="op" id="3357249">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3357253">hc</span><span class="op" id="3357255">.</span><span class="ident" id="3357256">seq</span><span class="op" id="3357259">[</span><span class="ident" id="3357260">i</span><span class="op" id="3357261">]</span>&nbsp;<span class="op" id="3357263">=</span>&nbsp;<span class="num" id="3357265">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3357268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357271">return</span>&nbsp;<span class="ident" id="3357278">nil</span><br>
<span class="lineno"></span><span class="op" id="3357282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="3357285">//&nbsp;incSeq&nbsp;increments&nbsp;the&nbsp;sequence&nbsp;number.</span><br>
<span class="lineno"></span><span class="keyword" id="3357327">func</span>&nbsp;<span class="op" id="3357332">(</span><span class="ident" id="3357333">hc</span>&nbsp;<span class="op" id="3357336">*</span><span class="ident" id="3357337">halfConn</span><span class="op" id="3357345">)</span>&nbsp;<span class="ident" id="3357347">incSeq</span><span class="op" id="3357353">(</span><span class="op" id="3357354">)</span>&nbsp;<span class="op" id="3357356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357359">for</span>&nbsp;<span class="ident" id="3357363">i</span>&nbsp;<span class="op" id="3357365">:=</span>&nbsp;<span class="num" id="3357368">7</span><span class="op" id="3357369">;</span>&nbsp;<span class="ident" id="3357371">i</span>&nbsp;<span class="op" id="3357373">&gt;=</span>&nbsp;<span class="num" id="3357376">0</span><span class="op" id="3357377">;</span>&nbsp;<span class="ident" id="3357379">i</span><span class="op" id="3357380">--</span>&nbsp;<span class="op" id="3357383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3357387">hc</span><span class="op" id="3357389">.</span><span class="ident" id="3357390">seq</span><span class="op" id="3357393">[</span><span class="ident" id="3357394">i</span><span class="op" id="3357395">]</span><span class="op" id="3357396">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357401">if</span>&nbsp;<span class="ident" id="3357404">hc</span><span class="op" id="3357406">.</span><span class="ident" id="3357407">seq</span><span class="op" id="3357410">[</span><span class="ident" id="3357411">i</span><span class="op" id="3357412">]</span>&nbsp;<span class="op" id="3357414">!=</span>&nbsp;<span class="num" id="3357417">0</span>&nbsp;<span class="op" id="3357419">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357424">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3357433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3357436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3357440">//&nbsp;Not&nbsp;allowed&nbsp;to&nbsp;let&nbsp;sequence&nbsp;number&nbsp;wrap.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3357485">//&nbsp;Instead,&nbsp;must&nbsp;renegotiate&nbsp;before&nbsp;it&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3357531">//&nbsp;Not&nbsp;likely&nbsp;enough&nbsp;to&nbsp;bother.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3357564">panic</span><span class="op" id="3357569">(</span><span class="string" id="3357570">&#34;TLS:&nbsp;sequence&nbsp;number&nbsp;wraparound&#34;</span><span class="op" id="3357603">)</span><br>
<span class="lineno"></span><span class="op" id="3357605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="3357608">//&nbsp;resetSeq&nbsp;resets&nbsp;the&nbsp;sequence&nbsp;number&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="3357656">func</span>&nbsp;<span class="op" id="3357661">(</span><span class="ident" id="3357662">hc</span>&nbsp;<span class="op" id="3357665">*</span><span class="ident" id="3357666">halfConn</span><span class="op" id="3357674">)</span>&nbsp;<span class="ident" id="3357676">resetSeq</span><span class="op" id="3357684">(</span><span class="op" id="3357685">)</span>&nbsp;<span class="op" id="3357687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357690">for</span>&nbsp;<span class="ident" id="3357694">i</span>&nbsp;<span class="op" id="3357696">:=</span>&nbsp;<span class="keyword" id="3357699">range</span>&nbsp;<span class="ident" id="3357705">hc</span><span class="op" id="3357707">.</span><span class="ident" id="3357708">seq</span>&nbsp;<span class="op" id="3357712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3357716">hc</span><span class="op" id="3357718">.</span><span class="ident" id="3357719">seq</span><span class="op" id="3357722">[</span><span class="ident" id="3357723">i</span><span class="op" id="3357724">]</span>&nbsp;<span class="op" id="3357726">=</span>&nbsp;<span class="num" id="3357728">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3357731">}</span><br>
<span class="lineno">170</span><span class="op" id="3357733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3357736">//&nbsp;removePadding&nbsp;returns&nbsp;an&nbsp;unpadded&nbsp;slice,&nbsp;in&nbsp;constant&nbsp;time,&nbsp;which&nbsp;is&nbsp;a&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="3357816">//&nbsp;of&nbsp;the&nbsp;input.&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;byte&nbsp;which&nbsp;is&nbsp;equal&nbsp;to&nbsp;255&nbsp;if&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="3357893">//&nbsp;was&nbsp;valid&nbsp;and&nbsp;0&nbsp;otherwise.&nbsp;See&nbsp;RFC&nbsp;2246,&nbsp;section&nbsp;6.2.3.2</span><br>
<span class="lineno">175</span><span class="keyword" id="3357953">func</span>&nbsp;<span class="ident" id="3357958">removePadding</span><span class="op" id="3357971">(</span><span class="ident" id="3357972">payload</span>&nbsp;<span class="op" id="3357980">[</span><span class="op" id="3357981">]</span><span class="builtintype" id="3357982">byte</span><span class="op" id="3357986">)</span>&nbsp;<span class="op" id="3357988">(</span><span class="op" id="3357989">[</span><span class="op" id="3357990">]</span><span class="builtintype" id="3357991">byte</span><span class="op" id="3357995">,</span>&nbsp;<span class="builtintype" id="3357997">byte</span><span class="op" id="3358001">)</span>&nbsp;<span class="op" id="3358003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3358006">if</span>&nbsp;<span class="builtinfunc" id="3358009">len</span><span class="op" id="3358012">(</span><span class="ident" id="3358013">payload</span><span class="op" id="3358020">)</span>&nbsp;<span class="op" id="3358022">&lt;</span>&nbsp;<span class="num" id="3358024">1</span>&nbsp;<span class="op" id="3358026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3358030">return</span>&nbsp;<span class="ident" id="3358037">payload</span><span class="op" id="3358044">,</span>&nbsp;<span class="num" id="3358046">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3358049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3358053">paddingLen</span>&nbsp;<span class="op" id="3358064">:=</span>&nbsp;<span class="ident" id="3358067">payload</span><span class="op" id="3358074">[</span><span class="builtinfunc" id="3358075">len</span><span class="op" id="3358078">(</span><span class="ident" id="3358079">payload</span><span class="op" id="3358086">)</span><span class="op" id="3358087">-</span><span class="num" id="3358088">1</span><span class="op" id="3358089">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3358092">t</span>&nbsp;<span class="op" id="3358094">:=</span>&nbsp;<span class="builtintype" id="3358097">uint</span><span class="op" id="3358101">(</span><span class="builtinfunc" id="3358102">len</span><span class="op" id="3358105">(</span><span class="ident" id="3358106">payload</span><span class="op" id="3358113">)</span><span class="op" id="3358114">-</span><span class="num" id="3358115">1</span><span class="op" id="3358116">)</span>&nbsp;<span class="op" id="3358118">-</span>&nbsp;<span class="builtintype" id="3358120">uint</span><span class="op" id="3358124">(</span><span class="ident" id="3358125">paddingLen</span><span class="op" id="3358135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3358138">//&nbsp;if&nbsp;len(payload)&nbsp;&gt;=&nbsp;(paddingLen&nbsp;-&nbsp;1)&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3358204">good</span>&nbsp;<span class="op" id="3358209">:=</span>&nbsp;<span class="builtintype" id="3358212">byte</span><span class="op" id="3358216">(</span><span class="builtintype" id="3358217">int32</span><span class="op" id="3358222">(</span><span class="op" id="3358223">^</span><span class="ident" id="3358224">t</span><span class="op" id="3358225">)</span>&nbsp;<span class="op" id="3358227">&gt;&gt;</span>&nbsp;<span class="num" id="3358230">31</span><span class="op" id="3358232">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3358236">toCheck</span>&nbsp;<span class="op" id="3358244">:=</span>&nbsp;<span class="num" id="3358247">255</span>&nbsp;<span class="comment" id="3358251">//&nbsp;the&nbsp;maximum&nbsp;possible&nbsp;padding&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3358291">//&nbsp;The&nbsp;length&nbsp;of&nbsp;the&nbsp;padded&nbsp;data&nbsp;is&nbsp;public,&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;an&nbsp;if&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3358361">if</span>&nbsp;<span class="ident" id="3358364">toCheck</span><span class="op" id="3358371">+</span><span class="num" id="3358372">1</span>&nbsp;<span class="op" id="3358374">&gt;</span>&nbsp;<span class="builtinfunc" id="3358376">len</span><span class="op" id="3358379">(</span><span class="ident" id="3358380">payload</span><span class="op" id="3358387">)</span>&nbsp;<span class="op" id="3358389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3358393">toCheck</span>&nbsp;<span class="op" id="3358401">=</span>&nbsp;<span class="builtinfunc" id="3358403">len</span><span class="op" id="3358406">(</span><span class="ident" id="3358407">payload</span><span class="op" id="3358414">)</span>&nbsp;<span class="op" id="3358416">-</span>&nbsp;<span class="num" id="3358418">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3358421">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3358425">for</span>&nbsp;<span class="ident" id="3358429">i</span>&nbsp;<span class="op" id="3358431">:=</span>&nbsp;<span class="num" id="3358434">0</span><span class="op" id="3358435">;</span>&nbsp;<span class="ident" id="3358437">i</span>&nbsp;<span class="op" id="3358439">&lt;</span>&nbsp;<span class="ident" id="3358441">toCheck</span><span class="op" id="3358448">;</span>&nbsp;<span class="ident" id="3358450">i</span><span class="op" id="3358451">++</span>&nbsp;<span class="op" id="3358454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3358458">t</span>&nbsp;<span class="op" id="3358460">:=</span>&nbsp;<span class="builtintype" id="3358463">uint</span><span class="op" id="3358467">(</span><span class="ident" id="3358468">paddingLen</span><span class="op" id="3358478">)</span>&nbsp;<span class="op" id="3358480">-</span>&nbsp;<span class="builtintype" id="3358482">uint</span><span class="op" id="3358486">(</span><span class="ident" id="3358487">i</span><span class="op" id="3358488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3358492">//&nbsp;if&nbsp;i&nbsp;&lt;=&nbsp;paddingLen&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3358542">mask</span>&nbsp;<span class="op" id="3358547">:=</span>&nbsp;<span class="builtintype" id="3358550">byte</span><span class="op" id="3358554">(</span><span class="builtintype" id="3358555">int32</span><span class="op" id="3358560">(</span><span class="op" id="3358561">^</span><span class="ident" id="3358562">t</span><span class="op" id="3358563">)</span>&nbsp;<span class="op" id="3358565">&gt;&gt;</span>&nbsp;<span class="num" id="3358568">31</span><span class="op" id="3358570">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3358574">b</span>&nbsp;<span class="op" id="3358576">:=</span>&nbsp;<span class="ident" id="3358579">payload</span><span class="op" id="3358586">[</span><span class="builtinfunc" id="3358587">len</span><span class="op" id="3358590">(</span><span class="ident" id="3358591">payload</span><span class="op" id="3358598">)</span><span class="op" id="3358599">-</span><span class="num" id="3358600">1</span><span class="op" id="3358601">-</span><span class="ident" id="3358602">i</span><span class="op" id="3358603">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3358607">good</span>&nbsp;<span class="op" id="3358612">&amp;^=</span>&nbsp;<span class="ident" id="3358616">mask</span><span class="op" id="3358620">&amp;</span><span class="ident" id="3358621">paddingLen</span>&nbsp;<span class="op" id="3358632">^</span>&nbsp;<span class="ident" id="3358634">mask</span><span class="op" id="3358638">&amp;</span><span class="ident" id="3358639">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3358642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3358646">//&nbsp;We&nbsp;AND&nbsp;together&nbsp;the&nbsp;bits&nbsp;of&nbsp;good&nbsp;and&nbsp;replicate&nbsp;the&nbsp;result&nbsp;across</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3358715">//&nbsp;all&nbsp;the&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3358733">good</span>&nbsp;<span class="op" id="3358738">&amp;=</span>&nbsp;<span class="ident" id="3358741">good</span>&nbsp;<span class="op" id="3358746">&lt;&lt;</span>&nbsp;<span class="num" id="3358749">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3358752">good</span>&nbsp;<span class="op" id="3358757">&amp;=</span>&nbsp;<span class="ident" id="3358760">good</span>&nbsp;<span class="op" id="3358765">&lt;&lt;</span>&nbsp;<span class="num" id="3358768">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3358771">good</span>&nbsp;<span class="op" id="3358776">&amp;=</span>&nbsp;<span class="ident" id="3358779">good</span>&nbsp;<span class="op" id="3358784">&lt;&lt;</span>&nbsp;<span class="num" id="3358787">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3358790">good</span>&nbsp;<span class="op" id="3358795">=</span>&nbsp;<span class="builtintype" id="3358797">uint8</span><span class="op" id="3358802">(</span><span class="builtintype" id="3358803">int8</span><span class="op" id="3358807">(</span><span class="ident" id="3358808">good</span><span class="op" id="3358812">)</span>&nbsp;<span class="op" id="3358814">&gt;&gt;</span>&nbsp;<span class="num" id="3358817">7</span><span class="op" id="3358818">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3358822">toRemove</span>&nbsp;<span class="op" id="3358831">:=</span>&nbsp;<span class="ident" id="3358834">good</span><span class="op" id="3358838">&amp;</span><span class="ident" id="3358839">paddingLen</span>&nbsp;<span class="op" id="3358850">+</span>&nbsp;<span class="num" id="3358852">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3358855">return</span>&nbsp;<span class="ident" id="3358862">payload</span><span class="op" id="3358869">[</span><span class="op" id="3358870">:</span><span class="builtinfunc" id="3358871">len</span><span class="op" id="3358874">(</span><span class="ident" id="3358875">payload</span><span class="op" id="3358882">)</span><span class="op" id="3358883">-</span><span class="builtintype" id="3358884">int</span><span class="op" id="3358887">(</span><span class="ident" id="3358888">toRemove</span><span class="op" id="3358896">)</span><span class="op" id="3358897">]</span><span class="op" id="3358898">,</span>&nbsp;<span class="ident" id="3358900">good</span><br>
<span class="lineno"></span><span class="op" id="3358905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment" id="3358908">//&nbsp;removePaddingSSL30&nbsp;is&nbsp;a&nbsp;replacement&nbsp;for&nbsp;removePadding&nbsp;in&nbsp;the&nbsp;case&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3358986">//&nbsp;protocol&nbsp;version&nbsp;is&nbsp;SSLv3.&nbsp;In&nbsp;this&nbsp;version,&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="3359061">//&nbsp;are&nbsp;random&nbsp;and&nbsp;cannot&nbsp;be&nbsp;checked.</span><br>
<span class="lineno"></span><span class="keyword" id="3359098">func</span>&nbsp;<span class="ident" id="3359103">removePaddingSSL30</span><span class="op" id="3359121">(</span><span class="ident" id="3359122">payload</span>&nbsp;<span class="op" id="3359130">[</span><span class="op" id="3359131">]</span><span class="builtintype" id="3359132">byte</span><span class="op" id="3359136">)</span>&nbsp;<span class="op" id="3359138">(</span><span class="op" id="3359139">[</span><span class="op" id="3359140">]</span><span class="builtintype" id="3359141">byte</span><span class="op" id="3359145">,</span>&nbsp;<span class="builtintype" id="3359147">byte</span><span class="op" id="3359151">)</span>&nbsp;<span class="op" id="3359153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3359156">if</span>&nbsp;<span class="builtinfunc" id="3359159">len</span><span class="op" id="3359162">(</span><span class="ident" id="3359163">payload</span><span class="op" id="3359170">)</span>&nbsp;<span class="op" id="3359172">&lt;</span>&nbsp;<span class="num" id="3359174">1</span>&nbsp;<span class="op" id="3359176">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3359180">return</span>&nbsp;<span class="ident" id="3359187">payload</span><span class="op" id="3359194">,</span>&nbsp;<span class="num" id="3359196">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3359199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3359203">paddingLen</span>&nbsp;<span class="op" id="3359214">:=</span>&nbsp;<span class="builtintype" id="3359217">int</span><span class="op" id="3359220">(</span><span class="ident" id="3359221">payload</span><span class="op" id="3359228">[</span><span class="builtinfunc" id="3359229">len</span><span class="op" id="3359232">(</span><span class="ident" id="3359233">payload</span><span class="op" id="3359240">)</span><span class="op" id="3359241">-</span><span class="num" id="3359242">1</span><span class="op" id="3359243">]</span><span class="op" id="3359244">)</span>&nbsp;<span class="op" id="3359246">+</span>&nbsp;<span class="num" id="3359248">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3359251">if</span>&nbsp;<span class="ident" id="3359254">paddingLen</span>&nbsp;<span class="op" id="3359265">&gt;</span>&nbsp;<span class="builtinfunc" id="3359267">len</span><span class="op" id="3359270">(</span><span class="ident" id="3359271">payload</span><span class="op" id="3359278">)</span>&nbsp;<span class="op" id="3359280">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3359284">return</span>&nbsp;<span class="ident" id="3359291">payload</span><span class="op" id="3359298">,</span>&nbsp;<span class="num" id="3359300">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3359303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3359307">return</span>&nbsp;<span class="ident" id="3359314">payload</span><span class="op" id="3359321">[</span><span class="op" id="3359322">:</span><span class="builtinfunc" id="3359323">len</span><span class="op" id="3359326">(</span><span class="ident" id="3359327">payload</span><span class="op" id="3359334">)</span><span class="op" id="3359335">-</span><span class="ident" id="3359336">paddingLen</span><span class="op" id="3359346">]</span><span class="op" id="3359347">,</span>&nbsp;<span class="num" id="3359349">255</span><br>
<span class="lineno"></span><span class="op" id="3359353">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="3359356">func</span>&nbsp;<span class="ident" id="3359361">roundUp</span><span class="op" id="3359368">(</span><span class="ident" id="3359369">a</span><span class="op" id="3359370">,</span>&nbsp;<span class="ident" id="3359372">b</span>&nbsp;<span class="builtintype" id="3359374">int</span><span class="op" id="3359377">)</span>&nbsp;<span class="builtintype" id="3359379">int</span>&nbsp;<span class="op" id="3359383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3359386">return</span>&nbsp;<span class="ident" id="3359393">a</span>&nbsp;<span class="op" id="3359395">+</span>&nbsp;<span class="op" id="3359397">(</span><span class="ident" id="3359398">b</span><span class="op" id="3359399">-</span><span class="ident" id="3359400">a</span><span class="op" id="3359401">%</span><span class="ident" id="3359402">b</span><span class="op" id="3359403">)</span><span class="op" id="3359404">%</span><span class="ident" id="3359405">b</span><br>
<span class="lineno"></span><span class="op" id="3359407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="comment" id="3359410">//&nbsp;cbcMode&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;block&nbsp;ciphers&nbsp;using&nbsp;cipher&nbsp;block&nbsp;chaining.</span><br>
<span class="lineno"></span><span class="keyword" id="3359484">type</span>&nbsp;<span class="ident" id="3359489">cbcMode</span>&nbsp;<span class="keyword" id="3359497">interface</span>&nbsp;<span class="op" id="3359507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3359510">cipher</span><span class="op" id="3359516">.</span><span class="ident" id="3359517">BlockMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3359528">SetIV</span><span class="op" id="3359533">(</span><span class="op" id="3359534">[</span><span class="op" id="3359535">]</span><span class="builtintype" id="3359536">byte</span><span class="op" id="3359540">)</span><br>
<span class="lineno"></span><span class="op" id="3359542">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="3359545">//&nbsp;decrypt&nbsp;checks&nbsp;and&nbsp;strips&nbsp;the&nbsp;mac&nbsp;and&nbsp;decrypts&nbsp;the&nbsp;data&nbsp;in&nbsp;b.&nbsp;Returns&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3359620">//&nbsp;success&nbsp;boolean,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;skip&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;record&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3359700">//&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;application&nbsp;payload,&nbsp;and&nbsp;an&nbsp;optional&nbsp;alert&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3359770">func</span>&nbsp;<span class="op" id="3359775">(</span><span class="ident" id="3359776">hc</span>&nbsp;<span class="op" id="3359779">*</span><span class="ident" id="3359780">halfConn</span><span class="op" id="3359788">)</span>&nbsp;<span class="ident" id="3359790">decrypt</span><span class="op" id="3359797">(</span><span class="ident" id="3359798">b</span>&nbsp;<span class="op" id="3359800">*</span><span class="ident" id="3359801">block</span><span class="op" id="3359806">)</span>&nbsp;<span class="op" id="3359808">(</span><span class="ident" id="3359809">ok</span>&nbsp;<span class="builtintype" id="3359812">bool</span><span class="op" id="3359816">,</span>&nbsp;<span class="ident" id="3359818">prefixLen</span>&nbsp;<span class="builtintype" id="3359828">int</span><span class="op" id="3359831">,</span>&nbsp;<span class="ident" id="3359833">alertValue</span>&nbsp;<span class="ident" id="3359844">alert</span><span class="op" id="3359849">)</span>&nbsp;<span class="op" id="3359851">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3359854">//&nbsp;pull&nbsp;out&nbsp;payload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3359875">payload</span>&nbsp;<span class="op" id="3359883">:=</span>&nbsp;<span class="ident" id="3359886">b</span><span class="op" id="3359887">.</span><span class="ident" id="3359888">data</span><span class="op" id="3359892">[</span><span class="ident" id="3359893">recordHeaderLen</span><span class="op" id="3359908">:</span><span class="op" id="3359909">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3359913">macSize</span>&nbsp;<span class="op" id="3359921">:=</span>&nbsp;<span class="num" id="3359924">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3359927">if</span>&nbsp;<span class="ident" id="3359930">hc</span><span class="op" id="3359932">.</span><span class="ident" id="3359933">mac</span>&nbsp;<span class="op" id="3359937">!=</span>&nbsp;<span class="ident" id="3359940">nil</span>&nbsp;<span class="op" id="3359944">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3359948">macSize</span>&nbsp;<span class="op" id="3359956">=</span>&nbsp;<span class="ident" id="3359958">hc</span><span class="op" id="3359960">.</span><span class="ident" id="3359961">mac</span><span class="op" id="3359964">.</span><span class="ident" id="3359965">Size</span><span class="op" id="3359969">(</span><span class="op" id="3359970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3359973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3359977">paddingGood</span>&nbsp;<span class="op" id="3359989">:=</span>&nbsp;<span class="builtintype" id="3359992">byte</span><span class="op" id="3359996">(</span><span class="num" id="3359997">255</span><span class="op" id="3360000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3360003">explicitIVLen</span>&nbsp;<span class="op" id="3360017">:=</span>&nbsp;<span class="num" id="3360020">0</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3360024">//&nbsp;decrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3360036">if</span>&nbsp;<span class="ident" id="3360039">hc</span><span class="op" id="3360041">.</span><span class="ident" id="3360042">cipher</span>&nbsp;<span class="op" id="3360049">!=</span>&nbsp;<span class="ident" id="3360052">nil</span>&nbsp;<span class="op" id="3360056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3360060">switch</span>&nbsp;<span class="ident" id="3360067">c</span>&nbsp;<span class="op" id="3360069">:=</span>&nbsp;<span class="ident" id="3360072">hc</span><span class="op" id="3360074">.</span><span class="ident" id="3360075">cipher</span><span class="op" id="3360081">.</span><span class="op" id="3360082">(</span><span class="keyword" id="3360083">type</span><span class="op" id="3360087">)</span>&nbsp;<span class="op" id="3360089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3360093">case</span>&nbsp;<span class="ident" id="3360098">cipher</span><span class="op" id="3360104">.</span><span class="ident" id="3360105">Stream</span><span class="op" id="3360111">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3360116">c</span><span class="op" id="3360117">.</span><span class="ident" id="3360118">XORKeyStream</span><span class="op" id="3360130">(</span><span class="ident" id="3360131">payload</span><span class="op" id="3360138">,</span>&nbsp;<span class="ident" id="3360140">payload</span><span class="op" id="3360147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3360151">case</span>&nbsp;<span class="ident" id="3360156">cipher</span><span class="op" id="3360162">.</span><span class="ident" id="3360163">AEAD</span><span class="op" id="3360167">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3360172">explicitIVLen</span>&nbsp;<span class="op" id="3360186">=</span>&nbsp;<span class="num" id="3360188">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3360193">if</span>&nbsp;<span class="builtinfunc" id="3360196">len</span><span class="op" id="3360199">(</span><span class="ident" id="3360200">payload</span><span class="op" id="3360207">)</span>&nbsp;<span class="op" id="3360209">&lt;</span>&nbsp;<span class="ident" id="3360211">explicitIVLen</span>&nbsp;<span class="op" id="3360225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3360231">return</span>&nbsp;<span class="builtintype" id="3360238">false</span><span class="op" id="3360243">,</span>&nbsp;<span class="num" id="3360245">0</span><span class="op" id="3360246">,</span>&nbsp;<span class="ident" id="3360248">alertBadRecordMAC</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3360269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3360274">nonce</span>&nbsp;<span class="op" id="3360280">:=</span>&nbsp;<span class="ident" id="3360283">payload</span><span class="op" id="3360290">[</span><span class="op" id="3360291">:</span><span class="num" id="3360292">8</span><span class="op" id="3360293">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3360298">payload</span>&nbsp;<span class="op" id="3360306">=</span>&nbsp;<span class="ident" id="3360308">payload</span><span class="op" id="3360315">[</span><span class="num" id="3360316">8</span><span class="op" id="3360317">:</span><span class="op" id="3360318">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3360324">var</span>&nbsp;<span class="ident" id="3360328">additionalData</span>&nbsp;<span class="op" id="3360343">[</span><span class="num" id="3360344">13</span><span class="op" id="3360346">]</span><span class="builtintype" id="3360347">byte</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3360355">copy</span><span class="op" id="3360359">(</span><span class="ident" id="3360360">additionalData</span><span class="op" id="3360374">[</span><span class="op" id="3360375">:</span><span class="op" id="3360376">]</span><span class="op" id="3360377">,</span>&nbsp;<span class="ident" id="3360379">hc</span><span class="op" id="3360381">.</span><span class="ident" id="3360382">seq</span><span class="op" id="3360385">[</span><span class="op" id="3360386">:</span><span class="op" id="3360387">]</span><span class="op" id="3360388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3360393">copy</span><span class="op" id="3360397">(</span><span class="ident" id="3360398">additionalData</span><span class="op" id="3360412">[</span><span class="num" id="3360413">8</span><span class="op" id="3360414">:</span><span class="op" id="3360415">]</span><span class="op" id="3360416">,</span>&nbsp;<span class="ident" id="3360418">b</span><span class="op" id="3360419">.</span><span class="ident" id="3360420">data</span><span class="op" id="3360424">[</span><span class="op" id="3360425">:</span><span class="num" id="3360426">3</span><span class="op" id="3360427">]</span><span class="op" id="3360428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3360433">n</span>&nbsp;<span class="op" id="3360435">:=</span>&nbsp;<span class="builtinfunc" id="3360438">len</span><span class="op" id="3360441">(</span><span class="ident" id="3360442">payload</span><span class="op" id="3360449">)</span>&nbsp;<span class="op" id="3360451">-</span>&nbsp;<span class="ident" id="3360453">c</span><span class="op" id="3360454">.</span><span class="ident" id="3360455">Overhead</span><span class="op" id="3360463">(</span><span class="op" id="3360464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3360469">additionalData</span><span class="op" id="3360483">[</span><span class="num" id="3360484">11</span><span class="op" id="3360486">]</span>&nbsp;<span class="op" id="3360488">=</span>&nbsp;<span class="builtintype" id="3360490">byte</span><span class="op" id="3360494">(</span><span class="ident" id="3360495">n</span>&nbsp;<span class="op" id="3360497">&gt;&gt;</span>&nbsp;<span class="num" id="3360500">8</span><span class="op" id="3360501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3360506">additionalData</span><span class="op" id="3360520">[</span><span class="num" id="3360521">12</span><span class="op" id="3360523">]</span>&nbsp;<span class="op" id="3360525">=</span>&nbsp;<span class="builtintype" id="3360527">byte</span><span class="op" id="3360531">(</span><span class="ident" id="3360532">n</span><span class="op" id="3360533">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3360538">var</span>&nbsp;<span class="ident" id="3360542">err</span>&nbsp;<span class="builtintype" id="3360546">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3360555">payload</span><span class="op" id="3360562">,</span>&nbsp;<span class="ident" id="3360564">err</span>&nbsp;<span class="op" id="3360568">=</span>&nbsp;<span class="ident" id="3360570">c</span><span class="op" id="3360571">.</span><span class="ident" id="3360572">Open</span><span class="op" id="3360576">(</span><span class="ident" id="3360577">payload</span><span class="op" id="3360584">[</span><span class="op" id="3360585">:</span><span class="num" id="3360586">0</span><span class="op" id="3360587">]</span><span class="op" id="3360588">,</span>&nbsp;<span class="ident" id="3360590">nonce</span><span class="op" id="3360595">,</span>&nbsp;<span class="ident" id="3360597">payload</span><span class="op" id="3360604">,</span>&nbsp;<span class="ident" id="3360606">additionalData</span><span class="op" id="3360620">[</span><span class="op" id="3360621">:</span><span class="op" id="3360622">]</span><span class="op" id="3360623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3360628">if</span>&nbsp;<span class="ident" id="3360631">err</span>&nbsp;<span class="op" id="3360635">!=</span>&nbsp;<span class="ident" id="3360638">nil</span>&nbsp;<span class="op" id="3360642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3360648">return</span>&nbsp;<span class="builtintype" id="3360655">false</span><span class="op" id="3360660">,</span>&nbsp;<span class="num" id="3360662">0</span><span class="op" id="3360663">,</span>&nbsp;<span class="ident" id="3360665">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3360686">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3360691">b</span><span class="op" id="3360692">.</span><span class="ident" id="3360693">resize</span><span class="op" id="3360699">(</span><span class="ident" id="3360700">recordHeaderLen</span>&nbsp;<span class="op" id="3360716">+</span>&nbsp;<span class="ident" id="3360718">explicitIVLen</span>&nbsp;<span class="op" id="3360732">+</span>&nbsp;<span class="builtinfunc" id="3360734">len</span><span class="op" id="3360737">(</span><span class="ident" id="3360738">payload</span><span class="op" id="3360745">)</span><span class="op" id="3360746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3360750">case</span>&nbsp;<span class="ident" id="3360755">cbcMode</span><span class="op" id="3360762">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3360767">blockSize</span>&nbsp;<span class="op" id="3360777">:=</span>&nbsp;<span class="ident" id="3360780">c</span><span class="op" id="3360781">.</span><span class="ident" id="3360782">BlockSize</span><span class="op" id="3360791">(</span><span class="op" id="3360792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3360797">if</span>&nbsp;<span class="ident" id="3360800">hc</span><span class="op" id="3360802">.</span><span class="ident" id="3360803">version</span>&nbsp;<span class="op" id="3360811">&gt;=</span>&nbsp;<span class="ident" id="3360814">VersionTLS11</span>&nbsp;<span class="op" id="3360827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3360833">explicitIVLen</span>&nbsp;<span class="op" id="3360847">=</span>&nbsp;<span class="ident" id="3360849">blockSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3360862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3360868">if</span>&nbsp;<span class="builtinfunc" id="3360871">len</span><span class="op" id="3360874">(</span><span class="ident" id="3360875">payload</span><span class="op" id="3360882">)</span><span class="op" id="3360883">%</span><span class="ident" id="3360884">blockSize</span>&nbsp;<span class="op" id="3360894">!=</span>&nbsp;<span class="num" id="3360897">0</span>&nbsp;<span class="op" id="3360899">||</span>&nbsp;<span class="builtinfunc" id="3360902">len</span><span class="op" id="3360905">(</span><span class="ident" id="3360906">payload</span><span class="op" id="3360913">)</span>&nbsp;<span class="op" id="3360915">&lt;</span>&nbsp;<span class="ident" id="3360917">roundUp</span><span class="op" id="3360924">(</span><span class="ident" id="3360925">explicitIVLen</span><span class="op" id="3360938">+</span><span class="ident" id="3360939">macSize</span><span class="op" id="3360946">+</span><span class="num" id="3360947">1</span><span class="op" id="3360948">,</span>&nbsp;<span class="ident" id="3360950">blockSize</span><span class="op" id="3360959">)</span>&nbsp;<span class="op" id="3360961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3360967">return</span>&nbsp;<span class="builtintype" id="3360974">false</span><span class="op" id="3360979">,</span>&nbsp;<span class="num" id="3360981">0</span><span class="op" id="3360982">,</span>&nbsp;<span class="ident" id="3360984">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3361005">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3361011">if</span>&nbsp;<span class="ident" id="3361014">explicitIVLen</span>&nbsp;<span class="op" id="3361028">&gt;</span>&nbsp;<span class="num" id="3361030">0</span>&nbsp;<span class="op" id="3361032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3361038">c</span><span class="op" id="3361039">.</span><span class="ident" id="3361040">SetIV</span><span class="op" id="3361045">(</span><span class="ident" id="3361046">payload</span><span class="op" id="3361053">[</span><span class="op" id="3361054">:</span><span class="ident" id="3361055">explicitIVLen</span><span class="op" id="3361068">]</span><span class="op" id="3361069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3361075">payload</span>&nbsp;<span class="op" id="3361083">=</span>&nbsp;<span class="ident" id="3361085">payload</span><span class="op" id="3361092">[</span><span class="ident" id="3361093">explicitIVLen</span><span class="op" id="3361106">:</span><span class="op" id="3361107">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3361112">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3361117">c</span><span class="op" id="3361118">.</span><span class="ident" id="3361119">CryptBlocks</span><span class="op" id="3361130">(</span><span class="ident" id="3361131">payload</span><span class="op" id="3361138">,</span>&nbsp;<span class="ident" id="3361140">payload</span><span class="op" id="3361147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3361152">if</span>&nbsp;<span class="ident" id="3361155">hc</span><span class="op" id="3361157">.</span><span class="ident" id="3361158">version</span>&nbsp;<span class="op" id="3361166">==</span>&nbsp;<span class="ident" id="3361169">VersionSSL30</span>&nbsp;<span class="op" id="3361182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3361188">payload</span><span class="op" id="3361195">,</span>&nbsp;<span class="ident" id="3361197">paddingGood</span>&nbsp;<span class="op" id="3361209">=</span>&nbsp;<span class="ident" id="3361211">removePaddingSSL30</span><span class="op" id="3361229">(</span><span class="ident" id="3361230">payload</span><span class="op" id="3361237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3361242">}</span>&nbsp;<span class="keyword" id="3361244">else</span>&nbsp;<span class="op" id="3361249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3361255">payload</span><span class="op" id="3361262">,</span>&nbsp;<span class="ident" id="3361264">paddingGood</span>&nbsp;<span class="op" id="3361276">=</span>&nbsp;<span class="ident" id="3361278">removePadding</span><span class="op" id="3361291">(</span><span class="ident" id="3361292">payload</span><span class="op" id="3361299">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3361304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3361309">b</span><span class="op" id="3361310">.</span><span class="ident" id="3361311">resize</span><span class="op" id="3361317">(</span><span class="ident" id="3361318">recordHeaderLen</span>&nbsp;<span class="op" id="3361334">+</span>&nbsp;<span class="ident" id="3361336">explicitIVLen</span>&nbsp;<span class="op" id="3361350">+</span>&nbsp;<span class="builtinfunc" id="3361352">len</span><span class="op" id="3361355">(</span><span class="ident" id="3361356">payload</span><span class="op" id="3361363">)</span><span class="op" id="3361364">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3361370">//&nbsp;note&nbsp;that&nbsp;we&nbsp;still&nbsp;have&nbsp;a&nbsp;timing&nbsp;side-channel&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3361429">//&nbsp;MAC&nbsp;check,&nbsp;below.&nbsp;An&nbsp;attacker&nbsp;can&nbsp;align&nbsp;the&nbsp;record</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3361486">//&nbsp;so&nbsp;that&nbsp;a&nbsp;correct&nbsp;padding&nbsp;will&nbsp;cause&nbsp;one&nbsp;less&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3361543">//&nbsp;block&nbsp;to&nbsp;be&nbsp;calculated.&nbsp;Then&nbsp;they&nbsp;can&nbsp;iteratively</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3361599">//&nbsp;decrypt&nbsp;a&nbsp;record&nbsp;by&nbsp;breaking&nbsp;each&nbsp;byte.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3361649">//&nbsp;&#34;Password&nbsp;Interception&nbsp;in&nbsp;a&nbsp;SSL/TLS&nbsp;Channel&#34;,&nbsp;Brice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3361707">//&nbsp;Canvel&nbsp;et&nbsp;al.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3361727">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3361733">//&nbsp;However,&nbsp;our&nbsp;behavior&nbsp;matches&nbsp;OpenSSL,&nbsp;so&nbsp;we&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3361789">//&nbsp;only&nbsp;as&nbsp;much&nbsp;as&nbsp;they&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3361819">default</span><span class="op" id="3361826">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3361831">panic</span><span class="op" id="3361836">(</span><span class="string" id="3361837">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="3361858">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3361862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3361865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3361869">//&nbsp;check,&nbsp;strip&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3361890">if</span>&nbsp;<span class="ident" id="3361893">hc</span><span class="op" id="3361895">.</span><span class="ident" id="3361896">mac</span>&nbsp;<span class="op" id="3361900">!=</span>&nbsp;<span class="ident" id="3361903">nil</span>&nbsp;<span class="op" id="3361907">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3361911">if</span>&nbsp;<span class="builtinfunc" id="3361914">len</span><span class="op" id="3361917">(</span><span class="ident" id="3361918">payload</span><span class="op" id="3361925">)</span>&nbsp;<span class="op" id="3361927">&lt;</span>&nbsp;<span class="ident" id="3361929">macSize</span>&nbsp;<span class="op" id="3361937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3361942">return</span>&nbsp;<span class="builtintype" id="3361949">false</span><span class="op" id="3361954">,</span>&nbsp;<span class="num" id="3361956">0</span><span class="op" id="3361957">,</span>&nbsp;<span class="ident" id="3361959">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3361979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3361984">//&nbsp;strip&nbsp;mac&nbsp;off&nbsp;payload,&nbsp;b.data</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3362019">n</span>&nbsp;<span class="op" id="3362021">:=</span>&nbsp;<span class="builtinfunc" id="3362024">len</span><span class="op" id="3362027">(</span><span class="ident" id="3362028">payload</span><span class="op" id="3362035">)</span>&nbsp;<span class="op" id="3362037">-</span>&nbsp;<span class="ident" id="3362039">macSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3362049">b</span><span class="op" id="3362050">.</span><span class="ident" id="3362051">data</span><span class="op" id="3362055">[</span><span class="num" id="3362056">3</span><span class="op" id="3362057">]</span>&nbsp;<span class="op" id="3362059">=</span>&nbsp;<span class="builtintype" id="3362061">byte</span><span class="op" id="3362065">(</span><span class="ident" id="3362066">n</span>&nbsp;<span class="op" id="3362068">&gt;&gt;</span>&nbsp;<span class="num" id="3362071">8</span><span class="op" id="3362072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3362076">b</span><span class="op" id="3362077">.</span><span class="ident" id="3362078">data</span><span class="op" id="3362082">[</span><span class="num" id="3362083">4</span><span class="op" id="3362084">]</span>&nbsp;<span class="op" id="3362086">=</span>&nbsp;<span class="builtintype" id="3362088">byte</span><span class="op" id="3362092">(</span><span class="ident" id="3362093">n</span><span class="op" id="3362094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3362098">b</span><span class="op" id="3362099">.</span><span class="ident" id="3362100">resize</span><span class="op" id="3362106">(</span><span class="ident" id="3362107">recordHeaderLen</span>&nbsp;<span class="op" id="3362123">+</span>&nbsp;<span class="ident" id="3362125">explicitIVLen</span>&nbsp;<span class="op" id="3362139">+</span>&nbsp;<span class="ident" id="3362141">n</span><span class="op" id="3362142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3362146">remoteMAC</span>&nbsp;<span class="op" id="3362156">:=</span>&nbsp;<span class="ident" id="3362159">payload</span><span class="op" id="3362166">[</span><span class="ident" id="3362167">n</span><span class="op" id="3362168">:</span><span class="op" id="3362169">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3362173">localMAC</span>&nbsp;<span class="op" id="3362182">:=</span>&nbsp;<span class="ident" id="3362185">hc</span><span class="op" id="3362187">.</span><span class="ident" id="3362188">mac</span><span class="op" id="3362191">.</span><span class="ident" id="3362192">MAC</span><span class="op" id="3362195">(</span><span class="ident" id="3362196">hc</span><span class="op" id="3362198">.</span><span class="ident" id="3362199">inDigestBuf</span><span class="op" id="3362210">,</span>&nbsp;<span class="ident" id="3362212">hc</span><span class="op" id="3362214">.</span><span class="ident" id="3362215">seq</span><span class="op" id="3362218">[</span><span class="num" id="3362219">0</span><span class="op" id="3362220">:</span><span class="op" id="3362221">]</span><span class="op" id="3362222">,</span>&nbsp;<span class="ident" id="3362224">b</span><span class="op" id="3362225">.</span><span class="ident" id="3362226">data</span><span class="op" id="3362230">[</span><span class="op" id="3362231">:</span><span class="ident" id="3362232">recordHeaderLen</span><span class="op" id="3362247">]</span><span class="op" id="3362248">,</span>&nbsp;<span class="ident" id="3362250">payload</span><span class="op" id="3362257">[</span><span class="op" id="3362258">:</span><span class="ident" id="3362259">n</span><span class="op" id="3362260">]</span><span class="op" id="3362261">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3362266">if</span>&nbsp;<span class="ident" id="3362269">subtle</span><span class="op" id="3362275">.</span><span class="ident" id="3362276">ConstantTimeCompare</span><span class="op" id="3362295">(</span><span class="ident" id="3362296">localMAC</span><span class="op" id="3362304">,</span>&nbsp;<span class="ident" id="3362306">remoteMAC</span><span class="op" id="3362315">)</span>&nbsp;<span class="op" id="3362317">!=</span>&nbsp;<span class="num" id="3362320">1</span>&nbsp;<span class="op" id="3362322">||</span>&nbsp;<span class="ident" id="3362325">paddingGood</span>&nbsp;<span class="op" id="3362337">!=</span>&nbsp;<span class="num" id="3362340">255</span>&nbsp;<span class="op" id="3362344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3362349">return</span>&nbsp;<span class="builtintype" id="3362356">false</span><span class="op" id="3362361">,</span>&nbsp;<span class="num" id="3362363">0</span><span class="op" id="3362364">,</span>&nbsp;<span class="ident" id="3362366">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3362386">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3362390">hc</span><span class="op" id="3362392">.</span><span class="ident" id="3362393">inDigestBuf</span>&nbsp;<span class="op" id="3362405">=</span>&nbsp;<span class="ident" id="3362407">localMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3362417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3362420">hc</span><span class="op" id="3362422">.</span><span class="ident" id="3362423">incSeq</span><span class="op" id="3362429">(</span><span class="op" id="3362430">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3362434">return</span>&nbsp;<span class="builtintype" id="3362441">true</span><span class="op" id="3362445">,</span>&nbsp;<span class="ident" id="3362447">recordHeaderLen</span>&nbsp;<span class="op" id="3362463">+</span>&nbsp;<span class="ident" id="3362465">explicitIVLen</span><span class="op" id="3362478">,</span>&nbsp;<span class="num" id="3362480">0</span><br>
<span class="lineno">335</span><span class="op" id="3362482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3362485">//&nbsp;padToBlockSize&nbsp;calculates&nbsp;the&nbsp;needed&nbsp;padding&nbsp;block,&nbsp;if&nbsp;any,&nbsp;for&nbsp;a&nbsp;payload.</span><br>
<span class="lineno"></span><span class="comment" id="3362563">//&nbsp;On&nbsp;exit,&nbsp;prefix&nbsp;aliases&nbsp;payload&nbsp;and&nbsp;extends&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;last&nbsp;full</span><br>
<span class="lineno"></span><span class="comment" id="3362638">//&nbsp;block&nbsp;of&nbsp;payload.&nbsp;finalBlock&nbsp;is&nbsp;a&nbsp;fresh&nbsp;slice&nbsp;which&nbsp;contains&nbsp;the&nbsp;contents&nbsp;of</span><br>
<span class="lineno">340</span><span class="comment" id="3362718">//&nbsp;any&nbsp;suffix&nbsp;of&nbsp;payload&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;needed&nbsp;padding&nbsp;to&nbsp;make&nbsp;finalBlock&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3362794">//&nbsp;full&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="3362809">func</span>&nbsp;<span class="ident" id="3362814">padToBlockSize</span><span class="op" id="3362828">(</span><span class="ident" id="3362829">payload</span>&nbsp;<span class="op" id="3362837">[</span><span class="op" id="3362838">]</span><span class="builtintype" id="3362839">byte</span><span class="op" id="3362843">,</span>&nbsp;<span class="ident" id="3362845">blockSize</span>&nbsp;<span class="builtintype" id="3362855">int</span><span class="op" id="3362858">)</span>&nbsp;<span class="op" id="3362860">(</span><span class="ident" id="3362861">prefix</span><span class="op" id="3362867">,</span>&nbsp;<span class="ident" id="3362869">finalBlock</span>&nbsp;<span class="op" id="3362880">[</span><span class="op" id="3362881">]</span><span class="builtintype" id="3362882">byte</span><span class="op" id="3362886">)</span>&nbsp;<span class="op" id="3362888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3362891">overrun</span>&nbsp;<span class="op" id="3362899">:=</span>&nbsp;<span class="builtinfunc" id="3362902">len</span><span class="op" id="3362905">(</span><span class="ident" id="3362906">payload</span><span class="op" id="3362913">)</span>&nbsp;<span class="op" id="3362915">%</span>&nbsp;<span class="ident" id="3362917">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3362928">paddingLen</span>&nbsp;<span class="op" id="3362939">:=</span>&nbsp;<span class="ident" id="3362942">blockSize</span>&nbsp;<span class="op" id="3362952">-</span>&nbsp;<span class="ident" id="3362954">overrun</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3362963">prefix</span>&nbsp;<span class="op" id="3362970">=</span>&nbsp;<span class="ident" id="3362972">payload</span><span class="op" id="3362979">[</span><span class="op" id="3362980">:</span><span class="builtinfunc" id="3362981">len</span><span class="op" id="3362984">(</span><span class="ident" id="3362985">payload</span><span class="op" id="3362992">)</span><span class="op" id="3362993">-</span><span class="ident" id="3362994">overrun</span><span class="op" id="3363001">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3363004">finalBlock</span>&nbsp;<span class="op" id="3363015">=</span>&nbsp;<span class="builtinfunc" id="3363017">make</span><span class="op" id="3363021">(</span><span class="op" id="3363022">[</span><span class="op" id="3363023">]</span><span class="builtintype" id="3363024">byte</span><span class="op" id="3363028">,</span>&nbsp;<span class="ident" id="3363030">blockSize</span><span class="op" id="3363039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3363042">copy</span><span class="op" id="3363046">(</span><span class="ident" id="3363047">finalBlock</span><span class="op" id="3363057">,</span>&nbsp;<span class="ident" id="3363059">payload</span><span class="op" id="3363066">[</span><span class="builtinfunc" id="3363067">len</span><span class="op" id="3363070">(</span><span class="ident" id="3363071">payload</span><span class="op" id="3363078">)</span><span class="op" id="3363079">-</span><span class="ident" id="3363080">overrun</span><span class="op" id="3363087">:</span><span class="op" id="3363088">]</span><span class="op" id="3363089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3363092">for</span>&nbsp;<span class="ident" id="3363096">i</span>&nbsp;<span class="op" id="3363098">:=</span>&nbsp;<span class="ident" id="3363101">overrun</span><span class="op" id="3363108">;</span>&nbsp;<span class="ident" id="3363110">i</span>&nbsp;<span class="op" id="3363112">&lt;</span>&nbsp;<span class="ident" id="3363114">blockSize</span><span class="op" id="3363123">;</span>&nbsp;<span class="ident" id="3363125">i</span><span class="op" id="3363126">++</span>&nbsp;<span class="op" id="3363129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3363133">finalBlock</span><span class="op" id="3363143">[</span><span class="ident" id="3363144">i</span><span class="op" id="3363145">]</span>&nbsp;<span class="op" id="3363147">=</span>&nbsp;<span class="builtintype" id="3363149">byte</span><span class="op" id="3363153">(</span><span class="ident" id="3363154">paddingLen</span>&nbsp;<span class="op" id="3363165">-</span>&nbsp;<span class="num" id="3363167">1</span><span class="op" id="3363168">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3363171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3363174">return</span><br>
<span class="lineno"></span><span class="op" id="3363181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3363184">//&nbsp;encrypt&nbsp;encrypts&nbsp;and&nbsp;macs&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno">355</span><span class="keyword" id="3363228">func</span>&nbsp;<span class="op" id="3363233">(</span><span class="ident" id="3363234">hc</span>&nbsp;<span class="op" id="3363237">*</span><span class="ident" id="3363238">halfConn</span><span class="op" id="3363246">)</span>&nbsp;<span class="ident" id="3363248">encrypt</span><span class="op" id="3363255">(</span><span class="ident" id="3363256">b</span>&nbsp;<span class="op" id="3363258">*</span><span class="ident" id="3363259">block</span><span class="op" id="3363264">,</span>&nbsp;<span class="ident" id="3363266">explicitIVLen</span>&nbsp;<span class="builtintype" id="3363280">int</span><span class="op" id="3363283">)</span>&nbsp;<span class="op" id="3363285">(</span><span class="builtintype" id="3363286">bool</span><span class="op" id="3363290">,</span>&nbsp;<span class="ident" id="3363292">alert</span><span class="op" id="3363297">)</span>&nbsp;<span class="op" id="3363299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3363302">//&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3363310">if</span>&nbsp;<span class="ident" id="3363313">hc</span><span class="op" id="3363315">.</span><span class="ident" id="3363316">mac</span>&nbsp;<span class="op" id="3363320">!=</span>&nbsp;<span class="ident" id="3363323">nil</span>&nbsp;<span class="op" id="3363327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3363331">mac</span>&nbsp;<span class="op" id="3363335">:=</span>&nbsp;<span class="ident" id="3363338">hc</span><span class="op" id="3363340">.</span><span class="ident" id="3363341">mac</span><span class="op" id="3363344">.</span><span class="ident" id="3363345">MAC</span><span class="op" id="3363348">(</span><span class="ident" id="3363349">hc</span><span class="op" id="3363351">.</span><span class="ident" id="3363352">outDigestBuf</span><span class="op" id="3363364">,</span>&nbsp;<span class="ident" id="3363366">hc</span><span class="op" id="3363368">.</span><span class="ident" id="3363369">seq</span><span class="op" id="3363372">[</span><span class="num" id="3363373">0</span><span class="op" id="3363374">:</span><span class="op" id="3363375">]</span><span class="op" id="3363376">,</span>&nbsp;<span class="ident" id="3363378">b</span><span class="op" id="3363379">.</span><span class="ident" id="3363380">data</span><span class="op" id="3363384">[</span><span class="op" id="3363385">:</span><span class="ident" id="3363386">recordHeaderLen</span><span class="op" id="3363401">]</span><span class="op" id="3363402">,</span>&nbsp;<span class="ident" id="3363404">b</span><span class="op" id="3363405">.</span><span class="ident" id="3363406">data</span><span class="op" id="3363410">[</span><span class="ident" id="3363411">recordHeaderLen</span><span class="op" id="3363426">+</span><span class="ident" id="3363427">explicitIVLen</span><span class="op" id="3363440">:</span><span class="op" id="3363441">]</span><span class="op" id="3363442">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3363447">n</span>&nbsp;<span class="op" id="3363449">:=</span>&nbsp;<span class="builtinfunc" id="3363452">len</span><span class="op" id="3363455">(</span><span class="ident" id="3363456">b</span><span class="op" id="3363457">.</span><span class="ident" id="3363458">data</span><span class="op" id="3363462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3363466">b</span><span class="op" id="3363467">.</span><span class="ident" id="3363468">resize</span><span class="op" id="3363474">(</span><span class="ident" id="3363475">n</span>&nbsp;<span class="op" id="3363477">+</span>&nbsp;<span class="builtinfunc" id="3363479">len</span><span class="op" id="3363482">(</span><span class="ident" id="3363483">mac</span><span class="op" id="3363486">)</span><span class="op" id="3363487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3363491">copy</span><span class="op" id="3363495">(</span><span class="ident" id="3363496">b</span><span class="op" id="3363497">.</span><span class="ident" id="3363498">data</span><span class="op" id="3363502">[</span><span class="ident" id="3363503">n</span><span class="op" id="3363504">:</span><span class="op" id="3363505">]</span><span class="op" id="3363506">,</span>&nbsp;<span class="ident" id="3363508">mac</span><span class="op" id="3363511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3363515">hc</span><span class="op" id="3363517">.</span><span class="ident" id="3363518">outDigestBuf</span>&nbsp;<span class="op" id="3363531">=</span>&nbsp;<span class="ident" id="3363533">mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3363538">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3363542">payload</span>&nbsp;<span class="op" id="3363550">:=</span>&nbsp;<span class="ident" id="3363553">b</span><span class="op" id="3363554">.</span><span class="ident" id="3363555">data</span><span class="op" id="3363559">[</span><span class="ident" id="3363560">recordHeaderLen</span><span class="op" id="3363575">:</span><span class="op" id="3363576">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3363580">//&nbsp;encrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3363592">if</span>&nbsp;<span class="ident" id="3363595">hc</span><span class="op" id="3363597">.</span><span class="ident" id="3363598">cipher</span>&nbsp;<span class="op" id="3363605">!=</span>&nbsp;<span class="ident" id="3363608">nil</span>&nbsp;<span class="op" id="3363612">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3363616">switch</span>&nbsp;<span class="ident" id="3363623">c</span>&nbsp;<span class="op" id="3363625">:=</span>&nbsp;<span class="ident" id="3363628">hc</span><span class="op" id="3363630">.</span><span class="ident" id="3363631">cipher</span><span class="op" id="3363637">.</span><span class="op" id="3363638">(</span><span class="keyword" id="3363639">type</span><span class="op" id="3363643">)</span>&nbsp;<span class="op" id="3363645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3363649">case</span>&nbsp;<span class="ident" id="3363654">cipher</span><span class="op" id="3363660">.</span><span class="ident" id="3363661">Stream</span><span class="op" id="3363667">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3363672">c</span><span class="op" id="3363673">.</span><span class="ident" id="3363674">XORKeyStream</span><span class="op" id="3363686">(</span><span class="ident" id="3363687">payload</span><span class="op" id="3363694">,</span>&nbsp;<span class="ident" id="3363696">payload</span><span class="op" id="3363703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3363707">case</span>&nbsp;<span class="ident" id="3363712">cipher</span><span class="op" id="3363718">.</span><span class="ident" id="3363719">AEAD</span><span class="op" id="3363723">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3363728">payloadLen</span>&nbsp;<span class="op" id="3363739">:=</span>&nbsp;<span class="builtinfunc" id="3363742">len</span><span class="op" id="3363745">(</span><span class="ident" id="3363746">b</span><span class="op" id="3363747">.</span><span class="ident" id="3363748">data</span><span class="op" id="3363752">)</span>&nbsp;<span class="op" id="3363754">-</span>&nbsp;<span class="ident" id="3363756">recordHeaderLen</span>&nbsp;<span class="op" id="3363772">-</span>&nbsp;<span class="ident" id="3363774">explicitIVLen</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3363791">b</span><span class="op" id="3363792">.</span><span class="ident" id="3363793">resize</span><span class="op" id="3363799">(</span><span class="builtinfunc" id="3363800">len</span><span class="op" id="3363803">(</span><span class="ident" id="3363804">b</span><span class="op" id="3363805">.</span><span class="ident" id="3363806">data</span><span class="op" id="3363810">)</span>&nbsp;<span class="op" id="3363812">+</span>&nbsp;<span class="ident" id="3363814">c</span><span class="op" id="3363815">.</span><span class="ident" id="3363816">Overhead</span><span class="op" id="3363824">(</span><span class="op" id="3363825">)</span><span class="op" id="3363826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3363831">nonce</span>&nbsp;<span class="op" id="3363837">:=</span>&nbsp;<span class="ident" id="3363840">b</span><span class="op" id="3363841">.</span><span class="ident" id="3363842">data</span><span class="op" id="3363846">[</span><span class="ident" id="3363847">recordHeaderLen</span>&nbsp;<span class="op" id="3363863">:</span>&nbsp;<span class="ident" id="3363865">recordHeaderLen</span><span class="op" id="3363880">+</span><span class="ident" id="3363881">explicitIVLen</span><span class="op" id="3363894">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3363899">payload</span>&nbsp;<span class="op" id="3363907">:=</span>&nbsp;<span class="ident" id="3363910">b</span><span class="op" id="3363911">.</span><span class="ident" id="3363912">data</span><span class="op" id="3363916">[</span><span class="ident" id="3363917">recordHeaderLen</span><span class="op" id="3363932">+</span><span class="ident" id="3363933">explicitIVLen</span><span class="op" id="3363946">:</span><span class="op" id="3363947">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3363952">payload</span>&nbsp;<span class="op" id="3363960">=</span>&nbsp;<span class="ident" id="3363962">payload</span><span class="op" id="3363969">[</span><span class="op" id="3363970">:</span><span class="ident" id="3363971">payloadLen</span><span class="op" id="3363981">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3363987">var</span>&nbsp;<span class="ident" id="3363991">additionalData</span>&nbsp;<span class="op" id="3364006">[</span><span class="num" id="3364007">13</span><span class="op" id="3364009">]</span><span class="builtintype" id="3364010">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3364018">copy</span><span class="op" id="3364022">(</span><span class="ident" id="3364023">additionalData</span><span class="op" id="3364037">[</span><span class="op" id="3364038">:</span><span class="op" id="3364039">]</span><span class="op" id="3364040">,</span>&nbsp;<span class="ident" id="3364042">hc</span><span class="op" id="3364044">.</span><span class="ident" id="3364045">seq</span><span class="op" id="3364048">[</span><span class="op" id="3364049">:</span><span class="op" id="3364050">]</span><span class="op" id="3364051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3364056">copy</span><span class="op" id="3364060">(</span><span class="ident" id="3364061">additionalData</span><span class="op" id="3364075">[</span><span class="num" id="3364076">8</span><span class="op" id="3364077">:</span><span class="op" id="3364078">]</span><span class="op" id="3364079">,</span>&nbsp;<span class="ident" id="3364081">b</span><span class="op" id="3364082">.</span><span class="ident" id="3364083">data</span><span class="op" id="3364087">[</span><span class="op" id="3364088">:</span><span class="num" id="3364089">3</span><span class="op" id="3364090">]</span><span class="op" id="3364091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3364096">additionalData</span><span class="op" id="3364110">[</span><span class="num" id="3364111">11</span><span class="op" id="3364113">]</span>&nbsp;<span class="op" id="3364115">=</span>&nbsp;<span class="builtintype" id="3364117">byte</span><span class="op" id="3364121">(</span><span class="ident" id="3364122">payloadLen</span>&nbsp;<span class="op" id="3364133">&gt;&gt;</span>&nbsp;<span class="num" id="3364136">8</span><span class="op" id="3364137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3364142">additionalData</span><span class="op" id="3364156">[</span><span class="num" id="3364157">12</span><span class="op" id="3364159">]</span>&nbsp;<span class="op" id="3364161">=</span>&nbsp;<span class="builtintype" id="3364163">byte</span><span class="op" id="3364167">(</span><span class="ident" id="3364168">payloadLen</span><span class="op" id="3364178">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3364184">c</span><span class="op" id="3364185">.</span><span class="ident" id="3364186">Seal</span><span class="op" id="3364190">(</span><span class="ident" id="3364191">payload</span><span class="op" id="3364198">[</span><span class="op" id="3364199">:</span><span class="num" id="3364200">0</span><span class="op" id="3364201">]</span><span class="op" id="3364202">,</span>&nbsp;<span class="ident" id="3364204">nonce</span><span class="op" id="3364209">,</span>&nbsp;<span class="ident" id="3364211">payload</span><span class="op" id="3364218">,</span>&nbsp;<span class="ident" id="3364220">additionalData</span><span class="op" id="3364234">[</span><span class="op" id="3364235">:</span><span class="op" id="3364236">]</span><span class="op" id="3364237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3364241">case</span>&nbsp;<span class="ident" id="3364246">cbcMode</span><span class="op" id="3364253">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3364258">blockSize</span>&nbsp;<span class="op" id="3364268">:=</span>&nbsp;<span class="ident" id="3364271">c</span><span class="op" id="3364272">.</span><span class="ident" id="3364273">BlockSize</span><span class="op" id="3364282">(</span><span class="op" id="3364283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3364288">if</span>&nbsp;<span class="ident" id="3364291">explicitIVLen</span>&nbsp;<span class="op" id="3364305">&gt;</span>&nbsp;<span class="num" id="3364307">0</span>&nbsp;<span class="op" id="3364309">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3364315">c</span><span class="op" id="3364316">.</span><span class="ident" id="3364317">SetIV</span><span class="op" id="3364322">(</span><span class="ident" id="3364323">payload</span><span class="op" id="3364330">[</span><span class="op" id="3364331">:</span><span class="ident" id="3364332">explicitIVLen</span><span class="op" id="3364345">]</span><span class="op" id="3364346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3364352">payload</span>&nbsp;<span class="op" id="3364360">=</span>&nbsp;<span class="ident" id="3364362">payload</span><span class="op" id="3364369">[</span><span class="ident" id="3364370">explicitIVLen</span><span class="op" id="3364383">:</span><span class="op" id="3364384">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3364389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3364394">prefix</span><span class="op" id="3364400">,</span>&nbsp;<span class="ident" id="3364402">finalBlock</span>&nbsp;<span class="op" id="3364413">:=</span>&nbsp;<span class="ident" id="3364416">padToBlockSize</span><span class="op" id="3364430">(</span><span class="ident" id="3364431">payload</span><span class="op" id="3364438">,</span>&nbsp;<span class="ident" id="3364440">blockSize</span><span class="op" id="3364449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3364454">b</span><span class="op" id="3364455">.</span><span class="ident" id="3364456">resize</span><span class="op" id="3364462">(</span><span class="ident" id="3364463">recordHeaderLen</span>&nbsp;<span class="op" id="3364479">+</span>&nbsp;<span class="ident" id="3364481">explicitIVLen</span>&nbsp;<span class="op" id="3364495">+</span>&nbsp;<span class="builtinfunc" id="3364497">len</span><span class="op" id="3364500">(</span><span class="ident" id="3364501">prefix</span><span class="op" id="3364507">)</span>&nbsp;<span class="op" id="3364509">+</span>&nbsp;<span class="builtinfunc" id="3364511">len</span><span class="op" id="3364514">(</span><span class="ident" id="3364515">finalBlock</span><span class="op" id="3364525">)</span><span class="op" id="3364526">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3364531">c</span><span class="op" id="3364532">.</span><span class="ident" id="3364533">CryptBlocks</span><span class="op" id="3364544">(</span><span class="ident" id="3364545">b</span><span class="op" id="3364546">.</span><span class="ident" id="3364547">data</span><span class="op" id="3364551">[</span><span class="ident" id="3364552">recordHeaderLen</span><span class="op" id="3364567">+</span><span class="ident" id="3364568">explicitIVLen</span><span class="op" id="3364581">:</span><span class="op" id="3364582">]</span><span class="op" id="3364583">,</span>&nbsp;<span class="ident" id="3364585">prefix</span><span class="op" id="3364591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3364596">c</span><span class="op" id="3364597">.</span><span class="ident" id="3364598">CryptBlocks</span><span class="op" id="3364609">(</span><span class="ident" id="3364610">b</span><span class="op" id="3364611">.</span><span class="ident" id="3364612">data</span><span class="op" id="3364616">[</span><span class="ident" id="3364617">recordHeaderLen</span><span class="op" id="3364632">+</span><span class="ident" id="3364633">explicitIVLen</span><span class="op" id="3364646">+</span><span class="builtinfunc" id="3364647">len</span><span class="op" id="3364650">(</span><span class="ident" id="3364651">prefix</span><span class="op" id="3364657">)</span><span class="op" id="3364658">:</span><span class="op" id="3364659">]</span><span class="op" id="3364660">,</span>&nbsp;<span class="ident" id="3364662">finalBlock</span><span class="op" id="3364672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3364676">default</span><span class="op" id="3364683">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3364688">panic</span><span class="op" id="3364693">(</span><span class="string" id="3364694">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="3364715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3364719">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3364722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3364726">//&nbsp;update&nbsp;length&nbsp;to&nbsp;include&nbsp;MAC&nbsp;and&nbsp;any&nbsp;block&nbsp;padding&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3364789">n</span>&nbsp;<span class="op" id="3364791">:=</span>&nbsp;<span class="builtinfunc" id="3364794">len</span><span class="op" id="3364797">(</span><span class="ident" id="3364798">b</span><span class="op" id="3364799">.</span><span class="ident" id="3364800">data</span><span class="op" id="3364804">)</span>&nbsp;<span class="op" id="3364806">-</span>&nbsp;<span class="ident" id="3364808">recordHeaderLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3364825">b</span><span class="op" id="3364826">.</span><span class="ident" id="3364827">data</span><span class="op" id="3364831">[</span><span class="num" id="3364832">3</span><span class="op" id="3364833">]</span>&nbsp;<span class="op" id="3364835">=</span>&nbsp;<span class="builtintype" id="3364837">byte</span><span class="op" id="3364841">(</span><span class="ident" id="3364842">n</span>&nbsp;<span class="op" id="3364844">&gt;&gt;</span>&nbsp;<span class="num" id="3364847">8</span><span class="op" id="3364848">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3364851">b</span><span class="op" id="3364852">.</span><span class="ident" id="3364853">data</span><span class="op" id="3364857">[</span><span class="num" id="3364858">4</span><span class="op" id="3364859">]</span>&nbsp;<span class="op" id="3364861">=</span>&nbsp;<span class="builtintype" id="3364863">byte</span><span class="op" id="3364867">(</span><span class="ident" id="3364868">n</span><span class="op" id="3364869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3364872">hc</span><span class="op" id="3364874">.</span><span class="ident" id="3364875">incSeq</span><span class="op" id="3364881">(</span><span class="op" id="3364882">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3364886">return</span>&nbsp;<span class="builtintype" id="3364893">true</span><span class="op" id="3364897">,</span>&nbsp;<span class="num" id="3364899">0</span><br>
<span class="lineno"></span><span class="op" id="3364901">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="3364904">//&nbsp;A&nbsp;block&nbsp;is&nbsp;a&nbsp;simple&nbsp;data&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3364940">type</span>&nbsp;<span class="ident" id="3364945">block</span>&nbsp;<span class="keyword" id="3364951">struct</span>&nbsp;<span class="op" id="3364958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3364961">data</span>&nbsp;<span class="op" id="3364966">[</span><span class="op" id="3364967">]</span><span class="builtintype" id="3364968">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3364974">off</span>&nbsp;&nbsp;<span class="builtintype" id="3364979">int</span>&nbsp;<span class="comment" id="3364983">//&nbsp;index&nbsp;for&nbsp;Read</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3365002">link</span>&nbsp;<span class="op" id="3365007">*</span><span class="ident" id="3365008">block</span><br>
<span class="lineno"></span><span class="op" id="3365014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3365017">//&nbsp;resize&nbsp;resizes&nbsp;block&nbsp;to&nbsp;be&nbsp;n&nbsp;bytes,&nbsp;growing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3365078">func</span>&nbsp;<span class="op" id="3365083">(</span><span class="ident" id="3365084">b</span>&nbsp;<span class="op" id="3365086">*</span><span class="ident" id="3365087">block</span><span class="op" id="3365092">)</span>&nbsp;<span class="ident" id="3365094">resize</span><span class="op" id="3365100">(</span><span class="ident" id="3365101">n</span>&nbsp;<span class="builtintype" id="3365103">int</span><span class="op" id="3365106">)</span>&nbsp;<span class="op" id="3365108">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3365111">if</span>&nbsp;<span class="ident" id="3365114">n</span>&nbsp;<span class="op" id="3365116">&gt;</span>&nbsp;<span class="builtinfunc" id="3365118">cap</span><span class="op" id="3365121">(</span><span class="ident" id="3365122">b</span><span class="op" id="3365123">.</span><span class="ident" id="3365124">data</span><span class="op" id="3365128">)</span>&nbsp;<span class="op" id="3365130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3365134">b</span><span class="op" id="3365135">.</span><span class="ident" id="3365136">reserve</span><span class="op" id="3365143">(</span><span class="ident" id="3365144">n</span><span class="op" id="3365145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3365148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3365151">b</span><span class="op" id="3365152">.</span><span class="ident" id="3365153">data</span>&nbsp;<span class="op" id="3365158">=</span>&nbsp;<span class="ident" id="3365160">b</span><span class="op" id="3365161">.</span><span class="ident" id="3365162">data</span><span class="op" id="3365166">[</span><span class="num" id="3365167">0</span><span class="op" id="3365168">:</span><span class="ident" id="3365169">n</span><span class="op" id="3365170">]</span><br>
<span class="lineno"></span><span class="op" id="3365172">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="3365175">//&nbsp;reserve&nbsp;makes&nbsp;sure&nbsp;that&nbsp;block&nbsp;contains&nbsp;a&nbsp;capacity&nbsp;of&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3365249">func</span>&nbsp;<span class="op" id="3365254">(</span><span class="ident" id="3365255">b</span>&nbsp;<span class="op" id="3365257">*</span><span class="ident" id="3365258">block</span><span class="op" id="3365263">)</span>&nbsp;<span class="ident" id="3365265">reserve</span><span class="op" id="3365272">(</span><span class="ident" id="3365273">n</span>&nbsp;<span class="builtintype" id="3365275">int</span><span class="op" id="3365278">)</span>&nbsp;<span class="op" id="3365280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3365283">if</span>&nbsp;<span class="builtinfunc" id="3365286">cap</span><span class="op" id="3365289">(</span><span class="ident" id="3365290">b</span><span class="op" id="3365291">.</span><span class="ident" id="3365292">data</span><span class="op" id="3365296">)</span>&nbsp;<span class="op" id="3365298">&gt;=</span>&nbsp;<span class="ident" id="3365301">n</span>&nbsp;<span class="op" id="3365303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3365307">return</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3365315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3365318">m</span>&nbsp;<span class="op" id="3365320">:=</span>&nbsp;<span class="builtinfunc" id="3365323">cap</span><span class="op" id="3365326">(</span><span class="ident" id="3365327">b</span><span class="op" id="3365328">.</span><span class="ident" id="3365329">data</span><span class="op" id="3365333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3365336">if</span>&nbsp;<span class="ident" id="3365339">m</span>&nbsp;<span class="op" id="3365341">==</span>&nbsp;<span class="num" id="3365344">0</span>&nbsp;<span class="op" id="3365346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3365350">m</span>&nbsp;<span class="op" id="3365352">=</span>&nbsp;<span class="num" id="3365354">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3365360">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3365363">for</span>&nbsp;<span class="ident" id="3365367">m</span>&nbsp;<span class="op" id="3365369">&lt;</span>&nbsp;<span class="ident" id="3365371">n</span>&nbsp;<span class="op" id="3365373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3365377">m</span>&nbsp;<span class="op" id="3365379">*=</span>&nbsp;<span class="num" id="3365382">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3365385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3365388">data</span>&nbsp;<span class="op" id="3365393">:=</span>&nbsp;<span class="builtinfunc" id="3365396">make</span><span class="op" id="3365400">(</span><span class="op" id="3365401">[</span><span class="op" id="3365402">]</span><span class="builtintype" id="3365403">byte</span><span class="op" id="3365407">,</span>&nbsp;<span class="builtinfunc" id="3365409">len</span><span class="op" id="3365412">(</span><span class="ident" id="3365413">b</span><span class="op" id="3365414">.</span><span class="ident" id="3365415">data</span><span class="op" id="3365419">)</span><span class="op" id="3365420">,</span>&nbsp;<span class="ident" id="3365422">m</span><span class="op" id="3365423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3365426">copy</span><span class="op" id="3365430">(</span><span class="ident" id="3365431">data</span><span class="op" id="3365435">,</span>&nbsp;<span class="ident" id="3365437">b</span><span class="op" id="3365438">.</span><span class="ident" id="3365439">data</span><span class="op" id="3365443">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3365446">b</span><span class="op" id="3365447">.</span><span class="ident" id="3365448">data</span>&nbsp;<span class="op" id="3365453">=</span>&nbsp;<span class="ident" id="3365455">data</span><br>
<span class="lineno"></span><span class="op" id="3365460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3365463">//&nbsp;readFromUntil&nbsp;reads&nbsp;from&nbsp;r&nbsp;into&nbsp;b&nbsp;until&nbsp;b&nbsp;contains&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes</span><br>
<span class="lineno"></span><span class="comment" id="3365534">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">445</span><span class="keyword" id="3365563">func</span>&nbsp;<span class="op" id="3365568">(</span><span class="ident" id="3365569">b</span>&nbsp;<span class="op" id="3365571">*</span><span class="ident" id="3365572">block</span><span class="op" id="3365577">)</span>&nbsp;<span class="ident" id="3365579">readFromUntil</span><span class="op" id="3365592">(</span><span class="ident" id="3365593">r</span>&nbsp;<span class="ident" id="3365595">io</span><span class="op" id="3365597">.</span><span class="ident" id="3365598">Reader</span><span class="op" id="3365604">,</span>&nbsp;<span class="ident" id="3365606">n</span>&nbsp;<span class="builtintype" id="3365608">int</span><span class="op" id="3365611">)</span>&nbsp;<span class="builtintype" id="3365613">error</span>&nbsp;<span class="op" id="3365619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3365622">//&nbsp;quick&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3365637">if</span>&nbsp;<span class="builtinfunc" id="3365640">len</span><span class="op" id="3365643">(</span><span class="ident" id="3365644">b</span><span class="op" id="3365645">.</span><span class="ident" id="3365646">data</span><span class="op" id="3365650">)</span>&nbsp;<span class="op" id="3365652">&gt;=</span>&nbsp;<span class="ident" id="3365655">n</span>&nbsp;<span class="op" id="3365657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3365661">return</span>&nbsp;<span class="ident" id="3365668">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3365673">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3365677">//&nbsp;read&nbsp;until&nbsp;have&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3365705">b</span><span class="op" id="3365706">.</span><span class="ident" id="3365707">reserve</span><span class="op" id="3365714">(</span><span class="ident" id="3365715">n</span><span class="op" id="3365716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3365719">for</span>&nbsp;<span class="op" id="3365723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3365727">m</span><span class="op" id="3365728">,</span>&nbsp;<span class="ident" id="3365730">err</span>&nbsp;<span class="op" id="3365734">:=</span>&nbsp;<span class="ident" id="3365737">r</span><span class="op" id="3365738">.</span><span class="ident" id="3365739">Read</span><span class="op" id="3365743">(</span><span class="ident" id="3365744">b</span><span class="op" id="3365745">.</span><span class="ident" id="3365746">data</span><span class="op" id="3365750">[</span><span class="builtinfunc" id="3365751">len</span><span class="op" id="3365754">(</span><span class="ident" id="3365755">b</span><span class="op" id="3365756">.</span><span class="ident" id="3365757">data</span><span class="op" id="3365761">)</span><span class="op" id="3365762">:</span><span class="builtinfunc" id="3365763">cap</span><span class="op" id="3365766">(</span><span class="ident" id="3365767">b</span><span class="op" id="3365768">.</span><span class="ident" id="3365769">data</span><span class="op" id="3365773">)</span><span class="op" id="3365774">]</span><span class="op" id="3365775">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3365779">b</span><span class="op" id="3365780">.</span><span class="ident" id="3365781">data</span>&nbsp;<span class="op" id="3365786">=</span>&nbsp;<span class="ident" id="3365788">b</span><span class="op" id="3365789">.</span><span class="ident" id="3365790">data</span><span class="op" id="3365794">[</span><span class="num" id="3365795">0</span>&nbsp;<span class="op" id="3365797">:</span>&nbsp;<span class="builtinfunc" id="3365799">len</span><span class="op" id="3365802">(</span><span class="ident" id="3365803">b</span><span class="op" id="3365804">.</span><span class="ident" id="3365805">data</span><span class="op" id="3365809">)</span><span class="op" id="3365810">+</span><span class="ident" id="3365811">m</span><span class="op" id="3365812">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3365816">if</span>&nbsp;<span class="builtinfunc" id="3365819">len</span><span class="op" id="3365822">(</span><span class="ident" id="3365823">b</span><span class="op" id="3365824">.</span><span class="ident" id="3365825">data</span><span class="op" id="3365829">)</span>&nbsp;<span class="op" id="3365831">&gt;=</span>&nbsp;<span class="ident" id="3365834">n</span>&nbsp;<span class="op" id="3365836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3365841">//&nbsp;TODO(bradfitz,agl):&nbsp;slightly&nbsp;suspicious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3365887">//&nbsp;that&nbsp;we&#39;re&nbsp;throwing&nbsp;away&nbsp;r.Read&#39;s&nbsp;err&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3365937">break</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3365945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3365949">if</span>&nbsp;<span class="ident" id="3365952">err</span>&nbsp;<span class="op" id="3365956">!=</span>&nbsp;<span class="ident" id="3365959">nil</span>&nbsp;<span class="op" id="3365963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3365968">return</span>&nbsp;<span class="ident" id="3365975">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3365981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3365984">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3365987">return</span>&nbsp;<span class="ident" id="3365994">nil</span><br>
<span class="lineno"></span><span class="op" id="3365998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3366001">func</span>&nbsp;<span class="op" id="3366006">(</span><span class="ident" id="3366007">b</span>&nbsp;<span class="op" id="3366009">*</span><span class="ident" id="3366010">block</span><span class="op" id="3366015">)</span>&nbsp;<span class="ident" id="3366017">Read</span><span class="op" id="3366021">(</span><span class="ident" id="3366022">p</span>&nbsp;<span class="op" id="3366024">[</span><span class="op" id="3366025">]</span><span class="builtintype" id="3366026">byte</span><span class="op" id="3366030">)</span>&nbsp;<span class="op" id="3366032">(</span><span class="ident" id="3366033">n</span>&nbsp;<span class="builtintype" id="3366035">int</span><span class="op" id="3366038">,</span>&nbsp;<span class="ident" id="3366040">err</span>&nbsp;<span class="builtintype" id="3366044">error</span><span class="op" id="3366049">)</span>&nbsp;<span class="op" id="3366051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3366054">n</span>&nbsp;<span class="op" id="3366056">=</span>&nbsp;<span class="builtinfunc" id="3366058">copy</span><span class="op" id="3366062">(</span><span class="ident" id="3366063">p</span><span class="op" id="3366064">,</span>&nbsp;<span class="ident" id="3366066">b</span><span class="op" id="3366067">.</span><span class="ident" id="3366068">data</span><span class="op" id="3366072">[</span><span class="ident" id="3366073">b</span><span class="op" id="3366074">.</span><span class="ident" id="3366075">off</span><span class="op" id="3366078">:</span><span class="op" id="3366079">]</span><span class="op" id="3366080">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3366083">b</span><span class="op" id="3366084">.</span><span class="ident" id="3366085">off</span>&nbsp;<span class="op" id="3366089">+=</span>&nbsp;<span class="ident" id="3366092">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3366095">return</span><br>
<span class="lineno"></span><span class="op" id="3366102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3366105">//&nbsp;newBlock&nbsp;allocates&nbsp;a&nbsp;new&nbsp;block,&nbsp;from&nbsp;hc&#39;s&nbsp;free&nbsp;list&nbsp;if&nbsp;possible.</span><br>
<span class="lineno">475</span><span class="keyword" id="3366173">func</span>&nbsp;<span class="op" id="3366178">(</span><span class="ident" id="3366179">hc</span>&nbsp;<span class="op" id="3366182">*</span><span class="ident" id="3366183">halfConn</span><span class="op" id="3366191">)</span>&nbsp;<span class="ident" id="3366193">newBlock</span><span class="op" id="3366201">(</span><span class="op" id="3366202">)</span>&nbsp;<span class="op" id="3366204">*</span><span class="ident" id="3366205">block</span>&nbsp;<span class="op" id="3366211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3366214">b</span>&nbsp;<span class="op" id="3366216">:=</span>&nbsp;<span class="ident" id="3366219">hc</span><span class="op" id="3366221">.</span><span class="ident" id="3366222">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3366229">if</span>&nbsp;<span class="ident" id="3366232">b</span>&nbsp;<span class="op" id="3366234">==</span>&nbsp;<span class="ident" id="3366237">nil</span>&nbsp;<span class="op" id="3366241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3366245">return</span>&nbsp;<span class="builtinfunc" id="3366252">new</span><span class="op" id="3366255">(</span><span class="ident" id="3366256">block</span><span class="op" id="3366261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3366264">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3366267">hc</span><span class="op" id="3366269">.</span><span class="ident" id="3366270">bfree</span>&nbsp;<span class="op" id="3366276">=</span>&nbsp;<span class="ident" id="3366278">b</span><span class="op" id="3366279">.</span><span class="ident" id="3366280">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3366286">b</span><span class="op" id="3366287">.</span><span class="ident" id="3366288">link</span>&nbsp;<span class="op" id="3366293">=</span>&nbsp;<span class="ident" id="3366295">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3366300">b</span><span class="op" id="3366301">.</span><span class="ident" id="3366302">resize</span><span class="op" id="3366308">(</span><span class="num" id="3366309">0</span><span class="op" id="3366310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3366313">return</span>&nbsp;<span class="ident" id="3366320">b</span><br>
<span class="lineno"></span><span class="op" id="3366322">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="3366325">//&nbsp;freeBlock&nbsp;returns&nbsp;a&nbsp;block&nbsp;to&nbsp;hc&#39;s&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="3366373">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;such&nbsp;that&nbsp;each&nbsp;side&nbsp;only&nbsp;has&nbsp;a&nbsp;block&nbsp;or&nbsp;two&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3366439">//&nbsp;its&nbsp;free&nbsp;list&nbsp;at&nbsp;a&nbsp;time,&nbsp;so&nbsp;there&#39;s&nbsp;no&nbsp;need&nbsp;to&nbsp;worry&nbsp;about</span><br>
<span class="lineno"></span><span class="comment" id="3366501">//&nbsp;trimming&nbsp;the&nbsp;list,&nbsp;etc.</span><br>
<span class="lineno">490</span><span class="keyword" id="3366528">func</span>&nbsp;<span class="op" id="3366533">(</span><span class="ident" id="3366534">hc</span>&nbsp;<span class="op" id="3366537">*</span><span class="ident" id="3366538">halfConn</span><span class="op" id="3366546">)</span>&nbsp;<span class="ident" id="3366548">freeBlock</span><span class="op" id="3366557">(</span><span class="ident" id="3366558">b</span>&nbsp;<span class="op" id="3366560">*</span><span class="ident" id="3366561">block</span><span class="op" id="3366566">)</span>&nbsp;<span class="op" id="3366568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3366571">b</span><span class="op" id="3366572">.</span><span class="ident" id="3366573">link</span>&nbsp;<span class="op" id="3366578">=</span>&nbsp;<span class="ident" id="3366580">hc</span><span class="op" id="3366582">.</span><span class="ident" id="3366583">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3366590">hc</span><span class="op" id="3366592">.</span><span class="ident" id="3366593">bfree</span>&nbsp;<span class="op" id="3366599">=</span>&nbsp;<span class="ident" id="3366601">b</span><br>
<span class="lineno"></span><span class="op" id="3366603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="3366606">//&nbsp;splitBlock&nbsp;splits&nbsp;a&nbsp;block&nbsp;after&nbsp;the&nbsp;first&nbsp;n&nbsp;bytes,</span><br>
<span class="lineno"></span><span class="comment" id="3366660">//&nbsp;returning&nbsp;a&nbsp;block&nbsp;with&nbsp;those&nbsp;n&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3366706">//&nbsp;block&nbsp;with&nbsp;the&nbsp;remainder.&nbsp;&nbsp;the&nbsp;latter&nbsp;may&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="3366759">func</span>&nbsp;<span class="op" id="3366764">(</span><span class="ident" id="3366765">hc</span>&nbsp;<span class="op" id="3366768">*</span><span class="ident" id="3366769">halfConn</span><span class="op" id="3366777">)</span>&nbsp;<span class="ident" id="3366779">splitBlock</span><span class="op" id="3366789">(</span><span class="ident" id="3366790">b</span>&nbsp;<span class="op" id="3366792">*</span><span class="ident" id="3366793">block</span><span class="op" id="3366798">,</span>&nbsp;<span class="ident" id="3366800">n</span>&nbsp;<span class="builtintype" id="3366802">int</span><span class="op" id="3366805">)</span>&nbsp;<span class="op" id="3366807">(</span><span class="op" id="3366808">*</span><span class="ident" id="3366809">block</span><span class="op" id="3366814">,</span>&nbsp;<span class="op" id="3366816">*</span><span class="ident" id="3366817">block</span><span class="op" id="3366822">)</span>&nbsp;<span class="op" id="3366824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3366827">if</span>&nbsp;<span class="builtinfunc" id="3366830">len</span><span class="op" id="3366833">(</span><span class="ident" id="3366834">b</span><span class="op" id="3366835">.</span><span class="ident" id="3366836">data</span><span class="op" id="3366840">)</span>&nbsp;<span class="op" id="3366842">&lt;=</span>&nbsp;<span class="ident" id="3366845">n</span>&nbsp;<span class="op" id="3366847">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3366851">return</span>&nbsp;<span class="ident" id="3366858">b</span><span class="op" id="3366859">,</span>&nbsp;<span class="ident" id="3366861">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3366866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3366869">bb</span>&nbsp;<span class="op" id="3366872">:=</span>&nbsp;<span class="ident" id="3366875">hc</span><span class="op" id="3366877">.</span><span class="ident" id="3366878">newBlock</span><span class="op" id="3366886">(</span><span class="op" id="3366887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3366890">bb</span><span class="op" id="3366892">.</span><span class="ident" id="3366893">resize</span><span class="op" id="3366899">(</span><span class="builtinfunc" id="3366900">len</span><span class="op" id="3366903">(</span><span class="ident" id="3366904">b</span><span class="op" id="3366905">.</span><span class="ident" id="3366906">data</span><span class="op" id="3366910">)</span>&nbsp;<span class="op" id="3366912">-</span>&nbsp;<span class="ident" id="3366914">n</span><span class="op" id="3366915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3366918">copy</span><span class="op" id="3366922">(</span><span class="ident" id="3366923">bb</span><span class="op" id="3366925">.</span><span class="ident" id="3366926">data</span><span class="op" id="3366930">,</span>&nbsp;<span class="ident" id="3366932">b</span><span class="op" id="3366933">.</span><span class="ident" id="3366934">data</span><span class="op" id="3366938">[</span><span class="ident" id="3366939">n</span><span class="op" id="3366940">:</span><span class="op" id="3366941">]</span><span class="op" id="3366942">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3366945">b</span><span class="op" id="3366946">.</span><span class="ident" id="3366947">data</span>&nbsp;<span class="op" id="3366952">=</span>&nbsp;<span class="ident" id="3366954">b</span><span class="op" id="3366955">.</span><span class="ident" id="3366956">data</span><span class="op" id="3366960">[</span><span class="num" id="3366961">0</span><span class="op" id="3366962">:</span><span class="ident" id="3366963">n</span><span class="op" id="3366964">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3366967">return</span>&nbsp;<span class="ident" id="3366974">b</span><span class="op" id="3366975">,</span>&nbsp;<span class="ident" id="3366977">bb</span><br>
<span class="lineno"></span><span class="op" id="3366980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3366983">//&nbsp;readRecord&nbsp;reads&nbsp;the&nbsp;next&nbsp;TLS&nbsp;record&nbsp;from&nbsp;the&nbsp;connection</span><br>
<span class="lineno">510</span><span class="comment" id="3367043">//&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3367082">//&nbsp;c.in.Mutex&nbsp;&lt;=&nbsp;L;&nbsp;c.input&nbsp;==&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="3367118">func</span>&nbsp;<span class="op" id="3367123">(</span><span class="ident" id="3367124">c</span>&nbsp;<span class="op" id="3367126">*</span><span class="ident" id="3367127">Conn</span><span class="op" id="3367131">)</span>&nbsp;<span class="ident" id="3367133">readRecord</span><span class="op" id="3367143">(</span><span class="ident" id="3367144">want</span>&nbsp;<span class="ident" id="3367149">recordType</span><span class="op" id="3367159">)</span>&nbsp;<span class="builtintype" id="3367161">error</span>&nbsp;<span class="op" id="3367167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3367170">//&nbsp;Caller&nbsp;must&nbsp;be&nbsp;in&nbsp;sync&nbsp;with&nbsp;connection:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3367214">//&nbsp;handshake&nbsp;data&nbsp;if&nbsp;handshake&nbsp;not&nbsp;yet&nbsp;completed,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3367265">//&nbsp;else&nbsp;application&nbsp;data.&nbsp;&nbsp;(We&nbsp;don&#39;t&nbsp;support&nbsp;renegotiation.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3367327">switch</span>&nbsp;<span class="ident" id="3367334">want</span>&nbsp;<span class="op" id="3367339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3367342">default</span><span class="op" id="3367349">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3367353">c</span><span class="op" id="3367354">.</span><span class="ident" id="3367355">sendAlert</span><span class="op" id="3367364">(</span><span class="ident" id="3367365">alertInternalError</span><span class="op" id="3367383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3367387">return</span>&nbsp;<span class="ident" id="3367394">c</span><span class="op" id="3367395">.</span><span class="ident" id="3367396">in</span><span class="op" id="3367398">.</span><span class="ident" id="3367399">setErrorLocked</span><span class="op" id="3367413">(</span><span class="ident" id="3367414">errors</span><span class="op" id="3367420">.</span><span class="ident" id="3367421">New</span><span class="op" id="3367424">(</span><span class="string" id="3367425">&#34;tls:&nbsp;unknown&nbsp;record&nbsp;type&nbsp;requested&#34;</span><span class="op" id="3367461">)</span><span class="op" id="3367462">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3367465">case</span>&nbsp;<span class="ident" id="3367470">recordTypeHandshake</span><span class="op" id="3367489">,</span>&nbsp;<span class="ident" id="3367491">recordTypeChangeCipherSpec</span><span class="op" id="3367517">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3367521">if</span>&nbsp;<span class="ident" id="3367524">c</span><span class="op" id="3367525">.</span><span class="ident" id="3367526">handshakeComplete</span>&nbsp;<span class="op" id="3367544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3367549">c</span><span class="op" id="3367550">.</span><span class="ident" id="3367551">sendAlert</span><span class="op" id="3367560">(</span><span class="ident" id="3367561">alertInternalError</span><span class="op" id="3367579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3367584">return</span>&nbsp;<span class="ident" id="3367591">c</span><span class="op" id="3367592">.</span><span class="ident" id="3367593">in</span><span class="op" id="3367595">.</span><span class="ident" id="3367596">setErrorLocked</span><span class="op" id="3367610">(</span><span class="ident" id="3367611">errors</span><span class="op" id="3367617">.</span><span class="ident" id="3367618">New</span><span class="op" id="3367621">(</span><span class="string" id="3367622">&#34;tls:&nbsp;handshake&nbsp;or&nbsp;ChangeCipherSpec&nbsp;requested&nbsp;after&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="3367693">)</span><span class="op" id="3367694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3367698">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3367701">case</span>&nbsp;<span class="ident" id="3367706">recordTypeApplicationData</span><span class="op" id="3367731">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3367735">if</span>&nbsp;<span class="op" id="3367738">!</span><span class="ident" id="3367739">c</span><span class="op" id="3367740">.</span><span class="ident" id="3367741">handshakeComplete</span>&nbsp;<span class="op" id="3367759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3367764">c</span><span class="op" id="3367765">.</span><span class="ident" id="3367766">sendAlert</span><span class="op" id="3367775">(</span><span class="ident" id="3367776">alertInternalError</span><span class="op" id="3367794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3367799">return</span>&nbsp;<span class="ident" id="3367806">c</span><span class="op" id="3367807">.</span><span class="ident" id="3367808">in</span><span class="op" id="3367810">.</span><span class="ident" id="3367811">setErrorLocked</span><span class="op" id="3367825">(</span><span class="ident" id="3367826">errors</span><span class="op" id="3367832">.</span><span class="ident" id="3367833">New</span><span class="op" id="3367836">(</span><span class="string" id="3367837">&#34;tls:&nbsp;application&nbsp;data&nbsp;record&nbsp;requested&nbsp;before&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="3367903">)</span><span class="op" id="3367904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3367908">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3367911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="3367914">Again</span><span class="op" id="3367919">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3367922">if</span>&nbsp;<span class="ident" id="3367925">c</span><span class="op" id="3367926">.</span><span class="ident" id="3367927">rawInput</span>&nbsp;<span class="op" id="3367936">==</span>&nbsp;<span class="ident" id="3367939">nil</span>&nbsp;<span class="op" id="3367943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3367947">c</span><span class="op" id="3367948">.</span><span class="ident" id="3367949">rawInput</span>&nbsp;<span class="op" id="3367958">=</span>&nbsp;<span class="ident" id="3367960">c</span><span class="op" id="3367961">.</span><span class="ident" id="3367962">in</span><span class="op" id="3367964">.</span><span class="ident" id="3367965">newBlock</span><span class="op" id="3367973">(</span><span class="op" id="3367974">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3367977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3367980">b</span>&nbsp;<span class="op" id="3367982">:=</span>&nbsp;<span class="ident" id="3367985">c</span><span class="op" id="3367986">.</span><span class="ident" id="3367987">rawInput</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3367998">//&nbsp;Read&nbsp;header,&nbsp;payload.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3368024">if</span>&nbsp;<span class="ident" id="3368027">err</span>&nbsp;<span class="op" id="3368031">:=</span>&nbsp;<span class="ident" id="3368034">b</span><span class="op" id="3368035">.</span><span class="ident" id="3368036">readFromUntil</span><span class="op" id="3368049">(</span><span class="ident" id="3368050">c</span><span class="op" id="3368051">.</span><span class="ident" id="3368052">conn</span><span class="op" id="3368056">,</span>&nbsp;<span class="ident" id="3368058">recordHeaderLen</span><span class="op" id="3368073">)</span><span class="op" id="3368074">;</span>&nbsp;<span class="ident" id="3368076">err</span>&nbsp;<span class="op" id="3368080">!=</span>&nbsp;<span class="ident" id="3368083">nil</span>&nbsp;<span class="op" id="3368087">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3368091">//&nbsp;RFC&nbsp;suggests&nbsp;that&nbsp;EOF&nbsp;without&nbsp;an&nbsp;alertCloseNotify&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3368149">//&nbsp;an&nbsp;error,&nbsp;but&nbsp;popular&nbsp;web&nbsp;sites&nbsp;seem&nbsp;to&nbsp;do&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3368203">//&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;make&nbsp;it&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3368238">//&nbsp;if&nbsp;err&nbsp;==&nbsp;io.EOF&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3368262">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;io.ErrUnexpectedEOF</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3368294">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3368301">if</span>&nbsp;<span class="ident" id="3368304">e</span><span class="op" id="3368305">,</span>&nbsp;<span class="ident" id="3368307">ok</span>&nbsp;<span class="op" id="3368310">:=</span>&nbsp;<span class="ident" id="3368313">err</span><span class="op" id="3368316">.</span><span class="op" id="3368317">(</span><span class="ident" id="3368318">net</span><span class="op" id="3368321">.</span><span class="ident" id="3368322">Error</span><span class="op" id="3368327">)</span><span class="op" id="3368328">;</span>&nbsp;<span class="op" id="3368330">!</span><span class="ident" id="3368331">ok</span>&nbsp;<span class="op" id="3368334">||</span>&nbsp;<span class="op" id="3368337">!</span><span class="ident" id="3368338">e</span><span class="op" id="3368339">.</span><span class="ident" id="3368340">Temporary</span><span class="op" id="3368349">(</span><span class="op" id="3368350">)</span>&nbsp;<span class="op" id="3368352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3368357">c</span><span class="op" id="3368358">.</span><span class="ident" id="3368359">in</span><span class="op" id="3368361">.</span><span class="ident" id="3368362">setErrorLocked</span><span class="op" id="3368376">(</span><span class="ident" id="3368377">err</span><span class="op" id="3368380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3368384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3368388">return</span>&nbsp;<span class="ident" id="3368395">err</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3368400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3368403">typ</span>&nbsp;<span class="op" id="3368407">:=</span>&nbsp;<span class="ident" id="3368410">recordType</span><span class="op" id="3368420">(</span><span class="ident" id="3368421">b</span><span class="op" id="3368422">.</span><span class="ident" id="3368423">data</span><span class="op" id="3368427">[</span><span class="num" id="3368428">0</span><span class="op" id="3368429">]</span><span class="op" id="3368430">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3368434">//&nbsp;No&nbsp;valid&nbsp;TLS&nbsp;record&nbsp;has&nbsp;a&nbsp;type&nbsp;of&nbsp;0x80,&nbsp;however&nbsp;SSLv2&nbsp;handshakes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3368503">//&nbsp;start&nbsp;with&nbsp;a&nbsp;uint16&nbsp;length&nbsp;where&nbsp;the&nbsp;MSB&nbsp;is&nbsp;set&nbsp;and&nbsp;the&nbsp;first&nbsp;record</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3368576">//&nbsp;is&nbsp;always&nbsp;&lt;&nbsp;256&nbsp;bytes&nbsp;long.&nbsp;Therefore&nbsp;typ&nbsp;==&nbsp;0x80&nbsp;strongly&nbsp;suggests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3368648">//&nbsp;an&nbsp;SSLv2&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3368669">if</span>&nbsp;<span class="ident" id="3368672">want</span>&nbsp;<span class="op" id="3368677">==</span>&nbsp;<span class="ident" id="3368680">recordTypeHandshake</span>&nbsp;<span class="op" id="3368700">&amp;&amp;</span>&nbsp;<span class="ident" id="3368703">typ</span>&nbsp;<span class="op" id="3368707">==</span>&nbsp;<span class="num" id="3368710">0x80</span>&nbsp;<span class="op" id="3368715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3368719">c</span><span class="op" id="3368720">.</span><span class="ident" id="3368721">sendAlert</span><span class="op" id="3368730">(</span><span class="ident" id="3368731">alertProtocolVersion</span><span class="op" id="3368751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3368755">return</span>&nbsp;<span class="ident" id="3368762">c</span><span class="op" id="3368763">.</span><span class="ident" id="3368764">in</span><span class="op" id="3368766">.</span><span class="ident" id="3368767">setErrorLocked</span><span class="op" id="3368781">(</span><span class="ident" id="3368782">errors</span><span class="op" id="3368788">.</span><span class="ident" id="3368789">New</span><span class="op" id="3368792">(</span><span class="string" id="3368793">&#34;tls:&nbsp;unsupported&nbsp;SSLv2&nbsp;handshake&nbsp;received&#34;</span><span class="op" id="3368836">)</span><span class="op" id="3368837">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3368840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3368844">vers</span>&nbsp;<span class="op" id="3368849">:=</span>&nbsp;<span class="builtintype" id="3368852">uint16</span><span class="op" id="3368858">(</span><span class="ident" id="3368859">b</span><span class="op" id="3368860">.</span><span class="ident" id="3368861">data</span><span class="op" id="3368865">[</span><span class="num" id="3368866">1</span><span class="op" id="3368867">]</span><span class="op" id="3368868">)</span><span class="op" id="3368869">&lt;&lt;</span><span class="num" id="3368871">8</span>&nbsp;<span class="op" id="3368873">|</span>&nbsp;<span class="builtintype" id="3368875">uint16</span><span class="op" id="3368881">(</span><span class="ident" id="3368882">b</span><span class="op" id="3368883">.</span><span class="ident" id="3368884">data</span><span class="op" id="3368888">[</span><span class="num" id="3368889">2</span><span class="op" id="3368890">]</span><span class="op" id="3368891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3368894">n</span>&nbsp;<span class="op" id="3368896">:=</span>&nbsp;<span class="builtintype" id="3368899">int</span><span class="op" id="3368902">(</span><span class="ident" id="3368903">b</span><span class="op" id="3368904">.</span><span class="ident" id="3368905">data</span><span class="op" id="3368909">[</span><span class="num" id="3368910">3</span><span class="op" id="3368911">]</span><span class="op" id="3368912">)</span><span class="op" id="3368913">&lt;&lt;</span><span class="num" id="3368915">8</span>&nbsp;<span class="op" id="3368917">|</span>&nbsp;<span class="builtintype" id="3368919">int</span><span class="op" id="3368922">(</span><span class="ident" id="3368923">b</span><span class="op" id="3368924">.</span><span class="ident" id="3368925">data</span><span class="op" id="3368929">[</span><span class="num" id="3368930">4</span><span class="op" id="3368931">]</span><span class="op" id="3368932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3368935">if</span>&nbsp;<span class="ident" id="3368938">c</span><span class="op" id="3368939">.</span><span class="ident" id="3368940">haveVers</span>&nbsp;<span class="op" id="3368949">&amp;&amp;</span>&nbsp;<span class="ident" id="3368952">vers</span>&nbsp;<span class="op" id="3368957">!=</span>&nbsp;<span class="ident" id="3368960">c</span><span class="op" id="3368961">.</span><span class="ident" id="3368962">vers</span>&nbsp;<span class="op" id="3368967">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3368971">c</span><span class="op" id="3368972">.</span><span class="ident" id="3368973">sendAlert</span><span class="op" id="3368982">(</span><span class="ident" id="3368983">alertProtocolVersion</span><span class="op" id="3369003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3369007">return</span>&nbsp;<span class="ident" id="3369014">c</span><span class="op" id="3369015">.</span><span class="ident" id="3369016">in</span><span class="op" id="3369018">.</span><span class="ident" id="3369019">setErrorLocked</span><span class="op" id="3369033">(</span><span class="ident" id="3369034">fmt</span><span class="op" id="3369037">.</span><span class="ident" id="3369038">Errorf</span><span class="op" id="3369044">(</span><span class="string" id="3369045">&#34;tls:&nbsp;received&nbsp;record&nbsp;with&nbsp;version&nbsp;%x&nbsp;when&nbsp;expecting&nbsp;version&nbsp;%x&#34;</span><span class="op" id="3369109">,</span>&nbsp;<span class="ident" id="3369111">vers</span><span class="op" id="3369115">,</span>&nbsp;<span class="ident" id="3369117">c</span><span class="op" id="3369118">.</span><span class="ident" id="3369119">vers</span><span class="op" id="3369123">)</span><span class="op" id="3369124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3369127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3369130">if</span>&nbsp;<span class="ident" id="3369133">n</span>&nbsp;<span class="op" id="3369135">&gt;</span>&nbsp;<span class="ident" id="3369137">maxCiphertext</span>&nbsp;<span class="op" id="3369151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3369155">c</span><span class="op" id="3369156">.</span><span class="ident" id="3369157">sendAlert</span><span class="op" id="3369166">(</span><span class="ident" id="3369167">alertRecordOverflow</span><span class="op" id="3369186">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3369190">return</span>&nbsp;<span class="ident" id="3369197">c</span><span class="op" id="3369198">.</span><span class="ident" id="3369199">in</span><span class="op" id="3369201">.</span><span class="ident" id="3369202">setErrorLocked</span><span class="op" id="3369216">(</span><span class="ident" id="3369217">fmt</span><span class="op" id="3369220">.</span><span class="ident" id="3369221">Errorf</span><span class="op" id="3369227">(</span><span class="string" id="3369228">&#34;tls:&nbsp;oversized&nbsp;record&nbsp;received&nbsp;with&nbsp;length&nbsp;%d&#34;</span><span class="op" id="3369275">,</span>&nbsp;<span class="ident" id="3369277">n</span><span class="op" id="3369278">)</span><span class="op" id="3369279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3369282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3369285">if</span>&nbsp;<span class="op" id="3369288">!</span><span class="ident" id="3369289">c</span><span class="op" id="3369290">.</span><span class="ident" id="3369291">haveVers</span>&nbsp;<span class="op" id="3369300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3369304">//&nbsp;First&nbsp;message,&nbsp;be&nbsp;extra&nbsp;suspicious:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3369345">//&nbsp;this&nbsp;might&nbsp;not&nbsp;be&nbsp;a&nbsp;TLS&nbsp;client.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3369382">//&nbsp;Bail&nbsp;out&nbsp;before&nbsp;reading&nbsp;a&nbsp;full&nbsp;&#39;body&#39;,&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3369439">//&nbsp;The&nbsp;current&nbsp;max&nbsp;version&nbsp;is&nbsp;3.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3369476">//&nbsp;If&nbsp;the&nbsp;version&nbsp;is&nbsp;&gt;=&nbsp;16.0,&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3369532">//&nbsp;Similarly,&nbsp;a&nbsp;clientHello&nbsp;message&nbsp;encodes&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3369581">//&nbsp;well&nbsp;under&nbsp;a&nbsp;kilobyte.&nbsp;&nbsp;If&nbsp;the&nbsp;length&nbsp;is&nbsp;&gt;=&nbsp;12&nbsp;kB,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3369637">//&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3369666">if</span>&nbsp;<span class="op" id="3369669">(</span><span class="ident" id="3369670">typ</span>&nbsp;<span class="op" id="3369674">!=</span>&nbsp;<span class="ident" id="3369677">recordTypeAlert</span>&nbsp;<span class="op" id="3369693">&amp;&amp;</span>&nbsp;<span class="ident" id="3369696">typ</span>&nbsp;<span class="op" id="3369700">!=</span>&nbsp;<span class="ident" id="3369703">want</span><span class="op" id="3369707">)</span>&nbsp;<span class="op" id="3369709">||</span>&nbsp;<span class="ident" id="3369712">vers</span>&nbsp;<span class="op" id="3369717">&gt;=</span>&nbsp;<span class="num" id="3369720">0x1000</span>&nbsp;<span class="op" id="3369727">||</span>&nbsp;<span class="ident" id="3369730">n</span>&nbsp;<span class="op" id="3369732">&gt;=</span>&nbsp;<span class="num" id="3369735">0x3000</span>&nbsp;<span class="op" id="3369742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3369747">c</span><span class="op" id="3369748">.</span><span class="ident" id="3369749">sendAlert</span><span class="op" id="3369758">(</span><span class="ident" id="3369759">alertUnexpectedMessage</span><span class="op" id="3369781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3369786">return</span>&nbsp;<span class="ident" id="3369793">c</span><span class="op" id="3369794">.</span><span class="ident" id="3369795">in</span><span class="op" id="3369797">.</span><span class="ident" id="3369798">setErrorLocked</span><span class="op" id="3369812">(</span><span class="ident" id="3369813">fmt</span><span class="op" id="3369816">.</span><span class="ident" id="3369817">Errorf</span><span class="op" id="3369823">(</span><span class="string" id="3369824">&#34;tls:&nbsp;first&nbsp;record&nbsp;does&nbsp;not&nbsp;look&nbsp;like&nbsp;a&nbsp;TLS&nbsp;handshake&#34;</span><span class="op" id="3369878">)</span><span class="op" id="3369879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3369883">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3369886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3369889">if</span>&nbsp;<span class="ident" id="3369892">err</span>&nbsp;<span class="op" id="3369896">:=</span>&nbsp;<span class="ident" id="3369899">b</span><span class="op" id="3369900">.</span><span class="ident" id="3369901">readFromUntil</span><span class="op" id="3369914">(</span><span class="ident" id="3369915">c</span><span class="op" id="3369916">.</span><span class="ident" id="3369917">conn</span><span class="op" id="3369921">,</span>&nbsp;<span class="ident" id="3369923">recordHeaderLen</span><span class="op" id="3369938">+</span><span class="ident" id="3369939">n</span><span class="op" id="3369940">)</span><span class="op" id="3369941">;</span>&nbsp;<span class="ident" id="3369943">err</span>&nbsp;<span class="op" id="3369947">!=</span>&nbsp;<span class="ident" id="3369950">nil</span>&nbsp;<span class="op" id="3369954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3369958">if</span>&nbsp;<span class="ident" id="3369961">err</span>&nbsp;<span class="op" id="3369965">==</span>&nbsp;<span class="ident" id="3369968">io</span><span class="op" id="3369970">.</span><span class="ident" id="3369971">EOF</span>&nbsp;<span class="op" id="3369975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3369980">err</span>&nbsp;<span class="op" id="3369984">=</span>&nbsp;<span class="ident" id="3369986">io</span><span class="op" id="3369988">.</span><span class="ident" id="3369989">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3370008">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370012">if</span>&nbsp;<span class="ident" id="3370015">e</span><span class="op" id="3370016">,</span>&nbsp;<span class="ident" id="3370018">ok</span>&nbsp;<span class="op" id="3370021">:=</span>&nbsp;<span class="ident" id="3370024">err</span><span class="op" id="3370027">.</span><span class="op" id="3370028">(</span><span class="ident" id="3370029">net</span><span class="op" id="3370032">.</span><span class="ident" id="3370033">Error</span><span class="op" id="3370038">)</span><span class="op" id="3370039">;</span>&nbsp;<span class="op" id="3370041">!</span><span class="ident" id="3370042">ok</span>&nbsp;<span class="op" id="3370045">||</span>&nbsp;<span class="op" id="3370048">!</span><span class="ident" id="3370049">e</span><span class="op" id="3370050">.</span><span class="ident" id="3370051">Temporary</span><span class="op" id="3370060">(</span><span class="op" id="3370061">)</span>&nbsp;<span class="op" id="3370063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3370068">c</span><span class="op" id="3370069">.</span><span class="ident" id="3370070">in</span><span class="op" id="3370072">.</span><span class="ident" id="3370073">setErrorLocked</span><span class="op" id="3370087">(</span><span class="ident" id="3370088">err</span><span class="op" id="3370091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3370095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370099">return</span>&nbsp;<span class="ident" id="3370106">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3370111">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3370115">//&nbsp;Process&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3370136">b</span><span class="op" id="3370137">,</span>&nbsp;<span class="ident" id="3370139">c</span><span class="op" id="3370140">.</span><span class="ident" id="3370141">rawInput</span>&nbsp;<span class="op" id="3370150">=</span>&nbsp;<span class="ident" id="3370152">c</span><span class="op" id="3370153">.</span><span class="ident" id="3370154">in</span><span class="op" id="3370156">.</span><span class="ident" id="3370157">splitBlock</span><span class="op" id="3370167">(</span><span class="ident" id="3370168">b</span><span class="op" id="3370169">,</span>&nbsp;<span class="ident" id="3370171">recordHeaderLen</span><span class="op" id="3370186">+</span><span class="ident" id="3370187">n</span><span class="op" id="3370188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3370191">ok</span><span class="op" id="3370193">,</span>&nbsp;<span class="ident" id="3370195">off</span><span class="op" id="3370198">,</span>&nbsp;<span class="ident" id="3370200">err</span>&nbsp;<span class="op" id="3370204">:=</span>&nbsp;<span class="ident" id="3370207">c</span><span class="op" id="3370208">.</span><span class="ident" id="3370209">in</span><span class="op" id="3370211">.</span><span class="ident" id="3370212">decrypt</span><span class="op" id="3370219">(</span><span class="ident" id="3370220">b</span><span class="op" id="3370221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370224">if</span>&nbsp;<span class="op" id="3370227">!</span><span class="ident" id="3370228">ok</span>&nbsp;<span class="op" id="3370231">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3370235">c</span><span class="op" id="3370236">.</span><span class="ident" id="3370237">in</span><span class="op" id="3370239">.</span><span class="ident" id="3370240">setErrorLocked</span><span class="op" id="3370254">(</span><span class="ident" id="3370255">c</span><span class="op" id="3370256">.</span><span class="ident" id="3370257">sendAlert</span><span class="op" id="3370266">(</span><span class="ident" id="3370267">err</span><span class="op" id="3370270">)</span><span class="op" id="3370271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3370274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3370277">b</span><span class="op" id="3370278">.</span><span class="ident" id="3370279">off</span>&nbsp;<span class="op" id="3370283">=</span>&nbsp;<span class="ident" id="3370285">off</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3370290">data</span>&nbsp;<span class="op" id="3370295">:=</span>&nbsp;<span class="ident" id="3370298">b</span><span class="op" id="3370299">.</span><span class="ident" id="3370300">data</span><span class="op" id="3370304">[</span><span class="ident" id="3370305">b</span><span class="op" id="3370306">.</span><span class="ident" id="3370307">off</span><span class="op" id="3370310">:</span><span class="op" id="3370311">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370314">if</span>&nbsp;<span class="builtinfunc" id="3370317">len</span><span class="op" id="3370320">(</span><span class="ident" id="3370321">data</span><span class="op" id="3370325">)</span>&nbsp;<span class="op" id="3370327">&gt;</span>&nbsp;<span class="ident" id="3370329">maxPlaintext</span>&nbsp;<span class="op" id="3370342">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3370346">err</span>&nbsp;<span class="op" id="3370350">:=</span>&nbsp;<span class="ident" id="3370353">c</span><span class="op" id="3370354">.</span><span class="ident" id="3370355">sendAlert</span><span class="op" id="3370364">(</span><span class="ident" id="3370365">alertRecordOverflow</span><span class="op" id="3370384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3370388">c</span><span class="op" id="3370389">.</span><span class="ident" id="3370390">in</span><span class="op" id="3370392">.</span><span class="ident" id="3370393">freeBlock</span><span class="op" id="3370402">(</span><span class="ident" id="3370403">b</span><span class="op" id="3370404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370408">return</span>&nbsp;<span class="ident" id="3370415">c</span><span class="op" id="3370416">.</span><span class="ident" id="3370417">in</span><span class="op" id="3370419">.</span><span class="ident" id="3370420">setErrorLocked</span><span class="op" id="3370434">(</span><span class="ident" id="3370435">err</span><span class="op" id="3370438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3370441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370445">switch</span>&nbsp;<span class="ident" id="3370452">typ</span>&nbsp;<span class="op" id="3370456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370459">default</span><span class="op" id="3370466">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3370470">c</span><span class="op" id="3370471">.</span><span class="ident" id="3370472">in</span><span class="op" id="3370474">.</span><span class="ident" id="3370475">setErrorLocked</span><span class="op" id="3370489">(</span><span class="ident" id="3370490">c</span><span class="op" id="3370491">.</span><span class="ident" id="3370492">sendAlert</span><span class="op" id="3370501">(</span><span class="ident" id="3370502">alertUnexpectedMessage</span><span class="op" id="3370524">)</span><span class="op" id="3370525">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370529">case</span>&nbsp;<span class="ident" id="3370534">recordTypeAlert</span><span class="op" id="3370549">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370553">if</span>&nbsp;<span class="builtinfunc" id="3370556">len</span><span class="op" id="3370559">(</span><span class="ident" id="3370560">data</span><span class="op" id="3370564">)</span>&nbsp;<span class="op" id="3370566">!=</span>&nbsp;<span class="num" id="3370569">2</span>&nbsp;<span class="op" id="3370571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3370576">c</span><span class="op" id="3370577">.</span><span class="ident" id="3370578">in</span><span class="op" id="3370580">.</span><span class="ident" id="3370581">setErrorLocked</span><span class="op" id="3370595">(</span><span class="ident" id="3370596">c</span><span class="op" id="3370597">.</span><span class="ident" id="3370598">sendAlert</span><span class="op" id="3370607">(</span><span class="ident" id="3370608">alertUnexpectedMessage</span><span class="op" id="3370630">)</span><span class="op" id="3370631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370636">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3370644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370648">if</span>&nbsp;<span class="ident" id="3370651">alert</span><span class="op" id="3370656">(</span><span class="ident" id="3370657">data</span><span class="op" id="3370661">[</span><span class="num" id="3370662">1</span><span class="op" id="3370663">]</span><span class="op" id="3370664">)</span>&nbsp;<span class="op" id="3370666">==</span>&nbsp;<span class="ident" id="3370669">alertCloseNotify</span>&nbsp;<span class="op" id="3370686">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3370691">c</span><span class="op" id="3370692">.</span><span class="ident" id="3370693">in</span><span class="op" id="3370695">.</span><span class="ident" id="3370696">setErrorLocked</span><span class="op" id="3370710">(</span><span class="ident" id="3370711">io</span><span class="op" id="3370713">.</span><span class="ident" id="3370714">EOF</span><span class="op" id="3370717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370722">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3370730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370734">switch</span>&nbsp;<span class="ident" id="3370741">data</span><span class="op" id="3370745">[</span><span class="num" id="3370746">0</span><span class="op" id="3370747">]</span>&nbsp;<span class="op" id="3370749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370753">case</span>&nbsp;<span class="ident" id="3370758">alertLevelWarning</span><span class="op" id="3370775">:</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3370780">//&nbsp;drop&nbsp;on&nbsp;the&nbsp;floor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3370804">c</span><span class="op" id="3370805">.</span><span class="ident" id="3370806">in</span><span class="op" id="3370808">.</span><span class="ident" id="3370809">freeBlock</span><span class="op" id="3370818">(</span><span class="ident" id="3370819">b</span><span class="op" id="3370820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370825">goto</span>&nbsp;<span class="ident" id="3370830">Again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370838">case</span>&nbsp;<span class="ident" id="3370843">alertLevelError</span><span class="op" id="3370858">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3370863">c</span><span class="op" id="3370864">.</span><span class="ident" id="3370865">in</span><span class="op" id="3370867">.</span><span class="ident" id="3370868">setErrorLocked</span><span class="op" id="3370882">(</span><span class="op" id="3370883">&amp;</span><span class="ident" id="3370884">net</span><span class="op" id="3370887">.</span><span class="ident" id="3370888">OpError</span><span class="op" id="3370895">{</span><span class="ident" id="3370896">Op</span><span class="op" id="3370898">:</span>&nbsp;<span class="string" id="3370900">&#34;remote&nbsp;error&#34;</span><span class="op" id="3370914">,</span>&nbsp;<span class="ident" id="3370916">Err</span><span class="op" id="3370919">:</span>&nbsp;<span class="ident" id="3370921">alert</span><span class="op" id="3370926">(</span><span class="ident" id="3370927">data</span><span class="op" id="3370931">[</span><span class="num" id="3370932">1</span><span class="op" id="3370933">]</span><span class="op" id="3370934">)</span><span class="op" id="3370935">}</span><span class="op" id="3370936">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3370940">default</span><span class="op" id="3370947">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3370952">c</span><span class="op" id="3370953">.</span><span class="ident" id="3370954">in</span><span class="op" id="3370956">.</span><span class="ident" id="3370957">setErrorLocked</span><span class="op" id="3370971">(</span><span class="ident" id="3370972">c</span><span class="op" id="3370973">.</span><span class="ident" id="3370974">sendAlert</span><span class="op" id="3370983">(</span><span class="ident" id="3370984">alertUnexpectedMessage</span><span class="op" id="3371006">)</span><span class="op" id="3371007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3371011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3371015">case</span>&nbsp;<span class="ident" id="3371020">recordTypeChangeCipherSpec</span><span class="op" id="3371046">:</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3371050">if</span>&nbsp;<span class="ident" id="3371053">typ</span>&nbsp;<span class="op" id="3371057">!=</span>&nbsp;<span class="ident" id="3371060">want</span>&nbsp;<span class="op" id="3371065">||</span>&nbsp;<span class="builtinfunc" id="3371068">len</span><span class="op" id="3371071">(</span><span class="ident" id="3371072">data</span><span class="op" id="3371076">)</span>&nbsp;<span class="op" id="3371078">!=</span>&nbsp;<span class="num" id="3371081">1</span>&nbsp;<span class="op" id="3371083">||</span>&nbsp;<span class="ident" id="3371086">data</span><span class="op" id="3371090">[</span><span class="num" id="3371091">0</span><span class="op" id="3371092">]</span>&nbsp;<span class="op" id="3371094">!=</span>&nbsp;<span class="num" id="3371097">1</span>&nbsp;<span class="op" id="3371099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3371104">c</span><span class="op" id="3371105">.</span><span class="ident" id="3371106">in</span><span class="op" id="3371108">.</span><span class="ident" id="3371109">setErrorLocked</span><span class="op" id="3371123">(</span><span class="ident" id="3371124">c</span><span class="op" id="3371125">.</span><span class="ident" id="3371126">sendAlert</span><span class="op" id="3371135">(</span><span class="ident" id="3371136">alertUnexpectedMessage</span><span class="op" id="3371158">)</span><span class="op" id="3371159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3371164">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3371172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3371176">err</span>&nbsp;<span class="op" id="3371180">:=</span>&nbsp;<span class="ident" id="3371183">c</span><span class="op" id="3371184">.</span><span class="ident" id="3371185">in</span><span class="op" id="3371187">.</span><span class="ident" id="3371188">changeCipherSpec</span><span class="op" id="3371204">(</span><span class="op" id="3371205">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3371209">if</span>&nbsp;<span class="ident" id="3371212">err</span>&nbsp;<span class="op" id="3371216">!=</span>&nbsp;<span class="ident" id="3371219">nil</span>&nbsp;<span class="op" id="3371223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3371228">c</span><span class="op" id="3371229">.</span><span class="ident" id="3371230">in</span><span class="op" id="3371232">.</span><span class="ident" id="3371233">setErrorLocked</span><span class="op" id="3371247">(</span><span class="ident" id="3371248">c</span><span class="op" id="3371249">.</span><span class="ident" id="3371250">sendAlert</span><span class="op" id="3371259">(</span><span class="ident" id="3371260">err</span><span class="op" id="3371263">.</span><span class="op" id="3371264">(</span><span class="ident" id="3371265">alert</span><span class="op" id="3371270">)</span><span class="op" id="3371271">)</span><span class="op" id="3371272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3371276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3371280">case</span>&nbsp;<span class="ident" id="3371285">recordTypeApplicationData</span><span class="op" id="3371310">:</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3371314">if</span>&nbsp;<span class="ident" id="3371317">typ</span>&nbsp;<span class="op" id="3371321">!=</span>&nbsp;<span class="ident" id="3371324">want</span>&nbsp;<span class="op" id="3371329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3371334">c</span><span class="op" id="3371335">.</span><span class="ident" id="3371336">in</span><span class="op" id="3371338">.</span><span class="ident" id="3371339">setErrorLocked</span><span class="op" id="3371353">(</span><span class="ident" id="3371354">c</span><span class="op" id="3371355">.</span><span class="ident" id="3371356">sendAlert</span><span class="op" id="3371365">(</span><span class="ident" id="3371366">alertUnexpectedMessage</span><span class="op" id="3371388">)</span><span class="op" id="3371389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3371394">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3371402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3371406">c</span><span class="op" id="3371407">.</span><span class="ident" id="3371408">input</span>&nbsp;<span class="op" id="3371414">=</span>&nbsp;<span class="ident" id="3371416">b</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3371420">b</span>&nbsp;<span class="op" id="3371422">=</span>&nbsp;<span class="ident" id="3371424">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3371430">case</span>&nbsp;<span class="ident" id="3371435">recordTypeHandshake</span><span class="op" id="3371454">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3371458">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;at&nbsp;least&nbsp;pick&nbsp;off&nbsp;connection&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3371517">if</span>&nbsp;<span class="ident" id="3371520">typ</span>&nbsp;<span class="op" id="3371524">!=</span>&nbsp;<span class="ident" id="3371527">want</span>&nbsp;<span class="op" id="3371532">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3371537">return</span>&nbsp;<span class="ident" id="3371544">c</span><span class="op" id="3371545">.</span><span class="ident" id="3371546">in</span><span class="op" id="3371548">.</span><span class="ident" id="3371549">setErrorLocked</span><span class="op" id="3371563">(</span><span class="ident" id="3371564">c</span><span class="op" id="3371565">.</span><span class="ident" id="3371566">sendAlert</span><span class="op" id="3371575">(</span><span class="ident" id="3371576">alertNoRenegotiation</span><span class="op" id="3371596">)</span><span class="op" id="3371597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3371601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3371605">c</span><span class="op" id="3371606">.</span><span class="ident" id="3371607">hand</span><span class="op" id="3371611">.</span><span class="ident" id="3371612">Write</span><span class="op" id="3371617">(</span><span class="ident" id="3371618">data</span><span class="op" id="3371622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3371625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3371629">if</span>&nbsp;<span class="ident" id="3371632">b</span>&nbsp;<span class="op" id="3371634">!=</span>&nbsp;<span class="ident" id="3371637">nil</span>&nbsp;<span class="op" id="3371641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3371645">c</span><span class="op" id="3371646">.</span><span class="ident" id="3371647">in</span><span class="op" id="3371649">.</span><span class="ident" id="3371650">freeBlock</span><span class="op" id="3371659">(</span><span class="ident" id="3371660">b</span><span class="op" id="3371661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3371664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3371667">return</span>&nbsp;<span class="ident" id="3371674">c</span><span class="op" id="3371675">.</span><span class="ident" id="3371676">in</span><span class="op" id="3371678">.</span><span class="ident" id="3371679">err</span><br>
<span class="lineno"></span><span class="op" id="3371683">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="3371686">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno"></span><span class="comment" id="3371726">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="3371747">func</span>&nbsp;<span class="op" id="3371752">(</span><span class="ident" id="3371753">c</span>&nbsp;<span class="op" id="3371755">*</span><span class="ident" id="3371756">Conn</span><span class="op" id="3371760">)</span>&nbsp;<span class="ident" id="3371762">sendAlertLocked</span><span class="op" id="3371777">(</span><span class="ident" id="3371778">err</span>&nbsp;<span class="ident" id="3371782">alert</span><span class="op" id="3371787">)</span>&nbsp;<span class="builtintype" id="3371789">error</span>&nbsp;<span class="op" id="3371795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3371798">switch</span>&nbsp;<span class="ident" id="3371805">err</span>&nbsp;<span class="op" id="3371809">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3371812">case</span>&nbsp;<span class="ident" id="3371817">alertNoRenegotiation</span><span class="op" id="3371837">,</span>&nbsp;<span class="ident" id="3371839">alertCloseNotify</span><span class="op" id="3371855">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3371859">c</span><span class="op" id="3371860">.</span><span class="ident" id="3371861">tmp</span><span class="op" id="3371864">[</span><span class="num" id="3371865">0</span><span class="op" id="3371866">]</span>&nbsp;<span class="op" id="3371868">=</span>&nbsp;<span class="ident" id="3371870">alertLevelWarning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3371889">default</span><span class="op" id="3371896">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3371900">c</span><span class="op" id="3371901">.</span><span class="ident" id="3371902">tmp</span><span class="op" id="3371905">[</span><span class="num" id="3371906">0</span><span class="op" id="3371907">]</span>&nbsp;<span class="op" id="3371909">=</span>&nbsp;<span class="ident" id="3371911">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3371928">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3371931">c</span><span class="op" id="3371932">.</span><span class="ident" id="3371933">tmp</span><span class="op" id="3371936">[</span><span class="num" id="3371937">1</span><span class="op" id="3371938">]</span>&nbsp;<span class="op" id="3371940">=</span>&nbsp;<span class="builtintype" id="3371942">byte</span><span class="op" id="3371946">(</span><span class="ident" id="3371947">err</span><span class="op" id="3371950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3371953">c</span><span class="op" id="3371954">.</span><span class="ident" id="3371955">writeRecord</span><span class="op" id="3371966">(</span><span class="ident" id="3371967">recordTypeAlert</span><span class="op" id="3371982">,</span>&nbsp;<span class="ident" id="3371984">c</span><span class="op" id="3371985">.</span><span class="ident" id="3371986">tmp</span><span class="op" id="3371989">[</span><span class="num" id="3371990">0</span><span class="op" id="3371991">:</span><span class="num" id="3371992">2</span><span class="op" id="3371993">]</span><span class="op" id="3371994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3371997">//&nbsp;closeNotify&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;in&nbsp;that&nbsp;it&nbsp;isn&#39;t&nbsp;an&nbsp;error:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3372058">if</span>&nbsp;<span class="ident" id="3372061">err</span>&nbsp;<span class="op" id="3372065">!=</span>&nbsp;<span class="ident" id="3372068">alertCloseNotify</span>&nbsp;<span class="op" id="3372085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3372089">return</span>&nbsp;<span class="ident" id="3372096">c</span><span class="op" id="3372097">.</span><span class="ident" id="3372098">out</span><span class="op" id="3372101">.</span><span class="ident" id="3372102">setErrorLocked</span><span class="op" id="3372116">(</span><span class="op" id="3372117">&amp;</span><span class="ident" id="3372118">net</span><span class="op" id="3372121">.</span><span class="ident" id="3372122">OpError</span><span class="op" id="3372129">{</span><span class="ident" id="3372130">Op</span><span class="op" id="3372132">:</span>&nbsp;<span class="string" id="3372134">&#34;local&nbsp;error&#34;</span><span class="op" id="3372147">,</span>&nbsp;<span class="ident" id="3372149">Err</span><span class="op" id="3372152">:</span>&nbsp;<span class="ident" id="3372154">err</span><span class="op" id="3372157">}</span><span class="op" id="3372158">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3372161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3372164">return</span>&nbsp;<span class="ident" id="3372171">nil</span><br>
<span class="lineno"></span><span class="op" id="3372175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3372178">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno">685</span><span class="comment" id="3372218">//&nbsp;L&nbsp;&lt;&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="3372238">func</span>&nbsp;<span class="op" id="3372243">(</span><span class="ident" id="3372244">c</span>&nbsp;<span class="op" id="3372246">*</span><span class="ident" id="3372247">Conn</span><span class="op" id="3372251">)</span>&nbsp;<span class="ident" id="3372253">sendAlert</span><span class="op" id="3372262">(</span><span class="ident" id="3372263">err</span>&nbsp;<span class="ident" id="3372267">alert</span><span class="op" id="3372272">)</span>&nbsp;<span class="builtintype" id="3372274">error</span>&nbsp;<span class="op" id="3372280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3372283">c</span><span class="op" id="3372284">.</span><span class="ident" id="3372285">out</span><span class="op" id="3372288">.</span><span class="ident" id="3372289">Lock</span><span class="op" id="3372293">(</span><span class="op" id="3372294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3372297">defer</span>&nbsp;<span class="ident" id="3372303">c</span><span class="op" id="3372304">.</span><span class="ident" id="3372305">out</span><span class="op" id="3372308">.</span><span class="ident" id="3372309">Unlock</span><span class="op" id="3372315">(</span><span class="op" id="3372316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3372319">return</span>&nbsp;<span class="ident" id="3372326">c</span><span class="op" id="3372327">.</span><span class="ident" id="3372328">sendAlertLocked</span><span class="op" id="3372343">(</span><span class="ident" id="3372344">err</span><span class="op" id="3372347">)</span><br>
<span class="lineno">690</span><span class="op" id="3372349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3372352">//&nbsp;writeRecord&nbsp;writes&nbsp;a&nbsp;TLS&nbsp;record&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="3372419">//&nbsp;to&nbsp;the&nbsp;connection&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3372476">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno">695</span><span class="keyword" id="3372497">func</span>&nbsp;<span class="op" id="3372502">(</span><span class="ident" id="3372503">c</span>&nbsp;<span class="op" id="3372505">*</span><span class="ident" id="3372506">Conn</span><span class="op" id="3372510">)</span>&nbsp;<span class="ident" id="3372512">writeRecord</span><span class="op" id="3372523">(</span><span class="ident" id="3372524">typ</span>&nbsp;<span class="ident" id="3372528">recordType</span><span class="op" id="3372538">,</span>&nbsp;<span class="ident" id="3372540">data</span>&nbsp;<span class="op" id="3372545">[</span><span class="op" id="3372546">]</span><span class="builtintype" id="3372547">byte</span><span class="op" id="3372551">)</span>&nbsp;<span class="op" id="3372553">(</span><span class="ident" id="3372554">n</span>&nbsp;<span class="builtintype" id="3372556">int</span><span class="op" id="3372559">,</span>&nbsp;<span class="ident" id="3372561">err</span>&nbsp;<span class="builtintype" id="3372565">error</span><span class="op" id="3372570">)</span>&nbsp;<span class="op" id="3372572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3372575">b</span>&nbsp;<span class="op" id="3372577">:=</span>&nbsp;<span class="ident" id="3372580">c</span><span class="op" id="3372581">.</span><span class="ident" id="3372582">out</span><span class="op" id="3372585">.</span><span class="ident" id="3372586">newBlock</span><span class="op" id="3372594">(</span><span class="op" id="3372595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3372598">for</span>&nbsp;<span class="builtinfunc" id="3372602">len</span><span class="op" id="3372605">(</span><span class="ident" id="3372606">data</span><span class="op" id="3372610">)</span>&nbsp;<span class="op" id="3372612">&gt;</span>&nbsp;<span class="num" id="3372614">0</span>&nbsp;<span class="op" id="3372616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3372620">m</span>&nbsp;<span class="op" id="3372622">:=</span>&nbsp;<span class="builtinfunc" id="3372625">len</span><span class="op" id="3372628">(</span><span class="ident" id="3372629">data</span><span class="op" id="3372633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3372637">if</span>&nbsp;<span class="ident" id="3372640">m</span>&nbsp;<span class="op" id="3372642">&gt;</span>&nbsp;<span class="ident" id="3372644">maxPlaintext</span>&nbsp;<span class="op" id="3372657">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3372662">m</span>&nbsp;<span class="op" id="3372664">=</span>&nbsp;<span class="ident" id="3372666">maxPlaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3372681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3372685">explicitIVLen</span>&nbsp;<span class="op" id="3372699">:=</span>&nbsp;<span class="num" id="3372702">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3372706">explicitIVIsSeq</span>&nbsp;<span class="op" id="3372722">:=</span>&nbsp;<span class="builtintype" id="3372725">false</span><br>
<span class="lineno"></span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3372734">var</span>&nbsp;<span class="ident" id="3372738">cbc</span>&nbsp;<span class="ident" id="3372742">cbcMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3372752">if</span>&nbsp;<span class="ident" id="3372755">c</span><span class="op" id="3372756">.</span><span class="ident" id="3372757">out</span><span class="op" id="3372760">.</span><span class="ident" id="3372761">version</span>&nbsp;<span class="op" id="3372769">&gt;=</span>&nbsp;<span class="ident" id="3372772">VersionTLS11</span>&nbsp;<span class="op" id="3372785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3372790">var</span>&nbsp;<span class="ident" id="3372794">ok</span>&nbsp;<span class="builtintype" id="3372797">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3372805">if</span>&nbsp;<span class="ident" id="3372808">cbc</span><span class="op" id="3372811">,</span>&nbsp;<span class="ident" id="3372813">ok</span>&nbsp;<span class="op" id="3372816">=</span>&nbsp;<span class="ident" id="3372818">c</span><span class="op" id="3372819">.</span><span class="ident" id="3372820">out</span><span class="op" id="3372823">.</span><span class="ident" id="3372824">cipher</span><span class="op" id="3372830">.</span><span class="op" id="3372831">(</span><span class="ident" id="3372832">cbcMode</span><span class="op" id="3372839">)</span><span class="op" id="3372840">;</span>&nbsp;<span class="ident" id="3372842">ok</span>&nbsp;<span class="op" id="3372845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3372851">explicitIVLen</span>&nbsp;<span class="op" id="3372865">=</span>&nbsp;<span class="ident" id="3372867">cbc</span><span class="op" id="3372870">.</span><span class="ident" id="3372871">BlockSize</span><span class="op" id="3372880">(</span><span class="op" id="3372881">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3372886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3372890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3372894">if</span>&nbsp;<span class="ident" id="3372897">explicitIVLen</span>&nbsp;<span class="op" id="3372911">==</span>&nbsp;<span class="num" id="3372914">0</span>&nbsp;<span class="op" id="3372916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3372921">if</span>&nbsp;<span class="ident" id="3372924">_</span><span class="op" id="3372925">,</span>&nbsp;<span class="ident" id="3372927">ok</span>&nbsp;<span class="op" id="3372930">:=</span>&nbsp;<span class="ident" id="3372933">c</span><span class="op" id="3372934">.</span><span class="ident" id="3372935">out</span><span class="op" id="3372938">.</span><span class="ident" id="3372939">cipher</span><span class="op" id="3372945">.</span><span class="op" id="3372946">(</span><span class="ident" id="3372947">cipher</span><span class="op" id="3372953">.</span><span class="ident" id="3372954">AEAD</span><span class="op" id="3372958">)</span><span class="op" id="3372959">;</span>&nbsp;<span class="ident" id="3372961">ok</span>&nbsp;<span class="op" id="3372964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3372970">explicitIVLen</span>&nbsp;<span class="op" id="3372984">=</span>&nbsp;<span class="num" id="3372986">8</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3372992">//&nbsp;The&nbsp;AES-GCM&nbsp;construction&nbsp;in&nbsp;TLS&nbsp;has&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3373038">//&nbsp;explicit&nbsp;nonce&nbsp;so&nbsp;that&nbsp;the&nbsp;nonce&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3373085">//&nbsp;random.&nbsp;However,&nbsp;the&nbsp;nonce&nbsp;is&nbsp;only&nbsp;8&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3373135">//&nbsp;which&nbsp;is&nbsp;too&nbsp;small&nbsp;for&nbsp;a&nbsp;secure,&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3373182">//&nbsp;nonce.&nbsp;Therefore&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3373233">//&nbsp;as&nbsp;the&nbsp;nonce.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3373254">explicitIVIsSeq</span>&nbsp;<span class="op" id="3373270">=</span>&nbsp;<span class="builtintype" id="3373272">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3373280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3373284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3373288">b</span><span class="op" id="3373289">.</span><span class="ident" id="3373290">resize</span><span class="op" id="3373296">(</span><span class="ident" id="3373297">recordHeaderLen</span>&nbsp;<span class="op" id="3373313">+</span>&nbsp;<span class="ident" id="3373315">explicitIVLen</span>&nbsp;<span class="op" id="3373329">+</span>&nbsp;<span class="ident" id="3373331">m</span><span class="op" id="3373332">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3373336">b</span><span class="op" id="3373337">.</span><span class="ident" id="3373338">data</span><span class="op" id="3373342">[</span><span class="num" id="3373343">0</span><span class="op" id="3373344">]</span>&nbsp;<span class="op" id="3373346">=</span>&nbsp;<span class="builtintype" id="3373348">byte</span><span class="op" id="3373352">(</span><span class="ident" id="3373353">typ</span><span class="op" id="3373356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3373360">vers</span>&nbsp;<span class="op" id="3373365">:=</span>&nbsp;<span class="ident" id="3373368">c</span><span class="op" id="3373369">.</span><span class="ident" id="3373370">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3373377">if</span>&nbsp;<span class="ident" id="3373380">vers</span>&nbsp;<span class="op" id="3373385">==</span>&nbsp;<span class="num" id="3373388">0</span>&nbsp;<span class="op" id="3373390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3373395">//&nbsp;Some&nbsp;TLS&nbsp;servers&nbsp;fail&nbsp;if&nbsp;the&nbsp;record&nbsp;version&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3373448">//&nbsp;greater&nbsp;than&nbsp;TLS&nbsp;1.0&nbsp;for&nbsp;the&nbsp;initial&nbsp;ClientHello.</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3373504">vers</span>&nbsp;<span class="op" id="3373509">=</span>&nbsp;<span class="ident" id="3373511">VersionTLS10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3373526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3373530">b</span><span class="op" id="3373531">.</span><span class="ident" id="3373532">data</span><span class="op" id="3373536">[</span><span class="num" id="3373537">1</span><span class="op" id="3373538">]</span>&nbsp;<span class="op" id="3373540">=</span>&nbsp;<span class="builtintype" id="3373542">byte</span><span class="op" id="3373546">(</span><span class="ident" id="3373547">vers</span>&nbsp;<span class="op" id="3373552">&gt;&gt;</span>&nbsp;<span class="num" id="3373555">8</span><span class="op" id="3373556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3373560">b</span><span class="op" id="3373561">.</span><span class="ident" id="3373562">data</span><span class="op" id="3373566">[</span><span class="num" id="3373567">2</span><span class="op" id="3373568">]</span>&nbsp;<span class="op" id="3373570">=</span>&nbsp;<span class="builtintype" id="3373572">byte</span><span class="op" id="3373576">(</span><span class="ident" id="3373577">vers</span><span class="op" id="3373581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3373585">b</span><span class="op" id="3373586">.</span><span class="ident" id="3373587">data</span><span class="op" id="3373591">[</span><span class="num" id="3373592">3</span><span class="op" id="3373593">]</span>&nbsp;<span class="op" id="3373595">=</span>&nbsp;<span class="builtintype" id="3373597">byte</span><span class="op" id="3373601">(</span><span class="ident" id="3373602">m</span>&nbsp;<span class="op" id="3373604">&gt;&gt;</span>&nbsp;<span class="num" id="3373607">8</span><span class="op" id="3373608">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3373612">b</span><span class="op" id="3373613">.</span><span class="ident" id="3373614">data</span><span class="op" id="3373618">[</span><span class="num" id="3373619">4</span><span class="op" id="3373620">]</span>&nbsp;<span class="op" id="3373622">=</span>&nbsp;<span class="builtintype" id="3373624">byte</span><span class="op" id="3373628">(</span><span class="ident" id="3373629">m</span><span class="op" id="3373630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3373634">if</span>&nbsp;<span class="ident" id="3373637">explicitIVLen</span>&nbsp;<span class="op" id="3373651">&gt;</span>&nbsp;<span class="num" id="3373653">0</span>&nbsp;<span class="op" id="3373655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3373660">explicitIV</span>&nbsp;<span class="op" id="3373671">:=</span>&nbsp;<span class="ident" id="3373674">b</span><span class="op" id="3373675">.</span><span class="ident" id="3373676">data</span><span class="op" id="3373680">[</span><span class="ident" id="3373681">recordHeaderLen</span>&nbsp;<span class="op" id="3373697">:</span>&nbsp;<span class="ident" id="3373699">recordHeaderLen</span><span class="op" id="3373714">+</span><span class="ident" id="3373715">explicitIVLen</span><span class="op" id="3373728">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3373733">if</span>&nbsp;<span class="ident" id="3373736">explicitIVIsSeq</span>&nbsp;<span class="op" id="3373752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3373758">copy</span><span class="op" id="3373762">(</span><span class="ident" id="3373763">explicitIV</span><span class="op" id="3373773">,</span>&nbsp;<span class="ident" id="3373775">c</span><span class="op" id="3373776">.</span><span class="ident" id="3373777">out</span><span class="op" id="3373780">.</span><span class="ident" id="3373781">seq</span><span class="op" id="3373784">[</span><span class="op" id="3373785">:</span><span class="op" id="3373786">]</span><span class="op" id="3373787">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3373792">}</span>&nbsp;<span class="keyword" id="3373794">else</span>&nbsp;<span class="op" id="3373799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3373805">if</span>&nbsp;<span class="ident" id="3373808">_</span><span class="op" id="3373809">,</span>&nbsp;<span class="ident" id="3373811">err</span>&nbsp;<span class="op" id="3373815">=</span>&nbsp;<span class="ident" id="3373817">io</span><span class="op" id="3373819">.</span><span class="ident" id="3373820">ReadFull</span><span class="op" id="3373828">(</span><span class="ident" id="3373829">c</span><span class="op" id="3373830">.</span><span class="ident" id="3373831">config</span><span class="op" id="3373837">.</span><span class="ident" id="3373838">rand</span><span class="op" id="3373842">(</span><span class="op" id="3373843">)</span><span class="op" id="3373844">,</span>&nbsp;<span class="ident" id="3373846">explicitIV</span><span class="op" id="3373856">)</span><span class="op" id="3373857">;</span>&nbsp;<span class="ident" id="3373859">err</span>&nbsp;<span class="op" id="3373863">!=</span>&nbsp;<span class="ident" id="3373866">nil</span>&nbsp;<span class="op" id="3373870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3373877">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3373887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3373892">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3373896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3373900">copy</span><span class="op" id="3373904">(</span><span class="ident" id="3373905">b</span><span class="op" id="3373906">.</span><span class="ident" id="3373907">data</span><span class="op" id="3373911">[</span><span class="ident" id="3373912">recordHeaderLen</span><span class="op" id="3373927">+</span><span class="ident" id="3373928">explicitIVLen</span><span class="op" id="3373941">:</span><span class="op" id="3373942">]</span><span class="op" id="3373943">,</span>&nbsp;<span class="ident" id="3373945">data</span><span class="op" id="3373949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3373953">c</span><span class="op" id="3373954">.</span><span class="ident" id="3373955">out</span><span class="op" id="3373958">.</span><span class="ident" id="3373959">encrypt</span><span class="op" id="3373966">(</span><span class="ident" id="3373967">b</span><span class="op" id="3373968">,</span>&nbsp;<span class="ident" id="3373970">explicitIVLen</span><span class="op" id="3373983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3373987">_</span><span class="op" id="3373988">,</span>&nbsp;<span class="ident" id="3373990">err</span>&nbsp;<span class="op" id="3373994">=</span>&nbsp;<span class="ident" id="3373996">c</span><span class="op" id="3373997">.</span><span class="ident" id="3373998">conn</span><span class="op" id="3374002">.</span><span class="ident" id="3374003">Write</span><span class="op" id="3374008">(</span><span class="ident" id="3374009">b</span><span class="op" id="3374010">.</span><span class="ident" id="3374011">data</span><span class="op" id="3374015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3374019">if</span>&nbsp;<span class="ident" id="3374022">err</span>&nbsp;<span class="op" id="3374026">!=</span>&nbsp;<span class="ident" id="3374029">nil</span>&nbsp;<span class="op" id="3374033">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3374038">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3374046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3374050">n</span>&nbsp;<span class="op" id="3374052">+=</span>&nbsp;<span class="ident" id="3374055">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3374059">data</span>&nbsp;<span class="op" id="3374064">=</span>&nbsp;<span class="ident" id="3374066">data</span><span class="op" id="3374070">[</span><span class="ident" id="3374071">m</span><span class="op" id="3374072">:</span><span class="op" id="3374073">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3374076">}</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3374079">c</span><span class="op" id="3374080">.</span><span class="ident" id="3374081">out</span><span class="op" id="3374084">.</span><span class="ident" id="3374085">freeBlock</span><span class="op" id="3374094">(</span><span class="ident" id="3374095">b</span><span class="op" id="3374096">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3374100">if</span>&nbsp;<span class="ident" id="3374103">typ</span>&nbsp;<span class="op" id="3374107">==</span>&nbsp;<span class="ident" id="3374110">recordTypeChangeCipherSpec</span>&nbsp;<span class="op" id="3374137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3374141">err</span>&nbsp;<span class="op" id="3374145">=</span>&nbsp;<span class="ident" id="3374147">c</span><span class="op" id="3374148">.</span><span class="ident" id="3374149">out</span><span class="op" id="3374152">.</span><span class="ident" id="3374153">changeCipherSpec</span><span class="op" id="3374169">(</span><span class="op" id="3374170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3374174">if</span>&nbsp;<span class="ident" id="3374177">err</span>&nbsp;<span class="op" id="3374181">!=</span>&nbsp;<span class="ident" id="3374184">nil</span>&nbsp;<span class="op" id="3374188">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3374193">//&nbsp;Cannot&nbsp;call&nbsp;sendAlert&nbsp;directly,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3374231">//&nbsp;because&nbsp;we&nbsp;already&nbsp;hold&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3374274">c</span><span class="op" id="3374275">.</span><span class="ident" id="3374276">tmp</span><span class="op" id="3374279">[</span><span class="num" id="3374280">0</span><span class="op" id="3374281">]</span>&nbsp;<span class="op" id="3374283">=</span>&nbsp;<span class="ident" id="3374285">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3374304">c</span><span class="op" id="3374305">.</span><span class="ident" id="3374306">tmp</span><span class="op" id="3374309">[</span><span class="num" id="3374310">1</span><span class="op" id="3374311">]</span>&nbsp;<span class="op" id="3374313">=</span>&nbsp;<span class="builtintype" id="3374315">byte</span><span class="op" id="3374319">(</span><span class="ident" id="3374320">err</span><span class="op" id="3374323">.</span><span class="op" id="3374324">(</span><span class="ident" id="3374325">alert</span><span class="op" id="3374330">)</span><span class="op" id="3374331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3374336">c</span><span class="op" id="3374337">.</span><span class="ident" id="3374338">writeRecord</span><span class="op" id="3374349">(</span><span class="ident" id="3374350">recordTypeAlert</span><span class="op" id="3374365">,</span>&nbsp;<span class="ident" id="3374367">c</span><span class="op" id="3374368">.</span><span class="ident" id="3374369">tmp</span><span class="op" id="3374372">[</span><span class="num" id="3374373">0</span><span class="op" id="3374374">:</span><span class="num" id="3374375">2</span><span class="op" id="3374376">]</span><span class="op" id="3374377">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3374382">return</span>&nbsp;<span class="ident" id="3374389">n</span><span class="op" id="3374390">,</span>&nbsp;<span class="ident" id="3374392">c</span><span class="op" id="3374393">.</span><span class="ident" id="3374394">out</span><span class="op" id="3374397">.</span><span class="ident" id="3374398">setErrorLocked</span><span class="op" id="3374412">(</span><span class="op" id="3374413">&amp;</span><span class="ident" id="3374414">net</span><span class="op" id="3374417">.</span><span class="ident" id="3374418">OpError</span><span class="op" id="3374425">{</span><span class="ident" id="3374426">Op</span><span class="op" id="3374428">:</span>&nbsp;<span class="string" id="3374430">&#34;local&nbsp;error&#34;</span><span class="op" id="3374443">,</span>&nbsp;<span class="ident" id="3374445">Err</span><span class="op" id="3374448">:</span>&nbsp;<span class="ident" id="3374450">err</span><span class="op" id="3374453">}</span><span class="op" id="3374454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3374458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3374461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3374464">return</span><br>
<span class="lineno"></span><span class="op" id="3374471">}</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="3374474">//&nbsp;readHandshake&nbsp;reads&nbsp;the&nbsp;next&nbsp;handshake&nbsp;message&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="3374529">//&nbsp;the&nbsp;record&nbsp;layer.</span><br>
<span class="lineno"></span><span class="comment" id="3374550">//&nbsp;c.in.Mutex&nbsp;&lt;&nbsp;L;&nbsp;c.out.Mutex&nbsp;&lt;&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="3374586">func</span>&nbsp;<span class="op" id="3374591">(</span><span class="ident" id="3374592">c</span>&nbsp;<span class="op" id="3374594">*</span><span class="ident" id="3374595">Conn</span><span class="op" id="3374599">)</span>&nbsp;<span class="ident" id="3374601">readHandshake</span><span class="op" id="3374614">(</span><span class="op" id="3374615">)</span>&nbsp;<span class="op" id="3374617">(</span><span class="keyword" id="3374618">interface</span><span class="op" id="3374627">{</span><span class="op" id="3374628">}</span><span class="op" id="3374629">,</span>&nbsp;<span class="builtintype" id="3374631">error</span><span class="op" id="3374636">)</span>&nbsp;<span class="op" id="3374638">{</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3374641">for</span>&nbsp;<span class="ident" id="3374645">c</span><span class="op" id="3374646">.</span><span class="ident" id="3374647">hand</span><span class="op" id="3374651">.</span><span class="ident" id="3374652">Len</span><span class="op" id="3374655">(</span><span class="op" id="3374656">)</span>&nbsp;<span class="op" id="3374658">&lt;</span>&nbsp;<span class="num" id="3374660">4</span>&nbsp;<span class="op" id="3374662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3374666">if</span>&nbsp;<span class="ident" id="3374669">err</span>&nbsp;<span class="op" id="3374673">:=</span>&nbsp;<span class="ident" id="3374676">c</span><span class="op" id="3374677">.</span><span class="ident" id="3374678">in</span><span class="op" id="3374680">.</span><span class="ident" id="3374681">err</span><span class="op" id="3374684">;</span>&nbsp;<span class="ident" id="3374686">err</span>&nbsp;<span class="op" id="3374690">!=</span>&nbsp;<span class="ident" id="3374693">nil</span>&nbsp;<span class="op" id="3374697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3374702">return</span>&nbsp;<span class="ident" id="3374709">nil</span><span class="op" id="3374712">,</span>&nbsp;<span class="ident" id="3374714">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3374720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3374724">if</span>&nbsp;<span class="ident" id="3374727">err</span>&nbsp;<span class="op" id="3374731">:=</span>&nbsp;<span class="ident" id="3374734">c</span><span class="op" id="3374735">.</span><span class="ident" id="3374736">readRecord</span><span class="op" id="3374746">(</span><span class="ident" id="3374747">recordTypeHandshake</span><span class="op" id="3374766">)</span><span class="op" id="3374767">;</span>&nbsp;<span class="ident" id="3374769">err</span>&nbsp;<span class="op" id="3374773">!=</span>&nbsp;<span class="ident" id="3374776">nil</span>&nbsp;<span class="op" id="3374780">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3374785">return</span>&nbsp;<span class="ident" id="3374792">nil</span><span class="op" id="3374795">,</span>&nbsp;<span class="ident" id="3374797">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3374803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3374806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3374810">data</span>&nbsp;<span class="op" id="3374815">:=</span>&nbsp;<span class="ident" id="3374818">c</span><span class="op" id="3374819">.</span><span class="ident" id="3374820">hand</span><span class="op" id="3374824">.</span><span class="ident" id="3374825">Bytes</span><span class="op" id="3374830">(</span><span class="op" id="3374831">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3374834">n</span>&nbsp;<span class="op" id="3374836">:=</span>&nbsp;<span class="builtintype" id="3374839">int</span><span class="op" id="3374842">(</span><span class="ident" id="3374843">data</span><span class="op" id="3374847">[</span><span class="num" id="3374848">1</span><span class="op" id="3374849">]</span><span class="op" id="3374850">)</span><span class="op" id="3374851">&lt;&lt;</span><span class="num" id="3374853">16</span>&nbsp;<span class="op" id="3374856">|</span>&nbsp;<span class="builtintype" id="3374858">int</span><span class="op" id="3374861">(</span><span class="ident" id="3374862">data</span><span class="op" id="3374866">[</span><span class="num" id="3374867">2</span><span class="op" id="3374868">]</span><span class="op" id="3374869">)</span><span class="op" id="3374870">&lt;&lt;</span><span class="num" id="3374872">8</span>&nbsp;<span class="op" id="3374874">|</span>&nbsp;<span class="builtintype" id="3374876">int</span><span class="op" id="3374879">(</span><span class="ident" id="3374880">data</span><span class="op" id="3374884">[</span><span class="num" id="3374885">3</span><span class="op" id="3374886">]</span><span class="op" id="3374887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3374890">if</span>&nbsp;<span class="ident" id="3374893">n</span>&nbsp;<span class="op" id="3374895">&gt;</span>&nbsp;<span class="ident" id="3374897">maxHandshake</span>&nbsp;<span class="op" id="3374910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3374914">return</span>&nbsp;<span class="ident" id="3374921">nil</span><span class="op" id="3374924">,</span>&nbsp;<span class="ident" id="3374926">c</span><span class="op" id="3374927">.</span><span class="ident" id="3374928">in</span><span class="op" id="3374930">.</span><span class="ident" id="3374931">setErrorLocked</span><span class="op" id="3374945">(</span><span class="ident" id="3374946">c</span><span class="op" id="3374947">.</span><span class="ident" id="3374948">sendAlert</span><span class="op" id="3374957">(</span><span class="ident" id="3374958">alertInternalError</span><span class="op" id="3374976">)</span><span class="op" id="3374977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3374980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3374983">for</span>&nbsp;<span class="ident" id="3374987">c</span><span class="op" id="3374988">.</span><span class="ident" id="3374989">hand</span><span class="op" id="3374993">.</span><span class="ident" id="3374994">Len</span><span class="op" id="3374997">(</span><span class="op" id="3374998">)</span>&nbsp;<span class="op" id="3375000">&lt;</span>&nbsp;<span class="num" id="3375002">4</span><span class="op" id="3375003">+</span><span class="ident" id="3375004">n</span>&nbsp;<span class="op" id="3375006">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375010">if</span>&nbsp;<span class="ident" id="3375013">err</span>&nbsp;<span class="op" id="3375017">:=</span>&nbsp;<span class="ident" id="3375020">c</span><span class="op" id="3375021">.</span><span class="ident" id="3375022">in</span><span class="op" id="3375024">.</span><span class="ident" id="3375025">err</span><span class="op" id="3375028">;</span>&nbsp;<span class="ident" id="3375030">err</span>&nbsp;<span class="op" id="3375034">!=</span>&nbsp;<span class="ident" id="3375037">nil</span>&nbsp;<span class="op" id="3375041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375046">return</span>&nbsp;<span class="ident" id="3375053">nil</span><span class="op" id="3375056">,</span>&nbsp;<span class="ident" id="3375058">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3375064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375068">if</span>&nbsp;<span class="ident" id="3375071">err</span>&nbsp;<span class="op" id="3375075">:=</span>&nbsp;<span class="ident" id="3375078">c</span><span class="op" id="3375079">.</span><span class="ident" id="3375080">readRecord</span><span class="op" id="3375090">(</span><span class="ident" id="3375091">recordTypeHandshake</span><span class="op" id="3375110">)</span><span class="op" id="3375111">;</span>&nbsp;<span class="ident" id="3375113">err</span>&nbsp;<span class="op" id="3375117">!=</span>&nbsp;<span class="ident" id="3375120">nil</span>&nbsp;<span class="op" id="3375124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375129">return</span>&nbsp;<span class="ident" id="3375136">nil</span><span class="op" id="3375139">,</span>&nbsp;<span class="ident" id="3375141">err</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3375147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3375150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375153">data</span>&nbsp;<span class="op" id="3375158">=</span>&nbsp;<span class="ident" id="3375160">c</span><span class="op" id="3375161">.</span><span class="ident" id="3375162">hand</span><span class="op" id="3375166">.</span><span class="ident" id="3375167">Next</span><span class="op" id="3375171">(</span><span class="num" id="3375172">4</span>&nbsp;<span class="op" id="3375174">+</span>&nbsp;<span class="ident" id="3375176">n</span><span class="op" id="3375177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375180">var</span>&nbsp;<span class="ident" id="3375184">m</span>&nbsp;<span class="ident" id="3375186">handshakeMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375204">switch</span>&nbsp;<span class="ident" id="3375211">data</span><span class="op" id="3375215">[</span><span class="num" id="3375216">0</span><span class="op" id="3375217">]</span>&nbsp;<span class="op" id="3375219">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375222">case</span>&nbsp;<span class="ident" id="3375227">typeClientHello</span><span class="op" id="3375242">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375246">m</span>&nbsp;<span class="op" id="3375248">=</span>&nbsp;<span class="builtinfunc" id="3375250">new</span><span class="op" id="3375253">(</span><span class="ident" id="3375254">clientHelloMsg</span><span class="op" id="3375268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375271">case</span>&nbsp;<span class="ident" id="3375276">typeServerHello</span><span class="op" id="3375291">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375295">m</span>&nbsp;<span class="op" id="3375297">=</span>&nbsp;<span class="builtinfunc" id="3375299">new</span><span class="op" id="3375302">(</span><span class="ident" id="3375303">serverHelloMsg</span><span class="op" id="3375317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375320">case</span>&nbsp;<span class="ident" id="3375325">typeNewSessionTicket</span><span class="op" id="3375345">:</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375349">m</span>&nbsp;<span class="op" id="3375351">=</span>&nbsp;<span class="builtinfunc" id="3375353">new</span><span class="op" id="3375356">(</span><span class="ident" id="3375357">newSessionTicketMsg</span><span class="op" id="3375376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375379">case</span>&nbsp;<span class="ident" id="3375384">typeCertificate</span><span class="op" id="3375399">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375403">m</span>&nbsp;<span class="op" id="3375405">=</span>&nbsp;<span class="builtinfunc" id="3375407">new</span><span class="op" id="3375410">(</span><span class="ident" id="3375411">certificateMsg</span><span class="op" id="3375425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375428">case</span>&nbsp;<span class="ident" id="3375433">typeCertificateRequest</span><span class="op" id="3375455">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375459">m</span>&nbsp;<span class="op" id="3375461">=</span>&nbsp;<span class="op" id="3375463">&amp;</span><span class="ident" id="3375464">certificateRequestMsg</span><span class="op" id="3375485">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375490">hasSignatureAndHash</span><span class="op" id="3375509">:</span>&nbsp;<span class="ident" id="3375511">c</span><span class="op" id="3375512">.</span><span class="ident" id="3375513">vers</span>&nbsp;<span class="op" id="3375518">&gt;=</span>&nbsp;<span class="ident" id="3375521">VersionTLS12</span><span class="op" id="3375533">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3375537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375540">case</span>&nbsp;<span class="ident" id="3375545">typeCertificateStatus</span><span class="op" id="3375566">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375570">m</span>&nbsp;<span class="op" id="3375572">=</span>&nbsp;<span class="builtinfunc" id="3375574">new</span><span class="op" id="3375577">(</span><span class="ident" id="3375578">certificateStatusMsg</span><span class="op" id="3375598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375601">case</span>&nbsp;<span class="ident" id="3375606">typeServerKeyExchange</span><span class="op" id="3375627">:</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375631">m</span>&nbsp;<span class="op" id="3375633">=</span>&nbsp;<span class="builtinfunc" id="3375635">new</span><span class="op" id="3375638">(</span><span class="ident" id="3375639">serverKeyExchangeMsg</span><span class="op" id="3375659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375662">case</span>&nbsp;<span class="ident" id="3375667">typeServerHelloDone</span><span class="op" id="3375686">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375690">m</span>&nbsp;<span class="op" id="3375692">=</span>&nbsp;<span class="builtinfunc" id="3375694">new</span><span class="op" id="3375697">(</span><span class="ident" id="3375698">serverHelloDoneMsg</span><span class="op" id="3375716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375719">case</span>&nbsp;<span class="ident" id="3375724">typeClientKeyExchange</span><span class="op" id="3375745">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375749">m</span>&nbsp;<span class="op" id="3375751">=</span>&nbsp;<span class="builtinfunc" id="3375753">new</span><span class="op" id="3375756">(</span><span class="ident" id="3375757">clientKeyExchangeMsg</span><span class="op" id="3375777">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375780">case</span>&nbsp;<span class="ident" id="3375785">typeCertificateVerify</span><span class="op" id="3375806">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375810">m</span>&nbsp;<span class="op" id="3375812">=</span>&nbsp;<span class="op" id="3375814">&amp;</span><span class="ident" id="3375815">certificateVerifyMsg</span><span class="op" id="3375835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375840">hasSignatureAndHash</span><span class="op" id="3375859">:</span>&nbsp;<span class="ident" id="3375861">c</span><span class="op" id="3375862">.</span><span class="ident" id="3375863">vers</span>&nbsp;<span class="op" id="3375868">&gt;=</span>&nbsp;<span class="ident" id="3375871">VersionTLS12</span><span class="op" id="3375883">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3375887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375890">case</span>&nbsp;<span class="ident" id="3375895">typeNextProtocol</span><span class="op" id="3375911">:</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375915">m</span>&nbsp;<span class="op" id="3375917">=</span>&nbsp;<span class="builtinfunc" id="3375919">new</span><span class="op" id="3375922">(</span><span class="ident" id="3375923">nextProtoMsg</span><span class="op" id="3375935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375938">case</span>&nbsp;<span class="ident" id="3375943">typeFinished</span><span class="op" id="3375955">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3375959">m</span>&nbsp;<span class="op" id="3375961">=</span>&nbsp;<span class="builtinfunc" id="3375963">new</span><span class="op" id="3375966">(</span><span class="ident" id="3375967">finishedMsg</span><span class="op" id="3375978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375981">default</span><span class="op" id="3375988">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3375992">return</span>&nbsp;<span class="ident" id="3375999">nil</span><span class="op" id="3376002">,</span>&nbsp;<span class="ident" id="3376004">c</span><span class="op" id="3376005">.</span><span class="ident" id="3376006">in</span><span class="op" id="3376008">.</span><span class="ident" id="3376009">setErrorLocked</span><span class="op" id="3376023">(</span><span class="ident" id="3376024">c</span><span class="op" id="3376025">.</span><span class="ident" id="3376026">sendAlert</span><span class="op" id="3376035">(</span><span class="ident" id="3376036">alertUnexpectedMessage</span><span class="op" id="3376058">)</span><span class="op" id="3376059">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3376062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3376066">//&nbsp;The&nbsp;handshake&nbsp;message&nbsp;unmarshallers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3376106">//&nbsp;expect&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;keep&nbsp;references&nbsp;to&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3376156">//&nbsp;so&nbsp;pass&nbsp;in&nbsp;a&nbsp;fresh&nbsp;copy&nbsp;that&nbsp;won&#39;t&nbsp;be&nbsp;overwritten.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376211">data</span>&nbsp;<span class="op" id="3376216">=</span>&nbsp;<span class="builtinfunc" id="3376218">append</span><span class="op" id="3376224">(</span><span class="op" id="3376225">[</span><span class="op" id="3376226">]</span><span class="builtintype" id="3376227">byte</span><span class="op" id="3376231">(</span><span class="ident" id="3376232">nil</span><span class="op" id="3376235">)</span><span class="op" id="3376236">,</span>&nbsp;<span class="ident" id="3376238">data</span><span class="op" id="3376242">...</span><span class="op" id="3376245">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3376249">if</span>&nbsp;<span class="op" id="3376252">!</span><span class="ident" id="3376253">m</span><span class="op" id="3376254">.</span><span class="ident" id="3376255">unmarshal</span><span class="op" id="3376264">(</span><span class="ident" id="3376265">data</span><span class="op" id="3376269">)</span>&nbsp;<span class="op" id="3376271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3376275">return</span>&nbsp;<span class="ident" id="3376282">nil</span><span class="op" id="3376285">,</span>&nbsp;<span class="ident" id="3376287">c</span><span class="op" id="3376288">.</span><span class="ident" id="3376289">in</span><span class="op" id="3376291">.</span><span class="ident" id="3376292">setErrorLocked</span><span class="op" id="3376306">(</span><span class="ident" id="3376307">c</span><span class="op" id="3376308">.</span><span class="ident" id="3376309">sendAlert</span><span class="op" id="3376318">(</span><span class="ident" id="3376319">alertUnexpectedMessage</span><span class="op" id="3376341">)</span><span class="op" id="3376342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3376345">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3376348">return</span>&nbsp;<span class="ident" id="3376355">m</span><span class="op" id="3376356">,</span>&nbsp;<span class="ident" id="3376358">nil</span><br>
<span class="lineno"></span><span class="op" id="3376362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3376365">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3376405">func</span>&nbsp;<span class="op" id="3376410">(</span><span class="ident" id="3376411">c</span>&nbsp;<span class="op" id="3376413">*</span><span class="ident" id="3376414">Conn</span><span class="op" id="3376418">)</span>&nbsp;<span class="ident" id="3376420">Write</span><span class="op" id="3376425">(</span><span class="ident" id="3376426">b</span>&nbsp;<span class="op" id="3376428">[</span><span class="op" id="3376429">]</span><span class="builtintype" id="3376430">byte</span><span class="op" id="3376434">)</span>&nbsp;<span class="op" id="3376436">(</span><span class="builtintype" id="3376437">int</span><span class="op" id="3376440">,</span>&nbsp;<span class="builtintype" id="3376442">error</span><span class="op" id="3376447">)</span>&nbsp;<span class="op" id="3376449">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3376452">if</span>&nbsp;<span class="ident" id="3376455">err</span>&nbsp;<span class="op" id="3376459">:=</span>&nbsp;<span class="ident" id="3376462">c</span><span class="op" id="3376463">.</span><span class="ident" id="3376464">Handshake</span><span class="op" id="3376473">(</span><span class="op" id="3376474">)</span><span class="op" id="3376475">;</span>&nbsp;<span class="ident" id="3376477">err</span>&nbsp;<span class="op" id="3376481">!=</span>&nbsp;<span class="ident" id="3376484">nil</span>&nbsp;<span class="op" id="3376488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3376492">return</span>&nbsp;<span class="num" id="3376499">0</span><span class="op" id="3376500">,</span>&nbsp;<span class="ident" id="3376502">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3376507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376511">c</span><span class="op" id="3376512">.</span><span class="ident" id="3376513">out</span><span class="op" id="3376516">.</span><span class="ident" id="3376517">Lock</span><span class="op" id="3376521">(</span><span class="op" id="3376522">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3376525">defer</span>&nbsp;<span class="ident" id="3376531">c</span><span class="op" id="3376532">.</span><span class="ident" id="3376533">out</span><span class="op" id="3376536">.</span><span class="ident" id="3376537">Unlock</span><span class="op" id="3376543">(</span><span class="op" id="3376544">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3376548">if</span>&nbsp;<span class="ident" id="3376551">err</span>&nbsp;<span class="op" id="3376555">:=</span>&nbsp;<span class="ident" id="3376558">c</span><span class="op" id="3376559">.</span><span class="ident" id="3376560">out</span><span class="op" id="3376563">.</span><span class="ident" id="3376564">err</span><span class="op" id="3376567">;</span>&nbsp;<span class="ident" id="3376569">err</span>&nbsp;<span class="op" id="3376573">!=</span>&nbsp;<span class="ident" id="3376576">nil</span>&nbsp;<span class="op" id="3376580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3376584">return</span>&nbsp;<span class="num" id="3376591">0</span><span class="op" id="3376592">,</span>&nbsp;<span class="ident" id="3376594">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3376599">}</span><br>
<span class="lineno">855</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3376603">if</span>&nbsp;<span class="op" id="3376606">!</span><span class="ident" id="3376607">c</span><span class="op" id="3376608">.</span><span class="ident" id="3376609">handshakeComplete</span>&nbsp;<span class="op" id="3376627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3376631">return</span>&nbsp;<span class="num" id="3376638">0</span><span class="op" id="3376639">,</span>&nbsp;<span class="ident" id="3376641">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3376661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3376665">//&nbsp;SSL&nbsp;3.0&nbsp;and&nbsp;TLS&nbsp;1.0&nbsp;are&nbsp;susceptible&nbsp;to&nbsp;a&nbsp;chosen-plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3376727">//&nbsp;attack&nbsp;when&nbsp;using&nbsp;block&nbsp;mode&nbsp;ciphers&nbsp;due&nbsp;to&nbsp;predictable&nbsp;IVs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3376792">//&nbsp;This&nbsp;can&nbsp;be&nbsp;prevented&nbsp;by&nbsp;splitting&nbsp;each&nbsp;Application&nbsp;Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3376853">//&nbsp;record&nbsp;into&nbsp;two&nbsp;records,&nbsp;effectively&nbsp;randomizing&nbsp;the&nbsp;IV.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3376914">//</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3376918">//&nbsp;http://www.openssl.org/~bodo/tls-cbc.txt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3376963">//&nbsp;https://bugzilla.mozilla.org/show_bug.cgi?id=665814</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3377019">//&nbsp;http://www.imperialviolet.org/2012/01/15/beastfollowup.html</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377084">var</span>&nbsp;<span class="ident" id="3377088">m</span>&nbsp;<span class="builtintype" id="3377090">int</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377095">if</span>&nbsp;<span class="builtinfunc" id="3377098">len</span><span class="op" id="3377101">(</span><span class="ident" id="3377102">b</span><span class="op" id="3377103">)</span>&nbsp;<span class="op" id="3377105">&gt;</span>&nbsp;<span class="num" id="3377107">1</span>&nbsp;<span class="op" id="3377109">&amp;&amp;</span>&nbsp;<span class="ident" id="3377112">c</span><span class="op" id="3377113">.</span><span class="ident" id="3377114">vers</span>&nbsp;<span class="op" id="3377119">&lt;=</span>&nbsp;<span class="ident" id="3377122">VersionTLS10</span>&nbsp;<span class="op" id="3377135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377139">if</span>&nbsp;<span class="ident" id="3377142">_</span><span class="op" id="3377143">,</span>&nbsp;<span class="ident" id="3377145">ok</span>&nbsp;<span class="op" id="3377148">:=</span>&nbsp;<span class="ident" id="3377151">c</span><span class="op" id="3377152">.</span><span class="ident" id="3377153">out</span><span class="op" id="3377156">.</span><span class="ident" id="3377157">cipher</span><span class="op" id="3377163">.</span><span class="op" id="3377164">(</span><span class="ident" id="3377165">cipher</span><span class="op" id="3377171">.</span><span class="ident" id="3377172">BlockMode</span><span class="op" id="3377181">)</span><span class="op" id="3377182">;</span>&nbsp;<span class="ident" id="3377184">ok</span>&nbsp;<span class="op" id="3377187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3377192">n</span><span class="op" id="3377193">,</span>&nbsp;<span class="ident" id="3377195">err</span>&nbsp;<span class="op" id="3377199">:=</span>&nbsp;<span class="ident" id="3377202">c</span><span class="op" id="3377203">.</span><span class="ident" id="3377204">writeRecord</span><span class="op" id="3377215">(</span><span class="ident" id="3377216">recordTypeApplicationData</span><span class="op" id="3377241">,</span>&nbsp;<span class="ident" id="3377243">b</span><span class="op" id="3377244">[</span><span class="op" id="3377245">:</span><span class="num" id="3377246">1</span><span class="op" id="3377247">]</span><span class="op" id="3377248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377253">if</span>&nbsp;<span class="ident" id="3377256">err</span>&nbsp;<span class="op" id="3377260">!=</span>&nbsp;<span class="ident" id="3377263">nil</span>&nbsp;<span class="op" id="3377267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377273">return</span>&nbsp;<span class="ident" id="3377280">n</span><span class="op" id="3377281">,</span>&nbsp;<span class="ident" id="3377283">c</span><span class="op" id="3377284">.</span><span class="ident" id="3377285">out</span><span class="op" id="3377288">.</span><span class="ident" id="3377289">setErrorLocked</span><span class="op" id="3377303">(</span><span class="ident" id="3377304">err</span><span class="op" id="3377307">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3377312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3377317">m</span><span class="op" id="3377318">,</span>&nbsp;<span class="ident" id="3377320">b</span>&nbsp;<span class="op" id="3377322">=</span>&nbsp;<span class="num" id="3377324">1</span><span class="op" id="3377325">,</span>&nbsp;<span class="ident" id="3377327">b</span><span class="op" id="3377328">[</span><span class="num" id="3377329">1</span><span class="op" id="3377330">:</span><span class="op" id="3377331">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3377335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3377338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3377342">n</span><span class="op" id="3377343">,</span>&nbsp;<span class="ident" id="3377345">err</span>&nbsp;<span class="op" id="3377349">:=</span>&nbsp;<span class="ident" id="3377352">c</span><span class="op" id="3377353">.</span><span class="ident" id="3377354">writeRecord</span><span class="op" id="3377365">(</span><span class="ident" id="3377366">recordTypeApplicationData</span><span class="op" id="3377391">,</span>&nbsp;<span class="ident" id="3377393">b</span><span class="op" id="3377394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377397">return</span>&nbsp;<span class="ident" id="3377404">n</span>&nbsp;<span class="op" id="3377406">+</span>&nbsp;<span class="ident" id="3377408">m</span><span class="op" id="3377409">,</span>&nbsp;<span class="ident" id="3377411">c</span><span class="op" id="3377412">.</span><span class="ident" id="3377413">out</span><span class="op" id="3377416">.</span><span class="ident" id="3377417">setErrorLocked</span><span class="op" id="3377431">(</span><span class="ident" id="3377432">err</span><span class="op" id="3377435">)</span><br>
<span class="lineno"></span><span class="op" id="3377437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3377440">//&nbsp;Read&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;a&nbsp;net.Error&nbsp;with&nbsp;Timeout()&nbsp;==&nbsp;true</span><br>
<span class="lineno">885</span><span class="comment" id="3377518">//&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and&nbsp;SetReadDeadline.</span><br>
<span class="lineno"></span><span class="keyword" id="3377584">func</span>&nbsp;<span class="op" id="3377589">(</span><span class="ident" id="3377590">c</span>&nbsp;<span class="op" id="3377592">*</span><span class="ident" id="3377593">Conn</span><span class="op" id="3377597">)</span>&nbsp;<span class="ident" id="3377599">Read</span><span class="op" id="3377603">(</span><span class="ident" id="3377604">b</span>&nbsp;<span class="op" id="3377606">[</span><span class="op" id="3377607">]</span><span class="builtintype" id="3377608">byte</span><span class="op" id="3377612">)</span>&nbsp;<span class="op" id="3377614">(</span><span class="ident" id="3377615">n</span>&nbsp;<span class="builtintype" id="3377617">int</span><span class="op" id="3377620">,</span>&nbsp;<span class="ident" id="3377622">err</span>&nbsp;<span class="builtintype" id="3377626">error</span><span class="op" id="3377631">)</span>&nbsp;<span class="op" id="3377633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377636">if</span>&nbsp;<span class="ident" id="3377639">err</span>&nbsp;<span class="op" id="3377643">=</span>&nbsp;<span class="ident" id="3377645">c</span><span class="op" id="3377646">.</span><span class="ident" id="3377647">Handshake</span><span class="op" id="3377656">(</span><span class="op" id="3377657">)</span><span class="op" id="3377658">;</span>&nbsp;<span class="ident" id="3377660">err</span>&nbsp;<span class="op" id="3377664">!=</span>&nbsp;<span class="ident" id="3377667">nil</span>&nbsp;<span class="op" id="3377671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377675">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3377683">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377686">if</span>&nbsp;<span class="builtinfunc" id="3377689">len</span><span class="op" id="3377692">(</span><span class="ident" id="3377693">b</span><span class="op" id="3377694">)</span>&nbsp;<span class="op" id="3377696">==</span>&nbsp;<span class="num" id="3377699">0</span>&nbsp;<span class="op" id="3377701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3377705">//&nbsp;Put&nbsp;this&nbsp;after&nbsp;Handshake,&nbsp;in&nbsp;case&nbsp;people&nbsp;were&nbsp;calling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3377764">//&nbsp;Read(nil)&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of&nbsp;the&nbsp;Handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377817">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3377825">}</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3377829">c</span><span class="op" id="3377830">.</span><span class="ident" id="3377831">in</span><span class="op" id="3377833">.</span><span class="ident" id="3377834">Lock</span><span class="op" id="3377838">(</span><span class="op" id="3377839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377842">defer</span>&nbsp;<span class="ident" id="3377848">c</span><span class="op" id="3377849">.</span><span class="ident" id="3377850">in</span><span class="op" id="3377852">.</span><span class="ident" id="3377853">Unlock</span><span class="op" id="3377859">(</span><span class="op" id="3377860">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3377864">//&nbsp;Some&nbsp;OpenSSL&nbsp;servers&nbsp;send&nbsp;empty&nbsp;records&nbsp;in&nbsp;order&nbsp;to&nbsp;randomize&nbsp;the</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3377934">//&nbsp;CBC&nbsp;IV.&nbsp;So&nbsp;this&nbsp;loop&nbsp;ignores&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;empty&nbsp;records.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378002">const</span>&nbsp;<span class="ident" id="3378008">maxConsecutiveEmptyRecords</span>&nbsp;<span class="op" id="3378035">=</span>&nbsp;<span class="num" id="3378037">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378042">for</span>&nbsp;<span class="ident" id="3378046">emptyRecordCount</span>&nbsp;<span class="op" id="3378063">:=</span>&nbsp;<span class="num" id="3378066">0</span><span class="op" id="3378067">;</span>&nbsp;<span class="ident" id="3378069">emptyRecordCount</span>&nbsp;<span class="op" id="3378086">&lt;=</span>&nbsp;<span class="ident" id="3378089">maxConsecutiveEmptyRecords</span><span class="op" id="3378115">;</span>&nbsp;<span class="ident" id="3378117">emptyRecordCount</span><span class="op" id="3378133">++</span>&nbsp;<span class="op" id="3378136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378140">for</span>&nbsp;<span class="ident" id="3378144">c</span><span class="op" id="3378145">.</span><span class="ident" id="3378146">input</span>&nbsp;<span class="op" id="3378152">==</span>&nbsp;<span class="ident" id="3378155">nil</span>&nbsp;<span class="op" id="3378159">&amp;&amp;</span>&nbsp;<span class="ident" id="3378162">c</span><span class="op" id="3378163">.</span><span class="ident" id="3378164">in</span><span class="op" id="3378166">.</span><span class="ident" id="3378167">err</span>&nbsp;<span class="op" id="3378171">==</span>&nbsp;<span class="ident" id="3378174">nil</span>&nbsp;<span class="op" id="3378178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378183">if</span>&nbsp;<span class="ident" id="3378186">err</span>&nbsp;<span class="op" id="3378190">:=</span>&nbsp;<span class="ident" id="3378193">c</span><span class="op" id="3378194">.</span><span class="ident" id="3378195">readRecord</span><span class="op" id="3378205">(</span><span class="ident" id="3378206">recordTypeApplicationData</span><span class="op" id="3378231">)</span><span class="op" id="3378232">;</span>&nbsp;<span class="ident" id="3378234">err</span>&nbsp;<span class="op" id="3378238">!=</span>&nbsp;<span class="ident" id="3378241">nil</span>&nbsp;<span class="op" id="3378245">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378251">//&nbsp;Soft&nbsp;error,&nbsp;like&nbsp;EAGAIN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378282">return</span>&nbsp;<span class="num" id="3378289">0</span><span class="op" id="3378290">,</span>&nbsp;<span class="ident" id="3378292">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378307">if</span>&nbsp;<span class="ident" id="3378310">err</span>&nbsp;<span class="op" id="3378314">:=</span>&nbsp;<span class="ident" id="3378317">c</span><span class="op" id="3378318">.</span><span class="ident" id="3378319">in</span><span class="op" id="3378321">.</span><span class="ident" id="3378322">err</span><span class="op" id="3378325">;</span>&nbsp;<span class="ident" id="3378327">err</span>&nbsp;<span class="op" id="3378331">!=</span>&nbsp;<span class="ident" id="3378334">nil</span>&nbsp;<span class="op" id="3378338">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378343">return</span>&nbsp;<span class="num" id="3378350">0</span><span class="op" id="3378351">,</span>&nbsp;<span class="ident" id="3378353">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378364">n</span><span class="op" id="3378365">,</span>&nbsp;<span class="ident" id="3378367">err</span>&nbsp;<span class="op" id="3378371">=</span>&nbsp;<span class="ident" id="3378373">c</span><span class="op" id="3378374">.</span><span class="ident" id="3378375">input</span><span class="op" id="3378380">.</span><span class="ident" id="3378381">Read</span><span class="op" id="3378385">(</span><span class="ident" id="3378386">b</span><span class="op" id="3378387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378391">if</span>&nbsp;<span class="ident" id="3378394">c</span><span class="op" id="3378395">.</span><span class="ident" id="3378396">input</span><span class="op" id="3378401">.</span><span class="ident" id="3378402">off</span>&nbsp;<span class="op" id="3378406">&gt;=</span>&nbsp;<span class="builtinfunc" id="3378409">len</span><span class="op" id="3378412">(</span><span class="ident" id="3378413">c</span><span class="op" id="3378414">.</span><span class="ident" id="3378415">input</span><span class="op" id="3378420">.</span><span class="ident" id="3378421">data</span><span class="op" id="3378425">)</span>&nbsp;<span class="op" id="3378427">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378432">c</span><span class="op" id="3378433">.</span><span class="ident" id="3378434">in</span><span class="op" id="3378436">.</span><span class="ident" id="3378437">freeBlock</span><span class="op" id="3378446">(</span><span class="ident" id="3378447">c</span><span class="op" id="3378448">.</span><span class="ident" id="3378449">input</span><span class="op" id="3378454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378459">c</span><span class="op" id="3378460">.</span><span class="ident" id="3378461">input</span>&nbsp;<span class="op" id="3378467">=</span>&nbsp;<span class="ident" id="3378469">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378480">//&nbsp;If&nbsp;a&nbsp;close-notify&nbsp;alert&nbsp;is&nbsp;waiting,&nbsp;read&nbsp;it&nbsp;so&nbsp;that</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378537">//&nbsp;we&nbsp;can&nbsp;return&nbsp;(n,&nbsp;EOF)&nbsp;instead&nbsp;of&nbsp;(n,&nbsp;nil),&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378596">//&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378649">//&nbsp;connection&nbsp;is&nbsp;now&nbsp;closed.&nbsp;This&nbsp;eliminates&nbsp;a&nbsp;race</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378703">//&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378756">//&nbsp;otherwise&nbsp;not&nbsp;observe&nbsp;the&nbsp;EOF&nbsp;until&nbsp;its&nbsp;next&nbsp;read,</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378812">//&nbsp;by&nbsp;which&nbsp;time&nbsp;a&nbsp;client&nbsp;goroutine&nbsp;might&nbsp;have&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378869">//&nbsp;tried&nbsp;to&nbsp;reuse&nbsp;the&nbsp;HTTP&nbsp;connection&nbsp;for&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378919">//&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378933">//&nbsp;See&nbsp;https://codereview.appspot.com/76400046</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378982">//&nbsp;and&nbsp;http://golang.org/issue/3514</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379020">if</span>&nbsp;<span class="ident" id="3379023">ri</span>&nbsp;<span class="op" id="3379026">:=</span>&nbsp;<span class="ident" id="3379029">c</span><span class="op" id="3379030">.</span><span class="ident" id="3379031">rawInput</span><span class="op" id="3379039">;</span>&nbsp;<span class="ident" id="3379041">ri</span>&nbsp;<span class="op" id="3379044">!=</span>&nbsp;<span class="ident" id="3379047">nil</span>&nbsp;<span class="op" id="3379051">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379057">n</span>&nbsp;<span class="op" id="3379059">!=</span>&nbsp;<span class="num" id="3379062">0</span>&nbsp;<span class="op" id="3379064">&amp;&amp;</span>&nbsp;<span class="ident" id="3379067">err</span>&nbsp;<span class="op" id="3379071">==</span>&nbsp;<span class="ident" id="3379074">nil</span>&nbsp;<span class="op" id="3379078">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379084">c</span><span class="op" id="3379085">.</span><span class="ident" id="3379086">input</span>&nbsp;<span class="op" id="3379092">==</span>&nbsp;<span class="ident" id="3379095">nil</span>&nbsp;<span class="op" id="3379099">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3379102">len</span><span class="op" id="3379105">(</span><span class="ident" id="3379106">ri</span><span class="op" id="3379108">.</span><span class="ident" id="3379109">data</span><span class="op" id="3379113">)</span>&nbsp;<span class="op" id="3379115">&gt;</span>&nbsp;<span class="num" id="3379117">0</span>&nbsp;<span class="op" id="3379119">&amp;&amp;</span>&nbsp;<span class="ident" id="3379122">recordType</span><span class="op" id="3379132">(</span><span class="ident" id="3379133">ri</span><span class="op" id="3379135">.</span><span class="ident" id="3379136">data</span><span class="op" id="3379140">[</span><span class="num" id="3379141">0</span><span class="op" id="3379142">]</span><span class="op" id="3379143">)</span>&nbsp;<span class="op" id="3379145">==</span>&nbsp;<span class="ident" id="3379148">recordTypeAlert</span>&nbsp;<span class="op" id="3379164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379169">if</span>&nbsp;<span class="ident" id="3379172">recErr</span>&nbsp;<span class="op" id="3379179">:=</span>&nbsp;<span class="ident" id="3379182">c</span><span class="op" id="3379183">.</span><span class="ident" id="3379184">readRecord</span><span class="op" id="3379194">(</span><span class="ident" id="3379195">recordTypeApplicationData</span><span class="op" id="3379220">)</span><span class="op" id="3379221">;</span>&nbsp;<span class="ident" id="3379223">recErr</span>&nbsp;<span class="op" id="3379230">!=</span>&nbsp;<span class="ident" id="3379233">nil</span>&nbsp;<span class="op" id="3379237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379243">err</span>&nbsp;<span class="op" id="3379247">=</span>&nbsp;<span class="ident" id="3379249">recErr</span>&nbsp;<span class="comment" id="3379256">//&nbsp;will&nbsp;be&nbsp;io.EOF&nbsp;on&nbsp;closeNotify</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379301">if</span>&nbsp;<span class="ident" id="3379304">n</span>&nbsp;<span class="op" id="3379306">!=</span>&nbsp;<span class="num" id="3379309">0</span>&nbsp;<span class="op" id="3379311">||</span>&nbsp;<span class="ident" id="3379314">err</span>&nbsp;<span class="op" id="3379318">!=</span>&nbsp;<span class="ident" id="3379321">nil</span>&nbsp;<span class="op" id="3379325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379330">return</span>&nbsp;<span class="ident" id="3379337">n</span><span class="op" id="3379338">,</span>&nbsp;<span class="ident" id="3379340">err</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379353">return</span>&nbsp;<span class="num" id="3379360">0</span><span class="op" id="3379361">,</span>&nbsp;<span class="ident" id="3379363">io</span><span class="op" id="3379365">.</span><span class="ident" id="3379366">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="3379380">}</span><br>
<span class="lineno">945</span><br>
<span class="lineno"></span><span class="comment" id="3379383">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3379415">func</span>&nbsp;<span class="op" id="3379420">(</span><span class="ident" id="3379421">c</span>&nbsp;<span class="op" id="3379423">*</span><span class="ident" id="3379424">Conn</span><span class="op" id="3379428">)</span>&nbsp;<span class="ident" id="3379430">Close</span><span class="op" id="3379435">(</span><span class="op" id="3379436">)</span>&nbsp;<span class="builtintype" id="3379438">error</span>&nbsp;<span class="op" id="3379444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379447">var</span>&nbsp;<span class="ident" id="3379451">alertErr</span>&nbsp;<span class="builtintype" id="3379460">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379468">c</span><span class="op" id="3379469">.</span><span class="ident" id="3379470">handshakeMutex</span><span class="op" id="3379484">.</span><span class="ident" id="3379485">Lock</span><span class="op" id="3379489">(</span><span class="op" id="3379490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379493">defer</span>&nbsp;<span class="ident" id="3379499">c</span><span class="op" id="3379500">.</span><span class="ident" id="3379501">handshakeMutex</span><span class="op" id="3379515">.</span><span class="ident" id="3379516">Unlock</span><span class="op" id="3379522">(</span><span class="op" id="3379523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379526">if</span>&nbsp;<span class="ident" id="3379529">c</span><span class="op" id="3379530">.</span><span class="ident" id="3379531">handshakeComplete</span>&nbsp;<span class="op" id="3379549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379553">alertErr</span>&nbsp;<span class="op" id="3379562">=</span>&nbsp;<span class="ident" id="3379564">c</span><span class="op" id="3379565">.</span><span class="ident" id="3379566">sendAlert</span><span class="op" id="3379575">(</span><span class="ident" id="3379576">alertCloseNotify</span><span class="op" id="3379592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379595">}</span><br>
<span class="lineno">955</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379599">if</span>&nbsp;<span class="ident" id="3379602">err</span>&nbsp;<span class="op" id="3379606">:=</span>&nbsp;<span class="ident" id="3379609">c</span><span class="op" id="3379610">.</span><span class="ident" id="3379611">conn</span><span class="op" id="3379615">.</span><span class="ident" id="3379616">Close</span><span class="op" id="3379621">(</span><span class="op" id="3379622">)</span><span class="op" id="3379623">;</span>&nbsp;<span class="ident" id="3379625">err</span>&nbsp;<span class="op" id="3379629">!=</span>&nbsp;<span class="ident" id="3379632">nil</span>&nbsp;<span class="op" id="3379636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379640">return</span>&nbsp;<span class="ident" id="3379647">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379655">return</span>&nbsp;<span class="ident" id="3379662">alertErr</span><br>
<span class="lineno">960</span><span class="op" id="3379671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3379674">//&nbsp;Handshake&nbsp;runs&nbsp;the&nbsp;client&nbsp;or&nbsp;server&nbsp;handshake</span><br>
<span class="lineno"></span><span class="comment" id="3379723">//&nbsp;protocol&nbsp;if&nbsp;it&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="3379763">//&nbsp;Most&nbsp;uses&nbsp;of&nbsp;this&nbsp;package&nbsp;need&nbsp;not&nbsp;call&nbsp;Handshake</span><br>
<span class="lineno">965</span><span class="comment" id="3379816">//&nbsp;explicitly:&nbsp;the&nbsp;first&nbsp;Read&nbsp;or&nbsp;Write&nbsp;will&nbsp;call&nbsp;it&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="3379883">func</span>&nbsp;<span class="op" id="3379888">(</span><span class="ident" id="3379889">c</span>&nbsp;<span class="op" id="3379891">*</span><span class="ident" id="3379892">Conn</span><span class="op" id="3379896">)</span>&nbsp;<span class="ident" id="3379898">Handshake</span><span class="op" id="3379907">(</span><span class="op" id="3379908">)</span>&nbsp;<span class="builtintype" id="3379910">error</span>&nbsp;<span class="op" id="3379916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379919">c</span><span class="op" id="3379920">.</span><span class="ident" id="3379921">handshakeMutex</span><span class="op" id="3379935">.</span><span class="ident" id="3379936">Lock</span><span class="op" id="3379940">(</span><span class="op" id="3379941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379944">defer</span>&nbsp;<span class="ident" id="3379950">c</span><span class="op" id="3379951">.</span><span class="ident" id="3379952">handshakeMutex</span><span class="op" id="3379966">.</span><span class="ident" id="3379967">Unlock</span><span class="op" id="3379973">(</span><span class="op" id="3379974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379977">if</span>&nbsp;<span class="ident" id="3379980">err</span>&nbsp;<span class="op" id="3379984">:=</span>&nbsp;<span class="ident" id="3379987">c</span><span class="op" id="3379988">.</span><span class="ident" id="3379989">handshakeErr</span><span class="op" id="3380001">;</span>&nbsp;<span class="ident" id="3380003">err</span>&nbsp;<span class="op" id="3380007">!=</span>&nbsp;<span class="ident" id="3380010">nil</span>&nbsp;<span class="op" id="3380014">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380018">return</span>&nbsp;<span class="ident" id="3380025">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380033">if</span>&nbsp;<span class="ident" id="3380036">c</span><span class="op" id="3380037">.</span><span class="ident" id="3380038">handshakeComplete</span>&nbsp;<span class="op" id="3380056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380060">return</span>&nbsp;<span class="ident" id="3380067">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380072">}</span><br>
<span class="lineno">975</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380076">if</span>&nbsp;<span class="ident" id="3380079">c</span><span class="op" id="3380080">.</span><span class="ident" id="3380081">isClient</span>&nbsp;<span class="op" id="3380090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380094">c</span><span class="op" id="3380095">.</span><span class="ident" id="3380096">handshakeErr</span>&nbsp;<span class="op" id="3380109">=</span>&nbsp;<span class="ident" id="3380111">c</span><span class="op" id="3380112">.</span><span class="ident" id="3380113">clientHandshake</span><span class="op" id="3380128">(</span><span class="op" id="3380129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380132">}</span>&nbsp;<span class="keyword" id="3380134">else</span>&nbsp;<span class="op" id="3380139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380143">c</span><span class="op" id="3380144">.</span><span class="ident" id="3380145">handshakeErr</span>&nbsp;<span class="op" id="3380158">=</span>&nbsp;<span class="ident" id="3380160">c</span><span class="op" id="3380161">.</span><span class="ident" id="3380162">serverHandshake</span><span class="op" id="3380177">(</span><span class="op" id="3380178">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380184">return</span>&nbsp;<span class="ident" id="3380191">c</span><span class="op" id="3380192">.</span><span class="ident" id="3380193">handshakeErr</span><br>
<span class="lineno"></span><span class="op" id="3380206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3380209">//&nbsp;ConnectionState&nbsp;returns&nbsp;basic&nbsp;TLS&nbsp;details&nbsp;about&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">985</span><span class="keyword" id="3380276">func</span>&nbsp;<span class="op" id="3380281">(</span><span class="ident" id="3380282">c</span>&nbsp;<span class="op" id="3380284">*</span><span class="ident" id="3380285">Conn</span><span class="op" id="3380289">)</span>&nbsp;<span class="ident" id="3380291">ConnectionState</span><span class="op" id="3380306">(</span><span class="op" id="3380307">)</span>&nbsp;<span class="ident" id="3380309">ConnectionState</span>&nbsp;<span class="op" id="3380325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380328">c</span><span class="op" id="3380329">.</span><span class="ident" id="3380330">handshakeMutex</span><span class="op" id="3380344">.</span><span class="ident" id="3380345">Lock</span><span class="op" id="3380349">(</span><span class="op" id="3380350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380353">defer</span>&nbsp;<span class="ident" id="3380359">c</span><span class="op" id="3380360">.</span><span class="ident" id="3380361">handshakeMutex</span><span class="op" id="3380375">.</span><span class="ident" id="3380376">Unlock</span><span class="op" id="3380382">(</span><span class="op" id="3380383">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380387">var</span>&nbsp;<span class="ident" id="3380391">state</span>&nbsp;<span class="ident" id="3380397">ConnectionState</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380414">state</span><span class="op" id="3380419">.</span><span class="ident" id="3380420">HandshakeComplete</span>&nbsp;<span class="op" id="3380438">=</span>&nbsp;<span class="ident" id="3380440">c</span><span class="op" id="3380441">.</span><span class="ident" id="3380442">handshakeComplete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380461">if</span>&nbsp;<span class="ident" id="3380464">c</span><span class="op" id="3380465">.</span><span class="ident" id="3380466">handshakeComplete</span>&nbsp;<span class="op" id="3380484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380488">state</span><span class="op" id="3380493">.</span><span class="ident" id="3380494">Version</span>&nbsp;<span class="op" id="3380502">=</span>&nbsp;<span class="ident" id="3380504">c</span><span class="op" id="3380505">.</span><span class="ident" id="3380506">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380513">state</span><span class="op" id="3380518">.</span><span class="ident" id="3380519">NegotiatedProtocol</span>&nbsp;<span class="op" id="3380538">=</span>&nbsp;<span class="ident" id="3380540">c</span><span class="op" id="3380541">.</span><span class="ident" id="3380542">clientProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380559">state</span><span class="op" id="3380564">.</span><span class="ident" id="3380565">DidResume</span>&nbsp;<span class="op" id="3380575">=</span>&nbsp;<span class="ident" id="3380577">c</span><span class="op" id="3380578">.</span><span class="ident" id="3380579">didResume</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380591">state</span><span class="op" id="3380596">.</span><span class="ident" id="3380597">NegotiatedProtocolIsMutual</span>&nbsp;<span class="op" id="3380624">=</span>&nbsp;<span class="op" id="3380626">!</span><span class="ident" id="3380627">c</span><span class="op" id="3380628">.</span><span class="ident" id="3380629">clientProtocolFallback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380654">state</span><span class="op" id="3380659">.</span><span class="ident" id="3380660">CipherSuite</span>&nbsp;<span class="op" id="3380672">=</span>&nbsp;<span class="ident" id="3380674">c</span><span class="op" id="3380675">.</span><span class="ident" id="3380676">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380690">state</span><span class="op" id="3380695">.</span><span class="ident" id="3380696">PeerCertificates</span>&nbsp;<span class="op" id="3380713">=</span>&nbsp;<span class="ident" id="3380715">c</span><span class="op" id="3380716">.</span><span class="ident" id="3380717">peerCertificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380736">state</span><span class="op" id="3380741">.</span><span class="ident" id="3380742">VerifiedChains</span>&nbsp;<span class="op" id="3380757">=</span>&nbsp;<span class="ident" id="3380759">c</span><span class="op" id="3380760">.</span><span class="ident" id="3380761">verifiedChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380778">state</span><span class="op" id="3380783">.</span><span class="ident" id="3380784">ServerName</span>&nbsp;<span class="op" id="3380795">=</span>&nbsp;<span class="ident" id="3380797">c</span><span class="op" id="3380798">.</span><span class="ident" id="3380799">serverName</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380812">if</span>&nbsp;<span class="op" id="3380815">!</span><span class="ident" id="3380816">c</span><span class="op" id="3380817">.</span><span class="ident" id="3380818">didResume</span>&nbsp;<span class="op" id="3380828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380833">state</span><span class="op" id="3380838">.</span><span class="ident" id="3380839">TLSUnique</span>&nbsp;<span class="op" id="3380849">=</span>&nbsp;<span class="ident" id="3380851">c</span><span class="op" id="3380852">.</span><span class="ident" id="3380853">firstFinished</span><span class="op" id="3380866">[</span><span class="op" id="3380867">:</span><span class="op" id="3380868">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380879">return</span>&nbsp;<span class="ident" id="3380886">state</span><br>
<span class="lineno"></span><span class="op" id="3380892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3380895">//&nbsp;OCSPResponse&nbsp;returns&nbsp;the&nbsp;stapled&nbsp;OCSP&nbsp;response&nbsp;from&nbsp;the&nbsp;TLS&nbsp;server,&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="3380969">//&nbsp;any.&nbsp;(Only&nbsp;valid&nbsp;for&nbsp;client&nbsp;connections.)</span><br>
<span class="lineno">1010</span><span class="keyword" id="3381014">func</span>&nbsp;<span class="op" id="3381019">(</span><span class="ident" id="3381020">c</span>&nbsp;<span class="op" id="3381022">*</span><span class="ident" id="3381023">Conn</span><span class="op" id="3381027">)</span>&nbsp;<span class="ident" id="3381029">OCSPResponse</span><span class="op" id="3381041">(</span><span class="op" id="3381042">)</span>&nbsp;<span class="op" id="3381044">[</span><span class="op" id="3381045">]</span><span class="builtintype" id="3381046">byte</span>&nbsp;<span class="op" id="3381051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381054">c</span><span class="op" id="3381055">.</span><span class="ident" id="3381056">handshakeMutex</span><span class="op" id="3381070">.</span><span class="ident" id="3381071">Lock</span><span class="op" id="3381075">(</span><span class="op" id="3381076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381079">defer</span>&nbsp;<span class="ident" id="3381085">c</span><span class="op" id="3381086">.</span><span class="ident" id="3381087">handshakeMutex</span><span class="op" id="3381101">.</span><span class="ident" id="3381102">Unlock</span><span class="op" id="3381108">(</span><span class="op" id="3381109">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381113">return</span>&nbsp;<span class="ident" id="3381120">c</span><span class="op" id="3381121">.</span><span class="ident" id="3381122">ocspResponse</span><br>
<span class="lineno">1015</span><span class="op" id="3381135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3381138">//&nbsp;VerifyHostname&nbsp;checks&nbsp;that&nbsp;the&nbsp;peer&nbsp;certificate&nbsp;chain&nbsp;is&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3381208">//&nbsp;connecting&nbsp;to&nbsp;host.&nbsp;&nbsp;If&nbsp;so,&nbsp;it&nbsp;returns&nbsp;nil;&nbsp;if&nbsp;not,&nbsp;it&nbsp;returns&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3381283">//&nbsp;describing&nbsp;the&nbsp;problem.</span><br>
<span class="lineno">1020</span><span class="keyword" id="3381310">func</span>&nbsp;<span class="op" id="3381315">(</span><span class="ident" id="3381316">c</span>&nbsp;<span class="op" id="3381318">*</span><span class="ident" id="3381319">Conn</span><span class="op" id="3381323">)</span>&nbsp;<span class="ident" id="3381325">VerifyHostname</span><span class="op" id="3381339">(</span><span class="ident" id="3381340">host</span>&nbsp;<span class="builtintype" id="3381345">string</span><span class="op" id="3381351">)</span>&nbsp;<span class="builtintype" id="3381353">error</span>&nbsp;<span class="op" id="3381359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381362">c</span><span class="op" id="3381363">.</span><span class="ident" id="3381364">handshakeMutex</span><span class="op" id="3381378">.</span><span class="ident" id="3381379">Lock</span><span class="op" id="3381383">(</span><span class="op" id="3381384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381387">defer</span>&nbsp;<span class="ident" id="3381393">c</span><span class="op" id="3381394">.</span><span class="ident" id="3381395">handshakeMutex</span><span class="op" id="3381409">.</span><span class="ident" id="3381410">Unlock</span><span class="op" id="3381416">(</span><span class="op" id="3381417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381420">if</span>&nbsp;<span class="op" id="3381423">!</span><span class="ident" id="3381424">c</span><span class="op" id="3381425">.</span><span class="ident" id="3381426">isClient</span>&nbsp;<span class="op" id="3381435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381439">return</span>&nbsp;<span class="ident" id="3381446">errors</span><span class="op" id="3381452">.</span><span class="ident" id="3381453">New</span><span class="op" id="3381456">(</span><span class="string" id="3381457">&#34;tls:&nbsp;VerifyHostname&nbsp;called&nbsp;on&nbsp;TLS&nbsp;server&nbsp;connection&#34;</span><span class="op" id="3381510">)</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381516">if</span>&nbsp;<span class="op" id="3381519">!</span><span class="ident" id="3381520">c</span><span class="op" id="3381521">.</span><span class="ident" id="3381522">handshakeComplete</span>&nbsp;<span class="op" id="3381540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381544">return</span>&nbsp;<span class="ident" id="3381551">errors</span><span class="op" id="3381557">.</span><span class="ident" id="3381558">New</span><span class="op" id="3381561">(</span><span class="string" id="3381562">&#34;tls:&nbsp;handshake&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;performed&#34;</span><span class="op" id="3381605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381611">return</span>&nbsp;<span class="ident" id="3381618">c</span><span class="op" id="3381619">.</span><span class="ident" id="3381620">peerCertificates</span><span class="op" id="3381636">[</span><span class="num" id="3381637">0</span><span class="op" id="3381638">]</span><span class="op" id="3381639">.</span><span class="ident" id="3381640">VerifyHostname</span><span class="op" id="3381654">(</span><span class="ident" id="3381655">host</span><span class="op" id="3381659">)</span><br>
<span class="lineno">1030</span><span class="op" id="3381661">}</span>
</div>
</body>
</html>
