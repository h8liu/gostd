<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1430464">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1430519">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1430573">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1430624">//&nbsp;Package&nbsp;sync&nbsp;provides&nbsp;basic&nbsp;synchronization&nbsp;primitives&nbsp;such&nbsp;as&nbsp;mutual</span><br>
<span class="lineno"></span><span class="comment" id="1430697">//&nbsp;exclusion&nbsp;locks.&nbsp;&nbsp;Other&nbsp;than&nbsp;the&nbsp;Once&nbsp;and&nbsp;WaitGroup&nbsp;types,&nbsp;most&nbsp;are&nbsp;intended</span><br>
<span class="lineno"></span><span class="comment" id="1430777">//&nbsp;for&nbsp;use&nbsp;by&nbsp;low-level&nbsp;library&nbsp;routines.&nbsp;&nbsp;Higher-level&nbsp;synchronization&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1430852">//&nbsp;better&nbsp;done&nbsp;via&nbsp;channels&nbsp;and&nbsp;communication.</span><br>
<span class="lineno"></span><span class="comment" id="1430899">//</span><br>
<span class="lineno">10</span><span class="comment" id="1430902">//&nbsp;Values&nbsp;containing&nbsp;the&nbsp;types&nbsp;defined&nbsp;in&nbsp;this&nbsp;package&nbsp;should&nbsp;not&nbsp;be&nbsp;copied.</span><br>
<span class="lineno"></span><span class="keyword" id="1430979">package</span>&nbsp;<span class="ident" id="1430987">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1430993">import</span>&nbsp;<span class="op" id="1431000">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1431003">&#34;sync/atomic&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1431018">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1431027">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1431030">//&nbsp;A&nbsp;Mutex&nbsp;is&nbsp;a&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1431069">//&nbsp;Mutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures;</span><br>
<span class="lineno">20</span><span class="comment" id="1431124">//&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;Mutex&nbsp;is&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1431176">type</span>&nbsp;<span class="ident" id="1431181">Mutex</span>&nbsp;<span class="keyword" id="1431187">struct</span>&nbsp;<span class="op" id="1431194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431197">state</span>&nbsp;<span class="builtintype" id="1431203">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431210">sema</span>&nbsp;&nbsp;<span class="builtintype" id="1431216">uint32</span><br>
<span class="lineno"></span><span class="op" id="1431223">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="1431226">//&nbsp;A&nbsp;Locker&nbsp;represents&nbsp;an&nbsp;object&nbsp;that&nbsp;can&nbsp;be&nbsp;locked&nbsp;and&nbsp;unlocked.</span><br>
<span class="lineno"></span><span class="keyword" id="1431292">type</span>&nbsp;<span class="ident" id="1431297">Locker</span>&nbsp;<span class="keyword" id="1431304">interface</span>&nbsp;<span class="op" id="1431314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431317">Lock</span><span class="op" id="1431321">(</span><span class="op" id="1431322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431325">Unlock</span><span class="op" id="1431331">(</span><span class="op" id="1431332">)</span><br>
<span class="lineno">30</span><span class="op" id="1431334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1431337">const</span>&nbsp;<span class="op" id="1431343">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431346">mutexLocked</span>&nbsp;<span class="op" id="1431358">=</span>&nbsp;<span class="num" id="1431360">1</span>&nbsp;<span class="op" id="1431362">&lt;&lt;</span>&nbsp;<span class="ident" id="1431365">iota</span>&nbsp;<span class="comment" id="1431370">//&nbsp;mutex&nbsp;is&nbsp;locked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431390">mutexWoken</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431402">mutexWaiterShift</span>&nbsp;<span class="op" id="1431419">=</span>&nbsp;<span class="ident" id="1431421">iota</span><br>
<span class="lineno"></span><span class="op" id="1431426">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1431429">//&nbsp;Lock&nbsp;locks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1431446">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;in&nbsp;use,&nbsp;the&nbsp;calling&nbsp;goroutine</span><br>
<span class="lineno">40</span><span class="comment" id="1431502">//&nbsp;blocks&nbsp;until&nbsp;the&nbsp;mutex&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1431542">func</span>&nbsp;<span class="op" id="1431547">(</span><span class="ident" id="1431548">m</span>&nbsp;<span class="op" id="1431550">*</span><span class="ident" id="1431551">Mutex</span><span class="op" id="1431556">)</span>&nbsp;<span class="ident" id="1431558">Lock</span><span class="op" id="1431562">(</span><span class="op" id="1431563">)</span>&nbsp;<span class="op" id="1431565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1431568">//&nbsp;Fast&nbsp;path:&nbsp;grab&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431604">if</span>&nbsp;<span class="ident" id="1431607">atomic</span><span class="op" id="1431613">.</span><span class="ident" id="1431614">CompareAndSwapInt32</span><span class="op" id="1431633">(</span><span class="op" id="1431634">&amp;</span><span class="ident" id="1431635">m</span><span class="op" id="1431636">.</span><span class="ident" id="1431637">state</span><span class="op" id="1431642">,</span>&nbsp;<span class="num" id="1431644">0</span><span class="op" id="1431645">,</span>&nbsp;<span class="ident" id="1431647">mutexLocked</span><span class="op" id="1431658">)</span>&nbsp;<span class="op" id="1431660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431664">if</span>&nbsp;<span class="ident" id="1431667">raceenabled</span>&nbsp;<span class="op" id="1431679">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431684">raceAcquire</span><span class="op" id="1431695">(</span><span class="ident" id="1431696">unsafe</span><span class="op" id="1431702">.</span><span class="ident" id="1431703">Pointer</span><span class="op" id="1431710">(</span><span class="ident" id="1431711">m</span><span class="op" id="1431712">)</span><span class="op" id="1431713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1431717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431721">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1431729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431733">awoke</span>&nbsp;<span class="op" id="1431739">:=</span>&nbsp;<span class="ident" id="1431742">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431749">for</span>&nbsp;<span class="op" id="1431753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431757">old</span>&nbsp;<span class="op" id="1431761">:=</span>&nbsp;<span class="ident" id="1431764">m</span><span class="op" id="1431765">.</span><span class="ident" id="1431766">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1431774">new</span>&nbsp;<span class="op" id="1431778">:=</span>&nbsp;<span class="ident" id="1431781">old</span>&nbsp;<span class="op" id="1431785">|</span>&nbsp;<span class="ident" id="1431787">mutexLocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431801">if</span>&nbsp;<span class="ident" id="1431804">old</span><span class="op" id="1431807">&amp;</span><span class="ident" id="1431808">mutexLocked</span>&nbsp;<span class="op" id="1431820">!=</span>&nbsp;<span class="num" id="1431823">0</span>&nbsp;<span class="op" id="1431825">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1431830">new</span>&nbsp;<span class="op" id="1431834">=</span>&nbsp;<span class="ident" id="1431836">old</span>&nbsp;<span class="op" id="1431840">+</span>&nbsp;<span class="num" id="1431842">1</span><span class="op" id="1431843">&lt;&lt;</span><span class="ident" id="1431845">mutexWaiterShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1431864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431868">if</span>&nbsp;<span class="ident" id="1431871">awoke</span>&nbsp;<span class="op" id="1431877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1431882">//&nbsp;The&nbsp;goroutine&nbsp;has&nbsp;been&nbsp;woken&nbsp;from&nbsp;sleep,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1431929">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;reset&nbsp;the&nbsp;flag&nbsp;in&nbsp;either&nbsp;case.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1431980">new</span>&nbsp;<span class="op" id="1431984">&amp;^=</span>&nbsp;<span class="ident" id="1431988">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432005">if</span>&nbsp;<span class="ident" id="1432008">atomic</span><span class="op" id="1432014">.</span><span class="ident" id="1432015">CompareAndSwapInt32</span><span class="op" id="1432034">(</span><span class="op" id="1432035">&amp;</span><span class="ident" id="1432036">m</span><span class="op" id="1432037">.</span><span class="ident" id="1432038">state</span><span class="op" id="1432043">,</span>&nbsp;<span class="ident" id="1432045">old</span><span class="op" id="1432048">,</span>&nbsp;<span class="builtinfunc" id="1432050">new</span><span class="op" id="1432053">)</span>&nbsp;<span class="op" id="1432055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432060">if</span>&nbsp;<span class="ident" id="1432063">old</span><span class="op" id="1432066">&amp;</span><span class="ident" id="1432067">mutexLocked</span>&nbsp;<span class="op" id="1432079">==</span>&nbsp;<span class="num" id="1432082">0</span>&nbsp;<span class="op" id="1432084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432090">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432104">runtime_Semacquire</span><span class="op" id="1432122">(</span><span class="op" id="1432123">&amp;</span><span class="ident" id="1432124">m</span><span class="op" id="1432125">.</span><span class="ident" id="1432126">sema</span><span class="op" id="1432130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432135">awoke</span>&nbsp;<span class="op" id="1432141">=</span>&nbsp;<span class="ident" id="1432143">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432153">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432157">if</span>&nbsp;<span class="ident" id="1432160">raceenabled</span>&nbsp;<span class="op" id="1432172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432176">raceAcquire</span><span class="op" id="1432187">(</span><span class="ident" id="1432188">unsafe</span><span class="op" id="1432194">.</span><span class="ident" id="1432195">Pointer</span><span class="op" id="1432202">(</span><span class="ident" id="1432203">m</span><span class="op" id="1432204">)</span><span class="op" id="1432205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432208">}</span><br>
<span class="lineno"></span><span class="op" id="1432210">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="1432213">//&nbsp;Unlock&nbsp;unlocks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1432234">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;m&nbsp;is&nbsp;not&nbsp;locked&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1432299">//</span><br>
<span class="lineno"></span><span class="comment" id="1432302">//&nbsp;A&nbsp;locked&nbsp;Mutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular&nbsp;goroutine.</span><br>
<span class="lineno">80</span><span class="comment" id="1432367">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;for&nbsp;one&nbsp;goroutine&nbsp;to&nbsp;lock&nbsp;a&nbsp;Mutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1432427">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;unlock&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1432474">func</span>&nbsp;<span class="op" id="1432479">(</span><span class="ident" id="1432480">m</span>&nbsp;<span class="op" id="1432482">*</span><span class="ident" id="1432483">Mutex</span><span class="op" id="1432488">)</span>&nbsp;<span class="ident" id="1432490">Unlock</span><span class="op" id="1432496">(</span><span class="op" id="1432497">)</span>&nbsp;<span class="op" id="1432499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432502">if</span>&nbsp;<span class="ident" id="1432505">raceenabled</span>&nbsp;<span class="op" id="1432517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432521">_</span>&nbsp;<span class="op" id="1432523">=</span>&nbsp;<span class="ident" id="1432525">m</span><span class="op" id="1432526">.</span><span class="ident" id="1432527">state</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432535">raceRelease</span><span class="op" id="1432546">(</span><span class="ident" id="1432547">unsafe</span><span class="op" id="1432553">.</span><span class="ident" id="1432554">Pointer</span><span class="op" id="1432561">(</span><span class="ident" id="1432562">m</span><span class="op" id="1432563">)</span><span class="op" id="1432564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1432571">//&nbsp;Fast&nbsp;path:&nbsp;drop&nbsp;lock&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1432601">new</span>&nbsp;<span class="op" id="1432605">:=</span>&nbsp;<span class="ident" id="1432608">atomic</span><span class="op" id="1432614">.</span><span class="ident" id="1432615">AddInt32</span><span class="op" id="1432623">(</span><span class="op" id="1432624">&amp;</span><span class="ident" id="1432625">m</span><span class="op" id="1432626">.</span><span class="ident" id="1432627">state</span><span class="op" id="1432632">,</span>&nbsp;<span class="op" id="1432634">-</span><span class="ident" id="1432635">mutexLocked</span><span class="op" id="1432646">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432649">if</span>&nbsp;<span class="op" id="1432652">(</span><span class="builtinfunc" id="1432653">new</span><span class="op" id="1432656">+</span><span class="ident" id="1432657">mutexLocked</span><span class="op" id="1432668">)</span><span class="op" id="1432669">&amp;</span><span class="ident" id="1432670">mutexLocked</span>&nbsp;<span class="op" id="1432682">==</span>&nbsp;<span class="num" id="1432685">0</span>&nbsp;<span class="op" id="1432687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1432691">panic</span><span class="op" id="1432696">(</span><span class="string" id="1432697">&#34;sync:&nbsp;unlock&nbsp;of&nbsp;unlocked&nbsp;mutex&#34;</span><span class="op" id="1432729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432736">old</span>&nbsp;<span class="op" id="1432740">:=</span>&nbsp;<span class="builtinfunc" id="1432743">new</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432748">for</span>&nbsp;<span class="op" id="1432752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1432756">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;waiters&nbsp;or&nbsp;a&nbsp;goroutine&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1432812">//&nbsp;been&nbsp;woken&nbsp;or&nbsp;grabbed&nbsp;the&nbsp;lock,&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;anyone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432873">if</span>&nbsp;<span class="ident" id="1432876">old</span><span class="op" id="1432879">&gt;&gt;</span><span class="ident" id="1432881">mutexWaiterShift</span>&nbsp;<span class="op" id="1432898">==</span>&nbsp;<span class="num" id="1432901">0</span>&nbsp;<span class="op" id="1432903">||</span>&nbsp;<span class="ident" id="1432906">old</span><span class="op" id="1432909">&amp;</span><span class="op" id="1432910">(</span><span class="ident" id="1432911">mutexLocked</span><span class="op" id="1432922">|</span><span class="ident" id="1432923">mutexWoken</span><span class="op" id="1432933">)</span>&nbsp;<span class="op" id="1432935">!=</span>&nbsp;<span class="num" id="1432938">0</span>&nbsp;<span class="op" id="1432940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432945">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1432958">//&nbsp;Grab&nbsp;the&nbsp;right&nbsp;to&nbsp;wake&nbsp;someone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1432995">new</span>&nbsp;<span class="op" id="1432999">=</span>&nbsp;<span class="op" id="1433001">(</span><span class="ident" id="1433002">old</span>&nbsp;<span class="op" id="1433006">-</span>&nbsp;<span class="num" id="1433008">1</span><span class="op" id="1433009">&lt;&lt;</span><span class="ident" id="1433011">mutexWaiterShift</span><span class="op" id="1433027">)</span>&nbsp;<span class="op" id="1433029">|</span>&nbsp;<span class="ident" id="1433031">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433044">if</span>&nbsp;<span class="ident" id="1433047">atomic</span><span class="op" id="1433053">.</span><span class="ident" id="1433054">CompareAndSwapInt32</span><span class="op" id="1433073">(</span><span class="op" id="1433074">&amp;</span><span class="ident" id="1433075">m</span><span class="op" id="1433076">.</span><span class="ident" id="1433077">state</span><span class="op" id="1433082">,</span>&nbsp;<span class="ident" id="1433084">old</span><span class="op" id="1433087">,</span>&nbsp;<span class="builtinfunc" id="1433089">new</span><span class="op" id="1433092">)</span>&nbsp;<span class="op" id="1433094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433099">runtime_Semrelease</span><span class="op" id="1433117">(</span><span class="op" id="1433118">&amp;</span><span class="ident" id="1433119">m</span><span class="op" id="1433120">.</span><span class="ident" id="1433121">sema</span><span class="op" id="1433125">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433130">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1433139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433143">old</span>&nbsp;<span class="op" id="1433147">=</span>&nbsp;<span class="ident" id="1433149">m</span><span class="op" id="1433150">.</span><span class="ident" id="1433151">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1433158">}</span><br>
<span class="lineno"></span><span class="op" id="1433160">}</span>
</div>
</body>
</html>
