<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/bzip2</h2>
<ul>
<li><a href="/gostd/compress/bzip2/bit_reader.go.html">bit_reader.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2.go.html">bzip2.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2_test.go.html">bzip2_test.go</a></li>
<li><a href="/gostd/compress/bzip2/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/compress/bzip2/move_to_front.go.html">move_to_front.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6368425">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6368480">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6368534">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6368585">//&nbsp;Package&nbsp;bzip2&nbsp;implements&nbsp;bzip2&nbsp;decompression.</span><br>
<span class="lineno"></span><span class="keyword" id="6368634">package</span>&nbsp;<span class="ident" id="6368642">bzip2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6368649">import</span>&nbsp;<span class="string" id="6368656">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="6368662">//&nbsp;There&#39;s&nbsp;no&nbsp;RFC&nbsp;for&nbsp;bzip2.&nbsp;I&nbsp;used&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for&nbsp;reference&nbsp;and&nbsp;a&nbsp;lot</span><br>
<span class="lineno"></span><span class="comment" id="6368741">//&nbsp;of&nbsp;guessing:&nbsp;http://en.wikipedia.org/wiki/Bzip2</span><br>
<span class="lineno"></span><span class="comment" id="6368792">//&nbsp;The&nbsp;source&nbsp;code&nbsp;to&nbsp;pyflate&nbsp;was&nbsp;useful&nbsp;for&nbsp;debugging:</span><br>
<span class="lineno"></span><span class="comment" id="6368848">//&nbsp;http://www.paul.sladen.org/projects/pyflate</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="6368896">//&nbsp;A&nbsp;StructuralError&nbsp;is&nbsp;returned&nbsp;when&nbsp;the&nbsp;bzip2&nbsp;data&nbsp;is&nbsp;found&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6368964">//&nbsp;syntactically&nbsp;invalid.</span><br>
<span class="lineno"></span><span class="keyword" id="6368990">type</span>&nbsp;<span class="ident" id="6368995">StructuralError</span>&nbsp;<span class="builtintype" id="6369011">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6369019">func</span>&nbsp;<span class="op" id="6369024">(</span><span class="ident" id="6369025">s</span>&nbsp;<span class="ident" id="6369027">StructuralError</span><span class="op" id="6369042">)</span>&nbsp;<span class="ident" id="6369044">Error</span><span class="op" id="6369049">(</span><span class="op" id="6369050">)</span>&nbsp;<span class="builtintype" id="6369052">string</span>&nbsp;<span class="op" id="6369059">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6369062">return</span>&nbsp;<span class="string" id="6369069">&#34;bzip2&nbsp;data&nbsp;invalid:&nbsp;&#34;</span>&nbsp;<span class="op" id="6369092">+</span>&nbsp;<span class="builtintype" id="6369094">string</span><span class="op" id="6369100">(</span><span class="ident" id="6369101">s</span><span class="op" id="6369102">)</span><br>
<span class="lineno"></span><span class="op" id="6369104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6369107">//&nbsp;A&nbsp;reader&nbsp;decompresses&nbsp;bzip2&nbsp;compressed&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6369155">type</span>&nbsp;<span class="ident" id="6369160">reader</span>&nbsp;<span class="keyword" id="6369167">struct</span>&nbsp;<span class="op" id="6369174">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369177">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6369190">bitReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369201">fileCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6369214">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369222">blockCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6369235">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369243">wantBlockCRC</span>&nbsp;<span class="builtintype" id="6369256">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369264">setupDone</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6369277">bool</span>&nbsp;<span class="comment" id="6369282">//&nbsp;true&nbsp;if&nbsp;we&nbsp;have&nbsp;parsed&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369327">blockSize</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6369340">int</span>&nbsp;&nbsp;<span class="comment" id="6369345">//&nbsp;blockSize&nbsp;in&nbsp;bytes,&nbsp;i.e.&nbsp;900&nbsp;*&nbsp;1024.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369386">eof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6369399">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369405">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6369418">[</span><span class="op" id="6369419">]</span><span class="builtintype" id="6369420">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6369428">//&nbsp;stores&nbsp;Burrows-Wheeler&nbsp;transformed&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369473">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6369486">[</span><span class="num" id="6369487">256</span><span class="op" id="6369490">]</span><span class="builtintype" id="6369491">uint</span>&nbsp;<span class="comment" id="6369496">//&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;for&nbsp;the&nbsp;inverse&nbsp;BWT.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369535">tt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6369548">[</span><span class="op" id="6369549">]</span><span class="builtintype" id="6369550">uint32</span>&nbsp;&nbsp;<span class="comment" id="6369558">//&nbsp;mirrors&nbsp;the&nbsp;`tt&#39;&nbsp;array&nbsp;in&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;and&nbsp;contains&nbsp;the&nbsp;P&nbsp;array&nbsp;in&nbsp;the&nbsp;upper&nbsp;24&nbsp;bits.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369652">tPos</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6369665">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6369675">//&nbsp;Index&nbsp;of&nbsp;the&nbsp;next&nbsp;output&nbsp;byte&nbsp;in&nbsp;tt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369717">preRLE</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6369729">[</span><span class="op" id="6369730">]</span><span class="builtintype" id="6369731">uint32</span>&nbsp;<span class="comment" id="6369738">//&nbsp;contains&nbsp;the&nbsp;RLE&nbsp;data&nbsp;still&nbsp;to&nbsp;be&nbsp;processed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369787">preRLEUsed</span>&nbsp;&nbsp;<span class="builtintype" id="6369799">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6369808">//&nbsp;number&nbsp;of&nbsp;entries&nbsp;of&nbsp;preRLE&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369846">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6369858">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6369867">//&nbsp;the&nbsp;last&nbsp;byte&nbsp;value&nbsp;seen.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369897">byteRepeats</span>&nbsp;<span class="builtintype" id="6369909">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6369918">//&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;lastByte&nbsp;seen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369962">repeats</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6369974">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6369983">//&nbsp;the&nbsp;number&nbsp;of&nbsp;copies&nbsp;of&nbsp;lastByte&nbsp;to&nbsp;output.</span><br>
<span class="lineno"></span><span class="op" id="6370030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6370033">//&nbsp;NewReader&nbsp;returns&nbsp;an&nbsp;io.Reader&nbsp;which&nbsp;decompresses&nbsp;bzip2&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">45</span><span class="comment" id="6370105">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="6370152">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="6370214">func</span>&nbsp;<span class="ident" id="6370219">NewReader</span><span class="op" id="6370228">(</span><span class="ident" id="6370229">r</span>&nbsp;<span class="ident" id="6370231">io</span><span class="op" id="6370233">.</span><span class="ident" id="6370234">Reader</span><span class="op" id="6370240">)</span>&nbsp;<span class="ident" id="6370242">io</span><span class="op" id="6370244">.</span><span class="ident" id="6370245">Reader</span>&nbsp;<span class="op" id="6370252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6370255">bz2</span>&nbsp;<span class="op" id="6370259">:=</span>&nbsp;<span class="builtinfunc" id="6370262">new</span><span class="op" id="6370265">(</span><span class="ident" id="6370266">reader</span><span class="op" id="6370272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6370275">bz2</span><span class="op" id="6370278">.</span><span class="ident" id="6370279">br</span>&nbsp;<span class="op" id="6370282">=</span>&nbsp;<span class="ident" id="6370284">newBitReader</span><span class="op" id="6370296">(</span><span class="ident" id="6370297">r</span><span class="op" id="6370298">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370301">return</span>&nbsp;<span class="ident" id="6370308">bz2</span><br>
<span class="lineno"></span><span class="op" id="6370312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6370315">const</span>&nbsp;<span class="ident" id="6370321">bzip2FileMagic</span>&nbsp;<span class="op" id="6370336">=</span>&nbsp;<span class="num" id="6370338">0x425a</span>&nbsp;<span class="comment" id="6370345">//&nbsp;&#34;BZ&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="6370353">const</span>&nbsp;<span class="ident" id="6370359">bzip2BlockMagic</span>&nbsp;<span class="op" id="6370375">=</span>&nbsp;<span class="num" id="6370377">0x314159265359</span><br>
<span class="lineno">55</span><span class="keyword" id="6370392">const</span>&nbsp;<span class="ident" id="6370398">bzip2FinalMagic</span>&nbsp;<span class="op" id="6370414">=</span>&nbsp;<span class="num" id="6370416">0x177245385090</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6370432">//&nbsp;setup&nbsp;parses&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="6370466">func</span>&nbsp;<span class="op" id="6370471">(</span><span class="ident" id="6370472">bz2</span>&nbsp;<span class="op" id="6370476">*</span><span class="ident" id="6370477">reader</span><span class="op" id="6370483">)</span>&nbsp;<span class="ident" id="6370485">setup</span><span class="op" id="6370490">(</span><span class="ident" id="6370491">needMagic</span>&nbsp;<span class="builtintype" id="6370501">bool</span><span class="op" id="6370505">)</span>&nbsp;<span class="builtintype" id="6370507">error</span>&nbsp;<span class="op" id="6370513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6370516">br</span>&nbsp;<span class="op" id="6370519">:=</span>&nbsp;<span class="op" id="6370522">&amp;</span><span class="ident" id="6370523">bz2</span><span class="op" id="6370526">.</span><span class="ident" id="6370527">br</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370532">if</span>&nbsp;<span class="ident" id="6370535">needMagic</span>&nbsp;<span class="op" id="6370545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6370549">magic</span>&nbsp;<span class="op" id="6370555">:=</span>&nbsp;<span class="ident" id="6370558">br</span><span class="op" id="6370560">.</span><span class="ident" id="6370561">ReadBits</span><span class="op" id="6370569">(</span><span class="num" id="6370570">16</span><span class="op" id="6370572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370576">if</span>&nbsp;<span class="ident" id="6370579">magic</span>&nbsp;<span class="op" id="6370585">!=</span>&nbsp;<span class="ident" id="6370588">bzip2FileMagic</span>&nbsp;<span class="op" id="6370603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370608">return</span>&nbsp;<span class="ident" id="6370615">StructuralError</span><span class="op" id="6370630">(</span><span class="string" id="6370631">&#34;bad&nbsp;magic&nbsp;value&#34;</span><span class="op" id="6370648">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6370652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6370655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6370659">t</span>&nbsp;<span class="op" id="6370661">:=</span>&nbsp;<span class="ident" id="6370664">br</span><span class="op" id="6370666">.</span><span class="ident" id="6370667">ReadBits</span><span class="op" id="6370675">(</span><span class="num" id="6370676">8</span><span class="op" id="6370677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370680">if</span>&nbsp;<span class="ident" id="6370683">t</span>&nbsp;<span class="op" id="6370685">!=</span>&nbsp;<span class="string" id="6370688">&#39;h&#39;</span>&nbsp;<span class="op" id="6370692">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370696">return</span>&nbsp;<span class="ident" id="6370703">StructuralError</span><span class="op" id="6370718">(</span><span class="string" id="6370719">&#34;non-Huffman&nbsp;entropy&nbsp;encoding&#34;</span><span class="op" id="6370749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6370752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6370756">level</span>&nbsp;<span class="op" id="6370762">:=</span>&nbsp;<span class="ident" id="6370765">br</span><span class="op" id="6370767">.</span><span class="ident" id="6370768">ReadBits</span><span class="op" id="6370776">(</span><span class="num" id="6370777">8</span><span class="op" id="6370778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370781">if</span>&nbsp;<span class="ident" id="6370784">level</span>&nbsp;<span class="op" id="6370790">&lt;</span>&nbsp;<span class="string" id="6370792">&#39;1&#39;</span>&nbsp;<span class="op" id="6370796">||</span>&nbsp;<span class="ident" id="6370799">level</span>&nbsp;<span class="op" id="6370805">&gt;</span>&nbsp;<span class="string" id="6370807">&#39;9&#39;</span>&nbsp;<span class="op" id="6370811">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370815">return</span>&nbsp;<span class="ident" id="6370822">StructuralError</span><span class="op" id="6370837">(</span><span class="string" id="6370838">&#34;invalid&nbsp;compression&nbsp;level&#34;</span><span class="op" id="6370865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6370868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6370872">bz2</span><span class="op" id="6370875">.</span><span class="ident" id="6370876">fileCRC</span>&nbsp;<span class="op" id="6370884">=</span>&nbsp;<span class="num" id="6370886">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6370889">bz2</span><span class="op" id="6370892">.</span><span class="ident" id="6370893">blockSize</span>&nbsp;<span class="op" id="6370903">=</span>&nbsp;<span class="num" id="6370905">100</span>&nbsp;<span class="op" id="6370909">*</span>&nbsp;<span class="num" id="6370911">1024</span>&nbsp;<span class="op" id="6370916">*</span>&nbsp;<span class="op" id="6370918">(</span><span class="builtintype" id="6370919">int</span><span class="op" id="6370922">(</span><span class="ident" id="6370923">level</span><span class="op" id="6370928">)</span>&nbsp;<span class="op" id="6370930">-</span>&nbsp;<span class="string" id="6370932">&#39;0&#39;</span><span class="op" id="6370935">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370938">if</span>&nbsp;<span class="ident" id="6370941">bz2</span><span class="op" id="6370944">.</span><span class="ident" id="6370945">blockSize</span>&nbsp;<span class="op" id="6370955">&gt;</span>&nbsp;<span class="builtinfunc" id="6370957">len</span><span class="op" id="6370960">(</span><span class="ident" id="6370961">bz2</span><span class="op" id="6370964">.</span><span class="ident" id="6370965">tt</span><span class="op" id="6370967">)</span>&nbsp;<span class="op" id="6370969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6370973">bz2</span><span class="op" id="6370976">.</span><span class="ident" id="6370977">tt</span>&nbsp;<span class="op" id="6370980">=</span>&nbsp;<span class="builtinfunc" id="6370982">make</span><span class="op" id="6370986">(</span><span class="op" id="6370987">[</span><span class="op" id="6370988">]</span><span class="builtintype" id="6370989">uint32</span><span class="op" id="6370995">,</span>&nbsp;<span class="ident" id="6370997">bz2</span><span class="op" id="6371000">.</span><span class="ident" id="6371001">blockSize</span><span class="op" id="6371010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6371013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6371016">return</span>&nbsp;<span class="ident" id="6371023">nil</span><br>
<span class="lineno"></span><span class="op" id="6371027">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="6371030">func</span>&nbsp;<span class="op" id="6371035">(</span><span class="ident" id="6371036">bz2</span>&nbsp;<span class="op" id="6371040">*</span><span class="ident" id="6371041">reader</span><span class="op" id="6371047">)</span>&nbsp;<span class="ident" id="6371049">Read</span><span class="op" id="6371053">(</span><span class="ident" id="6371054">buf</span>&nbsp;<span class="op" id="6371058">[</span><span class="op" id="6371059">]</span><span class="builtintype" id="6371060">byte</span><span class="op" id="6371064">)</span>&nbsp;<span class="op" id="6371066">(</span><span class="ident" id="6371067">n</span>&nbsp;<span class="builtintype" id="6371069">int</span><span class="op" id="6371072">,</span>&nbsp;<span class="ident" id="6371074">err</span>&nbsp;<span class="builtintype" id="6371078">error</span><span class="op" id="6371083">)</span>&nbsp;<span class="op" id="6371085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6371088">if</span>&nbsp;<span class="ident" id="6371091">bz2</span><span class="op" id="6371094">.</span><span class="ident" id="6371095">eof</span>&nbsp;<span class="op" id="6371099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6371103">return</span>&nbsp;<span class="num" id="6371110">0</span><span class="op" id="6371111">,</span>&nbsp;<span class="ident" id="6371113">io</span><span class="op" id="6371115">.</span><span class="ident" id="6371116">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6371121">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6371125">if</span>&nbsp;<span class="op" id="6371128">!</span><span class="ident" id="6371129">bz2</span><span class="op" id="6371132">.</span><span class="ident" id="6371133">setupDone</span>&nbsp;<span class="op" id="6371143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6371147">err</span>&nbsp;<span class="op" id="6371151">=</span>&nbsp;<span class="ident" id="6371153">bz2</span><span class="op" id="6371156">.</span><span class="ident" id="6371157">setup</span><span class="op" id="6371162">(</span><span class="builtintype" id="6371163">true</span><span class="op" id="6371167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6371171">brErr</span>&nbsp;<span class="op" id="6371177">:=</span>&nbsp;<span class="ident" id="6371180">bz2</span><span class="op" id="6371183">.</span><span class="ident" id="6371184">br</span><span class="op" id="6371186">.</span><span class="ident" id="6371187">Err</span><span class="op" id="6371190">(</span><span class="op" id="6371191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6371195">if</span>&nbsp;<span class="ident" id="6371198">brErr</span>&nbsp;<span class="op" id="6371204">!=</span>&nbsp;<span class="ident" id="6371207">nil</span>&nbsp;<span class="op" id="6371211">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6371216">err</span>&nbsp;<span class="op" id="6371220">=</span>&nbsp;<span class="ident" id="6371222">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6371230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6371234">if</span>&nbsp;<span class="ident" id="6371237">err</span>&nbsp;<span class="op" id="6371241">!=</span>&nbsp;<span class="ident" id="6371244">nil</span>&nbsp;<span class="op" id="6371248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6371253">return</span>&nbsp;<span class="num" id="6371260">0</span><span class="op" id="6371261">,</span>&nbsp;<span class="ident" id="6371263">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6371269">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6371273">bz2</span><span class="op" id="6371276">.</span><span class="ident" id="6371277">setupDone</span>&nbsp;<span class="op" id="6371287">=</span>&nbsp;<span class="builtintype" id="6371289">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6371295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6371299">n</span><span class="op" id="6371300">,</span>&nbsp;<span class="ident" id="6371302">err</span>&nbsp;<span class="op" id="6371306">=</span>&nbsp;<span class="ident" id="6371308">bz2</span><span class="op" id="6371311">.</span><span class="ident" id="6371312">read</span><span class="op" id="6371316">(</span><span class="ident" id="6371317">buf</span><span class="op" id="6371320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6371323">brErr</span>&nbsp;<span class="op" id="6371329">:=</span>&nbsp;<span class="ident" id="6371332">bz2</span><span class="op" id="6371335">.</span><span class="ident" id="6371336">br</span><span class="op" id="6371338">.</span><span class="ident" id="6371339">Err</span><span class="op" id="6371342">(</span><span class="op" id="6371343">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6371346">if</span>&nbsp;<span class="ident" id="6371349">brErr</span>&nbsp;<span class="op" id="6371355">!=</span>&nbsp;<span class="ident" id="6371358">nil</span>&nbsp;<span class="op" id="6371362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6371366">err</span>&nbsp;<span class="op" id="6371370">=</span>&nbsp;<span class="ident" id="6371372">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6371379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6371382">return</span><br>
<span class="lineno"></span><span class="op" id="6371389">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="6371392">func</span>&nbsp;<span class="op" id="6371397">(</span><span class="ident" id="6371398">bz2</span>&nbsp;<span class="op" id="6371402">*</span><span class="ident" id="6371403">reader</span><span class="op" id="6371409">)</span>&nbsp;<span class="ident" id="6371411">readFromBlock</span><span class="op" id="6371424">(</span><span class="ident" id="6371425">buf</span>&nbsp;<span class="op" id="6371429">[</span><span class="op" id="6371430">]</span><span class="builtintype" id="6371431">byte</span><span class="op" id="6371435">)</span>&nbsp;<span class="builtintype" id="6371437">int</span>&nbsp;<span class="op" id="6371441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371444">//&nbsp;bzip2&nbsp;is&nbsp;a&nbsp;block&nbsp;based&nbsp;compressor,&nbsp;except&nbsp;that&nbsp;it&nbsp;has&nbsp;a&nbsp;run-length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371515">//&nbsp;preprocessing&nbsp;step.&nbsp;The&nbsp;block&nbsp;based&nbsp;nature&nbsp;means&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371580">//&nbsp;preallocate&nbsp;fixed-size&nbsp;buffers&nbsp;and&nbsp;reuse&nbsp;them.&nbsp;However,&nbsp;the&nbsp;RLE</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371648">//&nbsp;preprocessing&nbsp;would&nbsp;require&nbsp;allocating&nbsp;huge&nbsp;buffers&nbsp;to&nbsp;store&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371717">//&nbsp;maximum&nbsp;expansion.&nbsp;Thus&nbsp;we&nbsp;process&nbsp;blocks&nbsp;all&nbsp;at&nbsp;once,&nbsp;except&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371787">//&nbsp;the&nbsp;RLE&nbsp;which&nbsp;we&nbsp;decompress&nbsp;as&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6371832">n</span>&nbsp;<span class="op" id="6371834">:=</span>&nbsp;<span class="num" id="6371837">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6371840">for</span>&nbsp;<span class="op" id="6371844">(</span><span class="ident" id="6371845">bz2</span><span class="op" id="6371848">.</span><span class="ident" id="6371849">repeats</span>&nbsp;<span class="op" id="6371857">&gt;</span>&nbsp;<span class="num" id="6371859">0</span>&nbsp;<span class="op" id="6371861">||</span>&nbsp;<span class="ident" id="6371864">bz2</span><span class="op" id="6371867">.</span><span class="ident" id="6371868">preRLEUsed</span>&nbsp;<span class="op" id="6371879">&lt;</span>&nbsp;<span class="builtinfunc" id="6371881">len</span><span class="op" id="6371884">(</span><span class="ident" id="6371885">bz2</span><span class="op" id="6371888">.</span><span class="ident" id="6371889">preRLE</span><span class="op" id="6371895">)</span><span class="op" id="6371896">)</span>&nbsp;<span class="op" id="6371898">&amp;&amp;</span>&nbsp;<span class="ident" id="6371901">n</span>&nbsp;<span class="op" id="6371903">&lt;</span>&nbsp;<span class="builtinfunc" id="6371905">len</span><span class="op" id="6371908">(</span><span class="ident" id="6371909">buf</span><span class="op" id="6371912">)</span>&nbsp;<span class="op" id="6371914">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371918">//&nbsp;We&nbsp;have&nbsp;RLE&nbsp;data&nbsp;pending.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371950">//&nbsp;The&nbsp;run-length&nbsp;encoding&nbsp;works&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371996">//&nbsp;Any&nbsp;sequence&nbsp;of&nbsp;four&nbsp;equal&nbsp;bytes&nbsp;is&nbsp;followed&nbsp;by&nbsp;a&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6372058">//&nbsp;byte&nbsp;which&nbsp;contains&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;that&nbsp;byte&nbsp;to</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6372121">//&nbsp;include.&nbsp;(The&nbsp;number&nbsp;of&nbsp;repeats&nbsp;can&nbsp;be&nbsp;zero.)&nbsp;Because&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6372187">//&nbsp;decompressing&nbsp;on-demand&nbsp;our&nbsp;state&nbsp;is&nbsp;kept&nbsp;in&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6372248">//&nbsp;object.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372262">if</span>&nbsp;<span class="ident" id="6372265">bz2</span><span class="op" id="6372268">.</span><span class="ident" id="6372269">repeats</span>&nbsp;<span class="op" id="6372277">&gt;</span>&nbsp;<span class="num" id="6372279">0</span>&nbsp;<span class="op" id="6372281">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372286">buf</span><span class="op" id="6372289">[</span><span class="ident" id="6372290">n</span><span class="op" id="6372291">]</span>&nbsp;<span class="op" id="6372293">=</span>&nbsp;<span class="builtintype" id="6372295">byte</span><span class="op" id="6372299">(</span><span class="ident" id="6372300">bz2</span><span class="op" id="6372303">.</span><span class="ident" id="6372304">lastByte</span><span class="op" id="6372312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372317">n</span><span class="op" id="6372318">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372324">bz2</span><span class="op" id="6372327">.</span><span class="ident" id="6372328">repeats</span><span class="op" id="6372335">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372341">if</span>&nbsp;<span class="ident" id="6372344">bz2</span><span class="op" id="6372347">.</span><span class="ident" id="6372348">repeats</span>&nbsp;<span class="op" id="6372356">==</span>&nbsp;<span class="num" id="6372359">0</span>&nbsp;<span class="op" id="6372361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372367">bz2</span><span class="op" id="6372370">.</span><span class="ident" id="6372371">lastByte</span>&nbsp;<span class="op" id="6372380">=</span>&nbsp;<span class="op" id="6372382">-</span><span class="num" id="6372383">1</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6372388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372393">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6372404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372409">bz2</span><span class="op" id="6372412">.</span><span class="ident" id="6372413">tPos</span>&nbsp;<span class="op" id="6372418">=</span>&nbsp;<span class="ident" id="6372420">bz2</span><span class="op" id="6372423">.</span><span class="ident" id="6372424">preRLE</span><span class="op" id="6372430">[</span><span class="ident" id="6372431">bz2</span><span class="op" id="6372434">.</span><span class="ident" id="6372435">tPos</span><span class="op" id="6372439">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372443">b</span>&nbsp;<span class="op" id="6372445">:=</span>&nbsp;<span class="builtintype" id="6372448">byte</span><span class="op" id="6372452">(</span><span class="ident" id="6372453">bz2</span><span class="op" id="6372456">.</span><span class="ident" id="6372457">tPos</span><span class="op" id="6372461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372465">bz2</span><span class="op" id="6372468">.</span><span class="ident" id="6372469">tPos</span>&nbsp;<span class="op" id="6372474">&gt;&gt;=</span>&nbsp;<span class="num" id="6372478">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372482">bz2</span><span class="op" id="6372485">.</span><span class="ident" id="6372486">preRLEUsed</span><span class="op" id="6372496">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372502">if</span>&nbsp;<span class="ident" id="6372505">bz2</span><span class="op" id="6372508">.</span><span class="ident" id="6372509">byteRepeats</span>&nbsp;<span class="op" id="6372521">==</span>&nbsp;<span class="num" id="6372524">3</span>&nbsp;<span class="op" id="6372526">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372531">bz2</span><span class="op" id="6372534">.</span><span class="ident" id="6372535">repeats</span>&nbsp;<span class="op" id="6372543">=</span>&nbsp;<span class="builtintype" id="6372545">uint</span><span class="op" id="6372549">(</span><span class="ident" id="6372550">b</span><span class="op" id="6372551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372556">bz2</span><span class="op" id="6372559">.</span><span class="ident" id="6372560">byteRepeats</span>&nbsp;<span class="op" id="6372572">=</span>&nbsp;<span class="num" id="6372574">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372579">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6372590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372595">if</span>&nbsp;<span class="ident" id="6372598">bz2</span><span class="op" id="6372601">.</span><span class="ident" id="6372602">lastByte</span>&nbsp;<span class="op" id="6372611">==</span>&nbsp;<span class="builtintype" id="6372614">int</span><span class="op" id="6372617">(</span><span class="ident" id="6372618">b</span><span class="op" id="6372619">)</span>&nbsp;<span class="op" id="6372621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372626">bz2</span><span class="op" id="6372629">.</span><span class="ident" id="6372630">byteRepeats</span><span class="op" id="6372641">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6372646">}</span>&nbsp;<span class="keyword" id="6372648">else</span>&nbsp;<span class="op" id="6372653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372658">bz2</span><span class="op" id="6372661">.</span><span class="ident" id="6372662">byteRepeats</span>&nbsp;<span class="op" id="6372674">=</span>&nbsp;<span class="num" id="6372676">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6372680">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372684">bz2</span><span class="op" id="6372687">.</span><span class="ident" id="6372688">lastByte</span>&nbsp;<span class="op" id="6372697">=</span>&nbsp;<span class="builtintype" id="6372699">int</span><span class="op" id="6372702">(</span><span class="ident" id="6372703">b</span><span class="op" id="6372704">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372709">buf</span><span class="op" id="6372712">[</span><span class="ident" id="6372713">n</span><span class="op" id="6372714">]</span>&nbsp;<span class="op" id="6372716">=</span>&nbsp;<span class="ident" id="6372718">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372722">n</span><span class="op" id="6372723">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6372727">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372731">return</span>&nbsp;<span class="ident" id="6372738">n</span><br>
<span class="lineno"></span><span class="op" id="6372740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6372743">func</span>&nbsp;<span class="op" id="6372748">(</span><span class="ident" id="6372749">bz2</span>&nbsp;<span class="op" id="6372753">*</span><span class="ident" id="6372754">reader</span><span class="op" id="6372760">)</span>&nbsp;<span class="ident" id="6372762">read</span><span class="op" id="6372766">(</span><span class="ident" id="6372767">buf</span>&nbsp;<span class="op" id="6372771">[</span><span class="op" id="6372772">]</span><span class="builtintype" id="6372773">byte</span><span class="op" id="6372777">)</span>&nbsp;<span class="op" id="6372779">(</span><span class="builtintype" id="6372780">int</span><span class="op" id="6372783">,</span>&nbsp;<span class="builtintype" id="6372785">error</span><span class="op" id="6372790">)</span>&nbsp;<span class="op" id="6372792">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372795">for</span>&nbsp;<span class="op" id="6372799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372803">n</span>&nbsp;<span class="op" id="6372805">:=</span>&nbsp;<span class="ident" id="6372808">bz2</span><span class="op" id="6372811">.</span><span class="ident" id="6372812">readFromBlock</span><span class="op" id="6372825">(</span><span class="ident" id="6372826">buf</span><span class="op" id="6372829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372833">if</span>&nbsp;<span class="ident" id="6372836">n</span>&nbsp;<span class="op" id="6372838">&gt;</span>&nbsp;<span class="num" id="6372840">0</span>&nbsp;<span class="op" id="6372842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372847">bz2</span><span class="op" id="6372850">.</span><span class="ident" id="6372851">blockCRC</span>&nbsp;<span class="op" id="6372860">=</span>&nbsp;<span class="ident" id="6372862">updateCRC</span><span class="op" id="6372871">(</span><span class="ident" id="6372872">bz2</span><span class="op" id="6372875">.</span><span class="ident" id="6372876">blockCRC</span><span class="op" id="6372884">,</span>&nbsp;<span class="ident" id="6372886">buf</span><span class="op" id="6372889">[</span><span class="op" id="6372890">:</span><span class="ident" id="6372891">n</span><span class="op" id="6372892">]</span><span class="op" id="6372893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372898">return</span>&nbsp;<span class="ident" id="6372905">n</span><span class="op" id="6372906">,</span>&nbsp;<span class="ident" id="6372908">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6372914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6372919">//&nbsp;End&nbsp;of&nbsp;block.&nbsp;Check&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372949">if</span>&nbsp;<span class="ident" id="6372952">bz2</span><span class="op" id="6372955">.</span><span class="ident" id="6372956">blockCRC</span>&nbsp;<span class="op" id="6372965">!=</span>&nbsp;<span class="ident" id="6372968">bz2</span><span class="op" id="6372971">.</span><span class="ident" id="6372972">wantBlockCRC</span>&nbsp;<span class="op" id="6372985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372990">bz2</span><span class="op" id="6372993">.</span><span class="ident" id="6372994">br</span><span class="op" id="6372996">.</span><span class="ident" id="6372997">err</span>&nbsp;<span class="op" id="6373001">=</span>&nbsp;<span class="ident" id="6373003">StructuralError</span><span class="op" id="6373018">(</span><span class="string" id="6373019">&#34;block&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="6373044">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373049">return</span>&nbsp;<span class="num" id="6373056">0</span><span class="op" id="6373057">,</span>&nbsp;<span class="ident" id="6373059">bz2</span><span class="op" id="6373062">.</span><span class="ident" id="6373063">br</span><span class="op" id="6373065">.</span><span class="ident" id="6373066">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6373077">//&nbsp;Find&nbsp;next&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373099">br</span>&nbsp;<span class="op" id="6373102">:=</span>&nbsp;<span class="op" id="6373105">&amp;</span><span class="ident" id="6373106">bz2</span><span class="op" id="6373109">.</span><span class="ident" id="6373110">br</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373115">switch</span>&nbsp;<span class="ident" id="6373122">br</span><span class="op" id="6373124">.</span><span class="ident" id="6373125">ReadBits64</span><span class="op" id="6373135">(</span><span class="num" id="6373136">48</span><span class="op" id="6373138">)</span>&nbsp;<span class="op" id="6373140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373144">default</span><span class="op" id="6373151">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373156">return</span>&nbsp;<span class="num" id="6373163">0</span><span class="op" id="6373164">,</span>&nbsp;<span class="ident" id="6373166">StructuralError</span><span class="op" id="6373181">(</span><span class="string" id="6373182">&#34;bad&nbsp;magic&nbsp;value&nbsp;found&#34;</span><span class="op" id="6373205">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373210">case</span>&nbsp;<span class="ident" id="6373215">bzip2BlockMagic</span><span class="op" id="6373230">:</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6373235">//&nbsp;Start&nbsp;of&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373257">err</span>&nbsp;<span class="op" id="6373261">:=</span>&nbsp;<span class="ident" id="6373264">bz2</span><span class="op" id="6373267">.</span><span class="ident" id="6373268">readBlock</span><span class="op" id="6373277">(</span><span class="op" id="6373278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373283">if</span>&nbsp;<span class="ident" id="6373286">err</span>&nbsp;<span class="op" id="6373290">!=</span>&nbsp;<span class="ident" id="6373293">nil</span>&nbsp;<span class="op" id="6373297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373303">return</span>&nbsp;<span class="num" id="6373310">0</span><span class="op" id="6373311">,</span>&nbsp;<span class="ident" id="6373313">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373320">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373325">case</span>&nbsp;<span class="ident" id="6373330">bzip2FinalMagic</span><span class="op" id="6373345">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6373350">//&nbsp;Check&nbsp;end-of-file&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373379">wantFileCRC</span>&nbsp;<span class="op" id="6373391">:=</span>&nbsp;<span class="builtintype" id="6373394">uint32</span><span class="op" id="6373400">(</span><span class="ident" id="6373401">br</span><span class="op" id="6373403">.</span><span class="ident" id="6373404">ReadBits64</span><span class="op" id="6373414">(</span><span class="num" id="6373415">32</span><span class="op" id="6373417">)</span><span class="op" id="6373418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373423">if</span>&nbsp;<span class="ident" id="6373426">br</span><span class="op" id="6373428">.</span><span class="ident" id="6373429">err</span>&nbsp;<span class="op" id="6373433">!=</span>&nbsp;<span class="ident" id="6373436">nil</span>&nbsp;<span class="op" id="6373440">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373446">return</span>&nbsp;<span class="num" id="6373453">0</span><span class="op" id="6373454">,</span>&nbsp;<span class="ident" id="6373456">br</span><span class="op" id="6373458">.</span><span class="ident" id="6373459">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373471">if</span>&nbsp;<span class="ident" id="6373474">bz2</span><span class="op" id="6373477">.</span><span class="ident" id="6373478">fileCRC</span>&nbsp;<span class="op" id="6373486">!=</span>&nbsp;<span class="ident" id="6373489">wantFileCRC</span>&nbsp;<span class="op" id="6373501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373507">br</span><span class="op" id="6373509">.</span><span class="ident" id="6373510">err</span>&nbsp;<span class="op" id="6373514">=</span>&nbsp;<span class="ident" id="6373516">StructuralError</span><span class="op" id="6373531">(</span><span class="string" id="6373532">&#34;file&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="6373556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373562">return</span>&nbsp;<span class="num" id="6373569">0</span><span class="op" id="6373570">,</span>&nbsp;<span class="ident" id="6373572">br</span><span class="op" id="6373574">.</span><span class="ident" id="6373575">err</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6373588">//&nbsp;Skip&nbsp;ahead&nbsp;to&nbsp;byte&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6373623">//&nbsp;Is&nbsp;there&nbsp;a&nbsp;file&nbsp;concatenated&nbsp;to&nbsp;this&nbsp;one?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6373671">//&nbsp;It&nbsp;would&nbsp;start&nbsp;with&nbsp;BZ.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373701">if</span>&nbsp;<span class="ident" id="6373704">br</span><span class="op" id="6373706">.</span><span class="ident" id="6373707">bits</span><span class="op" id="6373711">%</span><span class="num" id="6373712">8</span>&nbsp;<span class="op" id="6373714">!=</span>&nbsp;<span class="num" id="6373717">0</span>&nbsp;<span class="op" id="6373719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373725">br</span><span class="op" id="6373727">.</span><span class="ident" id="6373728">ReadBits</span><span class="op" id="6373736">(</span><span class="ident" id="6373737">br</span><span class="op" id="6373739">.</span><span class="ident" id="6373740">bits</span>&nbsp;<span class="op" id="6373745">%</span>&nbsp;<span class="num" id="6373747">8</span><span class="op" id="6373748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373758">b</span><span class="op" id="6373759">,</span>&nbsp;<span class="ident" id="6373761">err</span>&nbsp;<span class="op" id="6373765">:=</span>&nbsp;<span class="ident" id="6373768">br</span><span class="op" id="6373770">.</span><span class="ident" id="6373771">r</span><span class="op" id="6373772">.</span><span class="ident" id="6373773">ReadByte</span><span class="op" id="6373781">(</span><span class="op" id="6373782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373787">if</span>&nbsp;<span class="ident" id="6373790">err</span>&nbsp;<span class="op" id="6373794">==</span>&nbsp;<span class="ident" id="6373797">io</span><span class="op" id="6373799">.</span><span class="ident" id="6373800">EOF</span>&nbsp;<span class="op" id="6373804">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373810">br</span><span class="op" id="6373812">.</span><span class="ident" id="6373813">err</span>&nbsp;<span class="op" id="6373817">=</span>&nbsp;<span class="ident" id="6373819">io</span><span class="op" id="6373821">.</span><span class="ident" id="6373822">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373830">bz2</span><span class="op" id="6373833">.</span><span class="ident" id="6373834">eof</span>&nbsp;<span class="op" id="6373838">=</span>&nbsp;<span class="builtintype" id="6373840">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373849">return</span>&nbsp;<span class="num" id="6373856">0</span><span class="op" id="6373857">,</span>&nbsp;<span class="ident" id="6373859">io</span><span class="op" id="6373861">.</span><span class="ident" id="6373862">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373874">if</span>&nbsp;<span class="ident" id="6373877">err</span>&nbsp;<span class="op" id="6373881">!=</span>&nbsp;<span class="ident" id="6373884">nil</span>&nbsp;<span class="op" id="6373888">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373894">br</span><span class="op" id="6373896">.</span><span class="ident" id="6373897">err</span>&nbsp;<span class="op" id="6373901">=</span>&nbsp;<span class="ident" id="6373903">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373911">return</span>&nbsp;<span class="num" id="6373918">0</span><span class="op" id="6373919">,</span>&nbsp;<span class="ident" id="6373921">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373933">z</span><span class="op" id="6373934">,</span>&nbsp;<span class="ident" id="6373936">err</span>&nbsp;<span class="op" id="6373940">:=</span>&nbsp;<span class="ident" id="6373943">br</span><span class="op" id="6373945">.</span><span class="ident" id="6373946">r</span><span class="op" id="6373947">.</span><span class="ident" id="6373948">ReadByte</span><span class="op" id="6373956">(</span><span class="op" id="6373957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373962">if</span>&nbsp;<span class="ident" id="6373965">err</span>&nbsp;<span class="op" id="6373969">!=</span>&nbsp;<span class="ident" id="6373972">nil</span>&nbsp;<span class="op" id="6373976">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373982">if</span>&nbsp;<span class="ident" id="6373985">err</span>&nbsp;<span class="op" id="6373989">==</span>&nbsp;<span class="ident" id="6373992">io</span><span class="op" id="6373994">.</span><span class="ident" id="6373995">EOF</span>&nbsp;<span class="op" id="6373999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374006">err</span>&nbsp;<span class="op" id="6374010">=</span>&nbsp;<span class="ident" id="6374012">io</span><span class="op" id="6374014">.</span><span class="ident" id="6374015">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6374036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374042">br</span><span class="op" id="6374044">.</span><span class="ident" id="6374045">err</span>&nbsp;<span class="op" id="6374049">=</span>&nbsp;<span class="ident" id="6374051">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374059">return</span>&nbsp;<span class="num" id="6374066">0</span><span class="op" id="6374067">,</span>&nbsp;<span class="ident" id="6374069">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6374076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374081">if</span>&nbsp;<span class="ident" id="6374084">b</span>&nbsp;<span class="op" id="6374086">!=</span>&nbsp;<span class="string" id="6374089">&#39;B&#39;</span>&nbsp;<span class="op" id="6374093">||</span>&nbsp;<span class="ident" id="6374096">z</span>&nbsp;<span class="op" id="6374098">!=</span>&nbsp;<span class="string" id="6374101">&#39;Z&#39;</span>&nbsp;<span class="op" id="6374105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374111">return</span>&nbsp;<span class="num" id="6374118">0</span><span class="op" id="6374119">,</span>&nbsp;<span class="ident" id="6374121">StructuralError</span><span class="op" id="6374136">(</span><span class="string" id="6374137">&#34;bad&nbsp;magic&nbsp;value&nbsp;in&nbsp;continuation&nbsp;file&#34;</span><span class="op" id="6374175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6374180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374185">if</span>&nbsp;<span class="ident" id="6374188">err</span>&nbsp;<span class="op" id="6374192">:=</span>&nbsp;<span class="ident" id="6374195">bz2</span><span class="op" id="6374198">.</span><span class="ident" id="6374199">setup</span><span class="op" id="6374204">(</span><span class="builtintype" id="6374205">false</span><span class="op" id="6374210">)</span><span class="op" id="6374211">;</span>&nbsp;<span class="ident" id="6374213">err</span>&nbsp;<span class="op" id="6374217">!=</span>&nbsp;<span class="ident" id="6374220">nil</span>&nbsp;<span class="op" id="6374224">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374230">return</span>&nbsp;<span class="num" id="6374237">0</span><span class="op" id="6374238">,</span>&nbsp;<span class="ident" id="6374240">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6374247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6374251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6374254">}</span><br>
<span class="lineno"></span><span class="op" id="6374256">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="6374259">//&nbsp;readBlock&nbsp;reads&nbsp;a&nbsp;bzip2&nbsp;block.&nbsp;The&nbsp;magic&nbsp;number&nbsp;should&nbsp;already&nbsp;have&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span><span class="keyword" id="6374345">func</span>&nbsp;<span class="op" id="6374350">(</span><span class="ident" id="6374351">bz2</span>&nbsp;<span class="op" id="6374355">*</span><span class="ident" id="6374356">reader</span><span class="op" id="6374362">)</span>&nbsp;<span class="ident" id="6374364">readBlock</span><span class="op" id="6374373">(</span><span class="op" id="6374374">)</span>&nbsp;<span class="op" id="6374376">(</span><span class="ident" id="6374377">err</span>&nbsp;<span class="builtintype" id="6374381">error</span><span class="op" id="6374386">)</span>&nbsp;<span class="op" id="6374388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374391">br</span>&nbsp;<span class="op" id="6374394">:=</span>&nbsp;<span class="op" id="6374397">&amp;</span><span class="ident" id="6374398">bz2</span><span class="op" id="6374401">.</span><span class="ident" id="6374402">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374406">bz2</span><span class="op" id="6374409">.</span><span class="ident" id="6374410">wantBlockCRC</span>&nbsp;<span class="op" id="6374423">=</span>&nbsp;<span class="builtintype" id="6374425">uint32</span><span class="op" id="6374431">(</span><span class="ident" id="6374432">br</span><span class="op" id="6374434">.</span><span class="ident" id="6374435">ReadBits64</span><span class="op" id="6374445">(</span><span class="num" id="6374446">32</span><span class="op" id="6374448">)</span><span class="op" id="6374449">)</span>&nbsp;<span class="comment" id="6374451">//&nbsp;skip&nbsp;checksum.&nbsp;TODO:&nbsp;check&nbsp;it&nbsp;if&nbsp;we&nbsp;can&nbsp;figure&nbsp;out&nbsp;what&nbsp;it&nbsp;is.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374518">bz2</span><span class="op" id="6374521">.</span><span class="ident" id="6374522">blockCRC</span>&nbsp;<span class="op" id="6374531">=</span>&nbsp;<span class="num" id="6374533">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374536">bz2</span><span class="op" id="6374539">.</span><span class="ident" id="6374540">fileCRC</span>&nbsp;<span class="op" id="6374548">=</span>&nbsp;<span class="op" id="6374550">(</span><span class="ident" id="6374551">bz2</span><span class="op" id="6374554">.</span><span class="ident" id="6374555">fileCRC</span><span class="op" id="6374562">&lt;&lt;</span><span class="num" id="6374564">1</span>&nbsp;<span class="op" id="6374566">|</span>&nbsp;<span class="ident" id="6374568">bz2</span><span class="op" id="6374571">.</span><span class="ident" id="6374572">fileCRC</span><span class="op" id="6374579">&gt;&gt;</span><span class="num" id="6374581">31</span><span class="op" id="6374583">)</span>&nbsp;<span class="op" id="6374585">^</span>&nbsp;<span class="ident" id="6374587">bz2</span><span class="op" id="6374590">.</span><span class="ident" id="6374591">wantBlockCRC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374605">randomized</span>&nbsp;<span class="op" id="6374616">:=</span>&nbsp;<span class="ident" id="6374619">br</span><span class="op" id="6374621">.</span><span class="ident" id="6374622">ReadBits</span><span class="op" id="6374630">(</span><span class="num" id="6374631">1</span><span class="op" id="6374632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374635">if</span>&nbsp;<span class="ident" id="6374638">randomized</span>&nbsp;<span class="op" id="6374649">!=</span>&nbsp;<span class="num" id="6374652">0</span>&nbsp;<span class="op" id="6374654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374658">return</span>&nbsp;<span class="ident" id="6374665">StructuralError</span><span class="op" id="6374680">(</span><span class="string" id="6374681">&#34;deprecated&nbsp;randomized&nbsp;files&#34;</span><span class="op" id="6374710">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6374713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374716">origPtr</span>&nbsp;<span class="op" id="6374724">:=</span>&nbsp;<span class="builtintype" id="6374727">uint</span><span class="op" id="6374731">(</span><span class="ident" id="6374732">br</span><span class="op" id="6374734">.</span><span class="ident" id="6374735">ReadBits</span><span class="op" id="6374743">(</span><span class="num" id="6374744">24</span><span class="op" id="6374746">)</span><span class="op" id="6374747">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6374751">//&nbsp;If&nbsp;not&nbsp;every&nbsp;byte&nbsp;value&nbsp;is&nbsp;used&nbsp;in&nbsp;the&nbsp;block&nbsp;(i.e.,&nbsp;it&#39;s&nbsp;text)&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6374823">//&nbsp;the&nbsp;symbol&nbsp;set&nbsp;is&nbsp;reduced.&nbsp;The&nbsp;symbols&nbsp;used&nbsp;are&nbsp;stored&nbsp;as&nbsp;a</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6374887">//&nbsp;two-level,&nbsp;16x16&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374916">symbolRangeUsedBitmap</span>&nbsp;<span class="op" id="6374938">:=</span>&nbsp;<span class="ident" id="6374941">br</span><span class="op" id="6374943">.</span><span class="ident" id="6374944">ReadBits</span><span class="op" id="6374952">(</span><span class="num" id="6374953">16</span><span class="op" id="6374955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374958">symbolPresent</span>&nbsp;<span class="op" id="6374972">:=</span>&nbsp;<span class="builtinfunc" id="6374975">make</span><span class="op" id="6374979">(</span><span class="op" id="6374980">[</span><span class="op" id="6374981">]</span><span class="builtintype" id="6374982">bool</span><span class="op" id="6374986">,</span>&nbsp;<span class="num" id="6374988">256</span><span class="op" id="6374991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374994">numSymbols</span>&nbsp;<span class="op" id="6375005">:=</span>&nbsp;<span class="num" id="6375008">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6375011">for</span>&nbsp;<span class="ident" id="6375015">symRange</span>&nbsp;<span class="op" id="6375024">:=</span>&nbsp;<span class="builtintype" id="6375027">uint</span><span class="op" id="6375031">(</span><span class="num" id="6375032">0</span><span class="op" id="6375033">)</span><span class="op" id="6375034">;</span>&nbsp;<span class="ident" id="6375036">symRange</span>&nbsp;<span class="op" id="6375045">&lt;</span>&nbsp;<span class="num" id="6375047">16</span><span class="op" id="6375049">;</span>&nbsp;<span class="ident" id="6375051">symRange</span><span class="op" id="6375059">++</span>&nbsp;<span class="op" id="6375062">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6375066">if</span>&nbsp;<span class="ident" id="6375069">symbolRangeUsedBitmap</span><span class="op" id="6375090">&amp;</span><span class="op" id="6375091">(</span><span class="num" id="6375092">1</span><span class="op" id="6375093">&lt;&lt;</span><span class="op" id="6375095">(</span><span class="num" id="6375096">15</span><span class="op" id="6375098">-</span><span class="ident" id="6375099">symRange</span><span class="op" id="6375107">)</span><span class="op" id="6375108">)</span>&nbsp;<span class="op" id="6375110">!=</span>&nbsp;<span class="num" id="6375113">0</span>&nbsp;<span class="op" id="6375115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6375120">bits</span>&nbsp;<span class="op" id="6375125">:=</span>&nbsp;<span class="ident" id="6375128">br</span><span class="op" id="6375130">.</span><span class="ident" id="6375131">ReadBits</span><span class="op" id="6375139">(</span><span class="num" id="6375140">16</span><span class="op" id="6375142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6375147">for</span>&nbsp;<span class="ident" id="6375151">symbol</span>&nbsp;<span class="op" id="6375158">:=</span>&nbsp;<span class="builtintype" id="6375161">uint</span><span class="op" id="6375165">(</span><span class="num" id="6375166">0</span><span class="op" id="6375167">)</span><span class="op" id="6375168">;</span>&nbsp;<span class="ident" id="6375170">symbol</span>&nbsp;<span class="op" id="6375177">&lt;</span>&nbsp;<span class="num" id="6375179">16</span><span class="op" id="6375181">;</span>&nbsp;<span class="ident" id="6375183">symbol</span><span class="op" id="6375189">++</span>&nbsp;<span class="op" id="6375192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6375198">if</span>&nbsp;<span class="ident" id="6375201">bits</span><span class="op" id="6375205">&amp;</span><span class="op" id="6375206">(</span><span class="num" id="6375207">1</span><span class="op" id="6375208">&lt;&lt;</span><span class="op" id="6375210">(</span><span class="num" id="6375211">15</span><span class="op" id="6375213">-</span><span class="ident" id="6375214">symbol</span><span class="op" id="6375220">)</span><span class="op" id="6375221">)</span>&nbsp;<span class="op" id="6375223">!=</span>&nbsp;<span class="num" id="6375226">0</span>&nbsp;<span class="op" id="6375228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6375235">symbolPresent</span><span class="op" id="6375248">[</span><span class="num" id="6375249">16</span><span class="op" id="6375251">*</span><span class="ident" id="6375252">symRange</span><span class="op" id="6375260">+</span><span class="ident" id="6375261">symbol</span><span class="op" id="6375267">]</span>&nbsp;<span class="op" id="6375269">=</span>&nbsp;<span class="builtintype" id="6375271">true</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6375281">numSymbols</span><span class="op" id="6375291">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6375298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6375303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6375307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6375310">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6375314">if</span>&nbsp;<span class="ident" id="6375317">numSymbols</span>&nbsp;<span class="op" id="6375328">==</span>&nbsp;<span class="num" id="6375331">0</span>&nbsp;<span class="op" id="6375333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6375337">//&nbsp;There&nbsp;must&nbsp;be&nbsp;an&nbsp;EOF&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6375371">return</span>&nbsp;<span class="ident" id="6375378">StructuralError</span><span class="op" id="6375393">(</span><span class="string" id="6375394">&#34;no&nbsp;symbols&nbsp;in&nbsp;input&#34;</span><span class="op" id="6375415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6375418">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6375422">//&nbsp;A&nbsp;block&nbsp;uses&nbsp;between&nbsp;two&nbsp;and&nbsp;six&nbsp;different&nbsp;Huffman&nbsp;trees.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6375484">numHuffmanTrees</span>&nbsp;<span class="op" id="6375500">:=</span>&nbsp;<span class="ident" id="6375503">br</span><span class="op" id="6375505">.</span><span class="ident" id="6375506">ReadBits</span><span class="op" id="6375514">(</span><span class="num" id="6375515">3</span><span class="op" id="6375516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6375519">if</span>&nbsp;<span class="ident" id="6375522">numHuffmanTrees</span>&nbsp;<span class="op" id="6375538">&lt;</span>&nbsp;<span class="num" id="6375540">2</span>&nbsp;<span class="op" id="6375542">||</span>&nbsp;<span class="ident" id="6375545">numHuffmanTrees</span>&nbsp;<span class="op" id="6375561">&gt;</span>&nbsp;<span class="num" id="6375563">6</span>&nbsp;<span class="op" id="6375565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6375569">return</span>&nbsp;<span class="ident" id="6375576">StructuralError</span><span class="op" id="6375591">(</span><span class="string" id="6375592">&#34;invalid&nbsp;number&nbsp;of&nbsp;Huffman&nbsp;trees&#34;</span><span class="op" id="6375625">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6375628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6375632">//&nbsp;The&nbsp;Huffman&nbsp;tree&nbsp;can&nbsp;switch&nbsp;every&nbsp;50&nbsp;symbols&nbsp;so&nbsp;there&#39;s&nbsp;a&nbsp;list&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6375702">//&nbsp;tree&nbsp;indexes&nbsp;telling&nbsp;us&nbsp;which&nbsp;tree&nbsp;to&nbsp;use&nbsp;for&nbsp;each&nbsp;50&nbsp;symbol&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6375774">numSelectors</span>&nbsp;<span class="op" id="6375787">:=</span>&nbsp;<span class="ident" id="6375790">br</span><span class="op" id="6375792">.</span><span class="ident" id="6375793">ReadBits</span><span class="op" id="6375801">(</span><span class="num" id="6375802">15</span><span class="op" id="6375804">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6375807">treeIndexes</span>&nbsp;<span class="op" id="6375819">:=</span>&nbsp;<span class="builtinfunc" id="6375822">make</span><span class="op" id="6375826">(</span><span class="op" id="6375827">[</span><span class="op" id="6375828">]</span><span class="builtintype" id="6375829">uint8</span><span class="op" id="6375834">,</span>&nbsp;<span class="ident" id="6375836">numSelectors</span><span class="op" id="6375848">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6375852">//&nbsp;The&nbsp;tree&nbsp;indexes&nbsp;are&nbsp;move-to-front&nbsp;transformed&nbsp;and&nbsp;stored&nbsp;as&nbsp;unary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6375923">//&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6375936">mtfTreeDecoder</span>&nbsp;<span class="op" id="6375951">:=</span>&nbsp;<span class="ident" id="6375954">newMTFDecoderWithRange</span><span class="op" id="6375976">(</span><span class="ident" id="6375977">numHuffmanTrees</span><span class="op" id="6375992">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6375995">for</span>&nbsp;<span class="ident" id="6375999">i</span>&nbsp;<span class="op" id="6376001">:=</span>&nbsp;<span class="keyword" id="6376004">range</span>&nbsp;<span class="ident" id="6376010">treeIndexes</span>&nbsp;<span class="op" id="6376022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376026">c</span>&nbsp;<span class="op" id="6376028">:=</span>&nbsp;<span class="num" id="6376031">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376035">for</span>&nbsp;<span class="op" id="6376039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376044">inc</span>&nbsp;<span class="op" id="6376048">:=</span>&nbsp;<span class="ident" id="6376051">br</span><span class="op" id="6376053">.</span><span class="ident" id="6376054">ReadBits</span><span class="op" id="6376062">(</span><span class="num" id="6376063">1</span><span class="op" id="6376064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376069">if</span>&nbsp;<span class="ident" id="6376072">inc</span>&nbsp;<span class="op" id="6376076">==</span>&nbsp;<span class="num" id="6376079">0</span>&nbsp;<span class="op" id="6376081">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376087">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6376096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376101">c</span><span class="op" id="6376102">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6376107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376111">if</span>&nbsp;<span class="ident" id="6376114">c</span>&nbsp;<span class="op" id="6376116">&gt;=</span>&nbsp;<span class="ident" id="6376119">numHuffmanTrees</span>&nbsp;<span class="op" id="6376135">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376140">return</span>&nbsp;<span class="ident" id="6376147">StructuralError</span><span class="op" id="6376162">(</span><span class="string" id="6376163">&#34;tree&nbsp;index&nbsp;too&nbsp;large&#34;</span><span class="op" id="6376185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6376189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376193">treeIndexes</span><span class="op" id="6376204">[</span><span class="ident" id="6376205">i</span><span class="op" id="6376206">]</span>&nbsp;<span class="op" id="6376208">=</span>&nbsp;<span class="builtintype" id="6376210">uint8</span><span class="op" id="6376215">(</span><span class="ident" id="6376216">mtfTreeDecoder</span><span class="op" id="6376230">.</span><span class="ident" id="6376231">Decode</span><span class="op" id="6376237">(</span><span class="ident" id="6376238">c</span><span class="op" id="6376239">)</span><span class="op" id="6376240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6376243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6376247">//&nbsp;The&nbsp;list&nbsp;of&nbsp;symbols&nbsp;for&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;taken&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6376317">//&nbsp;the&nbsp;previously&nbsp;decoded&nbsp;symbol&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376359">symbols</span>&nbsp;<span class="op" id="6376367">:=</span>&nbsp;<span class="builtinfunc" id="6376370">make</span><span class="op" id="6376374">(</span><span class="op" id="6376375">[</span><span class="op" id="6376376">]</span><span class="builtintype" id="6376377">byte</span><span class="op" id="6376381">,</span>&nbsp;<span class="ident" id="6376383">numSymbols</span><span class="op" id="6376393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376396">nextSymbol</span>&nbsp;<span class="op" id="6376407">:=</span>&nbsp;<span class="num" id="6376410">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376413">for</span>&nbsp;<span class="ident" id="6376417">i</span>&nbsp;<span class="op" id="6376419">:=</span>&nbsp;<span class="num" id="6376422">0</span><span class="op" id="6376423">;</span>&nbsp;<span class="ident" id="6376425">i</span>&nbsp;<span class="op" id="6376427">&lt;</span>&nbsp;<span class="num" id="6376429">256</span><span class="op" id="6376432">;</span>&nbsp;<span class="ident" id="6376434">i</span><span class="op" id="6376435">++</span>&nbsp;<span class="op" id="6376438">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376442">if</span>&nbsp;<span class="ident" id="6376445">symbolPresent</span><span class="op" id="6376458">[</span><span class="ident" id="6376459">i</span><span class="op" id="6376460">]</span>&nbsp;<span class="op" id="6376462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376467">symbols</span><span class="op" id="6376474">[</span><span class="ident" id="6376475">nextSymbol</span><span class="op" id="6376485">]</span>&nbsp;<span class="op" id="6376487">=</span>&nbsp;<span class="builtintype" id="6376489">byte</span><span class="op" id="6376493">(</span><span class="ident" id="6376494">i</span><span class="op" id="6376495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376500">nextSymbol</span><span class="op" id="6376510">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6376515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6376518">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376521">mtf</span>&nbsp;<span class="op" id="6376525">:=</span>&nbsp;<span class="ident" id="6376528">newMTFDecoder</span><span class="op" id="6376541">(</span><span class="ident" id="6376542">symbols</span><span class="op" id="6376549">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376553">numSymbols</span>&nbsp;<span class="op" id="6376564">+=</span>&nbsp;<span class="num" id="6376567">2</span>&nbsp;<span class="comment" id="6376569">//&nbsp;to&nbsp;account&nbsp;for&nbsp;RUNA&nbsp;and&nbsp;RUNB&nbsp;symbols</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376610">huffmanTrees</span>&nbsp;<span class="op" id="6376623">:=</span>&nbsp;<span class="builtinfunc" id="6376626">make</span><span class="op" id="6376630">(</span><span class="op" id="6376631">[</span><span class="op" id="6376632">]</span><span class="ident" id="6376633">huffmanTree</span><span class="op" id="6376644">,</span>&nbsp;<span class="ident" id="6376646">numHuffmanTrees</span><span class="op" id="6376661">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6376665">//&nbsp;Now&nbsp;we&nbsp;decode&nbsp;the&nbsp;arrays&nbsp;of&nbsp;code-lengths&nbsp;for&nbsp;each&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376725">lengths</span>&nbsp;<span class="op" id="6376733">:=</span>&nbsp;<span class="builtinfunc" id="6376736">make</span><span class="op" id="6376740">(</span><span class="op" id="6376741">[</span><span class="op" id="6376742">]</span><span class="builtintype" id="6376743">uint8</span><span class="op" id="6376748">,</span>&nbsp;<span class="ident" id="6376750">numSymbols</span><span class="op" id="6376760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376763">for</span>&nbsp;<span class="ident" id="6376767">i</span>&nbsp;<span class="op" id="6376769">:=</span>&nbsp;<span class="keyword" id="6376772">range</span>&nbsp;<span class="ident" id="6376778">huffmanTrees</span>&nbsp;<span class="op" id="6376791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6376795">//&nbsp;The&nbsp;code&nbsp;lengths&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;from&nbsp;a&nbsp;5-bit&nbsp;base&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376860">length</span>&nbsp;<span class="op" id="6376867">:=</span>&nbsp;<span class="ident" id="6376870">br</span><span class="op" id="6376872">.</span><span class="ident" id="6376873">ReadBits</span><span class="op" id="6376881">(</span><span class="num" id="6376882">5</span><span class="op" id="6376883">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376887">for</span>&nbsp;<span class="ident" id="6376891">j</span>&nbsp;<span class="op" id="6376893">:=</span>&nbsp;<span class="keyword" id="6376896">range</span>&nbsp;<span class="ident" id="6376902">lengths</span>&nbsp;<span class="op" id="6376910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376915">for</span>&nbsp;<span class="op" id="6376919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376925">if</span>&nbsp;<span class="op" id="6376928">!</span><span class="ident" id="6376929">br</span><span class="op" id="6376931">.</span><span class="ident" id="6376932">ReadBit</span><span class="op" id="6376939">(</span><span class="op" id="6376940">)</span>&nbsp;<span class="op" id="6376942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376949">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6376959">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376965">if</span>&nbsp;<span class="ident" id="6376968">br</span><span class="op" id="6376970">.</span><span class="ident" id="6376971">ReadBit</span><span class="op" id="6376978">(</span><span class="op" id="6376979">)</span>&nbsp;<span class="op" id="6376981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376988">length</span><span class="op" id="6376994">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377001">}</span>&nbsp;<span class="keyword" id="6377003">else</span>&nbsp;<span class="op" id="6377008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377015">length</span><span class="op" id="6377021">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377028">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377038">if</span>&nbsp;<span class="ident" id="6377041">length</span>&nbsp;<span class="op" id="6377048">&lt;</span>&nbsp;<span class="num" id="6377050">0</span>&nbsp;<span class="op" id="6377052">||</span>&nbsp;<span class="ident" id="6377055">length</span>&nbsp;<span class="op" id="6377062">&gt;</span>&nbsp;<span class="num" id="6377064">20</span>&nbsp;<span class="op" id="6377067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377073">return</span>&nbsp;<span class="ident" id="6377080">StructuralError</span><span class="op" id="6377095">(</span><span class="string" id="6377096">&#34;Huffman&nbsp;length&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="6377125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377135">lengths</span><span class="op" id="6377142">[</span><span class="ident" id="6377143">j</span><span class="op" id="6377144">]</span>&nbsp;<span class="op" id="6377146">=</span>&nbsp;<span class="builtintype" id="6377148">uint8</span><span class="op" id="6377153">(</span><span class="ident" id="6377154">length</span><span class="op" id="6377160">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377168">huffmanTrees</span><span class="op" id="6377180">[</span><span class="ident" id="6377181">i</span><span class="op" id="6377182">]</span><span class="op" id="6377183">,</span>&nbsp;<span class="ident" id="6377185">err</span>&nbsp;<span class="op" id="6377189">=</span>&nbsp;<span class="ident" id="6377191">newHuffmanTree</span><span class="op" id="6377205">(</span><span class="ident" id="6377206">lengths</span><span class="op" id="6377213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377217">if</span>&nbsp;<span class="ident" id="6377220">err</span>&nbsp;<span class="op" id="6377224">!=</span>&nbsp;<span class="ident" id="6377227">nil</span>&nbsp;<span class="op" id="6377231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377236">return</span>&nbsp;<span class="ident" id="6377243">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377249">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377256">selectorIndex</span>&nbsp;<span class="op" id="6377270">:=</span>&nbsp;<span class="num" id="6377273">1</span>&nbsp;<span class="comment" id="6377275">//&nbsp;the&nbsp;next&nbsp;tree&nbsp;index&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377306">if</span>&nbsp;<span class="builtinfunc" id="6377309">len</span><span class="op" id="6377312">(</span><span class="ident" id="6377313">treeIndexes</span><span class="op" id="6377324">)</span>&nbsp;<span class="op" id="6377326">==</span>&nbsp;<span class="num" id="6377329">0</span>&nbsp;<span class="op" id="6377331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377335">return</span>&nbsp;<span class="ident" id="6377342">StructuralError</span><span class="op" id="6377357">(</span><span class="string" id="6377358">&#34;no&nbsp;tree&nbsp;selectors&nbsp;given&#34;</span><span class="op" id="6377383">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377389">if</span>&nbsp;<span class="builtintype" id="6377392">int</span><span class="op" id="6377395">(</span><span class="ident" id="6377396">treeIndexes</span><span class="op" id="6377407">[</span><span class="num" id="6377408">0</span><span class="op" id="6377409">]</span><span class="op" id="6377410">)</span>&nbsp;<span class="op" id="6377412">&gt;=</span>&nbsp;<span class="builtinfunc" id="6377415">len</span><span class="op" id="6377418">(</span><span class="ident" id="6377419">huffmanTrees</span><span class="op" id="6377431">)</span>&nbsp;<span class="op" id="6377433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377437">return</span>&nbsp;<span class="ident" id="6377444">StructuralError</span><span class="op" id="6377459">(</span><span class="string" id="6377460">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="6377488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377494">currentHuffmanTree</span>&nbsp;<span class="op" id="6377513">:=</span>&nbsp;<span class="ident" id="6377516">huffmanTrees</span><span class="op" id="6377528">[</span><span class="ident" id="6377529">treeIndexes</span><span class="op" id="6377540">[</span><span class="num" id="6377541">0</span><span class="op" id="6377542">]</span><span class="op" id="6377543">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377546">bufIndex</span>&nbsp;<span class="op" id="6377555">:=</span>&nbsp;<span class="num" id="6377558">0</span>&nbsp;<span class="comment" id="6377560">//&nbsp;indexes&nbsp;bz2.buf,&nbsp;the&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6377600">//&nbsp;The&nbsp;output&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;run-length&nbsp;encoded&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6377672">//&nbsp;we&nbsp;merge&nbsp;the&nbsp;decoding&nbsp;into&nbsp;the&nbsp;Huffman&nbsp;parsing&nbsp;loop.&nbsp;These&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6377739">//&nbsp;variables&nbsp;accumulate&nbsp;the&nbsp;repeat&nbsp;count.&nbsp;See&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6377809">//&nbsp;details.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377822">repeat</span>&nbsp;<span class="op" id="6377829">:=</span>&nbsp;<span class="num" id="6377832">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377835">repeat_power</span>&nbsp;<span class="op" id="6377848">:=</span>&nbsp;<span class="num" id="6377851">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6377855">//&nbsp;The&nbsp;`C&#39;&nbsp;array&nbsp;(used&nbsp;by&nbsp;the&nbsp;inverse&nbsp;BWT)&nbsp;needs&nbsp;to&nbsp;be&nbsp;zero&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377929">for</span>&nbsp;<span class="ident" id="6377933">i</span>&nbsp;<span class="op" id="6377935">:=</span>&nbsp;<span class="keyword" id="6377938">range</span>&nbsp;<span class="ident" id="6377944">bz2</span><span class="op" id="6377947">.</span><span class="ident" id="6377948">c</span>&nbsp;<span class="op" id="6377950">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377954">bz2</span><span class="op" id="6377957">.</span><span class="ident" id="6377958">c</span><span class="op" id="6377959">[</span><span class="ident" id="6377960">i</span><span class="op" id="6377961">]</span>&nbsp;<span class="op" id="6377963">=</span>&nbsp;<span class="num" id="6377965">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377972">decoded</span>&nbsp;<span class="op" id="6377980">:=</span>&nbsp;<span class="num" id="6377983">0</span>&nbsp;<span class="comment" id="6377985">//&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;symbols&nbsp;decoded&nbsp;by&nbsp;the&nbsp;current&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378047">for</span>&nbsp;<span class="op" id="6378051">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378055">if</span>&nbsp;<span class="ident" id="6378058">decoded</span>&nbsp;<span class="op" id="6378066">==</span>&nbsp;<span class="num" id="6378069">50</span>&nbsp;<span class="op" id="6378072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378077">if</span>&nbsp;<span class="ident" id="6378080">selectorIndex</span>&nbsp;<span class="op" id="6378094">&gt;=</span>&nbsp;<span class="ident" id="6378097">numSelectors</span>&nbsp;<span class="op" id="6378110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378116">return</span>&nbsp;<span class="ident" id="6378123">StructuralError</span><span class="op" id="6378138">(</span><span class="string" id="6378139">&#34;insufficient&nbsp;selector&nbsp;indices&nbsp;for&nbsp;number&nbsp;of&nbsp;symbols&#34;</span><span class="op" id="6378192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6378197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378202">if</span>&nbsp;<span class="builtintype" id="6378205">int</span><span class="op" id="6378208">(</span><span class="ident" id="6378209">treeIndexes</span><span class="op" id="6378220">[</span><span class="ident" id="6378221">selectorIndex</span><span class="op" id="6378234">]</span><span class="op" id="6378235">)</span>&nbsp;<span class="op" id="6378237">&gt;=</span>&nbsp;<span class="builtinfunc" id="6378240">len</span><span class="op" id="6378243">(</span><span class="ident" id="6378244">huffmanTrees</span><span class="op" id="6378256">)</span>&nbsp;<span class="op" id="6378258">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378264">return</span>&nbsp;<span class="ident" id="6378271">StructuralError</span><span class="op" id="6378286">(</span><span class="string" id="6378287">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="6378315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6378320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378325">currentHuffmanTree</span>&nbsp;<span class="op" id="6378344">=</span>&nbsp;<span class="ident" id="6378346">huffmanTrees</span><span class="op" id="6378358">[</span><span class="ident" id="6378359">treeIndexes</span><span class="op" id="6378370">[</span><span class="ident" id="6378371">selectorIndex</span><span class="op" id="6378384">]</span><span class="op" id="6378385">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378390">selectorIndex</span><span class="op" id="6378403">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378409">decoded</span>&nbsp;<span class="op" id="6378417">=</span>&nbsp;<span class="num" id="6378419">0</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6378423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378428">v</span>&nbsp;<span class="op" id="6378430">:=</span>&nbsp;<span class="ident" id="6378433">currentHuffmanTree</span><span class="op" id="6378451">.</span><span class="ident" id="6378452">Decode</span><span class="op" id="6378458">(</span><span class="ident" id="6378459">br</span><span class="op" id="6378461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378465">decoded</span><span class="op" id="6378472">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378478">if</span>&nbsp;<span class="ident" id="6378481">v</span>&nbsp;<span class="op" id="6378483">&lt;</span>&nbsp;<span class="num" id="6378485">2</span>&nbsp;<span class="op" id="6378487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378492">//&nbsp;This&nbsp;is&nbsp;either&nbsp;the&nbsp;RUNA&nbsp;or&nbsp;RUNB&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378538">if</span>&nbsp;<span class="ident" id="6378541">repeat</span>&nbsp;<span class="op" id="6378548">==</span>&nbsp;<span class="num" id="6378551">0</span>&nbsp;<span class="op" id="6378553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378559">repeat_power</span>&nbsp;<span class="op" id="6378572">=</span>&nbsp;<span class="num" id="6378574">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6378579">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378584">repeat</span>&nbsp;<span class="op" id="6378591">+=</span>&nbsp;<span class="ident" id="6378594">repeat_power</span>&nbsp;<span class="op" id="6378607">&lt;&lt;</span>&nbsp;<span class="ident" id="6378610">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378615">repeat_power</span>&nbsp;<span class="op" id="6378628">&lt;&lt;=</span>&nbsp;<span class="num" id="6378632">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378638">//&nbsp;This&nbsp;limit&nbsp;of&nbsp;2&nbsp;million&nbsp;comes&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378696">//&nbsp;code.&nbsp;It&nbsp;prevents&nbsp;repeat&nbsp;from&nbsp;overflowing.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378745">if</span>&nbsp;<span class="ident" id="6378748">repeat</span>&nbsp;<span class="op" id="6378755">&gt;</span>&nbsp;<span class="num" id="6378757">2</span><span class="op" id="6378758">*</span><span class="num" id="6378759">1024</span><span class="op" id="6378763">*</span><span class="num" id="6378764">1024</span>&nbsp;<span class="op" id="6378769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378775">return</span>&nbsp;<span class="ident" id="6378782">StructuralError</span><span class="op" id="6378797">(</span><span class="string" id="6378798">&#34;repeat&nbsp;count&nbsp;too&nbsp;large&#34;</span><span class="op" id="6378822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6378827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378832">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6378843">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378848">if</span>&nbsp;<span class="ident" id="6378851">repeat</span>&nbsp;<span class="op" id="6378858">&gt;</span>&nbsp;<span class="num" id="6378860">0</span>&nbsp;<span class="op" id="6378862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378867">//&nbsp;We&nbsp;have&nbsp;decoded&nbsp;a&nbsp;complete&nbsp;run-length&nbsp;so&nbsp;we&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378925">//&nbsp;replicate&nbsp;the&nbsp;last&nbsp;output&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378965">if</span>&nbsp;<span class="ident" id="6378968">repeat</span>&nbsp;<span class="op" id="6378975">&gt;</span>&nbsp;<span class="ident" id="6378977">bz2</span><span class="op" id="6378980">.</span><span class="ident" id="6378981">blockSize</span><span class="op" id="6378990">-</span><span class="ident" id="6378991">bufIndex</span>&nbsp;<span class="op" id="6379000">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379006">return</span>&nbsp;<span class="ident" id="6379013">StructuralError</span><span class="op" id="6379028">(</span><span class="string" id="6379029">&#34;repeats&nbsp;past&nbsp;end&nbsp;of&nbsp;block&#34;</span><span class="op" id="6379056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379066">for</span>&nbsp;<span class="ident" id="6379070">i</span>&nbsp;<span class="op" id="6379072">:=</span>&nbsp;<span class="num" id="6379075">0</span><span class="op" id="6379076">;</span>&nbsp;<span class="ident" id="6379078">i</span>&nbsp;<span class="op" id="6379080">&lt;</span>&nbsp;<span class="ident" id="6379082">repeat</span><span class="op" id="6379088">;</span>&nbsp;<span class="ident" id="6379090">i</span><span class="op" id="6379091">++</span>&nbsp;<span class="op" id="6379094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379100">b</span>&nbsp;<span class="op" id="6379102">:=</span>&nbsp;<span class="builtintype" id="6379105">byte</span><span class="op" id="6379109">(</span><span class="ident" id="6379110">mtf</span><span class="op" id="6379113">.</span><span class="ident" id="6379114">First</span><span class="op" id="6379119">(</span><span class="op" id="6379120">)</span><span class="op" id="6379121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379127">bz2</span><span class="op" id="6379130">.</span><span class="ident" id="6379131">tt</span><span class="op" id="6379133">[</span><span class="ident" id="6379134">bufIndex</span><span class="op" id="6379142">]</span>&nbsp;<span class="op" id="6379144">=</span>&nbsp;<span class="builtintype" id="6379146">uint32</span><span class="op" id="6379152">(</span><span class="ident" id="6379153">b</span><span class="op" id="6379154">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379160">bz2</span><span class="op" id="6379163">.</span><span class="ident" id="6379164">c</span><span class="op" id="6379165">[</span><span class="ident" id="6379166">b</span><span class="op" id="6379167">]</span><span class="op" id="6379168">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379175">bufIndex</span><span class="op" id="6379183">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379194">repeat</span>&nbsp;<span class="op" id="6379201">=</span>&nbsp;<span class="num" id="6379203">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379207">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379212">if</span>&nbsp;<span class="builtintype" id="6379215">int</span><span class="op" id="6379218">(</span><span class="ident" id="6379219">v</span><span class="op" id="6379220">)</span>&nbsp;<span class="op" id="6379222">==</span>&nbsp;<span class="ident" id="6379225">numSymbols</span><span class="op" id="6379235">-</span><span class="num" id="6379236">1</span>&nbsp;<span class="op" id="6379238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6379243">//&nbsp;This&nbsp;is&nbsp;the&nbsp;EOF&nbsp;symbol.&nbsp;Because&nbsp;it&#39;s&nbsp;always&nbsp;at&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6379300">//&nbsp;end&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;list,&nbsp;and&nbsp;never&nbsp;gets&nbsp;moved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6379358">//&nbsp;to&nbsp;the&nbsp;front,&nbsp;it&nbsp;has&nbsp;this&nbsp;unique&nbsp;value.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379404">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6379417">//&nbsp;Since&nbsp;two&nbsp;metasymbols&nbsp;(RUNA&nbsp;and&nbsp;RUNB)&nbsp;have&nbsp;values&nbsp;0&nbsp;and&nbsp;1,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6379481">//&nbsp;one&nbsp;would&nbsp;expect&nbsp;|v-2|&nbsp;to&nbsp;be&nbsp;passed&nbsp;to&nbsp;the&nbsp;MTF&nbsp;decoder.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6379542">//&nbsp;However,&nbsp;the&nbsp;front&nbsp;of&nbsp;the&nbsp;MTF&nbsp;list&nbsp;is&nbsp;never&nbsp;referenced&nbsp;as&nbsp;0,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6379608">//&nbsp;it&#39;s&nbsp;always&nbsp;referenced&nbsp;with&nbsp;a&nbsp;run-length&nbsp;of&nbsp;1.&nbsp;Thus&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6379667">//&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;encoded&nbsp;and&nbsp;we&nbsp;have&nbsp;|v-1|&nbsp;in&nbsp;the&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6379729">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379740">b</span>&nbsp;<span class="op" id="6379742">:=</span>&nbsp;<span class="builtintype" id="6379745">byte</span><span class="op" id="6379749">(</span><span class="ident" id="6379750">mtf</span><span class="op" id="6379753">.</span><span class="ident" id="6379754">Decode</span><span class="op" id="6379760">(</span><span class="builtintype" id="6379761">int</span><span class="op" id="6379764">(</span><span class="ident" id="6379765">v</span>&nbsp;<span class="op" id="6379767">-</span>&nbsp;<span class="num" id="6379769">1</span><span class="op" id="6379770">)</span><span class="op" id="6379771">)</span><span class="op" id="6379772">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379776">if</span>&nbsp;<span class="ident" id="6379779">bufIndex</span>&nbsp;<span class="op" id="6379788">&gt;=</span>&nbsp;<span class="ident" id="6379791">bz2</span><span class="op" id="6379794">.</span><span class="ident" id="6379795">blockSize</span>&nbsp;<span class="op" id="6379805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379810">return</span>&nbsp;<span class="ident" id="6379817">StructuralError</span><span class="op" id="6379832">(</span><span class="string" id="6379833">&#34;data&nbsp;exceeds&nbsp;block&nbsp;size&#34;</span><span class="op" id="6379858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379866">bz2</span><span class="op" id="6379869">.</span><span class="ident" id="6379870">tt</span><span class="op" id="6379872">[</span><span class="ident" id="6379873">bufIndex</span><span class="op" id="6379881">]</span>&nbsp;<span class="op" id="6379883">=</span>&nbsp;<span class="builtintype" id="6379885">uint32</span><span class="op" id="6379891">(</span><span class="ident" id="6379892">b</span><span class="op" id="6379893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379897">bz2</span><span class="op" id="6379900">.</span><span class="ident" id="6379901">c</span><span class="op" id="6379902">[</span><span class="ident" id="6379903">b</span><span class="op" id="6379904">]</span><span class="op" id="6379905">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379910">bufIndex</span><span class="op" id="6379918">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379926">if</span>&nbsp;<span class="ident" id="6379929">origPtr</span>&nbsp;<span class="op" id="6379937">&gt;=</span>&nbsp;<span class="builtintype" id="6379940">uint</span><span class="op" id="6379944">(</span><span class="ident" id="6379945">bufIndex</span><span class="op" id="6379953">)</span>&nbsp;<span class="op" id="6379955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379959">return</span>&nbsp;<span class="ident" id="6379966">StructuralError</span><span class="op" id="6379981">(</span><span class="string" id="6379982">&#34;origPtr&nbsp;out&nbsp;of&nbsp;bounds&#34;</span><span class="op" id="6380005">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6380008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6380012">//&nbsp;We&nbsp;have&nbsp;completed&nbsp;the&nbsp;entropy&nbsp;decoding.&nbsp;Now&nbsp;we&nbsp;can&nbsp;perform&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6380079">//&nbsp;inverse&nbsp;BWT&nbsp;and&nbsp;setup&nbsp;the&nbsp;RLE&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380121">bz2</span><span class="op" id="6380124">.</span><span class="ident" id="6380125">preRLE</span>&nbsp;<span class="op" id="6380132">=</span>&nbsp;<span class="ident" id="6380134">bz2</span><span class="op" id="6380137">.</span><span class="ident" id="6380138">tt</span><span class="op" id="6380140">[</span><span class="op" id="6380141">:</span><span class="ident" id="6380142">bufIndex</span><span class="op" id="6380150">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380153">bz2</span><span class="op" id="6380156">.</span><span class="ident" id="6380157">preRLEUsed</span>&nbsp;<span class="op" id="6380168">=</span>&nbsp;<span class="num" id="6380170">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380173">bz2</span><span class="op" id="6380176">.</span><span class="ident" id="6380177">tPos</span>&nbsp;<span class="op" id="6380182">=</span>&nbsp;<span class="ident" id="6380184">inverseBWT</span><span class="op" id="6380194">(</span><span class="ident" id="6380195">bz2</span><span class="op" id="6380198">.</span><span class="ident" id="6380199">preRLE</span><span class="op" id="6380205">,</span>&nbsp;<span class="ident" id="6380207">origPtr</span><span class="op" id="6380214">,</span>&nbsp;<span class="ident" id="6380216">bz2</span><span class="op" id="6380219">.</span><span class="ident" id="6380220">c</span><span class="op" id="6380221">[</span><span class="op" id="6380222">:</span><span class="op" id="6380223">]</span><span class="op" id="6380224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380227">bz2</span><span class="op" id="6380230">.</span><span class="ident" id="6380231">lastByte</span>&nbsp;<span class="op" id="6380240">=</span>&nbsp;<span class="op" id="6380242">-</span><span class="num" id="6380243">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380246">bz2</span><span class="op" id="6380249">.</span><span class="ident" id="6380250">byteRepeats</span>&nbsp;<span class="op" id="6380262">=</span>&nbsp;<span class="num" id="6380264">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380267">bz2</span><span class="op" id="6380270">.</span><span class="ident" id="6380271">repeats</span>&nbsp;<span class="op" id="6380279">=</span>&nbsp;<span class="num" id="6380281">0</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380285">return</span>&nbsp;<span class="ident" id="6380292">nil</span><br>
<span class="lineno"></span><span class="op" id="6380296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6380299">//&nbsp;inverseBWT&nbsp;implements&nbsp;the&nbsp;inverse&nbsp;Burrows-Wheeler&nbsp;transform&nbsp;as&nbsp;described&nbsp;in</span><br>
<span class="lineno">450</span><span class="comment" id="6380378">//&nbsp;http://www.hpl.hp.com/techreports/Compaq-DEC/SRC-RR-124.pdf,&nbsp;section&nbsp;4.2.</span><br>
<span class="lineno"></span><span class="comment" id="6380455">//&nbsp;In&nbsp;that&nbsp;document,&nbsp;origPtr&nbsp;is&nbsp;called&nbsp;`I&#39;&nbsp;and&nbsp;c&nbsp;is&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6380531">//&nbsp;first&nbsp;pass&nbsp;over&nbsp;the&nbsp;data.&nbsp;It&#39;s&nbsp;an&nbsp;argument&nbsp;here&nbsp;because&nbsp;we&nbsp;merge&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="6380609">//&nbsp;pass&nbsp;with&nbsp;the&nbsp;Huffman&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="comment" id="6380644">//</span><br>
<span class="lineno">455</span><span class="comment" id="6380647">//&nbsp;This&nbsp;also&nbsp;implements&nbsp;the&nbsp;`single&nbsp;array&#39;&nbsp;method&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="6380724">//&nbsp;which&nbsp;leaves&nbsp;the&nbsp;output,&nbsp;still&nbsp;shuffled,&nbsp;in&nbsp;the&nbsp;bottom&nbsp;8&nbsp;bits&nbsp;of&nbsp;tt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6380804">//&nbsp;index&nbsp;of&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;top&nbsp;24-bits.&nbsp;The&nbsp;index&nbsp;of&nbsp;the&nbsp;first&nbsp;byte&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="6380881">//&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="6380894">func</span>&nbsp;<span class="ident" id="6380899">inverseBWT</span><span class="op" id="6380909">(</span><span class="ident" id="6380910">tt</span>&nbsp;<span class="op" id="6380913">[</span><span class="op" id="6380914">]</span><span class="builtintype" id="6380915">uint32</span><span class="op" id="6380921">,</span>&nbsp;<span class="ident" id="6380923">origPtr</span>&nbsp;<span class="builtintype" id="6380931">uint</span><span class="op" id="6380935">,</span>&nbsp;<span class="ident" id="6380937">c</span>&nbsp;<span class="op" id="6380939">[</span><span class="op" id="6380940">]</span><span class="builtintype" id="6380941">uint</span><span class="op" id="6380945">)</span>&nbsp;<span class="builtintype" id="6380947">uint32</span>&nbsp;<span class="op" id="6380954">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380957">sum</span>&nbsp;<span class="op" id="6380961">:=</span>&nbsp;<span class="builtintype" id="6380964">uint</span><span class="op" id="6380968">(</span><span class="num" id="6380969">0</span><span class="op" id="6380970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380973">for</span>&nbsp;<span class="ident" id="6380977">i</span>&nbsp;<span class="op" id="6380979">:=</span>&nbsp;<span class="num" id="6380982">0</span><span class="op" id="6380983">;</span>&nbsp;<span class="ident" id="6380985">i</span>&nbsp;<span class="op" id="6380987">&lt;</span>&nbsp;<span class="num" id="6380989">256</span><span class="op" id="6380992">;</span>&nbsp;<span class="ident" id="6380994">i</span><span class="op" id="6380995">++</span>&nbsp;<span class="op" id="6380998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381002">sum</span>&nbsp;<span class="op" id="6381006">+=</span>&nbsp;<span class="ident" id="6381009">c</span><span class="op" id="6381010">[</span><span class="ident" id="6381011">i</span><span class="op" id="6381012">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381016">c</span><span class="op" id="6381017">[</span><span class="ident" id="6381018">i</span><span class="op" id="6381019">]</span>&nbsp;<span class="op" id="6381021">=</span>&nbsp;<span class="ident" id="6381023">sum</span>&nbsp;<span class="op" id="6381027">-</span>&nbsp;<span class="ident" id="6381029">c</span><span class="op" id="6381030">[</span><span class="ident" id="6381031">i</span><span class="op" id="6381032">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381035">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381039">for</span>&nbsp;<span class="ident" id="6381043">i</span>&nbsp;<span class="op" id="6381045">:=</span>&nbsp;<span class="keyword" id="6381048">range</span>&nbsp;<span class="ident" id="6381054">tt</span>&nbsp;<span class="op" id="6381057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381061">b</span>&nbsp;<span class="op" id="6381063">:=</span>&nbsp;<span class="ident" id="6381066">tt</span><span class="op" id="6381068">[</span><span class="ident" id="6381069">i</span><span class="op" id="6381070">]</span>&nbsp;<span class="op" id="6381072">&amp;</span>&nbsp;<span class="num" id="6381074">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381081">tt</span><span class="op" id="6381083">[</span><span class="ident" id="6381084">c</span><span class="op" id="6381085">[</span><span class="ident" id="6381086">b</span><span class="op" id="6381087">]</span><span class="op" id="6381088">]</span>&nbsp;<span class="op" id="6381090">|=</span>&nbsp;<span class="builtintype" id="6381093">uint32</span><span class="op" id="6381099">(</span><span class="ident" id="6381100">i</span><span class="op" id="6381101">)</span>&nbsp;<span class="op" id="6381103">&lt;&lt;</span>&nbsp;<span class="num" id="6381106">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381110">c</span><span class="op" id="6381111">[</span><span class="ident" id="6381112">b</span><span class="op" id="6381113">]</span><span class="op" id="6381114">++</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381122">return</span>&nbsp;<span class="ident" id="6381129">tt</span><span class="op" id="6381131">[</span><span class="ident" id="6381132">origPtr</span><span class="op" id="6381139">]</span>&nbsp;<span class="op" id="6381141">&gt;&gt;</span>&nbsp;<span class="num" id="6381144">8</span><br>
<span class="lineno"></span><span class="op" id="6381146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span><span class="comment" id="6381149">//&nbsp;This&nbsp;is&nbsp;a&nbsp;standard&nbsp;CRC32&nbsp;like&nbsp;in&nbsp;hash/crc32&nbsp;except&nbsp;that&nbsp;all&nbsp;the&nbsp;shifts&nbsp;are&nbsp;reversed,</span><br>
<span class="lineno"></span><span class="comment" id="6381237">//&nbsp;causing&nbsp;the&nbsp;bits&nbsp;in&nbsp;the&nbsp;input&nbsp;to&nbsp;be&nbsp;processed&nbsp;in&nbsp;the&nbsp;reverse&nbsp;of&nbsp;the&nbsp;usual&nbsp;order.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6381322">var</span>&nbsp;<span class="ident" id="6381326">crctab</span>&nbsp;<span class="op" id="6381333">[</span><span class="num" id="6381334">256</span><span class="op" id="6381337">]</span><span class="builtintype" id="6381338">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span><span class="keyword" id="6381346">func</span>&nbsp;<span class="ident" id="6381351">init</span><span class="op" id="6381355">(</span><span class="op" id="6381356">)</span>&nbsp;<span class="op" id="6381358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381361">const</span>&nbsp;<span class="ident" id="6381367">poly</span>&nbsp;<span class="op" id="6381372">=</span>&nbsp;<span class="num" id="6381374">0x04C11DB7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381386">for</span>&nbsp;<span class="ident" id="6381390">i</span>&nbsp;<span class="op" id="6381392">:=</span>&nbsp;<span class="keyword" id="6381395">range</span>&nbsp;<span class="ident" id="6381401">crctab</span>&nbsp;<span class="op" id="6381408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381412">crc</span>&nbsp;<span class="op" id="6381416">:=</span>&nbsp;<span class="builtintype" id="6381419">uint32</span><span class="op" id="6381425">(</span><span class="ident" id="6381426">i</span><span class="op" id="6381427">)</span>&nbsp;<span class="op" id="6381429">&lt;&lt;</span>&nbsp;<span class="num" id="6381432">24</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381437">for</span>&nbsp;<span class="ident" id="6381441">j</span>&nbsp;<span class="op" id="6381443">:=</span>&nbsp;<span class="num" id="6381446">0</span><span class="op" id="6381447">;</span>&nbsp;<span class="ident" id="6381449">j</span>&nbsp;<span class="op" id="6381451">&lt;</span>&nbsp;<span class="num" id="6381453">8</span><span class="op" id="6381454">;</span>&nbsp;<span class="ident" id="6381456">j</span><span class="op" id="6381457">++</span>&nbsp;<span class="op" id="6381460">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381465">if</span>&nbsp;<span class="ident" id="6381468">crc</span><span class="op" id="6381471">&amp;</span><span class="num" id="6381472">0x80000000</span>&nbsp;<span class="op" id="6381483">!=</span>&nbsp;<span class="num" id="6381486">0</span>&nbsp;<span class="op" id="6381488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381494">crc</span>&nbsp;<span class="op" id="6381498">=</span>&nbsp;<span class="op" id="6381500">(</span><span class="ident" id="6381501">crc</span>&nbsp;<span class="op" id="6381505">&lt;&lt;</span>&nbsp;<span class="num" id="6381508">1</span><span class="op" id="6381509">)</span>&nbsp;<span class="op" id="6381511">^</span>&nbsp;<span class="ident" id="6381513">poly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381521">}</span>&nbsp;<span class="keyword" id="6381523">else</span>&nbsp;<span class="op" id="6381528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381534">crc</span>&nbsp;<span class="op" id="6381538">&lt;&lt;=</span>&nbsp;<span class="num" id="6381542">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381547">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381555">crctab</span><span class="op" id="6381561">[</span><span class="ident" id="6381562">i</span><span class="op" id="6381563">]</span>&nbsp;<span class="op" id="6381565">=</span>&nbsp;<span class="ident" id="6381567">crc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381572">}</span><br>
<span class="lineno"></span><span class="op" id="6381574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="6381577">//&nbsp;updateCRC&nbsp;updates&nbsp;the&nbsp;crc&nbsp;value&nbsp;to&nbsp;incorporate&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="6381642">//&nbsp;The&nbsp;initial&nbsp;value&nbsp;is&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="6381669">func</span>&nbsp;<span class="ident" id="6381674">updateCRC</span><span class="op" id="6381683">(</span><span class="ident" id="6381684">val</span>&nbsp;<span class="builtintype" id="6381688">uint32</span><span class="op" id="6381694">,</span>&nbsp;<span class="ident" id="6381696">b</span>&nbsp;<span class="op" id="6381698">[</span><span class="op" id="6381699">]</span><span class="builtintype" id="6381700">byte</span><span class="op" id="6381704">)</span>&nbsp;<span class="builtintype" id="6381706">uint32</span>&nbsp;<span class="op" id="6381713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381716">crc</span>&nbsp;<span class="op" id="6381720">:=</span>&nbsp;<span class="op" id="6381723">^</span><span class="ident" id="6381724">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381729">for</span>&nbsp;<span class="ident" id="6381733">_</span><span class="op" id="6381734">,</span>&nbsp;<span class="ident" id="6381736">v</span>&nbsp;<span class="op" id="6381738">:=</span>&nbsp;<span class="keyword" id="6381741">range</span>&nbsp;<span class="ident" id="6381747">b</span>&nbsp;<span class="op" id="6381749">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381753">crc</span>&nbsp;<span class="op" id="6381757">=</span>&nbsp;<span class="ident" id="6381759">crctab</span><span class="op" id="6381765">[</span><span class="builtintype" id="6381766">byte</span><span class="op" id="6381770">(</span><span class="ident" id="6381771">crc</span><span class="op" id="6381774">&gt;&gt;</span><span class="num" id="6381776">24</span><span class="op" id="6381778">)</span><span class="op" id="6381779">^</span><span class="ident" id="6381780">v</span><span class="op" id="6381781">]</span>&nbsp;<span class="op" id="6381783">^</span>&nbsp;<span class="op" id="6381785">(</span><span class="ident" id="6381786">crc</span>&nbsp;<span class="op" id="6381790">&lt;&lt;</span>&nbsp;<span class="num" id="6381793">8</span><span class="op" id="6381794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381800">return</span>&nbsp;<span class="op" id="6381807">^</span><span class="ident" id="6381808">crc</span><br>
<span class="lineno"></span><span class="op" id="6381812">}</span>
</div>
</body>
</html>
