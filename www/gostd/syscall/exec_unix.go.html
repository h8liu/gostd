<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html" class="current">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2592600">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2592655">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2592709">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2592760">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2592825">//&nbsp;Fork,&nbsp;exec,&nbsp;wait,&nbsp;etc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2592852">package</span>&nbsp;<span class="ident" id="2592860">syscall</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="2592869">import</span>&nbsp;<span class="op" id="2592876">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2592879">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2592890">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2592898">&#34;unsafe&#34;</span><br>
<span class="lineno">15</span><span class="op" id="2592907">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2592910">//&nbsp;Lock&nbsp;synchronizing&nbsp;creation&nbsp;of&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;with&nbsp;fork.</span><br>
<span class="lineno"></span><span class="comment" id="2592976">//</span><br>
<span class="lineno"></span><span class="comment" id="2592979">//&nbsp;We&nbsp;want&nbsp;the&nbsp;child&nbsp;in&nbsp;a&nbsp;fork/exec&nbsp;sequence&nbsp;to&nbsp;inherit&nbsp;only&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="2593044">//&nbsp;file&nbsp;descriptors&nbsp;we&nbsp;intend.&nbsp;&nbsp;To&nbsp;do&nbsp;that,&nbsp;we&nbsp;mark&nbsp;all&nbsp;file</span><br>
<span class="lineno"></span><span class="comment" id="2593105">//&nbsp;descriptors&nbsp;close-on-exec&nbsp;and&nbsp;then,&nbsp;in&nbsp;the&nbsp;child,&nbsp;explicitly</span><br>
<span class="lineno"></span><span class="comment" id="2593169">//&nbsp;unmark&nbsp;the&nbsp;ones&nbsp;we&nbsp;want&nbsp;the&nbsp;exec&#39;ed&nbsp;program&nbsp;to&nbsp;keep.</span><br>
<span class="lineno"></span><span class="comment" id="2593225">//&nbsp;Unix&nbsp;doesn&#39;t&nbsp;make&nbsp;this&nbsp;easy:&nbsp;there&nbsp;is,&nbsp;in&nbsp;general,&nbsp;no&nbsp;way&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2593289">//&nbsp;allocate&nbsp;a&nbsp;new&nbsp;file&nbsp;descriptor&nbsp;close-on-exec.&nbsp;&nbsp;Instead&nbsp;you</span><br>
<span class="lineno">25</span><span class="comment" id="2593351">//&nbsp;have&nbsp;to&nbsp;allocate&nbsp;the&nbsp;descriptor&nbsp;and&nbsp;then&nbsp;mark&nbsp;it&nbsp;close-on-exec.</span><br>
<span class="lineno"></span><span class="comment" id="2593418">//&nbsp;If&nbsp;a&nbsp;fork&nbsp;happens&nbsp;between&nbsp;those&nbsp;two&nbsp;events,&nbsp;the&nbsp;child&#39;s&nbsp;exec</span><br>
<span class="lineno"></span><span class="comment" id="2593482">//&nbsp;will&nbsp;inherit&nbsp;an&nbsp;unwanted&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="comment" id="2593527">//</span><br>
<span class="lineno"></span><span class="comment" id="2593530">//&nbsp;This&nbsp;lock&nbsp;solves&nbsp;that&nbsp;race:&nbsp;the&nbsp;create&nbsp;new&nbsp;fd/mark&nbsp;close-on-exec</span><br>
<span class="lineno">30</span><span class="comment" id="2593598">//&nbsp;operation&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;reading,&nbsp;and&nbsp;the&nbsp;fork&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2593669">//&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;writing.&nbsp;&nbsp;At&nbsp;least,&nbsp;that&#39;s&nbsp;the&nbsp;idea.</span><br>
<span class="lineno"></span><span class="comment" id="2593738">//&nbsp;There&nbsp;are&nbsp;some&nbsp;complications.</span><br>
<span class="lineno"></span><span class="comment" id="2593771">//</span><br>
<span class="lineno"></span><span class="comment" id="2593774">//&nbsp;Some&nbsp;system&nbsp;calls&nbsp;that&nbsp;create&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;can&nbsp;block</span><br>
<span class="lineno">35</span><span class="comment" id="2593838">//&nbsp;for&nbsp;arbitrarily&nbsp;long&nbsp;times:&nbsp;open&nbsp;on&nbsp;a&nbsp;hung&nbsp;NFS&nbsp;server&nbsp;or&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="2593904">//&nbsp;pipe,&nbsp;accept&nbsp;on&nbsp;a&nbsp;socket,&nbsp;and&nbsp;so&nbsp;on.&nbsp;&nbsp;We&nbsp;can&#39;t&nbsp;reasonably&nbsp;grab</span><br>
<span class="lineno"></span><span class="comment" id="2593970">//&nbsp;the&nbsp;lock&nbsp;across&nbsp;those&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="2594007">//</span><br>
<span class="lineno"></span><span class="comment" id="2594010">//&nbsp;It&nbsp;is&nbsp;worse&nbsp;to&nbsp;inherit&nbsp;some&nbsp;file&nbsp;descriptors&nbsp;than&nbsp;others.</span><br>
<span class="lineno">40</span><span class="comment" id="2594071">//&nbsp;If&nbsp;a&nbsp;non-malicious&nbsp;child&nbsp;accidentally&nbsp;inherits&nbsp;an&nbsp;open&nbsp;ordinary&nbsp;file,</span><br>
<span class="lineno"></span><span class="comment" id="2594144">//&nbsp;that&#39;s&nbsp;not&nbsp;a&nbsp;big&nbsp;deal.&nbsp;&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;if&nbsp;a&nbsp;long-lived&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="2594212">//&nbsp;accidentally&nbsp;inherits&nbsp;the&nbsp;write&nbsp;end&nbsp;of&nbsp;a&nbsp;pipe,&nbsp;then&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span><span class="comment" id="2594278">//&nbsp;of&nbsp;that&nbsp;pipe&nbsp;will&nbsp;not&nbsp;see&nbsp;EOF&nbsp;until&nbsp;that&nbsp;child&nbsp;exits,&nbsp;potentially</span><br>
<span class="lineno"></span><span class="comment" id="2594347">//&nbsp;causing&nbsp;the&nbsp;parent&nbsp;program&nbsp;to&nbsp;hang.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;common&nbsp;problem</span><br>
<span class="lineno">45</span><span class="comment" id="2594412">//&nbsp;in&nbsp;threaded&nbsp;C&nbsp;programs&nbsp;that&nbsp;use&nbsp;popen.</span><br>
<span class="lineno"></span><span class="comment" id="2594454">//</span><br>
<span class="lineno"></span><span class="comment" id="2594457">//&nbsp;Luckily,&nbsp;the&nbsp;file&nbsp;descriptors&nbsp;that&nbsp;are&nbsp;most&nbsp;important&nbsp;not&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2594521">//&nbsp;inherit&nbsp;are&nbsp;not&nbsp;the&nbsp;ones&nbsp;that&nbsp;can&nbsp;take&nbsp;an&nbsp;arbitrarily&nbsp;long&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="2594588">//&nbsp;to&nbsp;create:&nbsp;pipe&nbsp;returns&nbsp;instantly,&nbsp;and&nbsp;the&nbsp;net&nbsp;package&nbsp;uses</span><br>
<span class="lineno">50</span><span class="comment" id="2594651">//&nbsp;non-blocking&nbsp;I/O&nbsp;to&nbsp;accept&nbsp;on&nbsp;a&nbsp;listening&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="2594704">//&nbsp;The&nbsp;rules&nbsp;for&nbsp;which&nbsp;file&nbsp;descriptor-creating&nbsp;operations&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2594771">//&nbsp;ForkLock&nbsp;are&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="2594799">//</span><br>
<span class="lineno"></span><span class="comment" id="2594802">//&nbsp;1)&nbsp;Pipe.&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno">55</span><span class="comment" id="2594852">//&nbsp;2)&nbsp;Socket.&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2594902">//&nbsp;3)&nbsp;Accept.&nbsp;&nbsp;If&nbsp;using&nbsp;non-blocking&nbsp;mode,&nbsp;use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2594963">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno"></span><span class="comment" id="2595009">//&nbsp;4)&nbsp;Open.&nbsp;&nbsp;&nbsp;&nbsp;Can&nbsp;block.&nbsp;&nbsp;Use&nbsp;O_CLOEXEC&nbsp;if&nbsp;available&nbsp;(Linux).</span><br>
<span class="lineno"></span><span class="comment" id="2595072">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno">60</span><span class="comment" id="2595118">//&nbsp;5)&nbsp;Dup.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2595168">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On&nbsp;Linux,&nbsp;could&nbsp;use&nbsp;fcntl&nbsp;F_DUPFD_CLOEXEC</span><br>
<span class="lineno"></span><span class="comment" id="2595225">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instead&nbsp;of&nbsp;the&nbsp;ForkLock,&nbsp;but&nbsp;only&nbsp;for&nbsp;dup(fd,&nbsp;-1).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2595292">var</span>&nbsp;<span class="ident" id="2595296">ForkLock</span>&nbsp;<span class="ident" id="2595305">sync</span><span class="op" id="2595309">.</span><span class="ident" id="2595310">RWMutex</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2595319">//&nbsp;StringSlicePtr&nbsp;is&nbsp;deprecated.&nbsp;Use&nbsp;SlicePtrFromStrings&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="2595385">//&nbsp;If&nbsp;any&nbsp;string&nbsp;contains&nbsp;a&nbsp;NUL&nbsp;byte&nbsp;this&nbsp;function&nbsp;panics&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="2595451">//&nbsp;of&nbsp;returning&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="2595477">func</span>&nbsp;<span class="ident" id="2595482">StringSlicePtr</span><span class="op" id="2595496">(</span><span class="ident" id="2595497">ss</span>&nbsp;<span class="op" id="2595500">[</span><span class="op" id="2595501">]</span><span class="builtintype" id="2595502">string</span><span class="op" id="2595508">)</span>&nbsp;<span class="op" id="2595510">[</span><span class="op" id="2595511">]</span><span class="op" id="2595512">*</span><span class="builtintype" id="2595513">byte</span>&nbsp;<span class="op" id="2595518">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2595521">bb</span>&nbsp;<span class="op" id="2595524">:=</span>&nbsp;<span class="builtinfunc" id="2595527">make</span><span class="op" id="2595531">(</span><span class="op" id="2595532">[</span><span class="op" id="2595533">]</span><span class="op" id="2595534">*</span><span class="builtintype" id="2595535">byte</span><span class="op" id="2595539">,</span>&nbsp;<span class="builtinfunc" id="2595541">len</span><span class="op" id="2595544">(</span><span class="ident" id="2595545">ss</span><span class="op" id="2595547">)</span><span class="op" id="2595548">+</span><span class="num" id="2595549">1</span><span class="op" id="2595550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2595553">for</span>&nbsp;<span class="ident" id="2595557">i</span>&nbsp;<span class="op" id="2595559">:=</span>&nbsp;<span class="num" id="2595562">0</span><span class="op" id="2595563">;</span>&nbsp;<span class="ident" id="2595565">i</span>&nbsp;<span class="op" id="2595567">&lt;</span>&nbsp;<span class="builtinfunc" id="2595569">len</span><span class="op" id="2595572">(</span><span class="ident" id="2595573">ss</span><span class="op" id="2595575">)</span><span class="op" id="2595576">;</span>&nbsp;<span class="ident" id="2595578">i</span><span class="op" id="2595579">++</span>&nbsp;<span class="op" id="2595582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2595586">bb</span><span class="op" id="2595588">[</span><span class="ident" id="2595589">i</span><span class="op" id="2595590">]</span>&nbsp;<span class="op" id="2595592">=</span>&nbsp;<span class="ident" id="2595594">StringBytePtr</span><span class="op" id="2595607">(</span><span class="ident" id="2595608">ss</span><span class="op" id="2595610">[</span><span class="ident" id="2595611">i</span><span class="op" id="2595612">]</span><span class="op" id="2595613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2595616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2595619">bb</span><span class="op" id="2595621">[</span><span class="builtinfunc" id="2595622">len</span><span class="op" id="2595625">(</span><span class="ident" id="2595626">ss</span><span class="op" id="2595628">)</span><span class="op" id="2595629">]</span>&nbsp;<span class="op" id="2595631">=</span>&nbsp;<span class="ident" id="2595633">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2595638">return</span>&nbsp;<span class="ident" id="2595645">bb</span><br>
<span class="lineno"></span><span class="op" id="2595648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2595651">//&nbsp;SlicePtrFromStrings&nbsp;converts&nbsp;a&nbsp;slice&nbsp;of&nbsp;strings&nbsp;to&nbsp;a&nbsp;slice&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2595716">//&nbsp;pointers&nbsp;to&nbsp;NUL-terminated&nbsp;byte&nbsp;slices.&nbsp;If&nbsp;any&nbsp;string&nbsp;contains</span><br>
<span class="lineno">80</span><span class="comment" id="2595782">//&nbsp;a&nbsp;NUL&nbsp;byte,&nbsp;it&nbsp;returns&nbsp;(nil,&nbsp;EINVAL).</span><br>
<span class="lineno"></span><span class="keyword" id="2595823">func</span>&nbsp;<span class="ident" id="2595828">SlicePtrFromStrings</span><span class="op" id="2595847">(</span><span class="ident" id="2595848">ss</span>&nbsp;<span class="op" id="2595851">[</span><span class="op" id="2595852">]</span><span class="builtintype" id="2595853">string</span><span class="op" id="2595859">)</span>&nbsp;<span class="op" id="2595861">(</span><span class="op" id="2595862">[</span><span class="op" id="2595863">]</span><span class="op" id="2595864">*</span><span class="builtintype" id="2595865">byte</span><span class="op" id="2595869">,</span>&nbsp;<span class="builtintype" id="2595871">error</span><span class="op" id="2595876">)</span>&nbsp;<span class="op" id="2595878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2595881">var</span>&nbsp;<span class="ident" id="2595885">err</span>&nbsp;<span class="builtintype" id="2595889">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2595896">bb</span>&nbsp;<span class="op" id="2595899">:=</span>&nbsp;<span class="builtinfunc" id="2595902">make</span><span class="op" id="2595906">(</span><span class="op" id="2595907">[</span><span class="op" id="2595908">]</span><span class="op" id="2595909">*</span><span class="builtintype" id="2595910">byte</span><span class="op" id="2595914">,</span>&nbsp;<span class="builtinfunc" id="2595916">len</span><span class="op" id="2595919">(</span><span class="ident" id="2595920">ss</span><span class="op" id="2595922">)</span><span class="op" id="2595923">+</span><span class="num" id="2595924">1</span><span class="op" id="2595925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2595928">for</span>&nbsp;<span class="ident" id="2595932">i</span>&nbsp;<span class="op" id="2595934">:=</span>&nbsp;<span class="num" id="2595937">0</span><span class="op" id="2595938">;</span>&nbsp;<span class="ident" id="2595940">i</span>&nbsp;<span class="op" id="2595942">&lt;</span>&nbsp;<span class="builtinfunc" id="2595944">len</span><span class="op" id="2595947">(</span><span class="ident" id="2595948">ss</span><span class="op" id="2595950">)</span><span class="op" id="2595951">;</span>&nbsp;<span class="ident" id="2595953">i</span><span class="op" id="2595954">++</span>&nbsp;<span class="op" id="2595957">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2595961">bb</span><span class="op" id="2595963">[</span><span class="ident" id="2595964">i</span><span class="op" id="2595965">]</span><span class="op" id="2595966">,</span>&nbsp;<span class="ident" id="2595968">err</span>&nbsp;<span class="op" id="2595972">=</span>&nbsp;<span class="ident" id="2595974">BytePtrFromString</span><span class="op" id="2595991">(</span><span class="ident" id="2595992">ss</span><span class="op" id="2595994">[</span><span class="ident" id="2595995">i</span><span class="op" id="2595996">]</span><span class="op" id="2595997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2596001">if</span>&nbsp;<span class="ident" id="2596004">err</span>&nbsp;<span class="op" id="2596008">!=</span>&nbsp;<span class="ident" id="2596011">nil</span>&nbsp;<span class="op" id="2596015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2596020">return</span>&nbsp;<span class="ident" id="2596027">nil</span><span class="op" id="2596030">,</span>&nbsp;<span class="ident" id="2596032">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2596038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2596041">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2596044">bb</span><span class="op" id="2596046">[</span><span class="builtinfunc" id="2596047">len</span><span class="op" id="2596050">(</span><span class="ident" id="2596051">ss</span><span class="op" id="2596053">)</span><span class="op" id="2596054">]</span>&nbsp;<span class="op" id="2596056">=</span>&nbsp;<span class="ident" id="2596058">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2596063">return</span>&nbsp;<span class="ident" id="2596070">bb</span><span class="op" id="2596072">,</span>&nbsp;<span class="ident" id="2596074">nil</span><br>
<span class="lineno"></span><span class="op" id="2596078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2596081">func</span>&nbsp;<span class="ident" id="2596086">CloseOnExec</span><span class="op" id="2596097">(</span><span class="ident" id="2596098">fd</span>&nbsp;<span class="builtintype" id="2596101">int</span><span class="op" id="2596104">)</span>&nbsp;<span class="op" id="2596106">{</span>&nbsp;<span class="ident" id="2596108">fcntl</span><span class="op" id="2596113">(</span><span class="ident" id="2596114">fd</span><span class="op" id="2596116">,</span>&nbsp;<span class="ident" id="2596118">F_SETFD</span><span class="op" id="2596125">,</span>&nbsp;<span class="ident" id="2596127">FD_CLOEXEC</span><span class="op" id="2596137">)</span>&nbsp;<span class="op" id="2596139">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="2596142">func</span>&nbsp;<span class="ident" id="2596147">SetNonblock</span><span class="op" id="2596158">(</span><span class="ident" id="2596159">fd</span>&nbsp;<span class="builtintype" id="2596162">int</span><span class="op" id="2596165">,</span>&nbsp;<span class="ident" id="2596167">nonblocking</span>&nbsp;<span class="builtintype" id="2596179">bool</span><span class="op" id="2596183">)</span>&nbsp;<span class="op" id="2596185">(</span><span class="ident" id="2596186">err</span>&nbsp;<span class="builtintype" id="2596190">error</span><span class="op" id="2596195">)</span>&nbsp;<span class="op" id="2596197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2596200">flag</span><span class="op" id="2596204">,</span>&nbsp;<span class="ident" id="2596206">err</span>&nbsp;<span class="op" id="2596210">:=</span>&nbsp;<span class="ident" id="2596213">fcntl</span><span class="op" id="2596218">(</span><span class="ident" id="2596219">fd</span><span class="op" id="2596221">,</span>&nbsp;<span class="ident" id="2596223">F_GETFL</span><span class="op" id="2596230">,</span>&nbsp;<span class="num" id="2596232">0</span><span class="op" id="2596233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2596236">if</span>&nbsp;<span class="ident" id="2596239">err</span>&nbsp;<span class="op" id="2596243">!=</span>&nbsp;<span class="ident" id="2596246">nil</span>&nbsp;<span class="op" id="2596250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2596254">return</span>&nbsp;<span class="ident" id="2596261">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2596266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2596269">if</span>&nbsp;<span class="ident" id="2596272">nonblocking</span>&nbsp;<span class="op" id="2596284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2596288">flag</span>&nbsp;<span class="op" id="2596293">|=</span>&nbsp;<span class="ident" id="2596296">O_NONBLOCK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2596308">}</span>&nbsp;<span class="keyword" id="2596310">else</span>&nbsp;<span class="op" id="2596315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2596319">flag</span>&nbsp;<span class="op" id="2596324">&amp;=</span>&nbsp;<span class="op" id="2596327">^</span><span class="ident" id="2596328">O_NONBLOCK</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2596340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2596343">_</span><span class="op" id="2596344">,</span>&nbsp;<span class="ident" id="2596346">err</span>&nbsp;<span class="op" id="2596350">=</span>&nbsp;<span class="ident" id="2596352">fcntl</span><span class="op" id="2596357">(</span><span class="ident" id="2596358">fd</span><span class="op" id="2596360">,</span>&nbsp;<span class="ident" id="2596362">F_SETFL</span><span class="op" id="2596369">,</span>&nbsp;<span class="ident" id="2596371">flag</span><span class="op" id="2596375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2596378">return</span>&nbsp;<span class="ident" id="2596385">err</span><br>
<span class="lineno"></span><span class="op" id="2596389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="2596392">//&nbsp;Credential&nbsp;holds&nbsp;user&nbsp;and&nbsp;group&nbsp;identities&nbsp;to&nbsp;be&nbsp;assumed</span><br>
<span class="lineno"></span><span class="comment" id="2596452">//&nbsp;by&nbsp;a&nbsp;child&nbsp;process&nbsp;started&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno"></span><span class="keyword" id="2596499">type</span>&nbsp;<span class="ident" id="2596504">Credential</span>&nbsp;<span class="keyword" id="2596515">struct</span>&nbsp;<span class="op" id="2596522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2596525">Uid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2596532">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2596541">//&nbsp;User&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2596554">Gid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2596561">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2596570">//&nbsp;Group&nbsp;ID.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2596584">Groups</span>&nbsp;<span class="op" id="2596591">[</span><span class="op" id="2596592">]</span><span class="builtintype" id="2596593">uint32</span>&nbsp;<span class="comment" id="2596600">//&nbsp;Supplementary&nbsp;group&nbsp;IDs.</span><br>
<span class="lineno"></span><span class="op" id="2596628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2596631">//&nbsp;ProcAttr&nbsp;holds&nbsp;attributes&nbsp;that&nbsp;will&nbsp;be&nbsp;applied&nbsp;to&nbsp;a&nbsp;new&nbsp;process&nbsp;started</span><br>
<span class="lineno"></span><span class="comment" id="2596706">//&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno">120</span><span class="keyword" id="2596726">type</span>&nbsp;<span class="ident" id="2596731">ProcAttr</span>&nbsp;<span class="keyword" id="2596740">struct</span>&nbsp;<span class="op" id="2596747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2596750">Dir</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2596756">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2596766">//&nbsp;Current&nbsp;working&nbsp;directory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2596797">Env</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2596803">[</span><span class="op" id="2596804">]</span><span class="builtintype" id="2596805">string</span>&nbsp;&nbsp;<span class="comment" id="2596813">//&nbsp;Environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2596830">Files</span>&nbsp;<span class="op" id="2596836">[</span><span class="op" id="2596837">]</span><span class="builtintype" id="2596838">uintptr</span>&nbsp;<span class="comment" id="2596846">//&nbsp;File&nbsp;descriptors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2596868">Sys</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2596874">*</span><span class="ident" id="2596875">SysProcAttr</span><br>
<span class="lineno">125</span><span class="op" id="2596887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2596890">var</span>&nbsp;<span class="ident" id="2596894">zeroProcAttr</span>&nbsp;<span class="ident" id="2596907">ProcAttr</span><br>
<span class="lineno"></span><span class="keyword" id="2596916">var</span>&nbsp;<span class="ident" id="2596920">zeroSysProcAttr</span>&nbsp;<span class="ident" id="2596936">SysProcAttr</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2596949">func</span>&nbsp;<span class="ident" id="2596954">forkExec</span><span class="op" id="2596962">(</span><span class="ident" id="2596963">argv0</span>&nbsp;<span class="builtintype" id="2596969">string</span><span class="op" id="2596975">,</span>&nbsp;<span class="ident" id="2596977">argv</span>&nbsp;<span class="op" id="2596982">[</span><span class="op" id="2596983">]</span><span class="builtintype" id="2596984">string</span><span class="op" id="2596990">,</span>&nbsp;<span class="ident" id="2596992">attr</span>&nbsp;<span class="op" id="2596997">*</span><span class="ident" id="2596998">ProcAttr</span><span class="op" id="2597006">)</span>&nbsp;<span class="op" id="2597008">(</span><span class="ident" id="2597009">pid</span>&nbsp;<span class="builtintype" id="2597013">int</span><span class="op" id="2597016">,</span>&nbsp;<span class="ident" id="2597018">err</span>&nbsp;<span class="builtintype" id="2597022">error</span><span class="op" id="2597027">)</span>&nbsp;<span class="op" id="2597029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597032">var</span>&nbsp;<span class="ident" id="2597036">p</span>&nbsp;<span class="op" id="2597038">[</span><span class="num" id="2597039">2</span><span class="op" id="2597040">]</span><span class="builtintype" id="2597041">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597046">var</span>&nbsp;<span class="ident" id="2597050">n</span>&nbsp;<span class="builtintype" id="2597052">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597057">var</span>&nbsp;<span class="ident" id="2597061">err1</span>&nbsp;<span class="ident" id="2597066">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597073">var</span>&nbsp;<span class="ident" id="2597077">wstatus</span>&nbsp;<span class="ident" id="2597085">WaitStatus</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597098">if</span>&nbsp;<span class="ident" id="2597101">attr</span>&nbsp;<span class="op" id="2597106">==</span>&nbsp;<span class="ident" id="2597109">nil</span>&nbsp;<span class="op" id="2597113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2597117">attr</span>&nbsp;<span class="op" id="2597122">=</span>&nbsp;<span class="op" id="2597124">&amp;</span><span class="ident" id="2597125">zeroProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2597139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2597142">sys</span>&nbsp;<span class="op" id="2597146">:=</span>&nbsp;<span class="ident" id="2597149">attr</span><span class="op" id="2597153">.</span><span class="ident" id="2597154">Sys</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597159">if</span>&nbsp;<span class="ident" id="2597162">sys</span>&nbsp;<span class="op" id="2597166">==</span>&nbsp;<span class="ident" id="2597169">nil</span>&nbsp;<span class="op" id="2597173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2597177">sys</span>&nbsp;<span class="op" id="2597181">=</span>&nbsp;<span class="op" id="2597183">&amp;</span><span class="ident" id="2597184">zeroSysProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2597201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2597205">p</span><span class="op" id="2597206">[</span><span class="num" id="2597207">0</span><span class="op" id="2597208">]</span>&nbsp;<span class="op" id="2597210">=</span>&nbsp;<span class="op" id="2597212">-</span><span class="num" id="2597213">1</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2597216">p</span><span class="op" id="2597217">[</span><span class="num" id="2597218">1</span><span class="op" id="2597219">]</span>&nbsp;<span class="op" id="2597221">=</span>&nbsp;<span class="op" id="2597223">-</span><span class="num" id="2597224">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2597228">//&nbsp;Convert&nbsp;args&nbsp;to&nbsp;C&nbsp;form.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2597256">argv0p</span><span class="op" id="2597262">,</span>&nbsp;<span class="ident" id="2597264">err</span>&nbsp;<span class="op" id="2597268">:=</span>&nbsp;<span class="ident" id="2597271">BytePtrFromString</span><span class="op" id="2597288">(</span><span class="ident" id="2597289">argv0</span><span class="op" id="2597294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597297">if</span>&nbsp;<span class="ident" id="2597300">err</span>&nbsp;<span class="op" id="2597304">!=</span>&nbsp;<span class="ident" id="2597307">nil</span>&nbsp;<span class="op" id="2597311">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597315">return</span>&nbsp;<span class="num" id="2597322">0</span><span class="op" id="2597323">,</span>&nbsp;<span class="ident" id="2597325">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2597330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2597333">argvp</span><span class="op" id="2597338">,</span>&nbsp;<span class="ident" id="2597340">err</span>&nbsp;<span class="op" id="2597344">:=</span>&nbsp;<span class="ident" id="2597347">SlicePtrFromStrings</span><span class="op" id="2597366">(</span><span class="ident" id="2597367">argv</span><span class="op" id="2597371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597374">if</span>&nbsp;<span class="ident" id="2597377">err</span>&nbsp;<span class="op" id="2597381">!=</span>&nbsp;<span class="ident" id="2597384">nil</span>&nbsp;<span class="op" id="2597388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597392">return</span>&nbsp;<span class="num" id="2597399">0</span><span class="op" id="2597400">,</span>&nbsp;<span class="ident" id="2597402">err</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2597407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2597410">envvp</span><span class="op" id="2597415">,</span>&nbsp;<span class="ident" id="2597417">err</span>&nbsp;<span class="op" id="2597421">:=</span>&nbsp;<span class="ident" id="2597424">SlicePtrFromStrings</span><span class="op" id="2597443">(</span><span class="ident" id="2597444">attr</span><span class="op" id="2597448">.</span><span class="ident" id="2597449">Env</span><span class="op" id="2597452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597455">if</span>&nbsp;<span class="ident" id="2597458">err</span>&nbsp;<span class="op" id="2597462">!=</span>&nbsp;<span class="ident" id="2597465">nil</span>&nbsp;<span class="op" id="2597469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597473">return</span>&nbsp;<span class="num" id="2597480">0</span><span class="op" id="2597481">,</span>&nbsp;<span class="ident" id="2597483">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2597488">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597492">if</span>&nbsp;<span class="op" id="2597495">(</span><span class="ident" id="2597496">runtime</span><span class="op" id="2597503">.</span><span class="ident" id="2597504">GOOS</span>&nbsp;<span class="op" id="2597509">==</span>&nbsp;<span class="string" id="2597512">&#34;freebsd&#34;</span>&nbsp;<span class="op" id="2597522">||</span>&nbsp;<span class="ident" id="2597525">runtime</span><span class="op" id="2597532">.</span><span class="ident" id="2597533">GOOS</span>&nbsp;<span class="op" id="2597538">==</span>&nbsp;<span class="string" id="2597541">&#34;dragonfly&#34;</span><span class="op" id="2597552">)</span>&nbsp;<span class="op" id="2597554">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2597557">len</span><span class="op" id="2597560">(</span><span class="ident" id="2597561">argv</span><span class="op" id="2597565">[</span><span class="num" id="2597566">0</span><span class="op" id="2597567">]</span><span class="op" id="2597568">)</span>&nbsp;<span class="op" id="2597570">&gt;</span>&nbsp;<span class="builtinfunc" id="2597572">len</span><span class="op" id="2597575">(</span><span class="ident" id="2597576">argv0</span><span class="op" id="2597581">)</span>&nbsp;<span class="op" id="2597583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2597587">argvp</span><span class="op" id="2597592">[</span><span class="num" id="2597593">0</span><span class="op" id="2597594">]</span>&nbsp;<span class="op" id="2597596">=</span>&nbsp;<span class="ident" id="2597598">argv0p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2597606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597610">var</span>&nbsp;<span class="ident" id="2597614">chroot</span>&nbsp;<span class="op" id="2597621">*</span><span class="builtintype" id="2597622">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597628">if</span>&nbsp;<span class="ident" id="2597631">sys</span><span class="op" id="2597634">.</span><span class="ident" id="2597635">Chroot</span>&nbsp;<span class="op" id="2597642">!=</span>&nbsp;<span class="string" id="2597645">&#34;&#34;</span>&nbsp;<span class="op" id="2597648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2597652">chroot</span><span class="op" id="2597658">,</span>&nbsp;<span class="ident" id="2597660">err</span>&nbsp;<span class="op" id="2597664">=</span>&nbsp;<span class="ident" id="2597666">BytePtrFromString</span><span class="op" id="2597683">(</span><span class="ident" id="2597684">sys</span><span class="op" id="2597687">.</span><span class="ident" id="2597688">Chroot</span><span class="op" id="2597694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597698">if</span>&nbsp;<span class="ident" id="2597701">err</span>&nbsp;<span class="op" id="2597705">!=</span>&nbsp;<span class="ident" id="2597708">nil</span>&nbsp;<span class="op" id="2597712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597717">return</span>&nbsp;<span class="num" id="2597724">0</span><span class="op" id="2597725">,</span>&nbsp;<span class="ident" id="2597727">err</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2597733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2597736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597739">var</span>&nbsp;<span class="ident" id="2597743">dir</span>&nbsp;<span class="op" id="2597747">*</span><span class="builtintype" id="2597748">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597754">if</span>&nbsp;<span class="ident" id="2597757">attr</span><span class="op" id="2597761">.</span><span class="ident" id="2597762">Dir</span>&nbsp;<span class="op" id="2597766">!=</span>&nbsp;<span class="string" id="2597769">&#34;&#34;</span>&nbsp;<span class="op" id="2597772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2597776">dir</span><span class="op" id="2597779">,</span>&nbsp;<span class="ident" id="2597781">err</span>&nbsp;<span class="op" id="2597785">=</span>&nbsp;<span class="ident" id="2597787">BytePtrFromString</span><span class="op" id="2597804">(</span><span class="ident" id="2597805">attr</span><span class="op" id="2597809">.</span><span class="ident" id="2597810">Dir</span><span class="op" id="2597813">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597817">if</span>&nbsp;<span class="ident" id="2597820">err</span>&nbsp;<span class="op" id="2597824">!=</span>&nbsp;<span class="ident" id="2597827">nil</span>&nbsp;<span class="op" id="2597831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2597836">return</span>&nbsp;<span class="num" id="2597843">0</span><span class="op" id="2597844">,</span>&nbsp;<span class="ident" id="2597846">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2597852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2597855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2597859">//&nbsp;Acquire&nbsp;the&nbsp;fork&nbsp;lock&nbsp;so&nbsp;that&nbsp;no&nbsp;other&nbsp;threads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2597910">//&nbsp;create&nbsp;new&nbsp;fds&nbsp;that&nbsp;are&nbsp;not&nbsp;yet&nbsp;close-on-exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2597960">//&nbsp;before&nbsp;we&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2597980">ForkLock</span><span class="op" id="2597988">.</span><span class="ident" id="2597989">Lock</span><span class="op" id="2597993">(</span><span class="op" id="2597994">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2597998">//&nbsp;Allocate&nbsp;child&nbsp;status&nbsp;pipe&nbsp;close&nbsp;on&nbsp;exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2598044">if</span>&nbsp;<span class="ident" id="2598047">err</span>&nbsp;<span class="op" id="2598051">=</span>&nbsp;<span class="ident" id="2598053">forkExecPipe</span><span class="op" id="2598065">(</span><span class="ident" id="2598066">p</span><span class="op" id="2598067">[</span><span class="op" id="2598068">:</span><span class="op" id="2598069">]</span><span class="op" id="2598070">)</span><span class="op" id="2598071">;</span>&nbsp;<span class="ident" id="2598073">err</span>&nbsp;<span class="op" id="2598077">!=</span>&nbsp;<span class="ident" id="2598080">nil</span>&nbsp;<span class="op" id="2598084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2598088">goto</span>&nbsp;<span class="builtintype" id="2598093">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2598100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2598104">//&nbsp;Kick&nbsp;off&nbsp;child.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2598124">pid</span><span class="op" id="2598127">,</span>&nbsp;<span class="ident" id="2598129">err1</span>&nbsp;<span class="op" id="2598134">=</span>&nbsp;<span class="ident" id="2598136">forkAndExecInChild</span><span class="op" id="2598154">(</span><span class="ident" id="2598155">argv0p</span><span class="op" id="2598161">,</span>&nbsp;<span class="ident" id="2598163">argvp</span><span class="op" id="2598168">,</span>&nbsp;<span class="ident" id="2598170">envvp</span><span class="op" id="2598175">,</span>&nbsp;<span class="ident" id="2598177">chroot</span><span class="op" id="2598183">,</span>&nbsp;<span class="ident" id="2598185">dir</span><span class="op" id="2598188">,</span>&nbsp;<span class="ident" id="2598190">attr</span><span class="op" id="2598194">,</span>&nbsp;<span class="ident" id="2598196">sys</span><span class="op" id="2598199">,</span>&nbsp;<span class="ident" id="2598201">p</span><span class="op" id="2598202">[</span><span class="num" id="2598203">1</span><span class="op" id="2598204">]</span><span class="op" id="2598205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2598208">if</span>&nbsp;<span class="ident" id="2598211">err1</span>&nbsp;<span class="op" id="2598216">!=</span>&nbsp;<span class="num" id="2598219">0</span>&nbsp;<span class="op" id="2598221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2598225">err</span>&nbsp;<span class="op" id="2598229">=</span>&nbsp;<span class="ident" id="2598231">Errno</span><span class="op" id="2598236">(</span><span class="ident" id="2598237">err1</span><span class="op" id="2598241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2598245">goto</span>&nbsp;<span class="builtintype" id="2598250">error</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2598257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2598260">ForkLock</span><span class="op" id="2598268">.</span><span class="ident" id="2598269">Unlock</span><span class="op" id="2598275">(</span><span class="op" id="2598276">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2598280">//&nbsp;Read&nbsp;child&nbsp;error&nbsp;status&nbsp;from&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2598319">Close</span><span class="op" id="2598324">(</span><span class="ident" id="2598325">p</span><span class="op" id="2598326">[</span><span class="num" id="2598327">1</span><span class="op" id="2598328">]</span><span class="op" id="2598329">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2598332">n</span><span class="op" id="2598333">,</span>&nbsp;<span class="ident" id="2598335">err</span>&nbsp;<span class="op" id="2598339">=</span>&nbsp;<span class="ident" id="2598341">readlen</span><span class="op" id="2598348">(</span><span class="ident" id="2598349">p</span><span class="op" id="2598350">[</span><span class="num" id="2598351">0</span><span class="op" id="2598352">]</span><span class="op" id="2598353">,</span>&nbsp;<span class="op" id="2598355">(</span><span class="op" id="2598356">*</span><span class="builtintype" id="2598357">byte</span><span class="op" id="2598361">)</span><span class="op" id="2598362">(</span><span class="ident" id="2598363">unsafe</span><span class="op" id="2598369">.</span><span class="ident" id="2598370">Pointer</span><span class="op" id="2598377">(</span><span class="op" id="2598378">&amp;</span><span class="ident" id="2598379">err1</span><span class="op" id="2598383">)</span><span class="op" id="2598384">)</span><span class="op" id="2598385">,</span>&nbsp;<span class="builtintype" id="2598387">int</span><span class="op" id="2598390">(</span><span class="ident" id="2598391">unsafe</span><span class="op" id="2598397">.</span><span class="ident" id="2598398">Sizeof</span><span class="op" id="2598404">(</span><span class="ident" id="2598405">err1</span><span class="op" id="2598409">)</span><span class="op" id="2598410">)</span><span class="op" id="2598411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2598414">Close</span><span class="op" id="2598419">(</span><span class="ident" id="2598420">p</span><span class="op" id="2598421">[</span><span class="num" id="2598422">0</span><span class="op" id="2598423">]</span><span class="op" id="2598424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2598427">if</span>&nbsp;<span class="ident" id="2598430">err</span>&nbsp;<span class="op" id="2598434">!=</span>&nbsp;<span class="ident" id="2598437">nil</span>&nbsp;<span class="op" id="2598441">||</span>&nbsp;<span class="ident" id="2598444">n</span>&nbsp;<span class="op" id="2598446">!=</span>&nbsp;<span class="num" id="2598449">0</span>&nbsp;<span class="op" id="2598451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2598455">if</span>&nbsp;<span class="ident" id="2598458">n</span>&nbsp;<span class="op" id="2598460">==</span>&nbsp;<span class="builtintype" id="2598463">int</span><span class="op" id="2598466">(</span><span class="ident" id="2598467">unsafe</span><span class="op" id="2598473">.</span><span class="ident" id="2598474">Sizeof</span><span class="op" id="2598480">(</span><span class="ident" id="2598481">err1</span><span class="op" id="2598485">)</span><span class="op" id="2598486">)</span>&nbsp;<span class="op" id="2598488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2598493">err</span>&nbsp;<span class="op" id="2598497">=</span>&nbsp;<span class="ident" id="2598499">Errno</span><span class="op" id="2598504">(</span><span class="ident" id="2598505">err1</span><span class="op" id="2598509">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2598513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2598517">if</span>&nbsp;<span class="ident" id="2598520">err</span>&nbsp;<span class="op" id="2598524">==</span>&nbsp;<span class="ident" id="2598527">nil</span>&nbsp;<span class="op" id="2598531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2598536">err</span>&nbsp;<span class="op" id="2598540">=</span>&nbsp;<span class="ident" id="2598542">EPIPE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2598550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2598555">//&nbsp;Child&nbsp;failed;&nbsp;wait&nbsp;for&nbsp;it&nbsp;to&nbsp;exit,&nbsp;to&nbsp;make&nbsp;sure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2598608">//&nbsp;the&nbsp;zombies&nbsp;don&#39;t&nbsp;accumulate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2598643">_</span><span class="op" id="2598644">,</span>&nbsp;<span class="ident" id="2598646">err1</span>&nbsp;<span class="op" id="2598651">:=</span>&nbsp;<span class="ident" id="2598654">Wait4</span><span class="op" id="2598659">(</span><span class="ident" id="2598660">pid</span><span class="op" id="2598663">,</span>&nbsp;<span class="op" id="2598665">&amp;</span><span class="ident" id="2598666">wstatus</span><span class="op" id="2598673">,</span>&nbsp;<span class="num" id="2598675">0</span><span class="op" id="2598676">,</span>&nbsp;<span class="ident" id="2598678">nil</span><span class="op" id="2598681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2598685">for</span>&nbsp;<span class="ident" id="2598689">err1</span>&nbsp;<span class="op" id="2598694">==</span>&nbsp;<span class="ident" id="2598697">EINTR</span>&nbsp;<span class="op" id="2598703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2598708">_</span><span class="op" id="2598709">,</span>&nbsp;<span class="ident" id="2598711">err1</span>&nbsp;<span class="op" id="2598716">=</span>&nbsp;<span class="ident" id="2598718">Wait4</span><span class="op" id="2598723">(</span><span class="ident" id="2598724">pid</span><span class="op" id="2598727">,</span>&nbsp;<span class="op" id="2598729">&amp;</span><span class="ident" id="2598730">wstatus</span><span class="op" id="2598737">,</span>&nbsp;<span class="num" id="2598739">0</span><span class="op" id="2598740">,</span>&nbsp;<span class="ident" id="2598742">nil</span><span class="op" id="2598745">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2598749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2598753">return</span>&nbsp;<span class="num" id="2598760">0</span><span class="op" id="2598761">,</span>&nbsp;<span class="ident" id="2598763">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2598768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2598772">//&nbsp;Read&nbsp;got&nbsp;EOF,&nbsp;so&nbsp;pipe&nbsp;closed&nbsp;on&nbsp;exec,&nbsp;so&nbsp;exec&nbsp;succeeded.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2598833">return</span>&nbsp;<span class="ident" id="2598840">pid</span><span class="op" id="2598843">,</span>&nbsp;<span class="ident" id="2598845">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="builtintype" id="2598850">error</span><span class="op" id="2598855">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2598858">if</span>&nbsp;<span class="ident" id="2598861">p</span><span class="op" id="2598862">[</span><span class="num" id="2598863">0</span><span class="op" id="2598864">]</span>&nbsp;<span class="op" id="2598866">&gt;=</span>&nbsp;<span class="num" id="2598869">0</span>&nbsp;<span class="op" id="2598871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2598875">Close</span><span class="op" id="2598880">(</span><span class="ident" id="2598881">p</span><span class="op" id="2598882">[</span><span class="num" id="2598883">0</span><span class="op" id="2598884">]</span><span class="op" id="2598885">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2598889">Close</span><span class="op" id="2598894">(</span><span class="ident" id="2598895">p</span><span class="op" id="2598896">[</span><span class="num" id="2598897">1</span><span class="op" id="2598898">]</span><span class="op" id="2598899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2598902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2598905">ForkLock</span><span class="op" id="2598913">.</span><span class="ident" id="2598914">Unlock</span><span class="op" id="2598920">(</span><span class="op" id="2598921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2598924">return</span>&nbsp;<span class="num" id="2598931">0</span><span class="op" id="2598932">,</span>&nbsp;<span class="ident" id="2598934">err</span><br>
<span class="lineno"></span><span class="op" id="2598938">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="2598941">//&nbsp;Combination&nbsp;of&nbsp;fork&nbsp;and&nbsp;exec,&nbsp;careful&nbsp;to&nbsp;be&nbsp;thread&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="2599001">func</span>&nbsp;<span class="ident" id="2599006">ForkExec</span><span class="op" id="2599014">(</span><span class="ident" id="2599015">argv0</span>&nbsp;<span class="builtintype" id="2599021">string</span><span class="op" id="2599027">,</span>&nbsp;<span class="ident" id="2599029">argv</span>&nbsp;<span class="op" id="2599034">[</span><span class="op" id="2599035">]</span><span class="builtintype" id="2599036">string</span><span class="op" id="2599042">,</span>&nbsp;<span class="ident" id="2599044">attr</span>&nbsp;<span class="op" id="2599049">*</span><span class="ident" id="2599050">ProcAttr</span><span class="op" id="2599058">)</span>&nbsp;<span class="op" id="2599060">(</span><span class="ident" id="2599061">pid</span>&nbsp;<span class="builtintype" id="2599065">int</span><span class="op" id="2599068">,</span>&nbsp;<span class="ident" id="2599070">err</span>&nbsp;<span class="builtintype" id="2599074">error</span><span class="op" id="2599079">)</span>&nbsp;<span class="op" id="2599081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2599084">return</span>&nbsp;<span class="ident" id="2599091">forkExec</span><span class="op" id="2599099">(</span><span class="ident" id="2599100">argv0</span><span class="op" id="2599105">,</span>&nbsp;<span class="ident" id="2599107">argv</span><span class="op" id="2599111">,</span>&nbsp;<span class="ident" id="2599113">attr</span><span class="op" id="2599117">)</span><br>
<span class="lineno"></span><span class="op" id="2599119">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="2599122">//&nbsp;StartProcess&nbsp;wraps&nbsp;ForkExec&nbsp;for&nbsp;package&nbsp;os.</span><br>
<span class="lineno"></span><span class="keyword" id="2599169">func</span>&nbsp;<span class="ident" id="2599174">StartProcess</span><span class="op" id="2599186">(</span><span class="ident" id="2599187">argv0</span>&nbsp;<span class="builtintype" id="2599193">string</span><span class="op" id="2599199">,</span>&nbsp;<span class="ident" id="2599201">argv</span>&nbsp;<span class="op" id="2599206">[</span><span class="op" id="2599207">]</span><span class="builtintype" id="2599208">string</span><span class="op" id="2599214">,</span>&nbsp;<span class="ident" id="2599216">attr</span>&nbsp;<span class="op" id="2599221">*</span><span class="ident" id="2599222">ProcAttr</span><span class="op" id="2599230">)</span>&nbsp;<span class="op" id="2599232">(</span><span class="ident" id="2599233">pid</span>&nbsp;<span class="builtintype" id="2599237">int</span><span class="op" id="2599240">,</span>&nbsp;<span class="ident" id="2599242">handle</span>&nbsp;<span class="builtintype" id="2599249">uintptr</span><span class="op" id="2599256">,</span>&nbsp;<span class="ident" id="2599258">err</span>&nbsp;<span class="builtintype" id="2599262">error</span><span class="op" id="2599267">)</span>&nbsp;<span class="op" id="2599269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2599272">pid</span><span class="op" id="2599275">,</span>&nbsp;<span class="ident" id="2599277">err</span>&nbsp;<span class="op" id="2599281">=</span>&nbsp;<span class="ident" id="2599283">forkExec</span><span class="op" id="2599291">(</span><span class="ident" id="2599292">argv0</span><span class="op" id="2599297">,</span>&nbsp;<span class="ident" id="2599299">argv</span><span class="op" id="2599303">,</span>&nbsp;<span class="ident" id="2599305">attr</span><span class="op" id="2599309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2599312">return</span>&nbsp;<span class="ident" id="2599319">pid</span><span class="op" id="2599322">,</span>&nbsp;<span class="num" id="2599324">0</span><span class="op" id="2599325">,</span>&nbsp;<span class="ident" id="2599327">err</span><br>
<span class="lineno">240</span><span class="op" id="2599331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2599334">//&nbsp;Ordinary&nbsp;exec.</span><br>
<span class="lineno"></span><span class="keyword" id="2599352">func</span>&nbsp;<span class="ident" id="2599357">Exec</span><span class="op" id="2599361">(</span><span class="ident" id="2599362">argv0</span>&nbsp;<span class="builtintype" id="2599368">string</span><span class="op" id="2599374">,</span>&nbsp;<span class="ident" id="2599376">argv</span>&nbsp;<span class="op" id="2599381">[</span><span class="op" id="2599382">]</span><span class="builtintype" id="2599383">string</span><span class="op" id="2599389">,</span>&nbsp;<span class="ident" id="2599391">envv</span>&nbsp;<span class="op" id="2599396">[</span><span class="op" id="2599397">]</span><span class="builtintype" id="2599398">string</span><span class="op" id="2599404">)</span>&nbsp;<span class="op" id="2599406">(</span><span class="ident" id="2599407">err</span>&nbsp;<span class="builtintype" id="2599411">error</span><span class="op" id="2599416">)</span>&nbsp;<span class="op" id="2599418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2599421">argv0p</span><span class="op" id="2599427">,</span>&nbsp;<span class="ident" id="2599429">err</span>&nbsp;<span class="op" id="2599433">:=</span>&nbsp;<span class="ident" id="2599436">BytePtrFromString</span><span class="op" id="2599453">(</span><span class="ident" id="2599454">argv0</span><span class="op" id="2599459">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2599462">if</span>&nbsp;<span class="ident" id="2599465">err</span>&nbsp;<span class="op" id="2599469">!=</span>&nbsp;<span class="ident" id="2599472">nil</span>&nbsp;<span class="op" id="2599476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2599480">return</span>&nbsp;<span class="ident" id="2599487">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2599492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2599495">argvp</span><span class="op" id="2599500">,</span>&nbsp;<span class="ident" id="2599502">err</span>&nbsp;<span class="op" id="2599506">:=</span>&nbsp;<span class="ident" id="2599509">SlicePtrFromStrings</span><span class="op" id="2599528">(</span><span class="ident" id="2599529">argv</span><span class="op" id="2599533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2599536">if</span>&nbsp;<span class="ident" id="2599539">err</span>&nbsp;<span class="op" id="2599543">!=</span>&nbsp;<span class="ident" id="2599546">nil</span>&nbsp;<span class="op" id="2599550">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2599554">return</span>&nbsp;<span class="ident" id="2599561">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2599566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2599569">envvp</span><span class="op" id="2599574">,</span>&nbsp;<span class="ident" id="2599576">err</span>&nbsp;<span class="op" id="2599580">:=</span>&nbsp;<span class="ident" id="2599583">SlicePtrFromStrings</span><span class="op" id="2599602">(</span><span class="ident" id="2599603">envv</span><span class="op" id="2599607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2599610">if</span>&nbsp;<span class="ident" id="2599613">err</span>&nbsp;<span class="op" id="2599617">!=</span>&nbsp;<span class="ident" id="2599620">nil</span>&nbsp;<span class="op" id="2599624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2599628">return</span>&nbsp;<span class="ident" id="2599635">err</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2599640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2599643">_</span><span class="op" id="2599644">,</span>&nbsp;<span class="ident" id="2599646">_</span><span class="op" id="2599647">,</span>&nbsp;<span class="ident" id="2599649">err1</span>&nbsp;<span class="op" id="2599654">:=</span>&nbsp;<span class="ident" id="2599657">RawSyscall</span><span class="op" id="2599667">(</span><span class="ident" id="2599668">SYS_EXECVE</span><span class="op" id="2599678">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2599682">uintptr</span><span class="op" id="2599689">(</span><span class="ident" id="2599690">unsafe</span><span class="op" id="2599696">.</span><span class="ident" id="2599697">Pointer</span><span class="op" id="2599704">(</span><span class="ident" id="2599705">argv0p</span><span class="op" id="2599711">)</span><span class="op" id="2599712">)</span><span class="op" id="2599713">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2599717">uintptr</span><span class="op" id="2599724">(</span><span class="ident" id="2599725">unsafe</span><span class="op" id="2599731">.</span><span class="ident" id="2599732">Pointer</span><span class="op" id="2599739">(</span><span class="op" id="2599740">&amp;</span><span class="ident" id="2599741">argvp</span><span class="op" id="2599746">[</span><span class="num" id="2599747">0</span><span class="op" id="2599748">]</span><span class="op" id="2599749">)</span><span class="op" id="2599750">)</span><span class="op" id="2599751">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2599755">uintptr</span><span class="op" id="2599762">(</span><span class="ident" id="2599763">unsafe</span><span class="op" id="2599769">.</span><span class="ident" id="2599770">Pointer</span><span class="op" id="2599777">(</span><span class="op" id="2599778">&amp;</span><span class="ident" id="2599779">envvp</span><span class="op" id="2599784">[</span><span class="num" id="2599785">0</span><span class="op" id="2599786">]</span><span class="op" id="2599787">)</span><span class="op" id="2599788">)</span><span class="op" id="2599789">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2599792">return</span>&nbsp;<span class="ident" id="2599799">Errno</span><span class="op" id="2599804">(</span><span class="ident" id="2599805">err1</span><span class="op" id="2599809">)</span><br>
<span class="lineno"></span><span class="op" id="2599811">}</span>
</div>
</body>
</html>
