<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1866606">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1866661">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1866715">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1866766">package</span>&nbsp;<span class="ident" id="1866774">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1866783">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&#39;s&nbsp;map&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="1866842">//</span><br>
<span class="lineno"></span><span class="comment" id="1866845">//&nbsp;A&nbsp;map&nbsp;is&nbsp;just&nbsp;a&nbsp;hash&nbsp;table.&nbsp;&nbsp;The&nbsp;data&nbsp;is&nbsp;arranged</span><br>
<span class="lineno">10</span><span class="comment" id="1866898">//&nbsp;into&nbsp;an&nbsp;array&nbsp;of&nbsp;buckets.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;up&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1866955">//&nbsp;8&nbsp;key/value&nbsp;pairs.&nbsp;&nbsp;The&nbsp;low-order&nbsp;bits&nbsp;of&nbsp;the&nbsp;hash&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="1867013">//&nbsp;used&nbsp;to&nbsp;select&nbsp;a&nbsp;bucket.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;a&nbsp;few</span><br>
<span class="lineno"></span><span class="comment" id="1867069">//&nbsp;high-order&nbsp;bits&nbsp;of&nbsp;each&nbsp;hash&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;entries</span><br>
<span class="lineno"></span><span class="comment" id="1867128">//&nbsp;within&nbsp;a&nbsp;single&nbsp;bucket.</span><br>
<span class="lineno">15</span><span class="comment" id="1867155">//</span><br>
<span class="lineno"></span><span class="comment" id="1867158">//&nbsp;If&nbsp;more&nbsp;than&nbsp;8&nbsp;keys&nbsp;hash&nbsp;to&nbsp;a&nbsp;bucket,&nbsp;we&nbsp;chain&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="1867211">//&nbsp;extra&nbsp;buckets.</span><br>
<span class="lineno"></span><span class="comment" id="1867229">//</span><br>
<span class="lineno"></span><span class="comment" id="1867232">//&nbsp;When&nbsp;the&nbsp;hashtable&nbsp;grows,&nbsp;we&nbsp;allocate&nbsp;a&nbsp;new&nbsp;array</span><br>
<span class="lineno">20</span><span class="comment" id="1867285">//&nbsp;of&nbsp;buckets&nbsp;twice&nbsp;as&nbsp;big.&nbsp;&nbsp;Buckets&nbsp;are&nbsp;incrementally</span><br>
<span class="lineno"></span><span class="comment" id="1867340">//&nbsp;copied&nbsp;from&nbsp;the&nbsp;old&nbsp;bucket&nbsp;array&nbsp;to&nbsp;the&nbsp;new&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span><span class="comment" id="1867401">//</span><br>
<span class="lineno"></span><span class="comment" id="1867404">//&nbsp;Map&nbsp;iterators&nbsp;walk&nbsp;through&nbsp;the&nbsp;array&nbsp;of&nbsp;buckets&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1867459">//&nbsp;return&nbsp;the&nbsp;keys&nbsp;in&nbsp;walk&nbsp;order&nbsp;(bucket&nbsp;#,&nbsp;then&nbsp;overflow</span><br>
<span class="lineno">25</span><span class="comment" id="1867517">//&nbsp;chain&nbsp;order,&nbsp;then&nbsp;bucket&nbsp;index).&nbsp;&nbsp;To&nbsp;maintain&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="1867576">//&nbsp;semantics,&nbsp;we&nbsp;never&nbsp;move&nbsp;keys&nbsp;within&nbsp;their&nbsp;bucket&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="1867633">//&nbsp;we&nbsp;did,&nbsp;keys&nbsp;might&nbsp;be&nbsp;returned&nbsp;0&nbsp;or&nbsp;2&nbsp;times).&nbsp;&nbsp;When</span><br>
<span class="lineno"></span><span class="comment" id="1867688">//&nbsp;growing&nbsp;the&nbsp;table,&nbsp;iterators&nbsp;remain&nbsp;iterating&nbsp;through&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1867749">//&nbsp;old&nbsp;table&nbsp;and&nbsp;must&nbsp;check&nbsp;the&nbsp;new&nbsp;table&nbsp;if&nbsp;the&nbsp;bucket</span><br>
<span class="lineno">30</span><span class="comment" id="1867805">//&nbsp;they&nbsp;are&nbsp;iterating&nbsp;through&nbsp;has&nbsp;been&nbsp;moved&nbsp;(&#34;evacuated&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="1867864">//&nbsp;to&nbsp;the&nbsp;new&nbsp;table.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1867886">//&nbsp;Picking&nbsp;loadFactor:&nbsp;too&nbsp;large&nbsp;and&nbsp;we&nbsp;have&nbsp;lots&nbsp;of&nbsp;overflow</span><br>
<span class="lineno"></span><span class="comment" id="1867948">//&nbsp;buckets,&nbsp;too&nbsp;small&nbsp;and&nbsp;we&nbsp;waste&nbsp;a&nbsp;lot&nbsp;of&nbsp;space.&nbsp;&nbsp;I&nbsp;wrote</span><br>
<span class="lineno">35</span><span class="comment" id="1868008">//&nbsp;a&nbsp;simple&nbsp;program&nbsp;to&nbsp;check&nbsp;some&nbsp;stats&nbsp;for&nbsp;different&nbsp;loads:</span><br>
<span class="lineno"></span><span class="comment" id="1868069">//&nbsp;(64-bit,&nbsp;8&nbsp;byte&nbsp;keys&nbsp;and&nbsp;values)</span><br>
<span class="lineno"></span><span class="comment" id="1868105">//&nbsp;&nbsp;loadFactor&nbsp;&nbsp;&nbsp;&nbsp;%overflow&nbsp;&nbsp;bytes/entry&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;missprobe</span><br>
<span class="lineno"></span><span class="comment" id="1868172">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00</span><br>
<span class="lineno"></span><span class="comment" id="1868239">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;17.30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50</span><br>
<span class="lineno">40</span><span class="comment" id="1868306">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.85&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;14.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00</span><br>
<span class="lineno"></span><span class="comment" id="1868373">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12.94&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50</span><br>
<span class="lineno"></span><span class="comment" id="1868440">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;15.27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;11.67&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00</span><br>
<span class="lineno"></span><span class="comment" id="1868507">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.90&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.79&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50</span><br>
<span class="lineno"></span><span class="comment" id="1868574">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;27.14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00</span><br>
<span class="lineno">45</span><span class="comment" id="1868641">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;34.03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.73&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50</span><br>
<span class="lineno"></span><span class="comment" id="1868708">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;41.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00</span><br>
<span class="lineno"></span><span class="comment" id="1868775">//</span><br>
<span class="lineno"></span><span class="comment" id="1868778">//&nbsp;%overflow&nbsp;&nbsp;&nbsp;=&nbsp;percentage&nbsp;of&nbsp;buckets&nbsp;which&nbsp;have&nbsp;an&nbsp;overflow&nbsp;bucket</span><br>
<span class="lineno"></span><span class="comment" id="1868847">//&nbsp;bytes/entry&nbsp;=&nbsp;overhead&nbsp;bytes&nbsp;used&nbsp;per&nbsp;key/value&nbsp;pair</span><br>
<span class="lineno">50</span><span class="comment" id="1868903">//&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;a&nbsp;present&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1868972">//&nbsp;missprobe&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;an&nbsp;absent&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1869041">//</span><br>
<span class="lineno"></span><span class="comment" id="1869044">//&nbsp;Keep&nbsp;in&nbsp;mind&nbsp;this&nbsp;data&nbsp;is&nbsp;for&nbsp;maximally&nbsp;loaded&nbsp;tables,&nbsp;i.e.&nbsp;just</span><br>
<span class="lineno"></span><span class="comment" id="1869112">//&nbsp;before&nbsp;the&nbsp;table&nbsp;grows.&nbsp;&nbsp;Typical&nbsp;tables&nbsp;will&nbsp;be&nbsp;somewhat&nbsp;less&nbsp;loaded.</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="1869186">import</span>&nbsp;<span class="op" id="1869193">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1869196">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1869205">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="1869208">const</span>&nbsp;<span class="op" id="1869214">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1869217">//&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;key/value&nbsp;pairs&nbsp;a&nbsp;bucket&nbsp;can&nbsp;hold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869274">bucketCntBits</span>&nbsp;<span class="op" id="1869288">=</span>&nbsp;<span class="num" id="1869290">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869293">bucketCnt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1869307">=</span>&nbsp;<span class="num" id="1869309">1</span>&nbsp;<span class="op" id="1869311">&lt;&lt;</span>&nbsp;<span class="ident" id="1869314">bucketCntBits</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1869330">//&nbsp;Maximum&nbsp;average&nbsp;load&nbsp;of&nbsp;a&nbsp;bucket&nbsp;that&nbsp;triggers&nbsp;growth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869389">loadFactor</span>&nbsp;<span class="op" id="1869400">=</span>&nbsp;<span class="num" id="1869402">6.5</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1869408">//&nbsp;Maximum&nbsp;key&nbsp;or&nbsp;value&nbsp;size&nbsp;to&nbsp;keep&nbsp;inline&nbsp;(instead&nbsp;of&nbsp;mallocing&nbsp;per&nbsp;element).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1869489">//&nbsp;Must&nbsp;fit&nbsp;in&nbsp;a&nbsp;uint8.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1869514">//&nbsp;Fast&nbsp;versions&nbsp;cannot&nbsp;handle&nbsp;big&nbsp;values&nbsp;-&nbsp;the&nbsp;cutoff&nbsp;size&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1869579">//&nbsp;fast&nbsp;versions&nbsp;in&nbsp;../../cmd/gc/walk.c&nbsp;must&nbsp;be&nbsp;at&nbsp;most&nbsp;this&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869648">maxKeySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1869661">=</span>&nbsp;<span class="num" id="1869663">128</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869668">maxValueSize</span>&nbsp;<span class="op" id="1869681">=</span>&nbsp;<span class="num" id="1869683">128</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1869689">//&nbsp;data&nbsp;offset&nbsp;should&nbsp;be&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;bmap&nbsp;struct,&nbsp;but&nbsp;needs&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1869760">//&nbsp;aligned&nbsp;correctly.&nbsp;&nbsp;For&nbsp;amd64p32&nbsp;this&nbsp;means&nbsp;64-bit&nbsp;alignment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1869825">//&nbsp;even&nbsp;though&nbsp;pointers&nbsp;are&nbsp;32&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869862">dataOffset</span>&nbsp;<span class="op" id="1869873">=</span>&nbsp;<span class="ident" id="1869875">unsafe</span><span class="op" id="1869881">.</span><span class="ident" id="1869882">Offsetof</span><span class="op" id="1869890">(</span><span class="keyword" id="1869891">struct</span>&nbsp;<span class="op" id="1869898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869902">b</span>&nbsp;<span class="ident" id="1869904">bmap</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869911">v</span>&nbsp;<span class="ident" id="1869913">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1869920">}</span><span class="op" id="1869921">{</span><span class="op" id="1869922">}</span><span class="op" id="1869923">.</span><span class="ident" id="1869924">v</span><span class="op" id="1869925">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1869929">//&nbsp;Possible&nbsp;tophash&nbsp;values.&nbsp;&nbsp;We&nbsp;reserve&nbsp;a&nbsp;few&nbsp;possibilities&nbsp;for&nbsp;special&nbsp;marks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1870009">//&nbsp;Each&nbsp;bucket&nbsp;(including&nbsp;its&nbsp;overflow&nbsp;buckets,&nbsp;if&nbsp;any)&nbsp;will&nbsp;have&nbsp;either&nbsp;all&nbsp;or&nbsp;none&nbsp;of&nbsp;its</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1870102">//&nbsp;entries&nbsp;in&nbsp;the&nbsp;evacuated*&nbsp;states&nbsp;(except&nbsp;during&nbsp;the&nbsp;evacuate()&nbsp;method,&nbsp;which&nbsp;only&nbsp;happens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1870196">//&nbsp;during&nbsp;map&nbsp;writes&nbsp;and&nbsp;thus&nbsp;no&nbsp;one&nbsp;else&nbsp;can&nbsp;observe&nbsp;the&nbsp;map&nbsp;during&nbsp;that&nbsp;time).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870278">empty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1870293">=</span>&nbsp;<span class="num" id="1870295">0</span>&nbsp;<span class="comment" id="1870297">//&nbsp;cell&nbsp;is&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870315">evacuatedEmpty</span>&nbsp;<span class="op" id="1870330">=</span>&nbsp;<span class="num" id="1870332">1</span>&nbsp;<span class="comment" id="1870334">//&nbsp;cell&nbsp;is&nbsp;empty,&nbsp;bucket&nbsp;is&nbsp;evacuated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870374">evacuatedX</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1870389">=</span>&nbsp;<span class="num" id="1870391">2</span>&nbsp;<span class="comment" id="1870393">//&nbsp;key/value&nbsp;is&nbsp;valid.&nbsp;&nbsp;Entry&nbsp;has&nbsp;been&nbsp;evacuated&nbsp;to&nbsp;first&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870474">evacuatedY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1870489">=</span>&nbsp;<span class="num" id="1870491">3</span>&nbsp;<span class="comment" id="1870493">//&nbsp;same&nbsp;as&nbsp;above,&nbsp;but&nbsp;evacuated&nbsp;to&nbsp;second&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870558">minTopHash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1870573">=</span>&nbsp;<span class="num" id="1870575">4</span>&nbsp;<span class="comment" id="1870577">//&nbsp;minimum&nbsp;tophash&nbsp;for&nbsp;a&nbsp;normal&nbsp;filled&nbsp;cell.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1870624">//&nbsp;flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870634">iterator</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1870646">=</span>&nbsp;<span class="num" id="1870648">1</span>&nbsp;<span class="comment" id="1870650">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;buckets</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870693">oldIterator</span>&nbsp;<span class="op" id="1870705">=</span>&nbsp;<span class="num" id="1870707">2</span>&nbsp;<span class="comment" id="1870709">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;oldbuckets</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1870756">//&nbsp;sentinel&nbsp;bucket&nbsp;ID&nbsp;for&nbsp;iterator&nbsp;checks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870799">noCheck</span>&nbsp;<span class="op" id="1870807">=</span>&nbsp;<span class="num" id="1870809">1</span><span class="op" id="1870810">&lt;&lt;</span><span class="op" id="1870812">(</span><span class="num" id="1870813">8</span><span class="op" id="1870814">*</span><span class="ident" id="1870815">ptrSize</span><span class="op" id="1870822">)</span>&nbsp;<span class="op" id="1870824">-</span>&nbsp;<span class="num" id="1870826">1</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1870830">//&nbsp;trigger&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;at&nbsp;every&nbsp;alloc&nbsp;called&nbsp;from&nbsp;this&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870900">checkgc</span>&nbsp;<span class="op" id="1870908">=</span>&nbsp;<span class="builtintype" id="1870910">false</span><br>
<span class="lineno"></span><span class="op" id="1870916">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1870919">//&nbsp;A&nbsp;header&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno">105</span><span class="keyword" id="1870945">type</span>&nbsp;<span class="ident" id="1870950">hmap</span>&nbsp;<span class="keyword" id="1870955">struct</span>&nbsp;<span class="op" id="1870962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1870965">//&nbsp;Note:&nbsp;the&nbsp;format&nbsp;of&nbsp;the&nbsp;Hmap&nbsp;is&nbsp;encoded&nbsp;in&nbsp;../../cmd/gc/reflect.c&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1871039">//&nbsp;../reflect/type.go.&nbsp;&nbsp;Don&#39;t&nbsp;change&nbsp;this&nbsp;structure&nbsp;without&nbsp;also&nbsp;changing&nbsp;that&nbsp;code!</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871125">count</span>&nbsp;<span class="builtintype" id="1871131">int</span>&nbsp;<span class="comment" id="1871135">//&nbsp;#&nbsp;live&nbsp;cells&nbsp;==&nbsp;size&nbsp;of&nbsp;map.&nbsp;&nbsp;Must&nbsp;be&nbsp;first&nbsp;(used&nbsp;by&nbsp;len()&nbsp;builtin)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871207">flags</span>&nbsp;<span class="builtintype" id="1871213">uint32</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871221">hash0</span>&nbsp;<span class="builtintype" id="1871227">uint32</span>&nbsp;<span class="comment" id="1871234">//&nbsp;hash&nbsp;seed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871248">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1871254">uint8</span>&nbsp;&nbsp;<span class="comment" id="1871261">//&nbsp;log_2&nbsp;of&nbsp;#&nbsp;of&nbsp;buckets&nbsp;(can&nbsp;hold&nbsp;up&nbsp;to&nbsp;loadFactor&nbsp;*&nbsp;2^B&nbsp;items)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871328">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1871339">unsafe</span><span class="op" id="1871345">.</span><span class="ident" id="1871346">Pointer</span>&nbsp;<span class="comment" id="1871354">//&nbsp;array&nbsp;of&nbsp;2^B&nbsp;Buckets.&nbsp;may&nbsp;be&nbsp;nil&nbsp;if&nbsp;count==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871404">oldbuckets</span>&nbsp;<span class="ident" id="1871415">unsafe</span><span class="op" id="1871421">.</span><span class="ident" id="1871422">Pointer</span>&nbsp;<span class="comment" id="1871430">//&nbsp;previous&nbsp;bucket&nbsp;array&nbsp;of&nbsp;half&nbsp;the&nbsp;size,&nbsp;non-nil&nbsp;only&nbsp;when&nbsp;growing</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871500">nevacuate</span>&nbsp;&nbsp;<span class="builtintype" id="1871511">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1871526">//&nbsp;progress&nbsp;counter&nbsp;for&nbsp;evacuation&nbsp;(buckets&nbsp;less&nbsp;than&nbsp;this&nbsp;have&nbsp;been&nbsp;evacuated)</span><br>
<span class="lineno"></span><span class="op" id="1871606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1871609">//&nbsp;A&nbsp;bucket&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="1871635">type</span>&nbsp;<span class="ident" id="1871640">bmap</span>&nbsp;<span class="keyword" id="1871645">struct</span>&nbsp;<span class="op" id="1871652">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871655">tophash</span>&nbsp;&nbsp;<span class="op" id="1871664">[</span><span class="ident" id="1871665">bucketCnt</span><span class="op" id="1871674">]</span><span class="builtintype" id="1871675">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871682">overflow</span>&nbsp;<span class="op" id="1871691">*</span><span class="ident" id="1871692">bmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1871698">//&nbsp;Followed&nbsp;by&nbsp;bucketCnt&nbsp;keys&nbsp;and&nbsp;then&nbsp;bucketCnt&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1871756">//&nbsp;NOTE:&nbsp;packing&nbsp;all&nbsp;the&nbsp;keys&nbsp;together&nbsp;and&nbsp;then&nbsp;all&nbsp;the&nbsp;values&nbsp;together&nbsp;makes&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1871839">//&nbsp;code&nbsp;a&nbsp;bit&nbsp;more&nbsp;complicated&nbsp;than&nbsp;alternating&nbsp;key/value/key/value/...&nbsp;but&nbsp;it&nbsp;allows</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1871926">//&nbsp;us&nbsp;to&nbsp;eliminate&nbsp;padding&nbsp;which&nbsp;would&nbsp;be&nbsp;needed&nbsp;for,&nbsp;e.g.,&nbsp;map[int64]int8.</span><br>
<span class="lineno"></span><span class="op" id="1872002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1872005">//&nbsp;A&nbsp;hash&nbsp;iteration&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="1872036">//&nbsp;If&nbsp;you&nbsp;modify&nbsp;hiter,&nbsp;also&nbsp;change&nbsp;cmd/gc/reflect.c&nbsp;to&nbsp;indicate</span><br>
<span class="lineno">130</span><span class="comment" id="1872101">//&nbsp;the&nbsp;layout&nbsp;of&nbsp;this&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="1872134">type</span>&nbsp;<span class="ident" id="1872139">hiter</span>&nbsp;<span class="keyword" id="1872145">struct</span>&nbsp;<span class="op" id="1872152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872155">key</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1872167">unsafe</span><span class="op" id="1872173">.</span><span class="ident" id="1872174">Pointer</span>&nbsp;<span class="comment" id="1872182">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;first&nbsp;position.&nbsp;&nbsp;Write&nbsp;nil&nbsp;to&nbsp;indicate&nbsp;iteration&nbsp;end&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872272">value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1872284">unsafe</span><span class="op" id="1872290">.</span><span class="ident" id="1872291">Pointer</span>&nbsp;<span class="comment" id="1872299">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;second&nbsp;position&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872352">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1872364">*</span><span class="ident" id="1872365">maptype</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872374">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1872386">*</span><span class="ident" id="1872387">hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872393">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1872405">unsafe</span><span class="op" id="1872411">.</span><span class="ident" id="1872412">Pointer</span>&nbsp;<span class="comment" id="1872420">//&nbsp;bucket&nbsp;ptr&nbsp;at&nbsp;hash_iter&nbsp;initialization&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872468">bptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1872480">*</span><span class="ident" id="1872481">bmap</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1872495">//&nbsp;current&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872514">startBucket</span>&nbsp;<span class="builtintype" id="1872526">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1872541">//&nbsp;bucket&nbsp;iteration&nbsp;started&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872573">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1872585">uint8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1872600">//&nbsp;intra-bucket&nbsp;offset&nbsp;to&nbsp;start&nbsp;from&nbsp;during&nbsp;iteration&nbsp;(should&nbsp;be&nbsp;big&nbsp;enough&nbsp;to&nbsp;hold&nbsp;bucketCnt-1)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872698">wrapped</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1872710">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1872725">//&nbsp;already&nbsp;wrapped&nbsp;around&nbsp;from&nbsp;end&nbsp;of&nbsp;bucket&nbsp;array&nbsp;to&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872790">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1872802">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872809">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1872821">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872828">bucket</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1872840">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872849">checkBucket</span>&nbsp;<span class="builtintype" id="1872861">uintptr</span><br>
<span class="lineno">145</span><span class="op" id="1872869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1872872">func</span>&nbsp;<span class="ident" id="1872877">evacuated</span><span class="op" id="1872886">(</span><span class="ident" id="1872887">b</span>&nbsp;<span class="op" id="1872889">*</span><span class="ident" id="1872890">bmap</span><span class="op" id="1872894">)</span>&nbsp;<span class="builtintype" id="1872896">bool</span>&nbsp;<span class="op" id="1872901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1872904">h</span>&nbsp;<span class="op" id="1872906">:=</span>&nbsp;<span class="ident" id="1872909">b</span><span class="op" id="1872910">.</span><span class="ident" id="1872911">tophash</span><span class="op" id="1872918">[</span><span class="num" id="1872919">0</span><span class="op" id="1872920">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1872923">return</span>&nbsp;<span class="ident" id="1872930">h</span>&nbsp;<span class="op" id="1872932">&gt;</span>&nbsp;<span class="ident" id="1872934">empty</span>&nbsp;<span class="op" id="1872940">&amp;&amp;</span>&nbsp;<span class="ident" id="1872943">h</span>&nbsp;<span class="op" id="1872945">&lt;</span>&nbsp;<span class="ident" id="1872947">minTopHash</span><br>
<span class="lineno">150</span><span class="op" id="1872958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1872961">func</span>&nbsp;<span class="ident" id="1872966">makemap</span><span class="op" id="1872973">(</span><span class="ident" id="1872974">t</span>&nbsp;<span class="op" id="1872976">*</span><span class="ident" id="1872977">maptype</span><span class="op" id="1872984">,</span>&nbsp;<span class="ident" id="1872986">hint</span>&nbsp;<span class="ident" id="1872991">int64</span><span class="op" id="1872996">)</span>&nbsp;<span class="op" id="1872998">*</span><span class="ident" id="1872999">hmap</span>&nbsp;<span class="op" id="1873004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1873007">if</span>&nbsp;<span class="ident" id="1873010">sz</span>&nbsp;<span class="op" id="1873013">:=</span>&nbsp;<span class="ident" id="1873016">unsafe</span><span class="op" id="1873022">.</span><span class="ident" id="1873023">Sizeof</span><span class="op" id="1873029">(</span><span class="ident" id="1873030">hmap</span><span class="op" id="1873034">{</span><span class="op" id="1873035">}</span><span class="op" id="1873036">)</span><span class="op" id="1873037">;</span>&nbsp;<span class="ident" id="1873039">sz</span>&nbsp;<span class="op" id="1873042">&gt;</span>&nbsp;<span class="num" id="1873044">48</span>&nbsp;<span class="op" id="1873047">||</span>&nbsp;<span class="ident" id="1873050">sz</span>&nbsp;<span class="op" id="1873053">!=</span>&nbsp;<span class="builtintype" id="1873056">uintptr</span><span class="op" id="1873063">(</span><span class="ident" id="1873064">t</span><span class="op" id="1873065">.</span><span class="ident" id="1873066">hmap</span><span class="op" id="1873070">.</span><span class="ident" id="1873071">size</span><span class="op" id="1873075">)</span>&nbsp;<span class="op" id="1873077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873081">gothrow</span><span class="op" id="1873088">(</span><span class="string" id="1873089">&#34;bad&nbsp;hmap&nbsp;size&#34;</span><span class="op" id="1873104">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1873107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1873111">if</span>&nbsp;<span class="ident" id="1873114">hint</span>&nbsp;<span class="op" id="1873119">&lt;</span>&nbsp;<span class="num" id="1873121">0</span>&nbsp;<span class="op" id="1873123">||</span>&nbsp;<span class="ident" id="1873126">int64</span><span class="op" id="1873131">(</span><span class="builtintype" id="1873132">int32</span><span class="op" id="1873137">(</span><span class="ident" id="1873138">hint</span><span class="op" id="1873142">)</span><span class="op" id="1873143">)</span>&nbsp;<span class="op" id="1873145">!=</span>&nbsp;<span class="ident" id="1873148">hint</span>&nbsp;<span class="op" id="1873153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1873157">panic</span><span class="op" id="1873162">(</span><span class="string" id="1873163">&#34;makemap:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1873191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1873195">//&nbsp;TODO:&nbsp;make&nbsp;hint&nbsp;an&nbsp;int,&nbsp;then&nbsp;none&nbsp;of&nbsp;this&nbsp;nonsense</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1873250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1873254">if</span>&nbsp;<span class="op" id="1873257">!</span><span class="ident" id="1873258">ismapkey</span><span class="op" id="1873266">(</span><span class="ident" id="1873267">t</span><span class="op" id="1873268">.</span><span class="ident" id="1873269">key</span><span class="op" id="1873272">)</span>&nbsp;<span class="op" id="1873274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873278">gothrow</span><span class="op" id="1873285">(</span><span class="string" id="1873286">&#34;runtime.makemap:&nbsp;unsupported&nbsp;map&nbsp;key&nbsp;type&#34;</span><span class="op" id="1873329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1873332">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1873336">//&nbsp;check&nbsp;compiler&#39;s&nbsp;and&nbsp;reflect&#39;s&nbsp;math</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1873376">if</span>&nbsp;<span class="ident" id="1873379">t</span><span class="op" id="1873380">.</span><span class="ident" id="1873381">key</span><span class="op" id="1873384">.</span><span class="ident" id="1873385">size</span>&nbsp;<span class="op" id="1873390">&gt;</span>&nbsp;<span class="ident" id="1873392">maxKeySize</span>&nbsp;<span class="op" id="1873403">&amp;&amp;</span>&nbsp;<span class="op" id="1873406">(</span><span class="op" id="1873407">!</span><span class="ident" id="1873408">t</span><span class="op" id="1873409">.</span><span class="ident" id="1873410">indirectkey</span>&nbsp;<span class="op" id="1873422">||</span>&nbsp;<span class="ident" id="1873425">t</span><span class="op" id="1873426">.</span><span class="ident" id="1873427">keysize</span>&nbsp;<span class="op" id="1873435">!=</span>&nbsp;<span class="builtintype" id="1873438">uint8</span><span class="op" id="1873443">(</span><span class="ident" id="1873444">ptrSize</span><span class="op" id="1873451">)</span><span class="op" id="1873452">)</span>&nbsp;<span class="op" id="1873454">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873459">t</span><span class="op" id="1873460">.</span><span class="ident" id="1873461">key</span><span class="op" id="1873464">.</span><span class="ident" id="1873465">size</span>&nbsp;<span class="op" id="1873470">&lt;=</span>&nbsp;<span class="ident" id="1873473">maxKeySize</span>&nbsp;<span class="op" id="1873484">&amp;&amp;</span>&nbsp;<span class="op" id="1873487">(</span><span class="ident" id="1873488">t</span><span class="op" id="1873489">.</span><span class="ident" id="1873490">indirectkey</span>&nbsp;<span class="op" id="1873502">||</span>&nbsp;<span class="ident" id="1873505">t</span><span class="op" id="1873506">.</span><span class="ident" id="1873507">keysize</span>&nbsp;<span class="op" id="1873515">!=</span>&nbsp;<span class="builtintype" id="1873518">uint8</span><span class="op" id="1873523">(</span><span class="ident" id="1873524">t</span><span class="op" id="1873525">.</span><span class="ident" id="1873526">key</span><span class="op" id="1873529">.</span><span class="ident" id="1873530">size</span><span class="op" id="1873534">)</span><span class="op" id="1873535">)</span>&nbsp;<span class="op" id="1873537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873541">gothrow</span><span class="op" id="1873548">(</span><span class="string" id="1873549">&#34;key&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1873565">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1873568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1873571">if</span>&nbsp;<span class="ident" id="1873574">t</span><span class="op" id="1873575">.</span><span class="ident" id="1873576">elem</span><span class="op" id="1873580">.</span><span class="ident" id="1873581">size</span>&nbsp;<span class="op" id="1873586">&gt;</span>&nbsp;<span class="ident" id="1873588">maxValueSize</span>&nbsp;<span class="op" id="1873601">&amp;&amp;</span>&nbsp;<span class="op" id="1873604">(</span><span class="op" id="1873605">!</span><span class="ident" id="1873606">t</span><span class="op" id="1873607">.</span><span class="ident" id="1873608">indirectvalue</span>&nbsp;<span class="op" id="1873622">||</span>&nbsp;<span class="ident" id="1873625">t</span><span class="op" id="1873626">.</span><span class="ident" id="1873627">valuesize</span>&nbsp;<span class="op" id="1873637">!=</span>&nbsp;<span class="builtintype" id="1873640">uint8</span><span class="op" id="1873645">(</span><span class="ident" id="1873646">ptrSize</span><span class="op" id="1873653">)</span><span class="op" id="1873654">)</span>&nbsp;<span class="op" id="1873656">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873661">t</span><span class="op" id="1873662">.</span><span class="ident" id="1873663">elem</span><span class="op" id="1873667">.</span><span class="ident" id="1873668">size</span>&nbsp;<span class="op" id="1873673">&lt;=</span>&nbsp;<span class="ident" id="1873676">maxValueSize</span>&nbsp;<span class="op" id="1873689">&amp;&amp;</span>&nbsp;<span class="op" id="1873692">(</span><span class="ident" id="1873693">t</span><span class="op" id="1873694">.</span><span class="ident" id="1873695">indirectvalue</span>&nbsp;<span class="op" id="1873709">||</span>&nbsp;<span class="ident" id="1873712">t</span><span class="op" id="1873713">.</span><span class="ident" id="1873714">valuesize</span>&nbsp;<span class="op" id="1873724">!=</span>&nbsp;<span class="builtintype" id="1873727">uint8</span><span class="op" id="1873732">(</span><span class="ident" id="1873733">t</span><span class="op" id="1873734">.</span><span class="ident" id="1873735">elem</span><span class="op" id="1873739">.</span><span class="ident" id="1873740">size</span><span class="op" id="1873744">)</span><span class="op" id="1873745">)</span>&nbsp;<span class="op" id="1873747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873751">gothrow</span><span class="op" id="1873758">(</span><span class="string" id="1873759">&#34;value&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1873777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1873780">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1873784">//&nbsp;invariants&nbsp;we&nbsp;depend&nbsp;on.&nbsp;&nbsp;We&nbsp;should&nbsp;probably&nbsp;check&nbsp;these&nbsp;at&nbsp;compile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1873861">//&nbsp;somewhere,&nbsp;but&nbsp;for&nbsp;now&nbsp;we&#39;ll&nbsp;do&nbsp;it&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1873906">if</span>&nbsp;<span class="ident" id="1873909">t</span><span class="op" id="1873910">.</span><span class="ident" id="1873911">key</span><span class="op" id="1873914">.</span><span class="ident" id="1873915">align</span>&nbsp;<span class="op" id="1873921">&gt;</span>&nbsp;<span class="ident" id="1873923">bucketCnt</span>&nbsp;<span class="op" id="1873933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1873937">gothrow</span><span class="op" id="1873944">(</span><span class="string" id="1873945">&#34;key&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1873964">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1873967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1873970">if</span>&nbsp;<span class="ident" id="1873973">t</span><span class="op" id="1873974">.</span><span class="ident" id="1873975">elem</span><span class="op" id="1873979">.</span><span class="ident" id="1873980">align</span>&nbsp;<span class="op" id="1873986">&gt;</span>&nbsp;<span class="ident" id="1873988">bucketCnt</span>&nbsp;<span class="op" id="1873998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874002">gothrow</span><span class="op" id="1874009">(</span><span class="string" id="1874010">&#34;value&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1874031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874037">if</span>&nbsp;<span class="builtintype" id="1874040">uintptr</span><span class="op" id="1874047">(</span><span class="ident" id="1874048">t</span><span class="op" id="1874049">.</span><span class="ident" id="1874050">key</span><span class="op" id="1874053">.</span><span class="ident" id="1874054">size</span><span class="op" id="1874058">)</span><span class="op" id="1874059">%</span><span class="builtintype" id="1874060">uintptr</span><span class="op" id="1874067">(</span><span class="ident" id="1874068">t</span><span class="op" id="1874069">.</span><span class="ident" id="1874070">key</span><span class="op" id="1874073">.</span><span class="ident" id="1874074">align</span><span class="op" id="1874079">)</span>&nbsp;<span class="op" id="1874081">!=</span>&nbsp;<span class="num" id="1874084">0</span>&nbsp;<span class="op" id="1874086">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874090">gothrow</span><span class="op" id="1874097">(</span><span class="string" id="1874098">&#34;key&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;key&nbsp;align&#34;</span><span class="op" id="1874136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874142">if</span>&nbsp;<span class="builtintype" id="1874145">uintptr</span><span class="op" id="1874152">(</span><span class="ident" id="1874153">t</span><span class="op" id="1874154">.</span><span class="ident" id="1874155">elem</span><span class="op" id="1874159">.</span><span class="ident" id="1874160">size</span><span class="op" id="1874164">)</span><span class="op" id="1874165">%</span><span class="builtintype" id="1874166">uintptr</span><span class="op" id="1874173">(</span><span class="ident" id="1874174">t</span><span class="op" id="1874175">.</span><span class="ident" id="1874176">elem</span><span class="op" id="1874180">.</span><span class="ident" id="1874181">align</span><span class="op" id="1874186">)</span>&nbsp;<span class="op" id="1874188">!=</span>&nbsp;<span class="num" id="1874191">0</span>&nbsp;<span class="op" id="1874193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874197">gothrow</span><span class="op" id="1874204">(</span><span class="string" id="1874205">&#34;value&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;value&nbsp;align&#34;</span><span class="op" id="1874247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874250">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874253">if</span>&nbsp;<span class="ident" id="1874256">bucketCnt</span>&nbsp;<span class="op" id="1874266">&lt;</span>&nbsp;<span class="num" id="1874268">8</span>&nbsp;<span class="op" id="1874270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874274">gothrow</span><span class="op" id="1874281">(</span><span class="string" id="1874282">&#34;bucketsize&nbsp;too&nbsp;small&nbsp;for&nbsp;proper&nbsp;alignment&#34;</span><span class="op" id="1874325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874331">if</span>&nbsp;<span class="ident" id="1874334">dataOffset</span><span class="op" id="1874344">%</span><span class="builtintype" id="1874345">uintptr</span><span class="op" id="1874352">(</span><span class="ident" id="1874353">t</span><span class="op" id="1874354">.</span><span class="ident" id="1874355">key</span><span class="op" id="1874358">.</span><span class="ident" id="1874359">align</span><span class="op" id="1874364">)</span>&nbsp;<span class="op" id="1874366">!=</span>&nbsp;<span class="num" id="1874369">0</span>&nbsp;<span class="op" id="1874371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874375">gothrow</span><span class="op" id="1874382">(</span><span class="string" id="1874383">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(key)&#34;</span><span class="op" id="1874413">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874419">if</span>&nbsp;<span class="ident" id="1874422">dataOffset</span><span class="op" id="1874432">%</span><span class="builtintype" id="1874433">uintptr</span><span class="op" id="1874440">(</span><span class="ident" id="1874441">t</span><span class="op" id="1874442">.</span><span class="ident" id="1874443">elem</span><span class="op" id="1874447">.</span><span class="ident" id="1874448">align</span><span class="op" id="1874453">)</span>&nbsp;<span class="op" id="1874455">!=</span>&nbsp;<span class="num" id="1874458">0</span>&nbsp;<span class="op" id="1874460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874464">gothrow</span><span class="op" id="1874471">(</span><span class="string" id="1874472">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(value)&#34;</span><span class="op" id="1874504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1874511">//&nbsp;find&nbsp;size&nbsp;parameter&nbsp;which&nbsp;will&nbsp;hold&nbsp;the&nbsp;requested&nbsp;#&nbsp;of&nbsp;elements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874579">B</span>&nbsp;<span class="op" id="1874581">:=</span>&nbsp;<span class="builtintype" id="1874584">uint8</span><span class="op" id="1874589">(</span><span class="num" id="1874590">0</span><span class="op" id="1874591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874594">for</span>&nbsp;<span class="op" id="1874598">;</span>&nbsp;<span class="ident" id="1874600">hint</span>&nbsp;<span class="op" id="1874605">&gt;</span>&nbsp;<span class="ident" id="1874607">bucketCnt</span>&nbsp;<span class="op" id="1874617">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1874620">float32</span><span class="op" id="1874627">(</span><span class="ident" id="1874628">hint</span><span class="op" id="1874632">)</span>&nbsp;<span class="op" id="1874634">&gt;</span>&nbsp;<span class="ident" id="1874636">loadFactor</span><span class="op" id="1874646">*</span><span class="builtintype" id="1874647">float32</span><span class="op" id="1874654">(</span><span class="builtintype" id="1874655">uintptr</span><span class="op" id="1874662">(</span><span class="num" id="1874663">1</span><span class="op" id="1874664">)</span><span class="op" id="1874665">&lt;&lt;</span><span class="ident" id="1874667">B</span><span class="op" id="1874668">)</span><span class="op" id="1874669">;</span>&nbsp;<span class="ident" id="1874671">B</span><span class="op" id="1874672">++</span>&nbsp;<span class="op" id="1874675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1874682">//&nbsp;allocate&nbsp;initial&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1874714">//&nbsp;if&nbsp;B&nbsp;==&nbsp;0,&nbsp;the&nbsp;buckets&nbsp;field&nbsp;is&nbsp;allocated&nbsp;lazily&nbsp;later&nbsp;(in&nbsp;mapassign)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1874788">//&nbsp;If&nbsp;hint&nbsp;is&nbsp;large&nbsp;zeroing&nbsp;this&nbsp;memory&nbsp;could&nbsp;take&nbsp;a&nbsp;while.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874849">var</span>&nbsp;<span class="ident" id="1874853">buckets</span>&nbsp;<span class="ident" id="1874861">unsafe</span><span class="op" id="1874867">.</span><span class="ident" id="1874868">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874877">if</span>&nbsp;<span class="ident" id="1874880">B</span>&nbsp;<span class="op" id="1874882">!=</span>&nbsp;<span class="num" id="1874885">0</span>&nbsp;<span class="op" id="1874887">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1874891">if</span>&nbsp;<span class="ident" id="1874894">checkgc</span>&nbsp;<span class="op" id="1874902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874907">memstats</span><span class="op" id="1874915">.</span><span class="ident" id="1874916">next_gc</span>&nbsp;<span class="op" id="1874924">=</span>&nbsp;<span class="ident" id="1874926">memstats</span><span class="op" id="1874934">.</span><span class="ident" id="1874935">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1874952">buckets</span>&nbsp;<span class="op" id="1874960">=</span>&nbsp;<span class="ident" id="1874962">newarray</span><span class="op" id="1874970">(</span><span class="ident" id="1874971">t</span><span class="op" id="1874972">.</span><span class="ident" id="1874973">bucket</span><span class="op" id="1874979">,</span>&nbsp;<span class="builtintype" id="1874981">uintptr</span><span class="op" id="1874988">(</span><span class="num" id="1874989">1</span><span class="op" id="1874990">)</span><span class="op" id="1874991">&lt;&lt;</span><span class="ident" id="1874993">B</span><span class="op" id="1874994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1874997">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1875001">//&nbsp;initialize&nbsp;Hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1875021">if</span>&nbsp;<span class="ident" id="1875024">checkgc</span>&nbsp;<span class="op" id="1875032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875036">memstats</span><span class="op" id="1875044">.</span><span class="ident" id="1875045">next_gc</span>&nbsp;<span class="op" id="1875053">=</span>&nbsp;<span class="ident" id="1875055">memstats</span><span class="op" id="1875063">.</span><span class="ident" id="1875064">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1875076">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875079">h</span>&nbsp;<span class="op" id="1875081">:=</span>&nbsp;<span class="op" id="1875084">(</span><span class="op" id="1875085">*</span><span class="ident" id="1875086">hmap</span><span class="op" id="1875090">)</span><span class="op" id="1875091">(</span><span class="ident" id="1875092">newobject</span><span class="op" id="1875101">(</span><span class="ident" id="1875102">t</span><span class="op" id="1875103">.</span><span class="ident" id="1875104">hmap</span><span class="op" id="1875108">)</span><span class="op" id="1875109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875112">h</span><span class="op" id="1875113">.</span><span class="ident" id="1875114">count</span>&nbsp;<span class="op" id="1875120">=</span>&nbsp;<span class="num" id="1875122">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875125">h</span><span class="op" id="1875126">.</span><span class="ident" id="1875127">B</span>&nbsp;<span class="op" id="1875129">=</span>&nbsp;<span class="ident" id="1875131">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875134">h</span><span class="op" id="1875135">.</span><span class="ident" id="1875136">flags</span>&nbsp;<span class="op" id="1875142">=</span>&nbsp;<span class="num" id="1875144">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875147">h</span><span class="op" id="1875148">.</span><span class="ident" id="1875149">hash0</span>&nbsp;<span class="op" id="1875155">=</span>&nbsp;<span class="ident" id="1875157">fastrand1</span><span class="op" id="1875166">(</span><span class="op" id="1875167">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875170">h</span><span class="op" id="1875171">.</span><span class="ident" id="1875172">buckets</span>&nbsp;<span class="op" id="1875180">=</span>&nbsp;<span class="ident" id="1875182">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875191">h</span><span class="op" id="1875192">.</span><span class="ident" id="1875193">oldbuckets</span>&nbsp;<span class="op" id="1875204">=</span>&nbsp;<span class="ident" id="1875206">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875211">h</span><span class="op" id="1875212">.</span><span class="ident" id="1875213">nevacuate</span>&nbsp;<span class="op" id="1875223">=</span>&nbsp;<span class="num" id="1875225">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1875229">return</span>&nbsp;<span class="ident" id="1875236">h</span><br>
<span class="lineno">230</span><span class="op" id="1875238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1875241">//&nbsp;mapaccess1&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;h[key].&nbsp;&nbsp;Never&nbsp;returns&nbsp;nil,&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1875312">//&nbsp;it&nbsp;will&nbsp;return&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;zero&nbsp;object&nbsp;for&nbsp;the&nbsp;value&nbsp;type&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="1875383">//&nbsp;the&nbsp;key&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">235</span><span class="comment" id="1875413">//&nbsp;NOTE:&nbsp;The&nbsp;returned&nbsp;pointer&nbsp;may&nbsp;keep&nbsp;the&nbsp;whole&nbsp;map&nbsp;live,&nbsp;so&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="1875481">//&nbsp;hold&nbsp;onto&nbsp;it&nbsp;for&nbsp;very&nbsp;long.</span><br>
<span class="lineno"></span><span class="keyword" id="1875512">func</span>&nbsp;<span class="ident" id="1875517">mapaccess1</span><span class="op" id="1875527">(</span><span class="ident" id="1875528">t</span>&nbsp;<span class="op" id="1875530">*</span><span class="ident" id="1875531">maptype</span><span class="op" id="1875538">,</span>&nbsp;<span class="ident" id="1875540">h</span>&nbsp;<span class="op" id="1875542">*</span><span class="ident" id="1875543">hmap</span><span class="op" id="1875547">,</span>&nbsp;<span class="ident" id="1875549">key</span>&nbsp;<span class="ident" id="1875553">unsafe</span><span class="op" id="1875559">.</span><span class="ident" id="1875560">Pointer</span><span class="op" id="1875567">)</span>&nbsp;<span class="ident" id="1875569">unsafe</span><span class="op" id="1875575">.</span><span class="ident" id="1875576">Pointer</span>&nbsp;<span class="op" id="1875584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1875587">if</span>&nbsp;<span class="ident" id="1875590">raceenabled</span>&nbsp;<span class="op" id="1875602">&amp;&amp;</span>&nbsp;<span class="ident" id="1875605">h</span>&nbsp;<span class="op" id="1875607">!=</span>&nbsp;<span class="ident" id="1875610">nil</span>&nbsp;<span class="op" id="1875614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875618">callerpc</span>&nbsp;<span class="op" id="1875627">:=</span>&nbsp;<span class="ident" id="1875630">getcallerpc</span><span class="op" id="1875641">(</span><span class="ident" id="1875642">unsafe</span><span class="op" id="1875648">.</span><span class="ident" id="1875649">Pointer</span><span class="op" id="1875656">(</span><span class="op" id="1875657">&amp;</span><span class="ident" id="1875658">t</span><span class="op" id="1875659">)</span><span class="op" id="1875660">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875664">pc</span>&nbsp;<span class="op" id="1875667">:=</span>&nbsp;<span class="ident" id="1875670">funcPC</span><span class="op" id="1875676">(</span><span class="ident" id="1875677">mapaccess1</span><span class="op" id="1875687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875691">racereadpc</span><span class="op" id="1875701">(</span><span class="ident" id="1875702">unsafe</span><span class="op" id="1875708">.</span><span class="ident" id="1875709">Pointer</span><span class="op" id="1875716">(</span><span class="ident" id="1875717">h</span><span class="op" id="1875718">)</span><span class="op" id="1875719">,</span>&nbsp;<span class="ident" id="1875721">callerpc</span><span class="op" id="1875729">,</span>&nbsp;<span class="ident" id="1875731">pc</span><span class="op" id="1875733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875737">raceReadObjectPC</span><span class="op" id="1875753">(</span><span class="ident" id="1875754">t</span><span class="op" id="1875755">.</span><span class="ident" id="1875756">key</span><span class="op" id="1875759">,</span>&nbsp;<span class="ident" id="1875761">key</span><span class="op" id="1875764">,</span>&nbsp;<span class="ident" id="1875766">callerpc</span><span class="op" id="1875774">,</span>&nbsp;<span class="ident" id="1875776">pc</span><span class="op" id="1875778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1875781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1875784">if</span>&nbsp;<span class="ident" id="1875787">h</span>&nbsp;<span class="op" id="1875789">==</span>&nbsp;<span class="ident" id="1875792">nil</span>&nbsp;<span class="op" id="1875796">||</span>&nbsp;<span class="ident" id="1875799">h</span><span class="op" id="1875800">.</span><span class="ident" id="1875801">count</span>&nbsp;<span class="op" id="1875807">==</span>&nbsp;<span class="num" id="1875810">0</span>&nbsp;<span class="op" id="1875812">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1875816">return</span>&nbsp;<span class="ident" id="1875823">unsafe</span><span class="op" id="1875829">.</span><span class="ident" id="1875830">Pointer</span><span class="op" id="1875837">(</span><span class="ident" id="1875838">t</span><span class="op" id="1875839">.</span><span class="ident" id="1875840">elem</span><span class="op" id="1875844">.</span><span class="ident" id="1875845">zero</span><span class="op" id="1875849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1875852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875855">alg</span>&nbsp;<span class="op" id="1875859">:=</span>&nbsp;<span class="ident" id="1875862">goalg</span><span class="op" id="1875867">(</span><span class="ident" id="1875868">t</span><span class="op" id="1875869">.</span><span class="ident" id="1875870">key</span><span class="op" id="1875873">.</span><span class="ident" id="1875874">alg</span><span class="op" id="1875877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875880">hash</span>&nbsp;<span class="op" id="1875885">:=</span>&nbsp;<span class="ident" id="1875888">alg</span><span class="op" id="1875891">.</span><span class="ident" id="1875892">hash</span><span class="op" id="1875896">(</span><span class="ident" id="1875897">key</span><span class="op" id="1875900">,</span>&nbsp;<span class="builtintype" id="1875902">uintptr</span><span class="op" id="1875909">(</span><span class="ident" id="1875910">t</span><span class="op" id="1875911">.</span><span class="ident" id="1875912">key</span><span class="op" id="1875915">.</span><span class="ident" id="1875916">size</span><span class="op" id="1875920">)</span><span class="op" id="1875921">,</span>&nbsp;<span class="builtintype" id="1875923">uintptr</span><span class="op" id="1875930">(</span><span class="ident" id="1875931">h</span><span class="op" id="1875932">.</span><span class="ident" id="1875933">hash0</span><span class="op" id="1875938">)</span><span class="op" id="1875939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875942">m</span>&nbsp;<span class="op" id="1875944">:=</span>&nbsp;<span class="builtintype" id="1875947">uintptr</span><span class="op" id="1875954">(</span><span class="num" id="1875955">1</span><span class="op" id="1875956">)</span><span class="op" id="1875957">&lt;&lt;</span><span class="ident" id="1875959">h</span><span class="op" id="1875960">.</span><span class="ident" id="1875961">B</span>&nbsp;<span class="op" id="1875963">-</span>&nbsp;<span class="num" id="1875965">1</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1875968">b</span>&nbsp;<span class="op" id="1875970">:=</span>&nbsp;<span class="op" id="1875973">(</span><span class="op" id="1875974">*</span><span class="ident" id="1875975">bmap</span><span class="op" id="1875979">)</span><span class="op" id="1875980">(</span><span class="ident" id="1875981">add</span><span class="op" id="1875984">(</span><span class="ident" id="1875985">h</span><span class="op" id="1875986">.</span><span class="ident" id="1875987">buckets</span><span class="op" id="1875994">,</span>&nbsp;<span class="op" id="1875996">(</span><span class="ident" id="1875997">hash</span><span class="op" id="1876001">&amp;</span><span class="ident" id="1876002">m</span><span class="op" id="1876003">)</span><span class="op" id="1876004">*</span><span class="builtintype" id="1876005">uintptr</span><span class="op" id="1876012">(</span><span class="ident" id="1876013">t</span><span class="op" id="1876014">.</span><span class="ident" id="1876015">bucketsize</span><span class="op" id="1876025">)</span><span class="op" id="1876026">)</span><span class="op" id="1876027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876030">if</span>&nbsp;<span class="ident" id="1876033">c</span>&nbsp;<span class="op" id="1876035">:=</span>&nbsp;<span class="ident" id="1876038">h</span><span class="op" id="1876039">.</span><span class="ident" id="1876040">oldbuckets</span><span class="op" id="1876050">;</span>&nbsp;<span class="ident" id="1876052">c</span>&nbsp;<span class="op" id="1876054">!=</span>&nbsp;<span class="ident" id="1876057">nil</span>&nbsp;<span class="op" id="1876061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876065">oldb</span>&nbsp;<span class="op" id="1876070">:=</span>&nbsp;<span class="op" id="1876073">(</span><span class="op" id="1876074">*</span><span class="ident" id="1876075">bmap</span><span class="op" id="1876079">)</span><span class="op" id="1876080">(</span><span class="ident" id="1876081">add</span><span class="op" id="1876084">(</span><span class="ident" id="1876085">c</span><span class="op" id="1876086">,</span>&nbsp;<span class="op" id="1876088">(</span><span class="ident" id="1876089">hash</span><span class="op" id="1876093">&amp;</span><span class="op" id="1876094">(</span><span class="ident" id="1876095">m</span><span class="op" id="1876096">&gt;&gt;</span><span class="num" id="1876098">1</span><span class="op" id="1876099">)</span><span class="op" id="1876100">)</span><span class="op" id="1876101">*</span><span class="builtintype" id="1876102">uintptr</span><span class="op" id="1876109">(</span><span class="ident" id="1876110">t</span><span class="op" id="1876111">.</span><span class="ident" id="1876112">bucketsize</span><span class="op" id="1876122">)</span><span class="op" id="1876123">)</span><span class="op" id="1876124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876128">if</span>&nbsp;<span class="op" id="1876131">!</span><span class="ident" id="1876132">evacuated</span><span class="op" id="1876141">(</span><span class="ident" id="1876142">oldb</span><span class="op" id="1876146">)</span>&nbsp;<span class="op" id="1876148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876153">b</span>&nbsp;<span class="op" id="1876155">=</span>&nbsp;<span class="ident" id="1876157">oldb</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876170">top</span>&nbsp;<span class="op" id="1876174">:=</span>&nbsp;<span class="builtintype" id="1876177">uint8</span><span class="op" id="1876182">(</span><span class="ident" id="1876183">hash</span>&nbsp;<span class="op" id="1876188">&gt;&gt;</span>&nbsp;<span class="op" id="1876191">(</span><span class="ident" id="1876192">ptrSize</span><span class="op" id="1876199">*</span><span class="num" id="1876200">8</span>&nbsp;<span class="op" id="1876202">-</span>&nbsp;<span class="num" id="1876204">8</span><span class="op" id="1876205">)</span><span class="op" id="1876206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876209">if</span>&nbsp;<span class="ident" id="1876212">top</span>&nbsp;<span class="op" id="1876216">&lt;</span>&nbsp;<span class="ident" id="1876218">minTopHash</span>&nbsp;<span class="op" id="1876229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876233">top</span>&nbsp;<span class="op" id="1876237">+=</span>&nbsp;<span class="ident" id="1876240">minTopHash</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876255">for</span>&nbsp;<span class="op" id="1876259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876263">for</span>&nbsp;<span class="ident" id="1876267">i</span>&nbsp;<span class="op" id="1876269">:=</span>&nbsp;<span class="builtintype" id="1876272">uintptr</span><span class="op" id="1876279">(</span><span class="num" id="1876280">0</span><span class="op" id="1876281">)</span><span class="op" id="1876282">;</span>&nbsp;<span class="ident" id="1876284">i</span>&nbsp;<span class="op" id="1876286">&lt;</span>&nbsp;<span class="ident" id="1876288">bucketCnt</span><span class="op" id="1876297">;</span>&nbsp;<span class="ident" id="1876299">i</span><span class="op" id="1876300">++</span>&nbsp;<span class="op" id="1876303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876308">if</span>&nbsp;<span class="ident" id="1876311">b</span><span class="op" id="1876312">.</span><span class="ident" id="1876313">tophash</span><span class="op" id="1876320">[</span><span class="ident" id="1876321">i</span><span class="op" id="1876322">]</span>&nbsp;<span class="op" id="1876324">!=</span>&nbsp;<span class="ident" id="1876327">top</span>&nbsp;<span class="op" id="1876331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876337">continue</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876354">k</span>&nbsp;<span class="op" id="1876356">:=</span>&nbsp;<span class="ident" id="1876359">add</span><span class="op" id="1876362">(</span><span class="ident" id="1876363">unsafe</span><span class="op" id="1876369">.</span><span class="ident" id="1876370">Pointer</span><span class="op" id="1876377">(</span><span class="ident" id="1876378">b</span><span class="op" id="1876379">)</span><span class="op" id="1876380">,</span>&nbsp;<span class="ident" id="1876382">dataOffset</span><span class="op" id="1876392">+</span><span class="ident" id="1876393">i</span><span class="op" id="1876394">*</span><span class="builtintype" id="1876395">uintptr</span><span class="op" id="1876402">(</span><span class="ident" id="1876403">t</span><span class="op" id="1876404">.</span><span class="ident" id="1876405">keysize</span><span class="op" id="1876412">)</span><span class="op" id="1876413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876418">if</span>&nbsp;<span class="ident" id="1876421">t</span><span class="op" id="1876422">.</span><span class="ident" id="1876423">indirectkey</span>&nbsp;<span class="op" id="1876435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876441">k</span>&nbsp;<span class="op" id="1876443">=</span>&nbsp;<span class="op" id="1876445">*</span><span class="op" id="1876446">(</span><span class="op" id="1876447">(</span><span class="op" id="1876448">*</span><span class="ident" id="1876449">unsafe</span><span class="op" id="1876455">.</span><span class="ident" id="1876456">Pointer</span><span class="op" id="1876463">)</span><span class="op" id="1876464">(</span><span class="ident" id="1876465">k</span><span class="op" id="1876466">)</span><span class="op" id="1876467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876472">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876477">if</span>&nbsp;<span class="ident" id="1876480">alg</span><span class="op" id="1876483">.</span><span class="ident" id="1876484">equal</span><span class="op" id="1876489">(</span><span class="ident" id="1876490">key</span><span class="op" id="1876493">,</span>&nbsp;<span class="ident" id="1876495">k</span><span class="op" id="1876496">,</span>&nbsp;<span class="builtintype" id="1876498">uintptr</span><span class="op" id="1876505">(</span><span class="ident" id="1876506">t</span><span class="op" id="1876507">.</span><span class="ident" id="1876508">key</span><span class="op" id="1876511">.</span><span class="ident" id="1876512">size</span><span class="op" id="1876516">)</span><span class="op" id="1876517">)</span>&nbsp;<span class="op" id="1876519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876525">v</span>&nbsp;<span class="op" id="1876527">:=</span>&nbsp;<span class="ident" id="1876530">add</span><span class="op" id="1876533">(</span><span class="ident" id="1876534">unsafe</span><span class="op" id="1876540">.</span><span class="ident" id="1876541">Pointer</span><span class="op" id="1876548">(</span><span class="ident" id="1876549">b</span><span class="op" id="1876550">)</span><span class="op" id="1876551">,</span>&nbsp;<span class="ident" id="1876553">dataOffset</span><span class="op" id="1876563">+</span><span class="ident" id="1876564">bucketCnt</span><span class="op" id="1876573">*</span><span class="builtintype" id="1876574">uintptr</span><span class="op" id="1876581">(</span><span class="ident" id="1876582">t</span><span class="op" id="1876583">.</span><span class="ident" id="1876584">keysize</span><span class="op" id="1876591">)</span><span class="op" id="1876592">+</span><span class="ident" id="1876593">i</span><span class="op" id="1876594">*</span><span class="builtintype" id="1876595">uintptr</span><span class="op" id="1876602">(</span><span class="ident" id="1876603">t</span><span class="op" id="1876604">.</span><span class="ident" id="1876605">valuesize</span><span class="op" id="1876614">)</span><span class="op" id="1876615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876621">if</span>&nbsp;<span class="ident" id="1876624">t</span><span class="op" id="1876625">.</span><span class="ident" id="1876626">indirectvalue</span>&nbsp;<span class="op" id="1876640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876647">v</span>&nbsp;<span class="op" id="1876649">=</span>&nbsp;<span class="op" id="1876651">*</span><span class="op" id="1876652">(</span><span class="op" id="1876653">(</span><span class="op" id="1876654">*</span><span class="ident" id="1876655">unsafe</span><span class="op" id="1876661">.</span><span class="ident" id="1876662">Pointer</span><span class="op" id="1876669">)</span><span class="op" id="1876670">(</span><span class="ident" id="1876671">v</span><span class="op" id="1876672">)</span><span class="op" id="1876673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876679">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876685">return</span>&nbsp;<span class="ident" id="1876692">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876705">b</span>&nbsp;<span class="op" id="1876707">=</span>&nbsp;<span class="ident" id="1876709">b</span><span class="op" id="1876710">.</span><span class="ident" id="1876711">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876722">if</span>&nbsp;<span class="ident" id="1876725">b</span>&nbsp;<span class="op" id="1876727">==</span>&nbsp;<span class="ident" id="1876730">nil</span>&nbsp;<span class="op" id="1876734">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876739">return</span>&nbsp;<span class="ident" id="1876746">unsafe</span><span class="op" id="1876752">.</span><span class="ident" id="1876753">Pointer</span><span class="op" id="1876760">(</span><span class="ident" id="1876761">t</span><span class="op" id="1876762">.</span><span class="ident" id="1876763">elem</span><span class="op" id="1876767">.</span><span class="ident" id="1876768">zero</span><span class="op" id="1876772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1876779">}</span><br>
<span class="lineno"></span><span class="op" id="1876781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="1876784">func</span>&nbsp;<span class="ident" id="1876789">mapaccess2</span><span class="op" id="1876799">(</span><span class="ident" id="1876800">t</span>&nbsp;<span class="op" id="1876802">*</span><span class="ident" id="1876803">maptype</span><span class="op" id="1876810">,</span>&nbsp;<span class="ident" id="1876812">h</span>&nbsp;<span class="op" id="1876814">*</span><span class="ident" id="1876815">hmap</span><span class="op" id="1876819">,</span>&nbsp;<span class="ident" id="1876821">key</span>&nbsp;<span class="ident" id="1876825">unsafe</span><span class="op" id="1876831">.</span><span class="ident" id="1876832">Pointer</span><span class="op" id="1876839">)</span>&nbsp;<span class="op" id="1876841">(</span><span class="ident" id="1876842">unsafe</span><span class="op" id="1876848">.</span><span class="ident" id="1876849">Pointer</span><span class="op" id="1876856">,</span>&nbsp;<span class="builtintype" id="1876858">bool</span><span class="op" id="1876862">)</span>&nbsp;<span class="op" id="1876864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1876867">if</span>&nbsp;<span class="ident" id="1876870">raceenabled</span>&nbsp;<span class="op" id="1876882">&amp;&amp;</span>&nbsp;<span class="ident" id="1876885">h</span>&nbsp;<span class="op" id="1876887">!=</span>&nbsp;<span class="ident" id="1876890">nil</span>&nbsp;<span class="op" id="1876894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876898">callerpc</span>&nbsp;<span class="op" id="1876907">:=</span>&nbsp;<span class="ident" id="1876910">getcallerpc</span><span class="op" id="1876921">(</span><span class="ident" id="1876922">unsafe</span><span class="op" id="1876928">.</span><span class="ident" id="1876929">Pointer</span><span class="op" id="1876936">(</span><span class="op" id="1876937">&amp;</span><span class="ident" id="1876938">t</span><span class="op" id="1876939">)</span><span class="op" id="1876940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876944">pc</span>&nbsp;<span class="op" id="1876947">:=</span>&nbsp;<span class="ident" id="1876950">funcPC</span><span class="op" id="1876956">(</span><span class="ident" id="1876957">mapaccess2</span><span class="op" id="1876967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1876971">racereadpc</span><span class="op" id="1876981">(</span><span class="ident" id="1876982">unsafe</span><span class="op" id="1876988">.</span><span class="ident" id="1876989">Pointer</span><span class="op" id="1876996">(</span><span class="ident" id="1876997">h</span><span class="op" id="1876998">)</span><span class="op" id="1876999">,</span>&nbsp;<span class="ident" id="1877001">callerpc</span><span class="op" id="1877009">,</span>&nbsp;<span class="ident" id="1877011">pc</span><span class="op" id="1877013">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1877017">raceReadObjectPC</span><span class="op" id="1877033">(</span><span class="ident" id="1877034">t</span><span class="op" id="1877035">.</span><span class="ident" id="1877036">key</span><span class="op" id="1877039">,</span>&nbsp;<span class="ident" id="1877041">key</span><span class="op" id="1877044">,</span>&nbsp;<span class="ident" id="1877046">callerpc</span><span class="op" id="1877054">,</span>&nbsp;<span class="ident" id="1877056">pc</span><span class="op" id="1877058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1877061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1877064">if</span>&nbsp;<span class="ident" id="1877067">h</span>&nbsp;<span class="op" id="1877069">==</span>&nbsp;<span class="ident" id="1877072">nil</span>&nbsp;<span class="op" id="1877076">||</span>&nbsp;<span class="ident" id="1877079">h</span><span class="op" id="1877080">.</span><span class="ident" id="1877081">count</span>&nbsp;<span class="op" id="1877087">==</span>&nbsp;<span class="num" id="1877090">0</span>&nbsp;<span class="op" id="1877092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1877096">return</span>&nbsp;<span class="ident" id="1877103">unsafe</span><span class="op" id="1877109">.</span><span class="ident" id="1877110">Pointer</span><span class="op" id="1877117">(</span><span class="ident" id="1877118">t</span><span class="op" id="1877119">.</span><span class="ident" id="1877120">elem</span><span class="op" id="1877124">.</span><span class="ident" id="1877125">zero</span><span class="op" id="1877129">)</span><span class="op" id="1877130">,</span>&nbsp;<span class="builtintype" id="1877132">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1877139">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1877142">alg</span>&nbsp;<span class="op" id="1877146">:=</span>&nbsp;<span class="ident" id="1877149">goalg</span><span class="op" id="1877154">(</span><span class="ident" id="1877155">t</span><span class="op" id="1877156">.</span><span class="ident" id="1877157">key</span><span class="op" id="1877160">.</span><span class="ident" id="1877161">alg</span><span class="op" id="1877164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1877167">hash</span>&nbsp;<span class="op" id="1877172">:=</span>&nbsp;<span class="ident" id="1877175">alg</span><span class="op" id="1877178">.</span><span class="ident" id="1877179">hash</span><span class="op" id="1877183">(</span><span class="ident" id="1877184">key</span><span class="op" id="1877187">,</span>&nbsp;<span class="builtintype" id="1877189">uintptr</span><span class="op" id="1877196">(</span><span class="ident" id="1877197">t</span><span class="op" id="1877198">.</span><span class="ident" id="1877199">key</span><span class="op" id="1877202">.</span><span class="ident" id="1877203">size</span><span class="op" id="1877207">)</span><span class="op" id="1877208">,</span>&nbsp;<span class="builtintype" id="1877210">uintptr</span><span class="op" id="1877217">(</span><span class="ident" id="1877218">h</span><span class="op" id="1877219">.</span><span class="ident" id="1877220">hash0</span><span class="op" id="1877225">)</span><span class="op" id="1877226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1877229">m</span>&nbsp;<span class="op" id="1877231">:=</span>&nbsp;<span class="builtintype" id="1877234">uintptr</span><span class="op" id="1877241">(</span><span class="num" id="1877242">1</span><span class="op" id="1877243">)</span><span class="op" id="1877244">&lt;&lt;</span><span class="ident" id="1877246">h</span><span class="op" id="1877247">.</span><span class="ident" id="1877248">B</span>&nbsp;<span class="op" id="1877250">-</span>&nbsp;<span class="num" id="1877252">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1877255">b</span>&nbsp;<span class="op" id="1877257">:=</span>&nbsp;<span class="op" id="1877260">(</span><span class="op" id="1877261">*</span><span class="ident" id="1877262">bmap</span><span class="op" id="1877266">)</span><span class="op" id="1877267">(</span><span class="ident" id="1877268">unsafe</span><span class="op" id="1877274">.</span><span class="ident" id="1877275">Pointer</span><span class="op" id="1877282">(</span><span class="builtintype" id="1877283">uintptr</span><span class="op" id="1877290">(</span><span class="ident" id="1877291">h</span><span class="op" id="1877292">.</span><span class="ident" id="1877293">buckets</span><span class="op" id="1877300">)</span>&nbsp;<span class="op" id="1877302">+</span>&nbsp;<span class="op" id="1877304">(</span><span class="ident" id="1877305">hash</span><span class="op" id="1877309">&amp;</span><span class="ident" id="1877310">m</span><span class="op" id="1877311">)</span><span class="op" id="1877312">*</span><span class="builtintype" id="1877313">uintptr</span><span class="op" id="1877320">(</span><span class="ident" id="1877321">t</span><span class="op" id="1877322">.</span><span class="ident" id="1877323">bucketsize</span><span class="op" id="1877333">)</span><span class="op" id="1877334">)</span><span class="op" id="1877335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1877338">if</span>&nbsp;<span class="ident" id="1877341">c</span>&nbsp;<span class="op" id="1877343">:=</span>&nbsp;<span class="ident" id="1877346">h</span><span class="op" id="1877347">.</span><span class="ident" id="1877348">oldbuckets</span><span class="op" id="1877358">;</span>&nbsp;<span class="ident" id="1877360">c</span>&nbsp;<span class="op" id="1877362">!=</span>&nbsp;<span class="ident" id="1877365">nil</span>&nbsp;<span class="op" id="1877369">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1877373">oldb</span>&nbsp;<span class="op" id="1877378">:=</span>&nbsp;<span class="op" id="1877381">(</span><span class="op" id="1877382">*</span><span class="ident" id="1877383">bmap</span><span class="op" id="1877387">)</span><span class="op" id="1877388">(</span><span class="ident" id="1877389">unsafe</span><span class="op" id="1877395">.</span><span class="ident" id="1877396">Pointer</span><span class="op" id="1877403">(</span><span class="builtintype" id="1877404">uintptr</span><span class="op" id="1877411">(</span><span class="ident" id="1877412">c</span><span class="op" id="1877413">)</span>&nbsp;<span class="op" id="1877415">+</span>&nbsp;<span class="op" id="1877417">(</span><span class="ident" id="1877418">hash</span><span class="op" id="1877422">&amp;</span><span class="op" id="1877423">(</span><span class="ident" id="1877424">m</span><span class="op" id="1877425">&gt;&gt;</span><span class="num" id="1877427">1</span><span class="op" id="1877428">)</span><span class="op" id="1877429">)</span><span class="op" id="1877430">*</span><span class="builtintype" id="1877431">uintptr</span><span class="op" id="1877438">(</span><span class="ident" id="1877439">t</span><span class="op" id="1877440">.</span><span class="ident" id="1877441">bucketsize</span><span class="op" id="1877451">)</span><span class="op" id="1877452">)</span><span class="op" id="1877453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1877457">if</span>&nbsp;<span class="op" id="1877460">!</span><span class="ident" id="1877461">evacuated</span><span class="op" id="1877470">(</span><span class="ident" id="1877471">oldb</span><span class="op" id="1877475">)</span>&nbsp;<span class="op" id="1877477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1877482">b</span>&nbsp;<span class="op" id="1877484">=</span>&nbsp;<span class="ident" id="1877486">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1877493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1877496">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1877499">top</span>&nbsp;<span class="op" id="1877503">:=</span>&nbsp;<span class="builtintype" id="1877506">uint8</span><span class="op" id="1877511">(</span><span class="ident" id="1877512">hash</span>&nbsp;<span class="op" id="1877517">&gt;&gt;</span>&nbsp;<span class="op" id="1877520">(</span><span class="ident" id="1877521">ptrSize</span><span class="op" id="1877528">*</span><span class="num" id="1877529">8</span>&nbsp;<span class="op" id="1877531">-</span>&nbsp;<span class="num" id="1877533">8</span><span class="op" id="1877534">)</span><span class="op" id="1877535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1877538">if</span>&nbsp;<span class="ident" id="1877541">top</span>&nbsp;<span class="op" id="1877545">&lt;</span>&nbsp;<span class="ident" id="1877547">minTopHash</span>&nbsp;<span class="op" id="1877558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1877562">top</span>&nbsp;<span class="op" id="1877566">+=</span>&nbsp;<span class="ident" id="1877569">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1877581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1877584">for</span>&nbsp;<span class="op" id="1877588">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1877592">for</span>&nbsp;<span class="ident" id="1877596">i</span>&nbsp;<span class="op" id="1877598">:=</span>&nbsp;<span class="builtintype" id="1877601">uintptr</span><span class="op" id="1877608">(</span><span class="num" id="1877609">0</span><span class="op" id="1877610">)</span><span class="op" id="1877611">;</span>&nbsp;<span class="ident" id="1877613">i</span>&nbsp;<span class="op" id="1877615">&lt;</span>&nbsp;<span class="ident" id="1877617">bucketCnt</span><span class="op" id="1877626">;</span>&nbsp;<span class="ident" id="1877628">i</span><span class="op" id="1877629">++</span>&nbsp;<span class="op" id="1877632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1877637">if</span>&nbsp;<span class="ident" id="1877640">b</span><span class="op" id="1877641">.</span><span class="ident" id="1877642">tophash</span><span class="op" id="1877649">[</span><span class="ident" id="1877650">i</span><span class="op" id="1877651">]</span>&nbsp;<span class="op" id="1877653">!=</span>&nbsp;<span class="ident" id="1877656">top</span>&nbsp;<span class="op" id="1877660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1877666">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1877678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1877683">k</span>&nbsp;<span class="op" id="1877685">:=</span>&nbsp;<span class="ident" id="1877688">add</span><span class="op" id="1877691">(</span><span class="ident" id="1877692">unsafe</span><span class="op" id="1877698">.</span><span class="ident" id="1877699">Pointer</span><span class="op" id="1877706">(</span><span class="ident" id="1877707">b</span><span class="op" id="1877708">)</span><span class="op" id="1877709">,</span>&nbsp;<span class="ident" id="1877711">dataOffset</span><span class="op" id="1877721">+</span><span class="ident" id="1877722">i</span><span class="op" id="1877723">*</span><span class="builtintype" id="1877724">uintptr</span><span class="op" id="1877731">(</span><span class="ident" id="1877732">t</span><span class="op" id="1877733">.</span><span class="ident" id="1877734">keysize</span><span class="op" id="1877741">)</span><span class="op" id="1877742">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1877747">if</span>&nbsp;<span class="ident" id="1877750">t</span><span class="op" id="1877751">.</span><span class="ident" id="1877752">indirectkey</span>&nbsp;<span class="op" id="1877764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1877770">k</span>&nbsp;<span class="op" id="1877772">=</span>&nbsp;<span class="op" id="1877774">*</span><span class="op" id="1877775">(</span><span class="op" id="1877776">(</span><span class="op" id="1877777">*</span><span class="ident" id="1877778">unsafe</span><span class="op" id="1877784">.</span><span class="ident" id="1877785">Pointer</span><span class="op" id="1877792">)</span><span class="op" id="1877793">(</span><span class="ident" id="1877794">k</span><span class="op" id="1877795">)</span><span class="op" id="1877796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1877801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1877806">if</span>&nbsp;<span class="ident" id="1877809">alg</span><span class="op" id="1877812">.</span><span class="ident" id="1877813">equal</span><span class="op" id="1877818">(</span><span class="ident" id="1877819">key</span><span class="op" id="1877822">,</span>&nbsp;<span class="ident" id="1877824">k</span><span class="op" id="1877825">,</span>&nbsp;<span class="builtintype" id="1877827">uintptr</span><span class="op" id="1877834">(</span><span class="ident" id="1877835">t</span><span class="op" id="1877836">.</span><span class="ident" id="1877837">key</span><span class="op" id="1877840">.</span><span class="ident" id="1877841">size</span><span class="op" id="1877845">)</span><span class="op" id="1877846">)</span>&nbsp;<span class="op" id="1877848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1877854">v</span>&nbsp;<span class="op" id="1877856">:=</span>&nbsp;<span class="ident" id="1877859">add</span><span class="op" id="1877862">(</span><span class="ident" id="1877863">unsafe</span><span class="op" id="1877869">.</span><span class="ident" id="1877870">Pointer</span><span class="op" id="1877877">(</span><span class="ident" id="1877878">b</span><span class="op" id="1877879">)</span><span class="op" id="1877880">,</span>&nbsp;<span class="ident" id="1877882">dataOffset</span><span class="op" id="1877892">+</span><span class="ident" id="1877893">bucketCnt</span><span class="op" id="1877902">*</span><span class="builtintype" id="1877903">uintptr</span><span class="op" id="1877910">(</span><span class="ident" id="1877911">t</span><span class="op" id="1877912">.</span><span class="ident" id="1877913">keysize</span><span class="op" id="1877920">)</span><span class="op" id="1877921">+</span><span class="ident" id="1877922">i</span><span class="op" id="1877923">*</span><span class="builtintype" id="1877924">uintptr</span><span class="op" id="1877931">(</span><span class="ident" id="1877932">t</span><span class="op" id="1877933">.</span><span class="ident" id="1877934">valuesize</span><span class="op" id="1877943">)</span><span class="op" id="1877944">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1877950">if</span>&nbsp;<span class="ident" id="1877953">t</span><span class="op" id="1877954">.</span><span class="ident" id="1877955">indirectvalue</span>&nbsp;<span class="op" id="1877969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1877976">v</span>&nbsp;<span class="op" id="1877978">=</span>&nbsp;<span class="op" id="1877980">*</span><span class="op" id="1877981">(</span><span class="op" id="1877982">(</span><span class="op" id="1877983">*</span><span class="ident" id="1877984">unsafe</span><span class="op" id="1877990">.</span><span class="ident" id="1877991">Pointer</span><span class="op" id="1877998">)</span><span class="op" id="1877999">(</span><span class="ident" id="1878000">v</span><span class="op" id="1878001">)</span><span class="op" id="1878002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1878008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1878014">return</span>&nbsp;<span class="ident" id="1878021">v</span><span class="op" id="1878022">,</span>&nbsp;<span class="builtintype" id="1878024">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1878032">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1878036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1878040">b</span>&nbsp;<span class="op" id="1878042">=</span>&nbsp;<span class="ident" id="1878044">b</span><span class="op" id="1878045">.</span><span class="ident" id="1878046">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1878057">if</span>&nbsp;<span class="ident" id="1878060">b</span>&nbsp;<span class="op" id="1878062">==</span>&nbsp;<span class="ident" id="1878065">nil</span>&nbsp;<span class="op" id="1878069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1878074">return</span>&nbsp;<span class="ident" id="1878081">unsafe</span><span class="op" id="1878087">.</span><span class="ident" id="1878088">Pointer</span><span class="op" id="1878095">(</span><span class="ident" id="1878096">t</span><span class="op" id="1878097">.</span><span class="ident" id="1878098">elem</span><span class="op" id="1878102">.</span><span class="ident" id="1878103">zero</span><span class="op" id="1878107">)</span><span class="op" id="1878108">,</span>&nbsp;<span class="builtintype" id="1878110">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1878118">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1878121">}</span><br>
<span class="lineno"></span><span class="op" id="1878123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1878126">//&nbsp;returns&nbsp;both&nbsp;key&nbsp;and&nbsp;value.&nbsp;&nbsp;Used&nbsp;by&nbsp;map&nbsp;iterator</span><br>
<span class="lineno"></span><span class="keyword" id="1878179">func</span>&nbsp;<span class="ident" id="1878184">mapaccessK</span><span class="op" id="1878194">(</span><span class="ident" id="1878195">t</span>&nbsp;<span class="op" id="1878197">*</span><span class="ident" id="1878198">maptype</span><span class="op" id="1878205">,</span>&nbsp;<span class="ident" id="1878207">h</span>&nbsp;<span class="op" id="1878209">*</span><span class="ident" id="1878210">hmap</span><span class="op" id="1878214">,</span>&nbsp;<span class="ident" id="1878216">key</span>&nbsp;<span class="ident" id="1878220">unsafe</span><span class="op" id="1878226">.</span><span class="ident" id="1878227">Pointer</span><span class="op" id="1878234">)</span>&nbsp;<span class="op" id="1878236">(</span><span class="ident" id="1878237">unsafe</span><span class="op" id="1878243">.</span><span class="ident" id="1878244">Pointer</span><span class="op" id="1878251">,</span>&nbsp;<span class="ident" id="1878253">unsafe</span><span class="op" id="1878259">.</span><span class="ident" id="1878260">Pointer</span><span class="op" id="1878267">)</span>&nbsp;<span class="op" id="1878269">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1878272">if</span>&nbsp;<span class="ident" id="1878275">h</span>&nbsp;<span class="op" id="1878277">==</span>&nbsp;<span class="ident" id="1878280">nil</span>&nbsp;<span class="op" id="1878284">||</span>&nbsp;<span class="ident" id="1878287">h</span><span class="op" id="1878288">.</span><span class="ident" id="1878289">count</span>&nbsp;<span class="op" id="1878295">==</span>&nbsp;<span class="num" id="1878298">0</span>&nbsp;<span class="op" id="1878300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1878304">return</span>&nbsp;<span class="ident" id="1878311">nil</span><span class="op" id="1878314">,</span>&nbsp;<span class="ident" id="1878316">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1878321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1878324">alg</span>&nbsp;<span class="op" id="1878328">:=</span>&nbsp;<span class="ident" id="1878331">goalg</span><span class="op" id="1878336">(</span><span class="ident" id="1878337">t</span><span class="op" id="1878338">.</span><span class="ident" id="1878339">key</span><span class="op" id="1878342">.</span><span class="ident" id="1878343">alg</span><span class="op" id="1878346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1878349">hash</span>&nbsp;<span class="op" id="1878354">:=</span>&nbsp;<span class="ident" id="1878357">alg</span><span class="op" id="1878360">.</span><span class="ident" id="1878361">hash</span><span class="op" id="1878365">(</span><span class="ident" id="1878366">key</span><span class="op" id="1878369">,</span>&nbsp;<span class="builtintype" id="1878371">uintptr</span><span class="op" id="1878378">(</span><span class="ident" id="1878379">t</span><span class="op" id="1878380">.</span><span class="ident" id="1878381">key</span><span class="op" id="1878384">.</span><span class="ident" id="1878385">size</span><span class="op" id="1878389">)</span><span class="op" id="1878390">,</span>&nbsp;<span class="builtintype" id="1878392">uintptr</span><span class="op" id="1878399">(</span><span class="ident" id="1878400">h</span><span class="op" id="1878401">.</span><span class="ident" id="1878402">hash0</span><span class="op" id="1878407">)</span><span class="op" id="1878408">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1878411">m</span>&nbsp;<span class="op" id="1878413">:=</span>&nbsp;<span class="builtintype" id="1878416">uintptr</span><span class="op" id="1878423">(</span><span class="num" id="1878424">1</span><span class="op" id="1878425">)</span><span class="op" id="1878426">&lt;&lt;</span><span class="ident" id="1878428">h</span><span class="op" id="1878429">.</span><span class="ident" id="1878430">B</span>&nbsp;<span class="op" id="1878432">-</span>&nbsp;<span class="num" id="1878434">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1878437">b</span>&nbsp;<span class="op" id="1878439">:=</span>&nbsp;<span class="op" id="1878442">(</span><span class="op" id="1878443">*</span><span class="ident" id="1878444">bmap</span><span class="op" id="1878448">)</span><span class="op" id="1878449">(</span><span class="ident" id="1878450">unsafe</span><span class="op" id="1878456">.</span><span class="ident" id="1878457">Pointer</span><span class="op" id="1878464">(</span><span class="builtintype" id="1878465">uintptr</span><span class="op" id="1878472">(</span><span class="ident" id="1878473">h</span><span class="op" id="1878474">.</span><span class="ident" id="1878475">buckets</span><span class="op" id="1878482">)</span>&nbsp;<span class="op" id="1878484">+</span>&nbsp;<span class="op" id="1878486">(</span><span class="ident" id="1878487">hash</span><span class="op" id="1878491">&amp;</span><span class="ident" id="1878492">m</span><span class="op" id="1878493">)</span><span class="op" id="1878494">*</span><span class="builtintype" id="1878495">uintptr</span><span class="op" id="1878502">(</span><span class="ident" id="1878503">t</span><span class="op" id="1878504">.</span><span class="ident" id="1878505">bucketsize</span><span class="op" id="1878515">)</span><span class="op" id="1878516">)</span><span class="op" id="1878517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1878520">if</span>&nbsp;<span class="ident" id="1878523">c</span>&nbsp;<span class="op" id="1878525">:=</span>&nbsp;<span class="ident" id="1878528">h</span><span class="op" id="1878529">.</span><span class="ident" id="1878530">oldbuckets</span><span class="op" id="1878540">;</span>&nbsp;<span class="ident" id="1878542">c</span>&nbsp;<span class="op" id="1878544">!=</span>&nbsp;<span class="ident" id="1878547">nil</span>&nbsp;<span class="op" id="1878551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1878555">oldb</span>&nbsp;<span class="op" id="1878560">:=</span>&nbsp;<span class="op" id="1878563">(</span><span class="op" id="1878564">*</span><span class="ident" id="1878565">bmap</span><span class="op" id="1878569">)</span><span class="op" id="1878570">(</span><span class="ident" id="1878571">unsafe</span><span class="op" id="1878577">.</span><span class="ident" id="1878578">Pointer</span><span class="op" id="1878585">(</span><span class="builtintype" id="1878586">uintptr</span><span class="op" id="1878593">(</span><span class="ident" id="1878594">c</span><span class="op" id="1878595">)</span>&nbsp;<span class="op" id="1878597">+</span>&nbsp;<span class="op" id="1878599">(</span><span class="ident" id="1878600">hash</span><span class="op" id="1878604">&amp;</span><span class="op" id="1878605">(</span><span class="ident" id="1878606">m</span><span class="op" id="1878607">&gt;&gt;</span><span class="num" id="1878609">1</span><span class="op" id="1878610">)</span><span class="op" id="1878611">)</span><span class="op" id="1878612">*</span><span class="builtintype" id="1878613">uintptr</span><span class="op" id="1878620">(</span><span class="ident" id="1878621">t</span><span class="op" id="1878622">.</span><span class="ident" id="1878623">bucketsize</span><span class="op" id="1878633">)</span><span class="op" id="1878634">)</span><span class="op" id="1878635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1878639">if</span>&nbsp;<span class="op" id="1878642">!</span><span class="ident" id="1878643">evacuated</span><span class="op" id="1878652">(</span><span class="ident" id="1878653">oldb</span><span class="op" id="1878657">)</span>&nbsp;<span class="op" id="1878659">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1878664">b</span>&nbsp;<span class="op" id="1878666">=</span>&nbsp;<span class="ident" id="1878668">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1878675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1878678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1878681">top</span>&nbsp;<span class="op" id="1878685">:=</span>&nbsp;<span class="builtintype" id="1878688">uint8</span><span class="op" id="1878693">(</span><span class="ident" id="1878694">hash</span>&nbsp;<span class="op" id="1878699">&gt;&gt;</span>&nbsp;<span class="op" id="1878702">(</span><span class="ident" id="1878703">ptrSize</span><span class="op" id="1878710">*</span><span class="num" id="1878711">8</span>&nbsp;<span class="op" id="1878713">-</span>&nbsp;<span class="num" id="1878715">8</span><span class="op" id="1878716">)</span><span class="op" id="1878717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1878720">if</span>&nbsp;<span class="ident" id="1878723">top</span>&nbsp;<span class="op" id="1878727">&lt;</span>&nbsp;<span class="ident" id="1878729">minTopHash</span>&nbsp;<span class="op" id="1878740">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1878744">top</span>&nbsp;<span class="op" id="1878748">+=</span>&nbsp;<span class="ident" id="1878751">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1878763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1878766">for</span>&nbsp;<span class="op" id="1878770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1878774">for</span>&nbsp;<span class="ident" id="1878778">i</span>&nbsp;<span class="op" id="1878780">:=</span>&nbsp;<span class="builtintype" id="1878783">uintptr</span><span class="op" id="1878790">(</span><span class="num" id="1878791">0</span><span class="op" id="1878792">)</span><span class="op" id="1878793">;</span>&nbsp;<span class="ident" id="1878795">i</span>&nbsp;<span class="op" id="1878797">&lt;</span>&nbsp;<span class="ident" id="1878799">bucketCnt</span><span class="op" id="1878808">;</span>&nbsp;<span class="ident" id="1878810">i</span><span class="op" id="1878811">++</span>&nbsp;<span class="op" id="1878814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1878819">if</span>&nbsp;<span class="ident" id="1878822">b</span><span class="op" id="1878823">.</span><span class="ident" id="1878824">tophash</span><span class="op" id="1878831">[</span><span class="ident" id="1878832">i</span><span class="op" id="1878833">]</span>&nbsp;<span class="op" id="1878835">!=</span>&nbsp;<span class="ident" id="1878838">top</span>&nbsp;<span class="op" id="1878842">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1878848">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1878860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1878865">k</span>&nbsp;<span class="op" id="1878867">:=</span>&nbsp;<span class="ident" id="1878870">add</span><span class="op" id="1878873">(</span><span class="ident" id="1878874">unsafe</span><span class="op" id="1878880">.</span><span class="ident" id="1878881">Pointer</span><span class="op" id="1878888">(</span><span class="ident" id="1878889">b</span><span class="op" id="1878890">)</span><span class="op" id="1878891">,</span>&nbsp;<span class="ident" id="1878893">dataOffset</span><span class="op" id="1878903">+</span><span class="ident" id="1878904">i</span><span class="op" id="1878905">*</span><span class="builtintype" id="1878906">uintptr</span><span class="op" id="1878913">(</span><span class="ident" id="1878914">t</span><span class="op" id="1878915">.</span><span class="ident" id="1878916">keysize</span><span class="op" id="1878923">)</span><span class="op" id="1878924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1878929">if</span>&nbsp;<span class="ident" id="1878932">t</span><span class="op" id="1878933">.</span><span class="ident" id="1878934">indirectkey</span>&nbsp;<span class="op" id="1878946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1878952">k</span>&nbsp;<span class="op" id="1878954">=</span>&nbsp;<span class="op" id="1878956">*</span><span class="op" id="1878957">(</span><span class="op" id="1878958">(</span><span class="op" id="1878959">*</span><span class="ident" id="1878960">unsafe</span><span class="op" id="1878966">.</span><span class="ident" id="1878967">Pointer</span><span class="op" id="1878974">)</span><span class="op" id="1878975">(</span><span class="ident" id="1878976">k</span><span class="op" id="1878977">)</span><span class="op" id="1878978">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1878983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1878988">if</span>&nbsp;<span class="ident" id="1878991">alg</span><span class="op" id="1878994">.</span><span class="ident" id="1878995">equal</span><span class="op" id="1879000">(</span><span class="ident" id="1879001">key</span><span class="op" id="1879004">,</span>&nbsp;<span class="ident" id="1879006">k</span><span class="op" id="1879007">,</span>&nbsp;<span class="builtintype" id="1879009">uintptr</span><span class="op" id="1879016">(</span><span class="ident" id="1879017">t</span><span class="op" id="1879018">.</span><span class="ident" id="1879019">key</span><span class="op" id="1879022">.</span><span class="ident" id="1879023">size</span><span class="op" id="1879027">)</span><span class="op" id="1879028">)</span>&nbsp;<span class="op" id="1879030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1879036">v</span>&nbsp;<span class="op" id="1879038">:=</span>&nbsp;<span class="ident" id="1879041">add</span><span class="op" id="1879044">(</span><span class="ident" id="1879045">unsafe</span><span class="op" id="1879051">.</span><span class="ident" id="1879052">Pointer</span><span class="op" id="1879059">(</span><span class="ident" id="1879060">b</span><span class="op" id="1879061">)</span><span class="op" id="1879062">,</span>&nbsp;<span class="ident" id="1879064">dataOffset</span><span class="op" id="1879074">+</span><span class="ident" id="1879075">bucketCnt</span><span class="op" id="1879084">*</span><span class="builtintype" id="1879085">uintptr</span><span class="op" id="1879092">(</span><span class="ident" id="1879093">t</span><span class="op" id="1879094">.</span><span class="ident" id="1879095">keysize</span><span class="op" id="1879102">)</span><span class="op" id="1879103">+</span><span class="ident" id="1879104">i</span><span class="op" id="1879105">*</span><span class="builtintype" id="1879106">uintptr</span><span class="op" id="1879113">(</span><span class="ident" id="1879114">t</span><span class="op" id="1879115">.</span><span class="ident" id="1879116">valuesize</span><span class="op" id="1879125">)</span><span class="op" id="1879126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1879132">if</span>&nbsp;<span class="ident" id="1879135">t</span><span class="op" id="1879136">.</span><span class="ident" id="1879137">indirectvalue</span>&nbsp;<span class="op" id="1879151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1879158">v</span>&nbsp;<span class="op" id="1879160">=</span>&nbsp;<span class="op" id="1879162">*</span><span class="op" id="1879163">(</span><span class="op" id="1879164">(</span><span class="op" id="1879165">*</span><span class="ident" id="1879166">unsafe</span><span class="op" id="1879172">.</span><span class="ident" id="1879173">Pointer</span><span class="op" id="1879180">)</span><span class="op" id="1879181">(</span><span class="ident" id="1879182">v</span><span class="op" id="1879183">)</span><span class="op" id="1879184">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1879190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1879196">return</span>&nbsp;<span class="ident" id="1879203">k</span><span class="op" id="1879204">,</span>&nbsp;<span class="ident" id="1879206">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1879211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1879215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1879219">b</span>&nbsp;<span class="op" id="1879221">=</span>&nbsp;<span class="ident" id="1879223">b</span><span class="op" id="1879224">.</span><span class="ident" id="1879225">overflow</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1879236">if</span>&nbsp;<span class="ident" id="1879239">b</span>&nbsp;<span class="op" id="1879241">==</span>&nbsp;<span class="ident" id="1879244">nil</span>&nbsp;<span class="op" id="1879248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1879253">return</span>&nbsp;<span class="ident" id="1879260">nil</span><span class="op" id="1879263">,</span>&nbsp;<span class="ident" id="1879265">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1879271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1879274">}</span><br>
<span class="lineno"></span><span class="op" id="1879276">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="1879279">func</span>&nbsp;<span class="ident" id="1879284">mapassign1</span><span class="op" id="1879294">(</span><span class="ident" id="1879295">t</span>&nbsp;<span class="op" id="1879297">*</span><span class="ident" id="1879298">maptype</span><span class="op" id="1879305">,</span>&nbsp;<span class="ident" id="1879307">h</span>&nbsp;<span class="op" id="1879309">*</span><span class="ident" id="1879310">hmap</span><span class="op" id="1879314">,</span>&nbsp;<span class="ident" id="1879316">key</span>&nbsp;<span class="ident" id="1879320">unsafe</span><span class="op" id="1879326">.</span><span class="ident" id="1879327">Pointer</span><span class="op" id="1879334">,</span>&nbsp;<span class="ident" id="1879336">val</span>&nbsp;<span class="ident" id="1879340">unsafe</span><span class="op" id="1879346">.</span><span class="ident" id="1879347">Pointer</span><span class="op" id="1879354">)</span>&nbsp;<span class="op" id="1879356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1879359">if</span>&nbsp;<span class="ident" id="1879362">h</span>&nbsp;<span class="op" id="1879364">==</span>&nbsp;<span class="ident" id="1879367">nil</span>&nbsp;<span class="op" id="1879371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1879375">panic</span><span class="op" id="1879380">(</span><span class="string" id="1879381">&#34;assignment&nbsp;to&nbsp;entry&nbsp;in&nbsp;nil&nbsp;map&#34;</span><span class="op" id="1879413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1879416">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1879419">if</span>&nbsp;<span class="ident" id="1879422">raceenabled</span>&nbsp;<span class="op" id="1879434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1879438">callerpc</span>&nbsp;<span class="op" id="1879447">:=</span>&nbsp;<span class="ident" id="1879450">getcallerpc</span><span class="op" id="1879461">(</span><span class="ident" id="1879462">unsafe</span><span class="op" id="1879468">.</span><span class="ident" id="1879469">Pointer</span><span class="op" id="1879476">(</span><span class="op" id="1879477">&amp;</span><span class="ident" id="1879478">t</span><span class="op" id="1879479">)</span><span class="op" id="1879480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1879484">pc</span>&nbsp;<span class="op" id="1879487">:=</span>&nbsp;<span class="ident" id="1879490">funcPC</span><span class="op" id="1879496">(</span><span class="ident" id="1879497">mapassign1</span><span class="op" id="1879507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1879511">racewritepc</span><span class="op" id="1879522">(</span><span class="ident" id="1879523">unsafe</span><span class="op" id="1879529">.</span><span class="ident" id="1879530">Pointer</span><span class="op" id="1879537">(</span><span class="ident" id="1879538">h</span><span class="op" id="1879539">)</span><span class="op" id="1879540">,</span>&nbsp;<span class="ident" id="1879542">callerpc</span><span class="op" id="1879550">,</span>&nbsp;<span class="ident" id="1879552">pc</span><span class="op" id="1879554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1879558">raceReadObjectPC</span><span class="op" id="1879574">(</span><span class="ident" id="1879575">t</span><span class="op" id="1879576">.</span><span class="ident" id="1879577">key</span><span class="op" id="1879580">,</span>&nbsp;<span class="ident" id="1879582">key</span><span class="op" id="1879585">,</span>&nbsp;<span class="ident" id="1879587">callerpc</span><span class="op" id="1879595">,</span>&nbsp;<span class="ident" id="1879597">pc</span><span class="op" id="1879599">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1879603">raceReadObjectPC</span><span class="op" id="1879619">(</span><span class="ident" id="1879620">t</span><span class="op" id="1879621">.</span><span class="ident" id="1879622">elem</span><span class="op" id="1879626">,</span>&nbsp;<span class="ident" id="1879628">val</span><span class="op" id="1879631">,</span>&nbsp;<span class="ident" id="1879633">callerpc</span><span class="op" id="1879641">,</span>&nbsp;<span class="ident" id="1879643">pc</span><span class="op" id="1879645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1879648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1879652">alg</span>&nbsp;<span class="op" id="1879656">:=</span>&nbsp;<span class="ident" id="1879659">goalg</span><span class="op" id="1879664">(</span><span class="ident" id="1879665">t</span><span class="op" id="1879666">.</span><span class="ident" id="1879667">key</span><span class="op" id="1879670">.</span><span class="ident" id="1879671">alg</span><span class="op" id="1879674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1879677">hash</span>&nbsp;<span class="op" id="1879682">:=</span>&nbsp;<span class="ident" id="1879685">alg</span><span class="op" id="1879688">.</span><span class="ident" id="1879689">hash</span><span class="op" id="1879693">(</span><span class="ident" id="1879694">key</span><span class="op" id="1879697">,</span>&nbsp;<span class="builtintype" id="1879699">uintptr</span><span class="op" id="1879706">(</span><span class="ident" id="1879707">t</span><span class="op" id="1879708">.</span><span class="ident" id="1879709">key</span><span class="op" id="1879712">.</span><span class="ident" id="1879713">size</span><span class="op" id="1879717">)</span><span class="op" id="1879718">,</span>&nbsp;<span class="builtintype" id="1879720">uintptr</span><span class="op" id="1879727">(</span><span class="ident" id="1879728">h</span><span class="op" id="1879729">.</span><span class="ident" id="1879730">hash0</span><span class="op" id="1879735">)</span><span class="op" id="1879736">)</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1879740">if</span>&nbsp;<span class="ident" id="1879743">h</span><span class="op" id="1879744">.</span><span class="ident" id="1879745">buckets</span>&nbsp;<span class="op" id="1879753">==</span>&nbsp;<span class="ident" id="1879756">nil</span>&nbsp;<span class="op" id="1879760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1879764">if</span>&nbsp;<span class="ident" id="1879767">checkgc</span>&nbsp;<span class="op" id="1879775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1879780">memstats</span><span class="op" id="1879788">.</span><span class="ident" id="1879789">next_gc</span>&nbsp;<span class="op" id="1879797">=</span>&nbsp;<span class="ident" id="1879799">memstats</span><span class="op" id="1879807">.</span><span class="ident" id="1879808">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1879821">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1879825">h</span><span class="op" id="1879826">.</span><span class="ident" id="1879827">buckets</span>&nbsp;<span class="op" id="1879835">=</span>&nbsp;<span class="ident" id="1879837">newarray</span><span class="op" id="1879845">(</span><span class="ident" id="1879846">t</span><span class="op" id="1879847">.</span><span class="ident" id="1879848">bucket</span><span class="op" id="1879854">,</span>&nbsp;<span class="num" id="1879856">1</span><span class="op" id="1879857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1879860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1879863">again</span><span class="op" id="1879868">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1879871">bucket</span>&nbsp;<span class="op" id="1879878">:=</span>&nbsp;<span class="ident" id="1879881">hash</span>&nbsp;<span class="op" id="1879886">&amp;</span>&nbsp;<span class="op" id="1879888">(</span><span class="builtintype" id="1879889">uintptr</span><span class="op" id="1879896">(</span><span class="num" id="1879897">1</span><span class="op" id="1879898">)</span><span class="op" id="1879899">&lt;&lt;</span><span class="ident" id="1879901">h</span><span class="op" id="1879902">.</span><span class="ident" id="1879903">B</span>&nbsp;<span class="op" id="1879905">-</span>&nbsp;<span class="num" id="1879907">1</span><span class="op" id="1879908">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1879911">if</span>&nbsp;<span class="ident" id="1879914">h</span><span class="op" id="1879915">.</span><span class="ident" id="1879916">oldbuckets</span>&nbsp;<span class="op" id="1879927">!=</span>&nbsp;<span class="ident" id="1879930">nil</span>&nbsp;<span class="op" id="1879934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1879938">growWork</span><span class="op" id="1879946">(</span><span class="ident" id="1879947">t</span><span class="op" id="1879948">,</span>&nbsp;<span class="ident" id="1879950">h</span><span class="op" id="1879951">,</span>&nbsp;<span class="ident" id="1879953">bucket</span><span class="op" id="1879959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1879962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1879965">b</span>&nbsp;<span class="op" id="1879967">:=</span>&nbsp;<span class="op" id="1879970">(</span><span class="op" id="1879971">*</span><span class="ident" id="1879972">bmap</span><span class="op" id="1879976">)</span><span class="op" id="1879977">(</span><span class="ident" id="1879978">unsafe</span><span class="op" id="1879984">.</span><span class="ident" id="1879985">Pointer</span><span class="op" id="1879992">(</span><span class="builtintype" id="1879993">uintptr</span><span class="op" id="1880000">(</span><span class="ident" id="1880001">h</span><span class="op" id="1880002">.</span><span class="ident" id="1880003">buckets</span><span class="op" id="1880010">)</span>&nbsp;<span class="op" id="1880012">+</span>&nbsp;<span class="ident" id="1880014">bucket</span><span class="op" id="1880020">*</span><span class="builtintype" id="1880021">uintptr</span><span class="op" id="1880028">(</span><span class="ident" id="1880029">t</span><span class="op" id="1880030">.</span><span class="ident" id="1880031">bucketsize</span><span class="op" id="1880041">)</span><span class="op" id="1880042">)</span><span class="op" id="1880043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880046">top</span>&nbsp;<span class="op" id="1880050">:=</span>&nbsp;<span class="builtintype" id="1880053">uint8</span><span class="op" id="1880058">(</span><span class="ident" id="1880059">hash</span>&nbsp;<span class="op" id="1880064">&gt;&gt;</span>&nbsp;<span class="op" id="1880067">(</span><span class="ident" id="1880068">ptrSize</span><span class="op" id="1880075">*</span><span class="num" id="1880076">8</span>&nbsp;<span class="op" id="1880078">-</span>&nbsp;<span class="num" id="1880080">8</span><span class="op" id="1880081">)</span><span class="op" id="1880082">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880085">if</span>&nbsp;<span class="ident" id="1880088">top</span>&nbsp;<span class="op" id="1880092">&lt;</span>&nbsp;<span class="ident" id="1880094">minTopHash</span>&nbsp;<span class="op" id="1880105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880109">top</span>&nbsp;<span class="op" id="1880113">+=</span>&nbsp;<span class="ident" id="1880116">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1880128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880132">var</span>&nbsp;<span class="ident" id="1880136">inserti</span>&nbsp;<span class="op" id="1880144">*</span><span class="builtintype" id="1880145">uint8</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880152">var</span>&nbsp;<span class="ident" id="1880156">insertk</span>&nbsp;<span class="ident" id="1880164">unsafe</span><span class="op" id="1880170">.</span><span class="ident" id="1880171">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880180">var</span>&nbsp;<span class="ident" id="1880184">insertv</span>&nbsp;<span class="ident" id="1880192">unsafe</span><span class="op" id="1880198">.</span><span class="ident" id="1880199">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880208">for</span>&nbsp;<span class="op" id="1880212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880216">for</span>&nbsp;<span class="ident" id="1880220">i</span>&nbsp;<span class="op" id="1880222">:=</span>&nbsp;<span class="builtintype" id="1880225">uintptr</span><span class="op" id="1880232">(</span><span class="num" id="1880233">0</span><span class="op" id="1880234">)</span><span class="op" id="1880235">;</span>&nbsp;<span class="ident" id="1880237">i</span>&nbsp;<span class="op" id="1880239">&lt;</span>&nbsp;<span class="ident" id="1880241">bucketCnt</span><span class="op" id="1880250">;</span>&nbsp;<span class="ident" id="1880252">i</span><span class="op" id="1880253">++</span>&nbsp;<span class="op" id="1880256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880261">if</span>&nbsp;<span class="ident" id="1880264">b</span><span class="op" id="1880265">.</span><span class="ident" id="1880266">tophash</span><span class="op" id="1880273">[</span><span class="ident" id="1880274">i</span><span class="op" id="1880275">]</span>&nbsp;<span class="op" id="1880277">!=</span>&nbsp;<span class="ident" id="1880280">top</span>&nbsp;<span class="op" id="1880284">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880290">if</span>&nbsp;<span class="ident" id="1880293">b</span><span class="op" id="1880294">.</span><span class="ident" id="1880295">tophash</span><span class="op" id="1880302">[</span><span class="ident" id="1880303">i</span><span class="op" id="1880304">]</span>&nbsp;<span class="op" id="1880306">==</span>&nbsp;<span class="ident" id="1880309">empty</span>&nbsp;<span class="op" id="1880315">&amp;&amp;</span>&nbsp;<span class="ident" id="1880318">inserti</span>&nbsp;<span class="op" id="1880326">==</span>&nbsp;<span class="ident" id="1880329">nil</span>&nbsp;<span class="op" id="1880333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880340">inserti</span>&nbsp;<span class="op" id="1880348">=</span>&nbsp;<span class="op" id="1880350">&amp;</span><span class="ident" id="1880351">b</span><span class="op" id="1880352">.</span><span class="ident" id="1880353">tophash</span><span class="op" id="1880360">[</span><span class="ident" id="1880361">i</span><span class="op" id="1880362">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880369">insertk</span>&nbsp;<span class="op" id="1880377">=</span>&nbsp;<span class="ident" id="1880379">add</span><span class="op" id="1880382">(</span><span class="ident" id="1880383">unsafe</span><span class="op" id="1880389">.</span><span class="ident" id="1880390">Pointer</span><span class="op" id="1880397">(</span><span class="ident" id="1880398">b</span><span class="op" id="1880399">)</span><span class="op" id="1880400">,</span>&nbsp;<span class="ident" id="1880402">dataOffset</span><span class="op" id="1880412">+</span><span class="ident" id="1880413">i</span><span class="op" id="1880414">*</span><span class="builtintype" id="1880415">uintptr</span><span class="op" id="1880422">(</span><span class="ident" id="1880423">t</span><span class="op" id="1880424">.</span><span class="ident" id="1880425">keysize</span><span class="op" id="1880432">)</span><span class="op" id="1880433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880440">insertv</span>&nbsp;<span class="op" id="1880448">=</span>&nbsp;<span class="ident" id="1880450">add</span><span class="op" id="1880453">(</span><span class="ident" id="1880454">unsafe</span><span class="op" id="1880460">.</span><span class="ident" id="1880461">Pointer</span><span class="op" id="1880468">(</span><span class="ident" id="1880469">b</span><span class="op" id="1880470">)</span><span class="op" id="1880471">,</span>&nbsp;<span class="ident" id="1880473">dataOffset</span><span class="op" id="1880483">+</span><span class="ident" id="1880484">bucketCnt</span><span class="op" id="1880493">*</span><span class="builtintype" id="1880494">uintptr</span><span class="op" id="1880501">(</span><span class="ident" id="1880502">t</span><span class="op" id="1880503">.</span><span class="ident" id="1880504">keysize</span><span class="op" id="1880511">)</span><span class="op" id="1880512">+</span><span class="ident" id="1880513">i</span><span class="op" id="1880514">*</span><span class="builtintype" id="1880515">uintptr</span><span class="op" id="1880522">(</span><span class="ident" id="1880523">t</span><span class="op" id="1880524">.</span><span class="ident" id="1880525">valuesize</span><span class="op" id="1880534">)</span><span class="op" id="1880535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1880541">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880547">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1880559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880564">k</span>&nbsp;<span class="op" id="1880566">:=</span>&nbsp;<span class="ident" id="1880569">add</span><span class="op" id="1880572">(</span><span class="ident" id="1880573">unsafe</span><span class="op" id="1880579">.</span><span class="ident" id="1880580">Pointer</span><span class="op" id="1880587">(</span><span class="ident" id="1880588">b</span><span class="op" id="1880589">)</span><span class="op" id="1880590">,</span>&nbsp;<span class="ident" id="1880592">dataOffset</span><span class="op" id="1880602">+</span><span class="ident" id="1880603">i</span><span class="op" id="1880604">*</span><span class="builtintype" id="1880605">uintptr</span><span class="op" id="1880612">(</span><span class="ident" id="1880613">t</span><span class="op" id="1880614">.</span><span class="ident" id="1880615">keysize</span><span class="op" id="1880622">)</span><span class="op" id="1880623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880628">k2</span>&nbsp;<span class="op" id="1880631">:=</span>&nbsp;<span class="ident" id="1880634">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880639">if</span>&nbsp;<span class="ident" id="1880642">t</span><span class="op" id="1880643">.</span><span class="ident" id="1880644">indirectkey</span>&nbsp;<span class="op" id="1880656">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880662">k2</span>&nbsp;<span class="op" id="1880665">=</span>&nbsp;<span class="op" id="1880667">*</span><span class="op" id="1880668">(</span><span class="op" id="1880669">(</span><span class="op" id="1880670">*</span><span class="ident" id="1880671">unsafe</span><span class="op" id="1880677">.</span><span class="ident" id="1880678">Pointer</span><span class="op" id="1880685">)</span><span class="op" id="1880686">(</span><span class="ident" id="1880687">k2</span><span class="op" id="1880689">)</span><span class="op" id="1880690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1880695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880700">if</span>&nbsp;<span class="op" id="1880703">!</span><span class="ident" id="1880704">alg</span><span class="op" id="1880707">.</span><span class="ident" id="1880708">equal</span><span class="op" id="1880713">(</span><span class="ident" id="1880714">key</span><span class="op" id="1880717">,</span>&nbsp;<span class="ident" id="1880719">k2</span><span class="op" id="1880721">,</span>&nbsp;<span class="builtintype" id="1880723">uintptr</span><span class="op" id="1880730">(</span><span class="ident" id="1880731">t</span><span class="op" id="1880732">.</span><span class="ident" id="1880733">key</span><span class="op" id="1880736">.</span><span class="ident" id="1880737">size</span><span class="op" id="1880741">)</span><span class="op" id="1880742">)</span>&nbsp;<span class="op" id="1880744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880750">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1880762">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1880767">//&nbsp;already&nbsp;have&nbsp;a&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Update&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880817">memmove</span><span class="op" id="1880824">(</span><span class="ident" id="1880825">k2</span><span class="op" id="1880827">,</span>&nbsp;<span class="ident" id="1880829">key</span><span class="op" id="1880832">,</span>&nbsp;<span class="builtintype" id="1880834">uintptr</span><span class="op" id="1880841">(</span><span class="ident" id="1880842">t</span><span class="op" id="1880843">.</span><span class="ident" id="1880844">key</span><span class="op" id="1880847">.</span><span class="ident" id="1880848">size</span><span class="op" id="1880852">)</span><span class="op" id="1880853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880858">v</span>&nbsp;<span class="op" id="1880860">:=</span>&nbsp;<span class="ident" id="1880863">add</span><span class="op" id="1880866">(</span><span class="ident" id="1880867">unsafe</span><span class="op" id="1880873">.</span><span class="ident" id="1880874">Pointer</span><span class="op" id="1880881">(</span><span class="ident" id="1880882">b</span><span class="op" id="1880883">)</span><span class="op" id="1880884">,</span>&nbsp;<span class="ident" id="1880886">dataOffset</span><span class="op" id="1880896">+</span><span class="ident" id="1880897">bucketCnt</span><span class="op" id="1880906">*</span><span class="builtintype" id="1880907">uintptr</span><span class="op" id="1880914">(</span><span class="ident" id="1880915">t</span><span class="op" id="1880916">.</span><span class="ident" id="1880917">keysize</span><span class="op" id="1880924">)</span><span class="op" id="1880925">+</span><span class="ident" id="1880926">i</span><span class="op" id="1880927">*</span><span class="builtintype" id="1880928">uintptr</span><span class="op" id="1880935">(</span><span class="ident" id="1880936">t</span><span class="op" id="1880937">.</span><span class="ident" id="1880938">valuesize</span><span class="op" id="1880947">)</span><span class="op" id="1880948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880953">v2</span>&nbsp;<span class="op" id="1880956">:=</span>&nbsp;<span class="ident" id="1880959">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1880964">if</span>&nbsp;<span class="ident" id="1880967">t</span><span class="op" id="1880968">.</span><span class="ident" id="1880969">indirectvalue</span>&nbsp;<span class="op" id="1880983">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1880989">v2</span>&nbsp;<span class="op" id="1880992">=</span>&nbsp;<span class="op" id="1880994">*</span><span class="op" id="1880995">(</span><span class="op" id="1880996">(</span><span class="op" id="1880997">*</span><span class="ident" id="1880998">unsafe</span><span class="op" id="1881004">.</span><span class="ident" id="1881005">Pointer</span><span class="op" id="1881012">)</span><span class="op" id="1881013">(</span><span class="ident" id="1881014">v2</span><span class="op" id="1881016">)</span><span class="op" id="1881017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881027">memmove</span><span class="op" id="1881034">(</span><span class="ident" id="1881035">v2</span><span class="op" id="1881037">,</span>&nbsp;<span class="ident" id="1881039">val</span><span class="op" id="1881042">,</span>&nbsp;<span class="builtintype" id="1881044">uintptr</span><span class="op" id="1881051">(</span><span class="ident" id="1881052">t</span><span class="op" id="1881053">.</span><span class="ident" id="1881054">elem</span><span class="op" id="1881058">.</span><span class="ident" id="1881059">size</span><span class="op" id="1881063">)</span><span class="op" id="1881064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881069">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881078">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881082">if</span>&nbsp;<span class="ident" id="1881085">b</span><span class="op" id="1881086">.</span><span class="ident" id="1881087">overflow</span>&nbsp;<span class="op" id="1881096">==</span>&nbsp;<span class="ident" id="1881099">nil</span>&nbsp;<span class="op" id="1881103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881108">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881120">b</span>&nbsp;<span class="op" id="1881122">=</span>&nbsp;<span class="ident" id="1881124">b</span><span class="op" id="1881125">.</span><span class="ident" id="1881126">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881136">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1881140">//&nbsp;did&nbsp;not&nbsp;find&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Allocate&nbsp;new&nbsp;cell&nbsp;&amp;&nbsp;add&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881206">if</span>&nbsp;<span class="builtintype" id="1881209">float32</span><span class="op" id="1881216">(</span><span class="ident" id="1881217">h</span><span class="op" id="1881218">.</span><span class="ident" id="1881219">count</span><span class="op" id="1881224">)</span>&nbsp;<span class="op" id="1881226">&gt;=</span>&nbsp;<span class="ident" id="1881229">loadFactor</span><span class="op" id="1881239">*</span><span class="builtintype" id="1881240">float32</span><span class="op" id="1881247">(</span><span class="op" id="1881248">(</span><span class="builtintype" id="1881249">uintptr</span><span class="op" id="1881256">(</span><span class="num" id="1881257">1</span><span class="op" id="1881258">)</span><span class="op" id="1881259">&lt;&lt;</span><span class="ident" id="1881261">h</span><span class="op" id="1881262">.</span><span class="ident" id="1881263">B</span><span class="op" id="1881264">)</span><span class="op" id="1881265">)</span>&nbsp;<span class="op" id="1881267">&amp;&amp;</span>&nbsp;<span class="ident" id="1881270">h</span><span class="op" id="1881271">.</span><span class="ident" id="1881272">count</span>&nbsp;<span class="op" id="1881278">&gt;=</span>&nbsp;<span class="ident" id="1881281">bucketCnt</span>&nbsp;<span class="op" id="1881291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881295">hashGrow</span><span class="op" id="1881303">(</span><span class="ident" id="1881304">t</span><span class="op" id="1881305">,</span>&nbsp;<span class="ident" id="1881307">h</span><span class="op" id="1881308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881312">goto</span>&nbsp;<span class="ident" id="1881317">again</span>&nbsp;<span class="comment" id="1881323">//&nbsp;Growing&nbsp;the&nbsp;table&nbsp;invalidates&nbsp;everything,&nbsp;so&nbsp;try&nbsp;again</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881386">if</span>&nbsp;<span class="ident" id="1881389">inserti</span>&nbsp;<span class="op" id="1881397">==</span>&nbsp;<span class="ident" id="1881400">nil</span>&nbsp;<span class="op" id="1881404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1881408">//&nbsp;all&nbsp;current&nbsp;buckets&nbsp;are&nbsp;full,&nbsp;allocate&nbsp;a&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881463">if</span>&nbsp;<span class="ident" id="1881466">checkgc</span>&nbsp;<span class="op" id="1881474">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881479">memstats</span><span class="op" id="1881487">.</span><span class="ident" id="1881488">next_gc</span>&nbsp;<span class="op" id="1881496">=</span>&nbsp;<span class="ident" id="1881498">memstats</span><span class="op" id="1881506">.</span><span class="ident" id="1881507">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881524">newb</span>&nbsp;<span class="op" id="1881529">:=</span>&nbsp;<span class="op" id="1881532">(</span><span class="op" id="1881533">*</span><span class="ident" id="1881534">bmap</span><span class="op" id="1881538">)</span><span class="op" id="1881539">(</span><span class="ident" id="1881540">newobject</span><span class="op" id="1881549">(</span><span class="ident" id="1881550">t</span><span class="op" id="1881551">.</span><span class="ident" id="1881552">bucket</span><span class="op" id="1881558">)</span><span class="op" id="1881559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881563">b</span><span class="op" id="1881564">.</span><span class="ident" id="1881565">overflow</span>&nbsp;<span class="op" id="1881574">=</span>&nbsp;<span class="ident" id="1881576">newb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881583">inserti</span>&nbsp;<span class="op" id="1881591">=</span>&nbsp;<span class="op" id="1881593">&amp;</span><span class="ident" id="1881594">newb</span><span class="op" id="1881598">.</span><span class="ident" id="1881599">tophash</span><span class="op" id="1881606">[</span><span class="num" id="1881607">0</span><span class="op" id="1881608">]</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881612">insertk</span>&nbsp;<span class="op" id="1881620">=</span>&nbsp;<span class="ident" id="1881622">add</span><span class="op" id="1881625">(</span><span class="ident" id="1881626">unsafe</span><span class="op" id="1881632">.</span><span class="ident" id="1881633">Pointer</span><span class="op" id="1881640">(</span><span class="ident" id="1881641">newb</span><span class="op" id="1881645">)</span><span class="op" id="1881646">,</span>&nbsp;<span class="ident" id="1881648">dataOffset</span><span class="op" id="1881658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881662">insertv</span>&nbsp;<span class="op" id="1881670">=</span>&nbsp;<span class="ident" id="1881672">add</span><span class="op" id="1881675">(</span><span class="ident" id="1881676">insertk</span><span class="op" id="1881683">,</span>&nbsp;<span class="ident" id="1881685">bucketCnt</span><span class="op" id="1881694">*</span><span class="builtintype" id="1881695">uintptr</span><span class="op" id="1881702">(</span><span class="ident" id="1881703">t</span><span class="op" id="1881704">.</span><span class="ident" id="1881705">keysize</span><span class="op" id="1881712">)</span><span class="op" id="1881713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1881720">//&nbsp;store&nbsp;new&nbsp;key/value&nbsp;at&nbsp;insert&nbsp;position</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881763">if</span>&nbsp;<span class="ident" id="1881766">t</span><span class="op" id="1881767">.</span><span class="ident" id="1881768">indirectkey</span>&nbsp;<span class="op" id="1881780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881784">if</span>&nbsp;<span class="ident" id="1881787">checkgc</span>&nbsp;<span class="op" id="1881795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881800">memstats</span><span class="op" id="1881808">.</span><span class="ident" id="1881809">next_gc</span>&nbsp;<span class="op" id="1881817">=</span>&nbsp;<span class="ident" id="1881819">memstats</span><span class="op" id="1881827">.</span><span class="ident" id="1881828">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881845">kmem</span>&nbsp;<span class="op" id="1881850">:=</span>&nbsp;<span class="ident" id="1881853">newobject</span><span class="op" id="1881862">(</span><span class="ident" id="1881863">t</span><span class="op" id="1881864">.</span><span class="ident" id="1881865">key</span><span class="op" id="1881868">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881872">*</span><span class="op" id="1881873">(</span><span class="op" id="1881874">*</span><span class="ident" id="1881875">unsafe</span><span class="op" id="1881881">.</span><span class="ident" id="1881882">Pointer</span><span class="op" id="1881889">)</span><span class="op" id="1881890">(</span><span class="ident" id="1881891">insertk</span><span class="op" id="1881898">)</span>&nbsp;<span class="op" id="1881900">=</span>&nbsp;<span class="ident" id="1881902">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881909">insertk</span>&nbsp;<span class="op" id="1881917">=</span>&nbsp;<span class="ident" id="1881919">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1881925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881928">if</span>&nbsp;<span class="ident" id="1881931">t</span><span class="op" id="1881932">.</span><span class="ident" id="1881933">indirectvalue</span>&nbsp;<span class="op" id="1881947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1881951">if</span>&nbsp;<span class="ident" id="1881954">checkgc</span>&nbsp;<span class="op" id="1881962">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1881967">memstats</span><span class="op" id="1881975">.</span><span class="ident" id="1881976">next_gc</span>&nbsp;<span class="op" id="1881984">=</span>&nbsp;<span class="ident" id="1881986">memstats</span><span class="op" id="1881994">.</span><span class="ident" id="1881995">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1882008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882012">vmem</span>&nbsp;<span class="op" id="1882017">:=</span>&nbsp;<span class="ident" id="1882020">newobject</span><span class="op" id="1882029">(</span><span class="ident" id="1882030">t</span><span class="op" id="1882031">.</span><span class="ident" id="1882032">elem</span><span class="op" id="1882036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1882040">*</span><span class="op" id="1882041">(</span><span class="op" id="1882042">*</span><span class="ident" id="1882043">unsafe</span><span class="op" id="1882049">.</span><span class="ident" id="1882050">Pointer</span><span class="op" id="1882057">)</span><span class="op" id="1882058">(</span><span class="ident" id="1882059">insertv</span><span class="op" id="1882066">)</span>&nbsp;<span class="op" id="1882068">=</span>&nbsp;<span class="ident" id="1882070">vmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882077">insertv</span>&nbsp;<span class="op" id="1882085">=</span>&nbsp;<span class="ident" id="1882087">vmem</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1882093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882096">memmove</span><span class="op" id="1882103">(</span><span class="ident" id="1882104">insertk</span><span class="op" id="1882111">,</span>&nbsp;<span class="ident" id="1882113">key</span><span class="op" id="1882116">,</span>&nbsp;<span class="builtintype" id="1882118">uintptr</span><span class="op" id="1882125">(</span><span class="ident" id="1882126">t</span><span class="op" id="1882127">.</span><span class="ident" id="1882128">key</span><span class="op" id="1882131">.</span><span class="ident" id="1882132">size</span><span class="op" id="1882136">)</span><span class="op" id="1882137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882140">memmove</span><span class="op" id="1882147">(</span><span class="ident" id="1882148">insertv</span><span class="op" id="1882155">,</span>&nbsp;<span class="ident" id="1882157">val</span><span class="op" id="1882160">,</span>&nbsp;<span class="builtintype" id="1882162">uintptr</span><span class="op" id="1882169">(</span><span class="ident" id="1882170">t</span><span class="op" id="1882171">.</span><span class="ident" id="1882172">elem</span><span class="op" id="1882176">.</span><span class="ident" id="1882177">size</span><span class="op" id="1882181">)</span><span class="op" id="1882182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1882185">*</span><span class="ident" id="1882186">inserti</span>&nbsp;<span class="op" id="1882194">=</span>&nbsp;<span class="ident" id="1882196">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882201">h</span><span class="op" id="1882202">.</span><span class="ident" id="1882203">count</span><span class="op" id="1882208">++</span><br>
<span class="lineno">485</span><span class="op" id="1882211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1882214">func</span>&nbsp;<span class="ident" id="1882219">mapdelete</span><span class="op" id="1882228">(</span><span class="ident" id="1882229">t</span>&nbsp;<span class="op" id="1882231">*</span><span class="ident" id="1882232">maptype</span><span class="op" id="1882239">,</span>&nbsp;<span class="ident" id="1882241">h</span>&nbsp;<span class="op" id="1882243">*</span><span class="ident" id="1882244">hmap</span><span class="op" id="1882248">,</span>&nbsp;<span class="ident" id="1882250">key</span>&nbsp;<span class="ident" id="1882254">unsafe</span><span class="op" id="1882260">.</span><span class="ident" id="1882261">Pointer</span><span class="op" id="1882268">)</span>&nbsp;<span class="op" id="1882270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1882273">if</span>&nbsp;<span class="ident" id="1882276">raceenabled</span>&nbsp;<span class="op" id="1882288">&amp;&amp;</span>&nbsp;<span class="ident" id="1882291">h</span>&nbsp;<span class="op" id="1882293">!=</span>&nbsp;<span class="ident" id="1882296">nil</span>&nbsp;<span class="op" id="1882300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882304">callerpc</span>&nbsp;<span class="op" id="1882313">:=</span>&nbsp;<span class="ident" id="1882316">getcallerpc</span><span class="op" id="1882327">(</span><span class="ident" id="1882328">unsafe</span><span class="op" id="1882334">.</span><span class="ident" id="1882335">Pointer</span><span class="op" id="1882342">(</span><span class="op" id="1882343">&amp;</span><span class="ident" id="1882344">t</span><span class="op" id="1882345">)</span><span class="op" id="1882346">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882350">pc</span>&nbsp;<span class="op" id="1882353">:=</span>&nbsp;<span class="ident" id="1882356">funcPC</span><span class="op" id="1882362">(</span><span class="ident" id="1882363">mapdelete</span><span class="op" id="1882372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882376">racewritepc</span><span class="op" id="1882387">(</span><span class="ident" id="1882388">unsafe</span><span class="op" id="1882394">.</span><span class="ident" id="1882395">Pointer</span><span class="op" id="1882402">(</span><span class="ident" id="1882403">h</span><span class="op" id="1882404">)</span><span class="op" id="1882405">,</span>&nbsp;<span class="ident" id="1882407">callerpc</span><span class="op" id="1882415">,</span>&nbsp;<span class="ident" id="1882417">pc</span><span class="op" id="1882419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882423">raceReadObjectPC</span><span class="op" id="1882439">(</span><span class="ident" id="1882440">t</span><span class="op" id="1882441">.</span><span class="ident" id="1882442">key</span><span class="op" id="1882445">,</span>&nbsp;<span class="ident" id="1882447">key</span><span class="op" id="1882450">,</span>&nbsp;<span class="ident" id="1882452">callerpc</span><span class="op" id="1882460">,</span>&nbsp;<span class="ident" id="1882462">pc</span><span class="op" id="1882464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1882467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1882470">if</span>&nbsp;<span class="ident" id="1882473">h</span>&nbsp;<span class="op" id="1882475">==</span>&nbsp;<span class="ident" id="1882478">nil</span>&nbsp;<span class="op" id="1882482">||</span>&nbsp;<span class="ident" id="1882485">h</span><span class="op" id="1882486">.</span><span class="ident" id="1882487">count</span>&nbsp;<span class="op" id="1882493">==</span>&nbsp;<span class="num" id="1882496">0</span>&nbsp;<span class="op" id="1882498">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1882502">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1882510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882513">alg</span>&nbsp;<span class="op" id="1882517">:=</span>&nbsp;<span class="ident" id="1882520">goalg</span><span class="op" id="1882525">(</span><span class="ident" id="1882526">t</span><span class="op" id="1882527">.</span><span class="ident" id="1882528">key</span><span class="op" id="1882531">.</span><span class="ident" id="1882532">alg</span><span class="op" id="1882535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882538">hash</span>&nbsp;<span class="op" id="1882543">:=</span>&nbsp;<span class="ident" id="1882546">alg</span><span class="op" id="1882549">.</span><span class="ident" id="1882550">hash</span><span class="op" id="1882554">(</span><span class="ident" id="1882555">key</span><span class="op" id="1882558">,</span>&nbsp;<span class="builtintype" id="1882560">uintptr</span><span class="op" id="1882567">(</span><span class="ident" id="1882568">t</span><span class="op" id="1882569">.</span><span class="ident" id="1882570">key</span><span class="op" id="1882573">.</span><span class="ident" id="1882574">size</span><span class="op" id="1882578">)</span><span class="op" id="1882579">,</span>&nbsp;<span class="builtintype" id="1882581">uintptr</span><span class="op" id="1882588">(</span><span class="ident" id="1882589">h</span><span class="op" id="1882590">.</span><span class="ident" id="1882591">hash0</span><span class="op" id="1882596">)</span><span class="op" id="1882597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882600">bucket</span>&nbsp;<span class="op" id="1882607">:=</span>&nbsp;<span class="ident" id="1882610">hash</span>&nbsp;<span class="op" id="1882615">&amp;</span>&nbsp;<span class="op" id="1882617">(</span><span class="builtintype" id="1882618">uintptr</span><span class="op" id="1882625">(</span><span class="num" id="1882626">1</span><span class="op" id="1882627">)</span><span class="op" id="1882628">&lt;&lt;</span><span class="ident" id="1882630">h</span><span class="op" id="1882631">.</span><span class="ident" id="1882632">B</span>&nbsp;<span class="op" id="1882634">-</span>&nbsp;<span class="num" id="1882636">1</span><span class="op" id="1882637">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1882640">if</span>&nbsp;<span class="ident" id="1882643">h</span><span class="op" id="1882644">.</span><span class="ident" id="1882645">oldbuckets</span>&nbsp;<span class="op" id="1882656">!=</span>&nbsp;<span class="ident" id="1882659">nil</span>&nbsp;<span class="op" id="1882663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882667">growWork</span><span class="op" id="1882675">(</span><span class="ident" id="1882676">t</span><span class="op" id="1882677">,</span>&nbsp;<span class="ident" id="1882679">h</span><span class="op" id="1882680">,</span>&nbsp;<span class="ident" id="1882682">bucket</span><span class="op" id="1882688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1882691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882694">b</span>&nbsp;<span class="op" id="1882696">:=</span>&nbsp;<span class="op" id="1882699">(</span><span class="op" id="1882700">*</span><span class="ident" id="1882701">bmap</span><span class="op" id="1882705">)</span><span class="op" id="1882706">(</span><span class="ident" id="1882707">unsafe</span><span class="op" id="1882713">.</span><span class="ident" id="1882714">Pointer</span><span class="op" id="1882721">(</span><span class="builtintype" id="1882722">uintptr</span><span class="op" id="1882729">(</span><span class="ident" id="1882730">h</span><span class="op" id="1882731">.</span><span class="ident" id="1882732">buckets</span><span class="op" id="1882739">)</span>&nbsp;<span class="op" id="1882741">+</span>&nbsp;<span class="ident" id="1882743">bucket</span><span class="op" id="1882749">*</span><span class="builtintype" id="1882750">uintptr</span><span class="op" id="1882757">(</span><span class="ident" id="1882758">t</span><span class="op" id="1882759">.</span><span class="ident" id="1882760">bucketsize</span><span class="op" id="1882770">)</span><span class="op" id="1882771">)</span><span class="op" id="1882772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882775">top</span>&nbsp;<span class="op" id="1882779">:=</span>&nbsp;<span class="builtintype" id="1882782">uint8</span><span class="op" id="1882787">(</span><span class="ident" id="1882788">hash</span>&nbsp;<span class="op" id="1882793">&gt;&gt;</span>&nbsp;<span class="op" id="1882796">(</span><span class="ident" id="1882797">ptrSize</span><span class="op" id="1882804">*</span><span class="num" id="1882805">8</span>&nbsp;<span class="op" id="1882807">-</span>&nbsp;<span class="num" id="1882809">8</span><span class="op" id="1882810">)</span><span class="op" id="1882811">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1882814">if</span>&nbsp;<span class="ident" id="1882817">top</span>&nbsp;<span class="op" id="1882821">&lt;</span>&nbsp;<span class="ident" id="1882823">minTopHash</span>&nbsp;<span class="op" id="1882834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882838">top</span>&nbsp;<span class="op" id="1882842">+=</span>&nbsp;<span class="ident" id="1882845">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1882857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1882860">for</span>&nbsp;<span class="op" id="1882864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1882868">for</span>&nbsp;<span class="ident" id="1882872">i</span>&nbsp;<span class="op" id="1882874">:=</span>&nbsp;<span class="builtintype" id="1882877">uintptr</span><span class="op" id="1882884">(</span><span class="num" id="1882885">0</span><span class="op" id="1882886">)</span><span class="op" id="1882887">;</span>&nbsp;<span class="ident" id="1882889">i</span>&nbsp;<span class="op" id="1882891">&lt;</span>&nbsp;<span class="ident" id="1882893">bucketCnt</span><span class="op" id="1882902">;</span>&nbsp;<span class="ident" id="1882904">i</span><span class="op" id="1882905">++</span>&nbsp;<span class="op" id="1882908">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1882913">if</span>&nbsp;<span class="ident" id="1882916">b</span><span class="op" id="1882917">.</span><span class="ident" id="1882918">tophash</span><span class="op" id="1882925">[</span><span class="ident" id="1882926">i</span><span class="op" id="1882927">]</span>&nbsp;<span class="op" id="1882929">!=</span>&nbsp;<span class="ident" id="1882932">top</span>&nbsp;<span class="op" id="1882936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1882942">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1882954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1882959">k</span>&nbsp;<span class="op" id="1882961">:=</span>&nbsp;<span class="ident" id="1882964">add</span><span class="op" id="1882967">(</span><span class="ident" id="1882968">unsafe</span><span class="op" id="1882974">.</span><span class="ident" id="1882975">Pointer</span><span class="op" id="1882982">(</span><span class="ident" id="1882983">b</span><span class="op" id="1882984">)</span><span class="op" id="1882985">,</span>&nbsp;<span class="ident" id="1882987">dataOffset</span><span class="op" id="1882997">+</span><span class="ident" id="1882998">i</span><span class="op" id="1882999">*</span><span class="builtintype" id="1883000">uintptr</span><span class="op" id="1883007">(</span><span class="ident" id="1883008">t</span><span class="op" id="1883009">.</span><span class="ident" id="1883010">keysize</span><span class="op" id="1883017">)</span><span class="op" id="1883018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883023">k2</span>&nbsp;<span class="op" id="1883026">:=</span>&nbsp;<span class="ident" id="1883029">k</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1883034">if</span>&nbsp;<span class="ident" id="1883037">t</span><span class="op" id="1883038">.</span><span class="ident" id="1883039">indirectkey</span>&nbsp;<span class="op" id="1883051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883057">k2</span>&nbsp;<span class="op" id="1883060">=</span>&nbsp;<span class="op" id="1883062">*</span><span class="op" id="1883063">(</span><span class="op" id="1883064">(</span><span class="op" id="1883065">*</span><span class="ident" id="1883066">unsafe</span><span class="op" id="1883072">.</span><span class="ident" id="1883073">Pointer</span><span class="op" id="1883080">)</span><span class="op" id="1883081">(</span><span class="ident" id="1883082">k2</span><span class="op" id="1883084">)</span><span class="op" id="1883085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1883090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1883095">if</span>&nbsp;<span class="op" id="1883098">!</span><span class="ident" id="1883099">alg</span><span class="op" id="1883102">.</span><span class="ident" id="1883103">equal</span><span class="op" id="1883108">(</span><span class="ident" id="1883109">key</span><span class="op" id="1883112">,</span>&nbsp;<span class="ident" id="1883114">k2</span><span class="op" id="1883116">,</span>&nbsp;<span class="builtintype" id="1883118">uintptr</span><span class="op" id="1883125">(</span><span class="ident" id="1883126">t</span><span class="op" id="1883127">.</span><span class="ident" id="1883128">key</span><span class="op" id="1883131">.</span><span class="ident" id="1883132">size</span><span class="op" id="1883136">)</span><span class="op" id="1883137">)</span>&nbsp;<span class="op" id="1883139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1883145">continue</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1883157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883162">memclr</span><span class="op" id="1883168">(</span><span class="ident" id="1883169">k</span><span class="op" id="1883170">,</span>&nbsp;<span class="builtintype" id="1883172">uintptr</span><span class="op" id="1883179">(</span><span class="ident" id="1883180">t</span><span class="op" id="1883181">.</span><span class="ident" id="1883182">keysize</span><span class="op" id="1883189">)</span><span class="op" id="1883190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883195">v</span>&nbsp;<span class="op" id="1883197">:=</span>&nbsp;<span class="ident" id="1883200">unsafe</span><span class="op" id="1883206">.</span><span class="ident" id="1883207">Pointer</span><span class="op" id="1883214">(</span><span class="builtintype" id="1883215">uintptr</span><span class="op" id="1883222">(</span><span class="ident" id="1883223">unsafe</span><span class="op" id="1883229">.</span><span class="ident" id="1883230">Pointer</span><span class="op" id="1883237">(</span><span class="ident" id="1883238">b</span><span class="op" id="1883239">)</span><span class="op" id="1883240">)</span>&nbsp;<span class="op" id="1883242">+</span>&nbsp;<span class="ident" id="1883244">dataOffset</span>&nbsp;<span class="op" id="1883255">+</span>&nbsp;<span class="ident" id="1883257">bucketCnt</span><span class="op" id="1883266">*</span><span class="builtintype" id="1883267">uintptr</span><span class="op" id="1883274">(</span><span class="ident" id="1883275">t</span><span class="op" id="1883276">.</span><span class="ident" id="1883277">keysize</span><span class="op" id="1883284">)</span>&nbsp;<span class="op" id="1883286">+</span>&nbsp;<span class="ident" id="1883288">i</span><span class="op" id="1883289">*</span><span class="builtintype" id="1883290">uintptr</span><span class="op" id="1883297">(</span><span class="ident" id="1883298">t</span><span class="op" id="1883299">.</span><span class="ident" id="1883300">valuesize</span><span class="op" id="1883309">)</span><span class="op" id="1883310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883315">memclr</span><span class="op" id="1883321">(</span><span class="ident" id="1883322">v</span><span class="op" id="1883323">,</span>&nbsp;<span class="builtintype" id="1883325">uintptr</span><span class="op" id="1883332">(</span><span class="ident" id="1883333">t</span><span class="op" id="1883334">.</span><span class="ident" id="1883335">valuesize</span><span class="op" id="1883344">)</span><span class="op" id="1883345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883350">b</span><span class="op" id="1883351">.</span><span class="ident" id="1883352">tophash</span><span class="op" id="1883359">[</span><span class="ident" id="1883360">i</span><span class="op" id="1883361">]</span>&nbsp;<span class="op" id="1883363">=</span>&nbsp;<span class="ident" id="1883365">empty</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883374">h</span><span class="op" id="1883375">.</span><span class="ident" id="1883376">count</span><span class="op" id="1883381">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1883387">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1883396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883400">b</span>&nbsp;<span class="op" id="1883402">=</span>&nbsp;<span class="ident" id="1883404">b</span><span class="op" id="1883405">.</span><span class="ident" id="1883406">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1883417">if</span>&nbsp;<span class="ident" id="1883420">b</span>&nbsp;<span class="op" id="1883422">==</span>&nbsp;<span class="ident" id="1883425">nil</span>&nbsp;<span class="op" id="1883429">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1883434">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1883443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1883446">}</span><br>
<span class="lineno"></span><span class="op" id="1883448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="1883451">func</span>&nbsp;<span class="ident" id="1883456">mapiterinit</span><span class="op" id="1883467">(</span><span class="ident" id="1883468">t</span>&nbsp;<span class="op" id="1883470">*</span><span class="ident" id="1883471">maptype</span><span class="op" id="1883478">,</span>&nbsp;<span class="ident" id="1883480">h</span>&nbsp;<span class="op" id="1883482">*</span><span class="ident" id="1883483">hmap</span><span class="op" id="1883487">,</span>&nbsp;<span class="ident" id="1883489">it</span>&nbsp;<span class="op" id="1883492">*</span><span class="ident" id="1883493">hiter</span><span class="op" id="1883498">)</span>&nbsp;<span class="op" id="1883500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1883503">//&nbsp;Clear&nbsp;pointer&nbsp;fields&nbsp;so&nbsp;garbage&nbsp;collector&nbsp;does&nbsp;not&nbsp;complain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883568">it</span><span class="op" id="1883570">.</span><span class="ident" id="1883571">key</span>&nbsp;<span class="op" id="1883575">=</span>&nbsp;<span class="ident" id="1883577">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883582">it</span><span class="op" id="1883584">.</span><span class="ident" id="1883585">value</span>&nbsp;<span class="op" id="1883591">=</span>&nbsp;<span class="ident" id="1883593">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883598">it</span><span class="op" id="1883600">.</span><span class="ident" id="1883601">t</span>&nbsp;<span class="op" id="1883603">=</span>&nbsp;<span class="ident" id="1883605">nil</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883610">it</span><span class="op" id="1883612">.</span><span class="ident" id="1883613">h</span>&nbsp;<span class="op" id="1883615">=</span>&nbsp;<span class="ident" id="1883617">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883622">it</span><span class="op" id="1883624">.</span><span class="ident" id="1883625">buckets</span>&nbsp;<span class="op" id="1883633">=</span>&nbsp;<span class="ident" id="1883635">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883640">it</span><span class="op" id="1883642">.</span><span class="ident" id="1883643">bptr</span>&nbsp;<span class="op" id="1883648">=</span>&nbsp;<span class="ident" id="1883650">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1883656">if</span>&nbsp;<span class="ident" id="1883659">raceenabled</span>&nbsp;<span class="op" id="1883671">&amp;&amp;</span>&nbsp;<span class="ident" id="1883674">h</span>&nbsp;<span class="op" id="1883676">!=</span>&nbsp;<span class="ident" id="1883679">nil</span>&nbsp;<span class="op" id="1883683">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883687">callerpc</span>&nbsp;<span class="op" id="1883696">:=</span>&nbsp;<span class="ident" id="1883699">getcallerpc</span><span class="op" id="1883710">(</span><span class="ident" id="1883711">unsafe</span><span class="op" id="1883717">.</span><span class="ident" id="1883718">Pointer</span><span class="op" id="1883725">(</span><span class="op" id="1883726">&amp;</span><span class="ident" id="1883727">t</span><span class="op" id="1883728">)</span><span class="op" id="1883729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883733">racereadpc</span><span class="op" id="1883743">(</span><span class="ident" id="1883744">unsafe</span><span class="op" id="1883750">.</span><span class="ident" id="1883751">Pointer</span><span class="op" id="1883758">(</span><span class="ident" id="1883759">h</span><span class="op" id="1883760">)</span><span class="op" id="1883761">,</span>&nbsp;<span class="ident" id="1883763">callerpc</span><span class="op" id="1883771">,</span>&nbsp;<span class="ident" id="1883773">funcPC</span><span class="op" id="1883779">(</span><span class="ident" id="1883780">mapiterinit</span><span class="op" id="1883791">)</span><span class="op" id="1883792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1883795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1883799">if</span>&nbsp;<span class="ident" id="1883802">h</span>&nbsp;<span class="op" id="1883804">==</span>&nbsp;<span class="ident" id="1883807">nil</span>&nbsp;<span class="op" id="1883811">||</span>&nbsp;<span class="ident" id="1883814">h</span><span class="op" id="1883815">.</span><span class="ident" id="1883816">count</span>&nbsp;<span class="op" id="1883822">==</span>&nbsp;<span class="num" id="1883825">0</span>&nbsp;<span class="op" id="1883827">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883831">it</span><span class="op" id="1883833">.</span><span class="ident" id="1883834">key</span>&nbsp;<span class="op" id="1883838">=</span>&nbsp;<span class="ident" id="1883840">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883846">it</span><span class="op" id="1883848">.</span><span class="ident" id="1883849">value</span>&nbsp;<span class="op" id="1883855">=</span>&nbsp;<span class="ident" id="1883857">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1883863">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1883871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1883875">if</span>&nbsp;<span class="ident" id="1883878">unsafe</span><span class="op" id="1883884">.</span><span class="ident" id="1883885">Sizeof</span><span class="op" id="1883891">(</span><span class="ident" id="1883892">hiter</span><span class="op" id="1883897">{</span><span class="op" id="1883898">}</span><span class="op" id="1883899">)</span><span class="op" id="1883900">/</span><span class="ident" id="1883901">ptrSize</span>&nbsp;<span class="op" id="1883909">!=</span>&nbsp;<span class="num" id="1883912">10</span>&nbsp;<span class="op" id="1883915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883919">gothrow</span><span class="op" id="1883926">(</span><span class="string" id="1883927">&#34;hash_iter&nbsp;size&nbsp;incorrect&#34;</span><span class="op" id="1883953">)</span>&nbsp;<span class="comment" id="1883955">//&nbsp;see&nbsp;../../cmd/gc/reflect.c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1883986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883989">it</span><span class="op" id="1883991">.</span><span class="ident" id="1883992">t</span>&nbsp;<span class="op" id="1883994">=</span>&nbsp;<span class="ident" id="1883996">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1883999">it</span><span class="op" id="1884001">.</span><span class="ident" id="1884002">h</span>&nbsp;<span class="op" id="1884004">=</span>&nbsp;<span class="ident" id="1884006">h</span><br>
<span class="lineno">560</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1884010">//&nbsp;grab&nbsp;snapshot&nbsp;of&nbsp;bucket&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884044">it</span><span class="op" id="1884046">.</span><span class="ident" id="1884047">B</span>&nbsp;<span class="op" id="1884049">=</span>&nbsp;<span class="ident" id="1884051">h</span><span class="op" id="1884052">.</span><span class="ident" id="1884053">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884056">it</span><span class="op" id="1884058">.</span><span class="ident" id="1884059">buckets</span>&nbsp;<span class="op" id="1884067">=</span>&nbsp;<span class="ident" id="1884069">h</span><span class="op" id="1884070">.</span><span class="ident" id="1884071">buckets</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1884081">//&nbsp;decide&nbsp;where&nbsp;to&nbsp;start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884107">r</span>&nbsp;<span class="op" id="1884109">:=</span>&nbsp;<span class="builtintype" id="1884112">uintptr</span><span class="op" id="1884119">(</span><span class="ident" id="1884120">fastrand1</span><span class="op" id="1884129">(</span><span class="op" id="1884130">)</span><span class="op" id="1884131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1884134">if</span>&nbsp;<span class="ident" id="1884137">h</span><span class="op" id="1884138">.</span><span class="ident" id="1884139">B</span>&nbsp;<span class="op" id="1884141">&gt;</span>&nbsp;<span class="num" id="1884143">31</span><span class="op" id="1884145">-</span><span class="ident" id="1884146">bucketCntBits</span>&nbsp;<span class="op" id="1884160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884164">r</span>&nbsp;<span class="op" id="1884166">+=</span>&nbsp;<span class="builtintype" id="1884169">uintptr</span><span class="op" id="1884176">(</span><span class="ident" id="1884177">fastrand1</span><span class="op" id="1884186">(</span><span class="op" id="1884187">)</span><span class="op" id="1884188">)</span>&nbsp;<span class="op" id="1884190">&lt;&lt;</span>&nbsp;<span class="num" id="1884193">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1884197">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884200">it</span><span class="op" id="1884202">.</span><span class="ident" id="1884203">startBucket</span>&nbsp;<span class="op" id="1884215">=</span>&nbsp;<span class="ident" id="1884217">r</span>&nbsp;<span class="op" id="1884219">&amp;</span>&nbsp;<span class="op" id="1884221">(</span><span class="builtintype" id="1884222">uintptr</span><span class="op" id="1884229">(</span><span class="num" id="1884230">1</span><span class="op" id="1884231">)</span><span class="op" id="1884232">&lt;&lt;</span><span class="ident" id="1884234">h</span><span class="op" id="1884235">.</span><span class="ident" id="1884236">B</span>&nbsp;<span class="op" id="1884238">-</span>&nbsp;<span class="num" id="1884240">1</span><span class="op" id="1884241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884244">it</span><span class="op" id="1884246">.</span><span class="ident" id="1884247">offset</span>&nbsp;<span class="op" id="1884254">=</span>&nbsp;<span class="builtintype" id="1884256">uint8</span><span class="op" id="1884261">(</span><span class="ident" id="1884262">r</span>&nbsp;<span class="op" id="1884264">&gt;&gt;</span>&nbsp;<span class="ident" id="1884267">h</span><span class="op" id="1884268">.</span><span class="ident" id="1884269">B</span>&nbsp;<span class="op" id="1884271">&amp;</span>&nbsp;<span class="op" id="1884273">(</span><span class="ident" id="1884274">bucketCnt</span>&nbsp;<span class="op" id="1884284">-</span>&nbsp;<span class="num" id="1884286">1</span><span class="op" id="1884287">)</span><span class="op" id="1884288">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1884292">//&nbsp;iterator&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884311">it</span><span class="op" id="1884313">.</span><span class="ident" id="1884314">bucket</span>&nbsp;<span class="op" id="1884321">=</span>&nbsp;<span class="ident" id="1884323">it</span><span class="op" id="1884325">.</span><span class="ident" id="1884326">startBucket</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884339">it</span><span class="op" id="1884341">.</span><span class="ident" id="1884342">wrapped</span>&nbsp;<span class="op" id="1884350">=</span>&nbsp;<span class="builtintype" id="1884352">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884359">it</span><span class="op" id="1884361">.</span><span class="ident" id="1884362">bptr</span>&nbsp;<span class="op" id="1884367">=</span>&nbsp;<span class="ident" id="1884369">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1884375">//&nbsp;Remember&nbsp;we&nbsp;have&nbsp;an&nbsp;iterator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1884409">//&nbsp;Can&nbsp;run&nbsp;concurrently&nbsp;with&nbsp;another&nbsp;hash_iter_init().</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1884465">for</span>&nbsp;<span class="op" id="1884469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884473">old</span>&nbsp;<span class="op" id="1884477">:=</span>&nbsp;<span class="ident" id="1884480">h</span><span class="op" id="1884481">.</span><span class="ident" id="1884482">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1884490">if</span>&nbsp;<span class="ident" id="1884493">old</span>&nbsp;<span class="op" id="1884497">==</span>&nbsp;<span class="ident" id="1884500">old</span><span class="op" id="1884503">|</span><span class="ident" id="1884504">iterator</span><span class="op" id="1884512">|</span><span class="ident" id="1884513">oldIterator</span>&nbsp;<span class="op" id="1884525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1884530">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1884538">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1884542">if</span>&nbsp;<span class="ident" id="1884545">cas</span><span class="op" id="1884548">(</span><span class="op" id="1884549">&amp;</span><span class="ident" id="1884550">h</span><span class="op" id="1884551">.</span><span class="ident" id="1884552">flags</span><span class="op" id="1884557">,</span>&nbsp;<span class="ident" id="1884559">old</span><span class="op" id="1884562">,</span>&nbsp;<span class="ident" id="1884564">old</span><span class="op" id="1884567">|</span><span class="ident" id="1884568">iterator</span><span class="op" id="1884576">|</span><span class="ident" id="1884577">oldIterator</span><span class="op" id="1884588">)</span>&nbsp;<span class="op" id="1884590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1884595">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1884603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1884606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884610">mapiternext</span><span class="op" id="1884621">(</span><span class="ident" id="1884622">it</span><span class="op" id="1884624">)</span><br>
<span class="lineno"></span><span class="op" id="1884626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1884629">func</span>&nbsp;<span class="ident" id="1884634">mapiternext</span><span class="op" id="1884645">(</span><span class="ident" id="1884646">it</span>&nbsp;<span class="op" id="1884649">*</span><span class="ident" id="1884650">hiter</span><span class="op" id="1884655">)</span>&nbsp;<span class="op" id="1884657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884660">h</span>&nbsp;<span class="op" id="1884662">:=</span>&nbsp;<span class="ident" id="1884665">it</span><span class="op" id="1884667">.</span><span class="ident" id="1884668">h</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1884671">if</span>&nbsp;<span class="ident" id="1884674">raceenabled</span>&nbsp;<span class="op" id="1884686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884690">callerpc</span>&nbsp;<span class="op" id="1884699">:=</span>&nbsp;<span class="ident" id="1884702">getcallerpc</span><span class="op" id="1884713">(</span><span class="ident" id="1884714">unsafe</span><span class="op" id="1884720">.</span><span class="ident" id="1884721">Pointer</span><span class="op" id="1884728">(</span><span class="op" id="1884729">&amp;</span><span class="ident" id="1884730">it</span><span class="op" id="1884732">)</span><span class="op" id="1884733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884737">racereadpc</span><span class="op" id="1884747">(</span><span class="ident" id="1884748">unsafe</span><span class="op" id="1884754">.</span><span class="ident" id="1884755">Pointer</span><span class="op" id="1884762">(</span><span class="ident" id="1884763">h</span><span class="op" id="1884764">)</span><span class="op" id="1884765">,</span>&nbsp;<span class="ident" id="1884767">callerpc</span><span class="op" id="1884775">,</span>&nbsp;<span class="ident" id="1884777">funcPC</span><span class="op" id="1884783">(</span><span class="ident" id="1884784">mapiternext</span><span class="op" id="1884795">)</span><span class="op" id="1884796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1884799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884802">t</span>&nbsp;<span class="op" id="1884804">:=</span>&nbsp;<span class="ident" id="1884807">it</span><span class="op" id="1884809">.</span><span class="ident" id="1884810">t</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884813">bucket</span>&nbsp;<span class="op" id="1884820">:=</span>&nbsp;<span class="ident" id="1884823">it</span><span class="op" id="1884825">.</span><span class="ident" id="1884826">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884834">b</span>&nbsp;<span class="op" id="1884836">:=</span>&nbsp;<span class="ident" id="1884839">it</span><span class="op" id="1884841">.</span><span class="ident" id="1884842">bptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884848">i</span>&nbsp;<span class="op" id="1884850">:=</span>&nbsp;<span class="ident" id="1884853">it</span><span class="op" id="1884855">.</span><span class="ident" id="1884856">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884859">checkBucket</span>&nbsp;<span class="op" id="1884871">:=</span>&nbsp;<span class="ident" id="1884874">it</span><span class="op" id="1884876">.</span><span class="ident" id="1884877">checkBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1884890">alg</span>&nbsp;<span class="op" id="1884894">:=</span>&nbsp;<span class="ident" id="1884897">goalg</span><span class="op" id="1884902">(</span><span class="ident" id="1884903">t</span><span class="op" id="1884904">.</span><span class="ident" id="1884905">key</span><span class="op" id="1884908">.</span><span class="ident" id="1884909">alg</span><span class="op" id="1884912">)</span><br>
<span class="lineno">605</span><br>
<span class="lineno"></span><span class="ident" id="1884915">next</span><span class="op" id="1884919">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1884922">if</span>&nbsp;<span class="ident" id="1884925">b</span>&nbsp;<span class="op" id="1884927">==</span>&nbsp;<span class="ident" id="1884930">nil</span>&nbsp;<span class="op" id="1884934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1884938">if</span>&nbsp;<span class="ident" id="1884941">bucket</span>&nbsp;<span class="op" id="1884948">==</span>&nbsp;<span class="ident" id="1884951">it</span><span class="op" id="1884953">.</span><span class="ident" id="1884954">startBucket</span>&nbsp;<span class="op" id="1884966">&amp;&amp;</span>&nbsp;<span class="ident" id="1884969">it</span><span class="op" id="1884971">.</span><span class="ident" id="1884972">wrapped</span>&nbsp;<span class="op" id="1884980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1884985">//&nbsp;end&nbsp;of&nbsp;iteration</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1885008">it</span><span class="op" id="1885010">.</span><span class="ident" id="1885011">key</span>&nbsp;<span class="op" id="1885015">=</span>&nbsp;<span class="ident" id="1885017">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1885024">it</span><span class="op" id="1885026">.</span><span class="ident" id="1885027">value</span>&nbsp;<span class="op" id="1885033">=</span>&nbsp;<span class="ident" id="1885035">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1885042">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1885051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1885055">if</span>&nbsp;<span class="ident" id="1885058">h</span><span class="op" id="1885059">.</span><span class="ident" id="1885060">oldbuckets</span>&nbsp;<span class="op" id="1885071">!=</span>&nbsp;<span class="ident" id="1885074">nil</span>&nbsp;<span class="op" id="1885078">&amp;&amp;</span>&nbsp;<span class="ident" id="1885081">it</span><span class="op" id="1885083">.</span><span class="ident" id="1885084">B</span>&nbsp;<span class="op" id="1885086">==</span>&nbsp;<span class="ident" id="1885089">h</span><span class="op" id="1885090">.</span><span class="ident" id="1885091">B</span>&nbsp;<span class="op" id="1885093">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1885098">//&nbsp;Iterator&nbsp;was&nbsp;started&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;grow,&nbsp;and&nbsp;the&nbsp;grow&nbsp;isn&#39;t&nbsp;done&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1885179">//&nbsp;If&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;looking&nbsp;at&nbsp;hasn&#39;t&nbsp;been&nbsp;filled&nbsp;in&nbsp;yet&nbsp;(i.e.&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1885256">//&nbsp;bucket&nbsp;hasn&#39;t&nbsp;been&nbsp;evacuated)&nbsp;then&nbsp;we&nbsp;need&nbsp;to&nbsp;iterate&nbsp;through&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1885332">//&nbsp;bucket&nbsp;and&nbsp;only&nbsp;return&nbsp;the&nbsp;ones&nbsp;that&nbsp;will&nbsp;be&nbsp;migrated&nbsp;to&nbsp;this&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1885408">oldbucket</span>&nbsp;<span class="op" id="1885418">:=</span>&nbsp;<span class="ident" id="1885421">bucket</span>&nbsp;<span class="op" id="1885428">&amp;</span>&nbsp;<span class="op" id="1885430">(</span><span class="builtintype" id="1885431">uintptr</span><span class="op" id="1885438">(</span><span class="num" id="1885439">1</span><span class="op" id="1885440">)</span><span class="op" id="1885441">&lt;&lt;</span><span class="op" id="1885443">(</span><span class="ident" id="1885444">it</span><span class="op" id="1885446">.</span><span class="ident" id="1885447">B</span><span class="op" id="1885448">-</span><span class="num" id="1885449">1</span><span class="op" id="1885450">)</span>&nbsp;<span class="op" id="1885452">-</span>&nbsp;<span class="num" id="1885454">1</span><span class="op" id="1885455">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1885460">b</span>&nbsp;<span class="op" id="1885462">=</span>&nbsp;<span class="op" id="1885464">(</span><span class="op" id="1885465">*</span><span class="ident" id="1885466">bmap</span><span class="op" id="1885470">)</span><span class="op" id="1885471">(</span><span class="ident" id="1885472">add</span><span class="op" id="1885475">(</span><span class="ident" id="1885476">h</span><span class="op" id="1885477">.</span><span class="ident" id="1885478">oldbuckets</span><span class="op" id="1885488">,</span>&nbsp;<span class="ident" id="1885490">oldbucket</span><span class="op" id="1885499">*</span><span class="builtintype" id="1885500">uintptr</span><span class="op" id="1885507">(</span><span class="ident" id="1885508">t</span><span class="op" id="1885509">.</span><span class="ident" id="1885510">bucketsize</span><span class="op" id="1885520">)</span><span class="op" id="1885521">)</span><span class="op" id="1885522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1885527">if</span>&nbsp;<span class="op" id="1885530">!</span><span class="ident" id="1885531">evacuated</span><span class="op" id="1885540">(</span><span class="ident" id="1885541">b</span><span class="op" id="1885542">)</span>&nbsp;<span class="op" id="1885544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1885550">checkBucket</span>&nbsp;<span class="op" id="1885562">=</span>&nbsp;<span class="ident" id="1885564">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1885574">}</span>&nbsp;<span class="keyword" id="1885576">else</span>&nbsp;<span class="op" id="1885581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1885587">b</span>&nbsp;<span class="op" id="1885589">=</span>&nbsp;<span class="op" id="1885591">(</span><span class="op" id="1885592">*</span><span class="ident" id="1885593">bmap</span><span class="op" id="1885597">)</span><span class="op" id="1885598">(</span><span class="ident" id="1885599">add</span><span class="op" id="1885602">(</span><span class="ident" id="1885603">it</span><span class="op" id="1885605">.</span><span class="ident" id="1885606">buckets</span><span class="op" id="1885613">,</span>&nbsp;<span class="ident" id="1885615">bucket</span><span class="op" id="1885621">*</span><span class="builtintype" id="1885622">uintptr</span><span class="op" id="1885629">(</span><span class="ident" id="1885630">t</span><span class="op" id="1885631">.</span><span class="ident" id="1885632">bucketsize</span><span class="op" id="1885642">)</span><span class="op" id="1885643">)</span><span class="op" id="1885644">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1885650">checkBucket</span>&nbsp;<span class="op" id="1885662">=</span>&nbsp;<span class="ident" id="1885664">noCheck</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1885675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1885679">}</span>&nbsp;<span class="keyword" id="1885681">else</span>&nbsp;<span class="op" id="1885686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1885691">b</span>&nbsp;<span class="op" id="1885693">=</span>&nbsp;<span class="op" id="1885695">(</span><span class="op" id="1885696">*</span><span class="ident" id="1885697">bmap</span><span class="op" id="1885701">)</span><span class="op" id="1885702">(</span><span class="ident" id="1885703">add</span><span class="op" id="1885706">(</span><span class="ident" id="1885707">it</span><span class="op" id="1885709">.</span><span class="ident" id="1885710">buckets</span><span class="op" id="1885717">,</span>&nbsp;<span class="ident" id="1885719">bucket</span><span class="op" id="1885725">*</span><span class="builtintype" id="1885726">uintptr</span><span class="op" id="1885733">(</span><span class="ident" id="1885734">t</span><span class="op" id="1885735">.</span><span class="ident" id="1885736">bucketsize</span><span class="op" id="1885746">)</span><span class="op" id="1885747">)</span><span class="op" id="1885748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1885753">checkBucket</span>&nbsp;<span class="op" id="1885765">=</span>&nbsp;<span class="ident" id="1885767">noCheck</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1885777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1885781">bucket</span><span class="op" id="1885787">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1885792">if</span>&nbsp;<span class="ident" id="1885795">bucket</span>&nbsp;<span class="op" id="1885802">==</span>&nbsp;<span class="builtintype" id="1885805">uintptr</span><span class="op" id="1885812">(</span><span class="num" id="1885813">1</span><span class="op" id="1885814">)</span><span class="op" id="1885815">&lt;&lt;</span><span class="ident" id="1885817">it</span><span class="op" id="1885819">.</span><span class="ident" id="1885820">B</span>&nbsp;<span class="op" id="1885822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1885827">bucket</span>&nbsp;<span class="op" id="1885834">=</span>&nbsp;<span class="num" id="1885836">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1885841">it</span><span class="op" id="1885843">.</span><span class="ident" id="1885844">wrapped</span>&nbsp;<span class="op" id="1885852">=</span>&nbsp;<span class="builtintype" id="1885854">true</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1885861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1885865">i</span>&nbsp;<span class="op" id="1885867">=</span>&nbsp;<span class="num" id="1885869">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1885872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1885875">for</span>&nbsp;<span class="op" id="1885879">;</span>&nbsp;<span class="ident" id="1885881">i</span>&nbsp;<span class="op" id="1885883">&lt;</span>&nbsp;<span class="ident" id="1885885">bucketCnt</span><span class="op" id="1885894">;</span>&nbsp;<span class="ident" id="1885896">i</span><span class="op" id="1885897">++</span>&nbsp;<span class="op" id="1885900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1885904">offi</span>&nbsp;<span class="op" id="1885909">:=</span>&nbsp;<span class="op" id="1885912">(</span><span class="ident" id="1885913">i</span>&nbsp;<span class="op" id="1885915">+</span>&nbsp;<span class="ident" id="1885917">it</span><span class="op" id="1885919">.</span><span class="ident" id="1885920">offset</span><span class="op" id="1885926">)</span>&nbsp;<span class="op" id="1885928">&amp;</span>&nbsp;<span class="op" id="1885930">(</span><span class="ident" id="1885931">bucketCnt</span>&nbsp;<span class="op" id="1885941">-</span>&nbsp;<span class="num" id="1885943">1</span><span class="op" id="1885944">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1885948">k</span>&nbsp;<span class="op" id="1885950">:=</span>&nbsp;<span class="ident" id="1885953">add</span><span class="op" id="1885956">(</span><span class="ident" id="1885957">unsafe</span><span class="op" id="1885963">.</span><span class="ident" id="1885964">Pointer</span><span class="op" id="1885971">(</span><span class="ident" id="1885972">b</span><span class="op" id="1885973">)</span><span class="op" id="1885974">,</span>&nbsp;<span class="ident" id="1885976">dataOffset</span><span class="op" id="1885986">+</span><span class="builtintype" id="1885987">uintptr</span><span class="op" id="1885994">(</span><span class="ident" id="1885995">offi</span><span class="op" id="1885999">)</span><span class="op" id="1886000">*</span><span class="builtintype" id="1886001">uintptr</span><span class="op" id="1886008">(</span><span class="ident" id="1886009">t</span><span class="op" id="1886010">.</span><span class="ident" id="1886011">keysize</span><span class="op" id="1886018">)</span><span class="op" id="1886019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1886023">v</span>&nbsp;<span class="op" id="1886025">:=</span>&nbsp;<span class="ident" id="1886028">add</span><span class="op" id="1886031">(</span><span class="ident" id="1886032">unsafe</span><span class="op" id="1886038">.</span><span class="ident" id="1886039">Pointer</span><span class="op" id="1886046">(</span><span class="ident" id="1886047">b</span><span class="op" id="1886048">)</span><span class="op" id="1886049">,</span>&nbsp;<span class="ident" id="1886051">dataOffset</span><span class="op" id="1886061">+</span><span class="ident" id="1886062">bucketCnt</span><span class="op" id="1886071">*</span><span class="builtintype" id="1886072">uintptr</span><span class="op" id="1886079">(</span><span class="ident" id="1886080">t</span><span class="op" id="1886081">.</span><span class="ident" id="1886082">keysize</span><span class="op" id="1886089">)</span><span class="op" id="1886090">+</span><span class="builtintype" id="1886091">uintptr</span><span class="op" id="1886098">(</span><span class="ident" id="1886099">offi</span><span class="op" id="1886103">)</span><span class="op" id="1886104">*</span><span class="builtintype" id="1886105">uintptr</span><span class="op" id="1886112">(</span><span class="ident" id="1886113">t</span><span class="op" id="1886114">.</span><span class="ident" id="1886115">valuesize</span><span class="op" id="1886124">)</span><span class="op" id="1886125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1886129">if</span>&nbsp;<span class="ident" id="1886132">b</span><span class="op" id="1886133">.</span><span class="ident" id="1886134">tophash</span><span class="op" id="1886141">[</span><span class="ident" id="1886142">offi</span><span class="op" id="1886146">]</span>&nbsp;<span class="op" id="1886148">!=</span>&nbsp;<span class="ident" id="1886151">empty</span>&nbsp;<span class="op" id="1886157">&amp;&amp;</span>&nbsp;<span class="ident" id="1886160">b</span><span class="op" id="1886161">.</span><span class="ident" id="1886162">tophash</span><span class="op" id="1886169">[</span><span class="ident" id="1886170">offi</span><span class="op" id="1886174">]</span>&nbsp;<span class="op" id="1886176">!=</span>&nbsp;<span class="ident" id="1886179">evacuatedEmpty</span>&nbsp;<span class="op" id="1886194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1886199">if</span>&nbsp;<span class="ident" id="1886202">checkBucket</span>&nbsp;<span class="op" id="1886214">!=</span>&nbsp;<span class="ident" id="1886217">noCheck</span>&nbsp;<span class="op" id="1886225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1886231">//&nbsp;Special&nbsp;case:&nbsp;iterator&nbsp;was&nbsp;started&nbsp;during&nbsp;a&nbsp;grow&nbsp;and&nbsp;the</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1886295">//&nbsp;grow&nbsp;is&nbsp;not&nbsp;done&nbsp;yet.&nbsp;&nbsp;We&#39;re&nbsp;working&nbsp;on&nbsp;a&nbsp;bucket&nbsp;whose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1886357">//&nbsp;oldbucket&nbsp;has&nbsp;not&nbsp;been&nbsp;evacuated&nbsp;yet.&nbsp;&nbsp;Or&nbsp;at&nbsp;least,&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1886426">//&nbsp;evacuated&nbsp;when&nbsp;we&nbsp;started&nbsp;the&nbsp;bucket.&nbsp;&nbsp;So&nbsp;we&#39;re&nbsp;iterating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1886491">//&nbsp;through&nbsp;the&nbsp;oldbucket,&nbsp;skipping&nbsp;any&nbsp;keys&nbsp;that&nbsp;will&nbsp;go</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1886552">//&nbsp;to&nbsp;the&nbsp;other&nbsp;new&nbsp;bucket&nbsp;(each&nbsp;oldbucket&nbsp;expands&nbsp;to&nbsp;two</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1886614">//&nbsp;buckets&nbsp;during&nbsp;a&nbsp;grow).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1886645">k2</span>&nbsp;<span class="op" id="1886648">:=</span>&nbsp;<span class="ident" id="1886651">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1886657">if</span>&nbsp;<span class="ident" id="1886660">t</span><span class="op" id="1886661">.</span><span class="ident" id="1886662">indirectkey</span>&nbsp;<span class="op" id="1886674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1886681">k2</span>&nbsp;<span class="op" id="1886684">=</span>&nbsp;<span class="op" id="1886686">*</span><span class="op" id="1886687">(</span><span class="op" id="1886688">(</span><span class="op" id="1886689">*</span><span class="ident" id="1886690">unsafe</span><span class="op" id="1886696">.</span><span class="ident" id="1886697">Pointer</span><span class="op" id="1886704">)</span><span class="op" id="1886705">(</span><span class="ident" id="1886706">k2</span><span class="op" id="1886708">)</span><span class="op" id="1886709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1886715">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1886721">if</span>&nbsp;<span class="ident" id="1886724">alg</span><span class="op" id="1886727">.</span><span class="ident" id="1886728">equal</span><span class="op" id="1886733">(</span><span class="ident" id="1886734">k2</span><span class="op" id="1886736">,</span>&nbsp;<span class="ident" id="1886738">k2</span><span class="op" id="1886740">,</span>&nbsp;<span class="builtintype" id="1886742">uintptr</span><span class="op" id="1886749">(</span><span class="ident" id="1886750">t</span><span class="op" id="1886751">.</span><span class="ident" id="1886752">key</span><span class="op" id="1886755">.</span><span class="ident" id="1886756">size</span><span class="op" id="1886760">)</span><span class="op" id="1886761">)</span>&nbsp;<span class="op" id="1886763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1886770">//&nbsp;If&nbsp;the&nbsp;item&nbsp;in&nbsp;the&nbsp;oldbucket&nbsp;is&nbsp;not&nbsp;destined&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1886827">//&nbsp;the&nbsp;current&nbsp;new&nbsp;bucket&nbsp;in&nbsp;the&nbsp;iteration,&nbsp;skip&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1886885">hash</span>&nbsp;<span class="op" id="1886890">:=</span>&nbsp;<span class="ident" id="1886893">alg</span><span class="op" id="1886896">.</span><span class="ident" id="1886897">hash</span><span class="op" id="1886901">(</span><span class="ident" id="1886902">k2</span><span class="op" id="1886904">,</span>&nbsp;<span class="builtintype" id="1886906">uintptr</span><span class="op" id="1886913">(</span><span class="ident" id="1886914">t</span><span class="op" id="1886915">.</span><span class="ident" id="1886916">key</span><span class="op" id="1886919">.</span><span class="ident" id="1886920">size</span><span class="op" id="1886924">)</span><span class="op" id="1886925">,</span>&nbsp;<span class="builtintype" id="1886927">uintptr</span><span class="op" id="1886934">(</span><span class="ident" id="1886935">h</span><span class="op" id="1886936">.</span><span class="ident" id="1886937">hash0</span><span class="op" id="1886942">)</span><span class="op" id="1886943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1886950">if</span>&nbsp;<span class="ident" id="1886953">hash</span><span class="op" id="1886957">&amp;</span><span class="op" id="1886958">(</span><span class="builtintype" id="1886959">uintptr</span><span class="op" id="1886966">(</span><span class="num" id="1886967">1</span><span class="op" id="1886968">)</span><span class="op" id="1886969">&lt;&lt;</span><span class="ident" id="1886971">it</span><span class="op" id="1886973">.</span><span class="ident" id="1886974">B</span><span class="op" id="1886975">-</span><span class="num" id="1886976">1</span><span class="op" id="1886977">)</span>&nbsp;<span class="op" id="1886979">!=</span>&nbsp;<span class="ident" id="1886982">checkBucket</span>&nbsp;<span class="op" id="1886994">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1887002">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1887016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1887022">}</span>&nbsp;<span class="keyword" id="1887024">else</span>&nbsp;<span class="op" id="1887029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1887036">//&nbsp;Hash&nbsp;isn&#39;t&nbsp;repeatable&nbsp;if&nbsp;k&nbsp;!=&nbsp;k&nbsp;(NaNs).&nbsp;&nbsp;We&nbsp;need&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1887095">//&nbsp;repeatable&nbsp;and&nbsp;randomish&nbsp;choice&nbsp;of&nbsp;which&nbsp;direction</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1887154">//&nbsp;to&nbsp;send&nbsp;NaNs&nbsp;during&nbsp;evacuation.&nbsp;&nbsp;We&#39;ll&nbsp;use&nbsp;the&nbsp;low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1887213">//&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;to&nbsp;decide&nbsp;which&nbsp;way&nbsp;NaNs&nbsp;go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1887265">//&nbsp;NOTE:&nbsp;this&nbsp;case&nbsp;is&nbsp;why&nbsp;we&nbsp;need&nbsp;two&nbsp;evacuate&nbsp;tophash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1887325">//&nbsp;values,&nbsp;evacuatedX&nbsp;and&nbsp;evacuatedY,&nbsp;that&nbsp;differ&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1887383">//&nbsp;their&nbsp;low&nbsp;bit.</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1887406">if</span>&nbsp;<span class="ident" id="1887409">checkBucket</span><span class="op" id="1887420">&gt;&gt;</span><span class="op" id="1887422">(</span><span class="ident" id="1887423">it</span><span class="op" id="1887425">.</span><span class="ident" id="1887426">B</span><span class="op" id="1887427">-</span><span class="num" id="1887428">1</span><span class="op" id="1887429">)</span>&nbsp;<span class="op" id="1887431">!=</span>&nbsp;<span class="builtintype" id="1887434">uintptr</span><span class="op" id="1887441">(</span><span class="ident" id="1887442">b</span><span class="op" id="1887443">.</span><span class="ident" id="1887444">tophash</span><span class="op" id="1887451">[</span><span class="ident" id="1887452">offi</span><span class="op" id="1887456">]</span><span class="op" id="1887457">&amp;</span><span class="num" id="1887458">1</span><span class="op" id="1887459">)</span>&nbsp;<span class="op" id="1887461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1887469">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1887483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1887489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1887494">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1887499">if</span>&nbsp;<span class="ident" id="1887502">b</span><span class="op" id="1887503">.</span><span class="ident" id="1887504">tophash</span><span class="op" id="1887511">[</span><span class="ident" id="1887512">offi</span><span class="op" id="1887516">]</span>&nbsp;<span class="op" id="1887518">!=</span>&nbsp;<span class="ident" id="1887521">evacuatedX</span>&nbsp;<span class="op" id="1887532">&amp;&amp;</span>&nbsp;<span class="ident" id="1887535">b</span><span class="op" id="1887536">.</span><span class="ident" id="1887537">tophash</span><span class="op" id="1887544">[</span><span class="ident" id="1887545">offi</span><span class="op" id="1887549">]</span>&nbsp;<span class="op" id="1887551">!=</span>&nbsp;<span class="ident" id="1887554">evacuatedY</span>&nbsp;<span class="op" id="1887565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1887571">//&nbsp;this&nbsp;is&nbsp;the&nbsp;golden&nbsp;data,&nbsp;we&nbsp;can&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1887621">if</span>&nbsp;<span class="ident" id="1887624">t</span><span class="op" id="1887625">.</span><span class="ident" id="1887626">indirectkey</span>&nbsp;<span class="op" id="1887638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1887645">k</span>&nbsp;<span class="op" id="1887647">=</span>&nbsp;<span class="op" id="1887649">*</span><span class="op" id="1887650">(</span><span class="op" id="1887651">(</span><span class="op" id="1887652">*</span><span class="ident" id="1887653">unsafe</span><span class="op" id="1887659">.</span><span class="ident" id="1887660">Pointer</span><span class="op" id="1887667">)</span><span class="op" id="1887668">(</span><span class="ident" id="1887669">k</span><span class="op" id="1887670">)</span><span class="op" id="1887671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1887677">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1887683">it</span><span class="op" id="1887685">.</span><span class="ident" id="1887686">key</span>&nbsp;<span class="op" id="1887690">=</span>&nbsp;<span class="ident" id="1887692">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1887698">if</span>&nbsp;<span class="ident" id="1887701">t</span><span class="op" id="1887702">.</span><span class="ident" id="1887703">indirectvalue</span>&nbsp;<span class="op" id="1887717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1887724">v</span>&nbsp;<span class="op" id="1887726">=</span>&nbsp;<span class="op" id="1887728">*</span><span class="op" id="1887729">(</span><span class="op" id="1887730">(</span><span class="op" id="1887731">*</span><span class="ident" id="1887732">unsafe</span><span class="op" id="1887738">.</span><span class="ident" id="1887739">Pointer</span><span class="op" id="1887746">)</span><span class="op" id="1887747">(</span><span class="ident" id="1887748">v</span><span class="op" id="1887749">)</span><span class="op" id="1887750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1887756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1887762">it</span><span class="op" id="1887764">.</span><span class="ident" id="1887765">value</span>&nbsp;<span class="op" id="1887771">=</span>&nbsp;<span class="ident" id="1887773">v</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1887778">}</span>&nbsp;<span class="keyword" id="1887780">else</span>&nbsp;<span class="op" id="1887785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1887791">//&nbsp;The&nbsp;hash&nbsp;table&nbsp;has&nbsp;grown&nbsp;since&nbsp;the&nbsp;iterator&nbsp;was&nbsp;started.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1887855">//&nbsp;The&nbsp;golden&nbsp;data&nbsp;for&nbsp;this&nbsp;key&nbsp;is&nbsp;now&nbsp;somewhere&nbsp;else.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1887914">k2</span>&nbsp;<span class="op" id="1887917">:=</span>&nbsp;<span class="ident" id="1887920">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1887926">if</span>&nbsp;<span class="ident" id="1887929">t</span><span class="op" id="1887930">.</span><span class="ident" id="1887931">indirectkey</span>&nbsp;<span class="op" id="1887943">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1887950">k2</span>&nbsp;<span class="op" id="1887953">=</span>&nbsp;<span class="op" id="1887955">*</span><span class="op" id="1887956">(</span><span class="op" id="1887957">(</span><span class="op" id="1887958">*</span><span class="ident" id="1887959">unsafe</span><span class="op" id="1887965">.</span><span class="ident" id="1887966">Pointer</span><span class="op" id="1887973">)</span><span class="op" id="1887974">(</span><span class="ident" id="1887975">k2</span><span class="op" id="1887977">)</span><span class="op" id="1887978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1887984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1887990">if</span>&nbsp;<span class="ident" id="1887993">alg</span><span class="op" id="1887996">.</span><span class="ident" id="1887997">equal</span><span class="op" id="1888002">(</span><span class="ident" id="1888003">k2</span><span class="op" id="1888005">,</span>&nbsp;<span class="ident" id="1888007">k2</span><span class="op" id="1888009">,</span>&nbsp;<span class="builtintype" id="1888011">uintptr</span><span class="op" id="1888018">(</span><span class="ident" id="1888019">t</span><span class="op" id="1888020">.</span><span class="ident" id="1888021">key</span><span class="op" id="1888024">.</span><span class="ident" id="1888025">size</span><span class="op" id="1888029">)</span><span class="op" id="1888030">)</span>&nbsp;<span class="op" id="1888032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1888039">//&nbsp;Check&nbsp;the&nbsp;current&nbsp;hash&nbsp;table&nbsp;for&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1888090">//&nbsp;This&nbsp;code&nbsp;handles&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;key</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1888139">//&nbsp;has&nbsp;been&nbsp;deleted,&nbsp;updated,&nbsp;or&nbsp;deleted&nbsp;and&nbsp;reinserted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1888201">//&nbsp;NOTE:&nbsp;we&nbsp;need&nbsp;to&nbsp;regrab&nbsp;the&nbsp;key&nbsp;as&nbsp;it&nbsp;has&nbsp;potentially&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1888268">//&nbsp;updated&nbsp;to&nbsp;an&nbsp;equal()&nbsp;but&nbsp;not&nbsp;identical&nbsp;key&nbsp;(e.g.&nbsp;+0.0&nbsp;vs&nbsp;-0.0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1888341">rk</span><span class="op" id="1888343">,</span>&nbsp;<span class="ident" id="1888345">rv</span>&nbsp;<span class="op" id="1888348">:=</span>&nbsp;<span class="ident" id="1888351">mapaccessK</span><span class="op" id="1888361">(</span><span class="ident" id="1888362">t</span><span class="op" id="1888363">,</span>&nbsp;<span class="ident" id="1888365">h</span><span class="op" id="1888366">,</span>&nbsp;<span class="ident" id="1888368">k2</span><span class="op" id="1888370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1888377">if</span>&nbsp;<span class="ident" id="1888380">rk</span>&nbsp;<span class="op" id="1888383">==</span>&nbsp;<span class="ident" id="1888386">nil</span>&nbsp;<span class="op" id="1888390">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1888398">continue</span>&nbsp;<span class="comment" id="1888407">//&nbsp;key&nbsp;has&nbsp;been&nbsp;deleted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1888436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1888443">it</span><span class="op" id="1888445">.</span><span class="ident" id="1888446">key</span>&nbsp;<span class="op" id="1888450">=</span>&nbsp;<span class="ident" id="1888452">rk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1888460">it</span><span class="op" id="1888462">.</span><span class="ident" id="1888463">value</span>&nbsp;<span class="op" id="1888469">=</span>&nbsp;<span class="ident" id="1888471">rv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1888478">}</span>&nbsp;<span class="keyword" id="1888480">else</span>&nbsp;<span class="op" id="1888485">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1888492">//&nbsp;if&nbsp;key!=key&nbsp;then&nbsp;the&nbsp;entry&nbsp;can&#39;t&nbsp;be&nbsp;deleted&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1888547">//&nbsp;updated,&nbsp;so&nbsp;we&nbsp;can&nbsp;just&nbsp;return&nbsp;it.&nbsp;&nbsp;That&#39;s&nbsp;lucky&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1888608">//&nbsp;us&nbsp;because&nbsp;when&nbsp;key!=key&nbsp;we&nbsp;can&#39;t&nbsp;look&nbsp;it&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1888661">//&nbsp;successfully&nbsp;in&nbsp;the&nbsp;current&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1888704">it</span><span class="op" id="1888706">.</span><span class="ident" id="1888707">key</span>&nbsp;<span class="op" id="1888711">=</span>&nbsp;<span class="ident" id="1888713">k2</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1888721">if</span>&nbsp;<span class="ident" id="1888724">t</span><span class="op" id="1888725">.</span><span class="ident" id="1888726">indirectvalue</span>&nbsp;<span class="op" id="1888740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1888748">v</span>&nbsp;<span class="op" id="1888750">=</span>&nbsp;<span class="op" id="1888752">*</span><span class="op" id="1888753">(</span><span class="op" id="1888754">(</span><span class="op" id="1888755">*</span><span class="ident" id="1888756">unsafe</span><span class="op" id="1888762">.</span><span class="ident" id="1888763">Pointer</span><span class="op" id="1888770">)</span><span class="op" id="1888771">(</span><span class="ident" id="1888772">v</span><span class="op" id="1888773">)</span><span class="op" id="1888774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1888781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1888788">it</span><span class="op" id="1888790">.</span><span class="ident" id="1888791">value</span>&nbsp;<span class="op" id="1888797">=</span>&nbsp;<span class="ident" id="1888799">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1888805">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1888810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1888815">it</span><span class="op" id="1888817">.</span><span class="ident" id="1888818">bucket</span>&nbsp;<span class="op" id="1888825">=</span>&nbsp;<span class="ident" id="1888827">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1888837">it</span><span class="op" id="1888839">.</span><span class="ident" id="1888840">bptr</span>&nbsp;<span class="op" id="1888845">=</span>&nbsp;<span class="ident" id="1888847">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1888852">it</span><span class="op" id="1888854">.</span><span class="ident" id="1888855">i</span>&nbsp;<span class="op" id="1888857">=</span>&nbsp;<span class="ident" id="1888859">i</span>&nbsp;<span class="op" id="1888861">+</span>&nbsp;<span class="num" id="1888863">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1888868">it</span><span class="op" id="1888870">.</span><span class="ident" id="1888871">checkBucket</span>&nbsp;<span class="op" id="1888883">=</span>&nbsp;<span class="ident" id="1888885">checkBucket</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1888900">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1888909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1888912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1888915">b</span>&nbsp;<span class="op" id="1888917">=</span>&nbsp;<span class="ident" id="1888919">b</span><span class="op" id="1888920">.</span><span class="ident" id="1888921">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1888931">i</span>&nbsp;<span class="op" id="1888933">=</span>&nbsp;<span class="num" id="1888935">0</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1888938">goto</span>&nbsp;<span class="ident" id="1888943">next</span><br>
<span class="lineno"></span><span class="op" id="1888948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1888951">func</span>&nbsp;<span class="ident" id="1888956">hashGrow</span><span class="op" id="1888964">(</span><span class="ident" id="1888965">t</span>&nbsp;<span class="op" id="1888967">*</span><span class="ident" id="1888968">maptype</span><span class="op" id="1888975">,</span>&nbsp;<span class="ident" id="1888977">h</span>&nbsp;<span class="op" id="1888979">*</span><span class="ident" id="1888980">hmap</span><span class="op" id="1888984">)</span>&nbsp;<span class="op" id="1888986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1888989">if</span>&nbsp;<span class="ident" id="1888992">h</span><span class="op" id="1888993">.</span><span class="ident" id="1888994">oldbuckets</span>&nbsp;<span class="op" id="1889005">!=</span>&nbsp;<span class="ident" id="1889008">nil</span>&nbsp;<span class="op" id="1889012">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1889016">gothrow</span><span class="op" id="1889023">(</span><span class="string" id="1889024">&#34;evacuation&nbsp;not&nbsp;done&nbsp;in&nbsp;time&#34;</span><span class="op" id="1889053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1889056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1889059">oldbuckets</span>&nbsp;<span class="op" id="1889070">:=</span>&nbsp;<span class="ident" id="1889073">h</span><span class="op" id="1889074">.</span><span class="ident" id="1889075">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1889084">if</span>&nbsp;<span class="ident" id="1889087">checkgc</span>&nbsp;<span class="op" id="1889095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1889099">memstats</span><span class="op" id="1889107">.</span><span class="ident" id="1889108">next_gc</span>&nbsp;<span class="op" id="1889116">=</span>&nbsp;<span class="ident" id="1889118">memstats</span><span class="op" id="1889126">.</span><span class="ident" id="1889127">heap_alloc</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1889139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1889142">newbuckets</span>&nbsp;<span class="op" id="1889153">:=</span>&nbsp;<span class="ident" id="1889156">newarray</span><span class="op" id="1889164">(</span><span class="ident" id="1889165">t</span><span class="op" id="1889166">.</span><span class="ident" id="1889167">bucket</span><span class="op" id="1889173">,</span>&nbsp;<span class="builtintype" id="1889175">uintptr</span><span class="op" id="1889182">(</span><span class="num" id="1889183">1</span><span class="op" id="1889184">)</span><span class="op" id="1889185">&lt;&lt;</span><span class="op" id="1889187">(</span><span class="ident" id="1889188">h</span><span class="op" id="1889189">.</span><span class="ident" id="1889190">B</span><span class="op" id="1889191">+</span><span class="num" id="1889192">1</span><span class="op" id="1889193">)</span><span class="op" id="1889194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1889197">flags</span>&nbsp;<span class="op" id="1889203">:=</span>&nbsp;<span class="ident" id="1889206">h</span><span class="op" id="1889207">.</span><span class="ident" id="1889208">flags</span>&nbsp;<span class="op" id="1889214">&amp;^</span>&nbsp;<span class="op" id="1889217">(</span><span class="ident" id="1889218">iterator</span>&nbsp;<span class="op" id="1889227">|</span>&nbsp;<span class="ident" id="1889229">oldIterator</span><span class="op" id="1889240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1889243">if</span>&nbsp;<span class="ident" id="1889246">h</span><span class="op" id="1889247">.</span><span class="ident" id="1889248">flags</span><span class="op" id="1889253">&amp;</span><span class="ident" id="1889254">iterator</span>&nbsp;<span class="op" id="1889263">!=</span>&nbsp;<span class="num" id="1889266">0</span>&nbsp;<span class="op" id="1889268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1889272">flags</span>&nbsp;<span class="op" id="1889278">|=</span>&nbsp;<span class="ident" id="1889281">oldIterator</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1889294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1889297">//&nbsp;commit&nbsp;the&nbsp;grow&nbsp;(atomic&nbsp;wrt&nbsp;gc)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1889333">h</span><span class="op" id="1889334">.</span><span class="ident" id="1889335">B</span><span class="op" id="1889336">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1889340">h</span><span class="op" id="1889341">.</span><span class="ident" id="1889342">flags</span>&nbsp;<span class="op" id="1889348">=</span>&nbsp;<span class="ident" id="1889350">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1889357">h</span><span class="op" id="1889358">.</span><span class="ident" id="1889359">oldbuckets</span>&nbsp;<span class="op" id="1889370">=</span>&nbsp;<span class="ident" id="1889372">oldbuckets</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1889384">h</span><span class="op" id="1889385">.</span><span class="ident" id="1889386">buckets</span>&nbsp;<span class="op" id="1889394">=</span>&nbsp;<span class="ident" id="1889396">newbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1889408">h</span><span class="op" id="1889409">.</span><span class="ident" id="1889410">nevacuate</span>&nbsp;<span class="op" id="1889420">=</span>&nbsp;<span class="num" id="1889422">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1889426">//&nbsp;the&nbsp;actual&nbsp;copying&nbsp;of&nbsp;the&nbsp;hash&nbsp;table&nbsp;data&nbsp;is&nbsp;done&nbsp;incrementally</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1889494">//&nbsp;by&nbsp;growWork()&nbsp;and&nbsp;evacuate().</span><br>
<span class="lineno">750</span><span class="op" id="1889527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1889530">func</span>&nbsp;<span class="ident" id="1889535">growWork</span><span class="op" id="1889543">(</span><span class="ident" id="1889544">t</span>&nbsp;<span class="op" id="1889546">*</span><span class="ident" id="1889547">maptype</span><span class="op" id="1889554">,</span>&nbsp;<span class="ident" id="1889556">h</span>&nbsp;<span class="op" id="1889558">*</span><span class="ident" id="1889559">hmap</span><span class="op" id="1889563">,</span>&nbsp;<span class="ident" id="1889565">bucket</span>&nbsp;<span class="builtintype" id="1889572">uintptr</span><span class="op" id="1889579">)</span>&nbsp;<span class="op" id="1889581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1889584">noldbuckets</span>&nbsp;<span class="op" id="1889596">:=</span>&nbsp;<span class="builtintype" id="1889599">uintptr</span><span class="op" id="1889606">(</span><span class="num" id="1889607">1</span><span class="op" id="1889608">)</span>&nbsp;<span class="op" id="1889610">&lt;&lt;</span>&nbsp;<span class="op" id="1889613">(</span><span class="ident" id="1889614">h</span><span class="op" id="1889615">.</span><span class="ident" id="1889616">B</span>&nbsp;<span class="op" id="1889618">-</span>&nbsp;<span class="num" id="1889620">1</span><span class="op" id="1889621">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1889625">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;evacuate&nbsp;the&nbsp;oldbucket&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1889679">//&nbsp;to&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1889716">evacuate</span><span class="op" id="1889724">(</span><span class="ident" id="1889725">t</span><span class="op" id="1889726">,</span>&nbsp;<span class="ident" id="1889728">h</span><span class="op" id="1889729">,</span>&nbsp;<span class="ident" id="1889731">bucket</span><span class="op" id="1889737">&amp;</span><span class="op" id="1889738">(</span><span class="ident" id="1889739">noldbuckets</span><span class="op" id="1889750">-</span><span class="num" id="1889751">1</span><span class="op" id="1889752">)</span><span class="op" id="1889753">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1889757">//&nbsp;evacuate&nbsp;one&nbsp;more&nbsp;oldbucket&nbsp;to&nbsp;make&nbsp;progress&nbsp;on&nbsp;growing</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1889817">if</span>&nbsp;<span class="ident" id="1889820">h</span><span class="op" id="1889821">.</span><span class="ident" id="1889822">oldbuckets</span>&nbsp;<span class="op" id="1889833">!=</span>&nbsp;<span class="ident" id="1889836">nil</span>&nbsp;<span class="op" id="1889840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1889844">evacuate</span><span class="op" id="1889852">(</span><span class="ident" id="1889853">t</span><span class="op" id="1889854">,</span>&nbsp;<span class="ident" id="1889856">h</span><span class="op" id="1889857">,</span>&nbsp;<span class="ident" id="1889859">h</span><span class="op" id="1889860">.</span><span class="ident" id="1889861">nevacuate</span><span class="op" id="1889870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1889873">}</span><br>
<span class="lineno"></span><span class="op" id="1889875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="1889878">func</span>&nbsp;<span class="ident" id="1889883">evacuate</span><span class="op" id="1889891">(</span><span class="ident" id="1889892">t</span>&nbsp;<span class="op" id="1889894">*</span><span class="ident" id="1889895">maptype</span><span class="op" id="1889902">,</span>&nbsp;<span class="ident" id="1889904">h</span>&nbsp;<span class="op" id="1889906">*</span><span class="ident" id="1889907">hmap</span><span class="op" id="1889911">,</span>&nbsp;<span class="ident" id="1889913">oldbucket</span>&nbsp;<span class="builtintype" id="1889923">uintptr</span><span class="op" id="1889930">)</span>&nbsp;<span class="op" id="1889932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1889935">b</span>&nbsp;<span class="op" id="1889937">:=</span>&nbsp;<span class="op" id="1889940">(</span><span class="op" id="1889941">*</span><span class="ident" id="1889942">bmap</span><span class="op" id="1889946">)</span><span class="op" id="1889947">(</span><span class="ident" id="1889948">add</span><span class="op" id="1889951">(</span><span class="ident" id="1889952">h</span><span class="op" id="1889953">.</span><span class="ident" id="1889954">oldbuckets</span><span class="op" id="1889964">,</span>&nbsp;<span class="ident" id="1889966">oldbucket</span><span class="op" id="1889975">*</span><span class="builtintype" id="1889976">uintptr</span><span class="op" id="1889983">(</span><span class="ident" id="1889984">t</span><span class="op" id="1889985">.</span><span class="ident" id="1889986">bucketsize</span><span class="op" id="1889996">)</span><span class="op" id="1889997">)</span><span class="op" id="1889998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890001">newbit</span>&nbsp;<span class="op" id="1890008">:=</span>&nbsp;<span class="builtintype" id="1890011">uintptr</span><span class="op" id="1890018">(</span><span class="num" id="1890019">1</span><span class="op" id="1890020">)</span>&nbsp;<span class="op" id="1890022">&lt;&lt;</span>&nbsp;<span class="op" id="1890025">(</span><span class="ident" id="1890026">h</span><span class="op" id="1890027">.</span><span class="ident" id="1890028">B</span>&nbsp;<span class="op" id="1890030">-</span>&nbsp;<span class="num" id="1890032">1</span><span class="op" id="1890033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890036">alg</span>&nbsp;<span class="op" id="1890040">:=</span>&nbsp;<span class="ident" id="1890043">goalg</span><span class="op" id="1890048">(</span><span class="ident" id="1890049">t</span><span class="op" id="1890050">.</span><span class="ident" id="1890051">key</span><span class="op" id="1890054">.</span><span class="ident" id="1890055">alg</span><span class="op" id="1890058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1890061">if</span>&nbsp;<span class="op" id="1890064">!</span><span class="ident" id="1890065">evacuated</span><span class="op" id="1890074">(</span><span class="ident" id="1890075">b</span><span class="op" id="1890076">)</span>&nbsp;<span class="op" id="1890078">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1890082">//&nbsp;TODO:&nbsp;reuse&nbsp;overflow&nbsp;buckets&nbsp;instead&nbsp;of&nbsp;using&nbsp;new&nbsp;ones,&nbsp;if&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1890152">//&nbsp;is&nbsp;no&nbsp;iterator&nbsp;using&nbsp;the&nbsp;old&nbsp;buckets.&nbsp;&nbsp;(If&nbsp;!oldIterator.)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890216">x</span>&nbsp;<span class="op" id="1890218">:=</span>&nbsp;<span class="op" id="1890221">(</span><span class="op" id="1890222">*</span><span class="ident" id="1890223">bmap</span><span class="op" id="1890227">)</span><span class="op" id="1890228">(</span><span class="ident" id="1890229">add</span><span class="op" id="1890232">(</span><span class="ident" id="1890233">h</span><span class="op" id="1890234">.</span><span class="ident" id="1890235">buckets</span><span class="op" id="1890242">,</span>&nbsp;<span class="ident" id="1890244">oldbucket</span><span class="op" id="1890253">*</span><span class="builtintype" id="1890254">uintptr</span><span class="op" id="1890261">(</span><span class="ident" id="1890262">t</span><span class="op" id="1890263">.</span><span class="ident" id="1890264">bucketsize</span><span class="op" id="1890274">)</span><span class="op" id="1890275">)</span><span class="op" id="1890276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890280">y</span>&nbsp;<span class="op" id="1890282">:=</span>&nbsp;<span class="op" id="1890285">(</span><span class="op" id="1890286">*</span><span class="ident" id="1890287">bmap</span><span class="op" id="1890291">)</span><span class="op" id="1890292">(</span><span class="ident" id="1890293">add</span><span class="op" id="1890296">(</span><span class="ident" id="1890297">h</span><span class="op" id="1890298">.</span><span class="ident" id="1890299">buckets</span><span class="op" id="1890306">,</span>&nbsp;<span class="op" id="1890308">(</span><span class="ident" id="1890309">oldbucket</span><span class="op" id="1890318">+</span><span class="ident" id="1890319">newbit</span><span class="op" id="1890325">)</span><span class="op" id="1890326">*</span><span class="builtintype" id="1890327">uintptr</span><span class="op" id="1890334">(</span><span class="ident" id="1890335">t</span><span class="op" id="1890336">.</span><span class="ident" id="1890337">bucketsize</span><span class="op" id="1890347">)</span><span class="op" id="1890348">)</span><span class="op" id="1890349">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890353">xi</span>&nbsp;<span class="op" id="1890356">:=</span>&nbsp;<span class="num" id="1890359">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890363">yi</span>&nbsp;<span class="op" id="1890366">:=</span>&nbsp;<span class="num" id="1890369">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890373">xk</span>&nbsp;<span class="op" id="1890376">:=</span>&nbsp;<span class="ident" id="1890379">add</span><span class="op" id="1890382">(</span><span class="ident" id="1890383">unsafe</span><span class="op" id="1890389">.</span><span class="ident" id="1890390">Pointer</span><span class="op" id="1890397">(</span><span class="ident" id="1890398">x</span><span class="op" id="1890399">)</span><span class="op" id="1890400">,</span>&nbsp;<span class="ident" id="1890402">dataOffset</span><span class="op" id="1890412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890416">yk</span>&nbsp;<span class="op" id="1890419">:=</span>&nbsp;<span class="ident" id="1890422">add</span><span class="op" id="1890425">(</span><span class="ident" id="1890426">unsafe</span><span class="op" id="1890432">.</span><span class="ident" id="1890433">Pointer</span><span class="op" id="1890440">(</span><span class="ident" id="1890441">y</span><span class="op" id="1890442">)</span><span class="op" id="1890443">,</span>&nbsp;<span class="ident" id="1890445">dataOffset</span><span class="op" id="1890455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890459">xv</span>&nbsp;<span class="op" id="1890462">:=</span>&nbsp;<span class="ident" id="1890465">add</span><span class="op" id="1890468">(</span><span class="ident" id="1890469">xk</span><span class="op" id="1890471">,</span>&nbsp;<span class="ident" id="1890473">bucketCnt</span><span class="op" id="1890482">*</span><span class="builtintype" id="1890483">uintptr</span><span class="op" id="1890490">(</span><span class="ident" id="1890491">t</span><span class="op" id="1890492">.</span><span class="ident" id="1890493">keysize</span><span class="op" id="1890500">)</span><span class="op" id="1890501">)</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890505">yv</span>&nbsp;<span class="op" id="1890508">:=</span>&nbsp;<span class="ident" id="1890511">add</span><span class="op" id="1890514">(</span><span class="ident" id="1890515">yk</span><span class="op" id="1890517">,</span>&nbsp;<span class="ident" id="1890519">bucketCnt</span><span class="op" id="1890528">*</span><span class="builtintype" id="1890529">uintptr</span><span class="op" id="1890536">(</span><span class="ident" id="1890537">t</span><span class="op" id="1890538">.</span><span class="ident" id="1890539">keysize</span><span class="op" id="1890546">)</span><span class="op" id="1890547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1890551">for</span>&nbsp;<span class="op" id="1890555">;</span>&nbsp;<span class="ident" id="1890557">b</span>&nbsp;<span class="op" id="1890559">!=</span>&nbsp;<span class="ident" id="1890562">nil</span><span class="op" id="1890565">;</span>&nbsp;<span class="ident" id="1890567">b</span>&nbsp;<span class="op" id="1890569">=</span>&nbsp;<span class="ident" id="1890571">b</span><span class="op" id="1890572">.</span><span class="ident" id="1890573">overflow</span>&nbsp;<span class="op" id="1890582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890587">k</span>&nbsp;<span class="op" id="1890589">:=</span>&nbsp;<span class="ident" id="1890592">add</span><span class="op" id="1890595">(</span><span class="ident" id="1890596">unsafe</span><span class="op" id="1890602">.</span><span class="ident" id="1890603">Pointer</span><span class="op" id="1890610">(</span><span class="ident" id="1890611">b</span><span class="op" id="1890612">)</span><span class="op" id="1890613">,</span>&nbsp;<span class="ident" id="1890615">dataOffset</span><span class="op" id="1890625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890630">v</span>&nbsp;<span class="op" id="1890632">:=</span>&nbsp;<span class="ident" id="1890635">add</span><span class="op" id="1890638">(</span><span class="ident" id="1890639">k</span><span class="op" id="1890640">,</span>&nbsp;<span class="ident" id="1890642">bucketCnt</span><span class="op" id="1890651">*</span><span class="builtintype" id="1890652">uintptr</span><span class="op" id="1890659">(</span><span class="ident" id="1890660">t</span><span class="op" id="1890661">.</span><span class="ident" id="1890662">keysize</span><span class="op" id="1890669">)</span><span class="op" id="1890670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1890675">for</span>&nbsp;<span class="ident" id="1890679">i</span>&nbsp;<span class="op" id="1890681">:=</span>&nbsp;<span class="num" id="1890684">0</span><span class="op" id="1890685">;</span>&nbsp;<span class="ident" id="1890687">i</span>&nbsp;<span class="op" id="1890689">&lt;</span>&nbsp;<span class="ident" id="1890691">bucketCnt</span><span class="op" id="1890700">;</span>&nbsp;<span class="ident" id="1890702">i</span><span class="op" id="1890703">,</span>&nbsp;<span class="ident" id="1890705">k</span><span class="op" id="1890706">,</span>&nbsp;<span class="ident" id="1890708">v</span>&nbsp;<span class="op" id="1890710">=</span>&nbsp;<span class="ident" id="1890712">i</span><span class="op" id="1890713">+</span><span class="num" id="1890714">1</span><span class="op" id="1890715">,</span>&nbsp;<span class="ident" id="1890717">add</span><span class="op" id="1890720">(</span><span class="ident" id="1890721">k</span><span class="op" id="1890722">,</span>&nbsp;<span class="builtintype" id="1890724">uintptr</span><span class="op" id="1890731">(</span><span class="ident" id="1890732">t</span><span class="op" id="1890733">.</span><span class="ident" id="1890734">keysize</span><span class="op" id="1890741">)</span><span class="op" id="1890742">)</span><span class="op" id="1890743">,</span>&nbsp;<span class="ident" id="1890745">add</span><span class="op" id="1890748">(</span><span class="ident" id="1890749">v</span><span class="op" id="1890750">,</span>&nbsp;<span class="builtintype" id="1890752">uintptr</span><span class="op" id="1890759">(</span><span class="ident" id="1890760">t</span><span class="op" id="1890761">.</span><span class="ident" id="1890762">valuesize</span><span class="op" id="1890771">)</span><span class="op" id="1890772">)</span>&nbsp;<span class="op" id="1890774">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890780">top</span>&nbsp;<span class="op" id="1890784">:=</span>&nbsp;<span class="ident" id="1890787">b</span><span class="op" id="1890788">.</span><span class="ident" id="1890789">tophash</span><span class="op" id="1890796">[</span><span class="ident" id="1890797">i</span><span class="op" id="1890798">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1890804">if</span>&nbsp;<span class="ident" id="1890807">top</span>&nbsp;<span class="op" id="1890811">==</span>&nbsp;<span class="ident" id="1890814">empty</span>&nbsp;<span class="op" id="1890820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890827">b</span><span class="op" id="1890828">.</span><span class="ident" id="1890829">tophash</span><span class="op" id="1890836">[</span><span class="ident" id="1890837">i</span><span class="op" id="1890838">]</span>&nbsp;<span class="op" id="1890840">=</span>&nbsp;<span class="ident" id="1890842">evacuatedEmpty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1890862">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1890875">}</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1890881">if</span>&nbsp;<span class="ident" id="1890884">top</span>&nbsp;<span class="op" id="1890888">&lt;</span>&nbsp;<span class="ident" id="1890890">minTopHash</span>&nbsp;<span class="op" id="1890901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890908">gothrow</span><span class="op" id="1890915">(</span><span class="string" id="1890916">&#34;bad&nbsp;map&nbsp;state&#34;</span><span class="op" id="1890931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1890937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890943">k2</span>&nbsp;<span class="op" id="1890946">:=</span>&nbsp;<span class="ident" id="1890949">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1890955">if</span>&nbsp;<span class="ident" id="1890958">t</span><span class="op" id="1890959">.</span><span class="ident" id="1890960">indirectkey</span>&nbsp;<span class="op" id="1890972">{</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1890979">k2</span>&nbsp;<span class="op" id="1890982">=</span>&nbsp;<span class="op" id="1890984">*</span><span class="op" id="1890985">(</span><span class="op" id="1890986">(</span><span class="op" id="1890987">*</span><span class="ident" id="1890988">unsafe</span><span class="op" id="1890994">.</span><span class="ident" id="1890995">Pointer</span><span class="op" id="1891002">)</span><span class="op" id="1891003">(</span><span class="ident" id="1891004">k2</span><span class="op" id="1891006">)</span><span class="op" id="1891007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1891013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1891019">//&nbsp;Compute&nbsp;hash&nbsp;to&nbsp;make&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;(whether&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1891088">//&nbsp;to&nbsp;send&nbsp;this&nbsp;key/value&nbsp;to&nbsp;bucket&nbsp;x&nbsp;or&nbsp;bucket&nbsp;y).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1891144">hash</span>&nbsp;<span class="op" id="1891149">:=</span>&nbsp;<span class="ident" id="1891152">alg</span><span class="op" id="1891155">.</span><span class="ident" id="1891156">hash</span><span class="op" id="1891160">(</span><span class="ident" id="1891161">k2</span><span class="op" id="1891163">,</span>&nbsp;<span class="builtintype" id="1891165">uintptr</span><span class="op" id="1891172">(</span><span class="ident" id="1891173">t</span><span class="op" id="1891174">.</span><span class="ident" id="1891175">key</span><span class="op" id="1891178">.</span><span class="ident" id="1891179">size</span><span class="op" id="1891183">)</span><span class="op" id="1891184">,</span>&nbsp;<span class="builtintype" id="1891186">uintptr</span><span class="op" id="1891193">(</span><span class="ident" id="1891194">h</span><span class="op" id="1891195">.</span><span class="ident" id="1891196">hash0</span><span class="op" id="1891201">)</span><span class="op" id="1891202">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1891208">if</span>&nbsp;<span class="ident" id="1891211">h</span><span class="op" id="1891212">.</span><span class="ident" id="1891213">flags</span><span class="op" id="1891218">&amp;</span><span class="ident" id="1891219">iterator</span>&nbsp;<span class="op" id="1891228">!=</span>&nbsp;<span class="num" id="1891231">0</span>&nbsp;<span class="op" id="1891233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1891240">if</span>&nbsp;<span class="op" id="1891243">!</span><span class="ident" id="1891244">alg</span><span class="op" id="1891247">.</span><span class="ident" id="1891248">equal</span><span class="op" id="1891253">(</span><span class="ident" id="1891254">k2</span><span class="op" id="1891256">,</span>&nbsp;<span class="ident" id="1891258">k2</span><span class="op" id="1891260">,</span>&nbsp;<span class="builtintype" id="1891262">uintptr</span><span class="op" id="1891269">(</span><span class="ident" id="1891270">t</span><span class="op" id="1891271">.</span><span class="ident" id="1891272">key</span><span class="op" id="1891275">.</span><span class="ident" id="1891276">size</span><span class="op" id="1891280">)</span><span class="op" id="1891281">)</span>&nbsp;<span class="op" id="1891283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1891291">//&nbsp;If&nbsp;key&nbsp;!=&nbsp;key&nbsp;(NaNs),&nbsp;then&nbsp;the&nbsp;hash&nbsp;could&nbsp;be&nbsp;(and&nbsp;probably</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1891359">//&nbsp;will&nbsp;be)&nbsp;entirely&nbsp;different&nbsp;from&nbsp;the&nbsp;old&nbsp;hash.&nbsp;&nbsp;Moreover,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1891426">//&nbsp;it&nbsp;isn&#39;t&nbsp;reproducible.&nbsp;&nbsp;Reproducibility&nbsp;is&nbsp;required&nbsp;in&nbsp;the</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1891494">//&nbsp;presence&nbsp;of&nbsp;iterators,&nbsp;as&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1891558">//&nbsp;match&nbsp;whatever&nbsp;decision&nbsp;the&nbsp;iterator&nbsp;made.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1891610">//&nbsp;Fortunately,&nbsp;we&nbsp;have&nbsp;the&nbsp;freedom&nbsp;to&nbsp;send&nbsp;these&nbsp;keys&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1891678">//&nbsp;way.&nbsp;&nbsp;Also,&nbsp;tophash&nbsp;is&nbsp;meaningless&nbsp;for&nbsp;these&nbsp;kinds&nbsp;of&nbsp;keys.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1891747">//&nbsp;We&nbsp;let&nbsp;the&nbsp;low&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;drive&nbsp;the&nbsp;evacuation&nbsp;decision.</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1891817">//&nbsp;We&nbsp;recompute&nbsp;a&nbsp;new&nbsp;random&nbsp;tophash&nbsp;for&nbsp;the&nbsp;next&nbsp;level&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1891882">//&nbsp;these&nbsp;keys&nbsp;will&nbsp;get&nbsp;evenly&nbsp;distributed&nbsp;across&nbsp;all&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1891949">//&nbsp;after&nbsp;multiple&nbsp;grows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1891980">if</span>&nbsp;<span class="op" id="1891983">(</span><span class="ident" id="1891984">top</span>&nbsp;<span class="op" id="1891988">&amp;</span>&nbsp;<span class="num" id="1891990">1</span><span class="op" id="1891991">)</span>&nbsp;<span class="op" id="1891993">!=</span>&nbsp;<span class="num" id="1891996">0</span>&nbsp;<span class="op" id="1891998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892007">hash</span>&nbsp;<span class="op" id="1892012">|=</span>&nbsp;<span class="ident" id="1892015">newbit</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1892028">}</span>&nbsp;<span class="keyword" id="1892030">else</span>&nbsp;<span class="op" id="1892035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892044">hash</span>&nbsp;<span class="op" id="1892049">&amp;^=</span>&nbsp;<span class="ident" id="1892053">newbit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1892066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892074">top</span>&nbsp;<span class="op" id="1892078">=</span>&nbsp;<span class="builtintype" id="1892080">uint8</span><span class="op" id="1892085">(</span><span class="ident" id="1892086">hash</span>&nbsp;<span class="op" id="1892091">&gt;&gt;</span>&nbsp;<span class="op" id="1892094">(</span><span class="ident" id="1892095">ptrSize</span><span class="op" id="1892102">*</span><span class="num" id="1892103">8</span>&nbsp;<span class="op" id="1892105">-</span>&nbsp;<span class="num" id="1892107">8</span><span class="op" id="1892108">)</span><span class="op" id="1892109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1892117">if</span>&nbsp;<span class="ident" id="1892120">top</span>&nbsp;<span class="op" id="1892124">&lt;</span>&nbsp;<span class="ident" id="1892126">minTopHash</span>&nbsp;<span class="op" id="1892137">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892146">top</span>&nbsp;<span class="op" id="1892150">+=</span>&nbsp;<span class="ident" id="1892153">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1892170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1892177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1892183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1892189">if</span>&nbsp;<span class="op" id="1892192">(</span><span class="ident" id="1892193">hash</span>&nbsp;<span class="op" id="1892198">&amp;</span>&nbsp;<span class="ident" id="1892200">newbit</span><span class="op" id="1892206">)</span>&nbsp;<span class="op" id="1892208">==</span>&nbsp;<span class="num" id="1892211">0</span>&nbsp;<span class="op" id="1892213">{</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892220">b</span><span class="op" id="1892221">.</span><span class="ident" id="1892222">tophash</span><span class="op" id="1892229">[</span><span class="ident" id="1892230">i</span><span class="op" id="1892231">]</span>&nbsp;<span class="op" id="1892233">=</span>&nbsp;<span class="ident" id="1892235">evacuatedX</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1892251">if</span>&nbsp;<span class="ident" id="1892254">xi</span>&nbsp;<span class="op" id="1892257">==</span>&nbsp;<span class="ident" id="1892260">bucketCnt</span>&nbsp;<span class="op" id="1892270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1892278">if</span>&nbsp;<span class="ident" id="1892281">checkgc</span>&nbsp;<span class="op" id="1892289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892298">memstats</span><span class="op" id="1892306">.</span><span class="ident" id="1892307">next_gc</span>&nbsp;<span class="op" id="1892315">=</span>&nbsp;<span class="ident" id="1892317">memstats</span><span class="op" id="1892325">.</span><span class="ident" id="1892326">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1892343">}</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892351">newx</span>&nbsp;<span class="op" id="1892356">:=</span>&nbsp;<span class="op" id="1892359">(</span><span class="op" id="1892360">*</span><span class="ident" id="1892361">bmap</span><span class="op" id="1892365">)</span><span class="op" id="1892366">(</span><span class="ident" id="1892367">newobject</span><span class="op" id="1892376">(</span><span class="ident" id="1892377">t</span><span class="op" id="1892378">.</span><span class="ident" id="1892379">bucket</span><span class="op" id="1892385">)</span><span class="op" id="1892386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892394">x</span><span class="op" id="1892395">.</span><span class="ident" id="1892396">overflow</span>&nbsp;<span class="op" id="1892405">=</span>&nbsp;<span class="ident" id="1892407">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892418">x</span>&nbsp;<span class="op" id="1892420">=</span>&nbsp;<span class="ident" id="1892422">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892433">xi</span>&nbsp;<span class="op" id="1892436">=</span>&nbsp;<span class="num" id="1892438">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892446">xk</span>&nbsp;<span class="op" id="1892449">=</span>&nbsp;<span class="ident" id="1892451">add</span><span class="op" id="1892454">(</span><span class="ident" id="1892455">unsafe</span><span class="op" id="1892461">.</span><span class="ident" id="1892462">Pointer</span><span class="op" id="1892469">(</span><span class="ident" id="1892470">x</span><span class="op" id="1892471">)</span><span class="op" id="1892472">,</span>&nbsp;<span class="ident" id="1892474">dataOffset</span><span class="op" id="1892484">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892492">xv</span>&nbsp;<span class="op" id="1892495">=</span>&nbsp;<span class="ident" id="1892497">add</span><span class="op" id="1892500">(</span><span class="ident" id="1892501">xk</span><span class="op" id="1892503">,</span>&nbsp;<span class="ident" id="1892505">bucketCnt</span><span class="op" id="1892514">*</span><span class="builtintype" id="1892515">uintptr</span><span class="op" id="1892522">(</span><span class="ident" id="1892523">t</span><span class="op" id="1892524">.</span><span class="ident" id="1892525">keysize</span><span class="op" id="1892532">)</span><span class="op" id="1892533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1892540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892547">x</span><span class="op" id="1892548">.</span><span class="ident" id="1892549">tophash</span><span class="op" id="1892556">[</span><span class="ident" id="1892557">xi</span><span class="op" id="1892559">]</span>&nbsp;<span class="op" id="1892561">=</span>&nbsp;<span class="ident" id="1892563">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1892572">if</span>&nbsp;<span class="ident" id="1892575">t</span><span class="op" id="1892576">.</span><span class="ident" id="1892577">indirectkey</span>&nbsp;<span class="op" id="1892589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1892597">*</span><span class="op" id="1892598">(</span><span class="op" id="1892599">*</span><span class="ident" id="1892600">unsafe</span><span class="op" id="1892606">.</span><span class="ident" id="1892607">Pointer</span><span class="op" id="1892614">)</span><span class="op" id="1892615">(</span><span class="ident" id="1892616">xk</span><span class="op" id="1892618">)</span>&nbsp;<span class="op" id="1892620">=</span>&nbsp;<span class="ident" id="1892622">k2</span>&nbsp;<span class="comment" id="1892625">//&nbsp;copy&nbsp;pointer</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1892646">}</span>&nbsp;<span class="keyword" id="1892648">else</span>&nbsp;<span class="op" id="1892653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892661">memmove</span><span class="op" id="1892668">(</span><span class="ident" id="1892669">xk</span><span class="op" id="1892671">,</span>&nbsp;<span class="ident" id="1892673">k</span><span class="op" id="1892674">,</span>&nbsp;<span class="builtintype" id="1892676">uintptr</span><span class="op" id="1892683">(</span><span class="ident" id="1892684">t</span><span class="op" id="1892685">.</span><span class="ident" id="1892686">key</span><span class="op" id="1892689">.</span><span class="ident" id="1892690">size</span><span class="op" id="1892694">)</span><span class="op" id="1892695">)</span>&nbsp;<span class="comment" id="1892697">//&nbsp;copy&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1892716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1892723">if</span>&nbsp;<span class="ident" id="1892726">t</span><span class="op" id="1892727">.</span><span class="ident" id="1892728">indirectvalue</span>&nbsp;<span class="op" id="1892742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1892750">*</span><span class="op" id="1892751">(</span><span class="op" id="1892752">*</span><span class="ident" id="1892753">unsafe</span><span class="op" id="1892759">.</span><span class="ident" id="1892760">Pointer</span><span class="op" id="1892767">)</span><span class="op" id="1892768">(</span><span class="ident" id="1892769">xv</span><span class="op" id="1892771">)</span>&nbsp;<span class="op" id="1892773">=</span>&nbsp;<span class="op" id="1892775">*</span><span class="op" id="1892776">(</span><span class="op" id="1892777">*</span><span class="ident" id="1892778">unsafe</span><span class="op" id="1892784">.</span><span class="ident" id="1892785">Pointer</span><span class="op" id="1892792">)</span><span class="op" id="1892793">(</span><span class="ident" id="1892794">v</span><span class="op" id="1892795">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1892802">}</span>&nbsp;<span class="keyword" id="1892804">else</span>&nbsp;<span class="op" id="1892809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892817">memmove</span><span class="op" id="1892824">(</span><span class="ident" id="1892825">xv</span><span class="op" id="1892827">,</span>&nbsp;<span class="ident" id="1892829">v</span><span class="op" id="1892830">,</span>&nbsp;<span class="builtintype" id="1892832">uintptr</span><span class="op" id="1892839">(</span><span class="ident" id="1892840">t</span><span class="op" id="1892841">.</span><span class="ident" id="1892842">elem</span><span class="op" id="1892846">.</span><span class="ident" id="1892847">size</span><span class="op" id="1892851">)</span><span class="op" id="1892852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1892859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892866">xi</span><span class="op" id="1892868">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892876">xk</span>&nbsp;<span class="op" id="1892879">=</span>&nbsp;<span class="ident" id="1892881">add</span><span class="op" id="1892884">(</span><span class="ident" id="1892885">xk</span><span class="op" id="1892887">,</span>&nbsp;<span class="builtintype" id="1892889">uintptr</span><span class="op" id="1892896">(</span><span class="ident" id="1892897">t</span><span class="op" id="1892898">.</span><span class="ident" id="1892899">keysize</span><span class="op" id="1892906">)</span><span class="op" id="1892907">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892914">xv</span>&nbsp;<span class="op" id="1892917">=</span>&nbsp;<span class="ident" id="1892919">add</span><span class="op" id="1892922">(</span><span class="ident" id="1892923">xv</span><span class="op" id="1892925">,</span>&nbsp;<span class="builtintype" id="1892927">uintptr</span><span class="op" id="1892934">(</span><span class="ident" id="1892935">t</span><span class="op" id="1892936">.</span><span class="ident" id="1892937">valuesize</span><span class="op" id="1892946">)</span><span class="op" id="1892947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1892953">}</span>&nbsp;<span class="keyword" id="1892955">else</span>&nbsp;<span class="op" id="1892960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1892967">b</span><span class="op" id="1892968">.</span><span class="ident" id="1892969">tophash</span><span class="op" id="1892976">[</span><span class="ident" id="1892977">i</span><span class="op" id="1892978">]</span>&nbsp;<span class="op" id="1892980">=</span>&nbsp;<span class="ident" id="1892982">evacuatedY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1892998">if</span>&nbsp;<span class="ident" id="1893001">yi</span>&nbsp;<span class="op" id="1893004">==</span>&nbsp;<span class="ident" id="1893007">bucketCnt</span>&nbsp;<span class="op" id="1893017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1893025">if</span>&nbsp;<span class="ident" id="1893028">checkgc</span>&nbsp;<span class="op" id="1893036">{</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1893045">memstats</span><span class="op" id="1893053">.</span><span class="ident" id="1893054">next_gc</span>&nbsp;<span class="op" id="1893062">=</span>&nbsp;<span class="ident" id="1893064">memstats</span><span class="op" id="1893072">.</span><span class="ident" id="1893073">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1893090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1893098">newy</span>&nbsp;<span class="op" id="1893103">:=</span>&nbsp;<span class="op" id="1893106">(</span><span class="op" id="1893107">*</span><span class="ident" id="1893108">bmap</span><span class="op" id="1893112">)</span><span class="op" id="1893113">(</span><span class="ident" id="1893114">newobject</span><span class="op" id="1893123">(</span><span class="ident" id="1893124">t</span><span class="op" id="1893125">.</span><span class="ident" id="1893126">bucket</span><span class="op" id="1893132">)</span><span class="op" id="1893133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1893141">y</span><span class="op" id="1893142">.</span><span class="ident" id="1893143">overflow</span>&nbsp;<span class="op" id="1893152">=</span>&nbsp;<span class="ident" id="1893154">newy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1893165">y</span>&nbsp;<span class="op" id="1893167">=</span>&nbsp;<span class="ident" id="1893169">newy</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1893180">yi</span>&nbsp;<span class="op" id="1893183">=</span>&nbsp;<span class="num" id="1893185">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1893193">yk</span>&nbsp;<span class="op" id="1893196">=</span>&nbsp;<span class="ident" id="1893198">add</span><span class="op" id="1893201">(</span><span class="ident" id="1893202">unsafe</span><span class="op" id="1893208">.</span><span class="ident" id="1893209">Pointer</span><span class="op" id="1893216">(</span><span class="ident" id="1893217">y</span><span class="op" id="1893218">)</span><span class="op" id="1893219">,</span>&nbsp;<span class="ident" id="1893221">dataOffset</span><span class="op" id="1893231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1893239">yv</span>&nbsp;<span class="op" id="1893242">=</span>&nbsp;<span class="ident" id="1893244">add</span><span class="op" id="1893247">(</span><span class="ident" id="1893248">yk</span><span class="op" id="1893250">,</span>&nbsp;<span class="ident" id="1893252">bucketCnt</span><span class="op" id="1893261">*</span><span class="builtintype" id="1893262">uintptr</span><span class="op" id="1893269">(</span><span class="ident" id="1893270">t</span><span class="op" id="1893271">.</span><span class="ident" id="1893272">keysize</span><span class="op" id="1893279">)</span><span class="op" id="1893280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1893287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1893294">y</span><span class="op" id="1893295">.</span><span class="ident" id="1893296">tophash</span><span class="op" id="1893303">[</span><span class="ident" id="1893304">yi</span><span class="op" id="1893306">]</span>&nbsp;<span class="op" id="1893308">=</span>&nbsp;<span class="ident" id="1893310">top</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1893319">if</span>&nbsp;<span class="ident" id="1893322">t</span><span class="op" id="1893323">.</span><span class="ident" id="1893324">indirectkey</span>&nbsp;<span class="op" id="1893336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1893344">*</span><span class="op" id="1893345">(</span><span class="op" id="1893346">*</span><span class="ident" id="1893347">unsafe</span><span class="op" id="1893353">.</span><span class="ident" id="1893354">Pointer</span><span class="op" id="1893361">)</span><span class="op" id="1893362">(</span><span class="ident" id="1893363">yk</span><span class="op" id="1893365">)</span>&nbsp;<span class="op" id="1893367">=</span>&nbsp;<span class="ident" id="1893369">k2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1893377">}</span>&nbsp;<span class="keyword" id="1893379">else</span>&nbsp;<span class="op" id="1893384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1893392">memmove</span><span class="op" id="1893399">(</span><span class="ident" id="1893400">yk</span><span class="op" id="1893402">,</span>&nbsp;<span class="ident" id="1893404">k</span><span class="op" id="1893405">,</span>&nbsp;<span class="builtintype" id="1893407">uintptr</span><span class="op" id="1893414">(</span><span class="ident" id="1893415">t</span><span class="op" id="1893416">.</span><span class="ident" id="1893417">key</span><span class="op" id="1893420">.</span><span class="ident" id="1893421">size</span><span class="op" id="1893425">)</span><span class="op" id="1893426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1893433">}</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1893440">if</span>&nbsp;<span class="ident" id="1893443">t</span><span class="op" id="1893444">.</span><span class="ident" id="1893445">indirectvalue</span>&nbsp;<span class="op" id="1893459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1893467">*</span><span class="op" id="1893468">(</span><span class="op" id="1893469">*</span><span class="ident" id="1893470">unsafe</span><span class="op" id="1893476">.</span><span class="ident" id="1893477">Pointer</span><span class="op" id="1893484">)</span><span class="op" id="1893485">(</span><span class="ident" id="1893486">yv</span><span class="op" id="1893488">)</span>&nbsp;<span class="op" id="1893490">=</span>&nbsp;<span class="op" id="1893492">*</span><span class="op" id="1893493">(</span><span class="op" id="1893494">*</span><span class="ident" id="1893495">unsafe</span><span class="op" id="1893501">.</span><span class="ident" id="1893502">Pointer</span><span class="op" id="1893509">)</span><span class="op" id="1893510">(</span><span class="ident" id="1893511">v</span><span class="op" id="1893512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1893519">}</span>&nbsp;<span class="keyword" id="1893521">else</span>&nbsp;<span class="op" id="1893526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1893534">memmove</span><span class="op" id="1893541">(</span><span class="ident" id="1893542">yv</span><span class="op" id="1893544">,</span>&nbsp;<span class="ident" id="1893546">v</span><span class="op" id="1893547">,</span>&nbsp;<span class="builtintype" id="1893549">uintptr</span><span class="op" id="1893556">(</span><span class="ident" id="1893557">t</span><span class="op" id="1893558">.</span><span class="ident" id="1893559">elem</span><span class="op" id="1893563">.</span><span class="ident" id="1893564">size</span><span class="op" id="1893568">)</span><span class="op" id="1893569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1893576">}</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1893583">yi</span><span class="op" id="1893585">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1893593">yk</span>&nbsp;<span class="op" id="1893596">=</span>&nbsp;<span class="ident" id="1893598">add</span><span class="op" id="1893601">(</span><span class="ident" id="1893602">yk</span><span class="op" id="1893604">,</span>&nbsp;<span class="builtintype" id="1893606">uintptr</span><span class="op" id="1893613">(</span><span class="ident" id="1893614">t</span><span class="op" id="1893615">.</span><span class="ident" id="1893616">keysize</span><span class="op" id="1893623">)</span><span class="op" id="1893624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1893631">yv</span>&nbsp;<span class="op" id="1893634">=</span>&nbsp;<span class="ident" id="1893636">add</span><span class="op" id="1893639">(</span><span class="ident" id="1893640">yv</span><span class="op" id="1893642">,</span>&nbsp;<span class="builtintype" id="1893644">uintptr</span><span class="op" id="1893651">(</span><span class="ident" id="1893652">t</span><span class="op" id="1893653">.</span><span class="ident" id="1893654">valuesize</span><span class="op" id="1893663">)</span><span class="op" id="1893664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1893670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1893675">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1893679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1893683">//&nbsp;Unlink&nbsp;the&nbsp;overflow&nbsp;buckets&nbsp;&amp;&nbsp;clear&nbsp;key/value&nbsp;to&nbsp;help&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1893746">if</span>&nbsp;<span class="ident" id="1893749">h</span><span class="op" id="1893750">.</span><span class="ident" id="1893751">flags</span><span class="op" id="1893756">&amp;</span><span class="ident" id="1893757">oldIterator</span>&nbsp;<span class="op" id="1893769">==</span>&nbsp;<span class="num" id="1893772">0</span>&nbsp;<span class="op" id="1893774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1893779">b</span>&nbsp;<span class="op" id="1893781">=</span>&nbsp;<span class="op" id="1893783">(</span><span class="op" id="1893784">*</span><span class="ident" id="1893785">bmap</span><span class="op" id="1893789">)</span><span class="op" id="1893790">(</span><span class="ident" id="1893791">add</span><span class="op" id="1893794">(</span><span class="ident" id="1893795">h</span><span class="op" id="1893796">.</span><span class="ident" id="1893797">oldbuckets</span><span class="op" id="1893807">,</span>&nbsp;<span class="ident" id="1893809">oldbucket</span><span class="op" id="1893818">*</span><span class="builtintype" id="1893819">uintptr</span><span class="op" id="1893826">(</span><span class="ident" id="1893827">t</span><span class="op" id="1893828">.</span><span class="ident" id="1893829">bucketsize</span><span class="op" id="1893839">)</span><span class="op" id="1893840">)</span><span class="op" id="1893841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1893846">b</span><span class="op" id="1893847">.</span><span class="ident" id="1893848">overflow</span>&nbsp;<span class="op" id="1893857">=</span>&nbsp;<span class="ident" id="1893859">nil</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1893866">memclr</span><span class="op" id="1893872">(</span><span class="ident" id="1893873">add</span><span class="op" id="1893876">(</span><span class="ident" id="1893877">unsafe</span><span class="op" id="1893883">.</span><span class="ident" id="1893884">Pointer</span><span class="op" id="1893891">(</span><span class="ident" id="1893892">b</span><span class="op" id="1893893">)</span><span class="op" id="1893894">,</span>&nbsp;<span class="ident" id="1893896">dataOffset</span><span class="op" id="1893906">)</span><span class="op" id="1893907">,</span>&nbsp;<span class="builtintype" id="1893909">uintptr</span><span class="op" id="1893916">(</span><span class="ident" id="1893917">t</span><span class="op" id="1893918">.</span><span class="ident" id="1893919">bucketsize</span><span class="op" id="1893929">)</span><span class="op" id="1893930">-</span><span class="ident" id="1893931">dataOffset</span><span class="op" id="1893941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1893945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1893948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1893952">//&nbsp;Advance&nbsp;evacuation&nbsp;mark</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1893980">if</span>&nbsp;<span class="ident" id="1893983">oldbucket</span>&nbsp;<span class="op" id="1893993">==</span>&nbsp;<span class="ident" id="1893996">h</span><span class="op" id="1893997">.</span><span class="ident" id="1893998">nevacuate</span>&nbsp;<span class="op" id="1894008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1894012">h</span><span class="op" id="1894013">.</span><span class="ident" id="1894014">nevacuate</span>&nbsp;<span class="op" id="1894024">=</span>&nbsp;<span class="ident" id="1894026">oldbucket</span>&nbsp;<span class="op" id="1894036">+</span>&nbsp;<span class="num" id="1894038">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1894042">if</span>&nbsp;<span class="ident" id="1894045">oldbucket</span><span class="op" id="1894054">+</span><span class="num" id="1894055">1</span>&nbsp;<span class="op" id="1894057">==</span>&nbsp;<span class="ident" id="1894060">newbit</span>&nbsp;<span class="op" id="1894067">{</span>&nbsp;<span class="comment" id="1894069">//&nbsp;newbit&nbsp;==&nbsp;#&nbsp;of&nbsp;oldbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1894101">//&nbsp;Growing&nbsp;is&nbsp;all&nbsp;done.&nbsp;&nbsp;Free&nbsp;old&nbsp;main&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1894157">h</span><span class="op" id="1894158">.</span><span class="ident" id="1894159">oldbuckets</span>&nbsp;<span class="op" id="1894170">=</span>&nbsp;<span class="ident" id="1894172">nil</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1894178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1894181">}</span><br>
<span class="lineno"></span><span class="op" id="1894183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1894186">func</span>&nbsp;<span class="ident" id="1894191">ismapkey</span><span class="op" id="1894199">(</span><span class="ident" id="1894200">t</span>&nbsp;<span class="op" id="1894202">*</span><span class="ident" id="1894203">_type</span><span class="op" id="1894208">)</span>&nbsp;<span class="builtintype" id="1894210">bool</span>&nbsp;<span class="op" id="1894215">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1894218">return</span>&nbsp;<span class="ident" id="1894225">goalg</span><span class="op" id="1894230">(</span><span class="ident" id="1894231">t</span><span class="op" id="1894232">.</span><span class="ident" id="1894233">alg</span><span class="op" id="1894236">)</span><span class="op" id="1894237">.</span><span class="ident" id="1894238">hash</span>&nbsp;<span class="op" id="1894243">!=</span>&nbsp;<span class="ident" id="1894246">nil</span><br>
<span class="lineno"></span><span class="op" id="1894250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1894253">//&nbsp;Reflect&nbsp;stubs.&nbsp;&nbsp;Called&nbsp;from&nbsp;../reflect/asm_*.s</span><br>
<span class="lineno"></span><br>
<span class="lineno">905</span><span class="keyword" id="1894304">func</span>&nbsp;<span class="ident" id="1894309">reflect_makemap</span><span class="op" id="1894324">(</span><span class="ident" id="1894325">t</span>&nbsp;<span class="op" id="1894327">*</span><span class="ident" id="1894328">maptype</span><span class="op" id="1894335">)</span>&nbsp;<span class="op" id="1894337">*</span><span class="ident" id="1894338">hmap</span>&nbsp;<span class="op" id="1894343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1894346">return</span>&nbsp;<span class="ident" id="1894353">makemap</span><span class="op" id="1894360">(</span><span class="ident" id="1894361">t</span><span class="op" id="1894362">,</span>&nbsp;<span class="num" id="1894364">0</span><span class="op" id="1894365">)</span><br>
<span class="lineno"></span><span class="op" id="1894367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1894370">func</span>&nbsp;<span class="ident" id="1894375">reflect_mapaccess</span><span class="op" id="1894392">(</span><span class="ident" id="1894393">t</span>&nbsp;<span class="op" id="1894395">*</span><span class="ident" id="1894396">maptype</span><span class="op" id="1894403">,</span>&nbsp;<span class="ident" id="1894405">h</span>&nbsp;<span class="op" id="1894407">*</span><span class="ident" id="1894408">hmap</span><span class="op" id="1894412">,</span>&nbsp;<span class="ident" id="1894414">key</span>&nbsp;<span class="ident" id="1894418">unsafe</span><span class="op" id="1894424">.</span><span class="ident" id="1894425">Pointer</span><span class="op" id="1894432">)</span>&nbsp;<span class="ident" id="1894434">unsafe</span><span class="op" id="1894440">.</span><span class="ident" id="1894441">Pointer</span>&nbsp;<span class="op" id="1894449">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1894452">val</span><span class="op" id="1894455">,</span>&nbsp;<span class="ident" id="1894457">ok</span>&nbsp;<span class="op" id="1894460">:=</span>&nbsp;<span class="ident" id="1894463">mapaccess2</span><span class="op" id="1894473">(</span><span class="ident" id="1894474">t</span><span class="op" id="1894475">,</span>&nbsp;<span class="ident" id="1894477">h</span><span class="op" id="1894478">,</span>&nbsp;<span class="ident" id="1894480">key</span><span class="op" id="1894483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1894486">if</span>&nbsp;<span class="op" id="1894489">!</span><span class="ident" id="1894490">ok</span>&nbsp;<span class="op" id="1894493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1894497">//&nbsp;reflect&nbsp;wants&nbsp;nil&nbsp;for&nbsp;a&nbsp;missing&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1894542">val</span>&nbsp;<span class="op" id="1894546">=</span>&nbsp;<span class="ident" id="1894548">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1894553">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1894556">return</span>&nbsp;<span class="ident" id="1894563">val</span><br>
<span class="lineno"></span><span class="op" id="1894567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1894570">func</span>&nbsp;<span class="ident" id="1894575">reflect_mapassign</span><span class="op" id="1894592">(</span><span class="ident" id="1894593">t</span>&nbsp;<span class="op" id="1894595">*</span><span class="ident" id="1894596">maptype</span><span class="op" id="1894603">,</span>&nbsp;<span class="ident" id="1894605">h</span>&nbsp;<span class="op" id="1894607">*</span><span class="ident" id="1894608">hmap</span><span class="op" id="1894612">,</span>&nbsp;<span class="ident" id="1894614">key</span>&nbsp;<span class="ident" id="1894618">unsafe</span><span class="op" id="1894624">.</span><span class="ident" id="1894625">Pointer</span><span class="op" id="1894632">,</span>&nbsp;<span class="ident" id="1894634">val</span>&nbsp;<span class="ident" id="1894638">unsafe</span><span class="op" id="1894644">.</span><span class="ident" id="1894645">Pointer</span><span class="op" id="1894652">)</span>&nbsp;<span class="op" id="1894654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1894657">mapassign1</span><span class="op" id="1894667">(</span><span class="ident" id="1894668">t</span><span class="op" id="1894669">,</span>&nbsp;<span class="ident" id="1894671">h</span><span class="op" id="1894672">,</span>&nbsp;<span class="ident" id="1894674">key</span><span class="op" id="1894677">,</span>&nbsp;<span class="ident" id="1894679">val</span><span class="op" id="1894682">)</span><br>
<span class="lineno">920</span><span class="op" id="1894684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1894687">func</span>&nbsp;<span class="ident" id="1894692">reflect_mapdelete</span><span class="op" id="1894709">(</span><span class="ident" id="1894710">t</span>&nbsp;<span class="op" id="1894712">*</span><span class="ident" id="1894713">maptype</span><span class="op" id="1894720">,</span>&nbsp;<span class="ident" id="1894722">h</span>&nbsp;<span class="op" id="1894724">*</span><span class="ident" id="1894725">hmap</span><span class="op" id="1894729">,</span>&nbsp;<span class="ident" id="1894731">key</span>&nbsp;<span class="ident" id="1894735">unsafe</span><span class="op" id="1894741">.</span><span class="ident" id="1894742">Pointer</span><span class="op" id="1894749">)</span>&nbsp;<span class="op" id="1894751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1894754">mapdelete</span><span class="op" id="1894763">(</span><span class="ident" id="1894764">t</span><span class="op" id="1894765">,</span>&nbsp;<span class="ident" id="1894767">h</span><span class="op" id="1894768">,</span>&nbsp;<span class="ident" id="1894770">key</span><span class="op" id="1894773">)</span><br>
<span class="lineno"></span><span class="op" id="1894775">}</span><br>
<span class="lineno">925</span><br>
<span class="lineno"></span><span class="keyword" id="1894778">func</span>&nbsp;<span class="ident" id="1894783">reflect_mapiterinit</span><span class="op" id="1894802">(</span><span class="ident" id="1894803">t</span>&nbsp;<span class="op" id="1894805">*</span><span class="ident" id="1894806">maptype</span><span class="op" id="1894813">,</span>&nbsp;<span class="ident" id="1894815">h</span>&nbsp;<span class="op" id="1894817">*</span><span class="ident" id="1894818">hmap</span><span class="op" id="1894822">)</span>&nbsp;<span class="op" id="1894824">*</span><span class="ident" id="1894825">hiter</span>&nbsp;<span class="op" id="1894831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1894834">it</span>&nbsp;<span class="op" id="1894837">:=</span>&nbsp;<span class="builtinfunc" id="1894840">new</span><span class="op" id="1894843">(</span><span class="ident" id="1894844">hiter</span><span class="op" id="1894849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1894852">mapiterinit</span><span class="op" id="1894863">(</span><span class="ident" id="1894864">t</span><span class="op" id="1894865">,</span>&nbsp;<span class="ident" id="1894867">h</span><span class="op" id="1894868">,</span>&nbsp;<span class="ident" id="1894870">it</span><span class="op" id="1894872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1894875">return</span>&nbsp;<span class="ident" id="1894882">it</span><br>
<span class="lineno">930</span><span class="op" id="1894885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1894888">func</span>&nbsp;<span class="ident" id="1894893">reflect_mapiternext</span><span class="op" id="1894912">(</span><span class="ident" id="1894913">it</span>&nbsp;<span class="op" id="1894916">*</span><span class="ident" id="1894917">hiter</span><span class="op" id="1894922">)</span>&nbsp;<span class="op" id="1894924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1894927">mapiternext</span><span class="op" id="1894938">(</span><span class="ident" id="1894939">it</span><span class="op" id="1894941">)</span><br>
<span class="lineno"></span><span class="op" id="1894943">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="keyword" id="1894946">func</span>&nbsp;<span class="ident" id="1894951">reflect_mapiterkey</span><span class="op" id="1894969">(</span><span class="ident" id="1894970">it</span>&nbsp;<span class="op" id="1894973">*</span><span class="ident" id="1894974">hiter</span><span class="op" id="1894979">)</span>&nbsp;<span class="ident" id="1894981">unsafe</span><span class="op" id="1894987">.</span><span class="ident" id="1894988">Pointer</span>&nbsp;<span class="op" id="1894996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1894999">return</span>&nbsp;<span class="ident" id="1895006">it</span><span class="op" id="1895008">.</span><span class="ident" id="1895009">key</span><br>
<span class="lineno"></span><span class="op" id="1895013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">940</span><span class="keyword" id="1895016">func</span>&nbsp;<span class="ident" id="1895021">reflect_maplen</span><span class="op" id="1895035">(</span><span class="ident" id="1895036">h</span>&nbsp;<span class="op" id="1895038">*</span><span class="ident" id="1895039">hmap</span><span class="op" id="1895043">)</span>&nbsp;<span class="builtintype" id="1895045">int</span>&nbsp;<span class="op" id="1895049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1895052">if</span>&nbsp;<span class="ident" id="1895055">h</span>&nbsp;<span class="op" id="1895057">==</span>&nbsp;<span class="ident" id="1895060">nil</span>&nbsp;<span class="op" id="1895064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1895068">return</span>&nbsp;<span class="num" id="1895075">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1895078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1895081">if</span>&nbsp;<span class="ident" id="1895084">raceenabled</span>&nbsp;<span class="op" id="1895096">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1895100">callerpc</span>&nbsp;<span class="op" id="1895109">:=</span>&nbsp;<span class="ident" id="1895112">getcallerpc</span><span class="op" id="1895123">(</span><span class="ident" id="1895124">unsafe</span><span class="op" id="1895130">.</span><span class="ident" id="1895131">Pointer</span><span class="op" id="1895138">(</span><span class="op" id="1895139">&amp;</span><span class="ident" id="1895140">h</span><span class="op" id="1895141">)</span><span class="op" id="1895142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1895146">racereadpc</span><span class="op" id="1895156">(</span><span class="ident" id="1895157">unsafe</span><span class="op" id="1895163">.</span><span class="ident" id="1895164">Pointer</span><span class="op" id="1895171">(</span><span class="ident" id="1895172">h</span><span class="op" id="1895173">)</span><span class="op" id="1895174">,</span>&nbsp;<span class="ident" id="1895176">callerpc</span><span class="op" id="1895184">,</span>&nbsp;<span class="ident" id="1895186">funcPC</span><span class="op" id="1895192">(</span><span class="ident" id="1895193">reflect_maplen</span><span class="op" id="1895207">)</span><span class="op" id="1895208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1895211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1895214">return</span>&nbsp;<span class="ident" id="1895221">h</span><span class="op" id="1895222">.</span><span class="ident" id="1895223">count</span><br>
<span class="lineno"></span><span class="op" id="1895229">}</span><br>
<span class="lineno">950</span><br>
<span class="lineno"></span><span class="keyword" id="1895232">func</span>&nbsp;<span class="ident" id="1895237">reflect_ismapkey</span><span class="op" id="1895253">(</span><span class="ident" id="1895254">t</span>&nbsp;<span class="op" id="1895256">*</span><span class="ident" id="1895257">_type</span><span class="op" id="1895262">)</span>&nbsp;<span class="builtintype" id="1895264">bool</span>&nbsp;<span class="op" id="1895269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1895272">return</span>&nbsp;<span class="ident" id="1895279">ismapkey</span><span class="op" id="1895287">(</span><span class="ident" id="1895288">t</span><span class="op" id="1895289">)</span><br>
<span class="lineno"></span><span class="op" id="1895291">}</span>
</div>
</body>
</html>
