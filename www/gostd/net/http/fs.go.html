<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html" class="current">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4071470">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4071525">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4071579">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4071630">//&nbsp;HTTP&nbsp;file&nbsp;system&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4071667">package</span>&nbsp;<span class="ident" id="4071675">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4071681">import</span>&nbsp;<span class="op" id="4071688">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4071691">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4071701">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4071708">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4071714">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4071722">&#34;mime/multipart&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4071740">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4071757">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4071768">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4071774">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4071782">&#34;path/filepath&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4071799">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4071810">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4071821">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4071828">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4071831">//&nbsp;A&nbsp;Dir&nbsp;implements&nbsp;FileSystem&nbsp;using&nbsp;the&nbsp;native&nbsp;file&nbsp;system&nbsp;restricted&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4071907">//&nbsp;specific&nbsp;directory&nbsp;tree.</span><br>
<span class="lineno"></span><span class="comment" id="4071935">//</span><br>
<span class="lineno"></span><span class="comment" id="4071938">//&nbsp;While&nbsp;the&nbsp;FileSystem.Open&nbsp;method&nbsp;takes&nbsp;&#39;/&#39;-separated&nbsp;paths,&nbsp;a&nbsp;Dir&#39;s&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="4072016">//&nbsp;value&nbsp;is&nbsp;a&nbsp;filename&nbsp;on&nbsp;the&nbsp;native&nbsp;file&nbsp;system,&nbsp;not&nbsp;a&nbsp;URL,&nbsp;so&nbsp;it&nbsp;is&nbsp;separated</span><br>
<span class="lineno">30</span><span class="comment" id="4072096">//&nbsp;by&nbsp;filepath.Separator,&nbsp;which&nbsp;isn&#39;t&nbsp;necessarily&nbsp;&#39;/&#39;.</span><br>
<span class="lineno"></span><span class="comment" id="4072151">//</span><br>
<span class="lineno"></span><span class="comment" id="4072154">//&nbsp;An&nbsp;empty&nbsp;Dir&nbsp;is&nbsp;treated&nbsp;as&nbsp;&#34;.&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="4072189">type</span>&nbsp;<span class="ident" id="4072194">Dir</span>&nbsp;<span class="builtintype" id="4072198">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="4072206">func</span>&nbsp;<span class="op" id="4072211">(</span><span class="ident" id="4072212">d</span>&nbsp;<span class="ident" id="4072214">Dir</span><span class="op" id="4072217">)</span>&nbsp;<span class="ident" id="4072219">Open</span><span class="op" id="4072223">(</span><span class="ident" id="4072224">name</span>&nbsp;<span class="builtintype" id="4072229">string</span><span class="op" id="4072235">)</span>&nbsp;<span class="op" id="4072237">(</span><span class="ident" id="4072238">File</span><span class="op" id="4072242">,</span>&nbsp;<span class="builtintype" id="4072244">error</span><span class="op" id="4072249">)</span>&nbsp;<span class="op" id="4072251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4072254">if</span>&nbsp;<span class="ident" id="4072257">filepath</span><span class="op" id="4072265">.</span><span class="ident" id="4072266">Separator</span>&nbsp;<span class="op" id="4072276">!=</span>&nbsp;<span class="string" id="4072279">&#39;/&#39;</span>&nbsp;<span class="op" id="4072283">&amp;&amp;</span>&nbsp;<span class="ident" id="4072286">strings</span><span class="op" id="4072293">.</span><span class="ident" id="4072294">IndexRune</span><span class="op" id="4072303">(</span><span class="ident" id="4072304">name</span><span class="op" id="4072308">,</span>&nbsp;<span class="ident" id="4072310">filepath</span><span class="op" id="4072318">.</span><span class="ident" id="4072319">Separator</span><span class="op" id="4072328">)</span>&nbsp;<span class="op" id="4072330">&gt;=</span>&nbsp;<span class="num" id="4072333">0</span>&nbsp;<span class="op" id="4072335">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4072340">strings</span><span class="op" id="4072347">.</span><span class="ident" id="4072348">Contains</span><span class="op" id="4072356">(</span><span class="ident" id="4072357">name</span><span class="op" id="4072361">,</span>&nbsp;<span class="string" id="4072363">&#34;\x00&#34;</span><span class="op" id="4072369">)</span>&nbsp;<span class="op" id="4072371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4072375">return</span>&nbsp;<span class="builtintype" id="4072382">nil</span><span class="op" id="4072385">,</span>&nbsp;<span class="ident" id="4072387">errors</span><span class="op" id="4072393">.</span><span class="ident" id="4072394">New</span><span class="op" id="4072397">(</span><span class="string" id="4072398">&#34;http:&nbsp;invalid&nbsp;character&nbsp;in&nbsp;file&nbsp;path&#34;</span><span class="op" id="4072436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4072439">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4072442">dir</span>&nbsp;<span class="op" id="4072446">:=</span>&nbsp;<span class="builtintype" id="4072449">string</span><span class="op" id="4072455">(</span><span class="ident" id="4072456">d</span><span class="op" id="4072457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4072460">if</span>&nbsp;<span class="ident" id="4072463">dir</span>&nbsp;<span class="op" id="4072467">==</span>&nbsp;<span class="string" id="4072470">&#34;&#34;</span>&nbsp;<span class="op" id="4072473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4072477">dir</span>&nbsp;<span class="op" id="4072481">=</span>&nbsp;<span class="string" id="4072483">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4072488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4072491">f</span><span class="op" id="4072492">,</span>&nbsp;<span class="ident" id="4072494">err</span>&nbsp;<span class="op" id="4072498">:=</span>&nbsp;<span class="ident" id="4072501">os</span><span class="op" id="4072503">.</span><span class="ident" id="4072504">Open</span><span class="op" id="4072508">(</span><span class="ident" id="4072509">filepath</span><span class="op" id="4072517">.</span><span class="ident" id="4072518">Join</span><span class="op" id="4072522">(</span><span class="ident" id="4072523">dir</span><span class="op" id="4072526">,</span>&nbsp;<span class="ident" id="4072528">filepath</span><span class="op" id="4072536">.</span><span class="ident" id="4072537">FromSlash</span><span class="op" id="4072546">(</span><span class="ident" id="4072547">path</span><span class="op" id="4072551">.</span><span class="ident" id="4072552">Clean</span><span class="op" id="4072557">(</span><span class="string" id="4072558">&#34;/&#34;</span><span class="op" id="4072561">+</span><span class="ident" id="4072562">name</span><span class="op" id="4072566">)</span><span class="op" id="4072567">)</span><span class="op" id="4072568">)</span><span class="op" id="4072569">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4072572">if</span>&nbsp;<span class="ident" id="4072575">err</span>&nbsp;<span class="op" id="4072579">!=</span>&nbsp;<span class="builtintype" id="4072582">nil</span>&nbsp;<span class="op" id="4072586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4072590">return</span>&nbsp;<span class="builtintype" id="4072597">nil</span><span class="op" id="4072600">,</span>&nbsp;<span class="ident" id="4072602">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4072607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4072610">return</span>&nbsp;<span class="ident" id="4072617">f</span><span class="op" id="4072618">,</span>&nbsp;<span class="builtintype" id="4072620">nil</span><br>
<span class="lineno"></span><span class="op" id="4072624">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="4072627">//&nbsp;A&nbsp;FileSystem&nbsp;implements&nbsp;access&nbsp;to&nbsp;a&nbsp;collection&nbsp;of&nbsp;named&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="4072693">//&nbsp;The&nbsp;elements&nbsp;in&nbsp;a&nbsp;file&nbsp;path&nbsp;are&nbsp;separated&nbsp;by&nbsp;slash&nbsp;(&#39;/&#39;,&nbsp;U+002F)</span><br>
<span class="lineno"></span><span class="comment" id="4072761">//&nbsp;characters,&nbsp;regardless&nbsp;of&nbsp;host&nbsp;operating&nbsp;system&nbsp;convention.</span><br>
<span class="lineno"></span><span class="keyword" id="4072824">type</span>&nbsp;<span class="ident" id="4072829">FileSystem</span>&nbsp;<span class="keyword" id="4072840">interface</span>&nbsp;<span class="op" id="4072850">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4072853">Open</span><span class="op" id="4072857">(</span><span class="ident" id="4072858">name</span>&nbsp;<span class="builtintype" id="4072863">string</span><span class="op" id="4072869">)</span>&nbsp;<span class="op" id="4072871">(</span><span class="ident" id="4072872">File</span><span class="op" id="4072876">,</span>&nbsp;<span class="builtintype" id="4072878">error</span><span class="op" id="4072883">)</span><br>
<span class="lineno"></span><span class="op" id="4072885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4072888">//&nbsp;A&nbsp;File&nbsp;is&nbsp;returned&nbsp;by&nbsp;a&nbsp;FileSystem&#39;s&nbsp;Open&nbsp;method&nbsp;and&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4072951">//&nbsp;served&nbsp;by&nbsp;the&nbsp;FileServer&nbsp;implementation.</span><br>
<span class="lineno">60</span><span class="comment" id="4072995">//</span><br>
<span class="lineno"></span><span class="comment" id="4072998">//&nbsp;The&nbsp;methods&nbsp;should&nbsp;behave&nbsp;the&nbsp;same&nbsp;as&nbsp;those&nbsp;on&nbsp;an&nbsp;*os.File.</span><br>
<span class="lineno"></span><span class="keyword" id="4073061">type</span>&nbsp;<span class="ident" id="4073066">File</span>&nbsp;<span class="keyword" id="4073071">interface</span>&nbsp;<span class="op" id="4073081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4073084">io</span><span class="op" id="4073086">.</span><span class="ident" id="4073087">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4073095">io</span><span class="op" id="4073097">.</span><span class="ident" id="4073098">Reader</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4073106">Readdir</span><span class="op" id="4073113">(</span><span class="ident" id="4073114">count</span>&nbsp;<span class="builtintype" id="4073120">int</span><span class="op" id="4073123">)</span>&nbsp;<span class="op" id="4073125">(</span><span class="op" id="4073126">[</span><span class="op" id="4073127">]</span><span class="ident" id="4073128">os</span><span class="op" id="4073130">.</span><span class="ident" id="4073131">FileInfo</span><span class="op" id="4073139">,</span>&nbsp;<span class="builtintype" id="4073141">error</span><span class="op" id="4073146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4073149">Seek</span><span class="op" id="4073153">(</span><span class="ident" id="4073154">offset</span>&nbsp;<span class="ident" id="4073161">int64</span><span class="op" id="4073166">,</span>&nbsp;<span class="ident" id="4073168">whence</span>&nbsp;<span class="builtintype" id="4073175">int</span><span class="op" id="4073178">)</span>&nbsp;<span class="op" id="4073180">(</span><span class="ident" id="4073181">int64</span><span class="op" id="4073186">,</span>&nbsp;<span class="builtintype" id="4073188">error</span><span class="op" id="4073193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4073196">Stat</span><span class="op" id="4073200">(</span><span class="op" id="4073201">)</span>&nbsp;<span class="op" id="4073203">(</span><span class="ident" id="4073204">os</span><span class="op" id="4073206">.</span><span class="ident" id="4073207">FileInfo</span><span class="op" id="4073215">,</span>&nbsp;<span class="builtintype" id="4073217">error</span><span class="op" id="4073222">)</span><br>
<span class="lineno"></span><span class="op" id="4073224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="4073227">func</span>&nbsp;<span class="ident" id="4073232">dirList</span><span class="op" id="4073239">(</span><span class="ident" id="4073240">w</span>&nbsp;<span class="ident" id="4073242">ResponseWriter</span><span class="op" id="4073256">,</span>&nbsp;<span class="ident" id="4073258">f</span>&nbsp;<span class="ident" id="4073260">File</span><span class="op" id="4073264">)</span>&nbsp;<span class="op" id="4073266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4073269">w</span><span class="op" id="4073270">.</span><span class="ident" id="4073271">Header</span><span class="op" id="4073277">(</span><span class="op" id="4073278">)</span><span class="op" id="4073279">.</span><span class="ident" id="4073280">Set</span><span class="op" id="4073283">(</span><span class="string" id="4073284">&#34;Content-Type&#34;</span><span class="op" id="4073298">,</span>&nbsp;<span class="string" id="4073300">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="4073326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4073329">fmt</span><span class="op" id="4073332">.</span><span class="ident" id="4073333">Fprintf</span><span class="op" id="4073340">(</span><span class="ident" id="4073341">w</span><span class="op" id="4073342">,</span>&nbsp;<span class="string" id="4073344">&#34;&lt;pre&gt;\n&#34;</span><span class="op" id="4073353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4073356">for</span>&nbsp;<span class="op" id="4073360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4073364">dirs</span><span class="op" id="4073368">,</span>&nbsp;<span class="ident" id="4073370">err</span>&nbsp;<span class="op" id="4073374">:=</span>&nbsp;<span class="ident" id="4073377">f</span><span class="op" id="4073378">.</span><span class="ident" id="4073379">Readdir</span><span class="op" id="4073386">(</span><span class="num" id="4073387">100</span><span class="op" id="4073390">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4073394">if</span>&nbsp;<span class="ident" id="4073397">err</span>&nbsp;<span class="op" id="4073401">!=</span>&nbsp;<span class="builtintype" id="4073404">nil</span>&nbsp;<span class="op" id="4073408">||</span>&nbsp;<span class="builtinfunc" id="4073411">len</span><span class="op" id="4073414">(</span><span class="ident" id="4073415">dirs</span><span class="op" id="4073419">)</span>&nbsp;<span class="op" id="4073421">==</span>&nbsp;<span class="num" id="4073424">0</span>&nbsp;<span class="op" id="4073426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4073431">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4073439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4073443">for</span>&nbsp;<span class="ident" id="4073447">_</span><span class="op" id="4073448">,</span>&nbsp;<span class="ident" id="4073450">d</span>&nbsp;<span class="op" id="4073452">:=</span>&nbsp;<span class="keyword" id="4073455">range</span>&nbsp;<span class="ident" id="4073461">dirs</span>&nbsp;<span class="op" id="4073466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4073471">name</span>&nbsp;<span class="op" id="4073476">:=</span>&nbsp;<span class="ident" id="4073479">d</span><span class="op" id="4073480">.</span><span class="ident" id="4073481">Name</span><span class="op" id="4073485">(</span><span class="op" id="4073486">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4073491">if</span>&nbsp;<span class="ident" id="4073494">d</span><span class="op" id="4073495">.</span><span class="ident" id="4073496">IsDir</span><span class="op" id="4073501">(</span><span class="op" id="4073502">)</span>&nbsp;<span class="op" id="4073504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4073510">name</span>&nbsp;<span class="op" id="4073515">+=</span>&nbsp;<span class="string" id="4073518">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4073525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4073530">//&nbsp;name&nbsp;may&nbsp;contain&nbsp;&#39;?&#39;&nbsp;or&nbsp;&#39;#&#39;,&nbsp;which&nbsp;must&nbsp;be&nbsp;escaped&nbsp;to&nbsp;remain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4073597">//&nbsp;part&nbsp;of&nbsp;the&nbsp;URL&nbsp;path,&nbsp;and&nbsp;not&nbsp;indicate&nbsp;the&nbsp;start&nbsp;of&nbsp;a&nbsp;query</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4073663">//&nbsp;string&nbsp;or&nbsp;fragment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4073689">url</span>&nbsp;<span class="op" id="4073693">:=</span>&nbsp;<span class="ident" id="4073696">url</span><span class="op" id="4073699">.</span><span class="ident" id="4073700">URL</span><span class="op" id="4073703">{</span><span class="ident" id="4073704">Path</span><span class="op" id="4073708">:</span>&nbsp;<span class="ident" id="4073710">name</span><span class="op" id="4073714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4073719">fmt</span><span class="op" id="4073722">.</span><span class="ident" id="4073723">Fprintf</span><span class="op" id="4073730">(</span><span class="ident" id="4073731">w</span><span class="op" id="4073732">,</span>&nbsp;<span class="string" id="4073734">&#34;&lt;a&nbsp;href=\&#34;%s\&#34;&gt;%s&lt;/a&gt;\n&#34;</span><span class="op" id="4073759">,</span>&nbsp;<span class="ident" id="4073761">url</span><span class="op" id="4073764">.</span><span class="ident" id="4073765">String</span><span class="op" id="4073771">(</span><span class="op" id="4073772">)</span><span class="op" id="4073773">,</span>&nbsp;<span class="ident" id="4073775">htmlReplacer</span><span class="op" id="4073787">.</span><span class="ident" id="4073788">Replace</span><span class="op" id="4073795">(</span><span class="ident" id="4073796">name</span><span class="op" id="4073800">)</span><span class="op" id="4073801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4073805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4073808">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4073811">fmt</span><span class="op" id="4073814">.</span><span class="ident" id="4073815">Fprintf</span><span class="op" id="4073822">(</span><span class="ident" id="4073823">w</span><span class="op" id="4073824">,</span>&nbsp;<span class="string" id="4073826">&#34;&lt;/pre&gt;\n&#34;</span><span class="op" id="4073836">)</span><br>
<span class="lineno"></span><span class="op" id="4073838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4073841">//&nbsp;ServeContent&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;using&nbsp;the&nbsp;content&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4073905">//&nbsp;provided&nbsp;ReadSeeker.&nbsp;&nbsp;The&nbsp;main&nbsp;benefit&nbsp;of&nbsp;ServeContent&nbsp;over&nbsp;io.Copy</span><br>
<span class="lineno">95</span><span class="comment" id="4073976">//&nbsp;is&nbsp;that&nbsp;it&nbsp;handles&nbsp;Range&nbsp;requests&nbsp;properly,&nbsp;sets&nbsp;the&nbsp;MIME&nbsp;type,&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4074047">//&nbsp;handles&nbsp;If-Modified-Since&nbsp;requests.</span><br>
<span class="lineno"></span><span class="comment" id="4074086">//</span><br>
<span class="lineno"></span><span class="comment" id="4074089">//&nbsp;If&nbsp;the&nbsp;response&#39;s&nbsp;Content-Type&nbsp;header&nbsp;is&nbsp;not&nbsp;set,&nbsp;ServeContent</span><br>
<span class="lineno"></span><span class="comment" id="4074155">//&nbsp;first&nbsp;tries&nbsp;to&nbsp;deduce&nbsp;the&nbsp;type&nbsp;from&nbsp;name&#39;s&nbsp;file&nbsp;extension&nbsp;and,</span><br>
<span class="lineno">100</span><span class="comment" id="4074221">//&nbsp;if&nbsp;that&nbsp;fails,&nbsp;falls&nbsp;back&nbsp;to&nbsp;reading&nbsp;the&nbsp;first&nbsp;block&nbsp;of&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="4074292">//&nbsp;and&nbsp;passing&nbsp;it&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span><span class="comment" id="4074332">//&nbsp;The&nbsp;name&nbsp;is&nbsp;otherwise&nbsp;unused;&nbsp;in&nbsp;particular&nbsp;it&nbsp;can&nbsp;be&nbsp;empty&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4074402">//&nbsp;never&nbsp;sent&nbsp;in&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="4074433">//</span><br>
<span class="lineno">105</span><span class="comment" id="4074436">//&nbsp;If&nbsp;modtime&nbsp;is&nbsp;not&nbsp;the&nbsp;zero&nbsp;time,&nbsp;ServeContent&nbsp;includes&nbsp;it&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4074502">//&nbsp;Last-Modified&nbsp;header&nbsp;in&nbsp;the&nbsp;response.&nbsp;&nbsp;If&nbsp;the&nbsp;request&nbsp;includes&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4074571">//&nbsp;If-Modified-Since&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;modtime&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span><span class="comment" id="4074636">//&nbsp;whether&nbsp;the&nbsp;content&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span><span class="comment" id="4074684">//</span><br>
<span class="lineno">110</span><span class="comment" id="4074687">//&nbsp;The&nbsp;content&#39;s&nbsp;Seek&nbsp;method&nbsp;must&nbsp;work:&nbsp;ServeContent&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="4074745">//&nbsp;a&nbsp;seek&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;content&nbsp;to&nbsp;determine&nbsp;its&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="4074804">//</span><br>
<span class="lineno"></span><span class="comment" id="4074807">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;has&nbsp;set&nbsp;w&#39;s&nbsp;ETag&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4074873">//&nbsp;handle&nbsp;requests&nbsp;using&nbsp;If-Range&nbsp;and&nbsp;If-None-Match.</span><br>
<span class="lineno">115</span><span class="comment" id="4074926">//</span><br>
<span class="lineno"></span><span class="comment" id="4074929">//&nbsp;Note&nbsp;that&nbsp;*os.File&nbsp;implements&nbsp;the&nbsp;io.ReadSeeker&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="4074991">func</span>&nbsp;<span class="ident" id="4074996">ServeContent</span><span class="op" id="4075008">(</span><span class="ident" id="4075009">w</span>&nbsp;<span class="ident" id="4075011">ResponseWriter</span><span class="op" id="4075025">,</span>&nbsp;<span class="ident" id="4075027">req</span>&nbsp;<span class="op" id="4075031">*</span><span class="ident" id="4075032">Request</span><span class="op" id="4075039">,</span>&nbsp;<span class="ident" id="4075041">name</span>&nbsp;<span class="builtintype" id="4075046">string</span><span class="op" id="4075052">,</span>&nbsp;<span class="ident" id="4075054">modtime</span>&nbsp;<span class="ident" id="4075062">time</span><span class="op" id="4075066">.</span><span class="ident" id="4075067">Time</span><span class="op" id="4075071">,</span>&nbsp;<span class="ident" id="4075073">content</span>&nbsp;<span class="ident" id="4075081">io</span><span class="op" id="4075083">.</span><span class="ident" id="4075084">ReadSeeker</span><span class="op" id="4075094">)</span>&nbsp;<span class="op" id="4075096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4075099">sizeFunc</span>&nbsp;<span class="op" id="4075108">:=</span>&nbsp;<span class="keyword" id="4075111">func</span><span class="op" id="4075115">(</span><span class="op" id="4075116">)</span>&nbsp;<span class="op" id="4075118">(</span><span class="ident" id="4075119">int64</span><span class="op" id="4075124">,</span>&nbsp;<span class="builtintype" id="4075126">error</span><span class="op" id="4075131">)</span>&nbsp;<span class="op" id="4075133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4075137">size</span><span class="op" id="4075141">,</span>&nbsp;<span class="ident" id="4075143">err</span>&nbsp;<span class="op" id="4075147">:=</span>&nbsp;<span class="ident" id="4075150">content</span><span class="op" id="4075157">.</span><span class="ident" id="4075158">Seek</span><span class="op" id="4075162">(</span><span class="num" id="4075163">0</span><span class="op" id="4075164">,</span>&nbsp;<span class="ident" id="4075166">os</span><span class="op" id="4075168">.</span><span class="ident" id="4075169">SEEK_END</span><span class="op" id="4075177">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4075181">if</span>&nbsp;<span class="ident" id="4075184">err</span>&nbsp;<span class="op" id="4075188">!=</span>&nbsp;<span class="builtintype" id="4075191">nil</span>&nbsp;<span class="op" id="4075195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4075200">return</span>&nbsp;<span class="num" id="4075207">0</span><span class="op" id="4075208">,</span>&nbsp;<span class="ident" id="4075210">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4075222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4075226">_</span><span class="op" id="4075227">,</span>&nbsp;<span class="ident" id="4075229">err</span>&nbsp;<span class="op" id="4075233">=</span>&nbsp;<span class="ident" id="4075235">content</span><span class="op" id="4075242">.</span><span class="ident" id="4075243">Seek</span><span class="op" id="4075247">(</span><span class="num" id="4075248">0</span><span class="op" id="4075249">,</span>&nbsp;<span class="ident" id="4075251">os</span><span class="op" id="4075253">.</span><span class="ident" id="4075254">SEEK_SET</span><span class="op" id="4075262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4075266">if</span>&nbsp;<span class="ident" id="4075269">err</span>&nbsp;<span class="op" id="4075273">!=</span>&nbsp;<span class="builtintype" id="4075276">nil</span>&nbsp;<span class="op" id="4075280">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4075285">return</span>&nbsp;<span class="num" id="4075292">0</span><span class="op" id="4075293">,</span>&nbsp;<span class="ident" id="4075295">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4075307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4075311">return</span>&nbsp;<span class="ident" id="4075318">size</span><span class="op" id="4075322">,</span>&nbsp;<span class="builtintype" id="4075324">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4075329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4075332">serveContent</span><span class="op" id="4075344">(</span><span class="ident" id="4075345">w</span><span class="op" id="4075346">,</span>&nbsp;<span class="ident" id="4075348">req</span><span class="op" id="4075351">,</span>&nbsp;<span class="ident" id="4075353">name</span><span class="op" id="4075357">,</span>&nbsp;<span class="ident" id="4075359">modtime</span><span class="op" id="4075366">,</span>&nbsp;<span class="ident" id="4075368">sizeFunc</span><span class="op" id="4075376">,</span>&nbsp;<span class="ident" id="4075378">content</span><span class="op" id="4075385">)</span><br>
<span class="lineno">130</span><span class="op" id="4075387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4075390">//&nbsp;errSeeker&nbsp;is&nbsp;returned&nbsp;by&nbsp;ServeContent&#39;s&nbsp;sizeFunc&nbsp;when&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="4075459">//&nbsp;doesn&#39;t&nbsp;seek&nbsp;properly.&nbsp;The&nbsp;underlying&nbsp;Seeker&#39;s&nbsp;error&nbsp;text&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="4075526">//&nbsp;included&nbsp;in&nbsp;the&nbsp;sizeFunc&nbsp;reply&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;sent&nbsp;over&nbsp;HTTP&nbsp;to&nbsp;end</span><br>
<span class="lineno">135</span><span class="comment" id="4075594">//&nbsp;users.</span><br>
<span class="lineno"></span><span class="keyword" id="4075604">var</span>&nbsp;<span class="ident" id="4075608">errSeeker</span>&nbsp;<span class="op" id="4075618">=</span>&nbsp;<span class="ident" id="4075620">errors</span><span class="op" id="4075626">.</span><span class="ident" id="4075627">New</span><span class="op" id="4075630">(</span><span class="string" id="4075631">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="4075650">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4075653">//&nbsp;if&nbsp;name&nbsp;is&nbsp;empty,&nbsp;filename&nbsp;is&nbsp;unknown.&nbsp;(used&nbsp;for&nbsp;mime&nbsp;type,&nbsp;before&nbsp;sniffing)</span><br>
<span class="lineno"></span><span class="comment" id="4075733">//&nbsp;if&nbsp;modtime.IsZero(),&nbsp;modtime&nbsp;is&nbsp;unknown.</span><br>
<span class="lineno">140</span><span class="comment" id="4075777">//&nbsp;content&nbsp;must&nbsp;be&nbsp;seeked&nbsp;to&nbsp;the&nbsp;beginning&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="4075833">//&nbsp;The&nbsp;sizeFunc&nbsp;is&nbsp;called&nbsp;at&nbsp;most&nbsp;once.&nbsp;Its&nbsp;error,&nbsp;if&nbsp;any,&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4075922">func</span>&nbsp;<span class="ident" id="4075927">serveContent</span><span class="op" id="4075939">(</span><span class="ident" id="4075940">w</span>&nbsp;<span class="ident" id="4075942">ResponseWriter</span><span class="op" id="4075956">,</span>&nbsp;<span class="ident" id="4075958">r</span>&nbsp;<span class="op" id="4075960">*</span><span class="ident" id="4075961">Request</span><span class="op" id="4075968">,</span>&nbsp;<span class="ident" id="4075970">name</span>&nbsp;<span class="builtintype" id="4075975">string</span><span class="op" id="4075981">,</span>&nbsp;<span class="ident" id="4075983">modtime</span>&nbsp;<span class="ident" id="4075991">time</span><span class="op" id="4075995">.</span><span class="ident" id="4075996">Time</span><span class="op" id="4076000">,</span>&nbsp;<span class="ident" id="4076002">sizeFunc</span>&nbsp;<span class="keyword" id="4076011">func</span><span class="op" id="4076015">(</span><span class="op" id="4076016">)</span>&nbsp;<span class="op" id="4076018">(</span><span class="ident" id="4076019">int64</span><span class="op" id="4076024">,</span>&nbsp;<span class="builtintype" id="4076026">error</span><span class="op" id="4076031">)</span><span class="op" id="4076032">,</span>&nbsp;<span class="ident" id="4076034">content</span>&nbsp;<span class="ident" id="4076042">io</span><span class="op" id="4076044">.</span><span class="ident" id="4076045">ReadSeeker</span><span class="op" id="4076055">)</span>&nbsp;<span class="op" id="4076057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4076060">if</span>&nbsp;<span class="ident" id="4076063">checkLastModified</span><span class="op" id="4076080">(</span><span class="ident" id="4076081">w</span><span class="op" id="4076082">,</span>&nbsp;<span class="ident" id="4076084">r</span><span class="op" id="4076085">,</span>&nbsp;<span class="ident" id="4076087">modtime</span><span class="op" id="4076094">)</span>&nbsp;<span class="op" id="4076096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4076100">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4076108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4076111">rangeReq</span><span class="op" id="4076119">,</span>&nbsp;<span class="ident" id="4076121">done</span>&nbsp;<span class="op" id="4076126">:=</span>&nbsp;<span class="ident" id="4076129">checkETag</span><span class="op" id="4076138">(</span><span class="ident" id="4076139">w</span><span class="op" id="4076140">,</span>&nbsp;<span class="ident" id="4076142">r</span><span class="op" id="4076143">,</span>&nbsp;<span class="ident" id="4076145">modtime</span><span class="op" id="4076152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4076155">if</span>&nbsp;<span class="ident" id="4076158">done</span>&nbsp;<span class="op" id="4076163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4076167">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4076175">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4076179">code</span>&nbsp;<span class="op" id="4076184">:=</span>&nbsp;<span class="ident" id="4076187">StatusOK</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4076198">//&nbsp;If&nbsp;Content-Type&nbsp;isn&#39;t&nbsp;set,&nbsp;use&nbsp;the&nbsp;file&#39;s&nbsp;extension&nbsp;to&nbsp;find&nbsp;it,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4076270">//&nbsp;if&nbsp;the&nbsp;Content-Type&nbsp;is&nbsp;unset&nbsp;explicitly,&nbsp;do&nbsp;not&nbsp;sniff&nbsp;the&nbsp;type.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4076338">ctypes</span><span class="op" id="4076344">,</span>&nbsp;<span class="ident" id="4076346">haveType</span>&nbsp;<span class="op" id="4076355">:=</span>&nbsp;<span class="ident" id="4076358">w</span><span class="op" id="4076359">.</span><span class="ident" id="4076360">Header</span><span class="op" id="4076366">(</span><span class="op" id="4076367">)</span><span class="op" id="4076368">[</span><span class="string" id="4076369">&#34;Content-Type&#34;</span><span class="op" id="4076383">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4076386">var</span>&nbsp;<span class="ident" id="4076390">ctype</span>&nbsp;<span class="builtintype" id="4076396">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4076404">if</span>&nbsp;<span class="op" id="4076407">!</span><span class="ident" id="4076408">haveType</span>&nbsp;<span class="op" id="4076417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4076421">ctype</span>&nbsp;<span class="op" id="4076427">=</span>&nbsp;<span class="ident" id="4076429">mime</span><span class="op" id="4076433">.</span><span class="ident" id="4076434">TypeByExtension</span><span class="op" id="4076449">(</span><span class="ident" id="4076450">filepath</span><span class="op" id="4076458">.</span><span class="ident" id="4076459">Ext</span><span class="op" id="4076462">(</span><span class="ident" id="4076463">name</span><span class="op" id="4076467">)</span><span class="op" id="4076468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4076472">if</span>&nbsp;<span class="ident" id="4076475">ctype</span>&nbsp;<span class="op" id="4076481">==</span>&nbsp;<span class="string" id="4076484">&#34;&#34;</span>&nbsp;<span class="op" id="4076487">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4076492">//&nbsp;read&nbsp;a&nbsp;chunk&nbsp;to&nbsp;decide&nbsp;between&nbsp;utf-8&nbsp;text&nbsp;and&nbsp;binary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4076551">var</span>&nbsp;<span class="ident" id="4076555">buf</span>&nbsp;<span class="op" id="4076559">[</span><span class="ident" id="4076560">sniffLen</span><span class="op" id="4076568">]</span><span class="builtintype" id="4076569">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4076577">n</span><span class="op" id="4076578">,</span>&nbsp;<span class="ident" id="4076580">_</span>&nbsp;<span class="op" id="4076582">:=</span>&nbsp;<span class="ident" id="4076585">io</span><span class="op" id="4076587">.</span><span class="ident" id="4076588">ReadFull</span><span class="op" id="4076596">(</span><span class="ident" id="4076597">content</span><span class="op" id="4076604">,</span>&nbsp;<span class="ident" id="4076606">buf</span><span class="op" id="4076609">[</span><span class="op" id="4076610">:</span><span class="op" id="4076611">]</span><span class="op" id="4076612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4076617">ctype</span>&nbsp;<span class="op" id="4076623">=</span>&nbsp;<span class="ident" id="4076625">DetectContentType</span><span class="op" id="4076642">(</span><span class="ident" id="4076643">buf</span><span class="op" id="4076646">[</span><span class="op" id="4076647">:</span><span class="ident" id="4076648">n</span><span class="op" id="4076649">]</span><span class="op" id="4076650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4076655">_</span><span class="op" id="4076656">,</span>&nbsp;<span class="ident" id="4076658">err</span>&nbsp;<span class="op" id="4076662">:=</span>&nbsp;<span class="ident" id="4076665">content</span><span class="op" id="4076672">.</span><span class="ident" id="4076673">Seek</span><span class="op" id="4076677">(</span><span class="num" id="4076678">0</span><span class="op" id="4076679">,</span>&nbsp;<span class="ident" id="4076681">os</span><span class="op" id="4076683">.</span><span class="ident" id="4076684">SEEK_SET</span><span class="op" id="4076692">)</span>&nbsp;<span class="comment" id="4076694">//&nbsp;rewind&nbsp;to&nbsp;output&nbsp;whole&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4076728">if</span>&nbsp;<span class="ident" id="4076731">err</span>&nbsp;<span class="op" id="4076735">!=</span>&nbsp;<span class="builtintype" id="4076738">nil</span>&nbsp;<span class="op" id="4076742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4076748">Error</span><span class="op" id="4076753">(</span><span class="ident" id="4076754">w</span><span class="op" id="4076755">,</span>&nbsp;<span class="string" id="4076757">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="4076776">,</span>&nbsp;<span class="ident" id="4076778">StatusInternalServerError</span><span class="op" id="4076803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4076809">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4076819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4076823">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4076827">w</span><span class="op" id="4076828">.</span><span class="ident" id="4076829">Header</span><span class="op" id="4076835">(</span><span class="op" id="4076836">)</span><span class="op" id="4076837">.</span><span class="ident" id="4076838">Set</span><span class="op" id="4076841">(</span><span class="string" id="4076842">&#34;Content-Type&#34;</span><span class="op" id="4076856">,</span>&nbsp;<span class="ident" id="4076858">ctype</span><span class="op" id="4076863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4076866">}</span>&nbsp;<span class="keyword" id="4076868">else</span>&nbsp;<span class="keyword" id="4076873">if</span>&nbsp;<span class="builtinfunc" id="4076876">len</span><span class="op" id="4076879">(</span><span class="ident" id="4076880">ctypes</span><span class="op" id="4076886">)</span>&nbsp;<span class="op" id="4076888">&gt;</span>&nbsp;<span class="num" id="4076890">0</span>&nbsp;<span class="op" id="4076892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4076896">ctype</span>&nbsp;<span class="op" id="4076902">=</span>&nbsp;<span class="ident" id="4076904">ctypes</span><span class="op" id="4076910">[</span><span class="num" id="4076911">0</span><span class="op" id="4076912">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4076915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4076919">size</span><span class="op" id="4076923">,</span>&nbsp;<span class="ident" id="4076925">err</span>&nbsp;<span class="op" id="4076929">:=</span>&nbsp;<span class="ident" id="4076932">sizeFunc</span><span class="op" id="4076940">(</span><span class="op" id="4076941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4076944">if</span>&nbsp;<span class="ident" id="4076947">err</span>&nbsp;<span class="op" id="4076951">!=</span>&nbsp;<span class="builtintype" id="4076954">nil</span>&nbsp;<span class="op" id="4076958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4076962">Error</span><span class="op" id="4076967">(</span><span class="ident" id="4076968">w</span><span class="op" id="4076969">,</span>&nbsp;<span class="ident" id="4076971">err</span><span class="op" id="4076974">.</span><span class="ident" id="4076975">Error</span><span class="op" id="4076980">(</span><span class="op" id="4076981">)</span><span class="op" id="4076982">,</span>&nbsp;<span class="ident" id="4076984">StatusInternalServerError</span><span class="op" id="4077009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4077013">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4077021">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4077025">//&nbsp;handle&nbsp;Content-Range&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4077058">sendSize</span>&nbsp;<span class="op" id="4077067">:=</span>&nbsp;<span class="ident" id="4077070">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4077076">var</span>&nbsp;<span class="ident" id="4077080">sendContent</span>&nbsp;<span class="ident" id="4077092">io</span><span class="op" id="4077094">.</span><span class="ident" id="4077095">Reader</span>&nbsp;<span class="op" id="4077102">=</span>&nbsp;<span class="ident" id="4077104">content</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4077113">if</span>&nbsp;<span class="ident" id="4077116">size</span>&nbsp;<span class="op" id="4077121">&gt;=</span>&nbsp;<span class="num" id="4077124">0</span>&nbsp;<span class="op" id="4077126">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4077130">ranges</span><span class="op" id="4077136">,</span>&nbsp;<span class="ident" id="4077138">err</span>&nbsp;<span class="op" id="4077142">:=</span>&nbsp;<span class="ident" id="4077145">parseRange</span><span class="op" id="4077155">(</span><span class="ident" id="4077156">rangeReq</span><span class="op" id="4077164">,</span>&nbsp;<span class="ident" id="4077166">size</span><span class="op" id="4077170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4077174">if</span>&nbsp;<span class="ident" id="4077177">err</span>&nbsp;<span class="op" id="4077181">!=</span>&nbsp;<span class="builtintype" id="4077184">nil</span>&nbsp;<span class="op" id="4077188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4077193">Error</span><span class="op" id="4077198">(</span><span class="ident" id="4077199">w</span><span class="op" id="4077200">,</span>&nbsp;<span class="ident" id="4077202">err</span><span class="op" id="4077205">.</span><span class="ident" id="4077206">Error</span><span class="op" id="4077211">(</span><span class="op" id="4077212">)</span><span class="op" id="4077213">,</span>&nbsp;<span class="ident" id="4077215">StatusRequestedRangeNotSatisfiable</span><span class="op" id="4077249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4077254">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4077263">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4077267">if</span>&nbsp;<span class="ident" id="4077270">sumRangesSize</span><span class="op" id="4077283">(</span><span class="ident" id="4077284">ranges</span><span class="op" id="4077290">)</span>&nbsp;<span class="op" id="4077292">&gt;</span>&nbsp;<span class="ident" id="4077294">size</span>&nbsp;<span class="op" id="4077299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4077304">//&nbsp;The&nbsp;total&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;all&nbsp;the&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4077354">//&nbsp;is&nbsp;larger&nbsp;than&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;file&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4077399">//&nbsp;itself,&nbsp;so&nbsp;this&nbsp;is&nbsp;probably&nbsp;an&nbsp;attack,&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4077449">//&nbsp;dumb&nbsp;client.&nbsp;&nbsp;Ignore&nbsp;the&nbsp;range&nbsp;request.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4077495">ranges</span>&nbsp;<span class="op" id="4077502">=</span>&nbsp;<span class="builtintype" id="4077504">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4077510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4077514">switch</span>&nbsp;<span class="op" id="4077521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4077525">case</span>&nbsp;<span class="builtinfunc" id="4077530">len</span><span class="op" id="4077533">(</span><span class="ident" id="4077534">ranges</span><span class="op" id="4077540">)</span>&nbsp;<span class="op" id="4077542">==</span>&nbsp;<span class="num" id="4077545">1</span><span class="op" id="4077546">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4077551">//&nbsp;RFC&nbsp;2616,&nbsp;Section&nbsp;14.16:</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4077582">//&nbsp;&#34;When&nbsp;an&nbsp;HTTP&nbsp;message&nbsp;includes&nbsp;the&nbsp;content&nbsp;of&nbsp;a&nbsp;single</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4077643">//&nbsp;range&nbsp;(for&nbsp;example,&nbsp;a&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4077699">//&nbsp;single&nbsp;range,&nbsp;or&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;set&nbsp;of&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4077755">//&nbsp;that&nbsp;overlap&nbsp;without&nbsp;any&nbsp;holes),&nbsp;this&nbsp;content&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4077810">//&nbsp;transmitted&nbsp;with&nbsp;a&nbsp;Content-Range&nbsp;header,&nbsp;and&nbsp;a</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4077863">//&nbsp;Content-Length&nbsp;header&nbsp;showing&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4077919">//&nbsp;actually&nbsp;transferred.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4077947">//&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4077957">//&nbsp;A&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;single&nbsp;range&nbsp;MUST&nbsp;NOT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4078015">//&nbsp;be&nbsp;sent&nbsp;using&nbsp;the&nbsp;multipart/byteranges&nbsp;media&nbsp;type.&#34;</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4078073">ra</span>&nbsp;<span class="op" id="4078076">:=</span>&nbsp;<span class="ident" id="4078079">ranges</span><span class="op" id="4078085">[</span><span class="num" id="4078086">0</span><span class="op" id="4078087">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4078092">if</span>&nbsp;<span class="ident" id="4078095">_</span><span class="op" id="4078096">,</span>&nbsp;<span class="ident" id="4078098">err</span>&nbsp;<span class="op" id="4078102">:=</span>&nbsp;<span class="ident" id="4078105">content</span><span class="op" id="4078112">.</span><span class="ident" id="4078113">Seek</span><span class="op" id="4078117">(</span><span class="ident" id="4078118">ra</span><span class="op" id="4078120">.</span><span class="ident" id="4078121">start</span><span class="op" id="4078126">,</span>&nbsp;<span class="ident" id="4078128">os</span><span class="op" id="4078130">.</span><span class="ident" id="4078131">SEEK_SET</span><span class="op" id="4078139">)</span><span class="op" id="4078140">;</span>&nbsp;<span class="ident" id="4078142">err</span>&nbsp;<span class="op" id="4078146">!=</span>&nbsp;<span class="builtintype" id="4078149">nil</span>&nbsp;<span class="op" id="4078153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4078159">Error</span><span class="op" id="4078164">(</span><span class="ident" id="4078165">w</span><span class="op" id="4078166">,</span>&nbsp;<span class="ident" id="4078168">err</span><span class="op" id="4078171">.</span><span class="ident" id="4078172">Error</span><span class="op" id="4078177">(</span><span class="op" id="4078178">)</span><span class="op" id="4078179">,</span>&nbsp;<span class="ident" id="4078181">StatusRequestedRangeNotSatisfiable</span><span class="op" id="4078215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4078221">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4078231">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4078236">sendSize</span>&nbsp;<span class="op" id="4078245">=</span>&nbsp;<span class="ident" id="4078247">ra</span><span class="op" id="4078249">.</span><span class="ident" id="4078250">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4078260">code</span>&nbsp;<span class="op" id="4078265">=</span>&nbsp;<span class="ident" id="4078267">StatusPartialContent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4078291">w</span><span class="op" id="4078292">.</span><span class="ident" id="4078293">Header</span><span class="op" id="4078299">(</span><span class="op" id="4078300">)</span><span class="op" id="4078301">.</span><span class="ident" id="4078302">Set</span><span class="op" id="4078305">(</span><span class="string" id="4078306">&#34;Content-Range&#34;</span><span class="op" id="4078321">,</span>&nbsp;<span class="ident" id="4078323">ra</span><span class="op" id="4078325">.</span><span class="ident" id="4078326">contentRange</span><span class="op" id="4078338">(</span><span class="ident" id="4078339">size</span><span class="op" id="4078343">)</span><span class="op" id="4078344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4078348">case</span>&nbsp;<span class="builtinfunc" id="4078353">len</span><span class="op" id="4078356">(</span><span class="ident" id="4078357">ranges</span><span class="op" id="4078363">)</span>&nbsp;<span class="op" id="4078365">&gt;</span>&nbsp;<span class="num" id="4078367">1</span><span class="op" id="4078368">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4078373">sendSize</span>&nbsp;<span class="op" id="4078382">=</span>&nbsp;<span class="ident" id="4078384">rangesMIMESize</span><span class="op" id="4078398">(</span><span class="ident" id="4078399">ranges</span><span class="op" id="4078405">,</span>&nbsp;<span class="ident" id="4078407">ctype</span><span class="op" id="4078412">,</span>&nbsp;<span class="ident" id="4078414">size</span><span class="op" id="4078418">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4078423">code</span>&nbsp;<span class="op" id="4078428">=</span>&nbsp;<span class="ident" id="4078430">StatusPartialContent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4078455">pr</span><span class="op" id="4078457">,</span>&nbsp;<span class="ident" id="4078459">pw</span>&nbsp;<span class="op" id="4078462">:=</span>&nbsp;<span class="ident" id="4078465">io</span><span class="op" id="4078467">.</span><span class="ident" id="4078468">Pipe</span><span class="op" id="4078472">(</span><span class="op" id="4078473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4078478">mw</span>&nbsp;<span class="op" id="4078481">:=</span>&nbsp;<span class="ident" id="4078484">multipart</span><span class="op" id="4078493">.</span><span class="ident" id="4078494">NewWriter</span><span class="op" id="4078503">(</span><span class="ident" id="4078504">pw</span><span class="op" id="4078506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4078511">w</span><span class="op" id="4078512">.</span><span class="ident" id="4078513">Header</span><span class="op" id="4078519">(</span><span class="op" id="4078520">)</span><span class="op" id="4078521">.</span><span class="ident" id="4078522">Set</span><span class="op" id="4078525">(</span><span class="string" id="4078526">&#34;Content-Type&#34;</span><span class="op" id="4078540">,</span>&nbsp;<span class="string" id="4078542">&#34;multipart/byteranges;&nbsp;boundary=&#34;</span><span class="op" id="4078575">+</span><span class="ident" id="4078576">mw</span><span class="op" id="4078578">.</span><span class="ident" id="4078579">Boundary</span><span class="op" id="4078587">(</span><span class="op" id="4078588">)</span><span class="op" id="4078589">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4078594">sendContent</span>&nbsp;<span class="op" id="4078606">=</span>&nbsp;<span class="ident" id="4078608">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4078614">defer</span>&nbsp;<span class="ident" id="4078620">pr</span><span class="op" id="4078622">.</span><span class="ident" id="4078623">Close</span><span class="op" id="4078628">(</span><span class="op" id="4078629">)</span>&nbsp;<span class="comment" id="4078631">//&nbsp;cause&nbsp;writing&nbsp;goroutine&nbsp;to&nbsp;fail&nbsp;and&nbsp;exit&nbsp;if&nbsp;CopyN&nbsp;doesn&#39;t&nbsp;finish.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4078703">go</span>&nbsp;<span class="keyword" id="4078706">func</span><span class="op" id="4078710">(</span><span class="op" id="4078711">)</span>&nbsp;<span class="op" id="4078713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4078719">for</span>&nbsp;<span class="ident" id="4078723">_</span><span class="op" id="4078724">,</span>&nbsp;<span class="ident" id="4078726">ra</span>&nbsp;<span class="op" id="4078729">:=</span>&nbsp;<span class="keyword" id="4078732">range</span>&nbsp;<span class="ident" id="4078738">ranges</span>&nbsp;<span class="op" id="4078745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4078752">part</span><span class="op" id="4078756">,</span>&nbsp;<span class="ident" id="4078758">err</span>&nbsp;<span class="op" id="4078762">:=</span>&nbsp;<span class="ident" id="4078765">mw</span><span class="op" id="4078767">.</span><span class="ident" id="4078768">CreatePart</span><span class="op" id="4078778">(</span><span class="ident" id="4078779">ra</span><span class="op" id="4078781">.</span><span class="ident" id="4078782">mimeHeader</span><span class="op" id="4078792">(</span><span class="ident" id="4078793">ctype</span><span class="op" id="4078798">,</span>&nbsp;<span class="ident" id="4078800">size</span><span class="op" id="4078804">)</span><span class="op" id="4078805">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4078812">if</span>&nbsp;<span class="ident" id="4078815">err</span>&nbsp;<span class="op" id="4078819">!=</span>&nbsp;<span class="builtintype" id="4078822">nil</span>&nbsp;<span class="op" id="4078826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4078834">pw</span><span class="op" id="4078836">.</span><span class="ident" id="4078837">CloseWithError</span><span class="op" id="4078851">(</span><span class="ident" id="4078852">err</span><span class="op" id="4078855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4078863">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4078875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4078882">if</span>&nbsp;<span class="ident" id="4078885">_</span><span class="op" id="4078886">,</span>&nbsp;<span class="ident" id="4078888">err</span>&nbsp;<span class="op" id="4078892">:=</span>&nbsp;<span class="ident" id="4078895">content</span><span class="op" id="4078902">.</span><span class="ident" id="4078903">Seek</span><span class="op" id="4078907">(</span><span class="ident" id="4078908">ra</span><span class="op" id="4078910">.</span><span class="ident" id="4078911">start</span><span class="op" id="4078916">,</span>&nbsp;<span class="ident" id="4078918">os</span><span class="op" id="4078920">.</span><span class="ident" id="4078921">SEEK_SET</span><span class="op" id="4078929">)</span><span class="op" id="4078930">;</span>&nbsp;<span class="ident" id="4078932">err</span>&nbsp;<span class="op" id="4078936">!=</span>&nbsp;<span class="builtintype" id="4078939">nil</span>&nbsp;<span class="op" id="4078943">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4078951">pw</span><span class="op" id="4078953">.</span><span class="ident" id="4078954">CloseWithError</span><span class="op" id="4078968">(</span><span class="ident" id="4078969">err</span><span class="op" id="4078972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4078980">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4078992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4078999">if</span>&nbsp;<span class="ident" id="4079002">_</span><span class="op" id="4079003">,</span>&nbsp;<span class="ident" id="4079005">err</span>&nbsp;<span class="op" id="4079009">:=</span>&nbsp;<span class="ident" id="4079012">io</span><span class="op" id="4079014">.</span><span class="ident" id="4079015">CopyN</span><span class="op" id="4079020">(</span><span class="ident" id="4079021">part</span><span class="op" id="4079025">,</span>&nbsp;<span class="ident" id="4079027">content</span><span class="op" id="4079034">,</span>&nbsp;<span class="ident" id="4079036">ra</span><span class="op" id="4079038">.</span><span class="ident" id="4079039">length</span><span class="op" id="4079045">)</span><span class="op" id="4079046">;</span>&nbsp;<span class="ident" id="4079048">err</span>&nbsp;<span class="op" id="4079052">!=</span>&nbsp;<span class="builtintype" id="4079055">nil</span>&nbsp;<span class="op" id="4079059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4079067">pw</span><span class="op" id="4079069">.</span><span class="ident" id="4079070">CloseWithError</span><span class="op" id="4079084">(</span><span class="ident" id="4079085">err</span><span class="op" id="4079088">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4079096">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4079108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4079114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4079120">mw</span><span class="op" id="4079122">.</span><span class="ident" id="4079123">Close</span><span class="op" id="4079128">(</span><span class="op" id="4079129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4079135">pw</span><span class="op" id="4079137">.</span><span class="ident" id="4079138">Close</span><span class="op" id="4079143">(</span><span class="op" id="4079144">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4079149">}</span><span class="op" id="4079150">(</span><span class="op" id="4079151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4079155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4079160">w</span><span class="op" id="4079161">.</span><span class="ident" id="4079162">Header</span><span class="op" id="4079168">(</span><span class="op" id="4079169">)</span><span class="op" id="4079170">.</span><span class="ident" id="4079171">Set</span><span class="op" id="4079174">(</span><span class="string" id="4079175">&#34;Accept-Ranges&#34;</span><span class="op" id="4079190">,</span>&nbsp;<span class="string" id="4079192">&#34;bytes&#34;</span><span class="op" id="4079199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4079203">if</span>&nbsp;<span class="ident" id="4079206">w</span><span class="op" id="4079207">.</span><span class="ident" id="4079208">Header</span><span class="op" id="4079214">(</span><span class="op" id="4079215">)</span><span class="op" id="4079216">.</span><span class="ident" id="4079217">Get</span><span class="op" id="4079220">(</span><span class="string" id="4079221">&#34;Content-Encoding&#34;</span><span class="op" id="4079239">)</span>&nbsp;<span class="op" id="4079241">==</span>&nbsp;<span class="string" id="4079244">&#34;&#34;</span>&nbsp;<span class="op" id="4079247">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4079252">w</span><span class="op" id="4079253">.</span><span class="ident" id="4079254">Header</span><span class="op" id="4079260">(</span><span class="op" id="4079261">)</span><span class="op" id="4079262">.</span><span class="ident" id="4079263">Set</span><span class="op" id="4079266">(</span><span class="string" id="4079267">&#34;Content-Length&#34;</span><span class="op" id="4079283">,</span>&nbsp;<span class="ident" id="4079285">strconv</span><span class="op" id="4079292">.</span><span class="ident" id="4079293">FormatInt</span><span class="op" id="4079302">(</span><span class="ident" id="4079303">sendSize</span><span class="op" id="4079311">,</span>&nbsp;<span class="num" id="4079313">10</span><span class="op" id="4079315">)</span><span class="op" id="4079316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4079320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4079323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4079327">w</span><span class="op" id="4079328">.</span><span class="ident" id="4079329">WriteHeader</span><span class="op" id="4079340">(</span><span class="ident" id="4079341">code</span><span class="op" id="4079345">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4079349">if</span>&nbsp;<span class="ident" id="4079352">r</span><span class="op" id="4079353">.</span><span class="ident" id="4079354">Method</span>&nbsp;<span class="op" id="4079361">!=</span>&nbsp;<span class="string" id="4079364">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4079371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4079375">io</span><span class="op" id="4079377">.</span><span class="ident" id="4079378">CopyN</span><span class="op" id="4079383">(</span><span class="ident" id="4079384">w</span><span class="op" id="4079385">,</span>&nbsp;<span class="ident" id="4079387">sendContent</span><span class="op" id="4079398">,</span>&nbsp;<span class="ident" id="4079400">sendSize</span><span class="op" id="4079408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4079411">}</span><br>
<span class="lineno"></span><span class="op" id="4079413">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="4079416">//&nbsp;modtime&nbsp;is&nbsp;the&nbsp;modification&nbsp;time&nbsp;of&nbsp;the&nbsp;resource&nbsp;to&nbsp;be&nbsp;served,&nbsp;or&nbsp;IsZero().</span><br>
<span class="lineno"></span><span class="comment" id="4079495">//&nbsp;return&nbsp;value&nbsp;is&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;complete.</span><br>
<span class="lineno"></span><span class="keyword" id="4079552">func</span>&nbsp;<span class="ident" id="4079557">checkLastModified</span><span class="op" id="4079574">(</span><span class="ident" id="4079575">w</span>&nbsp;<span class="ident" id="4079577">ResponseWriter</span><span class="op" id="4079591">,</span>&nbsp;<span class="ident" id="4079593">r</span>&nbsp;<span class="op" id="4079595">*</span><span class="ident" id="4079596">Request</span><span class="op" id="4079603">,</span>&nbsp;<span class="ident" id="4079605">modtime</span>&nbsp;<span class="ident" id="4079613">time</span><span class="op" id="4079617">.</span><span class="ident" id="4079618">Time</span><span class="op" id="4079622">)</span>&nbsp;<span class="builtintype" id="4079624">bool</span>&nbsp;<span class="op" id="4079629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4079632">if</span>&nbsp;<span class="ident" id="4079635">modtime</span><span class="op" id="4079642">.</span><span class="ident" id="4079643">IsZero</span><span class="op" id="4079649">(</span><span class="op" id="4079650">)</span>&nbsp;<span class="op" id="4079652">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4079656">return</span>&nbsp;<span class="builtintype" id="4079663">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4079670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4079674">//&nbsp;The&nbsp;Date-Modified&nbsp;header&nbsp;truncates&nbsp;sub-second&nbsp;precision,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4079738">//&nbsp;use&nbsp;mtime&nbsp;&lt;&nbsp;t+1s&nbsp;instead&nbsp;of&nbsp;mtime&nbsp;&lt;=&nbsp;t&nbsp;to&nbsp;check&nbsp;for&nbsp;unmodified.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4079806">if</span>&nbsp;<span class="ident" id="4079809">t</span><span class="op" id="4079810">,</span>&nbsp;<span class="ident" id="4079812">err</span>&nbsp;<span class="op" id="4079816">:=</span>&nbsp;<span class="ident" id="4079819">time</span><span class="op" id="4079823">.</span><span class="ident" id="4079824">Parse</span><span class="op" id="4079829">(</span><span class="ident" id="4079830">TimeFormat</span><span class="op" id="4079840">,</span>&nbsp;<span class="ident" id="4079842">r</span><span class="op" id="4079843">.</span><span class="ident" id="4079844">Header</span><span class="op" id="4079850">.</span><span class="ident" id="4079851">Get</span><span class="op" id="4079854">(</span><span class="string" id="4079855">&#34;If-Modified-Since&#34;</span><span class="op" id="4079874">)</span><span class="op" id="4079875">)</span><span class="op" id="4079876">;</span>&nbsp;<span class="ident" id="4079878">err</span>&nbsp;<span class="op" id="4079882">==</span>&nbsp;<span class="builtintype" id="4079885">nil</span>&nbsp;<span class="op" id="4079889">&amp;&amp;</span>&nbsp;<span class="ident" id="4079892">modtime</span><span class="op" id="4079899">.</span><span class="ident" id="4079900">Before</span><span class="op" id="4079906">(</span><span class="ident" id="4079907">t</span><span class="op" id="4079908">.</span><span class="ident" id="4079909">Add</span><span class="op" id="4079912">(</span><span class="num" id="4079913">1</span><span class="op" id="4079914">*</span><span class="ident" id="4079915">time</span><span class="op" id="4079919">.</span><span class="ident" id="4079920">Second</span><span class="op" id="4079926">)</span><span class="op" id="4079927">)</span>&nbsp;<span class="op" id="4079929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4079933">h</span>&nbsp;<span class="op" id="4079935">:=</span>&nbsp;<span class="ident" id="4079938">w</span><span class="op" id="4079939">.</span><span class="ident" id="4079940">Header</span><span class="op" id="4079946">(</span><span class="op" id="4079947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4079951">delete</span><span class="op" id="4079957">(</span><span class="ident" id="4079958">h</span><span class="op" id="4079959">,</span>&nbsp;<span class="string" id="4079961">&#34;Content-Type&#34;</span><span class="op" id="4079975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4079979">delete</span><span class="op" id="4079985">(</span><span class="ident" id="4079986">h</span><span class="op" id="4079987">,</span>&nbsp;<span class="string" id="4079989">&#34;Content-Length&#34;</span><span class="op" id="4080005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4080009">w</span><span class="op" id="4080010">.</span><span class="ident" id="4080011">WriteHeader</span><span class="op" id="4080022">(</span><span class="ident" id="4080023">StatusNotModified</span><span class="op" id="4080040">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4080044">return</span>&nbsp;<span class="builtintype" id="4080051">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4080057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4080060">w</span><span class="op" id="4080061">.</span><span class="ident" id="4080062">Header</span><span class="op" id="4080068">(</span><span class="op" id="4080069">)</span><span class="op" id="4080070">.</span><span class="ident" id="4080071">Set</span><span class="op" id="4080074">(</span><span class="string" id="4080075">&#34;Last-Modified&#34;</span><span class="op" id="4080090">,</span>&nbsp;<span class="ident" id="4080092">modtime</span><span class="op" id="4080099">.</span><span class="ident" id="4080100">UTC</span><span class="op" id="4080103">(</span><span class="op" id="4080104">)</span><span class="op" id="4080105">.</span><span class="ident" id="4080106">Format</span><span class="op" id="4080112">(</span><span class="ident" id="4080113">TimeFormat</span><span class="op" id="4080123">)</span><span class="op" id="4080124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4080127">return</span>&nbsp;<span class="builtintype" id="4080134">false</span><br>
<span class="lineno"></span><span class="op" id="4080140">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="4080143">//&nbsp;checkETag&nbsp;implements&nbsp;If-None-Match&nbsp;and&nbsp;If-Range&nbsp;checks.</span><br>
<span class="lineno"></span><span class="comment" id="4080202">//</span><br>
<span class="lineno"></span><span class="comment" id="4080205">//&nbsp;The&nbsp;ETag&nbsp;or&nbsp;modtime&nbsp;must&nbsp;have&nbsp;been&nbsp;previously&nbsp;set&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4080265">//&nbsp;ResponseWriter&#39;s&nbsp;headers.&nbsp;&nbsp;The&nbsp;modtime&nbsp;is&nbsp;only&nbsp;compared&nbsp;at&nbsp;second</span><br>
<span class="lineno">285</span><span class="comment" id="4080334">//&nbsp;granularity&nbsp;and&nbsp;may&nbsp;be&nbsp;the&nbsp;zero&nbsp;value&nbsp;to&nbsp;mean&nbsp;unknown.</span><br>
<span class="lineno"></span><span class="comment" id="4080392">//</span><br>
<span class="lineno"></span><span class="comment" id="4080395">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;effective&nbsp;request&nbsp;&#34;Range&#34;&nbsp;header&nbsp;to&nbsp;use&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4080466">//&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;considered&nbsp;done.</span><br>
<span class="lineno"></span><span class="keyword" id="4080514">func</span>&nbsp;<span class="ident" id="4080519">checkETag</span><span class="op" id="4080528">(</span><span class="ident" id="4080529">w</span>&nbsp;<span class="ident" id="4080531">ResponseWriter</span><span class="op" id="4080545">,</span>&nbsp;<span class="ident" id="4080547">r</span>&nbsp;<span class="op" id="4080549">*</span><span class="ident" id="4080550">Request</span><span class="op" id="4080557">,</span>&nbsp;<span class="ident" id="4080559">modtime</span>&nbsp;<span class="ident" id="4080567">time</span><span class="op" id="4080571">.</span><span class="ident" id="4080572">Time</span><span class="op" id="4080576">)</span>&nbsp;<span class="op" id="4080578">(</span><span class="ident" id="4080579">rangeReq</span>&nbsp;<span class="builtintype" id="4080588">string</span><span class="op" id="4080594">,</span>&nbsp;<span class="ident" id="4080596">done</span>&nbsp;<span class="builtintype" id="4080601">bool</span><span class="op" id="4080605">)</span>&nbsp;<span class="op" id="4080607">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4080610">etag</span>&nbsp;<span class="op" id="4080615">:=</span>&nbsp;<span class="ident" id="4080618">w</span><span class="op" id="4080619">.</span><span class="ident" id="4080620">Header</span><span class="op" id="4080626">(</span><span class="op" id="4080627">)</span><span class="op" id="4080628">.</span><span class="ident" id="4080629">get</span><span class="op" id="4080632">(</span><span class="string" id="4080633">&#34;Etag&#34;</span><span class="op" id="4080639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4080642">rangeReq</span>&nbsp;<span class="op" id="4080651">=</span>&nbsp;<span class="ident" id="4080653">r</span><span class="op" id="4080654">.</span><span class="ident" id="4080655">Header</span><span class="op" id="4080661">.</span><span class="ident" id="4080662">get</span><span class="op" id="4080665">(</span><span class="string" id="4080666">&#34;Range&#34;</span><span class="op" id="4080673">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4080677">//&nbsp;Invalidate&nbsp;the&nbsp;range&nbsp;request&nbsp;if&nbsp;the&nbsp;entity&nbsp;doesn&#39;t&nbsp;match&nbsp;the&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4080746">//&nbsp;the&nbsp;client&nbsp;was&nbsp;expecting.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4080776">//&nbsp;&#34;If-Range:&nbsp;version&#34;&nbsp;means&nbsp;&#34;ignore&nbsp;the&nbsp;Range:&nbsp;header&nbsp;unless&nbsp;version&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4080859">//&nbsp;current&nbsp;file.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4080878">//&nbsp;We&nbsp;only&nbsp;support&nbsp;ETag&nbsp;versions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4080913">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;have&nbsp;set&nbsp;the&nbsp;ETag&nbsp;on&nbsp;the&nbsp;response&nbsp;already.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4080976">if</span>&nbsp;<span class="ident" id="4080979">ir</span>&nbsp;<span class="op" id="4080982">:=</span>&nbsp;<span class="ident" id="4080985">r</span><span class="op" id="4080986">.</span><span class="ident" id="4080987">Header</span><span class="op" id="4080993">.</span><span class="ident" id="4080994">get</span><span class="op" id="4080997">(</span><span class="string" id="4080998">&#34;If-Range&#34;</span><span class="op" id="4081008">)</span><span class="op" id="4081009">;</span>&nbsp;<span class="ident" id="4081011">ir</span>&nbsp;<span class="op" id="4081014">!=</span>&nbsp;<span class="string" id="4081017">&#34;&#34;</span>&nbsp;<span class="op" id="4081020">&amp;&amp;</span>&nbsp;<span class="ident" id="4081023">ir</span>&nbsp;<span class="op" id="4081026">!=</span>&nbsp;<span class="ident" id="4081029">etag</span>&nbsp;<span class="op" id="4081034">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4081038">//&nbsp;The&nbsp;If-Range&nbsp;value&nbsp;is&nbsp;typically&nbsp;the&nbsp;ETag&nbsp;value,&nbsp;but&nbsp;it&nbsp;may&nbsp;also&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4081110">//&nbsp;the&nbsp;modtime&nbsp;date.&nbsp;See&nbsp;golang.org/issue/8367.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4081160">timeMatches</span>&nbsp;<span class="op" id="4081172">:=</span>&nbsp;<span class="builtintype" id="4081175">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4081183">if</span>&nbsp;<span class="op" id="4081186">!</span><span class="ident" id="4081187">modtime</span><span class="op" id="4081194">.</span><span class="ident" id="4081195">IsZero</span><span class="op" id="4081201">(</span><span class="op" id="4081202">)</span>&nbsp;<span class="op" id="4081204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4081209">if</span>&nbsp;<span class="ident" id="4081212">t</span><span class="op" id="4081213">,</span>&nbsp;<span class="ident" id="4081215">err</span>&nbsp;<span class="op" id="4081219">:=</span>&nbsp;<span class="ident" id="4081222">ParseTime</span><span class="op" id="4081231">(</span><span class="ident" id="4081232">ir</span><span class="op" id="4081234">)</span><span class="op" id="4081235">;</span>&nbsp;<span class="ident" id="4081237">err</span>&nbsp;<span class="op" id="4081241">==</span>&nbsp;<span class="builtintype" id="4081244">nil</span>&nbsp;<span class="op" id="4081248">&amp;&amp;</span>&nbsp;<span class="ident" id="4081251">t</span><span class="op" id="4081252">.</span><span class="ident" id="4081253">Unix</span><span class="op" id="4081257">(</span><span class="op" id="4081258">)</span>&nbsp;<span class="op" id="4081260">==</span>&nbsp;<span class="ident" id="4081263">modtime</span><span class="op" id="4081270">.</span><span class="ident" id="4081271">Unix</span><span class="op" id="4081275">(</span><span class="op" id="4081276">)</span>&nbsp;<span class="op" id="4081278">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4081284">timeMatches</span>&nbsp;<span class="op" id="4081296">=</span>&nbsp;<span class="builtintype" id="4081298">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4081306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4081310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4081314">if</span>&nbsp;<span class="op" id="4081317">!</span><span class="ident" id="4081318">timeMatches</span>&nbsp;<span class="op" id="4081330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4081335">rangeReq</span>&nbsp;<span class="op" id="4081344">=</span>&nbsp;<span class="string" id="4081346">&#34;&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4081351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4081354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4081358">if</span>&nbsp;<span class="ident" id="4081361">inm</span>&nbsp;<span class="op" id="4081365">:=</span>&nbsp;<span class="ident" id="4081368">r</span><span class="op" id="4081369">.</span><span class="ident" id="4081370">Header</span><span class="op" id="4081376">.</span><span class="ident" id="4081377">get</span><span class="op" id="4081380">(</span><span class="string" id="4081381">&#34;If-None-Match&#34;</span><span class="op" id="4081396">)</span><span class="op" id="4081397">;</span>&nbsp;<span class="ident" id="4081399">inm</span>&nbsp;<span class="op" id="4081403">!=</span>&nbsp;<span class="string" id="4081406">&#34;&#34;</span>&nbsp;<span class="op" id="4081409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4081413">//&nbsp;Must&nbsp;know&nbsp;ETag.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4081434">if</span>&nbsp;<span class="ident" id="4081437">etag</span>&nbsp;<span class="op" id="4081442">==</span>&nbsp;<span class="string" id="4081445">&#34;&#34;</span>&nbsp;<span class="op" id="4081448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4081453">return</span>&nbsp;<span class="ident" id="4081460">rangeReq</span><span class="op" id="4081468">,</span>&nbsp;<span class="builtintype" id="4081470">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4081478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4081483">//&nbsp;TODO(bradfitz):&nbsp;non-GET/HEAD&nbsp;requests&nbsp;require&nbsp;more&nbsp;work:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4081545">//&nbsp;sending&nbsp;a&nbsp;different&nbsp;status&nbsp;code&nbsp;on&nbsp;matches,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4081598">//&nbsp;also&nbsp;can&#39;t&nbsp;use&nbsp;weak&nbsp;cache&nbsp;validators&nbsp;(those&nbsp;with&nbsp;a&nbsp;&#34;W/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4081658">//&nbsp;prefix).&nbsp;&nbsp;But&nbsp;most&nbsp;users&nbsp;of&nbsp;ServeContent&nbsp;will&nbsp;be&nbsp;using</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4081718">//&nbsp;it&nbsp;on&nbsp;GET&nbsp;or&nbsp;HEAD,&nbsp;so&nbsp;only&nbsp;support&nbsp;those&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4081773">if</span>&nbsp;<span class="ident" id="4081776">r</span><span class="op" id="4081777">.</span><span class="ident" id="4081778">Method</span>&nbsp;<span class="op" id="4081785">!=</span>&nbsp;<span class="string" id="4081788">&#34;GET&#34;</span>&nbsp;<span class="op" id="4081794">&amp;&amp;</span>&nbsp;<span class="ident" id="4081797">r</span><span class="op" id="4081798">.</span><span class="ident" id="4081799">Method</span>&nbsp;<span class="op" id="4081806">!=</span>&nbsp;<span class="string" id="4081809">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4081816">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4081821">return</span>&nbsp;<span class="ident" id="4081828">rangeReq</span><span class="op" id="4081836">,</span>&nbsp;<span class="builtintype" id="4081838">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4081846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4081851">//&nbsp;TODO(bradfitz):&nbsp;deal&nbsp;with&nbsp;comma-separated&nbsp;or&nbsp;multiple-valued</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4081917">//&nbsp;list&nbsp;of&nbsp;If-None-match&nbsp;values.&nbsp;&nbsp;For&nbsp;now&nbsp;just&nbsp;handle&nbsp;the&nbsp;common</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4081984">//&nbsp;case&nbsp;of&nbsp;a&nbsp;single&nbsp;item.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4082012">if</span>&nbsp;<span class="ident" id="4082015">inm</span>&nbsp;<span class="op" id="4082019">==</span>&nbsp;<span class="ident" id="4082022">etag</span>&nbsp;<span class="op" id="4082027">||</span>&nbsp;<span class="ident" id="4082030">inm</span>&nbsp;<span class="op" id="4082034">==</span>&nbsp;<span class="string" id="4082037">&#34;*&#34;</span>&nbsp;<span class="op" id="4082041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4082046">h</span>&nbsp;<span class="op" id="4082048">:=</span>&nbsp;<span class="ident" id="4082051">w</span><span class="op" id="4082052">.</span><span class="ident" id="4082053">Header</span><span class="op" id="4082059">(</span><span class="op" id="4082060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4082065">delete</span><span class="op" id="4082071">(</span><span class="ident" id="4082072">h</span><span class="op" id="4082073">,</span>&nbsp;<span class="string" id="4082075">&#34;Content-Type&#34;</span><span class="op" id="4082089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4082094">delete</span><span class="op" id="4082100">(</span><span class="ident" id="4082101">h</span><span class="op" id="4082102">,</span>&nbsp;<span class="string" id="4082104">&#34;Content-Length&#34;</span><span class="op" id="4082120">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4082125">w</span><span class="op" id="4082126">.</span><span class="ident" id="4082127">WriteHeader</span><span class="op" id="4082138">(</span><span class="ident" id="4082139">StatusNotModified</span><span class="op" id="4082156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4082161">return</span>&nbsp;<span class="string" id="4082168">&#34;&#34;</span><span class="op" id="4082170">,</span>&nbsp;<span class="builtintype" id="4082172">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4082179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4082182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4082185">return</span>&nbsp;<span class="ident" id="4082192">rangeReq</span><span class="op" id="4082200">,</span>&nbsp;<span class="builtintype" id="4082202">false</span><br>
<span class="lineno">340</span><span class="op" id="4082208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4082211">//&nbsp;name&nbsp;is&nbsp;&#39;/&#39;-separated,&nbsp;not&nbsp;filepath.Separator.</span><br>
<span class="lineno"></span><span class="keyword" id="4082261">func</span>&nbsp;<span class="ident" id="4082266">serveFile</span><span class="op" id="4082275">(</span><span class="ident" id="4082276">w</span>&nbsp;<span class="ident" id="4082278">ResponseWriter</span><span class="op" id="4082292">,</span>&nbsp;<span class="ident" id="4082294">r</span>&nbsp;<span class="op" id="4082296">*</span><span class="ident" id="4082297">Request</span><span class="op" id="4082304">,</span>&nbsp;<span class="ident" id="4082306">fs</span>&nbsp;<span class="ident" id="4082309">FileSystem</span><span class="op" id="4082319">,</span>&nbsp;<span class="ident" id="4082321">name</span>&nbsp;<span class="builtintype" id="4082326">string</span><span class="op" id="4082332">,</span>&nbsp;<span class="ident" id="4082334">redirect</span>&nbsp;<span class="builtintype" id="4082343">bool</span><span class="op" id="4082347">)</span>&nbsp;<span class="op" id="4082349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4082352">const</span>&nbsp;<span class="ident" id="4082358">indexPage</span>&nbsp;<span class="op" id="4082368">=</span>&nbsp;<span class="string" id="4082370">&#34;/index.html&#34;</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4082386">//&nbsp;redirect&nbsp;.../index.html&nbsp;to&nbsp;.../</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4082422">//&nbsp;can&#39;t&nbsp;use&nbsp;Redirect()&nbsp;because&nbsp;that&nbsp;would&nbsp;make&nbsp;the&nbsp;path&nbsp;absolute,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4082490">//&nbsp;which&nbsp;would&nbsp;be&nbsp;a&nbsp;problem&nbsp;running&nbsp;under&nbsp;StripPrefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4082545">if</span>&nbsp;<span class="ident" id="4082548">strings</span><span class="op" id="4082555">.</span><span class="ident" id="4082556">HasSuffix</span><span class="op" id="4082565">(</span><span class="ident" id="4082566">r</span><span class="op" id="4082567">.</span><span class="ident" id="4082568">URL</span><span class="op" id="4082571">.</span><span class="ident" id="4082572">Path</span><span class="op" id="4082576">,</span>&nbsp;<span class="ident" id="4082578">indexPage</span><span class="op" id="4082587">)</span>&nbsp;<span class="op" id="4082589">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4082593">localRedirect</span><span class="op" id="4082606">(</span><span class="ident" id="4082607">w</span><span class="op" id="4082608">,</span>&nbsp;<span class="ident" id="4082610">r</span><span class="op" id="4082611">,</span>&nbsp;<span class="string" id="4082613">&#34;./&#34;</span><span class="op" id="4082617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4082621">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4082629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4082633">f</span><span class="op" id="4082634">,</span>&nbsp;<span class="ident" id="4082636">err</span>&nbsp;<span class="op" id="4082640">:=</span>&nbsp;<span class="ident" id="4082643">fs</span><span class="op" id="4082645">.</span><span class="ident" id="4082646">Open</span><span class="op" id="4082650">(</span><span class="ident" id="4082651">name</span><span class="op" id="4082655">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4082658">if</span>&nbsp;<span class="ident" id="4082661">err</span>&nbsp;<span class="op" id="4082665">!=</span>&nbsp;<span class="builtintype" id="4082668">nil</span>&nbsp;<span class="op" id="4082672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4082676">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4082707">NotFound</span><span class="op" id="4082715">(</span><span class="ident" id="4082716">w</span><span class="op" id="4082717">,</span>&nbsp;<span class="ident" id="4082719">r</span><span class="op" id="4082720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4082724">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4082732">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4082735">defer</span>&nbsp;<span class="ident" id="4082741">f</span><span class="op" id="4082742">.</span><span class="ident" id="4082743">Close</span><span class="op" id="4082748">(</span><span class="op" id="4082749">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4082753">d</span><span class="op" id="4082754">,</span>&nbsp;<span class="ident" id="4082756">err1</span>&nbsp;<span class="op" id="4082761">:=</span>&nbsp;<span class="ident" id="4082764">f</span><span class="op" id="4082765">.</span><span class="ident" id="4082766">Stat</span><span class="op" id="4082770">(</span><span class="op" id="4082771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4082774">if</span>&nbsp;<span class="ident" id="4082777">err1</span>&nbsp;<span class="op" id="4082782">!=</span>&nbsp;<span class="builtintype" id="4082785">nil</span>&nbsp;<span class="op" id="4082789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4082793">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4082824">NotFound</span><span class="op" id="4082832">(</span><span class="ident" id="4082833">w</span><span class="op" id="4082834">,</span>&nbsp;<span class="ident" id="4082836">r</span><span class="op" id="4082837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4082841">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4082849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4082853">if</span>&nbsp;<span class="ident" id="4082856">redirect</span>&nbsp;<span class="op" id="4082865">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4082869">//&nbsp;redirect&nbsp;to&nbsp;canonical&nbsp;path:&nbsp;/&nbsp;at&nbsp;end&nbsp;of&nbsp;directory&nbsp;url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4082928">//&nbsp;r.URL.Path&nbsp;always&nbsp;begins&nbsp;with&nbsp;/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4082965">url</span>&nbsp;<span class="op" id="4082969">:=</span>&nbsp;<span class="ident" id="4082972">r</span><span class="op" id="4082973">.</span><span class="ident" id="4082974">URL</span><span class="op" id="4082977">.</span><span class="ident" id="4082978">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4082985">if</span>&nbsp;<span class="ident" id="4082988">d</span><span class="op" id="4082989">.</span><span class="ident" id="4082990">IsDir</span><span class="op" id="4082995">(</span><span class="op" id="4082996">)</span>&nbsp;<span class="op" id="4082998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4083003">if</span>&nbsp;<span class="ident" id="4083006">url</span><span class="op" id="4083009">[</span><span class="builtinfunc" id="4083010">len</span><span class="op" id="4083013">(</span><span class="ident" id="4083014">url</span><span class="op" id="4083017">)</span><span class="op" id="4083018">-</span><span class="num" id="4083019">1</span><span class="op" id="4083020">]</span>&nbsp;<span class="op" id="4083022">!=</span>&nbsp;<span class="string" id="4083025">&#39;/&#39;</span>&nbsp;<span class="op" id="4083029">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4083035">localRedirect</span><span class="op" id="4083048">(</span><span class="ident" id="4083049">w</span><span class="op" id="4083050">,</span>&nbsp;<span class="ident" id="4083052">r</span><span class="op" id="4083053">,</span>&nbsp;<span class="ident" id="4083055">path</span><span class="op" id="4083059">.</span><span class="ident" id="4083060">Base</span><span class="op" id="4083064">(</span><span class="ident" id="4083065">url</span><span class="op" id="4083068">)</span><span class="op" id="4083069">+</span><span class="string" id="4083070">&#34;/&#34;</span><span class="op" id="4083073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4083079">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4083089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4083093">}</span>&nbsp;<span class="keyword" id="4083095">else</span>&nbsp;<span class="op" id="4083100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4083105">if</span>&nbsp;<span class="ident" id="4083108">url</span><span class="op" id="4083111">[</span><span class="builtinfunc" id="4083112">len</span><span class="op" id="4083115">(</span><span class="ident" id="4083116">url</span><span class="op" id="4083119">)</span><span class="op" id="4083120">-</span><span class="num" id="4083121">1</span><span class="op" id="4083122">]</span>&nbsp;<span class="op" id="4083124">==</span>&nbsp;<span class="string" id="4083127">&#39;/&#39;</span>&nbsp;<span class="op" id="4083131">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4083137">localRedirect</span><span class="op" id="4083150">(</span><span class="ident" id="4083151">w</span><span class="op" id="4083152">,</span>&nbsp;<span class="ident" id="4083154">r</span><span class="op" id="4083155">,</span>&nbsp;<span class="string" id="4083157">&#34;../&#34;</span><span class="op" id="4083162">+</span><span class="ident" id="4083163">path</span><span class="op" id="4083167">.</span><span class="ident" id="4083168">Base</span><span class="op" id="4083172">(</span><span class="ident" id="4083173">url</span><span class="op" id="4083176">)</span><span class="op" id="4083177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4083183">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4083193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4083197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4083200">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4083204">//&nbsp;use&nbsp;contents&nbsp;of&nbsp;index.html&nbsp;for&nbsp;directory,&nbsp;if&nbsp;present</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4083261">if</span>&nbsp;<span class="ident" id="4083264">d</span><span class="op" id="4083265">.</span><span class="ident" id="4083266">IsDir</span><span class="op" id="4083271">(</span><span class="op" id="4083272">)</span>&nbsp;<span class="op" id="4083274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4083278">index</span>&nbsp;<span class="op" id="4083284">:=</span>&nbsp;<span class="ident" id="4083287">strings</span><span class="op" id="4083294">.</span><span class="ident" id="4083295">TrimSuffix</span><span class="op" id="4083305">(</span><span class="ident" id="4083306">name</span><span class="op" id="4083310">,</span>&nbsp;<span class="string" id="4083312">&#34;/&#34;</span><span class="op" id="4083315">)</span>&nbsp;<span class="op" id="4083317">+</span>&nbsp;<span class="ident" id="4083319">indexPage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4083331">ff</span><span class="op" id="4083333">,</span>&nbsp;<span class="ident" id="4083335">err</span>&nbsp;<span class="op" id="4083339">:=</span>&nbsp;<span class="ident" id="4083342">fs</span><span class="op" id="4083344">.</span><span class="ident" id="4083345">Open</span><span class="op" id="4083349">(</span><span class="ident" id="4083350">index</span><span class="op" id="4083355">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4083359">if</span>&nbsp;<span class="ident" id="4083362">err</span>&nbsp;<span class="op" id="4083366">==</span>&nbsp;<span class="builtintype" id="4083369">nil</span>&nbsp;<span class="op" id="4083373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4083378">defer</span>&nbsp;<span class="ident" id="4083384">ff</span><span class="op" id="4083386">.</span><span class="ident" id="4083387">Close</span><span class="op" id="4083392">(</span><span class="op" id="4083393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4083398">dd</span><span class="op" id="4083400">,</span>&nbsp;<span class="ident" id="4083402">err</span>&nbsp;<span class="op" id="4083406">:=</span>&nbsp;<span class="ident" id="4083409">ff</span><span class="op" id="4083411">.</span><span class="ident" id="4083412">Stat</span><span class="op" id="4083416">(</span><span class="op" id="4083417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4083422">if</span>&nbsp;<span class="ident" id="4083425">err</span>&nbsp;<span class="op" id="4083429">==</span>&nbsp;<span class="builtintype" id="4083432">nil</span>&nbsp;<span class="op" id="4083436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4083442">name</span>&nbsp;<span class="op" id="4083447">=</span>&nbsp;<span class="ident" id="4083449">index</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4083459">d</span>&nbsp;<span class="op" id="4083461">=</span>&nbsp;<span class="ident" id="4083463">dd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4083470">f</span>&nbsp;<span class="op" id="4083472">=</span>&nbsp;<span class="ident" id="4083474">ff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4083480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4083484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4083487">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4083491">//&nbsp;Still&nbsp;a&nbsp;directory?&nbsp;(we&nbsp;didn&#39;t&nbsp;find&nbsp;an&nbsp;index.html&nbsp;file)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4083550">if</span>&nbsp;<span class="ident" id="4083553">d</span><span class="op" id="4083554">.</span><span class="ident" id="4083555">IsDir</span><span class="op" id="4083560">(</span><span class="op" id="4083561">)</span>&nbsp;<span class="op" id="4083563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4083567">if</span>&nbsp;<span class="ident" id="4083570">checkLastModified</span><span class="op" id="4083587">(</span><span class="ident" id="4083588">w</span><span class="op" id="4083589">,</span>&nbsp;<span class="ident" id="4083591">r</span><span class="op" id="4083592">,</span>&nbsp;<span class="ident" id="4083594">d</span><span class="op" id="4083595">.</span><span class="ident" id="4083596">ModTime</span><span class="op" id="4083603">(</span><span class="op" id="4083604">)</span><span class="op" id="4083605">)</span>&nbsp;<span class="op" id="4083607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4083612">return</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4083621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4083625">dirList</span><span class="op" id="4083632">(</span><span class="ident" id="4083633">w</span><span class="op" id="4083634">,</span>&nbsp;<span class="ident" id="4083636">f</span><span class="op" id="4083637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4083641">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4083649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4083653">//&nbsp;serveContent&nbsp;will&nbsp;check&nbsp;modification&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4083699">sizeFunc</span>&nbsp;<span class="op" id="4083708">:=</span>&nbsp;<span class="keyword" id="4083711">func</span><span class="op" id="4083715">(</span><span class="op" id="4083716">)</span>&nbsp;<span class="op" id="4083718">(</span><span class="ident" id="4083719">int64</span><span class="op" id="4083724">,</span>&nbsp;<span class="builtintype" id="4083726">error</span><span class="op" id="4083731">)</span>&nbsp;<span class="op" id="4083733">{</span>&nbsp;<span class="keyword" id="4083735">return</span>&nbsp;<span class="ident" id="4083742">d</span><span class="op" id="4083743">.</span><span class="ident" id="4083744">Size</span><span class="op" id="4083748">(</span><span class="op" id="4083749">)</span><span class="op" id="4083750">,</span>&nbsp;<span class="builtintype" id="4083752">nil</span>&nbsp;<span class="op" id="4083756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4083759">serveContent</span><span class="op" id="4083771">(</span><span class="ident" id="4083772">w</span><span class="op" id="4083773">,</span>&nbsp;<span class="ident" id="4083775">r</span><span class="op" id="4083776">,</span>&nbsp;<span class="ident" id="4083778">d</span><span class="op" id="4083779">.</span><span class="ident" id="4083780">Name</span><span class="op" id="4083784">(</span><span class="op" id="4083785">)</span><span class="op" id="4083786">,</span>&nbsp;<span class="ident" id="4083788">d</span><span class="op" id="4083789">.</span><span class="ident" id="4083790">ModTime</span><span class="op" id="4083797">(</span><span class="op" id="4083798">)</span><span class="op" id="4083799">,</span>&nbsp;<span class="ident" id="4083801">sizeFunc</span><span class="op" id="4083809">,</span>&nbsp;<span class="ident" id="4083811">f</span><span class="op" id="4083812">)</span><br>
<span class="lineno"></span><span class="op" id="4083814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="4083817">//&nbsp;localRedirect&nbsp;gives&nbsp;a&nbsp;Moved&nbsp;Permanently&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="4083870">//&nbsp;It&nbsp;does&nbsp;not&nbsp;convert&nbsp;relative&nbsp;paths&nbsp;to&nbsp;absolute&nbsp;paths&nbsp;like&nbsp;Redirect&nbsp;does.</span><br>
<span class="lineno"></span><span class="keyword" id="4083946">func</span>&nbsp;<span class="ident" id="4083951">localRedirect</span><span class="op" id="4083964">(</span><span class="ident" id="4083965">w</span>&nbsp;<span class="ident" id="4083967">ResponseWriter</span><span class="op" id="4083981">,</span>&nbsp;<span class="ident" id="4083983">r</span>&nbsp;<span class="op" id="4083985">*</span><span class="ident" id="4083986">Request</span><span class="op" id="4083993">,</span>&nbsp;<span class="ident" id="4083995">newPath</span>&nbsp;<span class="builtintype" id="4084003">string</span><span class="op" id="4084009">)</span>&nbsp;<span class="op" id="4084011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4084014">if</span>&nbsp;<span class="ident" id="4084017">q</span>&nbsp;<span class="op" id="4084019">:=</span>&nbsp;<span class="ident" id="4084022">r</span><span class="op" id="4084023">.</span><span class="ident" id="4084024">URL</span><span class="op" id="4084027">.</span><span class="ident" id="4084028">RawQuery</span><span class="op" id="4084036">;</span>&nbsp;<span class="ident" id="4084038">q</span>&nbsp;<span class="op" id="4084040">!=</span>&nbsp;<span class="string" id="4084043">&#34;&#34;</span>&nbsp;<span class="op" id="4084046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4084050">newPath</span>&nbsp;<span class="op" id="4084058">+=</span>&nbsp;<span class="string" id="4084061">&#34;?&#34;</span>&nbsp;<span class="op" id="4084065">+</span>&nbsp;<span class="ident" id="4084067">q</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4084070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4084073">w</span><span class="op" id="4084074">.</span><span class="ident" id="4084075">Header</span><span class="op" id="4084081">(</span><span class="op" id="4084082">)</span><span class="op" id="4084083">.</span><span class="ident" id="4084084">Set</span><span class="op" id="4084087">(</span><span class="string" id="4084088">&#34;Location&#34;</span><span class="op" id="4084098">,</span>&nbsp;<span class="ident" id="4084100">newPath</span><span class="op" id="4084107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4084110">w</span><span class="op" id="4084111">.</span><span class="ident" id="4084112">WriteHeader</span><span class="op" id="4084123">(</span><span class="ident" id="4084124">StatusMovedPermanently</span><span class="op" id="4084146">)</span><br>
<span class="lineno"></span><span class="op" id="4084148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span><span class="comment" id="4084151">//&nbsp;ServeFile&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;named&nbsp;file&nbsp;or&nbsp;directory.</span><br>
<span class="lineno"></span><span class="keyword" id="4084237">func</span>&nbsp;<span class="ident" id="4084242">ServeFile</span><span class="op" id="4084251">(</span><span class="ident" id="4084252">w</span>&nbsp;<span class="ident" id="4084254">ResponseWriter</span><span class="op" id="4084268">,</span>&nbsp;<span class="ident" id="4084270">r</span>&nbsp;<span class="op" id="4084272">*</span><span class="ident" id="4084273">Request</span><span class="op" id="4084280">,</span>&nbsp;<span class="ident" id="4084282">name</span>&nbsp;<span class="builtintype" id="4084287">string</span><span class="op" id="4084293">)</span>&nbsp;<span class="op" id="4084295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4084298">dir</span><span class="op" id="4084301">,</span>&nbsp;<span class="ident" id="4084303">file</span>&nbsp;<span class="op" id="4084308">:=</span>&nbsp;<span class="ident" id="4084311">filepath</span><span class="op" id="4084319">.</span><span class="ident" id="4084320">Split</span><span class="op" id="4084325">(</span><span class="ident" id="4084326">name</span><span class="op" id="4084330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4084333">serveFile</span><span class="op" id="4084342">(</span><span class="ident" id="4084343">w</span><span class="op" id="4084344">,</span>&nbsp;<span class="ident" id="4084346">r</span><span class="op" id="4084347">,</span>&nbsp;<span class="ident" id="4084349">Dir</span><span class="op" id="4084352">(</span><span class="ident" id="4084353">dir</span><span class="op" id="4084356">)</span><span class="op" id="4084357">,</span>&nbsp;<span class="ident" id="4084359">file</span><span class="op" id="4084363">,</span>&nbsp;<span class="builtintype" id="4084365">false</span><span class="op" id="4084370">)</span><br>
<span class="lineno"></span><span class="op" id="4084372">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="4084375">type</span>&nbsp;<span class="ident" id="4084380">fileHandler</span>&nbsp;<span class="keyword" id="4084392">struct</span>&nbsp;<span class="op" id="4084399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4084402">root</span>&nbsp;<span class="ident" id="4084407">FileSystem</span><br>
<span class="lineno"></span><span class="op" id="4084418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="comment" id="4084421">//&nbsp;FileServer&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4084479">//&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;file&nbsp;system&nbsp;rooted&nbsp;at&nbsp;root.</span><br>
<span class="lineno"></span><span class="comment" id="4084535">//</span><br>
<span class="lineno"></span><span class="comment" id="4084538">//&nbsp;To&nbsp;use&nbsp;the&nbsp;operating&nbsp;system&#39;s&nbsp;file&nbsp;system&nbsp;implementation,</span><br>
<span class="lineno"></span><span class="comment" id="4084599">//&nbsp;use&nbsp;http.Dir:</span><br>
<span class="lineno">440</span><span class="comment" id="4084616">//</span><br>
<span class="lineno"></span><span class="comment" id="4084619">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.Handle(&#34;/&#34;,&nbsp;http.FileServer(http.Dir(&#34;/tmp&#34;)))</span><br>
<span class="lineno"></span><span class="keyword" id="4084678">func</span>&nbsp;<span class="ident" id="4084683">FileServer</span><span class="op" id="4084693">(</span><span class="ident" id="4084694">root</span>&nbsp;<span class="ident" id="4084699">FileSystem</span><span class="op" id="4084709">)</span>&nbsp;<span class="ident" id="4084711">Handler</span>&nbsp;<span class="op" id="4084719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4084722">return</span>&nbsp;<span class="op" id="4084729">&amp;</span><span class="ident" id="4084730">fileHandler</span><span class="op" id="4084741">{</span><span class="ident" id="4084742">root</span><span class="op" id="4084746">}</span><br>
<span class="lineno"></span><span class="op" id="4084748">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span><span class="keyword" id="4084751">func</span>&nbsp;<span class="op" id="4084756">(</span><span class="ident" id="4084757">f</span>&nbsp;<span class="op" id="4084759">*</span><span class="ident" id="4084760">fileHandler</span><span class="op" id="4084771">)</span>&nbsp;<span class="ident" id="4084773">ServeHTTP</span><span class="op" id="4084782">(</span><span class="ident" id="4084783">w</span>&nbsp;<span class="ident" id="4084785">ResponseWriter</span><span class="op" id="4084799">,</span>&nbsp;<span class="ident" id="4084801">r</span>&nbsp;<span class="op" id="4084803">*</span><span class="ident" id="4084804">Request</span><span class="op" id="4084811">)</span>&nbsp;<span class="op" id="4084813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4084816">upath</span>&nbsp;<span class="op" id="4084822">:=</span>&nbsp;<span class="ident" id="4084825">r</span><span class="op" id="4084826">.</span><span class="ident" id="4084827">URL</span><span class="op" id="4084830">.</span><span class="ident" id="4084831">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4084837">if</span>&nbsp;<span class="op" id="4084840">!</span><span class="ident" id="4084841">strings</span><span class="op" id="4084848">.</span><span class="ident" id="4084849">HasPrefix</span><span class="op" id="4084858">(</span><span class="ident" id="4084859">upath</span><span class="op" id="4084864">,</span>&nbsp;<span class="string" id="4084866">&#34;/&#34;</span><span class="op" id="4084869">)</span>&nbsp;<span class="op" id="4084871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4084875">upath</span>&nbsp;<span class="op" id="4084881">=</span>&nbsp;<span class="string" id="4084883">&#34;/&#34;</span>&nbsp;<span class="op" id="4084887">+</span>&nbsp;<span class="ident" id="4084889">upath</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4084897">r</span><span class="op" id="4084898">.</span><span class="ident" id="4084899">URL</span><span class="op" id="4084902">.</span><span class="ident" id="4084903">Path</span>&nbsp;<span class="op" id="4084908">=</span>&nbsp;<span class="ident" id="4084910">upath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4084917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4084920">serveFile</span><span class="op" id="4084929">(</span><span class="ident" id="4084930">w</span><span class="op" id="4084931">,</span>&nbsp;<span class="ident" id="4084933">r</span><span class="op" id="4084934">,</span>&nbsp;<span class="ident" id="4084936">f</span><span class="op" id="4084937">.</span><span class="ident" id="4084938">root</span><span class="op" id="4084942">,</span>&nbsp;<span class="ident" id="4084944">path</span><span class="op" id="4084948">.</span><span class="ident" id="4084949">Clean</span><span class="op" id="4084954">(</span><span class="ident" id="4084955">upath</span><span class="op" id="4084960">)</span><span class="op" id="4084961">,</span>&nbsp;<span class="builtintype" id="4084963">true</span><span class="op" id="4084967">)</span><br>
<span class="lineno"></span><span class="op" id="4084969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="4084972">//&nbsp;httpRange&nbsp;specifies&nbsp;the&nbsp;byte&nbsp;range&nbsp;to&nbsp;be&nbsp;sent&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="4085036">type</span>&nbsp;<span class="ident" id="4085041">httpRange</span>&nbsp;<span class="keyword" id="4085051">struct</span>&nbsp;<span class="op" id="4085058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4085061">start</span><span class="op" id="4085066">,</span>&nbsp;<span class="ident" id="4085068">length</span>&nbsp;<span class="ident" id="4085075">int64</span><br>
<span class="lineno"></span><span class="op" id="4085081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="keyword" id="4085084">func</span>&nbsp;<span class="op" id="4085089">(</span><span class="ident" id="4085090">r</span>&nbsp;<span class="ident" id="4085092">httpRange</span><span class="op" id="4085101">)</span>&nbsp;<span class="ident" id="4085103">contentRange</span><span class="op" id="4085115">(</span><span class="ident" id="4085116">size</span>&nbsp;<span class="ident" id="4085121">int64</span><span class="op" id="4085126">)</span>&nbsp;<span class="builtintype" id="4085128">string</span>&nbsp;<span class="op" id="4085135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4085138">return</span>&nbsp;<span class="ident" id="4085145">fmt</span><span class="op" id="4085148">.</span><span class="ident" id="4085149">Sprintf</span><span class="op" id="4085156">(</span><span class="string" id="4085157">&#34;bytes&nbsp;%d-%d/%d&#34;</span><span class="op" id="4085173">,</span>&nbsp;<span class="ident" id="4085175">r</span><span class="op" id="4085176">.</span><span class="ident" id="4085177">start</span><span class="op" id="4085182">,</span>&nbsp;<span class="ident" id="4085184">r</span><span class="op" id="4085185">.</span><span class="ident" id="4085186">start</span><span class="op" id="4085191">+</span><span class="ident" id="4085192">r</span><span class="op" id="4085193">.</span><span class="ident" id="4085194">length</span><span class="op" id="4085200">-</span><span class="num" id="4085201">1</span><span class="op" id="4085202">,</span>&nbsp;<span class="ident" id="4085204">size</span><span class="op" id="4085208">)</span><br>
<span class="lineno"></span><span class="op" id="4085210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4085213">func</span>&nbsp;<span class="op" id="4085218">(</span><span class="ident" id="4085219">r</span>&nbsp;<span class="ident" id="4085221">httpRange</span><span class="op" id="4085230">)</span>&nbsp;<span class="ident" id="4085232">mimeHeader</span><span class="op" id="4085242">(</span><span class="ident" id="4085243">contentType</span>&nbsp;<span class="builtintype" id="4085255">string</span><span class="op" id="4085261">,</span>&nbsp;<span class="ident" id="4085263">size</span>&nbsp;<span class="ident" id="4085268">int64</span><span class="op" id="4085273">)</span>&nbsp;<span class="ident" id="4085275">textproto</span><span class="op" id="4085284">.</span><span class="ident" id="4085285">MIMEHeader</span>&nbsp;<span class="op" id="4085296">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4085299">return</span>&nbsp;<span class="ident" id="4085306">textproto</span><span class="op" id="4085315">.</span><span class="ident" id="4085316">MIMEHeader</span><span class="op" id="4085326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4085330">&#34;Content-Range&#34;</span><span class="op" id="4085345">:</span>&nbsp;<span class="op" id="4085347">{</span><span class="ident" id="4085348">r</span><span class="op" id="4085349">.</span><span class="ident" id="4085350">contentRange</span><span class="op" id="4085362">(</span><span class="ident" id="4085363">size</span><span class="op" id="4085367">)</span><span class="op" id="4085368">}</span><span class="op" id="4085369">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4085373">&#34;Content-Type&#34;</span><span class="op" id="4085387">:</span>&nbsp;&nbsp;<span class="op" id="4085390">{</span><span class="ident" id="4085391">contentType</span><span class="op" id="4085402">}</span><span class="op" id="4085403">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4085406">}</span><br>
<span class="lineno"></span><span class="op" id="4085408">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="comment" id="4085411">//&nbsp;parseRange&nbsp;parses&nbsp;a&nbsp;Range&nbsp;header&nbsp;string&nbsp;as&nbsp;per&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="keyword" id="4085471">func</span>&nbsp;<span class="ident" id="4085476">parseRange</span><span class="op" id="4085486">(</span><span class="ident" id="4085487">s</span>&nbsp;<span class="builtintype" id="4085489">string</span><span class="op" id="4085495">,</span>&nbsp;<span class="ident" id="4085497">size</span>&nbsp;<span class="ident" id="4085502">int64</span><span class="op" id="4085507">)</span>&nbsp;<span class="op" id="4085509">(</span><span class="op" id="4085510">[</span><span class="op" id="4085511">]</span><span class="ident" id="4085512">httpRange</span><span class="op" id="4085521">,</span>&nbsp;<span class="builtintype" id="4085523">error</span><span class="op" id="4085528">)</span>&nbsp;<span class="op" id="4085530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4085533">if</span>&nbsp;<span class="ident" id="4085536">s</span>&nbsp;<span class="op" id="4085538">==</span>&nbsp;<span class="string" id="4085541">&#34;&#34;</span>&nbsp;<span class="op" id="4085544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4085548">return</span>&nbsp;<span class="builtintype" id="4085555">nil</span><span class="op" id="4085558">,</span>&nbsp;<span class="builtintype" id="4085560">nil</span>&nbsp;<span class="comment" id="4085564">//&nbsp;header&nbsp;not&nbsp;present</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4085587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4085590">const</span>&nbsp;<span class="ident" id="4085596">b</span>&nbsp;<span class="op" id="4085598">=</span>&nbsp;<span class="string" id="4085600">&#34;bytes=&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4085610">if</span>&nbsp;<span class="op" id="4085613">!</span><span class="ident" id="4085614">strings</span><span class="op" id="4085621">.</span><span class="ident" id="4085622">HasPrefix</span><span class="op" id="4085631">(</span><span class="ident" id="4085632">s</span><span class="op" id="4085633">,</span>&nbsp;<span class="ident" id="4085635">b</span><span class="op" id="4085636">)</span>&nbsp;<span class="op" id="4085638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4085642">return</span>&nbsp;<span class="builtintype" id="4085649">nil</span><span class="op" id="4085652">,</span>&nbsp;<span class="ident" id="4085654">errors</span><span class="op" id="4085660">.</span><span class="ident" id="4085661">New</span><span class="op" id="4085664">(</span><span class="string" id="4085665">&#34;invalid&nbsp;range&#34;</span><span class="op" id="4085680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4085683">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4085686">var</span>&nbsp;<span class="ident" id="4085690">ranges</span>&nbsp;<span class="op" id="4085697">[</span><span class="op" id="4085698">]</span><span class="ident" id="4085699">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4085710">for</span>&nbsp;<span class="ident" id="4085714">_</span><span class="op" id="4085715">,</span>&nbsp;<span class="ident" id="4085717">ra</span>&nbsp;<span class="op" id="4085720">:=</span>&nbsp;<span class="keyword" id="4085723">range</span>&nbsp;<span class="ident" id="4085729">strings</span><span class="op" id="4085736">.</span><span class="ident" id="4085737">Split</span><span class="op" id="4085742">(</span><span class="ident" id="4085743">s</span><span class="op" id="4085744">[</span><span class="builtinfunc" id="4085745">len</span><span class="op" id="4085748">(</span><span class="ident" id="4085749">b</span><span class="op" id="4085750">)</span><span class="op" id="4085751">:</span><span class="op" id="4085752">]</span><span class="op" id="4085753">,</span>&nbsp;<span class="string" id="4085755">&#34;,&#34;</span><span class="op" id="4085758">)</span>&nbsp;<span class="op" id="4085760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4085764">ra</span>&nbsp;<span class="op" id="4085767">=</span>&nbsp;<span class="ident" id="4085769">strings</span><span class="op" id="4085776">.</span><span class="ident" id="4085777">TrimSpace</span><span class="op" id="4085786">(</span><span class="ident" id="4085787">ra</span><span class="op" id="4085789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4085793">if</span>&nbsp;<span class="ident" id="4085796">ra</span>&nbsp;<span class="op" id="4085799">==</span>&nbsp;<span class="string" id="4085802">&#34;&#34;</span>&nbsp;<span class="op" id="4085805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4085810">continue</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4085821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4085825">i</span>&nbsp;<span class="op" id="4085827">:=</span>&nbsp;<span class="ident" id="4085830">strings</span><span class="op" id="4085837">.</span><span class="ident" id="4085838">Index</span><span class="op" id="4085843">(</span><span class="ident" id="4085844">ra</span><span class="op" id="4085846">,</span>&nbsp;<span class="string" id="4085848">&#34;-&#34;</span><span class="op" id="4085851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4085855">if</span>&nbsp;<span class="ident" id="4085858">i</span>&nbsp;<span class="op" id="4085860">&lt;</span>&nbsp;<span class="num" id="4085862">0</span>&nbsp;<span class="op" id="4085864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4085869">return</span>&nbsp;<span class="builtintype" id="4085876">nil</span><span class="op" id="4085879">,</span>&nbsp;<span class="ident" id="4085881">errors</span><span class="op" id="4085887">.</span><span class="ident" id="4085888">New</span><span class="op" id="4085891">(</span><span class="string" id="4085892">&#34;invalid&nbsp;range&#34;</span><span class="op" id="4085907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4085911">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4085915">start</span><span class="op" id="4085920">,</span>&nbsp;<span class="ident" id="4085922">end</span>&nbsp;<span class="op" id="4085926">:=</span>&nbsp;<span class="ident" id="4085929">strings</span><span class="op" id="4085936">.</span><span class="ident" id="4085937">TrimSpace</span><span class="op" id="4085946">(</span><span class="ident" id="4085947">ra</span><span class="op" id="4085949">[</span><span class="op" id="4085950">:</span><span class="ident" id="4085951">i</span><span class="op" id="4085952">]</span><span class="op" id="4085953">)</span><span class="op" id="4085954">,</span>&nbsp;<span class="ident" id="4085956">strings</span><span class="op" id="4085963">.</span><span class="ident" id="4085964">TrimSpace</span><span class="op" id="4085973">(</span><span class="ident" id="4085974">ra</span><span class="op" id="4085976">[</span><span class="ident" id="4085977">i</span><span class="op" id="4085978">+</span><span class="num" id="4085979">1</span><span class="op" id="4085980">:</span><span class="op" id="4085981">]</span><span class="op" id="4085982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4085986">var</span>&nbsp;<span class="ident" id="4085990">r</span>&nbsp;<span class="ident" id="4085992">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4086004">if</span>&nbsp;<span class="ident" id="4086007">start</span>&nbsp;<span class="op" id="4086013">==</span>&nbsp;<span class="string" id="4086016">&#34;&#34;</span>&nbsp;<span class="op" id="4086019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4086024">//&nbsp;If&nbsp;no&nbsp;start&nbsp;is&nbsp;specified,&nbsp;end&nbsp;specifies&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4086074">//&nbsp;range&nbsp;start&nbsp;relative&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4086125">i</span><span class="op" id="4086126">,</span>&nbsp;<span class="ident" id="4086128">err</span>&nbsp;<span class="op" id="4086132">:=</span>&nbsp;<span class="ident" id="4086135">strconv</span><span class="op" id="4086142">.</span><span class="ident" id="4086143">ParseInt</span><span class="op" id="4086151">(</span><span class="ident" id="4086152">end</span><span class="op" id="4086155">,</span>&nbsp;<span class="num" id="4086157">10</span><span class="op" id="4086159">,</span>&nbsp;<span class="num" id="4086161">64</span><span class="op" id="4086163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4086168">if</span>&nbsp;<span class="ident" id="4086171">err</span>&nbsp;<span class="op" id="4086175">!=</span>&nbsp;<span class="builtintype" id="4086178">nil</span>&nbsp;<span class="op" id="4086182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4086188">return</span>&nbsp;<span class="builtintype" id="4086195">nil</span><span class="op" id="4086198">,</span>&nbsp;<span class="ident" id="4086200">errors</span><span class="op" id="4086206">.</span><span class="ident" id="4086207">New</span><span class="op" id="4086210">(</span><span class="string" id="4086211">&#34;invalid&nbsp;range&#34;</span><span class="op" id="4086226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4086231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4086236">if</span>&nbsp;<span class="ident" id="4086239">i</span>&nbsp;<span class="op" id="4086241">&gt;</span>&nbsp;<span class="ident" id="4086243">size</span>&nbsp;<span class="op" id="4086248">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4086254">i</span>&nbsp;<span class="op" id="4086256">=</span>&nbsp;<span class="ident" id="4086258">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4086266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4086271">r</span><span class="op" id="4086272">.</span><span class="ident" id="4086273">start</span>&nbsp;<span class="op" id="4086279">=</span>&nbsp;<span class="ident" id="4086281">size</span>&nbsp;<span class="op" id="4086286">-</span>&nbsp;<span class="ident" id="4086288">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4086293">r</span><span class="op" id="4086294">.</span><span class="ident" id="4086295">length</span>&nbsp;<span class="op" id="4086302">=</span>&nbsp;<span class="ident" id="4086304">size</span>&nbsp;<span class="op" id="4086309">-</span>&nbsp;<span class="ident" id="4086311">r</span><span class="op" id="4086312">.</span><span class="ident" id="4086313">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4086321">}</span>&nbsp;<span class="keyword" id="4086323">else</span>&nbsp;<span class="op" id="4086328">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4086333">i</span><span class="op" id="4086334">,</span>&nbsp;<span class="ident" id="4086336">err</span>&nbsp;<span class="op" id="4086340">:=</span>&nbsp;<span class="ident" id="4086343">strconv</span><span class="op" id="4086350">.</span><span class="ident" id="4086351">ParseInt</span><span class="op" id="4086359">(</span><span class="ident" id="4086360">start</span><span class="op" id="4086365">,</span>&nbsp;<span class="num" id="4086367">10</span><span class="op" id="4086369">,</span>&nbsp;<span class="num" id="4086371">64</span><span class="op" id="4086373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4086378">if</span>&nbsp;<span class="ident" id="4086381">err</span>&nbsp;<span class="op" id="4086385">!=</span>&nbsp;<span class="builtintype" id="4086388">nil</span>&nbsp;<span class="op" id="4086392">||</span>&nbsp;<span class="ident" id="4086395">i</span>&nbsp;<span class="op" id="4086397">&gt;</span>&nbsp;<span class="ident" id="4086399">size</span>&nbsp;<span class="op" id="4086404">||</span>&nbsp;<span class="ident" id="4086407">i</span>&nbsp;<span class="op" id="4086409">&lt;</span>&nbsp;<span class="num" id="4086411">0</span>&nbsp;<span class="op" id="4086413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4086419">return</span>&nbsp;<span class="builtintype" id="4086426">nil</span><span class="op" id="4086429">,</span>&nbsp;<span class="ident" id="4086431">errors</span><span class="op" id="4086437">.</span><span class="ident" id="4086438">New</span><span class="op" id="4086441">(</span><span class="string" id="4086442">&#34;invalid&nbsp;range&#34;</span><span class="op" id="4086457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4086462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4086467">r</span><span class="op" id="4086468">.</span><span class="ident" id="4086469">start</span>&nbsp;<span class="op" id="4086475">=</span>&nbsp;<span class="ident" id="4086477">i</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4086482">if</span>&nbsp;<span class="ident" id="4086485">end</span>&nbsp;<span class="op" id="4086489">==</span>&nbsp;<span class="string" id="4086492">&#34;&#34;</span>&nbsp;<span class="op" id="4086495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4086501">//&nbsp;If&nbsp;no&nbsp;end&nbsp;is&nbsp;specified,&nbsp;range&nbsp;extends&nbsp;to&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4086566">r</span><span class="op" id="4086567">.</span><span class="ident" id="4086568">length</span>&nbsp;<span class="op" id="4086575">=</span>&nbsp;<span class="ident" id="4086577">size</span>&nbsp;<span class="op" id="4086582">-</span>&nbsp;<span class="ident" id="4086584">r</span><span class="op" id="4086585">.</span><span class="ident" id="4086586">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4086595">}</span>&nbsp;<span class="keyword" id="4086597">else</span>&nbsp;<span class="op" id="4086602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4086608">i</span><span class="op" id="4086609">,</span>&nbsp;<span class="ident" id="4086611">err</span>&nbsp;<span class="op" id="4086615">:=</span>&nbsp;<span class="ident" id="4086618">strconv</span><span class="op" id="4086625">.</span><span class="ident" id="4086626">ParseInt</span><span class="op" id="4086634">(</span><span class="ident" id="4086635">end</span><span class="op" id="4086638">,</span>&nbsp;<span class="num" id="4086640">10</span><span class="op" id="4086642">,</span>&nbsp;<span class="num" id="4086644">64</span><span class="op" id="4086646">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4086652">if</span>&nbsp;<span class="ident" id="4086655">err</span>&nbsp;<span class="op" id="4086659">!=</span>&nbsp;<span class="builtintype" id="4086662">nil</span>&nbsp;<span class="op" id="4086666">||</span>&nbsp;<span class="ident" id="4086669">r</span><span class="op" id="4086670">.</span><span class="ident" id="4086671">start</span>&nbsp;<span class="op" id="4086677">&gt;</span>&nbsp;<span class="ident" id="4086679">i</span>&nbsp;<span class="op" id="4086681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4086688">return</span>&nbsp;<span class="builtintype" id="4086695">nil</span><span class="op" id="4086698">,</span>&nbsp;<span class="ident" id="4086700">errors</span><span class="op" id="4086706">.</span><span class="ident" id="4086707">New</span><span class="op" id="4086710">(</span><span class="string" id="4086711">&#34;invalid&nbsp;range&#34;</span><span class="op" id="4086726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4086732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4086738">if</span>&nbsp;<span class="ident" id="4086741">i</span>&nbsp;<span class="op" id="4086743">&gt;=</span>&nbsp;<span class="ident" id="4086746">size</span>&nbsp;<span class="op" id="4086751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4086758">i</span>&nbsp;<span class="op" id="4086760">=</span>&nbsp;<span class="ident" id="4086762">size</span>&nbsp;<span class="op" id="4086767">-</span>&nbsp;<span class="num" id="4086769">1</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4086775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4086781">r</span><span class="op" id="4086782">.</span><span class="ident" id="4086783">length</span>&nbsp;<span class="op" id="4086790">=</span>&nbsp;<span class="ident" id="4086792">i</span>&nbsp;<span class="op" id="4086794">-</span>&nbsp;<span class="ident" id="4086796">r</span><span class="op" id="4086797">.</span><span class="ident" id="4086798">start</span>&nbsp;<span class="op" id="4086804">+</span>&nbsp;<span class="num" id="4086806">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4086811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4086815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4086819">ranges</span>&nbsp;<span class="op" id="4086826">=</span>&nbsp;<span class="builtinfunc" id="4086828">append</span><span class="op" id="4086834">(</span><span class="ident" id="4086835">ranges</span><span class="op" id="4086841">,</span>&nbsp;<span class="ident" id="4086843">r</span><span class="op" id="4086844">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4086847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4086850">return</span>&nbsp;<span class="ident" id="4086857">ranges</span><span class="op" id="4086863">,</span>&nbsp;<span class="builtintype" id="4086865">nil</span><br>
<span class="lineno"></span><span class="op" id="4086869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4086872">//&nbsp;countingWriter&nbsp;counts&nbsp;how&nbsp;many&nbsp;bytes&nbsp;have&nbsp;been&nbsp;written&nbsp;to&nbsp;it.</span><br>
<span class="lineno">530</span><span class="keyword" id="4086937">type</span>&nbsp;<span class="ident" id="4086942">countingWriter</span>&nbsp;<span class="ident" id="4086957">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4086964">func</span>&nbsp;<span class="op" id="4086969">(</span><span class="ident" id="4086970">w</span>&nbsp;<span class="op" id="4086972">*</span><span class="ident" id="4086973">countingWriter</span><span class="op" id="4086987">)</span>&nbsp;<span class="ident" id="4086989">Write</span><span class="op" id="4086994">(</span><span class="ident" id="4086995">p</span>&nbsp;<span class="op" id="4086997">[</span><span class="op" id="4086998">]</span><span class="builtintype" id="4086999">byte</span><span class="op" id="4087003">)</span>&nbsp;<span class="op" id="4087005">(</span><span class="ident" id="4087006">n</span>&nbsp;<span class="builtintype" id="4087008">int</span><span class="op" id="4087011">,</span>&nbsp;<span class="ident" id="4087013">err</span>&nbsp;<span class="builtintype" id="4087017">error</span><span class="op" id="4087022">)</span>&nbsp;<span class="op" id="4087024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4087027">*</span><span class="ident" id="4087028">w</span>&nbsp;<span class="op" id="4087030">+=</span>&nbsp;<span class="ident" id="4087033">countingWriter</span><span class="op" id="4087047">(</span><span class="builtinfunc" id="4087048">len</span><span class="op" id="4087051">(</span><span class="ident" id="4087052">p</span><span class="op" id="4087053">)</span><span class="op" id="4087054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4087057">return</span>&nbsp;<span class="builtinfunc" id="4087064">len</span><span class="op" id="4087067">(</span><span class="ident" id="4087068">p</span><span class="op" id="4087069">)</span><span class="op" id="4087070">,</span>&nbsp;<span class="builtintype" id="4087072">nil</span><br>
<span class="lineno">535</span><span class="op" id="4087076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4087079">//&nbsp;rangesMIMESize&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;it&nbsp;takes&nbsp;to&nbsp;encode&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4087148">//&nbsp;provided&nbsp;ranges&nbsp;as&nbsp;a&nbsp;multipart&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4087192">func</span>&nbsp;<span class="ident" id="4087197">rangesMIMESize</span><span class="op" id="4087211">(</span><span class="ident" id="4087212">ranges</span>&nbsp;<span class="op" id="4087219">[</span><span class="op" id="4087220">]</span><span class="ident" id="4087221">httpRange</span><span class="op" id="4087230">,</span>&nbsp;<span class="ident" id="4087232">contentType</span>&nbsp;<span class="builtintype" id="4087244">string</span><span class="op" id="4087250">,</span>&nbsp;<span class="ident" id="4087252">contentSize</span>&nbsp;<span class="ident" id="4087264">int64</span><span class="op" id="4087269">)</span>&nbsp;<span class="op" id="4087271">(</span><span class="ident" id="4087272">encSize</span>&nbsp;<span class="ident" id="4087280">int64</span><span class="op" id="4087285">)</span>&nbsp;<span class="op" id="4087287">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4087290">var</span>&nbsp;<span class="ident" id="4087294">w</span>&nbsp;<span class="ident" id="4087296">countingWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4087312">mw</span>&nbsp;<span class="op" id="4087315">:=</span>&nbsp;<span class="ident" id="4087318">multipart</span><span class="op" id="4087327">.</span><span class="ident" id="4087328">NewWriter</span><span class="op" id="4087337">(</span><span class="op" id="4087338">&amp;</span><span class="ident" id="4087339">w</span><span class="op" id="4087340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4087343">for</span>&nbsp;<span class="ident" id="4087347">_</span><span class="op" id="4087348">,</span>&nbsp;<span class="ident" id="4087350">ra</span>&nbsp;<span class="op" id="4087353">:=</span>&nbsp;<span class="keyword" id="4087356">range</span>&nbsp;<span class="ident" id="4087362">ranges</span>&nbsp;<span class="op" id="4087369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4087373">mw</span><span class="op" id="4087375">.</span><span class="ident" id="4087376">CreatePart</span><span class="op" id="4087386">(</span><span class="ident" id="4087387">ra</span><span class="op" id="4087389">.</span><span class="ident" id="4087390">mimeHeader</span><span class="op" id="4087400">(</span><span class="ident" id="4087401">contentType</span><span class="op" id="4087412">,</span>&nbsp;<span class="ident" id="4087414">contentSize</span><span class="op" id="4087425">)</span><span class="op" id="4087426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4087430">encSize</span>&nbsp;<span class="op" id="4087438">+=</span>&nbsp;<span class="ident" id="4087441">ra</span><span class="op" id="4087443">.</span><span class="ident" id="4087444">length</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4087452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4087455">mw</span><span class="op" id="4087457">.</span><span class="ident" id="4087458">Close</span><span class="op" id="4087463">(</span><span class="op" id="4087464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4087467">encSize</span>&nbsp;<span class="op" id="4087475">+=</span>&nbsp;<span class="ident" id="4087478">int64</span><span class="op" id="4087483">(</span><span class="ident" id="4087484">w</span><span class="op" id="4087485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4087488">return</span><br>
<span class="lineno"></span><span class="op" id="4087495">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="4087498">func</span>&nbsp;<span class="ident" id="4087503">sumRangesSize</span><span class="op" id="4087516">(</span><span class="ident" id="4087517">ranges</span>&nbsp;<span class="op" id="4087524">[</span><span class="op" id="4087525">]</span><span class="ident" id="4087526">httpRange</span><span class="op" id="4087535">)</span>&nbsp;<span class="op" id="4087537">(</span><span class="ident" id="4087538">size</span>&nbsp;<span class="ident" id="4087543">int64</span><span class="op" id="4087548">)</span>&nbsp;<span class="op" id="4087550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4087553">for</span>&nbsp;<span class="ident" id="4087557">_</span><span class="op" id="4087558">,</span>&nbsp;<span class="ident" id="4087560">ra</span>&nbsp;<span class="op" id="4087563">:=</span>&nbsp;<span class="keyword" id="4087566">range</span>&nbsp;<span class="ident" id="4087572">ranges</span>&nbsp;<span class="op" id="4087579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4087583">size</span>&nbsp;<span class="op" id="4087588">+=</span>&nbsp;<span class="ident" id="4087591">ra</span><span class="op" id="4087593">.</span><span class="ident" id="4087594">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4087602">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4087605">return</span><br>
<span class="lineno"></span><span class="op" id="4087612">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
