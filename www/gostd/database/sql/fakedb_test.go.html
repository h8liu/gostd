<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7565011">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7565066">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7565120">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7565171">package</span>&nbsp;<span class="ident" id="7565179">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7565184">import</span>&nbsp;<span class="op" id="7565191">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7565194">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7565217">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7565227">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7565234">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7565240">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7565247">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7565255">&#34;strconv&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7565266">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7565277">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7565285">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7565296">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7565303">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7565306">var</span>&nbsp;<span class="ident" id="7565310">_</span>&nbsp;<span class="op" id="7565312">=</span>&nbsp;<span class="ident" id="7565314">log</span><span class="op" id="7565317">.</span><span class="ident" id="7565318">Printf</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7565326">//&nbsp;fakeDriver&nbsp;is&nbsp;a&nbsp;fake&nbsp;database&nbsp;that&nbsp;implements&nbsp;Go&#39;s&nbsp;driver.Driver</span><br>
<span class="lineno"></span><span class="comment" id="7565394">//&nbsp;interface,&nbsp;just&nbsp;for&nbsp;testing.</span><br>
<span class="lineno">25</span><span class="comment" id="7565426">//</span><br>
<span class="lineno"></span><span class="comment" id="7565429">//&nbsp;It&nbsp;speaks&nbsp;a&nbsp;query&nbsp;language&nbsp;that&#39;s&nbsp;semantically&nbsp;similar&nbsp;to&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="7565494">//&nbsp;syntactically&nbsp;different&nbsp;and&nbsp;simpler&nbsp;than&nbsp;SQL.&nbsp;&nbsp;The&nbsp;syntax&nbsp;is&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="7565561">//&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="7565573">//</span><br>
<span class="lineno">30</span><span class="comment" id="7565576">//&nbsp;&nbsp;&nbsp;WIPE</span><br>
<span class="lineno"></span><span class="comment" id="7565586">//&nbsp;&nbsp;&nbsp;CREATE|&lt;tablename&gt;|&lt;col&gt;=&lt;type&gt;,&lt;col&gt;=&lt;type&gt;,...</span><br>
<span class="lineno"></span><span class="comment" id="7565640">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;types&nbsp;are:&nbsp;&#34;string&#34;,&nbsp;[u]int{8,16,32,64},&nbsp;&#34;bool&#34;</span><br>
<span class="lineno"></span><span class="comment" id="7565701">//&nbsp;&nbsp;&nbsp;INSERT|&lt;tablename&gt;|col=val,col2=val2,col3=?</span><br>
<span class="lineno"></span><span class="comment" id="7565750">//&nbsp;&nbsp;&nbsp;SELECT|&lt;tablename&gt;|projectcol1,projectcol2|filtercol=?,filtercol2=?</span><br>
<span class="lineno">35</span><span class="comment" id="7565823">//</span><br>
<span class="lineno"></span><span class="comment" id="7565826">//&nbsp;When&nbsp;opening&nbsp;a&nbsp;fakeDriver&#39;s&nbsp;database,&nbsp;it&nbsp;starts&nbsp;empty&nbsp;with&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="7565891">//&nbsp;tables.&nbsp;&nbsp;All&nbsp;tables&nbsp;and&nbsp;data&nbsp;are&nbsp;stored&nbsp;in&nbsp;memory&nbsp;only.</span><br>
<span class="lineno"></span><span class="keyword" id="7565950">type</span>&nbsp;<span class="ident" id="7565955">fakeDriver</span>&nbsp;<span class="keyword" id="7565966">struct</span>&nbsp;<span class="op" id="7565973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7565976">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7565987">sync</span><span class="op" id="7565991">.</span><span class="ident" id="7565992">Mutex</span>&nbsp;<span class="comment" id="7565998">//&nbsp;guards&nbsp;3&nbsp;following&nbsp;fields</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566028">openCount</span>&nbsp;&nbsp;<span class="builtintype" id="7566039">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7566050">//&nbsp;conn&nbsp;opens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566065">closeCount</span>&nbsp;<span class="builtintype" id="7566076">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7566087">//&nbsp;conn&nbsp;closes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566103">waitCh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7566114">chan</span>&nbsp;<span class="keyword" id="7566119">struct</span><span class="op" id="7566125">{</span><span class="op" id="7566126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566129">waitingCh</span>&nbsp;&nbsp;<span class="keyword" id="7566140">chan</span>&nbsp;<span class="keyword" id="7566145">struct</span><span class="op" id="7566151">{</span><span class="op" id="7566152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566155">dbs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7566166">map</span><span class="op" id="7566169">[</span><span class="builtintype" id="7566170">string</span><span class="op" id="7566176">]</span><span class="op" id="7566177">*</span><span class="ident" id="7566178">fakeDB</span><br>
<span class="lineno">45</span><span class="op" id="7566185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7566188">type</span>&nbsp;<span class="ident" id="7566193">fakeDB</span>&nbsp;<span class="keyword" id="7566200">struct</span>&nbsp;<span class="op" id="7566207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566210">name</span>&nbsp;<span class="builtintype" id="7566215">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566224">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7566232">sync</span><span class="op" id="7566236">.</span><span class="ident" id="7566237">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566244">free</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7566252">[</span><span class="op" id="7566253">]</span><span class="op" id="7566254">*</span><span class="ident" id="7566255">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566265">tables</span>&nbsp;&nbsp;<span class="keyword" id="7566273">map</span><span class="op" id="7566276">[</span><span class="builtintype" id="7566277">string</span><span class="op" id="7566283">]</span><span class="op" id="7566284">*</span><span class="ident" id="7566285">table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566292">badConn</span>&nbsp;<span class="builtintype" id="7566300">bool</span><br>
<span class="lineno"></span><span class="op" id="7566305">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="7566308">type</span>&nbsp;<span class="ident" id="7566313">table</span>&nbsp;<span class="keyword" id="7566319">struct</span>&nbsp;<span class="op" id="7566326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566329">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7566337">sync</span><span class="op" id="7566341">.</span><span class="ident" id="7566342">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566349">colname</span>&nbsp;<span class="op" id="7566357">[</span><span class="op" id="7566358">]</span><span class="builtintype" id="7566359">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566367">coltype</span>&nbsp;<span class="op" id="7566375">[</span><span class="op" id="7566376">]</span><span class="builtintype" id="7566377">string</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566385">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7566393">[</span><span class="op" id="7566394">]</span><span class="op" id="7566395">*</span><span class="ident" id="7566396">row</span><br>
<span class="lineno"></span><span class="op" id="7566400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7566403">func</span>&nbsp;<span class="op" id="7566408">(</span><span class="ident" id="7566409">t</span>&nbsp;<span class="op" id="7566411">*</span><span class="ident" id="7566412">table</span><span class="op" id="7566417">)</span>&nbsp;<span class="ident" id="7566419">columnIndex</span><span class="op" id="7566430">(</span><span class="ident" id="7566431">name</span>&nbsp;<span class="builtintype" id="7566436">string</span><span class="op" id="7566442">)</span>&nbsp;<span class="builtintype" id="7566444">int</span>&nbsp;<span class="op" id="7566448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566451">for</span>&nbsp;<span class="ident" id="7566455">n</span><span class="op" id="7566456">,</span>&nbsp;<span class="ident" id="7566458">nname</span>&nbsp;<span class="op" id="7566464">:=</span>&nbsp;<span class="keyword" id="7566467">range</span>&nbsp;<span class="ident" id="7566473">t</span><span class="op" id="7566474">.</span><span class="ident" id="7566475">colname</span>&nbsp;<span class="op" id="7566483">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566487">if</span>&nbsp;<span class="ident" id="7566490">name</span>&nbsp;<span class="op" id="7566495">==</span>&nbsp;<span class="ident" id="7566498">nname</span>&nbsp;<span class="op" id="7566504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566509">return</span>&nbsp;<span class="ident" id="7566516">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7566520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7566523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566526">return</span>&nbsp;<span class="op" id="7566533">-</span><span class="num" id="7566534">1</span><br>
<span class="lineno">70</span><span class="op" id="7566536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7566539">type</span>&nbsp;<span class="ident" id="7566544">row</span>&nbsp;<span class="keyword" id="7566548">struct</span>&nbsp;<span class="op" id="7566555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566558">cols</span>&nbsp;<span class="op" id="7566563">[</span><span class="op" id="7566564">]</span><span class="keyword" id="7566565">interface</span><span class="op" id="7566574">{</span><span class="op" id="7566575">}</span>&nbsp;<span class="comment" id="7566577">//&nbsp;must&nbsp;be&nbsp;same&nbsp;size&nbsp;as&nbsp;its&nbsp;table&nbsp;colname&nbsp;+&nbsp;coltype</span><br>
<span class="lineno"></span><span class="op" id="7566629">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="7566632">func</span>&nbsp;<span class="op" id="7566637">(</span><span class="ident" id="7566638">r</span>&nbsp;<span class="op" id="7566640">*</span><span class="ident" id="7566641">row</span><span class="op" id="7566644">)</span>&nbsp;<span class="ident" id="7566646">clone</span><span class="op" id="7566651">(</span><span class="op" id="7566652">)</span>&nbsp;<span class="op" id="7566654">*</span><span class="ident" id="7566655">row</span>&nbsp;<span class="op" id="7566659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566662">nrow</span>&nbsp;<span class="op" id="7566667">:=</span>&nbsp;<span class="op" id="7566670">&amp;</span><span class="ident" id="7566671">row</span><span class="op" id="7566674">{</span><span class="ident" id="7566675">cols</span><span class="op" id="7566679">:</span>&nbsp;<span class="builtinfunc" id="7566681">make</span><span class="op" id="7566685">(</span><span class="op" id="7566686">[</span><span class="op" id="7566687">]</span><span class="keyword" id="7566688">interface</span><span class="op" id="7566697">{</span><span class="op" id="7566698">}</span><span class="op" id="7566699">,</span>&nbsp;<span class="builtinfunc" id="7566701">len</span><span class="op" id="7566704">(</span><span class="ident" id="7566705">r</span><span class="op" id="7566706">.</span><span class="ident" id="7566707">cols</span><span class="op" id="7566711">)</span><span class="op" id="7566712">)</span><span class="op" id="7566713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7566716">copy</span><span class="op" id="7566720">(</span><span class="ident" id="7566721">nrow</span><span class="op" id="7566725">.</span><span class="ident" id="7566726">cols</span><span class="op" id="7566730">,</span>&nbsp;<span class="ident" id="7566732">r</span><span class="op" id="7566733">.</span><span class="ident" id="7566734">cols</span><span class="op" id="7566738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7566741">return</span>&nbsp;<span class="ident" id="7566748">nrow</span><br>
<span class="lineno">80</span><span class="op" id="7566753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7566756">type</span>&nbsp;<span class="ident" id="7566761">fakeConn</span>&nbsp;<span class="keyword" id="7566770">struct</span>&nbsp;<span class="op" id="7566777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566780">db</span>&nbsp;<span class="op" id="7566783">*</span><span class="ident" id="7566784">fakeDB</span>&nbsp;<span class="comment" id="7566791">//&nbsp;where&nbsp;to&nbsp;return&nbsp;ourselves&nbsp;to</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566825">currTx</span>&nbsp;<span class="op" id="7566832">*</span><span class="ident" id="7566833">fakeTx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7566842">//&nbsp;Stats&nbsp;for&nbsp;tests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566863">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7566875">sync</span><span class="op" id="7566879">.</span><span class="ident" id="7566880">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566887">stmtsMade</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7566899">int</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566904">stmtsClosed</span>&nbsp;<span class="builtintype" id="7566916">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566921">numPrepare</span>&nbsp;&nbsp;<span class="builtintype" id="7566933">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566938">bad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7566950">bool</span><br>
<span class="lineno"></span><span class="op" id="7566955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7566958">func</span>&nbsp;<span class="op" id="7566963">(</span><span class="ident" id="7566964">c</span>&nbsp;<span class="op" id="7566966">*</span><span class="ident" id="7566967">fakeConn</span><span class="op" id="7566975">)</span>&nbsp;<span class="ident" id="7566977">incrStat</span><span class="op" id="7566985">(</span><span class="ident" id="7566986">v</span>&nbsp;<span class="op" id="7566988">*</span><span class="builtintype" id="7566989">int</span><span class="op" id="7566992">)</span>&nbsp;<span class="op" id="7566994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7566997">c</span><span class="op" id="7566998">.</span><span class="ident" id="7566999">mu</span><span class="op" id="7567001">.</span><span class="ident" id="7567002">Lock</span><span class="op" id="7567006">(</span><span class="op" id="7567007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7567010">*</span><span class="ident" id="7567011">v</span><span class="op" id="7567012">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567016">c</span><span class="op" id="7567017">.</span><span class="ident" id="7567018">mu</span><span class="op" id="7567020">.</span><span class="ident" id="7567021">Unlock</span><span class="op" id="7567027">(</span><span class="op" id="7567028">)</span><br>
<span class="lineno"></span><span class="op" id="7567030">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="7567033">type</span>&nbsp;<span class="ident" id="7567038">fakeTx</span>&nbsp;<span class="keyword" id="7567045">struct</span>&nbsp;<span class="op" id="7567052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567055">c</span>&nbsp;<span class="op" id="7567057">*</span><span class="ident" id="7567058">fakeConn</span><br>
<span class="lineno"></span><span class="op" id="7567067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="7567070">type</span>&nbsp;<span class="ident" id="7567075">fakeStmt</span>&nbsp;<span class="keyword" id="7567084">struct</span>&nbsp;<span class="op" id="7567091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567094">c</span>&nbsp;<span class="op" id="7567096">*</span><span class="ident" id="7567097">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567107">q</span>&nbsp;<span class="builtintype" id="7567109">string</span>&nbsp;<span class="comment" id="7567116">//&nbsp;just&nbsp;for&nbsp;debugging</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567140">cmd</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7567146">string</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567154">table</span>&nbsp;<span class="builtintype" id="7567160">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567169">closed</span>&nbsp;<span class="builtintype" id="7567176">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567183">colName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7567196">[</span><span class="op" id="7567197">]</span><span class="builtintype" id="7567198">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7567210">//&nbsp;used&nbsp;by&nbsp;CREATE,&nbsp;INSERT,&nbsp;SELECT&nbsp;(selected&nbsp;columns)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567264">colType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7567277">[</span><span class="op" id="7567278">]</span><span class="builtintype" id="7567279">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7567291">//&nbsp;used&nbsp;by&nbsp;CREATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567310">colValue</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7567323">[</span><span class="op" id="7567324">]</span><span class="keyword" id="7567325">interface</span><span class="op" id="7567334">{</span><span class="op" id="7567335">}</span>&nbsp;<span class="comment" id="7567337">//&nbsp;used&nbsp;by&nbsp;INSERT&nbsp;(mix&nbsp;of&nbsp;strings&nbsp;and&nbsp;&#34;?&#34;&nbsp;for&nbsp;bound&nbsp;params)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567398">placeholders</span>&nbsp;<span class="builtintype" id="7567411">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7567425">//&nbsp;used&nbsp;by&nbsp;INSERT/SELECT:&nbsp;number&nbsp;of&nbsp;?&nbsp;params</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567472">whereCol</span>&nbsp;<span class="op" id="7567481">[</span><span class="op" id="7567482">]</span><span class="builtintype" id="7567483">string</span>&nbsp;<span class="comment" id="7567490">//&nbsp;used&nbsp;by&nbsp;SELECT&nbsp;(all&nbsp;placeholders)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567529">placeholderConverter</span>&nbsp;<span class="op" id="7567550">[</span><span class="op" id="7567551">]</span><span class="ident" id="7567552">driver</span><span class="op" id="7567558">.</span><span class="ident" id="7567559">ValueConverter</span>&nbsp;<span class="comment" id="7567574">//&nbsp;used&nbsp;by&nbsp;INSERT</span><br>
<span class="lineno"></span><span class="op" id="7567592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7567595">var</span>&nbsp;<span class="ident" id="7567599">fdriver</span>&nbsp;<span class="ident" id="7567607">driver</span><span class="op" id="7567613">.</span><span class="ident" id="7567614">Driver</span>&nbsp;<span class="op" id="7567621">=</span>&nbsp;<span class="op" id="7567623">&amp;</span><span class="ident" id="7567624">fakeDriver</span><span class="op" id="7567634">{</span><span class="op" id="7567635">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="7567638">func</span>&nbsp;<span class="ident" id="7567643">init</span><span class="op" id="7567647">(</span><span class="op" id="7567648">)</span>&nbsp;<span class="op" id="7567650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567653">Register</span><span class="op" id="7567661">(</span><span class="string" id="7567662">&#34;test&#34;</span><span class="op" id="7567668">,</span>&nbsp;<span class="ident" id="7567670">fdriver</span><span class="op" id="7567677">)</span><br>
<span class="lineno"></span><span class="op" id="7567679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="7567682">func</span>&nbsp;<span class="ident" id="7567687">contains</span><span class="op" id="7567695">(</span><span class="ident" id="7567696">list</span>&nbsp;<span class="op" id="7567701">[</span><span class="op" id="7567702">]</span><span class="builtintype" id="7567703">string</span><span class="op" id="7567709">,</span>&nbsp;<span class="ident" id="7567711">y</span>&nbsp;<span class="builtintype" id="7567713">string</span><span class="op" id="7567719">)</span>&nbsp;<span class="builtintype" id="7567721">bool</span>&nbsp;<span class="op" id="7567726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7567729">for</span>&nbsp;<span class="ident" id="7567733">_</span><span class="op" id="7567734">,</span>&nbsp;<span class="ident" id="7567736">x</span>&nbsp;<span class="op" id="7567738">:=</span>&nbsp;<span class="keyword" id="7567741">range</span>&nbsp;<span class="ident" id="7567747">list</span>&nbsp;<span class="op" id="7567752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7567756">if</span>&nbsp;<span class="ident" id="7567759">x</span>&nbsp;<span class="op" id="7567761">==</span>&nbsp;<span class="ident" id="7567764">y</span>&nbsp;<span class="op" id="7567766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7567771">return</span>&nbsp;<span class="builtintype" id="7567778">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7567785">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7567788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7567791">return</span>&nbsp;<span class="builtintype" id="7567798">false</span><br>
<span class="lineno"></span><span class="op" id="7567804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7567807">type</span>&nbsp;<span class="ident" id="7567812">Dummy</span>&nbsp;<span class="keyword" id="7567818">struct</span>&nbsp;<span class="op" id="7567825">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567828">driver</span><span class="op" id="7567834">.</span><span class="ident" id="7567835">Driver</span><br>
<span class="lineno"></span><span class="op" id="7567842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7567845">func</span>&nbsp;<span class="ident" id="7567850">TestDrivers</span><span class="op" id="7567861">(</span><span class="ident" id="7567862">t</span>&nbsp;<span class="op" id="7567864">*</span><span class="ident" id="7567865">testing</span><span class="op" id="7567872">.</span><span class="ident" id="7567873">T</span><span class="op" id="7567874">)</span>&nbsp;<span class="op" id="7567876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567879">unregisterAllDrivers</span><span class="op" id="7567899">(</span><span class="op" id="7567900">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567903">Register</span><span class="op" id="7567911">(</span><span class="string" id="7567912">&#34;test&#34;</span><span class="op" id="7567918">,</span>&nbsp;<span class="ident" id="7567920">fdriver</span><span class="op" id="7567927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567930">Register</span><span class="op" id="7567938">(</span><span class="string" id="7567939">&#34;invalid&#34;</span><span class="op" id="7567948">,</span>&nbsp;<span class="ident" id="7567950">Dummy</span><span class="op" id="7567955">{</span><span class="op" id="7567956">}</span><span class="op" id="7567957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7567960">all</span>&nbsp;<span class="op" id="7567964">:=</span>&nbsp;<span class="ident" id="7567967">Drivers</span><span class="op" id="7567974">(</span><span class="op" id="7567975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7567978">if</span>&nbsp;<span class="builtinfunc" id="7567981">len</span><span class="op" id="7567984">(</span><span class="ident" id="7567985">all</span><span class="op" id="7567988">)</span>&nbsp;<span class="op" id="7567990">&lt;</span>&nbsp;<span class="num" id="7567992">2</span>&nbsp;<span class="op" id="7567994">||</span>&nbsp;<span class="op" id="7567997">!</span><span class="ident" id="7567998">sort</span><span class="op" id="7568002">.</span><span class="ident" id="7568003">StringsAreSorted</span><span class="op" id="7568019">(</span><span class="ident" id="7568020">all</span><span class="op" id="7568023">)</span>&nbsp;<span class="op" id="7568025">||</span>&nbsp;<span class="op" id="7568028">!</span><span class="ident" id="7568029">contains</span><span class="op" id="7568037">(</span><span class="ident" id="7568038">all</span><span class="op" id="7568041">,</span>&nbsp;<span class="string" id="7568043">&#34;test&#34;</span><span class="op" id="7568049">)</span>&nbsp;<span class="op" id="7568051">||</span>&nbsp;<span class="op" id="7568054">!</span><span class="ident" id="7568055">contains</span><span class="op" id="7568063">(</span><span class="ident" id="7568064">all</span><span class="op" id="7568067">,</span>&nbsp;<span class="string" id="7568069">&#34;invalid&#34;</span><span class="op" id="7568078">)</span>&nbsp;<span class="op" id="7568080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568084">t</span><span class="op" id="7568085">.</span><span class="ident" id="7568086">Fatalf</span><span class="op" id="7568092">(</span><span class="string" id="7568093">&#34;Drivers&nbsp;=&nbsp;%v,&nbsp;want&nbsp;sorted&nbsp;list&nbsp;with&nbsp;at&nbsp;least&nbsp;[invalid,&nbsp;test]&#34;</span><span class="op" id="7568155">,</span>&nbsp;<span class="ident" id="7568157">all</span><span class="op" id="7568160">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7568163">}</span><br>
<span class="lineno"></span><span class="op" id="7568165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7568168">//&nbsp;Supports&nbsp;dsn&nbsp;forms:</span><br>
<span class="lineno"></span><span class="comment" id="7568191">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;</span><br>
<span class="lineno">155</span><span class="comment" id="7568206">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;;&lt;opts&gt;&nbsp;&nbsp;(only&nbsp;currently&nbsp;supported&nbsp;option&nbsp;is&nbsp;`badConn`,</span><br>
<span class="lineno"></span><span class="comment" id="7568276">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;causes&nbsp;driver.ErrBadConn&nbsp;to&nbsp;be&nbsp;returned&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="7568349">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;every&nbsp;other&nbsp;conn.Begin())</span><br>
<span class="lineno"></span><span class="keyword" id="7568399">func</span>&nbsp;<span class="op" id="7568404">(</span><span class="ident" id="7568405">d</span>&nbsp;<span class="op" id="7568407">*</span><span class="ident" id="7568408">fakeDriver</span><span class="op" id="7568418">)</span>&nbsp;<span class="ident" id="7568420">Open</span><span class="op" id="7568424">(</span><span class="ident" id="7568425">dsn</span>&nbsp;<span class="builtintype" id="7568429">string</span><span class="op" id="7568435">)</span>&nbsp;<span class="op" id="7568437">(</span><span class="ident" id="7568438">driver</span><span class="op" id="7568444">.</span><span class="ident" id="7568445">Conn</span><span class="op" id="7568449">,</span>&nbsp;<span class="builtintype" id="7568451">error</span><span class="op" id="7568456">)</span>&nbsp;<span class="op" id="7568458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568461">parts</span>&nbsp;<span class="op" id="7568467">:=</span>&nbsp;<span class="ident" id="7568470">strings</span><span class="op" id="7568477">.</span><span class="ident" id="7568478">Split</span><span class="op" id="7568483">(</span><span class="ident" id="7568484">dsn</span><span class="op" id="7568487">,</span>&nbsp;<span class="string" id="7568489">&#34;;&#34;</span><span class="op" id="7568492">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7568495">if</span>&nbsp;<span class="builtinfunc" id="7568498">len</span><span class="op" id="7568501">(</span><span class="ident" id="7568502">parts</span><span class="op" id="7568507">)</span>&nbsp;<span class="op" id="7568509">&lt;</span>&nbsp;<span class="num" id="7568511">1</span>&nbsp;<span class="op" id="7568513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7568517">return</span>&nbsp;<span class="ident" id="7568524">nil</span><span class="op" id="7568527">,</span>&nbsp;<span class="ident" id="7568529">errors</span><span class="op" id="7568535">.</span><span class="ident" id="7568536">New</span><span class="op" id="7568539">(</span><span class="string" id="7568540">&#34;fakedb:&nbsp;no&nbsp;database&nbsp;name&#34;</span><span class="op" id="7568566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7568569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568572">name</span>&nbsp;<span class="op" id="7568577">:=</span>&nbsp;<span class="ident" id="7568580">parts</span><span class="op" id="7568585">[</span><span class="num" id="7568586">0</span><span class="op" id="7568587">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568591">db</span>&nbsp;<span class="op" id="7568594">:=</span>&nbsp;<span class="ident" id="7568597">d</span><span class="op" id="7568598">.</span><span class="ident" id="7568599">getDB</span><span class="op" id="7568604">(</span><span class="ident" id="7568605">name</span><span class="op" id="7568609">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568613">d</span><span class="op" id="7568614">.</span><span class="ident" id="7568615">mu</span><span class="op" id="7568617">.</span><span class="ident" id="7568618">Lock</span><span class="op" id="7568622">(</span><span class="op" id="7568623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568626">d</span><span class="op" id="7568627">.</span><span class="ident" id="7568628">openCount</span><span class="op" id="7568637">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568641">d</span><span class="op" id="7568642">.</span><span class="ident" id="7568643">mu</span><span class="op" id="7568645">.</span><span class="ident" id="7568646">Unlock</span><span class="op" id="7568652">(</span><span class="op" id="7568653">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568656">conn</span>&nbsp;<span class="op" id="7568661">:=</span>&nbsp;<span class="op" id="7568664">&amp;</span><span class="ident" id="7568665">fakeConn</span><span class="op" id="7568673">{</span><span class="ident" id="7568674">db</span><span class="op" id="7568676">:</span>&nbsp;<span class="ident" id="7568678">db</span><span class="op" id="7568680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7568684">if</span>&nbsp;<span class="builtinfunc" id="7568687">len</span><span class="op" id="7568690">(</span><span class="ident" id="7568691">parts</span><span class="op" id="7568696">)</span>&nbsp;<span class="op" id="7568698">&gt;=</span>&nbsp;<span class="num" id="7568701">2</span>&nbsp;<span class="op" id="7568703">&amp;&amp;</span>&nbsp;<span class="ident" id="7568706">parts</span><span class="op" id="7568711">[</span><span class="num" id="7568712">1</span><span class="op" id="7568713">]</span>&nbsp;<span class="op" id="7568715">==</span>&nbsp;<span class="string" id="7568718">&#34;badConn&#34;</span>&nbsp;<span class="op" id="7568728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568732">conn</span><span class="op" id="7568736">.</span><span class="ident" id="7568737">bad</span>&nbsp;<span class="op" id="7568741">=</span>&nbsp;<span class="builtintype" id="7568743">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7568749">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7568752">if</span>&nbsp;<span class="ident" id="7568755">d</span><span class="op" id="7568756">.</span><span class="ident" id="7568757">waitCh</span>&nbsp;<span class="op" id="7568764">!=</span>&nbsp;<span class="ident" id="7568767">nil</span>&nbsp;<span class="op" id="7568771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568775">d</span><span class="op" id="7568776">.</span><span class="ident" id="7568777">waitingCh</span>&nbsp;<span class="op" id="7568787">&lt;-</span>&nbsp;<span class="keyword" id="7568790">struct</span><span class="op" id="7568796">{</span><span class="op" id="7568797">}</span><span class="op" id="7568798">{</span><span class="op" id="7568799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7568803">&lt;-</span><span class="ident" id="7568805">d</span><span class="op" id="7568806">.</span><span class="ident" id="7568807">waitCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568816">d</span><span class="op" id="7568817">.</span><span class="ident" id="7568818">waitCh</span>&nbsp;<span class="op" id="7568825">=</span>&nbsp;<span class="ident" id="7568827">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568833">d</span><span class="op" id="7568834">.</span><span class="ident" id="7568835">waitingCh</span>&nbsp;<span class="op" id="7568845">=</span>&nbsp;<span class="ident" id="7568847">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7568852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7568855">return</span>&nbsp;<span class="ident" id="7568862">conn</span><span class="op" id="7568866">,</span>&nbsp;<span class="ident" id="7568868">nil</span><br>
<span class="lineno"></span><span class="op" id="7568872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7568875">func</span>&nbsp;<span class="op" id="7568880">(</span><span class="ident" id="7568881">d</span>&nbsp;<span class="op" id="7568883">*</span><span class="ident" id="7568884">fakeDriver</span><span class="op" id="7568894">)</span>&nbsp;<span class="ident" id="7568896">getDB</span><span class="op" id="7568901">(</span><span class="ident" id="7568902">name</span>&nbsp;<span class="builtintype" id="7568907">string</span><span class="op" id="7568913">)</span>&nbsp;<span class="op" id="7568915">*</span><span class="ident" id="7568916">fakeDB</span>&nbsp;<span class="op" id="7568923">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568926">d</span><span class="op" id="7568927">.</span><span class="ident" id="7568928">mu</span><span class="op" id="7568930">.</span><span class="ident" id="7568931">Lock</span><span class="op" id="7568935">(</span><span class="op" id="7568936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7568939">defer</span>&nbsp;<span class="ident" id="7568945">d</span><span class="op" id="7568946">.</span><span class="ident" id="7568947">mu</span><span class="op" id="7568949">.</span><span class="ident" id="7568950">Unlock</span><span class="op" id="7568956">(</span><span class="op" id="7568957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7568960">if</span>&nbsp;<span class="ident" id="7568963">d</span><span class="op" id="7568964">.</span><span class="ident" id="7568965">dbs</span>&nbsp;<span class="op" id="7568969">==</span>&nbsp;<span class="ident" id="7568972">nil</span>&nbsp;<span class="op" id="7568976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7568980">d</span><span class="op" id="7568981">.</span><span class="ident" id="7568982">dbs</span>&nbsp;<span class="op" id="7568986">=</span>&nbsp;<span class="builtinfunc" id="7568988">make</span><span class="op" id="7568992">(</span><span class="keyword" id="7568993">map</span><span class="op" id="7568996">[</span><span class="builtintype" id="7568997">string</span><span class="op" id="7569003">]</span><span class="op" id="7569004">*</span><span class="ident" id="7569005">fakeDB</span><span class="op" id="7569011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7569014">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569017">db</span><span class="op" id="7569019">,</span>&nbsp;<span class="ident" id="7569021">ok</span>&nbsp;<span class="op" id="7569024">:=</span>&nbsp;<span class="ident" id="7569027">d</span><span class="op" id="7569028">.</span><span class="ident" id="7569029">dbs</span><span class="op" id="7569032">[</span><span class="ident" id="7569033">name</span><span class="op" id="7569037">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569040">if</span>&nbsp;<span class="op" id="7569043">!</span><span class="ident" id="7569044">ok</span>&nbsp;<span class="op" id="7569047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569051">db</span>&nbsp;<span class="op" id="7569054">=</span>&nbsp;<span class="op" id="7569056">&amp;</span><span class="ident" id="7569057">fakeDB</span><span class="op" id="7569063">{</span><span class="ident" id="7569064">name</span><span class="op" id="7569068">:</span>&nbsp;<span class="ident" id="7569070">name</span><span class="op" id="7569074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569078">d</span><span class="op" id="7569079">.</span><span class="ident" id="7569080">dbs</span><span class="op" id="7569083">[</span><span class="ident" id="7569084">name</span><span class="op" id="7569088">]</span>&nbsp;<span class="op" id="7569090">=</span>&nbsp;<span class="ident" id="7569092">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7569096">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569099">return</span>&nbsp;<span class="ident" id="7569106">db</span><br>
<span class="lineno"></span><span class="op" id="7569109">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7569112">func</span>&nbsp;<span class="op" id="7569117">(</span><span class="ident" id="7569118">db</span>&nbsp;<span class="op" id="7569121">*</span><span class="ident" id="7569122">fakeDB</span><span class="op" id="7569128">)</span>&nbsp;<span class="ident" id="7569130">wipe</span><span class="op" id="7569134">(</span><span class="op" id="7569135">)</span>&nbsp;<span class="op" id="7569137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569140">db</span><span class="op" id="7569142">.</span><span class="ident" id="7569143">mu</span><span class="op" id="7569145">.</span><span class="ident" id="7569146">Lock</span><span class="op" id="7569150">(</span><span class="op" id="7569151">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569154">defer</span>&nbsp;<span class="ident" id="7569160">db</span><span class="op" id="7569162">.</span><span class="ident" id="7569163">mu</span><span class="op" id="7569165">.</span><span class="ident" id="7569166">Unlock</span><span class="op" id="7569172">(</span><span class="op" id="7569173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569176">db</span><span class="op" id="7569178">.</span><span class="ident" id="7569179">tables</span>&nbsp;<span class="op" id="7569186">=</span>&nbsp;<span class="ident" id="7569188">nil</span><br>
<span class="lineno"></span><span class="op" id="7569192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7569195">func</span>&nbsp;<span class="op" id="7569200">(</span><span class="ident" id="7569201">db</span>&nbsp;<span class="op" id="7569204">*</span><span class="ident" id="7569205">fakeDB</span><span class="op" id="7569211">)</span>&nbsp;<span class="ident" id="7569213">createTable</span><span class="op" id="7569224">(</span><span class="ident" id="7569225">name</span>&nbsp;<span class="builtintype" id="7569230">string</span><span class="op" id="7569236">,</span>&nbsp;<span class="ident" id="7569238">columnNames</span><span class="op" id="7569249">,</span>&nbsp;<span class="ident" id="7569251">columnTypes</span>&nbsp;<span class="op" id="7569263">[</span><span class="op" id="7569264">]</span><span class="builtintype" id="7569265">string</span><span class="op" id="7569271">)</span>&nbsp;<span class="builtintype" id="7569273">error</span>&nbsp;<span class="op" id="7569279">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569282">db</span><span class="op" id="7569284">.</span><span class="ident" id="7569285">mu</span><span class="op" id="7569287">.</span><span class="ident" id="7569288">Lock</span><span class="op" id="7569292">(</span><span class="op" id="7569293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569296">defer</span>&nbsp;<span class="ident" id="7569302">db</span><span class="op" id="7569304">.</span><span class="ident" id="7569305">mu</span><span class="op" id="7569307">.</span><span class="ident" id="7569308">Unlock</span><span class="op" id="7569314">(</span><span class="op" id="7569315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569318">if</span>&nbsp;<span class="ident" id="7569321">db</span><span class="op" id="7569323">.</span><span class="ident" id="7569324">tables</span>&nbsp;<span class="op" id="7569331">==</span>&nbsp;<span class="ident" id="7569334">nil</span>&nbsp;<span class="op" id="7569338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569342">db</span><span class="op" id="7569344">.</span><span class="ident" id="7569345">tables</span>&nbsp;<span class="op" id="7569352">=</span>&nbsp;<span class="builtinfunc" id="7569354">make</span><span class="op" id="7569358">(</span><span class="keyword" id="7569359">map</span><span class="op" id="7569362">[</span><span class="builtintype" id="7569363">string</span><span class="op" id="7569369">]</span><span class="op" id="7569370">*</span><span class="ident" id="7569371">table</span><span class="op" id="7569376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7569379">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569382">if</span>&nbsp;<span class="ident" id="7569385">_</span><span class="op" id="7569386">,</span>&nbsp;<span class="ident" id="7569388">exist</span>&nbsp;<span class="op" id="7569394">:=</span>&nbsp;<span class="ident" id="7569397">db</span><span class="op" id="7569399">.</span><span class="ident" id="7569400">tables</span><span class="op" id="7569406">[</span><span class="ident" id="7569407">name</span><span class="op" id="7569411">]</span><span class="op" id="7569412">;</span>&nbsp;<span class="ident" id="7569414">exist</span>&nbsp;<span class="op" id="7569420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569424">return</span>&nbsp;<span class="ident" id="7569431">fmt</span><span class="op" id="7569434">.</span><span class="ident" id="7569435">Errorf</span><span class="op" id="7569441">(</span><span class="string" id="7569442">&#34;table&nbsp;%q&nbsp;already&nbsp;exists&#34;</span><span class="op" id="7569467">,</span>&nbsp;<span class="ident" id="7569469">name</span><span class="op" id="7569473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7569476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569479">if</span>&nbsp;<span class="builtinfunc" id="7569482">len</span><span class="op" id="7569485">(</span><span class="ident" id="7569486">columnNames</span><span class="op" id="7569497">)</span>&nbsp;<span class="op" id="7569499">!=</span>&nbsp;<span class="builtinfunc" id="7569502">len</span><span class="op" id="7569505">(</span><span class="ident" id="7569506">columnTypes</span><span class="op" id="7569517">)</span>&nbsp;<span class="op" id="7569519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569523">return</span>&nbsp;<span class="ident" id="7569530">fmt</span><span class="op" id="7569533">.</span><span class="ident" id="7569534">Errorf</span><span class="op" id="7569540">(</span><span class="string" id="7569541">&#34;create&nbsp;table&nbsp;of&nbsp;%q&nbsp;len(names)&nbsp;!=&nbsp;len(types):&nbsp;%d&nbsp;vs&nbsp;%d&#34;</span><span class="op" id="7569596">,</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569601">name</span><span class="op" id="7569605">,</span>&nbsp;<span class="builtinfunc" id="7569607">len</span><span class="op" id="7569610">(</span><span class="ident" id="7569611">columnNames</span><span class="op" id="7569622">)</span><span class="op" id="7569623">,</span>&nbsp;<span class="builtinfunc" id="7569625">len</span><span class="op" id="7569628">(</span><span class="ident" id="7569629">columnTypes</span><span class="op" id="7569640">)</span><span class="op" id="7569641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7569644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569647">db</span><span class="op" id="7569649">.</span><span class="ident" id="7569650">tables</span><span class="op" id="7569656">[</span><span class="ident" id="7569657">name</span><span class="op" id="7569661">]</span>&nbsp;<span class="op" id="7569663">=</span>&nbsp;<span class="op" id="7569665">&amp;</span><span class="ident" id="7569666">table</span><span class="op" id="7569671">{</span><span class="ident" id="7569672">colname</span><span class="op" id="7569679">:</span>&nbsp;<span class="ident" id="7569681">columnNames</span><span class="op" id="7569692">,</span>&nbsp;<span class="ident" id="7569694">coltype</span><span class="op" id="7569701">:</span>&nbsp;<span class="ident" id="7569703">columnTypes</span><span class="op" id="7569714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569717">return</span>&nbsp;<span class="ident" id="7569724">nil</span><br>
<span class="lineno"></span><span class="op" id="7569728">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="7569731">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;db.mu&nbsp;lock&nbsp;held</span><br>
<span class="lineno"></span><span class="keyword" id="7569770">func</span>&nbsp;<span class="op" id="7569775">(</span><span class="ident" id="7569776">db</span>&nbsp;<span class="op" id="7569779">*</span><span class="ident" id="7569780">fakeDB</span><span class="op" id="7569786">)</span>&nbsp;<span class="ident" id="7569788">table</span><span class="op" id="7569793">(</span><span class="ident" id="7569794">table</span>&nbsp;<span class="builtintype" id="7569800">string</span><span class="op" id="7569806">)</span>&nbsp;<span class="op" id="7569808">(</span><span class="op" id="7569809">*</span><span class="ident" id="7569810">table</span><span class="op" id="7569815">,</span>&nbsp;<span class="builtintype" id="7569817">bool</span><span class="op" id="7569821">)</span>&nbsp;<span class="op" id="7569823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569826">if</span>&nbsp;<span class="ident" id="7569829">db</span><span class="op" id="7569831">.</span><span class="ident" id="7569832">tables</span>&nbsp;<span class="op" id="7569839">==</span>&nbsp;<span class="ident" id="7569842">nil</span>&nbsp;<span class="op" id="7569846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569850">return</span>&nbsp;<span class="ident" id="7569857">nil</span><span class="op" id="7569860">,</span>&nbsp;<span class="builtintype" id="7569862">false</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7569869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569872">t</span><span class="op" id="7569873">,</span>&nbsp;<span class="ident" id="7569875">ok</span>&nbsp;<span class="op" id="7569878">:=</span>&nbsp;<span class="ident" id="7569881">db</span><span class="op" id="7569883">.</span><span class="ident" id="7569884">tables</span><span class="op" id="7569890">[</span><span class="ident" id="7569891">table</span><span class="op" id="7569896">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7569899">return</span>&nbsp;<span class="ident" id="7569906">t</span><span class="op" id="7569907">,</span>&nbsp;<span class="ident" id="7569909">ok</span><br>
<span class="lineno"></span><span class="op" id="7569912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="7569915">func</span>&nbsp;<span class="op" id="7569920">(</span><span class="ident" id="7569921">db</span>&nbsp;<span class="op" id="7569924">*</span><span class="ident" id="7569925">fakeDB</span><span class="op" id="7569931">)</span>&nbsp;<span class="ident" id="7569933">columnType</span><span class="op" id="7569943">(</span><span class="ident" id="7569944">table</span><span class="op" id="7569949">,</span>&nbsp;<span class="ident" id="7569951">column</span>&nbsp;<span class="builtintype" id="7569958">string</span><span class="op" id="7569964">)</span>&nbsp;<span class="op" id="7569966">(</span><span class="ident" id="7569967">typ</span>&nbsp;<span class="builtintype" id="7569971">string</span><span class="op" id="7569977">,</span>&nbsp;<span class="ident" id="7569979">ok</span>&nbsp;<span class="builtintype" id="7569982">bool</span><span class="op" id="7569986">)</span>&nbsp;<span class="op" id="7569988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7569991">db</span><span class="op" id="7569993">.</span><span class="ident" id="7569994">mu</span><span class="op" id="7569996">.</span><span class="ident" id="7569997">Lock</span><span class="op" id="7570001">(</span><span class="op" id="7570002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570005">defer</span>&nbsp;<span class="ident" id="7570011">db</span><span class="op" id="7570013">.</span><span class="ident" id="7570014">mu</span><span class="op" id="7570016">.</span><span class="ident" id="7570017">Unlock</span><span class="op" id="7570023">(</span><span class="op" id="7570024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7570027">t</span><span class="op" id="7570028">,</span>&nbsp;<span class="ident" id="7570030">ok</span>&nbsp;<span class="op" id="7570033">:=</span>&nbsp;<span class="ident" id="7570036">db</span><span class="op" id="7570038">.</span><span class="ident" id="7570039">table</span><span class="op" id="7570044">(</span><span class="ident" id="7570045">table</span><span class="op" id="7570050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570053">if</span>&nbsp;<span class="op" id="7570056">!</span><span class="ident" id="7570057">ok</span>&nbsp;<span class="op" id="7570060">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570064">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7570072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570075">for</span>&nbsp;<span class="ident" id="7570079">n</span><span class="op" id="7570080">,</span>&nbsp;<span class="ident" id="7570082">cname</span>&nbsp;<span class="op" id="7570088">:=</span>&nbsp;<span class="keyword" id="7570091">range</span>&nbsp;<span class="ident" id="7570097">t</span><span class="op" id="7570098">.</span><span class="ident" id="7570099">colname</span>&nbsp;<span class="op" id="7570107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570111">if</span>&nbsp;<span class="ident" id="7570114">cname</span>&nbsp;<span class="op" id="7570120">==</span>&nbsp;<span class="ident" id="7570123">column</span>&nbsp;<span class="op" id="7570130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570135">return</span>&nbsp;<span class="ident" id="7570142">t</span><span class="op" id="7570143">.</span><span class="ident" id="7570144">coltype</span><span class="op" id="7570151">[</span><span class="ident" id="7570152">n</span><span class="op" id="7570153">]</span><span class="op" id="7570154">,</span>&nbsp;<span class="builtintype" id="7570156">true</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7570163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7570166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570169">return</span>&nbsp;<span class="string" id="7570176">&#34;&#34;</span><span class="op" id="7570178">,</span>&nbsp;<span class="builtintype" id="7570180">false</span><br>
<span class="lineno"></span><span class="op" id="7570186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="keyword" id="7570189">func</span>&nbsp;<span class="op" id="7570194">(</span><span class="ident" id="7570195">c</span>&nbsp;<span class="op" id="7570197">*</span><span class="ident" id="7570198">fakeConn</span><span class="op" id="7570206">)</span>&nbsp;<span class="ident" id="7570208">isBad</span><span class="op" id="7570213">(</span><span class="op" id="7570214">)</span>&nbsp;<span class="builtintype" id="7570216">bool</span>&nbsp;<span class="op" id="7570221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7570224">//&nbsp;if&nbsp;not&nbsp;simulating&nbsp;bad&nbsp;conn,&nbsp;do&nbsp;nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570267">if</span>&nbsp;<span class="op" id="7570270">!</span><span class="ident" id="7570271">c</span><span class="op" id="7570272">.</span><span class="ident" id="7570273">bad</span>&nbsp;<span class="op" id="7570277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570281">return</span>&nbsp;<span class="builtintype" id="7570288">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7570295">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7570298">//&nbsp;alternate&nbsp;between&nbsp;bad&nbsp;conn&nbsp;and&nbsp;not&nbsp;bad&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7570346">c</span><span class="op" id="7570347">.</span><span class="ident" id="7570348">db</span><span class="op" id="7570350">.</span><span class="ident" id="7570351">badConn</span>&nbsp;<span class="op" id="7570359">=</span>&nbsp;<span class="op" id="7570361">!</span><span class="ident" id="7570362">c</span><span class="op" id="7570363">.</span><span class="ident" id="7570364">db</span><span class="op" id="7570366">.</span><span class="ident" id="7570367">badConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570376">return</span>&nbsp;<span class="ident" id="7570383">c</span><span class="op" id="7570384">.</span><span class="ident" id="7570385">db</span><span class="op" id="7570387">.</span><span class="ident" id="7570388">badConn</span><br>
<span class="lineno"></span><span class="op" id="7570396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="7570399">func</span>&nbsp;<span class="op" id="7570404">(</span><span class="ident" id="7570405">c</span>&nbsp;<span class="op" id="7570407">*</span><span class="ident" id="7570408">fakeConn</span><span class="op" id="7570416">)</span>&nbsp;<span class="ident" id="7570418">Begin</span><span class="op" id="7570423">(</span><span class="op" id="7570424">)</span>&nbsp;<span class="op" id="7570426">(</span><span class="ident" id="7570427">driver</span><span class="op" id="7570433">.</span><span class="ident" id="7570434">Tx</span><span class="op" id="7570436">,</span>&nbsp;<span class="builtintype" id="7570438">error</span><span class="op" id="7570443">)</span>&nbsp;<span class="op" id="7570445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570448">if</span>&nbsp;<span class="ident" id="7570451">c</span><span class="op" id="7570452">.</span><span class="ident" id="7570453">isBad</span><span class="op" id="7570458">(</span><span class="op" id="7570459">)</span>&nbsp;<span class="op" id="7570461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570465">return</span>&nbsp;<span class="ident" id="7570472">nil</span><span class="op" id="7570475">,</span>&nbsp;<span class="ident" id="7570477">driver</span><span class="op" id="7570483">.</span><span class="ident" id="7570484">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7570496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570499">if</span>&nbsp;<span class="ident" id="7570502">c</span><span class="op" id="7570503">.</span><span class="ident" id="7570504">currTx</span>&nbsp;<span class="op" id="7570511">!=</span>&nbsp;<span class="ident" id="7570514">nil</span>&nbsp;<span class="op" id="7570518">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570522">return</span>&nbsp;<span class="ident" id="7570529">nil</span><span class="op" id="7570532">,</span>&nbsp;<span class="ident" id="7570534">errors</span><span class="op" id="7570540">.</span><span class="ident" id="7570541">New</span><span class="op" id="7570544">(</span><span class="string" id="7570545">&#34;already&nbsp;in&nbsp;a&nbsp;transaction&#34;</span><span class="op" id="7570571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7570574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7570577">c</span><span class="op" id="7570578">.</span><span class="ident" id="7570579">currTx</span>&nbsp;<span class="op" id="7570586">=</span>&nbsp;<span class="op" id="7570588">&amp;</span><span class="ident" id="7570589">fakeTx</span><span class="op" id="7570595">{</span><span class="ident" id="7570596">c</span><span class="op" id="7570597">:</span>&nbsp;<span class="ident" id="7570599">c</span><span class="op" id="7570600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570603">return</span>&nbsp;<span class="ident" id="7570610">c</span><span class="op" id="7570611">.</span><span class="ident" id="7570612">currTx</span><span class="op" id="7570618">,</span>&nbsp;<span class="ident" id="7570620">nil</span><br>
<span class="lineno"></span><span class="op" id="7570624">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="7570627">var</span>&nbsp;<span class="ident" id="7570631">hookPostCloseConn</span>&nbsp;<span class="keyword" id="7570649">struct</span>&nbsp;<span class="op" id="7570656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7570659">sync</span><span class="op" id="7570663">.</span><span class="ident" id="7570664">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7570671">fn</span>&nbsp;<span class="keyword" id="7570674">func</span><span class="op" id="7570678">(</span><span class="op" id="7570679">*</span><span class="ident" id="7570680">fakeConn</span><span class="op" id="7570688">,</span>&nbsp;<span class="builtintype" id="7570690">error</span><span class="op" id="7570695">)</span><br>
<span class="lineno"></span><span class="op" id="7570697">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="7570700">func</span>&nbsp;<span class="ident" id="7570705">setHookpostCloseConn</span><span class="op" id="7570725">(</span><span class="ident" id="7570726">fn</span>&nbsp;<span class="keyword" id="7570729">func</span><span class="op" id="7570733">(</span><span class="op" id="7570734">*</span><span class="ident" id="7570735">fakeConn</span><span class="op" id="7570743">,</span>&nbsp;<span class="builtintype" id="7570745">error</span><span class="op" id="7570750">)</span><span class="op" id="7570751">)</span>&nbsp;<span class="op" id="7570753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7570756">hookPostCloseConn</span><span class="op" id="7570773">.</span><span class="ident" id="7570774">Lock</span><span class="op" id="7570778">(</span><span class="op" id="7570779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7570782">defer</span>&nbsp;<span class="ident" id="7570788">hookPostCloseConn</span><span class="op" id="7570805">.</span><span class="ident" id="7570806">Unlock</span><span class="op" id="7570812">(</span><span class="op" id="7570813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7570816">hookPostCloseConn</span><span class="op" id="7570833">.</span><span class="ident" id="7570834">fn</span>&nbsp;<span class="op" id="7570837">=</span>&nbsp;<span class="ident" id="7570839">fn</span><br>
<span class="lineno">275</span><span class="op" id="7570842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7570845">var</span>&nbsp;<span class="ident" id="7570849">testStrictClose</span>&nbsp;<span class="op" id="7570865">*</span><span class="ident" id="7570866">testing</span><span class="op" id="7570873">.</span><span class="ident" id="7570874">T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7570877">//&nbsp;setStrictFakeConnClose&nbsp;sets&nbsp;the&nbsp;t&nbsp;to&nbsp;Errorf&nbsp;on&nbsp;when&nbsp;fakeConn.Close</span><br>
<span class="lineno">280</span><span class="comment" id="7570947">//&nbsp;fails&nbsp;to&nbsp;close.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;check&nbsp;is&nbsp;disabled.</span><br>
<span class="lineno"></span><span class="keyword" id="7570997">func</span>&nbsp;<span class="ident" id="7571002">setStrictFakeConnClose</span><span class="op" id="7571024">(</span><span class="ident" id="7571025">t</span>&nbsp;<span class="op" id="7571027">*</span><span class="ident" id="7571028">testing</span><span class="op" id="7571035">.</span><span class="ident" id="7571036">T</span><span class="op" id="7571037">)</span>&nbsp;<span class="op" id="7571039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571042">testStrictClose</span>&nbsp;<span class="op" id="7571058">=</span>&nbsp;<span class="ident" id="7571060">t</span><br>
<span class="lineno"></span><span class="op" id="7571062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="7571065">func</span>&nbsp;<span class="op" id="7571070">(</span><span class="ident" id="7571071">c</span>&nbsp;<span class="op" id="7571073">*</span><span class="ident" id="7571074">fakeConn</span><span class="op" id="7571082">)</span>&nbsp;<span class="ident" id="7571084">Close</span><span class="op" id="7571089">(</span><span class="op" id="7571090">)</span>&nbsp;<span class="op" id="7571092">(</span><span class="ident" id="7571093">err</span>&nbsp;<span class="builtintype" id="7571097">error</span><span class="op" id="7571102">)</span>&nbsp;<span class="op" id="7571104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571107">drv</span>&nbsp;<span class="op" id="7571111">:=</span>&nbsp;<span class="ident" id="7571114">fdriver</span><span class="op" id="7571121">.</span><span class="op" id="7571122">(</span><span class="op" id="7571123">*</span><span class="ident" id="7571124">fakeDriver</span><span class="op" id="7571134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571137">defer</span>&nbsp;<span class="keyword" id="7571143">func</span><span class="op" id="7571147">(</span><span class="op" id="7571148">)</span>&nbsp;<span class="op" id="7571150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571154">if</span>&nbsp;<span class="ident" id="7571157">err</span>&nbsp;<span class="op" id="7571161">!=</span>&nbsp;<span class="ident" id="7571164">nil</span>&nbsp;<span class="op" id="7571168">&amp;&amp;</span>&nbsp;<span class="ident" id="7571171">testStrictClose</span>&nbsp;<span class="op" id="7571187">!=</span>&nbsp;<span class="ident" id="7571190">nil</span>&nbsp;<span class="op" id="7571194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571199">testStrictClose</span><span class="op" id="7571214">.</span><span class="ident" id="7571215">Errorf</span><span class="op" id="7571221">(</span><span class="string" id="7571222">&#34;failed&nbsp;to&nbsp;close&nbsp;a&nbsp;test&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7571259">,</span>&nbsp;<span class="ident" id="7571261">err</span><span class="op" id="7571264">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571272">hookPostCloseConn</span><span class="op" id="7571289">.</span><span class="ident" id="7571290">Lock</span><span class="op" id="7571294">(</span><span class="op" id="7571295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571299">fn</span>&nbsp;<span class="op" id="7571302">:=</span>&nbsp;<span class="ident" id="7571305">hookPostCloseConn</span><span class="op" id="7571322">.</span><span class="ident" id="7571323">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571328">hookPostCloseConn</span><span class="op" id="7571345">.</span><span class="ident" id="7571346">Unlock</span><span class="op" id="7571352">(</span><span class="op" id="7571353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571357">if</span>&nbsp;<span class="ident" id="7571360">fn</span>&nbsp;<span class="op" id="7571363">!=</span>&nbsp;<span class="ident" id="7571366">nil</span>&nbsp;<span class="op" id="7571370">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571375">fn</span><span class="op" id="7571377">(</span><span class="ident" id="7571378">c</span><span class="op" id="7571379">,</span>&nbsp;<span class="ident" id="7571381">err</span><span class="op" id="7571384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571392">if</span>&nbsp;<span class="ident" id="7571395">err</span>&nbsp;<span class="op" id="7571399">==</span>&nbsp;<span class="ident" id="7571402">nil</span>&nbsp;<span class="op" id="7571406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571411">drv</span><span class="op" id="7571414">.</span><span class="ident" id="7571415">mu</span><span class="op" id="7571417">.</span><span class="ident" id="7571418">Lock</span><span class="op" id="7571422">(</span><span class="op" id="7571423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571428">drv</span><span class="op" id="7571431">.</span><span class="ident" id="7571432">closeCount</span><span class="op" id="7571442">++</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571448">drv</span><span class="op" id="7571451">.</span><span class="ident" id="7571452">mu</span><span class="op" id="7571454">.</span><span class="ident" id="7571455">Unlock</span><span class="op" id="7571461">(</span><span class="op" id="7571462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571469">}</span><span class="op" id="7571470">(</span><span class="op" id="7571471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571474">if</span>&nbsp;<span class="ident" id="7571477">c</span><span class="op" id="7571478">.</span><span class="ident" id="7571479">currTx</span>&nbsp;<span class="op" id="7571486">!=</span>&nbsp;<span class="ident" id="7571489">nil</span>&nbsp;<span class="op" id="7571493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571497">return</span>&nbsp;<span class="ident" id="7571504">errors</span><span class="op" id="7571510">.</span><span class="ident" id="7571511">New</span><span class="op" id="7571514">(</span><span class="string" id="7571515">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;in&nbsp;a&nbsp;Transaction&#34;</span><span class="op" id="7571555">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571561">if</span>&nbsp;<span class="ident" id="7571564">c</span><span class="op" id="7571565">.</span><span class="ident" id="7571566">db</span>&nbsp;<span class="op" id="7571569">==</span>&nbsp;<span class="ident" id="7571572">nil</span>&nbsp;<span class="op" id="7571576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571580">return</span>&nbsp;<span class="ident" id="7571587">errors</span><span class="op" id="7571593">.</span><span class="ident" id="7571594">New</span><span class="op" id="7571597">(</span><span class="string" id="7571598">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;already&nbsp;closed&#34;</span><span class="op" id="7571636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571642">if</span>&nbsp;<span class="ident" id="7571645">c</span><span class="op" id="7571646">.</span><span class="ident" id="7571647">stmtsMade</span>&nbsp;<span class="op" id="7571657">&gt;</span>&nbsp;<span class="ident" id="7571659">c</span><span class="op" id="7571660">.</span><span class="ident" id="7571661">stmtsClosed</span>&nbsp;<span class="op" id="7571673">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571677">return</span>&nbsp;<span class="ident" id="7571684">errors</span><span class="op" id="7571690">.</span><span class="ident" id="7571691">New</span><span class="op" id="7571694">(</span><span class="string" id="7571695">&#34;can&#39;t&nbsp;close;&nbsp;dangling&nbsp;statement(s)&#34;</span><span class="op" id="7571731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7571734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7571737">c</span><span class="op" id="7571738">.</span><span class="ident" id="7571739">db</span>&nbsp;<span class="op" id="7571742">=</span>&nbsp;<span class="ident" id="7571744">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571749">return</span>&nbsp;<span class="ident" id="7571756">nil</span><br>
<span class="lineno"></span><span class="op" id="7571760">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="7571763">func</span>&nbsp;<span class="ident" id="7571768">checkSubsetTypes</span><span class="op" id="7571784">(</span><span class="ident" id="7571785">args</span>&nbsp;<span class="op" id="7571790">[</span><span class="op" id="7571791">]</span><span class="ident" id="7571792">driver</span><span class="op" id="7571798">.</span><span class="ident" id="7571799">Value</span><span class="op" id="7571804">)</span>&nbsp;<span class="builtintype" id="7571806">error</span>&nbsp;<span class="op" id="7571812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571815">for</span>&nbsp;<span class="ident" id="7571819">n</span><span class="op" id="7571820">,</span>&nbsp;<span class="ident" id="7571822">arg</span>&nbsp;<span class="op" id="7571826">:=</span>&nbsp;<span class="keyword" id="7571829">range</span>&nbsp;<span class="ident" id="7571835">args</span>&nbsp;<span class="op" id="7571840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571844">switch</span>&nbsp;<span class="ident" id="7571851">arg</span><span class="op" id="7571854">.</span><span class="op" id="7571855">(</span><span class="keyword" id="7571856">type</span><span class="op" id="7571860">)</span>&nbsp;<span class="op" id="7571862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571866">case</span>&nbsp;<span class="ident" id="7571871">int64</span><span class="op" id="7571876">,</span>&nbsp;<span class="builtintype" id="7571878">float64</span><span class="op" id="7571885">,</span>&nbsp;<span class="builtintype" id="7571887">bool</span><span class="op" id="7571891">,</span>&nbsp;<span class="ident" id="7571893">nil</span><span class="op" id="7571896">,</span>&nbsp;<span class="op" id="7571898">[</span><span class="op" id="7571899">]</span><span class="builtintype" id="7571900">byte</span><span class="op" id="7571904">,</span>&nbsp;<span class="builtintype" id="7571906">string</span><span class="op" id="7571912">,</span>&nbsp;<span class="ident" id="7571914">time</span><span class="op" id="7571918">.</span><span class="ident" id="7571919">Time</span><span class="op" id="7571923">:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571927">default</span><span class="op" id="7571934">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7571939">return</span>&nbsp;<span class="ident" id="7571946">fmt</span><span class="op" id="7571949">.</span><span class="ident" id="7571950">Errorf</span><span class="op" id="7571956">(</span><span class="string" id="7571957">&#34;fakedb_test:&nbsp;invalid&nbsp;argument&nbsp;#%d:&nbsp;%v,&nbsp;type&nbsp;%T&#34;</span><span class="op" id="7572005">,</span>&nbsp;<span class="ident" id="7572007">n</span><span class="op" id="7572008">+</span><span class="num" id="7572009">1</span><span class="op" id="7572010">,</span>&nbsp;<span class="ident" id="7572012">arg</span><span class="op" id="7572015">,</span>&nbsp;<span class="ident" id="7572017">arg</span><span class="op" id="7572020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7572024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7572027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572030">return</span>&nbsp;<span class="ident" id="7572037">nil</span><br>
<span class="lineno">325</span><span class="op" id="7572041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7572044">func</span>&nbsp;<span class="op" id="7572049">(</span><span class="ident" id="7572050">c</span>&nbsp;<span class="op" id="7572052">*</span><span class="ident" id="7572053">fakeConn</span><span class="op" id="7572061">)</span>&nbsp;<span class="ident" id="7572063">Exec</span><span class="op" id="7572067">(</span><span class="ident" id="7572068">query</span>&nbsp;<span class="builtintype" id="7572074">string</span><span class="op" id="7572080">,</span>&nbsp;<span class="ident" id="7572082">args</span>&nbsp;<span class="op" id="7572087">[</span><span class="op" id="7572088">]</span><span class="ident" id="7572089">driver</span><span class="op" id="7572095">.</span><span class="ident" id="7572096">Value</span><span class="op" id="7572101">)</span>&nbsp;<span class="op" id="7572103">(</span><span class="ident" id="7572104">driver</span><span class="op" id="7572110">.</span><span class="ident" id="7572111">Result</span><span class="op" id="7572117">,</span>&nbsp;<span class="builtintype" id="7572119">error</span><span class="op" id="7572124">)</span>&nbsp;<span class="op" id="7572126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7572129">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7572190">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7572251">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7572310">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572337">err</span>&nbsp;<span class="op" id="7572341">:=</span>&nbsp;<span class="ident" id="7572344">checkSubsetTypes</span><span class="op" id="7572360">(</span><span class="ident" id="7572361">args</span><span class="op" id="7572365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572368">if</span>&nbsp;<span class="ident" id="7572371">err</span>&nbsp;<span class="op" id="7572375">!=</span>&nbsp;<span class="ident" id="7572378">nil</span>&nbsp;<span class="op" id="7572382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572386">return</span>&nbsp;<span class="ident" id="7572393">nil</span><span class="op" id="7572396">,</span>&nbsp;<span class="ident" id="7572398">err</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7572403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572406">return</span>&nbsp;<span class="ident" id="7572413">nil</span><span class="op" id="7572416">,</span>&nbsp;<span class="ident" id="7572418">driver</span><span class="op" id="7572424">.</span><span class="ident" id="7572425">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="7572433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7572436">func</span>&nbsp;<span class="op" id="7572441">(</span><span class="ident" id="7572442">c</span>&nbsp;<span class="op" id="7572444">*</span><span class="ident" id="7572445">fakeConn</span><span class="op" id="7572453">)</span>&nbsp;<span class="ident" id="7572455">Query</span><span class="op" id="7572460">(</span><span class="ident" id="7572461">query</span>&nbsp;<span class="builtintype" id="7572467">string</span><span class="op" id="7572473">,</span>&nbsp;<span class="ident" id="7572475">args</span>&nbsp;<span class="op" id="7572480">[</span><span class="op" id="7572481">]</span><span class="ident" id="7572482">driver</span><span class="op" id="7572488">.</span><span class="ident" id="7572489">Value</span><span class="op" id="7572494">)</span>&nbsp;<span class="op" id="7572496">(</span><span class="ident" id="7572497">driver</span><span class="op" id="7572503">.</span><span class="ident" id="7572504">Rows</span><span class="op" id="7572508">,</span>&nbsp;<span class="builtintype" id="7572510">error</span><span class="op" id="7572515">)</span>&nbsp;<span class="op" id="7572517">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7572520">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7572581">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7572642">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7572701">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572728">err</span>&nbsp;<span class="op" id="7572732">:=</span>&nbsp;<span class="ident" id="7572735">checkSubsetTypes</span><span class="op" id="7572751">(</span><span class="ident" id="7572752">args</span><span class="op" id="7572756">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572759">if</span>&nbsp;<span class="ident" id="7572762">err</span>&nbsp;<span class="op" id="7572766">!=</span>&nbsp;<span class="ident" id="7572769">nil</span>&nbsp;<span class="op" id="7572773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572777">return</span>&nbsp;<span class="ident" id="7572784">nil</span><span class="op" id="7572787">,</span>&nbsp;<span class="ident" id="7572789">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7572794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572797">return</span>&nbsp;<span class="ident" id="7572804">nil</span><span class="op" id="7572807">,</span>&nbsp;<span class="ident" id="7572809">driver</span><span class="op" id="7572815">.</span><span class="ident" id="7572816">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="7572824">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="7572827">func</span>&nbsp;<span class="ident" id="7572832">errf</span><span class="op" id="7572836">(</span><span class="ident" id="7572837">msg</span>&nbsp;<span class="builtintype" id="7572841">string</span><span class="op" id="7572847">,</span>&nbsp;<span class="ident" id="7572849">args</span>&nbsp;<span class="op" id="7572854">...</span><span class="keyword" id="7572857">interface</span><span class="op" id="7572866">{</span><span class="op" id="7572867">}</span><span class="op" id="7572868">)</span>&nbsp;<span class="builtintype" id="7572870">error</span>&nbsp;<span class="op" id="7572876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572879">return</span>&nbsp;<span class="ident" id="7572886">errors</span><span class="op" id="7572892">.</span><span class="ident" id="7572893">New</span><span class="op" id="7572896">(</span><span class="string" id="7572897">&#34;fakedb:&nbsp;&#34;</span>&nbsp;<span class="op" id="7572908">+</span>&nbsp;<span class="ident" id="7572910">fmt</span><span class="op" id="7572913">.</span><span class="ident" id="7572914">Sprintf</span><span class="op" id="7572921">(</span><span class="ident" id="7572922">msg</span><span class="op" id="7572925">,</span>&nbsp;<span class="ident" id="7572927">args</span><span class="op" id="7572931">...</span><span class="op" id="7572934">)</span><span class="op" id="7572935">)</span><br>
<span class="lineno"></span><span class="op" id="7572937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="7572940">//&nbsp;parts&nbsp;are&nbsp;table|selectCol1,selectCol2|whereCol=?,whereCol2=?</span><br>
<span class="lineno"></span><span class="comment" id="7573004">//&nbsp;(note&nbsp;that&nbsp;where&nbsp;columns&nbsp;must&nbsp;always&nbsp;contain&nbsp;?&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="7573061">//&nbsp;&nbsp;just&nbsp;a&nbsp;limitation&nbsp;for&nbsp;fakedb)</span><br>
<span class="lineno"></span><span class="keyword" id="7573095">func</span>&nbsp;<span class="op" id="7573100">(</span><span class="ident" id="7573101">c</span>&nbsp;<span class="op" id="7573103">*</span><span class="ident" id="7573104">fakeConn</span><span class="op" id="7573112">)</span>&nbsp;<span class="ident" id="7573114">prepareSelect</span><span class="op" id="7573127">(</span><span class="ident" id="7573128">stmt</span>&nbsp;<span class="op" id="7573133">*</span><span class="ident" id="7573134">fakeStmt</span><span class="op" id="7573142">,</span>&nbsp;<span class="ident" id="7573144">parts</span>&nbsp;<span class="op" id="7573150">[</span><span class="op" id="7573151">]</span><span class="builtintype" id="7573152">string</span><span class="op" id="7573158">)</span>&nbsp;<span class="op" id="7573160">(</span><span class="ident" id="7573161">driver</span><span class="op" id="7573167">.</span><span class="ident" id="7573168">Stmt</span><span class="op" id="7573172">,</span>&nbsp;<span class="builtintype" id="7573174">error</span><span class="op" id="7573179">)</span>&nbsp;<span class="op" id="7573181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573184">if</span>&nbsp;<span class="builtinfunc" id="7573187">len</span><span class="op" id="7573190">(</span><span class="ident" id="7573191">parts</span><span class="op" id="7573196">)</span>&nbsp;<span class="op" id="7573198">!=</span>&nbsp;<span class="num" id="7573201">3</span>&nbsp;<span class="op" id="7573203">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573207">stmt</span><span class="op" id="7573211">.</span><span class="ident" id="7573212">Close</span><span class="op" id="7573217">(</span><span class="op" id="7573218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573222">return</span>&nbsp;<span class="ident" id="7573229">nil</span><span class="op" id="7573232">,</span>&nbsp;<span class="ident" id="7573234">errf</span><span class="op" id="7573238">(</span><span class="string" id="7573239">&#34;invalid&nbsp;SELECT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;3&#34;</span><span class="op" id="7573284">,</span>&nbsp;<span class="builtinfunc" id="7573286">len</span><span class="op" id="7573289">(</span><span class="ident" id="7573290">parts</span><span class="op" id="7573295">)</span><span class="op" id="7573296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573302">stmt</span><span class="op" id="7573306">.</span><span class="ident" id="7573307">table</span>&nbsp;<span class="op" id="7573313">=</span>&nbsp;<span class="ident" id="7573315">parts</span><span class="op" id="7573320">[</span><span class="num" id="7573321">0</span><span class="op" id="7573322">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573325">stmt</span><span class="op" id="7573329">.</span><span class="ident" id="7573330">colName</span>&nbsp;<span class="op" id="7573338">=</span>&nbsp;<span class="ident" id="7573340">strings</span><span class="op" id="7573347">.</span><span class="ident" id="7573348">Split</span><span class="op" id="7573353">(</span><span class="ident" id="7573354">parts</span><span class="op" id="7573359">[</span><span class="num" id="7573360">1</span><span class="op" id="7573361">]</span><span class="op" id="7573362">,</span>&nbsp;<span class="string" id="7573364">&#34;,&#34;</span><span class="op" id="7573367">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573370">for</span>&nbsp;<span class="ident" id="7573374">n</span><span class="op" id="7573375">,</span>&nbsp;<span class="ident" id="7573377">colspec</span>&nbsp;<span class="op" id="7573385">:=</span>&nbsp;<span class="keyword" id="7573388">range</span>&nbsp;<span class="ident" id="7573394">strings</span><span class="op" id="7573401">.</span><span class="ident" id="7573402">Split</span><span class="op" id="7573407">(</span><span class="ident" id="7573408">parts</span><span class="op" id="7573413">[</span><span class="num" id="7573414">2</span><span class="op" id="7573415">]</span><span class="op" id="7573416">,</span>&nbsp;<span class="string" id="7573418">&#34;,&#34;</span><span class="op" id="7573421">)</span>&nbsp;<span class="op" id="7573423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573427">if</span>&nbsp;<span class="ident" id="7573430">colspec</span>&nbsp;<span class="op" id="7573438">==</span>&nbsp;<span class="string" id="7573441">&#34;&#34;</span>&nbsp;<span class="op" id="7573444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573449">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573464">nameVal</span>&nbsp;<span class="op" id="7573472">:=</span>&nbsp;<span class="ident" id="7573475">strings</span><span class="op" id="7573482">.</span><span class="ident" id="7573483">Split</span><span class="op" id="7573488">(</span><span class="ident" id="7573489">colspec</span><span class="op" id="7573496">,</span>&nbsp;<span class="string" id="7573498">&#34;=&#34;</span><span class="op" id="7573501">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573505">if</span>&nbsp;<span class="builtinfunc" id="7573508">len</span><span class="op" id="7573511">(</span><span class="ident" id="7573512">nameVal</span><span class="op" id="7573519">)</span>&nbsp;<span class="op" id="7573521">!=</span>&nbsp;<span class="num" id="7573524">2</span>&nbsp;<span class="op" id="7573526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573531">stmt</span><span class="op" id="7573535">.</span><span class="ident" id="7573536">Close</span><span class="op" id="7573541">(</span><span class="op" id="7573542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573547">return</span>&nbsp;<span class="ident" id="7573554">nil</span><span class="op" id="7573557">,</span>&nbsp;<span class="ident" id="7573559">errf</span><span class="op" id="7573563">(</span><span class="string" id="7573564">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7573625">,</span>&nbsp;<span class="ident" id="7573627">stmt</span><span class="op" id="7573631">.</span><span class="ident" id="7573632">table</span><span class="op" id="7573637">,</span>&nbsp;<span class="ident" id="7573639">colspec</span><span class="op" id="7573646">,</span>&nbsp;<span class="ident" id="7573648">n</span><span class="op" id="7573649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573657">column</span><span class="op" id="7573663">,</span>&nbsp;<span class="ident" id="7573665">value</span>&nbsp;<span class="op" id="7573671">:=</span>&nbsp;<span class="ident" id="7573674">nameVal</span><span class="op" id="7573681">[</span><span class="num" id="7573682">0</span><span class="op" id="7573683">]</span><span class="op" id="7573684">,</span>&nbsp;<span class="ident" id="7573686">nameVal</span><span class="op" id="7573693">[</span><span class="num" id="7573694">1</span><span class="op" id="7573695">]</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573699">_</span><span class="op" id="7573700">,</span>&nbsp;<span class="ident" id="7573702">ok</span>&nbsp;<span class="op" id="7573705">:=</span>&nbsp;<span class="ident" id="7573708">c</span><span class="op" id="7573709">.</span><span class="ident" id="7573710">db</span><span class="op" id="7573712">.</span><span class="ident" id="7573713">columnType</span><span class="op" id="7573723">(</span><span class="ident" id="7573724">stmt</span><span class="op" id="7573728">.</span><span class="ident" id="7573729">table</span><span class="op" id="7573734">,</span>&nbsp;<span class="ident" id="7573736">column</span><span class="op" id="7573742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573746">if</span>&nbsp;<span class="op" id="7573749">!</span><span class="ident" id="7573750">ok</span>&nbsp;<span class="op" id="7573753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573758">stmt</span><span class="op" id="7573762">.</span><span class="ident" id="7573763">Close</span><span class="op" id="7573768">(</span><span class="op" id="7573769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573774">return</span>&nbsp;<span class="ident" id="7573781">nil</span><span class="op" id="7573784">,</span>&nbsp;<span class="ident" id="7573786">errf</span><span class="op" id="7573790">(</span><span class="string" id="7573791">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7573845">,</span>&nbsp;<span class="ident" id="7573847">stmt</span><span class="op" id="7573851">.</span><span class="ident" id="7573852">table</span><span class="op" id="7573857">,</span>&nbsp;<span class="ident" id="7573859">column</span><span class="op" id="7573865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573869">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573873">if</span>&nbsp;<span class="ident" id="7573876">value</span>&nbsp;<span class="op" id="7573882">!=</span>&nbsp;<span class="string" id="7573885">&#34;?&#34;</span>&nbsp;<span class="op" id="7573889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573894">stmt</span><span class="op" id="7573898">.</span><span class="ident" id="7573899">Close</span><span class="op" id="7573904">(</span><span class="op" id="7573905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573910">return</span>&nbsp;<span class="ident" id="7573917">nil</span><span class="op" id="7573920">,</span>&nbsp;<span class="ident" id="7573922">errf</span><span class="op" id="7573926">(</span><span class="string" id="7573927">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;pre-bound&nbsp;value&nbsp;for&nbsp;where&nbsp;column&nbsp;%q;&nbsp;need&nbsp;a&nbsp;question&nbsp;mark&#34;</span><span class="op" id="7574009">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574015">stmt</span><span class="op" id="7574019">.</span><span class="ident" id="7574020">table</span><span class="op" id="7574025">,</span>&nbsp;<span class="ident" id="7574027">column</span><span class="op" id="7574033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7574037">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574041">stmt</span><span class="op" id="7574045">.</span><span class="ident" id="7574046">whereCol</span>&nbsp;<span class="op" id="7574055">=</span>&nbsp;<span class="builtinfunc" id="7574057">append</span><span class="op" id="7574063">(</span><span class="ident" id="7574064">stmt</span><span class="op" id="7574068">.</span><span class="ident" id="7574069">whereCol</span><span class="op" id="7574077">,</span>&nbsp;<span class="ident" id="7574079">column</span><span class="op" id="7574085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574089">stmt</span><span class="op" id="7574093">.</span><span class="ident" id="7574094">placeholders</span><span class="op" id="7574106">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7574110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574113">return</span>&nbsp;<span class="ident" id="7574120">stmt</span><span class="op" id="7574124">,</span>&nbsp;<span class="ident" id="7574126">nil</span><br>
<span class="lineno"></span><span class="op" id="7574130">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span><span class="comment" id="7574133">//&nbsp;parts&nbsp;are&nbsp;table|col=type,col2=type2</span><br>
<span class="lineno"></span><span class="keyword" id="7574172">func</span>&nbsp;<span class="op" id="7574177">(</span><span class="ident" id="7574178">c</span>&nbsp;<span class="op" id="7574180">*</span><span class="ident" id="7574181">fakeConn</span><span class="op" id="7574189">)</span>&nbsp;<span class="ident" id="7574191">prepareCreate</span><span class="op" id="7574204">(</span><span class="ident" id="7574205">stmt</span>&nbsp;<span class="op" id="7574210">*</span><span class="ident" id="7574211">fakeStmt</span><span class="op" id="7574219">,</span>&nbsp;<span class="ident" id="7574221">parts</span>&nbsp;<span class="op" id="7574227">[</span><span class="op" id="7574228">]</span><span class="builtintype" id="7574229">string</span><span class="op" id="7574235">)</span>&nbsp;<span class="op" id="7574237">(</span><span class="ident" id="7574238">driver</span><span class="op" id="7574244">.</span><span class="ident" id="7574245">Stmt</span><span class="op" id="7574249">,</span>&nbsp;<span class="builtintype" id="7574251">error</span><span class="op" id="7574256">)</span>&nbsp;<span class="op" id="7574258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574261">if</span>&nbsp;<span class="builtinfunc" id="7574264">len</span><span class="op" id="7574267">(</span><span class="ident" id="7574268">parts</span><span class="op" id="7574273">)</span>&nbsp;<span class="op" id="7574275">!=</span>&nbsp;<span class="num" id="7574278">2</span>&nbsp;<span class="op" id="7574280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574284">stmt</span><span class="op" id="7574288">.</span><span class="ident" id="7574289">Close</span><span class="op" id="7574294">(</span><span class="op" id="7574295">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574299">return</span>&nbsp;<span class="ident" id="7574306">nil</span><span class="op" id="7574309">,</span>&nbsp;<span class="ident" id="7574311">errf</span><span class="op" id="7574315">(</span><span class="string" id="7574316">&#34;invalid&nbsp;CREATE&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="7574361">,</span>&nbsp;<span class="builtinfunc" id="7574363">len</span><span class="op" id="7574366">(</span><span class="ident" id="7574367">parts</span><span class="op" id="7574372">)</span><span class="op" id="7574373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7574376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574379">stmt</span><span class="op" id="7574383">.</span><span class="ident" id="7574384">table</span>&nbsp;<span class="op" id="7574390">=</span>&nbsp;<span class="ident" id="7574392">parts</span><span class="op" id="7574397">[</span><span class="num" id="7574398">0</span><span class="op" id="7574399">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574402">for</span>&nbsp;<span class="ident" id="7574406">n</span><span class="op" id="7574407">,</span>&nbsp;<span class="ident" id="7574409">colspec</span>&nbsp;<span class="op" id="7574417">:=</span>&nbsp;<span class="keyword" id="7574420">range</span>&nbsp;<span class="ident" id="7574426">strings</span><span class="op" id="7574433">.</span><span class="ident" id="7574434">Split</span><span class="op" id="7574439">(</span><span class="ident" id="7574440">parts</span><span class="op" id="7574445">[</span><span class="num" id="7574446">1</span><span class="op" id="7574447">]</span><span class="op" id="7574448">,</span>&nbsp;<span class="string" id="7574450">&#34;,&#34;</span><span class="op" id="7574453">)</span>&nbsp;<span class="op" id="7574455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574459">nameType</span>&nbsp;<span class="op" id="7574468">:=</span>&nbsp;<span class="ident" id="7574471">strings</span><span class="op" id="7574478">.</span><span class="ident" id="7574479">Split</span><span class="op" id="7574484">(</span><span class="ident" id="7574485">colspec</span><span class="op" id="7574492">,</span>&nbsp;<span class="string" id="7574494">&#34;=&#34;</span><span class="op" id="7574497">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574501">if</span>&nbsp;<span class="builtinfunc" id="7574504">len</span><span class="op" id="7574507">(</span><span class="ident" id="7574508">nameType</span><span class="op" id="7574516">)</span>&nbsp;<span class="op" id="7574518">!=</span>&nbsp;<span class="num" id="7574521">2</span>&nbsp;<span class="op" id="7574523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574528">stmt</span><span class="op" id="7574532">.</span><span class="ident" id="7574533">Close</span><span class="op" id="7574538">(</span><span class="op" id="7574539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574544">return</span>&nbsp;<span class="ident" id="7574551">nil</span><span class="op" id="7574554">,</span>&nbsp;<span class="ident" id="7574556">errf</span><span class="op" id="7574560">(</span><span class="string" id="7574561">&#34;CREATE&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7574619">,</span>&nbsp;<span class="ident" id="7574621">stmt</span><span class="op" id="7574625">.</span><span class="ident" id="7574626">table</span><span class="op" id="7574631">,</span>&nbsp;<span class="ident" id="7574633">colspec</span><span class="op" id="7574640">,</span>&nbsp;<span class="ident" id="7574642">n</span><span class="op" id="7574643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7574647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574651">stmt</span><span class="op" id="7574655">.</span><span class="ident" id="7574656">colName</span>&nbsp;<span class="op" id="7574664">=</span>&nbsp;<span class="builtinfunc" id="7574666">append</span><span class="op" id="7574672">(</span><span class="ident" id="7574673">stmt</span><span class="op" id="7574677">.</span><span class="ident" id="7574678">colName</span><span class="op" id="7574685">,</span>&nbsp;<span class="ident" id="7574687">nameType</span><span class="op" id="7574695">[</span><span class="num" id="7574696">0</span><span class="op" id="7574697">]</span><span class="op" id="7574698">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574702">stmt</span><span class="op" id="7574706">.</span><span class="ident" id="7574707">colType</span>&nbsp;<span class="op" id="7574715">=</span>&nbsp;<span class="builtinfunc" id="7574717">append</span><span class="op" id="7574723">(</span><span class="ident" id="7574724">stmt</span><span class="op" id="7574728">.</span><span class="ident" id="7574729">colType</span><span class="op" id="7574736">,</span>&nbsp;<span class="ident" id="7574738">nameType</span><span class="op" id="7574746">[</span><span class="num" id="7574747">1</span><span class="op" id="7574748">]</span><span class="op" id="7574749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7574752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574755">return</span>&nbsp;<span class="ident" id="7574762">stmt</span><span class="op" id="7574766">,</span>&nbsp;<span class="ident" id="7574768">nil</span><br>
<span class="lineno"></span><span class="op" id="7574772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="7574775">//&nbsp;parts&nbsp;are&nbsp;table|col=?,col2=val</span><br>
<span class="lineno"></span><span class="keyword" id="7574809">func</span>&nbsp;<span class="op" id="7574814">(</span><span class="ident" id="7574815">c</span>&nbsp;<span class="op" id="7574817">*</span><span class="ident" id="7574818">fakeConn</span><span class="op" id="7574826">)</span>&nbsp;<span class="ident" id="7574828">prepareInsert</span><span class="op" id="7574841">(</span><span class="ident" id="7574842">stmt</span>&nbsp;<span class="op" id="7574847">*</span><span class="ident" id="7574848">fakeStmt</span><span class="op" id="7574856">,</span>&nbsp;<span class="ident" id="7574858">parts</span>&nbsp;<span class="op" id="7574864">[</span><span class="op" id="7574865">]</span><span class="builtintype" id="7574866">string</span><span class="op" id="7574872">)</span>&nbsp;<span class="op" id="7574874">(</span><span class="ident" id="7574875">driver</span><span class="op" id="7574881">.</span><span class="ident" id="7574882">Stmt</span><span class="op" id="7574886">,</span>&nbsp;<span class="builtintype" id="7574888">error</span><span class="op" id="7574893">)</span>&nbsp;<span class="op" id="7574895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574898">if</span>&nbsp;<span class="builtinfunc" id="7574901">len</span><span class="op" id="7574904">(</span><span class="ident" id="7574905">parts</span><span class="op" id="7574910">)</span>&nbsp;<span class="op" id="7574912">!=</span>&nbsp;<span class="num" id="7574915">2</span>&nbsp;<span class="op" id="7574917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574921">stmt</span><span class="op" id="7574925">.</span><span class="ident" id="7574926">Close</span><span class="op" id="7574931">(</span><span class="op" id="7574932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574936">return</span>&nbsp;<span class="ident" id="7574943">nil</span><span class="op" id="7574946">,</span>&nbsp;<span class="ident" id="7574948">errf</span><span class="op" id="7574952">(</span><span class="string" id="7574953">&#34;invalid&nbsp;INSERT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="7574998">,</span>&nbsp;<span class="builtinfunc" id="7575000">len</span><span class="op" id="7575003">(</span><span class="ident" id="7575004">parts</span><span class="op" id="7575009">)</span><span class="op" id="7575010">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7575013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575016">stmt</span><span class="op" id="7575020">.</span><span class="ident" id="7575021">table</span>&nbsp;<span class="op" id="7575027">=</span>&nbsp;<span class="ident" id="7575029">parts</span><span class="op" id="7575034">[</span><span class="num" id="7575035">0</span><span class="op" id="7575036">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575039">for</span>&nbsp;<span class="ident" id="7575043">n</span><span class="op" id="7575044">,</span>&nbsp;<span class="ident" id="7575046">colspec</span>&nbsp;<span class="op" id="7575054">:=</span>&nbsp;<span class="keyword" id="7575057">range</span>&nbsp;<span class="ident" id="7575063">strings</span><span class="op" id="7575070">.</span><span class="ident" id="7575071">Split</span><span class="op" id="7575076">(</span><span class="ident" id="7575077">parts</span><span class="op" id="7575082">[</span><span class="num" id="7575083">1</span><span class="op" id="7575084">]</span><span class="op" id="7575085">,</span>&nbsp;<span class="string" id="7575087">&#34;,&#34;</span><span class="op" id="7575090">)</span>&nbsp;<span class="op" id="7575092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575096">nameVal</span>&nbsp;<span class="op" id="7575104">:=</span>&nbsp;<span class="ident" id="7575107">strings</span><span class="op" id="7575114">.</span><span class="ident" id="7575115">Split</span><span class="op" id="7575120">(</span><span class="ident" id="7575121">colspec</span><span class="op" id="7575128">,</span>&nbsp;<span class="string" id="7575130">&#34;=&#34;</span><span class="op" id="7575133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575137">if</span>&nbsp;<span class="builtinfunc" id="7575140">len</span><span class="op" id="7575143">(</span><span class="ident" id="7575144">nameVal</span><span class="op" id="7575151">)</span>&nbsp;<span class="op" id="7575153">!=</span>&nbsp;<span class="num" id="7575156">2</span>&nbsp;<span class="op" id="7575158">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575163">stmt</span><span class="op" id="7575167">.</span><span class="ident" id="7575168">Close</span><span class="op" id="7575173">(</span><span class="op" id="7575174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575179">return</span>&nbsp;<span class="ident" id="7575186">nil</span><span class="op" id="7575189">,</span>&nbsp;<span class="ident" id="7575191">errf</span><span class="op" id="7575195">(</span><span class="string" id="7575196">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7575254">,</span>&nbsp;<span class="ident" id="7575256">stmt</span><span class="op" id="7575260">.</span><span class="ident" id="7575261">table</span><span class="op" id="7575266">,</span>&nbsp;<span class="ident" id="7575268">colspec</span><span class="op" id="7575275">,</span>&nbsp;<span class="ident" id="7575277">n</span><span class="op" id="7575278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7575282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575286">column</span><span class="op" id="7575292">,</span>&nbsp;<span class="ident" id="7575294">value</span>&nbsp;<span class="op" id="7575300">:=</span>&nbsp;<span class="ident" id="7575303">nameVal</span><span class="op" id="7575310">[</span><span class="num" id="7575311">0</span><span class="op" id="7575312">]</span><span class="op" id="7575313">,</span>&nbsp;<span class="ident" id="7575315">nameVal</span><span class="op" id="7575322">[</span><span class="num" id="7575323">1</span><span class="op" id="7575324">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575328">ctype</span><span class="op" id="7575333">,</span>&nbsp;<span class="ident" id="7575335">ok</span>&nbsp;<span class="op" id="7575338">:=</span>&nbsp;<span class="ident" id="7575341">c</span><span class="op" id="7575342">.</span><span class="ident" id="7575343">db</span><span class="op" id="7575345">.</span><span class="ident" id="7575346">columnType</span><span class="op" id="7575356">(</span><span class="ident" id="7575357">stmt</span><span class="op" id="7575361">.</span><span class="ident" id="7575362">table</span><span class="op" id="7575367">,</span>&nbsp;<span class="ident" id="7575369">column</span><span class="op" id="7575375">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575379">if</span>&nbsp;<span class="op" id="7575382">!</span><span class="ident" id="7575383">ok</span>&nbsp;<span class="op" id="7575386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575391">stmt</span><span class="op" id="7575395">.</span><span class="ident" id="7575396">Close</span><span class="op" id="7575401">(</span><span class="op" id="7575402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575407">return</span>&nbsp;<span class="ident" id="7575414">nil</span><span class="op" id="7575417">,</span>&nbsp;<span class="ident" id="7575419">errf</span><span class="op" id="7575423">(</span><span class="string" id="7575424">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7575475">,</span>&nbsp;<span class="ident" id="7575477">stmt</span><span class="op" id="7575481">.</span><span class="ident" id="7575482">table</span><span class="op" id="7575487">,</span>&nbsp;<span class="ident" id="7575489">column</span><span class="op" id="7575495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7575499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575503">stmt</span><span class="op" id="7575507">.</span><span class="ident" id="7575508">colName</span>&nbsp;<span class="op" id="7575516">=</span>&nbsp;<span class="builtinfunc" id="7575518">append</span><span class="op" id="7575524">(</span><span class="ident" id="7575525">stmt</span><span class="op" id="7575529">.</span><span class="ident" id="7575530">colName</span><span class="op" id="7575537">,</span>&nbsp;<span class="ident" id="7575539">column</span><span class="op" id="7575545">)</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575550">if</span>&nbsp;<span class="ident" id="7575553">value</span>&nbsp;<span class="op" id="7575559">!=</span>&nbsp;<span class="string" id="7575562">&#34;?&#34;</span>&nbsp;<span class="op" id="7575566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575571">var</span>&nbsp;<span class="ident" id="7575575">subsetVal</span>&nbsp;<span class="keyword" id="7575585">interface</span><span class="op" id="7575594">{</span><span class="op" id="7575595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7575600">//&nbsp;Convert&nbsp;to&nbsp;driver&nbsp;subset&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575636">switch</span>&nbsp;<span class="ident" id="7575643">ctype</span>&nbsp;<span class="op" id="7575649">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575654">case</span>&nbsp;<span class="string" id="7575659">&#34;string&#34;</span><span class="op" id="7575667">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575673">subsetVal</span>&nbsp;<span class="op" id="7575683">=</span>&nbsp;<span class="op" id="7575685">[</span><span class="op" id="7575686">]</span><span class="builtintype" id="7575687">byte</span><span class="op" id="7575691">(</span><span class="ident" id="7575692">value</span><span class="op" id="7575697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575702">case</span>&nbsp;<span class="string" id="7575707">&#34;blob&#34;</span><span class="op" id="7575713">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575719">subsetVal</span>&nbsp;<span class="op" id="7575729">=</span>&nbsp;<span class="op" id="7575731">[</span><span class="op" id="7575732">]</span><span class="builtintype" id="7575733">byte</span><span class="op" id="7575737">(</span><span class="ident" id="7575738">value</span><span class="op" id="7575743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575748">case</span>&nbsp;<span class="string" id="7575753">&#34;int32&#34;</span><span class="op" id="7575760">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575766">i</span><span class="op" id="7575767">,</span>&nbsp;<span class="ident" id="7575769">err</span>&nbsp;<span class="op" id="7575773">:=</span>&nbsp;<span class="ident" id="7575776">strconv</span><span class="op" id="7575783">.</span><span class="ident" id="7575784">Atoi</span><span class="op" id="7575788">(</span><span class="ident" id="7575789">value</span><span class="op" id="7575794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575800">if</span>&nbsp;<span class="ident" id="7575803">err</span>&nbsp;<span class="op" id="7575807">!=</span>&nbsp;<span class="ident" id="7575810">nil</span>&nbsp;<span class="op" id="7575814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575821">stmt</span><span class="op" id="7575825">.</span><span class="ident" id="7575826">Close</span><span class="op" id="7575831">(</span><span class="op" id="7575832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575839">return</span>&nbsp;<span class="ident" id="7575846">nil</span><span class="op" id="7575849">,</span>&nbsp;<span class="ident" id="7575851">errf</span><span class="op" id="7575855">(</span><span class="string" id="7575856">&#34;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;%q&#34;</span><span class="op" id="7575893">,</span>&nbsp;<span class="ident" id="7575895">value</span><span class="op" id="7575900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7575906">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575912">subsetVal</span>&nbsp;<span class="op" id="7575922">=</span>&nbsp;<span class="ident" id="7575924">int64</span><span class="op" id="7575929">(</span><span class="ident" id="7575930">i</span><span class="op" id="7575931">)</span>&nbsp;<span class="comment" id="7575933">//&nbsp;int64&nbsp;is&nbsp;a&nbsp;subset&nbsp;type,&nbsp;but&nbsp;not&nbsp;int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575977">default</span><span class="op" id="7575984">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575990">stmt</span><span class="op" id="7575994">.</span><span class="ident" id="7575995">Close</span><span class="op" id="7576000">(</span><span class="op" id="7576001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576007">return</span>&nbsp;<span class="ident" id="7576014">nil</span><span class="op" id="7576017">,</span>&nbsp;<span class="ident" id="7576019">errf</span><span class="op" id="7576023">(</span><span class="string" id="7576024">&#34;unsupported&nbsp;conversion&nbsp;for&nbsp;pre-bound&nbsp;parameter&nbsp;%q&nbsp;to&nbsp;type&nbsp;%q&#34;</span><span class="op" id="7576086">,</span>&nbsp;<span class="ident" id="7576088">value</span><span class="op" id="7576093">,</span>&nbsp;<span class="ident" id="7576095">ctype</span><span class="op" id="7576100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7576105">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576110">stmt</span><span class="op" id="7576114">.</span><span class="ident" id="7576115">colValue</span>&nbsp;<span class="op" id="7576124">=</span>&nbsp;<span class="builtinfunc" id="7576126">append</span><span class="op" id="7576132">(</span><span class="ident" id="7576133">stmt</span><span class="op" id="7576137">.</span><span class="ident" id="7576138">colValue</span><span class="op" id="7576146">,</span>&nbsp;<span class="ident" id="7576148">subsetVal</span><span class="op" id="7576157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7576161">}</span>&nbsp;<span class="keyword" id="7576163">else</span>&nbsp;<span class="op" id="7576168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576173">stmt</span><span class="op" id="7576177">.</span><span class="ident" id="7576178">placeholders</span><span class="op" id="7576190">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576196">stmt</span><span class="op" id="7576200">.</span><span class="ident" id="7576201">placeholderConverter</span>&nbsp;<span class="op" id="7576222">=</span>&nbsp;<span class="builtinfunc" id="7576224">append</span><span class="op" id="7576230">(</span><span class="ident" id="7576231">stmt</span><span class="op" id="7576235">.</span><span class="ident" id="7576236">placeholderConverter</span><span class="op" id="7576256">,</span>&nbsp;<span class="ident" id="7576258">converterForType</span><span class="op" id="7576274">(</span><span class="ident" id="7576275">ctype</span><span class="op" id="7576280">)</span><span class="op" id="7576281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576286">stmt</span><span class="op" id="7576290">.</span><span class="ident" id="7576291">colValue</span>&nbsp;<span class="op" id="7576300">=</span>&nbsp;<span class="builtinfunc" id="7576302">append</span><span class="op" id="7576308">(</span><span class="ident" id="7576309">stmt</span><span class="op" id="7576313">.</span><span class="ident" id="7576314">colValue</span><span class="op" id="7576322">,</span>&nbsp;<span class="string" id="7576324">&#34;?&#34;</span><span class="op" id="7576327">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7576331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7576334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576337">return</span>&nbsp;<span class="ident" id="7576344">stmt</span><span class="op" id="7576348">,</span>&nbsp;<span class="ident" id="7576350">nil</span><br>
<span class="lineno"></span><span class="op" id="7576354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="7576357">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="7576396">var</span>&nbsp;<span class="ident" id="7576400">hookPrepareBadConn</span>&nbsp;<span class="keyword" id="7576419">func</span><span class="op" id="7576423">(</span><span class="op" id="7576424">)</span>&nbsp;<span class="builtintype" id="7576426">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7576432">func</span>&nbsp;<span class="op" id="7576437">(</span><span class="ident" id="7576438">c</span>&nbsp;<span class="op" id="7576440">*</span><span class="ident" id="7576441">fakeConn</span><span class="op" id="7576449">)</span>&nbsp;<span class="ident" id="7576451">Prepare</span><span class="op" id="7576458">(</span><span class="ident" id="7576459">query</span>&nbsp;<span class="builtintype" id="7576465">string</span><span class="op" id="7576471">)</span>&nbsp;<span class="op" id="7576473">(</span><span class="ident" id="7576474">driver</span><span class="op" id="7576480">.</span><span class="ident" id="7576481">Stmt</span><span class="op" id="7576485">,</span>&nbsp;<span class="builtintype" id="7576487">error</span><span class="op" id="7576492">)</span>&nbsp;<span class="op" id="7576494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576497">c</span><span class="op" id="7576498">.</span><span class="ident" id="7576499">numPrepare</span><span class="op" id="7576509">++</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576513">if</span>&nbsp;<span class="ident" id="7576516">c</span><span class="op" id="7576517">.</span><span class="ident" id="7576518">db</span>&nbsp;<span class="op" id="7576521">==</span>&nbsp;<span class="ident" id="7576524">nil</span>&nbsp;<span class="op" id="7576528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7576532">panic</span><span class="op" id="7576537">(</span><span class="string" id="7576538">&#34;nil&nbsp;c.db;&nbsp;conn&nbsp;=&nbsp;&#34;</span>&nbsp;<span class="op" id="7576558">+</span>&nbsp;<span class="ident" id="7576560">fmt</span><span class="op" id="7576563">.</span><span class="ident" id="7576564">Sprintf</span><span class="op" id="7576571">(</span><span class="string" id="7576572">&#34;%#v&#34;</span><span class="op" id="7576577">,</span>&nbsp;<span class="ident" id="7576579">c</span><span class="op" id="7576580">)</span><span class="op" id="7576581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7576584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576588">if</span>&nbsp;<span class="ident" id="7576591">hookPrepareBadConn</span>&nbsp;<span class="op" id="7576610">!=</span>&nbsp;<span class="ident" id="7576613">nil</span>&nbsp;<span class="op" id="7576617">&amp;&amp;</span>&nbsp;<span class="ident" id="7576620">hookPrepareBadConn</span><span class="op" id="7576638">(</span><span class="op" id="7576639">)</span>&nbsp;<span class="op" id="7576641">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576645">return</span>&nbsp;<span class="ident" id="7576652">nil</span><span class="op" id="7576655">,</span>&nbsp;<span class="ident" id="7576657">driver</span><span class="op" id="7576663">.</span><span class="ident" id="7576664">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7576676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576680">parts</span>&nbsp;<span class="op" id="7576686">:=</span>&nbsp;<span class="ident" id="7576689">strings</span><span class="op" id="7576696">.</span><span class="ident" id="7576697">Split</span><span class="op" id="7576702">(</span><span class="ident" id="7576703">query</span><span class="op" id="7576708">,</span>&nbsp;<span class="string" id="7576710">&#34;|&#34;</span><span class="op" id="7576713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576716">if</span>&nbsp;<span class="builtinfunc" id="7576719">len</span><span class="op" id="7576722">(</span><span class="ident" id="7576723">parts</span><span class="op" id="7576728">)</span>&nbsp;<span class="op" id="7576730">&lt;</span>&nbsp;<span class="num" id="7576732">1</span>&nbsp;<span class="op" id="7576734">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576738">return</span>&nbsp;<span class="ident" id="7576745">nil</span><span class="op" id="7576748">,</span>&nbsp;<span class="ident" id="7576750">errf</span><span class="op" id="7576754">(</span><span class="string" id="7576755">&#34;empty&nbsp;query&#34;</span><span class="op" id="7576768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7576771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576774">cmd</span>&nbsp;<span class="op" id="7576778">:=</span>&nbsp;<span class="ident" id="7576781">parts</span><span class="op" id="7576786">[</span><span class="num" id="7576787">0</span><span class="op" id="7576788">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576791">parts</span>&nbsp;<span class="op" id="7576797">=</span>&nbsp;<span class="ident" id="7576799">parts</span><span class="op" id="7576804">[</span><span class="num" id="7576805">1</span><span class="op" id="7576806">:</span><span class="op" id="7576807">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576810">stmt</span>&nbsp;<span class="op" id="7576815">:=</span>&nbsp;<span class="op" id="7576818">&amp;</span><span class="ident" id="7576819">fakeStmt</span><span class="op" id="7576827">{</span><span class="ident" id="7576828">q</span><span class="op" id="7576829">:</span>&nbsp;<span class="ident" id="7576831">query</span><span class="op" id="7576836">,</span>&nbsp;<span class="ident" id="7576838">c</span><span class="op" id="7576839">:</span>&nbsp;<span class="ident" id="7576841">c</span><span class="op" id="7576842">,</span>&nbsp;<span class="ident" id="7576844">cmd</span><span class="op" id="7576847">:</span>&nbsp;<span class="ident" id="7576849">cmd</span><span class="op" id="7576852">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576855">c</span><span class="op" id="7576856">.</span><span class="ident" id="7576857">incrStat</span><span class="op" id="7576865">(</span><span class="op" id="7576866">&amp;</span><span class="ident" id="7576867">c</span><span class="op" id="7576868">.</span><span class="ident" id="7576869">stmtsMade</span><span class="op" id="7576878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576881">switch</span>&nbsp;<span class="ident" id="7576888">cmd</span>&nbsp;<span class="op" id="7576892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576895">case</span>&nbsp;<span class="string" id="7576900">&#34;WIPE&#34;</span><span class="op" id="7576906">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7576910">//&nbsp;Nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576922">case</span>&nbsp;<span class="string" id="7576927">&#34;SELECT&#34;</span><span class="op" id="7576935">:</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576939">return</span>&nbsp;<span class="ident" id="7576946">c</span><span class="op" id="7576947">.</span><span class="ident" id="7576948">prepareSelect</span><span class="op" id="7576961">(</span><span class="ident" id="7576962">stmt</span><span class="op" id="7576966">,</span>&nbsp;<span class="ident" id="7576968">parts</span><span class="op" id="7576973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576976">case</span>&nbsp;<span class="string" id="7576981">&#34;CREATE&#34;</span><span class="op" id="7576989">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576993">return</span>&nbsp;<span class="ident" id="7577000">c</span><span class="op" id="7577001">.</span><span class="ident" id="7577002">prepareCreate</span><span class="op" id="7577015">(</span><span class="ident" id="7577016">stmt</span><span class="op" id="7577020">,</span>&nbsp;<span class="ident" id="7577022">parts</span><span class="op" id="7577027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7577030">case</span>&nbsp;<span class="string" id="7577035">&#34;INSERT&#34;</span><span class="op" id="7577043">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7577047">return</span>&nbsp;<span class="ident" id="7577054">c</span><span class="op" id="7577055">.</span><span class="ident" id="7577056">prepareInsert</span><span class="op" id="7577069">(</span><span class="ident" id="7577070">stmt</span><span class="op" id="7577074">,</span>&nbsp;<span class="ident" id="7577076">parts</span><span class="op" id="7577081">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7577084">case</span>&nbsp;<span class="string" id="7577089">&#34;NOSERT&#34;</span><span class="op" id="7577097">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7577101">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7577181">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7577225">return</span>&nbsp;<span class="ident" id="7577232">c</span><span class="op" id="7577233">.</span><span class="ident" id="7577234">prepareInsert</span><span class="op" id="7577247">(</span><span class="ident" id="7577248">stmt</span><span class="op" id="7577252">,</span>&nbsp;<span class="ident" id="7577254">parts</span><span class="op" id="7577259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7577262">default</span><span class="op" id="7577269">:</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7577273">stmt</span><span class="op" id="7577277">.</span><span class="ident" id="7577278">Close</span><span class="op" id="7577283">(</span><span class="op" id="7577284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7577288">return</span>&nbsp;<span class="ident" id="7577295">nil</span><span class="op" id="7577298">,</span>&nbsp;<span class="ident" id="7577300">errf</span><span class="op" id="7577304">(</span><span class="string" id="7577305">&#34;unsupported&nbsp;command&nbsp;type&nbsp;%q&#34;</span><span class="op" id="7577334">,</span>&nbsp;<span class="ident" id="7577336">cmd</span><span class="op" id="7577339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7577342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7577345">return</span>&nbsp;<span class="ident" id="7577352">stmt</span><span class="op" id="7577356">,</span>&nbsp;<span class="ident" id="7577358">nil</span><br>
<span class="lineno"></span><span class="op" id="7577362">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="7577365">func</span>&nbsp;<span class="op" id="7577370">(</span><span class="ident" id="7577371">s</span>&nbsp;<span class="op" id="7577373">*</span><span class="ident" id="7577374">fakeStmt</span><span class="op" id="7577382">)</span>&nbsp;<span class="ident" id="7577384">ColumnConverter</span><span class="op" id="7577399">(</span><span class="ident" id="7577400">idx</span>&nbsp;<span class="builtintype" id="7577404">int</span><span class="op" id="7577407">)</span>&nbsp;<span class="ident" id="7577409">driver</span><span class="op" id="7577415">.</span><span class="ident" id="7577416">ValueConverter</span>&nbsp;<span class="op" id="7577431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7577434">if</span>&nbsp;<span class="builtinfunc" id="7577437">len</span><span class="op" id="7577440">(</span><span class="ident" id="7577441">s</span><span class="op" id="7577442">.</span><span class="ident" id="7577443">placeholderConverter</span><span class="op" id="7577463">)</span>&nbsp;<span class="op" id="7577465">==</span>&nbsp;<span class="num" id="7577468">0</span>&nbsp;<span class="op" id="7577470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7577474">return</span>&nbsp;<span class="ident" id="7577481">driver</span><span class="op" id="7577487">.</span><span class="ident" id="7577488">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7577515">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7577518">return</span>&nbsp;<span class="ident" id="7577525">s</span><span class="op" id="7577526">.</span><span class="ident" id="7577527">placeholderConverter</span><span class="op" id="7577547">[</span><span class="ident" id="7577548">idx</span><span class="op" id="7577551">]</span><br>
<span class="lineno"></span><span class="op" id="7577553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7577556">func</span>&nbsp;<span class="op" id="7577561">(</span><span class="ident" id="7577562">s</span>&nbsp;<span class="op" id="7577564">*</span><span class="ident" id="7577565">fakeStmt</span><span class="op" id="7577573">)</span>&nbsp;<span class="ident" id="7577575">Close</span><span class="op" id="7577580">(</span><span class="op" id="7577581">)</span>&nbsp;<span class="builtintype" id="7577583">error</span>&nbsp;<span class="op" id="7577589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7577592">if</span>&nbsp;<span class="ident" id="7577595">s</span><span class="op" id="7577596">.</span><span class="ident" id="7577597">c</span>&nbsp;<span class="op" id="7577599">==</span>&nbsp;<span class="ident" id="7577602">nil</span>&nbsp;<span class="op" id="7577606">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7577610">panic</span><span class="op" id="7577615">(</span><span class="string" id="7577616">&#34;nil&nbsp;conn&nbsp;in&nbsp;fakeStmt.Close&#34;</span><span class="op" id="7577644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7577647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7577650">if</span>&nbsp;<span class="ident" id="7577653">s</span><span class="op" id="7577654">.</span><span class="ident" id="7577655">c</span><span class="op" id="7577656">.</span><span class="ident" id="7577657">db</span>&nbsp;<span class="op" id="7577660">==</span>&nbsp;<span class="ident" id="7577663">nil</span>&nbsp;<span class="op" id="7577667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7577671">panic</span><span class="op" id="7577676">(</span><span class="string" id="7577677">&#34;in&nbsp;fakeStmt.Close,&nbsp;conn&#39;s&nbsp;db&nbsp;is&nbsp;nil&nbsp;(already&nbsp;closed)&#34;</span><span class="op" id="7577731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7577734">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7577737">if</span>&nbsp;<span class="op" id="7577740">!</span><span class="ident" id="7577741">s</span><span class="op" id="7577742">.</span><span class="ident" id="7577743">closed</span>&nbsp;<span class="op" id="7577750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7577754">s</span><span class="op" id="7577755">.</span><span class="ident" id="7577756">c</span><span class="op" id="7577757">.</span><span class="ident" id="7577758">incrStat</span><span class="op" id="7577766">(</span><span class="op" id="7577767">&amp;</span><span class="ident" id="7577768">s</span><span class="op" id="7577769">.</span><span class="ident" id="7577770">c</span><span class="op" id="7577771">.</span><span class="ident" id="7577772">stmtsClosed</span><span class="op" id="7577783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7577787">s</span><span class="op" id="7577788">.</span><span class="ident" id="7577789">closed</span>&nbsp;<span class="op" id="7577796">=</span>&nbsp;<span class="builtintype" id="7577798">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7577804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7577807">return</span>&nbsp;<span class="ident" id="7577814">nil</span><br>
<span class="lineno">520</span><span class="op" id="7577818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7577821">var</span>&nbsp;<span class="ident" id="7577825">errClosed</span>&nbsp;<span class="op" id="7577835">=</span>&nbsp;<span class="ident" id="7577837">errors</span><span class="op" id="7577843">.</span><span class="ident" id="7577844">New</span><span class="op" id="7577847">(</span><span class="string" id="7577848">&#34;fakedb:&nbsp;statement&nbsp;has&nbsp;been&nbsp;closed&#34;</span><span class="op" id="7577883">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7577886">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno">525</span><span class="keyword" id="7577925">var</span>&nbsp;<span class="ident" id="7577929">hookExecBadConn</span>&nbsp;<span class="keyword" id="7577945">func</span><span class="op" id="7577949">(</span><span class="op" id="7577950">)</span>&nbsp;<span class="builtintype" id="7577952">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7577958">func</span>&nbsp;<span class="op" id="7577963">(</span><span class="ident" id="7577964">s</span>&nbsp;<span class="op" id="7577966">*</span><span class="ident" id="7577967">fakeStmt</span><span class="op" id="7577975">)</span>&nbsp;<span class="ident" id="7577977">Exec</span><span class="op" id="7577981">(</span><span class="ident" id="7577982">args</span>&nbsp;<span class="op" id="7577987">[</span><span class="op" id="7577988">]</span><span class="ident" id="7577989">driver</span><span class="op" id="7577995">.</span><span class="ident" id="7577996">Value</span><span class="op" id="7578001">)</span>&nbsp;<span class="op" id="7578003">(</span><span class="ident" id="7578004">driver</span><span class="op" id="7578010">.</span><span class="ident" id="7578011">Result</span><span class="op" id="7578017">,</span>&nbsp;<span class="builtintype" id="7578019">error</span><span class="op" id="7578024">)</span>&nbsp;<span class="op" id="7578026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578029">if</span>&nbsp;<span class="ident" id="7578032">s</span><span class="op" id="7578033">.</span><span class="ident" id="7578034">closed</span>&nbsp;<span class="op" id="7578041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578045">return</span>&nbsp;<span class="ident" id="7578052">nil</span><span class="op" id="7578055">,</span>&nbsp;<span class="ident" id="7578057">errClosed</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7578068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578072">if</span>&nbsp;<span class="ident" id="7578075">hookExecBadConn</span>&nbsp;<span class="op" id="7578091">!=</span>&nbsp;<span class="ident" id="7578094">nil</span>&nbsp;<span class="op" id="7578098">&amp;&amp;</span>&nbsp;<span class="ident" id="7578101">hookExecBadConn</span><span class="op" id="7578116">(</span><span class="op" id="7578117">)</span>&nbsp;<span class="op" id="7578119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578123">return</span>&nbsp;<span class="ident" id="7578130">nil</span><span class="op" id="7578133">,</span>&nbsp;<span class="ident" id="7578135">driver</span><span class="op" id="7578141">.</span><span class="ident" id="7578142">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7578154">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7578158">err</span>&nbsp;<span class="op" id="7578162">:=</span>&nbsp;<span class="ident" id="7578165">checkSubsetTypes</span><span class="op" id="7578181">(</span><span class="ident" id="7578182">args</span><span class="op" id="7578186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578189">if</span>&nbsp;<span class="ident" id="7578192">err</span>&nbsp;<span class="op" id="7578196">!=</span>&nbsp;<span class="ident" id="7578199">nil</span>&nbsp;<span class="op" id="7578203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578207">return</span>&nbsp;<span class="ident" id="7578214">nil</span><span class="op" id="7578217">,</span>&nbsp;<span class="ident" id="7578219">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7578224">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7578228">db</span>&nbsp;<span class="op" id="7578231">:=</span>&nbsp;<span class="ident" id="7578234">s</span><span class="op" id="7578235">.</span><span class="ident" id="7578236">c</span><span class="op" id="7578237">.</span><span class="ident" id="7578238">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578242">switch</span>&nbsp;<span class="ident" id="7578249">s</span><span class="op" id="7578250">.</span><span class="ident" id="7578251">cmd</span>&nbsp;<span class="op" id="7578255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578258">case</span>&nbsp;<span class="string" id="7578263">&#34;WIPE&#34;</span><span class="op" id="7578269">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7578273">db</span><span class="op" id="7578275">.</span><span class="ident" id="7578276">wipe</span><span class="op" id="7578280">(</span><span class="op" id="7578281">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578285">return</span>&nbsp;<span class="ident" id="7578292">driver</span><span class="op" id="7578298">.</span><span class="ident" id="7578299">ResultNoRows</span><span class="op" id="7578311">,</span>&nbsp;<span class="ident" id="7578313">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578318">case</span>&nbsp;<span class="string" id="7578323">&#34;CREATE&#34;</span><span class="op" id="7578331">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578335">if</span>&nbsp;<span class="ident" id="7578338">err</span>&nbsp;<span class="op" id="7578342">:=</span>&nbsp;<span class="ident" id="7578345">db</span><span class="op" id="7578347">.</span><span class="ident" id="7578348">createTable</span><span class="op" id="7578359">(</span><span class="ident" id="7578360">s</span><span class="op" id="7578361">.</span><span class="ident" id="7578362">table</span><span class="op" id="7578367">,</span>&nbsp;<span class="ident" id="7578369">s</span><span class="op" id="7578370">.</span><span class="ident" id="7578371">colName</span><span class="op" id="7578378">,</span>&nbsp;<span class="ident" id="7578380">s</span><span class="op" id="7578381">.</span><span class="ident" id="7578382">colType</span><span class="op" id="7578389">)</span><span class="op" id="7578390">;</span>&nbsp;<span class="ident" id="7578392">err</span>&nbsp;<span class="op" id="7578396">!=</span>&nbsp;<span class="ident" id="7578399">nil</span>&nbsp;<span class="op" id="7578403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578408">return</span>&nbsp;<span class="ident" id="7578415">nil</span><span class="op" id="7578418">,</span>&nbsp;<span class="ident" id="7578420">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7578426">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578430">return</span>&nbsp;<span class="ident" id="7578437">driver</span><span class="op" id="7578443">.</span><span class="ident" id="7578444">ResultNoRows</span><span class="op" id="7578456">,</span>&nbsp;<span class="ident" id="7578458">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578463">case</span>&nbsp;<span class="string" id="7578468">&#34;INSERT&#34;</span><span class="op" id="7578476">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578480">return</span>&nbsp;<span class="ident" id="7578487">s</span><span class="op" id="7578488">.</span><span class="ident" id="7578489">execInsert</span><span class="op" id="7578499">(</span><span class="ident" id="7578500">args</span><span class="op" id="7578504">,</span>&nbsp;<span class="builtintype" id="7578506">true</span><span class="op" id="7578510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578513">case</span>&nbsp;<span class="string" id="7578518">&#34;NOSERT&#34;</span><span class="op" id="7578526">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7578530">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7578610">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578654">return</span>&nbsp;<span class="ident" id="7578661">s</span><span class="op" id="7578662">.</span><span class="ident" id="7578663">execInsert</span><span class="op" id="7578673">(</span><span class="ident" id="7578674">args</span><span class="op" id="7578678">,</span>&nbsp;<span class="builtintype" id="7578680">false</span><span class="op" id="7578685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7578688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7578691">fmt</span><span class="op" id="7578694">.</span><span class="ident" id="7578695">Printf</span><span class="op" id="7578701">(</span><span class="string" id="7578702">&#34;EXEC&nbsp;statement,&nbsp;cmd=%q:&nbsp;%#v\n&#34;</span><span class="op" id="7578733">,</span>&nbsp;<span class="ident" id="7578735">s</span><span class="op" id="7578736">.</span><span class="ident" id="7578737">cmd</span><span class="op" id="7578740">,</span>&nbsp;<span class="ident" id="7578742">s</span><span class="op" id="7578743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7578746">return</span>&nbsp;<span class="ident" id="7578753">nil</span><span class="op" id="7578756">,</span>&nbsp;<span class="ident" id="7578758">fmt</span><span class="op" id="7578761">.</span><span class="ident" id="7578762">Errorf</span><span class="op" id="7578768">(</span><span class="string" id="7578769">&#34;unimplemented&nbsp;statement&nbsp;Exec&nbsp;command&nbsp;type&nbsp;of&nbsp;%q&#34;</span><span class="op" id="7578818">,</span>&nbsp;<span class="ident" id="7578820">s</span><span class="op" id="7578821">.</span><span class="ident" id="7578822">cmd</span><span class="op" id="7578825">)</span><br>
<span class="lineno">560</span><span class="op" id="7578827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7578830">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;true,&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span><span class="comment" id="7578882">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;false&nbsp;do&nbsp;prep-work&nbsp;and&nbsp;error&nbsp;checking,&nbsp;but&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="7578951">//&nbsp;actually&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno">565</span><span class="keyword" id="7578989">func</span>&nbsp;<span class="op" id="7578994">(</span><span class="ident" id="7578995">s</span>&nbsp;<span class="op" id="7578997">*</span><span class="ident" id="7578998">fakeStmt</span><span class="op" id="7579006">)</span>&nbsp;<span class="ident" id="7579008">execInsert</span><span class="op" id="7579018">(</span><span class="ident" id="7579019">args</span>&nbsp;<span class="op" id="7579024">[</span><span class="op" id="7579025">]</span><span class="ident" id="7579026">driver</span><span class="op" id="7579032">.</span><span class="ident" id="7579033">Value</span><span class="op" id="7579038">,</span>&nbsp;<span class="ident" id="7579040">doInsert</span>&nbsp;<span class="builtintype" id="7579049">bool</span><span class="op" id="7579053">)</span>&nbsp;<span class="op" id="7579055">(</span><span class="ident" id="7579056">driver</span><span class="op" id="7579062">.</span><span class="ident" id="7579063">Result</span><span class="op" id="7579069">,</span>&nbsp;<span class="builtintype" id="7579071">error</span><span class="op" id="7579076">)</span>&nbsp;<span class="op" id="7579078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7579081">db</span>&nbsp;<span class="op" id="7579084">:=</span>&nbsp;<span class="ident" id="7579087">s</span><span class="op" id="7579088">.</span><span class="ident" id="7579089">c</span><span class="op" id="7579090">.</span><span class="ident" id="7579091">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7579095">if</span>&nbsp;<span class="builtinfunc" id="7579098">len</span><span class="op" id="7579101">(</span><span class="ident" id="7579102">args</span><span class="op" id="7579106">)</span>&nbsp;<span class="op" id="7579108">!=</span>&nbsp;<span class="ident" id="7579111">s</span><span class="op" id="7579112">.</span><span class="ident" id="7579113">placeholders</span>&nbsp;<span class="op" id="7579126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7579130">panic</span><span class="op" id="7579135">(</span><span class="string" id="7579136">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="7579194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7579197">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7579200">db</span><span class="op" id="7579202">.</span><span class="ident" id="7579203">mu</span><span class="op" id="7579205">.</span><span class="ident" id="7579206">Lock</span><span class="op" id="7579210">(</span><span class="op" id="7579211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7579214">t</span><span class="op" id="7579215">,</span>&nbsp;<span class="ident" id="7579217">ok</span>&nbsp;<span class="op" id="7579220">:=</span>&nbsp;<span class="ident" id="7579223">db</span><span class="op" id="7579225">.</span><span class="ident" id="7579226">table</span><span class="op" id="7579231">(</span><span class="ident" id="7579232">s</span><span class="op" id="7579233">.</span><span class="ident" id="7579234">table</span><span class="op" id="7579239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7579242">db</span><span class="op" id="7579244">.</span><span class="ident" id="7579245">mu</span><span class="op" id="7579247">.</span><span class="ident" id="7579248">Unlock</span><span class="op" id="7579254">(</span><span class="op" id="7579255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7579258">if</span>&nbsp;<span class="op" id="7579261">!</span><span class="ident" id="7579262">ok</span>&nbsp;<span class="op" id="7579265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7579269">return</span>&nbsp;<span class="ident" id="7579276">nil</span><span class="op" id="7579279">,</span>&nbsp;<span class="ident" id="7579281">fmt</span><span class="op" id="7579284">.</span><span class="ident" id="7579285">Errorf</span><span class="op" id="7579291">(</span><span class="string" id="7579292">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="7579324">,</span>&nbsp;<span class="ident" id="7579326">s</span><span class="op" id="7579327">.</span><span class="ident" id="7579328">table</span><span class="op" id="7579333">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7579336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7579340">t</span><span class="op" id="7579341">.</span><span class="ident" id="7579342">mu</span><span class="op" id="7579344">.</span><span class="ident" id="7579345">Lock</span><span class="op" id="7579349">(</span><span class="op" id="7579350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7579353">defer</span>&nbsp;<span class="ident" id="7579359">t</span><span class="op" id="7579360">.</span><span class="ident" id="7579361">mu</span><span class="op" id="7579363">.</span><span class="ident" id="7579364">Unlock</span><span class="op" id="7579370">(</span><span class="op" id="7579371">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7579375">var</span>&nbsp;<span class="ident" id="7579379">cols</span>&nbsp;<span class="op" id="7579384">[</span><span class="op" id="7579385">]</span><span class="keyword" id="7579386">interface</span><span class="op" id="7579395">{</span><span class="op" id="7579396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7579399">if</span>&nbsp;<span class="ident" id="7579402">doInsert</span>&nbsp;<span class="op" id="7579411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7579415">cols</span>&nbsp;<span class="op" id="7579420">=</span>&nbsp;<span class="builtinfunc" id="7579422">make</span><span class="op" id="7579426">(</span><span class="op" id="7579427">[</span><span class="op" id="7579428">]</span><span class="keyword" id="7579429">interface</span><span class="op" id="7579438">{</span><span class="op" id="7579439">}</span><span class="op" id="7579440">,</span>&nbsp;<span class="builtinfunc" id="7579442">len</span><span class="op" id="7579445">(</span><span class="ident" id="7579446">t</span><span class="op" id="7579447">.</span><span class="ident" id="7579448">colname</span><span class="op" id="7579455">)</span><span class="op" id="7579456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7579459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7579462">argPos</span>&nbsp;<span class="op" id="7579469">:=</span>&nbsp;<span class="num" id="7579472">0</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7579475">for</span>&nbsp;<span class="ident" id="7579479">n</span><span class="op" id="7579480">,</span>&nbsp;<span class="ident" id="7579482">colname</span>&nbsp;<span class="op" id="7579490">:=</span>&nbsp;<span class="keyword" id="7579493">range</span>&nbsp;<span class="ident" id="7579499">s</span><span class="op" id="7579500">.</span><span class="ident" id="7579501">colName</span>&nbsp;<span class="op" id="7579509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7579513">colidx</span>&nbsp;<span class="op" id="7579520">:=</span>&nbsp;<span class="ident" id="7579523">t</span><span class="op" id="7579524">.</span><span class="ident" id="7579525">columnIndex</span><span class="op" id="7579536">(</span><span class="ident" id="7579537">colname</span><span class="op" id="7579544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7579548">if</span>&nbsp;<span class="ident" id="7579551">colidx</span>&nbsp;<span class="op" id="7579558">==</span>&nbsp;<span class="op" id="7579561">-</span><span class="num" id="7579562">1</span>&nbsp;<span class="op" id="7579564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7579569">return</span>&nbsp;<span class="ident" id="7579576">nil</span><span class="op" id="7579579">,</span>&nbsp;<span class="ident" id="7579581">fmt</span><span class="op" id="7579584">.</span><span class="ident" id="7579585">Errorf</span><span class="op" id="7579591">(</span><span class="string" id="7579592">&#34;fakedb:&nbsp;column&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&nbsp;or&nbsp;dropped&nbsp;since&nbsp;prepared&nbsp;statement&nbsp;was&nbsp;created&#34;</span><span class="op" id="7579673">,</span>&nbsp;<span class="ident" id="7579675">colname</span><span class="op" id="7579682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7579686">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7579690">var</span>&nbsp;<span class="ident" id="7579694">val</span>&nbsp;<span class="keyword" id="7579698">interface</span><span class="op" id="7579707">{</span><span class="op" id="7579708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7579712">if</span>&nbsp;<span class="ident" id="7579715">strvalue</span><span class="op" id="7579723">,</span>&nbsp;<span class="ident" id="7579725">ok</span>&nbsp;<span class="op" id="7579728">:=</span>&nbsp;<span class="ident" id="7579731">s</span><span class="op" id="7579732">.</span><span class="ident" id="7579733">colValue</span><span class="op" id="7579741">[</span><span class="ident" id="7579742">n</span><span class="op" id="7579743">]</span><span class="op" id="7579744">.</span><span class="op" id="7579745">(</span><span class="builtintype" id="7579746">string</span><span class="op" id="7579752">)</span><span class="op" id="7579753">;</span>&nbsp;<span class="ident" id="7579755">ok</span>&nbsp;<span class="op" id="7579758">&amp;&amp;</span>&nbsp;<span class="ident" id="7579761">strvalue</span>&nbsp;<span class="op" id="7579770">==</span>&nbsp;<span class="string" id="7579773">&#34;?&#34;</span>&nbsp;<span class="op" id="7579777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7579782">val</span>&nbsp;<span class="op" id="7579786">=</span>&nbsp;<span class="ident" id="7579788">args</span><span class="op" id="7579792">[</span><span class="ident" id="7579793">argPos</span><span class="op" id="7579799">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7579804">argPos</span><span class="op" id="7579810">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7579815">}</span>&nbsp;<span class="keyword" id="7579817">else</span>&nbsp;<span class="op" id="7579822">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7579827">val</span>&nbsp;<span class="op" id="7579831">=</span>&nbsp;<span class="ident" id="7579833">s</span><span class="op" id="7579834">.</span><span class="ident" id="7579835">colValue</span><span class="op" id="7579843">[</span><span class="ident" id="7579844">n</span><span class="op" id="7579845">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7579849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7579853">if</span>&nbsp;<span class="ident" id="7579856">doInsert</span>&nbsp;<span class="op" id="7579865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7579870">cols</span><span class="op" id="7579874">[</span><span class="ident" id="7579875">colidx</span><span class="op" id="7579881">]</span>&nbsp;<span class="op" id="7579883">=</span>&nbsp;<span class="ident" id="7579885">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7579891">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7579894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7579898">if</span>&nbsp;<span class="ident" id="7579901">doInsert</span>&nbsp;<span class="op" id="7579910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7579914">t</span><span class="op" id="7579915">.</span><span class="ident" id="7579916">rows</span>&nbsp;<span class="op" id="7579921">=</span>&nbsp;<span class="builtinfunc" id="7579923">append</span><span class="op" id="7579929">(</span><span class="ident" id="7579930">t</span><span class="op" id="7579931">.</span><span class="ident" id="7579932">rows</span><span class="op" id="7579936">,</span>&nbsp;<span class="op" id="7579938">&amp;</span><span class="ident" id="7579939">row</span><span class="op" id="7579942">{</span><span class="ident" id="7579943">cols</span><span class="op" id="7579947">:</span>&nbsp;<span class="ident" id="7579949">cols</span><span class="op" id="7579953">}</span><span class="op" id="7579954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7579957">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7579960">return</span>&nbsp;<span class="ident" id="7579967">driver</span><span class="op" id="7579973">.</span><span class="ident" id="7579974">RowsAffected</span><span class="op" id="7579986">(</span><span class="num" id="7579987">1</span><span class="op" id="7579988">)</span><span class="op" id="7579989">,</span>&nbsp;<span class="ident" id="7579991">nil</span><br>
<span class="lineno"></span><span class="op" id="7579995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7579998">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="7580037">var</span>&nbsp;<span class="ident" id="7580041">hookQueryBadConn</span>&nbsp;<span class="keyword" id="7580058">func</span><span class="op" id="7580062">(</span><span class="op" id="7580063">)</span>&nbsp;<span class="builtintype" id="7580065">bool</span><br>
<span class="lineno">610</span><br>
<span class="lineno"></span><span class="keyword" id="7580071">func</span>&nbsp;<span class="op" id="7580076">(</span><span class="ident" id="7580077">s</span>&nbsp;<span class="op" id="7580079">*</span><span class="ident" id="7580080">fakeStmt</span><span class="op" id="7580088">)</span>&nbsp;<span class="ident" id="7580090">Query</span><span class="op" id="7580095">(</span><span class="ident" id="7580096">args</span>&nbsp;<span class="op" id="7580101">[</span><span class="op" id="7580102">]</span><span class="ident" id="7580103">driver</span><span class="op" id="7580109">.</span><span class="ident" id="7580110">Value</span><span class="op" id="7580115">)</span>&nbsp;<span class="op" id="7580117">(</span><span class="ident" id="7580118">driver</span><span class="op" id="7580124">.</span><span class="ident" id="7580125">Rows</span><span class="op" id="7580129">,</span>&nbsp;<span class="builtintype" id="7580131">error</span><span class="op" id="7580136">)</span>&nbsp;<span class="op" id="7580138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7580141">if</span>&nbsp;<span class="ident" id="7580144">s</span><span class="op" id="7580145">.</span><span class="ident" id="7580146">closed</span>&nbsp;<span class="op" id="7580153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7580157">return</span>&nbsp;<span class="ident" id="7580164">nil</span><span class="op" id="7580167">,</span>&nbsp;<span class="ident" id="7580169">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7580180">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7580184">if</span>&nbsp;<span class="ident" id="7580187">hookQueryBadConn</span>&nbsp;<span class="op" id="7580204">!=</span>&nbsp;<span class="ident" id="7580207">nil</span>&nbsp;<span class="op" id="7580211">&amp;&amp;</span>&nbsp;<span class="ident" id="7580214">hookQueryBadConn</span><span class="op" id="7580230">(</span><span class="op" id="7580231">)</span>&nbsp;<span class="op" id="7580233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7580237">return</span>&nbsp;<span class="ident" id="7580244">nil</span><span class="op" id="7580247">,</span>&nbsp;<span class="ident" id="7580249">driver</span><span class="op" id="7580255">.</span><span class="ident" id="7580256">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7580268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7580272">err</span>&nbsp;<span class="op" id="7580276">:=</span>&nbsp;<span class="ident" id="7580279">checkSubsetTypes</span><span class="op" id="7580295">(</span><span class="ident" id="7580296">args</span><span class="op" id="7580300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7580303">if</span>&nbsp;<span class="ident" id="7580306">err</span>&nbsp;<span class="op" id="7580310">!=</span>&nbsp;<span class="ident" id="7580313">nil</span>&nbsp;<span class="op" id="7580317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7580321">return</span>&nbsp;<span class="ident" id="7580328">nil</span><span class="op" id="7580331">,</span>&nbsp;<span class="ident" id="7580333">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7580338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7580342">db</span>&nbsp;<span class="op" id="7580345">:=</span>&nbsp;<span class="ident" id="7580348">s</span><span class="op" id="7580349">.</span><span class="ident" id="7580350">c</span><span class="op" id="7580351">.</span><span class="ident" id="7580352">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7580356">if</span>&nbsp;<span class="builtinfunc" id="7580359">len</span><span class="op" id="7580362">(</span><span class="ident" id="7580363">args</span><span class="op" id="7580367">)</span>&nbsp;<span class="op" id="7580369">!=</span>&nbsp;<span class="ident" id="7580372">s</span><span class="op" id="7580373">.</span><span class="ident" id="7580374">placeholders</span>&nbsp;<span class="op" id="7580387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7580391">panic</span><span class="op" id="7580396">(</span><span class="string" id="7580397">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="7580455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7580458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7580462">db</span><span class="op" id="7580464">.</span><span class="ident" id="7580465">mu</span><span class="op" id="7580467">.</span><span class="ident" id="7580468">Lock</span><span class="op" id="7580472">(</span><span class="op" id="7580473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7580476">t</span><span class="op" id="7580477">,</span>&nbsp;<span class="ident" id="7580479">ok</span>&nbsp;<span class="op" id="7580482">:=</span>&nbsp;<span class="ident" id="7580485">db</span><span class="op" id="7580487">.</span><span class="ident" id="7580488">table</span><span class="op" id="7580493">(</span><span class="ident" id="7580494">s</span><span class="op" id="7580495">.</span><span class="ident" id="7580496">table</span><span class="op" id="7580501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7580504">db</span><span class="op" id="7580506">.</span><span class="ident" id="7580507">mu</span><span class="op" id="7580509">.</span><span class="ident" id="7580510">Unlock</span><span class="op" id="7580516">(</span><span class="op" id="7580517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7580520">if</span>&nbsp;<span class="op" id="7580523">!</span><span class="ident" id="7580524">ok</span>&nbsp;<span class="op" id="7580527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7580531">return</span>&nbsp;<span class="ident" id="7580538">nil</span><span class="op" id="7580541">,</span>&nbsp;<span class="ident" id="7580543">fmt</span><span class="op" id="7580546">.</span><span class="ident" id="7580547">Errorf</span><span class="op" id="7580553">(</span><span class="string" id="7580554">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="7580586">,</span>&nbsp;<span class="ident" id="7580588">s</span><span class="op" id="7580589">.</span><span class="ident" id="7580590">table</span><span class="op" id="7580595">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7580598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7580602">if</span>&nbsp;<span class="ident" id="7580605">s</span><span class="op" id="7580606">.</span><span class="ident" id="7580607">table</span>&nbsp;<span class="op" id="7580613">==</span>&nbsp;<span class="string" id="7580616">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="7580629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7580633">if</span>&nbsp;<span class="builtinfunc" id="7580636">len</span><span class="op" id="7580639">(</span><span class="ident" id="7580640">s</span><span class="op" id="7580641">.</span><span class="ident" id="7580642">whereCol</span><span class="op" id="7580650">)</span>&nbsp;<span class="op" id="7580652">==</span>&nbsp;<span class="num" id="7580655">2</span>&nbsp;<span class="op" id="7580657">&amp;&amp;</span>&nbsp;<span class="ident" id="7580660">s</span><span class="op" id="7580661">.</span><span class="ident" id="7580662">whereCol</span><span class="op" id="7580670">[</span><span class="num" id="7580671">0</span><span class="op" id="7580672">]</span>&nbsp;<span class="op" id="7580674">==</span>&nbsp;<span class="string" id="7580677">&#34;op&#34;</span>&nbsp;<span class="op" id="7580682">&amp;&amp;</span>&nbsp;<span class="ident" id="7580685">s</span><span class="op" id="7580686">.</span><span class="ident" id="7580687">whereCol</span><span class="op" id="7580695">[</span><span class="num" id="7580696">1</span><span class="op" id="7580697">]</span>&nbsp;<span class="op" id="7580699">==</span>&nbsp;<span class="string" id="7580702">&#34;millis&#34;</span>&nbsp;<span class="op" id="7580711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7580716">if</span>&nbsp;<span class="ident" id="7580719">args</span><span class="op" id="7580723">[</span><span class="num" id="7580724">0</span><span class="op" id="7580725">]</span>&nbsp;<span class="op" id="7580727">==</span>&nbsp;<span class="string" id="7580730">&#34;sleep&#34;</span>&nbsp;<span class="op" id="7580738">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7580744">time</span><span class="op" id="7580748">.</span><span class="ident" id="7580749">Sleep</span><span class="op" id="7580754">(</span><span class="ident" id="7580755">time</span><span class="op" id="7580759">.</span><span class="ident" id="7580760">Duration</span><span class="op" id="7580768">(</span><span class="ident" id="7580769">args</span><span class="op" id="7580773">[</span><span class="num" id="7580774">1</span><span class="op" id="7580775">]</span><span class="op" id="7580776">.</span><span class="op" id="7580777">(</span><span class="ident" id="7580778">int64</span><span class="op" id="7580783">)</span><span class="op" id="7580784">)</span>&nbsp;<span class="op" id="7580786">*</span>&nbsp;<span class="ident" id="7580788">time</span><span class="op" id="7580792">.</span><span class="ident" id="7580793">Millisecond</span><span class="op" id="7580804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7580809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7580813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7580816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7580820">t</span><span class="op" id="7580821">.</span><span class="ident" id="7580822">mu</span><span class="op" id="7580824">.</span><span class="ident" id="7580825">Lock</span><span class="op" id="7580829">(</span><span class="op" id="7580830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7580833">defer</span>&nbsp;<span class="ident" id="7580839">t</span><span class="op" id="7580840">.</span><span class="ident" id="7580841">mu</span><span class="op" id="7580843">.</span><span class="ident" id="7580844">Unlock</span><span class="op" id="7580850">(</span><span class="op" id="7580851">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7580855">colIdx</span>&nbsp;<span class="op" id="7580862">:=</span>&nbsp;<span class="builtinfunc" id="7580865">make</span><span class="op" id="7580869">(</span><span class="keyword" id="7580870">map</span><span class="op" id="7580873">[</span><span class="builtintype" id="7580874">string</span><span class="op" id="7580880">]</span><span class="builtintype" id="7580881">int</span><span class="op" id="7580884">)</span>&nbsp;<span class="comment" id="7580886">//&nbsp;select&nbsp;column&nbsp;name&nbsp;-&gt;&nbsp;column&nbsp;index&nbsp;in&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7580934">for</span>&nbsp;<span class="ident" id="7580938">_</span><span class="op" id="7580939">,</span>&nbsp;<span class="ident" id="7580941">name</span>&nbsp;<span class="op" id="7580946">:=</span>&nbsp;<span class="keyword" id="7580949">range</span>&nbsp;<span class="ident" id="7580955">s</span><span class="op" id="7580956">.</span><span class="ident" id="7580957">colName</span>&nbsp;<span class="op" id="7580965">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7580969">idx</span>&nbsp;<span class="op" id="7580973">:=</span>&nbsp;<span class="ident" id="7580976">t</span><span class="op" id="7580977">.</span><span class="ident" id="7580978">columnIndex</span><span class="op" id="7580989">(</span><span class="ident" id="7580990">name</span><span class="op" id="7580994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7580998">if</span>&nbsp;<span class="ident" id="7581001">idx</span>&nbsp;<span class="op" id="7581005">==</span>&nbsp;<span class="op" id="7581008">-</span><span class="num" id="7581009">1</span>&nbsp;<span class="op" id="7581011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7581016">return</span>&nbsp;<span class="ident" id="7581023">nil</span><span class="op" id="7581026">,</span>&nbsp;<span class="ident" id="7581028">fmt</span><span class="op" id="7581031">.</span><span class="ident" id="7581032">Errorf</span><span class="op" id="7581038">(</span><span class="string" id="7581039">&#34;fakedb:&nbsp;unknown&nbsp;column&nbsp;name&nbsp;%q&#34;</span><span class="op" id="7581071">,</span>&nbsp;<span class="ident" id="7581073">name</span><span class="op" id="7581077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7581081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7581085">colIdx</span><span class="op" id="7581091">[</span><span class="ident" id="7581092">name</span><span class="op" id="7581096">]</span>&nbsp;<span class="op" id="7581098">=</span>&nbsp;<span class="ident" id="7581100">idx</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7581105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7581109">mrows</span>&nbsp;<span class="op" id="7581115">:=</span>&nbsp;<span class="op" id="7581118">[</span><span class="op" id="7581119">]</span><span class="op" id="7581120">*</span><span class="ident" id="7581121">row</span><span class="op" id="7581124">{</span><span class="op" id="7581125">}</span><br>
<span class="lineno"></span><span class="ident" id="7581127">rows</span><span class="op" id="7581131">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7581134">for</span>&nbsp;<span class="ident" id="7581138">_</span><span class="op" id="7581139">,</span>&nbsp;<span class="ident" id="7581141">trow</span>&nbsp;<span class="op" id="7581146">:=</span>&nbsp;<span class="keyword" id="7581149">range</span>&nbsp;<span class="ident" id="7581155">t</span><span class="op" id="7581156">.</span><span class="ident" id="7581157">rows</span>&nbsp;<span class="op" id="7581162">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7581166">//&nbsp;Process&nbsp;the&nbsp;where&nbsp;clause,&nbsp;skipping&nbsp;non-match&nbsp;rows.&nbsp;This&nbsp;is&nbsp;lazy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7581235">//&nbsp;and&nbsp;just&nbsp;uses&nbsp;fmt.Sprintf(&#34;%v&#34;)&nbsp;to&nbsp;test&nbsp;equality.&nbsp;&nbsp;Good&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7581303">//&nbsp;for&nbsp;test&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7581323">for</span>&nbsp;<span class="ident" id="7581327">widx</span><span class="op" id="7581331">,</span>&nbsp;<span class="ident" id="7581333">wcol</span>&nbsp;<span class="op" id="7581338">:=</span>&nbsp;<span class="keyword" id="7581341">range</span>&nbsp;<span class="ident" id="7581347">s</span><span class="op" id="7581348">.</span><span class="ident" id="7581349">whereCol</span>&nbsp;<span class="op" id="7581358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7581363">idx</span>&nbsp;<span class="op" id="7581367">:=</span>&nbsp;<span class="ident" id="7581370">t</span><span class="op" id="7581371">.</span><span class="ident" id="7581372">columnIndex</span><span class="op" id="7581383">(</span><span class="ident" id="7581384">wcol</span><span class="op" id="7581388">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7581393">if</span>&nbsp;<span class="ident" id="7581396">idx</span>&nbsp;<span class="op" id="7581400">==</span>&nbsp;<span class="op" id="7581403">-</span><span class="num" id="7581404">1</span>&nbsp;<span class="op" id="7581406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7581412">return</span>&nbsp;<span class="ident" id="7581419">nil</span><span class="op" id="7581422">,</span>&nbsp;<span class="ident" id="7581424">fmt</span><span class="op" id="7581427">.</span><span class="ident" id="7581428">Errorf</span><span class="op" id="7581434">(</span><span class="string" id="7581435">&#34;db:&nbsp;invalid&nbsp;where&nbsp;clause&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7581471">,</span>&nbsp;<span class="ident" id="7581473">wcol</span><span class="op" id="7581477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7581482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7581487">tcol</span>&nbsp;<span class="op" id="7581492">:=</span>&nbsp;<span class="ident" id="7581495">trow</span><span class="op" id="7581499">.</span><span class="ident" id="7581500">cols</span><span class="op" id="7581504">[</span><span class="ident" id="7581505">idx</span><span class="op" id="7581508">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7581513">if</span>&nbsp;<span class="ident" id="7581516">bs</span><span class="op" id="7581518">,</span>&nbsp;<span class="ident" id="7581520">ok</span>&nbsp;<span class="op" id="7581523">:=</span>&nbsp;<span class="ident" id="7581526">tcol</span><span class="op" id="7581530">.</span><span class="op" id="7581531">(</span><span class="op" id="7581532">[</span><span class="op" id="7581533">]</span><span class="builtintype" id="7581534">byte</span><span class="op" id="7581538">)</span><span class="op" id="7581539">;</span>&nbsp;<span class="ident" id="7581541">ok</span>&nbsp;<span class="op" id="7581544">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7581550">//&nbsp;lazy&nbsp;hack&nbsp;to&nbsp;avoid&nbsp;sprintf&nbsp;%v&nbsp;on&nbsp;a&nbsp;[]byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7581599">tcol</span>&nbsp;<span class="op" id="7581604">=</span>&nbsp;<span class="builtintype" id="7581606">string</span><span class="op" id="7581612">(</span><span class="ident" id="7581613">bs</span><span class="op" id="7581615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7581620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7581625">if</span>&nbsp;<span class="ident" id="7581628">fmt</span><span class="op" id="7581631">.</span><span class="ident" id="7581632">Sprintf</span><span class="op" id="7581639">(</span><span class="string" id="7581640">&#34;%v&#34;</span><span class="op" id="7581644">,</span>&nbsp;<span class="ident" id="7581646">tcol</span><span class="op" id="7581650">)</span>&nbsp;<span class="op" id="7581652">!=</span>&nbsp;<span class="ident" id="7581655">fmt</span><span class="op" id="7581658">.</span><span class="ident" id="7581659">Sprintf</span><span class="op" id="7581666">(</span><span class="string" id="7581667">&#34;%v&#34;</span><span class="op" id="7581671">,</span>&nbsp;<span class="ident" id="7581673">args</span><span class="op" id="7581677">[</span><span class="ident" id="7581678">widx</span><span class="op" id="7581682">]</span><span class="op" id="7581683">)</span>&nbsp;<span class="op" id="7581685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7581691">continue</span>&nbsp;<span class="ident" id="7581700">rows</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7581708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7581712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7581716">mrow</span>&nbsp;<span class="op" id="7581721">:=</span>&nbsp;<span class="op" id="7581724">&amp;</span><span class="ident" id="7581725">row</span><span class="op" id="7581728">{</span><span class="ident" id="7581729">cols</span><span class="op" id="7581733">:</span>&nbsp;<span class="builtinfunc" id="7581735">make</span><span class="op" id="7581739">(</span><span class="op" id="7581740">[</span><span class="op" id="7581741">]</span><span class="keyword" id="7581742">interface</span><span class="op" id="7581751">{</span><span class="op" id="7581752">}</span><span class="op" id="7581753">,</span>&nbsp;<span class="builtinfunc" id="7581755">len</span><span class="op" id="7581758">(</span><span class="ident" id="7581759">s</span><span class="op" id="7581760">.</span><span class="ident" id="7581761">colName</span><span class="op" id="7581768">)</span><span class="op" id="7581769">)</span><span class="op" id="7581770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7581774">for</span>&nbsp;<span class="ident" id="7581778">seli</span><span class="op" id="7581782">,</span>&nbsp;<span class="ident" id="7581784">name</span>&nbsp;<span class="op" id="7581789">:=</span>&nbsp;<span class="keyword" id="7581792">range</span>&nbsp;<span class="ident" id="7581798">s</span><span class="op" id="7581799">.</span><span class="ident" id="7581800">colName</span>&nbsp;<span class="op" id="7581808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7581813">mrow</span><span class="op" id="7581817">.</span><span class="ident" id="7581818">cols</span><span class="op" id="7581822">[</span><span class="ident" id="7581823">seli</span><span class="op" id="7581827">]</span>&nbsp;<span class="op" id="7581829">=</span>&nbsp;<span class="ident" id="7581831">trow</span><span class="op" id="7581835">.</span><span class="ident" id="7581836">cols</span><span class="op" id="7581840">[</span><span class="ident" id="7581841">colIdx</span><span class="op" id="7581847">[</span><span class="ident" id="7581848">name</span><span class="op" id="7581852">]</span><span class="op" id="7581853">]</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7581857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7581861">mrows</span>&nbsp;<span class="op" id="7581867">=</span>&nbsp;<span class="builtinfunc" id="7581869">append</span><span class="op" id="7581875">(</span><span class="ident" id="7581876">mrows</span><span class="op" id="7581881">,</span>&nbsp;<span class="ident" id="7581883">mrow</span><span class="op" id="7581887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7581890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7581894">cursor</span>&nbsp;<span class="op" id="7581901">:=</span>&nbsp;<span class="op" id="7581904">&amp;</span><span class="ident" id="7581905">rowsCursor</span><span class="op" id="7581915">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7581919">pos</span><span class="op" id="7581922">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7581927">-</span><span class="num" id="7581928">1</span><span class="op" id="7581929">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7581933">rows</span><span class="op" id="7581937">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7581941">mrows</span><span class="op" id="7581946">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7581950">cols</span><span class="op" id="7581954">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7581958">s</span><span class="op" id="7581959">.</span><span class="ident" id="7581960">colName</span><span class="op" id="7581967">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7581971">errPos</span><span class="op" id="7581977">:</span>&nbsp;<span class="op" id="7581979">-</span><span class="num" id="7581980">1</span><span class="op" id="7581981">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7581984">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7581987">return</span>&nbsp;<span class="ident" id="7581994">cursor</span><span class="op" id="7582000">,</span>&nbsp;<span class="ident" id="7582002">nil</span><br>
<span class="lineno"></span><span class="op" id="7582006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7582009">func</span>&nbsp;<span class="op" id="7582014">(</span><span class="ident" id="7582015">s</span>&nbsp;<span class="op" id="7582017">*</span><span class="ident" id="7582018">fakeStmt</span><span class="op" id="7582026">)</span>&nbsp;<span class="ident" id="7582028">NumInput</span><span class="op" id="7582036">(</span><span class="op" id="7582037">)</span>&nbsp;<span class="builtintype" id="7582039">int</span>&nbsp;<span class="op" id="7582043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7582046">return</span>&nbsp;<span class="ident" id="7582053">s</span><span class="op" id="7582054">.</span><span class="ident" id="7582055">placeholders</span><br>
<span class="lineno">695</span><span class="op" id="7582068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7582071">func</span>&nbsp;<span class="op" id="7582076">(</span><span class="ident" id="7582077">tx</span>&nbsp;<span class="op" id="7582080">*</span><span class="ident" id="7582081">fakeTx</span><span class="op" id="7582087">)</span>&nbsp;<span class="ident" id="7582089">Commit</span><span class="op" id="7582095">(</span><span class="op" id="7582096">)</span>&nbsp;<span class="builtintype" id="7582098">error</span>&nbsp;<span class="op" id="7582104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7582107">tx</span><span class="op" id="7582109">.</span><span class="ident" id="7582110">c</span><span class="op" id="7582111">.</span><span class="ident" id="7582112">currTx</span>&nbsp;<span class="op" id="7582119">=</span>&nbsp;<span class="ident" id="7582121">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7582126">return</span>&nbsp;<span class="ident" id="7582133">nil</span><br>
<span class="lineno">700</span><span class="op" id="7582137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7582140">func</span>&nbsp;<span class="op" id="7582145">(</span><span class="ident" id="7582146">tx</span>&nbsp;<span class="op" id="7582149">*</span><span class="ident" id="7582150">fakeTx</span><span class="op" id="7582156">)</span>&nbsp;<span class="ident" id="7582158">Rollback</span><span class="op" id="7582166">(</span><span class="op" id="7582167">)</span>&nbsp;<span class="builtintype" id="7582169">error</span>&nbsp;<span class="op" id="7582175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7582178">tx</span><span class="op" id="7582180">.</span><span class="ident" id="7582181">c</span><span class="op" id="7582182">.</span><span class="ident" id="7582183">currTx</span>&nbsp;<span class="op" id="7582190">=</span>&nbsp;<span class="ident" id="7582192">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7582197">return</span>&nbsp;<span class="ident" id="7582204">nil</span><br>
<span class="lineno">705</span><span class="op" id="7582208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7582211">type</span>&nbsp;<span class="ident" id="7582216">rowsCursor</span>&nbsp;<span class="keyword" id="7582227">struct</span>&nbsp;<span class="op" id="7582234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7582237">cols</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7582244">[</span><span class="op" id="7582245">]</span><span class="builtintype" id="7582246">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7582254">pos</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7582261">int</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7582266">rows</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7582273">[</span><span class="op" id="7582274">]</span><span class="op" id="7582275">*</span><span class="ident" id="7582276">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7582281">closed</span>&nbsp;<span class="builtintype" id="7582288">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7582295">//&nbsp;errPos&nbsp;and&nbsp;err&nbsp;are&nbsp;for&nbsp;making&nbsp;Next&nbsp;return&nbsp;early&nbsp;with&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7582359">errPos</span>&nbsp;<span class="builtintype" id="7582366">int</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7582371">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7582378">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7582386">//&nbsp;a&nbsp;clone&nbsp;of&nbsp;slices&nbsp;to&nbsp;give&nbsp;out&nbsp;to&nbsp;clients,&nbsp;indexed&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7582447">//&nbsp;the&nbsp;original&nbsp;slice&#39;s&nbsp;first&nbsp;byte&nbsp;address.&nbsp;&nbsp;we&nbsp;clone&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7582507">//&nbsp;just&nbsp;so&nbsp;we&#39;re&nbsp;able&nbsp;to&nbsp;corrupt&nbsp;them&nbsp;on&nbsp;close.</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7582556">bytesClone</span>&nbsp;<span class="keyword" id="7582567">map</span><span class="op" id="7582570">[</span><span class="op" id="7582571">*</span><span class="builtintype" id="7582572">byte</span><span class="op" id="7582576">]</span><span class="op" id="7582577">[</span><span class="op" id="7582578">]</span><span class="builtintype" id="7582579">byte</span><br>
<span class="lineno"></span><span class="op" id="7582584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7582587">func</span>&nbsp;<span class="op" id="7582592">(</span><span class="ident" id="7582593">rc</span>&nbsp;<span class="op" id="7582596">*</span><span class="ident" id="7582597">rowsCursor</span><span class="op" id="7582607">)</span>&nbsp;<span class="ident" id="7582609">Close</span><span class="op" id="7582614">(</span><span class="op" id="7582615">)</span>&nbsp;<span class="builtintype" id="7582617">error</span>&nbsp;<span class="op" id="7582623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7582626">if</span>&nbsp;<span class="op" id="7582629">!</span><span class="ident" id="7582630">rc</span><span class="op" id="7582632">.</span><span class="ident" id="7582633">closed</span>&nbsp;<span class="op" id="7582640">{</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7582644">for</span>&nbsp;<span class="ident" id="7582648">_</span><span class="op" id="7582649">,</span>&nbsp;<span class="ident" id="7582651">bs</span>&nbsp;<span class="op" id="7582654">:=</span>&nbsp;<span class="keyword" id="7582657">range</span>&nbsp;<span class="ident" id="7582663">rc</span><span class="op" id="7582665">.</span><span class="ident" id="7582666">bytesClone</span>&nbsp;<span class="op" id="7582677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7582682">bs</span><span class="op" id="7582684">[</span><span class="num" id="7582685">0</span><span class="op" id="7582686">]</span>&nbsp;<span class="op" id="7582688">=</span>&nbsp;<span class="num" id="7582690">255</span>&nbsp;<span class="comment" id="7582694">//&nbsp;first&nbsp;byte&nbsp;corrupted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7582720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7582723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7582726">rc</span><span class="op" id="7582728">.</span><span class="ident" id="7582729">closed</span>&nbsp;<span class="op" id="7582736">=</span>&nbsp;<span class="builtintype" id="7582738">true</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7582744">return</span>&nbsp;<span class="ident" id="7582751">nil</span><br>
<span class="lineno"></span><span class="op" id="7582755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7582758">func</span>&nbsp;<span class="op" id="7582763">(</span><span class="ident" id="7582764">rc</span>&nbsp;<span class="op" id="7582767">*</span><span class="ident" id="7582768">rowsCursor</span><span class="op" id="7582778">)</span>&nbsp;<span class="ident" id="7582780">Columns</span><span class="op" id="7582787">(</span><span class="op" id="7582788">)</span>&nbsp;<span class="op" id="7582790">[</span><span class="op" id="7582791">]</span><span class="builtintype" id="7582792">string</span>&nbsp;<span class="op" id="7582799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7582802">return</span>&nbsp;<span class="ident" id="7582809">rc</span><span class="op" id="7582811">.</span><span class="ident" id="7582812">cols</span><br>
<span class="lineno">735</span><span class="op" id="7582817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7582820">var</span>&nbsp;<span class="ident" id="7582824">rowsCursorNextHook</span>&nbsp;<span class="keyword" id="7582843">func</span><span class="op" id="7582847">(</span><span class="ident" id="7582848">dest</span>&nbsp;<span class="op" id="7582853">[</span><span class="op" id="7582854">]</span><span class="ident" id="7582855">driver</span><span class="op" id="7582861">.</span><span class="ident" id="7582862">Value</span><span class="op" id="7582867">)</span>&nbsp;<span class="builtintype" id="7582869">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7582876">func</span>&nbsp;<span class="op" id="7582881">(</span><span class="ident" id="7582882">rc</span>&nbsp;<span class="op" id="7582885">*</span><span class="ident" id="7582886">rowsCursor</span><span class="op" id="7582896">)</span>&nbsp;<span class="ident" id="7582898">Next</span><span class="op" id="7582902">(</span><span class="ident" id="7582903">dest</span>&nbsp;<span class="op" id="7582908">[</span><span class="op" id="7582909">]</span><span class="ident" id="7582910">driver</span><span class="op" id="7582916">.</span><span class="ident" id="7582917">Value</span><span class="op" id="7582922">)</span>&nbsp;<span class="builtintype" id="7582924">error</span>&nbsp;<span class="op" id="7582930">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7582933">if</span>&nbsp;<span class="ident" id="7582936">rowsCursorNextHook</span>&nbsp;<span class="op" id="7582955">!=</span>&nbsp;<span class="ident" id="7582958">nil</span>&nbsp;<span class="op" id="7582962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7582966">return</span>&nbsp;<span class="ident" id="7582973">rowsCursorNextHook</span><span class="op" id="7582991">(</span><span class="ident" id="7582992">dest</span><span class="op" id="7582996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7582999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7583003">if</span>&nbsp;<span class="ident" id="7583006">rc</span><span class="op" id="7583008">.</span><span class="ident" id="7583009">closed</span>&nbsp;<span class="op" id="7583016">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7583020">return</span>&nbsp;<span class="ident" id="7583027">errors</span><span class="op" id="7583033">.</span><span class="ident" id="7583034">New</span><span class="op" id="7583037">(</span><span class="string" id="7583038">&#34;fakedb:&nbsp;cursor&nbsp;is&nbsp;closed&#34;</span><span class="op" id="7583064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7583067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7583070">rc</span><span class="op" id="7583072">.</span><span class="ident" id="7583073">pos</span><span class="op" id="7583076">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7583080">if</span>&nbsp;<span class="ident" id="7583083">rc</span><span class="op" id="7583085">.</span><span class="ident" id="7583086">pos</span>&nbsp;<span class="op" id="7583090">==</span>&nbsp;<span class="ident" id="7583093">rc</span><span class="op" id="7583095">.</span><span class="ident" id="7583096">errPos</span>&nbsp;<span class="op" id="7583103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7583107">return</span>&nbsp;<span class="ident" id="7583114">rc</span><span class="op" id="7583116">.</span><span class="ident" id="7583117">err</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7583122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7583125">if</span>&nbsp;<span class="ident" id="7583128">rc</span><span class="op" id="7583130">.</span><span class="ident" id="7583131">pos</span>&nbsp;<span class="op" id="7583135">&gt;=</span>&nbsp;<span class="builtinfunc" id="7583138">len</span><span class="op" id="7583141">(</span><span class="ident" id="7583142">rc</span><span class="op" id="7583144">.</span><span class="ident" id="7583145">rows</span><span class="op" id="7583149">)</span>&nbsp;<span class="op" id="7583151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7583155">return</span>&nbsp;<span class="ident" id="7583162">io</span><span class="op" id="7583164">.</span><span class="ident" id="7583165">EOF</span>&nbsp;<span class="comment" id="7583169">//&nbsp;per&nbsp;interface&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7583192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7583195">for</span>&nbsp;<span class="ident" id="7583199">i</span><span class="op" id="7583200">,</span>&nbsp;<span class="ident" id="7583202">v</span>&nbsp;<span class="op" id="7583204">:=</span>&nbsp;<span class="keyword" id="7583207">range</span>&nbsp;<span class="ident" id="7583213">rc</span><span class="op" id="7583215">.</span><span class="ident" id="7583216">rows</span><span class="op" id="7583220">[</span><span class="ident" id="7583221">rc</span><span class="op" id="7583223">.</span><span class="ident" id="7583224">pos</span><span class="op" id="7583227">]</span><span class="op" id="7583228">.</span><span class="ident" id="7583229">cols</span>&nbsp;<span class="op" id="7583234">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7583238">//&nbsp;TODO(bradfitz):&nbsp;convert&nbsp;to&nbsp;subset&nbsp;types?&nbsp;naah,&nbsp;I</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7583292">//&nbsp;think&nbsp;the&nbsp;subset&nbsp;types&nbsp;should&nbsp;only&nbsp;be&nbsp;input&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7583344">//&nbsp;driver,&nbsp;but&nbsp;the&nbsp;sql&nbsp;package&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7583402">//&nbsp;a&nbsp;wider&nbsp;range&nbsp;of&nbsp;types&nbsp;coming&nbsp;out&nbsp;of&nbsp;drivers.&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7583457">//&nbsp;for&nbsp;ease&nbsp;of&nbsp;drivers,&nbsp;and&nbsp;to&nbsp;prevent&nbsp;drivers&nbsp;from</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7583511">//&nbsp;messing&nbsp;up&nbsp;conversions&nbsp;or&nbsp;doing&nbsp;them&nbsp;differently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7583566">dest</span><span class="op" id="7583570">[</span><span class="ident" id="7583571">i</span><span class="op" id="7583572">]</span>&nbsp;<span class="op" id="7583574">=</span>&nbsp;<span class="ident" id="7583576">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7583581">if</span>&nbsp;<span class="ident" id="7583584">bs</span><span class="op" id="7583586">,</span>&nbsp;<span class="ident" id="7583588">ok</span>&nbsp;<span class="op" id="7583591">:=</span>&nbsp;<span class="ident" id="7583594">v</span><span class="op" id="7583595">.</span><span class="op" id="7583596">(</span><span class="op" id="7583597">[</span><span class="op" id="7583598">]</span><span class="builtintype" id="7583599">byte</span><span class="op" id="7583603">)</span><span class="op" id="7583604">;</span>&nbsp;<span class="ident" id="7583606">ok</span>&nbsp;<span class="op" id="7583609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7583614">if</span>&nbsp;<span class="ident" id="7583617">rc</span><span class="op" id="7583619">.</span><span class="ident" id="7583620">bytesClone</span>&nbsp;<span class="op" id="7583631">==</span>&nbsp;<span class="ident" id="7583634">nil</span>&nbsp;<span class="op" id="7583638">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7583644">rc</span><span class="op" id="7583646">.</span><span class="ident" id="7583647">bytesClone</span>&nbsp;<span class="op" id="7583658">=</span>&nbsp;<span class="builtinfunc" id="7583660">make</span><span class="op" id="7583664">(</span><span class="keyword" id="7583665">map</span><span class="op" id="7583668">[</span><span class="op" id="7583669">*</span><span class="builtintype" id="7583670">byte</span><span class="op" id="7583674">]</span><span class="op" id="7583675">[</span><span class="op" id="7583676">]</span><span class="builtintype" id="7583677">byte</span><span class="op" id="7583681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7583686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7583691">clone</span><span class="op" id="7583696">,</span>&nbsp;<span class="ident" id="7583698">ok</span>&nbsp;<span class="op" id="7583701">:=</span>&nbsp;<span class="ident" id="7583704">rc</span><span class="op" id="7583706">.</span><span class="ident" id="7583707">bytesClone</span><span class="op" id="7583717">[</span><span class="op" id="7583718">&amp;</span><span class="ident" id="7583719">bs</span><span class="op" id="7583721">[</span><span class="num" id="7583722">0</span><span class="op" id="7583723">]</span><span class="op" id="7583724">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7583729">if</span>&nbsp;<span class="op" id="7583732">!</span><span class="ident" id="7583733">ok</span>&nbsp;<span class="op" id="7583736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7583742">clone</span>&nbsp;<span class="op" id="7583748">=</span>&nbsp;<span class="builtinfunc" id="7583750">make</span><span class="op" id="7583754">(</span><span class="op" id="7583755">[</span><span class="op" id="7583756">]</span><span class="builtintype" id="7583757">byte</span><span class="op" id="7583761">,</span>&nbsp;<span class="builtinfunc" id="7583763">len</span><span class="op" id="7583766">(</span><span class="ident" id="7583767">bs</span><span class="op" id="7583769">)</span><span class="op" id="7583770">)</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7583776">copy</span><span class="op" id="7583780">(</span><span class="ident" id="7583781">clone</span><span class="op" id="7583786">,</span>&nbsp;<span class="ident" id="7583788">bs</span><span class="op" id="7583790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7583796">rc</span><span class="op" id="7583798">.</span><span class="ident" id="7583799">bytesClone</span><span class="op" id="7583809">[</span><span class="op" id="7583810">&amp;</span><span class="ident" id="7583811">bs</span><span class="op" id="7583813">[</span><span class="num" id="7583814">0</span><span class="op" id="7583815">]</span><span class="op" id="7583816">]</span>&nbsp;<span class="op" id="7583818">=</span>&nbsp;<span class="ident" id="7583820">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7583829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7583834">dest</span><span class="op" id="7583838">[</span><span class="ident" id="7583839">i</span><span class="op" id="7583840">]</span>&nbsp;<span class="op" id="7583842">=</span>&nbsp;<span class="ident" id="7583844">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7583852">}</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7583855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7583858">return</span>&nbsp;<span class="ident" id="7583865">nil</span><br>
<span class="lineno"></span><span class="op" id="7583869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7583872">//&nbsp;fakeDriverString&nbsp;is&nbsp;like&nbsp;driver.String,&nbsp;but&nbsp;indirects&nbsp;pointers&nbsp;like</span><br>
<span class="lineno">780</span><span class="comment" id="7583943">//&nbsp;DefaultValueConverter.</span><br>
<span class="lineno"></span><span class="comment" id="7583969">//</span><br>
<span class="lineno"></span><span class="comment" id="7583972">//&nbsp;This&nbsp;could&nbsp;be&nbsp;surprising&nbsp;behavior&nbsp;to&nbsp;retroactively&nbsp;apply&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="7584035">//&nbsp;driver.String&nbsp;now&nbsp;that&nbsp;Go1&nbsp;is&nbsp;out,&nbsp;but&nbsp;this&nbsp;is&nbsp;convenient&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="7584100">//&nbsp;our&nbsp;TestPointerParamsAndScans.</span><br>
<span class="lineno">785</span><span class="comment" id="7584134">//</span><br>
<span class="lineno"></span><span class="keyword" id="7584137">type</span>&nbsp;<span class="ident" id="7584142">fakeDriverString</span>&nbsp;<span class="keyword" id="7584159">struct</span><span class="op" id="7584165">{</span><span class="op" id="7584166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7584169">func</span>&nbsp;<span class="op" id="7584174">(</span><span class="ident" id="7584175">fakeDriverString</span><span class="op" id="7584191">)</span>&nbsp;<span class="ident" id="7584193">ConvertValue</span><span class="op" id="7584205">(</span><span class="ident" id="7584206">v</span>&nbsp;<span class="keyword" id="7584208">interface</span><span class="op" id="7584217">{</span><span class="op" id="7584218">}</span><span class="op" id="7584219">)</span>&nbsp;<span class="op" id="7584221">(</span><span class="ident" id="7584222">driver</span><span class="op" id="7584228">.</span><span class="ident" id="7584229">Value</span><span class="op" id="7584234">,</span>&nbsp;<span class="builtintype" id="7584236">error</span><span class="op" id="7584241">)</span>&nbsp;<span class="op" id="7584243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584246">switch</span>&nbsp;<span class="ident" id="7584253">c</span>&nbsp;<span class="op" id="7584255">:=</span>&nbsp;<span class="ident" id="7584258">v</span><span class="op" id="7584259">.</span><span class="op" id="7584260">(</span><span class="keyword" id="7584261">type</span><span class="op" id="7584265">)</span>&nbsp;<span class="op" id="7584267">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584270">case</span>&nbsp;<span class="builtintype" id="7584275">string</span><span class="op" id="7584281">,</span>&nbsp;<span class="op" id="7584283">[</span><span class="op" id="7584284">]</span><span class="builtintype" id="7584285">byte</span><span class="op" id="7584289">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584293">return</span>&nbsp;<span class="ident" id="7584300">v</span><span class="op" id="7584301">,</span>&nbsp;<span class="ident" id="7584303">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584308">case</span>&nbsp;<span class="op" id="7584313">*</span><span class="builtintype" id="7584314">string</span><span class="op" id="7584320">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584324">if</span>&nbsp;<span class="ident" id="7584327">c</span>&nbsp;<span class="op" id="7584329">==</span>&nbsp;<span class="ident" id="7584332">nil</span>&nbsp;<span class="op" id="7584336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584341">return</span>&nbsp;<span class="ident" id="7584348">nil</span><span class="op" id="7584351">,</span>&nbsp;<span class="ident" id="7584353">nil</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7584359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584363">return</span>&nbsp;<span class="op" id="7584370">*</span><span class="ident" id="7584371">c</span><span class="op" id="7584372">,</span>&nbsp;<span class="ident" id="7584374">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7584379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584382">return</span>&nbsp;<span class="ident" id="7584389">fmt</span><span class="op" id="7584392">.</span><span class="ident" id="7584393">Sprintf</span><span class="op" id="7584400">(</span><span class="string" id="7584401">&#34;%v&#34;</span><span class="op" id="7584405">,</span>&nbsp;<span class="ident" id="7584407">v</span><span class="op" id="7584408">)</span><span class="op" id="7584409">,</span>&nbsp;<span class="ident" id="7584411">nil</span><br>
<span class="lineno"></span><span class="op" id="7584415">}</span><br>
<span class="lineno">800</span><br>
<span class="lineno"></span><span class="keyword" id="7584418">func</span>&nbsp;<span class="ident" id="7584423">converterForType</span><span class="op" id="7584439">(</span><span class="ident" id="7584440">typ</span>&nbsp;<span class="builtintype" id="7584444">string</span><span class="op" id="7584450">)</span>&nbsp;<span class="ident" id="7584452">driver</span><span class="op" id="7584458">.</span><span class="ident" id="7584459">ValueConverter</span>&nbsp;<span class="op" id="7584474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584477">switch</span>&nbsp;<span class="ident" id="7584484">typ</span>&nbsp;<span class="op" id="7584488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584491">case</span>&nbsp;<span class="string" id="7584496">&#34;bool&#34;</span><span class="op" id="7584502">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584506">return</span>&nbsp;<span class="ident" id="7584513">driver</span><span class="op" id="7584519">.</span><span class="ident" id="7584520">Bool</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584526">case</span>&nbsp;<span class="string" id="7584531">&#34;nullbool&#34;</span><span class="op" id="7584541">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584545">return</span>&nbsp;<span class="ident" id="7584552">driver</span><span class="op" id="7584558">.</span><span class="ident" id="7584559">Null</span><span class="op" id="7584563">{</span><span class="ident" id="7584564">Converter</span><span class="op" id="7584573">:</span>&nbsp;<span class="ident" id="7584575">driver</span><span class="op" id="7584581">.</span><span class="ident" id="7584582">Bool</span><span class="op" id="7584586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584589">case</span>&nbsp;<span class="string" id="7584594">&#34;int32&#34;</span><span class="op" id="7584601">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584605">return</span>&nbsp;<span class="ident" id="7584612">driver</span><span class="op" id="7584618">.</span><span class="ident" id="7584619">Int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584626">case</span>&nbsp;<span class="string" id="7584631">&#34;string&#34;</span><span class="op" id="7584639">:</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584643">return</span>&nbsp;<span class="ident" id="7584650">driver</span><span class="op" id="7584656">.</span><span class="ident" id="7584657">NotNull</span><span class="op" id="7584664">{</span><span class="ident" id="7584665">Converter</span><span class="op" id="7584674">:</span>&nbsp;<span class="ident" id="7584676">fakeDriverString</span><span class="op" id="7584692">{</span><span class="op" id="7584693">}</span><span class="op" id="7584694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584697">case</span>&nbsp;<span class="string" id="7584702">&#34;nullstring&#34;</span><span class="op" id="7584714">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584718">return</span>&nbsp;<span class="ident" id="7584725">driver</span><span class="op" id="7584731">.</span><span class="ident" id="7584732">Null</span><span class="op" id="7584736">{</span><span class="ident" id="7584737">Converter</span><span class="op" id="7584746">:</span>&nbsp;<span class="ident" id="7584748">fakeDriverString</span><span class="op" id="7584764">{</span><span class="op" id="7584765">}</span><span class="op" id="7584766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584769">case</span>&nbsp;<span class="string" id="7584774">&#34;int64&#34;</span><span class="op" id="7584781">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7584785">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584837">return</span>&nbsp;<span class="ident" id="7584844">driver</span><span class="op" id="7584850">.</span><span class="ident" id="7584851">NotNull</span><span class="op" id="7584858">{</span><span class="ident" id="7584859">Converter</span><span class="op" id="7584868">:</span>&nbsp;<span class="ident" id="7584870">driver</span><span class="op" id="7584876">.</span><span class="ident" id="7584877">DefaultParameterConverter</span><span class="op" id="7584902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584905">case</span>&nbsp;<span class="string" id="7584910">&#34;nullint64&#34;</span><span class="op" id="7584921">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7584925">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7584977">return</span>&nbsp;<span class="ident" id="7584984">driver</span><span class="op" id="7584990">.</span><span class="ident" id="7584991">Null</span><span class="op" id="7584995">{</span><span class="ident" id="7584996">Converter</span><span class="op" id="7585005">:</span>&nbsp;<span class="ident" id="7585007">driver</span><span class="op" id="7585013">.</span><span class="ident" id="7585014">DefaultParameterConverter</span><span class="op" id="7585039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7585042">case</span>&nbsp;<span class="string" id="7585047">&#34;float64&#34;</span><span class="op" id="7585056">:</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7585060">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7585112">return</span>&nbsp;<span class="ident" id="7585119">driver</span><span class="op" id="7585125">.</span><span class="ident" id="7585126">NotNull</span><span class="op" id="7585133">{</span><span class="ident" id="7585134">Converter</span><span class="op" id="7585143">:</span>&nbsp;<span class="ident" id="7585145">driver</span><span class="op" id="7585151">.</span><span class="ident" id="7585152">DefaultParameterConverter</span><span class="op" id="7585177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7585180">case</span>&nbsp;<span class="string" id="7585185">&#34;nullfloat64&#34;</span><span class="op" id="7585198">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7585202">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7585254">return</span>&nbsp;<span class="ident" id="7585261">driver</span><span class="op" id="7585267">.</span><span class="ident" id="7585268">Null</span><span class="op" id="7585272">{</span><span class="ident" id="7585273">Converter</span><span class="op" id="7585282">:</span>&nbsp;<span class="ident" id="7585284">driver</span><span class="op" id="7585290">.</span><span class="ident" id="7585291">DefaultParameterConverter</span><span class="op" id="7585316">}</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7585319">case</span>&nbsp;<span class="string" id="7585324">&#34;datetime&#34;</span><span class="op" id="7585334">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7585338">return</span>&nbsp;<span class="ident" id="7585345">driver</span><span class="op" id="7585351">.</span><span class="ident" id="7585352">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7585379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7585382">panic</span><span class="op" id="7585387">(</span><span class="string" id="7585388">&#34;invalid&nbsp;fakedb&nbsp;column&nbsp;type&nbsp;of&nbsp;&#34;</span>&nbsp;<span class="op" id="7585421">+</span>&nbsp;<span class="ident" id="7585423">typ</span><span class="op" id="7585426">)</span><br>
<span class="lineno"></span><span class="op" id="7585428">}</span>
</div>
</body>
</html>
