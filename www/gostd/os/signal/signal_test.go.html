<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>os/signal</h2>
<ul>
<li><a href="/gostd/os/signal/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/os/signal/signal.go.html">signal.go</a></li>
<li><a href="/gostd/os/signal/signal_test.go.html" class="current">signal_test.go</a></li>
<li><a href="/gostd/os/signal/signal_unix.go.html">signal_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8037231">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8037286">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8037340">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8037391">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8037456">package</span>&nbsp;<span class="ident" id="8037464">signal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8037472">import</span>&nbsp;<span class="op" id="8037479">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8037482">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8037490">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8037503">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8037509">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8037520">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8037531">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8037542">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8037553">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8037564">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8037571">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="8037574">func</span>&nbsp;<span class="ident" id="8037579">waitSig</span><span class="op" id="8037586">(</span><span class="ident" id="8037587">t</span>&nbsp;<span class="op" id="8037589">*</span><span class="ident" id="8037590">testing</span><span class="op" id="8037597">.</span><span class="ident" id="8037598">T</span><span class="op" id="8037599">,</span>&nbsp;<span class="ident" id="8037601">c</span>&nbsp;<span class="op" id="8037603">&lt;-</span><span class="keyword" id="8037605">chan</span>&nbsp;<span class="ident" id="8037610">os</span><span class="op" id="8037612">.</span><span class="ident" id="8037613">Signal</span><span class="op" id="8037619">,</span>&nbsp;<span class="ident" id="8037621">sig</span>&nbsp;<span class="ident" id="8037625">os</span><span class="op" id="8037627">.</span><span class="ident" id="8037628">Signal</span><span class="op" id="8037634">)</span>&nbsp;<span class="op" id="8037636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8037639">select</span>&nbsp;<span class="op" id="8037646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8037649">case</span>&nbsp;<span class="ident" id="8037654">s</span>&nbsp;<span class="op" id="8037656">:=</span>&nbsp;<span class="op" id="8037659">&lt;-</span><span class="ident" id="8037661">c</span><span class="op" id="8037662">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8037666">if</span>&nbsp;<span class="ident" id="8037669">s</span>&nbsp;<span class="op" id="8037671">!=</span>&nbsp;<span class="ident" id="8037674">sig</span>&nbsp;<span class="op" id="8037678">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037683">t</span><span class="op" id="8037684">.</span><span class="ident" id="8037685">Fatalf</span><span class="op" id="8037691">(</span><span class="string" id="8037692">&#34;signal&nbsp;was&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8037716">,</span>&nbsp;<span class="ident" id="8037718">s</span><span class="op" id="8037719">,</span>&nbsp;<span class="ident" id="8037721">sig</span><span class="op" id="8037724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8037728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8037731">case</span>&nbsp;<span class="op" id="8037736">&lt;-</span><span class="ident" id="8037738">time</span><span class="op" id="8037742">.</span><span class="ident" id="8037743">After</span><span class="op" id="8037748">(</span><span class="num" id="8037749">1</span>&nbsp;<span class="op" id="8037751">*</span>&nbsp;<span class="ident" id="8037753">time</span><span class="op" id="8037757">.</span><span class="ident" id="8037758">Second</span><span class="op" id="8037764">)</span><span class="op" id="8037765">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037769">t</span><span class="op" id="8037770">.</span><span class="ident" id="8037771">Fatalf</span><span class="op" id="8037777">(</span><span class="string" id="8037778">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;%v&#34;</span><span class="op" id="8037802">,</span>&nbsp;<span class="ident" id="8037804">sig</span><span class="op" id="8037807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8037810">}</span><br>
<span class="lineno">30</span><span class="op" id="8037812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8037815">//&nbsp;Test&nbsp;that&nbsp;basic&nbsp;signal&nbsp;handling&nbsp;works.</span><br>
<span class="lineno"></span><span class="keyword" id="8037857">func</span>&nbsp;<span class="ident" id="8037862">TestSignal</span><span class="op" id="8037872">(</span><span class="ident" id="8037873">t</span>&nbsp;<span class="op" id="8037875">*</span><span class="ident" id="8037876">testing</span><span class="op" id="8037883">.</span><span class="ident" id="8037884">T</span><span class="op" id="8037885">)</span>&nbsp;<span class="op" id="8037887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8037890">//&nbsp;Ask&nbsp;for&nbsp;SIGHUP</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037909">c</span>&nbsp;<span class="op" id="8037911">:=</span>&nbsp;<span class="builtinfunc" id="8037914">make</span><span class="op" id="8037918">(</span><span class="keyword" id="8037919">chan</span>&nbsp;<span class="ident" id="8037924">os</span><span class="op" id="8037926">.</span><span class="ident" id="8037927">Signal</span><span class="op" id="8037933">,</span>&nbsp;<span class="num" id="8037935">1</span><span class="op" id="8037936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037939">Notify</span><span class="op" id="8037945">(</span><span class="ident" id="8037946">c</span><span class="op" id="8037947">,</span>&nbsp;<span class="ident" id="8037949">syscall</span><span class="op" id="8037956">.</span><span class="ident" id="8037957">SIGHUP</span><span class="op" id="8037963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8037966">defer</span>&nbsp;<span class="ident" id="8037972">Stop</span><span class="op" id="8037976">(</span><span class="ident" id="8037977">c</span><span class="op" id="8037978">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8037982">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGHUP</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038013">t</span><span class="op" id="8038014">.</span><span class="ident" id="8038015">Logf</span><span class="op" id="8038019">(</span><span class="string" id="8038020">&#34;sighup...&#34;</span><span class="op" id="8038031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038034">syscall</span><span class="op" id="8038041">.</span><span class="ident" id="8038042">Kill</span><span class="op" id="8038046">(</span><span class="ident" id="8038047">syscall</span><span class="op" id="8038054">.</span><span class="ident" id="8038055">Getpid</span><span class="op" id="8038061">(</span><span class="op" id="8038062">)</span><span class="op" id="8038063">,</span>&nbsp;<span class="ident" id="8038065">syscall</span><span class="op" id="8038072">.</span><span class="ident" id="8038073">SIGHUP</span><span class="op" id="8038079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038082">waitSig</span><span class="op" id="8038089">(</span><span class="ident" id="8038090">t</span><span class="op" id="8038091">,</span>&nbsp;<span class="ident" id="8038093">c</span><span class="op" id="8038094">,</span>&nbsp;<span class="ident" id="8038096">syscall</span><span class="op" id="8038103">.</span><span class="ident" id="8038104">SIGHUP</span><span class="op" id="8038110">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8038114">//&nbsp;Ask&nbsp;for&nbsp;everything&nbsp;we&nbsp;can&nbsp;get.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038149">c1</span>&nbsp;<span class="op" id="8038152">:=</span>&nbsp;<span class="builtinfunc" id="8038155">make</span><span class="op" id="8038159">(</span><span class="keyword" id="8038160">chan</span>&nbsp;<span class="ident" id="8038165">os</span><span class="op" id="8038167">.</span><span class="ident" id="8038168">Signal</span><span class="op" id="8038174">,</span>&nbsp;<span class="num" id="8038176">1</span><span class="op" id="8038177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038180">Notify</span><span class="op" id="8038186">(</span><span class="ident" id="8038187">c1</span><span class="op" id="8038189">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8038193">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGWINCH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038226">t</span><span class="op" id="8038227">.</span><span class="ident" id="8038228">Logf</span><span class="op" id="8038232">(</span><span class="string" id="8038233">&#34;sigwinch...&#34;</span><span class="op" id="8038246">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038249">syscall</span><span class="op" id="8038256">.</span><span class="ident" id="8038257">Kill</span><span class="op" id="8038261">(</span><span class="ident" id="8038262">syscall</span><span class="op" id="8038269">.</span><span class="ident" id="8038270">Getpid</span><span class="op" id="8038276">(</span><span class="op" id="8038277">)</span><span class="op" id="8038278">,</span>&nbsp;<span class="ident" id="8038280">syscall</span><span class="op" id="8038287">.</span><span class="ident" id="8038288">SIGWINCH</span><span class="op" id="8038296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038299">waitSig</span><span class="op" id="8038306">(</span><span class="ident" id="8038307">t</span><span class="op" id="8038308">,</span>&nbsp;<span class="ident" id="8038310">c1</span><span class="op" id="8038312">,</span>&nbsp;<span class="ident" id="8038314">syscall</span><span class="op" id="8038321">.</span><span class="ident" id="8038322">SIGWINCH</span><span class="op" id="8038330">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8038334">//&nbsp;Send&nbsp;two&nbsp;more&nbsp;SIGHUPs,&nbsp;to&nbsp;make&nbsp;sure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8038379">//&nbsp;they&nbsp;get&nbsp;delivered&nbsp;on&nbsp;c1&nbsp;and&nbsp;that&nbsp;not&nbsp;reading</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8038429">//&nbsp;from&nbsp;c&nbsp;does&nbsp;not&nbsp;block&nbsp;everything.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038467">t</span><span class="op" id="8038468">.</span><span class="ident" id="8038469">Logf</span><span class="op" id="8038473">(</span><span class="string" id="8038474">&#34;sighup...&#34;</span><span class="op" id="8038485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038488">syscall</span><span class="op" id="8038495">.</span><span class="ident" id="8038496">Kill</span><span class="op" id="8038500">(</span><span class="ident" id="8038501">syscall</span><span class="op" id="8038508">.</span><span class="ident" id="8038509">Getpid</span><span class="op" id="8038515">(</span><span class="op" id="8038516">)</span><span class="op" id="8038517">,</span>&nbsp;<span class="ident" id="8038519">syscall</span><span class="op" id="8038526">.</span><span class="ident" id="8038527">SIGHUP</span><span class="op" id="8038533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038536">waitSig</span><span class="op" id="8038543">(</span><span class="ident" id="8038544">t</span><span class="op" id="8038545">,</span>&nbsp;<span class="ident" id="8038547">c1</span><span class="op" id="8038549">,</span>&nbsp;<span class="ident" id="8038551">syscall</span><span class="op" id="8038558">.</span><span class="ident" id="8038559">SIGHUP</span><span class="op" id="8038565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038568">t</span><span class="op" id="8038569">.</span><span class="ident" id="8038570">Logf</span><span class="op" id="8038574">(</span><span class="string" id="8038575">&#34;sighup...&#34;</span><span class="op" id="8038586">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038589">syscall</span><span class="op" id="8038596">.</span><span class="ident" id="8038597">Kill</span><span class="op" id="8038601">(</span><span class="ident" id="8038602">syscall</span><span class="op" id="8038609">.</span><span class="ident" id="8038610">Getpid</span><span class="op" id="8038616">(</span><span class="op" id="8038617">)</span><span class="op" id="8038618">,</span>&nbsp;<span class="ident" id="8038620">syscall</span><span class="op" id="8038627">.</span><span class="ident" id="8038628">SIGHUP</span><span class="op" id="8038634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038637">waitSig</span><span class="op" id="8038644">(</span><span class="ident" id="8038645">t</span><span class="op" id="8038646">,</span>&nbsp;<span class="ident" id="8038648">c1</span><span class="op" id="8038650">,</span>&nbsp;<span class="ident" id="8038652">syscall</span><span class="op" id="8038659">.</span><span class="ident" id="8038660">SIGHUP</span><span class="op" id="8038666">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8038670">//&nbsp;The&nbsp;first&nbsp;SIGHUP&nbsp;should&nbsp;be&nbsp;waiting&nbsp;for&nbsp;us&nbsp;on&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038722">waitSig</span><span class="op" id="8038729">(</span><span class="ident" id="8038730">t</span><span class="op" id="8038731">,</span>&nbsp;<span class="ident" id="8038733">c</span><span class="op" id="8038734">,</span>&nbsp;<span class="ident" id="8038736">syscall</span><span class="op" id="8038743">.</span><span class="ident" id="8038744">SIGHUP</span><span class="op" id="8038750">)</span><br>
<span class="lineno">65</span><span class="op" id="8038752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8038755">func</span>&nbsp;<span class="ident" id="8038760">TestStress</span><span class="op" id="8038770">(</span><span class="ident" id="8038771">t</span>&nbsp;<span class="op" id="8038773">*</span><span class="ident" id="8038774">testing</span><span class="op" id="8038781">.</span><span class="ident" id="8038782">T</span><span class="op" id="8038783">)</span>&nbsp;<span class="op" id="8038785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038788">dur</span>&nbsp;<span class="op" id="8038792">:=</span>&nbsp;<span class="num" id="8038795">3</span>&nbsp;<span class="op" id="8038797">*</span>&nbsp;<span class="ident" id="8038799">time</span><span class="op" id="8038803">.</span><span class="ident" id="8038804">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8038812">if</span>&nbsp;<span class="ident" id="8038815">testing</span><span class="op" id="8038822">.</span><span class="ident" id="8038823">Short</span><span class="op" id="8038828">(</span><span class="op" id="8038829">)</span>&nbsp;<span class="op" id="8038831">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038835">dur</span>&nbsp;<span class="op" id="8038839">=</span>&nbsp;<span class="num" id="8038841">100</span>&nbsp;<span class="op" id="8038845">*</span>&nbsp;<span class="ident" id="8038847">time</span><span class="op" id="8038851">.</span><span class="ident" id="8038852">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8038865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8038868">defer</span>&nbsp;<span class="ident" id="8038874">runtime</span><span class="op" id="8038881">.</span><span class="ident" id="8038882">GOMAXPROCS</span><span class="op" id="8038892">(</span><span class="ident" id="8038893">runtime</span><span class="op" id="8038900">.</span><span class="ident" id="8038901">GOMAXPROCS</span><span class="op" id="8038911">(</span><span class="num" id="8038912">4</span><span class="op" id="8038913">)</span><span class="op" id="8038914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038917">done</span>&nbsp;<span class="op" id="8038922">:=</span>&nbsp;<span class="builtinfunc" id="8038925">make</span><span class="op" id="8038929">(</span><span class="keyword" id="8038930">chan</span>&nbsp;<span class="builtintype" id="8038935">bool</span><span class="op" id="8038939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038942">finished</span>&nbsp;<span class="op" id="8038951">:=</span>&nbsp;<span class="builtinfunc" id="8038954">make</span><span class="op" id="8038958">(</span><span class="keyword" id="8038959">chan</span>&nbsp;<span class="builtintype" id="8038964">bool</span><span class="op" id="8038968">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8038971">go</span>&nbsp;<span class="keyword" id="8038974">func</span><span class="op" id="8038978">(</span><span class="op" id="8038979">)</span>&nbsp;<span class="op" id="8038981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038985">sig</span>&nbsp;<span class="op" id="8038989">:=</span>&nbsp;<span class="builtinfunc" id="8038992">make</span><span class="op" id="8038996">(</span><span class="keyword" id="8038997">chan</span>&nbsp;<span class="ident" id="8039002">os</span><span class="op" id="8039004">.</span><span class="ident" id="8039005">Signal</span><span class="op" id="8039011">,</span>&nbsp;<span class="num" id="8039013">1</span><span class="op" id="8039014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039018">Notify</span><span class="op" id="8039024">(</span><span class="ident" id="8039025">sig</span><span class="op" id="8039028">,</span>&nbsp;<span class="ident" id="8039030">syscall</span><span class="op" id="8039037">.</span><span class="ident" id="8039038">SIGUSR1</span><span class="op" id="8039045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039049">defer</span>&nbsp;<span class="ident" id="8039055">Stop</span><span class="op" id="8039059">(</span><span class="ident" id="8039060">sig</span><span class="op" id="8039063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039066">Loop</span><span class="op" id="8039070">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039074">for</span>&nbsp;<span class="op" id="8039078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039083">select</span>&nbsp;<span class="op" id="8039090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039095">case</span>&nbsp;<span class="op" id="8039100">&lt;-</span><span class="ident" id="8039102">sig</span><span class="op" id="8039105">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039110">case</span>&nbsp;<span class="op" id="8039115">&lt;-</span><span class="ident" id="8039117">done</span><span class="op" id="8039121">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039127">break</span>&nbsp;<span class="ident" id="8039133">Loop</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039149">finished</span>&nbsp;<span class="op" id="8039158">&lt;-</span>&nbsp;<span class="builtintype" id="8039161">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039167">}</span><span class="op" id="8039168">(</span><span class="op" id="8039169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039172">go</span>&nbsp;<span class="keyword" id="8039175">func</span><span class="op" id="8039179">(</span><span class="op" id="8039180">)</span>&nbsp;<span class="op" id="8039182">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039185">Loop</span><span class="op" id="8039189">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039193">for</span>&nbsp;<span class="op" id="8039197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039202">select</span>&nbsp;<span class="op" id="8039209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039214">case</span>&nbsp;<span class="op" id="8039219">&lt;-</span><span class="ident" id="8039221">done</span><span class="op" id="8039225">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039231">break</span>&nbsp;<span class="ident" id="8039237">Loop</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039245">default</span><span class="op" id="8039252">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039258">syscall</span><span class="op" id="8039265">.</span><span class="ident" id="8039266">Kill</span><span class="op" id="8039270">(</span><span class="ident" id="8039271">syscall</span><span class="op" id="8039278">.</span><span class="ident" id="8039279">Getpid</span><span class="op" id="8039285">(</span><span class="op" id="8039286">)</span><span class="op" id="8039287">,</span>&nbsp;<span class="ident" id="8039289">syscall</span><span class="op" id="8039296">.</span><span class="ident" id="8039297">SIGUSR1</span><span class="op" id="8039304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039310">runtime</span><span class="op" id="8039317">.</span><span class="ident" id="8039318">Gosched</span><span class="op" id="8039325">(</span><span class="op" id="8039326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039335">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039339">finished</span>&nbsp;<span class="op" id="8039348">&lt;-</span>&nbsp;<span class="builtintype" id="8039351">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039357">}</span><span class="op" id="8039358">(</span><span class="op" id="8039359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039362">time</span><span class="op" id="8039366">.</span><span class="ident" id="8039367">Sleep</span><span class="op" id="8039372">(</span><span class="ident" id="8039373">dur</span><span class="op" id="8039376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8039379">close</span><span class="op" id="8039384">(</span><span class="ident" id="8039385">done</span><span class="op" id="8039389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039392">&lt;-</span><span class="ident" id="8039394">finished</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039404">&lt;-</span><span class="ident" id="8039406">finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8039416">//&nbsp;When&nbsp;run&nbsp;with&nbsp;&#39;go&nbsp;test&nbsp;-cpu=1,2,4&#39;&nbsp;SIGUSR1&nbsp;from&nbsp;this&nbsp;test&nbsp;can&nbsp;slip</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8039487">//&nbsp;into&nbsp;subsequent&nbsp;TestSignal()&nbsp;causing&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8039537">//&nbsp;Sleep&nbsp;for&nbsp;a&nbsp;while&nbsp;to&nbsp;reduce&nbsp;the&nbsp;possibility&nbsp;of&nbsp;the&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039601">time</span><span class="op" id="8039605">.</span><span class="ident" id="8039606">Sleep</span><span class="op" id="8039611">(</span><span class="num" id="8039612">10</span>&nbsp;<span class="op" id="8039615">*</span>&nbsp;<span class="ident" id="8039617">time</span><span class="op" id="8039621">.</span><span class="ident" id="8039622">Millisecond</span><span class="op" id="8039633">)</span><br>
<span class="lineno">110</span><span class="op" id="8039635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8039638">var</span>&nbsp;<span class="ident" id="8039642">sendUncaughtSighup</span>&nbsp;<span class="op" id="8039661">=</span>&nbsp;<span class="ident" id="8039663">flag</span><span class="op" id="8039667">.</span><span class="ident" id="8039668">Int</span><span class="op" id="8039671">(</span><span class="string" id="8039672">&#34;send_uncaught_sighup&#34;</span><span class="op" id="8039694">,</span>&nbsp;<span class="num" id="8039696">0</span><span class="op" id="8039697">,</span>&nbsp;<span class="string" id="8039699">&#34;send&nbsp;uncaught&nbsp;SIGHUP&nbsp;during&nbsp;TestStop&#34;</span><span class="op" id="8039737">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8039740">//&nbsp;Test&nbsp;that&nbsp;Stop&nbsp;cancels&nbsp;the&nbsp;channel&#39;s&nbsp;registrations.</span><br>
<span class="lineno">115</span><span class="keyword" id="8039795">func</span>&nbsp;<span class="ident" id="8039800">TestStop</span><span class="op" id="8039808">(</span><span class="ident" id="8039809">t</span>&nbsp;<span class="op" id="8039811">*</span><span class="ident" id="8039812">testing</span><span class="op" id="8039819">.</span><span class="ident" id="8039820">T</span><span class="op" id="8039821">)</span>&nbsp;<span class="op" id="8039823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039826">sigs</span>&nbsp;<span class="op" id="8039831">:=</span>&nbsp;<span class="op" id="8039834">[</span><span class="op" id="8039835">]</span><span class="ident" id="8039836">syscall</span><span class="op" id="8039843">.</span><span class="ident" id="8039844">Signal</span><span class="op" id="8039850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039854">syscall</span><span class="op" id="8039861">.</span><span class="ident" id="8039862">SIGWINCH</span><span class="op" id="8039870">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039874">syscall</span><span class="op" id="8039881">.</span><span class="ident" id="8039882">SIGHUP</span><span class="op" id="8039888">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039891">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039895">for</span>&nbsp;<span class="ident" id="8039899">_</span><span class="op" id="8039900">,</span>&nbsp;<span class="ident" id="8039902">sig</span>&nbsp;<span class="op" id="8039906">:=</span>&nbsp;<span class="keyword" id="8039909">range</span>&nbsp;<span class="ident" id="8039915">sigs</span>&nbsp;<span class="op" id="8039920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8039924">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8039946">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8039991">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040062">if</span>&nbsp;<span class="ident" id="8040065">sig</span>&nbsp;<span class="op" id="8040069">!=</span>&nbsp;<span class="ident" id="8040072">syscall</span><span class="op" id="8040079">.</span><span class="ident" id="8040080">SIGHUP</span>&nbsp;<span class="op" id="8040087">||</span>&nbsp;<span class="op" id="8040090">*</span><span class="ident" id="8040091">sendUncaughtSighup</span>&nbsp;<span class="op" id="8040110">==</span>&nbsp;<span class="num" id="8040113">1</span>&nbsp;<span class="op" id="8040115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040120">syscall</span><span class="op" id="8040127">.</span><span class="ident" id="8040128">Kill</span><span class="op" id="8040132">(</span><span class="ident" id="8040133">syscall</span><span class="op" id="8040140">.</span><span class="ident" id="8040141">Getpid</span><span class="op" id="8040147">(</span><span class="op" id="8040148">)</span><span class="op" id="8040149">,</span>&nbsp;<span class="ident" id="8040151">sig</span><span class="op" id="8040154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8040158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040162">time</span><span class="op" id="8040166">.</span><span class="ident" id="8040167">Sleep</span><span class="op" id="8040172">(</span><span class="num" id="8040173">100</span>&nbsp;<span class="op" id="8040177">*</span>&nbsp;<span class="ident" id="8040179">time</span><span class="op" id="8040183">.</span><span class="ident" id="8040184">Millisecond</span><span class="op" id="8040195">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8040200">//&nbsp;Ask&nbsp;for&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040220">c</span>&nbsp;<span class="op" id="8040222">:=</span>&nbsp;<span class="builtinfunc" id="8040225">make</span><span class="op" id="8040229">(</span><span class="keyword" id="8040230">chan</span>&nbsp;<span class="ident" id="8040235">os</span><span class="op" id="8040237">.</span><span class="ident" id="8040238">Signal</span><span class="op" id="8040244">,</span>&nbsp;<span class="num" id="8040246">1</span><span class="op" id="8040247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040251">Notify</span><span class="op" id="8040257">(</span><span class="ident" id="8040258">c</span><span class="op" id="8040259">,</span>&nbsp;<span class="ident" id="8040261">sig</span><span class="op" id="8040264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040268">defer</span>&nbsp;<span class="ident" id="8040274">Stop</span><span class="op" id="8040278">(</span><span class="ident" id="8040279">c</span><span class="op" id="8040280">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8040285">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;that&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040320">syscall</span><span class="op" id="8040327">.</span><span class="ident" id="8040328">Kill</span><span class="op" id="8040332">(</span><span class="ident" id="8040333">syscall</span><span class="op" id="8040340">.</span><span class="ident" id="8040341">Getpid</span><span class="op" id="8040347">(</span><span class="op" id="8040348">)</span><span class="op" id="8040349">,</span>&nbsp;<span class="ident" id="8040351">sig</span><span class="op" id="8040354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040358">waitSig</span><span class="op" id="8040365">(</span><span class="ident" id="8040366">t</span><span class="op" id="8040367">,</span>&nbsp;<span class="ident" id="8040369">c</span><span class="op" id="8040370">,</span>&nbsp;<span class="ident" id="8040372">sig</span><span class="op" id="8040375">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040380">Stop</span><span class="op" id="8040384">(</span><span class="ident" id="8040385">c</span><span class="op" id="8040386">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040390">select</span>&nbsp;<span class="op" id="8040397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040401">case</span>&nbsp;<span class="ident" id="8040406">s</span>&nbsp;<span class="op" id="8040408">:=</span>&nbsp;<span class="op" id="8040411">&lt;-</span><span class="ident" id="8040413">c</span><span class="op" id="8040414">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040419">t</span><span class="op" id="8040420">.</span><span class="ident" id="8040421">Fatalf</span><span class="op" id="8040427">(</span><span class="string" id="8040428">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="8040450">,</span>&nbsp;<span class="ident" id="8040452">s</span><span class="op" id="8040453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040457">case</span>&nbsp;<span class="op" id="8040462">&lt;-</span><span class="ident" id="8040464">time</span><span class="op" id="8040468">.</span><span class="ident" id="8040469">After</span><span class="op" id="8040474">(</span><span class="num" id="8040475">100</span>&nbsp;<span class="op" id="8040479">*</span>&nbsp;<span class="ident" id="8040481">time</span><span class="op" id="8040485">.</span><span class="ident" id="8040486">Millisecond</span><span class="op" id="8040497">)</span><span class="op" id="8040498">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8040503">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8040531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8040536">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8040558">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8040603">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040674">if</span>&nbsp;<span class="ident" id="8040677">sig</span>&nbsp;<span class="op" id="8040681">!=</span>&nbsp;<span class="ident" id="8040684">syscall</span><span class="op" id="8040691">.</span><span class="ident" id="8040692">SIGHUP</span>&nbsp;<span class="op" id="8040699">||</span>&nbsp;<span class="op" id="8040702">*</span><span class="ident" id="8040703">sendUncaughtSighup</span>&nbsp;<span class="op" id="8040722">==</span>&nbsp;<span class="num" id="8040725">2</span>&nbsp;<span class="op" id="8040727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040732">syscall</span><span class="op" id="8040739">.</span><span class="ident" id="8040740">Kill</span><span class="op" id="8040744">(</span><span class="ident" id="8040745">syscall</span><span class="op" id="8040752">.</span><span class="ident" id="8040753">Getpid</span><span class="op" id="8040759">(</span><span class="op" id="8040760">)</span><span class="op" id="8040761">,</span>&nbsp;<span class="ident" id="8040763">sig</span><span class="op" id="8040766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8040770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040775">select</span>&nbsp;<span class="op" id="8040782">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040786">case</span>&nbsp;<span class="ident" id="8040791">s</span>&nbsp;<span class="op" id="8040793">:=</span>&nbsp;<span class="op" id="8040796">&lt;-</span><span class="ident" id="8040798">c</span><span class="op" id="8040799">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040804">t</span><span class="op" id="8040805">.</span><span class="ident" id="8040806">Fatalf</span><span class="op" id="8040812">(</span><span class="string" id="8040813">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="8040835">,</span>&nbsp;<span class="ident" id="8040837">s</span><span class="op" id="8040838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040842">case</span>&nbsp;<span class="op" id="8040847">&lt;-</span><span class="ident" id="8040849">time</span><span class="op" id="8040853">.</span><span class="ident" id="8040854">After</span><span class="op" id="8040859">(</span><span class="num" id="8040860">100</span>&nbsp;<span class="op" id="8040864">*</span>&nbsp;<span class="ident" id="8040866">time</span><span class="op" id="8040870">.</span><span class="ident" id="8040871">Millisecond</span><span class="op" id="8040882">)</span><span class="op" id="8040883">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8040888">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8040916">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8040919">}</span><br>
<span class="lineno"></span><span class="op" id="8040921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8040924">//&nbsp;Test&nbsp;that&nbsp;when&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;an&nbsp;uncaught&nbsp;SIGHUP&nbsp;does&nbsp;not&nbsp;kill&nbsp;the&nbsp;program,</span><br>
<span class="lineno"></span><span class="comment" id="8041005">//&nbsp;but&nbsp;a</span><br>
<span class="lineno">165</span><span class="keyword" id="8041014">func</span>&nbsp;<span class="ident" id="8041019">TestNohup</span><span class="op" id="8041028">(</span><span class="ident" id="8041029">t</span>&nbsp;<span class="op" id="8041031">*</span><span class="ident" id="8041032">testing</span><span class="op" id="8041039">.</span><span class="ident" id="8041040">T</span><span class="op" id="8041041">)</span>&nbsp;<span class="op" id="8041043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8041046">//&nbsp;Ugly:&nbsp;ask&nbsp;for&nbsp;SIGHUP&nbsp;so&nbsp;that&nbsp;child&nbsp;will&nbsp;not&nbsp;have&nbsp;no-hup&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8041110">//&nbsp;even&nbsp;if&nbsp;test&nbsp;is&nbsp;running&nbsp;under&nbsp;nohup&nbsp;environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8041163">//&nbsp;We&nbsp;have&nbsp;no&nbsp;intention&nbsp;of&nbsp;reading&nbsp;from&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041207">c</span>&nbsp;<span class="op" id="8041209">:=</span>&nbsp;<span class="builtinfunc" id="8041212">make</span><span class="op" id="8041216">(</span><span class="keyword" id="8041217">chan</span>&nbsp;<span class="ident" id="8041222">os</span><span class="op" id="8041224">.</span><span class="ident" id="8041225">Signal</span><span class="op" id="8041231">,</span>&nbsp;<span class="num" id="8041233">1</span><span class="op" id="8041234">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041237">Notify</span><span class="op" id="8041243">(</span><span class="ident" id="8041244">c</span><span class="op" id="8041245">,</span>&nbsp;<span class="ident" id="8041247">syscall</span><span class="op" id="8041254">.</span><span class="ident" id="8041255">SIGHUP</span><span class="op" id="8041261">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8041265">//&nbsp;When&nbsp;run&nbsp;without&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;crash&nbsp;on&nbsp;an&nbsp;uncaught&nbsp;SIGHUP.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8041338">//&nbsp;When&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;ignore&nbsp;uncaught&nbsp;SIGHUPs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8041405">//&nbsp;because&nbsp;the&nbsp;runtime&nbsp;is&nbsp;not&nbsp;supposed&nbsp;to&nbsp;be&nbsp;listening&nbsp;for&nbsp;them.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8041471">//&nbsp;Either&nbsp;way,&nbsp;TestStop&nbsp;should&nbsp;still&nbsp;be&nbsp;able&nbsp;to&nbsp;catch&nbsp;them&nbsp;when&nbsp;it&nbsp;wants&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8041550">//&nbsp;and&nbsp;then&nbsp;when&nbsp;it&nbsp;stops&nbsp;wanting&nbsp;them,&nbsp;the&nbsp;original&nbsp;behavior&nbsp;should&nbsp;resume.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8041628">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8041632">//&nbsp;send_uncaught_sighup=1&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;before&nbsp;starting&nbsp;to&nbsp;listen&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8041715">//&nbsp;send_uncaught_sighup=2&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;after&nbsp;no&nbsp;longer&nbsp;listening&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8041798">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8041802">//&nbsp;Both&nbsp;should&nbsp;fail&nbsp;without&nbsp;nohup&nbsp;and&nbsp;succeed&nbsp;with&nbsp;nohup.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041862">for</span>&nbsp;<span class="ident" id="8041866">i</span>&nbsp;<span class="op" id="8041868">:=</span>&nbsp;<span class="num" id="8041871">1</span><span class="op" id="8041872">;</span>&nbsp;<span class="ident" id="8041874">i</span>&nbsp;<span class="op" id="8041876">&lt;=</span>&nbsp;<span class="num" id="8041879">2</span><span class="op" id="8041880">;</span>&nbsp;<span class="ident" id="8041882">i</span><span class="op" id="8041883">++</span>&nbsp;<span class="op" id="8041886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041890">out</span><span class="op" id="8041893">,</span>&nbsp;<span class="ident" id="8041895">err</span>&nbsp;<span class="op" id="8041899">:=</span>&nbsp;<span class="ident" id="8041902">exec</span><span class="op" id="8041906">.</span><span class="ident" id="8041907">Command</span><span class="op" id="8041914">(</span><span class="ident" id="8041915">os</span><span class="op" id="8041917">.</span><span class="ident" id="8041918">Args</span><span class="op" id="8041922">[</span><span class="num" id="8041923">0</span><span class="op" id="8041924">]</span><span class="op" id="8041925">,</span>&nbsp;<span class="string" id="8041927">&#34;-test.run=TestStop&#34;</span><span class="op" id="8041947">,</span>&nbsp;<span class="string" id="8041949">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="8041973">+</span><span class="ident" id="8041974">strconv</span><span class="op" id="8041981">.</span><span class="ident" id="8041982">Itoa</span><span class="op" id="8041986">(</span><span class="ident" id="8041987">i</span><span class="op" id="8041988">)</span><span class="op" id="8041989">)</span><span class="op" id="8041990">.</span><span class="ident" id="8041991">CombinedOutput</span><span class="op" id="8042005">(</span><span class="op" id="8042006">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8042010">if</span>&nbsp;<span class="ident" id="8042013">err</span>&nbsp;<span class="op" id="8042017">==</span>&nbsp;<span class="ident" id="8042020">nil</span>&nbsp;<span class="op" id="8042024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042029">t</span><span class="op" id="8042030">.</span><span class="ident" id="8042031">Fatalf</span><span class="op" id="8042037">(</span><span class="string" id="8042038">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;and&nbsp;it&nbsp;succeeded:&nbsp;expected&nbsp;failure.\nOutput:\n%s&#34;</span><span class="op" id="8042127">,</span>&nbsp;<span class="ident" id="8042129">i</span><span class="op" id="8042130">,</span>&nbsp;<span class="ident" id="8042132">out</span><span class="op" id="8042135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042146">Stop</span><span class="op" id="8042150">(</span><span class="ident" id="8042151">c</span><span class="op" id="8042152">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8042156">//&nbsp;Again,&nbsp;this&nbsp;time&nbsp;with&nbsp;nohup,&nbsp;assuming&nbsp;we&nbsp;can&nbsp;find&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042214">_</span><span class="op" id="8042215">,</span>&nbsp;<span class="ident" id="8042217">err</span>&nbsp;<span class="op" id="8042221">:=</span>&nbsp;<span class="ident" id="8042224">os</span><span class="op" id="8042226">.</span><span class="ident" id="8042227">Stat</span><span class="op" id="8042231">(</span><span class="string" id="8042232">&#34;/usr/bin/nohup&#34;</span><span class="op" id="8042248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8042251">if</span>&nbsp;<span class="ident" id="8042254">err</span>&nbsp;<span class="op" id="8042258">!=</span>&nbsp;<span class="ident" id="8042261">nil</span>&nbsp;<span class="op" id="8042265">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042269">t</span><span class="op" id="8042270">.</span><span class="ident" id="8042271">Skip</span><span class="op" id="8042275">(</span><span class="string" id="8042276">&#34;cannot&nbsp;find&nbsp;nohup;&nbsp;skipping&nbsp;second&nbsp;half&nbsp;of&nbsp;test&#34;</span><span class="op" id="8042325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8042332">for</span>&nbsp;<span class="ident" id="8042336">i</span>&nbsp;<span class="op" id="8042338">:=</span>&nbsp;<span class="num" id="8042341">1</span><span class="op" id="8042342">;</span>&nbsp;<span class="ident" id="8042344">i</span>&nbsp;<span class="op" id="8042346">&lt;=</span>&nbsp;<span class="num" id="8042349">2</span><span class="op" id="8042350">;</span>&nbsp;<span class="ident" id="8042352">i</span><span class="op" id="8042353">++</span>&nbsp;<span class="op" id="8042356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042360">os</span><span class="op" id="8042362">.</span><span class="ident" id="8042363">Remove</span><span class="op" id="8042369">(</span><span class="string" id="8042370">&#34;nohup.out&#34;</span><span class="op" id="8042381">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042385">out</span><span class="op" id="8042388">,</span>&nbsp;<span class="ident" id="8042390">err</span>&nbsp;<span class="op" id="8042394">:=</span>&nbsp;<span class="ident" id="8042397">exec</span><span class="op" id="8042401">.</span><span class="ident" id="8042402">Command</span><span class="op" id="8042409">(</span><span class="string" id="8042410">&#34;/usr/bin/nohup&#34;</span><span class="op" id="8042426">,</span>&nbsp;<span class="ident" id="8042428">os</span><span class="op" id="8042430">.</span><span class="ident" id="8042431">Args</span><span class="op" id="8042435">[</span><span class="num" id="8042436">0</span><span class="op" id="8042437">]</span><span class="op" id="8042438">,</span>&nbsp;<span class="string" id="8042440">&#34;-test.run=TestStop&#34;</span><span class="op" id="8042460">,</span>&nbsp;<span class="string" id="8042462">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="8042486">+</span><span class="ident" id="8042487">strconv</span><span class="op" id="8042494">.</span><span class="ident" id="8042495">Itoa</span><span class="op" id="8042499">(</span><span class="ident" id="8042500">i</span><span class="op" id="8042501">)</span><span class="op" id="8042502">)</span><span class="op" id="8042503">.</span><span class="ident" id="8042504">CombinedOutput</span><span class="op" id="8042518">(</span><span class="op" id="8042519">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042524">data</span><span class="op" id="8042528">,</span>&nbsp;<span class="ident" id="8042530">_</span>&nbsp;<span class="op" id="8042532">:=</span>&nbsp;<span class="ident" id="8042535">ioutil</span><span class="op" id="8042541">.</span><span class="ident" id="8042542">ReadFile</span><span class="op" id="8042550">(</span><span class="string" id="8042551">&#34;nohup.out&#34;</span><span class="op" id="8042562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042566">os</span><span class="op" id="8042568">.</span><span class="ident" id="8042569">Remove</span><span class="op" id="8042575">(</span><span class="string" id="8042576">&#34;nohup.out&#34;</span><span class="op" id="8042587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8042591">if</span>&nbsp;<span class="ident" id="8042594">err</span>&nbsp;<span class="op" id="8042598">!=</span>&nbsp;<span class="ident" id="8042601">nil</span>&nbsp;<span class="op" id="8042605">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042610">t</span><span class="op" id="8042611">.</span><span class="ident" id="8042612">Fatalf</span><span class="op" id="8042618">(</span><span class="string" id="8042619">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;under&nbsp;nohup&nbsp;and&nbsp;it&nbsp;failed:&nbsp;expected&nbsp;success.\nError:&nbsp;%v\nOutput:\n%s%s&#34;</span><span class="op" id="8042730">,</span>&nbsp;<span class="ident" id="8042732">i</span><span class="op" id="8042733">,</span>&nbsp;<span class="ident" id="8042735">err</span><span class="op" id="8042738">,</span>&nbsp;<span class="ident" id="8042740">out</span><span class="op" id="8042743">,</span>&nbsp;<span class="ident" id="8042745">data</span><span class="op" id="8042749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042756">}</span><br>
<span class="lineno"></span><span class="op" id="8042758">}</span>
</div>
</body>
</html>
