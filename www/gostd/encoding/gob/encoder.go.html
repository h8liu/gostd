<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html" class="current">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5564902">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5564957">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5565011">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5565062">package</span>&nbsp;<span class="ident" id="5565070">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5565075">import</span>&nbsp;<span class="op" id="5565082">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5565085">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5565091">&#34;reflect&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5565102">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5565109">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5565112">//&nbsp;An&nbsp;Encoder&nbsp;manages&nbsp;the&nbsp;transmission&nbsp;of&nbsp;type&nbsp;and&nbsp;data&nbsp;information&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5565187">//&nbsp;other&nbsp;side&nbsp;of&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">15</span><span class="keyword" id="5565218">type</span>&nbsp;<span class="ident" id="5565223">Encoder</span>&nbsp;<span class="keyword" id="5565231">struct</span>&nbsp;<span class="op" id="5565238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5565241">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5565252">sync</span><span class="op" id="5565256">.</span><span class="ident" id="5565257">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5565276">//&nbsp;each&nbsp;item&nbsp;must&nbsp;be&nbsp;sent&nbsp;atomically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5565314">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5565325">[</span><span class="op" id="5565326">]</span><span class="ident" id="5565327">io</span><span class="op" id="5565329">.</span><span class="ident" id="5565330">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5565349">//&nbsp;where&nbsp;to&nbsp;send&nbsp;the&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5565376">sent</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5565387">map</span><span class="op" id="5565390">[</span><span class="ident" id="5565391">reflect</span><span class="op" id="5565398">.</span><span class="ident" id="5565399">Type</span><span class="op" id="5565403">]</span><span class="ident" id="5565404">typeId</span>&nbsp;<span class="comment" id="5565411">//&nbsp;which&nbsp;types&nbsp;we&#39;ve&nbsp;already&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5565446">countState</span>&nbsp;<span class="op" id="5565457">*</span><span class="ident" id="5565458">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5565481">//&nbsp;stage&nbsp;for&nbsp;writing&nbsp;counts</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5565510">freeList</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5565521">*</span><span class="ident" id="5565522">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5565545">//&nbsp;list&nbsp;of&nbsp;free&nbsp;encoderStates;&nbsp;avoids&nbsp;reallocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5565597">byteBuf</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5565608">encBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5565632">//&nbsp;buffer&nbsp;for&nbsp;top-level&nbsp;encoderState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5565670">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5565681">error</span><br>
<span class="lineno"></span><span class="op" id="5565687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5565690">//&nbsp;Before&nbsp;we&nbsp;encode&nbsp;a&nbsp;message,&nbsp;we&nbsp;reserve&nbsp;space&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5565757">//&nbsp;buffer&nbsp;in&nbsp;which&nbsp;to&nbsp;encode&nbsp;its&nbsp;length.&nbsp;This&nbsp;means&nbsp;we&nbsp;can&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5565824">//&nbsp;buffer&nbsp;to&nbsp;assemble&nbsp;the&nbsp;message&nbsp;without&nbsp;another&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="5565886">const</span>&nbsp;<span class="ident" id="5565892">maxLength</span>&nbsp;<span class="op" id="5565902">=</span>&nbsp;<span class="num" id="5565904">9</span>&nbsp;<span class="comment" id="5565906">//&nbsp;Maximum&nbsp;size&nbsp;of&nbsp;an&nbsp;encoded&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="5565944">var</span>&nbsp;<span class="ident" id="5565948">spaceForLength</span>&nbsp;<span class="op" id="5565963">=</span>&nbsp;<span class="builtinfunc" id="5565965">make</span><span class="op" id="5565969">(</span><span class="op" id="5565970">[</span><span class="op" id="5565971">]</span><span class="builtintype" id="5565972">byte</span><span class="op" id="5565976">,</span>&nbsp;<span class="ident" id="5565978">maxLength</span><span class="op" id="5565987">)</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="5565990">//&nbsp;NewEncoder&nbsp;returns&nbsp;a&nbsp;new&nbsp;encoder&nbsp;that&nbsp;will&nbsp;transmit&nbsp;on&nbsp;the&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5566063">func</span>&nbsp;<span class="ident" id="5566068">NewEncoder</span><span class="op" id="5566078">(</span><span class="ident" id="5566079">w</span>&nbsp;<span class="ident" id="5566081">io</span><span class="op" id="5566083">.</span><span class="ident" id="5566084">Writer</span><span class="op" id="5566090">)</span>&nbsp;<span class="op" id="5566092">*</span><span class="ident" id="5566093">Encoder</span>&nbsp;<span class="op" id="5566101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5566104">enc</span>&nbsp;<span class="op" id="5566108">:=</span>&nbsp;<span class="builtinfunc" id="5566111">new</span><span class="op" id="5566114">(</span><span class="ident" id="5566115">Encoder</span><span class="op" id="5566122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5566125">enc</span><span class="op" id="5566128">.</span><span class="ident" id="5566129">w</span>&nbsp;<span class="op" id="5566131">=</span>&nbsp;<span class="op" id="5566133">[</span><span class="op" id="5566134">]</span><span class="ident" id="5566135">io</span><span class="op" id="5566137">.</span><span class="ident" id="5566138">Writer</span><span class="op" id="5566144">{</span><span class="ident" id="5566145">w</span><span class="op" id="5566146">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5566149">enc</span><span class="op" id="5566152">.</span><span class="ident" id="5566153">sent</span>&nbsp;<span class="op" id="5566158">=</span>&nbsp;<span class="builtinfunc" id="5566160">make</span><span class="op" id="5566164">(</span><span class="keyword" id="5566165">map</span><span class="op" id="5566168">[</span><span class="ident" id="5566169">reflect</span><span class="op" id="5566176">.</span><span class="ident" id="5566177">Type</span><span class="op" id="5566181">]</span><span class="ident" id="5566182">typeId</span><span class="op" id="5566188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5566191">enc</span><span class="op" id="5566194">.</span><span class="ident" id="5566195">countState</span>&nbsp;<span class="op" id="5566206">=</span>&nbsp;<span class="ident" id="5566208">enc</span><span class="op" id="5566211">.</span><span class="ident" id="5566212">newEncoderState</span><span class="op" id="5566227">(</span><span class="builtinfunc" id="5566228">new</span><span class="op" id="5566231">(</span><span class="ident" id="5566232">encBuffer</span><span class="op" id="5566241">)</span><span class="op" id="5566242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5566245">return</span>&nbsp;<span class="ident" id="5566252">enc</span><br>
<span class="lineno"></span><span class="op" id="5566256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="5566259">//&nbsp;writer()&nbsp;returns&nbsp;the&nbsp;innermost&nbsp;writer&nbsp;the&nbsp;encoder&nbsp;is&nbsp;using</span><br>
<span class="lineno"></span><span class="keyword" id="5566321">func</span>&nbsp;<span class="op" id="5566326">(</span><span class="ident" id="5566327">enc</span>&nbsp;<span class="op" id="5566331">*</span><span class="ident" id="5566332">Encoder</span><span class="op" id="5566339">)</span>&nbsp;<span class="ident" id="5566341">writer</span><span class="op" id="5566347">(</span><span class="op" id="5566348">)</span>&nbsp;<span class="ident" id="5566350">io</span><span class="op" id="5566352">.</span><span class="ident" id="5566353">Writer</span>&nbsp;<span class="op" id="5566360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5566363">return</span>&nbsp;<span class="ident" id="5566370">enc</span><span class="op" id="5566373">.</span><span class="ident" id="5566374">w</span><span class="op" id="5566375">[</span><span class="builtinfunc" id="5566376">len</span><span class="op" id="5566379">(</span><span class="ident" id="5566380">enc</span><span class="op" id="5566383">.</span><span class="ident" id="5566384">w</span><span class="op" id="5566385">)</span><span class="op" id="5566386">-</span><span class="num" id="5566387">1</span><span class="op" id="5566388">]</span><br>
<span class="lineno"></span><span class="op" id="5566390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5566393">//&nbsp;pushWriter&nbsp;adds&nbsp;a&nbsp;writer&nbsp;to&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="keyword" id="5566437">func</span>&nbsp;<span class="op" id="5566442">(</span><span class="ident" id="5566443">enc</span>&nbsp;<span class="op" id="5566447">*</span><span class="ident" id="5566448">Encoder</span><span class="op" id="5566455">)</span>&nbsp;<span class="ident" id="5566457">pushWriter</span><span class="op" id="5566467">(</span><span class="ident" id="5566468">w</span>&nbsp;<span class="ident" id="5566470">io</span><span class="op" id="5566472">.</span><span class="ident" id="5566473">Writer</span><span class="op" id="5566479">)</span>&nbsp;<span class="op" id="5566481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5566484">enc</span><span class="op" id="5566487">.</span><span class="ident" id="5566488">w</span>&nbsp;<span class="op" id="5566490">=</span>&nbsp;<span class="builtinfunc" id="5566492">append</span><span class="op" id="5566498">(</span><span class="ident" id="5566499">enc</span><span class="op" id="5566502">.</span><span class="ident" id="5566503">w</span><span class="op" id="5566504">,</span>&nbsp;<span class="ident" id="5566506">w</span><span class="op" id="5566507">)</span><br>
<span class="lineno"></span><span class="op" id="5566509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5566512">//&nbsp;popWriter&nbsp;pops&nbsp;the&nbsp;innermost&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5566552">func</span>&nbsp;<span class="op" id="5566557">(</span><span class="ident" id="5566558">enc</span>&nbsp;<span class="op" id="5566562">*</span><span class="ident" id="5566563">Encoder</span><span class="op" id="5566570">)</span>&nbsp;<span class="ident" id="5566572">popWriter</span><span class="op" id="5566581">(</span><span class="op" id="5566582">)</span>&nbsp;<span class="op" id="5566584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5566587">enc</span><span class="op" id="5566590">.</span><span class="ident" id="5566591">w</span>&nbsp;<span class="op" id="5566593">=</span>&nbsp;<span class="ident" id="5566595">enc</span><span class="op" id="5566598">.</span><span class="ident" id="5566599">w</span><span class="op" id="5566600">[</span><span class="num" id="5566601">0</span>&nbsp;<span class="op" id="5566603">:</span>&nbsp;<span class="builtinfunc" id="5566605">len</span><span class="op" id="5566608">(</span><span class="ident" id="5566609">enc</span><span class="op" id="5566612">.</span><span class="ident" id="5566613">w</span><span class="op" id="5566614">)</span><span class="op" id="5566615">-</span><span class="num" id="5566616">1</span><span class="op" id="5566617">]</span><br>
<span class="lineno"></span><span class="op" id="5566619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="5566622">func</span>&nbsp;<span class="op" id="5566627">(</span><span class="ident" id="5566628">enc</span>&nbsp;<span class="op" id="5566632">*</span><span class="ident" id="5566633">Encoder</span><span class="op" id="5566640">)</span>&nbsp;<span class="ident" id="5566642">setError</span><span class="op" id="5566650">(</span><span class="ident" id="5566651">err</span>&nbsp;<span class="builtintype" id="5566655">error</span><span class="op" id="5566660">)</span>&nbsp;<span class="op" id="5566662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5566665">if</span>&nbsp;<span class="ident" id="5566668">enc</span><span class="op" id="5566671">.</span><span class="ident" id="5566672">err</span>&nbsp;<span class="op" id="5566676">==</span>&nbsp;<span class="builtintype" id="5566679">nil</span>&nbsp;<span class="op" id="5566683">{</span>&nbsp;<span class="comment" id="5566685">//&nbsp;remember&nbsp;the&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5566710">enc</span><span class="op" id="5566713">.</span><span class="ident" id="5566714">err</span>&nbsp;<span class="op" id="5566718">=</span>&nbsp;<span class="ident" id="5566720">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5566725">}</span><br>
<span class="lineno"></span><span class="op" id="5566727">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="5566730">//&nbsp;writeMessage&nbsp;sends&nbsp;the&nbsp;data&nbsp;item&nbsp;preceded&nbsp;by&nbsp;a&nbsp;unsigned&nbsp;count&nbsp;of&nbsp;its&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="5566810">func</span>&nbsp;<span class="op" id="5566815">(</span><span class="ident" id="5566816">enc</span>&nbsp;<span class="op" id="5566820">*</span><span class="ident" id="5566821">Encoder</span><span class="op" id="5566828">)</span>&nbsp;<span class="ident" id="5566830">writeMessage</span><span class="op" id="5566842">(</span><span class="ident" id="5566843">w</span>&nbsp;<span class="ident" id="5566845">io</span><span class="op" id="5566847">.</span><span class="ident" id="5566848">Writer</span><span class="op" id="5566854">,</span>&nbsp;<span class="ident" id="5566856">b</span>&nbsp;<span class="op" id="5566858">*</span><span class="ident" id="5566859">encBuffer</span><span class="op" id="5566868">)</span>&nbsp;<span class="op" id="5566870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5566873">//&nbsp;Space&nbsp;has&nbsp;been&nbsp;reserved&nbsp;for&nbsp;the&nbsp;length&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5566944">//&nbsp;This&nbsp;is&nbsp;a&nbsp;little&nbsp;dirty:&nbsp;we&nbsp;grab&nbsp;the&nbsp;slice&nbsp;from&nbsp;the&nbsp;bytes.Buffer&nbsp;and&nbsp;massage</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5567024">//&nbsp;it&nbsp;by&nbsp;hand.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5567040">message</span>&nbsp;<span class="op" id="5567048">:=</span>&nbsp;<span class="ident" id="5567051">b</span><span class="op" id="5567052">.</span><span class="ident" id="5567053">Bytes</span><span class="op" id="5567058">(</span><span class="op" id="5567059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5567062">messageLen</span>&nbsp;<span class="op" id="5567073">:=</span>&nbsp;<span class="builtinfunc" id="5567076">len</span><span class="op" id="5567079">(</span><span class="ident" id="5567080">message</span><span class="op" id="5567087">)</span>&nbsp;<span class="op" id="5567089">-</span>&nbsp;<span class="ident" id="5567091">maxLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5567102">//&nbsp;Encode&nbsp;the&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5567125">enc</span><span class="op" id="5567128">.</span><span class="ident" id="5567129">countState</span><span class="op" id="5567139">.</span><span class="ident" id="5567140">b</span><span class="op" id="5567141">.</span><span class="ident" id="5567142">Reset</span><span class="op" id="5567147">(</span><span class="op" id="5567148">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5567151">enc</span><span class="op" id="5567154">.</span><span class="ident" id="5567155">countState</span><span class="op" id="5567165">.</span><span class="ident" id="5567166">encodeUint</span><span class="op" id="5567176">(</span><span class="ident" id="5567177">uint64</span><span class="op" id="5567183">(</span><span class="ident" id="5567184">messageLen</span><span class="op" id="5567194">)</span><span class="op" id="5567195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5567198">//&nbsp;Copy&nbsp;the&nbsp;length&nbsp;to&nbsp;be&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5567249">offset</span>&nbsp;<span class="op" id="5567256">:=</span>&nbsp;<span class="ident" id="5567259">maxLength</span>&nbsp;<span class="op" id="5567269">-</span>&nbsp;<span class="ident" id="5567271">enc</span><span class="op" id="5567274">.</span><span class="ident" id="5567275">countState</span><span class="op" id="5567285">.</span><span class="ident" id="5567286">b</span><span class="op" id="5567287">.</span><span class="ident" id="5567288">Len</span><span class="op" id="5567291">(</span><span class="op" id="5567292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5567295">copy</span><span class="op" id="5567299">(</span><span class="ident" id="5567300">message</span><span class="op" id="5567307">[</span><span class="ident" id="5567308">offset</span><span class="op" id="5567314">:</span><span class="op" id="5567315">]</span><span class="op" id="5567316">,</span>&nbsp;<span class="ident" id="5567318">enc</span><span class="op" id="5567321">.</span><span class="ident" id="5567322">countState</span><span class="op" id="5567332">.</span><span class="ident" id="5567333">b</span><span class="op" id="5567334">.</span><span class="ident" id="5567335">Bytes</span><span class="op" id="5567340">(</span><span class="op" id="5567341">)</span><span class="op" id="5567342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5567345">//&nbsp;Write&nbsp;the&nbsp;data.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5567365">_</span><span class="op" id="5567366">,</span>&nbsp;<span class="ident" id="5567368">err</span>&nbsp;<span class="op" id="5567372">:=</span>&nbsp;<span class="ident" id="5567375">w</span><span class="op" id="5567376">.</span><span class="ident" id="5567377">Write</span><span class="op" id="5567382">(</span><span class="ident" id="5567383">message</span><span class="op" id="5567390">[</span><span class="ident" id="5567391">offset</span><span class="op" id="5567397">:</span><span class="op" id="5567398">]</span><span class="op" id="5567399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5567402">//&nbsp;Drain&nbsp;the&nbsp;buffer&nbsp;and&nbsp;restore&nbsp;the&nbsp;space&nbsp;at&nbsp;the&nbsp;front&nbsp;for&nbsp;the&nbsp;count&nbsp;of&nbsp;the&nbsp;next&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5567493">b</span><span class="op" id="5567494">.</span><span class="ident" id="5567495">Reset</span><span class="op" id="5567500">(</span><span class="op" id="5567501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5567504">b</span><span class="op" id="5567505">.</span><span class="ident" id="5567506">Write</span><span class="op" id="5567511">(</span><span class="ident" id="5567512">spaceForLength</span><span class="op" id="5567526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5567529">if</span>&nbsp;<span class="ident" id="5567532">err</span>&nbsp;<span class="op" id="5567536">!=</span>&nbsp;<span class="builtintype" id="5567539">nil</span>&nbsp;<span class="op" id="5567543">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5567547">enc</span><span class="op" id="5567550">.</span><span class="ident" id="5567551">setError</span><span class="op" id="5567559">(</span><span class="ident" id="5567560">err</span><span class="op" id="5567563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5567566">}</span><br>
<span class="lineno"></span><span class="op" id="5567568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5567571">//&nbsp;sendActualType&nbsp;sends&nbsp;the&nbsp;requested&nbsp;type,&nbsp;without&nbsp;further&nbsp;investigation,&nbsp;unless</span><br>
<span class="lineno">85</span><span class="comment" id="5567653">//&nbsp;it&#39;s&nbsp;been&nbsp;sent&nbsp;before.</span><br>
<span class="lineno"></span><span class="keyword" id="5567679">func</span>&nbsp;<span class="op" id="5567684">(</span><span class="ident" id="5567685">enc</span>&nbsp;<span class="op" id="5567689">*</span><span class="ident" id="5567690">Encoder</span><span class="op" id="5567697">)</span>&nbsp;<span class="ident" id="5567699">sendActualType</span><span class="op" id="5567713">(</span><span class="ident" id="5567714">w</span>&nbsp;<span class="ident" id="5567716">io</span><span class="op" id="5567718">.</span><span class="ident" id="5567719">Writer</span><span class="op" id="5567725">,</span>&nbsp;<span class="ident" id="5567727">state</span>&nbsp;<span class="op" id="5567733">*</span><span class="ident" id="5567734">encoderState</span><span class="op" id="5567746">,</span>&nbsp;<span class="ident" id="5567748">ut</span>&nbsp;<span class="op" id="5567751">*</span><span class="ident" id="5567752">userTypeInfo</span><span class="op" id="5567764">,</span>&nbsp;<span class="ident" id="5567766">actual</span>&nbsp;<span class="ident" id="5567773">reflect</span><span class="op" id="5567780">.</span><span class="ident" id="5567781">Type</span><span class="op" id="5567785">)</span>&nbsp;<span class="op" id="5567787">(</span><span class="ident" id="5567788">sent</span>&nbsp;<span class="builtintype" id="5567793">bool</span><span class="op" id="5567797">)</span>&nbsp;<span class="op" id="5567799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5567802">if</span>&nbsp;<span class="ident" id="5567805">_</span><span class="op" id="5567806">,</span>&nbsp;<span class="ident" id="5567808">alreadySent</span>&nbsp;<span class="op" id="5567820">:=</span>&nbsp;<span class="ident" id="5567823">enc</span><span class="op" id="5567826">.</span><span class="ident" id="5567827">sent</span><span class="op" id="5567831">[</span><span class="ident" id="5567832">actual</span><span class="op" id="5567838">]</span><span class="op" id="5567839">;</span>&nbsp;<span class="ident" id="5567841">alreadySent</span>&nbsp;<span class="op" id="5567853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5567857">return</span>&nbsp;<span class="builtintype" id="5567864">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5567871">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5567874">info</span><span class="op" id="5567878">,</span>&nbsp;<span class="ident" id="5567880">err</span>&nbsp;<span class="op" id="5567884">:=</span>&nbsp;<span class="ident" id="5567887">getTypeInfo</span><span class="op" id="5567898">(</span><span class="ident" id="5567899">ut</span><span class="op" id="5567901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5567904">if</span>&nbsp;<span class="ident" id="5567907">err</span>&nbsp;<span class="op" id="5567911">!=</span>&nbsp;<span class="builtintype" id="5567914">nil</span>&nbsp;<span class="op" id="5567918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5567922">enc</span><span class="op" id="5567925">.</span><span class="ident" id="5567926">setError</span><span class="op" id="5567934">(</span><span class="ident" id="5567935">err</span><span class="op" id="5567938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5567942">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5567950">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5567953">//&nbsp;Send&nbsp;the&nbsp;pair&nbsp;(-id,&nbsp;type)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5567983">//&nbsp;Id:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5567991">state</span><span class="op" id="5567996">.</span><span class="ident" id="5567997">encodeInt</span><span class="op" id="5568006">(</span><span class="op" id="5568007">-</span><span class="ident" id="5568008">int64</span><span class="op" id="5568013">(</span><span class="ident" id="5568014">info</span><span class="op" id="5568018">.</span><span class="ident" id="5568019">id</span><span class="op" id="5568021">)</span><span class="op" id="5568022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5568025">//&nbsp;Type:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5568035">enc</span><span class="op" id="5568038">.</span><span class="ident" id="5568039">encode</span><span class="op" id="5568045">(</span><span class="ident" id="5568046">state</span><span class="op" id="5568051">.</span><span class="ident" id="5568052">b</span><span class="op" id="5568053">,</span>&nbsp;<span class="ident" id="5568055">reflect</span><span class="op" id="5568062">.</span><span class="ident" id="5568063">ValueOf</span><span class="op" id="5568070">(</span><span class="ident" id="5568071">info</span><span class="op" id="5568075">.</span><span class="ident" id="5568076">wire</span><span class="op" id="5568080">)</span><span class="op" id="5568081">,</span>&nbsp;<span class="ident" id="5568083">wireTypeUserInfo</span><span class="op" id="5568099">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5568102">enc</span><span class="op" id="5568105">.</span><span class="ident" id="5568106">writeMessage</span><span class="op" id="5568118">(</span><span class="ident" id="5568119">w</span><span class="op" id="5568120">,</span>&nbsp;<span class="ident" id="5568122">state</span><span class="op" id="5568127">.</span><span class="ident" id="5568128">b</span><span class="op" id="5568129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5568132">if</span>&nbsp;<span class="ident" id="5568135">enc</span><span class="op" id="5568138">.</span><span class="ident" id="5568139">err</span>&nbsp;<span class="op" id="5568143">!=</span>&nbsp;<span class="builtintype" id="5568146">nil</span>&nbsp;<span class="op" id="5568150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5568154">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5568162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5568166">//&nbsp;Remember&nbsp;we&#39;ve&nbsp;sent&nbsp;this&nbsp;type,&nbsp;both&nbsp;what&nbsp;the&nbsp;user&nbsp;gave&nbsp;us&nbsp;and&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5568247">enc</span><span class="op" id="5568250">.</span><span class="ident" id="5568251">sent</span><span class="op" id="5568255">[</span><span class="ident" id="5568256">ut</span><span class="op" id="5568258">.</span><span class="ident" id="5568259">base</span><span class="op" id="5568263">]</span>&nbsp;<span class="op" id="5568265">=</span>&nbsp;<span class="ident" id="5568267">info</span><span class="op" id="5568271">.</span><span class="ident" id="5568272">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5568276">if</span>&nbsp;<span class="ident" id="5568279">ut</span><span class="op" id="5568281">.</span><span class="ident" id="5568282">user</span>&nbsp;<span class="op" id="5568287">!=</span>&nbsp;<span class="ident" id="5568290">ut</span><span class="op" id="5568292">.</span><span class="ident" id="5568293">base</span>&nbsp;<span class="op" id="5568298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5568302">enc</span><span class="op" id="5568305">.</span><span class="ident" id="5568306">sent</span><span class="op" id="5568310">[</span><span class="ident" id="5568311">ut</span><span class="op" id="5568313">.</span><span class="ident" id="5568314">user</span><span class="op" id="5568318">]</span>&nbsp;<span class="op" id="5568320">=</span>&nbsp;<span class="ident" id="5568322">info</span><span class="op" id="5568326">.</span><span class="ident" id="5568327">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5568331">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5568334">//&nbsp;Now&nbsp;send&nbsp;the&nbsp;inner&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5568363">switch</span>&nbsp;<span class="ident" id="5568370">st</span>&nbsp;<span class="op" id="5568373">:=</span>&nbsp;<span class="ident" id="5568376">actual</span><span class="op" id="5568382">;</span>&nbsp;<span class="ident" id="5568384">st</span><span class="op" id="5568386">.</span><span class="ident" id="5568387">Kind</span><span class="op" id="5568391">(</span><span class="op" id="5568392">)</span>&nbsp;<span class="op" id="5568394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5568397">case</span>&nbsp;<span class="ident" id="5568402">reflect</span><span class="op" id="5568409">.</span><span class="ident" id="5568410">Struct</span><span class="op" id="5568416">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5568420">for</span>&nbsp;<span class="ident" id="5568424">i</span>&nbsp;<span class="op" id="5568426">:=</span>&nbsp;<span class="num" id="5568429">0</span><span class="op" id="5568430">;</span>&nbsp;<span class="ident" id="5568432">i</span>&nbsp;<span class="op" id="5568434">&lt;</span>&nbsp;<span class="ident" id="5568436">st</span><span class="op" id="5568438">.</span><span class="ident" id="5568439">NumField</span><span class="op" id="5568447">(</span><span class="op" id="5568448">)</span><span class="op" id="5568449">;</span>&nbsp;<span class="ident" id="5568451">i</span><span class="op" id="5568452">++</span>&nbsp;<span class="op" id="5568455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5568460">if</span>&nbsp;<span class="ident" id="5568463">isExported</span><span class="op" id="5568473">(</span><span class="ident" id="5568474">st</span><span class="op" id="5568476">.</span><span class="ident" id="5568477">Field</span><span class="op" id="5568482">(</span><span class="ident" id="5568483">i</span><span class="op" id="5568484">)</span><span class="op" id="5568485">.</span><span class="ident" id="5568486">Name</span><span class="op" id="5568490">)</span>&nbsp;<span class="op" id="5568492">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5568498">enc</span><span class="op" id="5568501">.</span><span class="ident" id="5568502">sendType</span><span class="op" id="5568510">(</span><span class="ident" id="5568511">w</span><span class="op" id="5568512">,</span>&nbsp;<span class="ident" id="5568514">state</span><span class="op" id="5568519">,</span>&nbsp;<span class="ident" id="5568521">st</span><span class="op" id="5568523">.</span><span class="ident" id="5568524">Field</span><span class="op" id="5568529">(</span><span class="ident" id="5568530">i</span><span class="op" id="5568531">)</span><span class="op" id="5568532">.</span><span class="ident" id="5568533">Type</span><span class="op" id="5568537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5568542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5568546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5568549">case</span>&nbsp;<span class="ident" id="5568554">reflect</span><span class="op" id="5568561">.</span><span class="ident" id="5568562">Array</span><span class="op" id="5568567">,</span>&nbsp;<span class="ident" id="5568569">reflect</span><span class="op" id="5568576">.</span><span class="ident" id="5568577">Slice</span><span class="op" id="5568582">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5568586">enc</span><span class="op" id="5568589">.</span><span class="ident" id="5568590">sendType</span><span class="op" id="5568598">(</span><span class="ident" id="5568599">w</span><span class="op" id="5568600">,</span>&nbsp;<span class="ident" id="5568602">state</span><span class="op" id="5568607">,</span>&nbsp;<span class="ident" id="5568609">st</span><span class="op" id="5568611">.</span><span class="ident" id="5568612">Elem</span><span class="op" id="5568616">(</span><span class="op" id="5568617">)</span><span class="op" id="5568618">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5568621">case</span>&nbsp;<span class="ident" id="5568626">reflect</span><span class="op" id="5568633">.</span><span class="ident" id="5568634">Map</span><span class="op" id="5568637">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5568641">enc</span><span class="op" id="5568644">.</span><span class="ident" id="5568645">sendType</span><span class="op" id="5568653">(</span><span class="ident" id="5568654">w</span><span class="op" id="5568655">,</span>&nbsp;<span class="ident" id="5568657">state</span><span class="op" id="5568662">,</span>&nbsp;<span class="ident" id="5568664">st</span><span class="op" id="5568666">.</span><span class="ident" id="5568667">Key</span><span class="op" id="5568670">(</span><span class="op" id="5568671">)</span><span class="op" id="5568672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5568676">enc</span><span class="op" id="5568679">.</span><span class="ident" id="5568680">sendType</span><span class="op" id="5568688">(</span><span class="ident" id="5568689">w</span><span class="op" id="5568690">,</span>&nbsp;<span class="ident" id="5568692">state</span><span class="op" id="5568697">,</span>&nbsp;<span class="ident" id="5568699">st</span><span class="op" id="5568701">.</span><span class="ident" id="5568702">Elem</span><span class="op" id="5568706">(</span><span class="op" id="5568707">)</span><span class="op" id="5568708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5568711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5568714">return</span>&nbsp;<span class="builtintype" id="5568721">true</span><br>
<span class="lineno">125</span><span class="op" id="5568726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5568729">//&nbsp;sendType&nbsp;sends&nbsp;the&nbsp;type&nbsp;info&nbsp;to&nbsp;the&nbsp;other&nbsp;side,&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="5568794">func</span>&nbsp;<span class="op" id="5568799">(</span><span class="ident" id="5568800">enc</span>&nbsp;<span class="op" id="5568804">*</span><span class="ident" id="5568805">Encoder</span><span class="op" id="5568812">)</span>&nbsp;<span class="ident" id="5568814">sendType</span><span class="op" id="5568822">(</span><span class="ident" id="5568823">w</span>&nbsp;<span class="ident" id="5568825">io</span><span class="op" id="5568827">.</span><span class="ident" id="5568828">Writer</span><span class="op" id="5568834">,</span>&nbsp;<span class="ident" id="5568836">state</span>&nbsp;<span class="op" id="5568842">*</span><span class="ident" id="5568843">encoderState</span><span class="op" id="5568855">,</span>&nbsp;<span class="ident" id="5568857">origt</span>&nbsp;<span class="ident" id="5568863">reflect</span><span class="op" id="5568870">.</span><span class="ident" id="5568871">Type</span><span class="op" id="5568875">)</span>&nbsp;<span class="op" id="5568877">(</span><span class="ident" id="5568878">sent</span>&nbsp;<span class="builtintype" id="5568883">bool</span><span class="op" id="5568887">)</span>&nbsp;<span class="op" id="5568889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5568892">ut</span>&nbsp;<span class="op" id="5568895">:=</span>&nbsp;<span class="ident" id="5568898">userType</span><span class="op" id="5568906">(</span><span class="ident" id="5568907">origt</span><span class="op" id="5568912">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5568915">if</span>&nbsp;<span class="ident" id="5568918">ut</span><span class="op" id="5568920">.</span><span class="ident" id="5568921">externalEnc</span>&nbsp;<span class="op" id="5568933">!=</span>&nbsp;<span class="num" id="5568936">0</span>&nbsp;<span class="op" id="5568938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5568942">//&nbsp;The&nbsp;rules&nbsp;are&nbsp;different:&nbsp;regardless&nbsp;of&nbsp;the&nbsp;underlying&nbsp;type&#39;s&nbsp;representation,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569024">//&nbsp;we&nbsp;need&nbsp;to&nbsp;tell&nbsp;the&nbsp;other&nbsp;side&nbsp;that&nbsp;the&nbsp;base&nbsp;type&nbsp;is&nbsp;a&nbsp;GobEncoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569096">return</span>&nbsp;<span class="ident" id="5569103">enc</span><span class="op" id="5569106">.</span><span class="ident" id="5569107">sendActualType</span><span class="op" id="5569121">(</span><span class="ident" id="5569122">w</span><span class="op" id="5569123">,</span>&nbsp;<span class="ident" id="5569125">state</span><span class="op" id="5569130">,</span>&nbsp;<span class="ident" id="5569132">ut</span><span class="op" id="5569134">,</span>&nbsp;<span class="ident" id="5569136">ut</span><span class="op" id="5569138">.</span><span class="ident" id="5569139">base</span><span class="op" id="5569143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5569146">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569150">//&nbsp;It&#39;s&nbsp;a&nbsp;concrete&nbsp;value,&nbsp;so&nbsp;drill&nbsp;down&nbsp;to&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569209">switch</span>&nbsp;<span class="ident" id="5569216">rt</span>&nbsp;<span class="op" id="5569219">:=</span>&nbsp;<span class="ident" id="5569222">ut</span><span class="op" id="5569224">.</span><span class="ident" id="5569225">base</span><span class="op" id="5569229">;</span>&nbsp;<span class="ident" id="5569231">rt</span><span class="op" id="5569233">.</span><span class="ident" id="5569234">Kind</span><span class="op" id="5569238">(</span><span class="op" id="5569239">)</span>&nbsp;<span class="op" id="5569241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569244">default</span><span class="op" id="5569251">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569255">//&nbsp;Basic&nbsp;types&nbsp;and&nbsp;interfaces&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;be&nbsp;described.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569316">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569324">case</span>&nbsp;<span class="ident" id="5569329">reflect</span><span class="op" id="5569336">.</span><span class="ident" id="5569337">Slice</span><span class="op" id="5569342">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569346">//&nbsp;If&nbsp;it&#39;s&nbsp;[]uint8,&nbsp;don&#39;t&nbsp;send;&nbsp;it&#39;s&nbsp;considered&nbsp;basic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569403">if</span>&nbsp;<span class="ident" id="5569406">rt</span><span class="op" id="5569408">.</span><span class="ident" id="5569409">Elem</span><span class="op" id="5569413">(</span><span class="op" id="5569414">)</span><span class="op" id="5569415">.</span><span class="ident" id="5569416">Kind</span><span class="op" id="5569420">(</span><span class="op" id="5569421">)</span>&nbsp;<span class="op" id="5569423">==</span>&nbsp;<span class="ident" id="5569426">reflect</span><span class="op" id="5569433">.</span><span class="ident" id="5569434">Uint8</span>&nbsp;<span class="op" id="5569440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569445">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5569454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569458">//&nbsp;Otherwise&nbsp;we&nbsp;do&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569485">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569492">case</span>&nbsp;<span class="ident" id="5569497">reflect</span><span class="op" id="5569504">.</span><span class="ident" id="5569505">Array</span><span class="op" id="5569510">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569514">//&nbsp;arrays&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;element&nbsp;types.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569583">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569590">case</span>&nbsp;<span class="ident" id="5569595">reflect</span><span class="op" id="5569602">.</span><span class="ident" id="5569603">Map</span><span class="op" id="5569606">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569610">//&nbsp;maps&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;key/value&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569679">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569686">case</span>&nbsp;<span class="ident" id="5569691">reflect</span><span class="op" id="5569698">.</span><span class="ident" id="5569699">Struct</span><span class="op" id="5569705">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569709">//&nbsp;structs&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569760">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569767">case</span>&nbsp;<span class="ident" id="5569772">reflect</span><span class="op" id="5569779">.</span><span class="ident" id="5569780">Chan</span><span class="op" id="5569784">,</span>&nbsp;<span class="ident" id="5569786">reflect</span><span class="op" id="5569793">.</span><span class="ident" id="5569794">Func</span><span class="op" id="5569798">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569802">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here,&nbsp;it&#39;s&nbsp;a&nbsp;field&nbsp;of&nbsp;a&nbsp;struct;&nbsp;ignore&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569860">return</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5569868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5569872">return</span>&nbsp;<span class="ident" id="5569879">enc</span><span class="op" id="5569882">.</span><span class="ident" id="5569883">sendActualType</span><span class="op" id="5569897">(</span><span class="ident" id="5569898">w</span><span class="op" id="5569899">,</span>&nbsp;<span class="ident" id="5569901">state</span><span class="op" id="5569906">,</span>&nbsp;<span class="ident" id="5569908">ut</span><span class="op" id="5569910">,</span>&nbsp;<span class="ident" id="5569912">ut</span><span class="op" id="5569914">.</span><span class="ident" id="5569915">base</span><span class="op" id="5569919">)</span><br>
<span class="lineno"></span><span class="op" id="5569921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="5569924">//&nbsp;Encode&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;empty&nbsp;interface&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="5570000">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="5570080">func</span>&nbsp;<span class="op" id="5570085">(</span><span class="ident" id="5570086">enc</span>&nbsp;<span class="op" id="5570090">*</span><span class="ident" id="5570091">Encoder</span><span class="op" id="5570098">)</span>&nbsp;<span class="ident" id="5570100">Encode</span><span class="op" id="5570106">(</span><span class="ident" id="5570107">e</span>&nbsp;<span class="keyword" id="5570109">interface</span><span class="op" id="5570118">{</span><span class="op" id="5570119">}</span><span class="op" id="5570120">)</span>&nbsp;<span class="builtintype" id="5570122">error</span>&nbsp;<span class="op" id="5570128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570131">return</span>&nbsp;<span class="ident" id="5570138">enc</span><span class="op" id="5570141">.</span><span class="ident" id="5570142">EncodeValue</span><span class="op" id="5570153">(</span><span class="ident" id="5570154">reflect</span><span class="op" id="5570161">.</span><span class="ident" id="5570162">ValueOf</span><span class="op" id="5570169">(</span><span class="ident" id="5570170">e</span><span class="op" id="5570171">)</span><span class="op" id="5570172">)</span><br>
<span class="lineno"></span><span class="op" id="5570174">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="5570177">//&nbsp;sendTypeDescriptor&nbsp;makes&nbsp;sure&nbsp;the&nbsp;remote&nbsp;side&nbsp;knows&nbsp;about&nbsp;this&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="5570249">//&nbsp;It&nbsp;will&nbsp;send&nbsp;a&nbsp;descriptor&nbsp;if&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;time&nbsp;the&nbsp;type&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span><span class="comment" id="5570322">//&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="5570331">func</span>&nbsp;<span class="op" id="5570336">(</span><span class="ident" id="5570337">enc</span>&nbsp;<span class="op" id="5570341">*</span><span class="ident" id="5570342">Encoder</span><span class="op" id="5570349">)</span>&nbsp;<span class="ident" id="5570351">sendTypeDescriptor</span><span class="op" id="5570369">(</span><span class="ident" id="5570370">w</span>&nbsp;<span class="ident" id="5570372">io</span><span class="op" id="5570374">.</span><span class="ident" id="5570375">Writer</span><span class="op" id="5570381">,</span>&nbsp;<span class="ident" id="5570383">state</span>&nbsp;<span class="op" id="5570389">*</span><span class="ident" id="5570390">encoderState</span><span class="op" id="5570402">,</span>&nbsp;<span class="ident" id="5570404">ut</span>&nbsp;<span class="op" id="5570407">*</span><span class="ident" id="5570408">userTypeInfo</span><span class="op" id="5570420">)</span>&nbsp;<span class="op" id="5570422">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5570425">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;type&nbsp;is&nbsp;known&nbsp;to&nbsp;the&nbsp;other&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5570476">//&nbsp;First,&nbsp;have&nbsp;we&nbsp;already&nbsp;sent&nbsp;this&nbsp;type?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5570519">rt</span>&nbsp;<span class="op" id="5570522">:=</span>&nbsp;<span class="ident" id="5570525">ut</span><span class="op" id="5570527">.</span><span class="ident" id="5570528">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570534">if</span>&nbsp;<span class="ident" id="5570537">ut</span><span class="op" id="5570539">.</span><span class="ident" id="5570540">externalEnc</span>&nbsp;<span class="op" id="5570552">!=</span>&nbsp;<span class="num" id="5570555">0</span>&nbsp;<span class="op" id="5570557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5570561">rt</span>&nbsp;<span class="op" id="5570564">=</span>&nbsp;<span class="ident" id="5570566">ut</span><span class="op" id="5570568">.</span><span class="ident" id="5570569">user</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5570575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570578">if</span>&nbsp;<span class="ident" id="5570581">_</span><span class="op" id="5570582">,</span>&nbsp;<span class="ident" id="5570584">alreadySent</span>&nbsp;<span class="op" id="5570596">:=</span>&nbsp;<span class="ident" id="5570599">enc</span><span class="op" id="5570602">.</span><span class="ident" id="5570603">sent</span><span class="op" id="5570607">[</span><span class="ident" id="5570608">rt</span><span class="op" id="5570610">]</span><span class="op" id="5570611">;</span>&nbsp;<span class="op" id="5570613">!</span><span class="ident" id="5570614">alreadySent</span>&nbsp;<span class="op" id="5570626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5570630">//&nbsp;No,&nbsp;so&nbsp;send&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5570651">sent</span>&nbsp;<span class="op" id="5570656">:=</span>&nbsp;<span class="ident" id="5570659">enc</span><span class="op" id="5570662">.</span><span class="ident" id="5570663">sendType</span><span class="op" id="5570671">(</span><span class="ident" id="5570672">w</span><span class="op" id="5570673">,</span>&nbsp;<span class="ident" id="5570675">state</span><span class="op" id="5570680">,</span>&nbsp;<span class="ident" id="5570682">rt</span><span class="op" id="5570684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570688">if</span>&nbsp;<span class="ident" id="5570691">enc</span><span class="op" id="5570694">.</span><span class="ident" id="5570695">err</span>&nbsp;<span class="op" id="5570699">!=</span>&nbsp;<span class="builtintype" id="5570702">nil</span>&nbsp;<span class="op" id="5570706">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570711">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5570720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5570724">//&nbsp;If&nbsp;the&nbsp;type&nbsp;info&nbsp;has&nbsp;still&nbsp;not&nbsp;been&nbsp;transmitted,&nbsp;it&nbsp;means&nbsp;we&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5570795">//&nbsp;a&nbsp;singleton&nbsp;basic&nbsp;type&nbsp;(int,&nbsp;[]byte&nbsp;etc.)&nbsp;at&nbsp;top&nbsp;level.&nbsp;&nbsp;We&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5570866">//&nbsp;need&nbsp;to&nbsp;send&nbsp;the&nbsp;type&nbsp;info&nbsp;but&nbsp;we&nbsp;do&nbsp;need&nbsp;to&nbsp;update&nbsp;enc.sent.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570933">if</span>&nbsp;<span class="op" id="5570936">!</span><span class="ident" id="5570937">sent</span>&nbsp;<span class="op" id="5570942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5570947">info</span><span class="op" id="5570951">,</span>&nbsp;<span class="ident" id="5570953">err</span>&nbsp;<span class="op" id="5570957">:=</span>&nbsp;<span class="ident" id="5570960">getTypeInfo</span><span class="op" id="5570971">(</span><span class="ident" id="5570972">ut</span><span class="op" id="5570974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570979">if</span>&nbsp;<span class="ident" id="5570982">err</span>&nbsp;<span class="op" id="5570986">!=</span>&nbsp;<span class="builtintype" id="5570989">nil</span>&nbsp;<span class="op" id="5570993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5570999">enc</span><span class="op" id="5571002">.</span><span class="ident" id="5571003">setError</span><span class="op" id="5571011">(</span><span class="ident" id="5571012">err</span><span class="op" id="5571015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571021">return</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5571031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5571036">enc</span><span class="op" id="5571039">.</span><span class="ident" id="5571040">sent</span><span class="op" id="5571044">[</span><span class="ident" id="5571045">rt</span><span class="op" id="5571047">]</span>&nbsp;<span class="op" id="5571049">=</span>&nbsp;<span class="ident" id="5571051">info</span><span class="op" id="5571055">.</span><span class="ident" id="5571056">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5571061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5571064">}</span><br>
<span class="lineno"></span><span class="op" id="5571066">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="5571069">//&nbsp;sendTypeId&nbsp;sends&nbsp;the&nbsp;id,&nbsp;which&nbsp;must&nbsp;have&nbsp;already&nbsp;been&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="5571135">func</span>&nbsp;<span class="op" id="5571140">(</span><span class="ident" id="5571141">enc</span>&nbsp;<span class="op" id="5571145">*</span><span class="ident" id="5571146">Encoder</span><span class="op" id="5571153">)</span>&nbsp;<span class="ident" id="5571155">sendTypeId</span><span class="op" id="5571165">(</span><span class="ident" id="5571166">state</span>&nbsp;<span class="op" id="5571172">*</span><span class="ident" id="5571173">encoderState</span><span class="op" id="5571185">,</span>&nbsp;<span class="ident" id="5571187">ut</span>&nbsp;<span class="op" id="5571190">*</span><span class="ident" id="5571191">userTypeInfo</span><span class="op" id="5571203">)</span>&nbsp;<span class="op" id="5571205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5571208">//&nbsp;Identify&nbsp;the&nbsp;type&nbsp;of&nbsp;this&nbsp;top-level&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5571255">state</span><span class="op" id="5571260">.</span><span class="ident" id="5571261">encodeInt</span><span class="op" id="5571270">(</span><span class="ident" id="5571271">int64</span><span class="op" id="5571276">(</span><span class="ident" id="5571277">enc</span><span class="op" id="5571280">.</span><span class="ident" id="5571281">sent</span><span class="op" id="5571285">[</span><span class="ident" id="5571286">ut</span><span class="op" id="5571288">.</span><span class="ident" id="5571289">base</span><span class="op" id="5571293">]</span><span class="op" id="5571294">)</span><span class="op" id="5571295">)</span><br>
<span class="lineno">205</span><span class="op" id="5571297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5571300">//&nbsp;EncodeValue&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;reflection&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="5571376">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="5571456">func</span>&nbsp;<span class="op" id="5571461">(</span><span class="ident" id="5571462">enc</span>&nbsp;<span class="op" id="5571466">*</span><span class="ident" id="5571467">Encoder</span><span class="op" id="5571474">)</span>&nbsp;<span class="ident" id="5571476">EncodeValue</span><span class="op" id="5571487">(</span><span class="ident" id="5571488">value</span>&nbsp;<span class="ident" id="5571494">reflect</span><span class="op" id="5571501">.</span><span class="ident" id="5571502">Value</span><span class="op" id="5571507">)</span>&nbsp;<span class="builtintype" id="5571509">error</span>&nbsp;<span class="op" id="5571515">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5571518">//&nbsp;Gobs&nbsp;contain&nbsp;values.&nbsp;They&nbsp;cannot&nbsp;represent&nbsp;nil&nbsp;pointers,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5571585">//&nbsp;have&nbsp;no&nbsp;value&nbsp;to&nbsp;encode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571614">if</span>&nbsp;<span class="ident" id="5571617">value</span><span class="op" id="5571622">.</span><span class="ident" id="5571623">Kind</span><span class="op" id="5571627">(</span><span class="op" id="5571628">)</span>&nbsp;<span class="op" id="5571630">==</span>&nbsp;<span class="ident" id="5571633">reflect</span><span class="op" id="5571640">.</span><span class="ident" id="5571641">Ptr</span>&nbsp;<span class="op" id="5571645">&amp;&amp;</span>&nbsp;<span class="ident" id="5571648">value</span><span class="op" id="5571653">.</span><span class="ident" id="5571654">IsNil</span><span class="op" id="5571659">(</span><span class="op" id="5571660">)</span>&nbsp;<span class="op" id="5571662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5571666">panic</span><span class="op" id="5571671">(</span><span class="string" id="5571672">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5571714">+</span>&nbsp;<span class="ident" id="5571716">value</span><span class="op" id="5571721">.</span><span class="ident" id="5571722">Type</span><span class="op" id="5571726">(</span><span class="op" id="5571727">)</span><span class="op" id="5571728">.</span><span class="ident" id="5571729">String</span><span class="op" id="5571735">(</span><span class="op" id="5571736">)</span><span class="op" id="5571737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5571740">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5571744">//&nbsp;Make&nbsp;sure&nbsp;we&#39;re&nbsp;single-threaded&nbsp;through&nbsp;here,&nbsp;so&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5571806">//&nbsp;goroutines&nbsp;can&nbsp;share&nbsp;an&nbsp;encoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5571843">enc</span><span class="op" id="5571846">.</span><span class="ident" id="5571847">mutex</span><span class="op" id="5571852">.</span><span class="ident" id="5571853">Lock</span><span class="op" id="5571857">(</span><span class="op" id="5571858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571861">defer</span>&nbsp;<span class="ident" id="5571867">enc</span><span class="op" id="5571870">.</span><span class="ident" id="5571871">mutex</span><span class="op" id="5571876">.</span><span class="ident" id="5571877">Unlock</span><span class="op" id="5571883">(</span><span class="op" id="5571884">)</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5571888">//&nbsp;Remove&nbsp;any&nbsp;nested&nbsp;writers&nbsp;remaining&nbsp;due&nbsp;to&nbsp;previous&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5571952">enc</span><span class="op" id="5571955">.</span><span class="ident" id="5571956">w</span>&nbsp;<span class="op" id="5571958">=</span>&nbsp;<span class="ident" id="5571960">enc</span><span class="op" id="5571963">.</span><span class="ident" id="5571964">w</span><span class="op" id="5571965">[</span><span class="num" id="5571966">0</span><span class="op" id="5571967">:</span><span class="num" id="5571968">1</span><span class="op" id="5571969">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5571973">ut</span><span class="op" id="5571975">,</span>&nbsp;<span class="ident" id="5571977">err</span>&nbsp;<span class="op" id="5571981">:=</span>&nbsp;<span class="ident" id="5571984">validUserType</span><span class="op" id="5571997">(</span><span class="ident" id="5571998">value</span><span class="op" id="5572003">.</span><span class="ident" id="5572004">Type</span><span class="op" id="5572008">(</span><span class="op" id="5572009">)</span><span class="op" id="5572010">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572013">if</span>&nbsp;<span class="ident" id="5572016">err</span>&nbsp;<span class="op" id="5572020">!=</span>&nbsp;<span class="builtintype" id="5572023">nil</span>&nbsp;<span class="op" id="5572027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572031">return</span>&nbsp;<span class="ident" id="5572038">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5572043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572047">enc</span><span class="op" id="5572050">.</span><span class="ident" id="5572051">err</span>&nbsp;<span class="op" id="5572055">=</span>&nbsp;<span class="builtintype" id="5572057">nil</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572062">enc</span><span class="op" id="5572065">.</span><span class="ident" id="5572066">byteBuf</span><span class="op" id="5572073">.</span><span class="ident" id="5572074">Reset</span><span class="op" id="5572079">(</span><span class="op" id="5572080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572083">enc</span><span class="op" id="5572086">.</span><span class="ident" id="5572087">byteBuf</span><span class="op" id="5572094">.</span><span class="ident" id="5572095">Write</span><span class="op" id="5572100">(</span><span class="ident" id="5572101">spaceForLength</span><span class="op" id="5572115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572118">state</span>&nbsp;<span class="op" id="5572124">:=</span>&nbsp;<span class="ident" id="5572127">enc</span><span class="op" id="5572130">.</span><span class="ident" id="5572131">newEncoderState</span><span class="op" id="5572146">(</span><span class="op" id="5572147">&amp;</span><span class="ident" id="5572148">enc</span><span class="op" id="5572151">.</span><span class="ident" id="5572152">byteBuf</span><span class="op" id="5572159">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572163">enc</span><span class="op" id="5572166">.</span><span class="ident" id="5572167">sendTypeDescriptor</span><span class="op" id="5572185">(</span><span class="ident" id="5572186">enc</span><span class="op" id="5572189">.</span><span class="ident" id="5572190">writer</span><span class="op" id="5572196">(</span><span class="op" id="5572197">)</span><span class="op" id="5572198">,</span>&nbsp;<span class="ident" id="5572200">state</span><span class="op" id="5572205">,</span>&nbsp;<span class="ident" id="5572207">ut</span><span class="op" id="5572209">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572212">enc</span><span class="op" id="5572215">.</span><span class="ident" id="5572216">sendTypeId</span><span class="op" id="5572226">(</span><span class="ident" id="5572227">state</span><span class="op" id="5572232">,</span>&nbsp;<span class="ident" id="5572234">ut</span><span class="op" id="5572236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572239">if</span>&nbsp;<span class="ident" id="5572242">enc</span><span class="op" id="5572245">.</span><span class="ident" id="5572246">err</span>&nbsp;<span class="op" id="5572250">!=</span>&nbsp;<span class="builtintype" id="5572253">nil</span>&nbsp;<span class="op" id="5572257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572261">return</span>&nbsp;<span class="ident" id="5572268">enc</span><span class="op" id="5572271">.</span><span class="ident" id="5572272">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5572277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5572281">//&nbsp;Encode&nbsp;the&nbsp;object.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572304">enc</span><span class="op" id="5572307">.</span><span class="ident" id="5572308">encode</span><span class="op" id="5572314">(</span><span class="ident" id="5572315">state</span><span class="op" id="5572320">.</span><span class="ident" id="5572321">b</span><span class="op" id="5572322">,</span>&nbsp;<span class="ident" id="5572324">value</span><span class="op" id="5572329">,</span>&nbsp;<span class="ident" id="5572331">ut</span><span class="op" id="5572333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572336">if</span>&nbsp;<span class="ident" id="5572339">enc</span><span class="op" id="5572342">.</span><span class="ident" id="5572343">err</span>&nbsp;<span class="op" id="5572347">==</span>&nbsp;<span class="builtintype" id="5572350">nil</span>&nbsp;<span class="op" id="5572354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572358">enc</span><span class="op" id="5572361">.</span><span class="ident" id="5572362">writeMessage</span><span class="op" id="5572374">(</span><span class="ident" id="5572375">enc</span><span class="op" id="5572378">.</span><span class="ident" id="5572379">writer</span><span class="op" id="5572385">(</span><span class="op" id="5572386">)</span><span class="op" id="5572387">,</span>&nbsp;<span class="ident" id="5572389">state</span><span class="op" id="5572394">.</span><span class="ident" id="5572395">b</span><span class="op" id="5572396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5572399">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572403">enc</span><span class="op" id="5572406">.</span><span class="ident" id="5572407">freeEncoderState</span><span class="op" id="5572423">(</span><span class="ident" id="5572424">state</span><span class="op" id="5572429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572432">return</span>&nbsp;<span class="ident" id="5572439">enc</span><span class="op" id="5572442">.</span><span class="ident" id="5572443">err</span><br>
<span class="lineno"></span><span class="op" id="5572447">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
